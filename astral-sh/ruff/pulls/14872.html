<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-pyi`]: More autofixes for redundant-none-literal (`PYI061`) - astral-sh/ruff #14872</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-pyi</code>]: More autofixes for redundant-none-literal (<code>PYI061</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14872">#14872</a>
        opened by <a href="https://github.com/kiran-4444">@kiran-4444</a>
        on 2024-12-09 13:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kiran-4444">@kiran-4444</a></div>
            <div class="timeline-body">

Summary
<p>This PR solves #14537. I&#x27;ve tested it, and it&#x27;s working as expected. I&#x27;ll be updating this with tests tomorrow. The implementation isn&#x27;t yet sanitised and can be refactored further. Any feedback in doing this is greatly appreciated.</p>
Test Plan
<p>Tested locally, will update the tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/kiran-4444">@kiran-4444</a> on 2024-12-09 13:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[`flake8-pyi`]: More autofixes for redundant-none-literal/PYI061 (`PYI061`)&quot; to &quot;[`flake8-pyi`]: More autofixes for redundant-none-literal (`PYI061`)&quot; by <a href="https://github.com/kiran-4444">@kiran-4444</a> on 2024-12-09 13:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-12-09 14:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_none_literal.rs</code>:229 on 2024-12-09 15:08</div>
            <div class="timeline-body"><p>this will only work if the user has <code>from typing import Literal</code> somewhere in the file. If the user has <code>import typing</code> somewhere in the file instead of <code>from typing import Literal</code>, the fix here will break the user&#x27;s code, which won&#x27;t be good! Instead of using an <code>ExprName</code> that we&#x27;re constructing ourselves as the subscript value, we should just use the value of the original subscript expression</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_none_literal.rs</code>:255 on 2024-12-09 15:10</div>
            <div class="timeline-body"><p>this isn&#x27;t quite right: this will lead to the fix producing changes like this:</p>
<pre><code>- Literal[1, None]
+ Literal[1] | Literal[None]
</code></pre>
<p>but what we actually want it to do is something like this:</p>
<pre><code>- Literal[1, None]
+ Literal[1] | None
</code></pre>
<p>the good news is that this means that you can simplify your code a little bit :-)</p>
<pre><code>            right: Box::new(Expr::NoneLiteral(
                ExprNoneLiteral {
                    range: TextRange::default(),
                }
            )),
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_none_literal.rs</code>:99 on 2024-12-09 15:12</div>
            <div class="timeline-body"><p>the type of the <code>checker</code> variable is already <code>&amp;mut Checker</code> here, so this <code>borrow_mut()</code> call isn&#x27;t necessary (and means we can avoid the import of the <code>BorrowMut</code> trait at the top of the file)</p>
<pre><code>        create_fix_edit_2(checker, literal_expr, &amp;literal_elements).map(|edit| {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-09 15:13</div>
            <div class="timeline-body"><p>Thanks! A couple of issues here, but this broadly looks like it&#x27;s on the right track :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kiran-4444">@kiran-4444</a> reviewed on 2024-12-10 05:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/kiran-4444">@kiran-4444</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_none_literal.rs</code>:229 on 2024-12-10 05:57</div>
            <div class="timeline-body"><p>Oh yes, I totally missed this. Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kiran-4444">@kiran-4444</a> reviewed on 2024-12-10 05:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/kiran-4444">@kiran-4444</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_none_literal.rs</code>:255 on 2024-12-10 05:59</div>
            <div class="timeline-body"><p>This seems to behave a bit weird though:</p>
<pre><code>- Literal[1, None] # is being formatted to:
+ Literal[1,] | None
</code></pre>
<p>I&#x27;m not sure where that trailing comma is from.</p>
<p>But the following is working fine:</p>
<pre><code>- Literal[1,2,3,None]
+ Literal[1,2,3] | None
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-10 13:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_none_literal.rs</code>:255 on 2024-12-10 13:20</div>
            <div class="timeline-body"><p>The trailing comma is because Python has a different AST for subscript slices with only a single element than it does for subscript slices with multiple elements. You can see this quite easily if you use Python&#x27;s <code>ast</code> module to inspect the AST of a snippet. The first of these has the node for <code>1</code> directly as the subscript slice, but the second of these has a <code>Tuple</code> node as the subscript slice, with the nodes for <code>1</code> and <code>2</code> as the tuple&#x27;s elements:</p>
<pre><code>&gt;&gt;&gt; import ast
&gt;&gt;&gt; print(ast.dump(ast.parse(&#x27;x[1]&#x27;), indent=2))
Module(
  body=[
    Expr(
      value=Subscript(
        value=Name(id=&#x27;x&#x27;, ctx=Load()),
        slice=Constant(value=1),
        ctx=Load()))])
&gt;&gt;&gt; print(ast.dump(ast.parse(&#x27;x[1, 2]&#x27;), indent=2))
Module(
  body=[
    Expr(
      value=Subscript(
        value=Name(id=&#x27;x&#x27;, ctx=Load()),
        slice=Tuple(
          elts=[
            Constant(value=1),
            Constant(value=2)],
          ctx=Load()),
        ctx=Load()))])
</code></pre>
<p>It&#x27;s the same with Ruff&#x27;s AST for Python; we can see this in the Ruff playground here: https://play.ruff.rs/?secondary=AST</p>
<p>So you will need to check how many elements are left in the <code>Literal</code> slice after removing <code>None</code>. If there is only one element left in the <code>Literal</code> slice, you will want to remove the intermediate <code>Expr::Tuple</code> from the AST. But if there is still more than one element left in the <code>Literal</code> slice, you&#x27;ll need to keep the <code>Expr::Tuple</code> there.</p>
<p>Does that make sense? :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kiran-4444">@kiran-4444</a> reviewed on 2024-12-11 05:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/kiran-4444">@kiran-4444</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_none_literal.rs</code>:255 on 2024-12-11 05:49</div>
            <div class="timeline-body"><p>That totally made sense to me. Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-11 07:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_none_literal.rs</code>:255 on 2024-12-11 07:49</div>
            <div class="timeline-body"><p>No problem!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kiran-4444">@kiran-4444</a> reviewed on 2024-12-11 07:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/kiran-4444">@kiran-4444</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_none_literal.rs</code>:255 on 2024-12-11 07:56</div>
            <div class="timeline-body"><p>Do I need to update the snapshots as well? and are there any tests that I should update?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-11 08:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_none_literal.rs</code>:255 on 2024-12-11 08:05</div>
            <div class="timeline-body"><blockquote>
<p>Do I need to update the snapshots as well?</p>
</blockquote>
<p>Yes please!</p>
<blockquote>
<p>and are there any tests that I should update?</p>
</blockquote>
<p>Let&#x27;s just update the snapshots for now, then I&#x27;ll think about how the PR looks overall once the snapshot tests are passing üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-11 10:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_none_literal.rs</code>:255 on 2024-12-11 10:39</div>
            <div class="timeline-body"><p>@kiran-4444 you&#x27;ll need to run <code>cargo insta review</code> locally and then interactively &quot;accept&quot; the new changes to the snapshots for the tests to pass. There shouldn&#x27;t be any new snapshot files added as a result of this PR -- <code>cargo insta review</code> should merge the new file that&#x27;s currently being added into the existing snapshots for the rule.</p>
<p>Happy to do this for you and push to your branch if you need a hand with it. You need <code>cargo-insta</code> to be installed for it to work -- there&#x27;s some instructions here: https://github.com/astral-sh/ruff/blob/main/CONTRIBUTING.md#prerequisites</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kiran-4444">@kiran-4444</a> reviewed on 2024-12-11 10:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/kiran-4444">@kiran-4444</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_none_literal.rs</code>:255 on 2024-12-11 10:49</div>
            <div class="timeline-body"><p>Hmm, I tried this now. Let me know if this is right. Or else, please help me doing this :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-11 10:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_none_literal.rs</code>:255 on 2024-12-11 10:51</div>
            <div class="timeline-body"><p>Sorry, I should have been clearer! You first need to run <code>cargo test -p ruff_linter</code> to make sure the <code>cargo-insta</code> tool has an up-to-date idea of what the new snapshots should be from the latest version of your PR. Then you need to run <code>cargo insta review</code> to accept or reject the changes, and then you need to commit the new changes and push them to your branch.</p>
<p>Totally my fault for unclear instructions :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-12-11 11:21</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>‚úÖ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>‚ÑπÔ∏è ecosystem check <strong>detected linter changes</strong>. (+0 -1 violations, +16 -0 fixes in 2 projects; 53 projects unchanged)</p>
<a href="https://github.com/pandas-dev/pandas">pandas-dev/pandas</a> (+0 -1 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
- <a href="https://github.com/pandas-dev/pandas/blob/13e2df0d7074cbc1a8d59d7044d5bfcb69147a3d/pandas/core/groupby/groupby.py#L4082">pandas/core/groupby/groupby.py:4082:39:</a> PYI061 `Literal[None, ...]` can be replaced with `Literal[...] | None`
</pre>

</p>

<a href="https://github.com/zulip/zulip">zulip/zulip</a> (+0 -0 violations, +16 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/zulip/zulip/blob/2138885fbf9f747e437ab7f455caa6b5fa68cd8a/corporate/views/billing_page.py#L326">corporate/views/billing_page.py:326:24:</a> PYI061 [*] `Literal[None, ...]` can be replaced with `Literal[...] | None`
- <a href="https://github.com/zulip/zulip/blob/2138885fbf9f747e437ab7f455caa6b5fa68cd8a/corporate/views/billing_page.py#L326">corporate/views/billing_page.py:326:24:</a> PYI061 `Literal[None, ...]` can be replaced with `Literal[...] | None`
+ <a href="https://github.com/zulip/zulip/blob/2138885fbf9f747e437ab7f455caa6b5fa68cd8a/corporate/views/remote_billing_page.py#L158">corporate/views/remote_billing_page.py:158:26:</a> PYI061 [*] `Literal[None, ...]` can be replaced with `Literal[...] | None`
- <a href="https://github.com/zulip/zulip/blob/2138885fbf9f747e437ab7f455caa6b5fa68cd8a/corporate/views/remote_billing_page.py#L158">corporate/views/remote_billing_page.py:158:26:</a> PYI061 `Literal[None, ...]` can be replaced with `Literal[...] | None`
+ <a href="https://github.com/zulip/zulip/blob/2138885fbf9f747e437ab7f455caa6b5fa68cd8a/corporate/views/remote_billing_page.py#L159">corporate/views/remote_billing_page.py:159:42:</a> PYI061 [*] `Literal[None, ...]` can be replaced with `Literal[...] | None`
- <a href="https://github.com/zulip/zulip/blob/2138885fbf9f747e437ab7f455caa6b5fa68cd8a/corporate/views/remote_billing_page.py#L159">corporate/views/remote_billing_page.py:159:42:</a> PYI061 `Literal[None, ...]` can be replaced with `Literal[...] | None`
+ <a href="https://github.com/zulip/zulip/blob/2138885fbf9f747e437ab7f455caa6b5fa68cd8a/corporate/views/remote_billing_page.py#L160">corporate/views/remote_billing_page.py:160:48:</a> PYI061 [*] `Literal[None, ...]` can be replaced with `Literal[...] | None`
- <a href="https://github.com/zulip/zulip/blob/2138885fbf9f747e437ab7f455caa6b5fa68cd8a/corporate/views/remote_billing_page.py#L160">corporate/views/remote_billing_page.py:160:48:</a> PYI061 `Literal[None, ...]` can be replaced with `Literal[...] | None`
+ <a href="https://github.com/zulip/zulip/blob/2138885fbf9f747e437ab7f455caa6b5fa68cd8a/corporate/views/remote_billing_page.py#L678">corporate/views/remote_billing_page.py:678:26:</a> PYI061 [*] `Literal[None, ...]` can be replaced with `Literal[...] | None`
- <a href="https://github.com/zulip/zulip/blob/2138885fbf9f747e437ab7f455caa6b5fa68cd8a/corporate/views/remote_billing_page.py#L678">corporate/views/remote_billing_page.py:678:26:</a> PYI061 `Literal[None, ...]` can be replaced with `Literal[...] | None`
+ <a href="https://github.com/zulip/zulip/blob/2138885fbf9f747e437ab7f455caa6b5fa68cd8a/corporate/views/remote_billing_page.py#L679">corporate/views/remote_billing_page.py:679:42:</a> PYI061 [*] `Literal[None, ...]` can be replaced with `Literal[...] | None`
- <a href="https://github.com/zulip/zulip/blob/2138885fbf9f747e437ab7f455caa6b5fa68cd8a/corporate/views/remote_billing_page.py#L679">corporate/views/remote_billing_page.py:679:42:</a> PYI061 `Literal[None, ...]` can be replaced with `Literal[...] | None`
+ <a href="https://github.com/zulip/zulip/blob/2138885fbf9f747e437ab7f455caa6b5fa68cd8a/corporate/views/remote_billing_page.py#L680">corporate/views/remote_billing_page.py:680:48:</a> PYI061 [*] `Literal[None, ...]` can be replaced with `Literal[...] | None`
- <a href="https://github.com/zulip/zulip/blob/2138885fbf9f747e437ab7f455caa6b5fa68cd8a/corporate/views/remote_billing_page.py#L680">corporate/views/remote_billing_page.py:680:48:</a> PYI061 `Literal[None, ...]` can be replaced with `Literal[...] | None`
+ <a href="https://github.com/zulip/zulip/blob/2138885fbf9f747e437ab7f455caa6b5fa68cd8a/corporate/views/remote_billing_page.py#L70">corporate/views/remote_billing_page.py:70:5:</a> PYI061 [*] `Literal[None, ...]` can be replaced with `Literal[...] | None`
- <a href="https://github.com/zulip/zulip/blob/2138885fbf9f747e437ab7f455caa6b5fa68cd8a/corporate/views/remote_billing_page.py#L70">corporate/views/remote_billing_page.py:70:5:</a> PYI061 `Literal[None, ...]` can be replaced with `Literal[...] | None`
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PYI061 | 17 | 0 | 1 | 16 | 0 |</p>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kiran-4444">@kiran-4444</a> reviewed on 2024-12-11 11:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/kiran-4444">@kiran-4444</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_none_literal.rs</code>:255 on 2024-12-11 11:29</div>
            <div class="timeline-body"><p>Not an issue, should&#x27;ve read the contribution instructions well.</p>
<p>I think the snapshots are fine now? What are the next steps?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-11 11:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_none_literal.rs</code>:255 on 2024-12-11 11:55</div>
            <div class="timeline-body"><p>Brilliant, thanks! Yes, the snapshots are all fine now. There&#x27;s still one check failing on this PR, however: our linter, Clippy, has some complaints. Could you take a look at the error messages there and try to fix them? Let me know if anything&#x27;s confusing for you in what it says!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-12-12 19:42</div>
            <div class="timeline-body"><p>Thanks @kiran-4444, this is a fantastic improvement! I pushed a couple of small changes:</p>
<ul>
<li>We can&#x27;t safely offer the fix with the <code>|</code> syntax on Python &lt;=3.9, as the <code>|</code> syntax for unions was added in Python 3.10. Possibly we could in the future use <code>typing.Union</code> for the fix and offer it even on older versions of Python, but I think we can leave that to another PR :-)</li>
<li>I simplified the code slightly by combining the two <code>create_fix_edit()</code> functions</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-12-12 19:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-12-12 19:44</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:09:20 UTC
    </footer>
</body>
</html>
