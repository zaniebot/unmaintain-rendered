<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Reachability and narrowing for enum methods - astral-sh/ruff #21130</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Reachability and narrowing for enum methods</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21130">#21130</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-10-29 20:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body">Summary
<p>Adds proper type narrowing and reachability analysis for matching on non-inferable type variables bound to enums. For example:</p>
<pre><code>from enum import Enum

class Answer(Enum):
    NO = 0
    YES = 1

    def is_yes(self) -&gt; bool:  # no error here!
        match self:
            case Answer.YES:
                return True
            case Answer.NO:
                return False
</code></pre>
<p>closes <a href="https://github.com/astral-sh/ty/issues/1404">astral-sh/ty#1404</a></p>
Test Plan
<p>Added regression tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-29 20:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-29 20:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-29 20:32</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-29 20:34</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>mitmproxy (https://github.com/mitmproxy/mitmproxy)
- mitmproxy/proxy/layers/http/_events.py:127:17: error[type-assertion-failure] Argument does not have asserted type `Never`
- Found 1890 diagnostics
+ Found 1889 diagnostics

jax (https://github.com/google/jax)
- jax/_src/pallas/mosaic_gpu/core.py:1527:24: error[invalid-return-type] Function can implicitly return `None`, which is not assignable to return type `TMEMLayout`
- Found 2545 diagnostics
+ Found 2544 diagnostics

</code></pre>

No memory usage changes detected ✅

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-30 13:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-30 13:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-30 13:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-30 13:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> removed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-30 13:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-30 13:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-30 13:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/narrow/match.md</code>:304 on 2025-10-30 13:24</div>
            <div class="timeline-body"><p>We do indeed</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-30 13:25</div>
            <div class="timeline-body">

<code>ecosystem-analyzer</code> results
<p>| Lint rule | Added | Removed | Changed |
|-----------|------:|--------:|--------:|
| <code>invalid-return-type</code> | 0 | 1 | 0 |
| <code>type-assertion-failure</code> | 0 | 1 | 0 |
| <strong>Total</strong> | <strong>0</strong> | <strong>2</strong> | <strong>0</strong> |</p>
<p><strong><a href="https://david-narrowing-for-enum-met.ecosystem-663.pages.dev/diff">Full report with detailed diff</a></strong> (<a href="https://david-narrowing-for-enum-met.ecosystem-663.pages.dev/timing">timing results</a>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-10-30 13:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/resources/mdtest/narrow/match.md</code>:304 on 2025-10-30 13:36</div>
            <div class="timeline-body"><p>Glad you like it, I was planning on leaving this in there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-30 13:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/builder.rs</code>:795 on 2025-10-30 13:44</div>
            <div class="timeline-body"><p>nit: it seems to compile fine if we just use references here?</p>
<pre><code>                    .map(|lit| lit.name(self.db))
                    .chain(std::iter::once(enum_literal.name(self.db))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-30 13:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/builder.rs</code>:796 on 2025-10-30 13:50</div>
            <div class="timeline-body"><p>I think this can be an <code>FxHashSet</code>, which is a slighlty simpler datastructure and possibly slightly faster? I don&#x27;t think deterministic ordering is necessary here</p>
<pre><code>                    .collect::&lt;FxHashSet&lt;_&gt;&gt;();
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/semantic_index/reachability_constraints.rs</code>:816 on 2025-10-30 13:53</div>
            <div class="timeline-body"><pre><code>        // ~Literal[YES]`, which *is* always equivalent to `Never`. This means that subsequent patterns can never
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-30 14:08</div>
            <div class="timeline-body"><p>This fixes the issue for methods on enums, but there appear to be lots of other cases where you can have a TypeVar bound to a union (or type equivalent to a union) where we also exhibit similar issues with reachability and narrowing. These are all on this branch:</p>
<pre><code>from typing import assert_never, Literal

def f[T: bool](x: T) -&gt; T:
    match x:
        case True:
            return x
        case False:
            return x
        case _:
            reveal_type(x) # T@f &amp; ~Literal[True] &amp; ~Literal[False]
            assert_never(x)  # false-positive error

def g[T: Literal[&quot;foo&quot;, &quot;bar&quot;]](x: T) -&gt; T:
    match x:
        case &quot;foo&quot;:
            return x
        case &quot;bar&quot;:
            return x
        case _:
            reveal_type(x)  # T@g &amp; ~Literal[&quot;foo&quot;] &amp; ~Literal[&quot;bar&quot;]
            assert_never(x)  # false-positive error

def h[T: int | str](x: T) -&gt; T:
    if isinstance(x, int):
        return x
    elif isinstance(x, str):
        return x
    else:
        reveal_type(x)  # T@h &amp; ~int &amp; ~str
        assert_never(x)  # false-positive error
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-10-30 14:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-30 14:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-30 14:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-10-30 14:38</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:19:59 UTC
    </footer>
</body>
</html>
