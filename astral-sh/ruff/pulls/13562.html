<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add some basic subscript type inference - astral-sh/ruff #13562</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add some basic subscript type inference</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13562">#13562</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-09-30 02:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-30 02:51</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Just for tuples and strings -- the easiest cases. I think most of the rest require generic support?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @charliermarsh on 2024-09-30 02:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @charliermarsh on 2024-09-30 02:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @charliermarsh on 2024-09-30 02:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @charliermarsh on 2024-09-30 02:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-09-30 02:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2409 on 2024-09-30 02:52</div>
            <div class="timeline-body"><p>I assume it is beneficial to compute the <code>StringLiteral</code> when we can?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2415 on 2024-09-30 02:52</div>
            <div class="timeline-body"><p>What's the general philosophy around when we should error in a case like this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-09-30 02:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-09-30 10:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2409 on 2024-09-30 10:46</div>
            <div class="timeline-body"><p>yup</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-09-30 10:53</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2415 on 2024-09-30 11:17</div>
            <div class="timeline-body"><p>There's a few things to note here.</p>
<h3>Issues with <code>LiteralString</code></h3>
<p>According to a strict reading of <a href="https://peps.python.org/pep-0675/#type-inference">PEP 675</a>, I don't think this is a legal place where we can infer <code>LiteralString</code>, since the PEP states:</p>
<blockquote>
<p>As per the <a href="https://peps.python.org/pep-0675/#rationale">Rationale</a>, we also infer <code>LiteralString</code> in the following cases:</p>
<p>[...]</p>
<ul>
<li>Literal-preserving methods: In <a href="https://peps.python.org/pep-0675/#pep-675-appendix-c">Appendix C</a>, we have provided an exhaustive list of <code>str</code> methods that preserve the <code>LiteralString</code> type.</li>
</ul>
</blockquote>
<p><code>str.__getitem__</code> is not listed in Appendix C of the PEP, so I suppose that means that we're not allowed to infer <code>LiteralString</code> for <code>x</code>, <code>y</code> or <code>z</code> in a snippet like this:</p>
<pre><code class="language-py">def foo(a: Literal[&quot;foo&quot;], b: LiteralString, c: int):
    x = a[c]
    y = b[42]
    z = b[c]
</code></pre>
<p>I'm not sure what the status of Appendix C is, though... it doesn't seem to have been copied into the <a href="https://typing.readthedocs.io/en/latest/spec/literal.html#valid-locations-for-literalstring">relevant section</a> of the typing spec, so perhaps it isn't canonical anymore? Or maybe that was just an omission when writing the spec? There's also the question of typeshed's stubs: typeshed doesn't include a <code>LiteralString</code> overload in its stub for <code>str.__getitem__</code>, although it includes <code>LiteralString</code> overloads for many of its other <code>str</code> methods. I'm not sure if there's a reason for that or not -- even if not, it may be desirable to be in sync with typeshed here.</p>
<p>For now I think I'd just delete this branch -- continuing to fallback to <code>Unknown</code> is ~fine for now.</p>
<h3>Emitting diagnostics</h3>
<p>In general, if we can't infer that an operation creates a <code>Literal</code> type (whether that's <code>LiteralString</code> or <code>StringLiteral</code>), we should fall back to typeshed's stubs. Here that means falling back to <code>builtins.str.__getitem__</code> -- you'd do something like <code>value_ty.to_meta_type(db).member(db, &quot;__getitem__&quot;).call(&amp;[value_ty, slice_ty])</code> to figure out what the type of the subscript expression is. Except there are some complications ;) Take a look at <code>Type::iterate</code> for a more complete example of how we lookup dunder methods elsewhere, try to call them, and emit a diagnostic if the dunder method eithere doesn't exist or isn't callable. https://github.com/astral-sh/ruff/blob/5118166d21784e7c78e38ea42919ba50bb2a5142/crates/red_knot_python_semantic/src/types.rs#L629-L684</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:6454 on 2024-09-30 11:17</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    fn subscript_literal_string() -&gt; anyhow::Result&lt;()&gt; {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:6470 on 2024-09-30 11:18</div>
            <div class="timeline-body"><p><code>c</code> leads to a <code>TypeError</code> at runtime; this isn't correct. <code>TypeError</code>s should always cause us to infer <code>Unknown</code>. We should emit a diagnostic and infer <code>Unknown</code> rather than <code>LiteralString</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> requested changes on 2024-09-30 11:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-09-30 13:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:6470 on 2024-09-30 13:02</div>
            <div class="timeline-body"><p>What is the plan for emitting those diagnostics? Don't we need to propagate some information about <em>why</em> it failed?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-09-30 13:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:6470 on 2024-09-30 13:10</div>
            <div class="timeline-body"><p>Of course! Like I said in https://github.com/astral-sh/ruff/pull/13559#issuecomment-2382679447, take a look at the <code>add_diagnostic</code> and <code>not_iterable_diagnostic</code> methods for how we do this elsewhere</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-30 14:18</div>
            <div class="timeline-body"><p>Okay thanks, will re-request review once I've addressed feedback.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @charliermarsh on 2024-09-30 14:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-30 14:20</div>
            <div class="timeline-body"><p>Actually, it should be fine to merge in its current state. I'll look at doing the dunder fallback and diagnostics in a separate PR to keep this small.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-09-30 14:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2472 on 2024-09-30 14:24</div>
            <div class="timeline-body"><p>You need to add calls to <code>self.add_diagnostic()</code> on all these <code>else {Type::Unknown}</code> branches (or add a helper method, similar to our <code>not_iterable_diagnostic()</code> helper, and call that from each branch)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-09-30 14:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2472 on 2024-09-30 14:28</div>
            <div class="timeline-body"><p>It seems like that shouldn't be &quot;necessary&quot; for the PR to merge given that we have fallbacks to <code>Type::Unknown</code> everywhere without diagnostics (<code>infer_import_definition</code> would be a good example), but I'll add it here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-09-30 14:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2472 on 2024-09-30 14:32</div>
            <div class="timeline-body"><blockquote>
<p><code>infer_import_definition</code> would be a good example</p>
</blockquote>
<p>We emit a diagnostic here in that method when we can't resolve the import, no? https://github.com/astral-sh/ruff/blob/5f4b2823277df38fc222e9d8096b805f9cc34c74/crates/red_knot_python_semantic/src/types/infer.rs#L1314</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-09-30 14:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2472 on 2024-09-30 14:35</div>
            <div class="timeline-body"><p>But yeah, we can defer adding the calls to <code>add_diagnostic</code> if you want! But I'd definitely like us to at least add <code>TODO</code> comments for these branches if we are going to defer it. Inferring <code>Unknown</code> is correct here, but we shouldn't do it silently without emitting a diagnostic to the user informing them about the error, and I think there's a strong chance we'll forget about this otherwise</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-09-30 14:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2472 on 2024-09-30 14:42</div>
            <div class="timeline-body"><p>(I was referring to:</p>
<pre><code class="language-rust">tracing::debug!(&quot;Failed to resolve import due to invalid syntax&quot;);
Type::Unknown
</code></pre>
<p>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2472 on 2024-09-30 14:45</div>
            <div class="timeline-body"><p>Right, but that's because we'll have already emitted a diagnostic in an earlier pass if the node contains invalid syntax; there's no need to duplicate the parser's diagnostic in the type inference builder. That's not true for the branches you're adding here, however</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-09-30 14:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @charliermarsh on 2024-09-30 16:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-30 16:26</div>
            <div class="timeline-body"><p>Added diagnostics, though unsure if there are established patterns around the rule names, granularity, etc.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-09-30 16:28</div>
            <div class="timeline-body"><blockquote>
<p>Added diagnostics, though unsure if there are established patterns around the rule names, granularity, etc.</p>
</blockquote>
<p>It's a bit of a wild west right now, I wouldn't worry about that too much! I'm sure we'll clean them up at some point (and make the diagnostics less stringly typed etc.). Micha's proposals he shared during the on-site go some way to addressing this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-30 16:29</div>
            <div class="timeline-body"><p>Sounds good, I figured as much :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-09-30 16:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1263 on 2024-09-30 16:40</div>
            <div class="timeline-body"><p>The other two diagnostics look great to me, but this I don't think is correct. These diagnostics will be messages shown to users indicating errors in their code, but this diagnostic doesn't represent that -- it represents an implementation detail of how we're representing Python types in Rust.</p>
<p>I think if we get an <code>IntLiteral</code> so big that it can't fit into a <code>usize</code>, we don't actually need to know its precise value here, because we <em>know</em> it will represent an index-out-of-bounds for both a string-literal and a tuple:</p>
<ul>
<li>The maximum size of a string-literal type is set here: https://github.com/astral-sh/ruff/blob/d86b73eb3dbcf06552a2e4d316ef1765608bf4a4/crates/red_knot_python_semantic/src/types/infer.rs#L282</li>
<li>The maximum size of a heterogenous tuple type will be <code>usize::Max</code>, due to the <code>TupleType</code> definition here: https://github.com/astral-sh/ruff/blob/d86b73eb3dbcf06552a2e4d316ef1765608bf4a4/crates/red_knot_python_semantic/src/types.rs#L1214-L1218</li>
</ul>
<p>An <code>i64</code> bigger than <code>usize::MAX</code> will be bigger than either of those numbers</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-09-30 16:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2415 on 2024-09-30 16:42</div>
            <div class="timeline-body"><p>I don't agree with the pedantic reading of PEP 675 (or typeshed) as a rationale for removing this branch. Many useful things are simply overlooked. If a more precise type inference is clearly correct in terms of the runtime semantics, and there's nothing in the typing spec or conformance suite explicitly prohibiting it, then I think we should feel totally free to go ahead and do it.</p>
<p>It is clearly correct wrt the runtime semantics to infer <code>LiteralString</code> as the result of indexing into a <code>LiteralString</code> or <code>StringLiteral</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-09-30 16:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2415 on 2024-09-30 16:51</div>
            <div class="timeline-body"><p>On second thought, given the security rationale for <code>LiteralString</code>, there <em>may</em> be an argument that untrusted-user-supplied indices could allow turning a &quot;safe&quot; <code>LiteralString</code> into an &quot;unsafe&quot; one via careful cropping. I have mixed feelings about this, because there's also type-system value to <code>LiteralString</code> (we know it is really a built-in <code>str</code>, not a subclass), and in type-system terms, the inference of <code>LiteralString</code> is correct. And the security issue seems fairly contrived. But that <em>might</em> be why inference of <code>LiteralString</code> on <code>__getitem__</code> is not in the PEP?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2415 on 2024-09-30 16:52</div>
            <div class="timeline-body"><blockquote>
<p>It is clearly correct wrt the runtime semantics to infer <code>LiteralString</code> as the result of indexing into a <code>LiteralString</code> or <code>StringLiteral</code>.</p>
</blockquote>
<p>I agree, but the fact that PEP-675 is so clear that the list of string methods in Appendix C is valid is meant to be &quot;exhaustive&quot; made me worried that there was something I was misunderstanding :-) and until recently, PEP-675 <em>was</em> the spec -- it's not clear to me whether Appendix C was deliberately kept out of the typing spec or not.</p>
<p>This branch was anyway incorrect -- <code>StringLiteral</code> cannot be indexed into with objects of arbitraty types, which is what this branch allowed before Charlie removed it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-09-30 16:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-09-30 16:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1263 on 2024-09-30 16:53</div>
            <div class="timeline-body"><p>Yes, we shouldn't emit this as a diagnostic. Wherever we would do so, we should just silently fall back to whatever type we can safely infer without knowing the precise index.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1254 on 2024-09-30 16:57</div>
            <div class="timeline-body"><p>Not sure if typo or intentional, but &quot;out of bounds&quot; would be the usual terminology here; &quot;out of band&quot; usually means something else (side-channel communication.)</p>
<pre><code class="language-suggestion">    pub(super) fn tuple_index_out_of_bounds_diagnostic(
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1272 on 2024-09-30 16:58</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    pub(super) fn string_index_out_of_bounds_diagnostic(
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2415 on 2024-09-30 17:05</div>
            <div class="timeline-body"><p>So to clarify... We need to add a branch for <code>__getitem__</code> (in general -- I plan to do this in a separate PR), and slices into <code>StringLiteral</code> (with non-int literal indexes) should be handled by that branch? Or do we want to resolve to <code>LiteralString</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-09-30 17:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-09-30 17:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1263 on 2024-09-30 17:11</div>
            <div class="timeline-body"><p>Removed</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2426 on 2024-09-30 17:16</div>
            <div class="timeline-body"><p>Python allows negative indexing, which indexes from the end of the container:</p>
<pre><code>&gt;&gt;&gt; t = (1, 2, 3)
&gt;&gt;&gt; t[-1]
3
</code></pre>
<p>So we should handle that here. I would say we don't have to do it in this PR, and we can just add a TODO, but I don't like that in the meantime this would mean we'd wrongly emit an out-of-bounds error.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-09-30 17:18</div>
            <div class="timeline-body"><p>Looks great, thank you! One minor naming nit, and the issue of negative indexing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-09-30 17:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1254 on 2024-09-30 17:27</div>
            <div class="timeline-body"><p>Hah sorry, that's just a typo.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-09-30 17:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2426 on 2024-09-30 17:28</div>
            <div class="timeline-body"><p>I'll handle it here, thanks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-09-30 17:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2415 on 2024-09-30 17:42</div>
            <div class="timeline-body"><p>After further thought, I don't really buy the possible security argument I mentioned above for not inferring <code>LiteralString</code>: you can easily construct many other cases where the contents of a <code>LiteralString</code>, though always originating from a literal string in the source code, could be <em>influenced</em> in some way by untrusted user input (e.g. determining whether some concatenation does or doesn't occur.)</p>
<p>But that said, I don't think this is critical, and it is probably best to just rely on typeshed for this. So we could at some point consider proposing a change to typeshed with a <code>LiteralString</code> overload for <code>str.__getitem__</code>, but I don't think it's worth an extra special case in red-knot to diverge from typeshed here.</p>
<p>So yeah, I would say let's just add the branch that uses the return type from <code>__getitem__</code>, as Alex suggested. (And yeah, fine for that to be a separate follow-up if you prefer.</p>
<p>(I suspect, but don't know, that the reason Appendix C isn't in the type spec is that it was considered to already be reflected in the typeshed change.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @charliermarsh on 2024-09-30 18:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-09-30 20:17</div>
            <div class="timeline-body"><p>Nice! LGTM.</p>
<p>I think there would be a possible implementation where we extract a helper function for the actual indexing-or-None for each type, and then the negative case could just add <code>.len()</code> to the index and try that function. But there's really not that much duplication in this version, so I'm not sure that would be worth it, happy with this as-is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-09-30 20:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-09-30 20:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-09-30 20:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-30 20:51</div>
            <div class="timeline-body"><p>Thanks for the thorough reviews, much appreciated! I'll look at the <code>__getitem__</code> part next.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 21:00:07 UTC
    </footer>
</body>
</html>
