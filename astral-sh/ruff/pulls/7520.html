<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change `Resolver` to store `Settings` instead of `AllSettings` - astral-sh/ruff #7520</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Change <code>Resolver</code> to store <code>Settings</code> instead of <code>AllSettings</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7520">#7520</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-09-19 14:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-19 14:51</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR changes <code>Resolver</code> to only store <code>Settings</code> internally instead of <code>AllSettings</code> because <code>AllSettings</code> is only intended to be used at the top-level. It moves the <code>cache_dir</code> settings from <code>AllSettings</code> to <code>Settings</code> because it is an inherited setting.</p>
<p>~~This comes with one semenatical change. Previously, the cache for each python package was stored at the location specified by the configuration in that python package.
I don't think that was intentionally.~~</p>
<h2>Test Plan</h2>
<p><code>cargo test</code></p>
<p>Running ruff with caching enabled is somewhat faster (proving that caching isn't broken)</p>
<pre><code> hyperfine --warmup 10 \
        &quot;./target/release/ruff ./crates/ruff/resources/test/cpython -e&quot; \
        &quot;./target/release/ruff ./crates/ruff/resources/test/cpython --no-cache -e&quot;
Benchmark 1: ./target/release/ruff ./crates/ruff/resources/test/cpython -e
  Time (mean ¬± œÉ):      80.1 ms ¬±   3.0 ms    [User: 88.5 ms, System: 97.5 ms]
  Range (min ‚Ä¶ max):    75.9 ms ‚Ä¶  89.5 ms    35 runs
 
Benchmark 2: ./target/release/ruff ./crates/ruff/resources/test/cpython --no-cache -e
  Time (mean ¬± œÉ):     201.9 ms ¬±   4.7 ms    [User: 2904.2 ms, System: 125.7 ms]
  Range (min ‚Ä¶ max):   196.2 ms ‚Ä¶ 214.8 ms    14 runs
 
Summary
  ./target/release/ruff ./crates/ruff/resources/test/cpython -e ran
    2.52 ¬± 0.11 times faster than ./target/release/ruff ./crates/ruff/resources/test/cpython --no-cache -e
</code></pre>
<p>Verified that Ruff writes to a different cache directory when changing the <code>cache-dir</code> setting in the pyproject.toml.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-19 14:51</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #7518</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7518" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #7520</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7520" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  üëà<ul>
<li><strong>PR #7522</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7522" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7520?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @MichaReiser on 2023-09-19 14:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2023-09-19 14:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/resolver.rs</code>:280 on 2023-09-19 14:52</div>
            <div class="timeline-body"><p>Whoops, I couldn't resist. It avoids traversing the whole ancestor multiple times if you have <code>ruff check file.py, file2.py</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-19 14:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-09-19 15:22</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>‚úÖ ecosystem check detected no changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_cli/src/commands/check.rs</code>:68 on 2023-09-19 16:53</div>
            <div class="timeline-body"><p>Is this ok? Do we not use the <code>cache_dir</code> of each individual settings?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-19 16:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-19 16:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_cli/src/commands/check.rs</code>:82 on 2023-09-19 16:54</div>
            <div class="timeline-body"><p>Ah ok, no -- we always use the cache dir from the top-level.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-19 16:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_cli/src/commands/check.rs</code>:82 on 2023-09-19 16:55</div>
            <div class="timeline-body"><p>Ahh ok, this is the semantic change you're describing in the PR summary.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-09-19 16:56</div>
            <div class="timeline-body"><blockquote>
<p>This comes with one semenatical change. Previously, the cache for each python package was stored at the location specified by the configuration in that python package.</p>
</blockquote>
<p>I feel like the previous behavior may have been more correct? Do you disagree? But I don't feel strongly and trust your judgment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-19 18:07</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>This comes with one semenatical change. Previously, the cache for each python package was stored at the location specified by the configuration in that python package.</p>
</blockquote>
<p>I feel like the previous behavior may have been more correct? Do you disagree? But I don't feel strongly and trust your judgment.</p>
</blockquote>
<p>It depends on the intended semantics and if this is a use case we want too support. The way I understood you is that all settings on AllSettings should be global and don't support overwriting. We can keep the current behavior by moving the setting to Settings instead. But it feels like a very rare edge case to me. Or do you think it to be common in very large monorepos?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_cli/src/commands/check.rs</code>:68 on 2023-09-19 18:08</div>
            <div class="timeline-body"><p>ü§∑‚Äç‚ôÄÔ∏è My assumption was that settings in AllSettings are global and not overridable. What's the use case for different caches per directory?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-19 18:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-19 18:10</div>
            <div class="timeline-body"><p>I think it's pretty rare. If folks want to change the cache dir, it's almost always a global change (often to some path outside of the project, based on my grepping). This seems fine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-19 18:13</div>
            <div class="timeline-body"><p>Let me restore the old behavior to make this a pure refactor but move it to settings instead</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-19 20:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/resolver.rs</code>:117 on 2023-09-19 20:46</div>
            <div class="timeline-body"><p>@charliermarsh what's the resolution logic here? It feels kind of slow because it iterates over all settings without making use of the <code>BTreeMap</code>. Do you think we could optimize it by using <code>range</code> to prefilter the potential settings? Maybe <code>range(..path).rev().take_while(|(root, _)| path.starts_with(root)).last()</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-19 21:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_cli/src/commands/check.rs</code>:68 on 2023-09-19 21:14</div>
            <div class="timeline-body"><p>Back to the old behavior</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_macros/src/cache_key.rs</code>:1 on 2023-09-19 21:15</div>
            <div class="timeline-body"><p>I added logic to ignore fields from the generated <code>CacheKey</code> implementation</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-19 21:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2023-09-19 21:30</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/resolver-settings">CodSpeed Performance Report</a></h2>
<h3>Merging #7520 will <strong>improve performances by 2.46%</strong></h3>
<p><sub>Comparing <code>resolver-settings</code> (5b14236) with <code>main</code> (297ec2c)</sub></p>
<h3>Summary</h3>
<p><code>‚ö° 1</code> improvements
<code>‚úÖ 24</code> untouched benchmarks</p>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>main</code> | <code>resolver-settings</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ‚ö° | <code>linter/all-rules[numpy/ctypeslib.py]</code> | 35.1 ms | 34.2 ms | +2.46% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-19 22:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_workspace/src/resolver.rs</code>:117 on 2023-09-19 22:33</div>
            <div class="timeline-body"><p>I think the intent here is just to iterate from longest path to shortest. I'm not sure if that answers your question...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-20 06:12</div>
            <div class="timeline-body"><p>I'm closing this. My initial understanding was that the intention of <code>AllSettings</code> is to store settings that only apply to globally, but <code>cache-key</code> proves that this isn't the point. The main purpose solely seems to be that settings on <code>CliSettings</code> are CLI only, and should not be part of the cache key</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-09-20 06:12</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 02:39:47 UTC
    </footer>
</body>
</html>
