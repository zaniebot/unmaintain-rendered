<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avoid panic in invalid pattern recovery - astral-sh/ruff #10966</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Avoid panic in invalid pattern recovery</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10966">#10966</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-04-16 04:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-16 04:46</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR avoids the panic when trying to recover from an invalid pattern.</p>
<p>The panic occurs because there's no way to represent <code>x as y</code> syntax as a Python expression. There were few cases which were not accounted for when working on this.</p>
<p>The cases where it would panic are the ones where only a subset of pattern is valid in a position but all patterns are valid in a nested position of the mentioned top-level pattern.</p>
<p>For example, consider a mapping pattern and the following points:</p>
<ul>
<li>Key position can only be a <code>MatchValue</code> and <code>MatchSingleton</code></li>
<li><code>MatchClass</code> can contain a <code>MatchAs</code> as an argument</li>
<li><code>MatchAs</code> pattern with both pattern and name (<code>a as b</code>) cannot be converted to a valid expression</li>
</ul>
<p>Considering this, if a mapping pattern has a class pattern with an <code>as</code> pattern as one of it's argument, the parser would panic.</p>
<pre><code class="language-py">match subject:
	case {Foo(a as b): 1}: ...
#        ^^^^^^^^^^^^^^^^ mapping pattern
#         ^^^^^^^^^^^     mapping pattern key, class pattern
#             ^^^^^^      as pattern with both pattern and name
</code></pre>
<p>The same case is for complex literal patterns as well.</p>
<p>I'm not sure what the recovery should look like but for now it's better to avoid the panic and create an invalid expression node in it's place.</p>
<h2>Test Plan</h2>
<p>Add new test cases and update the snapshots.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dhruvmanila on 2024-04-16 04:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by @dhruvmanila on 2024-04-16 04:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fuzzer</span> added by @dhruvmanila on 2024-04-16 04:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2024-04-16 04:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/pattern.rs</code>:176 on 2024-04-16 04:55</div>
            <div class="timeline-body"><p>This isn't required now that we don't panic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/pattern.rs</code>:216 on 2024-04-16 04:56</div>
            <div class="timeline-body"><p>Same here, we don't panic so no need for the comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-04-16 04:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-04-16 05:05</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+5 -52 violations, +0 -0 fixes in 3 projects; 41 projects unchanged)</p>
<details><summary><a href="https://github.com/bokeh/bokeh">bokeh/bokeh</a> (+0 -1 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/events.py#L182'>src/bokeh/events.py:182:9:</a> PLW0642 Invalid assignment to `cls` argument in class method
</pre>

</p>
</details>
<details><summary><a href="https://github.com/pandas-dev/pandas">pandas-dev/pandas</a> (+0 -51 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/arrays/categorical.py#L568'>pandas/core/arrays/categorical.py:568:13:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/arrays/datetimelike.py#L1083'>pandas/core/arrays/datetimelike.py:1083:9:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/arrays/datetimelike.py#L1098'>pandas/core/arrays/datetimelike.py:1098:9:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/arrays/datetimelike.py#L1099'>pandas/core/arrays/datetimelike.py:1099:9:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/arrays/datetimelike.py#L1127'>pandas/core/arrays/datetimelike.py:1127:9:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/arrays/datetimelike.py#L1136'>pandas/core/arrays/datetimelike.py:1136:9:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/arrays/datetimelike.py#L1147'>pandas/core/arrays/datetimelike.py:1147:9:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/arrays/datetimelike.py#L1149'>pandas/core/arrays/datetimelike.py:1149:9:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/arrays/datetimelike.py#L1154'>pandas/core/arrays/datetimelike.py:1154:9:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/arrays/datetimelike.py#L1203'>pandas/core/arrays/datetimelike.py:1203:9:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/arrays/datetimelike.py#L1205'>pandas/core/arrays/datetimelike.py:1205:9:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/arrays/datetimelike.py#L1221'>pandas/core/arrays/datetimelike.py:1221:9:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/arrays/datetimelike.py#L1278'>pandas/core/arrays/datetimelike.py:1278:13:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/arrays/datetimelike.py#L1292'>pandas/core/arrays/datetimelike.py:1292:9:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/arrays/datetimelike.py#L1498'>pandas/core/arrays/datetimelike.py:1498:13:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/arrays/datetimelike.py#L1717'>pandas/core/arrays/datetimelike.py:1717:13:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/arrays/datetimelike.py#L2144'>pandas/core/arrays/datetimelike.py:2144:17:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/arrays/datetimelike.py#L2166'>pandas/core/arrays/datetimelike.py:2166:13:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/arrays/datetimelike.py#L455'>pandas/core/arrays/datetimelike.py:455:17:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/arrays/datetimelike.py#L806'>pandas/core/arrays/datetimelike.py:806:13:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/arrays/datetimelike.py#L997'>pandas/core/arrays/datetimelike.py:997:13:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/frame.py#L7715'>pandas/core/frame.py:7715:9:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/frame.py#L7728'>pandas/core/frame.py:7728:9:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/frame.py#L8071'>pandas/core/frame.py:8071:9:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/frame.py#L8083'>pandas/core/frame.py:8083:21:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/frame.py#L8123'>pandas/core/frame.py:8123:9:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/generic.py#L3407'>pandas/core/generic.py:3407:13:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/generic.py#L3568'>pandas/core/generic.py:3568:9:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/generic.py#L7902'>pandas/core/generic.py:7902:17:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/generic.py#L7905'>pandas/core/generic.py:7905:17:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/generic.py#L7908'>pandas/core/generic.py:7908:17:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/generic.py#L9165'>pandas/core/generic.py:9165:13:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/generic.py#L9172'>pandas/core/generic.py:9172:17:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/generic.py#L9175'>pandas/core/generic.py:9175:17:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/groupby/grouper.py#L249'>pandas/core/groupby/grouper.py:249:13:</a> PLW0642 Invalid assignment to `cls` argument in class method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/indexes/base.py#L1329'>pandas/core/indexes/base.py:1329:13:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/indexes/base.py#L2130'>pandas/core/indexes/base.py:2130:9:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/indexes/base.py#L2913'>pandas/core/indexes/base.py:2913:13:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/indexes/base.py#L3061'>pandas/core/indexes/base.py:3061:13:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/indexes/base.py#L3293'>pandas/core/indexes/base.py:3293:13:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/indexes/base.py#L4384'>pandas/core/indexes/base.py:4384:13:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/indexes/base.py#L5958'>pandas/core/indexes/base.py:5958:17:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/indexes/base.py#L5962'>pandas/core/indexes/base.py:5962:20:</a> PLW0642 Invalid assignment to `self` argument in instance method
- <a href='https://github.com/pandas-dev/pandas/blob/888b6bc1bb3fdf203dda64e50336db4eb9b1e778/pandas/core/internals/blocks.py#L1122'>pandas/core/internals/blocks.py:1122:13:</a> PLW0642 Invalid assignment to `self` argument in instance method
... 7 additional changes omitted for project
</pre>

</p>
</details>
<details><summary><a href="https://github.com/zulip/zulip">zulip/zulip</a> (+5 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/zulip/zulip/blob/1abd356a910aa4a36a763f0a7834d2d5dddbd6fb/scripts/lib/zulip_tools.py#L601'>scripts/lib/zulip_tools.py:601:1:</a> E302 [*] Expected 2 blank lines, found 0
+ <a href='https://github.com/zulip/zulip/blob/1abd356a910aa4a36a763f0a7834d2d5dddbd6fb/zerver/decorator.py#L556'>zerver/decorator.py:556:1:</a> E302 [*] Expected 2 blank lines, found 0
+ <a href='https://github.com/zulip/zulip/blob/1abd356a910aa4a36a763f0a7834d2d5dddbd6fb/zerver/lib/validator.py#L268'>zerver/lib/validator.py:268:1:</a> E302 [*] Expected 2 blank lines, found 0
+ <a href='https://github.com/zulip/zulip/blob/1abd356a910aa4a36a763f0a7834d2d5dddbd6fb/zproject/config.py#L33'>zproject/config.py:33:1:</a> E302 [*] Expected 2 blank lines, found 0
+ <a href='https://github.com/zulip/zulip/blob/1abd356a910aa4a36a763f0a7834d2d5dddbd6fb/zproject/config.py#L56'>zproject/config.py:56:1:</a> E302 [*] Expected 2 blank lines, found 0
</pre>

</p>
</details>
<details><summary>Changes by rule (2 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PLW0642 | 52 | 0 | 52 | 0 | 0 |
| E302 | 5 | 5 | 0 | 0 | 0 |</p>
</p>
</details>

<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/tests/snapshots/invalid_syntax@statements__match__invalid_mapping_pattern.py.snap</code>:415 on 2024-04-16 06:13</div>
            <div class="timeline-body"><p>I'm surprised that the parsing both drops the <code>a</code> and <code>as b</code> parts. Is this intentional?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-04-16 06:22</div>
            <div class="timeline-body"><p>Would you mind opening an issue for reworking the pattern recovery? I'm okay removing the panic branch for the release but I think we need to rething the pattern recovery holistically and either recover less (e.g. return the left hand side if positioned at a <code>-</code> or <code>+</code> and the left isn't a number), or change the AST structure to allow for better recovery.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-04-16 06:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/tests/snapshots/invalid_syntax@statements__match__invalid_mapping_pattern.py.snap</code>:415 on 2024-04-16 06:43</div>
            <div class="timeline-body"><p>Yes, we're replacing the <code>as</code> pattern with an invalid expression node when the conversion takes place in pattern error recovery. If not, the parser would panic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2024-04-16 10:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-04-16 10:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-04-16 10:40</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 22:37:36 UTC
    </footer>
</body>
</html>
