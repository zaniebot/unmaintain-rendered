```yaml
number: 7269
title: Bool expression comment placement
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: bool-op-binary-like
created_at: 2023-09-11T13:31:38Z
updated_at: 2023-09-12T07:06:29Z
url: https://github.com/astral-sh/ruff/pull/7269
synced_at: 2026-01-12T02:45:39Z
```

# Bool expression comment placement

---

_Pull request opened by @MichaReiser on 2023-09-11 13:31_

## Summary

This PR fixes all comment placement issues for boolean expression (`and`, `or`) for the django project by 

a) Rewriting the boolean expression formatting to use the BinaryLike formatting to get consistent formatting for all binary like expressions
b) Making `a\n # comment\n and b` a trailing comment of `a` the same as for binary expressions
c) Respecting whether a comment was inside or outside of the parentheses when formatting a parenthesized expression. 

Closes #7004
Closes #6062

## Test Plan

Added tests

**this PR**

| project      | similarity index  | total files       | changed files     |
|--------------|------------------:|------------------:|------------------:|
| **cpython**      |           0.76084 |              1789 |              1632 | :)
| **django**       |           0.99979 |              2760 |                45 | :)
| **transformers** |           0.99944 |              2587 |               413 | :)
| twine        |           1.00000 |                33 |                 0 | -
| typeshed     |           0.99978 |              3496 |              2173 |
| **warehouse**    |           0.99834 |               648 |                20 | :)
| **zulip**        |           0.99956 |              1437 |                23 | :)




**main**
| project      | similarity index  | total files       | changed files     |
|--------------|------------------:|------------------:|------------------:|
| cpython      |           0.76083 |              1789 |              1632 |
| django       |           0.99966 |              2760 |                58 |
| transformers |           0.99930 |              2587 |               447 |
| twine        |           1.00000 |                33 |                 0 |
| typeshed     |           0.99978 |              3496 |              2173 |
| warehouse    |           0.99825 |               648 |                22 |
| zulip        |           0.99950 |              1437 |                27 |


---

_Comment by @MichaReiser on 2023-09-11 13:31_

Current dependencies on/for this PR:
* main
  * **PR #7269** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7269" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  üëà

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7269?utm_source=stack-comment).

---

_Label `formatter` added by @MichaReiser on 2023-09-11 13:33_

---

_Review requested from @konstin by @MichaReiser on 2023-09-11 13:37_

---

_Marked ready for review by @MichaReiser on 2023-09-11 13:38_

---

_Review comment by @konstin on `crates/ruff_python_formatter/resources/test/fixtures/ruff/expression/boolean_operation.py`:123 on 2023-09-11 13:41_

can you shrink those examples a bit?

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/comments/placement.rs`:843 on 2023-09-11 14:18_

```suggestion
/// Attach own line comments before an `and` or `or` in a binary expression to the preceding operand.
```

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/binary_like.rs`:635 on 2023-09-11 14:19_

nit: consider moving this case into its own function

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/binary_like.rs`:642 on 2023-09-11 14:43_

Does rposition still do the right thing with multiple parentheses?

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/binary_like.rs`:644 on 2023-09-11 14:44_

this logic is hard to follow, could you add comment(s)? i think is works like below

```
z = (
# a
(
# b: this is the comment we extract
(
# c
x and y
))))
```

---

_@konstin approved on 2023-09-11 14:47_

---

_Comment by @konstin on 2023-09-11 14:48_

nice work on the compatibility!

---

_@MichaReiser reviewed on 2023-09-12 06:04_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/binary_like.rs`:642 on 2023-09-12 06:04_

I added a new test to `binary.py`. Whether it is subjective: 

```
(
               # comment
               (1 << (n + i-j + n-1))) # NW-SE ordinal
```

The `# comment` gets moved out of the parentheses because the formatter removes the unnecessary outer most parentheses. 

```python
    # comment
    (1 << (n + i - j + n - 1))  # NW-SE ordinal
```

I think that's fine and the result is stable.

---

_Comment by @codspeed-hq[bot] on 2023-09-12 06:32_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/bool-op-binary-like)

### Merging #7269 will **degrade performances by 3.73%**

<sub>Comparing <code>bool-op-binary-like</code> (6ffae39) with <code>main</code> (babf8d7)</sub>



### Summary

`‚ùå 5 (üëÅ 5)` regressions
`‚úÖ 20` untouched benchmarks




### Benchmarks breakdown

|     | Benchmark | `main` | `bool-op-binary-like` | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| üëÅ | `linter/all-rules[numpy/ctypeslib.py]` | 33.5 ms | 34.5 ms | -3.01% |
| üëÅ | `linter/all-rules[unicode/pypinyin.py]` | 15.2 ms | 15.7 ms | -2.89% |
| üëÅ | `linter/all-rules[pydantic/types.py]` | 70 ms | 72.3 ms | -3.14% |
| üëÅ | `linter/all-rules[large/dataset.py]` | 156.9 ms | 162.9 ms | -3.73% |
| üëÅ | `linter/all-rules[numpy/globals.py]` | 4 ms | 4.1 ms | -2.6% |


---

_Merged by @MichaReiser on 2023-09-12 06:39_

---

_Closed by @MichaReiser on 2023-09-12 06:39_

---

_Branch deleted on 2023-09-12 06:39_

---

_@konstin reviewed on 2023-09-12 07:06_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/binary_like.rs`:838 on 2023-09-12 07:06_

thanks! :100:

---
