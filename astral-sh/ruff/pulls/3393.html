<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ignore multiply-assigned variables in RET504 - astral-sh/ruff #3393</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Ignore multiply-assigned variables in RET504</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/3393">#3393</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-03-08 00:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><p>This PR acts on the suggestion from #2950 to avoid RET504 errors when a variable is assigned to multiple times. As-is, we have too many false positives like:</p>
<pre><code class="language-py">def get_queryset(option_1, option_2):
    queryset = Model.filter(a=1)
    if option_1:
        queryset = queryset.filter(b=2)
    if option_2:
        queryset = queryset.filter(c=3)
    return queryset
</code></pre>
<p>Instead, this rule will now only flag more trivial cases of &quot;assign-then-return&quot;, like:</p>
<pre><code class="language-py">def get_queryset():
    queryset = Model.filter(a=1)
    return queryset
</code></pre>
<p>It's possible that this is <em>too</em> conservative, since we no longer flag cases like:</p>
<pre><code class="language-py">def get_queryset():
    queryset = Model.filter(a=1)
    queryset = queryset.filter(c=3)
    return queryset
</code></pre>
<p>But, I actually think that's reasonable -- if you're multiply-assigning, you're often doing something like a fluent interface or a conditional assignment, and in those cases, it actually seems totally fine (preferable, even) to separate the operation chain from the return.</p>
<p>Closes #2950.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-03-08 00:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-03-09 00:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-03-09 00:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-03-09 00:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2023-03-09 19:56</div>
            <div class="timeline-body"><p>Note: the &quot;fix&quot; for case one was to write:</p>
<pre><code class="language-python">def get_queryset(option_1, option_2):
    queryset = Model.filter(a=1)
    if option_1:
        queryset = queryset.filter(b=2)
    if option_2:
        return queryset.filter(c=3)
    return queryset
</code></pre>
<p>Which wasn't obvious at first, and made it seem like it was misbehaving. After seeing it in place (usually <code>option1</code> and <code>option2</code> are not as symmetric as they seem above), I actually like it a bit better - it makes parsing the logic a bit simpler, as there's less overwriting of the same variable.</p>
<p>And</p>
<pre><code class="language-python">def get_queryset():
    queryset = Model.filter(a=1)
    return queryset.filter(c=3)
</code></pre>
<p>is <em>way</em> better, IMO, as it completely skips overwriting this variable. This &quot;fluent&quot; style won't work with static typing checking most of the time either, so I think it's fine to disable this check if you are using it and really want the extra line. I mean, if you don't like a check you don't have to use it? <code>¯\_(ツ)_/¯</code></p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:56:33 UTC
    </footer>
</body>
</html>
