<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Replace LALRPOP parser with hand-written parser - astral-sh/ruff #10036</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Replace LALRPOP parser with hand-written parser</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10036">#10036</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-02-19 04:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><p>(Supersedes #9152, authored by @LaBatata101)</p>
Summary
<p>This PR replaces the current parser generated from LALRPOP to a hand-written recursive descent parser.</p>
<p>It also updates the grammar for <a href="https://peps.python.org/pep-0646/">PEP 646</a> so that the parser outputs the correct AST. For example, in <code>data[*x]</code>, the index expression is now a tuple with a single starred expression instead of just a starred expression.</p>
<p>Beyond the performance improvements, the parser is also error resilient and can provide better error messages. The behavior as seen by any downstream tools isn&#x27;t changed. That is, the linter and formatter can still assume that the parser will <em>stop</em> at the first syntax error. This will be updated in the following months.</p>
<p>For more details about the change here, refer to the PR corresponding to the individual commits and the <a href="https://astral.sh/blog/ruff-v0.4.0">release blog post</a>.</p>
Test Plan
<p>Write <em>lots</em> and <em>lots</em> of tests for both valid and invalid syntax and verify the output.</p>
Acknowledgements
<ul>
<li>@MichaReiser for reviewing 100+ parser PRs and continuously providing guidance throughout the project</li>
<li>@LaBatata101 for initiating the transition to a hand-written parser in #9152</li>
<li>@addisoncrump for implementing the fuzzer which helped <a href="https://github.com/astral-sh/ruff/pull/10903">catch</a> <a href="https://github.com/astral-sh/ruff/pull/10910">a</a> <a href="https://github.com/astral-sh/ruff/pull/10966">lot</a> <a href="https://github.com/astral-sh/ruff/pull/10896">of</a> <a href="https://github.com/astral-sh/ruff/pull/10877">bugs</a></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-02-19 04:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-02-19 04:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-03-07 10:42</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/dhruv/parser">CodSpeed Performance Report</a>
Merging #10036 will <strong>improve performances by ×2.4</strong>
<p>Comparing <code>dhruv/parser</code> (98a7669) with <code>main</code> (e09180b)</p>
Summary
<p><code>⚡ 7</code> improvements
<code>✅ 23</code> untouched benchmarks</p>
Benchmarks breakdown
<p>|     | Benchmark | <code>main</code> | <code>dhruv/parser</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ⚡ | <code>linter/all-rules[unicode/pypinyin.py]</code> | 9.6 ms | 8.6 ms | +11.63% |
| ⚡ | <code>linter/all-with-preview-rules[unicode/pypinyin.py]</code> | 11.1 ms | 10.1 ms | +9.95% |
| ⚡ | <code>parser[large/dataset.py]</code> | 63.6 ms | 26.6 ms | ×2.4 |
| ⚡ | <code>parser[numpy/ctypeslib.py]</code> | 10.8 ms | 5 ms | ×2.2 |
| ⚡ | <code>parser[numpy/globals.py]</code> | 964.6 µs | 424.9 µs | ×2.3 |
| ⚡ | <code>parser[pydantic/types.py]</code> | 24.4 ms | 10.9 ms | ×2.2 |
| ⚡ | <code>parser[unicode/pypinyin.py]</code> | 3.8 ms | 1.7 ms | ×2.2 |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-03-12 12:52</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+1 -1 violations, +0 -0 fixes in 1 projects; 43 projects unchanged)</p>
<a href="https://github.com/demisto/content">demisto/content</a> (+1 -1 violations, +0 -0 fixes)
<p>

<pre>
+ <a href="https://github.com/demisto/content/blob/ab3a6a1d58ab6943adf406e58d12c9b1b1cddfc1/Packs/ThreatQ/Integrations/ThreatQ/ThreatQ.py#L106">Packs/ThreatQ/Integrations/ThreatQ/ThreatQ.py:106:12:</a> E999 SyntaxError: Multiple exception types must be parenthesized
- <a href="https://github.com/demisto/content/blob/ab3a6a1d58ab6943adf406e58d12c9b1b1cddfc1/Packs/ThreatQ/Integrations/ThreatQ/ThreatQ.py#L106">Packs/ThreatQ/Integrations/ThreatQ/ThreatQ.py:106:21:</a> E999 SyntaxError: Unexpected token &#x27;,&#x27;
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| E999 | 2 | 1 | 1 | 0 | 0 |</p>
</p>


Linter (preview)
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+1 -1 violations, +0 -0 fixes in 1 projects; 43 projects unchanged)</p>
<a href="https://github.com/demisto/content">demisto/content</a> (+1 -1 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/demisto/content/blob/ab3a6a1d58ab6943adf406e58d12c9b1b1cddfc1/Packs/ThreatQ/Integrations/ThreatQ/ThreatQ.py#L106">Packs/ThreatQ/Integrations/ThreatQ/ThreatQ.py:106:12:</a> E999 SyntaxError: Multiple exception types must be parenthesized
- <a href="https://github.com/demisto/content/blob/ab3a6a1d58ab6943adf406e58d12c9b1b1cddfc1/Packs/ThreatQ/Integrations/ThreatQ/ThreatQ.py#L106">Packs/ThreatQ/Integrations/ThreatQ/ThreatQ.py:106:21:</a> E999 SyntaxError: Unexpected token &#x27;,&#x27;
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| E999 | 2 | 1 | 1 | 0 | 0 |</p>
</p>


Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;v0.4.0&quot; by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-15 13:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-04-17 19:03</div>
            <div class="timeline-body"><p><img src="https://media3.giphy.com/media/bZBmitwUwKtDa/200w.gif?cid=6c09b952wajidy9mwmiqqi2y0rvn0o7tktanlk5g60j4p2kv&amp;ep=v1_gifs_search&amp;rid=200w.gif&amp;ct=g"></p>
<p>Ship It! ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-18 10:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-18 10:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-18 10:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/comparable.rs</code>:237 on 2024-04-18 10:43</div>
            <div class="timeline-body"><p>Do we still need this <code>Invalid</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-04-18 10:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-04-18 10:45</div>
            <div class="timeline-body"><p>One obligatory comment :P Excellent work. Looking forward to my next git pull</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-04-18 10:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_ast/src/comparable.rs</code>:237 on 2024-04-18 10:55</div>
            <div class="timeline-body"><p>How did you even find this? xD</p>
<p>No, I&#x27;ll remove it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on 2024-04-18 11:29</div>
            <div class="timeline-body"><p>:rocket: Let me know if I can help with further testing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-18 12:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-18 12:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-04-18 12:27</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:01:44 UTC
    </footer>
</body>
</html>
