<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-comprehensions`] Preserve trailing commas for single-element lists (`C409`) - astral-sh/ruff #19571</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-comprehensions</code>] Preserve trailing commas for single-element lists (<code>C409</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19571">#19571</a>
        opened by <a href="https://github.com/danparizher">@danparizher</a>
        on 2025-07-26 18:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/danparizher">@danparizher</a> on 2025-07-26 18:16</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes #19568</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-26 18:26</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @ntBre on 2025-07-26 18:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_comprehensions/rules/unnecessary_literal_within_tuple_call.rs</code>:129 on 2025-07-28 20:50</div>
            <div class="timeline-body"><p>These two checks, <code>needs_trailing_comma</code> and <code>has_trailing_comma</code> aren't mutually exclusive. We may need to either add a new comma (<code>needs_trailing_comma</code>) or preserve it (<code>has_trailing_comma</code>). You can see that deleting <code>needs_trailing_comma</code> was wrong because the <code>t6</code> test case below has now lost its comma.</p>
<p>I'm wondering if we could reuse the token-based check for <code>has_trailing_comma</code> too, but the main issue first is restoring the old functionality.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> requested changes on 2025-07-28 20:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @danparizher on 2025-07-30 05:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ntBre on 2025-08-07 19:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @ntBre on 2025-08-07 19:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`flake8_comprehensions`] Fix `C409` to preserve trailing commas in tuple calls" to "[`flake8-comprehensions`] Fix `C409` to preserve trailing commas in tuple calls" by @ntBre on 2025-08-07 19:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-08-07 20:26</div>
            <div class="timeline-body"><p>Okay I looked at this much more closely today, and I believe the only diff we needed was this:</p>
<pre><code class="language-diff">diff --git a/crates/ruff_linter/src/rules/flake8_comprehensions/rules/unnecessary_literal_within_tuple_call.rs b/crates/ruff_linter/src/rules/flake8_comprehensions/rules/unnecessary_literal_within_tuple_call.rs
index b2d3af263f..30a250e7ce 100644
--- a/crates/ruff_linter/src/rules/flake8_comprehensions/rules/unnecessary_literal_within_tuple_call.rs
+++ b/crates/ruff_linter/src/rules/flake8_comprehensions/rules/unnecessary_literal_within_tuple_call.rs
@@ -124,7 +124,7 @@ pub(crate) fn unnecessary_literal_within_tuple_call(
                 let needs_trailing_comma = if let [item] = elts.as_slice() {
                     SimpleTokenizer::new(
                         checker.locator().contents(),
-                        TextRange::new(item.end(), call.end()),
+                        TextRange::new(item.end(), argument.end()),
                     )
                     .all(|token| token.kind != SimpleTokenKind::Comma)
                 } else {
</code></pre>
<p>This preserves the comma in <code>tuple([1],)</code> and also doesn't add an unnecessary comma to the <code>t10</code> case (<code>t10 = (1, 2,)</code> in the current fix).</p>
<p>We shouldn't check the tokens all the way to the end of the call because those are not preserved.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_comprehensions/rules/unnecessary_literal_within_tuple_call.rs</code>:132 on 2025-08-08 18:48</div>
            <div class="timeline-body"><p>You should be able to revert all of this with the change I suggested.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-08-08 18:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-09-18 13:22</div>
            <div class="timeline-body"><p>@danparizher do you plan to come back to this or should we close this PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @danparizher on 2025-09-19 02:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-09-19 13:24</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`flake8-comprehensions`] Fix `C409` to preserve trailing commas in tuple calls" to "[`flake8-comprehensions`] Preserve trailing commas for single-element lists (`C409`)" by @ntBre on 2025-09-19 13:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-09-19 13:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-09-19 13:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-09-19 13:36</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:40:52 UTC
    </footer>
</body>
</html>
