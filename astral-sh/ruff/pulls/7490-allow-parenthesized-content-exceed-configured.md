```yaml
number: 7490
title: Allow parenthesized content exceed configured line width
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: allow-overflow
created_at: 2023-09-18T10:15:08Z
updated_at: 2023-09-20T06:39:26Z
url: https://github.com/astral-sh/ruff/pull/7490
synced_at: 2026-01-12T02:39:10Z
```

# Allow parenthesized content exceed configured line width

---

_Pull request opened by @MichaReiser on 2023-09-18 10:15_

## Summary

This PR changes the formatting for all `parenthesized` expressions to exceed the configured line width without breaking the enclosing expression. This is only relevant for the optional parentheses (`can_omit_optional_parentheses`) layout (used by `maybe_parenthesize_expression`). 

The basic idea is that when the content of a parenthesized expression doesn't fit when breaking after the opening `(`, `[`, or `{`, then adding an extra indentation level won't help either. 


```python
# Input
assert items == [
    "a very very very very very very very very very very very very very very very long string",
]

# Ruff before

assert (
    items
    == [
        "a very very very very very very very very very very very very very very very long string",
    ]
)

# After this PR (same as black)
assert items == [
    "a very very very very very very very very very very very very very very very long string",
]
```

You can see in the above example that adding the extra parentheses can never make the string fit, it's simply too long (this becomes less of a problem with the preview string splitting but can still happen with very long identifier names)


This change is implemented by changing the definition of `fits_expanded` to allow for text overflows when the condition is met (the optional parentheses are omitted). 

Closes #7431

Fixes Poetry's assert diffs https://github.com/python-poetry/poetry/compare/master...Secrus:poetry:ruff-formatter#diff-5f9be6a1e39172bd52265fbad21be3b1d184c0856263f30c21ff941e73dfb594L425

## Test Plan

Added tests


**Main**

| project      | similarity index  | total files       | changed files     |
|--------------|------------------:|------------------:|------------------:|
| cpython      |           0.76083 |              1789 |              1631 |
| django       |           0.99983 |              2760 |                36 |
| transformers |           0.99956 |              2587 |               404 |
| twine        |           1.00000 |                33 |                 0 |
| typeshed     |           0.99983 |              3496 |                18 |
| warehouse    |           0.99929 |               648 |                16 |
| zulip        |           0.99969 |              1437 |                21 |


**PR** 
| project      | similarity index  | total files       | changed files     |
|--------------|------------------:|------------------:|------------------:|
| cpython      |           0.76083 |              1789 |              1631 |
| django       |           0.99983 |              2760 |                36 |
| transformers |           0.99956 |              2587 |               404 |
| twine        |           1.00000 |                33 |                 0 |
| typeshed     |           0.99983 |              3496 |                18 |
| **warehouse**    |           0.99967 |               648 |                15 |
| **zulip**        |           0.99972 |              1437 |                21 |



---

_Comment by @MichaReiser on 2023-09-18 10:15_

Current dependencies on/for this PR:
* main
  * **PR #7490** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7490" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #6857** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6857" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7490?utm_source=stack-comment).

---

_Label `formatter` added by @MichaReiser on 2023-09-18 15:21_

---

_Comment by @codspeed-hq[bot] on 2023-09-19 06:31_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/allow-overflow)

### Merging #7490 will **not alter performance**

<sub>Comparing <code>allow-overflow</code> (86bc539) with <code>main</code> (6a4dbd6)</sub>



### Summary

`âœ… 25` untouched benchmarks






---

_Renamed from "Potential fix for overlong parenthesized content" to "Allow parenthesized content exceed configured line width" by @MichaReiser on 2023-09-19 06:44_

---

_Review comment by @MichaReiser on `crates/ruff_formatter/src/printer/mod.rs`:1399 on 2023-09-19 06:49_

This is the main change. Adding a match on `args.mode()` is mainly to align it with how other group-like IR  elements get formatted and avoids extra work in `PrintMode::Expanded`

---

_@MichaReiser reviewed on 2023-09-19 06:49_

---

_@MichaReiser reviewed on 2023-09-19 06:50_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/parentheses.rs`:185 on 2023-09-19 06:50_

We need to move the parentheses out because we want the group outer group to break if the opening or closing parentheses don't fit on the line.

---

_Marked ready for review by @MichaReiser on 2023-09-19 06:53_

---

_Review comment by @konstin on `crates/ruff_python_formatter/resources/test/fixtures/ruff/expression/binary.py`:403 on 2023-09-19 11:11_

i'd flatten this and expand the lines instead

---

_@konstin approved on 2023-09-19 11:16_

---

_Review requested from @charliermarsh by @MichaReiser on 2023-09-20 06:39_

---

_Merged by @MichaReiser on 2023-09-20 06:39_

---

_Closed by @MichaReiser on 2023-09-20 06:39_

---

_Branch deleted on 2023-09-20 06:39_

---
