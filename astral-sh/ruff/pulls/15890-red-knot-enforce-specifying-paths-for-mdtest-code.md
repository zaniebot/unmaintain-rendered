```yaml
number: 15890
title: "[red-knot] Enforce specifying paths for mdtest code blocks in a separate preceding line"
type: pull_request
state: merged
author: InSyncWithFoo
labels:
  - testing
  - ty
assignees: []
merged: true
base: main
head: rk-mdtests-paths-2
created_at: 2025-02-02T23:47:28Z
updated_at: 2025-02-04T20:06:00Z
url: https://github.com/astral-sh/ruff/pull/15890
synced_at: 2026-01-10T19:57:22Z
```

# [red-knot] Enforce specifying paths for mdtest code blocks in a separate preceding line

---

_Pull request opened by @InSyncWithFoo on 2025-02-02 23:47_

## Summary

Resolves #15695, rework of #15704.

This change modifies the Mdtests framework so that:

* Paths must now be specified in a separate preceding line:

	`````markdown
	`a.py`:

	```py
	x = 1
	```
	`````

	If the path of a file conflicts with its `lang`, an error will be thrown.

* Configs are no longer accepted. The pattern still take them into account, however, to avoid "Unterminated code block" errors.
* Unnamed files are now assigned unique, `lang`-respecting paths automatically.

Additionally, all legacy usages have been updated.

## Test Plan

Unit tests and Markdown tests.


---

_Review requested from @carljm by @InSyncWithFoo on 2025-02-02 23:47_

---

_Review requested from @MichaReiser by @InSyncWithFoo on 2025-02-02 23:47_

---

_Review requested from @AlexWaygood by @InSyncWithFoo on 2025-02-02 23:47_

---

_Review requested from @sharkdp by @InSyncWithFoo on 2025-02-02 23:47_

---

_Label `red-knot` added by @AlexWaygood on 2025-02-02 23:49_

---

_Label `testing` added by @AlexWaygood on 2025-02-02 23:49_

---

_Comment by @InSyncWithFoo on 2025-02-02 23:58_

Removing unnecessary paths is a tedious task and thus not tackled in this PR. If anyone wants to do so, please, be my guest.

---

_@sharkdp reviewed on 2025-02-03 09:06_

---

_Review comment by @sharkdp on `crates/red_knot_test/README.md`:1 on 2025-02-03 09:06_

There is still a now-outdated reference to `path=…` in this README.

---

_@sharkdp reviewed on 2025-02-03 09:20_

---

_Review comment by @sharkdp on `crates/red_knot_test/src/parser.rs`:168 on 2025-02-03 09:20_

The mandatory colon looks like something that's easy to miss. Should we make it optional in the pattern here, capture whether it's present or not, and then show an error if it's missing? Otherwise, if someone forgets to use one, it might be more difficult to debug what's wrong.

---

_@sharkdp reviewed on 2025-02-03 09:23_

---

_Review comment by @sharkdp on `crates/red_knot_test/src/parser.rs`:381 on 2025-02-03 09:23_

Do we want an exception for `lang=text` here?

---

_@sharkdp reviewed on 2025-02-03 09:24_

---

_Review comment by @sharkdp on `crates/red_knot_test/src/parser.rs`:382 on 2025-02-03 09:24_

Maybe
```suggestion
                    "File ending of test file path `{explicit_path}` does not match `lang={lang}` of code block"
```

---

_@sharkdp reviewed on 2025-02-03 09:24_

---

_Review comment by @sharkdp on `crates/red_knot_test/src/parser.rs`:394 on 2025-02-03 09:24_

Should we match on `"py"` explicitly, and show an error for unsupported extensions?

---

_@sharkdp reviewed on 2025-02-03 09:27_

---

_Review comment by @sharkdp on `crates/red_knot_test/src/parser.rs`:359 on 2025-02-03 09:27_

I misunderstood this message completely at first. I thought `toml`-configs would not be allowed anymore for some reason. Maybe something like:

```suggestion
            return Err(anyhow::anyhow!("Trailing code-block metadata is not supported. Only the code block language can be specified."));
```

---

_@sharkdp reviewed on 2025-02-03 09:32_

---

_Review comment by @sharkdp on `crates/red_knot_test/src/parser.rs`:855 on 2025-02-03 09:32_

Maybe we should give those autogenerated file names a more distinct name, and not just `test_#.py`? `test_1.py` is simple enough that someone might actually want to use it. Something like `mdtest_snippet_#.py` or `mdtest_{mangled_test_name}_#.py` would be much more unlikely to generate a clash, and we could forbid this pattern from being used in the explicit path name.

---

_@sharkdp requested changes on 2025-02-03 09:34_

Thank you! I think we can improve the error message for developers a bit, but otherwise this looks great.

---

_@InSyncWithFoo reviewed on 2025-02-03 14:56_

---

_Review comment by @InSyncWithFoo on `crates/red_knot_test/src/parser.rs`:168 on 2025-02-03 14:56_

I thought it would be problematic if something like this were to be considered a named block:

`````markdown
Lorem ipsum dolor sit amet consectetur adipiscing
`elit`  <!-- Typo: No dot -->

```python
x = 1
```
`````

---

_@InSyncWithFoo reviewed on 2025-02-03 15:00_

---

_Review comment by @InSyncWithFoo on `crates/red_knot_test/README.md`:1 on 2025-02-03 15:00_

I wasn't sure what to do with this. Maybe the entire section should be removed?

---

_Review comment by @MichaReiser on `crates/red_knot_test/src/lib.rs`:114 on 2025-02-03 15:00_

```suggestion
                project_root.join(&embedded.path)
```

---

_@MichaReiser reviewed on 2025-02-03 15:00_

---

_Review comment by @MichaReiser on `crates/red_knot_test/src/lib.rs`:112 on 2025-02-03 15:00_

I'm not a 100% sure if this works but maybe?

```suggestion
                SystemPathBuf::from(&embedded.path)
```

---

_@MichaReiser reviewed on 2025-02-03 15:00_

---

_@InSyncWithFoo reviewed on 2025-02-03 15:18_

---

_Review comment by @InSyncWithFoo on `crates/red_knot_test/src/lib.rs`:112 on 2025-02-03 15:18_

Nope, this doesn't compile. The other one does, though.

---

_@sharkdp reviewed on 2025-02-03 19:01_

---

_Review comment by @sharkdp on `crates/red_knot_test/README.md`:1 on 2025-02-03 19:01_

I don't think we should remove the "Asserting on full diagnostic output" section. It's something we still plan to do (see also: https://github.com/astral-sh/ruff/issues/15867). Maybe rephrase that section as (remove the part about incremental tests):

> By default, an `output` block will specify diagnostic output for the file `<workspace-root>/test.py`.
An `output` block can be prefixed by a `<path>:` label as usual, to explicitly specify the Python file for which it
asserts diagnostic output.

---

_@sharkdp reviewed on 2025-02-03 19:05_

---

_Review comment by @sharkdp on `crates/red_knot_test/src/parser.rs`:168 on 2025-02-03 19:05_

I think we should do something about that. That's a disadvantage of specifying the path outside the code snippet. Someone might write something like:

````
A long sentence that forces a line break .... this also works with
`int`:
```py
…
```
````

And it looks like we would currently treat this as being a code block for a file named `int`. I guess we could enforce two newlines before `<path>:`?

---

_@carljm reviewed on 2025-02-03 19:41_

---

_Review comment by @carljm on `crates/red_knot_test/src/parser.rs`:168 on 2025-02-03 19:41_

Yes, I think requiring two consecutive newlines before the path would reduce the potential for error, without ruling out any formatting we would want to use; I don't think we'd ever want the file path to be closely visually associated with the preceding line/paragraph.

---

_@carljm approved on 2025-02-03 19:50_

Other than the change to require two newlines before the path, this looks good to me. Thank you @InSyncWithFoo !

It looks like this doesn't implement @sharkdp 's suggestion from #15704 that consecutive unnamed code blocks would be merged into a single file. I like that idea, but I also think it's probably better if we leave that as a separate change/improvement, rather than adding it to this PR. We could file an issue to track the idea?

---

_Review comment by @carljm on `crates/red_knot_test/src/parser.rs`:297 on 2025-02-03 22:43_

I don't see any test failures if this stays marked as `unreachable!()`, so I think I will revert this change? It seems better to catch unexpected cases faster.

---

_@carljm approved on 2025-02-03 23:06_

Looks good! Thanks for all the thorough tests!

It looks to me like the updates to `README.md` need a bit of work still, I think it'll be easiest if I just make some additional updates there and then merge.

There's also one code change I commented inline that I think I will revert, unless there's a reason for it that I'm not seeing.

---

_Comment by @carljm on 2025-02-03 23:14_

@sharkdp I will hold off on merging this since you still have a change-request on it; go ahead and merge if it looks OK to you?

---

_@sharkdp approved on 2025-02-04 07:26_

Thank you very much!

---

_Merged by @sharkdp on 2025-02-04 07:27_

---

_Closed by @sharkdp on 2025-02-04 07:27_

---

_Branch deleted on 2025-02-04 20:06_

---
