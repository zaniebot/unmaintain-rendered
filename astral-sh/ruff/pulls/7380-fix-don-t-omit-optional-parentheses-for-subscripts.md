```yaml
number: 7380
title: "fix: Don't omit optional parentheses for subscripts"
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: dont-omit-optional-parens-for-subscript
created_at: 2023-09-14T08:34:34Z
updated_at: 2023-09-14T08:43:54Z
url: https://github.com/astral-sh/ruff/pull/7380
synced_at: 2026-01-12T15:55:23Z
```

# fix: Don't omit optional parentheses for subscripts

---

_@MichaReiser_

## Summary

Closes https://github.com/astral-sh/ruff/issues/7319

Ruff formatted

```python
def f():
    return (
        package_version is not None
        and package_version.split(".")[:2] == package_info.version.split(".")[:2]
    )
```

as 

```python
def f():
    return package_version is not None and package_version.split(".")[
        :2
    ] == package_info.version.split(".")[:2]
```

Because our `can_omit_parentheses` returned `true` when an expression starts or ends with a subscript whereas Black's does not. 

https://github.com/psf/black/blob/c160e4b7ce30c661ac4f2dfa5038becf1b8c5c33/src/black/lines.py#L969-L973

This PR excludes Subscript from `can_omit_parentheses`.

## Test Plan

Added test plan

**Base**
| project      | similarity index  | total files       | changed files     |
|--------------|------------------:|------------------:|------------------:|
| cpython      |           0.76083 |              1789 |              1632 |
| django       |           0.99981 |              2760 |                40 |
| transformers |           0.99944 |              2587 |               413 |
| twine        |           1.00000 |                33 |                 0 |
| typeshed     |           0.99983 |              3496 |                18 |
| warehouse    |           0.99834 |               648 |                20 |
| zulip        |           0.99956 |              1437 |                23 |


**This PR**
| project      | similarity index  | total files       | changed files     |
|--------------|------------------:|------------------:|------------------:|
| cpython      |           0.76083 |              1789 |              1632 |
| **django**       |           0.99981 |              2760 |                39 |
| **transformers** |           0.99952 |              2587 |               408 |
| twine        |           1.00000 |                33 |                 0 |
| typeshed     |           0.99983 |              3496 |                18 |
| **warehouse**    |           0.99923 |               648 |                18 |
| zulip        |           0.99956 |              1437 |                23 |


---

_Comment by @MichaReiser on 2023-09-14 08:34_

Current dependencies on/for this PR:
* main
  * **PR #7380** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7380" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7380?utm_source=stack-comment).

---

_Label `formatter` added by @MichaReiser on 2023-09-14 08:34_

---

_Marked ready for review by @MichaReiser on 2023-09-14 08:39_

---

_@konstin approved on 2023-09-14 08:41_

this looks much better! i wonder if this still holds up with really complex subscripts that you sometimes have have with numpy/pandas? Intuitively, only breaking when `()`/`[]`,`{}` have sufficiently complex content would make sense, but i don't want to start trying to determine what content is complex enough

---

_Comment by @MichaReiser on 2023-09-14 08:43_

> this looks much better! i wonder if this still holds up with really complex subscripts that you sometimes have have with numpy/pandas? Intuitively, only breaking when `()`/`[]`,`{}` have sufficiently complex content would make sense, but i don't want to start trying to determine what content is complex enough

I prefer just to add the parentheses, especially if parts of the expression are complicated. 

---

_Merged by @MichaReiser on 2023-09-14 08:43_

---

_Closed by @MichaReiser on 2023-09-14 08:43_

---

_Branch deleted on 2023-09-14 08:43_

---
