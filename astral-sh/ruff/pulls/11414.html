<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avoid flagging `__future__` annotations as required for non-evaluated type annotations - astral-sh/ruff #11414</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Avoid flagging <code>__future__</code> annotations as required for non-evaluated type annotations</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11414">#11414</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-05-13 17:22
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>If an annotation won&#x27;t be evaluated at runtime, we don&#x27;t need to flag <code>from __future__ import annotations</code> as required. This applies both to quoted annotations and annotations outside of runtime-evaluated positions, like:</p>
<pre><code>def main() -&gt; None:
    a_list: list[str] | None = []
    a_list.append(&quot;hello&quot;)
</code></pre>
<p>Closes <a href="https://github.com/astral-sh/ruff/issues/11397">astral-sh/ruff#11397</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-13 17:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Avoid flagging __future__ annotations as required for non-evaluated type annotations&quot; to &quot;Avoid flagging `__future__` annotations as required for non-evaluated type annotations&quot; by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-13 17:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-13 17:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dhruvmanila">@dhruvmanila</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-13 17:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-05-13 17:26</div>
            <div class="timeline-body"><p>Hmm, I wouldn&#x27;t do this for quoted annotations. I think it was definitely intentional in the original flake8 plugin for PEP-585 annotations in quotes to trigger this check, because otherwise UP037 won&#x27;t automatically remove the quotes for you without the <code>__future__</code> annotations import. I like the idea of ignoring annotations inside functions, though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-05-13 17:36</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>‚ÑπÔ∏è ecosystem check <strong>detected linter changes</strong>. (+0 -3 violations, +0 -0 fixes in 1 projects; 43 projects unchanged)</p>
<a href="https://github.com/zulip/zulip">zulip/zulip</a> (+0 -3 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --no-preview --select ALL</pre>
</p>
<p>

<pre>
- <a href="https://github.com/zulip/zulip/blob/91bd6e2b12d219de268cc7ad84782b61561262b5/corporate/lib/stripe.py#L3017">corporate/lib/stripe.py:3017:29:</a> FA102 Missing `from __future__ import annotations`, but uses PEP 604 union
- <a href="https://github.com/zulip/zulip/blob/91bd6e2b12d219de268cc7ad84782b61561262b5/corporate/lib/stripe.py#L3115">corporate/lib/stripe.py:3115:48:</a> FA102 Missing `from __future__ import annotations`, but uses PEP 604 union
- <a href="https://github.com/zulip/zulip/blob/91bd6e2b12d219de268cc7ad84782b61561262b5/corporate/lib/stripe.py#L915">corporate/lib/stripe.py:915:40:</a> FA102 Missing `from __future__ import annotations`, but uses PEP 604 union
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| FA102 | 3 | 0 | 3 | 0 | 0 |</p>
</p>


Linter (preview)
<p>‚ÑπÔ∏è ecosystem check <strong>detected linter changes</strong>. (+0 -3 violations, +0 -0 fixes in 1 projects; 43 projects unchanged)</p>
<a href="https://github.com/zulip/zulip">zulip/zulip</a> (+0 -3 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
- <a href="https://github.com/zulip/zulip/blob/91bd6e2b12d219de268cc7ad84782b61561262b5/corporate/lib/stripe.py#L3017">corporate/lib/stripe.py:3017:29:</a> FA102 Missing `from __future__ import annotations`, but uses PEP 604 union
- <a href="https://github.com/zulip/zulip/blob/91bd6e2b12d219de268cc7ad84782b61561262b5/corporate/lib/stripe.py#L3115">corporate/lib/stripe.py:3115:48:</a> FA102 Missing `from __future__ import annotations`, but uses PEP 604 union
- <a href="https://github.com/zulip/zulip/blob/91bd6e2b12d219de268cc7ad84782b61561262b5/corporate/lib/stripe.py#L915">corporate/lib/stripe.py:915:40:</a> FA102 Missing `from __future__ import annotations`, but uses PEP 604 union
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| FA102 | 3 | 0 | 3 | 0 | 0 |</p>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-13 17:53</div>
            <div class="timeline-body"><p>The diagnostic and documentation aren&#x27;t really correct or consistent with that use-case though, at least as-written. The messaging suggests you need this to avoid runtime errors. Almost feels like it needs an explicit message (e.g., you could remove quotes by adding this), but in that case, isn&#x27;t it <em>always</em> true that adding <code>from __future__ import annotations</code> would let you remove quotes? Regardless of the syntax you&#x27;re using?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-13 17:59</div>
            <div class="timeline-body"><p>I&#x27;m now wondering if that should be a separate rule or part of FA100? Since the type <em>can</em> be written more succinctly if you import <code>from __future__ import annotations</code>, at the very least by removing the quotes?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-05-13 18:04</div>
            <div class="timeline-body"><blockquote>
<p>The messaging suggests you need this to avoid runtime errors.</p>
</blockquote>
<p>Huh, that&#x27;s not how I&#x27;ve ever interpreted that message. The message is &quot;Missing <code>from __future__ import annotations</code>, but uses PEP 585 collection&quot; -- I always interpreted it as &quot;Missing <code>from __future__ import annotations</code>, but uses PEP 585 collection [which could be written more simply if you added this `<strong>future</strong> import]&quot;.</p>
<p>The original flake8 plugin explicitly mentions pyupgrade in its README as one of the motivations for the plugin: https://github.com/TylerYep/flake8-future-annotations?tab=readme-ov-file#flake8-future-annotations.</p>
<p>And I don&#x27;t think this rule is nearly adequate to prevent all runtime errors arising from using newer typing syntax on older versions, nor should it try to do that.</p>
<blockquote>
<p>isn&#x27;t it <em>always</em> true that adding <code>from __future__ import annotations</code> would let you remove quotes? Regardless of the syntax you&#x27;re using?</p>
</blockquote>
<p>Not necessarily... eg. removing quotes from this annotation would cause a syntax error:</p>
<pre><code>def foo() -&gt; &quot;Some kind of string&quot;:
    pass
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-05-13 18:05</div>
            <div class="timeline-body"><blockquote>
<p>I&#x27;m now wondering if that should be a separate rule or part of FA100? Since the type <em>can</em> be written more succinctly if you import <code>from __future__ import annotations</code>, at the very least by removing the quotes?</p>
</blockquote>
<p>IDK, because I&#x27;ve always thought of &quot;enabling other tools to auto-upgrade your annotations&quot; as being the <em>primary</em> motivation of the rule üòÑ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-13 18:08</div>
            <div class="timeline-body"><p>Are you mixing up FA100 and FA102? Or am I mixing them up? FA100 is the rule that tells you &quot;you can write this more succinctly if you import <code>from __future__ import annotations</code>.&quot; This PR does not modify FA100.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-13 18:10</div>
            <div class="timeline-body"><p>This rule modifies FA102, which tells you that you&#x27;re using an unsupported type annotation that <em>will</em> work if you add <code>from __future__ import annotations</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-05-13 18:20</div>
            <div class="timeline-body"><p>Argh, I should have checked more thoroughly. Yikes, and sorry :(</p>
<p>Yes, I didn&#x27;t realise there was a distinction between <code>FA100</code> and <code>FA102</code>. In that case, we should indeed make this change, as long as we still emit <code>FA100</code> on all these snippets. (But maybe we should also update <code>FA100</code> so that it&#x27;s not emitted for annotations inside functions, as well, since the <code>__future__</code> import is irrelevant in that context?)</p>
<p>It would be good if the rule summary at https://docs.astral.sh/ruff/rules/#flake8-future-annotations-fa made the distinction between the rules here a bit clearer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-13 18:21</div>
            <div class="timeline-body"><p>No need to apologize, I was also unsure. My guess is that we <em>don&#x27;t</em> emit <code>FA100</code> on the quoted ones. I&#x27;ll have to check...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/inoa-jboliveira">@inoa-jboliveira</a> on 2024-05-13 18:52</div>
            <div class="timeline-body"><p>LGTM! Thank you for such swift reply</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2024-05-20 06:05</div>
            <div class="timeline-body"><p>I think this makes sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-21 18:55</div>
            <div class="timeline-body"><p>Confirmed that we still emit <code>FA100</code> on these.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-21 18:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-21 18:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-05-21 18:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-05-21 19:01</div>
            <div class="timeline-body"><blockquote>
<p>Confirmed that we still emit <code>FA100</code> on these.</p>
</blockquote>
<p>TYVM!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TylerYep">@TylerYep</a> on 2024-05-23 21:25</div>
            <div class="timeline-body"><blockquote>
<p>If an annotation won&#x27;t be evaluated at runtime, we don&#x27;t need to flag from <strong>future</strong> import annotations as required.</p>
</blockquote>
<p>@charliermarsh  This is only accurate in Python versions 3.10+ I believe:</p>
<pre><code>Python 3.8.16 (default, Dec 20 2022, 18:52:29) 
[Clang 14.0.3 ] on darwin
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; x: list[int]
Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
TypeError: &#x27;type&#x27; object is not subscriptable
&gt;&gt;&gt; from __future__ import annotations
&gt;&gt;&gt; x: list[int]
&gt;&gt;&gt; 

</code></pre>
<pre><code>Python 3.10.13 (main, Aug 24 2023, 22:36:46) [Clang 14.0.3 (clang-1403.0.22.14.1)] on darwin
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; x: list[int]
&gt;&gt;&gt;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TylerYep">@TylerYep</a> on 2024-05-23 21:28</div>
            <div class="timeline-body"><p>But quoted ones will work regardless of the Python version:</p>
<pre><code>Python 3.8.16 (default, Dec 20 2022, 18:52:29) 
[Clang 14.0.3 ] on darwin
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; x: &quot;list[int]&quot;
&gt;&gt;&gt; 
</code></pre>
<p>I didn&#x27;t read the PR thoroughly, but wanted to make sure the lint rule is only changed for the quoted version but still flags non-quoted lowercase types without future annotations?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-23 21:29</div>
            <div class="timeline-body"><p>@TylerYep - the logic here only applies to annotated assignments within function bodies, which I believe works on all Python versions:</p>
<pre><code>def f():
    x: list[int] = 1

f()
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TylerYep">@TylerYep</a> on 2024-05-23 21:30</div>
            <div class="timeline-body"><p>Ah, makes sense, thank you for clarifying!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:04:05 UTC
    </footer>
</body>
</html>
