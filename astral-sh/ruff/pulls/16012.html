<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pass `Checker` by immutable reference to lint rules - astral-sh/ruff #16012</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Pass <code>Checker</code> by immutable reference to lint rules</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16012">#16012</a>
        opened by <a href="https://github.com/dylwil3">@dylwil3</a>
        on 2025-02-07 05:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a></div>
            <div class="timeline-body"><p>This very large PR changes the field <code>.diagnostics</code> in the <code>Checker</code> from a <code>Vec&lt;Diagnostic&gt;</code> to a <code>RefCell&lt;Vec&lt;Diagnostic&gt;&gt;</code>, adds methods to push new diagnostics to this cell, and then removes unnecessary mutability throughout all of our lint rule implementations.</p>
<p>Consequently, the compiler may now enforce what was, till now, the <em>convention</em> that the only changes to the <code>Checker</code> that can happen during a lint are the addition of diagnostics[^1].</p>
<p>The PR is best reviewed commit-by-commit. I have tried to keep the large commits limited to &quot;bulk actions that you can easily see are performing the same find/replace on a large number of files&quot;, and separate anything ad-hoc or with larger diffs. Please let me know if there&#x27;s anything else I can do to make this easier to review!</p>
<p>Many thanks to <a href="https://github.com/ast-grep/ast-grep"><code>ast-grep</code></a>, <a href="https://github.com/helix-editor/helix"><code>helix</code></a>, and good ol&#x27; fashioned<code>git</code> magic, without which this PR would have taken the rest of my natural life.</p>
<p>[^1]: And randomly also the seen variables violating <code>flake8-bugbear</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-07 05:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-07 05:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-02-07 05:50</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+1 -1 violations, +0 -0 fixes in 1 projects; 54 projects unchanged)</p>
<a href="https://github.com/apache/superset">apache/superset</a> (+1 -1 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/apache/superset/blob/c5f4a7f302f3ef763ab3deacd01cb0314789d7c7/superset/views/utils.py#L1">superset/views/utils.py:1:1:</a> CPY001 Missing copyright notice at top of file
- <a href="https://github.com/apache/superset/blob/c5f4a7f302f3ef763ab3deacd01cb0314789d7c7/superset/views/utils.py#L1">superset/views/utils.py:1:1:</a> CPY001 Missing copyright notice at top of file
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| CPY001 | 2 | 1 | 1 | 0 | 0 |</p>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:494 on 2025-02-07 07:31</div>
            <div class="timeline-body"><p>We may want to rename this method to <code>report_type_diagnostic</code> and also change its signature to take a <code>&amp;self</code> (unless you&#x27;ve already done so in a higher up commit)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:2583 on 2025-02-07 07:32</div>
            <div class="timeline-body"><p>Nit: We could add a <code>report_diagnostic_mut</code> method to discourage direct <code>self.diagnostics</code> accessors (I&#x27;m afraid from people copying this code over using <code>self.report_diagnostic</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/ambiguous_unicode_character.rs</code>:201 on 2025-02-07 07:33</div>
            <div class="timeline-body"><p>This will be slightly less performant because we now allocate a temporary <code>Vec</code> vs just writing to the <code>checker.diagnostics</code>. I think my preference here is to just pass <code>&amp;Checker</code> (and remove the <code>checker.settings</code> argument.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:16 on 2025-02-07 07:36</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-02-07 07:37</div>
            <div class="timeline-body"><p>Thank you. This is great, and thanks for taking the time to split the refactor into individual commits. It made reviewing this PR easy, even though it touches on so many files because it allowed me to skip over the &quot;mundane&quot; commits that touch most files.</p>
<p>I only have a few more minor comments. Would you happen to know what&#x27;s going on with the ecosystem check? I&#x27;m surprised why it adds and removes a diagnostic. But maybe that&#x27;s because we now return the diagnostics in a different order.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-02-07 08:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/ruff/rules/ambiguous_unicode_character.rs</code>:201 on 2025-02-07 08:03</div>
            <div class="timeline-body"><p>I tried to say this in the (extended) commit message but I think I didn&#x27;t communicate it well:</p>
<p>The helper <code>ambiguous_unicode_character</code> is used in both AST rules and a Tokens rule. The tokens rules predate the checker so I&#x27;d have to inline the logic, or make two helper functions, or do some other change, which is why I resisted.</p>
<p>But if you think the performance gain is worth splitting up the tokens vs. AST logic I can still do that!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-07 08:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/ambiguous_unicode_character.rs</code>:201 on 2025-02-07 08:05</div>
            <div class="timeline-body"><p>I must admit, I didn&#x27;t read the commit messages in detail. Shame on me!</p>
<p>I think it&#x27;s fine then. We could do something similar to Red Knot where we have a trimmed down struct for any context that can emit diagnostics but it feels overkill here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-02-07 08:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:2583 on 2025-02-07 08:08</div>
            <div class="timeline-body"><p>Should we just make <code>diagnostics</code> (and <code>flake8_bugbear_seen</code>) private? I just checked and the code compiles if I delete <code>pub(crate)</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-07 08:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:2583 on 2025-02-07 08:10</div>
            <div class="timeline-body"><p>Oh yes, please!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-07 08:22</div>
            <div class="timeline-body"><p>Thanks so much for reviewing this Micha!</p>
<p>I&#x27;m gonna look into the weird ecosystem thing in the morning... er... later <em>this</em> morning. Wow I should go to sleep...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:270 on 2025-02-07 11:37</div>
            <div class="timeline-body"><p>I believe this could just be:</p>
<pre><code>            diagnostics: RefCell::default(),
            flake8_bugbear_seen: RefCell::default(),
</code></pre>
<p>But happy to stick with what you currently have as well!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/fastapi/rules/fastapi_unused_path_parameter.rs</code>:209 on 2025-02-07 11:46</div>
            <div class="timeline-body"><p>I think the only reason we previously collected the diagnostics into an intermediate <code>Vec</code> in this rule before adding them to <code>checker.diagnostics</code> was to avoid some annoying borrow-checker issues. With this PR those borrow-checker issues are gone, so we can just do this:</p>
<pre><code>--- a/crates/ruff_linter/src/rules/fastapi/rules/fastapi_unused_path_parameter.rs
+++ b/crates/ruff_linter/src/rules/fastapi/rules/fastapi_unused_path_parameter.rs
@@ -163,7 +163,6 @@ pub(crate) fn fastapi_unused_path_parameter(
     }
 
     // Check if any of the path parameters are not in the function signature.
-    let mut diagnostics = vec![];
     for (path_param, range) in path_params {
         // Ignore invalid identifiers (e.g., `user-id`, as opposed to `user_id`)
         if !is_identifier(path_param) {
@@ -203,10 +202,8 @@ pub(crate) fn fastapi_unused_path_parameter(
                 checker.locator().contents(),
             )));
         }
-        diagnostics.push(diagnostic);
+        checker.report_diagnostic(diagnostic);
     }
-
-    checker.report_diagnostics(diagnostics);
 }
 
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_unused_arguments/rules/unused_arguments.rs</code>:408 on 2025-02-07 12:56</div>
            <div class="timeline-body"><p>I think you could avoid the intermediate allocation here by passing <code>Checker</code> around everywhere (and make a few other simplifications while you&#x27;re about it). This could be a followup, though</p>


<pre><code>diff --git a/crates/ruff_linter/src/rules/flake8_unused_arguments/rules/unused_arguments.rs b/crates/ruff_linter/src/rules/flake8_unused_arguments/rules/unused_arguments.rs
index cda67c264..8af376968 100644
--- a/crates/ruff_linter/src/rules/flake8_unused_arguments/rules/unused_arguments.rs
+++ b/crates/ruff_linter/src/rules/flake8_unused_arguments/rules/unused_arguments.rs
@@ -1,4 +1,3 @@
-use regex::Regex;
 use ruff_python_ast as ast;
 use ruff_python_ast::{Parameter, Parameters, Stmt, StmtExpr, StmtFunctionDef, StmtRaise};
 
@@ -246,15 +245,11 @@ impl Argumentable {
 }
 
 /// Check a plain function for unused arguments.
-fn function(
-    argumentable: Argumentable,
-    parameters: &amp;Parameters,
-    scope: &amp;Scope,
-    semantic: &amp;SemanticModel,
-    dummy_variable_rgx: &amp;Regex,
-    ignore_variadic_names: bool,
-    diagnostics: &amp;mut Vec&lt;Diagnostic&gt;,
-) {
+fn function(argumentable: Argumentable, parameters: &amp;Parameters, scope: &amp;Scope, checker: &amp;Checker) {
+    let ignore_variadic_names = checker
+        .settings
+        .flake8_unused_arguments
+        .ignore_variadic_names;
     let args = parameters
         .iter_non_variadic_params()
         .map(|parameter_with_default| &amp;parameter_with_default.parameter)
@@ -272,26 +267,15 @@ fn function(
                 .into_iter()
                 .skip(usize::from(ignore_variadic_names)),
         );
-    call(
-        argumentable,
-        args,
-        scope,
-        semantic,
-        dummy_variable_rgx,
-        diagnostics,
-    );
+    call(argumentable, args, scope, checker);
 }
 
 /// Check a method for unused arguments.
-fn method(
-    argumentable: Argumentable,
-    parameters: &amp;Parameters,
-    scope: &amp;Scope,
-    semantic: &amp;SemanticModel,
-    dummy_variable_rgx: &amp;Regex,
-    ignore_variadic_names: bool,
-    diagnostics: &amp;mut Vec&lt;Diagnostic&gt;,
-) {
+fn method(argumentable: Argumentable, parameters: &amp;Parameters, scope: &amp;Scope, checker: &amp;Checker) {
+    let ignore_variadic_names = checker
+        .settings
+        .flake8_unused_arguments
+        .ignore_variadic_names;
     let args = parameters
         .iter_non_variadic_params()
         .skip(1)
@@ -310,25 +294,18 @@ fn method(
                 .into_iter()
                 .skip(usize::from(ignore_variadic_names)),
         );
-    call(
-        argumentable,
-        args,
-        scope,
-        semantic,
-        dummy_variable_rgx,
-        diagnostics,
-    );
+    call(argumentable, args, scope, checker);
 }
 
 fn call&lt;&#x27;a&gt;(
     argumentable: Argumentable,
     parameters: impl Iterator&lt;Item = &amp;&#x27;a Parameter&gt;,
     scope: &amp;Scope,
-    semantic: &amp;SemanticModel,
-    dummy_variable_rgx: &amp;Regex,
-    diagnostics: &amp;mut Vec&lt;Diagnostic&gt;,
+    checker: &amp;Checker,
 ) {
-    diagnostics.extend(parameters.filter_map(|arg| {
+    let semantic = checker.semantic();
+    let dummy_variable_rgx = &amp;checker.settings.dummy_variable_rgx;
+    checker.report_diagnostics(parameters.filter_map(|arg| {
         let binding = scope
             .get(arg.name())
             .map(|binding_id| semantic.binding(binding_id))?;
@@ -405,7 +382,6 @@ pub(crate) fn is_not_implemented_stub_with_variable(
 
 /// ARG001, ARG002, ARG003, ARG004, ARG005
 pub(crate) fn unused_arguments(checker: &amp;Checker, scope: &amp;Scope) {
-    let mut diagnostics = Vec::new();
     if scope.uses_locals() {
         return;
     }
@@ -437,18 +413,7 @@ pub(crate) fn unused_arguments(checker: &amp;Checker, scope: &amp;Scope) {
                         &amp;&amp; !is_not_implemented_stub_with_variable(function_def, checker.semantic())
                         &amp;&amp; !visibility::is_overload(decorator_list, checker.semantic())
                     {
-                        function(
-                            Argumentable::Function,
-                            parameters,
-                            scope,
-                            checker.semantic(),
-                            &amp;checker.settings.dummy_variable_rgx,
-                            checker
-                                .settings
-                                .flake8_unused_arguments
-                                .ignore_variadic_names,
-                            &amp;mut diagnostics,
-                        );
+                        function(Argumentable::Function, parameters, scope, checker);
                     }
                 }
                 function_type::FunctionType::Method =&gt; {
@@ -463,18 +428,7 @@ pub(crate) fn unused_arguments(checker: &amp;Checker, scope: &amp;Scope) {
                         &amp;&amp; !visibility::is_override(decorator_list, checker.semantic())
                         &amp;&amp; !visibility::is_overload(decorator_list, checker.semantic())
                     {
-                        method(
-                            Argumentable::Method,
-                            parameters,
-                            scope,
-                            checker.semantic(),
-                            &amp;checker.settings.dummy_variable_rgx,
-                            checker
-                                .settings
-                                .flake8_unused_arguments
-                                .ignore_variadic_names,
-                            &amp;mut diagnostics,
-                        );
+                        method(Argumentable::Method, parameters, scope, checker);
                     }
                 }
                 function_type::FunctionType::ClassMethod =&gt; {
@@ -489,18 +443,7 @@ pub(crate) fn unused_arguments(checker: &amp;Checker, scope: &amp;Scope) {
                         &amp;&amp; !visibility::is_override(decorator_list, checker.semantic())
                         &amp;&amp; !visibility::is_overload(decorator_list, checker.semantic())
                     {
-                        method(
-                            Argumentable::ClassMethod,
-                            parameters,
-                            scope,
-                            checker.semantic(),
-                            &amp;checker.settings.dummy_variable_rgx,
-                            checker
-                                .settings
-                                .flake8_unused_arguments
-                                .ignore_variadic_names,
-                            &amp;mut diagnostics,
-                        );
+                        method(Argumentable::ClassMethod, parameters, scope, checker);
                     }
                 }
                 function_type::FunctionType::StaticMethod =&gt; {
@@ -515,18 +458,7 @@ pub(crate) fn unused_arguments(checker: &amp;Checker, scope: &amp;Scope) {
                         &amp;&amp; !visibility::is_override(decorator_list, checker.semantic())
                         &amp;&amp; !visibility::is_overload(decorator_list, checker.semantic())
                     {
-                        function(
-                            Argumentable::StaticMethod,
-                            parameters,
-                            scope,
-                            checker.semantic(),
-                            &amp;checker.settings.dummy_variable_rgx,
-                            checker
-                                .settings
-                                .flake8_unused_arguments
-                                .ignore_variadic_names,
-                            &amp;mut diagnostics,
-                        );
+                        function(Argumentable::StaticMethod, parameters, scope, checker);
                     }
                 }
             }
@@ -534,22 +466,10 @@ pub(crate) fn unused_arguments(checker: &amp;Checker, scope: &amp;Scope) {
         ScopeKind::Lambda(ast::ExprLambda { parameters, .. }) =&gt; {
             if let Some(parameters) = parameters {
                 if checker.enabled(Argumentable::Lambda.rule_code()) {
-                    function(
-                        Argumentable::Lambda,
-                        parameters,
-                        scope,
-                        checker.semantic(),
-                        &amp;checker.settings.dummy_variable_rgx,
-                        checker
-                            .settings
-                            .flake8_unused_arguments
-                            .ignore_variadic_names,
-                        &amp;mut diagnostics,
-                    );
+                    function(Argumentable::Lambda, parameters, scope, checker);
                 }
             }
         }
         _ =&gt; panic!(&quot;Expected ScopeKind::Function | ScopeKind::Lambda&quot;),
     }
-    checker.report_diagnostics(diagnostics);
 }
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-02-07 13:14</div>
            <div class="timeline-body"><p>This is fantastic. We should have done this a long time ago -- great work!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-02-07 14:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/flake8_unused_arguments/rules/unused_arguments.rs</code>:408 on 2025-02-07 14:33</div>
            <div class="timeline-body"><p>you make it so easy when I can just copy/paste your patch, thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-07 15:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-07 15:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:11:13 UTC
    </footer>
</body>
</html>
