<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Make `NominalInstanceType` internally wrap an enum - astral-sh/ruff #19811</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Make <code>NominalInstanceType</code> internally wrap an enum</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19811">#19811</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-08-07 17:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><p><strong>Stacked on top of https://github.com/astral-sh/ruff/pull/19669; review that PR first!</strong></p>
<hr />
<h2>Summary</h2>
<p>This implements @carljm's suggestion from https://github.com/astral-sh/ruff/pull/19669#issuecomment-3164171196, which appears to buy back almost all the performance and memory regressions from #19669. If we like this approach, I'll merge this PR into that branch shortly before merging that PR. (I'm keeping them as separate PRs for now, for ease of review.)</p>
<h2>Test Plan</h2>
<p>All existing tests pass. I don't believe this has any impact on semantics. There is still a small primer report on this PR, but it's now a bit of a mystery to me: I can't reproduce any of the &quot;diagnostics going away&quot; on the target branch of this PR, and I can reproduce all of the &quot;diagnostics being added&quot; on the target branch of this PR. I've seen slightly confusing results from mypy_primer in the past for stacked PRs; I suspect there's a subtle bug in the workflow somewhere that leads to it reporting a diagnostic diff even when there isn't one in cases like this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-08-07 17:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-07 17:23</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-07 17:41</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅</p>
<details>
<summary>Memory usage changes were detected when running on open source projects</summary>

<pre><code class="language-diff">flake8 (https://github.com/pycqa/flake8)
-     struct metadata = ~3MB
+     struct metadata = ~2MB

trio (https://github.com/python-trio/trio)
-     struct metadata = ~8MB
+     struct metadata = ~7MB

sphinx (https://github.com/sphinx-doc/sphinx)
-     struct fields = ~16MB
+     struct fields = ~15MB

prefect (https://github.com/PrefectHQ/prefect)
-     struct fields = ~35MB
+     struct fields = ~33MB
-     memo metadata = ~84MB
+     memo metadata = ~80MB

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-08-07 17:43</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_WALLTIME_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/alex%2Fremove-tuples-instance-enum?runnerMode=WallTime">CodSpeed WallTime Performance Report</a></h2>
<h3>Merging #19811 will <strong>improve performances by 63.76%</strong></h3>
<p><sub>Comparing <code>alex/remove-tuples-instance-enum</code> (dd260ae) with <code>alex/remove-tuples</code> (3436d5d)</sub></p>
<h3>Summary</h3>
<p><code>⚡ 4</code> improvements<br />
<code>✅ 3</code> untouched benchmarks</p>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ⚡ | <code>large[sympy]</code> | 41.3 s | 39.7 s | +4.08% |
| ⚡ | <code>medium[colour-science]</code> | 10.6 s | 6.5 s | +63.76% |
| ⚡ | <code>medium[pandas]</code> | 26.4 s | 24.7 s | +6.94% |
| ⚡ | <code>small[tanjun]</code> | 1.7 s | 1.6 s | +5.65% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-08-07 17:43</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_INSTRUMENTATION_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/alex%2Fremove-tuples-instance-enum?runnerMode=Instrumentation">CodSpeed Instrumentation Performance Report</a></h2>
<h3>Merging #19811 will <strong>improve performances by 6.26%</strong></h3>
<p><sub>Comparing <code>alex/remove-tuples-instance-enum</code> (dd260ae) with <code>alex/remove-tuples</code> (3436d5d)</sub></p>
<h3>Summary</h3>
<p><code>⚡ 1</code> improvements<br />
<code>✅ 41</code> untouched benchmarks</p>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ⚡ | <code>ty_micro[many_string_assignments]</code> | 73.9 ms | 69.6 ms | +6.26% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-08 11:01</div>
            <div class="timeline-body"><blockquote>
<pre><code class="language-diff">- tests/test_make.py:866:21: error[no-matching-overload] No overload of function `attrib` matches arguments
- Found 650 diagnostics
+ Found 649 diagnostics
</code></pre>
</blockquote>
<p>I don't understand why this PR would change the outcome here, but I can reproduce it locally... and this seems like an improvement. The code in question looks like this:</p>
<pre><code class="language-py">import attr
from attr._make import Factory

@attr.s
class C:
    x = attr.ib(factory=list, default=Factory(list))
</code></pre>
<p>and I think that should be allowed under this overload? https://github.com/python-attrs/attrs/blob/616adf5af936b9e690e72d740440dcfc9df25c87/src/attr/<strong>init</strong>.pyi#L211-L231</p>
<p>At runtime an exception is raised by this <code>attr.ib()</code> call:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; import attr
&gt;&gt;&gt; attr.attrib(default=attr.Factory(list), factory=list)
Traceback (most recent call last):
  File &quot;&lt;python-input-1&gt;&quot;, line 1, in &lt;module&gt;
    attr.attrib(default=attr.Factory(list), factory=list)
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/Users/alexw/dev/attrs/src/attr/_make.py&quot;, line 177, in attrib
    raise ValueError(msg)
ValueError: The `default` and `factory` arguments are mutually exclusive.
</code></pre>
<p>Mypy catches this and flags it because it has a custom (builtin) plugin for attrs, but pyright's only complaint about that snippet is:</p>
<pre><code>/Users/alexw/dev/attrs/foo.py
  /Users/alexw/dev/attrs/foo.py:6:9 - error: Dataclass field without type annotation will cause runtime exception (reportGeneralTypeIssues)
1 error, 0 warnings, 0 informations 
</code></pre>
<p>which is orthogonal to the issue of whether any of the overloads match.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-08 11:24</div>
            <div class="timeline-body"><blockquote>
<pre><code class="language-diff">+ scripts/lib/puppet_cache.py:77:10: error[no-matching-overload] No overload of function `NamedTemporaryFile` matches arguments
</code></pre>
</blockquote>
<p>but this is definitely a regression (that I can also repro locally). A minimal repro is this:</p>
<pre><code class="language-py">import tempfile

def f(x: str):
    tempfile.NamedTemporaryFile(prefix=x, suffix=&quot;.tar.gz&quot;)
</code></pre>
<p>so it looks like this PR has some unexpected effects on overload solving</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-08 13:19</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<pre><code class="language-diff">+ scripts/lib/puppet_cache.py:77:10: error[no-matching-overload] No overload of function `NamedTemporaryFile` matches arguments
</code></pre>
</blockquote>
<p>but this is definitely a regression (that I can also repro locally). A minimal repro is this:</p>
<pre><code class="language-python">import tempfile

def f(x: str):
    tempfile.NamedTemporaryFile(prefix=x, suffix=&quot;.tar.gz&quot;)
</code></pre>
<p>so it looks like this PR has some unexpected effects on overload solving</p>
</blockquote>
<p>Further investigation reveals that this is a more minimal repro:</p>
<pre><code class="language-py">def NamedTemporaryFile[T: (str, bytes)](suffix: T | None, prefix: T | None) -&gt; None: ...


def f(x: str):
    NamedTemporaryFile(prefix=x, suffix=&quot;.tar.gz&quot;)
</code></pre>
<p>The error we emit on this is:</p>
<pre><code>error[invalid-argument-type]: Argument to function `NamedTemporaryFile` is incorrect
 --&gt; bar.py:5:24
  |
4 | def f(x: str):
5 |     NamedTemporaryFile(prefix=x, suffix=&quot;.tar.gz&quot;)
  |                        ^^^^^^^^ Expected `Literal[&quot;.tar.gz&quot;] | None`, found `str`
  |
</code></pre>
<p>So it's nothing to do with overload solving; it's to do with TypeVar solving.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-08 13:26</div>
            <div class="timeline-body"><p>Hah, and the bug is in the commit that was nearly all written by Claude... that means it's not my fault, right? ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @AlexWaygood on 2025-08-08 16:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-08-08 16:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-08-08 16:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @AlexWaygood on 2025-08-08 16:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @AlexWaygood on 2025-08-08 16:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-08 17:47</div>
            <div class="timeline-body"><p>Well... there's some bad news here. I just noticed that mypy_primer runs seem to be taking a very long time on this PR branch. It looks like it takes 10 minutes to type-check static-frame with this PR branch in mypy_primer, whereas it takes around 1 minute to type-check static-frame with https://github.com/astral-sh/ruff/pull/19669. I can reproduce a severe slowdown locally on this branch for that repo too. No idea why that would be yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-08 19:08</div>
            <div class="timeline-body"><p>Okay, https://github.com/astral-sh/ruff/pull/19811/commits/fbcb8e344dac2c2065380e94b7a70f6c04ebdaae fixes the <code>static-frame</code> perf regression for me locally! It might be worthwhile for us to add <code>static-frame</code> as a benchmark -- I can look into that as a followup.</p>
<p>Edit: and it fixed it in CI as well -- mypy_primer is back to completing in ~3m!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-08 22:22</div>
            <div class="timeline-body"><blockquote>
<p>Okay, <a href="https://github.com/astral-sh/ruff/commit/fbcb8e344dac2c2065380e94b7a70f6c04ebdaae">fbcb8e3</a> fixes the <code>static-frame</code> perf regression for me locally! It might be worthwhile for us to add <code>static-frame</code> as a benchmark -- I can look into that as a followup.</p>
<p>Edit: and it fixed it in CI as well -- mypy_primer is back to completing in ~3m!</p>
</blockquote>
<p>And in fact, I'm splitting that out as a standalone change, since it improves performance relative to <code>main</code> as well: https://github.com/astral-sh/ruff/pull/19840</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-08-08 22:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @AlexWaygood on 2025-08-08 22:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/tuple.rs</code>:225 on 2025-08-10 10:03</div>
            <div class="timeline-body"><p>See https://github.com/astral-sh/ruff/pull/19669#discussion_r2264092114</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/instance.rs</code>:119 on 2025-08-10 10:07</div>
            <div class="timeline-body"><p>I moved this method from <code>class.rs</code> to <code>instance.rs</code> so that we could avoid having to materialize the <code>ClassType</code> if the instance type was an <code>ExactTuple</code> variant internally.</p>
<p>Now that I've added caching to <code>TupleType::to_class_type()</code>, this might not be a particularly significant optimisation anymore. But with our current callsites across the repo, we only ever need to know the tuple spec of instances, never the tuple spec of <code>Type::GenericAlias</code>es. So there doesn't appear to be a huge amount of downside to making this a method on <code>NominalInstanceType</code> rather than a method on <code>ClassType</code>.</p>
<p><code>slice_literal</code> could also possibly be made a method on <code>NominalInstanceType</code> rather than <code>ClassType</code>, but it doesn't seem to have any performance benefits from what I can tell locally, and it would make this PR's diff bigger.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-08-10 10:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-08-10 15:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/tuple.rs</code>:229 on 2025-08-10 15:28</div>
            <div class="timeline-body"><p>This <code>.expect()</code> call means we now panic if we're given a custom typeshed without a <code>tuple</code> class. I don't <em>love</em> this but I also think it's <em>okay</em> -- there are already classes where we panic if they're not available in typeshed, such as <code>object</code> and <code>types.ModuleType</code>. <code>tuple</code> is similarly special; I think it's okay if we effectively mandate that custom typesheds have to have a <code>tuple</code> class in them.</p>
<p>Doing this refactor without the <code>.expect()</code> call here would be quite a bit harder, I think.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-11 10:52</div>
            <div class="timeline-body"><p>I've merged the changes here directly into #19669</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-08-11 10:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-11 10:52</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:14:55 UTC
    </footer>
</body>
</html>
