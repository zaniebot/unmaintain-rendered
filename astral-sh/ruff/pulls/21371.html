<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-use-pathlib`] Fix false negatives when `dir_fd=None` is explicitly passed (`PTH106`, `PTH107`, `PTH108`, `PTH115`) - astral-sh/ruff #21371</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-use-pathlib</code>] Fix false negatives when <code>dir_fd=None</code> is explicitly passed (<code>PTH106</code>, <code>PTH107</code>, <code>PTH108</code>, <code>PTH115</code>)</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21371">#21371</a>
        opened by <a href="https://github.com/danparizher">@danparizher</a>
        on 2025-11-11 00:19
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danparizher">@danparizher</a></div>
            <div class="timeline-body">Summary
<p>Fixes false negatives in PTH106 (<code>os-rmdir</code>), PTH107 (<code>os-remove</code>), PTH108 (<code>os-unlink</code>), and PTH115 (<code>os-readlink</code>) when <code>dir_fd=None</code> is explicitly passed. These rules now correctly trigger violations even when the default <code>dir_fd</code> value is explicitly set.</p>
<p>Fixes #21342</p>
Problem Analysis
<p>The <code>check_os_pathlib_single_arg_calls</code> helper function checked <code>call.arguments.len() != 1</code> to ensure exactly one argument. However, <code>Arguments.len()</code> counts both positional and keyword arguments together.</p>
<p>When <code>dir_fd=None</code> was explicitly passed (e.g., <code>os.rmdir(&quot;path&quot;, dir_fd=None)</code>), the call had 2 arguments total (1 positional + 1 keyword), causing the function to return early and preventing the rule from triggering.</p>
Approach
<p>Modified <code>check_os_pathlib_single_arg_calls</code> to:</p>
<ol>
<li>Check for exactly one positional argument OR the main argument passed as a keyword</li>
<li>Allow <code>dir_fd=None</code> as an additional keyword argument when the main argument is present</li>
<li>Continue to suppress rules when <code>dir_fd</code> has a non-default value (since pathlib doesn&#x27;t support it)</li>
</ol>
<p>This ensures consistent behavior across all single-argument pathlib replacement rules (PTH106, PTH107, PTH108, PTH115, PTH202, PTH203).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-11 00:30</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-11-11 13:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_use_pathlib/helpers.rs</code>:62 on 2025-11-11 13:50</div>
            <div class="timeline-body"><p>Is it possible that we just needed to delete this check? I see that <code>is_keyword_only_argument_non_default</code> is already being called in at least PTH115:</p>
<p>https://github.com/astral-sh/ruff/blob/7b237d316f4099c75811527cb13dd8699ec23d1c/crates/ruff_linter/src/rules/flake8_use_pathlib/rules/os_readlink.rs#L71-L79</p>
<p>So I don&#x27;t think we should call it again here in the helper, but simply deleting the check may also not be enough.</p>
<p>It might be worth checking one of the other PTH rules that already accepts a <code>dir_fd</code> argument to see if we can copy how they work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> requested changes on 2025-11-11 13:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danparizher">@danparizher</a> reviewed on 2025-11-11 21:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/danparizher">@danparizher</a> on <code>crates/ruff_linter/src/rules/flake8_use_pathlib/helpers.rs</code>:62 on 2025-11-11 21:43</div>
            <div class="timeline-body"><p>That makes sense to me. I removed the check from the helper (it was already being done by all four callers: <code>PTH106</code>, <code>PTH107</code>, <code>PTH108</code>, <code>PTH115</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/ntBre">@ntBre</a> by <a href="https://github.com/danparizher">@danparizher</a> on 2025-11-11 22:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-11-18 20:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_use_pathlib/helpers.rs</code>:84 on 2025-11-18 20:36</div>
            <div class="timeline-body"><p>Do we need these checks? I think we already validated all of the arguments. I tried deleting this, and all of the tests still pass.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/ntBre">@ntBre</a> by <a href="https://github.com/danparizher">@danparizher</a> on 2025-11-20 00:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-12-08 23:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_use_pathlib/helpers.rs</code>:84 on 2025-12-08 23:37</div>
            <div class="timeline-body"><p>I think I intended for my comment to apply to this whole range, not just the last couple of checks. However, I realize now that we do need some kind of argument validation for these rules, but the current test cases don&#x27;t really cover it. Locally I tried removing all of this validation code, and all of the tests still pass. As one example, the rule, or at least the fix, should not apply in this case:</p>
<pre><code>os.rmdir(p, unknown_keyword=None)
</code></pre>
<p>but this triggers the diagnostic and fix on this branch.</p>
<p>I&#x27;m kind of inclined not to call <code>check_os_pathlib_single_arg_calls</code> in these rules and instead to do all of the validation in the rules themselves. That seems closer to how we handle PTH101, for example:</p>
<p>https://github.com/astral-sh/ruff/blob/df296fbac1795054cb3b14c4f728c1360298ed92/crates/ruff_linter/src/rules/flake8_use_pathlib/rules/os_chmod.rs#L101-L106</p>
<p>The nice thing about this is that we can also emit a diagnostic in the presence of unknown arguments but suppress the fix.</p>
<p>In summary, I think we should:</p>
<ol>
<li>Revert the changes to <code>check_os_pathlib_single_arg_calls</code> because I think enforcing exactly one argument is actually correct for some of the rules that use it</li>
<li>Inline <code>check_os_pathlib_single_arg_calls</code> into the rules in this PR (<code>PTH106</code>, <code>PTH107</code>, <code>PTH108</code>, and <code>PTH115</code>)</li>
<li>Modify these rules to validate their own arguments and emit a diagnostic without a fix in the presence of unknown arguments</li>
<li>Add more tests exercising the argument validation logic</li>
</ol>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:20:25 UTC
    </footer>
</body>
</html>
