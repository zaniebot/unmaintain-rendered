<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`refurb`] Implement `subclass-builtin` (`FURB189`) - astral-sh/ruff #14105</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>refurb</code>] Implement <code>subclass-builtin</code> (<code>FURB189</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14105">#14105</a>
        opened by <a href="https://github.com/sbrugman">@sbrugman</a>
        on 2024-11-05 12:21
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/sbrugman">@sbrugman</a> on 2024-11-05 12:21</div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>Implementation for one of the rules in https://github.com/astral-sh/ruff/issues/1348
Refurb only deals only with classes with a single base, however the rule is valid for any base.
(<code>str, Enum</code> is common prior to <code>StrEnum</code>)</p>
<h2>Test Plan</h2>
<p><code>cargo test</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-05 12:51</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+12 -0 violations, +0 -0 fixes in 5 projects; 49 projects unchanged)</p>
<details><summary><a href="https://github.com/apache/airflow">apache/airflow</a> (+6 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/apache/airflow/blob/a51487d89ab62ea32284bab26232349e0c7c070e/airflow/decorators/setup_teardown.py#L58'>airflow/decorators/setup_teardown.py:58:22:</a> FURB189 Subclassing `list` can be error prone, use `collections.UserList` instead
+ <a href='https://github.com/apache/airflow/blob/a51487d89ab62ea32284bab26232349e0c7c070e/airflow/io/utils/stat.py#L22'>airflow/io/utils/stat.py:22:19:</a> FURB189 Subclassing `dict` can be error prone, use `collections.UserDict` instead
+ <a href='https://github.com/apache/airflow/blob/a51487d89ab62ea32284bab26232349e0c7c070e/kubernetes_tests/test_base.py#L45'>kubernetes_tests/test_base.py:45:26:</a> FURB189 Subclassing `str` can be error prone, use `collections.UserStr` instead
+ <a href='https://github.com/apache/airflow/blob/a51487d89ab62ea32284bab26232349e0c7c070e/providers/src/airflow/providers/openlineage/utils/utils.py#L170'>providers/src/airflow/providers/openlineage/utils/utils.py:170:25:</a> FURB189 Subclassing `dict` can be error prone, use `collections.UserDict` instead
+ <a href='https://github.com/apache/airflow/blob/a51487d89ab62ea32284bab26232349e0c7c070e/providers/tests/openlineage/plugins/test_utils.py#L67'>providers/tests/openlineage/plugins/test_utils.py:67:19:</a> FURB189 Subclassing `dict` can be error prone, use `collections.UserDict` instead
+ <a href='https://github.com/apache/airflow/blob/a51487d89ab62ea32284bab26232349e0c7c070e/tests/utils/log/test_secrets_masker.py#L317'>tests/utils/log/test_secrets_masker.py:317:54:</a> FURB189 Subclassing `str` can be error prone, use `collections.UserStr` instead
</pre>

</p>
</details>
<details><summary><a href="https://github.com/bokeh/bokeh">bokeh/bokeh</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/models/plots.py#L903'>src/bokeh/models/plots.py:903:24:</a> FURB189 Subclassing `list` can be error prone, use `collections.UserList` instead
</pre>

</p>
</details>
<details><summary><a href="https://github.com/langchain-ai/langchain">langchain-ai/langchain</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/langchain-ai/langchain/blob/2cb39270ecd920adb93451c6edecc6e5b2efab30/libs/core/tests/unit_tests/stubs.py#L7'>libs/core/tests/unit_tests/stubs.py:7:14:</a> FURB189 Subclassing `str` can be error prone, use `collections.UserStr` instead
</pre>

</p>
</details>
<details><summary><a href="https://github.com/scikit-build/scikit-build-core">scikit-build/scikit-build-core</a> (+2 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/scikit-build/scikit-build-core/blob/f6e60f41e46ce13ddbd344542d1bf45743b74514/src/scikit_build_core/settings/skbuild_model.py#L31'>src/scikit_build_core/settings/skbuild_model.py:31:27:</a> FURB189 Subclassing `str` can be error prone, use `collections.UserStr` instead
+ <a href='https://github.com/scikit-build/scikit-build-core/blob/f6e60f41e46ce13ddbd344542d1bf45743b74514/src/scikit_build_core/setuptools/build_cmake.py#L214'>src/scikit_build_core/setuptools/build_cmake.py:214:24:</a> FURB189 Subclassing `list` can be error prone, use `collections.UserList` instead
</pre>

</p>
</details>
<details><summary><a href="https://github.com/indico/indico">indico/indico</a> (+2 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/indico/indico/blob/5b70ccf74a5125d22325406c52ce43c82b364170/indico/legacy/pdfinterface/latex.py#L169'>indico/legacy/pdfinterface/latex.py:169:16:</a> FURB189 Subclassing `str` can be error prone, use `collections.UserStr` instead
+ <a href='https://github.com/indico/indico/blob/5b70ccf74a5125d22325406c52ce43c82b364170/indico/modules/events/abstracts/util.py#L141'>indico/modules/events/abstracts/util.py:141:24:</a> FURB189 Subclassing `dict` can be error prone, use `collections.UserDict` instead
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| FURB189 | 12 | 12 | 0 | 0 | 0 |</p>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/refurb/rules/subclass_builtin.rs</code>:72 on 2024-11-06 04:18</div>
            <div class="timeline-body"><p>I'd prefer to pass in the <code>ast::StmtClass</code> here instead of <code>Arguments</code> as it's then clear that we're only interested in the arguments of a class and not the function.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/refurb/rules/subclass_builtin.rs</code>:93 on 2024-11-06 04:19</div>
            <div class="timeline-body"><p>nit: let's implement these directly as methods on <code>Builtins</code> like <code>symbol</code> would return <code>dict</code>/<code>list</code>/<code>str</code> and <code>user_symbol</code> would return <code>UserDict</code>/<code>UserList</code>/<code>UserStr</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/refurb/rules/subclass_builtin.rs</code>:65 on 2024-11-06 04:22</div>
            <div class="timeline-body"><p>nit: maybe <code>SupportedBuiltins</code> to highlight that these are the ones that are supported by this specific rule. There's some precedence for it at https://github.com/astral-sh/ruff/blob/4ece8e5c1e674eb0d751fa55b5a72950aa9d20f0/crates/ruff_linter/src/rules/flake8_comprehensions/rules/unnecessary_comprehension_in_call.rs#L197-L204</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/refurb/rules/subclass_builtin.rs</code>:93 on 2024-11-06 04:34</div>
            <div class="timeline-body"><p>Can we restructure this to avoid the double loop? Something like the following:</p>
<pre><code class="language-rs">for base in args {
	let Some(symbol) = checker.semantic().resolve_builtin_symbol(base) else {
		continue;
	};

	let Some(supported_builtin) = SupportedBuiltins::from_str(symbol) else {
		continue;
	};

	let mut diagnostic = ...
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/refurb/rules/subclass_builtin.rs</code>:53 on 2024-11-06 04:39</div>
            <div class="timeline-body"><p>I think we should expand the diagnostic message to be more informative, maybe something like &quot;Subclassing <code>{subclass}</code> can be error prone, use <code>collections.{replacement}</code> instead&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/refurb/rules/subclass_builtin.rs</code>:61 on 2024-11-06 04:39</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        format!(&quot;Replace with `collections.{replacement}`&quot;)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> requested changes on 2024-11-06 04:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @dhruvmanila on 2024-11-06 04:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @dhruvmanila on 2024-11-06 04:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sbrugman">@sbrugman</a> on 2024-11-06 15:53</div>
            <div class="timeline-body"><p>Thanks for the helpful pointers @dhruvmanila!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2024-11-07 04:40</div>
            <div class="timeline-body"><p>Thanks! I made a couple of minor changes:</p>
<ul>
<li>Moved the utilities below the rule logic function; we do this for all rules</li>
<li>Avoid the eager <code>.to_string</code> call for <code>user_symbol</code> method and only allocate it when creating the <code>Diagnostic</code></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-11-07 04:45</div>
            <div class="timeline-body"><p>Looking at the ecosystem changes, we might want to special case <code>(str, Enum)</code>.</p>
<blockquote>
<p>Refurb only deals only with classes with a single base, however the rule is valid for any base.</p>
</blockquote>
<p>Sorry, I missed this earlier but can you expand on why do we want to diverge from this behavior.</p>
<p>Edit: I think we <em>should</em> keep the same behavior as <code>refurb</code> and check only when there's one base class.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sbrugman">@sbrugman</a> on 2024-11-07 09:41</div>
            <div class="timeline-body"><p>Fair point. After looking at the ecosystem results, I think we indeed should stick with refurb's behaviour (at least until type inference is available).</p>
<p>Only considering classes with a single base is the least error prone.</p>
<p>It also has some false negatives which can be detected by considering multiple bases, e.g. https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/core/property/wrappers.py#L306.</p>
<p>However there are false positives for:</p>
<ul>
<li><code>str, Enum</code> is a special case already handled by another rule: https://docs.astral.sh/ruff/rules/replace-str-enum.</li>
<li>At the moment we cannot detect cases such as <code>str, SubclassOfEnum</code>: https://github.com/indico/indico/blob/5b70ccf74a5125d22325406c52ce43c82b364170/indico/modules/events/timetable/reschedule.py#L27</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/refurb/rules/subclass_builtin.rs</code>:77 on 2024-11-07 10:32</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    let [base] = &amp;**bases else {
        return;
    }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-11-07 10:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-11-07 10:34</div>
            <div class="timeline-body"><blockquote>
<p>It also has some false negatives which can be detected by considering multiple bases, e.g. <a href="https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/core/property/wrappers.py#L306">bokeh/bokeh@<code>829b2a7</code>/src/bokeh/core/property/wrappers.py#L306</a>.</p>
<p>However there are false positives for:</p>
<ul>
<li><code>str, Enum</code> is a special case already handled by another rule: <a href="https://docs.astral.sh/ruff/rules/replace-str-enum">docs.astral.sh/ruff/rules/replace-str-enum</a>.</li>
<li>At the moment we cannot detect cases such as <code>str, SubclassOfEnum</code>: <a href="https://github.com/indico/indico/blob/5b70ccf74a5125d22325406c52ce43c82b364170/indico/modules/events/timetable/reschedule.py#L27">indico/indico@<code>5b70ccf</code>/indico/modules/events/timetable/reschedule.py#L27</a></li>
</ul>
</blockquote>
<p>I think the listed limitations are a good trade-off.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2024-11-07 11:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`refurb`] Implement `subclass-builtin` (FURB189)" to "[`refurb`] Implement `subclass-builtin` (`FURB189`)" by @dhruvmanila on 2024-11-07 11:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2024-11-07 11:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-11-07 11:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-07 11:59</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 20:51:27 UTC
    </footer>
</body>
</html>
