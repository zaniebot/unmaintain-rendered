<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Use `ThinVec` for sub segments in `PlaceExpr` - astral-sh/ruff #19470</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Use <code>ThinVec</code> for sub segments in <code>PlaceExpr</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19470">#19470</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-07-21 17:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This replaces the <code>SmallVec</code> on <code>PlaceExpr</code> with a <code>ThinVec</code>. The main motivation is that many places (all symbols) have no sub segments and paying the extra cost of an empty vec (32 bytes) for each of those adds quiet a bit to overall memory usage</p>
<p>This reduces the <code>place_table</code> size by roughly 25%</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2025-07-21 17:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @MichaReiser on 2025-07-21 17:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MichaReiser on 2025-07-21 17:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MichaReiser on 2025-07-21 17:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @MichaReiser on 2025-07-21 17:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @MichaReiser on 2025-07-21 17:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2025-07-21 17:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @MichaReiser on 2025-07-21 17:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @MichaReiser by @MichaReiser on 2025-07-21 17:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @MichaReiser on 2025-07-21 17:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-21 17:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/semantic_index/place.rs</code>:54 on 2025-07-21 17:54</div>
            <div class="timeline-body"><p>I already PRd (and it's merged but not yet released) adding <code>thin_vec</code> support to the getsize crate</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-21 17:55</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅</p>
<details>
<summary>Memory usage changes were detected when running on open source projects</summary>

<pre><code class="language-diff">sphinx (https://github.com/sphinx-doc/sphinx)
-     memo fields = ~236MB
+     memo fields = ~224MB

prefect (https://github.com/PrefectHQ/prefect)
- TOTAL MEMORY USAGE: ~626MB
+ TOTAL MEMORY USAGE: ~596MB

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-21 18:02</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<details><summary><a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)</summary>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to parse examples/mcp/databricks_mcp_cookbook.ipynb:12:1:8: Simple statements must be separated by newlines or semicolons
</code></pre>
</p>
</details>

<h3>Formatter (preview)</h3>
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<details><summary><a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)</summary>
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to parse examples/mcp/databricks_mcp_cookbook.ipynb:12:1:8: Simple statements must be separated by newlines or semicolons
</code></pre>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2025-07-21 18:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/semantic_index/place.rs</code>:789 on 2025-07-21 18:14</div>
            <div class="timeline-body"><p>This <code>SmallVec</code> here is &quot;free&quot; as 4 <code>ScopedPlaceId</code>s + the tag fit into 24 bytes</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-21 18:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-21 18:16</div>
            <div class="timeline-body"><p>Nice, looks like this yields some small speedups too! https://codspeed.io/astral-sh/ruff/branches/micha%2Fplace-table-thin-vec?runnerMode=Instrumentation</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-07-21 18:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-21 18:30</div>
            <div class="timeline-body"><p>I think <code>PlaceExprSubSegment::StringSubscript</code> could also be relatively easily changed so that it wraps a <code>Box&lt;str&gt;</code> rather than a <code>String</code> -- not sure if that's worth doing or not</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-21 19:30</div>
            <div class="timeline-body"><blockquote>
<p>I think PlaceExprSubSegment::StringSubscript could also be relatively easily changed so that it wraps a Box<str> rather than a String -- not sure if that's worth doing or not</p>
</blockquote>
<p>This, unfortunately, doesn't help because <code>Name</code> is as big as a <code>String</code>.</p>
<p>An alternative to what I've done here is to split <code>PlaceTable</code> and internally track:</p>
<ul>
<li><code>symbol_map</code>: <code>HashTable&lt;ScopedSymbolId&gt;</code>,</li>
<li><code>symbols</code>: <code>IndexVec&lt;ScopedSymbolId, Symbol&gt;</code></li>
<li><code>member_map</code>: <code>HashTable&lt;ScopedMemberId&gt;</code>,</li>
<li><code>members</code>: <code>IndexVec&lt;ScopedMemberId, Member&gt;</code>, Can use a <code>SmallVec</code> because each element has at least one item.</li>
<li><code>ScopedPlaceId</code> becomes an enum over <code>ScopedSymbolId</code> and <code>ScopedMemberId</code>.</li>
</ul>
<p>I suspect that this might be slightly larger refactor but it might also help to untangle some of the complexity in <code>PlaceTable</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-07-21 22:16</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-07-21 22:17</div>
            <div class="timeline-body"><blockquote>
<p>An alternative to what I've done here is to split <code>PlaceTable</code></p>
</blockquote>
<p>Yes, I thought about this when reviewing the PR that added <code>PlaceTable</code>; I think it might be a nice refactor.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-22 05:51</div>
            <div class="timeline-body"><blockquote>
<p>Yes, I thought about this when reviewing the PR that added PlaceTable; I think it might be a nice refactor.</p>
</blockquote>
<p>I'll try to find time to look into this because it might allow us to reduce memory usage even more by changing the <code>Member</code> definition from <code>Name</code>, <code>Segments</code> to <code>ScopedSymbolId</code>, <code>Segments</code> or just a <code>Segments</code> portion</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-22 18:17</div>
            <div class="timeline-body"><blockquote>
<p>Yes, I thought about this when reviewing the PR that added PlaceTable; I think it might be a nice refactor.</p>
</blockquote>
<p>I think this would be a very nice refactor but it's also not trivial. I started and I've currently 188 errors... and many of them aren't very trivial to fix.</p>
<p>I do think that it would help clarify many things and having separate types for <code>Symbol</code> and <code>Member</code> even allows stricter typing in many cases. But, as it often is with these kind of refactors, introducing those abstractions later is sort of a pain</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-07-22 18:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-07-22 18:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-22 18:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-22 18:49</div>
            <div class="timeline-body"><p>The main blocker here is that <code>UseDefMap</code> uses a bunch of <code>IndexVec&lt;ScopedPlaceId&gt;</code>. That prevents us from splitting the <code>places</code> <code>IndexVec</code> into two.</p>
<p>We could split the hash map but there's little value in that because the main motivation is to reduce the size of <code>PlaceExpr</code> which is stored in the <code>IndexVec</code>.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:14:26 UTC
    </footer>
</body>
</html>
