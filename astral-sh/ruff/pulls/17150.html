<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Add GitHub PR annotations when mdtests fail in CI - astral-sh/ruff #17150</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Add GitHub PR annotations when mdtests fail in CI</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17150">#17150</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-04-02 12:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body">Summary
<p>This PR adds a CI job that causes GitHub to add annotations to a PR diff when mdtest assertions fail. For example:</p>

Screenshot

<p><img src="https://github.com/user-attachments/assets/bb2a649b-46ab-429d-a576-b36545940eaf" alt="image"></p>


Motivation
<p>Debugging mdtest failures locally is currently a really nice experience:</p>
<ul>
<li>Errors are displayed with pretty colours, which makes them much more readable</li>
<li>If you run the test from inside an IDE, you can CTRL-click on a path and jump directly to the line that had the failing assertion</li>
<li>If you use <a href="https://github.com/astral-sh/ruff/blob/main/crates/red_knot_python_semantic/mdtest.py"><code>mdtest.py</code></a>, you don&#x27;t even need to recompile anything after changing an assertion in an mdtest, amd the test results instantly live-update with each change to the MarkDown file</li>
</ul>
<p>Debugging mdtest failures in CI is much more unpleasant, however. Sometimes an error message is just</p>
<blockquote>
<p>[static-assert-error] Argument evaluates to <code>False</code></p>
</blockquote>
<p>...which doesn&#x27;t tell you very much unless you navigate to the line in question that has the failing mdtest assertion. The line in question might not even be touched by the PR, and even if it is, it can be hard to find the line if the PR touches many files. Unlike locally, you can&#x27;t click on the error and jump straight to the line that contains the failing assertion. You also don&#x27;t get colourised output in CI (<a href="https://github.com/astral-sh/ty/issues/235">astral-sh/ty#235</a>).</p>
<p>GitHub PR annotations should make it really easy to debug why mdtests are failing on PRs, making PR review much easier.</p>
How it works
<p>A new <code>mdtest_github_output_format</code> feature is added to the <code>red_knot_python_semantic</code> crate. When the feature is enabled, mdtest failures are printed to the terminal using <a href="https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/workflow-commands-for-github-actions#setting-an-error-message">a format that causes GitHub to attach annotations to the PR diff</a>. If the feature is not enabled, mdtest failures are printed using the same format that they were before, since that&#x27;s what is best for local development.</p>
<p>A new CI job is added to <code>ci.yaml</code> that runs only red-knot&#x27;s mdtests with this feature flag enabled. The job takes around 1m40s to run to completion on GitHub&#x27;s <code>ubuntu-latest</code> runner. The job only runs on PRs (not pushes to <code>main</code> or on <code>workflow_dispatch</code> events), and only runs if red-knot-related code changes as part of the PR.</p>
Test Plan
<p>I opened a PR to my fork <a href="https://github.com/AlexWaygood/ruff/pull/11/files">here</a> with some bogus changes to an mdtest to show what it looks like when there are failures in CI and this job has been added. Scroll down to <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_equivalent_to.md</code> on the &quot;files changed&quot; tab for that PR to see the annotations.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ci</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-02 12:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-02 12:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-02 12:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-02 12:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-02 12:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-02 12:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-02 12:35</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-02 12:42</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-02 12:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/Cargo.toml</code>:67 on 2025-04-02 12:48</div>
            <div class="timeline-body"><p>I don&#x27;t think we should use a feature for this. It seems off. I&#x27;d rather just use an environment variable for it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/lib.rs</code>:80 on 2025-04-02 12:49</div>
            <div class="timeline-body"><p>I&#x27;d prefer using <code>Concise</code> or <code>Full</code> or <code>Cli</code>. It isn&#x27;t a format that&#x27;s consumed by cargo. It&#x27;s the CLI output</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-02 12:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/Cargo.toml</code>:67 on 2025-04-02 12:50</div>
            <div class="timeline-body"><p>That&#x27;s fine by me! Wasn&#x27;t sure what would be best here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>.github/workflows/ci.yaml</code>:436 on 2025-04-02 12:51</div>
            <div class="timeline-body"><p>Is this required to be its own job or could we run this as part of the <code>linux</code> test run? I&#x27;m worried about extra CI time for the rare cases where an mdtest fails in CI</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-02 12:51</div>
            <div class="timeline-body"><p>This is cool.</p>
<p>I don&#x27;t think this should be a cargo feature, I&#x27;d use an environment variable instead. It would also be great if we can avoid that it has to run as its own job</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-02 12:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/src/lib.rs</code>:80 on 2025-04-02 12:53</div>
            <div class="timeline-body"><p>Yeah, I also considered <code>Default</code>. <code>Cli</code> works for me!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-02 13:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>.github/workflows/ci.yaml</code>:436 on 2025-04-02 13:04</div>
            <div class="timeline-body"><p>I think there&#x27;s a bunch of things that we&#x27;d ideally like, some of which are in competition with each other. The ones I&#x27;m already doing on this PR I&#x27;ve marked with ✅; the ones I&#x27;m not are marked with ❌:</p>
<ul>
<li>✅ Only run it on PRs, not pushes to <code>main</code></li>
<li>✅ Only run it if there are red-knot-related changes in the PR</li>
<li>✅ Have the job finish quickly so that annotations show up on the PR diff within a minute or two</li>
<li>✅ Have the output of this job clearly separated from the main <code>cargo test</code> output in the &quot;checks&quot; list at the bottom of a PR. The GitHub output format is <a href="https://github.com/AlexWaygood/ruff/actions/runs/14219352254/job/39843390348?pr=11">quite hard to read</a> if you try to just read what&#x27;s printed directly to the terminal.<ul>
<li>➡ This implies that the &quot;annotations&quot; test run should be its own separate job, rather than an additional step in the <code>linux</code> test run. Just because its a separate job doesn&#x27;t mean that it can&#x27;t reuse the Rust build from the <code>linux</code> job, though.</li>
</ul>
</li>
<li>❌ Only run the job if the Linux <em>build succeeds</em> (there&#x27;s no point starting the job if the PR has a compile error)<ul>
<li>➡ I think this is possible to accomplish but it might complicate the workflow a bit</li>
</ul>
</li>
<li>❌ Reuse the build from the <code>Linux</code> CI job.<ul>
<li>➡ Should be possible, but depends on the previous item</li>
</ul>
</li>
<li>❌ Only run it if the Linux <em>tests fail</em> (if the tests all pass, there&#x27;s no need to start the separate job to get the annotations).<ul>
<li>➡ Doing this would imply we&#x27;d have to wait for a full test run to either fail or succeed before starting the mdtest run that adds the annotations. That&#x27;s going to mean that it will be another 2-3 minutes before the annotations will show up on the PR diff in CI. I think I&#x27;d prefer not to do it.</li>
</ul>
</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-02 13:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>.github/workflows/ci.yaml</code>:436 on 2025-04-02 13:22</div>
            <div class="timeline-body"><p>The part I don&#x27;t understand is why it has to be its own job in the first place</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-02 13:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/tests/mdtest.rs</code>:22 on 2025-04-02 13:24</div>
            <div class="timeline-body"><p>Nit: Can we use something like <code>MDTEST_OUTPUT_FORMAT</code> or <code>MDTEST_GITHUB_OUTPUT_FORMAT</code> so that it&#x27;s clear where the environment variable is consumed (without having to search)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-02 13:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>.github/workflows/ci.yaml</code>:436 on 2025-04-02 13:24</div>
            <div class="timeline-body"><p>But I guess my concerns are addressed if we avoid rebuilding the binary and instead reuse it from the linux test run step</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-02 13:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/tests/mdtest.rs</code>:22 on 2025-04-02 13:24</div>
            <div class="timeline-body"><p>sure</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/lib.rs</code>:124 on 2025-04-02 13:24</div>
            <div class="timeline-body"><pre><code>    const fn is_cli(self) -&gt; bool {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-02 13:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-02 13:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/src/lib.rs</code>:124 on 2025-04-02 13:25</div>
            <div class="timeline-body"><p>hmm, maybe I should just derive <code>is_macro::Is</code> ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-02 13:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>.github/workflows/ci.yaml</code>:436 on 2025-04-02 13:27</div>
            <div class="timeline-body"><p>i answered that question in this bullet of my message above:</p>
<blockquote>
<p>✅ Have the output of this job clearly separated from the main <code>cargo test</code> output in the &quot;checks&quot; list at the bottom of a PR</p>
</blockquote>
<p>also note that, in addition to the rationale I gave there, I&#x27;m not totally sure how to make it so that later steps in the same job are run even if earlier jobs fail. In <a href="https://github.com/astral-sh/ruff/actions/runs/14220037782/job/39845581911?pr=17149">this workflow run</a>, for example, we never get to the <code>cargo doc --all --no-deps</code> step. The workflow aborts as soon as <code>cargo test</code> fails; later steps in that job are cancelled.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-02 13:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>.github/workflows/ci.yaml</code>:436 on 2025-04-02 13:58</div>
            <div class="timeline-body"><p>I think the easiest you could do is to not make this a dedicated job but a step that&#x27;s part of the main test job. You could even go as far as grepping to see if any mdtest failed and only then run this additional step</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-02 15:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-02 17:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-02 17:04</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/17150/commits/494ef81cd8b2edf9626f4b3f69fd759580c92c1e is my attempt at caching the build and then using it in both the <code>cargo test</code> job and the new <code>GitHub Annotations</code> job. From what I can tell, it seems to slow CI down quite a bit. Uploading and downloading the contents of <code>target/debug/deps</code> seems to take a lot longer than just building the same thing in parallel in two jobs simultaneously. Unless there&#x27;s a way of limiting the files I&#x27;m uploading more?</p>
<p>I&#x27;d be inclined to revert <a href="https://github.com/astral-sh/ruff/pull/17150">astral-sh/ruff#17150</a>/commits/494ef81cd8b2edf9626f4b3f69fd759580c92c1e and have it how it was before that commit. There is the additional advantage that the workflow file was simpler prior to that commit. But I don&#x27;t feel strongly.</p>
<p>As discussed in <a href="https://github.com/astral-sh/ruff/pull/17150#discussion_r2024763928">this comment thread</a>, I do think the new job has to be a separate job to the regular <code>cargo test</code> job. If an earlier step in a workflow job fails, you never get to the later step in the workflow job. That means that if any mdtests failed, GitHub would never run the later step that ran with the new GitHub Annotations format -- defeating the purpose of adding the new format altogether.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-02 17:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-02 17:23</div>
            <div class="timeline-body"><p>experimenting with another idea from @MichaReiser to see if we can reduce the number of times we do a Rust build in CI...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-02 17:27</div>
            <div class="timeline-body"><p>Okay great, annotations are still working on the latest version of the PR!</p>

Screenshot

<p><img src="https://github.com/user-attachments/assets/e827ce71-ce38-4df2-8c3e-bd8c8c628369" alt="image"></p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-02 17:30</div>
            <div class="timeline-body"><p>The PR is again ready for re-review :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-04-02 19:13</div>
            <div class="timeline-body"><p>Thanks, and sorry for the back and forth.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-02 20:51</div>
            <div class="timeline-body"><p>No worries, and thank you for the review. It&#x27;s much better for your suggestions!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-02 20:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-02 20:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-02 20:51</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:12:51 UTC
    </footer>
</body>
</html>
