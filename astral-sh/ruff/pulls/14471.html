<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Improve the performance of the formatter instability check job - astral-sh/ruff #14471</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Improve the performance of the formatter instability check job</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14471">#14471</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2024-11-20 00:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>We should probably get rid of this entirely and subsume it's functionality in the normal ecosystem checks? I don't think we're using the black comparison tests anymore, but maybe someone wants it?</p>
<p>There are a few major parts to this:</p>
<ol>
<li>Making the formatter script idempotent, so it can be run repeatedly and is robust to changing commits</li>
<li>Reducing the overhead of the git operations, minimizing the data transfer</li>
<li>Parallelizing all the git operations by repository</li>
</ol>
<p>This reduces the setup time from 80s to 16s (locally).</p>
<p>The initial motivation for idempotency was to include the repositories in the GitHub Actions cache. I'm not sure it's worth it yet — they're about 1GB and would consume our limited cache space. Regardless, it improves correctness for local invocations.</p>
<p>The total runtime of the job is reduced from ~4m to ~3m.</p>
<p>I also made some cosmetic changes to the output paths and such.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ci</span> added by @zanieb on 2024-11-20 00:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Improve the performance of the formatter instability checks" to "Improve the performance of the formatter instability check job" by @zanieb on 2024-11-20 01:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-20 01:17</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @zanieb on 2024-11-20 04:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-20 07:09</div>
            <div class="timeline-body"><blockquote>
<p>We should probably get rid of this entirely and subsume it's functionality in the normal ecosystem checks? I don't think we're using the black comparison tests anymore, but maybe someone wants it?</p>
</blockquote>
<p>I'm still using them because they're not only useful to assess black compatibility (which the ecosystem checks don't give us) but it also assigns a number to how compatible the stable and preview style are. The latter is mainly useful to understand: Is this a change happening very locally in a single file or does it touch every file in a repository. Something that I find difficult to assess from the ecosystem checks (because they truncate).</p>
<p>I'm also not concerned about the performance of this job. It only runs on formatter PRs and they're rare. Every formatter diff has to wait for the ecosystem check results, which tend to be much slower than any other check.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-11-20 07:09</div>
            <div class="timeline-body"><blockquote>
<p>The initial motivation for idempotency was to include the repositories in the GitHub Actions cache. I'm not sure it's worth it yet — they're about 1GB and would consume our limited cache space. Regardless, it improves correctness for local invocations.</p>
</blockquote>
<p>I don't think it's worth it. performance isn't a concern for this job and it runs to infrequently for the caches to even be useful.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-20 14:55</div>
            <div class="timeline-body"><p>Good to know you're still using it.</p>
<blockquote>
<p>I'm also not concerned about the performance of this job. It only runs on formatter PRs and they're rare. Every formatter diff has to wait for the ecosystem check results, which tend to be much slower than any other check.</p>
</blockquote>
<p>Not anymore! They run in 3m now — I'm following up on this because it's one of the slowest remaining jobs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2024-11-20 14:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-11-20 14:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-20 14:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-20 15:00</div>
            <div class="timeline-body"><p>I'm mainly saying that it's probably not worth your time. At least, I never waited for that job.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:07:52 UTC
    </footer>
</body>
</html>
