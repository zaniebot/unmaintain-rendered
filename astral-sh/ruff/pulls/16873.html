<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Add failing tests for `*` imports - astral-sh/ruff #16873</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Add failing tests for <code>*</code> imports</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16873">#16873</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-03-20 16:24
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body">Summary
<p>This PR adds a suite of tests for wildcard (<code>*</code>) imports. The tests nearly all fail for now, and those that don&#x27;t, ahem, pass for the wrong reasons...</p>
<p>I&#x27;ve tried to add TODO comments in all instances for places where we are currently inferring the incorrect thing, incorrectly emitting a diagnostic, or emitting a diagnostic with a bad error message.</p>
Test Plan
<p><code>cargo test -p red_knot_python_semantic</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-20 16:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-20 16:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-20 16:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-20 16:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-03-20 16:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/import/star.md</code>:89 on 2025-03-20 16:25</div>
            <div class="timeline-body"><p>the reason why we do <em>not</em> emit an error here is somewhat horrifying... we&#x27;re currently inserting a global-scope symbol with the name <code>&quot;*&quot;</code> in the symbol table for <code>b.py</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-20 16:34</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/import/star.md</code>:317 on 2025-03-21 00:30</div>
            <div class="timeline-body"><p>I think this could be done separately from the initial PR, but I&#x27;m guessing that&#x27;s already your plan; having it in the initial set of tests doesn&#x27;t preclude that, this test can just keep its TODOs longer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/import/star.md</code>:485 on 2025-03-21 00:33</div>
            <div class="timeline-body"><p>I would go for the first. If code is definitely wrong, even if it won&#x27;t actually error at runtime until &quot;used&quot;, I think it&#x27;s generally better if we issue the error closer to the source, and not further from the source (which might be code with a different author who can&#x27;t do anything about the problem.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/import/star.md</code>:366 on 2025-03-21 00:36</div>
            <div class="timeline-body"><p>I think in type inference we can be pretty smart here (i.e. we could support dynamic members if they evaluate to a <code>Literal[str]</code> type). The question is how we handle it in semantic indexing. If we want to allow dynamic elements of <code>__all__</code>, I think such definitions of <code>__all__</code> would need to be treated as effectively the same as no <code>__all__</code> at all (for semantic indexing purposes), meaning any name that may be defined at global scope in the module is considered to be possibly wildcard imported.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-03-21 00:37</div>
            <div class="timeline-body"><p>Looks great!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-03-21 13:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/import/star.md</code>:317 on 2025-03-21 13:29</div>
            <div class="timeline-body"><p>yup, exactly</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/import/star.md</code>:485 on 2025-03-21 13:32</div>
            <div class="timeline-body"><p>I&#x27;m sort of inclined to go for the third: emit diagnostics at both locations?</p>
<ul>
<li>Having an invalid <code>__all__</code> and having an import statement that we can say for sure will fail both seem like distinct errors that I&#x27;d want to know about if writing a Python module (even if they both have the same root cause)</li>
<li>If the module you&#x27;re importing from is third-party and has an invalid <code>__all__</code> but we only emit an error where <code>__all__</code> is defined, the user won&#x27;t get any warning that their <code>*</code> import from the third-party module will fail, since we don&#x27;t display diagnostics relating to type errors in third-party code. This isn&#x27;t that far-fetched: we&#x27;ve had several situations at typeshed where the library we&#x27;re stubbing has an invalid <code>__all__</code> and this was never detected by the library&#x27;s tests (though it was caught by typeshed&#x27;s tests!)</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-03-21 13:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-03-21 13:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/import/star.md</code>:366 on 2025-03-21 13:32</div>
            <div class="timeline-body"><p>that all makes sense to me</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-21 14:16</div>
            <div class="timeline-body"><p>Added some more tests in <a href="https://github.com/astral-sh/ruff/pull/16873">astral-sh/ruff#16873</a>/commits/7cf8eabccc38410cd4d2a71b08e7c4555e80fc90 ... I don&#x27;t <em>think</em> they&#x27;re contentious, but happy to address any comments in a followup! Merging for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-21 14:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-21 14:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-03-21 14:17</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:12:30 UTC
    </footer>
</body>
</html>
