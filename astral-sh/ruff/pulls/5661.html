<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Format `target: annotation = value?` expressions - astral-sh/ruff #5661</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Format <code>target: annotation = value?</code> expressions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5661">#5661</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-07-10 17:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">

Summary
<p>This PR implements formatting of <code>target: annotation (= value)?</code> expressions.</p>
<p>It resulted in me going down a rabbit hole because I then noticed that tuples inside of subscript should not be parenthesized. So I fixed that too.</p>


Test Plan
<p>I added new tests. I fixed the <code>skip_magic_comma</code> test to run it with magic comma disabled (This test got me really confused because one test wanted to have trailing comma and this test wanted <strong>not</strong> to have trailing commas).</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-10 17:58</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #5661</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5661"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite"></a>  ðŸ‘ˆ<ul>
<li><strong>PR #5680</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5680"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite"></a><ul>
<li><strong>PR #5683</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5683"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite"></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5661?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/builders.rs</code>:9 on 2023-07-10 18:02</div>
            <div class="timeline-body"><p>I think this name is better. The rest of the code refers to optional parentheses that we sometimes omit because they are unnecessary. These are parentheses that we always add if the content expands.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:109 on 2023-07-10 18:03</div>
            <div class="timeline-body"><p>I moved this, unchanged, to <code>parentheses.rs</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_function_def.rs</code>:100 on 2023-07-10 18:03</div>
            <div class="timeline-body"><p>Function defs are weird. They add parentheses around subscript expressions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/fixtures.rs</code>:16 on 2023-07-10 18:04</div>
            <div class="timeline-body"><p>This adds support for options for black tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/snapshots/black_compatibility@miscellaneous__force_pyi.py.snap</code>:100 on 2023-07-10 18:05</div>
            <div class="timeline-body"><p>Hmm, we&#x27;ll need into single line bodies at some point. Potentially something that our suite refactor would simplify but we shouldn&#x27;t be blocked by it.l</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/snapshots/black_compatibility@simple_cases__one_element_subscript.py.snap</code>:1 on 2023-07-10 18:05</div>
            <div class="timeline-body"><p>:partying_face:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-07-10 18:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-10 18:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-10 18:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-07-10 18:42</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>âœ… ecosystem check detected no changes.</p>
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      8.0Â±0.03ms     5.1 MB/sec    1.01      8.1Â±0.02ms     5.0 MB/sec
formatter/numpy/ctypeslib.py               1.00   1859.2Â±7.73Âµs     9.0 MB/sec    1.01   1875.0Â±5.49Âµs     8.9 MB/sec
formatter/numpy/globals.py                 1.00    206.2Â±4.40Âµs    14.3 MB/sec    1.00    206.9Â±1.26Âµs    14.3 MB/sec
formatter/pydantic/types.py                1.00      4.0Â±0.01ms     6.4 MB/sec    1.02      4.1Â±0.01ms     6.3 MB/sec
linter/all-rules/large/dataset.py          1.00     13.5Â±0.10ms     3.0 MB/sec    1.00     13.6Â±0.06ms     3.0 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.4Â±0.00ms     4.9 MB/sec    1.00      3.4Â±0.02ms     4.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    432.7Â±0.72Âµs     6.8 MB/sec    1.00    433.4Â±0.97Âµs     6.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.0Â±0.02ms     4.3 MB/sec    1.01      6.0Â±0.02ms     4.2 MB/sec
linter/default-rules/large/dataset.py      1.00      6.7Â±0.02ms     6.1 MB/sec    1.01      6.8Â±0.02ms     6.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1459.5Â±8.10Âµs    11.4 MB/sec    1.01   1468.3Â±4.07Âµs    11.3 MB/sec
linter/default-rules/numpy/globals.py      1.00    166.1Â±1.22Âµs    17.8 MB/sec    1.00    166.8Â±0.26Âµs    17.7 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.0Â±0.01ms     8.5 MB/sec    1.01      3.0Â±0.01ms     8.4 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     12.2Â±0.39ms     3.3 MB/sec    1.00     12.2Â±0.38ms     3.3 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.8Â±0.14ms     6.1 MB/sec    1.00      2.8Â±0.14ms     6.1 MB/sec
formatter/numpy/globals.py                 1.00   312.2Â±15.55Âµs     9.5 MB/sec    1.01   316.5Â±18.32Âµs     9.3 MB/sec
formatter/pydantic/types.py                1.00      5.8Â±0.20ms     4.4 MB/sec    1.05      6.1Â±0.23ms     4.2 MB/sec
linter/all-rules/large/dataset.py          1.04     21.4Â±0.63ms  1942.5 KB/sec    1.00     20.7Â±0.78ms  2012.2 KB/sec
linter/all-rules/numpy/ctypeslib.py        1.03      5.5Â±0.24ms     3.0 MB/sec    1.00      5.4Â±0.19ms     3.1 MB/sec
linter/all-rules/numpy/globals.py          1.03   664.3Â±31.46Âµs     4.4 MB/sec    1.00   642.8Â±21.80Âµs     4.6 MB/sec
linter/all-rules/pydantic/types.py         1.00      9.5Â±0.36ms     2.7 MB/sec    1.00      9.4Â±0.31ms     2.7 MB/sec
linter/default-rules/large/dataset.py      1.05     11.0Â±0.44ms     3.7 MB/sec    1.00     10.4Â±0.36ms     3.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.07      2.3Â±0.12ms     7.2 MB/sec    1.00      2.2Â±0.07ms     7.7 MB/sec
linter/default-rules/numpy/globals.py      1.01   283.2Â±13.42Âµs    10.4 MB/sec    1.00   280.9Â±23.97Âµs    10.5 MB/sec
linter/default-rules/pydantic/types.py     1.04      4.8Â±0.21ms     5.3 MB/sec    1.00      4.7Â±0.14ms     5.5 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/expr_subscript.rs</code>:93 on 2023-07-10 18:53</div>
            <div class="timeline-body"><p>this is at least have done, and i think an issue link is missing</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-07-10 19:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-11 12:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-11 12:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-11 14:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-11 14:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-07-11 14:40</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:55:13 UTC
    </footer>
</body>
</html>
