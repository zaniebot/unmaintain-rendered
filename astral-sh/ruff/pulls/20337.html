<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Integrate type context for bidirectional inference - astral-sh/ruff #20337</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Integrate type context for bidirectional inference</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20337">#20337</a>
        opened by <a href="https://github.com/ibraheemdev">@ibraheemdev</a>
        on 2025-09-10 18:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a></div>
            <div class="timeline-body">Summary
<p>Adds the infrastructure necessary to perform bidirectional type inference (<a href="https://github.com/astral-sh/ty/issues/168">astral-sh/ty#168</a>) without any typing changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">typing</span> added by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-09-10 18:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-09-10 18:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">typing</span> removed by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-09-10 18:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-09-10 18:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-10 18:39</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a>

Changes were detected when running ty on typing conformance tests

<pre><code>--- old-output.txt	2025-09-11 19:05:55.986136869 +0000
+++ new-output.txt	2025-09-11 19:05:58.979164413 +0000
@@ -1,6 +1,6 @@
 WARN ty is pre-release software and not ready for production use. Expect to encounter bugs, missing features, and fatal errors.
 fatal[panic] Panicked at /home/runner/.cargo/git/checkouts/salsa-e6f3bb7c2a062968/3713cd7/src/function/execute.rs:213:25 when checking `/home/runner/work/ruff/ruff/typing/conformance/tests/aliases_type_statement.py`: `PEP695TypeAliasType &lt; &#x27;db &gt;::value_type_(Id(b816)): execute: too many cycle iterations`
-fatal[panic] Panicked at /home/runner/.cargo/git/checkouts/salsa-e6f3bb7c2a062968/3713cd7/src/function/execute.rs:213:25 when checking `/home/runner/work/ruff/ruff/typing/conformance/tests/aliases_typealiastype.py`: `infer_definition_types(Id(12a7a)): execute: too many cycle iterations`
+fatal[panic] Panicked at /home/runner/.cargo/git/checkouts/salsa-e6f3bb7c2a062968/3713cd7/src/function/execute.rs:213:25 when checking `/home/runner/work/ruff/ruff/typing/conformance/tests/aliases_typealiastype.py`: `infer_definition_types(Id(12e7a)): execute: too many cycle iterations`
 _directives_deprecated_library.py:15:31: error[invalid-return-type] Function always implicitly returns `None`, which is not assignable to return type `int`
 _directives_deprecated_library.py:30:26: error[invalid-return-type] Function always implicitly returns `None`, which is not assignable to return type `str`
 _directives_deprecated_library.py:36:41: error[invalid-return-type] Function always implicitly returns `None`, which is not assignable to return type `Self@__add__`
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-10 18:42</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected âœ…
No memory usage changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-09-10 19:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:260 on 2025-09-10 19:56</div>
            <div class="timeline-body"><p>We never actually call <code>infer_expression_type</code> with a non-empty <code>TypeContext</code> currently, I&#x27;m not sure if that&#x27;s something that will change in the future?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:2181 on 2025-09-10 21:59</div>
            <div class="timeline-body"><p>The functions (and salsa queries) that now take a <code>TypeContext</code> are most often called with an empty one, but I&#x27;m not sure if we want to have separate functions or make the lack of a <code>TypeContext</code> explicit on every call.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-09-10 21:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-09-10 21:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-09-10 21:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-09-10 21:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-09-10 21:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-09-10 21:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-09-10 22:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:6423 on 2025-09-10 22:03</div>
            <div class="timeline-body"><p>I left this comment in a few notable places where we now have a <code>TypeContext</code> that we could use for more precise inference.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-09-10 22:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:266 on 2025-09-10 22:04</div>
            <div class="timeline-body"><p>I moved the queries into private functions because the <code>InferExpression</code> supertype is mostly an internal implementation detail.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:296 on 2025-09-10 22:08</div>
            <div class="timeline-body"><p>We also discussed splitting the queries into variants with and without a <code>TypeContext</code> as a potential workaround, but this supertype is effectively a more convenient way of doing that (internally, Salsa essentially creates a query for each variant of the input enum). The performance impact of this PR seems to be very minor with this optimization (and without it, there was a noticeable 2-3% regression).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-09-10 22:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:260 on 2025-09-11 00:27</div>
            <div class="timeline-body"><p>Hmm. This PR is great, and it&#x27;s awesome that it has negligible performance impact. And now this question is making me wonder if we don&#x27;t even need this and I mis-guided you last week? I was thinking the RHS of assignment statements was a standalone expression, but it only is for un-annotated assignment statements, not for annotated assignments. And it&#x27;s only annotated assignments and call arguments where we currently intend to apply a type context, but neither of those are standalone expressions. So it seems like at least for the initial scope here, we only need to pass type contexts internally in a <code>TypeInferenceBuilder</code>?</p>
<p>Unless I&#x27;m missing something here (@dcreager?), maybe the thing to take from this PR is that if we ever need additional context on <code>infer_type_expression</code>, now we know it can be done without a major performance regression -- but for now we should put it on ice and focus on just the internal type-contexts we need to actually implement bidirectional inference within an annotated assignment and for call arguments. (This will still involve the need to accommodate potentially multiple inferred types for a single expression, in the case of call arguments to unions of callables or overloaded callables.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-09-11 00:28</div>
            <div class="timeline-body"><p>Nice! (But see inline comment -- maybe we shouldn&#x27;t actually merge this at this point?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:296 on 2025-09-11 01:51</div>
            <div class="timeline-body"><blockquote>
<p>this supertype is effectively a more convenient way of doing that (internally, Salsa essentially creates a query for each variant of the input enum).</p>
</blockquote>
<p>That&#x27;s a nice trick, I didn&#x27;t realize that about how salsa handles the enum input</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:260 on 2025-09-11 01:54</div>
            <div class="timeline-body"><blockquote>
<p>Unless I&#x27;m missing something here</p>
</blockquote>
<p>I don&#x27;t see anything you&#x27;re missing</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-09-11 01:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-09-11 07:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:260 on 2025-09-11 07:13</div>
            <div class="timeline-body"><blockquote>
<p>I was thinking the RHS of assignment statements was a standalone expression, but it only is for un-annotated assignment statements, not for annotated assignments.</p>
</blockquote>
<p>Isn&#x27;t the right hand side of something like <code>self.t: MyTypedDict = {â€¦}</code> a standalone expression (see <a href="https://github.com/astral-sh/ruff/blob/c6b92b918e4d350e4f8aed95a41985f80ca7dfc9/crates/ty_python_semantic/src/semantic_index/builder.rs#L1647">here</a> and <a href="https://github.com/astral-sh/ruff/blob/8a0edf0da8342ae3b9fcf8d183fc289b52d64f86/crates/ty_python_semantic/src/types/infer.rs#L4629">here</a> and <a href="https://github.com/astral-sh/ruff/blob/8a0edf0da8342ae3b9fcf8d183fc289b52d64f86/crates/ty_python_semantic/src/types/infer.rs#L4721">here</a>)?</p>
<p>Maybe that&#x27;s only needed for something like <code>self.MY_CONSTANT: Final = 17</code> where the annotation contains no type (only a qualifier) though? Which could mean that it&#x27;s not important for purposes of bidirectional inference.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/AlexWaygood">@AlexWaygood</a> removed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-09-11 10:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-09-11 14:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:260 on 2025-09-11 14:19</div>
            <div class="timeline-body"><p>Aha, I <em>was</em> missing something, should have looked more carefully last night, thanks @sharkdp. I found the <code>Final</code> case yesterday but we indeed don&#x27;t need to apply any type context in that scenario (at least I don&#x27;t think we currently have plans for a bare <code>Final</code> or <code>ClassVar</code> annotation to affect inference of the RHS). But that doesn&#x27;t matter -- we now make annotated assignment RHS a standalone expression whenever it&#x27;s inside a method, so as you point out, even <code>self.x: MyTypedDict = {...}</code> inside a method (or for that matter, <code>x: MyTypedDict = {...}</code> inside a method) will have a standalone expression on the RHS. So I think we do need this PR. And we should (at some point) pass a non-empty <code>TypeContext</code> through in those places in <code>infer_annotated_assignment_statement</code> and <code>infer_annotated_assignment_definition</code> that @sharkdp linked.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-09-11 14:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:2181 on 2025-09-11 14:21</div>
            <div class="timeline-body"><p>I don&#x27;t have strong feelings here -- there&#x27;s maybe some advantage to making it explicit, and avoiding another axis on which to proliferate separate inference functions?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:260 on 2025-09-11 14:30</div>
            <div class="timeline-body"><p>It looks like already in this PR, we are (correctly) passing a non-empty <code>TypeContext</code> into <code>infer_maybe_standalone_expression</code> from <code>infer_annotated_assignment_statement</code> and <code>infer_annotated_assignment_definition</code>, which passes it through to <code>infer_standalone_expression_impl</code>, which passes it to <code>infer_expression_types</code>.</p>
<p>I think I mis-interpreted this question from @ibraheemdev entirely last night -- it&#x27;s actually a narrow question specifically about this <code>infer_expression_type</code> wrapper function, not about the <code>infer_expression_types</code> Salsa query generally. I think the answer to that question is that I don&#x27;t immediately see where we&#x27;ll use <code>infer_expression_type</code> with a non-empty <code>TypeContext</code>, but it still seems reasonable that it should accept one for consistency.</p>
<p>Sorry for mis-reading things here and not reviewing more carefully here last night; shouldn&#x27;t do reviews when short on time. But I think we are back to concluding that we should go ahead with this PR as-is, and hopefully some of the discussion above was useful context anyway ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-09-11 14:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-09-11 19:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-09-11 19:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-09-11 19:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-09-15 10:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:296 on 2025-09-15 10:04</div>
            <div class="timeline-body"><p>This is a nice solution!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:18:30 UTC
    </footer>
</body>
</html>
