<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preserve triple quotes and prefixes for strings - astral-sh/ruff #15818</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Preserve triple quotes and prefixes for strings</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15818">#15818</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-01-29 21:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a></div>
            <div class="timeline-body">Summary
<p>This is a follow-up to #15726, #15778, and #15794 to preserve the triple quote and prefix flags in plain strings, bytestrings, and f-strings.</p>
<p>I also added a <code>StringLiteralFlags::without_triple_quotes</code> method to avoid passing along triple quotes in rules like SIM905 where it might not make sense, as discussed <a href="https://github.com/astral-sh/ruff/pull/15726#discussion_r1930532426">here</a>.</p>
Test Plan
<p>Existing tests, plus many new cases in the <code>generator::tests::quote</code> test that should cover all combinations of quotes and prefixes, at least for simple string bodies.</p>
<p>Closes #7799 when combined with #15694, #15726, #15778, and #15794.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/ntBre">@ntBre</a> on 2025-01-29 21:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/ntBre">@ntBre</a> on 2025-01-29 21:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/ntBre">@ntBre</a> on 2025-01-29 21:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/ntBre">@ntBre</a> on 2025-01-29 21:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:1763 on 2025-01-29 21:58</div>
            <div class="timeline-body"><p>I wrote these before the loop below. I think they are redundant with the loop version and could be deleted.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-29 21:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-29 22:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_literal/src/escape.rs</code>:83 on 2025-01-29 22:02</div>
            <div class="timeline-body"><p>I think it might be worth defining a <code>Quote::as_triple_str</code> method and rewriting this as</p>
<pre><code>let quote = if self.triple_quote {
    self.escape.layout().quote.as_triple_str()
} else {
    self.escape.layout().quote.as_str()
};
formatter.write_str(quote)?;
</code></pre>
<p>but I just went with this simple/dumb approach first.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1489 on 2025-01-29 22:02</div>
            <div class="timeline-body"><p>could we add this method to <code>BytesLiteralFlags</code>, <code>FStringFlags</code> and <code>AnyStringFlags</code> as well? We might not need it now on those structs, but it&#x27;s nice to have a consistent interface between the various structs</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-29 22:07</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>âœ… ecosystem check detected no linter changes.</p>
Linter (preview)
<p>âœ… ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>âœ… ecosystem check detected no format changes.</p>
Formatter (preview)
<p>âœ… ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:175 on 2025-01-29 22:07</div>
            <div class="timeline-body"><pre><code>        self.p(&amp;flags.format_string_contents(body));
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:185 on 2025-01-29 22:10</div>
            <div class="timeline-body"><p>Strictly speaking, this might be slightly less performant, since <code>format_string_contents</code> allocates a new <code>String</code>. I think it&#x27;s worth it to avoid repetition, however. The <code>Generator</code> also shouldn&#x27;t be <em>terribly</em> performance-sensitive, since we only create autofixes if we found an error in the user&#x27;s code that leads us to emit a diagnostic, <em>and</em> we deem that the diagnostic is autofixable.</p>
<pre><code>            self.p(&amp;flags.format_string_contents(s));
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:196 on 2025-01-29 22:11</div>
            <div class="timeline-body"><pre><code>            .expect(&quot;Writing to a String buffer should never fail&quot;);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:161 on 2025-01-29 22:11</div>
            <div class="timeline-body"><pre><code>            .expect(&quot;Writing to a String buffer should never fail&quot;);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:1767 on 2025-01-29 22:16</div>
            <div class="timeline-body"><p>you could consider using https://docs.rs/test-case/latest/test_case/ for these -- it would mean that each example is run as a separate subtest, so if any one of them fails the other ones will still be run as separate tests. We use it for tests elsewhere in the repo, e.g. https://github.com/astral-sh/ruff/blob/15d886a50213dcd4013db028eeef15a60d182f98/crates/red_knot_python_semantic/src/types.rs#L4721-L4735</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/display.rs</code>:101 on 2025-01-29 22:20</div>
            <div class="timeline-body"><p>Because Rust doesn&#x27;t support keyword arguments, it can be a little unreadable to have functions that take boolean parameters. At a callsite like here, it can be hard to tell why a <code>bool</code> is being passed into a function. It&#x27;s often nicer to create a custom enum that can be passed into the function, e.g.</p>
<pre><code>#[derive(Debug, Copy, Clone, PartialEq, Eq)]
enum TripleQuoted {
    Yes,
    No,
}
</code></pre>
<p>And then if the parameter took an instance of this enum, this callsite could be</p>
<pre><code>                escape.bytes_repr(TripleQuoted::No).write(f)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-29 22:23</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-29 22:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:185 on 2025-01-29 22:26</div>
            <div class="timeline-body"><p>Wow thank you! I must have scrolled past this method so many times in the past few days!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-29 22:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:185 on 2025-01-29 22:28</div>
            <div class="timeline-body"><p>Hehe, it&#x27;s on the <code>StringFlags</code> trait that <code>StringLiteralFlags</code>, <code>BytesLiteralFlags</code>, <code>FStringFlags</code> and <code>AnyStringFlags</code> all implement :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-01-29 22:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-01-29 22:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-29 22:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:175 on 2025-01-29 22:40</div>
            <div class="timeline-body"><p>What did you think about the <code>str::from_utf8</code> call above this? As far as I know this should be a safe <code>unwrap</code> or <code>unreachable!</code>, but I went with this approach just in case. I figured it was better to fall back on the normal escaping code than to panic if I were wrong, but it does complicate the flow a bit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-29 23:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:1767 on 2025-01-29 23:30</div>
            <div class="timeline-body"><p>Thanks for the suggestion! I thought the <a href="https://docs.rs/test-case/latest/test_case/attr.test_matrix.html">test_matrix</a> macro looked perfect for this, but it appears to lowercase/further normalize the arguments, which causes a huge number of name conflicts for usage like this:</p>
<pre><code>    /// test all of the valid string literal prefix and quote combinations from
    /// https://docs.python.org/3/reference/lexical_analysis.html#string-and-bytes-literals
    #[test_case::test_matrix(
        [
            (&quot;r&quot;, &quot;r&quot;),
            (&quot;u&quot;, &quot;u&quot;),
            (&quot;R&quot;, &quot;R&quot;),
            (&quot;U&quot;, &quot;u&quot;), // case not tracked
            (&quot;f&quot;, &quot;f&quot;),
            (&quot;F&quot;, &quot;f&quot;),   // f case not tracked
            (&quot;fr&quot;, &quot;rf&quot;), // r before f
            (&quot;Fr&quot;, &quot;rf&quot;), // f case not tracked, r before f
            (&quot;fR&quot;, &quot;Rf&quot;), // r before f
            (&quot;FR&quot;, &quot;Rf&quot;), // f case not tracked, r before f
            (&quot;rf&quot;, &quot;rf&quot;),
            (&quot;rF&quot;, &quot;rf&quot;), // f case not tracked
            (&quot;Rf&quot;, &quot;Rf&quot;),
            (&quot;RF&quot;, &quot;Rf&quot;), // f case not tracked
            // bytestrings
            (&quot;b&quot;, &quot;b&quot;),
            (&quot;B&quot;, &quot;b&quot;),   // b case
            (&quot;br&quot;, &quot;rb&quot;), // r before b
            (&quot;Br&quot;, &quot;rb&quot;), // b case, r before b
            (&quot;bR&quot;, &quot;Rb&quot;), // r before b
            (&quot;BR&quot;, &quot;Rb&quot;), // b case, r before b
            (&quot;rb&quot;, &quot;rb&quot;),
            (&quot;rB&quot;, &quot;rb&quot;), // b case
            (&quot;Rb&quot;, &quot;Rb&quot;),
            (&quot;RB&quot;, &quot;Rb&quot;), // b case
        ],
        [&quot;\&quot;&quot;, &quot;&#x27;&quot;, &quot;\&quot;\&quot;\&quot;&quot;, &quot;&#x27;&#x27;&#x27;&quot;],
        [&quot;hello&quot;, &quot;{hello} {world}&quot;]
    )]
    fn prefix_quotes((inp, out): (&amp;str, &amp;str), quote: &amp;str, base: &amp;str) {
        let input = format!(&quot;{inp}{quote}{base}{quote}&quot;);
        let output = format!(&quot;{out}{quote}{base}{quote}&quot;);
        assert_eq!(round_trip(&amp;input), output);
    }
</code></pre>
<p>I&#x27;ve tried a few things to get around it like giving the tuples unused numeric id fields, but no luck yet. I might need to do that for both the tuples <em>and</em> the quote fields.</p>
<p>I think this might even be an issue for <a href="https://github.com/frondeus/test-case/issues/144">their docs</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-29 23:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:1767 on 2025-01-29 23:33</div>
            <div class="timeline-body"><p>Yeah okay, <code>u8</code>s on the end of those two fields did the job!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:1763 on 2025-01-30 13:37</div>
            <div class="timeline-body"><p>Yeah, it makes sense to get rid of them, I think</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:1737 on 2025-01-30 13:38</div>
            <div class="timeline-body"><p>I nearly suggested a silly change to <code>BytesRepr</code> and <code>StrRepr</code> that would have broken some edge cases. Luckily some tests failed -- but only for the <code>StrRepr</code> change; no tests failed for the <code>BytesRepr</code> change. Here&#x27;s a test that would have failed on my bad patch, which might be good to add:</p>
<pre><code>        assert_eq!(round_trip(r#&quot;&quot;he\&quot;llo&quot;&quot;#), r#&quot;&#x27;he&quot;llo&#x27;&quot;#);
        assert_eq!(round_trip(r#&quot;b&quot;he\&quot;llo&quot;&quot;#), r#&quot;b&#x27;he&quot;llo&#x27;&quot;#);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_literal/src/escape.rs</code>:34 on 2025-01-30 13:42</div>
            <div class="timeline-body"><p>nit</p>
<pre><code>    pub const fn is_yes(&amp;self) -&gt; bool {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-30 13:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-01-30 14:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_literal/src/escape.rs</code>:426 on 2025-01-30 14:58</div>
            <div class="timeline-body"><p>nit: is it worth adding a <code>write_n_char(n: usize, ch: char)</code> method?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-30 15:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_literal/src/escape.rs</code>:426 on 2025-01-30 15:30</div>
            <div class="timeline-body"><p>I just merged a commit from Alex reworking the triple quote API that I think addresses this, but I like the <code>write_n_char</code> idea too!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:172 on 2025-01-30 16:29</div>
            <div class="timeline-body"><p>I guess we could add a <code>StringFlags::write_string_contents()</code> method to avoid the allocation involved in <code>StringFlags::format_string_contents()</code>:</p>
<pre><code>diff --git a/crates/ruff_python_ast/src/nodes.rs b/crates/ruff_python_ast/src/nodes.rs
index db45b5b3d..663299c5a 100644
--- a/crates/ruff_python_ast/src/nodes.rs
+++ b/crates/ruff_python_ast/src/nodes.rs
@@ -1033,6 +1033,14 @@ pub trait StringFlags: Copy {
         let quote_str = self.quote_str();
         format!(&quot;{prefix}{quote_str}{contents}{quote_str}&quot;)
     }
+
+    fn write_string_contents(self, buffer: &amp;mut String, contents: &amp;str) {
+        let quote_str = self.quote_str();
+        buffer.push_str(self.prefix().as_str());
+        buffer.push_str(quote_str);
+        buffer.push_str(contents);
+        buffer.push_str(quote_str);
+    }
 }
 
 bitflags! {
diff --git a/crates/ruff_python_codegen/src/generator.rs b/crates/ruff_python_codegen/src/generator.rs
index 78642ec7d..4727e9009 100644
--- a/crates/ruff_python_codegen/src/generator.rs
+++ b/crates/ruff_python_codegen/src/generator.rs
@@ -168,15 +168,14 @@ impl&lt;&#x27;a&gt; Generator&lt;&#x27;a&gt; {
         s: &amp;[u8],
         flags: BytesLiteralFlags,
     ) -&gt; Result&lt;(), std::str::Utf8Error&gt; {
-        let body = std::str::from_utf8(s)?;
-        self.p(&amp;flags.format_string_contents(body));
+        flags.write_string_contents(&amp;mut self.buffer, std::str::from_utf8(s)?);
         Ok(())
     }
 
     fn p_str_repr(&amp;mut self, s: &amp;str, flags: impl Into&lt;AnyStringFlags&gt;) {
         let flags = flags.into();
         if flags.prefix().is_raw() {
-            self.p(&amp;flags.format_string_contents(s));
+            flags.write_string_contents(&amp;mut self.buffer, s);
             return;
         }
</code></pre>
<p>It would be similar to the <code>write_*</code> methods in https://github.com/astral-sh/ruff/blob/main/crates/ruff_python_literal/src/escape.rs -- except I&#x27;m not sure it needs to take any <code>impl Write</code> object; if we say it only takes an <code>&amp;mut String</code> then it doesn&#x27;t need to return a <code>Result</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_literal/src/escape.rs</code>:70 on 2025-01-30 16:29</div>
            <div class="timeline-body"><pre><code>    pub fn str_repr&lt;&#x27;r&gt;(&amp;&#x27;a self, triple_quotes: TripleQuotes) -&gt; StrRepr&lt;&#x27;r, &#x27;a&gt; {
        StrRepr {
            escape: self,
            triple_quotes,
        }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_literal/src/escape.rs</code>:76 on 2025-01-30 16:29</div>
            <div class="timeline-body"><pre><code>    triple_quotes: TripleQuotes,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_literal/src/escape.rs</code>:83 on 2025-01-30 16:30</div>
            <div class="timeline-body"><pre><code>            .with_triple_quotes_set_to(self.triple_quotes);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-30 16:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-30 17:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:172 on 2025-01-30 17:00</div>
            <div class="timeline-body"><p>This makes sense. Is it okay to skip the <code>self.num_newlines</code> checks in <code>Generator::p</code>? I&#x27;ve tended toward using that instead of writing directly to the buffer just in case, but I&#x27;m not sure exactly when it&#x27;s relevant.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-30 17:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:172 on 2025-01-30 17:07</div>
            <div class="timeline-body"><p>Uhh... IDK really. We seem to already write to the buffer directly on <code>main</code> in some places?</p>
<p>https://github.com/astral-sh/ruff/blob/b0b8b062410afdee0c9948a23fc99de8e5a406b6/crates/ruff_python_codegen/src/generator.rs#L154</p>
<p>https://github.com/astral-sh/ruff/blob/b0b8b062410afdee0c9948a23fc99de8e5a406b6/crates/ruff_python_codegen/src/generator.rs#L162</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:172 on 2025-01-30 17:17</div>
            <div class="timeline-body"><p>Oh right, at least we&#x27;ll be in good company!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-30 17:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-30 17:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:175 on 2025-01-30 17:17</div>
            <div class="timeline-body"><p>Right now it doesn&#x27;t seem like it&#x27;s possible to construct an AST node for a literal-bytes expression that includes a non-ASCII character in it: https://play.ruff.rs/0b3b0efb-74cd-4e26-a885-9180e23e4506</p>
<p>However, our parser supports error recovery and the specifics of exactly what nodes representing invalid syntax will look like are an implementation detail. Similarly, we don&#x27;t currently run any of our AST-based rules on files that contain invalid syntax (let alone try to autofix them), but that might well change in the future.</p>
<p>All told, I <em>think</em> I prefer your current approach here, though I&#x27;d also be interested in @dhruvmanila&#x27;s thoughts. It might be good to add a comment, whatever we end up doing here!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:175 on 2025-01-30 18:40</div>
            <div class="timeline-body"><p>That makes sense, thanks! I expanded my comment in <code>p_bytes_repr</code> a bit more, hopefully capturing some of this information. Otherwise I&#x27;m interested in Dhruv&#x27;s thoughts too!</p>
<p>This seems a bit separate, but I guess we could even make a stronger assertion that <code>s.iter().all(u8::is_ascii)</code> if we wanted. Although we&#x27;d still need to call <code>from_utf8</code> to get something to write in our buffer anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-30 18:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1043 on 2025-01-30 18:45</div>
            <div class="timeline-body"><p>oh, and I guess this is now a strict generalisation of the <code>format_string_contents()</code> method, so we can make now this simplification ðŸ˜„</p>
<pre><code>     fn format_string_contents(self, contents: &amp;str) -&gt; String {
-        let prefix = self.prefix();
-        let quote_str = self.quote_str();
-        format!(&quot;{prefix}{quote_str}{contents}{quote_str}&quot;)
+        let mut buffer = String::new();
+        self.write_string_contents(&amp;mut buffer, contents);
+        buffer
     }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-01-30 18:48</div>
            <div class="timeline-body"><p>Great work! The only other thing I&#x27;d do is get rid of the <code>Default</code> implementation for <code>AnyStringFlags</code>, for a consistent interface to the other <code>*Flags</code> structs</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-01-30 19:36</div>
            <div class="timeline-body"><p>Thank you! Sorry I neglected the <code>Default</code> change from our conversation earlier. It looks like <code>AnyStringFlags::default</code> is only used in <code>AnyStringFlags::new</code>. I added a private <code>empty</code> method instead for now, but I could also make <code>empty</code> public, and add all of the docs from the other <code>Flags</code>. What do you think?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-01-30 19:40</div>
            <div class="timeline-body"><blockquote>
<p>I added a private <code>empty</code> method instead for now</p>
</blockquote>
<p>That works for me! Or we could just inline it into <code>AnyStringFlags::new()</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-30 20:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1043 on 2025-01-30 20:23</div>
            <div class="timeline-body"><p>Nice! I also added an initial size for the buffer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:20 on 2025-01-30 21:04</div>
            <div class="timeline-body"><pre><code>use crate::{
    int,
    str::{Quote, TripleQuotes},
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1033 on 2025-01-30 21:05</div>
            <div class="timeline-body"><p>or maybe we could move this optimization to <code>write_string_contents()</code>?</p>
<pre><code>diff --git a/crates/ruff_python_ast/src/nodes.rs b/crates/ruff_python_ast/src/nodes.rs
index deb25ef05..da0bc5857 100644
--- a/crates/ruff_python_ast/src/nodes.rs
+++ b/crates/ruff_python_ast/src/nodes.rs
@@ -1029,13 +1029,14 @@ pub trait StringFlags: Copy {
     }
 
     fn format_string_contents(self, contents: &amp;str) -&gt; String {
-        let buf_size = self.opener_len().to_usize() + contents.len() + self.closer_len().to_usize();
-        let mut buffer = String::with_capacity(buf_size);
+        let mut buffer = String::new();
         self.write_string_contents(&amp;mut buffer, contents);
         buffer
     }
 
     fn write_string_contents(self, buffer: &amp;mut String, contents: &amp;str) {
+        buffer
+            .reserve(self.opener_len().to_usize() + contents.len() + self.closer_len().to_usize());
         let quote_str = self.quote_str();
         buffer.push_str(self.prefix().as_str());
         buffer.push_str(quote_str);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-01-30 21:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-01-30 23:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:2148 on 2025-01-31 05:41</div>
            <div class="timeline-body"><p>I&#x27;d suggest to keep the name as <code>with_triple_quotes</code> as &quot;with&quot; and &quot;set_to&quot; sounds similar and similar to getter conventions, we wouldn&#x27;t usually include the &quot;set&quot; prefix unless it&#x27;s obvious what&#x27;s being set (https://rust-lang.github.io/api-guidelines/naming.html#getter-names-follow-rust-convention-c-getter).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-01-31 05:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-31 11:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:2148 on 2025-01-31 11:31</div>
            <div class="timeline-body"><p>That&#x27;s fair. I suggested the name <code>with_triple_quotes_set_to</code> as I thought <code>flags.with_triple_quotes(TripleQuotes::No)</code> read a bit weird. The name <code>with_triple_quotes</code> implies to me that calling the method will always return a version of <code>flags</code> with the <code>TRIPLE_QUOTED</code> flag set. But in fact if you pass in <code>TripleQuotes::No</code>, this call returns a version of <code>flags</code> with the <code>TRIPLE_QUOTED</code> flag <em>unset</em>. Maybe <code>with_triple_quotes_set_to</code> just ends up adding verbosity without adding any more clarity, though.</p>
<p>TL;DR: I&#x27;m fine with changing it back to <code>with_triple_quotes</code>, since I can&#x27;t think of anything obviously better ðŸ˜„</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-31 13:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:2148 on 2025-01-31 13:04</div>
            <div class="timeline-body"><p>I think I lean toward changing it back too. With no arguments I&#x27;d definitely expect <code>with_triple_quotes</code> to set the flag (as it did before), but the enum argument helps to clarify what&#x27;s going on now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-02-01 05:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:175 on 2025-02-01 05:54</div>
            <div class="timeline-body"><p>Sorry for the late reply. The main goal of error recovery would be to preserve all the information of the original source i.e., the parser shouldn&#x27;t drop any of the tokens. This would happen on a case by case basis but, for example, in this scenario the parser could just store the raw bytes and set a flag that it contains non-ascii bytes. All downstream tools would then need to account for this additional information.</p>
<p>Another thing to point out is that the generator is mainly used to provide auto-fix and we might decide that even though we would provide diagnostics for source code with syntax errors, we won&#x27;t be providing any auto-fix for it as it might prove even more difficult to consider all the cases.</p>
<p>I think the current logic is fine for now and we can think about this more when we start working on this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1044 on 2025-02-03 09:08</div>
            <div class="timeline-body"><p>Nit: I&#x27;m leaning towards a <code>display</code> method here. You then get the: <em>Write into a new string</em> (<code>flags.display(contents).to_string()</code>) or <em>write to an existing buffer</em> (<code>write!(&amp;mut s, &quot;{}&quot;, flags.display(contents))</code>) for free.</p>
<pre><code>
trait StringFlags {
	...

	fn display_contents(contents: &amp;str) -&gt; DisplayFlags {
		DisplayFlags { prefix: self.prefix(), quote_str: self.quote_str, contents }
	}
}

pub struct DisplayFlags&lt;&#x27;a&gt;  {
	prefix: AnyStringPrefix,
	quote_str: &amp;&#x27;a str,
	contents: &amp;&#x27;a str,
}

impl fmt::Dispaly for DisplayFlags&lt;&#x27;_&gt; { ..}

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_simplify/rules/split_static_string.rs</code>:136 on 2025-02-03 09:10</div>
            <div class="timeline-body"><p>Does the generator take care of escaping nested quotes? E.g. if you have</p>
<pre><code>&quot;&quot;&quot;
&quot;itemA&quot;
&#x27;itemB&#x27;
&#x27;&#x27;&#x27;itemC&#x27;&#x27;&#x27;
&quot;&quot;&quot;.split()
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:174 on 2025-02-03 09:18</div>
            <div class="timeline-body"><p>Nit: I&#x27;m leaning towards inlining this method as it is only used in one place and not having to jump to <code>p_raw_bytes</code> when reading the comment in <code>p_bytes_repr</code> could help readability</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:155 on 2025-02-03 09:20</div>
            <div class="timeline-body"><p>Does this lead to a syntax error if <code>flags</code> uses a quote that is contained in the string? For example, what if I have <code>b&quot; and &#x27;tert&quot;</code> and flags specify single quotes?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-03 09:23</div>
            <div class="timeline-body"><p>I&#x27;ve mainly an understand question:</p>
<p>Who&#x27;s responsibility is it to correctly handle nested quotes? Is it the generator or the code building the AST? If it is the generator, what happens in cases where it&#x27;s impossible to pick the right quotes?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-02-03 14:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:155 on 2025-02-03 14:28</div>
            <div class="timeline-body"><p>I think that is true, but the only way to get into that state is if the user of the <code>Generator</code> hard-coded a request for single quotes. The intention was to pass along flags from input string literals (so the input would have to be <code>br&#x27; and &#x27;tert&#x27;</code>, which is already a syntax error, or to use <a href="https://github.com/astral-sh/ruff/blob/brent%2Fpreserve-triple/crates/ruff_linter/src/checkers/ast/mod.rs#L314"><code>Checker::default_bytes_flags</code></a> if there&#x27;s not an existing literal to preserve, which I  think should also handle this case.</p>
<p>Basically you&#x27;d have to write code like</p>
<pre><code>BytesLiteral {
            value: Box::from(*b&quot; and &#x27;tert&quot;),
            range: TextRange::default(),
            flags: BytesLiteralFlags::empty()
                .with_quote_style(Quote::Single)
                .with_prefix(ByteStringPrefix::Raw { uppercase_r: false }),
        }
</code></pre>
<p>to cause the issue, at least as far as I can think of.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-02-03 14:29</div>
            <div class="timeline-body"><blockquote>
<p>Who&#x27;s responsibility is it to correctly handle nested quotes? Is it the generator or the code building the AST? If it is the generator, what happens in cases where it&#x27;s impossible to pick the right quotes?</p>
</blockquote>
<p>It&#x27;s still the generator&#x27;s responsibility to handle nested quotes. All of the code paths except raw strings end up going through either <a href="https://github.com/astral-sh/ruff/blob/brent%2Fpreserve-triple/crates/ruff_python_literal/src/escape.rs#L57"><code>UnicodeEscape::with_preferred_quote</code></a> (in the case of normal strings and f-strings) or <a href="https://github.com/astral-sh/ruff/blob/brent%2Fpreserve-triple/crates/ruff_python_literal/src/escape.rs#L250"><code>AsciiEscape::with_preferred_quote</code></a> (for bytestrings). These try to use the quote you pass in but will change the outer quotes if needed or even start adding escaped quotes in the worst case.</p>
<p>I tested your <code>split</code> case above with SIM905 (after temporarily modifying the rule to preserve triple quotes) and the output was <code>[&#x27;&#x27;&#x27;&quot;itemA&quot;&#x27;&#x27;&#x27;, &quot;&quot;&quot;&#x27;itemB&#x27;&quot;&quot;&quot;, &quot;&quot;&quot;&#x27;&#x27;&#x27;itemC&#x27;&#x27;&#x27;&quot;&quot;&quot;]</code>. <code>itemA</code> is probably the most interesting because the outer triple double quotes from the input got converted to single quotes to preserve the inner double quotes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-03 14:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:155 on 2025-02-03 14:53</div>
            <div class="timeline-body"><p>The exception to this would be if a refactor e.g moves a byte string into an f-string expression and the target python version is 3.12. But arguably, there isn&#x27;t much the generator can do about this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-02-03 14:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_simplify/rules/split_static_string.rs</code>:136 on 2025-02-03 15:29</div>
            <div class="timeline-body"><p>Added this as a SIM905 test case, including <code>&quot;&#x27;itemD&#x27;&quot;</code> to show escaped quotes when the generator can&#x27;t just alternate.</p>
<p>Input:</p>
<pre><code>&quot;&quot;&quot;
&quot;itemA&quot;
&#x27;itemB&#x27;
&#x27;&#x27;&#x27;itemC&#x27;&#x27;&#x27;
&quot;&#x27;itemD&#x27;&quot;
&quot;&quot;&quot;.split()
</code></pre>
<p>Output:</p>
<pre><code>[&#x27;&quot;itemA&quot;&#x27;, &quot;&#x27;itemB&#x27;&quot;, &quot;&#x27;&#x27;&#x27;itemC&#x27;&#x27;&#x27;&quot;, &quot;\&quot;&#x27;itemD&#x27;\&quot;&quot;]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-02-03 15:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:155 on 2025-02-03 17:21</div>
            <div class="timeline-body"><p>Oh good point, I forgot about rules moving these into f-strings. I think <code>UnicodeEscape</code> will still get a chance to run in that case, as long as the outer f-string isn&#x27;t raw too, but this is good to keep in mind.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-02-03 17:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-03 17:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_simplify/SIM905.py</code>:17 on 2025-02-03 17:36</div>
            <div class="timeline-body"><p>nit: this unfortunately results in a huge snapshot change that&#x27;s quite hard to review, because the line numbers change for all diagnostics emitted on code below the added lines here. I know it means it doesn&#x27;t &quot;fit in&quot; with the &quot;categories&quot; in the fixture that the comments crate, but I think I&#x27;d prefer for this to be added at the bottom of the fixture file, if that&#x27;s okay?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-02-03 17:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_simplify/SIM905.py</code>:17 on 2025-02-03 17:38</div>
            <div class="timeline-body"><p>For sure, I prefer it at the bottom too but tried to stick with the categories. I&#x27;ll just add a comment to clarify.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_simplify/SIM905.py</code>:17 on 2025-02-03 17:47</div>
            <div class="timeline-body"><p>I didn&#x27;t rebase over the last one, but hopefully the net diff is much more readable now!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-02-03 17:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1055 on 2025-02-03 17:52</div>
            <div class="timeline-body"><p>An alternative here might be this (the diff is relative to your branch), which would mean the <code>DisplayFlags</code> struct would take up slightly less memory. Curious what @MichaReiser thinks of the pros and cons. I think there&#x27;s almost certainly not much practical difference to what you have now:</p>
<pre><code>diff --git a/crates/ruff_python_ast/src/nodes.rs b/crates/ruff_python_ast/src/nodes.rs
index 3471776f2..70b21e7db 100644
--- a/crates/ruff_python_ast/src/nodes.rs
+++ b/crates/ruff_python_ast/src/nodes.rs
@@ -977,7 +977,7 @@ impl Ranged for FStringPart {
     }
 }
 
-pub trait StringFlags: Copy {
+pub trait StringFlags: Copy + Into&lt;AnyStringFlags&gt; {
     /// Does the string use single or double quotes in its opener and closer?
     fn quote_style(self) -&gt; Quote;
 
@@ -1029,16 +1029,14 @@ pub trait StringFlags: Copy {
 
     fn display_contents(self, contents: &amp;str) -&gt; DisplayFlags {
         DisplayFlags {
-            prefix: self.prefix(),
-            quote_str: self.quote_str(),
+            flags: self.into(),
             contents,
         }
     }
 }
 
 pub struct DisplayFlags&lt;&#x27;a&gt; {
-    prefix: AnyStringPrefix,
-    quote_str: &amp;&#x27;a str,
+    flags: AnyStringFlags,
     contents: &amp;&#x27;a str,
 }
 
@@ -1047,8 +1045,8 @@ impl std::fmt::Display for DisplayFlags&lt;&#x27;_&gt; {
         write!(
             f,
             &quot;{prefix}{quote}{contents}{quote}&quot;,
-            prefix = self.prefix,
-            quote = self.quote_str,
+            prefix = self.flags.prefix(),
+            quote = self.flags.quote_str(),
             contents = self.contents
         )
     }
diff --git a/crates/ruff_python_parser/src/token.rs b/crates/ruff_python_parser/src/token.rs
index ecda19730..d741b15a4 100644
--- a/crates/ruff_python_parser/src/token.rs
+++ b/crates/ruff_python_parser/src/token.rs
@@ -777,6 +777,12 @@ impl TokenFlags {
     }
 }
 
+impl From&lt;TokenFlags&gt; for AnyStringFlags {
+    fn from(flags: TokenFlags) -&gt; Self {
+        flags.as_any_string_flags()
+    }
+}
+
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-02-03 17:52</div>
            <div class="timeline-body"><p>LGTM!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-03 17:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1039 on 2025-02-03 17:59</div>
            <div class="timeline-body"><p>I don&#x27;t <em>love</em> the name of this struct because it doesn&#x27;t just display the flags -- it displays the string contents embedded in the prefix and quotes, which are supplied by the flags. <code>DisplayStringLiteralWithQuotesAndPrefix</code> is kinda verbose, though, so I&#x27;m not sure what a better name might be. (AKA: I&#x27;m fine with it being merged as-is!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-02-03 18:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1039 on 2025-02-03 18:04</div>
            <div class="timeline-body"><p>Oh good point. I also wanted to make the struct private, but it&#x27;s in a public trait. One thing we could do is just return <code>impl Display</code> from <code>display_contents</code>? Then we could use as verbose an internal name as we want and arguably better capture the intention here without having to name a type.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-03 18:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1039 on 2025-02-03 18:05</div>
            <div class="timeline-body"><p>Oh, I like that idea!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-03 19:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1055 on 2025-02-03 19:36</div>
            <div class="timeline-body"><p>I&#x27;m not too fond of trait chains. I&#x27;d rather have a <code>into_any_string_flags</code> method but I don&#x27;t think it matters much. <code>Display</code> is rarely used.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-03 19:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1039 on 2025-02-03 19:37</div>
            <div class="timeline-body"><p>The downside of that is that the trait is no longer object safe, but it might not matter here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-02-03 19:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1039 on 2025-02-03 19:56</div>
            <div class="timeline-body"><p>Oh good point. I&#x27;m somewhat leaning toward leaving the code as it is here, for both the struct name and its contents (re the conversation above) if that&#x27;s okay with you both.</p>
<p>I don&#x27;t really love the new trait bound or <code>From</code> impl either, but it does make the struct smaller, so I&#x27;m happy either way, though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-03 20:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1039 on 2025-02-03 20:52</div>
            <div class="timeline-body"><p>I&#x27;m fine to leave everything as is!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/ntBre">@ntBre</a> on 2025-02-04 13:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/ntBre">@ntBre</a> on 2025-02-04 13:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-04 13:41</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:10:56 UTC
    </footer>
</body>
</html>
