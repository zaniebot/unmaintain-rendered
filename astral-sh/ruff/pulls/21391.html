<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Support `isinstance()` and `issubclass()` narrowing when the second argument is a `typing.py` stdlib alias - astral-sh/ruff #21391</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Support <code>isinstance()</code> and <code>issubclass()</code> narrowing when the second argument is a <code>typing.py</code> stdlib alias</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21391">#21391</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-11-11 19:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>A followup to https://github.com/astral-sh/ruff/pull/21386</p>
<h2>Test Plan</h2>
<p>New mdtests added</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-11-11 19:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-11 19:56</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-11 19:56</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">kornia (https://github.com/kornia/kornia)
- kornia/utils/draw.py:379:38: warning[possibly-missing-attribute] Attribute `shape` may be missing on object of type `Unknown | list[Unknown]`
- kornia/utils/draw.py:379:54: warning[possibly-missing-attribute] Attribute `device` may be missing on object of type `Unknown | list[Unknown]`
- kornia/utils/draw.py:379:71: warning[possibly-missing-attribute] Attribute `dtype` may be missing on object of type `Unknown | list[Unknown]`
- Found 762 diagnostics
+ Found 759 diagnostics

dd-trace-py (https://github.com/DataDog/dd-trace-py)
+ ddtrace/appsec/_iast/_ast/visitor.py:785:32: warning[possibly-missing-attribute] Attribute `elts` may be missing on object of type `(expr &amp; Top[list[Unknown]] &amp; ~Subscript) | (Tuple &amp; ~Subscript)`
- ddtrace/appsec/_iast/_ast/visitor.py:785:32: error[unresolved-attribute] Object of type `expr &amp; ~Subscript` has no attribute `elts`
- ddtrace/appsec/_iast/_ast/visitor.py:787:55: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 8226 diagnostics
+ Found 8225 diagnostics

sympy (https://github.com/sympy/sympy)
- sympy/matrices/sparse.py:143:46: error[call-non-callable] Object of type `None` is not callable
- sympy/matrices/sparse.py:174:56: error[not-iterable] Object of type `(Unknown &amp; ~Top[dict[Unknown, Unknown]] &amp; ~Dict) | None` may not be iterable
+ sympy/matrices/sparse.py:174:56: error[not-iterable] Object of type `(Unknown &amp; ~(() -&gt; object) &amp; ~Top[dict[Unknown, Unknown]] &amp; ~Dict) | None` may not be iterable
- sympy/matrices/sparse.py:184:41: error[invalid-argument-type] Argument to function `len` is incorrect: Expected `Sized`, found `(Unknown &amp; ~Top[dict[Unknown, Unknown]] &amp; ~Dict) | None`
+ sympy/matrices/sparse.py:184:41: error[invalid-argument-type] Argument to function `len` is incorrect: Expected `Sized`, found `(Unknown &amp; ~(() -&gt; object) &amp; ~Top[dict[Unknown, Unknown]] &amp; ~Dict) | None`
- Found 14444 diagnostics
+ Found 14443 diagnostics


</code></pre>
</details>

<p>No memory usage changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @AlexWaygood on 2025-11-11 20:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-11-11 20:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-11-11 20:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @AlexWaygood on 2025-11-11 20:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-11 20:06</div>
            <div class="timeline-body"><p>Not a huge ecosystem impact, but I think this is worth it for consistency as much as anything else.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/narrow.rs</code>:233 on 2025-11-11 20:08</div>
            <div class="timeline-body"><p>This comment suggests this is a ty limitation, but at runtime <code>issubclass(..., typing.Callable)</code> just raises <code>TypeError</code>, so I don't think this is something we should support.</p>
<p>We should probably revise your previous PR so that we emit a diagnostic on that again?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-11-11 20:08</div>
            <div class="timeline-body"><p>Love it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-11-11 20:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/narrow.rs</code>:233 on 2025-11-11 20:09</div>
            <div class="timeline-body"><p>Oh it does? Huh, I'll fix that, thanks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-11-11 20:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/narrow.rs</code>:233 on 2025-11-11 20:10</div>
            <div class="timeline-body"><blockquote>
<p>at runtime <code>issubclass(..., typing.Callable)</code> just raises <code>TypeError</code></p>
</blockquote>
<p>not on my machine?</p>
<pre><code class="language-pycon">Python 3.13.1 (main, Jan  3 2025, 12:04:03) [Clang 15.0.0 (clang-1500.3.9.4)] on darwin
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; import typing as t
&gt;&gt;&gt; issubclass(int, t.Callable)
False
&gt;&gt;&gt; issubclass(type(lambda: 42), t.Callable)
True
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-11-11 20:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/narrow.rs</code>:233 on 2025-11-11 20:12</div>
            <div class="timeline-body"><p>Did you literally pass in a <code>...</code> for the first argument? If so then the runtime was probably complaining about your first argument not being an instance of <code>type</code> rather than anything about the second argument ðŸ˜„</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-11-11 20:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/narrow.rs</code>:233 on 2025-11-11 20:49</div>
            <div class="timeline-body"><p>Yeah my mistake, sorry!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-11-11 20:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/narrow.rs</code>:233 on 2025-11-11 20:49</div>
            <div class="timeline-body"><p>Looks good as is. I guess in principle we could have a protocol as the meta-type of Callable...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-11-11 21:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-11-11 21:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-11-11 21:09</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:17:09 UTC
    </footer>
</body>
</html>
