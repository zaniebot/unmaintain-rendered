<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change `EnvironmentOptions::venv-path` to `Option&lt;SystemPathBuf&gt;` - astral-sh/ruff #15631</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Change <code>EnvironmentOptions::venv-path</code> to <code>Option&lt;SystemPathBuf&gt;</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15631">#15631</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-01-21 09:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-21 09:32</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>The <code>Options</code> struct is intended to capture the user's configuration options but
<code>EnvironmentOptions::venv_path</code> supports both a <code>SitePackages::Known</code> and <code>SitePackages::Derived</code>.</p>
<p>Users should only be able to provide <code>SitePackages::Derived</code>—they specify a path to a venv, and Red Knot derives the path to the site-packages directory. We'll only use the <code>Known</code> variant once we automatically discover the Python installation.</p>
<p>That's why this PR changes <code>EnvironmentOptions::venv_path</code> from <code>Option&lt;SitePackages&gt;</code> to <code>Option&lt;SystemPathBuf&gt;</code>.</p>
<p>This requires making some changes to the file watcher test, and I decided to use <code>extra_paths</code> over venv path
because our venv validation is annoyingly correct -- making mocking a venv rather involved.</p>
<h2>Test Plan</h2>
<p><code>cargo test</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @MichaReiser on 2025-01-21 09:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2025-01-21 09:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MichaReiser on 2025-01-21 09:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MichaReiser on 2025-01-21 09:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @MichaReiser on 2025-01-21 09:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-21 09:40</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> approved on 2025-01-21 09:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/module_resolver/resolver.rs</code>:226 on 2025-01-21 12:11</div>
            <div class="timeline-body"><p>not sure I understand this TODO</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-01-21 12:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-01-21 12:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/module_resolver/resolver.rs</code>:226 on 2025-01-21 12:18</div>
            <div class="timeline-body"><p>The idea here would be that we warn if <code>program.python_version</code> isn't compatible with the venv's python because that suggests a configuration error.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-21 12:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/module_resolver/resolver.rs</code>:226 on 2025-01-21 12:21</div>
            <div class="timeline-body"><p>I don't think that's necessarily true. People often use a newer Python version for local development than they use in production. That would result in the project's <code>requires-python</code> being set to e.g. <code>&quot;&gt;= 3.9&quot;</code> even though they're using Python 3.13 locally. We'd type-check assuming Python 3.9 (the version they're using in production), unless they explicitly override that on the command line</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-01-21 12:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/module_resolver/resolver.rs</code>:226 on 2025-01-21 12:24</div>
            <div class="timeline-body"><p>With incompatible I mean if your python version is older than what's specified in requires python. Using a newer version isn't incompatible with requires python.</p>
<p>Or we warn if you set an explicit target version but your venv version doesn't match that version (it's not the same major/minor)</p>
<p>Both these situations suggest that there's something wrong with the setup and seems worth warning about.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-21 12:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/module_resolver/resolver.rs</code>:226 on 2025-01-21 12:27</div>
            <div class="timeline-body"><p>I still worry that these could lead to noisy warnings that won't be useful to most users... but we can play it by ear and modulate it depending on the feedback we get from users, I suppose.</p>
<p>Could you make the TODO a bit more expansive so it's clear what we might want to warn about in the future?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-01-21 14:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-01-21 14:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-21 14:10</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 20:06:11 UTC
    </footer>
</body>
</html>
