<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-pyi`] Implement PYI026 - astral-sh/ruff #5844</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-pyi</code>] Implement PYI026</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5844">#5844</a>
        opened by <a href="https://github.com/LaBatata101">@LaBatata101</a>
        on 2023-07-17 22:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/LaBatata101">@LaBatata101</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Checks for <code>typehint.TypeAlias</code> annotation in type aliases. See <a href="https://github.com/PyCQA/flake8-pyi/blob/main/pyi.py#L1085">original source</a>.</p>
<pre><code>$ flake8 --select Y026 crates/ruff/resources/test/fixtures/flake8_pyi/PYI026.pyi
crates/ruff/resources/test/fixtures/flake8_pyi/PYI026.pyi:4:1: Y026 Use typing_extensions.TypeAlias for type aliases, e.g. &quot;NewAny: TypeAlias = Any&quot;
crates/ruff/resources/test/fixtures/flake8_pyi/PYI026.pyi:5:1: Y026 Use typing_extensions.TypeAlias for type aliases, e.g. &quot;OptinalStr: TypeAlias = typing.Optional[str]&quot;
crates/ruff/resources/test/fixtures/flake8_pyi/PYI026.pyi:6:1: Y026 Use typing_extensions.TypeAlias for type aliases, e.g. &quot;Foo: TypeAlias = Literal['foo']&quot;
crates/ruff/resources/test/fixtures/flake8_pyi/PYI026.pyi:7:1: Y026 Use typing_extensions.TypeAlias for type aliases, e.g. &quot;IntOrStr: TypeAlias = int | str&quot;
crates/ruff/resources/test/fixtures/flake8_pyi/PYI026.pyi:8:1: Y026 Use typing_extensions.TypeAlias for type aliases, e.g. &quot;AliasNone: TypeAlias = None&quot;
</code></pre>
<pre><code>$ ./target/debug/ruff --select PYI026 crates/ruff/resources/test/fixtures/flake8_pyi/PYI026.pyi --no-cache
crates/ruff/resources/test/fixtures/flake8_pyi/PYI026.pyi:4:1: PYI026 Use `typing.TypeAlias` for type aliases in `NewAny`, e.g. &quot;NewAny: typing.TypeAlias = Any&quot;
crates/ruff/resources/test/fixtures/flake8_pyi/PYI026.pyi:5:1: PYI026 Use `typing.TypeAlias` for type aliases in `OptinalStr`, e.g. &quot;OptinalStr: typing.TypeAlias = typing.Optional[str]&quot;
crates/ruff/resources/test/fixtures/flake8_pyi/PYI026.pyi:6:1: PYI026 Use `typing.TypeAlias` for type aliases in `Foo`, e.g. &quot;Foo: typing.TypeAlias = Literal[&quot;foo&quot;]&quot;
crates/ruff/resources/test/fixtures/flake8_pyi/PYI026.pyi:7:1: PYI026 Use `typing.TypeAlias` for type aliases in `IntOrStr`, e.g. &quot;IntOrStr: typing.TypeAlias = int | str&quot;
crates/ruff/resources/test/fixtures/flake8_pyi/PYI026.pyi:8:1: PYI026 Use `typing.TypeAlias` for type aliases in `AliasNone`, e.g. &quot;AliasNone: typing.TypeAlias = None&quot;
Found 5 errors.
</code></pre>
<p>ref: #848</p>
<h2>Test Plan</h2>
<p>Snapshots, manual runs of flake8.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-07-17 23:37</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>ℹ️ ecosystem check <strong>detected changes</strong>. (+2, -0, 0 error(s))</p>
<details><summary>typeshed (+2, -0)</summary>
<p>

<pre>
+ <a href='https://github.com/python/typeshed/blob/032f9195f9e3788a6e5c7ecb086f173a3ac92a95/stdlib/builtins.pyi#L1664'>stdlib/builtins.pyi:1664:1:</a> PYI026 Use `typing.TypeAlias` for type alias, e.g., `_SupportsSomeKindOfPow: typing.TypeAlias = _SupportsPow2[Any, Any] | _SupportsPow3NoneOnly[Any, Any] | _SupportsPow3[Any, Any, Any]`
+ <a href='https://github.com/python/typeshed/blob/032f9195f9e3788a6e5c7ecb086f173a3ac92a95/stdlib/builtins.pyi#L220'>stdlib/builtins.pyi:220:1:</a> PYI026 Use `typing.TypeAlias` for type alias, e.g., `_LiteralInteger: typing.TypeAlias = _PositiveInteger | _NegativeInteger | Literal[0]`
</pre>

</p>
</details>
Rules changed: 1

<p>| Rule | Changes | Additions | Removals |
| ---- | ------- | --------- | -------- |
| PYI026 | 2 | 2 | 0 |</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     11.0±0.03ms     3.7 MB/sec    1.00     10.9±0.03ms     3.7 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.2±0.00ms     7.5 MB/sec    1.01      2.2±0.06ms     7.5 MB/sec
formatter/numpy/globals.py                 1.04   256.3±11.23µs    11.5 MB/sec    1.00    246.9±0.78µs    12.0 MB/sec
formatter/pydantic/types.py                1.00      4.8±0.01ms     5.4 MB/sec    1.01      4.8±0.01ms     5.3 MB/sec
linter/all-rules/large/dataset.py          1.00     15.4±0.04ms     2.6 MB/sec    1.00     15.3±0.03ms     2.7 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.9±0.00ms     4.2 MB/sec    1.00      3.9±0.00ms     4.3 MB/sec
linter/all-rules/numpy/globals.py          1.01    518.2±0.82µs     5.7 MB/sec    1.00    515.2±1.17µs     5.7 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.0±0.01ms     3.6 MB/sec    1.00      7.0±0.01ms     3.7 MB/sec
linter/default-rules/large/dataset.py      1.01      7.9±0.02ms     5.1 MB/sec    1.00      7.9±0.02ms     5.2 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01   1687.6±7.22µs     9.9 MB/sec    1.00   1676.1±4.23µs     9.9 MB/sec
linter/default-rules/numpy/globals.py      1.00    185.1±0.35µs    15.9 MB/sec    1.00    184.5±0.32µs    16.0 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.6±0.03ms     7.1 MB/sec    1.00      3.6±0.02ms     7.2 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     11.4±0.33ms     3.6 MB/sec    1.08     12.4±0.27ms     3.3 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.2±0.05ms     7.4 MB/sec    1.07      2.4±0.04ms     6.9 MB/sec
formatter/numpy/globals.py                 1.00    251.0±7.05µs    11.8 MB/sec    1.04    261.4±7.59µs    11.3 MB/sec
formatter/pydantic/types.py                1.00      4.8±0.08ms     5.3 MB/sec    1.11      5.4±0.08ms     4.8 MB/sec
linter/all-rules/large/dataset.py          1.00     16.2±0.33ms     2.5 MB/sec    1.00     16.2±0.36ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      4.3±0.09ms     3.8 MB/sec    1.00      4.3±0.07ms     3.9 MB/sec
linter/all-rules/numpy/globals.py          1.01   505.4±10.55µs     5.8 MB/sec    1.00    499.1±9.31µs     5.9 MB/sec
linter/all-rules/pydantic/types.py         1.02      7.5±0.21ms     3.4 MB/sec    1.00      7.4±0.17ms     3.5 MB/sec
linter/default-rules/large/dataset.py      1.00      8.3±0.16ms     4.9 MB/sec    1.01      8.4±0.17ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1714.4±21.75µs     9.7 MB/sec    1.02  1741.5±29.81µs     9.6 MB/sec
linter/default-rules/numpy/globals.py      1.00    191.4±3.44µs    15.4 MB/sec    1.02    194.9±5.02µs    15.1 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.7±0.06ms     6.9 MB/sec    1.01      3.7±0.09ms     6.8 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-17 23:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/resources/test/fixtures/flake8_pyi/PYI026.py</code>:5 on 2023-07-17 23:56</div>
            <div class="timeline-body"><pre><code class="language-suggestion">OptionalStr = typing.Optional[str]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-17 23:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/resources/test/fixtures/flake8_pyi/PYI026.py</code>:11 on 2023-07-17 23:56</div>
            <div class="timeline-body"><pre><code class="language-suggestion">OptionalStr: TypeAlias = typing.Optional[str]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-17 23:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/resources/test/fixtures/flake8_pyi/PYI026.pyi</code>:5 on 2023-07-17 23:57</div>
            <div class="timeline-body"><pre><code class="language-suggestion">OptionalStr = typing.Optional[str]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-17 23:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/resources/test/fixtures/flake8_pyi/PYI026.pyi</code>:11 on 2023-07-17 23:57</div>
            <div class="timeline-body"><pre><code class="language-suggestion">OptionalStr: TypeAlias = typing.Optional[str]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-17 23:59</div>
            <div class="timeline-body"><p>Welcome and thanks for contributing!</p>
<p>This seems like a good candidate for a suggested or automatic fix if your up for it :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/simple_defaults.rs</code>:126 on 2023-07-18 00:01</div>
            <div class="timeline-body"><p>I'd either exclude the name so this reads:</p>
<blockquote>
<p>Use <code>typing.TypeAlias</code> for type aliases. e.g. &quot;AliasNone: typing.TypeAlias = None&quot;`</p>
</blockquote>
<pre><code class="language-suggestion">        format!(&quot;Use `typing.TypeAlias` for type aliases, e.g. \&quot;{name}: typing.TypeAlias = {value}\&quot;&quot;)
</code></pre>
<p>or make it singular</p>
<blockquote>
<p>Use <code>typing.TypeAlias</code> for type alias <code>AliasNone</code>, e.g. &quot;AliasNone: typing.TypeAlias = None&quot;</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-18 00:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/LaBatata101">@LaBatata101</a> on 2023-07-18 00:07</div>
            <div class="timeline-body"><blockquote>
<p>Welcome and thanks for contributing!</p>
<p>This seems like a good candidate for a suggested or automatic fix if your up for it :)</p>
</blockquote>
<p>I'll try to add the automatic fix. Do you have any examples for this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/simple_defaults.rs</code>:435 on 2023-07-18 00:07</div>
            <div class="timeline-body"><p>What's the motivation for this change? I believe it's semantically equivalent, but the former enforces the condition with a single match.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/simple_defaults.rs</code>:507 on 2023-07-18 00:08</div>
            <div class="timeline-body"><p>Ditto here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-07-18 00:09</div>
            <div class="timeline-body"><p>@LaBatata101 here's an example that changes one type annotation to another https://github.com/astral-sh/ruff/pull/4695/files#diff-f72967b46be9c2c0fed6dc2bf98259327c03cc36dd28839e72cc106a60f552dbR83-R91</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-18 00:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/resources/test/fixtures/flake8_pyi/PYI026.pyi</code>:15 on 2023-07-18 00:10</div>
            <div class="timeline-body"><p>Perhaps a test case with another existing annotation would be good e.g. <code>IntOrStr: Foo = int | str</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/simple_defaults.rs</code>:574 on 2023-07-18 00:11</div>
            <div class="timeline-body"><p>I think more idiomatic in our codebase would be to remove <code>is_any</code>, and do:</p>
<pre><code class="language-rust">if let Expr::Name(ast::ExprName { id, .. }) = target {
    if id.as_str() == &quot;Any&quot; {
        return;
    }
};
</code></pre>
<p>That way, IMO, the condition reads more linearly: &quot;if the <code>value</code> is a <code>Name</code>, and that <code>Name</code> is &quot;any&quot;, then return&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/simple_defaults.rs</code>:574 on 2023-07-18 00:11</div>
            <div class="timeline-body"><p>However, we have a special utility for this, which will ensure that the <code>Any</code> here actually refers to <code>typing.Any</code>, and that we match things like <code>x: typing.Any</code> instead of just <code>x: Any</code>:</p>
<pre><code class="language-rust">if checker.semantic().match_typing_expr(value, &quot;Any&quot;) {
    return;
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/simple_defaults.rs</code>:568 on 2023-07-18 00:12</div>
            <div class="timeline-body"><p>Should this rule run with multiple targets? (E.g., <code>x = y = 1</code>.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/simple_defaults.rs</code>:638 on 2023-07-18 00:15</div>
            <div class="timeline-body"><p>It looks like the original implementation in flake8-pyi has slightly different criteria: https://github.com/PyCQA/flake8-pyi/blob/2a86db8271dc500247a8a69419536240334731cf/pyi.py#L1085.</p>
<p>It looks like they trigger if:</p>
<ul>
<li>The value is a subscript.</li>
<li>The value is a PEP 604-style union.</li>
<li>The value is <code>Any</code>.</li>
<li>The value is <code>None</code>.</li>
</ul>
<p>It looks like the current implementation here is more permissive. I think we need some tweaks to be more conservative, to avoid false positives. E.g., we should omit <em>any</em> expression that isn't a subscript (like, we should omit all call expressions), but we should allow the constant <code>None</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-07-18 00:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2023-07-18 01:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/simple_defaults.rs</code>:638 on 2023-07-18 01:47</div>
            <div class="timeline-body"><p>The length of the docstring on that flake8-pyi method there is a testament to the number of times we had to revise that check at flake8-pyi before we got to a place where the balance between false negatives and false positives was where we wanted it to be... There are <em>still</em> a few false positives that flake8-pyi's Y026 produces, but overall I'm pretty happy with it now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/LaBatata101">@LaBatata101</a> reviewed on 2023-07-18 19:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/LaBatata101">@LaBatata101</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/simple_defaults.rs</code>:435 on 2023-07-18 19:47</div>
            <div class="timeline-body"><p>Whaaat, I don't remember changing that part of the code. I'll revert the changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @LaBatata101 on 2023-07-19 22:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @LaBatata101 on 2023-07-19 22:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @charliermarsh on 2023-07-20 01:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-07-20 01:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/simple_defaults.rs</code>:615 on 2023-07-20 01:34</div>
            <div class="timeline-body"><p>I reordered these operations from least- to most-expensive.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-07-20 01:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/simple_defaults.rs</code>:604 on 2023-07-20 01:34</div>
            <div class="timeline-body"><p>I renamed the method and rule to be a little more in-line with our conventions (&quot;describe the bad case&quot;).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-07-20 01:35</div>
            <div class="timeline-body"><p>Looks great -- nice work, thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-07-20 01:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-07-20 01:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-07-27 21:03</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:58:50 UTC
    </footer>
</body>
</html>
