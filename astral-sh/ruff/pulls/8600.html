<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>remove several uses of `unsafe` - astral-sh/ruff #8600</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>remove several uses of <code>unsafe</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/8600">#8600</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2023-11-10 14:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a></div>
            <div class="timeline-body"><p>This PR removes several uses of <code>unsafe</code>. I generally limited myself to low hanging fruit that I could see. There are still a few remaining uses of <code>unsafe</code> that looked a bit more difficult to remove (if possible at all). But this gets rid of a good chunk of them.</p>
<p>I put each <code>unsafe</code> removal into its own commit with a justification for why I did it. So I would encourage reviewing this PR commit-by-commit. That way, we can legislate them independently. It's no problem to drop a commit if we feel the <code>unsafe</code> should stay in that case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @BurntSushi on 2023-11-10 14:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @BurntSushi on 2023-11-10 14:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @BurntSushi on 2023-11-10 14:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2023-11-10 14:52</div>
            <div class="timeline-body"><p>LGTM, but I'm the least qualified :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-10 14:57</div>
            <div class="timeline-body"><p>I'd prefer to have Micha review this when he's back since he has context on all of these, and I suspect they were done intentionally (though that doesn't necessarily mean they shouldn't be changed).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @BurntSushi on 2023-11-10 15:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-11-10 15:26</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-11-10 16:20</div>
            <div class="timeline-body"><p>Benchmarks from codspeed seem to support my local benchmarks that there's little to no impact: https://codspeed.io/astral-sh/ruff/branches/ag/reduce-unsafe</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_formatter/src/arguments.rs</code>:6 on 2023-11-10 16:21</div>
            <div class="timeline-body"><p>no more unsafe in the formatter :heart_eyes: (sorry micha)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_macros/src/newtype_index.rs</code>:50 on 2023-11-10 16:26</div>
            <div class="timeline-body"><p>Is this ever called in a const context? We had some <code>const fn</code> that didn't actually need to be const</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/comments/map.rs</code>:546 on 2023-11-10 16:34</div>
            <div class="timeline-body"><p>I'm surprised there isn't a method in std that combines the assert and <code>NonZeroU32::new</code> (like <code>NonZeroU32::try_from(value + 1)</code>, but apparently <code>NonZeroU32</code> doesn't even have a &quot;normal&quot; add</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-11-10 16:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-10 16:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/src/comments/map.rs</code>:546 on 2023-11-10 16:48</div>
            <div class="timeline-body"><p>In this case, it would need to be a <code>TryFrom&lt;usize&gt; for NonZeroU32</code>. And if you fill out the full complement of those across all the <code>NonZero</code> types, it ends up being quite a lot of impls. Not clear that's worth doing when you can compose things, e.g., <code>u32::try_from(value).ok().and_then(std::num::NonZeroU32::new)</code> or something like that.</p>
<p>And yeah it doesn't have <code>Add</code> because there are some thorny decisions around its semantics. e.g., What happens when you do <code>NonZeroU32::MAX + 1</code>. And if you had subtraction, then <code>NonZeroU32::new(1).unwrap() - 1</code>. You'd have to panic I think.</p>
<p>I also don't think anyone has seriously proposed adding all of the arithmetic methods to the various <code>NonZero</code> types either. (They do have checked/saturation operations where appropriate.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-10 16:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_macros/src/newtype_index.rs</code>:50 on 2023-11-10 16:57</div>
            <div class="timeline-body"><p>It is yeah: https://github.com/astral-sh/ruff/blob/995649f45584af2dc8a1d128bfb1ed852dfcaf99/crates/ruff_macros/src/newtype_index.rs#L40</p>
<p>Anyway you slice it, <code>Self::MAX</code> having type <code>Self</code> means you need to build a <code>NonZeroU32</code> in a const context. And to do that for <code>u32::MAX - 1</code>, I believe that requires some kind of <code>unsafe</code> uttered somewhere. It's possible that <code>Self::MAX</code> doesn't need to be const and could be a method instead, but that's a bigger change.</p>
<p>I think we can probably just leave this one here for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_formatter/src/format_element.rs</code>:347 on 2023-11-27 05:06</div>
            <div class="timeline-body"><p>We currently don't use best fitting in <code>ruff_python_formatter</code> so the cost of this change is unknown.</p>
<p>My preferred solution for this would be to change <code>most_expanded</code> and <code>most_flat</code> to return <code>Result</code> and propagate the error inside of the <code>Printer</code> (with a proper message) as we now do for most (all) other invalid cases in the printer (instead of panicking).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_formatter/src/arguments.rs</code>:6 on 2023-11-27 05:09</div>
            <div class="timeline-body"><p>This makes me sad :P</p>
<p>You can propose the same change to <code>std::fmt::Argument</code> ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-11-27 05:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-27 13:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_formatter/src/format_element.rs</code>:347 on 2023-11-27 13:33</div>
            <div class="timeline-body"><p>Are you thinking about using a <a href="https://github.com/astral-sh/ruff/blob/f4d64720369e9de20bea76879a8f0693e1dc2b2c/crates/ruff_formatter/src/diagnostics.rs#L6-L27"><code>FormatError</code></a>? If so, which variant is appropriate here? I don't think I have enough context to write a good user facing error message here. (A panic looks appropriate to me here, since I imagine this is a bug in the code if the assert gets tripped. But I'm not completely certain.)</p>
<p>I suppose a behavior preserving change here would be to switch the <code>assert!</code> back to <code>debug_assert!</code> and document the panic conditions to <code>most_expanded</code> and <code>most_flat</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-27 13:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_formatter/src/arguments.rs</code>:6 on 2023-11-27 13:44</div>
            <div class="timeline-body"><p>I don't think it works there. In std, we're &quot;escaping&quot; out of multiple different trait impls: https://github.com/rust-lang/rust/blob/b29a1e00f850e548f3021ea523d0e143724fa9b7/library/core/src/fmt/rt.rs#L95-L130</p>
<p>Here it looks like we only need one particular trait impl, so we can just use a <code>dyn</code> and get what we need.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-11-27 23:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_formatter/src/format_element.rs</code>:347 on 2023-11-27 23:04</div>
            <div class="timeline-body"><p>It would be a new variant (or two) in <code>InvalidDocumentError</code> but I'm also okay keeping the panics in <code>most_expanded</code> and <code>most_flat</code> and pointing it out in the documentation that Printing will fail with a panic if passed with less than 2 variations.</p>
<p>The debug assertion mainly exists to make debugging easier, because you can identify the incorrect call from the call-stack which you can't when it panics during printing (and document inspection in the printer is a pain).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-11-27 23:05</div>
            <div class="timeline-body"><p>Sorry. I didn't notice that this wasn't merged yet or I would have approved yesterday.</p>
<p>LGTM. I would prefer keeping the debug assertion in the <code>BestFitting</code> constructor and instead panic when using <code>most_expanded</code> or <code>most_flat</code> for performance reasons.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2023-11-27 23:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-11-28 14:26</div>
            <div class="timeline-body"><p>@MichaReiser Aye, done! I've updated the code to switch back to a <code>debug_assert!</code> at construction time, but panic in the <code>most_{flat,expanded}</code> methods.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @BurntSushi on 2023-11-28 14:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2023-11-28 14:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-11-28 14:50</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:01:22 UTC
    </footer>
</body>
</html>
