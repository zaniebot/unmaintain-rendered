<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pyupgrade`] Don't introduce invalid syntax when upgrading old-style type aliases with parenthesized multiline values (`UP040`) - astral-sh/ruff #16026</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pyupgrade</code>] Don't introduce invalid syntax when upgrading old-style type aliases with parenthesized multiline values (<code>UP040</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16026">#16026</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-02-07 16:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>We previously autofixed this:</p>
<pre><code class="language-py">from typing import TypeAlias

T: TypeAlias = (
    int
    | str
)
</code></pre>
<p>to this:</p>
<pre><code class="language-py">type T = int
    | str
</code></pre>
<p>When we should be autofixing it to this:</p>
<pre><code class="language-py">type T = (
    int
    | str
)
</code></pre>
<p>This PR fixes the bug. Closes #16023</p>
<h2>Test Plan</h2>
<p>New fixture added that repros the issue on <code>main</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2025-02-07 16:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @AlexWaygood on 2025-02-07 16:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">python312</span> added by @AlexWaygood on 2025-02-07 16:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "add failing test" to "[`pyupgrade`] Don't introduce invalid syntax when upgrading old-style type aliases (`UP040`)" by @AlexWaygood on 2025-02-07 16:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`pyupgrade`] Don't introduce invalid syntax when upgrading old-style type aliases (`UP040`)" to "[`pyupgrade`] Don't introduce invalid syntax when upgrading old-style type aliases with parenthesized multiline values (`UP040`)" by @AlexWaygood on 2025-02-07 16:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-07 16:40</div>
            <div class="timeline-body"><p>I think this is a small regression from https://github.com/astral-sh/ruff/pull/15840 (cc. @ntBre) -- totally one I should have caught in review, though!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-02-07 16:43</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/pep695/non_pep695_type_alias.rs</code>:265 on 2025-02-07 16:43</div>
            <div class="timeline-body"><p>I'd prefer using <code>&amp;Stmt</code>a here if we always have a <code>stmt</code>. It encodes the constraint stronger (It otherwise leaves me wondering if <code>stmt</code> is guaranteed to be a <code>stmt</code> or if it is a left over from a refactor</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-02-07 16:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/pep695/non_pep695_type_alias.rs</code>:265 on 2025-02-07 16:46</div>
            <div class="timeline-body"><blockquote>
<p>I'd prefer using <code>&amp;Stmt</code>a here if we always have a <code>stmt</code>.</p>
</blockquote>
<p>Unfortunately we don't. This function is called from two possible functions: in one function we have a <code>&amp;StmtAssign</code> and in the other we have a <code>&amp;StmtAnnAssign</code>.</p>
<p>I could use <code>StmtRef</code>, though, if you'd prefer that?</p>
<pre><code class="language-diff">--- a/crates/ruff_linter/src/rules/pyupgrade/rules/pep695/non_pep695_type_alias.rs
+++ b/crates/ruff_linter/src/rules/pyupgrade/rules/pep695/non_pep695_type_alias.rs
@@ -5,7 +5,7 @@ use ruff_macros::{derive_message_formats, ViolationMetadata};
 use ruff_python_ast::name::Name;
 use ruff_python_ast::parenthesize::parenthesized_range;
 use ruff_python_ast::visitor::Visitor;
-use ruff_python_ast::{AnyNodeRef, Expr, ExprCall, ExprName, Keyword, StmtAnnAssign, StmtAssign};
+use ruff_python_ast::{Expr, ExprCall, ExprName, Keyword, StmtAnnAssign, StmtAssign, StmtRef};
 use ruff_text_size::{Ranged, TextRange};
 
 use crate::checkers::ast::Checker;
@@ -262,7 +262,7 @@ pub(crate) fn non_pep695_type_alias(checker: &amp;Checker, stmt: &amp;StmtAnnAssign) {
 /// Generate a [`Diagnostic`] for a non-PEP 695 type alias or type alias type.
 fn create_diagnostic(
     checker: &amp;Checker,
-    stmt: AnyNodeRef,
+    stmt: StmtRef,
     name: &amp;Name,
     value: &amp;Expr,
     type_vars: &amp;[TypeVar],
@@ -273,8 +273,13 @@ fn create_diagnostic(
     let content = format!(
         &quot;type {name}{type_params} = {value}&quot;,
         type_params = DisplayTypeVars { type_vars, source },
-        value = &amp;source[parenthesized_range(value.into(), stmt, checker.comment_ranges(), source)
-            .unwrap_or(value.range())]
+        value = &amp;source[parenthesized_range(
+            value.into(),
+            stmt.into(),
+            checker.comment_ranges(),
+            source
+        )
+        .unwrap_or(value.range())]
     );
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-07 16:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2025-02-07 16:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/resources/test/fixtures/pyupgrade/UP040.py</code>:120 on 2025-02-07 16:49</div>
            <div class="timeline-body"><p>This might be a good test case to add:</p>
<pre><code class="language-python">T: TypeAlias = (  # This comment should not make the fix unsafe
	int | str
)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-07 16:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/resources/test/fixtures/pyupgrade/UP040.py</code>:120 on 2025-02-07 16:53</div>
            <div class="timeline-body"><p>Thanks! However, all fixes for this rule are unsafe (because you can't use PEP-695 type aliases as the second argument in <code>isinstance()</code> calls, whereas you can with old-style type aliases that use <code>TypeAlias</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2025-02-07 16:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/resources/test/fixtures/pyupgrade/UP040.py</code>:120 on 2025-02-07 16:55</div>
            <div class="timeline-body"><blockquote>
<p>However, all fixes for this rule are unsafe</p>
</blockquote>
<p>Aren't they safe in stubs?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-02-07 16:55</div>
            <div class="timeline-body"><p>Sorry about that! Thanks for the quick fix! I don't have anything to add on top of the other reviews, LGTM.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-07 16:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/resources/test/fixtures/pyupgrade/UP040.py</code>:120 on 2025-02-07 16:57</div>
            <div class="timeline-body"><blockquote>
<p>Aren't they safe in stubs?</p>
</blockquote>
<p>hmm, good point. Want to make a followup PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-07 16:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/pep695/non_pep695_type_alias.rs</code>:265 on 2025-02-07 16:59</div>
            <div class="timeline-body"><p>I switched to use <code>StmtRef</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2025-02-07 17:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/resources/test/fixtures/pyupgrade/UP040.py</code>:120 on 2025-02-07 17:01</div>
            <div class="timeline-body"><p>Sure. I'm ready whenever you are.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-02-07 17:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-02-07 17:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-07 17:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:09:50 UTC
    </footer>
</body>
</html>
