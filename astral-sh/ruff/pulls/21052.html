<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Do not crash if a FileRoot is a symlink - astral-sh/ruff #21052</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Do not crash if a FileRoot is a symlink</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21052">#21052</a>
        opened by <a href="https://github.com/Gankra">@Gankra</a>
        on 2025-10-23 22:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/Gankra">@Gankra</a> on 2025-10-23 22:23</div>
            <div class="timeline-body"><p>This is a fix for the issue <a href="https://github.com/astral-sh/ruff/pull/21047#issuecomment-3437837018">described here</a>, where ty found my homebrew python site-packages, and then panicked because it was handling both symlink and non-symlink versions of the same directory (which, syntactically, are not subdirectories of eachother).</p>
<p>I am always suspicious of using canonicalize but it's not clear to me there's a way to avoid it here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @Gankra on 2025-10-23 22:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @Gankra on 2025-10-23 22:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @Gankra on 2025-10-23 22:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @Gankra on 2025-10-23 22:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Do not crash if a FileRoot is a symlink" to "[ty] Do not crash if a FileRoot is a symlink" by @Gankra on 2025-10-23 22:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @Gankra on 2025-10-23 22:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @Gankra on 2025-10-23 22:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-10-23 22:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ruff_db/src/files.rs</code>:194 on 2025-10-23 22:24</div>
            <div class="timeline-body"><p>On paper the first <code>absolute</code> is redundant but I'm not sure if <code>db.system().current_directory()</code> is able to be not-the-process-level-current-directory that  canonicalize_path uses.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-23 22:40</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-10-23 22:40</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/gankra%2Frootcause?utm_source=github&amp;utm_medium=comment&amp;utm_content=header">CodSpeed Performance Report</a></h2>
<h3>Merging #21052 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>gankra/rootcause</code> (8e12163) with <code>main</code> (b93d8f2)</sub></p>
<h3>Summary</h3>
<p><code>✅ 52</code> untouched</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @Gankra on 2025-10-23 23:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-23 23:43</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-23 23:44</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_test/src/db.rs</code>:194 on 2025-10-23 23:45</div>
            <div class="timeline-body"><p>This is a &quot;Hillarious&quot; interaction between <code>strip_prefix</code> and <code>dunce</code>.</p>
<p><code>dunce</code> removes &quot;unnecessary&quot; UNC prefixes, but the import_basic mdtest actually passes in a really really really long path, which <code>dunce</code> then goes &quot;ah UNC is needed&quot;.</p>
<p>This results in <code>canonicalized.strip_prefix(os_system.current_directory())</code> failing.</p>
<p>If you then go &quot;ah I will simply canonicalize <code>os_system.current_directory()</code>&quot; <strong>you still lose</strong> because <code>dunce</code> is very helpful and removes the unnecessary UNC prefix from the much shorter cwd!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-10-23 23:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-24 06:03</div>
            <div class="timeline-body"><p>I'd very much prefer not to call <code>canonicalize</code> in <code>Files</code> and, instead, call <code>canonicalize</code> where we add the <code>FileRoot</code> (and where we look it up if that turns out to be necessary). It limits the scope of where we have an undesired <code>canonicalize</code> call and also allows us to better document why it is necessary in this specific instance.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @AlexWaygood on 2025-10-24 07:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-10-24 13:47</div>
            <div class="timeline-body"><blockquote>
<p>I'd very much prefer not to call canonicalize in Files and, instead, call canonicalize where we add the FileRoot (and where we look it up if that turns out to be necessary).</p>
</blockquote>
<p>Do you mean you want this logic moved into the routine it's calling (FileRoot::try_add, FileRoot::at)?
Or do you mean out to each caller of  <code>try_add_root</code> / <code>expect_root</code> / <code>root</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-24 13:56</div>
            <div class="timeline-body"><p>Ideally, we'd canonicalize the path where we create it before adding it as a search path (or site package path or whatever it is). This should then also ensure that we only create paths that use the canonicalized representation. But I don't understand the specific problem enough to say whether that's possible</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-10-30 15:29</div>
            <div class="timeline-body"><p>Bafflingly I can't reproduce this anymore so I'm just gonna close this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Gankra on 2025-10-30 15:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @Gankra on 2025-10-31 14:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-10-31 15:04</div>
            <div class="timeline-body"><p>Ok micha got a reproducer. If you go in vscode and via the pallete select &quot;Python Interpretter: /opt/homebrew/bin/python3&quot; the crash occurs:</p>
<pre><code class="language-text">No root found for path '/opt/homebrew/Cellar/python@3.13/3.13.5/lib/python3.13/site-packages'. Known roots: FileRoots(
...
/opt/homebrew/Cellar/python@3.13/3.13.5/Frameworks/Python.framework/Versions/3.13/lib/python3.13/site-packages
</code></pre>
<p>On my system the path we select is a fractal symlink:</p>
<ol>
<li><code>/opt/homebrew/bin/python3</code></li>
<li><code>/opt/homebrew/Cellar/python@3.13/3.13.5/bin/python3</code></li>
<li><code>/opt/homebrew/Cellar/python@3.13/3.13.5/Frameworks/Python.framework/Versions/3.13/bin/python3</code></li>
<li><code>/opt/homebrew/Cellar/python@3.13/3.13.5/Frameworks/Python.framework/Versions/3.13/bin/python3.13</code></li>
</ol>
<p>Path 4 is a real file. If you pass 1 or 2 to <code>ty check --python ...</code> everything works fine. If you pass 3 or 4 we have this panic.</p>
<p>The actual crash involves two other dirs in a symlink relationship:</p>
<ol start="5">
<li><code>/opt/homebrew/Cellar/python@3.13/3.13.5/Frameworks/Python.framework/Versions/3.13/lib/python3.13/site-packages</code></li>
<li><code>/opt/homebrew/Cellar/python@3.13/3.13.5/lib/python3.13/site-packages</code></li>
</ol>
<p>Path 6 is an actual directory. We also see that path 6 is, weirdly, what you would discover if you searched for site-packages from <em>path 2</em>, which is wild because path 2 was a bloody symlink!</p>
<p>So when handed path 3 or 4 as <code>--python</code> we find that we're in a <em>real</em> directory (so even if we canonicalized at that point it would do nothing). At this point we search for and discover site-packages at path 5, which <em>is</em> a symlink but we don't normalize that away.</p>
<p>Then at some later point we end up with a copy of the same path but with the symlink resolved (path 6), and we freak out because the two paths aren't lexically nested.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-10-31 15:23</div>
            <div class="timeline-body"><p>Ok so the &quot;root cause&quot; is this canonicalize (and the absence of a paired canonicalize for <em>adding</em> a root):</p>
<p>https://github.com/astral-sh/ruff/blob/b93d8f2b9fa834ab7c672d801c725c0031d9408e/crates/ty_python_semantic/src/module_resolver/resolver.rs#L451-L464</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-10-31 16:41</div>
            <div class="timeline-body"><p>An unfortunate game of whackamole if you don't want to unconditionally canonicalize all paths.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-12 20:47</div>
            <div class="timeline-body"><p>Obsolete</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Gankra on 2025-11-12 20:47</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:54:19 UTC
    </footer>
</body>
</html>
