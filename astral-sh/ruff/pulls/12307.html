<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Add support for editable installs to the module resolver - astral-sh/ruff #12307</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Add support for editable installs to the module resolver</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/12307">#12307</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-07-12 19:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body">Summary
<p>This PR adds support for editable installations in <code>site-packages</code> to the module resolver. Still a few details to be checked vis-Ã -vis Python&#x27;s runtime semantics.</p>
<p>Work towards <a href="https://github.com/astral-sh/ruff/issues/11653">astral-sh/ruff#11653</a>.</p>
Test Plan
<p><code>cargo test -p red_knot_module_resolver</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-12 19:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-07-12 20:04</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>âœ… ecosystem check detected no linter changes.</p>
Linter (preview)
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-12 20:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/path.rs</code>:76 on 2024-07-12 20:24</div>
            <div class="timeline-body"><p>I considered just using the <code>SitePackages</code> variant for editable installs, since these search paths do come about as a consequence of <code>.pth</code> files in the <code>site-packages</code> directory. However, the search paths for editable installs aren&#x27;t necessarily children of the <code>site-packages</code> search path (and indeed most often won&#x27;t be), and I think it would be too easy to assume that all instances of the <code>SitePackages</code> variant have the <code>site-packages</code> directory as their root.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-12 20:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/path.rs</code>:222 on 2024-07-12 20:25</div>
            <div class="timeline-body"><p>At runtime, Python does no validation for whether or not the path is a directory before adding it to <code>sys.path</code>, according to the docs: https://docs.python.org/3/library/site.html#module-site. Possibly we shouldn&#x27;t either? I should check what mypy and pyright do here.</p>
<p>I&#x27;m not sure what happens if you have a path to a file, rather than a path to a directory, in <code>sys.path</code>? I&#x27;ve never seen that. I should check that too.</p>
<p>Python <em>does</em> check whether the path actually <em>exists</em> before adding it to <code>sys.path</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:208 on 2024-07-12 20:28</div>
            <div class="timeline-body"><p>This routine should probably be a Salsa query?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-12 20:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-12 20:46</div>
            <div class="timeline-body"><p>Dude, stop working ðŸ˜‚ I thought you needed some rest</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-12 20:51</div>
            <div class="timeline-body"><blockquote>
<p>Dude, stop working ðŸ˜‚ I thought you needed some rest</p>
</blockquote>
<p>I have an addiction :(</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-12 21:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:239 on 2024-07-12 21:14</div>
            <div class="timeline-body"><p>These paths aren&#x27;t normalized and they could be paths relative to <code>site-packages</code> rather than absolute paths. We might want to normalize them.</p>
<p>Mind you, we don&#x27;t normalize other search paths (to get rid of <code>.</code> and <code>..</code> components) anywhere yet either.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-12 21:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/path.rs</code>:222 on 2024-07-12 21:28</div>
            <div class="timeline-body"><p>Yeah, if you append a file to <code>sys.path</code> at runtime it doesn&#x27;t seem to have any impact on runtime semantics.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-13 12:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/path.rs</code>:222 on 2024-07-13 12:55</div>
            <div class="timeline-body"><p>Also tried editing a <code>.pth</code> file in a <code>site-packages</code> directory to include a path to a Python file; it doesn&#x27;t seem to affect which modules are imported or not. So I think it&#x27;s fine for us to ignore any paths that don&#x27;t point to directories</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-13 13:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-13 13:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-13 13:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-07-13 14:49</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/editables">CodSpeed Performance Report</a>
Merging #12307 will <strong>improve performances by 4.81%</strong>
<p>Comparing <code>editables</code> (0d64399) with <code>editables</code> (e29d3d4)</p>
Summary
<p><code>âš¡ 1</code> improvements
<code>âœ… 32</code> untouched benchmarks</p>
Benchmarks breakdown
<p>|     | Benchmark | <code>editables</code> | <code>editables</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| âš¡ | <code>red_knot_check_file[incremental]</code> | 90 Âµs | 85.9 Âµs | +4.81% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:1516 on 2024-07-13 14:49</div>
            <div class="timeline-body"><p>This test is failing, and I&#x27;m not sure why. To read the contents of the <code>pth</code> files, I&#x27;m using <code>system_path_to_file</code> in <code>PthFileIterator::next()</code>, and <code>source_text()</code> in <code>PthFile::new()</code>. IIUC, I think that should be sufficient to indicate to Salsa that the <code>module_search_paths()</code> query depends on the existence and contents of the <code>_foo.pth</code> file, and that therefore deleting the <code>_foo.pth</code> file should invalidate the previous query.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-13 14:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/testing.rs</code>:129 on 2024-07-15 07:54</div>
            <div class="timeline-body"><p>I don&#x27;t understand what <code>other_files</code> means here. Can this be any file? Where are they written to?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:177 on 2024-07-15 07:56</div>
            <div class="timeline-body"><p>Nit: We may want to fall this <code>first_party_root</code> because it isn&#x27;t equal to the workspace root when the source is e.g. stored in a <code>src</code> directory</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:236 on 2024-07-15 07:58</div>
            <div class="timeline-body"><p>Nit: Can we use an <code>IndexSet</code> here. What I understand is that <code>OrderSet</code> is only a thin wrapper around <code>IndexSet</code> that implements <code>Hash</code>. I don&#x27;t think we have a <code>Hash</code> requirement here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:256 on 2024-07-15 08:00</div>
            <div class="timeline-body"><p>I recommend that we call <code>db.report_untracked_read();</code> in the body. It informs salsa to only cache this query for the current revision. This ensures that the results are correct even when we don&#x27;t track the <code>system.is_directory</code> call yet (at a small perf penalty that this query is executed every time we run a new check phase but I think that&#x27;s neglectable).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:281 on 2024-07-15 08:04</div>
            <div class="timeline-body"><p>The <code>MemoryFileSystem</code> also doesn&#x27;t guarantee this in its contract. It would be okay for it to shuffle the entries before returning.</p>
<p>I recommend shortening the comment. The first two lines are what&#x27;s important.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:286 on 2024-07-15 08:04</div>
            <div class="timeline-body"><pre><code>            dynamic_paths.extend(pth_file.editable_installations().filter_map(
</code></pre>
<p>The <code>iter</code> prefix isn&#x27;t commonly used except for <code>iter</code> and <code>into_iter</code> methods</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:408 on 2024-07-15 08:11</div>
            <div class="timeline-body"><p>Can we store just the <code>File</code> instead?</p>
<p>On the other hand, if we use <code>db.report_untracked_read</code>, then there&#x27;s little benefit for storing <code>File</code> or even using <code>SourceText</code>. You can then simply store the <code>SystemPathBuf</code> and directly call <code>system.read_to_string</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:475 on 2024-07-15 08:12</div>
            <div class="timeline-body"><p>I think Charlie&#x27;s implementation also has an upper bound on the <code>pth</code> file sizes. Should we add this too?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:232 on 2024-07-15 08:15</div>
            <div class="timeline-body"><p>Considering that we build this set (this is the validated settings). Can&#x27;t we remove duplicates when constructing this struct. It seems wasteful to repeat the deduplication on every iterator call.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:347 on 2024-07-15 08:17</div>
            <div class="timeline-body"><p>Nit: I would make this a method on <code>ModuleResolutionSettings</code>, e.g. <code>.search_paths</code>. Feels easier to discover and comes with a nicer name (hiding the fact that it is an iterator or not)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:396 on 2024-07-15 08:20</div>
            <div class="timeline-body"><p>Is it adviced to trim the path?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:395 on 2024-07-15 08:22</div>
            <div class="timeline-body"><p>Isn&#x27;t the <code>site_packages</code> path guaranteed to be absolute? I would prefer guaranteeing that the <code>site_packages</code> path is absolute instead of relying on <code>system.current_directory</code> here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-15 08:22</div>
            <div class="timeline-body"><p>Overall looks good.</p>
<p>An unrelated comment for <code>resolver</code> (and some of them might be because how I structured the code). I find it difficult to read the code because I always have to jump up and down. The <code>ModuleResolutionSettings</code> aren&#x27;t next to the <code>ValidatedSearchPathSettings</code>, instead, the <code>Pth</code> code becomes in between. We shouldn&#x27;t refactor the code as part of this PR but maybe you can come up with an ordering that brings the code closer together.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-15 09:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:232 on 2024-07-15 09:23</div>
            <div class="timeline-body"><p>Yes, I wondered about this. I think it makes it slightly less clear to the reader exactly what data is being stored where, but I agree it would be more efficient. I&#x27;ll make the change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-15 11:01</div>
            <div class="timeline-body"><blockquote>
<p>An unrelated comment for <code>resolver</code> (and some of them might be because how I structured the code). I find it difficult to read the code because I always have to jump up and down. The <code>ModuleResolutionSettings</code> aren&#x27;t next to the <code>ValidatedSearchPathSettings</code>, instead, the <code>Pth</code> code becomes in between. We shouldn&#x27;t refactor the code as part of this PR but maybe you can come up with an ordering that brings the code closer together.</p>
</blockquote>
<p>Yeah, I have the same opinion. I&#x27;m planning on doing a followup where I move some more code out into a separate submodule just for finding the search paths -- but although this PR makes the problem worse, I didn&#x27;t want to do it in this PR, as it would have made the diff harder to read and review.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-15 11:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:236 on 2024-07-15 11:03</div>
            <div class="timeline-body"><p>Oh, sure. I just copied what was being done elsewhere in <code>red-knot</code> in places where we needed deduplicated sequences that maintained insertion order ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-15 11:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:475 on 2024-07-15 11:08</div>
            <div class="timeline-body"><p>I saw that. I believe it&#x27;s copied directly from pyright&#x27;s logic here: https://github.com/microsoft/pyright/blob/042d2ea58246f0e4a8e1597a540878badfae85b7/packages/pyright-internal/src/analyzer/pythonPathUtils.ts#L193-L206</p>
<p>I don&#x27;t much like it: it seems pretty ad-hoc to me. There&#x27;s nothing in the Python documentation that indicates that it will stop adding entries from <code>pth</code> files when they exceed a certain size. If you do end up with a massive <code>pth</code> file in <code>site-packages</code>, I don&#x27;t think it&#x27;s Ruff&#x27;s fault if that creates a startup penalty for Ruff: it&#x27;s probably the package the user installed, or the build backend that package is using, that&#x27;s doing something wrong there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-15 11:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:396 on 2024-07-15 11:10</div>
            <div class="timeline-body"><p>Not sure I understand the question here, sorry!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-15 11:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:395 on 2024-07-15 11:13</div>
            <div class="timeline-body"><p>The <code>site-packages</code> path is guaranteed to be absolute here, but without the call to <code>SystemPath::absolute()</code> here I think we could end up storing technically-valid-but-somewhat-strange paths as module resolution roots, e.g. <code>/site-packages/./../foo/bar/baz/src/</code>. I&#x27;d prefer to have that normalized as <code>/foo/bar/baz/src</code> before storing it as a module-resolution root (just for debuggability more than anything else).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-15 11:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:395 on 2024-07-15 11:14</div>
            <div class="timeline-body"><p>This is because the paths we&#x27;re trying to discover in <code>pth</code> files could be absolute paths, or they could be relative to <code>site-packages</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-15 11:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/testing.rs</code>:129 on 2024-07-15 11:16</div>
            <div class="timeline-body"><p>They can be any files, yes. Editable installs can point to directories that are outside any of the &quot;static&quot; module-resolution root paths, so we need a way of modelling that in tests. The files are written to wherever the path points: <code>.with_other_file([(&quot;/foo/bar/src/baz.py&quot;, &quot;&quot;)])</code> adds an empty file at location <code>/foo/bar/src/baz.py</code>.</p>
<p>I agree it&#x27;s not a great name... any ideas for how to improve it? :P</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:177 on 2024-07-15 11:17</div>
            <div class="timeline-body"><p>Yeah, that&#x27;s a great point</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-15 11:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-15 11:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:177 on 2024-07-15 11:35</div>
            <div class="timeline-body"><p>I&#x27;ll defer fixing this to a followup, since calling this <code>first_party_root</code> consistently would mean several files untouched by this PR would be altered, and it&#x27;s a preexisting issue</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-15 11:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:395 on 2024-07-15 11:45</div>
            <div class="timeline-body"><p>Makes sense. Can we then pass <code>site_packages</code> as the current working directory instead of <code>system.current_directory</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-15 11:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:396 on 2024-07-15 11:45</div>
            <div class="timeline-body"><p>I wonder what happens if you have a line like <code>a/b                                                          </code> (a lot of space). Should this resolve to <code>a/b</code> or throw because that directory probably doesn&#x27;t exist on disk :D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-15 11:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:177 on 2024-07-15 11:46</div>
            <div class="timeline-body"><p>Sounds good</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-15 12:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:395 on 2024-07-15 12:01</div>
            <div class="timeline-body"><p>Ah, yeah that works!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-15 12:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:396 on 2024-07-15 12:07</div>
            <div class="timeline-body"><p>Hehe. The Python spec doesn&#x27;t seem to say anything about preceding and trailing whitespace on each line of a <code>.pth</code> file, and I don&#x27;t know of any build backends that add preceding or trailing whitespace. Pyright trims preceding and trailing whitespace from each line, however (I assume because it wants to err on the side of leniency), and Charlie&#x27;s port does too. It seems reasonable to me to trim trailing whitespace; I already do that in the <code>PthFile::editable_installations()</code> method</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-15 12:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:177 on 2024-07-15 12:10</div>
            <div class="timeline-body"><p>I filed <a href="https://github.com/astral-sh/ruff/issues/12337">astral-sh/ruff#12337</a> so I don&#x27;t forget</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-15 12:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:256 on 2024-07-15 12:18</div>
            <div class="timeline-body"><p>I don&#x27;t fully understand what <code>report_untracked_read()</code> is doing here, but it fixes my tests, so I&#x27;ll take it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-15 12:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:1516 on 2024-07-15 12:28</div>
            <div class="timeline-body"><p>I took a quick look at the salsa events and this seems correct.</p>
<pre><code>[crates/red_knot_module_resolver/src/resolver.rs:1555:9] db.take_salsa_events().debug(&amp;db) = [
    Event {
        runtime_id: RuntimeId {
            counter: 0,
        },
        kind: WillCheckCancellation,
    },
    Event {
        runtime_id: RuntimeId {
            counter: 0,
        },
        kind: WillCheckCancellation,
    },
    Event {
        runtime_id: RuntimeId {
            counter: 0,
        },
        kind: WillCheckCancellation,
    },
    Event {
        runtime_id: RuntimeId {
            counter: 0,
        },
        kind: DidValidateMemoizedValue {
            database_key: source_text(2),
        },
    },
    Event {
        runtime_id: RuntimeId {
            counter: 0,
        },
        kind: DidValidateMemoizedValue {
            database_key: parse_typeshed_versions(2),
        },
    },
    Event {
        runtime_id: RuntimeId {
            counter: 0,
        },
        kind: WillCheckCancellation,
    },
    Event {
        runtime_id: RuntimeId {
            counter: 0,
        },
        kind: WillExecute {
            database_key: dynamic_module_resolution_paths(0),
        },
    },
    Event {
        runtime_id: RuntimeId {
            counter: 0,
        },
        kind: DidValidateMemoizedValue {
            database_key: resolve_module_query(0),
        },
    },
]
</code></pre>
<p>It re-runs the <code>dynamic_module_resolution_paths</code> query because the dynamic module resolution paths changed (you deleted a <code>phf</code> file). It then re-runs the <code>resolve_module_query</code> but evaluates to the same cached result. Not sure why this is the case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:1516 on 2024-07-15 12:34</div>
            <div class="timeline-body"><p>It seems that adding <code>db.report_untracked_read()</code> to the function body, like you suggested elsehwere, makes the test start passing. But then if I start using <code>db.system().read_to_string()</code> in the query to get the contents of the <code>.pth</code> file rather than <code>source_text()</code> (which you said <em>should</em> be okay if I added the <code>report_untracked_read()</code> call), it starts failing again.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-15 12:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-15 12:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/testing.rs</code>:129 on 2024-07-15 12:41</div>
            <div class="timeline-body"><p>I&#x27;m leaning towards calling <code>db.write_files(...)</code> in the few tests that need other files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-15 12:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/testing.rs</code>:129 on 2024-07-15 12:42</div>
            <div class="timeline-body"><p>Fair enough</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-15 12:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:256 on 2024-07-15 12:43</div>
            <div class="timeline-body"><p>It tells Salsa not to cache the result beyond a single revision (every time any input ingredient changes, the revision is bumped).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-15 12:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:408 on 2024-07-15 12:46</div>
            <div class="timeline-body"><blockquote>
<p>Can we store just the <code>File</code> instead?</p>
</blockquote>
<p>Hmm, if I make this change (which I think is what you&#x27;re suggesting):</p>
<pre><code>--- a/crates/red_knot_module_resolver/src/resolver.rs
+++ b/crates/red_knot_module_resolver/src/resolver.rs
@@ -330,7 +330,7 @@ impl&lt;&#x27;db&gt; FusedIterator for SearchPathIterator&lt;&#x27;db&gt; {}
 struct PthFile&lt;&#x27;db&gt; {
     db: &amp;&#x27;db dyn Db,
     path: SystemPathBuf,
-    contents: SourceText,
+    file: File,
     site_packages: &amp;&#x27;db SystemPath,
 }
 
@@ -344,7 +344,7 @@ impl&lt;&#x27;db&gt; PthFile&lt;&#x27;db&gt; {
         Self {
             db,
             path: pth_path,
-            contents: source_text(db.upcast(), file),
+            file,
             site_packages,
         }
     }
@@ -355,11 +355,13 @@ impl&lt;&#x27;db&gt; PthFile&lt;&#x27;db&gt; {
     where
         &#x27;a: &#x27;db,
     {
+        let contents = source_text(self.db.upcast(), self.file);
+
         // Empty lines or lines starting with &#x27;#&#x27; are ignored by the Python interpreter.
         // Lines that start with &quot;import &quot; or &quot;import\t&quot; do not represent editable installs at all;
         // instead, these are files that are executed by Python at startup.
         // https://docs.python.org/3/library/site.html#module-site
-        self.contents.lines().filter_map(|line| {
+        contents.lines().filter_map(|line| {
             let line = line.trim();
             if line.is_empty()
                 || line.starts_with(&#x27;#&#x27;)
</code></pre>
<p>Then I end up with compile errors:</p>
<pre><code>error[E0515]: cannot return value referencing local variable `contents`
   --&gt; crates/red_knot_module_resolver/src/resolver.rs:364:9
    |
364 |           contents.lines().filter_map(|line| {
    |           ^-------
    |           |
    |  _________`contents` is borrowed here
    | |
365 | |             let line = line.trim();
366 | |             if line.is_empty()
367 | |                 || line.starts_with(&#x27;#&#x27;)
...   |
374 | |             ModuleResolutionPathBuf::editable_installation_root(self.db, possible_editable_install)
375 | |         })
    | |__________^ returns a value referencing data owned by the current function
    |
    = help: use `.collect()` to allocate the iterator
</code></pre>
<p>Which I could fix easily enough by creating a custom iterator type that stores value returned by <code>source_text()</code>. But that doesn&#x27;t seem much different to storing the value returned by <code>source_text()</code> directly on <code>PthFile</code> itself, which is what I have now.</p>
<blockquote>
<p>On the other hand, if we use <code>db.report_untracked_read</code>, then there&#x27;s little benefit for storing <code>File</code> or even using <code>SourceText</code>. You can then simply store the <code>SystemPathBuf</code> and directly call <code>system.read_to_string</code>.</p>
</blockquote>
<p>I tried this, but it makes <code>deleting_pth_file_on_which_module_resolution_depends_invalidates_cache()</code> start failing again (it was fixed by adding the <code>report_untracked_read()</code> call).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-15 12:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/testing.rs</code>:129 on 2024-07-15 12:54</div>
            <div class="timeline-body"><p>Done in <a href="https://github.com/astral-sh/ruff/pull/12307">astral-sh/ruff#12307</a>/commits/1adf37d575a6d3571389a8fae3503f41060b5da7, though in my opinion it makes the test code somewhat uglier than it would be otherwise :(</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-15 13:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:408 on 2024-07-15 13:15</div>
            <div class="timeline-body"><p>I think I got a little bit closer to what you were recommending in <a href="https://github.com/astral-sh/ruff/pull/12307">astral-sh/ruff#12307</a>/commits/0c1e24c07dd0b742f8796243588f335be225a701</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-15 13:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:1409 on 2024-07-15 13:35</div>
            <div class="timeline-body"><p>Nit: I think I prefer comparing the paths. It gives nicer error messages (1 != 2)</p>
<pre><code>        assert_eq!(
            foo_module.file().path,
            FilePath::System(SystemPathBuf::from(&quot;/x/src/foo/__init__.py&quot;))
        );
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-15 13:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_module_resolver/src/path.rs</code>:76 on 2024-07-15 18:49</div>
            <div class="timeline-body"><p>I don&#x27;t have a problem with introducing a new enum variant for pth-added paths, though I&#x27;m also not totally convinced by it: I don&#x27;t know when we&#x27;d ever handle them differently, and it requires one more chunk of duplicated code wherever we handle this enum. I don&#x27;t think the confusion you mention should occur: in general search paths should never be children of other search paths (this is a really bad setup that leads to the same module being importable under two different names), so it doesn&#x27;t seem to me to be a likely confusion to assume this would be the case.</p>
<p>I&#x27;m not sure about the name <code>EditableInstall</code>. <code>pth</code> files are a feature of the Python import system that are <em>used</em> by the editable-install feature of some package managers, but the feature predates that use, and <code>pth</code> files have been (and I&#x27;m sure still are) used in many other ways as well (e.g. for the zipped-egg installation format of setuptools). So I think it&#x27;s potentially a little misleading to imply that every path discovered in a <code>.pth</code> file is an editable install.</p>
<p>I&#x27;d suggest <code>PthEntry</code> or something similar instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-07-15 18:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-07-15 19:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_module_resolver/src/path.rs</code>:222 on 2024-07-15 19:00</div>
            <div class="timeline-body"><p>Putting a file on <code>sys.path</code> is meaningful at runtime if there is an import loader that understands such an entry. For instance, the builtin zipfile import loader can load modules from zip files listed on <code>sys.path</code>. The homebrew-installed <code>python3</code> on my MacBook actually has the path <code>.../lib/python312.zip</code> on <code>sys.path</code> by default.</p>
<p>I don&#x27;t think it&#x27;s totally out of the question that we&#x27;d support zip loader someday (it wouldn&#x27;t be technically all that hard, since we&#x27;re already doing it for vendored files), but it seems pretty unlikely, since these days it&#x27;s not much used AFAIK. So I think it&#x27;s fine to just assume/require only directories on <code>sys.path</code> for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:256 on 2024-07-15 19:03</div>
            <div class="timeline-body"><p>I think we should add a comment above the call to <code>db.report_untracked_read()</code> explaining what it does, why it&#x27;s needed, and under what conditions we could remove it. (This should be a TODO comment if we intend to remove it at some point.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:353 on 2024-07-15 19:09</div>
            <div class="timeline-body"><pre><code>        // instead, these are lines that are executed by Python at startup.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-07-15 19:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-07-15 19:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:396 on 2024-07-15 19:17</div>
            <div class="timeline-body"><p>Python at runtime only strips trailing whitespace, not leading whitespace: https://github.com/python/cpython/blob/main/Lib/site.py#L208</p>
<p>I also verified that behavior experimentally.</p>
<p>I think we should do the same thing the runtime does.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-16 13:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/path.rs</code>:76 on 2024-07-16 13:04</div>
            <div class="timeline-body"><blockquote>
<p>I&#x27;m not sure about the name <code>EditableInstall</code>. <code>pth</code> files are a feature of the Python import system that are <em>used</em> by the editable-install feature of some package managers, but the feature predates that use, and <code>pth</code> files have been (and I&#x27;m sure still are) used in many other ways as well (e.g. for the zipped-egg installation format of setuptools). So I think it&#x27;s potentially a little misleading to imply that every path discovered in a <code>.pth</code> file is an editable install.</p>
</blockquote>
<p>Hrm, true, but the validation we do elsewhere should ensure that we only add paths that point to directories when we iterate through <code>.pth</code> files to try to find paths that could potentially be editable installs. While it&#x27;s true that a directoy path in a <code>.pth</code> file could point to something which wasn&#x27;t intended to be an editable install, the Python runtime will still consider Python modules at that path to be importable, correct (since they&#x27;ll be added to <code>sys.path</code> by <code>site.py</code>)? So IIUC a directory path in a <code>.pth</code> file is <em>in effect</em> an editable install, even if it... wasn&#x27;t meant to be.</p>
<p>All of which is to say, from the perspective of the module resolver, this variant should only really be used if we think it&#x27;s more-likely-than-not that a path represents a directory that has been editably installed, or a path relative to a path representing a directory that has been editably installed. We should have done sufficient validation at this point that it&#x27;s more than just &quot;an arbitrary line in a <code>.pth</code> file&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-16 14:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:170 on 2024-07-16 14:26</div>
            <div class="timeline-body"><p>I&#x27;ve realised that using an <code>OrderSet</code> here isn&#x27;t sufficient to enforce that there&#x27;ll be no duplication in the final list of search paths. <code>ModuleResolutionPathBuf::FirstParty(SystemPathBuf(&quot;/src&quot;))</code> and <code>ModuleResolutionPathBuf::EditableInstall(SystemPathBuf(&quot;/src&quot;))</code> will hash differently (and that&#x27;s correct), due to them being different enum variants. But we shouldn&#x27;t add the second one to the list of search paths for us to consider if the first one is already in the list, since they point to the same underlying path on disk :/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/path.rs</code>:76 on 2024-07-16 14:40</div>
            <div class="timeline-body"><p>I&#x27;m okay with either name but it might be at the time that we add some documentation to each variant because I don&#x27;t think the linked order still applies (it doesn&#x27;t mention editable installs)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:170 on 2024-07-16 14:55</div>
            <div class="timeline-body"><p>You probably want to do a dedupe pass first OR collect all system paths into a set and test if they aren&#x27;t already in the set before adding a new search path. What about <code>/src</code> and <code>/src/foo</code>. If this needs to be handled too, then you probably have to test the entire ancestor chain of every path before adding a new entry.</p>
<p>Should this be an <code>IndexMap</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:241 on 2024-07-16 14:58</div>
            <div class="timeline-body"><p>Should this be an <code>IndexSet</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:354 on 2024-07-16 14:59</div>
            <div class="timeline-body"><p>Do we also need to remove duplicates from here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:408 on 2024-07-16 15:00</div>
            <div class="timeline-body"><p>What&#x27;s the motivation for using <code>SourceText</code> as <code>contents</code> over just <code>String</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:343 on 2024-07-16 16:09</div>
            <div class="timeline-body"><p>Nit: I think you can just use the <code>db</code> lifetime</p>
<pre><code>    fn editable_installations&lt;&#x27;a&gt;(&amp;&#x27;db self) -&gt; impl Iterator&lt;Item = ModuleResolutionPathBuf&gt; + &#x27;db
    {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:382 on 2024-07-16 16:10</div>
            <div class="timeline-body"><p>Nit: We can remove this comment now thanks to the <code>record_untracked_read</code> call.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:249 on 2024-07-16 16:11</div>
            <div class="timeline-body"><p>Nit: Should these method be called <code>editable_install_resolution_paths</code> to better align with the naming of the path variant?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-07-16 16:13</div>
            <div class="timeline-body"><p>This looks good to me. Thanks for addressing all feedback.</p>
<p>I think we should handle deduplication in a follow up PR. It&#x27;s not specifically related to editable installs. It&#x27;s just that editable installs make the problem worse.</p>
<p>My only ask before merging is to change <code>PthFile</code> to use a <code>String</code> instead of <code>SourceText</code> and to use <code>IndexMap</code> over <code>OrderedSet</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-16 16:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:170 on 2024-07-16 16:21</div>
            <div class="timeline-body"><blockquote>
<p>What about <code>/src</code> and <code>/src/foo</code></p>
</blockquote>
<p>That&#x27;s bad coding practice (as Carl mentioned elsewhere), and will probably end up with surprising results for the user, but the runtime adds them both to <code>sys.path</code> in that situation, and we should aim to emulate the runtime in that regard. Possibly we could emit some kind of warning telling the user that this probably will have bad effects down the line, but at the same time there might be a reason for doing this (quite unusual) thing, so that might also be annoying.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-16 16:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:354 on 2024-07-16 16:24</div>
            <div class="timeline-body"><p>I don&#x27;t think it&#x27;s possible to have two duplicate <code>.pth</code> files (with duplicate filenames) in the same directory</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-16 16:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:249 on 2024-07-16 16:29</div>
            <div class="timeline-body"><p>I guess I wanted to have a clean distinction between &quot;static&quot; resolution paths that can be derived solely from the Ruff settings given to us by the user, and &quot;dynamic&quot; paths that we have to figure out for ourselves by iterating through <code>.pth</code> files. And I suppose there&#x27;s a possibility that we might want to add support for some other kind of &quot;dynamic&quot; resolution paths in the future (not editables), which we might also want to implement as part of this routine.</p>
<p>But I&#x27;m okay with this proposed rename for now; that&#x27;s pretty hypothetical, and I don&#x27;t have any specific idea of what other dynamic search paths there could be.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-16 16:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:241 on 2024-07-16 16:34</div>
            <div class="timeline-body"><p>No -- we need to know exactly what the site-packages path is later because we only lazily compute the editable-install search paths from the <code>.pth</code> files when and if we hit a module resolution that requires it. When we lazily compute the editable-install paths, we need to know the path to <code>site-packages</code> so that we can call <code>read_dir()</code> on the site-packages path and find all the <code>.pth</code> files in it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-16 16:36</div>
            <div class="timeline-body"><blockquote>
<p>to use <code>IndexMap</code> over <code>OrderedSet</code>.</p>
</blockquote>
<p>I already changed the PR so that it uses <code>indexmap::IndexSet</code> internally rather than <code>ordermap::OrderSet</code>. But I think I have a confusingly named type alias in there. I&#x27;ll change the name of that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-16 16:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:241 on 2024-07-16 16:43</div>
            <div class="timeline-body"><p>Sorry. I meant line 240</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:354 on 2024-07-16 16:45</div>
            <div class="timeline-body"><p>What I meant was more whether we need to duplicate the paths to which the <code>pth</code> files point to, e.g. if you have one pointing to <code>ruff</code> and another to <code>ruff/api</code>. Or is this also considered bad practice?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-16 16:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-16 16:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:241 on 2024-07-16 16:45</div>
            <div class="timeline-body"><p><code>OrderSet</code> in this file is currently (following your previous review comments) just defined as</p>
<pre><code>type OrderSet&lt;T&gt; = indexmap::IndexSet&lt;T, BuildHasherDefault&lt;FxHasher&gt;&gt;;
</code></pre>
<p>But that&#x27;s a pretty darn confusing name for me to have given that type alias! So I&#x27;ll change that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-16 16:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:241 on 2024-07-16 16:47</div>
            <div class="timeline-body"><p>ah that explains it lol.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-16 16:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:354 on 2024-07-16 16:48</div>
            <div class="timeline-body"><p>In the <code>for</code> loop immediately below this, we do indeed use a data structure that removes strict duplicates. But yeah, we shouldn&#x27;t remove paths that overlap, only paths that are strict duplicates.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-16 18:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:408 on 2024-07-16 18:10</div>
            <div class="timeline-body"><p>I switched it to use <code>String</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-16 18:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:256 on 2024-07-16 18:10</div>
            <div class="timeline-body"><p>Added a big TODO</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-16 18:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/path.rs</code>:76 on 2024-07-16 18:11</div>
            <div class="timeline-body"><p>Adding some more docs makes sense but I won&#x27;t do it <em>just</em> now, since I may still refactor this pretty soon according to the idea Carl suggested on one of my earlier PRs</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-16 18:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-16 18:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-07-16 18:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-07-16 18:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_module_resolver/src/path.rs</code>:76 on 2024-07-16 18:24</div>
            <div class="timeline-body"><p>Certainly any path found in a <code>.pth</code> file will be added to <code>sys.path</code>, and particularly if that path is a directory, it will result in modules there being importable. I&#x27;m not sure if there is any other validation you&#x27;re referring to that we do.</p>
<p>The logical jump you&#x27;re making that I don&#x27;t quite follow is &quot;if we add a path to sys.path that makes things importable, that&#x27;s an &#x27;editable install&#x27;.&quot; I don&#x27;t think that follows. It&#x27;s just importable Python source code. &quot;Editable install&quot; is a very specific user-facing feature that implies a certain use case. For example, there&#x27;s no reason the path added by the <code>pth</code> file line couldn&#x27;t point to some Python code on a read-only filesystem. We should still support that just fine, but it&#x27;s not very editable! In that case the pth file entry is being used for some other use case that I wouldn&#x27;t describe as an &quot;editable install.&quot;</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:05:13 UTC
    </footer>
</body>
</html>
