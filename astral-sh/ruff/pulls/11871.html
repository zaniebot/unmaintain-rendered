<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use re-lexing for normal list parsing - astral-sh/ruff #11871</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use re-lexing for normal list parsing</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11871">#11871</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-06-14 12:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body">Summary
<p>This PR is a follow-up on #11845 to add the re-lexing logic for normal list parsing.</p>
<p>A normal list parsing is basically parsing elements without any separator in between i.e., there can only be trivia tokens in between the two elements. Currently, this is only being used for parsing <strong>assignment statement</strong> and <strong>f-string elements</strong>. Assignment statements cannot be in a parenthesized context, but f-string can have curly braces so this PR is specifically for them.</p>
<p>I don&#x27;t think this is an ideal recovery but the problem is that both lexer and parser could add an error for f-strings. If the lexer adds an error it&#x27;ll emit an <code>Unknown</code> token instead while the parser adds the error directly. I think we&#x27;d need to move all f-string errors to be emitted by the parser instead. This way the parser can correctly inform the lexer that it&#x27;s out of an f-string and then the lexer can pop the current f-string context out of the stack.</p>
Test Plan
<p>Add test cases, update the snapshots, and run the fuzzer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-06-14 12:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-06-14 12:45</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/dhruv/re-lexing-2">CodSpeed Performance Report</a>
Merging #11871 will <strong>not alter performance</strong>
<p>Comparing <code>dhruv/re-lexing-2</code> (7543306) with <code>main</code> (8499abf)</p>
Summary
<p><code>✅ 30</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-06-14 13:00</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-06-17 10:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-06-17 10:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-06-18 06:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-06-18 06:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-06-18 06:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-06-18 06:44</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:04:40 UTC
    </footer>
</body>
</html>
