<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Migrate `is_equivalent_to` unit tests to Markdown tests - astral-sh/ruff #15470</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Migrate <code>is_equivalent_to</code> unit tests to Markdown tests</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15470">#15470</a>
        opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a>
        on 2025-01-14 09:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Part of astral-sh/ruff#15397, built on top of astral-sh/ruff#15469.</p>
<h2>Test Plan</h2>
<p>Markdown tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @InSyncWithFoo on 2025-01-14 09:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @InSyncWithFoo on 2025-01-14 09:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @InSyncWithFoo on 2025-01-14 09:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @InSyncWithFoo on 2025-01-14 09:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by @AlexWaygood on 2025-01-14 09:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-01-14 09:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-14 09:42</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_equivalent_to.md</code>:1 on 2025-01-14 14:58</div>
            <div class="timeline-body"><p>Minor:</p>
<pre><code class="language-suggestion"># Equivalence relation
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-14 14:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> approved on 2025-01-14 15:00</div>
            <div class="timeline-body"><p>Thank you. This looks good to me as soon as the conflicts have been resolved.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @MichaReiser removed by @MichaReiser on 2025-01-14 15:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_equivalent_to.md</code>:2 on 2025-01-14 17:42</div>
            <div class="timeline-body"><pre><code class="language-suggestion">
`is_equivalent_to` implements the equivalence relation for fully static types.

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1958 on 2025-01-14 17:48</div>
            <div class="timeline-body"><p>I don't think this change is a good idea.</p>
<p>In the previous tests, we asserted the relation in both directions for every pair of types, including in the negative cases. This change doesn't give us similar testing of commutativity, particularly for the negative tests, because if one direction returns true and the other direction returns false, we'll just report false. So non-commutativity in the negative equivalence tests would have been caught as an error previously, and now would silently pass.</p>
<p>I also think that for clarity reasons, <code>knot_extensions.is_equivalent_to</code> should simply reflect what our <code>is_equivalent_to</code> function does, and not implicitly double-check the commutation.</p>
<p>I think that instead of making this change, we should explicitly test both directions in the markdown tests. If that's too painful, we should consider just not moving these to mdtests.</p>
<p>@sharkdp, you already reviewed this and were prepared to land it as-is; how do you feel about this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-01-14 17:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-14 18:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_equivalent_to.md</code>:2 on 2025-01-14 18:03</div>
            <div class="timeline-body"><p>It would also be good to link to https://typing.readthedocs.io/en/latest/spec/glossary.html#term-equivalent and/or https://typing.readthedocs.io/en/latest/spec/concepts.html#subtype-supertype-and-type-equivalence here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2025-01-14 18:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1958 on 2025-01-14 18:15</div>
            <div class="timeline-body"><p>The tests for <code>is_disjoint_from</code> have the same problem, but much worse in that there are many more of them compared to that of <code>is_equivalent_to</code>.</p>
<p>Perhaps <code>is_equivalent_to</code>/<code>is_disjoint_from</code> should return <code>tuple[bool, bool]</code> instead?</p>
<pre><code class="language-python"># knot_extensions.pyi
BOTH_WAYS = (True, True)
NEITHER_WAYS = (False, False)

def is_equivalent_to(...) -&gt; tuple[bool, bool]: ...

# is_equivalent_to.md
static_assert(is_equivalent_to(A, B) == BOTH_WAYS)
static_assert(is_equivalent_to(A, B) == NEITHER_WAYS)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-14 18:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1958 on 2025-01-14 18:17</div>
            <div class="timeline-body"><p>or we could add more functions such as <code>knot_extensions.is_commutatively_equivalent()</code> and <code>knot_extensions.is_commutatively_disjoint()</code>?</p>
<p>(Wait for Carl's and/or David's response before going ahead and implementing this!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-01-14 18:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1958 on 2025-01-14 18:25</div>
            <div class="timeline-body"><p>Good point about the <code>is_disjoint_from</code> tests!</p>
<p>I feel that <code>knot_extensions.is_equivalent_to</code> and <code>knot_extensions.is_disjoint_from</code> are semantically meaningful type operations that I'm comfortable exposing publicly to users of red-knot. These operations should simply be commutative, and if they are not, it's a bug in red-knot. Testing that we in fact implement them commutatively is a concern only of red-knot's test suite, which I don't want to expose in the public API of those methods. So I don't want them to check commutativity or return two booleans.</p>
<p>So if we want to move these tests to mdtest, without manual testing of commutativity, then I prefer Alex's suggestion of dedicated methods for this purpose.</p>
<p>My main hesitance is that these would be the first methods in the <code>knot_extensions</code> namespace that are intended solely for testing red-knot, and that I would not prefer to expose otherwise. This suggests possibly putting them in a different namespace, and possibly adding some infrastructure to only expose that namespace in red-knot tests, and not otherwise. I think this is all doable, but it's certainly more work.</p>
<p>Would like to hear @sharkdp take on this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1958 on 2025-01-14 18:29</div>
            <div class="timeline-body"><p>Oh! Last time I looked at the PR, it was still showing a version that was combined with the is-subtype-of changes, and I completely missed this change, thinking it was something from the previous changeset.</p>
<blockquote>
<p>I also think that for clarity reasons, <code>knot_extensions.is_equivalent_to</code> should simply reflect what our <code>is_equivalent_to</code> function does,</p>
</blockquote>
<p>Yes, absolutely.</p>
<blockquote>
<p>Perhaps <code>is_equivalent_to</code>/<code>is_disjoint_from</code> should return <code>tuple[bool, bool]</code> instead?</p>
</blockquote>
<blockquote>
<p>or we could add more functions such as <code>knot_extensions.is_commutatively_equivalent()</code> and <code>knot_extensions.is_commutatively_disjoint()</code>?</p>
</blockquote>
<p>I'm personally not a big fan of either of these options. I would propose we add a &quot;is_equivalent_to is commutative&quot; section to this suite, add a couple of (non exhaustive) tests, and then rely on a <code>is_equivalent_to_is_commutative</code> property test to specifically test this property. We can add a reference to the property test in this file.</p>
<p>Yes, this would not be equivalent to (heh) what we had before, but I don't think that a commutativity-violation is a very likely scenario. And if so, we would hopefully catch that using the new property test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-14 18:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-14 18:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1958 on 2025-01-14 18:29</div>
            <div class="timeline-body"><p>That reminds me that I had an idea for a way we could issue a warning to users about the <code>knot_extensions</code> API relatively easily: https://github.com/astral-sh/ruff/issues/15355#issuecomment-2590811421</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-14 18:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1958 on 2025-01-14 18:30</div>
            <div class="timeline-body"><p>I'm also happy to go with @sharkdp's suggested path here!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1958 on 2025-01-14 18:31</div>
            <div class="timeline-body"><p>I like @sharkdp 's proposal.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-01-14 18:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-14 18:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1958 on 2025-01-14 18:32</div>
            <div class="timeline-body"><p>Additional thought: if we had &quot;inlining&quot; of small functions during type inference (like pyright), we could potentially even write helpers such as <code>is_commutatively_equivalent</code> in Python, which would be neat.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-01-14 18:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1958 on 2025-01-14 18:53</div>
            <div class="timeline-body"><p>Either inlining (so we could just write the helpers without annotations), or explicit <code>TypeForm</code> annotations, would allow this!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-01-14 18:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @carljm on 2025-01-14 18:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-01-14 18:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-14 19:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-15 08:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1958 on 2025-01-15 08:15</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/15488</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-01-15 17:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1958 on 2025-01-15 17:01</div>
            <div class="timeline-body"><blockquote>
<p>or explicit <code>TypeForm</code> annotations</p>
</blockquote>
<p>For posterity: @sharkdp pointed out in chat that this wouldn't be enough to propagate the right literal boolean return type back; we'd need to be able to annotate with something like <code>def is_commutative_equivalent_to[T, S](ty_a: TypeForm[T], ty_b: TypeForm[S]) -&gt; And[is_equivalent_to(T, S), is_equivalent_to(S, T)]: ...</code> -- obviously that return type annotation is depending on several things that don't exist :)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:09:08 UTC
    </footer>
</body>
</html>
