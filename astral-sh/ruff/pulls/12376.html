<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Improve validation for search paths - astral-sh/ruff #12376</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Improve validation for search paths</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/12376">#12376</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-07-18 11:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR cleans up the settings validation and types in the module resolver. Namely:</p>
<ul>
<li>Currently we validate that a <code>ModuleResolutionPathBuf</code> has either no extension, a <code>.pyi</code> extension or a <code>.py</code> extension. But for search paths specifically (which are the only module-resolution paths that are ever directly constructed), that's the wrong kind of validation for us to do: we should just validate that the path points to a directory.</li>
<li>For custom typeshed directories, validate that a <code>&lt;typeshed&gt;/stdlib/</code> directory exists, that a <code>&lt;typeshed&gt;/stdlib/VERSIONS</code> file exists, and that the <code>VERSIONS</code> file parses.</li>
</ul>
<h2>Test Plan</h2>
<p><code>cargo test -p red-knot_module_resolver</code>. I haven't added any new tests specifically as part of this PR, but I'm happy to if you'd find them useful, either as this PR or as a followup.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2024-07-18 11:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2024-07-18 11:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2024-07-18 11:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-07-18 12:11</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-18 12:37</div>
            <div class="timeline-body"><p>I think it would ease reviewing if the validation change and the structure change aren't in the same PR. Or is there a specific reason why you put both changes into one PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-18 12:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:114 on 2024-07-18 12:37</div>
            <div class="timeline-body"><p>What's the motivation for prefixing the query with <code>resolve</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-18 12:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/path.rs</code>:770 on 2024-07-18 12:38</div>
            <div class="timeline-body"><p>All the <code>is_directory</code> reads will be a problem because they by-pass Salsa.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-18 12:40</div>
            <div class="timeline-body"><blockquote>
<p>I think it would ease reviewing if the validation change and the structure change aren't in the same PR. Or is there a specific reason why you put both changes into one PR?</p>
</blockquote>
<p>I started off only doing the validation changes, but then I realised that really there were different invariants for module-search paths as opposed to module-resolution paths in general, and so improving the validation didn't really make sense while they were still being represented by one type. But I can certainly split it into two PRs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-18 12:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:114 on 2024-07-18 12:44</div>
            <div class="timeline-body"><p>This function now returns a <code>Result</code>. We now have another <code>module_resolution_settings(db: &amp;dyn Db)</code> function that simply calls <code>resolve_module_resolution_settings(db).as_ref().unwrap()</code>. This still obviously isn't correct, because we're still panicking when we shouldn't, but:</p>
<ul>
<li>it's now isolated to one <code>.unwrap()</code> call and TODO comment</li>
<li>we should get a nicer error message when the panic happens rather than just &quot;called <code>.unwrap()</code> on a None value&quot;</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-18 12:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:114 on 2024-07-18 12:55</div>
            <div class="timeline-body"><p>I would call this method <code>try_module_resolution_settings</code> to make it clear that this returns a <code>Result</code>.</p>
<p>We should make the <code>module_resolution_settings</code> a query because it panics anyway (nothing to cache)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-18 13:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/path.rs</code>:770 on 2024-07-18 13:16</div>
            <div class="timeline-body"><p>I thought search-path settings were set once at the start of the process, and then never changed after that. Given that, is Salsa invalidation necessary here? If the settings never change, then the settings will only ever be validated once, so this function will only ever be executed once.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @AlexWaygood on 2024-07-18 13:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-18 13:49</div>
            <div class="timeline-body"><p>I've extracted the structure change into its own PR: https://github.com/astral-sh/ruff/pull/12379.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Use a distinct type for module search paths in the module resolver" to "[red-knot] Improve validation for search paths" by @AlexWaygood on 2024-07-23 10:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @AlexWaygood on 2024-07-23 10:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-23 11:00</div>
            <div class="timeline-body"><p>Following the changes made in https://github.com/astral-sh/ruff/commit/2a8f95c437d64fdd9b2d512ac065288d775aabfb (which this PR is now rebased on top of), this PR is now solely focussed on improving validation for search-path settings.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2024-07-23 11:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_module_resolver/src/path.rs</code>:770 on 2024-07-23 22:34</div>
            <div class="timeline-body"><p>I think we need to watch these paths and if something we are assuming is a directory becomes not-a-directory, we need to react to that -- but I'd also assumed that this type of change (which should be rare) would mean totally starting over, which seems like it means Salsa invalidation wouldn't be relevant.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-07-23 22:34</div>
            <div class="timeline-body"><p>This looks good to me, but will leave to Micha to stamp once the question of Salsa invalidation is resolved.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/path.rs</code>:770 on 2024-07-24 07:10</div>
            <div class="timeline-body"><p>Watching the directories wouldn't be sufficient. We would have to watch the parent directories because a change from file to directory is technically a different file (watching is file and not path-based). But that would significantly increase the number of files we watch, and some systems limit the number of files that can be watched. That's why I think that we don't want to do that.</p>
<p>There's also the problem that we can't watch the folders if resolving the module resolution failed. At least not without duplicating a lot of this logic in the code where  we set-up file watching. That's why I'm actually not sure if we want to error in the first place or if it would be better fallback to reasonable defaults. Because failing to start means that the LSP can support no-completion whatsoever. It also can't provide any help fixing the ruff settings. It's just dead.</p>
<blockquote>
<p>I thought search-path settings were set once at the start of the process, and then never changed after that.</p>
</blockquote>
<p>This is correct today but not long-term. A user can change the workspace settings at any time, and we have to respond to that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-24 07:13</div>
            <div class="timeline-body"><p>I like the validation code but I don't think the &quot;all settings must be valid or we don't use any of the provided settings&quot; provides the best user experience. It means the CLI will fail to start and so will the LSP. This severely limits the LSP because it can't provide any help when editing the settings.</p>
<p>I think a better approach would be to recover as many user settings as possible. This gives us the <em>closest</em> to what the user wanted. We can surface the error messages with <code>tracing::warn</code> or <code>tracing::error</code> for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-24 10:52</div>
            <div class="timeline-body"><blockquote>
<p>I like the validation code but I don't think the &quot;all settings must be valid or we don't use any of the provided settings&quot; provides the best user experience. It means the CLI will fail to start and so will the LSP.</p>
</blockquote>
<p>I think this is somewhere where we might want different behaviour depending on whether redknot is being run as a CLI tool or as an LSP server.</p>
<p>As an LSP server, I can see that it makes sense to try to recover as much as possible, as the user may be in the middle of editing their workspace settings -- and even if they're not, it's annoying if redknot completely gives up from linting all your code because of a small typo in your workspace settings.</p>
<p>As a CLI tool, I think the tradeoff is pretty different. Something I've really liked about Ruff in the past is how strictly it validates the settings passed to it. It means that there's no ambiguity, and no chance of Ruff silently doing the wrong thing. This is especially important, in my view, for a tool that applies autofixes to your code -- moreover, it's a tool that many people have installed as a pre-commit hook, which means it'll automatically apply autofixes as part of every commit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-24 10:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/path.rs</code>:770 on 2024-07-24 10:53</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>I thought search-path settings were set once at the start of the process, and then never changed after that.</p>
</blockquote>
<p>This is correct today but not long-term. A user can change the workspace settings at any time, and we have to respond to that.</p>
</blockquote>
<p>I see -- this is different to what I had previously understood</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-24 11:30</div>
            <div class="timeline-body"><p>I agree on that assessment. But that still means that the infrastructure has to handle it gracefully for the LSP case. The CLI will want to call some function that tells it if the settings are correct.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-24 12:33</div>
            <div class="timeline-body"><p>I don't have error handling figured out entirely at this point, but I generally see two options, and I'm leaning towards option 1 for module resolution. But it's not entirely clear how we would implement it for module resolution specifically.</p>
<h2>Handle possible fatal errors <strong>outside</strong> of salsa</h2>
<p>What I mean by that, is that we avoid handling errors that are potentially fatal inside of Salsa queries and instead force the CLI/LSP to handle them when creating the Salsa inputs. Specifically to module resolution, this would mean that we validate the search paths <strong>before</strong> setting them on <code>Program</code> by exposing a method that has a <code>Result&lt;Settings, (Settings, Errors)&gt;</code>  return type where <code>Ok</code> means the settings are okay and <code>Err</code> returns the &quot;recovered&quot; settings with the encountered errors. The CLI and LSP can then decide how to recover from the error, e.g. by using the fallback setting, exit, or e.g. continue using any old search path settings from a previous pass.</p>
<p>This has two benefits:</p>
<ul>
<li>The validation would happen outside of Salsa. That means we don't have to worry about using any <code>system</code> APIs</li>
<li>The salsa queries can assume that the input are valid. There's still a slight chance that someone deletes the directory between us checking the paths and running the analysis. But there's not much we can do about this. That's just bad luck (or bad intention)</li>
</ul>
<p>I think I want to use a similar design for handling errors related to the configuration.</p>
<p>The main challenge I see with this, specifically for module resolution, is that <code>Program</code> lives in <code>ruff_db</code>. I don't have a good solution for this just now.</p>
<h2>Gracefully handle the errors inside Salsa</h2>
<p>This is the approach that I want to use for any non-fatal errors, e.g. we fail to read a single file. We extend <code>SourceText</code> with an <code>error: Option&lt;Error&gt;</code> field that indicates that reading the file failed. Regular queries that call <code>source_text</code> won't bother whether the error is set. They'll simply assume that everything worked just fine. However, <code>check_file</code> would explicitly call <code>source_text</code> and check if reading the file was successful. If not, abort checking and instead emit a diagnostic.</p>
<p>We could do the same for module resolution but it does have the downside that <em>forgetting</em> to check if the operation failed is silent and, therefore, easy.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-24 13:05</div>
            <div class="timeline-body"><p>I agree there's lots of design work still to be done here regarding error handling and settings resolution. It wasn't really my intent to solve that problem in this PR; I just really wanted to make the validation we were already doing make some kind of sense, and to add some proper error messages for it rather than simply having the module resolver call <code>.unwrap()</code> on an <code>Option</code> value.</p>
<p>@MichaReiser, what's your specific concern with the changes this PR is making? It's already the case on <code>main</code> that we panic in the module resolver as soon as we find a single search path that we consider to be invalid; this PR doesn't change anything in that regard. Should I add some more TODOs around the system calls in <code>path.rs</code> saying that we'll need to revisit them if we end up deciding to do settings resolution inside Salsa?</p>
<p>I can think of lots of possible ideas for solving the bigger questions you're posing here, but I'm not sure any of them are in the scope of this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-24 13:13</div>
            <div class="timeline-body"><p>My main concern is that it isn't a clear improvement to me because it introduces new unobserved <code>system</code> calls and isn't strictly moving toward the desired design. I'm not opposed to merging it. It's just that it kind of solves validation but kind of doesn't.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-07-24 13:52</div>
            <div class="timeline-body"><p>But I don't think these are reasons enough to not land this PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2024-07-24 14:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-07-24 14:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-07-24 14:02</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:05:22 UTC
    </footer>
</body>
</html>
