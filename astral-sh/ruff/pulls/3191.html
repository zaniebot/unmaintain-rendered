<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Run automatically format code blocks with Black - astral-sh/ruff #3191</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Run automatically format code blocks with Black</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/3191">#3191</a>
        opened by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a>
        on 2023-02-23 20:28
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JonathanPlasse">@JonathanPlasse</a></div>
            <div class="timeline-body"><p><a href="https://github.com/executablebooks/mdformat">mdformat</a> is Python Markdown formatter.
It catches some errors that <code>markdownlint</code> does not detect.</p>
<p>It will:</p>
<ul>
<li>Use 1. everywhere</li>
<li>Switch * to - bullet (it does not support <code>*</code> option, I could maintain a fork to support it if it is not acceptable)</li>
<li>Remove \n inside code expression (e.g. <code>code expression</code>)</li>
<li>Move footers at the end of files</li>
<li>Escape characters like <code>except*</code> with <code>except\*</code> as <code>*</code> would be considered like the start of an italic section.</li>
</ul>
<p>But most importantly is that it will run Black on code blocks.
Currently, a lot of code blocks are malformatted (e.g. bad indentation)</p>
<p>If a part of the code blocks should not be formatted the comments <code># fmt: off</code> and <code># fmt: on</code> can be used.
They will be removed during the documentation generation.</p>
<blockquote>
<p><strong>Warning</strong></p>
</blockquote>
<p>Ruff docs generation does not support code inside links. (e.g. <code>[`typing.Any`](â€¦)</code>)</p>
<pre><code class="language-rust">    /// ## References
    ///
    /// * [PEP 484](https://www.python.org/dev/peps/pep-0484/#the-any-type)
    /// * [`typing.Any`](https://docs.python.org/3/library/typing.html#typing.Any)
    /// * [Mypy: The Any type](https://mypy.readthedocs.io/en/stable/kinds_of_types.html#the-any-type)
</code></pre>
<p>It produces this code</p>
<pre><code class="language-markdown">## References

* [PEP 484](https://www.python.org/dev/peps/pep-0484/#the-any-type)
* [`typing.Any`][typing.Any](https://docs.python.org/3/library/typing.html#typing.Any)
* [Mypy: The Any type](https://mypy.readthedocs.io/en/stable/kinds_of_types.html#the-any-type)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-23 21:30</div>
            <div class="timeline-body"><p>This looks reasonable to me. I'm fine with using <code>-</code> instead of <code>*</code>.</p>
<blockquote>
<p>But most importantly is that it will run Black on code blocks. Currently, a lot of code blocks are malformatted (e.g. bad indentation).</p>
</blockquote>
<p>Where are these? Are they in the auto-generated sections that thus don't appear in the diff?</p>
<blockquote>
<p>Ruff docs generation does not support code inside links.</p>
</blockquote>
<p>This is intentional. We have to write them out like that, because MkDocs does not support code inside references. Are you saying that <code>mdformat</code> effects those? Or why is the warning called out?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-02-23 21:53</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>But most importantly is that it will run Black on code blocks. Currently, a lot of code blocks are malformatted (e.g. bad indentation).</p>
</blockquote>
<p>Where are these? Are they in the auto-generated sections that thus don't appear in the diff?</p>
</blockquote>
<p>I did not yet push the code block formatting.
This is why this pull request is currently a draft.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-02-23 21:56</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>Ruff docs generation does not support code inside links.</p>
</blockquote>
<p>This is intentional. We have to write them out like that, because MkDocs does not support code inside references. Are you saying that mdformat effects those? Or why is the warning called out?</p>
</blockquote>
<p>For the <code>mkdocs</code> links, <code>mdformat</code> affects those. It should not be blocking, a regex should fix it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-02-24 00:18</div>
            <div class="timeline-body"><p><code>mdformat</code> pass on the entire generated docs (excluding the links, but it does not affect this pull request, it would if <code>mdformat</code> was part of the docs generation process).
I removed the <code># fmt: off</code> as they were added to run <code>mdformat-black</code>.
A future pull request could add <code>mdformat</code> inside the docs generation process.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @JonathanPlasse on 2023-02-24 00:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_annotations/rules.rs</code>:20 on 2023-02-26 03:50</div>
            <div class="timeline-body"><p>Is there any way not to enforce these empty lines? I feel like they're not super helpful especially when we show users the Markdown directly. Maybe I'm wrong though?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-02-26 03:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on <code>crates/ruff/src/rules/flake8_annotations/rules.rs</code>:20 on 2023-02-26 15:10</div>
            <div class="timeline-body"><p>There is no option for this. <code>markdownlint,</code> <code>mdformat,</code> and <code>prettier</code>all add the empty lines.
An option would be to only format the code blocks content with black.
But thinking about it now it would make more sense to run ruff auto fix and formatter on it.
We would need a way to specify a ruff configuration for each code blocks.
It would signal to the developer when generating the docs that the code blocks were updated and thus incorrect.
For example, when we have the before and after examples.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> reviewed on 2023-02-26 15:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_annotations/rules.rs</code>:20 on 2023-02-26 16:47</div>
            <div class="timeline-body"><p>How exactly is this being run today? Like does <code>mdformat</code> get run over these Rust files, and it picks up the Markdown?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-02-26 16:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on <code>crates/ruff/src/rules/flake8_annotations/rules.rs</code>:20 on 2023-02-26 18:06</div>
            <div class="timeline-body"><p>No, I generated the files then ran mdformat on them, then edited the rust files until the generation produced valid markdown.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> reviewed on 2023-02-26 18:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-02-26 19:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_annotations/rules.rs</code>:20 on 2023-02-26 19:15</div>
            <div class="timeline-body"><p>I see, so would these not be enforced on an ongoing basis?</p>
<p>I'm partial to not applying the empty lines. <a href="https://github.com/rust-lang/rust-clippy/blob/3d193fa17a7df3256d58b841a2df92af1cbdbea4/declare_clippy_lint/src/lib.rs#L100">Clippy</a> doesn't do that, and I like to follow Clippy as a best practice.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on <code>crates/ruff/src/rules/flake8_annotations/rules.rs</code>:20 on 2023-02-26 19:38</div>
            <div class="timeline-body"><p>No, they would not be enforced.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> reviewed on 2023-02-26 19:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-02-26 23:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_annotations/rules.rs</code>:20 on 2023-02-26 23:42</div>
            <div class="timeline-body"><p>Can I back out the changes to add newlines everywhere, then merge this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> reviewed on 2023-02-27 08:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on <code>crates/ruff/src/rules/flake8_annotations/rules.rs</code>:20 on 2023-02-27 08:01</div>
            <div class="timeline-body"><p>I can do it if you want.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-02-27 08:58</div>
            <div class="timeline-body"><p>Rebased, revert the commit that added empty lines, and run Black on new rules.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-02-27 15:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-02-27 15:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-02-27 15:19</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:56:24 UTC
    </footer>
</body>
</html>
