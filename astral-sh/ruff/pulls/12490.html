<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ignore `NPY201` inside `except` blocks for compatibility with older numpy versions - astral-sh/ruff #12490</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Ignore <code>NPY201</code> inside <code>except</code> blocks for compatibility with older numpy versions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/12490">#12490</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-07-24 12:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes #12476.</p>
<p>This PR makes it so that deprecated imports and attribute accesses of numpy members are ignored in the following conditions:</p>
<ul>
<li>For attribute accesses (e.g. <code>np.ComplexWarning</code>), we only ignore the violation if it's inside an <code>except AttributeError</code> block, and the member is accessed through its non-deprecated name in the associated <code>try</code> block.</li>
<li>For uses of the <code>numpy</code> member where it's simply an <code>ExprName</code> node, we check to see how the <code>numpy</code> member was bound. If it was bound via a <code>from numpy import foo</code> statement, we check to see if that import statement took place inside an <code>except ImportError</code> or <code>except ModuleNotFoundError</code> block. If so, and if the <code>numpy</code> member was imported through its non-deprecated name in the associated try block, we ignore the violation in the same way.</li>
</ul>
<p>Examples:</p>
<pre><code class="language-py">import numpy as np

try:
    np.all([True, True])
except AttributError:
    np.alltrue([True, True])  # Okay

try:
    from numpy.exceptions import ComplexWarning
except ImportError:
    from numpy import ComplexWarning

x = ComplexWarning()  # Okay
</code></pre>
<p>This was more complex than I expected, since we currently track <em>handled</em> exceptions in the semantic model, but we don't track <em>suspended</em> exceptions. I.e., if we're in a lint rule and we're examining a node inside a <code>try</code> block, we know which exceptions the enclosing <code>StmtTry</code> node handles. But if we're in a lint rule and we're examining a node inside an <code>except</code> block, we don't have that information easily to hand.</p>
<h2>Test Plan</h2>
<p>Added some fixtures and snapshots.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @AlexWaygood on 2024-07-24 12:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-07-24 12:47</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/alex/numpy-depr">CodSpeed Performance Report</a></h2>
<h3>Merging #12490 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>alex/numpy-depr</code> (9c8c7d3) with <code>alex/numpy-depr</code> (bb14c21)</sub></p>
<h3>Summary</h3>
<p><code>✅ 33</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-07-24 12:55</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-24 13:32</div>
            <div class="timeline-body"><p>The lexer benchmark is drunk!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-24 13:34</div>
            <div class="timeline-body"><blockquote>
<p>The lexer benchmark is drunk!</p>
</blockquote>
<p>Hey, I'll take it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/numpy/rules/numpy_2_0_deprecation.rs</code>:761 on 2024-07-24 13:36</div>
            <div class="timeline-body"><p>Can we check <code>semantic.handled_exceptions</code> instead? Does that work? Then we wouldn't need to find the try statement or anything.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-07-24 13:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-24 13:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/numpy/rules/numpy_2_0_deprecation.rs</code>:761 on 2024-07-24 13:37</div>
            <div class="timeline-body"><p>No, <code>semantic.handled_exceptions</code> records the exceptions if we're visiting the <code>try</code> block of a <code>try</code>/<code>except</code> statement. But here we're visiting the <code>except</code> block of a <code>try</code>/<code>except</code> statement. Hence &quot;suspended_exceptions&quot; rather than &quot;handled_exceptions&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/numpy/rules/numpy_2_0_deprecation.rs</code>:902 on 2024-07-24 13:37</div>
            <div class="timeline-body"><p>I don't think it matters much because we only run this code in the error case, but it is kind of expensive. Do we have no way of resolving the statement in which a binding is declared and then traverse upwards (by using the parent API?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/numpy/rules/numpy_2_0_deprecation.rs</code>:940 on 2024-07-24 13:38</div>
            <div class="timeline-body"><p>Nit: Add an empty <code>visit_expression</code> to avoid traversing <strong>into</strong> expressions or implement <code>StatementVisitor</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-24 13:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/numpy/rules/numpy_2_0_deprecation.rs</code>:761 on 2024-07-24 13:39</div>
            <div class="timeline-body"><p>Also we still need to find the node for the <code>try</code> statement so that we can check whether it was accessed via the undeprecated call path in the <code>try</code> block</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/numpy/rules/numpy_2_0_deprecation.rs</code>:847 on 2024-07-24 13:42</div>
            <div class="timeline-body"><p>Nit: It could make sense to add a <code>visit_stmt</code> implementation that short-circuits visiting when <code>self.found_attribute</code> is true (or <code>visit_body</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-07-24 13:42</div>
            <div class="timeline-body"><p>Looks good. Maybe give @charliermarsh a grace period of a day to look at the semantic model changes ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-24 13:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/numpy/rules/numpy_2_0_deprecation.rs</code>:902 on 2024-07-24 13:47</div>
            <div class="timeline-body"><p>The situation is that we're visiting an <code>except</code> block in a <code>try</code>/<code>except</code> statement. We find a deprecated numpy access in that <code>except</code> block. We need to find out if there's an undeprecated access in the <code>try</code> block of the <code>try</code>/<code>except</code> statement. The way I do this is by traversing upwards from the node we're linting in the <code>except</code> block (using the parent API) to find the <code>StmtTry</code> node, then from the <code>StmtTry</code> node I then traverse downwards into the <code>try</code> block using the <code>ImportSearcher</code> to find if there are any imports using the undeprecated API.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-24 14:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/numpy/rules/numpy_2_0_deprecation.rs</code>:847 on 2024-07-24 14:07</div>
            <div class="timeline-body"><p>Thanks, I pushed that change! Wasn't quite sure what best practices were here, since there's a lot of <code>visit_*</code> methods on the <code>Visitor</code> trait that could potentially be overridden here to short-circuit. I guess most of the other ones generally delegate to <code>visit_expr</code> and <code>visit_stmt</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-24 15:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/numpy/rules/numpy_2_0_deprecation.rs</code>:847 on 2024-07-24 15:08</div>
            <div class="timeline-body"><p>Yeah. I think <code>visit_stmt</code> makes sense because it short circuits early.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-07-24 19:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:1846 on 2024-07-24 19:41</div>
            <div class="timeline-body"><p>Idly wondering if we should just store the semantic model flags on the binding, in theory it's tiny.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-07-24 19:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/numpy/rules/numpy_2_0_deprecation.rs</code>:806 on 2024-07-24 19:42</div>
            <div class="timeline-body"><p>Could you instead add a method <code>statements</code> to the semantic model that's identical to the <code>pub fn expressions(&amp;self, node_id: NodeId) -&gt; impl Iterator&lt;Item = &amp;'a Expr&gt; + '_</code> variant? Or is this doing something else?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-24 19:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:1846 on 2024-07-24 19:43</div>
            <div class="timeline-body"><p>As in, get rid of the separate <code>BindingFlags</code> struct altogether, and store the semantic-model flags on <code>Binding</code> instead? Or store the semantic-model flags in addition to the <code>BindingFlags</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-07-24 19:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/numpy/rules/numpy_2_0_deprecation.rs</code>:835 on 2024-07-24 19:43</div>
            <div class="timeline-body"><p>I think you can just call <code>visit_body</code>, or is this an optimization?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-07-24 19:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-07-24 19:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/numpy/rules/numpy_2_0_deprecation.rs</code>:835 on 2024-07-24 19:45</div>
            <div class="timeline-body"><p>Oh sorry I see there was some discussion here that got resolved, feel free to ignore.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-07-24 19:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:1846 on 2024-07-24 19:45</div>
            <div class="timeline-body"><p>Store them in addition (and then remove this flag from <code>BindingFlags</code>). But, it's ok, no need to change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-24 19:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/numpy/rules/numpy_2_0_deprecation.rs</code>:835 on 2024-07-24 19:46</div>
            <div class="timeline-body"><p>naw this is a good point</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-24 19:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/numpy/rules/numpy_2_0_deprecation.rs</code>:806 on 2024-07-24 19:58</div>
            <div class="timeline-body"><p>Ahh, nice idea</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2024-07-24 20:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-07-24 20:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-07-24 20:03</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:05:29 UTC
    </footer>
</body>
</html>
