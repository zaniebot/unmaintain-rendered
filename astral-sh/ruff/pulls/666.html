<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Handle multiple unused submodule imports - astral-sh/ruff #666</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Handle multiple unused submodule imports</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/666">#666</a>
        opened by <a href="https://github.com/squiddy">@squiddy</a>
        on 2022-11-10 06:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/squiddy">@squiddy</a></div>
            <div class="timeline-body"><p>I've got the tests and the right behaviour in place, but the code is not pretty right now.</p>
<ul>
<li>[x] Cleanup code</li>
</ul>
<hr />
<p>This resolves the issue where ruff doesn't see any unused imports in code like this:</p>
<pre><code>import multiprocessing.pool
import multiprocessing.process
z = multiprocessing.pool.ThreadPool()</code></pre>
<p>The underlying issue was twofold:</p>
<ol>
<li><p>When tracking submodule imports, we used the first part of the module (multiprocessing in this example) as the key in the bindings map. Therefore both submodule imports would end up as one entry, with no way to differentiate between them.</p>
</li>
<li><p>When tracking references to imports, we only looked at Name expressions. A compound (attribute) expression such as multiprocessing.process resulted in two attempts to mark names/imports used:</p>
<p>One for multiprocessing and one for process. Marking multiprocessing used together with the issue in 1) meant that all imports of multiprocessing were marked as used.</p>
</li>
</ol>
<p>The solution:</p>
<ol>
<li><p>For submodule imports, use the full name as key in the bindings map.</p>
</li>
<li><p>Detect Attribute access (such as foo.bar.baz, but not foo.bar[&quot;baz&quot;]) and use that to check if it matches an import. If the visitor is not in such an Attribute in the tree right now, keep looking at Name expressions.</p>
<p>With an attribute access like <code>multiprocessing.pool.ThreadPool</code>, iterate through all parts of it and try to look them up in bindings. This is necessary because certain modules can have different access patterns, e.g.</p>
<pre><code>import os
os.path.exists(&quot;foo&quot;)</code></pre>
</li>
</ol>
<p>instead of</p>
<pre><code>   import os.path
   os.path.exists(&quot;foo&quot;)</code></pre>
<p>Closes #60</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-11 00:39</div>
            <div class="timeline-body"><p>Awesome! Will review this soon!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-11 22:08</div>
            <div class="timeline-body"><p>@squiddy - Re-reading the summary -- do you want a code review on this, or did you wanna do any cleanup first?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/squiddy">@squiddy</a> on 2022-11-12 05:34</div>
            <div class="timeline-body"><p>I should have specified that more. I'd really appreciate a code review on the approach itself, the cleanup part is primary about the changes to <code>handle_node_load</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-12 17:15</div>
            <div class="timeline-body"><p>You got it :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2022-11-12 17:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-13 15:54</div>
            <div class="timeline-body"><p>(Overall, what you've written in the summary makes sense. Haven't read the code yet.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/check_ast.rs</code>:1965 on 2022-11-13 16:16</div>
            <div class="timeline-body"><p>I think we can avoid cloning any expressions here like:</p>
<pre><code class="language-rust">let ids: Vec&lt;(String, &amp;Expr)&gt; = match &amp;expr.node {
    ExprKind::Name { id, .. } =&gt; vec![(id.clone(), expr)],
    ExprKind::Attribute { value, .. } =&gt; {
        let path = compose_call_path(expr).unwrap();
        let segments: Vec&lt;&amp;str&gt; = path.split('.').collect();
        if segments.len() &gt; 1 {
            (1..segments.len())
                .rev()
                .map(|i| (segments[..i].join(&quot;.&quot;), &amp;**value))
                .collect()
        } else {
            vec![(segments.first().unwrap().to_string(), value)]
        }
    }
    _ =&gt; return,
};
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/check_ast.rs</code>:2395 on 2022-11-13 16:17</div>
            <div class="timeline-body"><p>Is this safe? What assumptions is it making? (That there's at least one member in <code>ids</code>, and at least one member in <code>self.scope_stack</code>?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/check_ast.rs</code>:1970 on 2022-11-13 16:22</div>
            <div class="timeline-body"><p>I think this <em>always</em> has to be true, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/check_ast.rs</code>:1966 on 2022-11-13 16:24</div>
            <div class="timeline-body"><p>I'd love to get rid of the ID clones... trying to figure out if that's possible.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/check_ast.rs</code>:1966 on 2022-11-13 16:35</div>
            <div class="timeline-body"><p>I think this gets it down to one copy:</p>
<pre><code class="language-rust">let call_path;
let ids: Vec&lt;(&amp;str, &amp;Expr)&gt; = match &amp;expr.node {
    ExprKind::Name { id, .. } =&gt; vec![(id, expr)],
    ExprKind::Attribute { value, .. } =&gt; {
        call_path = compose_call_path(expr).unwrap();
        call_path
            .rmatch_indices('.')
            .map(|(i, _)| (&amp;call_path[..i], &amp;**value))
            .collect()
    }
    _ =&gt; return,
};
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/check_ast.rs</code>:1971 on 2022-11-13 16:36</div>
            <div class="timeline-body"><p>What about this case? This seems like it should be valid but is currently unhandled.</p>
<pre><code class="language-py">import a.b.c.d

foo = a.b.c.d
</code></pre>
<p>Ruff gives me:</p>
<pre><code class="language-py">Found 2 error(s).
foo.py:1:1: F401 `a.b.c.d` imported but unused
foo.py:9:7: F821 Undefined name `a`
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-11-13 16:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-20 22:05</div>
            <div class="timeline-body"><p>@squiddy - Would you like me to clean up based on the comments and get this merged? Totally up to you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/squiddy">@squiddy</a> on 2022-11-21 05:53</div>
            <div class="timeline-body"><blockquote>
<p>@squiddy - Would you like me to clean up based on the comments and get this merged? Totally up to you.</p>
</blockquote>
<p>I've give it a try, thanks for the review.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/squiddy">@squiddy</a> reviewed on 2022-11-26 07:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/squiddy">@squiddy</a> on <code>src/check_ast.rs</code>:1965 on 2022-11-26 07:48</div>
            <div class="timeline-body"><p>Thank you. Closing in favor of https://github.com/charliermarsh/ruff/pull/666#discussion_r1020931419, where you tidied this up even more.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/squiddy">@squiddy</a> reviewed on 2022-11-26 07:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/squiddy">@squiddy</a> on <code>src/check_ast.rs</code>:1966 on 2022-11-26 07:49</div>
            <div class="timeline-body"><p>This is great, thank you. Applied it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/squiddy">@squiddy</a> on <code>src/check_ast.rs</code>:1971 on 2022-11-26 08:10</div>
            <div class="timeline-body"><p><code>ids</code> didn't include the full identifier (only <code>a.b.c</code> in this case). Extended it to and your test case passes now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/squiddy">@squiddy</a> reviewed on 2022-11-26 08:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/squiddy">@squiddy</a> reviewed on 2022-11-26 08:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/squiddy">@squiddy</a> on <code>src/check_ast.rs</code>:1970 on 2022-11-26 08:12</div>
            <div class="timeline-body"><p>Yes, you are right. Resolving this because the current code doesn't care anymore.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/squiddy">@squiddy</a> on <code>src/check_ast.rs</code>:2395 on 2022-11-26 08:37</div>
            <div class="timeline-body"><p>Yes to both.</p>
<p>At least one member in <code>ids</code> should be safe to assume. We're either called with a <code>Name</code> or <code>Attribute</code>, return otherwise.
You are right about the <code>scope_stack</code>. If that can be empty, we would crash here. I'm not too familiar with that yet, can this be empty?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/squiddy">@squiddy</a> reviewed on 2022-11-26 08:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/squiddy">@squiddy</a> reviewed on 2022-11-26 08:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/squiddy">@squiddy</a> on <code>src/check_ast.rs</code>:2395 on 2022-11-26 08:39</div>
            <div class="timeline-body"><p>I could initialize <code>not_found</code> with the first entry of <code>ids</code>, which is then either the name or the full expression for an attribute (e.g. <code>multiprocessing.pool.Pool</code>).</p>
<p>If we find a match in the imports, we return early.</p>
<p>If we don't, we'll report the whole expression/identifier as unknown.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/squiddy">@squiddy</a> reviewed on 2022-11-26 08:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/squiddy">@squiddy</a> on <code>src/check_ast.rs</code>:2395 on 2022-11-26 08:45</div>
            <div class="timeline-body"><p>Okay, removed the unwrap and instead pick the first entry from <code>ids</code>. If that is empty, we return.</p>
<p>Please let me know what you think.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-26 21:28</div>
            <div class="timeline-body"><p>Cool, gonna profile this tonight to make sure it's not a significant regression, then we can merge.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-27 04:53</div>
            <div class="timeline-body"><p>Introduces a small slowdown so wanna see if I can optimize this a bit, then will merge.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/squiddy">@squiddy</a> on 2022-12-09 10:40</div>
            <div class="timeline-body"><p>@charliermarsh I know you're very busy - good evidence to the success of ruff - so I'm not being pushy here.</p>
<p>Can I help you here move this forward? If it's the slowdown that is blocking this, how would I go about that measuring that? Is it just hyperfine + running ruff on the cmdline, or did you do some in-depth profiling?</p>
<p>I'm happy for anything you can share that helps me help you. :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-09 21:29</div>
            <div class="timeline-body"><p>Thanks for this really kind and understanding message (and not pushy at all). I've been a bad maintainer on this one, asking you to make changes and then failing to follow-up, so I apologize.</p>
<p>I did try to get this across the finish line once or twice but was struggling to eke out any more performance gains and felt mixed about introducing a performance penalty. But the blocker now is that I need to do a fairly substantial rebase due to https://github.com/charliermarsh/ruff/pull/1147 and https://github.com/charliermarsh/ruff/pull/1137. If you're up for trying to handle that, it'd be appreciated. But otherwise, I'll continue to try to get to this when I can.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/squiddy">@squiddy</a> on 2022-12-10 04:09</div>
            <div class="timeline-body"><p>I'm doing the rebase now and see what else I can do.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/squiddy">@squiddy</a> reviewed on 2022-12-10 04:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/squiddy">@squiddy</a> on <code>src/pyflakes/mod.rs</code>:2248 on 2022-12-10 04:25</div>
            <div class="timeline-body"><p>Unsure about this test. Why not report twice?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-12-10 04:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/pyflakes/mod.rs</code>:2248 on 2022-12-10 04:28</div>
            <div class="timeline-body"><p>Yeah reporting twice is better, I think.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-12-10 04:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/pyflakes/mod.rs</code>:2248 on 2022-12-10 04:28</div>
            <div class="timeline-body"><p>(These are literally the Pyflakes tests ported to Rust, so if we change behavior (as we're doing in this PR), we'll likely need to tweak the expectations of the tests.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/squiddy">@squiddy</a> on 2022-12-10 07:29</div>
            <div class="timeline-body"><p>Currently experimenting with putting this attribute specific logic after the &quot;simple&quot; name-based lookup, under the assumption that <code>Name</code> are way more common generally than just inside <code>Attribute</code>, e.g. in function calls or variable lookups.</p>
<p>Benchmarks against CPython look promising, but I need to fix one more test. :crossed_fingers:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/squiddy">@squiddy</a> on 2022-12-26 07:18</div>
            <div class="timeline-body"><p>Closing for now. I haven't made any good progress, might look into that again at some later point.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @squiddy on 2022-12-26 07:18</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:54:51 UTC
    </footer>
</body>
</html>
