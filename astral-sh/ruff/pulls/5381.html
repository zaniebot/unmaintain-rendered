<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Port Pyright's import resolver to Rust - astral-sh/ruff #5381</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Port Pyright's import resolver to Rust</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5381">#5381</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-06-27 04:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR contains the first step towards enabling robust first-party, third-party, and standard library import resolution in Ruff (including support for <code>typeshed</code>, stub files, native modules, etc.) by porting Pyright's import resolver to Rust.</p>
<p>The strategy taken here was to start with a more-or-less direct port of the Pyright's TypeScript resolver. The code is intentionally similar, and the test suite is effectively a superset of Pyright's test suite for its own resolver. Due to the nature of the port, the code is very, very non-idiomatic for Rust. The code is also entirely unused outside of the test suite, and no effort has been made to integrate it with the rest of the codebase.</p>
<p>Future work will include:</p>
<ul>
<li>Refactoring the code (now that it works) to match Rust and Ruff idioms.</li>
<li>Further testing, in practice, to ensure that the resolver can resolve imports in a complex project, when provided with a virtual environment path.</li>
<li>Caching, to minimize filesystem lookups and redundant resolutions.</li>
<li>Integration into Ruff itself (use Ruff's existing settings, find rules that can make use of robust resolution, etc.)</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @charliermarsh on 2023-06-27 04:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2023-06-27 04:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-27 04:19</div>
            <div class="timeline-body"><p>Candidly, I don't know that it's worth doing a close review of the code in its current state. I want to check this in, since it closely mirrors the source implementation -- but I plan to refactor large parts of it, and I suspect the reviews on those refactors will be more informative, accessible, and worthwhile.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-27 04:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_resolver/src/config.rs</code>:7 on 2023-06-27 04:20</div>
            <div class="timeline-body"><p>We won't need all of these, I don't think.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Boshen">@Boshen</a> on 2023-06-27 04:36</div>
            <div class="timeline-body"><p>I worked on the Rust version of the node.js resolver. An abstraction you want to add early is the concept of &quot;normalized&quot; or &quot;canonicalized&quot; path, you won't be able to distinguish these to the path read from the import statements very soon ...</p>
<p>Another pedantic thing is to use <code>Box&lt;Path&gt;</code> instead of <code>PathBuf</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-06-27 04:45</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>✅ ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01      7.9±0.05ms     5.2 MB/sec    1.00      7.8±0.02ms     5.2 MB/sec
formatter/numpy/ctypeslib.py               1.00   1697.7±2.55µs     9.8 MB/sec    1.00   1693.1±2.47µs     9.8 MB/sec
formatter/numpy/globals.py                 1.00    191.1±0.30µs    15.4 MB/sec    1.01    192.3±1.45µs    15.3 MB/sec
formatter/pydantic/types.py                1.00      3.7±0.01ms     6.8 MB/sec    1.00      3.7±0.01ms     6.9 MB/sec
linter/all-rules/large/dataset.py          1.01     13.3±0.11ms     3.1 MB/sec    1.00     13.2±0.08ms     3.1 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.3±0.01ms     5.0 MB/sec    1.01      3.3±0.01ms     5.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    425.5±1.31µs     6.9 MB/sec    1.01    430.2±0.77µs     6.9 MB/sec
linter/all-rules/pydantic/types.py         1.01      5.9±0.06ms     4.3 MB/sec    1.00      5.8±0.03ms     4.4 MB/sec
linter/default-rules/large/dataset.py      1.00      6.6±0.02ms     6.1 MB/sec    1.00      6.6±0.03ms     6.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1461.1±1.88µs    11.4 MB/sec    1.01   1478.9±1.85µs    11.3 MB/sec
linter/default-rules/numpy/globals.py      1.00    165.7±1.61µs    17.8 MB/sec    1.01    167.5±0.22µs    17.6 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.0±0.01ms     8.4 MB/sec    1.01      3.0±0.01ms     8.4 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      9.3±0.08ms     4.4 MB/sec    1.01      9.4±0.13ms     4.3 MB/sec
formatter/numpy/ctypeslib.py               1.00  1908.3±16.01µs     8.7 MB/sec    1.01  1920.9±16.43µs     8.7 MB/sec
formatter/numpy/globals.py                 1.00    209.4±1.85µs    14.1 MB/sec    1.00    210.0±3.77µs    14.1 MB/sec
formatter/pydantic/types.py                1.00      4.4±0.03ms     5.8 MB/sec    1.01      4.4±0.06ms     5.8 MB/sec
linter/all-rules/large/dataset.py          1.00     15.4±0.14ms     2.6 MB/sec    1.00     15.5±0.15ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      4.1±0.06ms     4.0 MB/sec    1.00      4.1±0.02ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.00    426.8±5.92µs     6.9 MB/sec    1.02    433.2±6.35µs     6.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.9±0.09ms     3.7 MB/sec    1.00      6.9±0.07ms     3.7 MB/sec
linter/default-rules/large/dataset.py      1.00      8.1±0.06ms     5.1 MB/sec    1.02      8.2±0.07ms     5.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1670.0±14.27µs    10.0 MB/sec    1.03  1719.1±14.87µs     9.7 MB/sec
linter/default-rules/numpy/globals.py      1.00    179.9±1.42µs    16.4 MB/sec    1.02    184.0±2.21µs    16.0 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.6±0.04ms     7.0 MB/sec    1.02      3.7±0.04ms     6.8 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_resolver/Cargo.toml</code>:17 on 2023-06-27 07:45</div>
            <div class="timeline-body"><p>not specific to this PR, but i've been thinking about switching to tracing instead, which has the same logging macros but some extra goodies such as spans and tracing_subscriber. I haven't checked if that still works nicely with fern.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_resolver/src/host.rs</code>:42 on 2023-06-27 07:49</div>
            <div class="timeline-body"><p>this is also a todo</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_resolver/src/implicit_imports.rs</code>:14 on 2023-06-27 07:52</div>
            <div class="timeline-body"><p>What's an implicit import of a native module? https://stackoverflow.com/questions/48716943/what-is-python-implicit-relative-import says implicit imports have been removed in python 3. (I do see how type stubs can be described as an implicit import)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_resolver/src/implicit_imports.rs</code>:31 on 2023-06-27 07:53</div>
            <div class="timeline-body"><p>We also have to think about error handling when we start having dependencies on io, e.g. this would be weird if that was a permission error. Which is also a good opportunity to promote https://docs.rs/fs-err/latest/fs_err/, it made a big difference in maturin</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_resolver/src/implicit_imports.rs</code>:66 on 2023-06-27 07:57</div>
            <div class="timeline-body"><p>This could be <code>foo.so</code>, <code>foo.abi3.so</code> or <code>foo.cpython-38-x86_64-linux-gnu.so</code>, but i haven't seen <code>foo.py.so</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_resolver/src/import_result.rs</code>:46 on 2023-06-27 08:02</div>
            <div class="timeline-body"><p>are those the files we need to import before we import out actual target file?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_resolver/src/lib.rs</code>:17 on 2023-06-27 08:03</div>
            <div class="timeline-body"><p>on windows it's <code>Lib</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_resolver/src/search.rs</code>:29 on 2023-06-27 08:24</div>
            <div class="timeline-body"><p>shouldn't <code>python{major}.{minor}</code> (unix) or <code>Python</code> (iirc windows) we in between the two? i've never seen the version without it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_resolver/src/search.rs</code>:53 on 2023-06-27 08:26</div>
            <div class="timeline-body"><p>Strange they do it that way, if know the python version we can just compute the path</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_resolver/src/search.rs</code>:95 on 2023-06-27 08:28</div>
            <div class="timeline-body"><p>pth files are such a hack because the canonical way to handle them is to execute arbitrary code every time before any user code</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_resolver/src/search.rs</code>:144 on 2023-06-27 08:29</div>
            <div class="timeline-body"><p>here i'd also just check the current platform</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-06-27 08:31</div>
            <div class="timeline-body"><p>Read through it once, didn't flag any rust idioms</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-27 16:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_resolver/Cargo.toml</code>:17 on 2023-06-27 16:01</div>
            <div class="timeline-body"><p>I think they used tracing at Rome, @MichaReiser has mentioned this once before... No opinion from me! (I also don't feel strongly about fern or chrono or anything else.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-27 16:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_resolver/src/host.rs</code>:42 on 2023-06-27 16:01</div>
            <div class="timeline-body"><p>I think this is fine because it's just for testing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_resolver/src/import_result.rs</code>:46 on 2023-06-27 16:04</div>
            <div class="timeline-body"><p>These are all the files imported when &quot;importing&quot; the module. E.g., if you <code>import foo.bar</code>, it'll include the <code>__init__.py</code> file in <code>./foo</code>, and <code>./foo/bar.py</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-27 16:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-27 16:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_resolver/src/import_result.rs</code>:46 on 2023-06-27 16:04</div>
            <div class="timeline-body"><p>Will add some examples.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-27 16:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_resolver/src/implicit_imports.rs</code>:66 on 2023-06-27 16:04</div>
            <div class="timeline-body"><p>Good call.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-27 16:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_resolver/src/search.rs</code>:29 on 2023-06-27 16:06</div>
            <div class="timeline-body"><p>Can you check the structure on Windows for me?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-06-27 16:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-06-27 16:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-06-27 16:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-06-28 05:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_resolver/src/search.rs</code>:29 on 2023-06-28 05:22</div>
            <div class="timeline-body"><p>sorry windows actually uses <code>Lib/site-packages</code></p>
<p><img src="https://github.com/astral-sh/ruff/assets/6826232/eba30280-1aa2-40b1-a3bb-17dba7b9b75b" alt="image" /></p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:58:24 UTC
    </footer>
</body>
</html>
