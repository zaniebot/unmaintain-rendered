```yaml
number: 7946
title: Insert newline after nested function or class statements
type: pull_request
state: merged
author: konstin
labels:
  - formatter
assignees: []
merged: true
base: main
head: 10-13-Insert_newline_after_nested_function_or_class_statements
created_at: 2023-10-13T15:01:51Z
updated_at: 2023-10-18T09:52:05Z
url: https://github.com/astral-sh/ruff/pull/7946
synced_at: 2026-01-12T02:32:41Z
```

# Insert newline after nested function or class statements

---

_Pull request opened by @konstin on 2023-10-13 15:01_

**Summary** Insert a newline after nested function and class definitions, unless there is a trailing own line comment.

We need to e.g. format
```python
if platform.system() == "Linux":
    if sys.version > (3, 10):
        def f():
            print("old")
    else:
        def f():
            print("new")
    f()
```
as
```python
if platform.system() == "Linux":
    if sys.version > (3, 10):

        def f():
            print("old")

    else:

        def f():
            print("new")

    f()
```
even though `f()` is directly preceded by an if statement, not a function or class definition. See the comments and fixtures for trailing own line comment handling.

**Test Plan** I checked that the new content of `newlines.py` matches black's formatting.

---

_Comment by @konstin on 2023-10-13 15:02_

Current dependencies on/for this PR:
* main
  * **PR #7946** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7946" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #8011** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8011" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7946?utm_source=stack-comment).

---

_Converted to draft by @konstin on 2023-10-13 15:36_

---

_Comment by @konstin on 2023-10-13 15:42_

This is more complex than i expected, leaving it for now:
```python
def fakehttp():

    class FakeHTTPConnection:
        if mock_close:
            def close(self):
                pass
    FakeHTTPConnection.fakedata = fakedata
```
Here we must not insert an empty line after `close` because the class already does. I think we need to switch strategies to always check the last nested child for each but the last element in a suite.

---

_Marked ready for review by @konstin on 2023-10-17 13:27_

---

_Label `formatter` added by @konstin on 2023-10-17 13:28_

---

_Comment by @github-actions[bot] on 2023-10-17 13:37_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.



---

_Review requested from @charliermarsh by @MichaReiser on 2023-10-17 23:17_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/statement/suite.rs`:208 on 2023-10-17 23:23_

Is `any` here correct? Shouldn't we only test this for the last node:

```python
if True:
	if False:
		def double(s):
			...
	#trailing comment, if gets excluded by the `filter` and the `any` will be true.
```



---

_@MichaReiser reviewed on 2023-10-17 23:24_

Leaving to @charliermarsh for the final review as his more familiar with the empty line rules than I

---

_@charliermarsh reviewed on 2023-10-18 02:14_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/comments/placement.rs`:2236 on 2023-10-18 02:14_

What was the motivation for making this an associated function?

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/resources/test/fixtures/ruff/newlines.py`:256 on 2023-10-18 02:14_

Is there intentionally no newline at EOF?

---

_@charliermarsh reviewed on 2023-10-18 02:14_

---

_@charliermarsh reviewed on 2023-10-18 02:14_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/comments/placement.rs`:2236 on 2023-10-18 02:14_

(Not necessarily disagreeing, just looking to understand.)

---

_@charliermarsh reviewed on 2023-10-18 02:17_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/statement/suite.rs`:188 on 2023-10-18 02:17_

Nit: "a empty lines"

---

_@charliermarsh reviewed on 2023-10-18 02:18_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/statement/suite.rs`:190 on 2023-10-18 02:18_

Is this intentionally indented? Can we add the outer scope, like the function `def` or similar?

---

_@charliermarsh reviewed on 2023-10-18 02:22_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/statement/suite.rs`:208 on 2023-10-18 02:22_

I think `successors` will short circuit as soon as it sees a node with a trailing comment, so the `any` would be false.

---

_@charliermarsh approved on 2023-10-18 02:22_

---

_@charliermarsh reviewed on 2023-10-18 02:23_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/statement/suite.rs`:208 on 2023-10-18 02:23_

But I may be misunderstanding, it's a bit confusing.

---

_@konstin reviewed on 2023-10-18 09:28_

---

_Review comment by @konstin on `crates/ruff_python_formatter/resources/test/fixtures/ruff/newlines.py`:256 on 2023-10-18 09:28_

yep, clarified the comment, this is due to a bug that in the initial implementation where it would add empty lines at the end of the file

---

_@konstin reviewed on 2023-10-18 09:29_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/comments/placement.rs`:2236 on 2023-10-18 09:29_

I needed to share it outside of placement where it used to be private helper function and then it seemed natural that "what is the last child of this node" is a property of node

---

_@konstin reviewed on 2023-10-18 09:32_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/statement/suite.rs`:208 on 2023-10-18 09:32_

Tried to make the code clearer, it's a bit complex with the recursive logic unfortunately

---

_Merged by @konstin on 2023-10-18 09:45_

---

_Closed by @konstin on 2023-10-18 09:45_

---

_Branch deleted on 2023-10-18 09:45_

---
