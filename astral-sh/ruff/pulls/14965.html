<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Error out when an mdtest code block is unterminated - astral-sh/ruff #14965</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Error out when an mdtest code block is unterminated</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14965">#14965</a>
        opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a>
        on 2024-12-14 00:21
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Resolves #14934.</p>
<h2>Test Plan</h2>
<p>Added a unit test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @InSyncWithFoo on 2024-12-14 00:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @InSyncWithFoo on 2024-12-14 00:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @InSyncWithFoo on 2024-12-14 00:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @InSyncWithFoo on 2024-12-14 00:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Error out when a code block is unterminated" to "[red-knot] Error out when an mdtest code block is unterminated" by @carljm on 2024-12-14 00:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by @AlexWaygood on 2024-12-14 00:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2024-12-14 00:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-12-14 00:28</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/src/parser.rs</code>:339 on 2024-12-14 00:34</div>
            <div class="timeline-body"><p>This will always say &quot;at index 0&quot; no matter where in the file the unterminated code block starts, because of the way we use <code>Cursor</code> to advance through the source text; we are always matching this regex at the start of a string. (Checked this experimentally.)</p>
<p>I <em>think</em> (not tested) that <code>self.cursor.token_len()</code> will give you the offset into the original source text that we've consumed so far, and still let you easily provide this info in the error. If for some reason that doesn't work, I'm also OK with just not providing this data. In practice, I'm not sure how useful it is, because I <em>think</em> if any code block other than the last one is unterminated, you'll just get a situation where the contents between the unterminated code block and the next will get swallowed, and it'll end up reporting a later code block as unterminated, not the one you actually need to fix?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/src/parser.rs</code>:689 on 2024-12-14 00:37</div>
            <div class="timeline-body"><p>Maybe use an example where the code block doesn't start at position 0 in the source text (i.e. preface the source text with some prose or a header) so this test would have caught the issue with the index reporting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-12-14 00:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-12-14 00:37</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2024-12-14 02:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/red_knot_test/src/parser.rs</code>:339 on 2024-12-14 02:12</div>
            <div class="timeline-body"><p>I changed it so that it emits row indexes instead. I don't feel satisfied just yet, though; how about IDE-inspectable absolute paths with <code>:row:column</code> affix?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/src/parser.rs</code>:353 on 2024-12-14 05:19</div>
            <div class="timeline-body"><p>All errors are already output with the full path as a prefix, so as you have it this ends up rendering as:</p>
<pre><code>Error parsing `/Users/carlmeyer/projects/ruff/crates/red_knot_python_semantic/resources/mdtest/scopes/unbound.md`: Unterminated code block at: /Users/carlmeyer/projects/ruff/crates/red_knot_python_semantic/resources/mdtest/scopes/unbound.md:47:0
</code></pre>
<p>Which seems a bit redundant :)</p>
<pre><code class="language-suggestion">                &quot;Unterminated code block starting on line {row}&quot;,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-12-14 05:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/src/lib.rs</code>:34 on 2024-12-14 05:19</div>
            <div class="timeline-body"><p>Here's where we already show the path in every error.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-12-14 05:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/red_knot_test/src/lib.rs</code>:34 on 2024-12-14 05:44</div>
            <div class="timeline-body"><p>I was thinking of changing this upstream error message too, but that's probably too much. Reverted to &quot;row&quot; commit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2024-12-14 05:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-12-14 05:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/src/lib.rs</code>:34 on 2024-12-14 05:51</div>
            <div class="timeline-body"><p>Looks good, to keep this PR focused. Future PR to further improve error output here is welcome!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-12-14 05:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @carljm on 2024-12-14 05:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2024-12-14 05:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-12-14 06:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-12-14 15:50</div>
            <div class="timeline-body"><p>Thanks @InSyncWithFoo! :D</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:08:29 UTC
    </footer>
</body>
</html>
