<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>add diagnostic `Span` (couples `File` and `TextRange`) - astral-sh/ruff #16101</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>add diagnostic <code>Span</code> (couples <code>File</code> and <code>TextRange</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16101">#16101</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2025-02-11 18:02
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-02-11 18:02</div>
            <div class="timeline-body"><p>This essentially makes it impossible to construct a <code>Diagnostic</code>
that has a <code>TextRange</code> but no <code>File</code>.</p>
<p>This is meant to be a precursor to multi-span support.</p>
<p>(Note that I consider this more of a prototyping-change and not
necessarily what this is going to look like longer term.)</p>
<p>Reviewers can probably review this PR as one big diff instead of
commit-by-commit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @BurntSushi on 2025-02-11 18:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @BurntSushi on 2025-02-11 18:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @BurntSushi on 2025-02-11 18:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @BurntSushi on 2025-02-11 18:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-02-11 18:09</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @MichaReiser on 2025-02-11 18:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_project/src/metadata/options.rs</code>:385 on 2025-02-11 18:12</div>
            <div class="timeline-body"><p>Could we directly store the <code>Span</code> on <code>OptionDiagnostic</code> instead of constructing it here on the fly?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/diagnostic.rs</code>:805 on 2025-02-11 18:12</div>
            <div class="timeline-body"><p>Same: I'm sort of inclined to simply store the <code>Span</code> directly on the <code>Diagnostic</code> struct. But I guess this way is fine too</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-02-11 18:14</div>
            <div class="timeline-body"><p>Nice: The only thing that's unclear to me is whether we want to store <code>Span</code>s directly on the concrete <code>Diagnostic</code> types or if we want to construct the span ad-hoc in the <code>span</code> method. I think I'm fine with either.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-02-11 18:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/red_knot_project/src/metadata/options.rs</code>:385 on 2025-02-11 18:38</div>
            <div class="timeline-body"><p>This is done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-02-11 18:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/red_knot_python_semantic/src/types/diagnostic.rs</code>:805 on 2025-02-11 18:40</div>
            <div class="timeline-body"><p>This one is a little trickier because a <code>TypedDiagnostic</code> always has a <code>File</code> and a <code>Range</code>, where as a <code>Span</code> always has a <code>File</code> and an optional <code>Range</code>. So I'm going to leave this as-is for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-02-11 18:47</div>
            <div class="timeline-body"><p>Since <code>Span</code> is <code>Copy</code>, you could make the <code>range</code> and <code>file</code> methods take <code>self</code> rather than <code>&amp;self</code>, which would allow you to get rid of a few closures:</p>
<details>
<summary>Patch</summary>

<pre><code class="language-diff">diff --git a/crates/red_knot_project/src/lib.rs b/crates/red_knot_project/src/lib.rs
index 2126f36a8..bd3dfe60a 100644
--- a/crates/red_knot_project/src/lib.rs
+++ b/crates/red_knot_project/src/lib.rs
@@ -347,7 +347,7 @@ fn check_file_impl(db: &amp;dyn Db, file: File) -&gt; Vec&lt;Box&lt;dyn Diagnostic&gt;&gt; {
     diagnostics.sort_unstable_by_key(|diagnostic| {
         diagnostic
             .span()
-            .and_then(|span| span.range())
+            .and_then(Span::range)
             .unwrap_or_default()
             .start()
     });
diff --git a/crates/red_knot_test/src/diagnostic.rs b/crates/red_knot_test/src/diagnostic.rs
index 56ee51223..7cf258f11 100644
--- a/crates/red_knot_test/src/diagnostic.rs
+++ b/crates/red_knot_test/src/diagnostic.rs
@@ -2,7 +2,7 @@
 //!
 //! We don't assume that we will get the diagnostics in source order.
 
-use ruff_db::diagnostic::Diagnostic;
+use ruff_db::diagnostic::{Diagnostic, Span};
 use ruff_source_file::{LineIndex, OneIndexed};
 use std::ops::{Deref, Range};
 
@@ -27,7 +27,7 @@ where
             .map(|diagnostic| DiagnosticWithLine {
                 line_number: diagnostic
                     .span()
-                    .and_then(|span| span.range())
+                    .and_then(Span::range)
                     .map_or(OneIndexed::from_zero_indexed(0), |range| {
                         line_index.line_index(range.start())
                     }),
diff --git a/crates/red_knot_test/src/matcher.rs b/crates/red_knot_test/src/matcher.rs
index d350ec7c6..d90bcef03 100644
--- a/crates/red_knot_test/src/matcher.rs
+++ b/crates/red_knot_test/src/matcher.rs
@@ -4,7 +4,7 @@ use crate::assertion::{Assertion, ErrorAssertion, InlineFileAssertions};
 use crate::db::Db;
 use crate::diagnostic::SortedDiagnostics;
 use colored::Colorize;
-use ruff_db::diagnostic::{Diagnostic, DiagnosticAsStrError, DiagnosticId};
+use ruff_db::diagnostic::{Diagnostic, DiagnosticAsStrError, DiagnosticId, Span};
 use ruff_db::files::File;
 use ruff_db::source::{line_index, source_text, SourceText};
 use ruff_source_file::{LineIndex, OneIndexed};
@@ -258,7 +258,7 @@ impl Matcher {
     fn column&lt;T: Diagnostic&gt;(&amp;self, diagnostic: &amp;T) -&gt; OneIndexed {
         diagnostic
             .span()
-            .and_then(|span| span.range())
+            .and_then(Span::range)
             .map(|range| {
                 self.line_index
                     .source_location(range.start(), &amp;self.source)
diff --git a/crates/ruff_benchmark/benches/red_knot.rs b/crates/ruff_benchmark/benches/red_knot.rs
index 87366b04d..423446dde 100644
--- a/crates/ruff_benchmark/benches/red_knot.rs
+++ b/crates/ruff_benchmark/benches/red_knot.rs
@@ -11,7 +11,7 @@ use red_knot_project::{Db, ProjectDatabase, ProjectMetadata};
 use red_knot_python_semantic::PythonVersion;
 use ruff_benchmark::criterion::{criterion_group, criterion_main, BatchSize, Criterion};
 use ruff_benchmark::TestFile;
-use ruff_db::diagnostic::{Diagnostic, DiagnosticId, Severity};
+use ruff_db::diagnostic::{Diagnostic, DiagnosticId, Severity, Span};
 use ruff_db::files::{system_path_to_file, File};
 use ruff_db::source::source_text;
 use ruff_db::system::{MemoryFileSystem, SystemPath, SystemPathBuf, TestSystem};
@@ -231,11 +231,11 @@ fn assert_diagnostics(db: &amp;dyn Db, diagnostics: &amp;[Box&lt;dyn Diagnostic&gt;]) {
                 diagnostic.id(),
                 diagnostic
                     .span()
-                    .map(|span| span.file())
+                    .map(Span::file)
                     .map(|file| file.path(db).as_str()),
                 diagnostic
                     .span()
-                    .and_then(|span| span.range())
+                    .and_then(Span::range)
                     .map(Range::&lt;usize&gt;::from),
                 diagnostic.message(),
                 diagnostic.severity(),
diff --git a/crates/ruff_db/src/diagnostic.rs b/crates/ruff_db/src/diagnostic.rs
index 02c701267..5bcec79c5 100644
--- a/crates/ruff_db/src/diagnostic.rs
+++ b/crates/ruff_db/src/diagnostic.rs
@@ -196,7 +196,7 @@ pub struct Span {
 
 impl Span {
     /// Returns the `File` attached to this `Span`.
-    pub fn file(&amp;self) -&gt; File {
+    pub fn file(self) -&gt; File {
         self.file
     }
 
@@ -205,7 +205,7 @@ impl Span {
     /// When there is no range, it is convention to assume that this `Span`
     /// refers to the corresponding `File` as a whole. In some cases, consumers
     /// of this API may use the range `0..0` to represent this case.
-    pub fn range(&amp;self) -&gt; Option&lt;TextRange&gt; {
+    pub fn range(self) -&gt; Option&lt;TextRange&gt; {
         self.range
     }
</code></pre>
</diff>

<p>(No strong opinion on whether that's worth it, though)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-11 18:51</div>
            <div class="timeline-body"><p>It's unclear if <code>Span</code> can remain <code>Copy</code> if we integrate it into Ruff where we don't have a <code>Copy</code> identifier for a file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-02-11 19:41</div>
            <div class="timeline-body"><p>Yeah <code>Span</code> being <code>Copy</code> is interesting. I wasn't thinking too carefully about that yet, but I can see it being annoying if it can't be <code>Copy</code>. But I wouldn't be surprised if the refactor in Ruff to permit it was brutal.</p>
<p>I'm going to remove the <code>Copy</code> impl, but retain APIs <em>as if</em> it were <code>Copy</code> for now. (Which essentially means writing <code>span.clone()</code> in some cases.) If we really commit to non-<code>Copy</code>, then we'll want to use <code>&amp;Span</code> in more places, which is pretty annoying.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-11 19:44</div>
            <div class="timeline-body"><p>I could see us interning files in Ruff when we create the diagnostics, but yeah, it's somewhat unclear if that's hard. But definitely annoying if <code>Span</code> can't be <code>Copy</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @BurntSushi on 2025-02-11 19:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2025-02-11 19:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-11 19:55</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:57:53 UTC
    </footer>
</body>
</html>
