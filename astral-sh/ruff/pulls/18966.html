<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use `Rule` for `FileNoqaDirective`s - astral-sh/ruff #18966</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use <code>Rule</code> for <code>FileNoqaDirective</code>s</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18966">#18966</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-06-26 17:04
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a></div>
            <div class="timeline-body">Summary
<p>See <a href="https://github.com/astral-sh/ruff/pull/18946">astral-sh/ruff#18946</a>#discussion_r2168459251.</p>
Test Plan
<p>Existing tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-26 17:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-26 17:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-06-26 17:16</div>
            <div class="timeline-body">



<a href="https://codspeed.io/astral-sh/ruff/branches/brent%2Fdirective-rule?runnerMode=Instrumentation">CodSpeed Instrumentation Performance Report</a>
Merging #18966 will <strong>not alter performance</strong>
<p>Comparing <code>brent/directive-rule</code> (2bbc37e) with <code>brent/string-noqa-code</code> (4eab76b)</p>
Summary
<p><code>✅ 37</code> untouched benchmarks<br>
<code>⁉️ 1</code> dropped benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/brent%2Fdirective-rule?runnerMode=Instrumentation">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
Benchmarks breakdown
<p>|     | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ⁉️ | <code>ty_micro[many_attribute_assignments]</code> | 56.6 ms | N/A | N/A |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-26 17:17</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-26 17:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-26 17:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/checkers/noqa.rs</code>:54 on 2025-06-26 19:21</div>
            <div class="timeline-body"><p>Do we have a short-circuit path somewhere that skips iterating over all diagnostics if there are no <code>noqa</code> codes at all?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/checkers/noqa.rs</code>:63 on 2025-06-26 19:25</div>
            <div class="timeline-body"><p>Should we add (or use) a method <code>includes_code</code> that accepts a secondary code instead of the <code>rule</code>. That would allow us to defer the rule parsing up to the point where we&#x27;ve found a suppression comment (which should be the exception).</p>
<p>To avoid calling <code>Noqa::to_string</code>, we can add a method <code>Noqa::matches_code(code: &amp;str)</code> which can match the string without allocationg</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-26 19:27</div>
            <div class="timeline-body"><p>I&#x27;ve a small perf recommendation to reduce the number of <code>Rule::parse</code> call</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-26 19:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/noqa.rs</code>:63 on 2025-06-26 19:46</div>
            <div class="timeline-body"><p>Ah yeah, I already added <code>FileExemption::contains_secondary_code</code> but I can call it before this to bail out earlier without parsing the rule code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-26 19:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/noqa.rs</code>:54 on 2025-06-26 19:58</div>
            <div class="timeline-body"><p>I don&#x27;t think so, but that&#x27;s a good idea. I added</p>
<pre><code>    if file_noqa_directives.is_empty() &amp;&amp; noqa_directives.is_empty() {
        return Vec::new();
    }
</code></pre>
<p>to the top of this function, along with those two <code>is_empty</code> methods.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-06-26 20:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-26 21:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-26 21:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-26 21:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-27 06:24</div>
            <div class="timeline-body"><p>Hmm, I think I would have merged this into main or waited with merging to make it easier to review <a href="https://github.com/astral-sh/ruff/pull/18946">astral-sh/ruff#18946</a> It&#x27;s no big deal. It&#x27;s just a bit confusing and distracting because I now need to decide for each change if I already reviewed it or not.</p>
<p>The other advantage of merging to main is that it would give us better insight in how <a href="https://github.com/astral-sh/ruff/pull/18946">astral-sh/ruff#18946</a> changes performance. Now it&#x27;s all muddled up with this change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-27 12:45</div>
            <div class="timeline-body"><p>Oh, sorry about that! I wasn&#x27;t thinking about the review or checking the benchmarks again, but it sounds obvious in hindsight.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:15:58 UTC
    </footer>
</body>
</html>
