```yaml
number: 7569
title: Formatter and parser refactoring
type: pull_request
state: merged
author: konstin
labels:
  - internal
  - formatter
assignees: []
merged: true
base: main
head: _formatter-and-parser-refactorings
created_at: 2023-09-21T11:33:24Z
updated_at: 2023-09-26T13:29:45Z
url: https://github.com/astral-sh/ruff/pull/7569
synced_at: 2026-01-12T15:55:24Z
```

# Formatter and parser refactoring

---

_@konstin_

I got confused and refactored a bit, now the naming should be more consistent. This is the basis for the range formatting work.

Chages:
* `format_module` -> `format_module_source` (format a string)
* `format_node` -> `format_module_ast` (format a program parsed into an AST)
* Added `parse_ok_tokens` that takes `Token` instead of `Result<Token>`
* Call the source code `source` consistently
* Added a `tokens_and_ranges` helper
* `python_ast` -> `module` (because that's the type)



---

_Comment by @konstin on 2023-09-21 11:33_

Current dependencies on/for this PR:
* main
  * **PR #7569** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7569" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #7571** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7571" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7569?utm_source=stack-comment).

---

_Label `formatter` added by @konstin on 2023-09-21 11:36_

---

_Label `internal` added by @konstin on 2023-09-21 11:36_

---

_@MichaReiser reviewed on 2023-09-21 11:39_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/lib.rs`:135 on 2023-09-21 11:39_

The idea here was that you could pass any node eventually (e.g. a single statement)

---

_Comment by @github-actions[bot] on 2023-09-21 11:49_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.



---

_@konstin reviewed on 2023-09-26 08:06_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/lib.rs`:135 on 2023-09-26 08:06_

That makes sense for later, but right now e.g. the comments assume that you have the entire AST present anyway

---

_Marked ready for review by @konstin on 2023-09-26 08:07_

---

_Comment by @codspeed-hq[bot] on 2023-09-26 08:17_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/_formatter-and-parser-refactorings)

### Merging #7569 will **improve performances by 8.46%**

<sub>Comparing <code>_formatter-and-parser-refactorings</code> (dd8b124) with <code>main</code> (ab64301)</sub>



### Summary

`âš¡ 4` improvements
`âœ… 21` untouched benchmarks




### Benchmarks breakdown

|     | Benchmark | `main` | `_formatter-and-parser-refactorings` | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| âš¡ | `lexer[pydantic/types.py]` | 4.1 ms | 4 ms | +3.69% |
| âš¡ | `lexer[numpy/ctypeslib.py]` | 2 ms | 1.9 ms | +2.55% |
| âš¡ | `lexer[unicode/pypinyin.py]` | 620 Âµs | 592 Âµs | +4.74% |
| âš¡ | `lexer[large/dataset.py]` | 9.8 ms | 9 ms | +8.46% |


---

_@MichaReiser reviewed on 2023-09-26 11:03_

Would you mind summarizing your changes? It would make reviewing this PR easier.

---

_Comment by @konstin on 2023-09-26 12:10_

updated

---

_@MichaReiser approved on 2023-09-26 13:09_

---

_Merged by @konstin on 2023-09-26 13:29_

---

_Closed by @konstin on 2023-09-26 13:29_

---

_Branch deleted on 2023-09-26 13:29_

---
