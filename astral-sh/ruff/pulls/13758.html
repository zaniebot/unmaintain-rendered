<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red knot] Fix narrowing for 'â€¦ is not â€¦' type guards, add 'â€¦ is â€¦' type guards - astral-sh/ruff #13758</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red knot] Fix narrowing for &#x27;â€¦ is not â€¦&#x27; type guards, add &#x27;â€¦ is â€¦&#x27; type guards</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13758">#13758</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2024-10-15 08:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body">

Summary
<ul>
<li><p>Fix a bug with <code>â€¦ is not â€¦</code> type guards.</p>
<p>Previously, in an example like</p>
<pre><code>x = [1]
y = [1]

if x is not y:
    reveal_type(x)
</code></pre>
<p>we would infer a type of <code>list[int] &amp; ~list[int] == Never</code> for <code>x</code> inside the conditional (instead of <code>list[int]</code>), since we built a (negative) intersection with the type of the right hand side (<code>y</code>). However, as this example shows, this assumption can only be made for singleton types (types with a single inhabitant) such as <code>None</code>.</p>
</li>
<li><p>Add support for <code>â€¦ is â€¦</code> type guards.</p>
</li>
</ul>
<p>closes #13715</p>
Test Plan
<p>Moved existing <code>narrow_â€¦</code> tests to Markdown-based tests and added new ones (including a regression test for the bug described above). Note that will create some conflicts with <a href="https://github.com/astral-sh/ruff/pull/13719">astral-sh/ruff#13719</a>. I tried to establish the correct organizational structure as proposed in <a href="https://github.com/astral-sh/ruff/pull/13719#discussion_r1800188105">this comment</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-10-15 08:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-10-15 08:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-10-15 08:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-10-15 08:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-10-15 08:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals_is_not.md</code>:39 on 2024-10-15 08:44</div>
            <div class="timeline-body"><p>Ideally, this should be <code>list[int]</code>, but I guess that is being tracked elsewhere, so I didn&#x27;t add a TODO comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-10-15 08:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/match.md</code>:17 on 2024-10-15 08:45</div>
            <div class="timeline-body"><p>Copied over from <a href="https://github.com/astral-sh/ruff/pull/13719#discussion_r1800188105">this comment</a> by @carljm</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-10-15 08:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:498 on 2024-10-15 08:46</div>
            <div class="timeline-body"><p>I can try to do better here, but I&#x27;m not sure if it&#x27;s worth the time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-10-15 08:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:511 on 2024-10-15 08:48</div>
            <div class="timeline-body"><p>What rust-analyzer auto-inserted looks so logical, I just kept it :smile:. But seriously, I don&#x27;t know how to treat <code>Type::Todo</code> here. Returning <code>false</code> might be another sensible option.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-10-15 08:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1568 on 2024-10-15 08:49</div>
            <div class="timeline-body"><p>There might be a good reason why <code>None</code> was missing so far?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-10-15 08:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:511 on 2024-10-15 08:54</div>
            <div class="timeline-body"><p>The <code>Todo</code> type is semantically identical to <code>Unknown</code> except that it indicates that its inference is still missing (helps with debugging). We can add Todo to the <code>Type::Unknown</code> branch</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-10-15 08:56</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>âœ… ecosystem check detected no linter changes.</p>
Linter (preview)
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:498 on 2024-10-15 08:57</div>
            <div class="timeline-body"><p>We normalize unions containing a single type to just that type in:</p>
<p>https://github.com/astral-sh/ruff/blob/f1205177fd9a323c93be456ea3f193870780645b/crates/red_knot_python_semantic/src/types/builder.rs#L110-L116</p>
<p>I would have to look into e.g. <code>Never | None</code> and @AlexWaygood might know the answer but I would expect this to normalize to <code>Never</code> which I think is already happening here:</p>
<p>https://github.com/astral-sh/ruff/blob/f1205177fd9a323c93be456ea3f193870780645b/crates/red_knot_python_semantic/src/types/builder.rs#L77-L81</p>
<p>But we could add a test to prove it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:491 on 2024-10-15 08:58</div>
            <div class="timeline-body"><p>I&#x27;m not sure if tuples are singletons but my Python knowledge isn&#x27;t strong enough to link you to any resource</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1568 on 2024-10-15 09:01</div>
            <div class="timeline-body"><p>We plan to remove <code>Type::None</code> but I don&#x27;t think this is relevant to the test code changes here</p>
<p>https://github.com/astral-sh/ruff/issues/13670</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-10-15 09:02</div>
            <div class="timeline-body"><p>LGTM, but let&#x27;s wait for at least one review from @AlexWaygood or @carljm to verify that it has the correct semantics</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:498 on 2024-10-15 09:06</div>
            <div class="timeline-body"><blockquote>
<p>We normalize unions containing a single type to just that type in:</p>
</blockquote>
<p>I saw that, but wasn&#x27;t sure if there was a guarantee/invariant on the <code>Type</code> enum that would enforce this?</p>
<blockquote>
<p>I would have to look into e.g. <code>Never | None</code> and @AlexWaygood might know the answer but I would expect this to normalize to <code>Never</code></p>
</blockquote>
<p>I think it should normalize to <code>None</code>? I&#x27;ll check and add a test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-10-15 09:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-10-15 09:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:498 on 2024-10-15 09:08</div>
            <div class="timeline-body"><p>Yeah, reading through <code>is_subtype</code> I think <code>None</code> is correct.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-10-15 09:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:491 on 2024-10-15 09:10</div>
            <div class="timeline-body"><blockquote>
<p>I&#x27;m not sure if tuples are singletons</p>
</blockquote>
<p>My thinking is this: a tuple type is a singleton type if all of its elements are singleton types. There is one and only one inhabitant of the type <code>tuple[None, Literal[True]]</code>, for example.</p>
<p>Now that I think about it again, the same is true for the empty tuple. That <code>!tuple.elements(db).is_empty()</code> should be removed. There is exactly one inhabitant of the empty tuple type <code>tuple[]</code>, namely <code>()</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-15 09:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:498 on 2024-10-15 09:14</div>
            <div class="timeline-body"><blockquote>
<p>I think it should normalize to <code>None</code>? I&#x27;ll check and add a test.</p>
</blockquote>
<p>Yes. Every Python type represents a set of possible runtime values. The <code>None</code> type is a set of possible values with length 1 (the only possible runtime value that satisfies the type is the runtime object <code>None</code> itself). <code>Never</code>, meanwhile, is the bottom type, an empty type: it is a set of possible values with length 0.</p>
<p>The union of those two sets is exactly equal to the set that represents the <code>None</code> type; hence <code>None | Never</code> simplifies to <code>None</code> (and in fact, <code>T | Never</code> always simplifies to <code>T</code>, for any given type <code>T</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals_is.md</code>:23 on 2024-10-15 09:30</div>
            <div class="timeline-body"><p>Hah! The type narrowing is indeed safe here, but this is very unidiomatic Python code (you should never use <code>is</code> to compare with an <code>int</code> in Python, as it can have surprising effects). Could you possibly add a short comment to that effect?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:489 on 2024-10-15 10:13</div>
            <div class="timeline-body"><p>As I mentioned in our call just now, this unfortunately isn&#x27;t correct. Two tuples are not guaranteed to be the same object in terms of <em>identity</em> (which literally refers to the memory address of the underlying object) even if they compare equal, and even if all of their elements are in fact references to the exact same singletons:</p>
<pre><code>&gt;&gt;&gt; x = (False, True)
&gt;&gt;&gt; y = (False, True)
&gt;&gt;&gt; False is False
True
&gt;&gt;&gt; True is True
True
&gt;&gt;&gt; all(x_element is y_element for x_element, y_element in zip(x, y))
True
&gt;&gt;&gt; all(id(x_element) == id(y_element) for x_element, y_element in zip(x, y))
True
&gt;&gt;&gt; id(x)
4378553856
&gt;&gt;&gt; id(y)
4378331520
&gt;&gt;&gt; x is y
False
</code></pre>
<p>The one exception is the empty tuple, which <em>is</em> always the same object:</p>
<pre><code>&gt;&gt;&gt; x = ()
&gt;&gt;&gt; y = ()
&gt;&gt;&gt; id(x)
4386737520
&gt;&gt;&gt; id(y)
4386737520
&gt;&gt;&gt; x is y
True
</code></pre>
<p>...However... I <em>thought</em> this was guaranteed by the language reference... but now that I check, it appears the language reference <a href="https://docs.python.org/3/reference/expressions.html#parenthesized-forms">says the opposite</a>:</p>
<blockquote>
<p>An empty pair of parentheses yields an empty tuple object. Since tuples are immutable, the same rules as for literals apply (i.e., two occurrences of the empty tuple may or may not yield the same object).</p>
</blockquote>
<p>So I&#x27;m not sure exactly what we should do here. The empty tuple is commonly used as a sentinel value, so I highly doubt that Python will realistically ever change it so that it is no longer a singleton; the backwards-compatibility implications would be too great, even if this is not guaranteed by the language spec. Perhaps the best course of action would be to treat it as a singleton in our model, but link to the that section of the language spec and say that this isn&#x27;t strictly guaranteed by the language.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:478 on 2024-10-15 10:15</div>
            <div class="timeline-body"><p>This is fine for now, but note that some <code>Instance</code> types can also be singletons:</p>
<ul>
<li>Instances of <code>types.EllipsisType</code> (there is only one, <code>...</code>)</li>
<li>Instances of <code>types.NotImplementedType</code> (there is only one, <code>NotImplemented</code>)</li>
</ul>
<p>We could implement this using the <code>KnownClass</code> enum -- we could add an <code>is_singleton</code> method to that enum. This could be done as as followup PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals_is_not.md</code>:29 on 2024-10-15 10:16</div>
            <div class="timeline-body"><p>You could possibly expand on this comment a little here to explain why the runtime semantics are the way they are</p>
<pre><code>Non-singleton types should *not* narrow the type:
two instances of a non-singleton class may occupy different addresses in memory
even if they compare equal.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals_is.md</code>:6 on 2024-10-15 10:20</div>
            <div class="timeline-body"><p>I&#x27;m a little nervous that these tests will break once we add more type checking (<code>flag</code> is not defined here). I know it&#x27;s a bit more boilerplate, but would you be able to do something like this in the tests?</p>
<pre><code>def returns_bool() -&gt; bool:
    return True

x = None if returns_bool() else 1
</code></pre>
<p>I <em>would</em> suggest simply doing <code>x = None if bool() else 1</code>, but unfortunately I think that will also be prone to future breakage. I believe we (accurately) infer <code>bool()</code> as returning <code>Literal[False]</code> rather than a random instance of <code>bool</code>, so in the future we&#x27;ll probably be able to statically determine that one of the two branches is always taken, which would mean we wouldn&#x27;t infer a union type anymore. But the same thing doesn&#x27;t apply for an arbitrary function like <code>returns_bool()</code>, where we&#x27;ll just believe the return type and infer a random instance of <code>bool</code> rather than <code>Literal[True]</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> requested changes on 2024-10-15 10:23</div>
            <div class="timeline-body"><p>Thanks! This mostly looks good, but there&#x27;s an important correctness thing we need to fix involving tuples. I also left a couple of minor nitpick comments as well :-)</p>
<p>As well as the <a href="https://docs.python.org/3/reference/index.html">language reference</a>, Brett Cannon&#x27;s <a href="https://snarky.ca/tag/syntactic-sugar/">blog series unravelling syntactic sugar</a> is also an invaluable resource for understanding what these operators are doing under the hood. His article unravelling <code>is</code> and <code>is not</code> is one of the shorter ones, but it&#x27;s here: https://snarky.ca/unravelling-is-and-is-not/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-15 10:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1568 on 2024-10-15 10:25</div>
            <div class="timeline-body"><p>Yeah, this is fine</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-15 10:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals_is_not.md</code>:39 on 2024-10-15 10:31</div>
            <div class="timeline-body"><p>Hmm... I guess I would weakly prefer adding a short <code>TODO: generics</code> comment here, so that it&#x27;s obvious to readers of the test that we are not asserting this type because we believe that it is the best type we can possibly infer here, just because it&#x27;s the best we can do right now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-15 10:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:491 on 2024-10-15 10:35</div>
            <div class="timeline-body"><p>See my comment at <a href="https://github.com/astral-sh/ruff/pull/13758">astral-sh/ruff#13758</a>#discussion_r1800865188.</p>
<blockquote>
<p>There is exactly one inhabitant of the empty tuple type <code>tuple[]</code></p>
</blockquote>
<p>nitpick: the type representing the empty tuple is spelled as <code>tuple[()]</code> :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-10-15 10:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals_is.md</code>:6 on 2024-10-15 10:51</div>
            <div class="timeline-body"><p>That&#x27;s actually something I noted down and wanted to ask. I just saw <code>flag</code> being used undeclared in other tests and copied that, but I also think it&#x27;s not great. I actually thought about doing something like <code>â€¦ if random.randint(0, 1) else â€¦</code>, but a better way would probably be to move all of this into a function, where the type checker can not assume anything about the value of the parameter:</p>
<pre><code>def f(x: Literal[1] | None):
    â€¦
</code></pre>
<hr>
<p>This seems like a common pattern in inference tests, so maybe we can come up with a better/shorter way to write them. I&#x27;m thinking something like</p>
<pre><code>x: Literal[1] | None = conjure()
</code></pre>
<p>where <code>conjure</code> would be a special function similar to Rusts <code>todo!()</code> â€” usually called <code>absurd</code> in type theory â€” of (hopefully not illegal) signature:</p>
<pre><code>def conjure[T]() -&gt; T:
    ???
</code></pre>
<p>that we would somehow inject into those test examples. Not sure if that makes sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-15 10:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals_is.md</code>:6 on 2024-10-15 10:58</div>
            <div class="timeline-body"><blockquote>
<p>a better way would probably be to move all of this into a function, where the type checker can not assume anything about the value of the parameter:</p>
</blockquote>
<p>Yes, this would definitely be my preference! Unfortunately we&#x27;re not yet in a place where we can do that (we need to implement #13693 first -- which shouldn&#x27;t be <em>too</em> tricky, we just haven&#x27;t got to it yet). We currently infer types from return annotations but not from parameter annotations.</p>
<blockquote>
<p>This seems like a common pattern in inference tests, so maybe we can come up with a better/shorter way to write them. I&#x27;m thinking something like</p>
<pre><code>x: Literal[1] | None = conjure()
</code></pre>
</blockquote>
<p>Hrm, maybe... there&#x27;s also advantages to keeping the test snippets as close to real-world Python as possible, though. The wonderful thing about having tests written in Markdown is that they double as living documentation of what our current inference capabilities are, and it&#x27;s great for other readers of our tests if that documentation is as clear as possible. I think implementing <a href="https://github.com/astral-sh/ruff/issues/13693">astral-sh/ruff#13693</a> and then using function parameters for tests after that is probably my preferred solution for now, but I&#x27;m definitely open to persuasion!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-10-15 11:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals_is.md</code>:6 on 2024-10-15 11:11</div>
            <div class="timeline-body"><blockquote>
<p>there&#x27;s also advantages to keeping the test snippets as close to real-world Python as possible, though</p>
</blockquote>
<p>True. But I would claim that those <code>x = None if flag else 1</code> lines are not ideal in terms of their self-documenting property either. Definitely took me a moment to understand what&#x27;s going on when I first saw them. And we have the problem with defining <code>flag</code>. What if we had something like the following pre-defined (never mind the actual implementation), possibly extended to a variadic function, is possible:</p>
<pre><code>def one_of[X, Y](x: X, y: Y) -&gt; X | Y:
    if random.randint(0, 1):
        return x
    else:
        return y
</code></pre>
<p>This could be used like</p>
<pre><code>x = one_of(1, None)

reveal_type(x)  # Literal[1] | None
</code></pre>
<p>(I understand that this might not yet be possible with the current state of red knot)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-15 11:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals_is.md</code>:6 on 2024-10-15 11:15</div>
            <div class="timeline-body"><p>I&#x27;m definitely open to it! Maybe you could create a followup issue on this for discussion? (I&#x27;d definitely want @carljm&#x27;s input as well, as the chief author of the test framework ðŸ˜„)</p>
<blockquote>
<p>(I understand that this might not yet be possible with the current state of red knot)</p>
</blockquote>
<p>yes, generic functions are definitely a little way off for now ðŸ˜„</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals_is.md</code>:23 on 2024-10-15 11:21</div>
            <div class="timeline-body"><p>Hm, I understand why you would never want to do <code>if y is 345</code>, but doing <code>if y is x</code> (do these two variables refer to the exact same object) should be a valid â€” if obscure â€” use case?</p>
<p>I changed it to a custom class now, to make sure that this is not about something int-specific.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-10-15 11:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-10-15 11:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:489 on 2024-10-15 11:22</div>
            <div class="timeline-body"><blockquote>
<p>Perhaps the best course of action would be to treat it as a singleton in our model, but link to the that section of the language spec and say that this isn&#x27;t strictly guaranteed by the language.</p>
</blockquote>
<p>I did that for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-15 11:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals_is.md</code>:23 on 2024-10-15 11:31</div>
            <div class="timeline-body"><p><em>Is</em> there a use case in Python for checking if two integer objects share the exact same address in memory (which is what the <code>is</code> operator does)? If you actually compare something to an integer <em>literal</em>, Python emits a <code>SyntaxWarning</code> to warn you that this is almost certainly not what you were trying to do, because you should nearly always treat one integer with value <code>42</code> the same as any other integer with value <code>42</code>:</p>
<pre><code>&gt;&gt;&gt; x = 42
&gt;&gt;&gt; x is 42
&lt;python-input-1&gt;:1: SyntaxWarning: &quot;is&quot; with &#x27;int&#x27; literal. Did you mean &quot;==&quot;?
  x is 42
True
</code></pre>
<p>The <code>is</code> and <code>is not</code> operators are honestly sort of odd. Python attempts to abstract away the details of memory management in most cases, and for most objects it tries to discourage you from relying on details such as whether one object occupies the exact same memory address as another. And yet, the <code>id()</code> function is a builtin, and <code>is</code> and <code>is not</code> are crucial if you&#x27;re using sentinel values such as <code>True</code>, <code>False</code>, <code>None</code> or <code>NotImplemented</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-10-15 11:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals_is.md</code>:23 on 2024-10-15 11:42</div>
            <div class="timeline-body"><blockquote>
<p><em>Is</em> there a use case in Python for checking if two integer objects share the exact same address in memory (which is what the <code>is</code> operator does)?</p>
</blockquote>
<p>I honestly don&#x27;t know. But I could imagine some generic code, maybe in a serialization or caching library, that uses <code>x is y</code> to actually check whether two objects are the exact same thing. And that generic code might be used with simple integer objects as well. Anyway, I changed it to a custom class now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-15 11:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:489 on 2024-10-15 11:52</div>
            <div class="timeline-body"><p>I&#x27;ve started a discussion on the Python Discourse forum about whether it&#x27;s time to change the language reference so that this is a guaranteed property of the language: https://discuss.python.org/t/should-we-specify-in-the-language-reference-that-the-empty-tuple-is-a-singleton/67957/1</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:498 on 2024-10-15 12:00</div>
            <div class="timeline-body"><p>I think I would probably shorten the comment here to something like</p>
<pre><code>                // A single-element union, where the sole element was a singleton,
                // would itself be a singleton type. However, unions with length &lt; 2
                // should never appear in our model due to [`UnionBuilder::build`]
                false
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-10-15 12:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:478 on 2024-10-15 12:01</div>
            <div class="timeline-body"><p>:+1:</p>
<p>Turns out to be a bit harder than I expected, so I&#x27;m postponing it to another PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:478 on 2024-10-15 12:02</div>
            <div class="timeline-body"><p>Could possibly add a short TODO comment here so we don&#x27;t forget about it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-10-15 12:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals_is.md</code>:6 on 2024-10-15 12:02</div>
            <div class="timeline-body"><blockquote>
<p>Maybe you could create a followup issue on this for discussion</p>
</blockquote>
<p>will do. I&#x27;m keeping the <code>flag</code> thing here for now, since it&#x27;s used in other tests as well; unless you want me to make the <code>returns_bool()</code> change above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/narrow.rs</code>:168 on 2024-10-15 12:06</div>
            <div class="timeline-body"><p>We could possibly explicitly handle the case of non-singleton <code>is not</code> narrowing here now, since we know we will never do anything here:</p>
<pre><code>                    }
                    // Non-singletons cannot be safely narrowed using `is not`
                    ast::CmpOp::IsNot =&gt; {}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-10-15 12:06</div>
            <div class="timeline-body"><p>A couple more nits, but this LGTM now overall. Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-15 12:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals_is.md</code>:23 on 2024-10-15 12:08</div>
            <div class="timeline-body"><blockquote>
<p>But I could imagine some generic code, maybe in a serialization or caching library, that uses <code>x is y</code> to actually check whether two objects are the exact same thing.</p>
</blockquote>
<p>Sounds like something I&#x27;d flag in a code review if I was helping maintain the library ;) anyway, using a custom class is definitely an improvement, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-10-15 12:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals_is.md</code>:23 on 2024-10-15 12:09</div>
            <div class="timeline-body"><p>Pytest doesn&#x27;t have this but JS testing frameworks often expose a <code>expect(a).toBeSame(b)</code> and the function would do a <code>is</code> comparison internally.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-15 12:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals_is.md</code>:23 on 2024-10-15 12:14</div>
            <div class="timeline-body"><p>Yes, <code>unittest</code> has similar helper methods: <code>assertIs</code>, <code>assertIsNot</code>, <code>assertIsNone</code> and <code>assertIsNotNone</code>. (Pytest doesn&#x27;t really need such helpers -- because of the AST rewriting it does before it runs the tests, just <code>assert x is y</code> will produce a beautiful traceback with lots of details if the test fails.) I&#x27;m not saying <code>is</code> comparisons are <em>useless</em>, just that <code>is</code> comparisons with immutable builtin types such as integers are almost always not really what you want to do, and that it&#x27;s slightly strange that this functionality is exposed so prominently as builtin functions and syntax.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-15 12:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals_is.md</code>:6 on 2024-10-15 12:16</div>
            <div class="timeline-body"><blockquote>
<p>I&#x27;m keeping the <code>flag</code> thing here for now, since it&#x27;s used in other tests as well; unless you want me to make the <code>returns_bool()</code> change above.</p>
</blockquote>
<p>yeah, find to keep it for now, we can change them all later</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:477 on 2024-10-15 12:21</div>
            <div class="timeline-body"><p>Oh! Modules are singletons (at least in our model). Each separate Python module is represented as a separate type in our model.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-15 12:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-15 12:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:477 on 2024-10-15 12:28</div>
            <div class="timeline-body"><p>(Obviously <code>types.ModuleType</code> is not a singleton -- there are multiple different Python modules out there in the wild. But <code>Type::Module(&lt;the typing module&gt;)</code> is a singleton, as is <code>Type::Module(&lt;the functools module&gt;)</code>.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-10-15 12:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-10-15 12:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-10-15 12:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-10-15 12:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:478 on 2024-10-15 13:26</div>
            <div class="timeline-body"><blockquote>
<p>Turns out to be a bit harder than I expected, so I&#x27;m postponing it to another PR.</p>
</blockquote>
<p>After trying to implement this, @AlexWaygood and me agreed to skip support for <code>EllipsisType</code>/<code>NotImplementedType</code> for now. The reason is that we can&#x27;t look up the symbol types from <code>types</code>, since they are conditionally added only if the Python version is &gt;=3.10: https://github.com/astral-sh/ruff/blob/74bf4b0653c0273af893fe81d31c126b45329ac6/crates/red_knot_vendored/vendor/typeshed/stdlib/types.pyi#L614-L620</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-10-15 13:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-15 20:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals_is_not.md</code>:39 on 2024-10-15 20:38</div>
            <div class="timeline-body"><p>Not important (definitely no need to change), but FWIW my preference would have been to just avoid using a generic type entirely here, and thus avoid the need for the TODO :) There are plenty of non-generic types (e.g. <code>int</code>) that would demonstrate precisely the same issue here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-15 20:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:495 on 2024-10-15 20:40</div>
            <div class="timeline-body"><p>I&#x27;m not sure we&#x27;ll want to stick with this conclusion, given the response to https://discuss.python.org/t/should-we-specify-in-the-language-reference-that-the-empty-tuple-is-a-singleton/67957/7 -- in particular the fact that <code>is</code> comparisons with tuples are now a syntax warning in recent Python versions, and that there are Python implementations (GraalPy) for which the empty tuple is not a singleton. But we can leave it for now, I don&#x27;t think it&#x27;s particularly critical either way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-15 20:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:495 on 2024-10-15 20:42</div>
            <div class="timeline-body"><p>yeah. Though strictly speaking the narrowing is still safe on all popular Python implementations, and probably always will be. But probably not worth carving out a special case for, given the language appears to be actively discouraging it now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-15 20:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:508 on 2024-10-15 20:43</div>
            <div class="timeline-body"><p>We should (but don&#x27;t yet) simplify this to just <code>Literal[True]</code> in intersection builder.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-15 20:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:509 on 2024-10-15 20:44</div>
            <div class="timeline-body"><p>This type also cannot occur in our representation, because we normalize to disjunctive normal form (union of intersections), so this would become <code>(None &amp; None) | (None &amp; int)</code> and then <code>None | (None &amp; int)</code> and then (this step not yet implemented) <code>None | Never</code> and thus just <code>None</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:510 on 2024-10-15 20:47</div>
            <div class="timeline-body"><p>We already always normalize this to <code>(A &amp; B) | (A &amp; C) | (B &amp; B) | (B &amp; C)</code> -&gt; <code>(A &amp; B) | (A &amp; C) | B | (B &amp; C)</code>, which should (though I&#x27;m not sure if it would yet?) become <code>(A &amp; C) | B</code>, which (if we know <code>A</code> and <code>C</code> are disjoint -- this part not yet implemented) should become just <code>B</code> -- so then would return <code>true</code> from this method :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-15 20:47</div>
            <div class="timeline-body"></div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:07:27 UTC
    </footer>
</body>
</html>
