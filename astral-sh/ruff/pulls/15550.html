<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Add support for `typing.ClassVar` - astral-sh/ruff #15550</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Add support for <code>typing.ClassVar</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15550">#15550</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-01-17 12:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-17 12:47</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Add support for <code>typing.ClassVar</code>, i.e. emit a diagnostic in this scenario:</p>
<pre><code class="language-py">from typing import ClassVar

class C:
    x: ClassVar[int] = 1

c = C()
c.x = 3  # error: &quot;Cannot assign to pure class variable `x` from an instance of type `C`&quot;
</code></pre>
<h2>Test Plan</h2>
<ul>
<li>New tests for the <code>typing.ClassVar</code> qualifier</li>
<li>Fixed one TODO in <code>attributes.md</code></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @sharkdp on 2025-01-17 12:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-17 13:20</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @sharkdp on 2025-01-17 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2025-01-17 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @sharkdp on 2025-01-17 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2025-01-17 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-17 14:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:174 on 2025-01-17 14:40</div>
            <div class="timeline-body"><p>We can't do this yet, but should be able to, as soon as we know what the type of <code>self</code> is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-17 14:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2528 on 2025-01-17 14:45</div>
            <div class="timeline-body"><p>This could also simply be called <code>.inner()</code>, <code>.inner_type()</code>, or similar?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1688 on 2025-01-17 16:43</div>
            <div class="timeline-body"><p>Nit: adding a method would help with readability here (I think it's the type but hard to tell)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-01-17 16:44</div>
            <div class="timeline-body"><p>Looks good to me from a salsa/rust perspective.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_qualifiers/classvar.md</code>:71 on 2025-01-17 18:24</div>
            <div class="timeline-body"><p>Or maybe</p>
<pre><code class="language-suggestion">    # error: [invalid-type-form] &quot;Type qualifier `typing.ClassVar` expects exactly one type parameter&quot;
</code></pre>
<p>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2499 on 2025-01-17 18:29</div>
            <div class="timeline-body"><p>strictly this method seems to be querying whether <code>ClassVar</code> is <em>one</em> of the qualifiers for the variable rather than whether it <em>is the sole</em> qualifier for the variable, so maybe this might be a better name?</p>
<pre><code class="language-suggestion">    pub(crate) fn includes_class_var(self) -&gt; bool {
</code></pre>
<p>I think it's actually invalid to combine <code>ClassVar</code> with any other type qualifiers currently (<code>ClassVar[Final[int]]</code> is not permitted). But this might change in the future, and we probably want to be able to recover gracefully and infer a good type even if the user does do something illegal with their qualifiers. So using a bitflag rather than an enum seems like a good option here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1688 on 2025-01-17 18:30</div>
            <div class="timeline-body"><p>agreed -- or it could just be a struct with named fields rather than a tuple struct?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:4862 on 2025-01-17 18:39</div>
            <div class="timeline-body"><p>Hmm, I think the original idea of having both the <code>infer_annotation_expression</code> methods and the <code>infer_type_expression</code> methods was that the <code>infer_annotation_expression()</code> methods would return <code>(Type, Qualifiers)</code> but the <code>infer_type_expression</code> methods would continue to just return <code>Type</code> (since qualifiers are valid in annotation expressions, but not type expressions, per <a href="https://typing.readthedocs.io/en/latest/spec/annotations.html#type-and-annotation-expressions">the grammar in the spec</a>). Because if we find a <code>ClassVar[T]</code> in a context where only a type expression is permitted, we should emit a diagnostic, and probably not record the entire variable as being a <code>ClassVar</code>. E.g. this is invalid, and the variable should probably not be recorded as a <code>ClassVar</code>. We can debate whether we should infer <code>Unknown</code>, <code>int | Unknown</code> or <code>int | str</code> for <code>Foo.x</code>:</p>
<pre><code class="language-py">class Foo:
    x: int | ClassVar[str]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:5419 on 2025-01-17 18:41</div>
            <div class="timeline-body"><p>Should we be passing in some context (maybe as part of <code>InferContext</code>?) that tells us whether we're in a class body here? That would allow us to emit a diagnostic here if a definition is annotated with <code>ClassVar</code> outside a class body, which is obviously illegal</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-17 18:41</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-17 18:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:5419 on 2025-01-17 18:46</div>
            <div class="timeline-body"><blockquote>
<p>that tells us whether we're in a class body here</p>
</blockquote>
<p>I felt like I would eventually have to add this anyway for instance attributes that are implicitly defined in methods only. This is why I left this as a TODO here (see test in <code>classvar.md</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-17 18:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2499 on 2025-01-17 18:58</div>
            <div class="timeline-body"><p>Hm.. for the sake of the argument, imagine that <code>ClassVar</code> and <code>Final</code> would be allowed, then I think it would still be okay, terminology wise, to say that a particular variable &quot;<em>is</em> a classvar and also <em>is</em> final&quot;?</p>
<p>I agree that &quot;includes&quot; makes more sense when thinking from the perspective of the set of type qualifiers (which is what this struct represents).</p>
<p>I have now moved this function to <code>SymbolAndQualifiers</code> which changes the code that uses it to:</p>
<pre><code class="language-rs">let instance_member = instance.class.instance_member(self.db(), attr);
if instance_member.is_class_var() {
    // emit diagnostic
}
</code></pre>
<p>What do you think?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-17 19:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2499 on 2025-01-17 19:00</div>
            <div class="timeline-body"><p>Ah, that reads much better if it's a method on <code>SymbolAndQualifiers</code>. This is resolved now in that case -- thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-17 22:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:4862 on 2025-01-17 22:10</div>
            <div class="timeline-body"><p>Thanks Alex. I implemented this now. It's more code, but definitely the cleaner approach. I think I didn't realize at first that <code>ClassVar</code> and <code>Final</code> can only appear at the &quot;outer layers&quot; of an annotation expression (unlike <code>Annotated</code>, but that is not a type qualifier). I thought I had to modify the existing matches on these KnownInstance types, but we actually need to handle them separately in <code>infer_annotation_expression_impl</code>. This introduces a bit of duplicated logic, but I'm afraid it's necessary. The match cases in infer_type_expression are all error cases that only emit diagnostics.</p>
<p>I also had a lot of fun with corpus panics, but it looks like I managed to store exactly one type per expression in the end.</p>
<p>I think I need to do another round of review myself (not today), and probably add some more tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-17 22:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_qualifiers/classvar.md</code>:25 on 2025-01-17 22:13</div>
            <div class="timeline-body"><p>@carljm I haven't tackled this TODO yet. I think it requires changes that are rather orthogonal to what I did here, but let me know if you think it should be solved in this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-17 22:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2538 on 2025-01-17 22:32</div>
            <div class="timeline-body"><p>Would it? I don't see <code>Final</code> in this example ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-17 22:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2538 on 2025-01-17 22:34</div>
            <div class="timeline-body"><p>Thanks. It was there before, but I removed it and forgot to update the qualifier expression.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:5298 on 2025-01-17 22:38</div>
            <div class="timeline-body"><p>This feels like it might fit in better as a free function in diagnostic.rs, similar to https://github.com/astral-sh/ruff/blob/98ef5641707cb55c9c4d91983406c6b81d83851c/crates/red_knot_python_semantic/src/types/diagnostic.rs#L1044</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-17 22:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:189 on 2025-01-17 23:38</div>
            <div class="timeline-body"><p>minor nit, but it would it be clearer to just say &quot;ClassVar&quot; rather than &quot;pure class variable&quot;? I think an explicit <code>ClassVar</code> annotation is the only way to create a &quot;pure class variable&quot;, so this seems to make the association more direct and explicit, and avoids introducing another vocabulary term (&quot;pure class variable&quot;) that we have to define.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_qualifiers/classvar.md</code>:25 on 2025-01-17 23:38</div>
            <div class="timeline-body"><p>No, not at all, totally fine to do it separately, as long as it's clearly marked as a TODO (as you've done)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_qualifiers/classvar.md</code>:44 on 2025-01-17 23:46</div>
            <div class="timeline-body"><p>Maybe this should be a diagnostic? But it isn't in <a href="https://pyright-play.net/?strict=true&amp;code=GYJw9gtgBALgngBwJYDsDmUkQWEMoDCANgIYDOZAaiSAFC0AmApsFCEzAK4gpkD6AIzBgiACgCUUALQA%2BKEJEAuKADo19AMakKhRbSgHMrdlx78FY8XsM2oAD2XFyVGgG1UMALr7DTImSZrWwMHTBQYTSgAXkIJTRU7aKgAJiA">pyright</a> (which has the same behavior you implemented here).</p>
<p>It is in <a href="https://mypy-play.net/?mypy=latest&amp;python=3.12&amp;gist=16cd32b442c26dd919e75d151313aff0">mypy</a>, but for different reasons than it would be for us, since mypy just generally prohibits re-declaration.</p>
<p>Not sure, don't feel clear enough about it to even suggest a TODO comment. We can always add this diagnostic if we decide we need it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:250 on 2025-01-17 23:53</div>
            <div class="timeline-body"><p>nit: is it valuable to maintain an invariant that a variable named <code>*_ty</code> contains a <code>Type</code>, and a function named <code>*_ty</code> returns a <code>Type</code>? If so, should we establish a suffix like <code>*_tyq</code> for a &quot;type and qualifiers&quot;? Or is this all too pedantic and veering unnecessarily into Hungarian notation? (I don't feel strongly.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2551 on 2025-01-18 00:33</div>
            <div class="timeline-body"><p>naming nit: we usually use <code>_ty</code> not <code>_type</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3418 on 2025-01-18 00:36</div>
            <div class="timeline-body"><p>We're already inside a match arm for <code>ctx</code> being <code>Store</code>, why do we need to match on <code>ctx</code> again?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-01-18 00:42</div>
            <div class="timeline-body"><p>This looks great!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-18 12:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:250 on 2025-01-18 12:29</div>
            <div class="timeline-body"><p>I'm afraid I broke this invariant before, and never cleaned it up. For example, <code>bindings_ty</code> returns a <code>Symbol</code>. Most call sites that call functions returning <code>Symbol</code>/<code>TypeAndQualifiers</code> are only interested in the contained type, but it's probably still better to clean up those names. I opened #15569 as a follow-up task for me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3418 on 2025-01-18 12:34</div>
            <div class="timeline-body"><p>Thanks for catching that. I previously had this code block in an entirely different place (where the match on <code>ctx</code> was necessary) and forgot to remove it when I moved it here.</p>
<p>With type narrowing, clippy could have been able to catch this :smile:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-18 12:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-18 12:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_qualifiers/classvar.md</code>:44 on 2025-01-18 12:42</div>
            <div class="timeline-body"><p>The &quot;currently&quot; was my way to try and describe that this is probably an open design decision. It feels to me like a not very common edge case, so in spirit of &quot;every lint rule generates maintenance work&quot;, I'll leave this as-is for now, but it should be straightforward to add a lint for this later if we want to.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2025-01-18 12:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-01-18 12:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-18 12:51</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 20:06:10 UTC
    </footer>
</body>
</html>
