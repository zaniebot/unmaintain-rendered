```yaml
number: 7327
title: "Update `F541` to use new f-string tokens"
type: pull_request
state: merged
author: dhruvmanila
labels:
  - rule
  - python312
assignees: []
merged: true
base: dhruv/pep-701
head: dhruv/issue-7292
created_at: 2023-09-13T04:41:55Z
updated_at: 2023-09-28T03:58:51Z
url: https://github.com/astral-sh/ruff/pull/7327
synced_at: 2026-01-12T15:55:23Z
```

# Update `F541` to use new f-string tokens

---

_@dhruvmanila_

## Summary

This PR updates the `F541` rule to use the new f-string tokens.

## Test Plan

Add new test case and uncomment a broken test case.

fixes: #7292


---

_Comment by @dhruvmanila on 2023-09-13 04:42_

Current dependencies on/for this PR:
* main
  * **PR #7376** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7376" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7690** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7690" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7667** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7667" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7597** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7597" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7588** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7588" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #7589** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7589" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7586** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7586" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7515** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7515" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7477** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7477" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7387** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7387" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7378** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7378" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7329** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7329" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7328** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7328" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7327** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7327" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #7326** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7326" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7325** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7325" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7327?utm_source=stack-comment).

---

_Label `python312` added by @dhruvmanila on 2023-09-13 05:12_

---

_Label `rule` added by @dhruvmanila on 2023-09-13 05:13_

---

_Marked ready for review by @dhruvmanila on 2023-09-14 03:34_

---

_Review requested from @charliermarsh by @dhruvmanila on 2023-09-14 03:34_

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/pyflakes/rules/f_string_missing_placeholders.rs`:67 on 2023-09-14 07:00_

Unrelated to your PR: Change expr to `ExprFString`?

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/pyflakes/rules/f_string_missing_placeholders.rs`:72 on 2023-09-14 07:01_

Nit: Just to make sure we never index from the start of the document

```suggestion
    let mut current_f_string_start = expr.start();
```

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/pyflakes/rules/f_string_missing_placeholders.rs`:82 on 2023-09-14 07:04_

How does this work with multiple nested fstrings? 

```python
f"{f"{a + f"{b}"}"}"
```

I would expect that `f"{b}"` overrides the start position of `f"{a + f"{b}"}"`

---

_@MichaReiser reviewed on 2023-09-14 07:04_

---

_@dhruvmanila reviewed on 2023-09-15 06:09_

---

_Review comment by @dhruvmanila on `crates/ruff/src/rules/pyflakes/rules/f_string_missing_placeholders.rs`:82 on 2023-09-15 06:09_

To give some context, the autofix for the rule `F541` is to remove the `f` prefix from the f-string _without_ any placeholders. The placeholder checks are done at an expression level by checking if there's any `FormattedValue`. The function you're referring to is to get the `f` prefix range and the f-string range. At this point there can't be any nested f-strings.

Also, the reason the function returns an iterator is because of implicitly concatenated strings.

---

_Review comment by @dhruvmanila on `crates/ruff/src/rules/pyflakes/rules/f_string_missing_placeholders.rs`:82 on 2023-09-15 06:12_

I think the function name is a bit confusing which I'll rename. I've also added docs to the function.

---

_@dhruvmanila reviewed on 2023-09-15 06:12_

---

_@MichaReiser reviewed on 2023-09-15 06:18_

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/pyflakes/rules/f_string_missing_placeholders.rs`:82 on 2023-09-15 06:18_

Hmm, but the documentation mentions that this function returns all nested f-string ranges, meaning there need to be placeholders? It's also unclear to me where the filtering out of f-strings without placeholders happens.

So I think we need to update the documentation to match its actual behavior (or it's too early in the morning and I shouldn't be reviewing PR's :sweat_smile: )

---

_@dhruvmanila reviewed on 2023-09-15 06:30_

---

_Review comment by @dhruvmanila on `crates/ruff/src/rules/pyflakes/rules/f_string_missing_placeholders.rs`:111 on 2023-09-15 06:30_

>  It's also unclear to me where the filtering out of f-strings without placeholders happens.

@MichaReiser 

---

_@dhruvmanila reviewed on 2023-09-15 06:30_

---

_Review comment by @dhruvmanila on `crates/ruff/src/rules/pyflakes/rules/f_string_missing_placeholders.rs`:82 on 2023-09-15 06:30_

> Hmm, but the documentation mentions that this function returns all nested f-string ranges, meaning there need to be placeholders?

I've updated the documentation but I'm curious as to where was "nested f-string ranges" mentioned? ðŸ˜… 

---

_@MichaReiser reviewed on 2023-09-15 07:03_

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/pyflakes/rules/f_string_missing_placeholders.rs`:111 on 2023-09-15 07:03_

Thanks. The issue I see is that `find_useless_f_strings` returns all fstrings but with potentially incorrect ranges. So naming that function `find_useless_f_strings` is misleading in my view because not all fstrings returned by that function are useless.

---

_@dhruvmanila reviewed on 2023-09-15 07:15_

---

_Review comment by @dhruvmanila on `crates/ruff/src/rules/pyflakes/rules/f_string_missing_placeholders.rs`:111 on 2023-09-15 07:15_

Yes, I totally agree. I've renamed it to `fstring_prefix_and_tok_range` but the main reason it returns an iterator is because the f-string can contain multiple implicitly concatenated (f-)strings.

> because not all fstrings returned by that function are useless.

Can you expand on this? For example, in the below code snippet it would return (prefix range, token range) for the "first" and the "last" string and not for the "normal" string. Both f-strings are useless in the sense that there are no placeholders used and so the `f` prefix is useless. I don't think it ever returns incorrect ranges.

```python
  f"first" "normal" rf"second"
# ^                  ^             (prefix range)
# ^^^^^^^^          ^^^^^^^^^^     (token range)

# (0..1, 0..8)      - `f"first"`
# (19..20, 18..28)  - `rf"second"`
```

---

_Review requested from @MichaReiser by @dhruvmanila on 2023-09-18 16:19_

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/pyflakes/rules/f_string_missing_placeholders.rs`:107 on 2023-09-18 16:24_

Nit: Values is now redundant, you can use `fstring.values` directly

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/pyflakes/rules/f_string_missing_placeholders.rs`:109 on 2023-09-18 16:25_

```suggestion
    if values.is_empty()
```

Because values can only be initialized with formatted values?

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/pyflakes/rules/f_string_missing_placeholders.rs`:50 on 2023-09-18 16:25_

```suggestion
/// Return an iterator containing a two-element tuple for each f-string part in the
```

---

_@MichaReiser approved on 2023-09-18 16:25_

---

_@dhruvmanila reviewed on 2023-09-18 16:30_

---

_Review comment by @dhruvmanila on `crates/ruff/src/rules/pyflakes/rules/f_string_missing_placeholders.rs`:109 on 2023-09-18 16:30_

No, it's initialized with both formatted values and string literals (other than the expression part). So, `f"foo"` will give:
```rust
String(
    ExprFString {
        range: 0..6,
        values: [
            Constant(
                ExprConstant {
                    range: 2..5,
                    value: Str(
                        StringConstant {
                            value: "foo",
                            unicode: false,
                            implicit_concatenated: false,
                        },
                    ),
                },
            ),
        ],
        implicit_concatenated: false,
    },
)
```

---

_Merged by @dhruvmanila on 2023-09-18 16:44_

---

_Closed by @dhruvmanila on 2023-09-18 16:44_

---

_Branch deleted on 2023-09-18 16:44_

---
