<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-implicit-str-concat`] Avoid invalid fix generated by autofix (`ISC003`) - astral-sh/ruff #21517</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-implicit-str-concat</code>] Avoid invalid fix generated by autofix (<code>ISC003</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21517">#21517</a>
        opened by <a href="https://github.com/prakhar1144">@prakhar1144</a>
        on 2025-11-18 21:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/prakhar1144">@prakhar1144</a> on 2025-11-18 21:57</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>As reported in #19757:
While attempting ISC003 autofix for an expression with explicit string concatenation, with either operand being a string literal that wraps across multiple lines (in parentheses) - it resulted in generating a fix which caused runtime error.</p>
<p>Example:</p>
<pre><code>_ = &quot;abc&quot; + (
    &quot;def&quot;
    &quot;ghi&quot;
)
</code></pre>
<p>was being auto-fixed to:</p>
<pre><code>_ = &quot;abc&quot; (
    &quot;def&quot;
    &quot;ghi&quot;
)
</code></pre>
<p>which raised <code>TypeError: 'str' object is not callable</code></p>
<p>This commit makes changes to just report diagnostic - no autofix in such cases.</p>
<p>Fixes #19757.</p>
<h2>Test Plan</h2>
<p>Added example scenarios in <code>crates/ruff_linter/resources/test/fixtures/flake8_implicit_str_concat/ISC.py</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/prakhar1144">@prakhar1144</a> on 2025-11-18 21:59</div>
            <div class="timeline-body"><p>As per suggestion in https://github.com/astral-sh/ruff/pull/19778#discussion_r2257641741:</p>
<blockquote>
<p>I think we can probably just use this helper function to check if left and right are parenthesized and avoid the fix if either of them is</p>
</blockquote>
<blockquote>
<p>We can also still report a diagnostic in this case, we just can't autofix it. Another option would be to try to move one of the expressions into the existing parentheses from the other expression, but that might be too involved. I'd be happy with just offering a diagnostic but no fix if one of them is parenthesized to avoid causing the runtime error.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-18 22:08</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @prakhar1144 on 2025-11-18 22:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/rules/flake8_implicit_str_concat/rules/explicit.rs</code>:100 on 2025-11-19 01:36</div>
            <div class="timeline-body"><p>Let's also make it clear that the existing autofix would result in broken code, and maybe include a link to the issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/rules/flake8_implicit_str_concat/rules/explicit.rs</code>:98 on 2025-11-19 01:41</div>
            <div class="timeline-body"><p>I think it's preferred to have this as a separate function that takes appropriate arguments rather than a block.</p>
<p>I think it would also be better to have a function that takes both left and right sides at the same time, and then the code below could be something like:</p>
<pre><code class="language-rust">if !is_either_side_parenthesized(left, right, ...) {
    diagnostic.set_fix(...);
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> requested changes on 2025-11-19 01:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @amyreese on 2025-11-19 01:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @amyreese on 2025-11-19 01:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @prakhar1144 on 2025-11-19 15:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/prakhar1144">@prakhar1144</a> reviewed on 2025-11-19 15:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/prakhar1144">@prakhar1144</a> on <code>crates/ruff_linter/src/rules/flake8_implicit_str_concat/rules/explicit.rs</code>:100 on 2025-11-19 15:32</div>
            <div class="timeline-body"><p>Extended the comment:</p>
<pre><code class="language-diff">diff --git a/crates/ruff_linter/src/rules/flake8_implicit_str_concat/rules/explicit.rs b/crates/ruff_linter/src/rules/flake8_implicit_str_concat/rules/explicit.rs
index 58f3db33bd..8edb7b46ad 100644
--- a/crates/ruff_linter/src/rules/flake8_implicit_str_concat/rules/explicit.rs
+++ b/crates/ruff_linter/src/rules/flake8_implicit_str_concat/rules/explicit.rs
@@ -98,6 +98,8 @@ pub(crate) fn explicit(checker: &amp;Checker, expr: &amp;Expr) {
                 };
                 // If either `left` or `right` is parenthesized, generating
                 // a fix would be too involved. Just report the diagnostic.
+                // Currently, attempting `generate_fix` would result in
+                // an invalid code. See: #19757
                 if is_parenthesized(left) || is_parenthesized(right) {
                     return;
                 }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/prakhar1144">@prakhar1144</a> reviewed on 2025-11-19 15:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/prakhar1144">@prakhar1144</a> on <code>crates/ruff_linter/src/rules/flake8_implicit_str_concat/rules/explicit.rs</code>:98 on 2025-11-19 15:44</div>
            <div class="timeline-body"><blockquote>
<p>I think it would also be better to have a function that takes both left and right sides at the same time</p>
</blockquote>
<p>That'd result in the new function body being:</p>
<pre><code class="language-rs">  is_left_parenthesized = parenthesized_range(
      left.into(),
      bin_op.into(),
      checker.comment_ranges(),
      checker.source(),
  )
  .is_some();
  
   is_right_parenthesized = parenthesized_range(
      right.into(),
      bin_op.into(),
      checker.comment_ranges(),
      checker.source(),
  )
  .is_some();
  
  is_left_parenthesized || is_right_parenthesized
</code></pre>
<p>which is a bit verbose... with repeated code ?</p>
<p>I had thought about a separate function while writing this, but preferred this approach because:</p>
<ul>
<li>It's only called twice in adjacent lines, localized scope, so closure felt natural</li>
<li>it doesn't have complex logic worth unit testing</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @prakhar1144 on 2025-11-19 16:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @amyreese by @prakhar1144 on 2025-11-19 16:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/prakhar1144">@prakhar1144</a> on 2025-11-19 16:03</div>
            <div class="timeline-body"><p>This is ready to review.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> approved on 2025-11-22 01:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[flake8-implicit-str-concat] Avoid invalid fix generated by autofix (ISC003)" to "[`flake8-implicit-str-concat`] Avoid invalid fix generated by autofix (`ISC003`)" by @amyreese on 2025-11-22 01:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @amyreese on 2025-11-22 01:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @amyreese on 2025-11-22 01:22</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:48:27 UTC
    </footer>
</body>
</html>
