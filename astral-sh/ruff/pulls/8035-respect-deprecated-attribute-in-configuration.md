```yaml
number: 8035
title: "Respect `#(deprecated)` attribute in configuration options"
type: pull_request
state: merged
author: MichaReiser
labels:
  - documentation
  - configuration
assignees: []
merged: true
base: main
head: options-deprecated
created_at: 2023-10-18T03:13:32Z
updated_at: 2023-10-20T04:54:41Z
url: https://github.com/astral-sh/ruff/pull/8035
synced_at: 2026-01-12T02:32:41Z
```

# Respect `#(deprecated)` attribute in configuration options

---

_Pull request opened by @MichaReiser on 2023-10-18 03:13_

## Summary

This PR extends the `OptionsMetadata` derive macro to respect the `deprecated` attribute. 

Adding the `deprecated` attribute to an option does:

* Mark the option as deprecated in the json schema (handled by schemars)
* Adds a `deprecated` message to the documentation 
* Shows a `(deprecated)` label when listing the configurations with `ruff config` 
* Shows the deprecation message when showing an option with `ruff config <name>`

`deprecated` is not yet supported for groups.

## Test Plan

```
 cargo run --bin ruff -q -- config extend-ignore
A list of rule codes or prefixes to ignore, in addition to those
specified by `ignore`.

Default value: []
Type: list[RuleSelector]
Deprecated: This option has been **deprecated** in favor of `ignore` since its usage is now interchangeable with `ignore`.
Example usage:
..
```

```
cargo run --bin ruff -q -- config 
cache-dir
extend
...
extend-ignore (deprecated)
```

<img width="1092" alt="Screenshot 2023-10-19 at 09 57 21" src="https://github.com/astral-sh/ruff/assets/1203881/bb86744c-42c1-4bf9-aa7d-27cdb571b9bd">




---

_Comment by @MichaReiser on 2023-10-18 03:13_

Current dependencies on/for this PR:
* main
  * **PR #8000** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8000" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #8002** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8002" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #8032** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8032" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #8006** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8006" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #8035** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8035" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
          * **PR #8010** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8010" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
            * **PR #8082** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8082" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
              * **PR #8088** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8088" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
            * **PR #8039** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8039" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #8031** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8031" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/8035?utm_source=stack-comment).

---

_Label `configuration` added by @MichaReiser on 2023-10-18 03:13_

---

_Label `documentation` added by @MichaReiser on 2023-10-18 03:44_

---

_@MichaReiser reviewed on 2023-10-18 03:45_

---

_Review comment by @MichaReiser on `crates/ruff_macros/src/config.rs`:217 on 2023-10-18 03:45_

The old logic relied on the specific order. The new logic allows arbitrary ordering and is in line with that serde and other crates use for parsing attribute fields.

---

_@MichaReiser reviewed on 2023-10-18 03:48_

---

_Review comment by @MichaReiser on `ruff.schema.json`:1698 on 2023-10-18 03:48_

We shouldn't remove deprecated options from the schema to avoid existing configurations failing the schema validation. 

---

_Renamed from "Respect `deprecated` attribute in configuration options" to "Respect `#(deprecated)` attribute in configuration options" by @MichaReiser on 2023-10-18 06:17_

---

_Marked ready for review by @MichaReiser on 2023-10-18 06:17_

---

_Review requested from @charliermarsh by @MichaReiser on 2023-10-18 06:17_

---

_Review requested from @zanieb by @MichaReiser on 2023-10-18 06:17_

---

_Review comment by @charliermarsh on `crates/ruff_dev/src/generate_options.rs`:123 on 2023-10-18 13:52_

Can we remove this or otherwise modify the deprecation message? Right now, it reads "This option is deprecated: This option has been deprecated ..."

---

_@charliermarsh approved on 2023-10-18 13:53_

When we rename an option, will we leave the deprecated variant and mark it as deprecated? I assume both will then show up in the documentation.

---

_Comment by @github-actions[bot] on 2023-10-19 00:05_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.



---

_Comment by @MichaReiser on 2023-10-19 00:05_

> When we rename an option, will we leave the deprecated variant and mark it as deprecated? I assume both will then show up in the documentation.

Yes, marking an option as deprecated has the result that both, the new and the deprecated, options show up in the documentation. We can customize the layout for deprecated options if we want. 

I considered alternatives for the special case of renaming options but they all require more tooling support which I'm not sure is worth building. What I want is that:

* Both the new and deprecated options are in the json schema. The deprecated option must be marked as deprecated in the schema. 
* Ideally: The deprecated name is listed next to the new configuration name. 

The challenge is that we need two fields to know if the user used the deprecated field (we could create a custom deserializer and emit the warning in the deserializer but it will be challenging to ever return this warning as a diagnostic in the future). Also, `schemars` needs two fields to have both show up in the schema. 

We could remove the `option` attribute from the deprecated option and add a `deprecated_alias` field to the `option` attribute. But it felt like too much complexity for the few deprecated options that we have today.

---

_@MichaReiser reviewed on 2023-10-19 00:33_

---

_Review comment by @MichaReiser on `crates/ruff_dev/src/generate_options.rs`:123 on 2023-10-19 00:33_

I updated the messaging of the deprecated note and the formatting in the documentation generation. I hope you like this better. 
<img width="1231" alt="Screenshot 2023-10-19 at 09 32 38" src="https://github.com/astral-sh/ruff/assets/1203881/e4234485-47a1-4066-851f-182e5a131f43">


---

_Merged by @MichaReiser on 2023-10-19 01:07_

---

_Closed by @MichaReiser on 2023-10-19 01:07_

---

_Branch deleted on 2023-10-19 01:07_

---

_Comment by @henryiii on 2023-10-19 21:31_

Curious to see how SchemaStore (and other validators, like fastjsonschema) handle this - might need to be added to the ignored keyword list in their internal validator (which is easy to do per schema). Technically, it was added in draft 2019, which pretty much nothing seems to officially support. But like other features, I don't think extra keywords are disallowed, and validators may start picking up on this (besides schemas, I know there's discussion on making jsonschema in Python support it).

(This is my favorite 2019 feature, though, and I'd love to see it added everywhere)

---

_Comment by @zanieb on 2023-10-19 22:09_

Thanks for the notes! We'll see at https://github.com/SchemaStore/schemastore/pull/3332

---

_Comment by @MichaReiser on 2023-10-19 23:05_

Interesting, I assumed that this is well supported, considering that 2020-12 is the [most recent json schema specification](https://json-schema.org/specification)

---

_Comment by @henryiii on 2023-10-19 23:08_

It would be nice if the description in JSONSchema would include the deprecation reason. I wasnâ€™t aware that `extend-ignore` was deprecated and the schema didnâ€™t say why.

---

_Comment by @henryiii on 2023-10-19 23:11_

Most tools seem to have frozen at draft 7. Fastjsonschema (used by validate-pyproject) requires 7. Even schemastore requires 7: https://github.com/SchemaStore/schemastore/blob/master/CONTRIBUTING.md#best-practices

---

_Comment by @MichaReiser on 2023-10-19 23:36_

> It would be nice if the description in JSONSchema would include the deprecation reason. I wasnâ€™t aware that `extend-ignore` was deprecated and the schema didnâ€™t say why.

Yeah. I haven't figured out a good (technical) solution to this yet which doesn't require us to re-implement schemar's derive macro other than copying the deprecation message into the description. It's a pity that the json schema `deprecated` field is a boolean and doesn't allow specifying a message

---
