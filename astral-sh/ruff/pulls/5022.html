<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suggest combining async with statements - astral-sh/ruff #5022</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Suggest combining async with statements</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5022">#5022</a>
        opened by <a href="https://github.com/Thomasdezeeuw">@Thomasdezeeuw</a>
        on 2023-06-12 10:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/Thomasdezeeuw">@Thomasdezeeuw</a> on 2023-06-12 10:34</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Previously the rule for SIM117 explicitly ignored <code>async with</code> statements as it would incorrectly suggestion to merge <code>async with</code> and regular <code>with</code> statements as reported in issue #1902.</p>
<p>This partially reverts the fix for that (commit     396be5edeac0c5724de87e93c5a885dacf201f05) by enabling the rules for <code>async with</code> statements again, but with a check ensuring that the statements are both of the same kind, i.e. both <code>async with</code> or both (just) <code>with</code> statements.</p>
<p>Closes #3025</p>
<h2>Test Plan</h2>
<p>Updated and existing test and added a new test case from #3025.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_with.rs</code>:63 on 2023-06-12 10:38</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// Returns a boolean indicating whether it's an async with statement, the items and
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_with.rs</code>:65 on 2023-06-12 10:45</div>
            <div class="timeline-body"><p>How would this deal with</p>
<pre><code class="language-python">with a as a2:
    async with b as b2:
        with c as c2:
            async with d as d2:
                f(a2, b2, c2, d2)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_with.rs</code>:101 on 2023-06-12 11:09</div>
            <div class="timeline-body"><p>Took me way too long to figure this out:</p>
<pre><code class="language-suggestion">            // Make sure with fix from top to bottom for nested with statements, e.g. for
            // ```python
            // with A():
            //     with B():
            //         with C():
            //             print(&quot;hello&quot;)
            // ```
            // suggest
            // ```python
            // with A(), B():
            //     with C():
            //         print(&quot;hello&quot;)
            // ```
            // but not the following
            // ```python
            // with A():
            //     with B(), C():
            //         print(&quot;hello&quot;)
            // ```
            return;
</code></pre>
<p>I'd place it outside the if let but github only allows me to place comments here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_with.rs</code>:71 on 2023-06-12 11:11</div>
            <div class="timeline-body"><p>What's the purpose of the recursion if we only fix one level in each ruff fix iteration?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-06-12 11:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Thomasdezeeuw">@Thomasdezeeuw</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_with.rs</code>:65 on 2023-06-12 11:30</div>
            <div class="timeline-body"><p>Currently it makes no suggestion.</p>
<p>We could probably suggest the following:</p>
<blockquote>
<pre><code class="language-python">with a as a2, c as c2:
    async with b as b2, d as d2:
        f(a2, b2, c2, d2)
</code></pre>
</blockquote>
<p>However, I'm not sure if that always produces equivalent code. If I read the docs correctly (https://docs.python.org/3/whatsnew/2.6.html#pep-343-the-with-statement) the syntax is <code>with expression</code>, where <code>expression</code> could fail in some way.</p>
<p>Consider</p>
<blockquote>
<pre><code class="language-python">with open('/etc/file1', 'r') as f1:
    async with open('/etc/file2', 'r') as f2:
        with open('/etc/file3', 'r') as f3:
            async with open('/etc/file3', 'r') as f4:
                f(f1, f2, f3, f4)
</code></pre>
</blockquote>
<p>I don't think we can rewrite that to</p>
<blockquote>
<pre><code class="language-python">with open('/etc/file1', 'r') as f1, open('/etc/file3', 'r') as f3:
    async with open('/etc/file2', 'r') as f2, open('/etc/file3', 'r') as f4:
        f(f1, f2, f3, f4)
</code></pre>
</blockquote>
<p>Because that changes the order in which the files are opened.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Thomasdezeeuw">@Thomasdezeeuw</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_with.rs</code>:71 on 2023-06-12 11:34</div>
            <div class="timeline-body"><p>I'm not exactly sure, I didn't want to change the existing code too much possibly breaking something in the process.</p>
<p>It does slightly improve the suggestion span (<code>-</code> is old code, <code>+</code> is without the recursive call):</p>
<pre><code>---- rules::flake8_simplify::tests::rules::rule_multiplewithstatements_path_new_sim117_py_expects stdout ----
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Snapshot Summary ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Snapshot file: crates/ruff/src/rules/flake8_simplify/snapshots/ruff__rules__flake8_simplify__tests__SIM117_SIM117.py.snap
Snapshot: SIM117_SIM117.py
Source: crates/ruff/src/rules/flake8_simplify/mod.rs:52
────────────────────────────────────────────────────────────────────────────────────────────────────────
-old snapshot
+new results
────────────┬───────────────────────────────────────────────────────────────────────────────────────────
   22    22 │    |
   23    23 │  6 |   # SIM117
   24    24 │  7 | / with A():
   25    25 │  8 | |     with B():
   26       │- 9 | |         with C():
   27       │-   | |_________________^ SIM117
         26 │+   | |_____________^ SIM117
         27 │+ 9 |           with C():
   28    28 │ 10 |               print(&quot;hello&quot;)
   29    29 │    |
   30    30 │    = help: Combine `with` statements
   31    31 │
────────────┴───────────────────────────────────────────────────────────────────────────────────────────

</code></pre>
<p>But perhaps we can resolve that without recursion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Thomasdezeeuw">@Thomasdezeeuw</a> reviewed on 2023-06-12 11:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-06-12 11:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_with.rs</code>:65 on 2023-06-12 11:51</div>
            <div class="timeline-body"><p>sorry, bad example. If i use</p>
<pre><code class="language-python">async with b as b2:
    with c as c2:
        async with d as d2:
            f(b2, c2, d2)
</code></pre>
<p>i get</p>
<pre><code>SIM117.py:112:1: SIM117 [*] Use a single `with` statement with multiple contexts instead of nested `with` statements
    |
110 |       return 0
111 |   
112 | / async with b as b2:
113 | |     with c as c2:
114 | |         async with d as d2:
    | |___________________________^ SIM117
115 |               f(b2, c2, d2)
    |
    = help: Combine `with` statements

ℹ Suggested fix
109 109 | 
110 110 |     return 0
111 111 | 
112     |-async with b as b2:
113     |-    with c as c2:
114     |-        async with d as d2:
115     |-            f(b2, c2, d2)
    112 |+async with b as b2, c as c2:
    113 |+    async with d as d2:
    114 |+        f(b2, c2, d2)

</code></pre>
<p>which is incorrect.</p>
<p>Could you add a test case for both the already working example and this example?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-12 12:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_with.rs</code>:65 on 2023-06-12 12:46</div>
            <div class="timeline-body"><p>Yeah if they're out-of-order (with, then async, then with, etc.), we shouldn't re-order the context managers IMO -- only consecutive sync or async managers.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_with.rs</code>:71 on 2023-06-12 12:46</div>
            <div class="timeline-body"><blockquote>
<p>What's the purpose of the recursion if we only fix one level in each ruff fix iteration?</p>
</blockquote>
<p>Is this true? I was under the impression that we did collapse multiple levels (haven't looked back at the code).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-12 12:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Thomasdezeeuw">@Thomasdezeeuw</a> reviewed on 2023-06-12 13:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Thomasdezeeuw">@Thomasdezeeuw</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_with.rs</code>:71 on 2023-06-12 13:56</div>
            <div class="timeline-body"><p>After following some red hearings I think I can say that we don't completely collapse multiple levels. This is the output of the current code (before this pr):</p>
<pre><code>SIM117.py:2:1: SIM117 [*] Use a single `with` statement with multiple contexts instead of nested `with` statements
  |
1 |   # SIM117
2 | / with A():
3 | |     with B():
4 | |         with C():
  | |_________________^ SIM117
5 |               print(&quot;hello&quot;)
  |
  = help: Combine `with` statements

ℹ Suggested fix
1 1 | # SIM117
2   |-with A():
3   |-    with B():
4   |-        with C():
5   |-            print(&quot;hello&quot;)
  2 |+with A(), B():
  3 |+    with C():
  4 |+        print(&quot;hello&quot;)
</code></pre>
<p>Note that the error indicator (first part) includes all three <code>with</code> statements, but the suggested fix only includes the first two <code>with</code> statement. Which is not ideal because when applied Ruff will complain the next run to also collapse <code>with C()</code>.</p>
<p>I could work on the fix suggestion to rewrite it to <code>with A(), B(), C()</code>, but that will have a larger scope than issue https://github.com/astral-sh/ruff/issues/3025 is aiming to fix, so perhaps we should do it in another pr.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Thomasdezeeuw">@Thomasdezeeuw</a> reviewed on 2023-06-12 14:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Thomasdezeeuw">@Thomasdezeeuw</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_with.rs</code>:65 on 2023-06-12 14:00</div>
            <div class="timeline-body"><p>I've resolved this in the last commit (169c0fffaacf4386bde36416d389187c744fc521), but that changed the range of text the error points to, see the change in the snapshot and https://github.com/astral-sh/ruff/pull/5022#discussion_r1226710316.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-12 14:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_with.rs</code>:71 on 2023-06-12 14:11</div>
            <div class="timeline-body"><p>Ahh ok, so we flag them all, but only fix one level... This is not <em>terrible</em> because Ruff runs iteratively until there are no more fixable errors, so from the user's perspective, it will appear as if these were fixed in one pass. But it does mean that the suggested fix is confusing as depicted above.</p>
<p>Let's fix it if possible, but in a separate PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-06-12 14:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-06-12 14:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-06-12 14:26</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.17      8.1±0.05ms     5.1 MB/sec    1.00      6.9±0.05ms     5.9 MB/sec
formatter/numpy/ctypeslib.py               1.14   1580.6±5.26µs    10.5 MB/sec    1.00   1391.4±2.39µs    12.0 MB/sec
formatter/numpy/globals.py                 1.10    151.4±0.44µs    19.5 MB/sec    1.00    137.9±0.98µs    21.4 MB/sec
formatter/pydantic/types.py                1.15      3.2±0.01ms     8.0 MB/sec    1.00      2.8±0.01ms     9.1 MB/sec
linter/all-rules/large/dataset.py          1.00     14.8±0.13ms     2.7 MB/sec    1.02     15.1±0.10ms     2.7 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.6±0.01ms     4.7 MB/sec    1.02      3.6±0.04ms     4.6 MB/sec
linter/all-rules/numpy/globals.py          1.00    368.4±1.19µs     8.0 MB/sec    1.01    371.5±0.99µs     7.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.3±0.05ms     4.1 MB/sec    1.03      6.5±0.07ms     3.9 MB/sec
linter/default-rules/large/dataset.py      1.00      7.5±0.04ms     5.4 MB/sec    1.01      7.6±0.04ms     5.4 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1552.0±3.10µs    10.7 MB/sec    1.01  1570.1±43.79µs    10.6 MB/sec
linter/default-rules/numpy/globals.py      1.00    166.2±1.19µs    17.7 MB/sec    1.00    166.4±0.30µs    17.7 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.3±0.01ms     7.6 MB/sec    1.00      3.3±0.01ms     7.6 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      9.7±0.21ms     4.2 MB/sec    1.00      9.7±0.23ms     4.2 MB/sec
formatter/numpy/ctypeslib.py               1.02      2.0±0.12ms     8.3 MB/sec    1.00  1952.6±52.38µs     8.5 MB/sec
formatter/numpy/globals.py                 1.00    188.6±7.78µs    15.6 MB/sec    1.00    187.8±8.38µs    15.7 MB/sec
formatter/pydantic/types.py                1.01      3.9±0.11ms     6.5 MB/sec    1.00      3.9±0.10ms     6.5 MB/sec
linter/all-rules/large/dataset.py          1.00     20.3±0.41ms     2.0 MB/sec    1.00     20.4±0.37ms  2044.0 KB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      5.1±0.15ms     3.2 MB/sec    1.01      5.2±0.12ms     3.2 MB/sec
linter/all-rules/numpy/globals.py          1.00   608.8±16.88µs     4.8 MB/sec    1.01   612.2±20.40µs     4.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      8.7±0.22ms     2.9 MB/sec    1.01      8.8±0.20ms     2.9 MB/sec
linter/default-rules/large/dataset.py      1.00     10.3±0.20ms     4.0 MB/sec    1.00     10.3±0.18ms     4.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00      2.2±0.06ms     7.7 MB/sec    1.00      2.2±0.05ms     7.7 MB/sec
linter/default-rules/numpy/globals.py      1.01   244.6±11.44µs    12.1 MB/sec    1.00    241.7±8.17µs    12.2 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.6±0.13ms     5.5 MB/sec    1.00      4.6±0.12ms     5.5 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @Thomasdezeeuw on 2023-06-12 14:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Thomasdezeeuw on 2023-06-12 14:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-06-12 14:33</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 03:44:08 UTC
    </footer>
</body>
</html>
