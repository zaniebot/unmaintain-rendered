<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`ruff server` - A new built-in LSP for Ruff, written in Rust - astral-sh/ruff #10158</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>ruff server</code> - A new built-in LSP for Ruff, written in Rust</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10158">#10158</a>
        opened by <a href="https://github.com/snowsignal">@snowsignal</a>
        on 2024-02-29 01:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a></div>
            <div class="timeline-body">

Summary
<p>This PR introduces the <code>ruff_server</code> crate and a new <code>ruff server</code> command. <code>ruff_server</code> is a re-implementation of <a href="https://github.com/astral-sh/ruff-lsp"><code>ruff-lsp</code></a>, written entirely in Rust. It brings significant performance improvements, much tighter integration with Ruff, a foundation for supporting entirely new language server features, and more!</p>
<p>This PR is an early version of <code>ruff_lsp</code> that we&#x27;re calling the <strong>pre-release</strong> version. Anyone is more than welcome to use it and submit bug reports for any issues they encounter - we&#x27;ll have some documentation on how to set it up with a few common editors, and we&#x27;ll also provide a pre-release VSCode extension for those interested.</p>
<p>This pre-release version supports:</p>
<ul>
<li><strong>Diagnostics for <code>.py</code> files</strong></li>
<li><strong>Quick fixes</strong></li>
<li><strong>Full-file formatting</strong></li>
<li><strong>Range formatting</strong></li>
<li><strong>Multiple workspace folders</strong></li>
<li>~~<strong>Automatic linter/formatter configuration</strong> - taken from any <code>pyproject.toml</code> files in the workspace.~~ (this will be implemented in a follow-up pull request)</li>
</ul>
<p>Many thanks to @MichaReiser for his <a href="https://github.com/astral-sh/ruff/pull/7262">proof-of-concept work</a>, which was important groundwork for making this PR possible.</p>
Architectural Decisions
<p>I&#x27;ve made an executive choice to go with <code>lsp-server</code> as a base framework for the LSP, in favor of <code>tower-lsp</code>. There were several reasons for this:</p>
<ol>
<li>I would like to avoid <code>async</code> in our implementation. LSPs are mostly computationally bound rather than I/O bound, and <code>async</code> adds a lot of complexity to the API, while also making harder to reason about execution order. This leads into the second reason, which is...</li>
<li>Any handlers that mutate state should be blocking and run in the event loop, and the state should be lock-free. This is the approach that <code>rust-analyzer</code> uses (also with the <code>lsp-server</code>/<code>lsp-types</code> crates as a framework), and it gives us assurances about data mutation and execution order. <code>tower-lsp</code> doesn&#x27;t support this, which has caused some <a href="https://github.com/ebkalderon/tower-lsp/issues/284">issues</a> around data races and out-of-order handler execution.</li>
<li>In general, I think it makes sense to have tight control over scheduling and the specifics of our implementation, in exchange for a slightly higher up-front cost of writing it ourselves. We&#x27;ll be able to fine-tune it to our needs and support future LSP features without depending on an upstream maintainer.</li>
</ol>
Test Plan
<p>The pre-release of <code>ruff_server</code> will have snapshot tests for common document editing scenarios. An expanded test suite is on the roadmap for future version of <code>ruff_server</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-03-01 05:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-03-01 05:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-03-01 05:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-03-01 17:13</div>
            <div class="timeline-body"><p>@snowsignal How would you recommend to review this PR? Which parts of the PR are in its final state?  Are there parts that you plan to iterate on in future PRs?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>Cargo.toml</code>:72 on 2024-03-01 17:20</div>
            <div class="timeline-body"><p>I was able to remove the <code>phf</code> and <code>libc</code> dependency from the <code>ruff_server</code> crate without getting any compile errors. Can you double check if they&#x27;re used?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>Cargo.toml</code>:59 on 2024-03-01 17:20</div>
            <div class="timeline-body"><p>Ohoh, now we go all lowlevel.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/args.rs</code>:500 on 2024-03-01 18:00</div>
            <div class="timeline-body"><p>I don&#x27;t have a strong opinion on the name. One advantage of using <code>lsp</code> over <code>server</code> is that we could add <code>ruff server start</code> and <code>ruff server stop</code>  commands in the future if we support a daemon. The LSP spec also has some recommendations about what arguments should be supported that we might not want to have on a generic <code>server</code> command. However, we could probably also do this by using <code>ruff server</code> with no sub-command to connect to the LSP directly`.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/edit/document.rs</code>:25 on 2024-03-01 18:02</div>
            <div class="timeline-body"><p>I&#x27;m okay with this. The only use case that exists today is to replace the content. So maybe rename the method to <code>replace</code> in which case re-computing the <code>LineIndex</code> from scratch seems like a good default.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/edit/document.rs</code>:45 on 2024-03-01 18:03</div>
            <div class="timeline-body"><p>I prefer not to group methods but I don&#x27;t others doing it. What I don&#x27;t understand is why <code>modify</code> isn&#x27;t part of the <code>Mutable</code> api.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/edit/document.rs</code>:65 on 2024-03-01 18:08</div>
            <div class="timeline-body"><p>Can we initialize the line index with <code>self.line_index</code>? The index only needs updating when <code>new_contents</code> was modified.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/edit/document.rs</code>:81 on 2024-03-01 18:09</div>
            <div class="timeline-body"><p>I believe this unnecessarily computes the line index at least once even when <code>new_contents</code> still match <code>self.content</code>.</p>
<p>I think we can simply re-compute the <code>LineIndex</code> after every change because we need the new <code>LineIndex</code>  when calling <code>modify_with_manual_index</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/edit/document.rs</code>:117 on 2024-03-01 18:10</div>
            <div class="timeline-body"><p>Nit: Should we create a newtype wrapper for <code>Version</code>. It would give the <code>i32</code> more meaning (especially if we start storing it in other places)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/edit/range.rs</code>:8 on 2024-03-01 18:11</div>
            <div class="timeline-body"><p>Nit: We could introduce two new extension traits and expose this functionality as methods instead:</p>
<pre><code>pub(crate) trait RangeExt {
	fn to_text_range(&amp;self, text: &amp;str, index: &amp;LineIndex, encoding: PositionEncoding) -&gt; TextRange{}
}

pub(crate) trait TextRangeExt {
	fn to_range(&amp;self, text: &amp;str, index; &amp;LineIndex, encoding: PositionEncoding) -&gt; types::Range {...}
}
</code></pre>
<p>It would slightly reduce the number of arguments that need to be passed.</p>
<p>Another alternative is that we create our own <code>EditorRange</code> newtype wrapper around <code>types::Range</code> so that we can implement additional methods on it</p>
<pre><code>#[derive(Copy, Clone, Debug, Eq, PartialEq)]
pub(crate) struct EditorRange(types::Range);

impl EditorRange {
	pub(crate) fn from_text_range(range: TextRange, text: &amp;str, index: &amp;LineIndex, encoding: PositionEncoding) -&gt; Self {
	...
  }

  pub(crate) fn to_text_range(text: &amp;str, index: &amp;LineIndex, encoding: PositionEncoding) -&gt; TextRange {
		...
  }
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/edit/range.rs</code>:1 on 2024-03-01 18:11</div>
            <div class="timeline-body"><p>@BurntSushi would you mind taking a look at these methods as our unicode expert.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/format.rs</code>:19 on 2024-03-01 18:22</div>
            <div class="timeline-body"><p>I would call the method <code>format_range</code> and instead use the full qualified name on line 28. I fear that it&#x27;s otherwise confusing because people need to remember whether it was <code>format_range</code> or <code>range_format</code> and the answer depends on the crate you&#x27;re in.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/lint.rs</code>:45 on 2024-03-01 18:23</div>
            <div class="timeline-body"><p>Coud this re-use the computed <code>LineIndex</code> from the document?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/lint.rs</code>:33 on 2024-03-01 18:24</div>
            <div class="timeline-body"><p>It would be nice if we could reuse more of the <code>ruff_linter</code> crate methods but maybe something to consider to do later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/lib.rs</code>:25 on 2024-03-01 18:25</div>
            <div class="timeline-body"><p>Can we reuse the linter version here (that&#x27;s what the CLI uses as well)</p>
<pre><code>    ruff_linter::VERSION
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/lint.rs</code>:102 on 2024-03-01 18:26</div>
            <div class="timeline-body"><p>It would be nice if we wouldn&#x27;t have to store the fixes in the diagnostics but changing that is probably something we should leave for later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server.rs</code>:103 on 2024-03-01 18:28</div>
            <div class="timeline-body"><p>Nit: I would appreciate longer names than <code>g</code> and <code>e</code>. It improves readability when you don&#x27;t have type information available, e.g. on GitHub.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server.rs</code>:103 on 2024-03-01 18:29</div>
            <div class="timeline-body"><p>Should we consider more than just the first encoding?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/schedule/thread/priority.rs</code>:1 on 2024-03-01 18:32</div>
            <div class="timeline-body"><p>@BurntSushi I would appreciate it if you could take a look at the scheduling code here. Okay, I&#x27;m making assumptions here. I assume you know a good deal about thread scheduling. If not, don&#x27;t feel required to review.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-03-01 18:33</div>
            <div class="timeline-body"><p>This looks very exciting. I haven&#x27;t managed to get through everything yet. I plan to continue my review on Monday.</p>
<p>I would appreciate a more in depth explanation of the architecture and why you decided to go with <code>lsp-server</code> over <code>tower-lsp</code>. Documenting this decision will be useful for the future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-03-01 18:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/notifications/did_change.rs</code>:25 on 2024-03-04 13:21</div>
            <div class="timeline-body"><p>Do we need to update the document&#x27;s version when the content is empty to ensure it stays in sync with the IDE?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/notifications/did_change.rs</code>:21 on 2024-03-04 13:23</div>
            <div class="timeline-body"><p>I don&#x27;t fully understand why using a macro is necessary and it isn&#x27;t obvious what&#x27;s happening here (or where <code>document_url</code> is coming from). I assume it is because all params have a different shape. How about we define a trait <code>DocumentUrl</code> with a single <code>document_url</code> method (I don&#x27;t like the trait name, maybe <code>Document</code>?) that we could then pass to the <code>document_controller</code></p>
<p>Or we remove the macro because the implementation is trivial?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/notifications/did_open.rs</code>:28 on 2024-03-04 13:37</div>
            <div class="timeline-body"><p>What&#x27;s the reason that this notification isn&#x27;t using <code>        super::define_document_url!(params: &amp;types::DidCloseTextDocumentParams);</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/code_action.rs</code>:30 on 2024-03-04 13:43</div>
            <div class="timeline-body"><p>Nit: Can we use <code>context</code> here and make it explicit that the serialized fix data is incorrect? I fear that it&#x27;s otherwise very painful to track down where the json serialization fails.</p>
<p>Which brings up. Should we use more explicit errors (thiserror?) in combiantion with <code>anyhow</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/diagnostic.rs</code>:9 on 2024-03-04 13:45</div>
            <div class="timeline-body"><p>Nit: Maybe rename to <code>DocumentDiagnostic</code>. <code>Diagnostic</code> is a very generic term</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/diagnostic.rs</code>:23 on 2024-03-04 13:45</div>
            <div class="timeline-body"><p>Nit: It seems very common that we need to pass <code>Document</code> and <code>Encoding</code>. Should we store the encoding on the <code>Document</code> or have a type that wrapps <code>Document</code> and <code>encoding</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/format.rs</code>:25 on 2024-03-04 13:46</div>
            <div class="timeline-body"><pre><code>        let doc_size = snapshot.document().contents().text_len();
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/format.rs</code>:26 on 2024-03-04 13:48</div>
            <div class="timeline-body"><p>Yeah, I think it would be nice to run a small diff. The existing LSP does a very &quot;trivial&quot; diff where it truncates identical lines from the start and end. We should add that at least. Using a proper &quot;diffing&quot; algorithm might help to create smaller edits but has the downside that diffing is exponential. That&#x27;s why I think the &quot;simple&quot; diffing is enough for now and we can leave it to editors to narrow the edits.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/format_range.rs</code>:26 on 2024-03-04 13:49</div>
            <div class="timeline-body"><p>Would it make sense to use <code>context</code> or some other information that lets us know from which request the error is coming from or do we attach this somewhere further up?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests.rs</code>:15 on 2024-03-04 13:50</div>
            <div class="timeline-body"><p>What&#x27;s the reasoning of making this a <code>Option&lt;Vec&lt;_&gt;&gt;</code> over a <code>Vec&lt;_&gt;</code> that is either empty (no changes) or contains edits?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/traits.rs</code>:10 on 2024-03-04 13:52</div>
            <div class="timeline-body"><p>Is it possible to send other responses to the server? For example, can an implementation send a notification to the client while it is in the middle of the operation?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/traits.rs</code>:18 on 2024-03-04 13:52</div>
            <div class="timeline-body"><pre><code>/// executing. Avoid doing any I/O or long-running computations.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/traits.rs</code>:64 on 2024-03-04 13:54</div>
            <div class="timeline-body"><p>Nit: I recommend moving this comment to <code>document_url</code>. Although, I would prefer to avoid the macro and instead implement the very simple signature manually.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/traits.rs</code>:32 on 2024-03-04 13:56</div>
            <div class="timeline-body"><p>The fact that <code>document_url</code> is mandatory limits <code>BackgroundRequest</code> to requests that have a document. For exmaple, it&#x27;s not possible to use it for requesting all workflow symbols.</p>
<p>It seems the <code>document_url</code> is used for getting the snapshot. Could we change the signature so that we pass in the entire Global snapshot state and the <code>snapshot_lense</code> (or just <code>snapshot</code>) slices the content that it needs from the snapshot?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/traits.rs</code>:90 on 2024-03-04 14:00</div>
            <div class="timeline-body"><p>Nit: Could we use <code>&amp;&#x27;static str</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/traits.rs</code>:107 on 2024-03-04 14:02</div>
            <div class="timeline-body"><p>Should we rename the method to <code>complete</code> or similar to decouple it from the request/response concept (that, seemingly, doesn&#x27;t apply to all <code>Request</code>s)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/traits.rs</code>:69 on 2024-03-04 14:03</div>
            <div class="timeline-body"><p>Same as for <code>BackgroundTask</code>: Can we decouple the signature from documents to also support workspace requests?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api.rs</code>:51 on 2024-03-04 14:08</div>
            <div class="timeline-body"><p>This reads very nicely and it&#x27;s impressive that you can write all these macros!
Unfortunately, it breaks RustRover completely. It fails to find the <code>BackgroundRequest::document_url</code> usage and <code>unwrap_or_else</code> is marked as a syntax error. It also took me a while to understand what&#x27;s going on in the macros and I&#x27;m not sure if I fully undertand yet.</p>
<p>Do you see a way to reduce the need for macros or can we pull out more code out of the macros so that the macros become very thin wrappers?</p>
<p>There&#x27;s also quiet a lot of complexity in the macro implementations that I find very difficult to read. That&#x27;s why I think it would be worthwile exploring non-macro designs (I&#x27;m okay deriving some repetitive fields with macros but implementing scheduling in macro&#x27;s sounds scary)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/client.rs</code>:18 on 2024-03-04 14:14</div>
            <div class="timeline-body"><p>This is the first time that I see <code>pub(in ..)</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/schedule.rs</code>:25 on 2024-03-04 14:20</div>
            <div class="timeline-body"><p>Can you document the reason why we need the larger stack size or remove it until we have a need for it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/schedule.rs</code>:21 on 2024-03-04 14:21</div>
            <div class="timeline-body"><p>Should we use a different name for it, e.g. <code>primary</code>, <code>mutating</code>, or whatever its main purpose is?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/session/types.rs</code>:3 on 2024-03-04 14:23</div>
            <div class="timeline-body"><p>Nit: Rename to <code>LspSettings</code> or similar? We already have multiple <code>Settings</code> struct in ruff and I often import or navigate to the wrong type.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/session.rs</code>:27 on 2024-03-04 14:24</div>
            <div class="timeline-body"><p>Nit:</p>
<pre><code>    watch_receiver: Receiver&lt;notify::Result&lt;notify::Event&gt;&gt;,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/session.rs</code>:22 on 2024-03-04 14:25</div>
            <div class="timeline-body"><p>Can we document the fields in <code>Session</code>. They seem important (e.g I don&#x27;t know what <code>watch_recv</code> is)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/session.rs</code>:37 on 2024-03-04 14:26</div>
            <div class="timeline-body"><p>Should this be <code>DocumentSnapshot</code>, considering that it only references a single document. How do you imagine this to grow once we have workspaces and might need snapshoting data other than documents?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/session.rs</code>:40 on 2024-03-04 14:27</div>
            <div class="timeline-body"><p>Nit: Consider renaming to <code>LspConfiguration</code> or similar. There&#x27;s already a handful of <code>Configuration</code> structs in ruff and them having the same name can be confusing.</p>
<p>Also: Should this be <code>Settings</code> considering that it stores <code>Settings</code> struct?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/session.rs</code>:77 on 2024-03-04 14:29</div>
            <div class="timeline-body"><p>What&#x27;s the reason that we set-up our own watchers. The LSP specification supports file watching (e.g VS code watches your project for changes and notifices the server)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/session.rs</code>:61 on 2024-03-04 14:31</div>
            <div class="timeline-body"><p>Nit: I find <code>Controller</code> a very generic word that isn&#x27;t telling me much about what it does (it controls a document somehow?).</p>
<p>Can we think of a more semantical name of what it represents? How is it different from <code>Document</code> and <code>DocumentRef</code>? Maybe <code>OpenDocument</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/session.rs</code>:172 on 2024-03-04 14:34</div>
            <div class="timeline-body"><p>Nit: <code>document_snapshot</code> to make it consistent with <code>open_document</code> and to avoid abbreviation. Or you remove the <code>document</code> from all methods which I think would read nice:</p>
<ul>
<li><code>documents.snapshot(my_doc)</code></li>
<li><code>documents.controller(my_doc)</code></li>
<li><code>documents.open(url, content, version)</code></li>
<li><code>documents.close(url, content, version)</code></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/session.rs</code>:261 on 2024-03-04 14:35</div>
            <div class="timeline-body"><p>Ruff also support <code>.ruff.toml</code> https://docs.astral.sh/ruff/configuration/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/session.rs</code>:265 on 2024-03-04 14:35</div>
            <div class="timeline-body"><p>Nit: I&#x27;ve most commonly seen <code>mut</code> as postfix and not prefix: <code>self.entry_for_path_mut(path)</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/session.rs</code>:321 on 2024-03-04 14:37</div>
            <div class="timeline-body"><p>Nit: I would find it helpful if we avoid single letter variables because it is very difficult to tell what the types are when doing a code review. E.g. I have no idea what <code>u</code> is. <code>Url</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/session.rs</code>:326 on 2024-03-04 14:37</div>
            <div class="timeline-body"><pre><code>    fn workspace_for_url_mut(&amp;mut self, url: &amp;Url) -&gt; Option&lt;&amp;mut Workspace&gt; {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/session.rs</code>:331 on 2024-03-04 14:43</div>
            <div class="timeline-body"><p>Isn&#x27;t it guaranteed that the longest-match is always the last key given that the keys are stored in sorted order?</p>
<p>Can we use the <code>range_mut</code> api (same for other calls)</p>
<pre><code>self.0.range_mut(..path).next_back().map(|(_, w)| w)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/schedule/thread/pool.rs</code>:47 on 2024-03-04 14:45</div>
            <div class="timeline-body"><p>What&#x27;s the reason for the increased stack size in worker threads?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/schedule/thread/pool.rs</code>:53 on 2024-03-04 14:51</div>
            <div class="timeline-body"><p>How comfortable do you feel about the threading code and that you understand it well (also applies to priority.rs)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/schedule/task.rs</code>:1 on 2024-03-04 14:53</div>
            <div class="timeline-body"><p>Does this file (all files in <code>schedule</code>) need a license header?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api.rs</code>:28 on 2024-03-04 15:14</div>
            <div class="timeline-body"><p>Nit: Coudl we include the <code>id</code> in the returned error?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-03-04 15:20</div>
            <div class="timeline-body"><p>As said before. This is excellent work. I haven&#x27;t reviewed everything in detail, the PR is too large for that.</p>
<p>I think this work deserves a more in depth explanation of the architecture decisions. I like the simplicity of the handlers and that mutating tasks run on a dedicated thread. However, it comes at the cost that cancellation, the entire scheduling, dispatching, are problems that we now need to solve. That&#x27;s why I&#x27;m interested on hearing your perspective on how to balance these tradeoffs and the complexity of implementing said features (I&#x27;m especially interested in cancellation).</p>
<p>I would find some additional comments useful that explain some concepts, especially around scheduling, how requests/notifications work etc. I can see that you have put a lot of thought into it, let&#x27;s make sure that other contributors are aware of your deliberate design choices.</p>
<p>It might be nice if some of the scheduling work could be tested too. Although I fear that this isn&#x27;t going to be easy.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_server/src/edit.rs</code>:19 on 2024-03-04 17:57</div>
            <div class="timeline-body"><p>What does &quot;second choice&quot; mean in this context?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_server/src/edit/document.rs</code>:25 on 2024-03-04 17:59</div>
            <div class="timeline-body"><p>Strong agree. Default to encapsulation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_server/src/edit/document.rs</code>:12 on 2024-03-04 18:01</div>
            <div class="timeline-body"><p>Some comments on what these fields are (especially <code>version</code>) and any relevant invariants would be helpful.</p>
<p>Also, if the <em>caller</em> needs to care about <code>version</code> (and it looks like they might given that they provide it to <code>Document</code>&#x27;s constructor), then perhaps some public docs on <code>Document</code> would be useful.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_server/src/edit/document.rs</code>:45 on 2024-03-04 18:04</div>
            <div class="timeline-body"><p>I&#x27;m a big fan of grouping methods, but typically in a way that serves a useful documentation/presentation need (beyond necessary groupings due to generics). <a href="https://docs.rs/regex/latest/regex/struct.Regex.html#impl-Regex-1">For example.</a> I usually wouldn&#x27;t separate methods by immutable/mutable though, but I don&#x27;t know enough yet about this type to suggest an alternative.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_server/src/edit/range.rs</code>:15 on 2024-03-04 18:49</div>
            <div class="timeline-body"><p>I personally like to avoid <code>as</code> casts these days. Since <code>range.start.line</code> is a <code>u32</code> and I don&#x27;t think we have any plans to support 16-bit platforms, it should be correct to do <code>usize::try_from(range.start.line).expect(&quot;u32 fits in usize&quot;)</code> here. (Perhaps an extension trait on <code>lsp_types::Position</code> to add this method if it&#x27;s used a lot would be appropriate.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_server/src/edit/range.rs</code>:77 on 2024-03-04 18:52</div>
            <div class="timeline-body"><p>I would just do <code>u32::try_from(c.len_utf8()).expect(&quot;utf8 len always &lt;=4&quot;)</code>. Then you could remove the <code>SAFETY</code> comment as it&#x27;s encoded in the code and <code>expect</code> message. And you should be able to get rid of the Clippy <code>allow</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_server/src/edit/range.rs</code>:66 on 2024-03-04 18:53</div>
            <div class="timeline-body"><p>Can you document the contract of this function? It is doing interesting things!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_server/src/edit/range.rs</code>:67 on 2024-03-04 18:54</div>
            <div class="timeline-body"><p>I <em>think</em> this would be more precisely named <code>utf8_code_unit_offset</code> or even just <code>byte_offset</code>, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_server/src/edit/range.rs</code>:66 on 2024-03-04 18:55</div>
            <div class="timeline-body"><p>Also, I think &quot;character&quot; is &quot;utf16 code unit offset&quot; right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_server/src/edit/range.rs</code>:153 on 2024-03-04 18:56</div>
            <div class="timeline-body"><p>I think it would be good to have some focused tests for the functions in this module. There are lots of interesting boundary conditions here. Property based tests (<code>quickcheck</code> or <code>proptest</code>) might work well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_server/src/lib.rs</code>:7 on 2024-03-04 18:57</div>
            <div class="timeline-body"><p>I&#x27;d personally drop these sorts of comments. They&#x27;re pretty redundant with the source itself.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_server/src/server.rs</code>:48 on 2024-03-04 19:00</div>
            <div class="timeline-body"><p>This is a very long line. Can you break it up? You can backslash escape newlines to break it up a bit: https://doc.rust-lang.org/rust-by-example/std/str.html#literals-and-escapes</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_server/src/server/api.rs</code>:51 on 2024-03-04 19:11</div>
            <div class="timeline-body"><p>I somewhat agree. I spent a couple minutes trying to grok them but couldn&#x27;t manage. I think exploring non-macro designs or a lighter-weight and more transparent macro design might be useful. In particular, it looks like the <code>select_task!</code> macro is only being used in a couple places right now, so I&#x27;m not sure how much it is buying us. But maybe is intended to be used a lot more in the future.</p>
<p>If a macro design is truly necessary (or rather, is very compelling given the set of trade offs), a mitigation to it is extra docs with lots of examples.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_server/src/server/api/traits.rs</code>:18 on 2024-03-04 19:13</div>
            <div class="timeline-body"><p>Can you add more to these docs explaining why?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_server/src/server/schedule/thread/pool.rs</code>:48 on 2024-03-04 19:19</div>
            <div class="timeline-body"><p>Do we need unbounded channels here? I&#x27;d rather we use bounded channels so that we can benefit from backpressure. (And if we need unbounded channels, we should write some comments explaining why.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_server/src/server/schedule/thread/priority.rs</code>:1 on 2024-03-04 19:20</div>
            <div class="timeline-body"><p>I don&#x27;t have much special insight here. My prior is that rust-analyzer likely has some institutional knowledge that is encoded here that we&#x27;ll probably benefit from.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_server/src/server/schedule/thread/priority.rs</code>:1 on 2024-03-04 19:22</div>
            <div class="timeline-body"><p>@snowsignal How certain are you that we need (or greatly benefit from) all of this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-03-04 19:27</div>
            <div class="timeline-body"><p>Wow! There is so much here! Really nice work. :-)</p>
<p>Other than the comments I left, I have some holistic feedback too:</p>
<ol>
<li>It feels like there is a lot of interesting documentation that could be written for a lot of your types that would help clarify some of their behavior. I found that the comments that did exist were more on the &quot;inside baseball&quot; side of the spectrum (e.g., the comments about not implementing a trait method or the comments about why a type isn&#x27;t just a closure) rather than &quot;here is the contract the caller needs to care about.&quot; I like the former. They belong. They help contextualize why code is the way it is. But I&#x27;d really like to see more of the latter.</li>
<li>I found it somewhat difficult to review this PR without a &quot;big picture&quot; of how the code is structure. These are tricky docs to write, I&#x27;d suggest the first step in doing so is to pick a target audience. For example, for me, I know very little about LSP, but perhaps the architecture docs should assume that knowledge. But maybe not. I&#x27;m not sure.</li>
</ol>
<p>Overall amazing work. I can&#x27;t believe how fast you got this built!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>Cargo.toml</code>:72 on 2024-03-04 22:01</div>
            <div class="timeline-body"><p>Thanks for catching <code>phf</code>, we can remove that! (it was for an optimization I later took out) We still need <code>libc</code> for the QoS wrapper on Apple platforms, though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/edit.rs</code>:19 on 2024-03-04 22:07</div>
            <div class="timeline-body"><p>This was taken from <a href="https://github.com/astral-sh/ruff/pull/7262">Micha&#x27;s proof-of-concept PR</a>. I believe it means that if we&#x27;re given a choice between multiple encodings, this should be our second choice after <code>UTF8</code>. I haven&#x27;t implemented logic to prioritize this yet, though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/edit/document.rs</code>:45 on 2024-03-04 22:09</div>
            <div class="timeline-body"><p>I can probably get rid of the grouping here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server.rs</code>:103 on 2024-03-04 22:12</div>
            <div class="timeline-body"><p>We do - I need to implement encoding prioritization here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server/api/notifications/did_change.rs</code>:21 on 2024-03-04 22:20</div>
            <div class="timeline-body"><p>This macro was created as a way to avoid the repeated boilerplate of writing a function that returned <code>&amp;params.text_document.uri</code> from an arbitrary parameter type in <code>lsp-types</code> (a parameter type is a deserialized message payload for requests and notifications). Since these types don&#x27;t have a shared function to get the <code>Url</code>, even though they all follow the same internal layout, it needs to be a concrete function for each parameter type.</p>
<p>The reason why we need to define this function for each background handler is because we need a generic way to extract the document URL from the parameters of a request/notification, in order to take a session snapshot. Here, though, it&#x27;s just defined for convenience.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server/api/notifications/did_change.rs</code>:25 on 2024-03-04 22:20</div>
            <div class="timeline-body"><p>Good catch, we should update the document version here üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server/api/notifications/did_open.rs</code>:28 on 2024-03-04 22:24</div>
            <div class="timeline-body"><p>We have to de-structure the parameter type anyway to access multiple fields, so defining a boilerplate function to get the document URL wasn&#x27;t necessary. You&#x27;re right that it&#x27;s inconsistent with other handlers, though - maybe I&#x27;ll just de-structure the parameter type for handlers that don&#x27;t have <code>document_url</code> implemented as a required method.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server/api/requests.rs</code>:15 on 2024-03-04 22:25</div>
            <div class="timeline-body"><p>This is the required response type for format requests as defined in <code>lsp_types</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server/api/requests/diagnostic.rs</code>:23 on 2024-03-04 22:28</div>
            <div class="timeline-body"><p>The encoding is a global setting - I think it makes sense to keep it separate from the <code>Document</code> type.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server/api/traits.rs</code>:10 on 2024-03-04 22:32</div>
            <div class="timeline-body"><p>Yes, that&#x27;s allowed - for example, some long-running requests can post notifications that report task progress. That&#x27;s what the <code>notifier</code> is for, even though we aren&#x27;t using it yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server/api/traits.rs</code>:18 on 2024-03-04 22:35</div>
            <div class="timeline-body"><p>I wrote &quot;try to&quot; because we already <em>do</em> have some necessary I/O that gets run on the main thread - for example, when resolving configuration for workspace folders that got added.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server/client.rs</code>:18 on 2024-03-04 22:39</div>
            <div class="timeline-body"><p>Hehe, we can probably replace that with <code>pub(super)</code> anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server/schedule.rs</code>:21 on 2024-03-04 22:41</div>
            <div class="timeline-body"><p>It&#x27;s the thread that runs the main loop - would <code>main_loop_thread</code> work?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server/schedule/task.rs</code>:1 on 2024-03-04 22:42</div>
            <div class="timeline-body"><p>No, this one I wrote myself.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server/schedule/thread/pool.rs</code>:47 on 2024-03-04 22:46</div>
            <div class="timeline-body"><p>Mainly to override low OS defaults on platforms like Windows and avoid the likelihood of a stack overflow. That being said, we probably don&#x27;t need a stack size this big - these defaults were taken from <code>rust-analyzer</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server/schedule/thread/pool.rs</code>:53 on 2024-03-04 22:49</div>
            <div class="timeline-body"><p>I think I understand it reasonably well, though I could probably use some help with making changes (like the one @BurntSushi suggested about using bounded channels) just so I know I&#x27;m on the right track.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server/schedule/thread/pool.rs</code>:48 on 2024-03-04 22:50</div>
            <div class="timeline-body"><p>I can definitely look into using bounded channels here. Could you clarify what you mean by &quot;benefiting from back-pressure?&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/session.rs</code>:61 on 2024-03-04 22:53</div>
            <div class="timeline-body"><p>You&#x27;re right, this could probably be named better. Also these docs need updating because it doesn&#x27;t have a revision counter anymore ü´†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/session.rs</code>:77 on 2024-03-04 22:56</div>
            <div class="timeline-body"><p>Oh, that makes things much simpler! I&#x27;ll try switching to that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server/schedule/thread/priority.rs</code>:1 on 2024-03-04 23:20</div>
            <div class="timeline-body"><p>If we&#x27;re going to have a multi-threaded LSP (which I strongly believe we <em>should</em>), we&#x27;ll need a way to manage thread pool(s), and for something as latency-critical as an LSP I think thread prioritization is a reasonable thing to have too. I&#x27;m not as committed to this specific implementation as I am to the general idea of having a scheduler with these capabilities.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server/api/traits.rs</code>:18 on 2024-03-04 23:22</div>
            <div class="timeline-body"><p>I actually might move the methods on this trait and <code>Notification</code> out into standalone functions as part of the work to remove <code>select_task!</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server/api.rs</code>:51 on 2024-03-04 23:26</div>
            <div class="timeline-body"><p>I&#x27;ll look into removing macros as much as I can from the codebase. Having one for task initialization might be handy, but <code>select_task!</code> can definitely be refactored out.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-03-04 23:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-03-05 12:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_server/src/edit.rs</code>:19 on 2024-03-05 12:01</div>
            <div class="timeline-body"><p>I think the thing that confused me here is that I understand <code>UTF8</code> to be the preferred encoding, but <code>UTF16</code> is marked as the default. Yet, the comment on UTF32 says it is the second choice. I think the answer here is maybe some holistic docs on this type explaining when each variant is used. (And I do also wonder whether a <code>Default</code> impl for this type is a good idea, but I don&#x27;t have enough of the surrounding context internalized to have a strong opinion.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-03-05 12:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_server/src/server/schedule/thread/pool.rs</code>:48 on 2024-03-05 12:05</div>
            <div class="timeline-body"><p>Yes! I wrote a little bit about it (with links) in the context of <code>uv</code> a bit ago: <a href="https://github.com/astral-sh/uv/pull/1163">astral-sh/uv#1163</a>#discussion_r1473155361</p>
<p>To be clear, I do not mean to say &quot;never use unbound channels.&quot; I mean to say that if we do use them, IMO, we ought to have a specific justification for them. But otherwise default to bounded channels.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-03-05 12:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/edit.rs</code>:19 on 2024-03-05 12:12</div>
            <div class="timeline-body"><p>For some context: It&#x27;s the default because UTF16 is the default according to the LSP specification that all servers must support.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>Cargo.toml</code>:63 on 2024-03-05 17:12</div>
            <div class="timeline-body"><p>I would recommend to use the <code>lsprotocol</code> library (https://github.com/microsoft/lsprotocol/tree/main/packages/rust/lsprotocol) as it&#x27;ll always be in sync with the latest protocol. The <code>ruff-lsp</code> package also uses the Python version of it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-05 17:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/lint.rs</code>:33 on 2024-03-07 15:20</div>
            <div class="timeline-body"><p>I&#x27;ll explore this in a follow-up!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/lint.rs</code>:102 on 2024-03-07 15:21</div>
            <div class="timeline-body"><p>I&#x27;ll make this a follow-up issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server/api/requests/format_range.rs</code>:26 on 2024-03-07 15:22</div>
            <div class="timeline-body"><p>We attach this further up, inside the task closure.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>Cargo.toml</code>:63 on 2024-03-07 17:00</div>
            <div class="timeline-body"><p>I think we&#x27;ll have to make this a follow-up issue - this would be a pretty fundamental re-write.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-03-07 17:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-03-07 17:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server/api/traits.rs</code>:32 on 2024-03-07 17:39</div>
            <div class="timeline-body"><blockquote>
<p>Could we change the signature so that we pass in the entire Global snapshot state and the snapshot_lense (or just snapshot) slices the content that it needs from the snapshot?</p>
</blockquote>
<p>We could, but there isn&#x27;t a need for that right now. For now, I changed the trait names to be more explicitly about capturing a single document.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-03-07 17:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff/src/args.rs</code>:500 on 2024-03-07 17:54</div>
            <div class="timeline-body"><p>If we end up supporting a language server <em>and</em> a daemon, we should probably call the daemon something other than &#x27;server&#x27;, in my opinion.</p>
<p>Here&#x27;s why I think <code>server</code> is a good name for this command:</p>
<ul>
<li>It fits our command naming scheme better, since none of our other commands use acronyms</li>
<li>It&#x27;s more immediately clear as to what it&#x27;s doing, especially if someone isn&#x27;t familiar with the term &quot;LSP&quot;.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/edit/document.rs</code>:95 on 2024-03-08 09:30</div>
            <div class="timeline-body"><p>Can&#x27;t we take <code>active_index</code> here, considering that we carefully updated it in each iteratin?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/edit/range.rs</code>:153 on 2024-03-08 09:31</div>
            <div class="timeline-body"><p>I agree on this @snowsignal do you plan to follow up on this in a separate PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/format.rs</code>:25 on 2024-03-08 09:35</div>
            <div class="timeline-body"><p>It might be worth to do a quick check if the code is identical and in that case, return early.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/format.rs</code>:39 on 2024-03-08 09:37</div>
            <div class="timeline-body"><p>Nit: I like to make constructor functions methods on the corresponding types: <code>Replacement::between(unformatted, unformatted_index.line_starts(), ...)</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/format.rs</code>:50 on 2024-03-08 09:38</div>
            <div class="timeline-body"><p>To use the same terminology as in the <code>Format::run</code> function or align with the formatter internal terminology:</p>
<ul>
<li><code>unformatted_range</code> and <code>formatted_range</code></li>
<li>or <code>source_range</code>, <code>formatted_range</code></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/format.rs</code>:85 on 2024-03-08 09:42</div>
            <div class="timeline-body"><p>I think this iterates the document twice if they are identical. We should avoid re-traversing <code>old_text_line_starts</code> for the lines we know are identical after having found <code>old_start</code> and <code>new_start.</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/format.rs</code>:142 on 2024-03-08 09:43</div>
            <div class="timeline-body"><p>Nit: Some whitespace could help readers to understand the setup / act / assertion flow</p>
<pre><code>        let original = r#&quot;
        aaaa
        bbbb
        cccc
        dddd
        eeee
        &quot;#;
        let original_index = LineIndex::from_source_text(original);

        let new = r#&quot;
        bb
        cccc
        dd
        &quot;#;
        let new_index = LineIndex::from_source_text(new);

        let expected = r#&quot;
        bb
        cccc
        dd
        &quot;#;

        let replacement = find_replacement_range(
            original,
            original_index.line_starts(),
            new,
            new_index.line_starts(),
        );

        let mut test = original.to_string();
        test.replace_range(
            replacement.replace_range.start().to_usize()
                ..replacement.replace_range.end().to_usize(),
            &amp;new[replacement.replacement_text_range],
        );
        
        assert_eq!(expected, &amp;test);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/notifications/did_change.rs</code>:21 on 2024-03-08 09:46</div>
            <div class="timeline-body"><p>That makes sense. IMO, the macro here seems overkill. The code it generates is minimal and very easy to write by hand. However, it adds significant complexity to readers because they have to open the macro definition or read its documentation to understand what&#x27;s happening inside.</p>
<p>That&#x27;s why I recommend removing the macro and instead implementing the trait function by hand (I&#x27;m sure code pilot can autocomplete it for you)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/session.rs</code>:177 on 2024-03-08 09:56</div>
            <div class="timeline-body"><p>Nit: I would prefer what you said during during the sync demonstration: To make this method explicit rather than in <code>deref_mut</code>. I would be surprised to learn that a <code>deref</code> function allocates internally, especially considering that the compiler inserts <code>deref_mut</code> calls manually</p>
<blockquote>
<p>DerefMut. The compiler will silently insert calls to DerefMut::deref_mut. For this reason, one should be careful about implementing DerefMut and only do so when mutable deref coercion is desirable. See the Deref docs for advice on when this is typically desirable or undesirable.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/session.rs</code>:153 on 2024-03-08 09:57</div>
            <div class="timeline-body"><p>Nit : Some spacing between the methods helps readability</p>
<pre><code>    fn snapshot(&amp;self, url: &amp;Url) -&gt; Option&lt;DocumentRef&gt; {
        Some(self.documents.get(url)?.make_ref())
    }

    fn controller(&amp;mut self, url: &amp;Url) -&gt; Option&lt;&amp;mut DocumentController&gt; {
        self.documents.get_mut(url)
    }

    fn open(&amp;mut self, url: &amp;Url, contents: String, version: DocumentVersion) {
        if self
            .documents
            .insert(url.clone(), DocumentController::new(contents, version))
            .is_some()
        {
            tracing::warn!(&quot;Opening document `{url}` that is already open!&quot;);
        }
    }
    
    fn close(&amp;mut self, url: &amp;Url) -&gt; crate::Result&lt;()&gt; {
        let Some(_) = self.documents.remove(url) else {
            return Err(anyhow!(
                &quot;Tried to close document `{url}`, which was not open&quot;
            ));
        };
        Ok(())
    }
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/schedule.rs</code>:21 on 2024-03-08 09:57</div>
            <div class="timeline-body"><p>Nit: Have you considered renaming <code>main_loop</code> to <code>event_loop</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/traits.rs</code>:7 on 2024-03-08 09:59</div>
            <div class="timeline-body"><p>Should we rename our <code>Request</code> trait to <code>RequestHandler</code> or similar to avoid conflicts with <code>lsp_types</code>? I&#x27;m concerned that it can be confusing when somone accidentally imports the &quot;wrong&quot; request type. Especially because both traits are needed to implement a <code>Request</code> trait</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server.rs</code>:110 on 2024-03-08 10:01</div>
            <div class="timeline-body"><p>Nit: It might be worth to implement <code>TryFrom</code> for <code>&amp;LspEncoding</code> to avoid the cloning here (I don&#x27;t know how expensive cloning the LSP encoding is but I don&#x27;t see a reason why we can&#x27;t implement <code>TryFrom</code> for a reference instead)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2024-03-08 10:05</div>
            <div class="timeline-body"><p>The code looks great. Thanks for addressing all the feedback.</p>
<p>What&#x27;s still missing, in my view, is a discussion of the architectural decisions as part of the PR summary. We&#x27;ve covered some of them in our sync meeting but I think it is beneficial to write those down to have a reference for the future. That&#x27;s the reason why I&#x27;m requesting feedback. Once that&#x27;s done, feel free to merge.</p>
<p>As @BurntSushi pointed out, I think it would be good to have some more conceptual documentation. Maybe the <code>README</code> would be a good start. It doesn&#x27;t have to be extensive but a brief explanation of the core concept involved.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-03-08 17:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/edit/range.rs</code>:153 on 2024-03-09 01:04</div>
            <div class="timeline-body"><p>Yep, this will be in a follow-up.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-03-09 04:56</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>‚úÖ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>‚ÑπÔ∏è ecosystem check <strong>detected linter changes</strong>. (+13 -0 violations, +0 -0 fixes in 1 projects; 42 projects unchanged)</p>
<a href="https://github.com/pandas-dev/pandas">pandas-dev/pandas</a> (+13 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/pandas-dev/pandas/blob/4692686a750b95884e1d5a4f1313614c71c57213/pandas/io/parsers/python_parser.py#L1039">pandas/io/parsers/python_parser.py:1039:47:</a> PLR6201 Use a `set` literal when testing for membership
+ <a href="https://github.com/pandas-dev/pandas/blob/4692686a750b95884e1d5a4f1313614c71c57213/pandas/io/parsers/python_parser.py#L1106">pandas/io/parsers/python_parser.py:1106:9:</a> PLR1702 Too many nested blocks (6 &gt; 5)
+ <a href="https://github.com/pandas-dev/pandas/blob/4692686a750b95884e1d5a4f1313614c71c57213/pandas/io/parsers/python_parser.py#L1106">pandas/io/parsers/python_parser.py:1106:9:</a> PLR1702 Too many nested blocks (6 &gt; 5)
+ <a href="https://github.com/pandas-dev/pandas/blob/4692686a750b95884e1d5a4f1313614c71c57213/pandas/io/parsers/python_parser.py#L1208">pandas/io/parsers/python_parser.py:1208:9:</a> PLR0917 Too many positional arguments (6/5)
+ <a href="https://github.com/pandas-dev/pandas/blob/4692686a750b95884e1d5a4f1313614c71c57213/pandas/io/parsers/python_parser.py#L1343">pandas/io/parsers/python_parser.py:1343:9:</a> PLR6301 Method `_remove_empty_lines` could be a function, class method, or static method
+ <a href="https://github.com/pandas-dev/pandas/blob/4692686a750b95884e1d5a4f1313614c71c57213/pandas/io/parsers/python_parser.py#L1358">pandas/io/parsers/python_parser.py:1358:40:</a> PLC1901 `v == &quot;&quot;` can be simplified to `not v` as an empty string is falsey
+ <a href="https://github.com/pandas-dev/pandas/blob/4692686a750b95884e1d5a4f1313614c71c57213/pandas/io/parsers/python_parser.py#L391">pandas/io/parsers/python_parser.py:391:9:</a> PLR0914 Too many local variables (25/15)
+ <a href="https://github.com/pandas-dev/pandas/blob/4692686a750b95884e1d5a4f1313614c71c57213/pandas/io/parsers/python_parser.py#L399">pandas/io/parsers/python_parser.py:399:9:</a> PLR1702 Too many nested blocks (6 &gt; 5)
+ <a href="https://github.com/pandas-dev/pandas/blob/4692686a750b95884e1d5a4f1313614c71c57213/pandas/io/parsers/python_parser.py#L399">pandas/io/parsers/python_parser.py:399:9:</a> PLR1702 Too many nested blocks (7 &gt; 5)
+ <a href="https://github.com/pandas-dev/pandas/blob/4692686a750b95884e1d5a4f1313614c71c57213/pandas/io/parsers/python_parser.py#L449">pandas/io/parsers/python_parser.py:449:29:</a> PLC1901 `c == &quot;&quot;` can be simplified to `not c` as an empty string is falsey
+ <a href="https://github.com/pandas-dev/pandas/blob/4692686a750b95884e1d5a4f1313614c71c57213/pandas/io/parsers/python_parser.py#L701">pandas/io/parsers/python_parser.py:701:9:</a> PLR6301 Method `_is_line_empty` could be a function, class method, or static method
+ <a href="https://github.com/pandas-dev/pandas/blob/4692686a750b95884e1d5a4f1313614c71c57213/pandas/io/parsers/python_parser.py#L815">pandas/io/parsers/python_parser.py:815:37:</a> PLR6201 Use a `set` literal when testing for membership
+ <a href="https://github.com/pandas-dev/pandas/blob/4692686a750b95884e1d5a4f1313614c71c57213/pandas/io/parsers/python_parser.py#L863">pandas/io/parsers/python_parser.py:863:9:</a> PLR6301 Method `_remove_empty_lines` could be a function, class method, or static method
</pre>

</p>

Changes by rule (6 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PLR1702 | 4 | 4 | 0 | 0 | 0 |
| PLR6301 | 3 | 3 | 0 | 0 | 0 |
| PLR6201 | 2 | 2 | 0 | 0 | 0 |
| PLC1901 | 2 | 2 | 0 | 0 | 0 |
| PLR0917 | 1 | 1 | 0 | 0 | 0 |
| PLR0914 | 1 | 1 | 0 | 0 | 0 |</p>
</p>


Formatter (stable)
<p>‚úÖ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>‚úÖ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-03-09 04:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-03-09 04:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-03-09 04:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-03-09 04:58</div>
            <div class="timeline-body"></div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:01:52 UTC
    </footer>
</body>
</html>
