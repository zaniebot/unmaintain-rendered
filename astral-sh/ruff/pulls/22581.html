<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Remove redundant re-exports that share the same top-most module - astral-sh/ruff #22581</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Remove redundant re-exports that share the same top-most module</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22581">#22581</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2026-01-14 19:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a></div>
            <div class="timeline-body"><p>The idea here is to avoid flooding completions with a bunch of
redundant symbols when those symbols are just re-exports of one
another. And in particular, to avoid suggesting symbols &quot;deeper&quot;
in the module graph.</p>
<p>The implementation here is (to me) surprisingly complicated. The main
constraints leading to some of that complexity are:</p>
<ol>
<li><p>Trying to limit the redundant detection to as few of the symbols
we extract as possible. In particular, while I haven't done benchmarking
on this, I perceive the redundancy detection to be somewhat expensive
and auto-import can return lots of symbols. So we're careful to only do
this extra checking on (typically) small groups of symbols that could
possibly be merged.</p>
</li>
<li><p>Even by restricting our work, this merging process could still be
called quite a bit. (Thousands of times in my &quot;standard data scienc-y
test environment.&quot;) So I went out of my way to amortize allocs.</p>
</li>
<li><p>Re-exports can form a chain and we want to find all of them.</p>
</li>
<li><p>We (probably) don't want to remove redundant re-exports unless
they share the same top-level module. Otherwise, e.g., a library
that re-exports another library's symbols could have all of its
re-exports dropped.</p>
</li>
<li><p>We want to only keep the top-most re-exports, and there may be
multiple such re-exports. So we keep all of them.</p>
</li>
<li><p>We can't assume anything about the relationship of re-exports
and the original definition. A re-export could be deeper in the
module hierarchy than the original definition or above it.</p>
</li>
</ol>
<p>Reviewers are encouraged to read this PR commit by commit.</p>
<p>Fixes astral-sh/ty#1857</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @BurntSushi on 2026-01-14 19:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @BurntSushi on 2026-01-14 19:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @BurntSushi on 2026-01-14 19:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @Gankra by @BurntSushi on 2026-01-14 19:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @BurntSushi on 2026-01-14 19:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @BurntSushi on 2026-01-14 19:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2026-01-14 19:20</div>
            <div class="timeline-body"><p>Demo:</p>
<p>https://github.com/user-attachments/assets/3c141fb3-f48b-489a-b7d9-9b6ec54fa457</p>
<p>Here's what the status quo looks like:</p>
<p>https://github.com/user-attachments/assets/a5d8bc24-6537-4d1a-b192-a1b2eed2061b</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-14 19:20</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Typing Conformance</h2>
<h3>Summary</h3>
<p>| Metric | Old | New | Diff | Outcome |
|--------|-----|-----|------|---------|
| True Positives  | 0 | 0 | +0 | ⏬ (❌) |
| False Positives | 969 | 969 | +0 | ⏬ (✅) |
| False Negatives | 1155 | 1155 | +0 | ⏬ (✅) |
| Total Diagnostics | 969 | 969 | 0 | ⏬ |
| Precision | 0.00% | 0.00% | +0.00% | ⏬ (❌) |
| Recall | 0.00% | 0.00% | +0.00% | ⏬ (❌) |</p>
<p>The percentage of diagnostics emitted that were expected errors held steady at 0.00%, and the percentage of expected errors that received a diagnostic held steady at 0.00%.</p>
<p><a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">Typing conformance tests</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-14 19:22</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">prefect (https://github.com/PrefectHQ/prefect)
- src/integrations/prefect-dbt/prefect_dbt/core/settings.py:94:28: error[invalid-assignment] Object of type `T@resolve_block_document_references | dict[str, Any] | str | ... omitted 4 union elements` is not assignable to `dict[str, Any]`
+ src/integrations/prefect-dbt/prefect_dbt/core/settings.py:94:28: error[invalid-assignment] Object of type `T@resolve_block_document_references | dict[str, Any]` is not assignable to `dict[str, Any]`
- src/integrations/prefect-dbt/prefect_dbt/core/settings.py:99:28: error[invalid-assignment] Object of type `T@resolve_variables | str | int | ... omitted 4 union elements` is not assignable to `dict[str, Any]`
+ src/integrations/prefect-dbt/prefect_dbt/core/settings.py:99:28: error[invalid-assignment] Object of type `T@resolve_variables | dict[str, Any]` is not assignable to `dict[str, Any]`
- src/prefect/cli/deploy/_core.py:86:21: error[invalid-assignment] Object of type `T@resolve_block_document_references | dict[str, Any] | str | ... omitted 4 union elements` is not assignable to `dict[str, Any]`
+ src/prefect/cli/deploy/_core.py:86:21: error[invalid-assignment] Object of type `T@resolve_block_document_references | dict[str, Any]` is not assignable to `dict[str, Any]`
- src/prefect/cli/deploy/_core.py:87:21: error[invalid-assignment] Object of type `T@resolve_variables | str | int | ... omitted 4 union elements` is not assignable to `dict[str, Any]`
+ src/prefect/cli/deploy/_core.py:87:21: error[invalid-assignment] Object of type `T@resolve_variables` is not assignable to `dict[str, Any]`
- src/prefect/deployments/steps/core.py:137:38: error[invalid-argument-type] Argument is incorrect: Expected `T@resolve_variables`, found `T@resolve_block_document_references | dict[str, Any] | str | ... omitted 4 union elements`
+ src/prefect/deployments/steps/core.py:137:38: error[invalid-argument-type] Argument is incorrect: Expected `T@resolve_variables`, found `T@resolve_block_document_references | dict[str, Any]`
- src/prefect/utilities/templating.py:320:13: error[invalid-assignment] Invalid subscript assignment with key of type `object` and value of type `T@resolve_block_document_references | dict[str, Any] | str | ... omitted 4 union elements` on object of type `dict[str, Any]`
+ src/prefect/utilities/templating.py:320:13: error[invalid-assignment] Invalid subscript assignment with key of type `object` and value of type `T@resolve_block_document_references | dict[str, Any]` on object of type `dict[str, Any]`
- src/prefect/utilities/templating.py:323:16: error[invalid-return-type] Return type does not match returned value: expected `T@resolve_block_document_references | dict[str, Any]`, found `list[T@resolve_block_document_references | dict[str, Any] | str | ... omitted 5 union elements]`
+ src/prefect/utilities/templating.py:323:16: error[invalid-return-type] Return type does not match returned value: expected `T@resolve_block_document_references | dict[str, Any]`, found `list[T@resolve_block_document_references | dict[str, Any] | Unknown]`
- src/prefect/utilities/templating.py:437:16: error[invalid-return-type] Return type does not match returned value: expected `T@resolve_variables`, found `dict[object, T@resolve_variables | str | int | ... omitted 5 union elements]`
+ src/prefect/utilities/templating.py:437:16: error[invalid-return-type] Return type does not match returned value: expected `T@resolve_variables`, found `dict[object, T@resolve_variables | Unknown]`
- src/prefect/utilities/templating.py:442:16: error[invalid-return-type] Return type does not match returned value: expected `T@resolve_variables`, found `list[T@resolve_variables | str | int | ... omitted 5 union elements]`
+ src/prefect/utilities/templating.py:442:16: error[invalid-return-type] Return type does not match returned value: expected `T@resolve_variables`, found `list[T@resolve_variables | Unknown]`
- src/prefect/workers/base.py:232:13: error[invalid-argument-type] Argument is incorrect: Expected `T@resolve_variables`, found `T@resolve_block_document_references | dict[str, Any] | str | ... omitted 4 union elements`
+ src/prefect/workers/base.py:232:13: error[invalid-argument-type] Argument is incorrect: Expected `T@resolve_variables`, found `T@resolve_block_document_references | dict[str, Any]`
- src/prefect/workers/base.py:234:20: error[invalid-argument-type] Argument expression after ** must be a mapping type: Found `T@resolve_variables | str | int | ... omitted 4 union elements`
+ src/prefect/workers/base.py:234:20: error[invalid-argument-type] Argument expression after ** must be a mapping type: Found `T@resolve_variables`

static-frame (https://github.com/static-frame/static-frame)
- static_frame/core/bus.py:675:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Bus[Any], object_]`, found `InterGetItemILocReduces[Self@iloc | Bus[Any], object_ | Self@iloc]`
+ static_frame/core/bus.py:671:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[Bus[Any], object_]`, found `InterGetItemLocReduces[Bus[Any] | Bottom[Series[Any, Any]] | ndarray[Never, Never] | ... omitted 6 union elements, object_]`
+ static_frame/core/bus.py:675:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Bus[Any], object_]`, found `InterGetItemILocReduces[Bus[Any] | ndarray[Never, Never] | TypeBlocks | ... omitted 6 union elements, object_ | Self@iloc]`
- static_frame/core/node_selector.py:526:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[TVContainer_co@InterfaceSelectQuartet, Any]`, found `InterGetItemLocReduces[Unknown | Bottom[Series[Any, Any]], Any]`
+ static_frame/core/node_selector.py:526:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[TVContainer_co@InterfaceSelectQuartet, Any]`, found `InterGetItemLocReduces[Bottom[Series[Any, Any]] | Unknown, Any]`
+ static_frame/core/yarn.py:418:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Yarn[Any], object_]`, found `InterGetItemILocReduces[Yarn[Any] | Bottom[Index[Any]] | TypeBlocks | ... omitted 6 union elements, object_]`
- Found 1824 diagnostics
+ Found 1826 diagnostics

pandas-stubs (https://github.com/pandas-dev/pandas-stubs)
+ tests/frame/test_groupby.py:229:15: error[type-assertion-failure] Type `Series[Any]` does not match asserted type `Series[str | bytes | int | ... omitted 12 union elements]`
+ tests/frame/test_groupby.py:625:15: error[type-assertion-failure] Type `Series[Any]` does not match asserted type `Series[str | bytes | int | ... omitted 12 union elements]`
- Found 4359 diagnostics
+ Found 4361 diagnostics


</code></pre>
</details>

<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dcreager removed by @BurntSushi on 2026-01-14 19:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @BurntSushi on 2026-01-14 19:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @Gankra removed by @BurntSushi on 2026-01-14 19:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @BurntSushi on 2026-01-14 19:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @BurntSushi on 2026-01-14 19:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @BurntSushi on 2026-01-14 19:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/all_symbols.rs</code>:80 on 2026-01-15 13:14</div>
            <div class="timeline-body"><p>Nit, it could be assigning the result of <code>AllSymbolInfo::</code> to a variable before acquiring the lock, if whatever we do in <code>::from_module </code>is expensive. The same applies for line 85</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/symbols.rs</code>:295 on 2026-01-15 13:18</div>
            <div class="timeline-body"><p><code>ModuleName</code> is also a compact str, meaning we only clone a heap allocation if the string is more than 24 bytes</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/symbols.rs</code>:837 on 2026-01-15 13:19</div>
            <div class="timeline-body"><p>Nit: I have a slight preference for using our own enum here (which could also have methods like <code>symbol_kind</code>). Reading <code>is_left</code>, <code>either</code> in this body feels rather cryptic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_module_resolver/src/module_name.rs</code>:96 on 2026-01-15 13:29</div>
            <div class="timeline-body"><p>Nit: I'm leaning towards using <code>root</code> here, which IMO goes better with <code>ancestors</code> and <code>parent</code> than <code>top</code>, but I can't specifically say why :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/all_symbols.rs</code>:239 on 2026-01-15 13:35</div>
            <div class="timeline-body"><p>One concern that I have with removing it without considering the outer context is if you're working on said library. Let's say I work on pandas and are writing a module in <code>pandas.io.parsers.readers</code> or a sibling package of it. It's probably desired to then import the symbol from the closest module rather than always preferring the outer most module?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/all_symbols.rs</code>:257 on 2026-01-15 13:39</div>
            <div class="timeline-body"><p>This <code>impl</code> block is a bit larger than what I normally would feel comfortable having within a function body. Should we make <code>merge</code> a module?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/all_symbols.rs</code>:254 on 2026-01-15 13:40</div>
            <div class="timeline-body"><p>I'd find a a short comment on what the meaning of these fields helpful. The code here is complicated enough that I'm failing to easily infer the meaning (and all the invariants) by simply scanning the method bodies</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/all_symbols.rs</code>:245 on 2026-01-15 13:51</div>
            <div class="timeline-body"><p>All the lints emitted by clippy here seem reasonable to me (except maybe the match one but can we just disable this specific lint). Any specific reason why you disabled all warning lints?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/all_symbols.rs</code>:436 on 2026-01-15 13:55</div>
            <div class="timeline-body"><p>Is this semantically the same as &quot;finishing&quot; a group? If so, should we add a <code>finish_into(&amp;mut self, target: &amp;mut Vec)</code> method (or <code>finish(&amp;mut self) -&gt; impl Iterator&lt;...&gt;</code> ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/all_symbols.rs</code>:447 on 2026-01-15 13:55</div>
            <div class="timeline-body"><p>haha, you're not one of the <code>is_some_and</code> fans :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/all_symbols.rs</code>:308 on 2026-01-15 14:01</div>
            <div class="timeline-body"><p>What are cases where the kind between two symbols with the same fully qualified name is different?</p>
<p>Would two different kinds suggest that these are different symbols?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/all_symbols.rs</code>:250 on 2026-01-15 14:05</div>
            <div class="timeline-body"><p>Nit: This might be more annoying, so I leave it up to you. As I understand it, the <code>origin_keep</code> act as a mechanism to remove elements from <code>origin</code> and <code>reexport</code> without having to actually remove them (because <code>swap_remove</code> would change the ordering).</p>
<p>An alternative (but maybe too annoying to deal with) approach would be to &quot;tombstone&quot; elements that have been removed, e.g. by making <code>orign</code> a <code>Vec</code> over <code>Option&lt;AllSymbolInfo&gt;</code> where <code>None</code> is the tombstone.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2026-01-15 14:09</div>
            <div class="timeline-body"><p>This looks good. There's certainly a fair amount of complexity in <code>merge</code> (functional but also to avoid allocations) that requires a fair amount of concentration to understand what's going on.</p>
<p>I have one design question on whether filtering out re-export must be sensitive to the current module.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-15 14:54:03 UTC
    </footer>
</body>
</html>
