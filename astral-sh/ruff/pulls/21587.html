<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Refactor `CheckSuppressionContext` to use `DiagnosticGuard` - astral-sh/ruff #21587</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Refactor <code>CheckSuppressionContext</code> to use <code>DiagnosticGuard</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21587">#21587</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-11-23 10:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">Summary
<p>This is PR is a first step towards adding a &quot;Remove unused suppression&quot; code action in the editor.</p>
<p>Adding the fix for removing unused suppression requires setting the <code>Fix</code> on the
diagnostic created by <code>CheckSuppressionContext::report_unchecked</code>. To make this possible,
change <code>report_unchecked</code> and <code>report_lint</code> to return a <code>DiagnosticGuard</code>.</p>
<p>Doing so requires extracting <code>DiagnosticGuard</code> from <code>InferContext</code>.</p>
<p>I tried very hard to not having to change <code>CheckSuppressionContext</code> to store a <code>RefCell&lt;TypeCheckDiagnostic&gt;</code> but
I couldn&#x27;t find a way to do so. I tried a <code>enum DiagnosticSink { Cell(RefCell&lt;TypeCheckDiagnostics&gt;), Mut(&amp;mut TypeCheckDiagnostic) }</code>
with a <code>emit</code> method that takes <code>&amp;self</code>. However, the borrow checker (correctly?), disallowes me to mutate the <code>&amp;mut TypeCheckDiagnostic</code> in that case.</p>
<p>I gave up after 30min or so and I sort of like how <code>check_suppressions</code> takes the <code>Diagnostic</code>s with suppressions and returns only
the diagnostics once it&#x27;s done, as the suppressions have now been handled.</p>
Test Plan
<p><code>cargo test</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-23 10:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-23 10:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-11-23 10:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/diagnostic.rs</code>:154 on 2025-11-23 10:25</div>
            <div class="timeline-body"><p>This is just a move except that <code>DiagnosticGuard</code> now stores a <code>file</code> and <code>sink</code> instead of a <code>&amp;InferContext</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-23 10:26</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-23 10:28</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected ✅</p>
<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-11-23 10:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types/context.rs</code>:636 on 2025-11-23 10:51</div>
            <div class="timeline-body"><p>I moved this logic into <code>DiagnosticGuard::drop</code>, to reduce the code duplication</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/BurntSushi">@BurntSushi</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-23 10:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[ty] Refactor `CheckSuppressionContext` to use `DiagnosticGuard`&quot;&quot; to &quot;[ty] Refactor `CheckSuppressionContext` to use `DiagnosticGuard`&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-23 11:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-23 11:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-23 11:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-23 11:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-23 11:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-23 11:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/dcreager">@dcreager</a> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-23 11:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/carljm">@carljm</a> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-23 11:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/sharkdp">@sharkdp</a> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-23 11:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/AlexWaygood">@AlexWaygood</a> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-23 11:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_python_semantic/src/diagnostic.rs</code>:168 on 2025-11-24 15:02</div>
            <div class="timeline-body"><p>What goes wrong when you use <code>&amp;mut TypeCheckDiagnostics</code> here?</p>
<p>It might be worth a brief comment saying why interior mutability is being used here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2025-11-24 15:02</div>
            <div class="timeline-body"><p>Makes sense to me!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-11-24 15:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/diagnostic.rs</code>:168 on 2025-11-24 15:11</div>
            <div class="timeline-body"><p>It would panic if you do:</p>
<pre><code>let diag = context.report_lint(...);
let diag2 = context.report_lint(...); // we now borrow `&amp;mut TypeCheckDiagnostics` twice
</code></pre>
<p>This seems <em>worse</em> as an API caller shouldn&#x27;t be aware of the internal ref-cell borrow</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-11-24 15:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_python_semantic/src/diagnostic.rs</code>:168 on 2025-11-24 15:26</div>
            <div class="timeline-body"><p>I guess I meant the higher level reason. But I think I now see: you wouldn&#x27;t be able to have two guards alive at the same time?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-11-24 17:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/diagnostic.rs</code>:168 on 2025-11-24 17:52</div>
            <div class="timeline-body"><p>Yes, the higher level reason is that the current approach correctly isolates the <code>RefCell</code> so that callers don&#x27;t need to know about it (I&#x27;ll add a comment).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-25 10:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-25 10:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-11-25 10:54</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:20:58 UTC
    </footer>
</body>
</html>
