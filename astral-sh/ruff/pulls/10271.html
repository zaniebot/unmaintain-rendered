<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remove deprecated parsing list functions - astral-sh/ruff #10271</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Remove deprecated parsing list functions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10271">#10271</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-03-07 08:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-07 08:51</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR removes the deprecated parsing list functions and updates the references to use the new functions.</p>
<p>There are now 4 functions to accommodate this pattern. They are divided into 2 groups: one to parse a sequence of elements and the other to parse a sequence of elements <em>separated</em> by a comma. In each of the groups, there are 2 functions: one collects and returns all the parsed elements as a vector and the other delegates the collection part to the user. This separation is achieved by using <code>Fn</code> and <code>FnMut</code> to allow mutation in the later case.</p>
<p>The error recovery context has been updated to accommodate the new sequence kind. Currently, the terminator token kinds only contain the necessary token to end the list and not necessarily the ones which might help in error recovery. This will be updated as I go through the testing phase. This phase is basically coming up with a bunch of invalid programs to check how the parser is acting and how can we help in the recovery phase.</p>
<h2>Test Plan</h2>
<p>Currently, my plan is to keep the testing part separate than the actual update. This doesn't mean I'm not testing locally, but it's not thorough. The main reason is to keep the diffs to a minimal and writing test cases will require some effort which I want to decouple with the actual change. This is ok here as it's not getting merged into <code>main</code> but the parser PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by @dhruvmanila on 2024-03-07 08:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-08 02:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:22 on 2024-03-08 02:17</div>
            <div class="timeline-body"><p>This is still incomplete, I'm updating as I go through every parse functions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-08 02:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/mod.rs</code>:814 on 2024-03-08 02:19</div>
            <div class="timeline-body"><p>I might update the terminator tokens when I write some thorough test cases for invalid programs for better error recovery. But, for now, it's only limited to all valid programs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-08 02:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/mod.rs</code>:921 on 2024-03-08 02:20</div>
            <div class="timeline-body"><p>Same as above. The error messages will possibly be improved with new invalid program test cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-08 02:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:256 on 2024-03-08 02:20</div>
            <div class="timeline-body"><p>In a follow-up PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-08 02:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:361 on 2024-03-08 02:21</div>
            <div class="timeline-body"><p>Probably not required as we discussed to move &quot;soft&quot; syntax errors into the linter.</p>
<p>(There are other TODOs in this PR)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-08 02:36</div>
            <div class="timeline-body"><p>Clippy says that <code>at_expr_end</code> isn't used but it'll be used at a later stage. So, ignore that for now. There are no other clippy errors apart from this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dhruvmanila on 2024-03-08 02:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2024-03-08 02:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:446 on 2024-03-08 08:16</div>
            <div class="timeline-body"><p>This is excellent</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/other/f_string_element.rs</code>:40 on 2024-03-08 08:18</div>
            <div class="timeline-body"><p>Is this intentional? You don't have to reply to this comment. I just want to double check that it is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:600 on 2024-03-08 08:21</div>
            <div class="timeline-body"><p>I recommend using <code>parse_comma_separated_list</code> here because I don't know if the compiler recognize that it can directly move the elements into <code>slices</code> without cloning the expressions (which is what <code>extend_from_slice</code> does internally).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:531 on 2024-03-08 08:24</div>
            <div class="timeline-body"><p>This is not related to this PR and more feedback for myself. I just had to navigate to the definition to figure out what the meaning of <code>true</code> is here. I don't think it's a problem in IDEs but it's difficult to know the meaning when reading the code. Two suggestions (for a separate PR)</p>
<ul>
<li>Create an enum <code>TrailingComma</code> with variants <code>Allowed</code>, <code>Forbidden</code></li>
<li>We could move it into <code>RecoveryContextKind</code> because it should be the same in all places where we use the same kind.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:1284 on 2024-03-08 08:25</div>
            <div class="timeline-body"><p>Nit: Use <code>parse_comma_separated_list</code> to avoid cloning the list elements.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:1310 on 2024-03-08 08:26</div>
            <div class="timeline-body"><p>Nit: Use <code>parse_comma_separated_list</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/pattern.rs</code>:230 on 2024-03-08 08:32</div>
            <div class="timeline-body"><p>What's the motivation for early returning when we see a <code>{}</code>. Doesn't the <code>parse_comma_separated_list</code> handle this automatically for us because it exits the loop immediately when seeing the <code>}</code> (list terminator)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/pattern.rs</code>:355 on 2024-03-08 08:32</div>
            <div class="timeline-body"><p>Thank you :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/mod.rs</code>:480 on 2024-03-08 08:36</div>
            <div class="timeline-body"><p>Nit: I'm happy to go with what we have today. I just want to throw this out here in case you like this more: How about <code>parse_list</code> (parses into a vec) and <code>parse_list_items</code> (only parses the items). Although the difference is probably to subtle.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/mod.rs</code>:564 on 2024-03-08 08:38</div>
            <div class="timeline-body"><p>Yeah I think that's true by having a <code>while !self.at(TokenKind::EndOfFile) {}</code>. I'm just a big fan of <code>loop</code> :D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/mod.rs</code>:746 on 2024-03-08 08:39</div>
            <div class="timeline-body"><p>Thank you for writing all this documentation. That's very helpful!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/mod.rs</code>:716 on 2024-03-08 08:42</div>
            <div class="timeline-body"><p>Nit: I don't think that's still needed, I should have removed it. I experimented with directly casting between kind and the bitflags and that requires a repr but we don't do this anymore.</p>
<pre><code class="language-suggestion"></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/mod.rs</code>:921 on 2024-03-08 08:45</div>
            <div class="timeline-body"><p>Makes sense. What is unclear to me is if we should have a dedicated variant for each possible syntax error in <code>ParseErrorType</code> instead of using <code>OtherError</code> for everything. But that's nothing that we need to change in this PR. More something to think about.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-03-08 08:46</div>
            <div class="timeline-body"><p>This is great! Thanks for your careful work.</p>
<p>It might be worth running a perf benchmark as part of the test plan for now until we get CodeSpeed reports. Just to make sure we don't introduce any significant perf regressions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-08 17:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/mod.rs</code>:921 on 2024-03-08 17:27</div>
            <div class="timeline-body"><p>Yeah, I do plan to take a closer look at the error types in another PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-08 17:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/pattern.rs</code>:230 on 2024-03-08 17:38</div>
            <div class="timeline-body"><p>Not much, mainly that it's good to have. Plus I saw this pattern elsewhere so thought it made sense here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-08 17:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/mod.rs</code>:564 on 2024-03-08 17:42</div>
            <div class="timeline-body"><p>Yeah, I like the <code>loop</code> version myself, just want consistency so that it's easier to understand both as they're similar :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2024-03-08 17:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-03-08 17:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-03-08 17:52</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 22:47:55 UTC
    </footer>
</body>
</html>
