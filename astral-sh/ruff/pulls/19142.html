<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Use RHS inferred type for bare `Final` symbols - astral-sh/ruff #19142</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Use RHS inferred type for bare <code>Final</code> symbols</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19142">#19142</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-07-04 08:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body">Summary
<p>Infer the type of symbols with a <code>Final</code> qualifier as their right-hand-side inferred type:</p>
<pre><code>x: Final = 1
y: Final[int] = 1

def _():
    reveal_type(x)  # previously: Unknown, now: Literal[1]
    reveal_type(y)  # int, same as before
</code></pre>
<p>Part of <a href="https://github.com/astral-sh/ty/issues/158">astral-sh/ty#158</a></p>
Ecosystem analysis
aiohttp
<pre><code>aiohttp (https://github.com/aio-libs/aiohttp)
+ error[invalid-argument-type] aiohttp/compression_utils.py:131:54: Argument to bound method `__init__` is incorrect: Expected `ZLibBackendProtocol`, found `&lt;module &#x27;zlib&#x27;&gt;`
</code></pre>
<p>This code <a href="https://github.com/aio-libs/aiohttp/blob/a83597fa88be7ac7dd5f6081d236d751cb40fe4d/aiohttp/compression_utils.py#L52-L77">creates a protocol</a> that looks like</p>
<pre><code>class ZLibBackendProtocol(Protocol):
    Z_FULL_FLUSH: int
    Z_SYNC_FLUSH: int
    # more fieldsâ€¦
</code></pre>
<p>It then <a href="https://github.com/aio-libs/aiohttp/blob/a83597fa88be7ac7dd5f6081d236d751cb40fe4d/aiohttp/compression_utils.py#L131">tries to assign</a> the module literal <code>zlib</code> to that protocol. Howefer, in typeshed, these <code>zlib</code> members are annotated like this:</p>
<pre><code>Z_FULL_FLUSH: Final = 3
Z_SYNC_FLUSH: Final = 2
</code></pre>
<p>With the proposed change here, we now infer these as <code>Literal[3]</code> / <code>Literal[2]</code>. Since protocol members have to be assignable both ways (invariance), we do not consider <code>zlib</code> assignable to this protocol anymore.</p>
<p>That seems rather unfortunate. Not sure who is to blame here? That <code>ZLibBackendProtocol</code> protocol should probably not annotate the members with <code>int</code>, given that <code>typeshed</code> doesn&#x27;t use an explicit annotation here either? But what should they do instead? Annotate those fields with <code>Any</code>?</p>
<p>Or is it another case where we should consider literal-widening?</p>
<p>FYI @AlexWaygood</p>
cloud-init
<pre><code>cloud-init (https://github.com/canonical/cloud-init)
+ error[invalid-argument-type] tests/unittests/sources/test_smartos.py:575:32: Argument to function `oct` is incorrect: Expected `SupportsIndex`, found `int | float`
+ error[invalid-argument-type] tests/unittests/sources/test_smartos.py:593:32: Argument to function `oct` is incorrect: Expected `SupportsIndex`, found `int | float`
+ error[invalid-argument-type] tests/unittests/sources/test_smartos.py:647:35: Argument to function `oct` is incorrect: Expected `SupportsIndex`, found `int | float`
</code></pre>
<p>New false positives on expressions like <code>oct(os.stat(legacy_script_f)[stat.ST_MODE])</code>. We now correctly infer <code>stat.ST_MODE</code> as <code>Literal[1]</code>, because in typeshed, it is annotated as <code>ST_MODE: Final = 0</code>. <code>os.stat</code> returns a <code>stat_result</code> which is a tuple subclass. Accessing it at index 0 should return an <code>int</code>, but we currently return <code>int | float</code>, presumably due to missing support for tuple subclasses (FYI @AlexWaygood):</p>
<pre><code>class stat_result(structseq[float], tuple[int, int, int, int, int, int, int, float, float, float]):
</code></pre>
<p>In terms of <code>typing.Final</code>, things are working as expected here.</p>
pywin-32
<p>Many new false positives similar to:</p>
<pre><code>pywin32 (https://github.com/mhammond/pywin32)
+ error[invalid-argument-type] Pythonwin/pywin/docking/DockingBar.py:288:55: Argument to function `LoadCursor` is incorrect: Expected `PyResourceId`, found `Literal[32645]`
</code></pre>
<p>The line in question calls <code>win32api.LoadCursor(0, win32con.IDC_ARROW)</code>. The <code>win32con.IDC_ARROW</code> symbol is annotated as <a href="https://github.com/python/typeshed/blob/2408c028f4f677e0db4eabef0c70e9f6ab33e365/stubs/pywin32/win32/lib/win32con.pyi#L594"><code>IDC_ARROW: Final = 32512</code> in typeshed</a>, but <a href="https://github.com/python/typeshed/blob/2408c028f4f677e0db4eabef0c70e9f6ab33e365/stubs/pywin32/win32/win32api.pyi#L197"><code>LoadCursor</code></a> expects a <a href="https://github.com/python/typeshed/blob/2408c028f4f677e0db4eabef0c70e9f6ab33e365/stubs/pywin32/_win32typing.pyi#L1252"><code>PyResourceId</code></a>, which is an empty class. So.. this seems like a true positive to me, unless that typeshed annotation of <code>IDC_ARROW</code> is meant to imply that the type should be <code>Unknown</code>/<code>Any</code>?</p>
streamlit
<pre><code>streamlit (https://github.com/streamlit/streamlit)
+ error[invalid-argument-type] lib/streamlit/string_util.py:163:37: Argument to bound method `translate` is incorrect: Expected `bytes`, found `bytearray`
</code></pre>
<p>This looks like a true positive? The code calls <code>inp.translate(None, TEXTCHARS)</code>. <code>inp</code> is <code>bytes</code>, and <code>TEXTCHARS</code> is:</p>
<pre><code>TEXTCHARS: Final = bytearray(
    {7, 8, 9, 10, 12, 13, 27} | set(range(0x20, 0x100)) - {0x7F}
)
</code></pre>
<p>~~We now infer this as <code>bytearray</code>, but <code>bytes.translate</code> <a href="https://github.com/python/typeshed/blob/2408c028f4f677e0db4eabef0c70e9f6ab33e365/stdlib/builtins.pyi#L710">expects <code>bytes</code> for its <code>delete</code> parameter</a>. This seems to work at runtime, so maybe the typeshed annotation is wrong?~~ (Edit: this is now fixed in typeshed)</p>
<pre><code>&gt;&gt;&gt; b&quot;abc&quot;.translate(None, bytearray(b&quot;b&quot;))
b&#x27;ac&#x27;
</code></pre>
rotki
<pre><code>+ error[invalid-return-type] rotkehlchen/chain/ethereum/modules/yearn/decoder.py:412:13: Return type does not match returned value: expected `dict[Unknown, str]`, found `dict[Unknown, Literal[&quot;yearn-v1&quot;, &quot;yearn-v2&quot;]]`
</code></pre>
<p>The code in question looks like</p>
<pre><code>    def addresses_to_counterparties(self) -&gt; dict[ChecksumEvmAddress, str]:
        return dict.fromkeys(self.vaults, CPT_BEEFY_FINANCE)
</code></pre>
<p>where <code>CPT_BEEFY_FINANCE: Final = &#x27;beefy_finance&#x27;. We previously inferred the value type of the returned </code>dict<code>as</code>Unknown<code>, and now we infer it as </code>Literal[&quot;beefy_finance&quot;]<code>, which does not match the annotated return type because </code>dict` is invariant in the value type.</p>
<pre><code>+ error[invalid-argument-type] rotkehlchen/tests/unit/decoders/test_curve.py:249:9: Argument is incorrect: Expected `int`, found `FVal`
</code></pre>
<p>There are true positives that were previously silenced through the <code>Unknown</code>.</p>
Test Plan
<p>New Markdown tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-04 08:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-07-04 08:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/resources/mdtest/type_qualifiers/final.md</code>:13 on 2025-07-04 08:53</div>
            <div class="timeline-body"><p>Pretty sure I intended to write <code>FINAL_A: Final[int] = 1</code> here originally :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-04 08:56</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>parso (https://github.com/davidhalter/parso)
-     memo fields = ~49MB
+     memo fields = ~54MB

beartype (https://github.com/beartype/beartype)
- TOTAL MEMORY USAGE: ~97MB
+ TOTAL MEMORY USAGE: ~88MB

black (https://github.com/psf/black)
-     memo metadata = ~8MB
+     memo metadata = ~9MB

rich (https://github.com/Textualize/rich)
-     memo fields = ~117MB
+     memo fields = ~106MB

discord.py (https://github.com/Rapptz/discord.py)
-     memo fields = ~207MB
+     memo fields = ~189MB

hydra-zen (https://github.com/mit-ll-responsible-ai/hydra-zen)
- info[revealed-type] tests/annotations/declarations.py:122:9: Revealed type: `Unknown`
+ info[revealed-type] tests/annotations/declarations.py:122:9: Revealed type: `@Todo(unsupported nested subscript in type[X])`
- info[revealed-type] tests/annotations/declarations.py:233:9: Revealed type: `Unknown`
+ info[revealed-type] tests/annotations/declarations.py:233:9: Revealed type: `@Todo(unsupported nested subscript in type[X])`
- error[invalid-argument-type] tests/annotations/declarations.py:434:26: Argument to function `make_config` is incorrect: Expected `tuple[type[DataClass_], ...]`, found `tuple[type[DataClass], Unknown, &lt;class &#x27;P3&#x27;&gt;, Unknown]`
+ error[invalid-argument-type] tests/annotations/declarations.py:434:26: Argument to function `make_config` is incorrect: Expected `tuple[type[DataClass_], ...]`, found `tuple[type[DataClass], @Todo(unsupported nested subscript in type[X]), &lt;class &#x27;P3&#x27;&gt;, @Todo(unsupported nested subscript in type[X])]`
- warning[unused-ignore-comment] tests/annotations/declarations.py:495:15: Unused blanket `type: ignore` directive
- warning[unused-ignore-comment] tests/annotations/declarations.py:859:31: Unused blanket `type: ignore` directive
- warning[unused-ignore-comment] tests/annotations/declarations.py:1238:45: Unused blanket `type: ignore` directive
+ error[no-matching-overload] tests/annotations/declarations.py:1237:5: No overload of bound method `builds` matches arguments
+ error[no-matching-overload] tests/annotations/declarations.py:1436:5: No overload of bound method `builds` matches arguments
- warning[unused-ignore-comment] tests/annotations/declarations.py:1434:47: Unused blanket `type: ignore` directive
- warning[unused-ignore-comment] tests/annotations/declarations.py:1435:51: Unused blanket `type: ignore` directive
- Found 599 diagnostics
+ Found 596 diagnostics
- TOTAL MEMORY USAGE: ~88MB
+ TOTAL MEMORY USAGE: ~97MB

pylox (https://github.com/sco1/pylox)
-     memo fields = ~49MB
+     memo fields = ~54MB

cloud-init (https://github.com/canonical/cloud-init)
+ error[invalid-argument-type] tests/unittests/sources/test_smartos.py:575:32: Argument to function `oct` is incorrect: Expected `SupportsIndex`, found `int | float`
+ error[invalid-argument-type] tests/unittests/sources/test_smartos.py:593:32: Argument to function `oct` is incorrect: Expected `SupportsIndex`, found `int | float`
+ error[invalid-argument-type] tests/unittests/sources/test_smartos.py:647:35: Argument to function `oct` is incorrect: Expected `SupportsIndex`, found `int | float`
- Found 663 diagnostics
+ Found 666 diagnostics

pwndbg (https://github.com/pwndbg/pwndbg)
- warning[unused-ignore-comment] pwndbg/dbg/gdb/symbol.py:188:57: Unused blanket `type: ignore` directive
- Found 2274 diagnostics
+ Found 2273 diagnostics

dragonchain (https://github.com/dragonchain/dragonchain)
-     memo fields = ~80MB
+     memo fields = ~88MB

scrapy (https://github.com/scrapy/scrapy)
-     memo fields = ~207MB
+     memo fields = ~189MB

pywin32 (https://github.com/mhammond/pywin32)
+ error[invalid-argument-type] Pythonwin/pywin/Demos/dlgtest.py:111:56: Argument to bound method `CreateWindow` is incorrect: Expected `PyCWnd | None`, found `int`
+ error[invalid-argument-type] Pythonwin/pywin/docking/DockingBar.py:91:41: Argument to function `LoadCursor` is incorrect: Expected `PyResourceId`, found `Literal[32512]`
+ error[invalid-argument-type] Pythonwin/pywin/docking/DockingBar.py:288:55: Argument to function `LoadCursor` is incorrect: Expected `PyResourceId`, found `Literal[32645]`
+ error[invalid-argument-type] Pythonwin/pywin/docking/DockingBar.py:290:55: Argument to function `LoadCursor` is incorrect: Expected `PyResourceId`, found `Literal[32644]`
+ error[invalid-argument-type] Pythonwin/pywin/framework/scriptutils.py:63:28: Argument to function `CreateFileDialog` is incorrect: Expected `str | None`, found `Literal[4098]`
+ error[invalid-argument-type] Pythonwin/pywin/framework/scriptutils.py:426:28: Argument to function `CreateFileDialog` is incorrect: Expected `str | None`, found `Literal[4098]`
+ error[invalid-argument-type] Pythonwin/pywin/framework/sgrepmdi.py:445:28: Argument to function `CreateFileDialog` is incorrect: Expected `str | None`, found `Literal[2]`
+ error[invalid-argument-type] com/win32com/client/tlbrowse.py:78:55: Argument to function `CreateFileDialog` is incorrect: Expected `str | None`, found `Literal[4098]`
+ error[invalid-argument-type] com/win32com/server/register.py:33:26: Argument to function `RegSetValue` is incorrect: Expected `PyHKEY`, found `Unknown | Literal[-2147483648]`
+ error[invalid-argument-type] com/win32com/server/register.py:49:31: Argument to function `RegDeleteKey` is incorrect: Expected `PyHKEY`, found `Unknown | Literal[-2147483648]`
- error[invalid-argument-type] com/win32com/test/testClipboard.py:139:26: Argument to bound method `GetData` is incorrect: Expected `PyFORMATETC`, found `tuple[Unknown, None, int, Literal[-1], int]`
+ error[invalid-argument-type] com/win32com/test/testClipboard.py:139:26: Argument to bound method `GetData` is incorrect: Expected `PyFORMATETC`, found `tuple[Literal[1], None, int, Literal[-1], int]`
+ error[invalid-argument-type] win32/Demos/RegCreateKeyTransacted.py:11:5: Argument to function `RegCreateKeyEx` is incorrect: Expected `PyHKEY`, found `Literal[-2147483647]`
+ error[invalid-argument-type] win32/Demos/RegCreateKeyTransacted.py:22:5: Argument to function `RegOpenKeyTransacted` is incorrect: Expected `PyHKEY`, found `Literal[-2147483647]`
+ error[invalid-argument-type] win32/Demos/RegCreateKeyTransacted.py:60:23: Argument to function `RegDeleteKey` is incorrect: Expected `PyHKEY`, found `Literal[-2147483647]`
- error[invalid-argument-type] win32/Demos/RegRestoreKey.py:30:61: Argument to function `AdjustTokenPrivileges` is incorrect: Expected `PyTOKEN_PRIVILEGES`, found `tuple[tuple[int, Unknown], tuple[int, Unknown]]`
+ error[invalid-argument-type] win32/Demos/RegRestoreKey.py:30:61: Argument to function `AdjustTokenPrivileges` is incorrect: Expected `PyTOKEN_PRIVILEGES`, found `tuple[tuple[int, Literal[2]], tuple[int, Literal[2]]]`
+ error[invalid-argument-type] win32/Demos/RegRestoreKey.py:38:9: Argument to function `RegCreateKeyEx` is incorrect: Expected `PyHKEY`, found `Literal[-2147483647]`
+ error[invalid-argument-type] win32/Demos/RegRestoreKey.py:62:9: Argument to function `RegCreateKeyEx` is incorrect: Expected `PyHKEY`, found `Literal[-2147483647]`
- error[invalid-argument-type] win32/Demos/security/account_rights.py:25:44: Argument to function `AdjustTokenPrivileges` is incorrect: Expected `PyTOKEN_PRIVILEGES`, found `tuple[tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown]]`
+ error[invalid-argument-type] win32/Demos/security/account_rights.py:25:44: Argument to function `AdjustTokenPrivileges` is incorrect: Expected `PyTOKEN_PRIVILEGES`, found `tuple[tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]]]`
- error[invalid-argument-type] win32/Demos/security/explicit_entries.py:46:44: Argument to function `AdjustTokenPrivileges` is incorrect: Expected `PyTOKEN_PRIVILEGES`, found `tuple[tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown]]`
+ error[invalid-argument-type] win32/Demos/security/explicit_entries.py:46:44: Argument to function `AdjustTokenPrivileges` is incorrect: Expected `PyTOKEN_PRIVILEGES`, found `tuple[tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]]]`
- error[invalid-argument-type] win32/Demos/security/list_rights.py:25:44: Argument to function `AdjustTokenPrivileges` is incorrect: Expected `PyTOKEN_PRIVILEGES`, found `tuple[tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown]]`
+ error[invalid-argument-type] win32/Demos/security/list_rights.py:25:44: Argument to function `AdjustTokenPrivileges` is incorrect: Expected `PyTOKEN_PRIVILEGES`, found `tuple[tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]]]`
- error[invalid-argument-type] win32/Demos/security/regsave_sa.py:37:44: Argument to function `AdjustTokenPrivileges` is incorrect: Expected `PyTOKEN_PRIVILEGES`, found `tuple[tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown]]`
+ error[invalid-argument-type] win32/Demos/security/regsave_sa.py:37:44: Argument to function `AdjustTokenPrivileges` is incorrect: Expected `PyTOKEN_PRIVILEGES`, found `tuple[tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]]]`
- error[invalid-argument-type] win32/Demos/security/regsecurity.py:21:44: Argument to function `AdjustTokenPrivileges` is incorrect: Expected `PyTOKEN_PRIVILEGES`, found `tuple[tuple[int, Unknown], tuple[int, Unknown]]`
+ error[invalid-argument-type] win32/Demos/security/regsecurity.py:21:44: Argument to function `AdjustTokenPrivileges` is incorrect: Expected `PyTOKEN_PRIVILEGES`, found `tuple[tuple[int, Literal[2]], tuple[int, Literal[2]]]`
- error[invalid-argument-type] win32/Demos/security/set_file_audit.py:34:61: Argument to function `AdjustTokenPrivileges` is incorrect: Expected `PyTOKEN_PRIVILEGES`, found `tuple[tuple[int, Unknown], tuple[int, Unknown]]`
+ error[invalid-argument-type] win32/Demos/security/set_file_audit.py:34:61: Argument to function `AdjustTokenPrivileges` is incorrect: Expected `PyTOKEN_PRIVILEGES`, found `tuple[tuple[int, Literal[2]], tuple[int, Literal[2]]]`
- error[invalid-argument-type] win32/Demos/security/set_file_owner.py:43:44: Argument to function `AdjustTokenPrivileges` is incorrect: Expected `PyTOKEN_PRIVILEGES`, found `tuple[tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown]]`
+ error[invalid-argument-type] win32/Demos/security/set_file_owner.py:43:44: Argument to function `AdjustTokenPrivileges` is incorrect: Expected `PyTOKEN_PRIVILEGES`, found `tuple[tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]]]`
- error[invalid-argument-type] win32/Demos/security/setnamedsecurityinfo.py:75:44: Argument to function `AdjustTokenPrivileges` is incorrect: Expected `PyTOKEN_PRIVILEGES`, found `tuple[tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown]]`
+ error[invalid-argument-type] win32/Demos/security/setnamedsecurityinfo.py:75:44: Argument to function `AdjustTokenPrivileges` is incorrect: Expected `PyTOKEN_PRIVILEGES`, found `tuple[tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]]]`
- error[invalid-argument-type] win32/Demos/security/setsecurityinfo.py:74:56: Argument to function `AdjustTokenPrivileges` is incorrect: Expected `PyTOKEN_PRIVILEGES`, found `tuple[tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown]]`
+ error[invalid-argument-type] win32/Demos/security/setsecurityinfo.py:74:56: Argument to function `AdjustTokenPrivileges` is incorrect: Expected `PyTOKEN_PRIVILEGES`, found `tuple[tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]]]`
- error[invalid-argument-type] win32/Demos/security/setuserobjectsecurity.py:74:44: Argument to function `AdjustTokenPrivileges` is incorrect: Expected `PyTOKEN_PRIVILEGES`, found `tuple[tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown], tuple[int, Unknown]]`
+ error[invalid-argument-type] win32/Demos/security/setuserobjectsecurity.py:74:44: Argument to function `AdjustTokenPrivileges` is incorrect: Expected `PyTOKEN_PRIVILEGES`, found `tuple[tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]], tuple[int, Literal[2]]]`
- error[too-many-positional-arguments] win32/Demos/service/pipeTestService.py:94:67: Too many positional arguments to function `GetNamedPipeHandleState`: expected 2, got 3
- warning[possibly-unresolved-reference] win32/Demos/service/pipeTestService.py:94:82: Name `d` used when possibly not defined
- error[invalid-argument-type] win32/Demos/win32gui_menu.py:147:35: Argument to function `Shell_NotifyIcon` is incorrect: Expected `PyNOTIFYICONDATA`, found `tuple[Unknown, Literal[0], int, Unknown, PyGdiHANDLE | PyWNDCLASS, Literal[&quot;Python Demo&quot;]]`
+ error[invalid-argument-type] win32/Demos/win32gui_menu.py:147:35: Argument to function `Shell_NotifyIcon` is incorrect: Expected `PyNOTIFYICONDATA`, found `tuple[Unknown, Literal[0], int, Literal[1044], PyGdiHANDLE | PyWNDCLASS, Literal[&quot;Python Demo&quot;]]`
+ error[invalid-argument-type] win32/Demos/win32gui_taskbar.py:26:45: Argument to function `LoadCursor` is incorrect: Expected `PyResourceId`, found `Literal[32512]`
- error[invalid-argument-type] win32/Demos/win32gui_taskbar.py:78:57: Argument to function `Shell_NotifyIcon` is incorrect: Expected `PyNOTIFYICONDATA`, found `tuple[Unknown, Literal[0], int, Unknown, PyGdiHANDLE | PyWNDCLASS, Literal[&quot;Python Demo&quot;]]`
+ error[invalid-argument-type] win32/Demos/win32gui_taskbar.py:78:57: Argument to function `Shell_NotifyIcon` is incorrect: Expected `PyNOTIFYICONDATA`, found `tuple[Unknown, Literal[0], int, Literal[1044], PyGdiHANDLE | PyWNDCLASS, Literal[&quot;Python Demo&quot;]]`
+ error[invalid-argument-type] win32/Lib/regutil.py:297:9: Argument to function `RegSetValue` is incorrect: Expected `PyHKEY`, found `Literal[-2147483648]`
+ error[invalid-argument-type] win32/Lib/regutil.py:300:9: Argument to function `RegSetValue` is incorrect: Expected `PyHKEY`, found `Literal[-2147483648]`
+ error[invalid-argument-type] win32/Lib/regutil.py:303:9: Argument to function `RegSetValue` is incorrect: Expected `PyHKEY`, found `Literal[-2147483648]`
+ error[invalid-argument-type] win32/Lib/regutil.py:309:9: Argument to function `RegSetValue` is incorrect: Expected `PyHKEY`, found `Literal[-2147483648]`
+ error[invalid-argument-type] win32/Lib/regutil.py:316:9: Argument to function `RegSetValue` is incorrect: Expected `PyHKEY`, found `Literal[-2147483648]`
+ error[invalid-argument-type] win32/Lib/regutil.py:319:9: Argument to function `RegSetValue` is incorrect: Expected `PyHKEY`, found `Literal[-2147483648]`
+ error[invalid-argument-type] win32/Lib/regutil.py:328:9: Argument to function `RegSetValue` is incorrect: Expected `PyHKEY`, found `Literal[-2147483648]`
+ error[invalid-argument-type] win32/Lib/regutil.py:331:9: Argument to function `RegSetValue` is incorrect: Expected `PyHKEY`, found `Literal[-2147483648]`
+ error[invalid-argument-type] win32/Lib/regutil.py:337:9: Argument to function `RegSetValue` is incorrect: Expected `PyHKEY`, found `Literal[-2147483648]`
+ error[invalid-argument-type] win32/Lib/regutil.py:344:9: Argument to function `RegSetValue` is incorrect: Expected `PyHKEY`, found `Literal[-2147483648]`
+ error[invalid-argument-type] win32/Lib/regutil.py:347:9: Argument to function `RegSetValue` is incorrect: Expected `PyHKEY`, found `Literal[-2147483648]`
+ error[invalid-argument-type] win32/Lib/regutil.py:362:13: Argument to function `RegSetValue` is incorrect: Expected `PyHKEY`, found `Literal[-2147483648]`
+ error[invalid-argument-type] win32/Lib/regutil.py:369:9: Argument to function `RegSetValue` is incorrect: Expected `PyHKEY`, found `Literal[-2147483648]`
+ error[invalid-argument-type] win32/Lib/regutil.py:379:9: Argument to function `RegSetValue` is incorrect: Expected `PyHKEY`, found `Literal[-2147483648]`
+ error[invalid-argument-type] win32/Lib/regutil.py:385:9: Argument to function `RegSetValue` is incorrect: Expected `PyHKEY`, found `Literal[-2147483648]`
+ error[invalid-argument-type] win32/Lib/regutil.py:391:9: Argument to function `RegSetValue` is incorrect: Expected `PyHKEY`, found `Literal[-2147483648]`
+ error[invalid-argument-type] win32/Lib/win32evtlogutil.py:99:13: Argument to function `RegDeleteKey` is incorrect: Expected `PyHKEY`, found `Literal[-2147483646]`
+ error[invalid-argument-type] win32/scripts/regsetup.py:213:59: Argument to function `CreateFileDialog` is incorrect: Expected `str | None`, found `Literal[4096]`
+ error[invalid-argument-type] win32/test/test_win32api.py:80:39: Argument to function `RegDeleteKey` is incorrect: Expected `PyHKEY`, found `Literal[-2147483647]`
+ error[invalid-argument-type] win32/test/test_win32api.py:123:39: Argument to function `RegDeleteKey` is incorrect: Expected `PyHKEY`, found `Literal[-2147483647]`
+ error[invalid-argument-type] win32/test/test_win32api.py:131:13: Argument to function `RegNotifyChangeKeyValue` is incorrect: Expected `PyHKEY`, found `Literal[-2147483647]`
- Found 1973 diagnostics
+ Found 2008 diagnostics

pytest (https://github.com/pytest-dev/pytest)
- TOTAL MEMORY USAGE: ~276MB
+ TOTAL MEMORY USAGE: ~251MB

psycopg (https://github.com/psycopg/psycopg)
-     memo fields = ~171MB
+     memo fields = ~189MB

pandas-stubs (https://github.com/pandas-dev/pandas-stubs)
-     memo metadata = ~28MB
+     memo metadata = ~30MB

aiohttp (https://github.com/aio-libs/aiohttp)
+ error[invalid-argument-type] aiohttp/compression_utils.py:131:54: Argument to bound method `__init__` is incorrect: Expected `ZLibBackendProtocol`, found `&lt;module &#x27;zlib&#x27;&gt;`
- Found 176 diagnostics
+ Found 177 diagnostics

openlibrary (https://github.com/internetarchive/openlibrary)
-     memo fields = ~189MB
+     memo fields = ~171MB

scikit-learn (https://github.com/scikit-learn/scikit-learn)
-     memo fields = ~593MB
+     memo fields = ~539MB

rotki (https://github.com/rotki/rotki)
+ error[invalid-return-type] rotkehlchen/chain/ethereum/modules/yearn/decoder.py:412:13: Return type does not match returned value: expected `dict[Unknown, str]`, found `dict[Unknown, Literal[&quot;yearn-v1&quot;, &quot;yearn-v2&quot;]]`
+ error[invalid-return-type] rotkehlchen/chain/evm/decoding/aave/v2/decoder.py:138:16: Return type does not match returned value: expected `dict[Unknown, str]`, found `dict[Unknown, Literal[&quot;aave-v2&quot;]]`
+ error[invalid-return-type] rotkehlchen/chain/evm/decoding/beefy_finance/decoder.py:204:16: Return type does not match returned value: expected `dict[Unknown, str]`, found `dict[Unknown, Literal[&quot;beefy_finance&quot;]]`
+ error[invalid-return-type] rotkehlchen/chain/evm/decoding/compound/v3/decoder.py:408:16: Return type does not match returned value: expected `dict[Unknown, str]`, found `dict[Unknown, Literal[&quot;compound-v3&quot;]]`
+ error[invalid-return-type] rotkehlchen/chain/evm/decoding/llamazip/decoder.py:81:16: Return type does not match returned value: expected `dict[Unknown, str]`, found `dict[Unknown, Literal[&quot;llamazip&quot;]]`
+ error[invalid-return-type] rotkehlchen/chain/evm/decoding/morpho/decoder.py:330:16: Return type does not match returned value: expected `dict[Unknown, str]`, found `dict[Unknown, Literal[&quot;morpho&quot;]]`
+ error[invalid-return-type] rotkehlchen/chain/evm/decoding/uniswap/v3/decoder.py:596:16: Return type does not match returned value: expected `dict[Unknown, str]`, found `dict[Unknown, Literal[&quot;uniswap-v3&quot;]]`
+ error[invalid-return-type] rotkehlchen/chain/evm/decoding/zerox/decoder.py:294:16: Return type does not match returned value: expected `dict[Unknown, str]`, found `dict[Unknown, Literal[&quot;0x&quot;]]`
+ error[invalid-argument-type] rotkehlchen/tests/unit/decoders/test_curve.py:249:9: Argument is incorrect: Expected `int`, found `FVal`
+ error[invalid-argument-type] rotkehlchen/tests/unit/decoders/test_curve.py:565:9: Argument is incorrect: Expected `int`, found `FVal`
- warning[unused-ignore-comment] rotkehlchen/tests/unit/globaldb/test_upgrades.py:125:68: Unused blanket `type: ignore` directive
- warning[unused-ignore-comment] rotkehlchen/tests/unit/globaldb/test_upgrades.py:231:68: Unused blanket `type: ignore` directive
- warning[unused-ignore-comment] rotkehlchen/tests/unit/globaldb/test_upgrades.py:359:68: Unused blanket `type: ignore` directive
- warning[unused-ignore-comment] rotkehlchen/tests/unit/globaldb/test_upgrades.py:471:68: Unused blanket `type: ignore` directive
- warning[unused-ignore-comment] rotkehlchen/tests/unit/globaldb/test_upgrades.py:554:68: Unused blanket `type: ignore` directive
- warning[unused-ignore-comment] rotkehlchen/tests/unit/globaldb/test_upgrades.py:695:68: Unused blanket `type: ignore` directive
- warning[unused-ignore-comment] rotkehlchen/tests/unit/globaldb/test_upgrades.py:823:68: Unused blanket `type: ignore` directive
- warning[unused-ignore-comment] rotkehlchen/tests/unit/globaldb/test_upgrades.py:889:68: Unused blanket `type: ignore` directive
- warning[unused-ignore-comment] rotkehlchen/tests/unit/globaldb/test_upgrades.py:937:68: Unused blanket `type: ignore` directive
- warning[unused-ignore-comment] rotkehlchen/tests/unit/globaldb/test_upgrades.py:1021:68: Unused blanket `type: ignore` directive
- warning[unused-ignore-comment] rotkehlchen/tests/unit/globaldb/test_upgrades.py:1133:68: Unused blanket `type: ignore` directive
- warning[unused-ignore-comment] rotkehlchen/tests/unit/globaldb/test_upgrades.py:1217:98: Unused blanket `type: ignore` directive
- warning[unused-ignore-comment] rotkehlchen/tests/unit/globaldb/test_upgrades.py:1247:64: Unused blanket `type: ignore` directive
- Found 1728 diagnostics
+ Found 1725 diagnostics

</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-04 08:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-04 10:25</div>
            <div class="timeline-body"><blockquote>
<p>With the proposed change here, we now infer these as <code>Literal[3]</code> / <code>Literal[2]</code>. Since protocol members have to be assignable both ways (invariance), we do not consider <code>zlib</code> assignable to this protocol anymore.</p>
<p>That seems rather unfortunate. Not sure who is to blame here? That <code>ZLibBackendProtocol</code> protocol should probably not annotate the members with <code>int</code>, given that <code>typeshed</code> doesn&#x27;t use an explicit annotation here either? But what should they do instead? Annotate those fields with <code>Any</code>?</p>
<p>Or is it another case where we should consider literal-widening?</p>
</blockquote>
<p>I think our behaviour is correct here. Even if we put aside the issue of variance, the module still shouldn&#x27;t satisfy <code>ZLibBackendProtocol</code>, because the protocol declares <code>Z_FULL_FLUSH</code> and <code>Z_SYNC_FLUSH</code> as mutable attribute members -- but because these members are declared as <code>Final</code> in the module, they therefore cannot be reassigned on the class, so they are immutable, so they should not satisfy the protocol interface. (We don&#x27;t yet look at qualifiers when deciding subtyping/assignability of types to protocol types, but we&#x27;ll need to in due course.)</p>
<p>For the module to satisfy the protocol, either the members on the module would need to be made mutable (and declared as <code>int</code> if the author wants precise types), e.g.</p>
<pre><code>- Z_FULL_FLUSH: Final = 3
- Z_SYNC_FLUSH: Final = 2
+ Z_FULL_FLUSH: int = 3
+ Z_SYNC_FLUSH: int = 2
</code></pre>
<p>or the protocol would need to be changed so that it uses immutable, covariant members rather than mutable, invariant members. The only way to do that on a protocol currently (at least until https://peps.python.org/pep-0767/ is approved) is to use <code>@property</code> members:</p>
<pre><code>  class ZLibBackendProtocol(Protocol):
-     Z_FULL_FLUSH: int
-     Z_SYNC_FLUSH: int
+     @property
+     def Z_FULL_FLUSH(self) -&gt; int: ...
+     @property
+     def Z_SYNC_FLUSH(self) -&gt; int: ...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-04 10:27</div>
            <div class="timeline-body"><blockquote>
<p>So.. this seems like a true positive to me, unless that typeshed annotation of <code>IDC_ARROW</code> is meant to imply that the type should be <code>Unknown</code>/<code>Any</code>?</p>
</blockquote>
<p>yeah, that does sound like a true positive. Possibly a typeshed bug?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-04 10:30</div>
            <div class="timeline-body"><blockquote>
<p>We now infer this as <code>bytearray</code>, but <code>bytes.translate</code> <a href="https://github.com/python/typeshed/blob/2408c028f4f677e0db4eabef0c70e9f6ab33e365/stdlib/builtins.pyi#L710">expects <code>bytes</code> for its <code>delete</code> parameter</a>. This seems to work at runtime, so maybe the typeshed annotation is wrong?</p>
<pre><code>&gt;&gt;&gt; b&quot;abc&quot;.translate(None, bytearray(b&quot;b&quot;))
b&#x27;ac&#x27;
</code></pre>
</blockquote>
<p>That sounds like a typeshed bug, yes. I think it&#x27;s probably a remnant of a special case that used to exist in the type system, but now no longer does, where <code>bytes</code> in a type expression would be interpreted in a similar way to <code>bytes | bytearray | memoryview</code> by type checkers in some situations (similar to the special case that still exists for <code>float</code>/<code>int</code>/<code>complex</code>). See https://peps.python.org/pep-0688 for details.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[ty] Use inferred type for `Final` symbols&quot; to &quot;[ty] Use RHS inferred type for bare `Final` symbols&quot; by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-07 09:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> removed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-07 09:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-07 10:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-07 10:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-07 10:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-07 10:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-07 10:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/place.rs</code>:540 on 2025-07-07 10:57</div>
            <div class="timeline-body"><p>Does this mean that we would consider <code>x</code> to be &quot;qualified with bare <code>Final</code>&quot; here?</p>
<pre><code>from ty_extensions import Unknown
from typing import Final

x: Final[Unknown]
</code></pre>
<p>I think that&#x27;s okay if so; people just shouldn&#x27;t do that ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-07-07 10:58</div>
            <div class="timeline-body"><p>nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-07-07 11:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/place.rs</code>:540 on 2025-07-07 11:16</div>
            <div class="timeline-body"><p>Yes, well spotted :smile:. I agree that it&#x27;s not as clean as it could be. The alternative is much more complicated as it requires us to return <code>Option&lt;Type&gt;</code> and <code>TypeQualifiers</code> instead of just <code>Type</code> and <code>TypeQualifiers</code> from <code>infer_annotation_expression</code> and related methods (such that we could return <code>None</code> for a bare <code>Final</code> or <code>ClassVar</code>), which has a lot of downstream consequences.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-07 11:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-07 11:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-07 11:16</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:16:16 UTC
    </footer>
</body>
</html>
