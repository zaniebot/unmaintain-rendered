<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update rule selection to respect preview mode - astral-sh/ruff #7195</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Update rule selection to respect preview mode</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7195">#7195</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2023-09-06 15:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<!-- What's the purpose of the change? What does it do, and why? -->

<p>Extends work in #7046 (some relevant discussion there)</p>
<p>Changes:</p>
<ul>
<li>All nursery rules are now referred to as preview rules</li>
<li>Documentation for the nursery is updated to describe preview</li>
<li>Adds a &quot;PREVIEW&quot; selector for preview rules<ul>
<li>This is primarily to allow <code>--preview --ignore PREVIEW --extend-select FOO001,BAR200</code></li>
</ul>
</li>
<li>Using <code>--preview</code> enables preview rules that match selectors</li>
</ul>
<p>Notable decisions:</p>
<ul>
<li>Preview rules are not selectable by their rule code without enabling preview</li>
<li>Retains the &quot;NURSERY&quot; selector for backwards compatibility</li>
<li>Nursery rules are selectable by their rule code for backwards compatiblity</li>
</ul>
<p>Additional work:</p>
<ul>
<li>Selection of preview rules without the &quot;--preview&quot; flag should display a warning</li>
<li>Use of deprecated nursery selection behavior should display a warning</li>
<li>Nursery selection should be removed after some time</li>
</ul>
<h2>Test Plan</h2>
<!-- How was it tested? -->

<p>Manual confirmation (i.e. we don't have an preview rules yet just nursery rules so I added a preview rule for manual testing)</p>
<p>New unit tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-09-06 15:22</div>
            <div class="timeline-body"><p>~Note nursery selection backwards compatibility is still a work in progress.~</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2023-09-06 15:41</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/zanie/rule-preview">CodSpeed Performance Report</a></h2>
<h3>Merging #7195 will <strong>degrade performances by 4.4%</strong></h3>
<p><sub>Comparing <code>zanie/rule-preview</code> (6351494) with <code>main</code> (171b66c)</sub></p>
<h3>Summary</h3>
<p><code>‚ùå 4</code> regressions
<code>‚úÖ 21</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/zanie/rule-preview">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>main</code> | <code>zanie/rule-preview</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ‚ùå | <code>linter/all-rules[pydantic/types.py]</code> | 70.5 ms | 72.8 ms | -3.16% |
| ‚ùå | <code>linter/all-rules[large/dataset.py]</code> | 158 ms | 164.8 ms | -4.15% |
| ‚ùå | <code>linter/all-rules[numpy/globals.py]</code> | 4 ms | 4.1 ms | -2.57% |
| ‚ùå | <code>linter/all-rules[numpy/ctypeslib.py]</code> | 33.4 ms | 35 ms | -4.4% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-09-06 16:00</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>‚úÖ ecosystem check detected no changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-09-06 16:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_benchmark/benches/linter.rs</code>:82 on 2023-09-06 16:14</div>
            <div class="timeline-body"><p>Presumably the benchmark regressions are due to including our nursery/preview rules now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-09-06 19:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_benchmark/benches/linter.rs</code>:82 on 2023-09-06 19:05</div>
            <div class="timeline-body"><p>Yep https://github.com/astral-sh/ruff/pull/7195/commits/9522dfbc0119727b3c8ec8a7b0991159c6229c8c ‚Äî I'll do this in a separate PR to avoid blocking this one</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-09-06 19:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_benchmark/benches/linter.rs</code>:82 on 2023-09-06 19:09</div>
            <div class="timeline-body"><p>#7208</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @zanieb on 2023-09-06 21:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_dev/src/generate_docs.rs</code>:48 on 2023-09-07 14:13</div>
            <div class="timeline-body"><p>Is the &quot;explicitly selecting&quot; part still true? I thought this applied to the existing nursery rules for backwards compatibility, but not for preview rules in general?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/codes.rs</code>:59 on 2023-09-07 14:17</div>
            <div class="timeline-body"><p>Can we mark as <code>#[deprecated(...)]</code> to avoid accidental usages in the future?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rule_selector.rs</code>:108 on 2023-09-07 14:18</div>
            <div class="timeline-body"><p>I bet this could be encoded in the type system somehow, this feels awkward (I know that I wrote it lol). Not asking for a change here since it will likely involve more extensive changes in the macro, etc., just expressing that it feels strange.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-09-07 14:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-07 14:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>ruff.schema.json</code>:1898 on 2023-09-07 14:21</div>
            <div class="timeline-body"><p>There is some potential for confusion here that didn't exist in the nursery whereby if a user does<code> --select E11</code> without <code>--preview</code>, we won't throw a hard error. Instead, we'll select no rules and emit no diagnostics (IIUC), though I imagine in the future we'll want to show a warning.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-07 14:22</div>
            <div class="timeline-body"><p>Just confirming (even though it's mentioned in the test plan) that no rules are actually moved to <code>--preview</code> here -- it's only enabling the functionality.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-09-07 14:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_dev/src/generate_docs.rs</code>:48 on 2023-09-07 14:50</div>
            <div class="timeline-body"><p>üëç yep thanks will fix</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-09-07 14:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>ruff.schema.json</code>:1898 on 2023-09-07 14:51</div>
            <div class="timeline-body"><p>Yep #7210 will show a warning</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-09-07 14:51</div>
            <div class="timeline-body"><p>@charliermarsh well all of the nursery rules will be enabled with <code>--preview</code> but yes there are no rules that are preview-only without being in the nursery.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/codes.rs</code>:59 on 2023-09-07 15:13</div>
            <div class="timeline-body"><p>Same for <code>RuleSelector::Nursery</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rule_selector.rs</code>:95 on 2023-09-07 15:14</div>
            <div class="timeline-body"><p>Nit: Should this be a method on <code>RuleCodePrefix</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_cli/src/commands/rule.rs</code>:22 on 2023-09-07 15:17</div>
            <div class="timeline-body"><p>Should we use <code>PreviewMode</code> here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_macros/src/map_codes.rs</code>:133 on 2023-09-07 15:19</div>
            <div class="timeline-body"><p>We could move all of this logic out of the macro if we instead implement <code>impl From&lt;#linter&gt; for RuleCodePrefix</code> because the <code>RuleCodePrefix::#linter(linter)</code> code is the only code that requires code-gen</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-07 15:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_cli/src/commands/rule.rs</code>:22 on 2023-09-07 17:44</div>
            <div class="timeline-body"><p>The rule is in preview and is enabled or disabled by preview mode :D I want to think a bit more about &quot;preview&quot; vs &quot;preview mode&quot; in general so thanks for pointing this out.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-09-07 17:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-09-07 17:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_macros/src/map_codes.rs</code>:133 on 2023-09-07 17:46</div>
            <div class="timeline-body"><p>Interesting. I'd like to separate further changes to the macro from this pull request though, if that's okay?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-09-07 17:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/src/rule_selector.rs</code>:108 on 2023-09-07 17:46</div>
            <div class="timeline-body"><p>I will open a tracking issue once this is merged</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-09-07 17:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/src/rule_selector.rs</code>:95 on 2023-09-07 17:55</div>
            <div class="timeline-body"><p>Yeah maybe but it's in the macro ü§î</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-09-07 23:29</div>
            <div class="timeline-body"><p>I'd like to do a release tomorrow before merging this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/rule_selector.rs</code>:338 on 2023-09-08 03:37</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    /// The specificity when selecting via a rule prefix at three-character depth (e.g., `--select PLE120`).
    Prefix3Chars,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/rule_selector.rs</code>:340 on 2023-09-08 03:37</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    /// The specificity when selecting via a rule prefix at four-character depth (e.g., `--select PLE120`).
    Prefix4Chars,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/rule_selector.rs</code>:334 on 2023-09-08 03:44</div>
            <div class="timeline-body"><p>I got a bit confused with &quot;rule prefix&quot; which made me think of the <em>prefix</em> part of the code i.e., &quot;PLE&quot; in the given example. But I think this is related to the number part, right? Maybe &quot;Suffix1Char&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2023-09-08 03:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-09-08 15:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/src/rule_selector.rs</code>:334 on 2023-09-08 15:26</div>
            <div class="timeline-body"><p>Hm well the specificity is that it's a prefix e.g. including &quot;PLE10&quot; but I agree the character count part is confusing since it just refers to the code length.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-08 15:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_macros/src/map_codes.rs</code>:133 on 2023-09-08 15:33</div>
            <div class="timeline-body"><p>Yeah absolutely. I should have written this more clearly. This is feedback based on last week's discussion on how it probably would be possible to move a lot out of the macros if we abstracted the dynamic parts by traits instead of where we generate the implementations for our types. But this isn't something that concerns this PR. I just noticed it as a good example because the dynamic part is limited to a single line.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-08 15:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rule_selector.rs</code>:95 on 2023-09-08 15:34</div>
            <div class="timeline-body"><p>You can have multiple <code>impl</code> blocks even in different files. For as long as they are all in the same crate. Rust will merge them all together.</p>
<pre><code>// macro generated
impl RuleCodePrefix {
}

// somewhere else 
impl RuleCodePrefix {
	fn is_single_rule_selector(&amp;self) -&gt; bool {
		...
	}
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2023-09-11 17:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2023-09-11 17:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-09-11 17:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @zanieb on 2023-09-11 18:35</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:00:05 UTC
    </footer>
</body>
</html>
