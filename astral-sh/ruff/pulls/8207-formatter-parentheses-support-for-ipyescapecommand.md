```yaml
number: 8207
title: "Formatter parentheses support for `IpyEscapeCommand`"
type: pull_request
state: merged
author: dhruvmanila
labels:
  - bug
  - formatter
assignees: []
merged: true
base: main
head: dhruv/formatter-ipy-todo
created_at: 2023-10-25T09:47:05Z
updated_at: 2023-10-25T14:08:06Z
url: https://github.com/astral-sh/ruff/pull/8207
synced_at: 2026-01-12T02:32:42Z
```

# Formatter parentheses support for `IpyEscapeCommand`

---

_Pull request opened by @dhruvmanila on 2023-10-25 09:47_

## Summary

This PR removes the `todo!()` around `IpyEscapeCommand` in the formatter.

The `NeedsParentheses` trait needs to be implemented which always return `Never`. The reason being that if an escape command is parenthesized, then that's not parsed as an escape command. IOW, the parentheses shouldn't be present around an escape command.

In the similar way, the `CanSkipOptionalParenthesesVisitor` will skip this node.

## Test Plan

Updated the `unformatted.ipynb` fixture with new cells containing IPython escape commands and the corresponding snapshot was verified. Also, tested it out in a few open source repositories containing notebooks (`openai/openai-cookbook`, `huggingface/notebooks`).

#### New cells in `unformatted.ipynb`

**Cell 2**
```markdown
A markdown cell
```

**Cell 3**
```python
def some_function(foo, bar):
    pass
%matplotlib inline
```

**Cell 4**
```python
foo = %pwd
def some_function(foo,bar,):
	foo = %pwd
    print(foo
	)
```

fixes: #8204 

---

_Comment by @dhruvmanila on 2023-10-25 09:47_

Current dependencies on/for this PR:
* main
  * **PR #8205** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8205" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #8207** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8207" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/8207?utm_source=stack-comment).

---

_Marked ready for review by @dhruvmanila on 2023-10-25 10:28_

---

_Label `bug` added by @dhruvmanila on 2023-10-25 10:28_

---

_Label `formatter` added by @dhruvmanila on 2023-10-25 10:28_

---

_Review requested from @MichaReiser by @dhruvmanila on 2023-10-25 10:28_

---

_Review request for @MichaReiser removed by @dhruvmanila on 2023-10-25 10:28_

---

_Review requested from @konstin by @dhruvmanila on 2023-10-25 10:28_

---

_Review requested from @MichaReiser by @dhruvmanila on 2023-10-25 10:29_

---

_@MichaReiser approved on 2023-10-25 10:34_

Looks good to me. Can we add an E2E test (CLI test) in the parent PR that tests `ruff format` with a notebook that contains ipython commands?

---

_Comment by @dhruvmanila on 2023-10-25 13:35_

> Can we add an E2E test (CLI test) in the parent PR that tests `ruff format` with a notebook that contains ipython commands?

Do you mean in this PR? I've added it.

---

_Comment by @github-actions[bot] on 2023-10-25 13:43_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.



---

_@konstin approved on 2023-10-25 13:47_

---

_Closed by @dhruvmanila on 2023-10-25 13:51_

---

_Reopened by @dhruvmanila on 2023-10-25 13:51_

---

_Merged by @dhruvmanila on 2023-10-25 14:01_

---

_Closed by @dhruvmanila on 2023-10-25 14:01_

---

_Branch deleted on 2023-10-25 14:01_

---
