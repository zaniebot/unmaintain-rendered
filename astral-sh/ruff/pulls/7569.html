<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formatter and parser refactoring - astral-sh/ruff #7569</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Formatter and parser refactoring</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7569">#7569</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2023-09-21 11:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><p>I got confused and refactored a bit, now the naming should be more consistent. This is the basis for the range formatting work.</p>
<p>Chages:</p>
<ul>
<li><code>format_module</code> -&gt; <code>format_module_source</code> (format a string)</li>
<li><code>format_node</code> -&gt; <code>format_module_ast</code> (format a program parsed into an AST)</li>
<li>Added <code>parse_ok_tokens</code> that takes <code>Token</code> instead of <code>Result&lt;Token&gt;</code></li>
<li>Call the source code <code>source</code> consistently</li>
<li>Added a <code>tokens_and_ranges</code> helper</li>
<li><code>python_ast</code> -&gt; <code>module</code> (because that&#x27;s the type)</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-09-21 11:33</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #7569</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7569"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a>  ðŸ‘ˆ<ul>
<li><strong>PR #7571</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7571"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7569?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/konstin">@konstin</a> on 2023-09-21 11:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/konstin">@konstin</a> on 2023-09-21 11:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-21 11:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/lib.rs</code>:135 on 2023-09-21 11:39</div>
            <div class="timeline-body"><p>The idea here was that you could pass any node eventually (e.g. a single statement)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-09-21 11:49</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>âœ… ecosystem check detected no changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-26 08:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/lib.rs</code>:135 on 2023-09-26 08:06</div>
            <div class="timeline-body"><p>That makes sense for later, but right now e.g. the comments assume that you have the entire AST present anyway</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/konstin">@konstin</a> on 2023-09-26 08:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2023-09-26 08:17</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/_formatter-and-parser-refactorings">CodSpeed Performance Report</a>
Merging #7569 will <strong>improve performances by 8.46%</strong>
<p>Comparing <code>_formatter-and-parser-refactorings</code> (dd8b124) with <code>main</code> (ab64301)</p>
Summary
<p><code>âš¡ 4</code> improvements
<code>âœ… 21</code> untouched benchmarks</p>
Benchmarks breakdown
<p>|     | Benchmark | <code>main</code> | <code>_formatter-and-parser-refactorings</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| âš¡ | <code>lexer[pydantic/types.py]</code> | 4.1 ms | 4 ms | +3.69% |
| âš¡ | <code>lexer[numpy/ctypeslib.py]</code> | 2 ms | 1.9 ms | +2.55% |
| âš¡ | <code>lexer[unicode/pypinyin.py]</code> | 620 Âµs | 592 Âµs | +4.74% |
| âš¡ | <code>lexer[large/dataset.py]</code> | 9.8 ms | 9 ms | +8.46% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-26 11:03</div>
            <div class="timeline-body"><p>Would you mind summarizing your changes? It would make reviewing this PR easier.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-09-26 12:10</div>
            <div class="timeline-body"><p>updated</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-09-26 13:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/konstin">@konstin</a> on 2023-09-26 13:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/konstin">@konstin</a> on 2023-09-26 13:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-09-26 13:29</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:57:37 UTC
    </footer>
</body>
</html>
