<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Allow enum narrowing for classes that don't override `__eq__` - astral-sh/ruff #22371</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Allow enum narrowing for classes that don't override <code>__eq__</code></h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22371">#22371</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2026-01-04 18:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-04 18:45</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Closes https://github.com/astral-sh/ty/issues/2192.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @charliermarsh on 2026-01-04 18:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-04 18:47</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-04 18:49</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">freqtrade (https://github.com/freqtrade/freqtrade)
- freqtrade/rpc/telegram.py:563:62: error[invalid-key] Unknown key &quot;lock_end_time&quot; for TypedDict `RPCCancelMsg`: Unknown key &quot;lock_end_time&quot;
- freqtrade/rpc/telegram.py:563:62: error[invalid-key] Unknown key &quot;lock_end_time&quot; for TypedDict `RPCExitCancelMsg`: Unknown key &quot;lock_end_time&quot;
- freqtrade/rpc/telegram.py:569:58: error[invalid-key] Unknown key &quot;lock_end_time&quot; for TypedDict `RPCCancelMsg`: Unknown key &quot;lock_end_time&quot;
- freqtrade/rpc/telegram.py:569:58: error[invalid-key] Unknown key &quot;lock_end_time&quot; for TypedDict `RPCExitCancelMsg`: Unknown key &quot;lock_end_time&quot;
- freqtrade/rpc/telegram.py:573:41: error[invalid-key] Unknown key &quot;status&quot; for TypedDict `RPCCancelMsg`: Unknown key &quot;status&quot;
- freqtrade/rpc/telegram.py:573:41: error[invalid-key] Unknown key &quot;status&quot; for TypedDict `RPCExitCancelMsg`: Unknown key &quot;status&quot;
- freqtrade/rpc/telegram.py:576:59: error[invalid-key] Unknown key &quot;status&quot; for TypedDict `RPCCancelMsg`: Unknown key &quot;status&quot;
- freqtrade/rpc/telegram.py:576:59: error[invalid-key] Unknown key &quot;status&quot; for TypedDict `RPCExitCancelMsg`: Unknown key &quot;status&quot;
- freqtrade/rpc/telegram.py:579:59: error[invalid-key] Unknown key &quot;status&quot; for TypedDict `RPCCancelMsg`: Unknown key &quot;status&quot;
- freqtrade/rpc/telegram.py:579:59: error[invalid-key] Unknown key &quot;status&quot; for TypedDict `RPCExitCancelMsg`: Unknown key &quot;status&quot;
- freqtrade/rpc/telegram.py:582:30: error[invalid-key] Unknown key &quot;status&quot; for TypedDict `RPCCancelMsg`: Unknown key &quot;status&quot;
- freqtrade/rpc/telegram.py:582:30: error[invalid-key] Unknown key &quot;status&quot; for TypedDict `RPCExitCancelMsg`: Unknown key &quot;status&quot;
- freqtrade/rpc/telegram.py:584:30: error[invalid-key] Unknown key &quot;msg&quot; for TypedDict `RPCCancelMsg`: Unknown key &quot;msg&quot;
- freqtrade/rpc/telegram.py:584:30: error[invalid-key] Unknown key &quot;msg&quot; for TypedDict `RPCExitCancelMsg`: Unknown key &quot;msg&quot;
- Found 681 diagnostics
+ Found 667 diagnostics

prefect (https://github.com/PrefectHQ/prefect)
- src/prefect/deployments/runner.py:795:70: warning[possibly-missing-attribute] Attribute `__name__` may be missing on object of type `Unknown | ((...) -&gt; Any)`
+ src/prefect/deployments/runner.py:795:70: warning[possibly-missing-attribute] Attribute `__name__` may be missing on object of type `Unknown | (((...) -&gt; Any) &amp; ((*args: object, **kwargs: object) -&gt; object))`
- src/prefect/flow_engine.py:812:32: error[invalid-await] `Unknown | R@FlowRunEngine | Coroutine[Any, Any, R@FlowRunEngine]` is not awaitable
- src/prefect/flow_engine.py:1401:24: error[invalid-await] `Unknown | R@AsyncFlowRunEngine | Coroutine[Any, Any, R@AsyncFlowRunEngine]` is not awaitable
- src/prefect/flow_engine.py:1482:43: error[invalid-argument-type] Argument to function `next` is incorrect: Expected `SupportsNext[Unknown]`, found `Unknown | R@run_generator_flow_sync`
- src/prefect/flow_engine.py:1490:21: warning[possibly-missing-attribute] Attribute `throw` may be missing on object of type `Unknown | R@run_generator_flow_sync`
- src/prefect/flow_engine.py:1524:44: warning[possibly-missing-attribute] Attribute `__anext__` may be missing on object of type `Unknown | R@run_generator_flow_async`
- src/prefect/flow_engine.py:1531:25: warning[possibly-missing-attribute] Attribute `throw` may be missing on object of type `Unknown | R@run_generator_flow_async`
- src/prefect/flows.py:286:34: error[unresolved-attribute] Object of type `(**P@Flow) -&gt; R@Flow` has no attribute `__name__`
+ src/prefect/flows.py:286:34: error[unresolved-attribute] Object of type `((**P@Flow) -&gt; R@Flow) &amp; ((*args: object, **kwargs: object) -&gt; object)` has no attribute `__name__`
- src/prefect/flows.py:404:68: error[unresolved-attribute] Object of type `(**P@Flow) -&gt; R@Flow` has no attribute `__name__`
+ src/prefect/flows.py:404:68: error[unresolved-attribute] Object of type `((**P@Flow) -&gt; R@Flow) &amp; ((*args: object, **kwargs: object) -&gt; object)` has no attribute `__name__`
+ src/prefect/flows.py:1750:53: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 5533 diagnostics
+ Found 5528 diagnostics

scikit-build-core (https://github.com/scikit-build/scikit-build-core)
+ src/scikit_build_core/build/wheel.py:98:20: error[no-matching-overload] No overload of bound method `__init__` matches arguments
- Found 47 diagnostics
+ Found 48 diagnostics

static-frame (https://github.com/static-frame/static-frame)
- static_frame/core/bus.py:671:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[Bus[Any], object_]`, found `InterGetItemLocReduces[Top[Index[Any]] | Top[Series[Any, Any]] | TypeBlocks | ... omitted 6 union elements, object_]`
+ static_frame/core/bus.py:671:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[Bus[Any], object_]`, found `InterGetItemLocReduces[Top[Bus[Any]] | TypeBlocks | Batch | ... omitted 6 union elements, object_]`


</code></pre>
</details>

<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2026-01-05 20:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @charliermarsh on 2026-01-05 20:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @charliermarsh on 2026-01-05 20:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @charliermarsh on 2026-01-05 20:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @charliermarsh on 2026-01-05 20:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-06 13:28</div>
            <div class="timeline-body"><p>This leads to incorrect narrowing for tagged unions that use <code>IntEnum</code>s, <code>StrEnum</code>s, or custom enums that use <code>int</code> or <code>str</code> as mixins:</p>
<pre><code class="language-py">from typing import Literal
from enum import IntEnum, StrEnum, Enum

class Foo(IntEnum):
    X = 1

class Bar(StrEnum):
    X = &quot;foo&quot;

class Baz(int, Enum):
    X = 1

class Spam(str, Enum):
    X = &quot;foo&quot;

def f(x: tuple[int, Literal[Foo.X]] | tuple[str, Literal[1]]):
    if x[1] == 1:
        reveal_type(x)  # tuple[str, Literal[1]]

def g(x: tuple[int, Literal[Bar.X]] | tuple[str, Literal[&quot;foo&quot;]]):
    if x[1] == &quot;foo&quot;:
        reveal_type(x)  # tuple[str, Literal[&quot;foo&quot;]]

def h(x: tuple[int, Literal[Baz.X]] | tuple[str, Literal[1]]):
    if x[1] == 1:
        reveal_type(x)  # tuple[str, Literal[1]]

def i(x: tuple[int, Literal[Spam.X]] | tuple[str, Literal[&quot;foo&quot;]]):
    if x[1] == &quot;foo&quot;:
        reveal_type(x)  # tuple[str, Literal[&quot;foo&quot;]]
</code></pre>
<p>At runtime, <code>Foo.X == Baz.X == 1</code>, and <code>Bar.X == Spam.X == &quot;foo&quot;</code>, so all these narrowings are incorrect:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; from enum import IntEnum, StrEnum, Enum
... 
... class Foo(IntEnum):
...     X = 1
... 
... class Bar(StrEnum):
...     X = &quot;foo&quot;
... 
... class Baz(int, Enum):
...     X = 1
... 
... class Spam(str, Enum):
...     X = &quot;foo&quot;
...         
&gt;&gt;&gt; Foo.X == 1
True
&gt;&gt;&gt; Bar.X == &quot;foo&quot;
True
&gt;&gt;&gt; Baz.X == 1
True
&gt;&gt;&gt; Spam.X == &quot;foo&quot;
True
</code></pre>
<p>The cause of the bug is that the <code>Type::overrides_equality</code> method includes <code>MemberLookupPolicy::MRO_NO_INT_OR_STR_LOOKUP</code> in its policy when trying to determine whether the class overrides <code>__eq__</code>: it returns <code>false</code> if it determines that the class inherits its <code>__eq__</code> method from <code>str</code> or <code>int</code>. This is a pre-existing issue on <code>main</code>, and the cause of this bug: https://github.com/astral-sh/ty/issues/1454. The comment in <code>Type::overrides_equality</code> states that it's okay to ignore <code>__eq__</code> methods inherited from <code>int</code> or <code>str</code> because we &quot;know that they are well-behaved&quot;, but that's not sufficient for several callers of the method.</p>
<p>https://github.com/astral-sh/ruff/blob/ce059c4857c1d6eeb453cf9687fc82f8784798df/crates/ty_python_semantic/src/types.rs#L988-L1010</p>
<p>Ideally I feel like we'd fix that bug first before making the impact of that bug more severe... but also, maybe it doesn't come up that much, so maybe it's fine to go ahead with this even while it remains unfixed? IDK though, curious for @carljm's thoughts!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:30:53 UTC
    </footer>
</body>
</html>
