```yaml
number: 19978
title: "[ty] Look for `site-packages` directories in `<sys.prefix>/lib64/` as well as `<sys.prefix>/lib/` on non-Windows systems"
type: pull_request
state: merged
author: AlexWaygood
labels:
  - ty
assignees: []
merged: true
base: main
head: alex/poetry-weird
created_at: 2025-08-18T21:48:50Z
updated_at: 2025-08-19T13:54:13Z
url: https://github.com/astral-sh/ruff/pull/19978
synced_at: 2026-01-12T15:56:51Z
```

# [ty] Look for `site-packages` directories in `<sys.prefix>/lib64/` as well as `<sys.prefix>/lib/` on non-Windows systems

---

_@AlexWaygood_

## Summary

Fixes https://github.com/astral-sh/ty/issues/1043; fixes https://github.com/astral-sh/ty/issues/257.

According to [the documentation of `sys.platlibdir`](https://docs.python.org/3/library/sys.html#sys.platlibdir) in the standard library, Python modules should never be installed into the `lib64/pythonX.Y/site-packages` directory; that directory should only be used for C extensions (which can never be submodules of a Python package, only top-level modules). Empirically, however, some installers appear to put Python files into the `lib64/pythonX.Y/site-packages` directory rather than the `lib/pythonX.Y/site-packages` directory, in some situations. I'm not sure why they're doing this -- but we'll need to start looking at the `lib64` directory at some point in the future anyway to solve https://github.com/astral-sh/ty/issues/487, so we may as well start looking at it now.

The practical implication of this is that a virtual environment can often have two `site-packages` directories on Unix, and so can a system environment. This isn't too big of a change to our overall model, since there were already situations where we accumulated `site-packages` directories from several different environments and added them all as search paths, but it requires a little bit of a refactor to `site_packages.rs`.

## Test Plan

I added a CLI integration test.

I looked at whether it would be possible to add a unit test for this as an mdtest or in `site_packages.rs`... but concluded that both would be too much pain for too little gain here. The mdtest framework abstracts away the path to the `site-packages` directory by using "magic" `<path-to-site-packages>` path segments; this allows us to write platform-independent tests for `site-packages` import resolution, but means that we cannot add a unit test for something like this.

It would be possible to expand the testing framework in `site_packages.rs` to allow for us to add a unit test there, but it would be a big diff; I don't think it's worth it for a single test.


---

_Label `ty` added by @AlexWaygood on 2025-08-18 21:48_

---

_Comment by @github-actions[bot] on 2025-08-18 21:50_

<!-- generated-comment typing_conformance_diagnostics_diff -->
## Diagnostic diff on [typing conformance tests](https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance)
No changes detected when running ty on typing conformance tests ✅


---

_Comment by @github-actions[bot] on 2025-08-18 21:56_

<!-- generated-comment mypy_primer -->
## `mypy_primer` results
No ecosystem changes detected ✅
No memory usage changes detected ✅


---

_Comment by @AlexWaygood on 2025-08-18 22:01_

I'm guessing this also fixes https://github.com/astral-sh/ty/issues/257, but haven't verified that

EDIT: @geofft kindly verified that poetry is indeed putting those packages into the `lib64/pythonX.Y/site-packages` directory, so it almost certainly seems to be the same issue

---

_Marked ready for review by @AlexWaygood on 2025-08-19 11:21_

---

_Review requested from @carljm by @AlexWaygood on 2025-08-19 11:21_

---

_Review requested from @sharkdp by @AlexWaygood on 2025-08-19 11:21_

---

_Review requested from @dcreager by @AlexWaygood on 2025-08-19 11:21_

---

_Review requested from @MichaReiser by @AlexWaygood on 2025-08-19 11:21_

---

_Review comment by @MichaReiser on `crates/ty_python_semantic/src/site_packages.rs`:118 on 2025-08-19 11:23_

Nit: Coudl we use the `from_iter` implementation below?

---

_Review comment by @MichaReiser on `crates/ty_python_semantic/src/site_packages.rs`:276 on 2025-08-19 11:25_

I think I'd prefer using `as_path()` over `as_ref` as it is converting to a more specific type and not a less specific (e.g. String -> str). 

Especially considering that this type also implements `as_str`

---

_Review comment by @MichaReiser on `crates/ty_python_semantic/src/site_packages.rs`:282 on 2025-08-19 11:26_

Does this work
```suggestion
impl PartialEq<str> for UnixLibDir {
    fn eq(&self, other: &str) -> bool {
        self.as_str() == other
    }
}
```

---

_Review comment by @MichaReiser on `crates/ty_python_semantic/src/site_packages.rs`:292 on 2025-08-19 11:26_

Nit: You could do
```suggestion
        other == self 
```

---

_@MichaReiser approved on 2025-08-19 11:28_

Nice, thank you

---

_@AlexWaygood reviewed on 2025-08-19 11:46_

---

_Review comment by @AlexWaygood on `crates/ty_python_semantic/src/site_packages.rs`:282 on 2025-08-19 11:46_

if I do that then it makes the places where I'm using the `impl` less ergonomic; I have to do awkward dereferences

---

_@AlexWaygood reviewed on 2025-08-19 11:48_

---

_Review comment by @AlexWaygood on `crates/ty_python_semantic/src/site_packages.rs`:276 on 2025-08-19 11:48_

hmm, but we already implement `AsRef<SystemPath>` for `str` -- isn't that also converting to a more specific type?

I'd prefer to leave things as they are because it means I can pass `UnixLibDir`s directly into `SystemPath::join()`, which requires the argument passed in to implement `AsRef<SystemPath>`. There are ways round this, but they all make the code less ergonomic

---

_@AlexWaygood reviewed on 2025-08-19 11:49_

---

_Review comment by @AlexWaygood on `crates/ty_python_semantic/src/site_packages.rs`:118 on 2025-08-19 11:49_

The `FromIterator` implementation was unused, so I got rid of that one and kept the new one that's used

---

_Merged by @AlexWaygood on 2025-08-19 11:53_

---

_Closed by @AlexWaygood on 2025-08-19 11:53_

---

_Branch deleted on 2025-08-19 11:53_

---
