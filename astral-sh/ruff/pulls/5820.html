<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draw boundaries between various `Checker` visitation phases - astral-sh/ruff #5820</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Draw boundaries between various <code>Checker</code> visitation phases</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5820">#5820</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-07-17 04:22
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-07-17 04:22</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR does some non-behavior-changing refactoring of the AST checker. Specifically, it breaks the <code>Stmt</code>, <code>Expr</code>, and <code>ExceptHandler</code> visitors into four distinct, consistent phases:</p>
<ol>
<li><strong>Phase 1: Analysis</strong>: Run any lint rules on the node.</li>
<li><strong>Phase 2: Binding</strong>: Bind any symbols declared by the node.</li>
<li><strong>Phase 3: Recursion</strong>: Visit all child nodes.</li>
<li><strong>Phase 4: Clean-up</strong>: Pop scopes, etc.</li>
</ol>
<p>There are some fuzzy boundaries in the last three phases, but the most important divide is between the Phase 1 and all the others -- the goal here is (as much as possible) to disentangle all of the vanilla lint-rule calls from any other semantic analysis or model building.</p>
<p>Part of the motivation here is that I'm considering re-ordering some of these phases, and it was just impossible to reason about that change as long as we had miscellaneous binding-creation and scope-modification code intermingled with lint rules. However, this could also enable us to (e.g.) move the entire analysis phase elsewhere, and even with a more limited API that has read-only access to <code>Checker</code> (but can push to a diagnostics vector).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-07-17 04:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/checkers/ast/mod.rs</code>:270 on 2023-07-17 04:22</div>
            <div class="timeline-body"><p>Moved into the Binding phase.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-07-17 04:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/checkers/ast/mod.rs</code>:313 on 2023-07-17 04:22</div>
            <div class="timeline-body"><p>Moved into the Binding phase.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/checkers/ast/mod.rs</code>:837 on 2023-07-17 04:22</div>
            <div class="timeline-body"><p>Moved into the Binding phase.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-07-17 04:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/checkers/ast/mod.rs</code>:2266 on 2023-07-17 04:23</div>
            <div class="timeline-body"><p>Moved into the binding phase.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-07-17 04:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-07-17 04:34</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>✅ ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      9.4±0.06ms     4.3 MB/sec    1.01      9.5±0.04ms     4.3 MB/sec
formatter/numpy/ctypeslib.py               1.00   1865.6±3.83µs     8.9 MB/sec    1.00   1866.0±4.93µs     8.9 MB/sec
formatter/numpy/globals.py                 1.00    209.4±0.34µs    14.1 MB/sec    1.01    210.8±2.04µs    14.0 MB/sec
formatter/pydantic/types.py                1.01      4.1±0.01ms     6.3 MB/sec    1.00      4.0±0.01ms     6.3 MB/sec
linter/all-rules/large/dataset.py          1.00     13.4±0.06ms     3.0 MB/sec    1.01     13.5±0.09ms     3.0 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.4±0.02ms     5.0 MB/sec    1.00      3.4±0.02ms     4.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    438.8±1.28µs     6.7 MB/sec    1.00    439.3±0.56µs     6.7 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.0±0.05ms     4.2 MB/sec    1.00      6.1±0.06ms     4.2 MB/sec
linter/default-rules/large/dataset.py      1.00      6.6±0.02ms     6.2 MB/sec    1.00      6.6±0.03ms     6.2 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1399.6±1.96µs    11.9 MB/sec    1.00   1402.6±3.63µs    11.9 MB/sec
linter/default-rules/numpy/globals.py      1.00    156.2±2.70µs    18.9 MB/sec    1.00    156.2±0.28µs    18.9 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.9±0.01ms     8.7 MB/sec    1.01      3.0±0.01ms     8.6 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     11.3±0.14ms     3.6 MB/sec    1.00     11.3±0.14ms     3.6 MB/sec
formatter/numpy/ctypeslib.py               1.01      2.2±0.02ms     7.6 MB/sec    1.00      2.2±0.03ms     7.7 MB/sec
formatter/numpy/globals.py                 1.00    230.8±3.88µs    12.8 MB/sec    1.02   236.0±18.22µs    12.5 MB/sec
formatter/pydantic/types.py                1.00      4.8±0.10ms     5.3 MB/sec    1.00      4.9±0.16ms     5.3 MB/sec
linter/all-rules/large/dataset.py          1.00     15.8±0.14ms     2.6 MB/sec    1.00     15.8±0.20ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      4.2±0.10ms     3.9 MB/sec    1.00      4.2±0.13ms     4.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    426.5±9.13µs     6.9 MB/sec    1.01   429.4±13.39µs     6.9 MB/sec
linter/all-rules/pydantic/types.py         1.02      7.3±0.17ms     3.5 MB/sec    1.00      7.2±0.11ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.00      8.2±0.09ms     5.0 MB/sec    1.00      8.2±0.07ms     5.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1665.2±50.79µs    10.0 MB/sec    1.00  1669.0±45.54µs    10.0 MB/sec
linter/default-rules/numpy/globals.py      1.00    173.5±3.80µs    17.0 MB/sec    1.00    174.0±3.90µs    17.0 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.6±0.03ms     7.0 MB/sec    1.00      3.6±0.04ms     7.0 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/checkers/ast/mod.rs</code>:208 on 2023-07-17 06:19</div>
            <div class="timeline-body"><p>Can we add some documentation to <code>Checker</code> that explains the different phases? Especially <code>Analysis</code> is unclear to me (<code>Syntax</code>?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-07-17 06:23</div>
            <div class="timeline-body"><p>Okay, I now understand the phases. They are very different from what I understood from Phases and the fact that they overlap (The pre-processing of expression happens during a statements recursion phase) is confusing to me. The issue could just be that it they are named <em>Phases</em>.</p>
<p>I didn't review the changes line by line because the PR seems to mainly move code around.
I don't have a good recommendation on what to do differently or an alternate name suggestion (maybe step?))</p>
<p>For maintainability. How do we ensure that new rules are added to the right <em>phase</em> in the future?</p>
<p>How does it work that lint rules can run and use the semantic model before the binder phase for that node completed? For example, wouldn't that mean that we miss a <em>read</em> of the <code>callee</code> when analysing a call expression?</p>
<p>Written before I understood the <em>phases</em> concept. Kept for completness</p>
<p>What's the motivation for splitting <code>Syntax</code> and <code>Binding</code> into two phases?</p>
<p>I don't see the two as so different: Lint rules only generate diagnostics whereas <code>Binding</code> constructs a new representation.</p>
<p>The way I think about it is that <em>visitors</em> take different inputs and can produce different outputs:</p>
<ul>
<li>Binder:<ul>
<li>Input: Syntax Node</li>
<li>output: Bound semantic model</li>
</ul>
</li>
<li>Syntax Visitor<ul>
<li>Input: Syntax Node</li>
<li>Output: Diagnostic</li>
</ul>
</li>
<li>Semantic Visitor<ul>
<li>Input: Semantic Model, Syntax Node</li>
<li>Output: Diagnostic</li>
</ul>
</li>
</ul>
<p>That means, we only need two passes
As you can see, th</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-07-17 14:15</div>
            <div class="timeline-body"><p>@MichaReiser - Couple quick things (I almost just wrote this in Discord but want to err on the side of putting things in GitHub -- but <em>also</em> trying to let myself write brief and informal comments on GitHub):</p>
<ol>
<li>I was going to reorder the &quot;phases&quot; in a second PR such that we run lint rules after binding. I think it probably works right now because we tend to only do all-usage-renames in deferred phases.</li>
<li>If I were to merge the last three &quot;phases&quot;, would it make sense to you to retain the &quot;phase&quot; terminology? Since we'd have one model-building and visitation phase, and then the linting phase.</li>
<li>RE &quot;For maintainability. How do we ensure that new rules are added to the right phase in the future?&quot; -- I was thinking of doing something very dumb and lightweight, like moving the analysis phase to its own module (maybe a trait, maybe just a method on <code>Checker</code>). Then, we'd point to that separate module in the docs, etc. Eventually we can enforce this with better API, which would have other benefits (e.g., the rules should only have mutable access to <code>diagnostics</code>, not to anything else on <code>Checker</code>), but I'm hesitant to do larger API refactors without spending more time thinking it through.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-17 16:06</div>
            <div class="timeline-body"><blockquote>
<p>I was going to reorder the &quot;phases&quot; in a second PR such that we run lint rules after binding. I think it probably works right now because we tend to only do all-usage-renames in deferred phases.</p>
</blockquote>
<p>Would this be moving to something close to what I outlined above? Where we have two phases, one syntax based and phase where we also have the semantic model?</p>
<blockquote>
<p>If I were to merge the last three &quot;phases&quot;, would it make sense to you to retain the &quot;phase&quot; terminology? Since we'd have one model-building and visitation phase, and then the linting phase.</p>
</blockquote>
<p>I guess that works too. My gut feeling is that I would prefer running the syntax rules together with the binder to avoid that the semantic model construction prevents them from running (and we could even emit these diagnostics earlier).</p>
<p>Feel free to merge. I think I'm mainly interested in how you lay out the phases in your next PR (with explanations)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-07-17 17:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-07-17 17:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-07-17 17:02</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 03:31:00 UTC
    </footer>
</body>
</html>
