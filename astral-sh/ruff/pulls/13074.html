<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use `uv run` to run the Python-based fuzzer - astral-sh/ruff #13074</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use <code>uv run</code> to run the Python-based fuzzer</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13074">#13074</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-08-23 10:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body">Summary
<p>This converts the <code>scripts/fuzz-parser</code> script into a script runnable via <code>uv run</code>.</p>
<p>Since this is a single-file script, I considered using <a href="https://docs.astral.sh/uv/guides/scripts/#declaring-script-dependencies">inline metadata</a> here; it seemed like it might be a good fit. However, it seems as though inline dependencies aren&#x27;t recorded in <code>uv.lock</code> at all, which wouldn&#x27;t be ideal since we use this script in CI as a regression test. I therefore added the dependencies of the script to the <code>pyproject.toml</code> in the Ruff repo root instead, which means that the dependencies are pinned in the project&#x27;s <code>uv.lock</code> file.</p>
<p>Annoyingly, <code>uv run scripts/fuzz-parser.py</code> seems to build Ruff from source with this PR before it runs the script. I don&#x27;t think there&#x27;s any way currently to tell uv to <em>only</em> install the dev dependencies, and not bother with installing the project itself, when running scripts? Building Ruff from source isn&#x27;t necessary with this script if you pass the <code>--test-executable</code> flag. This might be a blocker for this PR? It means that the <code>uv run</code> invocation takes ages to get going.</p>
<p>I deliberately haven&#x27;t tried to include any of the docs dependencies in this change, as @MichaReiser already tried in #12622, and the situation there is quite complicated with the two <code>requirements.txt</code> files.</p>
<p>Overall this is something I&#x27;d love to do as it seems like it <em>could</em> be a really nice simplification... but I&#x27;m not sure it&#x27;s a perfect fit right now?</p>
Test Plan
<ul>
<li><code>uv run scripts/fuzz-parser.py 0-100</code></li>
<li><code>uv run scripts/generate_known_standard_library.py</code></li>
<li><code>cd scripts/knot_benchmark &amp;&amp; uv run benchmark</code></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-08-23 10:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ci</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-08-23 10:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/zanieb">@zanieb</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-08-23 10:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-08-23 10:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dhruvmanila">@dhruvmanila</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-08-23 10:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-08-23 10:47</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/scripts-uv">CodSpeed Performance Report</a>
Merging #13074 will <strong>not alter performance</strong>
<p>Comparing <code>scripts-uv</code> (d11d884) with <code>main</code> (c6023c0)</p>
Summary
<p><code>✅ 32</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-08-23 11:00</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_salesforce.ipynb:14:1:1: Expected an expression
</code></pre>
</p>


Formatter (preview)
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_salesforce.ipynb:14:1:1: Expected an expression
</code></pre>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-23 11:13</div>
            <div class="timeline-body"><p>Haha, and here is another use case asking for virtual workspace. This will make @charliermarsh so happy</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-23 11:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/MichaReiser">@MichaReiser</a> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-23 11:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/dhruvmanila">@dhruvmanila</a> removed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-23 11:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-08-28 18:27</div>
            <div class="timeline-body"><p>Well... this works for the <code>fuzz-parser</code> script, but not for <code>generate_known_standard_library.py</code>. <code>uv</code> refuses to install a new enough version of <code>stdlibs</code>, because recent versions of <code>stdlibs</code> require Python 3.8+, but the <code>requires-python</code> field in our <code>pyproject.toml</code> states (correctly) that Ruff supports being installed on Python 3.7+, and it seems impossible to convince uv that it&#x27;s okay to install a dev-dependency that&#x27;s only available on newer Python versions if there&#x27;s the <code>requires-python = &quot;&gt;= 3.7&quot;</code> field there.</p>
<p>I think having a dev-dependency that&#x27;s only available on newer Python versions than the one the package is declared as supporting is probably reasonable...? Hmm, but maybe if it&#x27;s declared as a &quot;virtual&quot; workspace, uv assumes there <em>is</em> no package, so therefore the <code>requires-python</code> field <em>must</em> refer to whatever ad-hoc scripts you have floating around in your &quot;virtual&quot; workspace...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-28 18:30</div>
            <div class="timeline-body"><p>I kind of think these should just be PEP 723 scripts. Semantically, at least, that&#x27;s what they <em>want</em> to be, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-08-28 18:31</div>
            <div class="timeline-body"><blockquote>
<p>I kind of think these should just be PEP 723 scripts. Semantically, at least, that&#x27;s what they <em>want</em> to be, right?</p>
</blockquote>
<p>I tried that at first, but I don&#x27;t get the transitive dependencies pinned in the lockfile (and updated by Renovate) if I have them as PEP 723 scripts, right? We run <code>fuzz-parser</code> in CI; I think we want the transitive deps pinned for that</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-28 18:37</div>
            <div class="timeline-body"><p>Separately, why are the deps not in <code>scripts/pyproject.toml</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-08-28 18:40</div>
            <div class="timeline-body"><blockquote>
<p>Separately, why are the deps not in <code>scripts/pyproject.toml</code>?</p>
</blockquote>
<p>Would I have to <code>cd</code> into <code>scripts</code> to run them then? <code>fuzz-parser</code> needs to be run from the workspace root. Or will <code>uv run</code> pick up the config file at <code>scripts/pyproject.toml</code> even if I run the scripts from the workspace root?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-28 18:46</div>
            <div class="timeline-body"><p>Related <a href="https://github.com/astral-sh/uv/issues/6733">astral-sh/uv#6733</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-29 15:30</div>
            <div class="timeline-body"><p>Alternatively we could prioritize adding the lockfile to <code>PEP 723</code> scripts heh.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-08-29 15:31</div>
            <div class="timeline-body"><blockquote>
<p>Alternatively we could prioritize adding the lockfile to <code>PEP 723</code> scripts heh.</p>
</blockquote>
<p>Ah, that would be the ideal solution if it&#x27;s something you&#x27;re considering!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-29 16:30</div>
            <div class="timeline-body"><p>@AlexWaygood would you want it to be embedded in the script? It might be looong.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-08-30 14:16</div>
            <div class="timeline-body"><blockquote>
<p>@AlexWaygood would you want it to be embedded in the script? It might be looong.</p>
</blockquote>
<p>Hrm... no, probably not!</p>
<p>I think there&#x27;s essentially two genres of single-file scripts:</p>
<ol>
<li>One-off scripts that you write for a single purpose. You want these to be easily shareable, you don&#x27;t want to have to faff around with a separate <code>requirements.txt</code> or lockfile for them, you want everything about the script to be contained within the single file.</li>
<li>&quot;Persistent&quot; scripts that are a single file but that you keep around indefinitely and run on a regular basis. These might be scripts that are e.g. run as part of CI for a larger project. You want these scripts to be reliable, and shareability isn&#x27;t as important.</li>
</ol>
<p>These scripts definitely feel like they fit into category (2) rather than category (1). It&#x27;s not like it&#x27;s ever going to make sense to try to run them outside this repository, so shareability and portability aren&#x27;t really important; it&#x27;s okay if the lockfile gets output to a separate file, IMO. I guess the easiest way of doing that implementation-wise would be a separate lockfile for each script, since you&#x27;ll probably want a separate virtual environment for each script?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-30 14:23</div>
            <div class="timeline-body"><blockquote>
<p>&quot;Persistent&quot; scripts that are a single file but that you keep around indefinitely and run on a regular basis. These might be scripts that are e.g. run as part of CI for a larger project. You want these scripts to be reliable, and shareability isn&#x27;t as important.</p>
</blockquote>
<p>I think this should just be a project, personally.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-14 17:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-26 12:06</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:06:17 UTC
    </footer>
</body>
</html>
