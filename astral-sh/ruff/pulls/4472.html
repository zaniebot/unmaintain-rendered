<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bring pycodestyle rules into full compatibility (on SciPy) - astral-sh/ruff #4472</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Bring pycodestyle rules into full compatibility (on SciPy)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4472">#4472</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-05-17 14:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>This PR contains a handful of bug fixes that were necessary to get our pycodestyle rules to output identical diagnostics to pycodestyle itself when run on the SciPy repo (which I&#x27;m using as &quot;a large, diverse codebase that does not use Black and includes some known violations&quot;).</p>
<p>For posterity, here&#x27;s the script I used to diff against SciPy, which could in theory be applied to any other project: https://gist.github.com/charliermarsh/3f2855f33960c92306c91d003b6237dc.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-17 14:48</div>
            <div class="timeline-body"><p>I&#x27;m going to carve a couple of these out into separate PRs, so draft for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-05-17 14:56</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>✅ ecosystem check detected no changes.</p>
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.02     14.8±0.11ms     2.8 MB/sec    1.00     14.4±0.09ms     2.8 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.02      3.5±0.03ms     4.7 MB/sec    1.00      3.5±0.01ms     4.8 MB/sec
linter/all-rules/numpy/globals.py          1.00    428.5±1.49µs     6.9 MB/sec    1.00    428.3±1.25µs     6.9 MB/sec
linter/all-rules/pydantic/types.py         1.01      6.0±0.05ms     4.2 MB/sec    1.00      5.9±0.05ms     4.3 MB/sec
linter/default-rules/large/dataset.py      1.03      7.0±0.10ms     5.8 MB/sec    1.00      6.7±0.03ms     6.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01   1479.2±2.43µs    11.3 MB/sec    1.00   1460.6±2.32µs    11.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    164.2±0.76µs    18.0 MB/sec    1.00    163.6±3.36µs    18.0 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.1±0.01ms     8.3 MB/sec    1.00      3.1±0.01ms     8.3 MB/sec
parser/large/dataset.py                    1.01      5.5±0.01ms     7.4 MB/sec    1.00      5.4±0.01ms     7.5 MB/sec
parser/numpy/ctypeslib.py                  1.00   1067.9±0.76µs    15.6 MB/sec    1.00   1063.2±1.82µs    15.7 MB/sec
parser/numpy/globals.py                    1.01    109.8±0.34µs    26.9 MB/sec    1.00    108.5±0.21µs    27.2 MB/sec
parser/pydantic/types.py                   1.01      2.3±0.00ms    11.0 MB/sec    1.00      2.3±0.00ms    11.1 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                    pr
-----                                      ----                                    --
linter/all-rules/large/dataset.py          1.01     20.3±0.57ms  2047.5 KB/sec     1.00     20.2±0.59ms     2.0 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      5.2±0.18ms     3.2 MB/sec     1.00      5.2±0.20ms     3.2 MB/sec
linter/all-rules/numpy/globals.py          1.00   620.1±30.62µs     4.8 MB/sec     1.00   618.0±27.92µs     4.8 MB/sec
linter/all-rules/pydantic/types.py         1.01      8.6±0.31ms     3.0 MB/sec     1.00      8.5±0.26ms     3.0 MB/sec
linter/default-rules/large/dataset.py      1.00     10.2±0.36ms     4.0 MB/sec     1.00     10.2±0.33ms     4.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00      2.1±0.08ms     7.8 MB/sec     1.00      2.1±0.11ms     7.8 MB/sec
linter/default-rules/numpy/globals.py      1.00   256.1±13.60µs    11.5 MB/sec     1.00   256.3±11.90µs    11.5 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.5±0.14ms     5.7 MB/sec     1.00      4.5±0.17ms     5.7 MB/sec
parser/large/dataset.py                    1.03      8.5±0.21ms     4.8 MB/sec     1.00      8.3±0.16ms     4.9 MB/sec
parser/numpy/ctypeslib.py                  1.02  1645.0±125.33µs    10.1 MB/sec    1.00  1613.4±63.32µs    10.3 MB/sec
parser/numpy/globals.py                    1.02    168.1±8.40µs    17.6 MB/sec     1.00   164.8±17.97µs    17.9 MB/sec
parser/pydantic/types.py                   1.04      3.7±0.17ms     6.9 MB/sec     1.00      3.6±0.12ms     7.2 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-17 14:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-17 14:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/checkers/logical_lines.rs</code>:60 on 2023-05-17 14:57</div>
            <div class="timeline-body"><p>I&#x27;ve done this before too, but I think it&#x27;s incorrect -- doesn&#x27;t this mean &quot;The flag needs to contain both OPERATOR <em>and</em> PUNCTUATION&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-17 14:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/checkers/logical_lines.rs</code>:59 on 2023-05-17 14:58</div>
            <div class="timeline-body"><p>(Was also missing BRACKET.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-17 14:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-17 14:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/pycodestyle/rules/logical_lines/missing_whitespace.rs</code>:57 on 2023-05-17 14:58</div>
            <div class="timeline-body"><p>I think this was just an oversight without a test-case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-17 14:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/pycodestyle/rules/logical_lines/missing_whitespace.rs</code>:69 on 2023-05-17 14:58</div>
            <div class="timeline-body"><p>Empirically, pycodestyle seems to allow continuations:</p>
<pre><code>#: Okay
a = (1,\
2)
</code></pre>
<p>We could deviate and remove this change, I don&#x27;t feel strongly, but it was necessary to achieve compatibility.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_ast/src/token_kind.rs</code>:324 on 2023-05-17 14:59</div>
            <div class="timeline-body"><p>pycodestyle doesn&#x27;t seem to include or enforce this -- we were flagging this as invalid space around the tilde:</p>
<pre><code>spam[ ~ham]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-17 14:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-17 14:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_ast/src/token_kind.rs</code>:244 on 2023-05-17 14:59</div>
            <div class="timeline-body"><p>I think this was just missing (<code>==</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/pycodestyle/rules/logical_lines/mod.rs</code>:375 on 2023-05-17 15:01</div>
            <div class="timeline-body"><p>Probably the most &quot;controversial&quot; change here -- don&#x27;t treat the first line here as containing trailing whitespace (between the colon and comment):</p>
<pre><code>if x:  # Foo
  ...
</code></pre>
<p>Without this change, we flag the following as containing invalid trailing space around the <code>[</code>:</p>
<pre><code>#: Okay
x = [  #
    &#x27;some value&#x27;,
]
</code></pre>
<p>Another option is to change all clients of this method to lookahead and <em>not</em> flag when the next token is a comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-17 15:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/checkers/logical_lines.rs</code>:60 on 2023-05-17 15:29</div>
            <div class="timeline-body"><p>Yes it does. What we want here is to use <code>intersects</code> (could be faster than using an <code>||</code> with two function calls.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/pycodestyle/rules/logical_lines/mod.rs</code>:375 on 2023-05-17 15:32</div>
            <div class="timeline-body"><p>I think the question is whether this should apply to all rules or not:</p>
<ul>
<li>Yes -&gt; having it here is fine</li>
<li>No -&gt; Handle it inside of the rule.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/token_kind.rs</code>:324 on 2023-05-17 15:33</div>
            <div class="timeline-body"><p>Nit: Can we move this method to the rule that uses it because <code>TokenKind</code> is generic and <code>is_bitwise_or_shift</code> now no longer returns <code>true</code> for all bitwise operators.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-05-17 15:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-17 16:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-17 16:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-05-17 16:51</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:53:45 UTC
    </footer>
</body>
</html>
