```yaml
number: 7809
title: Report precise location for invalid conversion flag
type: pull_request
state: merged
author: dhruvmanila
labels:
  - bug
assignees: []
merged: true
base: main
head: dhruv/conversion-flag-loc
created_at: 2023-10-04T11:30:41Z
updated_at: 2023-10-05T12:16:15Z
url: https://github.com/astral-sh/ruff/pull/7809
synced_at: 2026-01-12T15:55:24Z
```

# Report precise location for invalid conversion flag

---

_@dhruvmanila_

## Summary

This PR updates the parser definition to use the precise location when reporting
an invalid f-string conversion flag error.

Taking the following example code:
```python
f"{foo!x}"
```

On earlier version,
```
Error: f-string: invalid conversion character at byte offset 6
```

Now,
```
Error: f-string: invalid conversion character at byte offset 7
```

This becomes more useful when there's whitespace between `!` and the flag value
although that is not valid but we can't detect that now.

## Test Plan

As mentioned above.


---

_Comment by @dhruvmanila on 2023-10-04 11:30_

Current dependencies on/for this PR:
* main
  * **PR #7809** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7809" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  üëà

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7809?utm_source=stack-comment).

---

_Label `bug` added by @dhruvmanila on 2023-10-04 11:31_

---

_Comment by @codspeed-hq[bot] on 2023-10-04 11:45_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/dhruv/conversion-flag-loc)

### Merging #7809 will **degrade performances by 2.5%**

<sub>Comparing <code>dhruv/conversion-flag-loc</code> (dc9270b) with <code>main</code> (a1509df)</sub>



### Summary

`‚ùå 1` regressions
`‚úÖ 24` untouched benchmarks



> :warning: _Please fix the performance issues or [acknowledge them on CodSpeed](https://codspeed.io/astral-sh/ruff/branches/dhruv/conversion-flag-loc)._

### Benchmarks breakdown

|     | Benchmark | `main` | `dhruv/conversion-flag-loc` | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ‚ùå | `linter/default-rules[pydantic/types.py]` | 38 ms | 39 ms | -2.5% |


---

_Comment by @github-actions[bot] on 2023-10-04 11:48_

## PR Check Results
### Ecosystem
‚úÖ ecosystem check detected no changes.



---

_Renamed from "Precise location for reporting invalid conversion flag" to "Report precise location for invalid conversion flag" by @dhruvmanila on 2023-10-05 12:16_

---

_Merged by @dhruvmanila on 2023-10-05 12:16_

---

_Closed by @dhruvmanila on 2023-10-05 12:16_

---

_Branch deleted on 2023-10-05 12:16_

---
