<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Format `lambda` expression - astral-sh/ruff #5806</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Format <code>lambda</code> expression</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5806">#5806</a>
        opened by <a href="https://github.com/cnpryer">@cnpryer</a>
        on 2023-07-16 13:22
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/cnpryer">@cnpryer</a> on 2023-07-16 13:22</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>See #5810.</p>
<p>Implements <code>ArgumentsParentheses::SkipInsideLambda</code> for <code>FormatArguments</code> to unblock <code>lambda</code> formatting.</p>
<h2>Test Plan</h2>
<p>Existing snapshots and potentially more fixtures.</p>
<hr />
<p>0.978 -&gt; 0.98 on django similarity index</p>
<p>I wasn't sure if I wanted to claim this one because I was violating the orphan rule workaround by modifying the generated.rs. I noticed (1) if I regenerated them it'd modify the currently checked in generated.rs, so I figured there may have been some manual adjustments already. (2) I saw #5804 modify it manually in the same way. I looked at some of #4951 as well.</p>
<p>TODO:</p>
<ul>
<li>[x] Update generated.rs for new <code>ForamtArguments</code> <code>Default</code></li>
<li>[x] Basic implementation</li>
<li>[x] Review current snapshots</li>
<li>[x] Add more fixtures</li>
<li>[x] Dangling comments</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Format `lamdba` expression" to "Format `lambda` expression" by @cnpryer on 2023-07-16 13:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @cnpryer on 2023-07-16 13:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-07-16 13:46</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>✅ ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      9.3±0.03ms     4.4 MB/sec    1.00      9.4±0.03ms     4.3 MB/sec
formatter/numpy/ctypeslib.py               1.00   1867.1±2.62µs     8.9 MB/sec    1.00   1874.5±4.06µs     8.9 MB/sec
formatter/numpy/globals.py                 1.00    207.7±0.64µs    14.2 MB/sec    1.00    208.2±0.21µs    14.2 MB/sec
formatter/pydantic/types.py                1.00      4.0±0.01ms     6.3 MB/sec    1.00      4.0±0.01ms     6.3 MB/sec
linter/all-rules/large/dataset.py          1.00     12.9±0.04ms     3.2 MB/sec    1.00     12.9±0.04ms     3.2 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.3±0.00ms     5.1 MB/sec    1.01      3.3±0.00ms     5.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    430.0±0.54µs     6.9 MB/sec    1.01    434.7±1.84µs     6.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.8±0.01ms     4.4 MB/sec    1.01      5.9±0.01ms     4.3 MB/sec
linter/default-rules/large/dataset.py      1.00      6.5±0.01ms     6.2 MB/sec    1.01      6.6±0.02ms     6.2 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1396.2±1.83µs    11.9 MB/sec    1.01   1415.5±2.53µs    11.8 MB/sec
linter/default-rules/numpy/globals.py      1.00    154.9±0.51µs    19.0 MB/sec    1.00    155.6±0.28µs    19.0 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.0±0.01ms     8.6 MB/sec    1.01      3.0±0.01ms     8.5 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     11.1±0.15ms     3.7 MB/sec    1.00     11.1±0.14ms     3.7 MB/sec
formatter/numpy/ctypeslib.py               1.01      2.2±0.04ms     7.6 MB/sec    1.00      2.2±0.03ms     7.7 MB/sec
formatter/numpy/globals.py                 1.00    246.3±5.62µs    12.0 MB/sec    1.02    250.1±9.29µs    11.8 MB/sec
formatter/pydantic/types.py                1.01      4.8±0.09ms     5.3 MB/sec    1.00      4.8±0.06ms     5.3 MB/sec
linter/all-rules/large/dataset.py          1.00     15.5±0.15ms     2.6 MB/sec    1.01     15.6±0.20ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.1±0.05ms     4.1 MB/sec    1.00      4.1±0.06ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.01    495.9±9.07µs     6.0 MB/sec    1.00    491.2±8.33µs     6.0 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.0±0.11ms     3.6 MB/sec    1.01      7.1±0.12ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.01      8.1±0.08ms     5.0 MB/sec    1.00      8.0±0.07ms     5.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.03  1707.1±38.32µs     9.8 MB/sec    1.00  1657.0±18.64µs    10.0 MB/sec
linter/default-rules/numpy/globals.py      1.01    192.1±3.18µs    15.4 MB/sec    1.00    189.4±3.01µs    15.6 MB/sec
linter/default-rules/pydantic/types.py     1.03      3.6±0.05ms     7.0 MB/sec    1.00      3.6±0.03ms     7.2 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @konstin on 2023-07-16 18:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_lambda.rs</code>:38 on 2023-07-18 09:19</div>
            <div class="timeline-body"><p>Nit (I'm fine with either)</p>
<pre><code class="language-suggestion">        write!(f, [text(&quot;lambda&quot;)])?;

        if !args.args.is_empty() {
            write!(
                f,
                [
                    space(),
                    args.format()
                        .with_options(ArgumentsParentheses::SkipInsideLambda),
                ]
            )?;
        }

        write!(f, [text(&quot;:&quot;), space(), body.format()])
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/expression/lambda.py</code>:24 on 2023-07-18 09:20</div>
            <div class="timeline-body"><p>Can we add some more examples where the parenthesized body expands over multiple lines?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/other/arguments.rs</code>:194 on 2023-07-18 09:25</div>
            <div class="timeline-body"><p>Can we add an assertion that <code>dangling_comments</code> is empty (is this guaranteed?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-07-18 09:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @cnpryer on 2023-07-18 11:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cnpryer">@cnpryer</a> reviewed on 2023-07-18 11:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/cnpryer">@cnpryer</a> on <code>crates/ruff_python_formatter/src/expression/expr_lambda.rs</code>:38 on 2023-07-18 11:21</div>
            <div class="timeline-body"><p>Yours is better for sure. 7473457ecaae65ac9b645262bb7587269f71a232</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cnpryer">@cnpryer</a> reviewed on 2023-07-18 11:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/cnpryer">@cnpryer</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/expression/lambda.py</code>:24 on 2023-07-18 11:22</div>
            <div class="timeline-body"><p>ed78487efe33648761550d9cf44ab08ee7c915d1</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cnpryer">@cnpryer</a> reviewed on 2023-07-18 11:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/cnpryer">@cnpryer</a> on <code>crates/ruff_python_formatter/src/other/arguments.rs</code>:194 on 2023-07-18 11:22</div>
            <div class="timeline-body"><p>e11be20805a7e6cbd2492b7af2483f317202677b</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/cnpryer">@cnpryer</a> on <code>crates/ruff_python_formatter/src/other/arguments.rs</code>:194 on 2023-07-18 11:22</div>
            <div class="timeline-body"><blockquote>
<p>is this guaranteed?</p>
</blockquote>
<p>Let me think about this later today.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cnpryer">@cnpryer</a> reviewed on 2023-07-18 11:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/cnpryer">@cnpryer</a> on <code>crates/ruff_python_formatter/src/other/arguments.rs</code>:194 on 2023-07-18 11:32</div>
            <div class="timeline-body"><p>My initial thought is it should be since afaik <code>lambda (</code> is a syntax error.</p>
<pre><code>SyntaxError: Unexpected token '('Ruff(E999)
</code></pre>
<p>But a couple more thoughts:</p>
<ul>
<li>I may not be thinking about <em>assignment</em> of dangling comments for <code>lambda</code>s.</li>
<li>Maybe I can run this on more code with an assertion.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cnpryer">@cnpryer</a> reviewed on 2023-07-18 11:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cnpryer">@cnpryer</a> on 2023-07-18 11:37</div>
            <div class="timeline-body"><p><a href="https://github.com/astral-sh/ruff/pull/5806#discussion_r1266630127">See comment</a>. In the meantime I'll mark this as ready since the debug assert is a good safeguard IIUC.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @cnpryer on 2023-07-18 11:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-07-18 16:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/other/arguments.rs</code>:194 on 2023-07-18 16:15</div>
            <div class="timeline-body"><p>I managed to construct this example:</p>
<pre><code class="language-python">a = (
    lambda  # a
           : 1
)
</code></pre>
<p>This is a pronouncedly strange edge case (it does neither make sense to have a comment there nor to break the empty lambda argument list over two lines), i.e. it doesn't matter where the comment ends up as long as it's stable, but currently we lose it which we shouldn't:</p>
<pre><code>{
    Node {
        kind: Arguments,
        range: 10..36,
        source: `lambda  # a⏎`,
    }: {
        &quot;leading&quot;: [],
        &quot;dangling&quot;: [
            SourceComment {
                text: &quot;# a&quot;,
                position: EndOfLine,
                formatted: false,
            },
        ],
        &quot;trailing&quot;: [],
    },
}
a = lambda: 1
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/cnpryer">@cnpryer</a> on <code>crates/ruff_python_formatter/src/other/arguments.rs</code>:194 on 2023-07-18 16:28</div>
            <div class="timeline-body"><p>Perfect. Thank you. I'll try to handle this today.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cnpryer">@cnpryer</a> reviewed on 2023-07-18 16:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cnpryer">@cnpryer</a> reviewed on 2023-07-19 00:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/cnpryer">@cnpryer</a> on <code>crates/ruff_python_formatter/src/other/arguments.rs</code>:194 on 2023-07-19 00:29</div>
            <div class="timeline-body"><p>bacf71356b7c397564b0f1f74e04406e6e034260 (I'll leave this unresolved to defer to a review)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @cnpryer on 2023-07-19 00:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_lambda.rs</code>:51 on 2023-07-19 06:17</div>
            <div class="timeline-body"><p>Since the dangling comments are now handled here, it is safe to override <code>fmt_dangling_comments</code> with a function that just returns <code>Ok(())</code>.</p>
<p>Unrelated to this PR: What would you think (and @konstin): Should we make <code>fmt_dangling_comments</code> always return <code>Ok(())</code> and instead have the default implementation assert that are dangling comments were formatted in debug builds? The downside is that we could potentially loose dangling comments in production because of it. But it seems error-prone having to remember that it is now safe override the function.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-07-19 06:17</div>
            <div class="timeline-body"><p>Looks good to me. Let's override <code>fmt_dangling_comments</code> and we're then good to merge</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-07-19 09:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/expr_lambda.rs</code>:51 on 2023-07-19 09:28</div>
            <div class="timeline-body"><p>yes, i think we should replace the current <code>fmt_dangling_comments</code>, maybe even keep a big match which nodes are allowed to have dangling comment and which should error when they have</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cnpryer">@cnpryer</a> on 2023-07-19 10:37</div>
            <div class="timeline-body"><p>Dang! So close</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cnpryer">@cnpryer</a> reviewed on 2023-07-19 11:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/cnpryer">@cnpryer</a> on <code>crates/ruff_python_formatter/src/expression/expr_lambda.rs</code>:51 on 2023-07-19 11:25</div>
            <div class="timeline-body"><blockquote>
<p>What would you think</p>
</blockquote>
<p>I think if I gave an opinion at this time it wouldn't be informed enough. I'll write this down so that later, if I can add to the conversation, I'll let you know if I have any other thoughts.</p>
<p>69384521d025f595e5eb95755d8993c8f5134299</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cnpryer">@cnpryer</a> reviewed on 2023-07-19 11:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/cnpryer">@cnpryer</a> on <code>crates/ruff_python_formatter/src/expression/expr_lambda.rs</code>:57 on 2023-07-19 11:40</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        // Override. Dangling comments are handled in `fmt_fields`.
</code></pre>
<p>Can I get this even with the auto-merge?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-07-19 11:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-07-19 11:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-07-19 11:49</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 03:31:00 UTC
    </footer>
</body>
</html>
