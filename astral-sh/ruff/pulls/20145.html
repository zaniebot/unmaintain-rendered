<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Better handling for panics and error messages - astral-sh/ruff #20145</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Better handling for panics and error messages</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20145">#20145</a>
        opened by <a href="https://github.com/amyreese">@amyreese</a>
        on 2025-08-29 00:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/amyreese">@amyreese</a> on 2025-08-29 00:25</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Improve handling of panics during linting, and increase visibility
of error messages and the call-to-action to report issues to the repo.</p>
<ul>
<li>Adds a new <code>panics</code> vector to the <code>Diagnostics</code> object</li>
<li>Updates the <code>check::lint_path</code> function to format and record panics
on the diagnostics result rather than immediately logging the error</li>
<li>Adds a new <code>printer::write_panics</code> function that logs any panics
followed by the message requesting the user submit a bug report</li>
<li>Call <code>write_panics</code> from the other <code>write_*</code> functions, but after
normal output is logged, so that the request is at the bottom of
output for user visibility</li>
<li>Check for panics and exit with code 2 (error)</li>
</ul>
<h2>Test Plan</h2>
<p>Manually added a <code>panic!</code> and ran ruff on a file:</p>
<pre><code>$ cargo run -p ruff -- check crates/ruff_linter/resources/test/fixtures/flake8_async/ASYNC250.py --no-cache --preview --select ASYNC250
...

     Running `target/debug/ruff check crates/ruff_linter/resources/test/fixtures/flake8_async/ASYNC250.py --no-cache --preview --select ASYNC250`
All checks passed!
error: Panicked while linting crates/ruff_linter/resources/test/fixtures/flake8_async/ASYNC250.py:
panicked at crates/ruff/src/diagnostics.rs:196:5:
thing happened
run with `RUST_BACKTRACE=1` environment variable to display a backtrace

error: This indicates a bug in Ruff. If you could open an issue at:

https://github.com/astral-sh/ruff/issues/new?title=%5BLinter%20panic%5D

...with the relevant file contents, the `pyproject.toml` settings, and the stack trace above, we'd be very appreciative!

&gt; [2]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @amyreese on 2025-08-29 00:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-29 00:37</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-08-29 12:45</div>
            <div class="timeline-body"><p>Thanks! I definitely should have thought of this earlier, and this version still does seem reasonable, but I finally thought to double check how ty handles this:</p>
<p>https://github.com/astral-sh/ruff/blob/e42006ece8c53f5e4196849af5c0b3d6c6fadfd2/crates/ty/src/lib.rs#L337-L358</p>
<p>I think they just construct a normal diagnostic with <code>Severity::Fatal</code>. That might allow us to accomplish something similar while reusing some of our existing diagnostic infrastructure. The individual error messages can go into each fatal diagnostic, and then we can check the <code>max_severity</code> at the end for the longer message about opening an issue. What do you think?</p>
<p>Edit: and here's where they construct these diagnostics:</p>
<p>https://github.com/astral-sh/ruff/blob/e42006ece8c53f5e4196849af5c0b3d6c6fadfd2/crates/ty_project/src/lib.rs#L687-L697</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amyreese">@amyreese</a> on 2025-08-29 19:47</div>
            <div class="timeline-body"><p>@ntBre so from what I can see, the problem with that approach is that when printing the results, ruff wants to sort the <code>Diagnostic</code> objects, which then requires an <code>Annotation</code> which needs a <code>Span</code> which itself needs a <code>SourceFile</code> which needs file contents, and so on. And none of that information is available at the level that the current <code>catch_unwind</code> is happening, so we either need to move the <code>catch_unwind</code> inside of <code>diagnostics::lint_path</code> after it has constructed the <code>SourceFile</code> object, or we need to change the logic around sorting diagnostics to accommodate diagnostics without an <code>Annotation</code> or <code>SourceFile</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @amyreese on 2025-09-05 00:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:46:48 UTC
    </footer>
</body>
</html>
