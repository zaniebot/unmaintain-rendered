<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Clarify how scopes are pushed and popped for comprehensions and generator expressions - astral-sh/ruff #13353</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Clarify how scopes are pushed and popped for comprehensions and generator expressions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13353">#13353</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-09-14 17:21
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-09-14 17:21</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>An invariant that must be upheld in the <code>SemanticIndexBuilder</code> is that any scope pushed onto the stack must later be popped off the stack. We uphold this invariant, but it's currently a little hard to follow exactly how this invariant is upheld for comprehensions and generator expressions, as the scope is pushed onto the stack in one method but popped off the stack in another method. This PR clarifies the code so that the comprehension scopes are always popped off the stack in the same scope where they are pushed onto the stack. <code>visit_generators</code> is renamed to <code>with_generators_scope()</code> and the method is modified so that it accepts a closure for visiting the comprehension's outer <code>elt</code> inside the new scope before the scope is popped off the stack. This is a similar pattern to the one we already use for the <code>with_type_params()</code> method.</p>
<h2>Test Plan</h2>
<p><code>cargo test</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2024-09-14 17:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2024-09-14 17:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2024-09-14 17:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-09-14 17:30</div>
            <div class="timeline-body"><p>Looks good!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2024-09-14 17:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-09-14 17:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-09-14 17:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-09-14 17:35</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 21:30:59 UTC
    </footer>
</body>
</html>
