<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explicitly ban overriding `extend` as part of a --config flag - astral-sh/ruff #10135</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Explicitly ban overriding <code>extend</code> as part of a --config flag</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10135">#10135</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-02-26 13:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-02-26 13:10</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Relates to #10035. Attempting to override <code>extend</code> as part of a --config flag doesn't work because we currently apply the configuration overrides given in the <code>--config</code> flag <em>after</em> any configuration options found in any <code>pyproject.toml</code>/<code>ruff.toml</code> files have been parsed and validated. But this particular override affects which config files ruff should be looking at in the first place, so we'd need to look for it at an earlier stage in the process.</p>
<p>Currently we just silently accept the argument but just don't do anything with it; this PR changes that so that we explicitly error out if a user tries to override <code>extend</code> using the <code>--config</code> flag. Longer term, we could possibly think about reworking how <code>--config</code> works so that it <em>is</em> possible to override <code>extend</code> using <code>--config</code>; or, we could add a separate option so that people can override <code>extend</code> properly via the command line.</p>
<h2>Test Plan</h2>
<p><code>cargo test</code>, and manual testing</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff/tests/lint.rs</code>:1 on 2024-02-26 13:11</div>
            <div class="timeline-body"><p>This should also ban passing <code>extend</code> as part of a <code>--config</code> flag when doing <code>ruff format</code>, but I didn't bother adding an equivalent test in <code>crates/ruff/tests/format.rs</code>, as it just felt duplicative. Lmk if you disagree!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-02-26 13:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by @MichaReiser on 2024-02-26 13:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cli</span> added by @MichaReiser on 2024-02-26 13:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/args.rs</code>:767 on 2024-02-26 13:18</div>
            <div class="timeline-body"><p>Nit: Implementing <code>Display</code> is mandatory for proper &quot;Error&quot; types that also implement the <code>Error</code> trait. That's why I liked the old implementation more (might also be worth to implement <code>impl Error for InvalidConfligFlagError</code>).</p>
<p>There's still a way for you to get to the error message by using <code>error.to_string()</code> (<code>to_string</code> is implemented by all types that implement <code>Display</code>.</p>
<p>The downside is that it possibly requires an allocation. I think that's fine, considering that we generate at most one error ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-02-26 13:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-26 13:19</div>
            <div class="timeline-body"><p>This is, in theory, a breaking change because it could break invocations like <code>ruff check --config extend=test.toml</code>. I think it's okay to move forward with this change, considering that it never worked the way the user intended.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-02-26 13:23</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+1 -0 violations, +0 -0 fixes in 1 projects; 42 projects unchanged)</p>
<details><summary><a href="https://github.com/pandas-dev/pandas">pandas-dev/pandas</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/pandas-dev/pandas/blob/edd45f68c196334734125f330fbd62de20dfb6d3/pandas/_libs/json.pyi#L7'>pandas/_libs/json.pyi:7:5:</a> PLR0917 Too many positional arguments (8/5)
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PLR0917 | 1 | 1 | 0 | 0 | 0 |</p>
</p>
</details>

<h3>Formatter (stable)</h3>
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<details><summary><a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)</summary>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to read examples/How_to_handle_rate_limits.ipynb: Expected a Jupyter Notebook, which must be internally stored as JSON, but this file isn't valid JSON: trailing comma at line 47 column 4
</code></pre>
</p>
</details>

<h3>Formatter (preview)</h3>
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<details><summary><a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)</summary>
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to read examples/How_to_handle_rate_limits.ipynb: Expected a Jupyter Notebook, which must be internally stored as JSON, but this file isn't valid JSON: trailing comma at line 47 column 4
</code></pre>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-02-26 15:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff/src/args.rs</code>:767 on 2024-02-26 15:32</div>
            <div class="timeline-body"><p>So, the reason why I got rid of the <code>Display</code> implementation is because I wanted to make invalid states unrepresentable in <code>ConfigArgumentParser::parse_ref</code>. With the new code structure, it's impossible to proceed beyond line 866 if we have an enum variant that doesn't have an underlying error -- and that's good, because those need to be treated differently when describing them in words than the enum variants that do have underlying errors. But if I implemented <code>Display</code> for this enum, it would work for all the variants alike, which actually feels like a bit of a footgun here.</p>
<p>Really this enum isn't an error type at all (we never wrap it with an <code>Err</code> and return it), just an enumeration of the various kinds of failure modes we could have had when trying to parse the a <code>--config</code> flag as TOML. Possibly it should just be renamed... but I'm still pretty new to Rust error-handling patterns :) What do you think?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-02-26 15:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/args.rs</code>:767 on 2024-02-26 15:39</div>
            <div class="timeline-body"><p>I see. Maybe name it <code>InvalidConfigFlagReason</code> to make it clear that it's never used in an <code>Err</code> (which I assumed is the case)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2024-02-26 16:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-02-26 16:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-07-01 10:29</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 21:56:31 UTC
    </footer>
</body>
</html>
