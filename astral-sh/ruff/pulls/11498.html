<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[flake8-async] Sleep with &gt;24 hour interval should usually sleep forever (ASYNC116) - astral-sh/ruff #11498</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[flake8-async] Sleep with &gt;24 hour interval should usually sleep forever (ASYNC116)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11498">#11498</a>
        opened by <a href="https://github.com/ekohilas">@ekohilas</a>
        on 2024-05-22 20:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ekohilas">@ekohilas</a></div>
            <div class="timeline-body">Summary
<p>Addresses #8451 by implementing rule 116 to add an unsafe fix when sleep is used with a &gt;24 hour interval to instead consider sleeping forever.</p>
<p>This rule is added as async instead as I my understanding was that these trio rules would be moved to async anyway.</p>
<p>There are a couple of TODOs, which address further extending the rule by adding support for lookups and evaluations, and also supporting <code>anyio</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ekohilas">@ekohilas</a> on <code>crates/ruff_linter/src/rules/flake8_async/rules/sleep_forever_call.rs</code>:12 on 2024-05-22 20:53</div>
            <div class="timeline-body"><p>We were discussing how &quot;no gil&quot; was renamed to &quot;free threading&quot; to remove negative language.</p>
<p>Thoughts on changing &quot;Why is this bad&quot; to something like &quot;How could it be better?&quot; across all rules?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ekohilas">@ekohilas</a> on <code>crates/ruff_linter/src/rules/flake8_async/snapshots/ruff_linter__rules__flake8_async__tests__ASYNC116_ASYNC116.py.snap</code>:1 on 2024-05-22 20:54</div>
            <div class="timeline-body"><p>Has a different testing methodology been thought about?
This feels error prone to me, since it can be easy to miss and difficult to know what exactly should pass or fail.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ekohilas">@ekohilas</a> on <code>ruff.schema.json</code>:1 on 2024-05-22 20:55</div>
            <div class="timeline-body"><p>I needed this schema to be explained to me, will add some extra documentation in a <a href="https://github.com/astral-sh/ruff/pull/11517/commits/048e0bd50742e654ffc0d93e6bd9a7d7b10fa6d7">new PR</a> to address this for future contributors if that&#x27;s okay.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ekohilas">@ekohilas</a> on <code>crates/ruff_linter/src/rules/flake8_async/rules/sleep_forever_call.rs</code>:89 on 2024-05-22 20:57</div>
            <div class="timeline-body"><p>help, as a previous c user this casting doesn&#x27;t feel right to me, and @AlexWaygood and @carljm had taken a look but couldn&#x27;t get this to work either.
What is the preferred way of doing this kind of logic?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ekohilas">@ekohilas</a> reviewed on 2024-05-22 20:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-05-22 21:02</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>âœ… ecosystem check detected no linter changes.</p>
Linter (preview)
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-05-22 21:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_linter/src/rules/flake8_async/rules/sleep_forever_call.rs</code>:89 on 2024-05-22 21:24</div>
            <div class="timeline-body"><p>I thought we had discussed a couple alternatives to avoid this lint, e.g. rounding the float value to the next highest integer and then doing an integer comparison. Did that not work?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-23 02:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/flake8_async/rules/sleep_forever_call.rs</code>:98 on 2024-05-23 02:11</div>
            <div class="timeline-body"><p>This returns a binding that should be used below in lieu of <code>replacement_function.to_string()</code>, since in theory this could end up being <code>trio.sleep_forever</code> rather than just <code>sleep_forever</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-23 02:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/flake8_async/rules/sleep_forever_call.rs</code>:44 on 2024-05-23 02:11</div>
            <div class="timeline-body"><p>Nit: more conventional in Ruff would be &quot;Replace with <code>trio.sleep_forever()</code>&quot;. These show up in VS Code and other editors as Quick Fix titles, so they should be short and imperative.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-23 02:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_async/ASYNC116.py</code>:51 on 2024-05-23 02:12</div>
            <div class="timeline-body"><p>Mind running <code>ruff format</code> over this to ensure (e.g.) newline consistency?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-23 02:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-23 02:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-23 02:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/flake8_async/snapshots/ruff_linter__rules__flake8_async__tests__ASYNC116_ASYNC116.py.snap</code>:1 on 2024-05-23 02:19</div>
            <div class="timeline-body"><p>The snapshot tests have been incredibly useful for us! I&#x27;m really happy with them -- we have extensive test coverage and it&#x27;s really easy to add coverage + review changes once you&#x27;re used to the format.</p>
<p>Structurally, it could be nice if each snippet were its own file. It could also be nice to somehow encode the expectation in the source itself, though I don&#x27;t know that a strategy like that it is consistent with snapshotting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ekohilas">@ekohilas</a> reviewed on 2024-05-23 15:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ekohilas">@ekohilas</a> on <code>crates/ruff_linter/src/rules/flake8_async/snapshots/ruff_linter__rules__flake8_async__tests__ASYNC116_ASYNC116.py.snap</code>:1 on 2024-05-23 15:15</div>
            <div class="timeline-body"><blockquote>
<p>The snapshot tests have been incredibly useful for us!</p>
</blockquote>
<p>Oh yes I agree! They are quite nice ðŸ˜Š We had them at a past job, but the indirection in combination with the human element of checking caused errors to happen every so often ðŸ˜ž</p>
<blockquote>
<p>Structurally, it could be nice if each snippet were its own file.</p>
</blockquote>
<p>I was thinking something like an <code>ASYNC116</code> folder with files for each test case, but I can also image that would be annoying to edit. I assume that something like this could work instead? <code>cargo run -p ruff -- check crates/ruff_linter/resources/test/fixtures/flake8_async/ASYNC116/ --no-cache --preview --select ASYNC116</code></p>
<blockquote>
<p>It could also be nice to somehow encode the expectation in the source itself,</p>
</blockquote>
<p>Would comments work for this, like in <code>ASYNC116.py</code>?</p>
<blockquote>
<p>though I don&#x27;t know that a strategy like that it is consistent with snapshotting.</p>
</blockquote>
<p>What are your thoughts on if there was an extra check that did something like &quot;each file can only have one error&quot; or &quot;an error must appear at the same line as a comment&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ekohilas">@ekohilas</a> reviewed on 2024-05-23 15:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ekohilas">@ekohilas</a> on <code>crates/ruff_linter/src/rules/flake8_async/rules/sleep_forever_call.rs</code>:44 on 2024-05-23 15:27</div>
            <div class="timeline-body"><p>Happy to update, although I&#x27;m not sure how unsafe edits appear in editors, should unsafe edits still be imperative?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ekohilas">@ekohilas</a> reviewed on 2024-05-23 15:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ekohilas">@ekohilas</a> on <code>crates/ruff_linter/src/rules/flake8_async/rules/sleep_forever_call.rs</code>:89 on 2024-05-23 15:30</div>
            <div class="timeline-body"><p>Ah yeah, if I remember correctly we had discussed that the problem with rounding to an int was that it could possibly overflow the int and that logic would need to be checked instead.
Thus neither method was ideal and thus we needed another opinion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ekohilas">@ekohilas</a> reviewed on 2024-05-23 15:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ekohilas">@ekohilas</a> on <code>crates/ruff_linter/src/rules/flake8_async/rules/sleep_forever_call.rs</code>:44 on 2024-05-23 15:31</div>
            <div class="timeline-body"><p>Discussed at sprints with @AlexWaygood that unsafe edits should still be imperative</p>
<pre><code>        Some(format!(&quot;Replace with `trio.sleep_forever()`&quot;))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ekohilas">@ekohilas</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_async/ASYNC116.py</code>:51 on 2024-05-23 15:32</div>
            <div class="timeline-body"><p>done, thoughts on having a ci job to check the format of <code>crates/ruff_linter/resources/test/**.*.py</code> ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ekohilas">@ekohilas</a> reviewed on 2024-05-23 15:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/ekohilas">@ekohilas</a> on 2024-05-23 16:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-05-23 20:20</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-23 20:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_async/ASYNC116.py</code>:51 on 2024-05-23 20:22</div>
            <div class="timeline-body"><p>Unfortunately in some cases we actively <em>don&#x27;t</em> want to re-format fixtures, since we&#x27;re often testing unformatted syntax intentionally (or, e.g., strange comment placement). I&#x27;d like to enable format on the fixtures, but we&#x27;d need to add suppression comments to some of the existing fixtures.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-23 20:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/flake8_async/rules/sleep_forever_call.rs</code>:89 on 2024-05-23 20:24</div>
            <div class="timeline-body"><p>Personally think this is ok -- we know that this constant fits in <code>f64</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-23 20:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-23 20:25</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:04:11 UTC
    </footer>
</body>
</html>
