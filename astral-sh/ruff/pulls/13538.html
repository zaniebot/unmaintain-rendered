<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red Knot - Infer the return value of bool()  - astral-sh/ruff #13538</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Red Knot - Infer the return value of bool()</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13538">#13538</a>
        opened by <a href="https://github.com/TomerBin">@TomerBin</a>
        on 2024-09-27 14:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/TomerBin">@TomerBin</a></div>
            <div class="timeline-body">

Summary
<p>Following #13449, this PR adds custom handling for the bool contractor, so when the input type has statically known truthiness value, it will be used as the return value of the bool function.
For example, in the following snippet x will now be resolved to <code>Literal[True]</code> instead of <code>bool</code>.</p>
<pre><code>x = bool(1)
</code></pre>


Test Plan
<p>Some cargo tests were added.</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/TomerBin">@TomerBin</a> on 2024-09-27 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/TomerBin">@TomerBin</a> on 2024-09-27 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/TomerBin">@TomerBin</a> on 2024-09-27 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-09-27 14:42</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/TomerBin:tomer/bool-function">CodSpeed Performance Report</a>
Merging #13538 will <strong>not alter performance</strong>
<p>Comparing <code>TomerBin:tomer/bool-function</code> (4aabb57) with <code>main</code> (1639488)</p>
Summary
<p><code>✅ 32</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-09-27 15:04</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-27 15:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2034 on 2024-09-27 17:04</div>
            <div class="timeline-body"><p>This should happen inside <code>Type::call</code> instead of here, and it should use <code>FunctionType::is_stdlib_symbol</code> instead of querying the builtin type and comparing for equality.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> requested changes on 2024-09-27 17:06</div>
            <div class="timeline-body"><p>Thank you!! This looks like the right behavior, but the implementation should go inside <code>Type::call</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Slyces">@Slyces</a> reviewed on 2024-09-27 18:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Slyces">@Slyces</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:598 on 2024-09-27 18:52</div>
            <div class="timeline-body"><p>This might not fit into the scope, but I&#x27;ve recently added some functions similar to <code>bool</code> in #13511, namely <code>repr</code> and <code>str</code>.</p>
<p>I think there&#x27;s a pattern where we&#x27;ll eventually want to extend this piece of code to deal with all currently implemented magic methods (<code>__bool__</code>, <code>__str__</code>, <code>__repr__</code>, ...) that have an associated builtin calling them.</p>
<p>Maybe we could introduce an enumeration for builtins with a method on <code>ClassType</code> that returns an <code>Option&lt;Builtin&gt;</code> to have something easily extendable like</p>
<pre><code>impl&lt;&#x27;db&gt; ClassType&lt;&#x27;db&gt; {
    pub(crate) fn to_maybe_builtin(self, db: &amp;&#x27;db dyn Db) -&gt; Option&lt;Builtin&gt; {
        if self.is_stdlib_symbol(db, &quot;builtins&quot;, &quot;bool&quot;) {
            Some(Builtin::Bool)
        } else if self.is_stdlib_symbol(db, &quot;builtins&quot;, &quot;str&quot;) {
            Some(Builtin::Str)
        } else if self.is_stdlib_symbol(db, &quot;builtins&quot;, &quot;repr&quot;) {
            Some(Builtin::Str)
        } else {
            None
        }
    }
 }
</code></pre>
<p>And in the selected code something along the lines of</p>
<pre><code>                let maybe_builtin = class.to_maybe_builtin(db);
                CallOutcome::callable(match maybe_builtin {
                    Some(Builtin::Bool) =&gt; arg_types
                        .first()
                        .unwrap_or(&amp;Type::Unknown)
                        .bool(db)
                        .into_type(db),
                    Some(Builtin::Str) =&gt; arg_types.first().unwrap_or(&amp;Type::Unknown).str(db),
                    Some(Builtin::Repr) =&gt; arg_types.first().unwrap_or(&amp;Type::Unknown).repr(db),
                    None =&gt; Type::Instance(class),
                })
</code></pre>
<p>Doing this for <code>repr</code> and <code>str</code> is obviously outside of scope.</p>
<p>What do you think @carljm ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-09-27 18:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:598 on 2024-09-27 18:57</div>
            <div class="timeline-body"><p>Yes, I think we will want to do something like this, though I think we may also want to store the <code>Builtin</code> enum value in the <code>ClassType</code> (and also in <code>FunctionType</code> -- this could simplify our support for <code>reveal_type</code>) so that we can just call <code>is_stdlib_symbol</code> when the class or function is defined, rather than at every call-site.</p>
<p>But I think that can/should be done as a separate PR, rather than as part of this PR; it&#x27;s easier to get these generalizations right once there are a few cases in place to generalize.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-09-27 19:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/carljm">@carljm</a> on 2024-09-27 19:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2024-09-27 19:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-09-27 19:18</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:07:02 UTC
    </footer>
</body>
</html>
