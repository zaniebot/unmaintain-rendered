<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-pyi`] Avoid syntax error in the case of starred and keyword arguments (`PYI059`) - astral-sh/ruff #18611</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-pyi</code>] Avoid syntax error in the case of starred and keyword arguments (<code>PYI059</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18611">#18611</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-06-10 14:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes https://github.com/astral-sh/ruff/issues/18602 by:</p>
<ol>
<li>Avoiding a fix when <code>*args</code> are present</li>
<li>Inserting the <code>Generic</code> base class right before the first keyword argument, if one is present</li>
</ol>
<p>In an intermediate commit, I also had special handling to avoid a fix in the <code>**kwargs</code> case, but this is treated (roughly) as a normal keyword, and I believe handling it properly falls out of the other keyword fix.</p>
<p>I also updated the <code>add_argument</code> utility function to insert new arguments right before the keyword argument list instead of at the very end of the argument list. This changed a couple of snapshots unrelated to <code>PYI059</code>, but there shouldn't be any functional changes to other rules because all other calls to <code>add_argument</code> were adding a keyword argument anyway.</p>
<h2>Test Plan</h2>
<p>Existing PYI059 cases, plus new tests based on the issue</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @ntBre on 2025-06-10 14:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ntBre on 2025-06-10 14:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @ntBre on 2025-06-10 14:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/generic_not_last_base_class.rs</code>:147 on 2025-06-10 14:41</div>
            <div class="timeline-body"><p>should we be adding this logic to <code>add_argument</code>, so that it's also fixed for other rules that use that utility? If we don't want to do that in this PR, is it worth opening a followup issue for that?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-10 14:42</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+0 -0 violations, +0 -26 fixes in 5 projects; 50 projects unchanged)</p>
<details><summary><a href="https://github.com/apache/airflow">apache/airflow</a> (+0 -0 violations, +0 -8 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
- <a href='https://github.com/apache/airflow/blob/8da0160cf9ecda249230c417d09ed248fd6db095/airflow-core/src/airflow/api_fastapi/auth/managers/base_auth_manager.py#L78'>airflow-core/src/airflow/api_fastapi/auth/managers/base_auth_manager.py:78:22:</a> PYI059 [*] `Generic[]` should always be the last base class
+ <a href='https://github.com/apache/airflow/blob/8da0160cf9ecda249230c417d09ed248fd6db095/airflow-core/src/airflow/api_fastapi/auth/managers/base_auth_manager.py#L78'>airflow-core/src/airflow/api_fastapi/auth/managers/base_auth_manager.py:78:22:</a> PYI059 `Generic[]` should always be the last base class
- <a href='https://github.com/apache/airflow/blob/8da0160cf9ecda249230c417d09ed248fd6db095/airflow-core/src/airflow/api_fastapi/common/exceptions.py#L37'>airflow-core/src/airflow/api_fastapi/common/exceptions.py:37:23:</a> PYI059 [*] `Generic[]` should always be the last base class
+ <a href='https://github.com/apache/airflow/blob/8da0160cf9ecda249230c417d09ed248fd6db095/airflow-core/src/airflow/api_fastapi/common/exceptions.py#L37'>airflow-core/src/airflow/api_fastapi/common/exceptions.py:37:23:</a> PYI059 `Generic[]` should always be the last base class
- <a href='https://github.com/apache/airflow/blob/8da0160cf9ecda249230c417d09ed248fd6db095/airflow-core/src/airflow/api_fastapi/core_api/base.py#L52'>airflow-core/src/airflow/api_fastapi/core_api/base.py:52:16:</a> PYI059 [*] `Generic[]` should always be the last base class
+ <a href='https://github.com/apache/airflow/blob/8da0160cf9ecda249230c417d09ed248fd6db095/airflow-core/src/airflow/api_fastapi/core_api/base.py#L52'>airflow-core/src/airflow/api_fastapi/core_api/base.py:52:16:</a> PYI059 `Generic[]` should always be the last base class
- <a href='https://github.com/apache/airflow/blob/8da0160cf9ecda249230c417d09ed248fd6db095/airflow-core/src/airflow/api_fastapi/core_api/services/public/common.py#L37'>airflow-core/src/airflow/api_fastapi/core_api/services/public/common.py:37:18:</a> PYI059 [*] `Generic[]` should always be the last base class
+ <a href='https://github.com/apache/airflow/blob/8da0160cf9ecda249230c417d09ed248fd6db095/airflow-core/src/airflow/api_fastapi/core_api/services/public/common.py#L37'>airflow-core/src/airflow/api_fastapi/core_api/services/public/common.py:37:18:</a> PYI059 `Generic[]` should always be the last base class
</pre>

</p>
</details>
<details><summary><a href="https://github.com/langchain-ai/langchain">langchain-ai/langchain</a> (+0 -0 violations, +0 -8 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
- <a href='https://github.com/langchain-ai/langchain/blob/e455fab5d3ca2820db2f49c5511a23b168a441ab/libs/core/langchain_core/output_parsers/base.py#L31'>libs/core/langchain_core/output_parsers/base.py:31:26:</a> PYI059 [*] `Generic[]` should always be the last base class
+ <a href='https://github.com/langchain-ai/langchain/blob/e455fab5d3ca2820db2f49c5511a23b168a441ab/libs/core/langchain_core/output_parsers/base.py#L31'>libs/core/langchain_core/output_parsers/base.py:31:26:</a> PYI059 `Generic[]` should always be the last base class
- <a href='https://github.com/langchain-ai/langchain/blob/e455fab5d3ca2820db2f49c5511a23b168a441ab/libs/core/langchain_core/prompts/base.py#L45'>libs/core/langchain_core/prompts/base.py:45:25:</a> PYI059 [*] `Generic[]` should always be the last base class
+ <a href='https://github.com/langchain-ai/langchain/blob/e455fab5d3ca2820db2f49c5511a23b168a441ab/libs/core/langchain_core/prompts/base.py#L45'>libs/core/langchain_core/prompts/base.py:45:25:</a> PYI059 `Generic[]` should always be the last base class
- <a href='https://github.com/langchain-ai/langchain/blob/e455fab5d3ca2820db2f49c5511a23b168a441ab/libs/core/langchain_core/runnables/base.py#L111'>libs/core/langchain_core/runnables/base.py:111:15:</a> PYI059 [*] `Generic[]` should always be the last base class
+ <a href='https://github.com/langchain-ai/langchain/blob/e455fab5d3ca2820db2f49c5511a23b168a441ab/libs/core/langchain_core/runnables/base.py#L111'>libs/core/langchain_core/runnables/base.py:111:15:</a> PYI059 `Generic[]` should always be the last base class
- <a href='https://github.com/langchain-ai/langchain/blob/e455fab5d3ca2820db2f49c5511a23b168a441ab/libs/core/langchain_core/stores.py#L26'>libs/core/langchain_core/stores.py:26:16:</a> PYI059 [*] `Generic[]` should always be the last base class
+ <a href='https://github.com/langchain-ai/langchain/blob/e455fab5d3ca2820db2f49c5511a23b168a441ab/libs/core/langchain_core/stores.py#L26'>libs/core/langchain_core/stores.py:26:16:</a> PYI059 `Generic[]` should always be the last base class
</pre>

</p>
</details>
<details><summary><a href="https://github.com/latchbio/latch">latchbio/latch</a> (+0 -0 violations, +0 -4 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
- <a href='https://github.com/latchbio/latch/blob/fe0d3801e44c64448f01372f01c9dc6574f805a6/src/latch/types/metadata.py#L440'>src/latch/types/metadata.py:440:25:</a> PYI059 [*] `Generic[]` should always be the last base class
+ <a href='https://github.com/latchbio/latch/blob/fe0d3801e44c64448f01372f01c9dc6574f805a6/src/latch/types/metadata.py#L440'>src/latch/types/metadata.py:440:25:</a> PYI059 `Generic[]` should always be the last base class
- <a href='https://github.com/latchbio/latch/blob/fe0d3801e44c64448f01372f01c9dc6574f805a6/src/latch/types/metadata.py#L489'>src/latch/types/metadata.py:489:24:</a> PYI059 [*] `Generic[]` should always be the last base class
+ <a href='https://github.com/latchbio/latch/blob/fe0d3801e44c64448f01372f01c9dc6574f805a6/src/latch/types/metadata.py#L489'>src/latch/types/metadata.py:489:24:</a> PYI059 `Generic[]` should always be the last base class
</pre>

</p>
</details>
<details><summary><a href="https://github.com/python/typeshed">python/typeshed</a> (+0 -0 violations, +0 -2 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview --select E,F,FA,I,PYI,RUF,UP,W</pre>
</p>
<p>

<pre>
- <a href='https://github.com/python/typeshed/blob/0db0486fe6a0eb6b4ebf1256fe0afe0b95e2dc36/stdlib/asyncio/queues.pyi#L28'>stdlib/asyncio/queues.pyi:28:12:</a> PYI059 [*] `Generic[]` should always be the last base class
+ <a href='https://github.com/python/typeshed/blob/0db0486fe6a0eb6b4ebf1256fe0afe0b95e2dc36/stdlib/asyncio/queues.pyi#L28'>stdlib/asyncio/queues.pyi:28:12:</a> PYI059 `Generic[]` should always be the last base class
</pre>

</p>
</details>
<details><summary><a href="https://github.com/zulip/zulip">zulip/zulip</a> (+0 -0 violations, +0 -4 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
- <a href='https://github.com/zulip/zulip/blob/3dc54a10d7cbfb6f6f66a868a31d17ee9e215f53/zerver/lib/notes.py#L12'>zerver/lib/notes.py:12:16:</a> PYI059 [*] `Generic[]` should always be the last base class
+ <a href='https://github.com/zulip/zulip/blob/3dc54a10d7cbfb6f6f66a868a31d17ee9e215f53/zerver/lib/notes.py#L12'>zerver/lib/notes.py:12:16:</a> PYI059 `Generic[]` should always be the last base class
- <a href='https://github.com/zulip/zulip/blob/3dc54a10d7cbfb6f6f66a868a31d17ee9e215f53/zerver/lib/queue.py#L35'>zerver/lib/queue.py:35:18:</a> PYI059 [*] `Generic[]` should always be the last base class
+ <a href='https://github.com/zulip/zulip/blob/3dc54a10d7cbfb6f6f66a868a31d17ee9e215f53/zerver/lib/queue.py#L35'>zerver/lib/queue.py:35:18:</a> PYI059 `Generic[]` should always be the last base class
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PYI059 | 26 | 0 | 0 | 0 | 26 |</p>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/generic_not_last_base_class.rs</code>:149 on 2025-06-10 14:43</div>
            <div class="timeline-body"><p>Hmm... it's unrelated to your PR, but I'm not sure that this should be a safe fix :-(</p>
<p>Moving the position of <code>Generic[]</code> in the bases tuple could change the behaviour of the code by changing the class's MRO, and it's <em>possible</em> that the code was actually working before the fix. (Having <code>Generic[]</code> as not-the-last base class can <em>sometimes</em> work, it's just... never advisable.)</p>
<p>Even if we're okay with the fix changing the behaviour of the code, is there a possibility it could delete comments in some situations? We discussed this in the original PR so I think we have good test coverage for it, but at that point in time we didn't have as rigorous a policy for whether a fix should be deemed to be unsafe if it removed comments: https://github.com/astral-sh/ruff/pull/11233#discussion_r1589099207</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-06-10 14:44</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-10 14:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/generic_not_last_base_class.rs</code>:147 on 2025-06-10 14:49</div>
            <div class="timeline-body"><p>Yeah, I actually checked the other callers of <code>add_argument</code>, and they were all adding keyword arguments! So I think it makes sense to fix this or add a note to the docs at the very least.</p>
<p>I don't mind doing it here, but I guess it might churn some snapshots to move the existing calls to the front of the kwarg list.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-10 14:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/generic_not_last_base_class.rs</code>:149 on 2025-06-10 14:56</div>
            <div class="timeline-body"><p>I was wondering about that too, thanks for bringing it up.</p>
<p>It definitely removes comments (<a href="https://play.ruff.rs/8b475e04-00a8-40c6-83b4-eb6d805b3f1e">playground</a>) trailing the <code>Generic</code> argument.</p>
<p>I'd be fine marking this always unsafe and adding a <code>## Fix safety</code> section saying that it can change the MRO and also delete comments, if that sounds good to you.</p>
<p>This seems like a lot of changes for a rule about to be stabilized. How are you feeling about that? I'm definitely fine leaving this in preview for another cycle.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-10 14:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/generic_not_last_base_class.rs</code>:149 on 2025-06-10 14:59</div>
            <div class="timeline-body"><blockquote>
<p>I'd be fine marking this always unsafe and adding a <code>## Fix safety</code> section saying that it can change the MRO and also delete comments, if that sounds good to you.</p>
</blockquote>
<p>That sounds good to me, yeah!</p>
<blockquote>
<p>This seems like a lot of changes for a rule about to be stabilized. How are you feeling about that? I'm definitely fine leaving this in preview for another cycle.</p>
</blockquote>
<p>Agreed -- let's make the changes proposed in this PR and the docs updates proposed in https://github.com/astral-sh/ruff/pull/18601, but leave it in preview for now?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/generic_not_last_base_class.rs</code>:147 on 2025-06-10 15:00</div>
            <div class="timeline-body"><p>I'm happy with doing it here or postponing to a followup -- either is fine by me!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-10 15:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-10 16:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/generic_not_last_base_class.rs</code>:147 on 2025-06-10 16:08</div>
            <div class="timeline-body"><p>I went ahead and did it here. It might have even shortened the net diff!</p>
<p>You're welcome to review again of course, but otherwise I'll just merge this when CI finishes. Thanks for the help!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-06-10 16:17</div>
            <div class="timeline-body"><p>Excellent!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-06-10 16:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-06-10 16:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-10 16:27</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:13:20 UTC
    </footer>
</body>
</html>
