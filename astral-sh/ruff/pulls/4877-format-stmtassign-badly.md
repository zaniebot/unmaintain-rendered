```yaml
number: 4877
title: Format StmtAssign, badly
type: pull_request
state: closed
author: konstin
labels:
  - internal
  - formatter
assignees: []
draft: true
base: main
head: format-statement-assign-badly
created_at: 2023-06-05T20:48:18Z
updated_at: 2023-06-12T12:37:24Z
url: https://github.com/astral-sh/ruff/pull/4877
synced_at: 2026-01-12T15:55:16Z
```

# Format StmtAssign, badly

---

_@konstin_

This is a near-verbatim formatting of assignment statements so we can see the effect of formatting the right hand side. It lacks the wrapping rules for the left hand side and will put the entire left hand side on one line.

On the snapshots this has mostly the effect of normalizing the whitespace around equals sign, but more importantly it will surface all changes to expressions.


---

_Comment by @konstin on 2023-06-05 20:48_

Current dependencies on/for this PR:
* main
  * **PR #4876** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4876" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #4877** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4877" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
      * **PR #4878** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4878" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/charliermarsh/ruff/4877?utm_source=stack-comment).

---

_Label `autoformatter` added by @konstin on 2023-06-05 20:48_

---

_Label `internal` added by @konstin on 2023-06-05 20:48_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/statement/stmt_assign.rs`:54 on 2023-06-05 20:58_

Nit: use the space element for adding whitespace

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/statement/stmt_assign.rs`:41 on 2023-06-05 20:59_

You mean equal?

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/statement/stmt_assign.rs`:22 on 2023-06-05 21:00_

Should this use value.format().with_options(Parenthesize::IfBreaks) to only add parentheses if necessary? Or what's black's behavior?

---

_@MichaReiser reviewed on 2023-06-05 21:01_

---

_Comment by @github-actions[bot] on 2023-06-05 21:16_

## PR Check Results
### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      5.5Â±0.01ms     7.4 MB/sec    1.00      5.5Â±0.01ms     7.4 MB/sec
formatter/numpy/ctypeslib.py               1.00   1073.5Â±1.58Âµs    15.5 MB/sec    1.02   1099.3Â±1.10Âµs    15.1 MB/sec
formatter/numpy/globals.py                 1.00    119.8Â±0.57Âµs    24.6 MB/sec    1.08    128.9Â±0.51Âµs    22.9 MB/sec
formatter/pydantic/types.py                1.00      2.4Â±0.00ms    10.7 MB/sec    1.04      2.5Â±0.03ms    10.3 MB/sec
linter/all-rules/large/dataset.py          1.00     13.8Â±0.07ms     2.9 MB/sec    1.00     13.8Â±0.08ms     2.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.3Â±0.01ms     5.0 MB/sec    1.00      3.3Â±0.01ms     5.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    408.0Â±0.45Âµs     7.2 MB/sec    1.00    407.9Â±0.43Âµs     7.2 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.8Â±0.01ms     4.4 MB/sec    1.00      5.8Â±0.03ms     4.4 MB/sec
linter/default-rules/large/dataset.py      1.00      6.6Â±0.01ms     6.1 MB/sec    1.00      6.6Â±0.01ms     6.2 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1426.8Â±7.53Âµs    11.7 MB/sec    1.00   1421.7Â±2.71Âµs    11.7 MB/sec
linter/default-rules/numpy/globals.py      1.00    156.6Â±0.25Âµs    18.8 MB/sec    1.00    157.3Â±2.54Âµs    18.8 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.0Â±0.01ms     8.6 MB/sec    1.00      3.0Â±0.00ms     8.6 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      6.9Â±0.03ms     5.9 MB/sec    1.00      6.9Â±0.04ms     5.9 MB/sec
formatter/numpy/ctypeslib.py               1.00   1305.8Â±9.09Âµs    12.8 MB/sec    1.02   1327.1Â±9.39Âµs    12.5 MB/sec
formatter/numpy/globals.py                 1.00    148.4Â±2.08Âµs    19.9 MB/sec    1.05    155.4Â±2.52Âµs    19.0 MB/sec
formatter/pydantic/types.py                1.00      3.0Â±0.04ms     8.6 MB/sec    1.03      3.0Â±0.02ms     8.4 MB/sec
linter/all-rules/large/dataset.py          1.00     16.6Â±0.12ms     2.4 MB/sec    1.01     16.7Â±0.15ms     2.4 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.3Â±0.09ms     3.9 MB/sec    1.00      4.3Â±0.02ms     3.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    429.1Â±5.31Âµs     6.9 MB/sec    1.01    433.2Â±7.36Âµs     6.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.2Â±0.05ms     3.6 MB/sec    1.00      7.1Â±0.03ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.00      8.4Â±0.09ms     4.9 MB/sec    1.00      8.4Â±0.04ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1736.5Â±9.65Âµs     9.6 MB/sec    1.00  1736.9Â±10.38Âµs     9.6 MB/sec
linter/default-rules/numpy/globals.py      1.00    187.7Â±2.35Âµs    15.7 MB/sec    1.00    186.9Â±1.75Âµs    15.8 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.8Â±0.02ms     6.8 MB/sec    1.01      3.8Â±0.02ms     6.7 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/statement/stmt_assign.rs`:22 on 2023-06-06 06:36_

I couldn't find a symbol like `Parenthesize::IfBreaks`, i now added a group and if_group_breaks which doesn't do the same as black but still at least keeps the line length constraint

---

_@konstin reviewed on 2023-06-06 06:36_

---

_@MichaReiser reviewed on 2023-06-06 07:46_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/statement/stmt_assign.rs`:22 on 2023-06-06 07:46_

Yeah, this is in the binary expression formatting

---

_@konstin reviewed on 2023-06-06 07:48_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/statement/stmt_assign.rs`:22 on 2023-06-06 07:48_

i realized i can change both PRs significantly with the new utils

---

_Marked ready for review by @konstin on 2023-06-06 12:14_

---

_Comment by @konstin on 2023-06-06 12:33_

tests are passing locally -.-

---

_Comment by @MichaReiser on 2023-06-06 15:15_

> tests are passing locally -.-

Can you try a cargo clean and then re-run the tests. It could be that cargo isn't picking up the new file.

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/statement/stmt_assign.rs`:36 on 2023-06-06 15:16_

NIt
```suggestion
        write!(
            f,
            [
                LhsAssignList::new(targets),
                space(),
                text("="),
                space(),
                value.format().with_options(Parenthesize::IfBreaks)
            ]
        )
```

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/statement/stmt_assign.rs`:56 on 2023-06-06 15:17_

Nit: But it seems you use this style intentionally (which is fine with me)
```suggestion
            return single_entry.format().fmt(f);
```

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/statement/stmt_assign.rs`:80 on 2023-06-06 15:18_

What do you mean by 84 chars on top level? Can you add an example?

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/statement/stmt_assign.rs`:86 on 2023-06-06 15:19_

Nit: You only need `format_args` if you want to format more than one element
```suggestion
                [group(&current
                    .format()
                    .with_options(Parenthesize::IfBreaks))]
```

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/statement/stmt_assign.rs`:101 on 2023-06-06 15:20_

This will create nested groups. The example I shared didn't require nested groups. Do you know if the nested groups are necessary? If not, then this could be simplified to simply wrap every expression in a group (without using recursion)

---

_@MichaReiser reviewed on 2023-06-06 15:20_

---

_Comment by @konstin on 2023-06-07 10:09_

The solution was the `--delete-unreferenced-snapshots` in `cargo insta test --all --all-features --delete-unreferenced-snapshots`

---

_Label `blocked` added by @konstin on 2023-06-07 15:43_

---

_Comment by @konstin on 2023-06-07 15:44_

This is block on Expr not working with formatting twice because the dummies are all constants and have different spacing rules from what they represent

---

_Converted to draft by @konstin on 2023-06-07 20:13_

---

_Comment by @konstin on 2023-06-08 10:01_

Closing in favor of #4938

---

_Closed by @konstin on 2023-06-08 10:01_

---

_Branch deleted on 2023-06-12 12:37_

---
