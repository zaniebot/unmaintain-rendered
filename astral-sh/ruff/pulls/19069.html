<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Fix panic for attribute expressions with empty value - astral-sh/ruff #19069</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Fix panic for attribute expressions with empty value</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19069">#19069</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-07-01 13:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-01 13:12</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>closes https://github.com/astral-sh/ty/issues/738</p>
<h2>Test Plan</h2>
<p>Added corpus test</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @sharkdp on 2025-07-01 13:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:5683 on 2025-07-01 13:13</div>
            <div class="timeline-body"><p>This is probably not the best (and not the broadest) fix here. Maybe @mtshiba could have a look at this if you find the time?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-07-01 13:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-01 13:16</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">rich (https://github.com/Textualize/rich)
- TOTAL MEMORY USAGE: ~142MB
+ TOTAL MEMORY USAGE: ~129MB

alerta (https://github.com/alerta/alerta)
- TOTAL MEMORY USAGE: ~117MB
+ TOTAL MEMORY USAGE: ~106MB

discord.py (https://github.com/Rapptz/discord.py)
-     memo fields = ~207MB
+     memo fields = ~189MB

vision (https://github.com/pytorch/vision)
-     memo fields = ~304MB
+     memo fields = ~276MB

paasta (https://github.com/yelp/paasta)
-     memo fields = ~171MB
+     memo fields = ~156MB

meson (https://github.com/mesonbuild/meson)
-     memo fields = ~334MB
+     memo fields = ~304MB

scikit-learn (https://github.com/scikit-learn/scikit-learn)
- TOTAL MEMORY USAGE: ~717MB
+ TOTAL MEMORY USAGE: ~652MB

sympy (https://github.com/sympy/sympy)
-     memo fields = ~1399MB
+     memo fields = ~1538MB

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mtshiba">@mtshiba</a> reviewed on 2025-07-07 18:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/mtshiba">@mtshiba</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:5683 on 2025-07-07 18:24</div>
            <div class="timeline-body"><p>Sorry for the late review. This fix looks good!</p>
<p>One thing I am wondering about is our current handling of (syntactically) invalid place expressions.
The parser seems to construct the following element for <code>[.a.</code>, for example:</p>
<pre><code>Attribute(ExprAttribute {
    node_index: AtomicNodeIndex(3),
    range: 1..3,
    value: Name(ExprName { node_index: AtomicNodeIndex(4), range: 1..1, id: Name(&quot;&quot;), ctx: Invalid }),
    attr: Identifier { id: Name(&quot;a&quot;), range: 2..3, node_index: AtomicNodeIndex(5) },
    ctx: Load
})
</code></pre>
<p>This is also not a valid expression and we can immediately return <code>Unbound</code>. Rather, this seems to cause a panic, but it doesn't. Because it is recorded as a place in the <code>UseDefMap</code>. The inner name is invalid, but the attribute is in the load context. Not harmful, but a useless record.</p>
<p>https://github.com/astral-sh/ruff/blob/f15f930053a829d366e55e2dee8c454f20f66dcd/crates/ty_python_semantic/src/semantic_index/builder.rs#L1945-L1962</p>
<p>It might be better to validate that the inner expressions are also valid when building the <code>SemanticIndex</code>, or to let the parser propagate the invalid context to the outer expressions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-07-08 08:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:5683 on 2025-07-08 08:58</div>
            <div class="timeline-body"><p>@dhruvmanila Would you mind also having a look at this, in particular the suggestion here to do part of the work in the parser?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-08 09:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:5683 on 2025-07-08 09:59</div>
            <div class="timeline-body"><blockquote>
<p>It might be better to validate that the inner expressions are also valid when building the <code>SemanticIndex</code>, or to let the parser propagate the invalid context to the outer expressions.</p>
</blockquote>
<p>I think it makes sense that if an inner expression is invalid then the entire attribute expression is marked as invalid by the parser. This would then be automatically excluded by the semantic index builder. We do related changes using the <a href="https://github.com/astral-sh/ruff/blob/1ddda241f69d6e1aa651d279983a9738ddb2f892/crates/ruff_python_parser/src/parser/helpers.rs#L9-L9"><code>helpers::set_expr_context</code></a> function.</p>
<p>Do we only need to account for the top-level invalid expression or any nested invalid expressions as well? For example, in <code>.a</code>, it's only the top level <code>value</code> expression of the attribute expression that's invalid but in <code>foo(1+).bar</code>, it's the inner expression (<code>+1</code>) that's invalid instead of the outer expression <code>foo(...)</code> and the outer expression corresponds to the <code>value</code> field of an attribute expression. I'm assuming it's the former?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mtshiba">@mtshiba</a> reviewed on 2025-07-08 17:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/mtshiba">@mtshiba</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:5683 on 2025-07-08 17:01</div>
            <div class="timeline-body"><blockquote>
<p>Do we only need to account for the top-level invalid expression or any nested invalid expressions as well? For example, in .a, it's only the top level value expression of the attribute expression that's invalid but in foo(1+).bar, it's the inner expression (+1) that's invalid instead of the outer expression foo(...) and the outer expression corresponds to the value field of an attribute expression. I'm assuming it's the former?</p>
</blockquote>
<p>The only expressions that should have invalid context propagated are those that are simple enough that <code>PlaceExpr::try_from</code> succeeds.
A complex expression like <code>f(1+).bar</code> is not recorded as a place in the <code>UseDefMap</code>, so the outer attribute <code>f(...).bar</code> can be used as the load context.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-09 04:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:5683 on 2025-07-09 04:27</div>
            <div class="timeline-body"><p>That seems a bit inconsistent because the parser shouldn't care whether the expression can be constructed by <code>PlaceExpr</code> or not. And, I don't think it really matters, right? Like, if there are any invalid expressions nested in the <code>ExprAttribute</code>, then the entire <code>ExprAttribute</code> is invalid and the parser shouldn't special case only specific expressions. But, if special casing is important, then I'd prefer to have this logic in ty and not in the parser.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-09 06:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:5683 on 2025-07-09 06:00</div>
            <div class="timeline-body"><p>Is changing the context in the parser significantely simpler than doing it in ty? If not, I'd suggest doing it in ty.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-09 06:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:5683 on 2025-07-09 06:21</div>
            <div class="timeline-body"><p>I think it won't be that simple change in the parser because we'd need to get this information (<code>ExprContext::Invalid</code>) up the AST to the <code>ExprAttribute</code> which could possibly be achieved by storing it in <code>ParsedExpr</code> (<code>is_invalid: bool</code> field) and using it in <code>parse_attribute_expression</code>. But, yeah, it might be simpler to do it in ty instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @sharkdp on 2025-07-09 06:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2025-07-09 06:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2025-07-09 06:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @sharkdp on 2025-07-09 06:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-07-09 06:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:5683 on 2025-07-09 06:24</div>
            <div class="timeline-body"><p>Thanks everyone. If this really only causes unnecessary work, I'm not sure it's worth doing something here at all. I'll move this PR to in-review to fix the original crash. It comes up easily in the LSP/playground when editing code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-07-09 06:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2025-07-09 06:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-07-09 06:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-09 06:46</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 18:33:37 UTC
    </footer>
</body>
</html>
