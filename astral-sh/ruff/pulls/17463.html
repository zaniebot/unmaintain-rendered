<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Detect semantic syntax errors - astral-sh/ruff #17463</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Detect semantic syntax errors</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17463">#17463</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-04-18 15:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR extends semantic syntax error detection to red-knot. The main changes here are:</p>
<ol>
<li>Adding <code>SemanticSyntaxChecker</code> and <code>Vec&lt;SemanticSyntaxError&gt;</code> fields to the <code>SemanticIndexBuilder</code></li>
<li>Calling <code>SemanticSyntaxChecker::visit_stmt</code> and <code>visit_expr</code> in the <code>SemanticIndexBuilder</code>'s <code>visit_stmt</code> and <code>visit_expr</code> methods</li>
<li>Implementing <code>SemanticSyntaxContext</code> for <code>SemanticIndexBuilder</code></li>
<li>Adding new mdtests to test the context implementation and show diagnostics</li>
</ol>
<p>(3) is definitely the trickiest and required (I think) a minor addition to the <code>SemanticIndexBuilder</code>. I tried to look around for existing code performing the necessary checks, but I definitely could have missed something or misused the existing code even when I found it.</p>
<p>There's still one TODO around <code>global</code> statement handling. I don't think there's an existing way to look this up, but I'm happy to work on that here or in a separate PR. This currently only affects detection of one error (<code>LoadBeforeGlobalDeclaration</code> or <a href="https://docs.astral.sh/ruff/rules/load-before-global-declaration/">PLE0118</a> in ruff), so it's not too big of a problem even if we leave the TODO.</p>
<h2>Test Plan</h2>
<p>New mdtests, as well as new errors for existing mdtests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @ntBre on 2025-04-18 15:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-18 15:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/resources/mdtest/comprehensions/basic.md</code>:132 on 2025-04-18 15:38</div>
            <div class="timeline-body"><p>This actually helped to reveal a bug in the first error here. I opened a separate PR to fix this in #17460, so this and the following case will be reduced to the second error once that lands.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-18 15:39</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-18 15:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/resources/mdtest/comprehensions/basic.md</code>:132 on 2025-04-18 15:39</div>
            <div class="timeline-body"><p>That PR does not fix the backticks around &quot;asynchronous comprehension.&quot; I can just fix that here since red-knot will be the only place this message is actually used.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-18 15:43</div>
            <div class="timeline-body"><p>The <code>mypy_primer</code> results look like true positives to me, although it's a bit unfortunate because it seems clear that this file is meant to be split up somehow:</p>
<p>https://github.com/laowantong/paroxython/blob/44e14b17965c6b02871db4c9ed6acc8716c2740d/examples/idioms/programs_with_labels.py#L690-L695</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-18 16:09</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>âœ… ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>âœ… ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @ntBre on 2025-04-18 16:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @ntBre on 2025-04-18 16:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @ntBre on 2025-04-18 16:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @ntBre on 2025-04-18 16:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @ntBre on 2025-04-18 16:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @ntBre on 2025-04-18 16:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @ntBre on 2025-04-18 16:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/annotations/invalid.md</code>:76 on 2025-04-18 16:55</div>
            <div class="timeline-body"><p>maybe let's just avoid the syntax errors by putting the entire <code>_</code> function inside an inner function? I think the syntax-error diagnostics here distract a bit from what this is meant to be testing</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/comprehensions/basic.md</code>:133 on 2025-04-18 16:57</div>
            <div class="timeline-body"><p>similarly here, I don't think the intent here was for this to test our resilience to invalid syntax (the test case is titled &quot;Basic&quot; ðŸ˜„), so I'd be inclined to do this to avoid the syntax error:</p>
<pre><code class="language-suggestion">async def _():
    [reveal_type(x) async for x in AsyncIterable()]
</code></pre>
<p>although it probably <em>is</em> a good idea for us to add a <em>separate</em> test case that demonstrates that we still infer types correctly even if there is invalid syntax!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/comprehensions/basic.md</code>:153 on 2025-04-18 16:58</div>
            <div class="timeline-body"><p>here too</p>
<pre><code class="language-suggestion">async def _():
    # revealed: @Todo(async iterables/iterators)
    [reveal_type(x) async for x in Iterable()]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-18 16:59</div>
            <div class="timeline-body"><p>ðŸ¥³</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-18 17:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/resources/mdtest/annotations/invalid.md</code>:76 on 2025-04-18 17:06</div>
            <div class="timeline-body"><p>Sounds good! I was on the fence between marking the errors or editing the test cases and went for leaving the test code untouched, but this definitely makes sense, especially for these easy-to-fix cases.</p>
<p>What did you think about the <code>match</code> cases in <code>star.md</code>? I actually started there and was going to edit them so that the name capture was last, but I wasn't sure if the <code>or</code> pattern was also important.</p>
<pre><code class="language-diff">diff --git a/a.py b/b.py
index f39fe59..2dd1a04 100644
--- a/a.py
+++ b/b.py
@@ -5,7 +5,7 @@ match 42:
         ...
     case [O]:
         ...
-    case P | Q:  # error: [invalid-syntax] &quot;name capture `P` makes remaining patterns unreachable&quot;
-        ...
     case object(foo=R):
         ...
+    case P:
+        ...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-18 17:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/annotations/invalid.md</code>:76 on 2025-04-18 17:09</div>
            <div class="timeline-body"><p>Ooh, thanks, I didn't spot that! Yes, it is important that that's an <code>Or</code> pattern. The LHS and RHS of the <code>|</code> don't necessarily need to be <code>Name</code>s though -- you could add two classes to the mdtest:</p>
<pre><code class="language-py">class Foo: ...
class Bar: ...
</code></pre>
<p>and then change the pattern to <code>Foo() | Bar()</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-18 20:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/resources/mdtest/annotations/invalid.md</code>:76 on 2025-04-18 20:50</div>
            <div class="timeline-body"><p>Actually in the <code>P</code> and <code>Q</code> case, it does look important for them to be <code>Name</code>s? They're used down below in in a <code>possibly-unresolved-reference</code> error:</p>
<p>https://github.com/astral-sh/ruff/blob/454ad15aee13e5ac2fc9b67ff5907658764207df/crates/red_knot_python_semantic/resources/mdtest/import/star.md?plain=1#L244-L246</p>
<p>The shortest diff preserving that later assertion would probably be nesting them inside something else like <code>case object(p=P) | object(q=Q)</code>, but I'm happy to do whatever best preserves your original intentions with the tests.</p>
<p>Actually that suggestion causes yet another syntax error in CPython that I didn't cover:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; match 42:
...     case object(p=P) | object(q=Q): ...
...
  File &quot;&lt;python-input-0&gt;&quot;, line 2
    case object(p=P) | object(q=Q): ...
         ^^^^^^^^^^^^^^^^^^^^^^^^^
SyntaxError: alternative patterns bind different names
</code></pre>
<p>and also causes an <code>unresolved-reference</code> to <code>R</code> instead of a <code>possibly-unresolved-reference</code>.</p>
<p>https://playknot.ruff.rs/616e62da-c1b8-4c2b-9c12-1a7c1bc34851</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/resources/mdtest/comprehensions/basic.md</code>:133 on 2025-04-18 21:00</div>
            <div class="timeline-body"><p>Updated! Leaving this unresolved for now in case we also want to add the separate test case. I'm guessing that could go in <code>invalid_syntax.md</code> next to this file? But maybe somewhere else is better.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-18 21:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2332 on 2025-04-18 21:45</div>
            <div class="timeline-body"><p>we already have a method for this one ;)</p>
<pre><code class="language-suggestion">        self.current_scope_is_global_scope()
</code></pre>
<p>but maybe we should just delete that method, move the implementation of that method to the trait method here, and refactor the callsites of the method to use the trait method? If you do that, I would simplify this implementation to:</p>
<pre><code class="language-suggestion">        self.scope_stack.len() == 1
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2348 on 2025-04-18 21:49</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        self.file.source_type(self.db.upcast()).is_ipynb()
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/annotations/invalid.md</code>:76 on 2025-04-18 21:50</div>
            <div class="timeline-body"><p>Ah, feel free to leave <code>star.md</code> as you have it then, don't worry too much about it! Would be great to open a followup issue about this and https://github.com/astral-sh/ruff/pull/17463#discussion_r2050872442 so we don't forget about it, though. I can look at it next week.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/diagnostics/semantic_syntax_errors.md</code>:85 on 2025-04-18 21:54</div>
            <div class="timeline-body"><p>hmm, yeah, ideally we would get rid of the <code>invalid-type-form</code> error here; it's just redundant noise to the user to have two diagnostics for the same problem. I think @MichaReiser has mentioned in the past that he wanted a global solution to make sure we didn't emit any red-knot diagnostics from type inference on nodes that were already known to be invalid syntax. Would be another thing that would be good to file a followup issue for IMO.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-04-18 21:55</div>
            <div class="timeline-body"><p>This is great, thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-21 13:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/resources/mdtest/annotations/invalid.md</code>:76 on 2025-04-21 13:14</div>
            <div class="timeline-body"><p>Opened #17522 and #17523 and added the new syntax error to #17412!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-21 13:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2332 on 2025-04-21 13:17</div>
            <div class="timeline-body"><p>I figured I would miss at least one existing method, thanks!</p>
<p>Hmm, I was worried about having to import the trait everywhere this method is used, but so far it's only used in this file. I'll move the implementation to the trait then!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-21 13:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/resources/mdtest/diagnostics/semantic_syntax_errors.md</code>:85 on 2025-04-21 13:21</div>
            <div class="timeline-body"><p>Opened #17524!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-04-21 15:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:1601 on 2025-04-21 15:41</div>
            <div class="timeline-body"><p>Yeah, I wonder if we can use <code>#[salsa::tracked(return_ref)]</code> on the <code>source_text</code> salsa query instead so that it returns a <code>&amp;SourceText</code> instead and <code>SourceText</code> is cheap clonable because the inner data is behind an <code>Arc</code> so we can just clone wherever the owned <code>SourceText</code> is required. (cc @MichaReiser)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-04-21 15:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/resources/mdtest/diagnostics/semantic_syntax_errors.md</code>:1 on 2025-04-21 15:44</div>
            <div class="timeline-body"><p>Does this cover all syntax errors that we detect or does it only cover a subset of it? I think it'd be useful to have at least one test case to cover each syntax error (could be done in a follow-up) so that any changes to the red-knot's semantic model is tested against these checks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-04-21 15:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/resources/mdtest/import/star.md</code>:1 on 2025-04-21 15:45</div>
            <div class="timeline-body"><p>Is it possible to avoid raising the syntax errors in this file by e.g., separating out the match statements to avoid unreachable patterns? cc @AlexWaygood</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-21 15:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/import/star.md</code>:1 on 2025-04-21 15:47</div>
            <div class="timeline-body"><p>yes, should definitely be possible -- I'll do it as a followup (https://github.com/astral-sh/ruff/issues/17523)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-04-21 15:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:92 on 2025-04-21 15:47</div>
            <div class="timeline-body"><p>At some point in the future, it would be useful to combine these flags into a <code>bitflags</code> or similar to avoid multiple fields.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/resources/mdtest/diagnostics/semantic_syntax_errors.md</code>:1 on 2025-04-21 15:50</div>
            <div class="timeline-body"><p>I believe this subset should cover every context method, which should be the main interaction with the semantic model. But it definitely wouldn't hurt to cover every error variant too!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-21 15:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-04-21 15:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2257 on 2025-04-21 15:52</div>
            <div class="timeline-body"><p>nit: should this method be named <code>seen_module_docstring_boundary</code> to explicitly state that it's for the module docstring and not other (function, class, etc.) docstring?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-04-21 15:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/resources/mdtest/diagnostics/semantic_syntax_errors.md</code>:1 on 2025-04-21 15:55</div>
            <div class="timeline-body"><p>Makes sense. This is not urgent and doesn't need to block this PR but something good to have.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2257 on 2025-04-21 15:56</div>
            <div class="timeline-body"><p>Ah, that is what the ruff <code>SemanticModel</code>'s method is called too. I'll update it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-21 15:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-04-21 16:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2286 on 2025-04-21 16:00</div>
            <div class="timeline-body"><p>We should probably <code>expect_function</code> here as otherwise there's some internal error if the scope kind doesn't originate from the function node.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-04-21 16:01</div>
            <div class="timeline-body"><p>Looks good!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-21 16:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/resources/mdtest/diagnostics/semantic_syntax_errors.md</code>:1 on 2025-04-21 16:29</div>
            <div class="timeline-body"><p>I might create a help-wanted issue, if that's not too lazy of me :laughing: Only a subset of errors are covered by ruff integration tests too. The rest rely on inline tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-21 17:16</div>
            <div class="timeline-body"><p>Thanks for the reviews! I think I've addressed all of the feedback we wanted to handle here and opened issues for the other follow-ups. I'll leave this open a bit longer in case anyone else wants to have a look, especially Micha since he's been pinged a couple of times here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/resources/mdtest/diagnostics/semantic_syntax_errors.md</code>:85 on 2025-04-22 11:44</div>
            <div class="timeline-body"><p>Yes, there's a TODO in the <code>InferContext</code> to suppress diagnostics in that case. I'm not entirely sure yet how that should work but isn't something that should block this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-22 11:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/resources/mdtest/snapshots/semantic_syntax_errors.md_-_Semantic_syntax_error_diagnostics_-_`async`_comprehensions_in_synchronous_comprehensions_-_Python_3.10.snap</code>:41 on 2025-04-22 11:46</div>
            <div class="timeline-body"><p>I'm a bit confused by this message. Isn't <code>f</code> async?</p>
<p>It's a bit a shame that we can't make use of the multi range diagnostics because it would be nice to have a second frame outlining &quot;why&quot; the context isn't async (which would address my confusion). I don't think this is something we should solve as part of this PR but maybe something to come back once we also use the new diagnostics in Ruff.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2264 on 2025-04-22 11:48</div>
            <div class="timeline-body"><p>It could make sense to cache this lookup in a field if this method is called frequently (<code>::get</code> and <code>.python_version</code> are roughly as expensive as a hash map lookup)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2342 on 2025-04-22 11:50</div>
            <div class="timeline-body"><p>I think it's better to use <code>source_text().is_notebook</code> here because that's what we have as source</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2271 on 2025-04-22 11:52</div>
            <div class="timeline-body"><p>I think I'd prefer to store a <code>LazyCell</code> on <code>SemanticIndexBuilder</code> that fetches the <code>SourceText</code> for the current file when needed (and stores it). This allows you to return a <code>&amp;str</code> here and also allows you to reuse the <code>source_text</code> when testing if the current file is a notebook.</p>
<p>(You can skip the <code>LazyCell</code> if both <code>with_source</code> and <code>is_notebook</code> are called rarely)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2346 on 2025-04-22 11:54</div>
            <div class="timeline-body"><p>Unlike Ruff, Red Knot also runs semantic indexing on third party files. We should avoid reporting any syntax errors for those files. You can check if a file is open by calling <code>db.is_file_open(file))</code>. Ideally, we would skip the entire <code>SemanticSyntaxChecker</code> for those files but we should at least avoiding pushing any errors.</p>
<p>https://github.com/astral-sh/ruff/blob/7d11ef156439ee63f2ae065cc2336e7fdabb24af/crates/red_knot_python_semantic/src/types/context.rs#L360-L362</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index.rs</code>:181 on 2025-04-22 11:56</div>
            <div class="timeline-body"><p>This could be a good use case for a <code>ThinVec</code> to shrink the size of this struct, considering that most files won't have any <code>SemanticSyntaxError</code>. I'm okay making this change as a separate PR and also applying it to <code>TypeCheckDiagnostics</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:93 on 2025-04-22 11:58</div>
            <div class="timeline-body"><p>You could use <code>extend</code> here so that it can reserve the right amount of elements (without having to check on every <code>push</code> call)</p>
<pre><code class="language-rust">diagnostics.extend(index.semantic_syntax_errors().iter().map(|diagnostic| create_semantic_syntax_diagnostic(file, error))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:859 on 2025-04-22 12:00</div>
            <div class="timeline-body"><p>I don't think it's good practice to create diagnostics without a main message. I suggest passing <code>err.to_string()</code> to the <code>Diagnostic::new</code> (instead of &quot;&quot;) and instead use no message in the annotation (the annotation's message should describe the annotated part).</p>
<p>We should make the same change for unsupported syntax and parse diagnostics but we can do this as a seprate PR (unless @BurntSushi thinks what we have now is better)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:1601 on 2025-04-22 12:04</div>
            <div class="timeline-body"><p>I don't fully remember the motivation for having <code>SourceText</code> and <code>SourceTextInner</code> instead of annotating the query with <code>return_ref</code> and replacing <code>SourceText</code> with <code>SourceTextInner</code>.</p>
<p>We could try changing the definition as a separate PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:91 on 2025-04-22 12:07</div>
            <div class="timeline-body"><p>Adding the diagnostic sementically fits better into <code>check_file_impl</code> because the diagnsotics aren't related to type checking. On the other hand, it doesn't really make a difference. That's why I think either way is fine (up to you)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:1056 on 2025-04-22 12:09</div>
            <div class="timeline-body"><p>This seems so simple that, arguably, we might just want to move this logic to the <code>SemanticSyntaxChecker</code> (the integration complexity is higher)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2368 on 2025-04-22 12:11</div>
            <div class="timeline-body"><p>You can call https://github.com/astral-sh/ruff/blob/be54b840e98a35069ab53746996684c887cc102c/crates/red_knot_python_semantic/src/semantic_index/builder.rs#L159-L161</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-04-22 12:11</div>
            <div class="timeline-body"><p>This looks great. I've a few smaller suggestions but I think this is good to go</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-22 12:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/snapshots/semantic_syntax_errors.md_-_Semantic_syntax_error_diagnostics_-_`async`_comprehensions_in_synchronous_comprehensions_-_Python_3.10.snap</code>:41 on 2025-04-22 12:17</div>
            <div class="timeline-body"><p>I <em>think</em> the &quot;synchronous function&quot; that the async list comprehension is immediately nested inside of here is the function-like scope created by the synchronous dict comprehension. But I agree that it would be great if we could have a clearer error and a multi-span diagnostic</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-22 12:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2342 on 2025-04-22 12:19</div>
            <div class="timeline-body"><p>oops, I think that's what @ntBre had originally but I suggested doing it this way. Sorry @ntBre! (Micha almost certainly knows best here)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-22 12:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/resources/mdtest/snapshots/semantic_syntax_errors.md_-_Semantic_syntax_error_diagnostics_-_`async`_comprehensions_in_synchronous_comprehensions_-_Python_3.10.snap</code>:41 on 2025-04-22 12:19</div>
            <div class="timeline-body"><p>Yes, <code>f</code> is async, but the version-related part is that you can't use an async comprehension inside of a sync comprehension before 3.11. This is the error message I'm trying to clean up in https://github.com/astral-sh/ruff/pull/17460, so I definitely agree that it's confusing!</p>
<p>That's a good point about the multi-span diagnostic too. We could definitely highlight the outer sync comprehension, as well as the inner async one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-22 12:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2368 on 2025-04-22 12:21</div>
            <div class="timeline-body"><p>Brent is deleting that method as part of this PR; current callsites of that method are being switched over to use the <code>in_module_scope</code> method being added here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-22 12:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:93 on 2025-04-22 12:27</div>
            <div class="timeline-body"><p><code>diagnostics.extend</code> takes an <code>other: &amp;TypeCheckDiagnostics</code> argument rather than an <code>Iterator&lt;Item = Diagnostic&gt;</code> or similar. That's why I went with <code>push</code> instead. Should I try to change some types in the <code>TypeCheckDiagnostics</code> implementation? What I really want is just <code>diagnostics.diagnostics.extend</code>, but the field is private too.</p>
<p>I could add an <code>extend_diagnostics</code> method maybe?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-22 12:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:93 on 2025-04-22 12:29</div>
            <div class="timeline-body"><p>Oh, I assumed it's a vec.</p>
<p>Would it work if you implement the <code>Extend</code> trait?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-22 12:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:91 on 2025-04-22 12:34</div>
            <div class="timeline-body"><p>Ah, is the <code>semantic_index</code> call cached with salsa? I thought I had to do it here because this is where the
<code>SemanticIndex</code> holding the errors was available, but if I can just call <code>semantic_index</code> again in <code>check_file_impl</code>, I can definitely move it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-22 12:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:1056 on 2025-04-22 12:35</div>
            <div class="timeline-body"><p>I think I ran into trouble moving this out of the ruff <code>Checker</code>, which led to it being a <code>Context</code> method in the first place, but I'll double check. It does look silly here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-22 12:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2368 on 2025-04-22 12:37</div>
            <div class="timeline-body"><p>Alex actually suggested deleting that method in favor of this one and inlining its implementation here. Happy to revert if you prefer the old one, though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-22 12:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2346 on 2025-04-22 12:42</div>
            <div class="timeline-body"><p>Oh that's good to know! Maybe I can put this check in <code>with_semantic_checker</code> and return without visiting anything in those cases. Is this a cheap check to run on ever statement/expression, or do I need to cache it somehow?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2271 on 2025-04-22 12:46</div>
            <div class="timeline-body"><p>I haven't profiled to be sure, but they don't look like they're called particularly often. <code>is_notebook</code> is usually gated by <code>in_module_scope</code>, but it is used in the <code>async</code> checks in global scope. <code>with_source</code> is only used for extracting a duplicate <code>match</code> mapping key, so it's almost never called.</p>
<p>But I still like the idea of the <code>LazyCell</code> and restoring the simple signature for the <code>source</code> method, so I think I'll do that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-22 12:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-22 12:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2342 on 2025-04-22 12:53</div>
            <div class="timeline-body"><p>No worries, I think <code>source_text</code> makes more sense in combination with the suggestion to cache it down below than it did when I wrote it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-22 12:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:93 on 2025-04-22 12:55</div>
            <div class="timeline-body"><p>Me too until <code>extend</code> didn't work :laughing: I'll try <code>Extend</code>, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-22 12:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2368 on 2025-04-22 12:55</div>
            <div class="timeline-body"><p>Wow I should have refreshed before commenting! Thanks @AlexWaygood!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-22 13:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2271 on 2025-04-22 13:22</div>
            <div class="timeline-body"><p>I'm actually having some trouble with the <code>LazyCell</code>. With this straightforward approach:</p>
<pre><code class="language-rust">        let mut builder = Self {
            db,
            file,
            source_text: LazyCell::new(|| source_text(db, file)),
            // ...
        };
</code></pre>
<p>the compiler is complaining that it found a closure capturing variables instead of an <code>fn</code> item. Am I doing something silly here, or should I try something else?</p>
<p>Obviously <code>LazyCell</code> closures can generally capture variables because there's an example in ruff, but maybe it's because I'm trying to return it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-22 14:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:93 on 2025-04-22 14:41</div>
            <div class="timeline-body"><p>I went with the <code>extend_diagnostics</code> method approach. The implementation is the same as <code>impl Extend&lt;Diagnostic&gt;</code>, but I had to call it in the qualified <code>Extend::extend</code> form to differentiate from the current <code>extend</code> method, so I thought it looked nicer this way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-22 15:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:91 on 2025-04-22 15:37</div>
            <div class="timeline-body"><p>Oh, <code>check_file_impl</code> is actually in a different crate, and <code>semantic_index</code> is <code>pub(crate)</code>. I think I'll just leave it here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:1056 on 2025-04-22 15:47</div>
            <div class="timeline-body"><p>I moved this field onto the <code>SemanticSyntaxChecker</code>. I think the previous problem was from also trying to delete the flag from ruff's <code>SemanticModel</code>. So there's a slight duplication with ruff tracking it separately, but it's just a single <code>bool</code> and allows deleting a whole context method.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-22 15:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-04-22 15:54</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_INSTRUMENTATION_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/brent%2Fsemantic-errors-red-knot">CodSpeed Performance Report</a></h2>
<h3>Merging astral-sh/ruff#17463 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>brent/semantic-errors-red-knot</code> (931fcf1) with <code>main</code> (5407249)</sub></p>
<h3>Summary</h3>
<p><code>âœ… 33</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-22 16:07</div>
            <div class="timeline-body"><p>I'm guessing (hoping) the horrible performance degradation was from my naive use of <code>is_file_open</code>. I started caching that on the builder and also merged main in case it was something else.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-22 16:15</div>
            <div class="timeline-body"><p>One more guess and then I'll set up for local benchmarks :sweat_smile: I'm not getting much from the salsa flamegraphs on codspeed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2388 on 2025-04-22 16:51</div>
            <div class="timeline-body"><p>You could consider changing the <code>semantic_checker</code> field on the <code>SemanticIndexBuilder</code> to be an <code>Option&lt;SemanticSyntaxChecker&gt;</code> and only initialize it with <code>Some</code> if the file is open. <code>with_semantic_checker</code> is a no-op if the checker is <code>None</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-22 16:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-22 16:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2346 on 2025-04-22 16:52</div>
            <div class="timeline-body"><p>You want to cache it. It's at least as expensive as a hash set lookup</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-22 16:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:108 on 2025-04-22 16:54</div>
            <div class="timeline-body"><p>We should move those fields into their own group (or to the <code>builder state</code> group at the top). The fields at the bottom are reserved for fields that match the fields on <code>SemanticIndex</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-22 16:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2346 on 2025-04-22 16:55</div>
            <div class="timeline-body"><p>Is this the caching you would do? I was confused why this didn't fix the perf regression: https://github.com/astral-sh/ruff/pull/17463/commits/5e172cc80125f788b93a826be2553ccb712b21cb.</p>
<p>I'll try the <code>Option</code> suggestion below, but I'm afraid it might cause the same issue if I do the check here again.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-22 17:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2271 on 2025-04-22 17:00</div>
            <div class="timeline-body"><p>I think the probleme here is more that you can't name the closure type when declaring <code>SemanticIndexBuilder</code>. You can try to use <code>OnceCell</code> instead</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-22 17:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2346 on 2025-04-22 17:08</div>
            <div class="timeline-body"><p>The regression went away, no? I no longer see the 33% regression. A 1% regresssion doesn't sound that unreasonable to me</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-22 17:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2346 on 2025-04-22 17:11</div>
            <div class="timeline-body"><p>It went away after I reverted my first two attempts and moved the check into <code>report_semantic_error</code>. The benchmark just finished on the <code>Option</code> case and it seems to have brought back the regression. Do you have an intuition why calling <code>is_file_open</code> in <code>SemanticIndexBuilder::new</code> is such a disaster?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-22 17:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2346 on 2025-04-22 17:26</div>
            <div class="timeline-body"><p>Not really. <code>is_file_open</code> is a &quot;cheap&quot; hash set lookup in the benchmark case</p>
<p>https://github.com/astral-sh/ruff/blob/9c47b6dbb0f29369fdf38d5048276994b2e09e49/crates/red_knot_project/src/lib.rs#L316-L324</p>
<p>It also doesn't introduce any new query dependencies that would be expensive to validate.</p>
<p>I can try to debug this tomorrow.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-22 17:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2346 on 2025-04-22 17:29</div>
            <div class="timeline-body"><p>Thanks, and sorry for the trouble. I'll push my other changes, I think everything else should be resolved.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-22 17:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2346 on 2025-04-22 17:53</div>
            <div class="timeline-body"><p>Okay. I think I know what's happening but I don't have a solution for this yet.</p>
<p>Salsa assigns values to different durabilities. This allows it to short-circuit some expensive checks if nothing of that durability has changed. In our case, we use a <em>higher</em> durability for files from the standard library because they can never change (all files in typeshed are shipped as part of the red knot binary).</p>
<p>That means, the <code>semantic_index</code> query for files from typeshed currently have a high durability. However, this is no longer the case if we call <code>is_file_open</code> because it reads <code>open_files</code> which has a low durability -&gt; Making the entire query having a low durability.</p>
<p>The easiest fix is to change <code>is_file_open</code> to always return <code>false</code> if <code>file.path(db).is_vendored()</code>. However, this still has the downside that it reduces the durability of <code>semantic_index</code> for all third-party files to <code>low</code>.</p>
<p>I've to think a bit more about what the proper fix is here. Maybe going back to when you emit the diagnostic isn't that bad after all.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @carljm on 2025-04-23 05:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-23 06:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2346 on 2025-04-23 06:44</div>
            <div class="timeline-body"><p>I went ahead and created an issue for this &quot;downgrading&quot; problem as this might is also a problem for type inference diagnostics. To unblock this PR, I suggest to go back to your implementation where you lazily check if the file is open before reporting the diagnostic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-23 13:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:2346 on 2025-04-23 13:26</div>
            <div class="timeline-body"><p>Thanks for tracking down the issue! I've reverted to having the check in <code>report_semantic_error</code>.</p>
<p>I'll make sure the benchmarks pass this time and then get ready to merge, if that's good with you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-04-23 13:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-04-23 13:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-23 13:53</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:11:41 UTC
    </footer>
</body>
</html>
