<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CI: Use a native version of Shellcheck instead of WASI - astral-sh/ruff #17108</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>CI: Use a native version of Shellcheck instead of WASI</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17108">#17108</a>
        opened by <a href="https://github.com/akx">@akx</a>
        on 2025-04-01 06:04
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/akx">@akx</a> on 2025-04-01 06:04</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Refs https://github.com/astral-sh/ruff/pull/17092#issuecomment-2768137890, this switches the CI pipeline to use a native version of Shellcheck pulled from GitHub Releases instead of the WASI compilation.</p>
<p>cc @AlexWaygood</p>
<h2>Test Plan</h2>
<p>I tried this out in my fork of <code>ruff</code> (where it made a cold-cache <code>pre-commit</code> CI step faster than a hot-cache run), and we're probably about to find out how it works here in upstream land.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-01 06:13</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>‚úÖ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>‚úÖ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @AlexWaygood by @AlexWaygood on 2025-04-01 07:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-01 12:29</div>
            <div class="timeline-body"><p>Nice, that's quite an impressive speedup... I knew that the actionlint step was slow (it's why it's only run if you pass <code>--hook-stage=manual</code>), but I didn't realise it was taking up <em>so</em> much time in the GitHub Actions run.</p>
<p>Did you verify that the shellcheck integration is still working as expected? I.e., does it still catch shell-scripting errors embedded in GitHub Actions <code>run:</code> steps?</p>
<p>A thing I don't really like about this approach is that it means you won't be able to run the pre-commit hook manually locally unless you have shellcheck preinstalled. (Or, well, you <em>will</em> be able to run the hook, but it won't actually check the same things as it checks in CI unless you have shellcheck preinstalled.) That seems confusing enough that we'd probably have to document it in our <code>CONTRIBUTING.md</code> file -- but I'd much rather contributors didn't have to install any other tools at all. Sorta the point of pre-commit, in my opinion, is that it makes it very easy to locally run exactly the same commands that are run in CI.</p>
<p>You mentioned in https://github.com/astral-sh/ruff/pull/17092#issuecomment-2768137890 that a big reason this might be so slow in CI is because the GitHub Actions runners are starved of cores -- we could see if switching to the larger depot runners helps. We use them in some other jobs already, e.g. https://github.com/astral-sh/ruff/blob/d0c8eaa0923352ccc4ec30c9fac1f573f20998b3/.github/workflows/ci.yaml#L201-L203</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/akx">@akx</a> on 2025-04-01 12:58</div>
            <div class="timeline-body"><blockquote>
<p>Did you verify that the shellcheck integration is still working as expected? I.e., does it still catch shell-scripting errors embedded in GitHub Actions <code>run:</code> steps?</p>
</blockquote>
<p>Yes ‚Äì an earlier version of this had <code>cd $(mktemp -d)</code>, which <a href="https://github.com/akx/ruff/actions/runs/14188273689/job/39747397724">shellcheck dutifully did flag me to make <code>cd &quot;$(mktemp -d)&quot;</code> instead.</a></p>
<blockquote>
<p>A thing I don't really like about this approach is that it means you won't be able to run the pre-commit hook manually locally unless you have shellcheck preinstalled.</p>
</blockquote>
<p>I was thinking the same ‚Äì but then again, this check is disabled by default anyway, so I doubt too many contributors would know to run <code>--hook-stage=manual</code> if they hadn't peeked in the pre-commit configuration to find the comment about this. üòÖ</p>
<blockquote>
<p>You mentioned in https://github.com/astral-sh/ruff/pull/17092#issuecomment-2768137890 that a big reason this might be so slow in CI is because the GitHub Actions runners are starved of cores</p>
</blockquote>
<p>That was, tbh, before I noticed it's running WASM in a Go-based interpreter. üòÑ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-01 13:05</div>
            <div class="timeline-body"><blockquote>
<p>Yes ‚Äì an earlier version of this had <code>cd $(mktemp -d)</code>, which <a href="https://github.com/akx/ruff/actions/runs/14188273689/job/39747397724">shellcheck dutifully did flag me to make <code>cd &quot;$(mktemp -d)&quot;</code> instead.</a></p>
</blockquote>
<p>Nice, thank you ‚ù§Ô∏è</p>
<blockquote>
<p>I was thinking the same ‚Äì but then again, this check is disabled by default anyway, so I doubt too many contributors would know to run <code>--hook-stage=manual</code> if they hadn't peeked in the pre-commit configuration to find the comment about this. üòÖ</p>
</blockquote>
<p>hmm, true. It's still nice for me, personally, to be able to run exactly the same thing locally as is run in CI, though ;-)</p>
<p>I'd like to experiment with switching to the depot runners and see how much that buys us</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ci</span> added by @AlexWaygood on 2025-04-01 13:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/akx">@akx</a> on 2025-04-01 13:08</div>
            <div class="timeline-body"><blockquote>
<p>I'd like to experiment with switching to the depot runners and see how much that buys us</p>
</blockquote>
<p>Sure, but I wouldn't be holding my breath for great gains there. I can whip up a sibling PR anyway, just a sec.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-01 13:22</div>
            <div class="timeline-body"><p>Thanks for your work on this!! https://github.com/astral-sh/ruff/pull/17120 got this down to 30s, which I think is &quot;fast enough&quot; now :-D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-04-01 13:22</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:41:05 UTC
    </footer>
</body>
</html>
