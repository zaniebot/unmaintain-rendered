<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] flatten unions - astral-sh/ruff #11783</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] flatten unions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11783">#11783</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2024-06-06 21:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body"><p>Flatten union types. Fixes #11781</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/carljm">@carljm</a> on 2024-06-06 21:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/carljm">@carljm</a> on 2024-06-06 21:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/carljm">@carljm</a> on 2024-06-06 21:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/src/semantic/types/infer.rs</code>:627 on 2024-06-06 21:08</div>
            <div class="timeline-body"><p>When printing the revealed type to the user, it would be nice if we could prettify this to <code>Literal[C1, C2, C3]</code> (pyright does this: https://pyright-play.net/?pyrightVersion=1.1.361&amp;strict=true&amp;code=MYRgBAvGIFDATJM84GYmpgMwDYEMBzAGjF0MSgCMB7anACgEoSa6mYAPJUMASy1L4CYAKY4AziLAI%2BAsgURjJ0zACcRANxF4cAfQAuATwAOI%2Bh0YwgA). But doesn&#x27;t need to be done now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-06-06 21:20</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/src/semantic/types.rs</code>:245 on 2024-06-06 21:20</div>
            <div class="timeline-body"><p>It took me a little while to understand why <code>either</code> was being used here. I think here I&#x27;d find a more imperative approach more readable (and then we don&#x27;t need the new <code>either</code> dependency for the crate):</p>
<pre><code>        let mut flattened = Vec::with_capacity(elems.len());
        for elem in elems {
            match elem {
                Type::Union(union_id) =&gt; flattened.extend(union_id.elements(self)),
                _ =&gt; flattened.push(*elem),
            }
        }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/src/semantic/types.rs</code>:546 on 2024-06-06 21:26</div>
            <div class="timeline-body"><p>It&#x27;s a bit weird to me that we have to call <code>.collect()</code> here in order to create the iterator instance. Normally I wouldn&#x27;t expect a method returning an iterator to allocate anything, but here there is an allocation under the hood.</p>
<p>If we&#x27;re already collecting, why don&#x27;t we just return <code>Vec&lt;Type&gt;</code> from <code>.elements()</code>? You can do more with a <code>Vec</code> than you can with an iterator. Or do you not want us to start relying on that API?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-06-06 21:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-06-06 21:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/src/semantic/types/infer.rs</code>:627 on 2024-06-06 21:27</div>
            <div class="timeline-body"><p>Oh, I see you already created #11782 :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/src/semantic/types/infer.rs</code>:627 on 2024-06-06 21:37</div>
            <div class="timeline-body"><p>Feel free to open an issue for this!</p>
<p>One thing that&#x27;s not clear to me is whether we want to mix different kinds of literals or not. E.g. do we prefer <code>Literal[1, C, &quot;foo&quot;, &quot;bar&quot;]</code> or <code>Literal[1] | Literal[C] | Literal[&quot;foo&quot;, &quot;bar&quot;]</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-06-06 21:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-06-06 21:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/src/semantic/types/infer.rs</code>:627 on 2024-06-06 21:37</div>
            <div class="timeline-body"><p>In #11784 I did this condensing, but only for int literals so far.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-06-06 21:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/src/semantic/types.rs</code>:245 on 2024-06-06 21:40</div>
            <div class="timeline-body"><p>Ugh, but it took me a while to figure out how to do this successfully with <code>flat_map</code>! Ok, ok, I&#x27;ll switch to imperative style...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-06-06 21:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/src/semantic/types/infer.rs</code>:627 on 2024-06-06 21:44</div>
            <div class="timeline-body"><blockquote>
<p>One thing that&#x27;s not clear to me is whether we want to mix different kinds of literals or not. E.g. do we prefer <code>Literal[1, C, &quot;foo&quot;, &quot;bar&quot;]</code> or <code>Literal[1] | Literal[C] | Literal[&quot;foo&quot;, &quot;bar&quot;]</code>?</p>
</blockquote>
<p>yeah, not sure... especially with objects (such as classes) that users might not be expecting to see in a <code>Literal</code> slice... I&#x27;ll possibly open an issue tomorrow, gonna call it for the night pretty soon!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-06-06 21:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/src/semantic/types.rs</code>:546 on 2024-06-06 21:48</div>
            <div class="timeline-body"><p>Yeah, you&#x27;re right, this should just return an owned vec. I might not even need it at all if I do the imperative version above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-06-06 21:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/src/semantic/types/infer.rs</code>:627 on 2024-06-06 21:51</div>
            <div class="timeline-body"><p>I went ahead and created #11785</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/carljm">@carljm</a> on 2024-06-06 22:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2024-06-06 22:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-06-06 22:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-06-07 16:08</div>
            <div class="timeline-body"><p>I managed to get the <code>elements()</code> method working without any <code>.collect()</code> calls, if you&#x27;re interested:</p>
<pre><code>diff --git a/crates/red_knot/src/semantic/types.rs b/crates/red_knot/src/semantic/types.rs
index 360b157c5..ae866e00c 100644
--- a/crates/red_knot/src/semantic/types.rs
+++ b/crates/red_knot/src/semantic/types.rs
@@ -1,4 +1,6 @@
 #![allow(dead_code)]
+use std::iter::FusedIterator;
+
 use crate::ast_ids::NodeKey;
 use crate::db::{QueryResult, SemanticDb, SemanticJar};
 use crate::files::FileId;
@@ -531,12 +533,41 @@ pub struct UnionTypeId {
 }
 
 impl UnionTypeId {
-    pub fn elements(self, type_store: &amp;TypeStore) -&gt; Vec&lt;Type&gt; {
+    pub fn elements(self, type_store: &amp;TypeStore) -&gt; UnionElementsIterator {
         let union = type_store.get_union(self);
-        union.elements.iter().copied().collect()
+        UnionElementsIterator { union, index: 0 }
     }
 }
 
+pub struct UnionElementsIterator&lt;&#x27;a&gt; {
+    union: UnionTypeRef&lt;&#x27;a&gt;,
+    index: usize,
+}
+
+impl&lt;&#x27;a&gt; Iterator for UnionElementsIterator&lt;&#x27;a&gt; {
+    type Item = Type;
+
+    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {
+        let item = self.union.elements.get_index(self.index).copied();
+        self.index += 1;
+        item
+    }
+
+    fn size_hint(&amp;self) -&gt; (usize, Option&lt;usize&gt;) {
+        let size = self.union.elements.len() - self.index;
+        (size, Some(size))
+    }
+
+    fn last(self) -&gt; Option&lt;Self::Item&gt; {
+        self.union.elements.last().copied()
+    }
+}
+
+impl&lt;&#x27;a&gt; FusedIterator for UnionElementsIterator&lt;&#x27;a&gt; {}
+impl&lt;&#x27;a&gt; ExactSizeIterator for UnionElementsIterator&lt;&#x27;a&gt; {}
</code></pre>
<p>A bit more verbose, but maybe worth it if we&#x27;ll be iterating over union elements a lot? WDYT?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-06-07 16:29</div>
            <div class="timeline-body"><p>Yeah, I think that&#x27;s probably worth it! I knew this type of borrowing iterator was an option, but at the time I was being stubborn about trying to get it working with <code>flat_map</code>, which requires that the returned iterator own its items, meaning this type of iterator wouldn&#x27;t work for that. But now that we aren&#x27;t using <code>flat_map</code> to flatten anyway, this would work fine.</p>
<p>We should do the same for <code>IntersectionPositiveIterator</code> and <code>IntersectionNegativeIterator</code> as well.</p>
<p>I think this is something that can wait until post-Salsa, though; no need to introduce more PRs right now for Micha to port.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:04:31 UTC
    </footer>
</body>
</html>
