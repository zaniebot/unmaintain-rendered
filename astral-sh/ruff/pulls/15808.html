<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Extend instance-attribute tests - astral-sh/ruff #15808</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Extend instance-attribute tests</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15808">#15808</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-01-29 11:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body">Summary
<p>When we discussed the plan on how to proceed with instance attributes, we said that we should first extend our research into the behavior of existing type checkers. The result of this research is summarized in the newly added / modified tests in this PR. The TODO comments align with existing behavior of other type checkers. If we deviate from the behavior, it is described in a comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-29 11:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-29 11:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-29 11:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-29 11:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-29 11:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:106 on 2025-01-29 11:43</div>
            <div class="timeline-body"><p>This section has only been moved.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:192 on 2025-01-29 11:52</div>
            <div class="timeline-body"><p>ooh, interesting. Yeah, I can see how this could be hard. Simply checking that the <code>this</code> variable in <code>__init__</code> has the same type as <code>self</code> would not be sufficient; you&#x27;d need to know that it refers to exactly the same object as <code>self</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:333 on 2025-01-29 11:59</div>
            <div class="timeline-body"><p>Pyright emits an error here but mypy does not, which might be worth a comment.</p>
<p>I agree that it&#x27;s unsafe to redeclare a mutable variable with a subtype of the type of the variable as it exists on the superclass <code>Foo</code>. Mutable variables <em>should</em> really be invariant rather than covariant.</p>
<p>Unfortunately I think a lot of typed Python code assumes that this kind of thing will be allowed, though, as mypy has always (unsafely) treated mutable instance attributes as covariant, and for a while I think pyright did too. So doing what pyright does here might cause compatibility issues for users migrating from mypy. This could possibly be a disabled-by-default error code, since I think in practice it doesn&#x27;t actually cause a large number of type-safety issues for users.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-01-29 11:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-29 12:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:333 on 2025-01-29 12:28</div>
            <div class="timeline-body"><blockquote>
<p>Pyright emits an error here but mypy does not, which might be worth a comment.</p>
</blockquote>
<p>Done, thanks.</p>
<blockquote>
<p>This could possibly be a disabled-by-default error code, since I think in practice it doesn&#x27;t actually cause a large number of type-safety issues for users.</p>
</blockquote>
<p>Hm. Sure, we can still discuss whether that should be enabled by default or not, but it seems to me like this is something that could easily cause problems? All of the following is well typed if you were to allow the <code>var: int = 1</code> re-declaration on <code>Derived</code> (and in fact, as you said, mypy sees no problem with this program):</p>
<pre><code>class Base:
    var: int | None = None

    def reset(self) -&gt; None:
        self.var = None

class Derived(Base):
    var: int = 1

derived = Derived()
derived.reset()

derived.var + 1  # Boom!
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:192 on 2025-01-29 13:06</div>
            <div class="timeline-body"><p>Interestingly, pyright does actually seem to have <a href="https://microsoft.github.io/pyright/#/type-concepts-advanced?id=inferred-type-of-self-and-cls-parameters">a special treatment of <code>self</code> / <code>cls</code></a>:</p>
<blockquote>
<p>When a type annotation for a methodâ€™s <code>self</code> or <code>cls</code> parameter is omitted, pyright will infer its type based on the class that contains the method. The inferred type is internally represented as a type variable that is bound to the class.</p>
<p>The type of <code>self</code> is represented as <code>Self@ClassName</code> where <code>ClassName</code> is the class that contains the method. Likewise, the <code>cls</code> parameter in a class method will have the type <code>Type[Self@ClassName]</code>.</p>
</blockquote>
<pre><code>class C:
    def __init__(self) -&gt; None:
        reveal_type(self)  # pyright:  Self@C
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-29 13:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-29 13:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-29 13:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-29 13:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-01-29 16:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:192 on 2025-01-29 16:37</div>
            <div class="timeline-body"><p>If by &quot;special treatment&quot; you mean &quot;special treatment based on the name of the parameter,&quot; I don&#x27;t see evidence for that in the linked docs or in the playground? Pyright does implement a lint rule telling you to change the name to <code>self</code>/<code>cls</code>, but using a different name doesn&#x27;t seem to otherwise impact its type inference. The phrase &quot;a method&#x27;s self or cls parameter&quot; in those docs does not mean &quot;a parameter named <code>self</code> or <code>cls</code>&quot;, it means &quot;the first parameter of a method or classmethod.&quot;</p>
<p>If by &quot;special treatment&quot; you mean assigning a type to an un-annotated first parameter that is a typevar bound to the type of the containing class, we will also need to do that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:192 on 2025-01-29 16:39</div>
            <div class="timeline-body"><blockquote>
<p>Simply checking that the <code>this</code> variable in <code>__init__</code> has the same type as <code>self</code> would not be sufficient; you&#x27;d need to know that it refers to exactly the same object as <code>self</code>.</p>
</blockquote>
<p>Once we implement correct <code>Self</code> typing, then checking that it has the same type as <code>self</code> will actually be sufficient, because the <code>Self</code> type can&#x27;t apply to anything other than <code>self</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-01-29 16:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:333 on 2025-01-29 16:41</div>
            <div class="timeline-body"><p>Absolutely, I agree that treating mutable instance attributes as covariant is unsound! And we <em>should</em> definitely have a diagnostic about attempting to covariantly override declarations like that. I just worry that there&#x27;s a <em>lot</em> of typed Python code out there that relies on mypy (unsoundly!) treating mutable attributes as covariant.</p>
<p>Anyway, we can figure out the details of whether the diagnostic is enabled or disabled by default at a later date.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-29 16:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:337 on 2025-01-29 16:43</div>
            <div class="timeline-body"><p>I think there are two possible rules here: &quot;subclass can not re-declare, period&quot;, or &quot;subclass can only re-declare with an equivalent type, because mutability implies invariance&quot;. The name <code>can_not_be_redeclared</code> here suggests the former, but pyright implements the latter. There&#x27;s no unsoundness to redeclare with the same type on a subclass, and pyright allows it without error. Perhaps we could be a little clearer about that here? Even show an example of both?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-01-29 16:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-29 16:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:192 on 2025-01-29 16:50</div>
            <div class="timeline-body"><blockquote>
<p>Once we implement correct <code>Self</code> typing, then checking that it has the same type as <code>self</code> will actually be sufficient, because the <code>Self</code> type can&#x27;t apply to anything other than <code>self</code>.</p>
</blockquote>
<p>Is that true?</p>
<pre><code>from typing import Self

class Foo:
    def __init__(self, other: Self | None = None):
        if other is not None:
            other.bar = 42
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-01-29 17:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:192 on 2025-01-29 17:01</div>
            <div class="timeline-body"><p>Hmm, good point. I think it would also be pretty reasonable to consider <code>other.bar = 42</code> the same way we would consider <code>self.bar = 42</code>; both are cases of a method of the very same class assigning to an attribute on its self type. The only real distinction would be if we were trying to validate full initialization of <code>self</code>, but I don&#x27;t think we&#x27;re aiming to do that? But it would also be OK not to, whatever is easier I think, since I doubt it happens often.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-29 17:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:192 on 2025-01-29 17:33</div>
            <div class="timeline-body"><p>Ah, yeah, that makes sense!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-29 21:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:192 on 2025-01-29 21:22</div>
            <div class="timeline-body"><blockquote>
<p>If by &quot;special treatment&quot; you mean assigning a type to an un-annotated first parameter that is a typevar bound to the type of the containing class, we will also need to do that.</p>
</blockquote>
<p>Sorry, I should have been more clear. This is what I meant, yes. It&#x27;s not yet clear to me why pyright sometimes infers <code>C</code>, <a href="https://pyright-play.net/?strict=true&amp;code=MYGwhgzhAEDCBcAoaLoBMCmAzaB9XAlgHYEAu%2BAFBBiFgJTQC0AfNAHID2RGSqf01WgDoAHtAC8AmliEBPIA">sometimes <code>*C</code></a> (for &quot;partially unknown&quot; types?), and sometimes <code>Self@C</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-01-29 22:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:192 on 2025-01-29 22:31</div>
            <div class="timeline-body"><p>Ah, I see. The type of <code>self</code> should generally be <code>Self@C</code>, which is a type variable with upper bound <code>C</code>; this is different from <code>C</code> in that it accounts for the possibility of a subclass, which has implications for methods that  <code>return self</code> (when called on a subclass, they will return an instance of the subclass, not <code>C</code>), and for valid-Liskov-override checking of method signatures (normally parameter types are contravariant, so a subclass method parameter could not accept a subtype of the corresponding superclass method parameter, but this is exactly what needs to happen with <code>self</code>). Not sure in what cases pyright will flatten that to just <code>C</code>, or what <code>C*</code> represents.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-29 23:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:192 on 2025-01-29 23:05</div>
            <div class="timeline-body"><p>some of the inconsistency in pyright&#x27;s behaviour here may be because of what PEP484 specified before we added a <code>Self</code> type to the typing system: https://peps.python.org/pep-0484/#annotating-instance-and-class-methods</p>
<p>Pyright and other type checkers had to change various behaviours when <code>Self</code> was added</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-30 09:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:337 on 2025-01-30 09:38</div>
            <div class="timeline-body"><p>Thanks. <a href="https://github.com/astral-sh/ruff/pull/15826">astral-sh/ruff#15826</a></p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:10:55 UTC
    </footer>
</body>
</html>
