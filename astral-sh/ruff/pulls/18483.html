<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Track the origin of the `environment.python` setting for better error messages - astral-sh/ruff #18483</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Track the origin of the <code>environment.python</code> setting for better error messages</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18483">#18483</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-06-05 18:17
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body">Summary
<p>This PR tracks the origin of the <code>environment.python</code> setting more precisely, so that we don&#x27;t refer to the user&#x27;s &quot;<code>--python</code> argument&quot; in error messages if the setting was actually specified in a configuration file.</p>
<p>The first commit is a pretty simple change that just tracks <em>whether</em> the setting came from the CLI or a config file. The second commit adds annotations to some <code>site-packages</code> error messages so that we show the user exactly where in the config file the setting was specified. Most of the diff comes from the second commit; I can drop this change, if we feel it adds too much complexity. I&#x27;m not totally sure if it&#x27;s worth it or not.</p>
Test Plan
<p>Snapshot tests and manual testing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-05 18:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-05 18:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-05 18:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-05 18:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-05 18:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/metadata/options.rs</code>:394 on 2025-06-06 05:54</div>
            <div class="timeline-body"><p>This should not be necessary. <code>RelativePathBuf</code> wrapps <code>RangedValue</code> internally. But you might need to add a few methods to get the value (or decide that the current wrapping doesn&#x27;t make any sense and rewrite all uses of <code>RelativePathBuf</code> to <code>RangedValue&lt;RelativePathBuf&gt;</code> and remove the <code>RangedValue</code> from <code>RelativePathBuf</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty/tests/cli.rs</code>:1112 on 2025-06-06 05:58</div>
            <div class="timeline-body"><p>We should display the file name here. It&#x27;s otherwise unclear where this snippet comes from. E.g. I don&#x27;t understand what the message shows here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-06 05:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/site_packages.rs</code>:651 on 2025-06-06 06:01</div>
            <div class="timeline-body"><p>Hmm, It definetely doesn&#x27;t make me excited that we&#x27;re using annotation snippet here directly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-06 06:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/sharkdp">@sharkdp</a> removed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-06-06 07:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-06 10:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_project/src/metadata/options.rs</code>:394 on 2025-06-06 10:51</div>
            <div class="timeline-body"><p>Thanks, I totally missed that</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-06 11:17</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-06 11:22</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-06-06 11:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-06 12:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/site_packages.rs</code>:651 on 2025-06-06 12:01</div>
            <div class="timeline-body"><p>Agreed, but it&#x27;s useful to have snippet rendering capabilities in this module for other reasons too. It might be nice in the future to render annotations if we fail to parse pyvenv.cfg files, for example. (This <em>would</em> be a good &quot;help wanted&quot; task.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-06 12:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-06 12:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-06 12:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-06 12:43</div>
            <div class="timeline-body"><p>Demo of what the error looks like now:</p>
<p><img src="https://github.com/user-attachments/assets/ac453cbb-7757-4c84-b5e9-1f43b3140d3f" alt="image"></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-06-11 10:50</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:15:14 UTC
    </footer>
</body>
</html>
