<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Make `Module` a Salsa ingredient - astral-sh/ruff #19495</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Make <code>Module</code> a Salsa ingredient</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19495">#19495</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2025-07-22 19:02
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a></div>
            <div class="timeline-body"><p>We want to write queries that depend on <code>Module</code> for caching. While it
seems it can be done without making <code>Module</code> an ingredient, it seems it
is <a href="https://github.com/astral-sh/ruff/pull/19408#discussion_r2215867301">best practice to do so</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @BurntSushi on 2025-07-22 19:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @BurntSushi on 2025-07-22 19:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @BurntSushi on 2025-07-22 19:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @BurntSushi on 2025-07-22 19:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @BurntSushi on 2025-07-22 19:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dcreager removed by @BurntSushi on 2025-07-22 19:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @BurntSushi on 2025-07-22 19:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @BurntSushi on 2025-07-22 19:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @BurntSushi on 2025-07-22 19:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-07-22 19:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-07-22 19:04</div>
            <div class="timeline-body"><p>@MichaReiser RE https://github.com/astral-sh/ruff/pull/19408#discussion_r2215867301</p>
<p>What would be the downside of leaving <code>Module</code> as it was and <em>not</em> making it an ingredient? Is it that dependency tracking in Salsa won't be as good as it would be with this change? I'm trying to figure out what would go wrong if we kept the status quo. (I'm not arguing in favor of the status quo, this is for my own edification.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-22 19:05</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-22 19:13</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-07-22 20:11</div>
            <div class="timeline-body"><p>I'm curious, given that <code>File:Module</code> is <code>1:1</code>, why we need to make queries cache based on <code>Module</code> instead of based on its <code>File</code>? AFAIK we've mostly just based everything around <code>File</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/module_resolver/module.rs</code>:105 on 2025-07-23 05:54</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    fn all_submodules_inner(self, db: &amp;'db dyn Db) -&gt; Option&lt;Vec&lt;Name&gt;&gt; {
</code></pre>
<p>We no longer need the <code>dummy</code> argument here because <code>Module</code> is now a <code>salsa::tracked</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-07-23 06:01</div>
            <div class="timeline-body"><blockquote>
<p>What would be the downside of leaving Module as it was and not making it an ingredient? I</p>
</blockquote>
<p>The main downside is that <code>all_submodule_names</code> requires the <code>()</code> dummy argument because its (otherwise) only argument (<code>self</code>) isn't a salsa ingredient. What this does behind the scene is that salsa creates an ad-hoc interned struct with two fields: <code>dummy: ()</code> and <code>module: self</code>.</p>
<blockquote>
<p>I'm curious, given that File:Module is 1:1, why we need to make queries cache based on Module instead of based on its File? AFAIK we've mostly just based everything around File.</p>
</blockquote>
<p>I must admit, I didn't look at <code>all_submodule_names</code> in detail and you're right, we could restructure that function so that only the portion operating on <code>File</code> would be the salsa query. That would remove the need to make <code>Module</code> a salsa query today.</p>
<p>It being a salsa struct would still be beneficial if we need queries operating on namespace packages or queries using other <code>Module</code> fields that can't be as easily restructured as <code>all_submodule_names</code>.</p>
<p>@BurntSushi has probably more insight here on whether we want to extend <code>all_submodule_names</code> to namespace packages in the future or if there are other queries that need to operate at the module level</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-07-23 12:53</div>
            <div class="timeline-body"><blockquote>
<p>@BurntSushi has probably more insight here on whether we want to extend <code>all_submodule_names</code> to namespace packages in the future or if there are other queries that need to operate at the module level</p>
</blockquote>
<p>I am not 100% certain about this, but I <em>suspect</em> so. I'm thinking about queries for symbols exported by modules (for auto import). If I'm wrong about this and <code>Module</code> is unnecessarily a Salsa ingredient, what kind of downsides are we looking at? Extra memory usage? If it isn't too bad, I think I'd prefer to keep it as an ingredient for now.</p>
<p>I've pushed up another commit that does restructure the code to just use <code>File</code> as an input to a query function.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-23 13:40</div>
            <div class="timeline-body"><blockquote>
<p>If I'm wrong about this and Module is unnecessarily a Salsa ingredient, what kind of downsides are we looking at? Extra memory usage?</p>
</blockquote>
<ul>
<li>Accessors are slightly slower as they require a db lookup and they're a bit more annoying to use</li>
<li>Salsa has to track additional metadata for each tracked struct. I don't expect this to be a huge problem here as there are relatively few modules (it's not in the millions)</li>
</ul>
<blockquote>
<p>I am not 100% certain about this, but I suspect so. I'm thinking about queries for symbols exported by modules (for auto import).</p>
</blockquote>
<p>Makes sense. The main question is if they could be over <code>File</code> instead of <code>Module</code>. But I'm fine merging this as is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @BurntSushi on 2025-07-23 13:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2025-07-23 13:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-23 13:46</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:14:28 UTC
    </footer>
</body>
</html>
