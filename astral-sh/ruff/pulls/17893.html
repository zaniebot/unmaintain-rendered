<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[parser] Flag single unparenthesized generator expr with trailing comma in arguments. - astral-sh/ruff #17893</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[parser] Flag single unparenthesized generator expr with trailing comma in arguments.</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17893">#17893</a>
        opened by <a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a>
        on 2025-05-06 17:31
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a></div>
            <div class="timeline-body"><p>Fixes #17867</p>
Summary
<p>The CPython parser does not allow generator expressions which are the sole arguments in an argument list to have a trailing comma.
With this change, we start flagging such instances.</p>
Test Plan
<p>Added new inline tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a> on 2025-05-06 17:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dhruvmanila">@dhruvmanila</a> by <a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a> on 2025-05-06 17:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a> on <code>crates/ruff_python_parser/src/parser/mod.rs</code>:665 on 2025-05-06 17:33</div>
            <div class="timeline-body"><p>Instead of special-casing inside <code>parse_comma_separated_list</code> itself, I felt returning the <code>trailing_comma_range</code> to be simpler. But please let me know if this feels hacky.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a> reviewed on 2025-05-06 17:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a> on 2025-05-06 17:33</div>
            <div class="timeline-body"><p>@ntBre could you please review?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/resources/inline/ok/args_unparenthesized_generator.py</code>:2 on 2025-05-06 18:18</div>
            <div class="timeline-body"><p>I think this is the cause of the CI failure:</p>
<pre><code>sum((x for x in range(10)),)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:664 on 2025-05-06 18:25</div>
            <div class="timeline-body"><p>This is just a note to other potential reviewers, but I highly recommend hiding whitespace from the diff here. The only change in this function is capturing the value <code>trailing_comma_range</code>, which is now returned by <code>parse_comma_separated_list</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/parser/mod.rs</code>:665 on 2025-05-06 18:33</div>
            <div class="timeline-body"><p>This looks reasonable to me (and the change is quite small overall once I hid the whitespace diff), but I have two ideas here:</p>
<ul>
<li>Can we just return a <code>bool</code> instead of an <code>Option&lt;TextRange&gt;</code>? It looks like we only ever use the <code>Option</code> to call <code>is_some</code>, so we could just call <code>is_some</code> in the return here.</li>
<li>Could we update the <code>recovery_context_kind</code> we pass in here so that we reuse the existing <code>OtherError</code> on line 657?</li>
</ul>
<p>The second of these would prevent the need for the first and seems like a more robust approach, but I&#x27;m not really familiar with the available <code>RecoveryContextKind</code>s. If we can&#x27;t get that to work, I think the current approach (with the <code>bool</code> modification) would be fine. @dhruvmanila would know better than me though!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-06 18:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-05-06 18:53</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<a href="https://github.com/mesonbuild/meson-python">mesonbuild/meson-python</a> (error)
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to read tests/packages/symlinks/baz.py: No such file or directory (os error 2)
error: Failed to read tests/packages/symlinks/qux.py: No such file or directory (os error 2)
</code></pre>
</p>


Formatter (preview)
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<a href="https://github.com/mesonbuild/meson-python">mesonbuild/meson-python</a> (error)
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to read tests/packages/symlinks/baz.py: No such file or directory (os error 2)
error: Failed to read tests/packages/symlinks/qux.py: No such file or directory (os error 2)
</code></pre>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a> reviewed on 2025-05-06 18:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a> on <code>crates/ruff_python_parser/src/parser/mod.rs</code>:665 on 2025-05-06 18:57</div>
            <div class="timeline-body"><p>The context is <code>RecoveryContextKind::Arguments</code>, which alows trailing commas.</p>
<p>By updating <code>recovery_context_kind</code>, do you mean making it so that <code>OtherError</code> is raised even for <code>RecoveryContextKind::Arguments</code>? And later on replace that <code>OtherError</code> with the more specialized <code>UnparenthesizedGeneratorExpression</code> (or remove it entirely, if generators are not involved)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:664 on 2025-05-06 18:57</div>
            <div class="timeline-body"><p>(I also did not know about this setting. Thank you!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a> reviewed on 2025-05-06 18:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a> reviewed on 2025-05-06 18:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a> on <code>crates/ruff_python_parser/resources/inline/ok/args_unparenthesized_generator.py</code>:2 on 2025-05-06 18:58</div>
            <div class="timeline-body"><p>Oops, looks like a <code>git add</code> miss on my end. Fixed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a> reviewed on 2025-05-06 19:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a> on <code>crates/ruff_python_parser/src/parser/mod.rs</code>:665 on 2025-05-06 19:01</div>
            <div class="timeline-body"><p>I addressed the first point and pushed here.
Happy to revert/change if we decide on the other way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a> on 2025-05-06 19:04</div>
            <div class="timeline-body"><p>Thanks for reviewing, Brent. I addressed all but one comment.
Please see the question at <a href="https://github.com/astral-sh/ruff/pull/17893">astral-sh/ruff#17893</a>#discussion_r2076077042</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-06 19:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/parser/mod.rs</code>:665 on 2025-05-06 19:55</div>
            <div class="timeline-body"><p>Sorry for the confusion, I pulled down the PR locally, and I think I understand what&#x27;s going on better now. My suggestion was basically a worse wording of your idea to add special-casing inside of <code>parse_comma_separated_list</code>, but I see now that the proper error (<code>UnparenthesizedGeneratorExpression</code>) is emitted from <code>validate_arguments</code>, so I think your implementation totally makes sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:2529 on 2025-05-06 19:58</div>
            <div class="timeline-body"><p>Minor docs suggestion, something like:</p>
<blockquote>
<ol>
<li>If there is more than one argument (positional or keyword), <strong>or a single argument with a trailing comma,</strong> ...</li>
</ol>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:2547 on 2025-05-06 20:00</div>
            <div class="timeline-body"><p>I believe we can simplify this to</p>
<pre><code>        if has_trailing_comma || arguments.len() &gt; 1 {
</code></pre>
<p>since we&#x27;ll either have 0 arguments, in which case the loop is never entered and the conditional doesn&#x27;t matter; 1 argument in which case only <code>has_trailing_comma</code> matters; or many arguments, in which case <code>arguments.len() &gt; 1</code> applies.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/resources/inline/ok/args_unparenthesized_generator.py</code>:3 on 2025-05-06 20:02</div>
            <div class="timeline-body"><p>I guess one more nit while I&#x27;m here, this is slightly confusing with the name of the test (<code>unparenthesized_generator</code>), but it&#x27;s also annoying to have to rename snapshots and such, so I&#x27;m okay with leaving it as is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-05-06 20:02</div>
            <div class="timeline-body"><p>Thanks, this looks good to me! And thanks for clearing up my confusion from earlier. I found a couple of minor nits, but otherwise I just want to give Dhruv a chance to look at this if he wants to.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-06 20:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-06 20:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a> reviewed on 2025-05-07 06:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a> on <code>crates/ruff_python_parser/resources/inline/ok/args_unparenthesized_generator.py</code>:3 on 2025-05-07 06:02</div>
            <div class="timeline-body"><p>Hmm, if the premise is that un-parenthesized expressions are bad, then I think it would be natural for the &quot;ok&quot; parts of the test to be good (ie, have parens)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a> reviewed on 2025-05-07 06:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a> on <code>crates/ruff_python_parser/resources/inline/ok/args_unparenthesized_generator.py</code>:3 on 2025-05-07 06:04</div>
            <div class="timeline-body"><p>I actually added one more inline test here. Not related to the changes in this PR specifically, but I felt the case of multiple arguments was missing from the &quot;ok&quot; section.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a> on 2025-05-07 06:09</div>
            <div class="timeline-body"><p>Thanks Brent. I&#x27;ve addressed the review comments. For the test name -- IMO the name isn&#x27;t exactly incorrect, so I&#x27;d prefer to keep it the same way.
(Although I did add a new inline test in the &quot;ok&quot; section which you might want to review.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-05-07 07:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-05-07 12:22</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-05-07 18:11</div>
            <div class="timeline-body"><p>Looks great, thank you! I think it&#x27;s fine to leave the test name as is too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-07 18:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-07 18:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-05-07 18:19</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:14:07 UTC
    </footer>
</body>
</html>
