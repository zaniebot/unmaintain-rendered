<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-use-pathlib`] Dotless suffix passed to `Path.with_suffix()` (`PTH210`) - astral-sh/ruff #14779</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-use-pathlib</code>] Dotless suffix passed to <code>Path.with_suffix()</code> (<code>PTH210</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14779">#14779</a>
        opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a>
        on 2024-12-05 00:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a></div>
            <div class="timeline-body">Summary
<p>Resolves #14441.</p>
Test Plan
<p><code>cargo nextest run</code> and <code>cargo insta test</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-12-05 00:22</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/ruff/rules/dotless_with_suffix.rs</code>:97 on 2024-12-05 16:53</div>
            <div class="timeline-body"><pre><code>    if arguments.len() == 1 {
        arguments
            .find_argument(&quot;suffix&quot;, 0)?
            .as_string_literal_expr()
    } else {
        None
    }
</code></pre>
<p>You could probably inline this function. It&#x27;s only used once, and it feels simple enough that it doesn&#x27;t really need to be extracted into a separate function.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/ruff/rules/dotless_with_suffix.rs</code>:67 on 2024-12-05 16:54</div>
            <div class="timeline-body"><p>why are we <code>return</code>ing if a fix is unavailable? Surely it&#x27;s better to mark the diagnostic as only-sometimes fixable rather than just not emitting it if we can&#x27;t provide an autofix</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/ruff/rules/dotless_with_suffix.rs</code>:60 on 2024-12-05 16:56</div>
            <div class="timeline-body"><p>I&#x27;d find this easier to understand:</p>
<pre><code>    let string_value = string.value.to_str();
    if string_value.is_empty() || string_value.starts_with(&#x27;.&#x27;) {
        return;
    }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/ruff/rules/dotless_with_suffix.rs</code>:114 on 2024-12-05 17:05</div>
            <div class="timeline-body"><p>this suggestion requires an import of <code>ruff_text_size::Ranged</code> at the top of the file:</p>
<pre><code>    let first_part = string.value.iter().next()?;
    let after_leading_quote = first_part
        .start()
        .checked_add(first_part.flags.opener_len())?;
    let edit = Edit::insertion(&quot;.&quot;.to_string(), after_leading_quote);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/ruff/rules/dotless_with_suffix.rs</code>:116 on 2024-12-05 17:06</div>
            <div class="timeline-body"><p>this should definitely be an unsafe fix, because they might be deliberately using a suffix without a leading <code>.</code>, in which case the fix would break their code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-05 17:10</div>
            <div class="timeline-body"><p>Thanks. The rule seems reasonable to me. I think we should add it to our <code>flake8-use-pathlib</code> category, however. We already have rules such as https://docs.astral.sh/ruff/rules/path-constructor-current-directory/ that tell you how to use pathlib better (rather than just complaining at you if you used <code>os.path</code> instead of pathlib).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2024-12-05 17:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/src/rules/ruff/rules/dotless_with_suffix.rs</code>:67 on 2024-12-05 17:20</div>
            <div class="timeline-body"><p>This <code>return</code> is expected to be unreachable; if it is, there is a bug somewhere. Should I still implement <code>AlwaysFixableViolation</code>, but might not add the fix if it is <code>None</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-05 17:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/ruff/rules/dotless_with_suffix.rs</code>:67 on 2024-12-05 17:22</div>
            <div class="timeline-body"><p>I see. If the return is expected to be unreachable, you should make that explicit by doing something like</p>
<pre><code>    let diagnostic = Diagnostic::new(DotlessWithSuffix, call.range);
    let Some(fix) = add_leading_dot_fix(string) else {
        unreachable!(&quot;Expected always to be able to fix this rule&quot;);
    };
    checker.diagnostics.push(diagnostic.with_fix(fix));
</code></pre>
<p>And then we&#x27;ll get bug reports telling us if something about our assumptions here is incorrect, which is useful.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[`ruff`] Dotless suffix passed to `Path.with_suffix()` (`RUF049`)&quot; to &quot;[`flake8-use-pathlib`] Dotless suffix passed to `Path.with_suffix()` (`PTH901`)&quot; by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-12-05 19:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-12-06 01:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-06 09:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-06 09:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/codes.rs</code>:912 on 2024-12-06 09:04</div>
            <div class="timeline-body"><p>I don&#x27;t think it&#x27;s necessary to introduce an entire new prefix. We use <code>2XX</code> for rules that have no upstream rule.</p>
<p>I also think we should make the rule name more explicit: <code>DotlessPathlibWithSuffix</code> to avoid future conflicts</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_use_pathlib/rules/dotless_with_suffix.rs</code>:19 on 2024-12-06 09:06</div>
            <div class="timeline-body"><p>We should be more explicit about what the possible errors are here. As a reader, it&#x27;s not clear to me what that means (what&#x27;s even type inference)? What are the cases I have to worry about.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_use_pathlib/rules/dotless_with_suffix.rs</code>:71 on 2024-12-06 09:10</div>
            <div class="timeline-body"><p>We can avoid the <code>unreachable</code> by rewiring this a bit</p>
<pre><code>		let [first_part, ..] = string.value.as_slice() else {
        return;
    };

    if first_part.is_empty() || first_part.starts_with(&#x27;.&#x27;) {
        return;
    }

    let diagnostic = Diagnostic::new(DotlessWithSuffix, call.range);
    let fix = add_leading_dot_fix(first_part);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_use_pathlib/rules/dotless_with_suffix.rs</code>:103 on 2024-12-06 09:10</div>
            <div class="timeline-body"><p>Can you explain why the fix is considered unsafe and if it has to be unsafe, can we document the fix safety?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2024-12-06 09:11</div>
            <div class="timeline-body"><p>Thank you. A few smaller coding and documentation changes</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-06 09:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_use_pathlib/rules/dotless_with_suffix.rs</code>:103 on 2024-12-06 09:18</div>
            <div class="timeline-body"><p>I asked for @InSyncWithFoo to make the fix unsafe. I think it&#x27;s important because this fix changes the code from something that always raises an exception at runtime to something that doesn&#x27;t. By doing that, we&#x27;re making the assumption that the <code>with_suffix</code> call is exactly correct except for not having a leading period. But that assumption might not be accurate, and applying the autofix might conceal other possible bugs, since the runtime will no longer raise an exception on the call</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-06 09:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_use_pathlib/rules/dotless_with_suffix.rs</code>:103 on 2024-12-06 09:19</div>
            <div class="timeline-body"><p>Put another way: we know there&#x27;s a mistake in the code, but are we <em>sure</em> it&#x27;s just that they forgot a leading period in the string they&#x27;re passing? Maybe they have the correct string but they&#x27;re using the wrong method?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-06 09:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_use_pathlib/rules/dotless_with_suffix.rs</code>:103 on 2024-12-06 09:20</div>
            <div class="timeline-body"><p>I agree that we should add a docs section on fix safety, definitely!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_use_pathlib/rules/dotless_with_suffix.rs</code>:71 on 2024-12-06 09:44</div>
            <div class="timeline-body"><p>Even with this change, there&#x27;s still a <code>checked_add()</code> call in the <code>add_leading_dot_fix()</code> function where a <code>?</code> is used. But I think it would be fine to use <code>.expect()</code> there to avoid having to return an <code>Option</code> from <code>add_leading_dot_fix()</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-06 09:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/src/rules/flake8_use_pathlib/rules/dotless_with_suffix.rs</code>:71 on 2024-12-06 11:32</div>
            <div class="timeline-body"><p>This change fails the <code>u&#x27;&#x27; r&#x27;json&#x27;</code> test, as it expects the first part, rather than the entire string, to have at least one character.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2024-12-06 11:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_use_pathlib/rules/dotless_pathlib_with_suffix.rs</code>:10 on 2024-12-06 11:36</div>
            <div class="timeline-body"><pre><code>/// Checks for `pathlib.Path.with_suffix()` calls where
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_use_pathlib/rules/dotless_pathlib_with_suffix.rs</code>:18 on 2024-12-06 11:37</div>
            <div class="timeline-body"><p>do you have an example of a situation where this rule might cause a false positive? It seems to me like it&#x27;s much more likely to cause false negatives than false positives?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_use_pathlib/rules/dotless_pathlib_with_suffix.rs</code>:25 on 2024-12-06 11:41</div>
            <div class="timeline-body"><pre><code>/// The fix for this rule adds a leading period to the string passed
/// to the `with_suffix()` call. This fix is marked as unsafe, as it
/// changes runtime behaviour: the call would previously always have
/// raised an exception, but no longer will. Moreover, it&#x27;s impossible
/// to determine if this is the correct fix for a given situation
/// (it&#x27;s possible that the string was correct but was being passed to
/// the wrong method entirely, for example).
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_use_pathlib/rules/dotless_pathlib_with_suffix.rs</code>:27 on 2024-12-06 11:41</div>
            <div class="timeline-body"><p>Can you move this section above the <code>## Known problems</code> and <code>## Fix safety</code> section?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-06 11:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2024-12-06 11:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/src/rules/flake8_use_pathlib/rules/dotless_pathlib_with_suffix.rs</code>:18 on 2024-12-06 11:55</div>
            <div class="timeline-body"><p>I thought it would be better to mention false positives, even if they are firmly in the minority; no strong opinion, however. Rephrased.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-12-06 12:08</div>
            <div class="timeline-body"><p>Thanks, these documentation improvements are great. I now get a good sense for why the fix is unsafe and what the limitations are.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-06 12:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-06 12:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-12-06 12:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[`flake8-use-pathlib`] Dotless suffix passed to `Path.with_suffix()` (`PTH901`)&quot; to &quot;[`flake8-use-pathlib`] Dotless suffix passed to `Path.with_suffix()` (`PTH210`)&quot; by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-12-06 13:24</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:09:11 UTC
    </footer>
</body>
</html>
