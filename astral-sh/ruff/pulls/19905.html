<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] support goto/hover on string annotations - astral-sh/ruff #19905</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] support goto/hover on string annotations</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19905">#19905</a>
        opened by <a href="https://github.com/Gankra">@Gankra</a>
        on 2025-08-13 22:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a></div>
            <div class="timeline-body"><p>The root issues with this implementation is that ty_python_semantic doesn&#x27;t really provide a way to ask:</p>
<ul>
<li>~~hey there&#x27;s a string literal here, is this a type annotation?~~</li>
<li>hey this substring of a string annotation, what type is it?</li>
</ul>
<p>This means that we:</p>
<ul>
<li>~~currently assume <em>every</em> string literal that is shaped like a type annotation <em>is</em> one (and <em>not</em> a <code>str</code>)~~</li>
<li>~~can&#x27;t implement <code>goto_type_definition</code> for types we find in type annotations~~<ul>
<li>can only report <code>goto_type_definition</code> to be the type of the whole string, and not the substring</li>
</ul>
</li>
<li>~~find-and-replace functionality may erroneously edit random strings that happen to match?~~</li>
</ul>
<p>Thankfully I don&#x27;t <em>think</em> adding the necessary APIs to ty_python_semantic (or whatever) is actually that hard..? perhaps famous last words.</p>
<p>Fixes <a href="https://github.com/astral-sh/ty/issues/1009">astral-sh/ty#1009</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-08-13 22:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_ide/src/goto_type_definition.rs</code>:229 on 2025-08-13 22:37</div>
            <div class="timeline-body"><p>This is the main Problematic thing about this implementation -- we don&#x27;t ask the type checker if this string actually was a string annotation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-13 22:38</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a>

Changes were detected when running ty on typing conformance tests

<pre><code>--- old-output.txt	2025-08-14 00:59:43.392643714 +0000
+++ new-output.txt	2025-08-14 00:59:43.459644200 +0000
@@ -1,5 +1,5 @@
 WARN ty is pre-release software and not ready for production use. Expect to encounter bugs, missing features, and fatal errors.
-fatal[panic] Panicked at /home/runner/.cargo/git/checkouts/salsa-e6f3bb7c2a062968/918d35d/src/function/execute.rs:215:25 when checking `/home/runner/work/ruff/ruff/typing/conformance/tests/aliases_typealiastype.py`: `infer_definition_types(Id(1a4cb)): execute: too many cycle iterations`
+fatal[panic] Panicked at /home/runner/.cargo/git/checkouts/salsa-e6f3bb7c2a062968/918d35d/src/function/execute.rs:215:25 when checking `/home/runner/work/ruff/ruff/typing/conformance/tests/aliases_typealiastype.py`: `infer_definition_types(Id(f2b2)): execute: too many cycle iterations`
 _directives_deprecated_library.py:15:31: error[invalid-return-type] Function always implicitly returns `None`, which is not assignable to return type `int`
 _directives_deprecated_library.py:30:26: error[invalid-return-type] Function always implicitly returns `None`, which is not assignable to return type `str`
 _directives_deprecated_library.py:36:41: error[invalid-return-type] Function always implicitly returns `None`, which is not assignable to return type `Self@__add__`
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-08-13 22:39</div>
            <div class="timeline-body"><p><img alt="Screenshot 2025-08-13 at 6 39 16 PM" src="https://github.com/user-attachments/assets/3555ad9b-65e1-41ca-884f-6e1bd125313d"></p>
<p><img alt="Screenshot 2025-08-13 at 6 39 31 PM" src="https://github.com/user-attachments/assets/1d693fcb-f935-4cde-939b-503cf01d5a95"></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-13 22:40</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-13 22:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-13 22:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-08-14 00:59</div>
            <div class="timeline-body"><p>I thought of a way to technically ask the inference engine &quot;hey is this string an annotation?&quot; (ask what the string infers to, and check if that&#x27;s literally the string it is. if it&#x27;s not, it must be a type annotation.)</p>
<p>This leaves the only real issue being &quot;way to ask the type of a substring of an annotation&quot;. I think this is technically shippable but a bit dubious.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/goto.rs</code>:690 on 2025-08-14 06:55</div>
            <div class="timeline-body"><p>This check will return false for strings longer than 4096 bytes</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-14 07:04</div>
            <div class="timeline-body"><p>This doesn&#x27;t look to horrible and I wouldn&#x27;t mind merging it, except that it&#x27;s probably not that useful either because it is limited to names.</p>
<p>Looking at this, it&#x27;s also not a go to definition specific problem. E.g. rename also doesn&#x27;t consider references in stringified annotations (I think).</p>
<p>I don&#x27;t have a great idea for how to support this holisticly from the top of my mind. One idea that we floated in the past and might work here is to support virtual documents.</p>
<p>A virtual document (or file) is a snippet from within another file but it gets its own <code>File</code> id (it probably has to be an id layered on top of <code>File</code> but conceptually its an id that can be a real file or a virtual file).</p>
<p>We&#x27;ll need a similar feature if we ever want to support embedded code, e.g. some SQL inside python. We wouldn&#x27;t want to re-parse that sql statement for formatting and linting, it should only be parsed once.</p>
<p>I think this idea is also similar to how rust analyzer handles macros.</p>
<p>https://github.com/rust-lang/rust-analyzer/blob/59ef84506deb45e6d4336935d0d4be54c3386814/crates/hir-expand/src/lib.rs#L1074-L1077</p>
<p>This is obviously a pretty big change. I&#x27;d be okay punting on this for the beta but we should create an issue outlining the problems we&#x27;ve run into.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-21 20:16</div>
            <div class="timeline-body"><p>bitrotted to hell, will restart this from scratch with months of experience under my belt</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-21 20:16</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:17:42 UTC
    </footer>
</body>
</html>
