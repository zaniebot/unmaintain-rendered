```yaml
number: 5680
title: Improve comprehension line break beheavior
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: comprehension-line-break
created_at: 2023-07-11T09:57:53Z
updated_at: 2023-07-11T15:08:24Z
url: https://github.com/astral-sh/ruff/pull/5680
synced_at: 2026-01-12T03:36:55Z
```

# Improve comprehension line break beheavior

---

_Pull request opened by @MichaReiser on 2023-07-11 09:57_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This PR improves the Black compatibility when it comes to breaking comprehensions. 

We want to avoid line breaks before the target and `in` whenever possible. Furthermore, `if X is not None` should be grouped together, similar to other binary like expressions

<!-- What's the purpose of the change? What does it do, and why? -->

## Test Plan

`cargo test`

<!-- How was it tested? -->


---

_Comment by @MichaReiser on 2023-07-11 09:58_

Current dependencies on/for this PR:
* main
  * **PR #5661** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5661" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #5680** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5680" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
      * **PR #5683** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5683" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/5680?utm_source=stack-comment).

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_compare.rs`:36 on 2023-07-11 09:59_

No change other than that this gets all wrapped in an `in_parentheses_only_group`

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/tests/snapshots/format@statement__list_comp.py.snap`:99 on 2023-07-11 10:00_

Black doesn't insert parentheses here. I'll look into this next

---

_@MichaReiser reviewed on 2023-07-11 10:01_

---

_Label `formatter` added by @MichaReiser on 2023-07-11 10:01_

---

_Review requested from @konstin by @MichaReiser on 2023-07-11 10:01_

---

_Comment by @github-actions[bot] on 2023-07-11 10:33_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     10.4Â±0.33ms     3.9 MB/sec    1.15     11.9Â±0.96ms     3.4 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.4Â±0.05ms     7.0 MB/sec    1.05      2.5Â±0.13ms     6.6 MB/sec
formatter/numpy/globals.py                 1.02   288.4Â±19.15Âµs    10.2 MB/sec    1.00   282.7Â±18.32Âµs    10.4 MB/sec
formatter/pydantic/types.py                1.07      5.7Â±0.50ms     4.4 MB/sec    1.00      5.4Â±0.31ms     4.7 MB/sec
linter/all-rules/large/dataset.py          1.03     19.4Â±1.23ms     2.1 MB/sec    1.00     18.7Â±0.71ms     2.2 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.5Â±0.15ms     3.7 MB/sec    1.01      4.5Â±0.17ms     3.7 MB/sec
linter/all-rules/numpy/globals.py          1.00   585.5Â±27.18Âµs     5.0 MB/sec    1.01   592.4Â±30.12Âµs     5.0 MB/sec
linter/all-rules/pydantic/types.py         1.01      8.2Â±0.28ms     3.1 MB/sec    1.00      8.1Â±0.35ms     3.2 MB/sec
linter/default-rules/large/dataset.py      1.00      9.0Â±0.20ms     4.5 MB/sec    1.06      9.5Â±0.47ms     4.3 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1942.6Â±49.28Âµs     8.6 MB/sec    1.17      2.3Â±0.34ms     7.3 MB/sec
linter/default-rules/numpy/globals.py      1.00   231.0Â±10.75Âµs    12.8 MB/sec    1.02   235.5Â±19.77Âµs    12.5 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.2Â±0.17ms     6.0 MB/sec    1.00      4.2Â±0.16ms     6.0 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.02      9.6Â±0.12ms     4.3 MB/sec    1.00      9.4Â±0.08ms     4.3 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.2Â±0.04ms     7.7 MB/sec    1.01      2.2Â±0.14ms     7.7 MB/sec
formatter/numpy/globals.py                 1.00    238.1Â±4.50Âµs    12.4 MB/sec    1.02    243.7Â±7.53Âµs    12.1 MB/sec
formatter/pydantic/types.py                1.01      4.7Â±0.07ms     5.4 MB/sec    1.00      4.7Â±0.08ms     5.4 MB/sec
linter/all-rules/large/dataset.py          1.10     18.2Â±0.23ms     2.2 MB/sec    1.00     16.5Â±0.24ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.10      4.6Â±0.11ms     3.6 MB/sec    1.00      4.2Â±0.07ms     3.9 MB/sec
linter/all-rules/numpy/globals.py          1.05   536.5Â±11.07Âµs     5.5 MB/sec    1.00    509.4Â±7.81Âµs     5.8 MB/sec
linter/all-rules/pydantic/types.py         1.12      8.1Â±0.18ms     3.2 MB/sec    1.00      7.2Â±0.12ms     3.5 MB/sec
linter/default-rules/large/dataset.py      1.24     10.2Â±0.15ms     4.0 MB/sec    1.00      8.2Â±0.08ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.18      2.1Â±0.03ms     8.1 MB/sec    1.00  1746.3Â±25.40Âµs     9.5 MB/sec
linter/default-rules/numpy/globals.py      1.12    227.1Â±4.37Âµs    13.0 MB/sec    1.00    202.4Â±5.45Âµs    14.6 MB/sec
linter/default-rules/pydantic/types.py     1.20      4.4Â±0.12ms     5.8 MB/sec    1.00      3.7Â±0.04ms     7.0 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/other/comprehension.rs`:62 on 2023-07-11 10:43_

would the macros rules allow inlining the `in_space` as if expression?

---

_Review comment by @konstin on `crates/ruff_python_formatter/tests/snapshots/black_compatibility@py_37__python37.py.snap`:93 on 2023-07-11 10:44_

that looks much nicer

---

_Review comment by @konstin on `crates/ruff_python_formatter/tests/snapshots/black_compatibility@simple_cases__fmtskip5.py.snap`:29 on 2023-07-11 10:44_

this, too

---

_Review comment by @konstin on `crates/ruff_python_formatter/tests/snapshots/format@statement__list_comp.py.snap`:99 on 2023-07-11 10:46_

yep i think that black remove tuple parentheses here same as `for` statements. i'd expect this is the same case for if-else expressions being analogous to `if` statements

---

_@konstin approved on 2023-07-11 10:46_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/other/comprehension.rs`:62 on 2023-07-11 12:32_

I don't think so because `space` and `soft_line_break_or_space` return different structs.

---

_@MichaReiser reviewed on 2023-07-11 12:32_

---

_Merged by @MichaReiser on 2023-07-11 14:51_

---

_Closed by @MichaReiser on 2023-07-11 14:51_

---

_Branch deleted on 2023-07-11 14:51_

---

_Comment by @MichaReiser on 2023-07-11 14:51_

@MichaReiser merged this pull request with [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/5680).

---
