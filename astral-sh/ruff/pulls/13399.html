<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[pycodestyle] Fix: Don't autofix if the first line ends in a question mark? (D400) - astral-sh/ruff #13399</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[pycodestyle] Fix: Don't autofix if the first line ends in a question mark? (D400)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13399">#13399</a>
        opened by <a href="https://github.com/yahayaohinoyi">@yahayaohinoyi</a>
        on 2024-09-18 22:28
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/yahayaohinoyi">@yahayaohinoyi</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes https://github.com/astral-sh/ruff/issues/13365</p>
<blockquote>
<p>The autofix for D400 currently changes this:</p>
<pre><code class="language-python">def should_frob() -&gt; bool:
    &quot;&quot;&quot;Should we frob the bar?&quot;&quot;&quot;
</code></pre>
<p>To this:</p>
<pre><code class="language-python">def should_frob() -&gt; bool:
    &quot;&quot;&quot;Should we frob the bar?.&quot;&quot;&quot;
</code></pre>
<p>Which seems pretty clearly worse! We probably just shouldn't offer an autofix if the first line ends in a question mark or exclamation mark?</p>
</blockquote>
<h2>DESCRIPTION</h2>
<p>Basically, we don't want a diagnostic when we don't set a fix for this rule https://github.com/astral-sh/ruff/blob/8b3da1867e02eb38c34b11b90969662f4506a65b/crates/ruff_linter/src/rules/pydocstyle/rules/ends_with_period.rs#L113.</p>
<h2>Test Plan</h2>
<p>Holistically followed the instructions here https://docs.astral.sh/ruff/contributing/#rule-testing-fixtures-and-snapshots</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @yahayaohinoyi on 2024-09-18 23:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-09-18 23:11</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/pydocstyle/rules/ends_with_period.rs</code>:112 on 2024-09-19 01:19</div>
            <div class="timeline-body"><pre><code class="language-suggestion">            }
            checker.diagnostics.push(diagnostic);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/pydocstyle/rules/ends_with_punctuation.rs</code>:112 on 2024-09-19 01:20</div>
            <div class="timeline-body"><pre><code class="language-suggestion">            }
            checker.diagnostics.push(diagnostic);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-09-19 01:22</div>
            <div class="timeline-body"><p>Thanks for the PR! I think we should still emit a <em>diagnostic</em> if the first line ends in a question mark or exclamation mark, though, since according to <a href="https://peps.python.org/pep-0257/">PEP 257</a> the docstring isn't following the conventional style if it doesn't end in a period. We just shouldn't offer an <em>autofix</em> for the diagnostic if it ends in a question mark or exclamation mark, since we don't know what the appropriate autofix would be in that situation.</p>
<p>I left some inline suggestions below that should be sufficient to address this -- though you'll need to regenerate the snapshots again!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2024-09-19 07:04</div>
            <div class="timeline-body"><p>See @AlexWaygood's comments</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @yahayaohinoyi on 2024-09-19 07:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/yahayaohinoyi">@yahayaohinoyi</a> on 2024-09-19 21:55</div>
            <div class="timeline-body"><p>Need some help!. I get failures like
<code>failures:     rules::pydocstyle::tests::rules::rule_endsinperiod_path_new_d_py_expects</code>
after running the tests. How do I get visibility of what exactly fails? Even when I remove the content of the whole file the test still fails. Also doesn't generate any snapshots</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-20 07:23</div>
            <div class="timeline-body"><p>Running the test gives me:</p>
<pre><code>cargo test rules::pydocstyle::tests::rules::rule_endsinperiod_path_new_d_py_expects -p ruff_linter
    Finished `test` profile [unoptimized + debuginfo] target(s) in 0.08s
     Running unittests src/lib.rs (target/debug/deps/ruff_linter-93716c3568a00bf4)

running 1 test
test rules::pydocstyle::tests::rules::rule_endsinperiod_path_new_d_py_expects ... FAILED

failures:

---- rules::pydocstyle::tests::rules::rule_endsinperiod_path_new_d_py_expects stdout ----
thread 'rules::pydocstyle::tests::rules::rule_endsinperiod_path_new_d_py_expects' panicked at crates/ruff_linter/src/test.rs:254:21:
Rule EndsInPeriod is marked to always-fixable but the diagnostic has no fix.
Either ensure you always emit a fix or change `Violation::FIX_AVAILABILITY` to either `FixAvailability::Sometimes` or `FixAvailability::None`
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace


failures:
    rules::pydocstyle::tests::rules::rule_endsinperiod_path_new_d_py_expects

test result: FAILED. 0 passed; 1 failed; 0 ignored; 0 measured; 2108 filtered out; finished in 0.01s
</code></pre>
<p>The important bits are</p>
<pre><code>thread 'rules::pydocstyle::tests::rules::rule_endsinperiod_path_new_d_py_expects' panicked at crates/ruff_linter/src/test.rs:254:21:
Rule EndsInPeriod is marked to always-fixable but the diagnostic has no fix.
Either ensure you always emit a fix or change `Violation::FIX_AVAILABILITY` to either `FixAvailability::Sometimes` or `FixAvailability::None`
</code></pre>
<p>It's telling you that the <code>Violation</code> should no longer implement <code>AlwaysFixableViolation</code> and instead explicitly set the <code>Fixability</code> to <code>Sometimes</code></p>
<pre><code class="language-rust">impl Violation for EndsInPeriod {
    /// `None` in the case a fix is never available or otherwise Some
    /// [`FixAvailability`] describing the available fix.
    const FIX_AVAILABILITY: FixAvailability = FixAvailability::Sometimes;

    #[derive_message_formats]
    fn message(&amp;self) -&gt; String {
        format!(&quot;First line should end with a period&quot;)
    }

    fn fix_title(&amp;self) -&gt; String {
        &quot;Add period&quot;.to_string()
    }
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @yahayaohinoyi on 2024-09-20 08:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @yahayaohinoyi on 2024-09-20 08:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @yahayaohinoyi on 2024-09-20 08:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2024-09-20 08:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @MichaReiser on 2024-09-20 08:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-09-20 08:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pydocstyle/rules/ends_with_punctuation.rs</code>:112 on 2024-09-20 08:25</div>
            <div class="timeline-body"><p>I think we still need to move the <code>checker.diagnostic.push</code> call outside the <code>trimmed.ends_with</code> branch or we omit diagnostics for docstring summaries that end in <code>!</code>. We actually see this because I would expect to see more diagnostics in <code>ruff_linter__rules__pydocstyle__tests__D415_D415.py.snap</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/yahayaohinoyi">@yahayaohinoyi</a> reviewed on 2024-09-20 09:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/yahayaohinoyi">@yahayaohinoyi</a> on <code>crates/ruff_linter/src/rules/pydocstyle/rules/ends_with_punctuation.rs</code>:112 on 2024-09-20 09:17</div>
            <div class="timeline-body"><blockquote>
<p>I think we still need to move the <code>checker.diagnostic.push</code> call outside the <code>trimmed.ends_with</code> branch or we omit diagnostics for docstring summaries that end in <code>!</code>. We actually see this because I would expect to see more diagnostics in <code>ruff_linter__rules__pydocstyle__tests__D415_D415.py.snap</code></p>
</blockquote>
<p>Does it look any better now?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-09-20 09:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pydocstyle/rules/ends_with_punctuation.rs</code>:110 on 2024-09-20 09:36</div>
            <div class="timeline-body"><p>Looking at the code again, I think this change is unnecessary because line 107 already checks that the text doesn't end with <code>!</code> or <code>?</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/yahayaohinoyi">@yahayaohinoyi</a> reviewed on 2024-09-20 09:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/yahayaohinoyi">@yahayaohinoyi</a> on <code>crates/ruff_linter/src/rules/pydocstyle/rules/ends_with_punctuation.rs</code>:110 on 2024-09-20 09:38</div>
            <div class="timeline-body"><p>Yeah I the issue complains about fixing D400. D415 is just fine the way it is. I'd make a commit but leave the extra generated snapshot for D415</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-09-20 11:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pydocstyle/rules/ends_with_punctuation.rs</code>:49 on 2024-09-20 11:00</div>
            <div class="timeline-body"><p>Nice find</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-09-20 11:00</div>
            <div class="timeline-body"><p>Thank you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2024-09-20 11:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-09-20 11:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:06:34 UTC
    </footer>
</body>
</html>
