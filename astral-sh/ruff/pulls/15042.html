<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Report invalid exceptions - astral-sh/ruff #15042</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Report invalid exceptions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15042">#15042</a>
        opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a>
        on 2024-12-18 00:02
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a></div>
            <div class="timeline-body">Summary
<p>Resolves #15038.</p>
Test Plan
<p>Markdown tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-12-18 00:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-12-18 00:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-12-18 00:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-12-18 00:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-12-18 00:16</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/exception/basic.md</code>:172 on 2024-12-18 00:38</div>
            <div class="timeline-body"><p>Might be nice to have a happy-path test similar to this but showing that we can catch an exception and <code>raise from</code> that exception without error. So like this test, but with a valid exception type in place of <code>int</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/diagnostic.rs</code>:202 on 2024-12-18 00:40</div>
            <div class="timeline-body"><pre><code>    /// Checks for `raise` statements and exception handlers
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/diagnostic.rs</code>:731 on 2024-12-18 00:41</div>
            <div class="timeline-body"><pre><code>                &quot;Cannot raise object of type `{}` (must be a `BaseException` subclass or instance)&quot;,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/diagnostic.rs</code>:742 on 2024-12-18 00:41</div>
            <div class="timeline-body"><pre><code>                &quot;Cannot use object of type `{}` as exception cause (must be a `BaseException` subclass or instance, or `None`)&quot;,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-12-18 00:44</div>
            <div class="timeline-body"><p>Nice! This looks good to me.</p>
<p>I&#x27;d like to get @AlexWaygood review on it, since he&#x27;s done most of the work on exceptions so far. Feel free to hold off on implementing my comments until he reviews also.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-12-18 07:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/diagnostic.rs</code>:737 on 2024-12-18 07:43</div>
            <div class="timeline-body"><pre><code>    pub(super) fn add_invalid_exception_caught(&amp;mut self, db: &amp;dyn Db, node: &amp;ast::Expr, ty: Type) {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/diagnostic.rs</code>:232 on 2024-12-18 07:46</div>
            <div class="timeline-body"><p>Seeing the changes to the documentation, I now think that these should be two error codes: <code>invalid-exception-caught</code> and <code>invalid-exception-raised</code> as @AlexWaygood suggested in the linked issue</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1468 on 2024-12-18 07:48</div>
            <div class="timeline-body"><pre><code>    pub(crate) fn can_be_raised(self, db: &amp;&#x27;db dyn Db) -&gt; bool {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1474 on 2024-12-18 07:48</div>
            <div class="timeline-body"><p>I&#x27;m interested in hearing other opinions. These methods feel too specific to me to have them on <code>Type</code>. That&#x27;s why I&#x27;m leaning towards making them standalone functions. Unless we forsee using them in other places too (I want to avoid that <code>Type</code> ends up with a trillion very specific methods)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-12-18 07:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-18 07:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1474 on 2024-12-18 10:49</div>
            <div class="timeline-body"><p>I agree with @MichaReiser&#x27;s comment here. None of these methods are particularly complicated (so separating them out into a separate methods doesn&#x27;t really improve readability) and they all have very few uses currently. I&#x27;m also not sure they&#x27;re going to be generally useful in many other contexts. Until we have other places where we want to use them, we should just inline them at their uses, in my opinion.</p>
<p>This is also not the way I would write this function. An object can be an exception cause if its type is assignable to the type <code>BaseException | type[BaseException] | None</code>. That&#x27;s <em>not</em> exactly what this function does -- you return <code>true</code> if the object is assignable to <code>BaseException</code> or is assignable to <code>type[BaseException]</code> or actually is (<em>not</em> is assignable to) <code>None</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2200 on 2024-12-18 10:52</div>
            <div class="timeline-body"><p>Please keep the explicit unpacking of the AST node. It means that we get a compiler error warning about unused variables if we forget to infer the type of one of the sub-nodes. That&#x27;s very valuable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2189 on 2024-12-18 11:08</div>
            <div class="timeline-body"><p>As you&#x27;ve seen before in your PRs, red-knot panics if we fail to infer the types for all sub-nodes in an AST. The way you&#x27;ve written this method means that if <code>exc</code> is <code>None</code> but <code>cause</code> is <code>Some()</code>, red-knot will not infer the type of the <code>cause</code> sub-node, and might panic. Now, with valid Python syntax, it&#x27;s impossible for <code>cause</code> to be <code>Some()</code> if <code>exc</code> is <code>None</code> -- but red-knot needs to be able to analyze invalid Python syntax without panicking as well as valid Python syntax. I think currently our parser will never produce an <code>ast.Raise</code> node where <code>exc</code> is <code>None</code> but <code>cause</code> is <code>Some()</code>, even when analyzing invalid syntax -- but that&#x27;s an implementation detail of our parser as it is today; we might change the way we do error recovery at any point, so we shouldn&#x27;t rely on it.</p>
<p>TL;DR: we can&#x27;t do an early return here; you have to make sure that we also infer the type of <code>cause</code> here if it&#x27;s <code>Some()</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> requested changes on 2024-12-18 11:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-18 11:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/diagnostic.rs</code>:232 on 2024-12-18 11:10</div>
            <div class="timeline-body"><p>Yeah, I agree that this would be clearer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/diagnostic.rs</code>:737 on 2024-12-18 16:23</div>
            <div class="timeline-body"><p><code>add_invalid_exception_cause</code> is correct here; this error is about the &quot;cause&quot;, or the <code>e</code> in <code>raise Foo from e</code>, it&#x27;s not about catching exceptions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/diagnostic.rs</code>:232 on 2024-12-18 16:24</div>
            <div class="timeline-body"><p>Two or three separate codes? On the raising side, there&#x27;s the raised exception, and there&#x27;s the cause: the <code>Foo</code> and the <code>e</code> in <code>raise Foo from e</code>. I think if we split it out, we kind of have to go to three, or else one of the two will still have an awkward name: <code>invalid-exception-raised</code> doesn&#x27;t make sense for a bad &quot;cause&quot;, because that&#x27;s not the exception raised.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1474 on 2024-12-18 16:33</div>
            <div class="timeline-body"><p>I would like us to increase our use of well-named functions that describe some semantic of a type, rather than just inlining all of it into type inference, particularly when the same logic would be repeated in more than one location. I do think this makes type inference more readable. I think these methods are worth it if they have a sensible/clear name and have 2+ uses. If they have only one use, I agree that&#x27;s questionable.</p>
<p>As for where they go, I would prefer to keep them on <code>Type</code>; I think that&#x27;s better than a collection of standalone functions which operate on a single <code>Type</code>, both in usage ergonomics and in discoverability. I&#x27;m not worried about too many methods on <code>Type</code>, if we go with the heuristic that methods should generally have 2+ uses, and have a name that clearly represents something semantically meaningful.</p>
<p>Concretely in this case I think those heuristics would suggest keeping <code>is_exception_class</code> and <code>is_exception</code>, but not <code>is_raisable</code> or <code>can_be_exception_cause</code>. (I also think <code>is_none</code> is fine in general, but as Alex points out, maybe isn&#x27;t the clearest option here -- though given that <code>None</code> is final and that will never change, it really doesn&#x27;t matter in practice.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-12-18 16:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-18 16:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/diagnostic.rs</code>:232 on 2024-12-18 16:35</div>
            <div class="timeline-body"><p>I think it would be fine to have two codes: <code>invalid-exception-caught</code> and <code>invalid-raise-statement</code>. One code would be about exception handlers, the other would be about <code>raise</code> statements.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-12-18 16:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/diagnostic.rs</code>:232 on 2024-12-18 16:40</div>
            <div class="timeline-body"><p>Sounds reasonable. Maybe just <code>invalid-raise</code>? Not sure <code>-statement</code> adds value.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-18 16:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1474 on 2024-12-18 16:44</div>
            <div class="timeline-body"><blockquote>
<p>Concretely in this case I think those heuristics would suggest keeping <code>is_exception_class</code> and <code>is_exception</code>, but not <code>is_raisable</code> or <code>can_be_exception_cause</code>.</p>
</blockquote>
<p><code>Type::is_exception()</code> is a one-liner, and I honestly find <code>.is_assignable_to(KnownClass::BaseException.to_instance(db))</code> more readable, because I don&#x27;t have to lookup exactly what <code>is_exception()</code> is doing under the hood.</p>
<p><code>is_exception_class</code> is a bit more complicated than <code>is_exception</code>, because <code>KnownClass::to_subclass_of()</code> returns <code>Option&lt;Type&gt;</code> rather than <code>Type</code>. That&#x27;s probably a bad signature for <code>to_subclass_of()</code> to have, to be honest; I probably made a mistake there when I added it in https://github.com/astral-sh/ruff/commit/ab26d9cf9a5899406e1b4a3555c54e6d0be8ed96#diff-42314c006689490bbdfbeeb973de64046b3e069e3d88f67520aeba375f20e655R1910. Both <code>KnownClass::to_class_literal()</code> and <code>KnownClass::to_instance()</code> fall back to <code>Unknown</code> if they can&#x27;t find the type being looked up rather than returning an <code>Option</code>; for consistency, <code>KnownClass::to_subclass_of()</code> should probably return <code>type[Unknown]</code> if it can&#x27;t find the type in question, rather than returning an <code>Option</code>. If we fixed the signature of <code>KnownClass::to_subclass_of()</code> so that it no longer returns an <code>Option</code>, then <code>is_exception_class()</code> would also just become a trivial one-liner.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1474 on 2024-12-18 16:50</div>
            <div class="timeline-body"><p>Ok, I think it&#x27;s fair to also add the heuristic &quot;encapsulates some non-trivial logic&quot; :) And I agree that making <code>to_subclass_of</code> just handle the fallback to <code>Unknown</code> internally is a good alternative to <code>is_exception_class</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-12-18 16:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/diagnostic.rs</code>:238 on 2024-12-18 17:29</div>
            <div class="timeline-body"><pre><code>    /// Checks for `raise` statements that raise non-exceptions or use invalid
    /// causes for their raised exceptions.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/diagnostic.rs</code>:244 on 2024-12-18 17:31</div>
            <div class="timeline-body"><pre><code>    /// Only subclasses or instances of `BaseException` can be raised.
    /// For an exception&#x27;s cause, the same rules apply, except that `None` is also
    /// permitted. Violating these rules results in a `TypeError` at runtime.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/diagnostic.rs</code>:283 on 2024-12-18 17:37</div>
            <div class="timeline-body"><pre><code>    /// ## Examples
    /// ```python
    /// def f():
    ///     try:
    ///         something()
    ///     except NameError:
    ///         raise &quot;oops!&quot; from f
    ///
    /// def g():
    ///     raise NotImplemented from 42
    /// ```
    ///
    /// Use instead:
    /// ```python
    /// def f():
    ///     try:
    ///         something()
    ///     except NameError as e:
    ///         raise RuntimeError(&quot;oops!&quot;) from e
    ///
    /// def g():
    ///     raise NotImplementedError from None
    /// ```
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1446 on 2024-12-18 17:39</div>
            <div class="timeline-body"><p>This method also returns <code>true</code> (and is correct to do so) for <code>Type::Any</code>, <code>Type::Unknown</code> and <code>Type::Todo</code>, so if we&#x27;re going to keep it for now, it would be better to give it a more precise name than <code>is_exception_class</code>:</p>
<pre><code>    pub(crate) fn is_assignable_to_subclass_of_base_exception(self, db: &amp;&#x27;db dyn Db) -&gt; bool {
</code></pre>
<p>But I would still favour just simplifying the signature of <code>KnownClass::to_subclass_of()</code> so that we don&#x27;t need this method at all</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-18 17:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2322 on 2024-12-18 18:15</div>
            <div class="timeline-body"><pre><code>            .unwrap_or(Type::subclass_of_base(ClassBase::Unknown))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-12-18 18:16</div>
            <div class="timeline-body"><p>Nice, thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-18 18:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2205 on 2024-12-18 18:19</div>
            <div class="timeline-body"><pre><code>
        let can_be_raised =
            UnionType::from_elements(self.db(), [base_exception_type, base_exception_instance]);
        let can_be_exception_cause = UnionType::from_elements(self.db(), [can_be_raised, Type::none(self.db())]);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-18 18:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2204 on 2024-12-18 18:26</div>
            <div class="timeline-body"><pre><code>        let can_be_exception_cause =
            UnionType::from_elements(self.db(), [can_be_raised, Type::none(self.db())]);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-12-18 18:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-12-18 18:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-12-18 18:31</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:09:35 UTC
    </footer>
</body>
</html>
