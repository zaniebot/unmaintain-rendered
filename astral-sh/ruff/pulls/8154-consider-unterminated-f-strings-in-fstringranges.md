```yaml
number: 8154
title: "Consider unterminated f-strings in `FStringRanges`"
type: pull_request
state: merged
author: dhruvmanila
labels:
  - bug
assignees: []
merged: true
base: main
head: dhruv/unterminated-fstring
created_at: 2023-10-24T05:27:01Z
updated_at: 2023-10-27T11:19:14Z
url: https://github.com/astral-sh/ruff/pull/8154
synced_at: 2026-01-12T15:55:25Z
```

# Consider unterminated f-strings in `FStringRanges`

---

_@dhruvmanila_

## Summary

This PR removes the `debug_assertion` in the `Indexer` to allow unterminated f-strings. This is mainly a fix in the development build which now matches the release build.

The fix is simple: remove the `debug_assertion` which means that the there could be `FStringStart` and possibly `FStringMiddle` tokens without a corresponding f-string range in the `Indexer`. This means that the code requesting for the f-string index need to account for the `None` case, making the code safer.

This also updates the code which queries the `FStringRanges` to account for the `None` case. This will happen when the `FStringStart` / `FStringMiddle` tokens are present but the `FStringEnd` token isn't which means that the `Indexer` won't contain the range for that f-string.

## Test Plan

`cargo test`

Taking the following code as an example:

```python
f"{123}
```

This only emits a `FStringStart` token, but no `FStringMiddle` or `FStringEnd` tokens.

And,

```python
f"\.png${
```

This emits a `FStringStart` and `FStringMiddle` token, but no `FStringEnd` token.

fixes: #8065


---

_Comment by @dhruvmanila on 2023-10-24 05:27_

Current dependencies on/for this PR:
* main
  * **PR #8154** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8154" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #8156** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8156" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/8154?utm_source=stack-comment).

---

_@dhruvmanila reviewed on 2023-10-24 05:33_

---

_Review comment by @dhruvmanila on `crates/ruff_python_index/src/fstring_ranges.rs`:97 on 2023-10-24 05:33_

I guess this isn't really required because we'd be providing diagnostics for the same.

---

_Label `bug` added by @dhruvmanila on 2023-10-24 05:33_

---

_Review requested from @MichaReiser by @dhruvmanila on 2023-10-24 05:34_

---

_Review requested from @konstin by @dhruvmanila on 2023-10-24 05:34_

---

_Comment by @github-actions[bot] on 2023-10-24 05:49_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.



---

_@MichaReiser reviewed on 2023-10-24 06:42_

---

_Review comment by @MichaReiser on `crates/ruff_python_index/src/fstring_ranges.rs`:97 on 2023-10-24 06:42_

I wonnder if it would be useful to store the range with a missing and position instead of omitting it entirely.

---

_@MichaReiser reviewed on 2023-10-24 07:15_

---

_Review comment by @MichaReiser on `crates/ruff_python_index/src/fstring_ranges.rs`:97 on 2023-10-24 07:15_

To extend on this:  It might even be more correct to simply assume that everything after the fstring start token is inside the fstring if the end token is missing. However, what the correct interpretation is might depend on the specific usage. E.g. adding noqa comments might be a bad idea for unclosed fstring. Rules testing if the range is part of a multiline string could get away by assuming the string goes to the end of the file 

---

_Comment by @konstin on 2023-10-24 07:40_

Shouldn't unterminated f-strings be caught in the parser?

---

_Comment by @dhruvmanila on 2023-10-24 09:18_

> Shouldn't unterminated f-strings be caught in the parser?

Yes, they're being caught. The issue which was highlighted in the linked issue is a debug assertion present in constructing the f-string ranges in the indexer. And, the indexer uses the flattened tokens for that purpose which ignores the error tokens.

For the following code snippet,
```python
f"{123}
```

We would've panicked but only in the debug build which is what this PR fixes.

Actually, the release build could panic as well with:
```python
f"\.png${
```

And, running with:
```console
$ pipx run "ruff==0.1.1" check --isolated --no-cache --select=W605,E999 ~/playground/ruff/fstring.py --fix
error: Panicked while linting /Users/dhruv/playground/ruff/fstring.py: This indicates a bug in Ruff. If you could open an issue at:

    https://github.com/astral-sh/ruff/issues/new?title=%5BLinter%20panic%5D

...with the relevant file contents, the `pyproject.toml` settings, and the following stack trace, we'd be very appreciative!

panicked at 'called `Option::unwrap()` on a `None` value', crates/ruff_linter/src/rules/pycodestyle/rules/invalid_escape_sequence.rs:175:18
Backtrace:    0: _rust_eh_personality
   1: _main
   2: _rust_eh_personality
   3: _rust_eh_personality
   4: _rust_eh_personality
   5: _rust_eh_personality
   6: __rjem_je_witnesses_cleanup
   7: __rjem_je_witnesses_cleanup
   8: _main
   9: _main
  10: _main
  11: _main
  12: _main
  13: _main
  14: _main
  15: _main
  16: start
  17: start
  18: _main
```

---

_@dhruvmanila reviewed on 2023-10-24 10:02_

---

_Review comment by @dhruvmanila on `crates/ruff_python_index/src/fstring_ranges.rs`:97 on 2023-10-24 10:02_

I thought of the same in one of my [proposed solution](https://github.com/astral-sh/ruff/issues/8065#issuecomment-1776530001).

For rules, they're only being used to check `W605` (invalid escape sequence) and `ISC` (implicit string concatenation) which will be fine. For the former, the fix will be created (see below) while for later the fix won't be created.

```diff
-f"\.png{
+rf"\.png{
```

The NoQA logic will need to be looked into though. We might have to somehow mark these ranges as "incomplete from source code point of view".


---

_@dhruvmanila reviewed on 2023-10-24 10:03_

---

_Review comment by @dhruvmanila on `crates/ruff_linter/src/rules/flake8_implicit_str_concat/rules/implicit.rs`:124 on 2023-10-24 10:03_

These unwrap's aren't safe at all as I thought earlier. Ruff can panic on certain edge cases. It's better to account for the `None` case.

---

_Comment by @konstin on 2023-10-24 12:03_

> Yes, they're being caught. The issue which was highlighted in the linked issue is a debug assertion present in constructing the f-string ranges in the indexer. And, the indexer uses the flattened tokens for that purpose which ignores the error tokens.

Sorry, i missed that the index is built during parsing, not after

---

_@konstin approved on 2023-10-24 12:03_

---

_Comment by @charliermarsh on 2023-10-24 12:47_

I believe the Indexer is built before parsing, but not as part of parsing itself. We need to build it regardless of whether the source code is valid, because we do support linting invalid programs (at least for the token-based rules).

---

_@MichaReiser reviewed on 2023-10-24 12:50_

---

_Review comment by @MichaReiser on `crates/ruff_python_index/src/fstring_ranges.rs`:97 on 2023-10-24 12:50_

I'm also fine with adding the entire range, but just omitting the range of an unterminated string seems wrong to me (I rather overestimate than underestimate the f-string range)

---

_@dhruvmanila reviewed on 2023-10-24 13:25_

---

_Review comment by @dhruvmanila on `crates/ruff_python_index/src/fstring_ranges.rs`:97 on 2023-10-24 13:25_

We should probably avoid adding NoQA directives then otherwise it won't be lexed as a comment and the `--add-noqa` will keep on adding them.

```python
f"\.png
  # noqa: W605
  # noqa: W605
  # ...
```

I'm not sure how to store this info. One solution could be to update the signature from `BTreeMap<TextSize, TextRange>` to `BTreeMap<TextSize, FStringRange>` where:
```rust
struct FStringRange {
	range: TextRange,
	// Is this f-string complete i.e., does it have both the start and end tokens?
	complete: bool
}
```

Or, while computing the NoQA mapping we can ignore these ranges by somehow checking if they're for a _complete_ f-string or not.

@charliermarsh Any thoughts here?

---

_@charliermarsh reviewed on 2023-10-25 16:39_

---

_Review comment by @charliermarsh on `crates/ruff_python_index/src/fstring_ranges.rs`:97 on 2023-10-25 16:39_

If we did change the type to `TreeMap<TextSize, FStringRange>`, where would we then use that information to avoid adding NOQA?

---

_@dhruvmanila reviewed on 2023-10-26 04:05_

---

_Review comment by @dhruvmanila on `crates/ruff_python_index/src/fstring_ranges.rs`:97 on 2023-10-26 04:05_

Earlier I thought that ignoring such ranges here would work:

https://github.com/astral-sh/ruff/blob/29fb86e3c831fd6e72283c0342f85e2b2fa7479c/crates/ruff_linter/src/directives.rs#L154-L171

But, I don't think so as then, by default, Ruff will add the directive at the end of the line.

I think we can update this function to return a `Option<TextSize>` instead:

https://github.com/astral-sh/ruff/blob/29fb86e3c831fd6e72283c0342f85e2b2fa7479c/crates/ruff_linter/src/noqa.rs#L746-L762

which will be used here and `continue` on `None`:

https://github.com/astral-sh/ruff/blob/29fb86e3c831fd6e72283c0342f85e2b2fa7479c/crates/ruff_linter/src/noqa.rs#L527-L527

Note that even if we somehow support this, it'll be impossible to ignore any violation on that line manually. For example,

```python
# Unterminated f-string
f"\.png{x}  # noqa: W605
```

Here, the `noqa` comment is part of the f-string and is not a comment.

---

_@charliermarsh reviewed on 2023-10-26 04:45_

---

_Review comment by @charliermarsh on `crates/ruff_python_index/src/fstring_ranges.rs`:97 on 2023-10-26 04:45_

The plan you described here makes sense to me. Thanks for walking me through it.

---

_@MichaReiser approved on 2023-10-26 08:16_

I would prefer if we express the fact that unterminated f-strings are not stored in the return type of `innermost` rather than just a note but are fine moving forward with this solution.

---

_Closed by @dhruvmanila on 2023-10-27 11:00_

---

_Reopened by @dhruvmanila on 2023-10-27 11:01_

---

_@dhruvmanila reviewed on 2023-10-27 11:02_

---

_Review comment by @dhruvmanila on `crates/ruff_python_index/src/fstring_ranges.rs`:97 on 2023-10-27 11:02_

I've a local branch with a possible implementation for this but there are a few complexities involved. I'll proceed with merging this and open a new PR with that change instead.

---

_Renamed from "Allow unterminated f-strings in the indexer" to "Consider unterminated f-strings in `FStringRanges`" by @dhruvmanila on 2023-10-27 11:05_

---

_Merged by @dhruvmanila on 2023-10-27 11:11_

---

_Closed by @dhruvmanila on 2023-10-27 11:11_

---

_Branch deleted on 2023-10-27 11:11_

---
