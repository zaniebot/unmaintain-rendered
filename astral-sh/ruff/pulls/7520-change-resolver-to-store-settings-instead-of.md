```yaml
number: 7520
title: "Change `Resolver` to store `Settings` instead of `AllSettings`"
type: pull_request
state: closed
author: MichaReiser
labels:
  - internal
assignees: []
base: main
head: resolver-settings
created_at: 2023-09-19T14:51:32Z
updated_at: 2023-09-20T06:12:41Z
url: https://github.com/astral-sh/ruff/pull/7520
synced_at: 2026-01-12T02:39:10Z
```

# Change `Resolver` to store `Settings` instead of `AllSettings`

---

_Pull request opened by @MichaReiser on 2023-09-19 14:51_

## Summary

This PR changes `Resolver` to only store `Settings` internally instead of `AllSettings` because `AllSettings` is only intended to be used at the top-level. It moves the `cache_dir` settings from `AllSettings` to `Settings` because it is an inherited setting.

~~This comes with one semenatical change. Previously, the cache for each python package was stored at the location specified by the configuration in that python package. 
I don't think that was intentionally.~~


## Test Plan

`cargo test`

Running ruff with caching enabled is somewhat faster (proving that caching isn't broken)

```
 hyperfine --warmup 10 \
        "./target/release/ruff ./crates/ruff/resources/test/cpython -e" \
        "./target/release/ruff ./crates/ruff/resources/test/cpython --no-cache -e"
Benchmark 1: ./target/release/ruff ./crates/ruff/resources/test/cpython -e
  Time (mean ¬± œÉ):      80.1 ms ¬±   3.0 ms    [User: 88.5 ms, System: 97.5 ms]
  Range (min ‚Ä¶ max):    75.9 ms ‚Ä¶  89.5 ms    35 runs
 
Benchmark 2: ./target/release/ruff ./crates/ruff/resources/test/cpython --no-cache -e
  Time (mean ¬± œÉ):     201.9 ms ¬±   4.7 ms    [User: 2904.2 ms, System: 125.7 ms]
  Range (min ‚Ä¶ max):   196.2 ms ‚Ä¶ 214.8 ms    14 runs
 
Summary
  ./target/release/ruff ./crates/ruff/resources/test/cpython -e ran
    2.52 ¬± 0.11 times faster than ./target/release/ruff ./crates/ruff/resources/test/cpython --no-cache -e
```

Verified that Ruff writes to a different cache directory when changing the `cache-dir` setting in the pyproject.toml.


---

_Comment by @MichaReiser on 2023-09-19 14:51_

Current dependencies on/for this PR:
* main
  * **PR #7518** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7518" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7520** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7520" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  üëà
      * **PR #7522** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7522" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7520?utm_source=stack-comment).

---

_Review requested from @charliermarsh by @MichaReiser on 2023-09-19 14:51_

---

_Label `internal` added by @MichaReiser on 2023-09-19 14:51_

---

_Review comment by @MichaReiser on `crates/ruff_workspace/src/resolver.rs`:280 on 2023-09-19 14:52_

Whoops, I couldn't resist. It avoids traversing the whole ancestor multiple times if you have `ruff check file.py, file2.py`

---

_@MichaReiser reviewed on 2023-09-19 14:52_

---

_Comment by @github-actions[bot] on 2023-09-19 15:22_

## PR Check Results
### Ecosystem
‚úÖ ecosystem check detected no changes.



---

_Review comment by @charliermarsh on `crates/ruff_cli/src/commands/check.rs`:68 on 2023-09-19 16:53_

Is this ok? Do we not use the `cache_dir` of each individual settings?

---

_@charliermarsh reviewed on 2023-09-19 16:53_

---

_@charliermarsh reviewed on 2023-09-19 16:54_

---

_Review comment by @charliermarsh on `crates/ruff_cli/src/commands/check.rs`:82 on 2023-09-19 16:54_

Ah ok, no -- we always use the cache dir from the top-level.

---

_@charliermarsh reviewed on 2023-09-19 16:55_

---

_Review comment by @charliermarsh on `crates/ruff_cli/src/commands/check.rs`:82 on 2023-09-19 16:55_

Ahh ok, this is the semantic change you're describing in the PR summary.

---

_@charliermarsh approved on 2023-09-19 16:56_

> This comes with one semenatical change. Previously, the cache for each python package was stored at the location specified by the configuration in that python package.

I feel like the previous behavior may have been more correct? Do you disagree? But I don't feel strongly and trust your judgment.

---

_Comment by @MichaReiser on 2023-09-19 18:07_

> > This comes with one semenatical change. Previously, the cache for each python package was stored at the location specified by the configuration in that python package.
> 
> 
> 
> I feel like the previous behavior may have been more correct? Do you disagree? But I don't feel strongly and trust your judgment.

It depends on the intended semantics and if this is a use case we want too support. The way I understood you is that all settings on AllSettings should be global and don't support overwriting. We can keep the current behavior by moving the setting to Settings instead. But it feels like a very rare edge case to me. Or do you think it to be common in very large monorepos?

---

_Review comment by @MichaReiser on `crates/ruff_cli/src/commands/check.rs`:68 on 2023-09-19 18:08_

ü§∑‚Äç‚ôÄÔ∏è My assumption was that settings in AllSettings are global and not overridable. What's the use case for different caches per directory?

---

_@MichaReiser reviewed on 2023-09-19 18:08_

---

_Comment by @charliermarsh on 2023-09-19 18:10_

I think it's pretty rare. If folks want to change the cache dir, it's almost always a global change (often to some path outside of the project, based on my grepping). This seems fine.

---

_Comment by @MichaReiser on 2023-09-19 18:13_

Let me restore the old behavior to make this a pure refactor but move it to settings instead 

---

_@MichaReiser reviewed on 2023-09-19 20:46_

---

_Review comment by @MichaReiser on `crates/ruff_workspace/src/resolver.rs`:117 on 2023-09-19 20:46_

@charliermarsh what's the resolution logic here? It feels kind of slow because it iterates over all settings without making use of the `BTreeMap`. Do you think we could optimize it by using `range` to prefilter the potential settings? Maybe `range(..path).rev().take_while(|(root, _)| path.starts_with(root)).last()`?

---

_@MichaReiser reviewed on 2023-09-19 21:14_

---

_Review comment by @MichaReiser on `crates/ruff_cli/src/commands/check.rs`:68 on 2023-09-19 21:14_

Back to the old behavior

---

_Review comment by @MichaReiser on `crates/ruff_macros/src/cache_key.rs`:1 on 2023-09-19 21:15_

I added logic to ignore fields from the generated `CacheKey` implementation

---

_@MichaReiser reviewed on 2023-09-19 21:15_

---

_Comment by @codspeed-hq[bot] on 2023-09-19 21:30_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/resolver-settings)

### Merging #7520 will **improve performances by 2.46%**

<sub>Comparing <code>resolver-settings</code> (5b14236) with <code>main</code> (297ec2c)</sub>



### Summary

`‚ö° 1` improvements
`‚úÖ 24` untouched benchmarks




### Benchmarks breakdown

|     | Benchmark | `main` | `resolver-settings` | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ‚ö° | `linter/all-rules[numpy/ctypeslib.py]` | 35.1 ms | 34.2 ms | +2.46% |


---

_@charliermarsh reviewed on 2023-09-19 22:33_

---

_Review comment by @charliermarsh on `crates/ruff_workspace/src/resolver.rs`:117 on 2023-09-19 22:33_

I think the intent here is just to iterate from longest path to shortest. I'm not sure if that answers your question...

---

_Comment by @MichaReiser on 2023-09-20 06:12_

I'm closing this. My initial understanding was that the intention of `AllSettings` is to store settings that only apply to globally, but `cache-key` proves that this isn't the point. The main purpose solely seems to be that settings on `CliSettings` are CLI only, and should not be part of the cache key

---

_Closed by @MichaReiser on 2023-09-20 06:12_

---
