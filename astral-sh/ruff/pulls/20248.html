<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Implement the legacy PEP-484 convention for indicating positional-only parameters - astral-sh/ruff #20248</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Implement the legacy PEP-484 convention for indicating positional-only parameters</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20248">#20248</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-09-04 18:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-09-04 18:50</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>PEP 570, introduced in Python 3.8, added dedicated Python syntax for denoting positional-only
parameters (the <code>/</code> in a function signature). However, functions implemented in C were able to have positional-only parameters prior to Python 3.8 (there was just no syntax for expressing this at the Python level).</p>
<p>Stub files describing functions implemented in C nonetheless needed a way of expressing that certain parameters were positional-only. In the absence of dedicated Python syntax, PEP 484 described a convention that type checkers were expected to understand:</p>
<blockquote>
<p>Some functions are designed to take their arguments only positionally, and expect their callers never to use the argumentâ€™s name to provide that argument by keyword. All arguments with names beginning with <code>__</code> are assumed to be positional-only, except if their names also end with <code>__</code>.</p>
</blockquote>
<p>While this convention is now redundant (following the implementation of PEP 570), many projects still continue to use the old convention. This PR therefore adds support for the older convention.</p>
<h2>Test Plan</h2>
<p>Mdtests added and updated</p>
<hr />
<p>Co-authored-by: Carl Meyer <a href="mailto:carl@astral.sh">carl@astral.sh</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-09-04 18:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-04 18:53</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<details>
<summary>Changes were detected when running ty on typing conformance tests</summary>

<pre><code class="language-diff">--- old-output.txt	2025-09-05 11:42:40.616229139 +0000
+++ new-output.txt	2025-09-05 11:42:43.238286300 +0000
@@ -606,6 +606,10 @@
 generics_variance_inference.py:170:1: error[invalid-assignment] Object of type `ShouldBeInvariant6[int]` is not assignable to `ShouldBeInvariant6[int | float]`
 generics_variance_inference.py:181:1: error[invalid-assignment] Object of type `ShouldBeCovariant6[int | float]` is not assignable to `ShouldBeCovariant6[int]`
 generics_variance_inference.py:194:1: error[invalid-assignment] Object of type `ShouldBeContravariant2[int]` is not assignable to `ShouldBeContravariant2[int | float]`
+historical_positional.py:18:1: error[missing-argument] No argument provided for required parameter `__x` of function `f1`
+historical_positional.py:18:4: error[unknown-argument] Argument `__x` does not match any known parameter of function `f1`
+historical_positional.py:43:1: error[missing-argument] No argument provided for required parameter `__x` of bound method `m1`
+historical_positional.py:43:6: error[unknown-argument] Argument `__x` does not match any known parameter of bound method `m1`
 literals_interactions.py:15:5: error[index-out-of-bounds] Index 5 is out of bounds for tuple `tuple[int, str, list[bool]]` with length 3
 literals_interactions.py:16:5: error[index-out-of-bounds] Index -5 is out of bounds for tuple `tuple[int, str, list[bool]]` with length 3
 literals_interactions.py:17:5: error[index-out-of-bounds] Index 4 is out of bounds for tuple `tuple[int, str, list[bool]]` with length 3
@@ -692,7 +696,7 @@
 narrowing_typeis.py:96:9: error[type-assertion-failure] Argument does not have asserted type `B`
 narrowing_typeis.py:132:20: error[invalid-argument-type] Argument to function `takes_callable_str` is incorrect: Expected `(object, /) -&gt; str`, found `def simple_typeguard(val: object) -&gt; TypeIs[int]`
 narrowing_typeis.py:191:18: error[invalid-argument-type] Argument to function `takes_int_typeis` is incorrect: Expected `(object, /) -&gt; TypeIs[int]`, found `def bool_typeis(val: object) -&gt; TypeIs[bool]`
-overloads_basic.py:39:1: error[invalid-argument-type] Method `__getitem__` of type `Overload[(__i: int) -&gt; int, (__s: slice[Any, Any, Any]) -&gt; bytes]` cannot be called with key of type `Literal[&quot;&quot;]` on object of type `Bytes`
+overloads_basic.py:39:1: error[invalid-argument-type] Method `__getitem__` of type `Overload[(__i: int, /) -&gt; int, (__s: slice[Any, Any, Any], /) -&gt; bytes]` cannot be called with key of type `Literal[&quot;&quot;]` on object of type `Bytes`
 overloads_definitions.py:20:5: error[invalid-overload] Overloaded function `func1` requires at least two overloads
 overloads_definitions.py:33:5: error[invalid-overload] Overloaded non-stub function `func2` must have an implementation
 overloads_definitions.py:63:9: error[invalid-overload] Overloaded non-stub function `not_abstract` must have an implementation
@@ -864,5 +868,5 @@
 typeddicts_usage.py:28:1: error[missing-typed-dict-key] Missing required key 'name' in TypedDict `Movie` constructor
 typeddicts_usage.py:28:18: error[invalid-key] Invalid key access on TypedDict `Movie`: Unknown key &quot;title&quot;
 typeddicts_usage.py:40:24: error[invalid-type-form] The special form `typing.TypedDict` is not allowed in type expressions. Did you mean to use a concrete TypedDict or `collections.abc.Mapping[str, object]` instead?
-Found 865 diagnostics
+Found 869 diagnostics
 WARN A fatal error occurred while checking some files. Not all project files were analyzed. See the diagnostics list above for details.
</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-04 18:56</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">hydra-zen (https://github.com/mit-ll-responsible-ai/hydra-zen)
- tests/annotations/declarations.py:860:33: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- tests/annotations/declarations.py:863:41: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- tests/annotations/declarations.py:866:38: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 564 diagnostics
+ Found 561 diagnostics

</code></pre>
</details>
No memory usage changes detected âœ…

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-09-04 22:31</div>
            <div class="timeline-body"><p>The conformance suite diff is all positive: we're emitting new diagnostics on lines where we're meant to emit diagnostics.</p>
<p>The <a href="https://github.com/mit-ll-responsible-ai/hydra-zen/blob/4a9997c6a9907d0c85a39a422d8f5760d7358b68/tests/annotations/declarations.py#L858-L866">new hits on <code>hydra-zen</code></a> are also expected -- they're actually trying to <em>assert</em> on these lines that certain calls cause the type checker to emit diagnostics.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/signatures.rs</code>:1246 on 2025-09-04 22:40</div>
            <div class="timeline-body"><p>I initially tried to see what would happen if we made <code>self</code> or <code>cls</code> <em>always</em> implicitly positional-only, even if there were no other parameters in the function that used the PEP-484 convention. But there were a surprising number of ecosystem hits where people really are passing <code>self</code> or <code>cls</code> using keyword arguments.</p>
<p>The reason why this might be &quot;interesting&quot; for protocols is that <a href="https://github.com/python/typeshed/blob/07557a4316d246b4315f600fd4c9734297d6bc92/stdlib/typing.pyi#L528"><code>Iterator.__iter__</code></a> (for example) is not annotated as having a positional-only <code>self</code> parameter in typeshed. A naive implementation of protocol assignability/subtyping for method members might therefore lead us to conclude that this class isn't a subtype of <code>Iterable</code> (the protocol declares that it must be possible to pass <code>self</code> by keyword argument, and you can't do that with <code>Foo.__iter__</code>!), which is almost certainly going to be a counter-intuitive result for the user and go against their intent:</p>
<pre><code class="language-py">from typing import Iterator

class Foo:
    def __iter__(self, /) -&gt; Iterator[int]: ...
</code></pre>
<p>I suppose one alternative here might be to treat <code>self</code> as always implicitly positional-only for dunder methods? That doesn't feel like it would lead to particularly consistent or principled behaviour though.</p>
<p>I also think it's not essential to find a solution to this now, though. It's sort of a rare edge case, and anyway I'm pretty sure I can work around it fairly easily in our <code>Protocol</code> implementation</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-09-04 22:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @AlexWaygood on 2025-09-04 22:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-09-04 22:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-09-04 22:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @AlexWaygood on 2025-09-04 22:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/semantic_index/definition.rs</code>:1137 on 2025-09-04 23:58</div>
            <div class="timeline-body"><p>We could fill this out and add similar <code>From</code> implementations for the <code>AstNodeRef</code> wrapper of every AST node kind that we currently implement <code>From</code> for a direct reference to. I intended in our pairing session today that we'd come back and do this; it might save someone some confusion in future if they try to use a different kind of <code>AstNodeRef</code> as an <code>Into&lt;DefinitionNodeKey&gt;</code>. Seems sort of odd to arbitrarily support it only for class definitions, even if that's the only place we currently use it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/function.rs</code>:796 on 2025-09-05 00:18</div>
            <div class="timeline-body"><p>Nice! Glad to see we don't have to duplicate the source of truth for special-cased method names.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/signatures.rs</code>:1246 on 2025-09-05 00:23</div>
            <div class="timeline-body"><p>It makes sense to me to imply this only for <code>Protocol</code> methods (as suggested in your <code>TODO</code> comment above.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-09-05 00:23</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @sharkdp on 2025-09-05 08:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-09-05 11:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/semantic_index/definition.rs</code>:1137 on 2025-09-05 11:19</div>
            <div class="timeline-body"><p>I found a way to generalise this impl (ðŸ¥³) using higher-ranked trait bounds (ðŸ˜±) in https://github.com/astral-sh/ruff/pull/20248/commits/487334cb1498aa5a48065d00543a16b8b6d9d10c</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-09-05 11:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/signatures.rs</code>:1246 on 2025-09-05 11:20</div>
            <div class="timeline-body"><p>done in https://github.com/astral-sh/ruff/pull/20248/commits/3e1153a1a174fd4fdd9b79f865153be71394b994</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-05 11:30</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>âœ… ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>âœ… ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-09-05 11:56</div>
            <div class="timeline-body"><p>Requesting a re-review since this has changed a fair bit since you last took a look!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-09-05 11:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-09-05 16:33</div>
            <div class="timeline-body"><p>This is great!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-09-05 16:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-09-05 16:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-09-05 16:56</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:46:48 UTC
    </footer>
</body>
</html>
