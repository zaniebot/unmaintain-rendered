<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add formatting for `StmtMatch` - astral-sh/ruff #6286</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add formatting for <code>StmtMatch</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6286">#6286</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2023-08-02 20:04
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body">Summary
<p>This PR adds support for <code>StmtMatch</code> with subs for <code>MatchCase</code>.</p>
Test Plan
<p>Add a few additional test cases around <code>match</code> statement, comments, line breaks.</p>
<p>resolves: #6298</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-08-02 20:04</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #6286</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6286"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite"></a>  ðŸ‘ˆ<ul>
<li><strong>PR #6360</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6360"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite"></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6286?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-08-02 20:30</div>
            <div class="timeline-body">PR Check Results
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      8.2Â±0.06ms     5.0 MB/sec    1.00      8.2Â±0.06ms     5.0 MB/sec
formatter/numpy/ctypeslib.py               1.00  1625.9Â±46.67Âµs    10.2 MB/sec    1.00   1620.8Â±7.58Âµs    10.3 MB/sec
formatter/numpy/globals.py                 1.00    182.0Â±3.88Âµs    16.2 MB/sec    1.00    182.9Â±0.27Âµs    16.1 MB/sec
formatter/pydantic/types.py                1.00      3.4Â±0.06ms     7.4 MB/sec    1.00      3.5Â±0.04ms     7.4 MB/sec
linter/all-rules/large/dataset.py          1.00     10.1Â±0.05ms     4.0 MB/sec    1.03     10.3Â±0.12ms     3.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      2.7Â±0.01ms     6.2 MB/sec    1.01      2.7Â±0.02ms     6.1 MB/sec
linter/all-rules/numpy/globals.py          1.00    377.9Â±0.90Âµs     7.8 MB/sec    1.00    379.4Â±0.77Âµs     7.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      4.6Â±0.02ms     5.5 MB/sec    1.02      4.7Â±0.04ms     5.4 MB/sec
linter/default-rules/large/dataset.py      1.00      5.3Â±0.01ms     7.7 MB/sec    1.00      5.3Â±0.04ms     7.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1133.9Â±1.12Âµs    14.7 MB/sec    1.00   1132.8Â±1.35Âµs    14.7 MB/sec
linter/default-rules/numpy/globals.py      1.00    127.4Â±2.46Âµs    23.2 MB/sec    1.00    127.0Â±1.33Âµs    23.2 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.3Â±0.02ms    10.9 MB/sec    1.00      2.3Â±0.01ms    10.9 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     10.0Â±0.13ms     4.1 MB/sec    1.04     10.4Â±0.16ms     3.9 MB/sec
formatter/numpy/ctypeslib.py               1.00  1896.9Â±30.41Âµs     8.8 MB/sec    1.03  1953.7Â±30.67Âµs     8.5 MB/sec
formatter/numpy/globals.py                 1.00    208.9Â±6.80Âµs    14.1 MB/sec    1.02    213.9Â±7.44Âµs    13.8 MB/sec
formatter/pydantic/types.py                1.00      4.2Â±0.06ms     6.1 MB/sec    1.04      4.3Â±0.05ms     5.9 MB/sec
linter/all-rules/large/dataset.py          1.00     12.8Â±0.12ms     3.2 MB/sec    1.01     13.0Â±0.14ms     3.1 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.5Â±0.04ms     4.8 MB/sec    1.01      3.5Â±0.04ms     4.8 MB/sec
linter/all-rules/numpy/globals.py          1.00    432.2Â±8.97Âµs     6.8 MB/sec    1.00    432.4Â±6.83Âµs     6.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.8Â±0.05ms     4.4 MB/sec    1.03      6.0Â±0.12ms     4.3 MB/sec
linter/default-rules/large/dataset.py      1.00      6.9Â±0.17ms     5.9 MB/sec    1.00      6.9Â±0.10ms     5.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.02  1444.7Â±19.62Âµs    11.5 MB/sec    1.00  1415.7Â±15.93Âµs    11.8 MB/sec
linter/default-rules/numpy/globals.py      1.00    164.4Â±2.92Âµs    17.9 MB/sec    1.00    164.8Â±2.84Âµs    17.9 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.0Â±0.03ms     8.4 MB/sec    1.01      3.1Â±0.05ms     8.3 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/konstin">@konstin</a> on 2023-08-03 07:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Add formatting for `StmtMatch` and `MatchCase`&quot; to &quot;Add formatting for `StmtMatch`&quot; by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-08-05 04:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_formatter/src/statement/stmt_match.rs</code>:45 on 2023-08-05 05:57</div>
            <div class="timeline-body"><p>Temporary until the <code>MatchCase</code> formatting is implemented.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_formatter/tests/snapshots/format@statement__match.py.snap</code>:76 on 2023-08-05 06:02</div>
            <div class="timeline-body"><p>This seems to be a known issue where the comment right next to an opening parentheses is moved down instead.</p>
<pre><code>- match (  # leading expr comment
+ match (
+     # leading expr comment
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-08-05 06:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-08-05 06:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-08-05 06:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-08-05 06:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:428 on 2023-08-07 08:44</div>
            <div class="timeline-body"><p>Do we need this function? i left it because i hadn&#x27;t worked with match yet, but that case should be handled by the generic if/while/for/try logic</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/statement/stmt_match.rs</code>:32 on 2023-08-07 08:45</div>
            <div class="timeline-body"><p>Can this be more than one comment, and if not, could you add a debug assert?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-08-07 08:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_match.rs</code>:46 on 2023-08-07 08:46</div>
            <div class="timeline-body"><p>Could we move the mock implementations to the match cases instead and call into <code>case.format().fmt(f)</code> here?</p>
<p>This has the benefit that implementing a specific match case requires no changes to the statement formatting (and we can even provide match case mocks of the right pattern)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_match.rs</code>:37 on 2023-08-07 08:48</div>
            <div class="timeline-body"><p>Do we need to retain empty lines between match cases?</p>
<p>Micha trying to write valid python code :sweat_smile:</p>
<pre><code>match test:
	case &quot;a&quot;:
		pass

	case &quot;b&quot;:
		pass
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-07 08:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/tests/snapshots/format@statement__match.py.snap</code>:76 on 2023-08-07 08:56</div>
            <div class="timeline-body"><p>See also #6380 and #6381, but we don&#x27;t have the handling for this for general expression parentheses yet, leading end-of-line comments inside of optional expression parentheses are rather rare</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-08-07 08:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-08-07 17:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:428 on 2023-08-07 17:08</div>
            <div class="timeline-body"><p>Oh, thanks for letting me know. Yeah, we don&#x27;t actually need it as the comments are placed properly around the match statements and case nodes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_formatter/src/statement/stmt_match.rs</code>:46 on 2023-08-07 17:36</div>
            <div class="timeline-body"><p>Yeah, we can.</p>
<blockquote>
<p>(and we can even provide match case mocks of the right pattern)</p>
</blockquote>
<p>By this, do you mean the different kinds of patterns for the match cases? If so, that will make the formatting unstable because in the first iteration each pattern type will be formatted as it&#x27;s not implemented equivalent but on the second iteration (now that the pattern is a variable semantically), some of them will be formatted again.</p>
<pre><code>match p:
	case Point(x, y):  # Pattern::MatchClass
		pass

# vvvvv
match p:
	case NOT_YET_IMPLEMENTED_MatchClass:  # Pattern::MatchValue
		pass

# vvvvv
match p:
	case NOT_YET_IMPLEMENTED_MatchValue:
		pass
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-08-07 17:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_formatter/src/statement/stmt_match.rs</code>:37 on 2023-08-07 17:37</div>
            <div class="timeline-body"><p>I think the newline handling will be done in the <code>MatchCase</code> implementation. Any newline between the <code>match</code> statement and the first case will be removed as is done in black as well:</p>
<pre><code>match test:

	case &quot;a&quot;:
		pass

# vvvvv
match test:
	case &quot;a&quot;:
		pass
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-08-07 17:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-08-07 17:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-07 18:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_match.rs</code>:46 on 2023-08-07 18:20</div>
            <div class="timeline-body"><p>You can use the not_implemented_custom_text to provide a specific text. You then need to make sure that the class item uses a class verbatim text.</p>
<p>If it&#x27;s not already the case: The MatchCase formatting should be a match statement that dispatches the formatting to the specific case item (see FormatStmt)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/visitor.rs</code>:76 on 2023-08-08 08:52</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/other/match_case.rs</code>:27 on 2023-08-08 08:55</div>
            <div class="timeline-body"><p>We can also do this as a separate PR: Ideally, we call into <code>pattern.format()</code> here. This requires implementing <code>AsFormat</code> and <code>IntoFormat</code> for <code>Pattern</code>, similar to how it is done for <code>Mod</code></p>
<p>https://github.com/astral-sh/ruff/blob/f45e8645d7c4a2ad4e934ebbbadd91ca59fd543a/crates/ruff_python_formatter/src/module/mod.rs#L1-L35</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-08-08 08:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-08-08 13:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_formatter/src/other/match_case.rs</code>:27 on 2023-08-08 13:03</div>
            <div class="timeline-body"><p>Yes, it&#x27;s already a work in progress in the next PR (<a href="https://github.com/astral-sh/ruff/pull/6360">astral-sh/ruff#6360</a>/files#diff-05760c9829e7694c86aaf97014143c0785c12da546f06dcfbc87caf67b15d773) ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-08-08 13:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-08-08 13:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-08-08 13:18</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:55:57 UTC
    </footer>
</body>
</html>
