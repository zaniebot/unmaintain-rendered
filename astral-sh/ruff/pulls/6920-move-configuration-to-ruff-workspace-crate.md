```yaml
number: 6920
title: "Move `Configuration` to `ruff_workspace` crate"
type: pull_request
state: merged
author: MichaReiser
labels:
  - internal
assignees: []
merged: true
base: main
head: ruff-project
created_at: 2023-08-27T16:45:45Z
updated_at: 2023-08-28T06:21:50Z
url: https://github.com/astral-sh/ruff/pull/6920
synced_at: 2026-01-12T15:55:22Z
```

# Move `Configuration` to `ruff_workspace` crate

---

_@MichaReiser_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This PR introduces a new `ruff_workspace` crate and moves `Configuration` and the project file discovery to the newly created crate. 

The motivation for this change is to 

a) Speed up the ruff library compile time to enable faster development cycles
b) Prepare for the formatter where it becomes necessary to add formatter specific configurations to `Configuration`. This wouldn't be possible today without adding `ruff_python_formatter` as a dependency to `ruff`, which we want to avoid (even slower compile times). 

Some consequences of the refactor:

* It was possible to move the whole `flake8` converter module from ruff to the flake8 crate.
* All plugin options are no longer defined alongside their rule code but had to be moved to `ruff_workspace`. I think that's how it is intended.


## Results

This reduces the release llvm lines from 1801126 -> 1451732 (~20% reduction) and building the ruff library in release mode drops from 43s to 33s on my machine, which is a lot! 

It also reduces the ruff binary release build time from 156 to 137s, mainly because `ruff_workspace` can compile in parallel to `ruff` (at least part of the time)

## Test Plan

`cargo build` and `cargo test`

<!-- How was it tested? -->


---

_Comment by @MichaReiser on 2023-08-27 16:45_

Current dependencies on/for this PR:
* main
  * **PR #6920** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6920" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6920?utm_source=stack-comment).

---

_Label `internal` added by @MichaReiser on 2023-08-27 16:49_

---

_@MichaReiser reviewed on 2023-08-27 16:55_

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/flake8_import_conventions/mod.rs`:38 on 2023-08-27 16:55_

Use settings instead of options

---

_@MichaReiser reviewed on 2023-08-27 16:57_

---

_Review comment by @MichaReiser on `crates/ruff_wasm/src/lib.rs`:158 on 2023-08-27 16:57_

@charliermarsh is this the same? Not using `From<Settings> for Options` here allows us to remove a ton of code (and going from settings to options is rather odd)

---

_Review requested from @charliermarsh by @MichaReiser on 2023-08-27 16:58_

---

_Comment by @github-actions[bot] on 2023-08-27 17:12_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Review comment by @charliermarsh on `crates/flake8_to_ruff/src/main.rs`:2 on 2023-08-27 18:56_

Nit: trailing thing

---

_Review comment by @charliermarsh on `crates/ruff/src/packaging.rs`:49 on 2023-08-27 18:57_

Why did the above two functions stick around? Can we move them too?

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/flake8_import_conventions/mod.rs`:38 on 2023-08-27 18:57_

Much better.

---

_Review comment by @charliermarsh on `crates/ruff_wasm/src/lib.rs`:158 on 2023-08-27 19:02_

Hmm... I _think_ this change will have the effect that all of these settings will be hidden in the Settings pane by default, rather than showing their defaults (since they will default to `None` rather than `Some(pyupgrade::settings::Options::default())`).

---

_Review comment by @charliermarsh on `crates/ruff_wasm/src/lib.rs`:158 on 2023-08-27 19:02_

I did not verify this myself, and that might be worth it anyway to be honest.

---

_@charliermarsh approved on 2023-08-27 19:02_

---

_Review comment by @MichaReiser on `crates/ruff_wasm/src/lib.rs`:158 on 2023-08-28 06:05_

I cleared my local storage and ran the playground locally. It is giving me the same configuration as on production

---

_@MichaReiser reviewed on 2023-08-28 06:05_

---

_@MichaReiser reviewed on 2023-08-28 06:07_

---

_Review comment by @MichaReiser on `crates/ruff/src/packaging.rs`:49 on 2023-08-28 06:07_

`detect_package_root` is used by `test_path`... I didn't find a way to remove it easily. 

---

_Merged by @MichaReiser on 2023-08-28 06:21_

---

_Closed by @MichaReiser on 2023-08-28 06:21_

---

_Branch deleted on 2023-08-28 06:21_

---
