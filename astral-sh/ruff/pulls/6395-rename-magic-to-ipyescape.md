```yaml
number: 6395
title: "Rename `Magic*` to `IpyEscape*`"
type: pull_request
state: merged
author: dhruvmanila
labels:
  - internal
assignees: []
merged: true
base: main
head: dhruv/ipython-magics-rename
created_at: 2023-08-07T16:10:53Z
updated_at: 2023-08-09T13:45:06Z
url: https://github.com/astral-sh/ruff/pull/6395
synced_at: 2026-01-12T15:55:21Z
```

# Rename `Magic*` to `IpyEscape*`

---

_@dhruvmanila_

## Summary

This PR renames the `MagicCommand` token to `IpyEscapeCommand` token and `MagicKind` to `IpyEscapeKind` type to better reflect the purpose of the token and type. Similarly, it renames the AST nodes from `LineMagic` to `IpyEscapeCommand` prefixed with `Stmt`/`Expr` wherever necessary.

It also makes renames from using `jupyter_magic` to `ipython_escape_commands` in various function names.

The mode value is still `Mode::Jupyter` because the escape commands are part of the IPython syntax but the lexing/parsing is done for a Jupyter notebook.

### Motivation behind the rename:
* IPython codebase defines it as "EscapeCommand" / "Escape Sequences":
    * Escape Sequences: https://github.com/ipython/ipython/blob/292e3a23459ca965b8c1bfe2c3707044c510209a/IPython/core/inputtransformer2.py#L329-L333
    * Escape command: https://github.com/ipython/ipython/blob/292e3a23459ca965b8c1bfe2c3707044c510209a/IPython/core/inputtransformer2.py#L410-L411
* The word "magic" is used mainly for the actual magic commands i.e., the ones starting with `%`/`%%` (https://ipython.readthedocs.io/en/stable/interactive/reference.html#magic-command-system). So, this avoids any confusion between the Magic token (`%`, `%%`) and the escape command itself.
## Test Plan

* `cargo test` to make sure all renames are done correctly.
* `grep` for `jupyter_escape`/`magic` to make sure all renames are done correctly.


---

_Comment by @dhruvmanila on 2023-08-07 16:11_

Current dependencies on/for this PR:
* main
  * **PR #6395** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6395" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6395?utm_source=stack-comment).

---

_Comment by @github-actions[bot] on 2023-08-07 16:35_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01      8.4Â±0.17ms     4.9 MB/sec    1.00      8.2Â±0.04ms     4.9 MB/sec
formatter/numpy/ctypeslib.py               1.01  1679.0Â±54.62Âµs     9.9 MB/sec    1.00  1656.7Â±52.19Âµs    10.1 MB/sec
formatter/numpy/globals.py                 1.01    187.4Â±7.11Âµs    15.7 MB/sec    1.00    185.5Â±5.65Âµs    15.9 MB/sec
formatter/pydantic/types.py                1.00      3.5Â±0.11ms     7.2 MB/sec    1.00      3.5Â±0.10ms     7.2 MB/sec
linter/all-rules/large/dataset.py          1.00     10.3Â±0.09ms     4.0 MB/sec    1.00     10.3Â±0.06ms     4.0 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      2.7Â±0.02ms     6.1 MB/sec    1.00      2.7Â±0.01ms     6.1 MB/sec
linter/all-rules/numpy/globals.py          1.00    387.0Â±2.75Âµs     7.6 MB/sec    1.00    386.0Â±1.85Âµs     7.6 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.4Â±0.04ms     4.7 MB/sec    1.00      5.4Â±0.06ms     4.7 MB/sec
linter/default-rules/large/dataset.py      1.00      5.3Â±0.02ms     7.7 MB/sec    1.00      5.3Â±0.02ms     7.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01   1155.2Â±8.11Âµs    14.4 MB/sec    1.00   1143.4Â±8.02Âµs    14.6 MB/sec
linter/default-rules/numpy/globals.py      1.02    134.8Â±4.93Âµs    21.9 MB/sec    1.00    132.7Â±3.98Âµs    22.2 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.4Â±0.03ms    10.6 MB/sec    1.00      2.4Â±0.01ms    10.6 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     12.0Â±0.30ms     3.4 MB/sec    1.03     12.3Â±0.28ms     3.3 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.3Â±0.07ms     7.4 MB/sec    1.04      2.4Â±0.08ms     7.1 MB/sec
formatter/numpy/globals.py                 1.00   258.9Â±12.15Âµs    11.4 MB/sec    1.02   264.3Â±21.92Âµs    11.2 MB/sec
formatter/pydantic/types.py                1.00      5.1Â±0.15ms     5.0 MB/sec    1.02      5.2Â±0.17ms     4.9 MB/sec
linter/all-rules/large/dataset.py          1.02     15.3Â±0.36ms     2.7 MB/sec    1.00     15.1Â±0.31ms     2.7 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.02      4.2Â±0.14ms     3.9 MB/sec    1.00      4.2Â±0.09ms     4.0 MB/sec
linter/all-rules/numpy/globals.py          1.00   517.2Â±18.56Âµs     5.7 MB/sec    1.01   520.1Â±22.17Âµs     5.7 MB/sec
linter/all-rules/pydantic/types.py         1.01      7.9Â±0.19ms     3.2 MB/sec    1.00      7.9Â±0.13ms     3.2 MB/sec
linter/default-rules/large/dataset.py      1.00      8.3Â±0.12ms     4.9 MB/sec    1.00      8.3Â±0.12ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1716.9Â±40.04Âµs     9.7 MB/sec    1.02  1752.6Â±47.05Âµs     9.5 MB/sec
linter/default-rules/numpy/globals.py      1.00    197.0Â±7.68Âµs    15.0 MB/sec    1.03    203.2Â±8.21Âµs    14.5 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.7Â±0.08ms     7.0 MB/sec    1.02      3.7Â±0.07ms     6.9 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Review requested from @MichaReiser by @dhruvmanila on 2023-08-07 17:56_

---

_Review requested from @charliermarsh by @dhruvmanila on 2023-08-07 17:57_

---

_Comment by @MichaReiser on 2023-08-07 20:07_

You mention that the rename is to better reflect the purpose and type. Can you expand on what makes the new name the better choice? 

---

_Comment by @dhruvmanila on 2023-08-08 04:14_

## IPython Escape Commands Terminology

Before we get into the definitions, I'm omitting all of the rules of lexing/parsing because we're only interested in the definition.

* "Magic commands" are special IPython syntax which starts with a token to identify the magic kind followed by the command value itself.
* "Magic kind" are the kind of magic commands which are recognized by the token itself: `%`, `%%`, `!`, `!!`, `?`, `??`, `/`, `;`, and `,`.
* "Help command" (or "Dynamic Object Introspection" as it's called) are the escape commands of the kind `?` and `??`. (`?str.replace`)
* "Help end command" are a subset of "Help command" where the token can be at the end of the line i.e., after the value itself (`str.replace?`). Here's where things get tricky. I'll divide the help end command into two types for better understanding:
    * Strict version: The token is _only_ at the end of the line (`str.replace?`, `str.replace??`)
    * Combined version: Not only either `?` or `??` is at the end of the line but other magic kind tokens are present at the start as well (`%matplotlib?`, `%%timeit?`)
* "Priority" comes into picture for the "Combined version" mentioned above. When there are magic kind tokens on both side of the value, how do we determine the magic kind i.e., which token to choose? The "Help end command" always takes priority over any other token i.e., if there is `?`/`??` at the end then that is used to determine the kind.

### What the syntax would look like?
* `<MagicKind><Command value>` (e.g., `%matplotlib`, `/foo`, `!pwd`, etc.)
* `<Command value><MagicKind ("?" or "??")>` (e.g., `str.replace?`, `math.pi??`, etc.)
* `<MagicKind><Command value><MagicKind ("?" or "??")>` (e.g., `%matplotlib?`, `%%timeit??`, etc.)

### Motivation behind the rename:
* IPython codebase defines it as "EscapeCommand" / "Escape Sequences":
    * Escape Sequences: https://github.com/ipython/ipython/blob/292e3a23459ca965b8c1bfe2c3707044c510209a/IPython/core/inputtransformer2.py#L329-L333
    * Escape command: https://github.com/ipython/ipython/blob/292e3a23459ca965b8c1bfe2c3707044c510209a/IPython/core/inputtransformer2.py#L410-L411
* The word "magic" is used mainly for the actual magic commands i.e., the ones starting with `%`/`%%` (https://ipython.readthedocs.io/en/stable/interactive/reference.html#magic-command-system). So, this avoids any confusion between the Magic token (`%`, `%%`) and the escape command itself.

---

_Comment by @MichaReiser on 2023-08-08 07:53_

Thanks for the explanation. This is very helpful context that I didn't have before. We should preserve this in writing somewhere (maybe as documentation on `EscapeCommand`). 

A few thoughts:

> The word "magic" is used mainly for the actual magic commands i.e., the ones starting with %/%% 

That makes sense now. So only the EscapeKind `%` and `%%` are "magic"

What I liked about the old "Magic" prefix is that it clearly marked them as not being part of the Python spec. Would it make sense to keep a similar prefix. Maybe IpyEscapeCommand and IpyEscapeSequence. Should we use the same prefix for the tokens and ast nodes? 

We did something similar at rome where we prefixed the JS Spec nodes with `Js`, e.g. `JsBinaryExpression`, the type script syntax nodes with `Ts` (`TsTypeAliasDeclaration`), and the jsx nodes with `Jsx` (`JsxTagExpression`)

---

_Comment by @dhruvmanila on 2023-08-08 13:01_

> Thanks for the explanation. This is very helpful context that I didn't have before. We should preserve this in writing somewhere (maybe as documentation on `EscapeCommand`).

Yes, will do so in a separate PR.

> What I liked about the old "Magic" prefix is that it clearly marked them as not being part of the Python spec. Would it make sense to keep a similar prefix. Maybe IpyEscapeCommand and IpyEscapeSequence. Should we use the same prefix for the tokens and ast nodes?

Yes, my "Other ideas" section proposed something similar although a bit verbose. I like the "Ipy" prefix.

So, to summarize:
* `MagicCommand` -> `IpyEscapeCommand`
* `MagicKind` -> `IpyEscapeKind` (I'm leaning towards "Kind" suffix for consistency with `StringKind` although I have no problem with `IpyEscapeSequence`)
* `StmtLineMagic`/`ExprLineMagic` -> `IpyEscapeCommandStatement`/`IpyEscapeCommandExpression` (Is this too verbose?) or `StmtIpyEscapeCommand`/`ExprIpyEscapeCommand` (for consistency with the current naming convention).


---

_Comment by @MichaReiser on 2023-08-08 15:50_

Sounds good to me. 

> StmtLineMagic/ExprLineMagic -> IpyEscapeCommandStatement/IpyEscapeCommandExpression (Is this too verbose?) or StmtIpyEscapeCommand/ExprIpyEscapeCommand (for consistency with the current naming convention).

I prefer the `IpyEscapeCommandStatement` but we may need to go with `StmtIpyEscapeCommand` for consistency (until we rename all nodes)

---

_Renamed from "Rename `Magic*` to `Escape*`" to "Rename `Magic*` to `IpyEscape*`" by @dhruvmanila on 2023-08-09 03:29_

---

_Label `internal` added by @dhruvmanila on 2023-08-09 05:11_

---

_Review comment by @MichaReiser on `crates/ruff_python_ast/src/node.rs`:51 on 2023-08-09 07:21_

Rename the node type

---

_Review comment by @MichaReiser on `crates/ruff_python_ast/src/node.rs`:79 on 2023-08-09 07:21_

Rename the variant name

---

_Review comment by @MichaReiser on `crates/ruff_python_ast/src/comparable.rs`:1168 on 2023-08-09 07:21_

Rename the struct name

---

_@MichaReiser approved on 2023-08-09 07:23_

Looks good. You may want to search for `StmtLineMagic` and `ExprLineMagic` (text) and replace all occurrences with the new names

---

_Comment by @dhruvmanila on 2023-08-09 13:18_

Thanks for noticing the remaining renames! :)

---

_Merged by @dhruvmanila on 2023-08-09 13:28_

---

_Closed by @dhruvmanila on 2023-08-09 13:28_

---

_Branch deleted on 2023-08-09 13:28_

---
