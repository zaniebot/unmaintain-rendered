<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Treat empty intersection as 'object', fix intersection simplification - astral-sh/ruff #13880</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Treat empty intersection as &#x27;object&#x27;, fix intersection simplification</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13880">#13880</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2024-10-22 14:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body">Summary
<ul>
<li>Properly treat the empty intersection as being of type <code>object</code>.</li>
<li>Consequently, change the simplification method to explicitly add <code>Never</code> to the positive side of the intersection when collapsing a type such as <code>int &amp; str</code> to <code>Never</code>, as opposed to just clearing both the positive and the negative side.</li>
<li>Minor code improvement in <code>bindings_ty</code>: use <code>peekable()</code> to check whether the iterator over constraints is empty, instead of handling first and subsequent elements separately.</li>
</ul>
<p>fixes #13870</p>
Test Plan
<ul>
<li>New unit tests for <code>IntersectionBuilder</code> to make sure the empty intersection represents <code>object</code>.</li>
<li>Markdown-based regression test for the original issue in #13870</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-10-22 14:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-10-22 14:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-10-22 14:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-10-22 14:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-10-22 14:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals_nested.md</code>:25 on 2024-10-22 14:23</div>
            <div class="timeline-body"><p>Without the fix in this PR, I would previously get</p>
<pre><code>if x != 1:
    reveal_type(x)  # revealed: Literal[2, 3]
    if x != 2:
        reveal_type(x)  # revealed: ~Literal[2] | Literal[3]
</code></pre>
<p>Note how the bug only shows up if you add more than one constraint.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-10-22 14:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1059 on 2024-10-22 14:27</div>
            <div class="timeline-body"><p>You might be thinking: isn&#x27;t this the exact same thing as before? It&#x27;s not though. We now call <code>.build()</code> for every single constraint. Before:</p>
<pre><code>IntersectionBuilder::new(…)
  .add_positive(bindings_ty)
  .add_positive(constraint_1)
  .add_positive(constraint_2)
  .build();
</code></pre>
<p>After:</p>
<pre><code>IntersectionBuilder::new(…)
  .add_positive(
    IntersectionBuilder::new(…)
      .add_positive(bindings_ty)
      .add_positive(constraint_1)
      .build()
  ).add_positive(constraint_2)
  .build()
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-10-22 14:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2115 on 2024-10-22 14:28</div>
            <div class="timeline-body"><p>This tests more or less the same thing like the Markdown-based test, only in a much more direct way. Let me know if I should remove it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1059 on 2024-10-22 14:36</div>
            <div class="timeline-body"><p>Hmm... I&#x27;m not sure repeatedly calling <code>build()</code> is optimal here. <code>IntersectionBuilder::build()</code> calls <code>InnerIntersectionBuilder::build</code>, and <code>InnerIntersectionBuilder::build</code> has these <code>shrink_to_fit()</code> calls. I think it only makes sense to do those when the intersection is &quot;finished&quot;, rather than every time we add a positive or negative element to the intersection:</p>
<p>https://github.com/astral-sh/ruff/blob/7dbd8f0f8e725d05cc1d15e6ef1c6cc2ed2b2090/crates/red_knot_python_semantic/src/types/builder.rs#L357-L358</p>
<p>What if we moved the simplifications done by <code>build()</code> out into a common method that is called by <code>build</code>, <code>add_positive</code> and <code>add_negative</code>? Would that remove the need to call <code>build()</code> every time we added a new element to the intersection?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-22 14:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-10-22 14:45</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-10-22 16:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:162 on 2024-10-22 16:01</div>
            <div class="timeline-body"><p>This is just an unrelated code improvement. No functional change. Let me know if you prefer the old version.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-10-22 16:02</div>
            <div class="timeline-body"><p>Code changes in the updated version look great, thank you! Can you update the PR description (and thus also the merged commit message) to reflect the updated direction? Then feel free to merge.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-22 16:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:162 on 2024-10-22 16:03</div>
            <div class="timeline-body"><p>I think the new version is nicer, thank you. Don&#x27;t know if there is any performance difference, but I&#x27;m comfortable leaving that question to experimentation if/when this code is identified as a hot spot in profiling.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[red-knot] Constrained types using proper intersections&quot; to &quot;[red-knot] Treat empty intersection as &#x27;object&#x27;, fix intersection simplification&quot; by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-10-22 19:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-10-22 19:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-10-22 19:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-10-22 19:02</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:07:42 UTC
    </footer>
</body>
</html>
