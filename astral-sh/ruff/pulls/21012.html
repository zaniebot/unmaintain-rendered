<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Teach the resolver that vendored copies of typeshed in the ty cache are in fact typeshed - astral-sh/ruff #21012</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Teach the resolver that vendored copies of typeshed in the ty cache are in fact typeshed</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21012">#21012</a>
        opened by <a href="https://github.com/Gankra">@Gankra</a>
        on 2025-10-21 04:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a></div>
            <div class="timeline-body"><p>Fixes https://github.com/astral-sh/ty/issues/1054</p>
<p>I've confirmed it works on my machine in vscode, but it's not clear to me if there's a good way to test this in our test suite.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @Gankra on 2025-10-21 04:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @Gankra on 2025-10-21 04:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @Gankra on 2025-10-21 04:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @Gankra on 2025-10-21 04:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @Gankra on 2025-10-21 04:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @Gankra on 2025-10-21 04:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @Gankra on 2025-10-21 04:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-10-21 04:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/src/module_resolver/path.rs</code>:751 on 2025-10-21 04:11</div>
            <div class="timeline-body"><p>We invoke these <em>a lot</em> now, so they might need to be cached...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-21 04:13</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-21 04:14</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/module_resolver/path.rs</code>:737 on 2025-10-21 06:19</div>
            <div class="timeline-body"><p>Hmm. I'd prefer if we can keep this logic in <code>ty_server</code>, if possible because not all clients have a cache location or they use a different cache location (e.g. playground)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-21 06:23</div>
            <div class="timeline-body"><p>Could we achive the same if the LSP registered an additional search path for the cached vendored files (that comes after the standard library?) That would require less custom casing for which we have not tests for.</p>
<p>Another alternative would be to remap cached vendored file path to  the corresponding vendored path within the LSP request handlers.</p>
<p>Could any of those solution lead to problems if the content of the cached vendored file and the vendored file diverge (e.g. because the user starts to make edits?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Teach the resolver that vendored copies of typeshed in the ty cache are in fact typeshed" to "[ty] Teach the resolver that vendored copies of typeshed in the ty cache are in fact typeshed" by @AlexWaygood on 2025-10-21 06:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-10-21 13:53</div>
            <div class="timeline-body"><blockquote>
<p>Could we achive the same if the LSP registered an additional search path for the cached vendored files (that comes after the standard library?) That would require less custom casing for which we have not tests for.</p>
</blockquote>
<p>The additional search-path still requires something like <code>path_is_equivalent</code> logic to not get rejected on the <code>file.path() == module.file().path()</code> logic. I'd also be worried that &quot;the stdlib can't be shadowed&quot; rules might get in the way? But probably it would do the right thing for this code specifically so maybe it's fine?</p>
<blockquote>
<p>Another alternative would be to remap cached vendored file path to the corresponding vendored path within the LSP request handlers.</p>
</blockquote>
<p>Hmm that was concerning to me as an approach earlier but maybe it's not actually that bad? We already do that mapping in the other direction. I'll give it a try.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Gankra on 2025-10-21 17:57</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:16:37 UTC
    </footer>
</body>
</html>
