<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add support for using uv as an alternative formatter backend - astral-sh/ruff #19665</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add support for using uv as an alternative formatter backend</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19665">#19665</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2025-07-31 17:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-31 17:45</div>
            <div class="timeline-body"><p>This adds a new <code>backend: internal | uv</code> option to the LSP <code>FormatOptions</code> allowing users to perform document and range formatting operations though uv. The idea here is to prototype a solution for users to transition to a <code>uv format</code> command without encountering version mismatches (and consequently, formatting differences) between the LSP's version of <code>ruff</code> and uv's version of <code>ruff</code>.</p>
<p>The primarily alternative to this would be to use uv to discover the <code>ruff</code> version used to start the LSP in the first place. However, this would increase the scope of a minimal <code>uv format</code> command beyond &quot;run a formatter&quot;, and raise larger questions about how uv should be used to coordinate toolchain discovery. I think those are good things to explore, but I'm hesitant to let them block a <code>uv format</code> implementation. Another downside of using uv to discover <code>ruff</code>, is that it needs to be implemented <em>outside</em> the LSP; e.g., we'd need to change the instructions on how to run the LSP and implement it in each editor integration, like the VS Code plugin.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-31 18:10</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-01 15:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/format.rs</code>:277 on 2025-08-01 15:59</div>
            <div class="timeline-body"><p>We should probalby show a message to the user if that happens see <code>Client</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-08-01 16:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_server/src/format.rs</code>:277 on 2025-08-01 16:09</div>
            <div class="timeline-body"><p>Can we differentiate between failures due to syntax errors in an easy way?</p>
<p>Will look at the <code>Client</code> for sending the message. Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-08-01 17:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_server/src/format.rs</code>:277 on 2025-08-01 17:20</div>
            <div class="timeline-body"><p>See https://github.com/astral-sh/ruff/pull/19665/commits/d23af97c3946e9e74a727fde26ed6381a0393670</p>
<p>My understanding is this will propagate upstream as the <code>format_internal</code> errors do. We could show a message directly to the user with more context, but I think we can defer that for now?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-22 19:26</div>
            <div class="timeline-body"><p>@dhruvmanila would you mind helping me ship this? I'm not sure what all needs to happen :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @zanieb on 2025-08-22 19:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-08-25 08:35</div>
            <div class="timeline-body"><blockquote>
<p>would you mind helping me ship this? I'm not sure what all needs to happen :)</p>
</blockquote>
<p>Sure! I'll look into this in a bit</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-25 12:23</div>
            <div class="timeline-body"><p>I'll look into the test failures.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/format.rs</code>:182 on 2025-08-25 12:37</div>
            <div class="timeline-body"><p>Should this use <code>self.options.line_width()</code> and<code> self.options.indent_width()</code> instead?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/format.rs</code>:201 on 2025-08-25 12:40</div>
            <div class="timeline-body"><p>Same as above, <code>self.options.indent_style()</code> ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/format.rs</code>:212 on 2025-08-25 12:44</div>
            <div class="timeline-body"><p>I'm a bit surprised that this works, is this equivalent to <code>--config format.quote-style = 'single'</code> (notice there are no quotes to the <code>--config</code> value):</p>
<pre><code class="language-console">$ ruff format --config format.quote-style = 'single' --diff isolated.py               
error: invalid value 'format.quote-style' for '--config &lt;CONFIG_OPTION&gt;'

  tip: A `--config` flag must either be a path to a `.toml` configuration file
       or a TOML `&lt;KEY&gt; = &lt;VALUE&gt;` pair overriding a specific configuration
       option

For more information, try '--help'.
</code></pre>
<p>I think the entire value would need to be quoted, so the following should work:</p>
<pre><code class="language-console">$ ruff format --config &quot;format.quote-style = 'single'&quot; --diff isolated.py
</code></pre>
<p>Same goes for other <code>--config</code> flags.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/format.rs</code>:170 on 2025-08-25 12:50</div>
            <div class="timeline-body"><p>This will always use the <code>uv</code> command that comes the earliest on PATH as seen from within the editor. Do you see any issues that could occur when doing so?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/format.rs</code>:171 on 2025-08-25 12:50</div>
            <div class="timeline-body"><p>Yeah, we'd also need to provide a better error message when the <code>uv</code> command itself isn't available.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/format.rs</code>:139 on 2025-08-25 12:53</div>
            <div class="timeline-body"><p>Returning <code>Result</code> type here would mean that any errors resulted would be counted as internal server error and will be shown to the user. I think this is fine for now, but we might want to categorize a subset of them with better error message for example the TODO comment to check whether the subcommand is available or not.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/session/options.rs</code>:291 on 2025-08-25 13:09</div>
            <div class="timeline-body"><p>Including it directly in the <code>format</code> table might indicate that this is a stable option, I think there are two ways to communicate the experimental nature of this feature:</p>
<ol>
<li>Make it explicit in the documentation</li>
<li>Include it under <code>experimental.format.backend</code> similar to ty's <code>experimental</code> namespace (https://docs.astral.sh/ty/reference/editor-settings/#experimental)</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-08-25 13:13</div>
            <div class="timeline-body"><p>Thanks!</p>
<p>I read the corresponding Notion document for this in which you've mentioned:</p>
<blockquote>
<p>Micha and I talked quite a bit offline about the IDE experience, and there are a couple possible approaches that we can take to alleviate those problems.</p>
</blockquote>
<p>~Is there any mention of other approaches apart from the one that's implemented in this PR?~ Nevermind, I see it in the PR description.</p>
<p>There are couple of follow-ups that would need to be done:</p>
<ol>
<li>Updating the documentation to include the new option, this needs to be done manually for editor settings</li>
<li>Updating the VS Code extension to expose this option in VS Code settings and pass it to the server</li>
</ol>
<p>Can you confirm whether this was tested in the editor? If so, which editor did you test this with, I can try it out in some other editor.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-08-25 13:19</div>
            <div class="timeline-body"><blockquote>
<p>The primarily alternative to this would be to use uv to discover the <code>ruff</code> version used to start the LSP in the first place. However, this would increase the scope of a minimal <code>uv format</code> command beyond &quot;run a formatter&quot;, and raise larger questions about how uv should be used to coordinate toolchain discovery. I think those are good things to explore, but I'm hesitant to let them block a <code>uv format</code> implementation. Another downside of using uv to discover <code>ruff</code>, is that it needs to be implemented <em>outside</em> the LSP; e.g., we'd need to change the instructions on how to run the LSP and implement it in each editor integration, like the VS Code plugin.</p>
</blockquote>
<p>Does this mean something like <code>uv server</code> ?</p>
<p>Yeah, I think I'd be a bit hesitant to make the change as described here mainly because we only control the client side implementation for VS Code while for other editors we'd need to explicitly specify on how to start the server and what does it mean to start it from <code>uv</code> vs <code>ruff</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-08-26 13:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_server/src/format.rs</code>:182 on 2025-08-26 13:18</div>
            <div class="timeline-body"><p>Yep, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-08-26 13:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_server/src/format.rs</code>:212 on 2025-08-26 13:20</div>
            <div class="timeline-body"><p>When using <code>Command::arg</code> the outer quotes (<code>&quot;</code>) are implicit. Those outer quotes are being parsed by your shell into a single argument. I think providing them here would actually break things, as they'd be included in the value.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-08-26 13:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_server/src/format.rs</code>:170 on 2025-08-26 13:21</div>
            <div class="timeline-body"><p>Yes. It could be the wrong version.</p>
<p>I don't think I expect multiple uv versions to be available on people's machines — and when it happens it's usually an accident. We can provide a way to set the uv path in the future though. We'll want it for other things.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-08-26 13:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_server/src/format.rs</code>:171 on 2025-08-26 13:21</div>
            <div class="timeline-body"><p>What were you thinking for that case?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-08-26 13:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_server/src/format.rs</code>:139 on 2025-08-26 13:22</div>
            <div class="timeline-body"><p>That makes sense, thanks for clarifying!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-08-26 13:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_server/src/session/options.rs</code>:291 on 2025-08-26 13:22</div>
            <div class="timeline-body"><p>I don't have strong feelings. (2) seems nice but is weird to transition off of?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-26 13:23</div>
            <div class="timeline-body"><blockquote>
<p>Does this mean something like uv server ?</p>
</blockquote>
<p>Yeah, basically.</p>
<blockquote>
<p>... while for other editors we'd need to explicitly specify on how to start the server and what does it mean to start it from uv vs ruff.</p>
</blockquote>
<p>Yeah, this was the same concern Micha and I had.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-26 13:24</div>
            <div class="timeline-body"><p>The test failures on Windows are due to concurrent-installs being unsafe in uv. I'll fix that upstream.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-08-26 14:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/format.rs</code>:212 on 2025-08-26 14:59</div>
            <div class="timeline-body"><p>Ah I see, thanks for clarifying</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-08-26 15:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/format.rs</code>:171 on 2025-08-26 15:01</div>
            <div class="timeline-body"><p>Like, what the error message would be?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-08-26 15:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/format.rs</code>:170 on 2025-08-26 15:11</div>
            <div class="timeline-body"><p>Yeah, that makes sense</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-08-26 15:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/session/options.rs</code>:291 on 2025-08-26 15:14</div>
            <div class="timeline-body"><p>Thinking about this more, I think the current structure is fine (including it in the existing <code>format</code> namespace).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-08-26 16:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_server/src/format.rs</code>:171 on 2025-08-26 16:23</div>
            <div class="timeline-body"><p>Yeah, but I just made a small improvement here for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by @dhruvmanila on 2025-09-08 05:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @dhruvmanila on 2025-09-08 05:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-09-09 15:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2025-09-09 15:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2025-09-09 15:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-09-09 15:09</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:46:47 UTC
    </footer>
</body>
</html>
