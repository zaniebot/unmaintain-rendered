<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Specialize `str.startswith` for string literals - astral-sh/ruff #17351</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Specialize <code>str.startswith</code> for string literals</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17351">#17351</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-04-11 13:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Infer precise Boolean literal types for <code>str.startswith</code> calls where the instance and the prefix are both string literals. This allows us to understand <code>sys.platform.startswith(…)</code> branches.</p>
<h2>Test Plan</h2>
<p>New Markdown tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @sharkdp on 2025-04-11 13:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-11 13:14</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">pyinstrument (https://github.com/joerick/pyinstrument)
- warning[lint:possibly-unresolved-reference] /tmp/mypy_primer/projects/pyinstrument/pyinstrument/vendor/appdirs.py:99:33: Name `_get_win_folder` used when possibly not defined
- warning[lint:possibly-unresolved-reference] /tmp/mypy_primer/projects/pyinstrument/pyinstrument/vendor/appdirs.py:152:33: Name `_get_win_folder` used when possibly not defined
- warning[lint:possibly-unresolved-reference] /tmp/mypy_primer/projects/pyinstrument/pyinstrument/vendor/appdirs.py:319:33: Name `_get_win_folder` used when possibly not defined
- error[lint:unresolved-import] /tmp/mypy_primer/projects/pyinstrument/pyinstrument/vendor/appdirs.py:559:28: Module `ctypes` has no member `windll`
- error[lint:unresolved-import] /tmp/mypy_primer/projects/pyinstrument/pyinstrument/vendor/appdirs.py:562:20: Cannot resolve import `com.sun.jna`
+ warning[lint:unresolved-reference] /tmp/mypy_primer/projects/pyinstrument/pyinstrument/vendor/appdirs.py:99:33: Name `_get_win_folder` used when not defined
+ warning[lint:unresolved-reference] /tmp/mypy_primer/projects/pyinstrument/pyinstrument/vendor/appdirs.py:152:33: Name `_get_win_folder` used when not defined
+ warning[lint:unresolved-reference] /tmp/mypy_primer/projects/pyinstrument/pyinstrument/vendor/appdirs.py:319:33: Name `_get_win_folder` used when not defined
- Found 292 diagnostics
+ Found 290 diagnostics

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-11 13:24</div>
            <div class="timeline-body"><p>The pyinstrument changes show that we now understand the <a href="https://github.com/joerick/pyinstrument/blob/main/pyinstrument/vendor/appdirs.py#L46"><code>sys.platform.startswith('java')</code></a> branch in that file. We still report some diagnostics, because the reachable <code>else</code> branch <a href="https://github.com/joerick/pyinstrument/blob/99fab9d9e3d13c7c913c1db5607f7bb1a3ead94b/pyinstrument/vendor/appdirs.py#L59">sets <code>system = sys.platform</code></a> and then uses <em>that</em> symbol inside nested scopes for <a href="https://github.com/joerick/pyinstrument/blob/99fab9d9e3d13c7c913c1db5607f7bb1a3ead94b/pyinstrument/vendor/appdirs.py#L95">further platform checks</a>. We still emit errors in those branches, because the public type of <code>system</code> is <code>Literal[&quot;linux&quot;] | Unknown</code>, so we don't infer those platform check branches as unreachable.</p>
<p>So I think those diagnostics are true positives according to our model, where <code>system</code> could be reassigned (not that we would understand that yet, but we would require that symbol to be qualified with <code>Final</code>).</p>
<p>Two false positives further down in the file are now gone, because they use <code>system</code> for platform checks inside the scope it was defined in.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @sharkdp on 2025-04-11 13:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2025-04-11 13:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2025-04-11 13:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @sharkdp on 2025-04-11 13:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-11 13:40</div>
            <div class="timeline-body"><p>It might be confusing for users if we infer precise types for <code>str.startswith</code> but not <code>str.endswith</code> — should we do that method too?</p>
<p>Overall I'm okay with this, but note that this goes beyond what the spec requires of us when it comes to understanding <code>sys.platform</code> branches</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @sharkdp on 2025-04-11 13:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @sharkdp on 2025-04-11 13:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-11 13:59</div>
            <div class="timeline-body"><blockquote>
<p>It might be confusing for users if we infer precise types for <code>str.startswith</code> but not <code>str.endswith</code> — should we do that method too?</p>
</blockquote>
<p>It's going to be extremely rare that someone actually calls <code>x.startswith(y)</code> where both <code>x</code> and <code>y</code> are string literal types. I don't think that we have to worry about similarly precise <code>endswith</code> inference being a required feature for anyone.</p>
<blockquote>
<p>Overall I'm okay with this, but note that this goes beyond what the spec requires of us when it comes to understanding <code>sys.platform</code> branches</p>
</blockquote>
<blockquote>
<p>Overall I'm okay with this, but note that this goes beyond what the spec requires of us when it comes to understanding <code>sys.platform</code> branches</p>
</blockquote>
<p>Yes, but <a href="https://typing.python.org/en/latest/spec/directives.html#version-and-platform-checking">the spec is vague</a>. And there is <a href="https://github.com/python/typing/issues/1732">this issue</a> which aims to improve the spec. It includes this comment:</p>
<blockquote>
<p>Maybe it would also make sense to support platform checks using startswith(), as that is officially recommended <a href="https://docs.python.org/3/library/sys.html#sys.platform">in the Python docs</a>, and is required to properly support some Unix variants, like FreeBSD, that include the version number in the platform string. See also https://github.com/python/typeshed/pull/11876.</p>
</blockquote>
<p>And this comment:</p>
<blockquote>
<p>mypy has actually always supported sys.platform.startswith, since 2016 (in addition to == and !=)</p>
</blockquote>
<p>And this:</p>
<blockquote>
<p>sys.platform.startswith probably makes sense to add since it helps FreeBSD (a Tier 3 platform), is already supported by mypy, and doesn't seem difficult to add to other type checkers.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:6191 on 2025-04-11 14:03</div>
            <div class="timeline-body"><p>Maybe add a comment saying why we special-case this method specifically?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Type inference for str.startswith" to "[red-knot] Specialize `str.startswith` for string literals" by @sharkdp on 2025-04-11 14:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-04-11 14:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2025-04-11 14:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-04-11 14:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-11 14:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:3135 on 2025-04-11 14:27</div>
            <div class="timeline-body"><p>does it cause false positives if you use <code>SupportsIndex</code> here? I thought this branch meant we already avoided false positives for nearly all uses of <code>SupportsIndex</code>:</p>
<p>https://github.com/astral-sh/ruff/blob/ffef71d1067aa6d185bc177b502ff9dc4c906260/crates/red_knot_python_semantic/src/types.rs#L1226-L1243</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-04-11 14:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:3135 on 2025-04-11 18:30</div>
            <div class="timeline-body"><p>You're right. For some reason I didn't realized I could just do <code>KnownClass::SupportsIndex.to_instance(db)</code> =&gt; https://github.com/astral-sh/ruff/pull/17362</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-04-11 18:30</div>
            <div class="timeline-body"></div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:11:30 UTC
    </footer>
</body>
</html>
