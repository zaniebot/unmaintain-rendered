<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hug closing `}` when f-string expression has a  format specifier - astral-sh/ruff #18704</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Hug closing <code>}</code> when f-string expression has a  format specifier</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18704">#18704</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-06-16 09:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR changes how we format f-string expressions with a format specifier.</p>
<p>Before:</p>
<ul>
<li>triple-quoted f- or t-strings with a format specifier were always formatted onto a single line</li>
<li>single-quoted f- or t-strings could break over multiple lines even when they had format specifiers. The format specifier was separated by a newline + indent from the closing <code>}</code>. This is now invalid syntax under Python 3.13.4.<pre><code class="language-py">f&quot;testeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee{
    a:.3f
}moreeeeeeeeeeeeeeeeeetest&quot;  
</code></pre>
</li>
</ul>
<p>This PR changes two address the invalid syntax and make single and triple quoted strings more consisent:</p>
<ul>
<li><p>f- or t-string elements with a format specifier now hug the closing <code>}</code>. This ensures that the formatter doesn't introduce a now invalid line break after the format specifier.</p>
<pre><code class="language-py">f&quot;testeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee{
    a:.3f}moreeeeeeeeeeeeeeeeeetest&quot;  
</code></pre>
</li>
<li><p>Remove the restriction that triple-quoted f- or t-strings can't use the multiline layout if they have a format specifier. This isn't required to fix the invalid syntax BUT it fixes an issue where the formatter requires two passes to correctly format comments nested inside an interpolated format specifier:</p>
<pre><code class="language-py">f&quot;&quot;&quot;{foo
   :a{
     a # more
    # comment
   }
}&quot;&quot;&quot;
</code></pre>
<p>which before this PR gets formatted to:</p>
<pre><code class="language-py">f&quot;&quot;&quot;{foo:a{a}
}&quot;&quot;&quot;  # more
    # comment
</code></pre>
<p>which is fairly different from the source. I think making this change should be fine, if this PR makes it into the minor release tomorrow.</p>
</li>
</ul>
<p>I considered if we should always keep elements with a format specifier flat. However, this gets very tricky if the format specifier is already formatted over multiple lines and contains comments (see the triple-quoted case above). That's why I opted to allow them and making the behavior consistent between single and triple quoted strings.</p>
<p>Fixes https://github.com/astral-sh/ruff/issues/18672
Fixes https://github.com/astral-sh/ruff/issues/18632</p>
<p>Note, this PR doesn't change the parser / lexer</p>
<h2>Test Plan</h2>
<p>Updated / added tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2025-06-16 09:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2025-06-16 09:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2025-06-16 09:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2025-06-16 09:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-16 09:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/expression/fstring.py</code>:307 on 2025-06-16 09:31</div>
            <div class="timeline-body"><p>This example is a syntax error for a single quoted string, but it's perfectly fine for a triple quoted string</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-16 09:36</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Formatter (stable)</h3>
<p>âœ… ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>âœ… ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Don't use soft_block indent for f-strings with a foramt specifier" to "Don't use soft_block indent for f-strings with a format specifier" by @MichaReiser on 2025-06-16 14:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Don't use soft_block indent for f-strings with a format specifier" to "Hug closing `}` when f-string expression has a  format specifier" by @MichaReiser on 2025-06-16 14:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @MichaReiser on 2025-06-16 14:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2025-06-16 14:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MichaReiser on 2025-06-16 16:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MichaReiser on 2025-06-16 16:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @MichaReiser on 2025-06-16 16:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @MichaReiser on 2025-06-16 16:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dcreager removed by @MichaReiser on 2025-06-16 16:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @MichaReiser on 2025-06-16 16:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @MichaReiser on 2025-06-16 16:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @MichaReiser on 2025-06-16 16:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-16 16:33</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_formatter/src/other/interpolated_string_element.rs</code>:244 on 2025-06-16 16:38</div>
            <div class="timeline-body"><p>Is this empty branch part of the TODO above?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-06-16 16:51</div>
            <div class="timeline-body"><p>This makes sense to me, for what it's worth. It definitely makes sense to wait for Dhruv's review, just wanted to take a quick look too in case it helped.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-16 16:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/other/interpolated_string_element.rs</code>:244 on 2025-06-16 16:53</div>
            <div class="timeline-body"><p>Lol no, that's just me moving stuff around and forgetting to delete it (and clippy not telling me)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-16 17:10</div>
            <div class="timeline-body"><p>@ntBre for the changelog (assuming this makes it in). We could probably write something like this</p>
<p>Ruff now formats multiline f-strings with format-specifiers differently because of a change to CPython's grammar. Before, Ruff formatted the interpolation expression like so:</p>
<pre><code class="language-py">f&quot;This is some long string {
    x:d
} that is formatted across multiple lines&quot;  
</code></pre>
<p>The line break after the <code>:d</code> format specifier is now a syntax error with Python 3.13.4 or newer. That's why Ruff now formats the f-string like so:</p>
<pre><code class="language-py">f&quot;This is some long string {
    x:d} that is formatted across multiple lines&quot;  
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-16 17:38</div>
            <div class="timeline-body"><p>Thanks! I'll add it to the blog post too. There's no real rush on getting the release out from my side, so I think we can wait until this is ready.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "v0.12" by @ntBre on 2025-06-16 17:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/expression/fstring.py</code>:299 on 2025-06-17 03:14</div>
            <div class="timeline-body"><p>I think 21 is already taken by the previous comment, let's choose another number so that it's easier to differentiate.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_formatter/src/other/interpolated_string_element.rs</code>:269 on 2025-06-17 03:45</div>
            <div class="timeline-body"><p>I'm guessing the example mentioned in the comment is specifically to target the <code>format_spec.is_none</code> case and not the trailing comment case. And, as the latter case is going to be removed, we don't really need to provide an example for that here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_formatter/src/other/interpolated_string_element.rs</code>:225 on 2025-06-17 03:46</div>
            <div class="timeline-body"><p>I think this will also be a syntax error with the recent CPython parser changes? So, then this case can never occur then unless maybe it's a triple-quoted string?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-06-17 03:49</div>
            <div class="timeline-body"><p>Looks great! Thank you for the quick fix!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-06-17 03:55</div>
            <div class="timeline-body"><blockquote>
<ul>
<li>Remove the restriction that triple-quoted f- or t-strings can't use the multiline layout if they have a format specifier. This isn't required to fix the invalid syntax BUT it fixes an issue where the formatter requires two passes to correctly format comments nested inside an interpolated format specifier:</li>
</ul>
</blockquote>
<p>Yeah, I think I mainly did this because the newline for a triple-quoted f-string is a newline character in the literal string and not an actual newline, so that didn't account for the fact that the f-string is multiline. For example, the following is not a multiline f-string:</p>
<pre><code class="language-py">aaaaaaaaaaa = f&quot;&quot;&quot;asaaaaaaaaaaaaaaaa {aaaaaaaaaaaa + bbbbbbbbbbbb + ccccccccccccccc + dddddddd:.3f
} cccccccccc&quot;&quot;&quot;
</code></pre>
<p>But, it does create inconsistent behavior between triple-quoted and single-quoted f-string which you've noticed. One might argue that is not really an inconsistent behavior as it does follow what we stated regarding when the expression could be broken down i.e., only when the user already has a multiline f-string.</p>
<p>In reality, I guess this shouldn't affect too many users as newlines in format spec should be rare enough especially now that it's a syntax error. So, I'm fine with this change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-17 05:25</div>
            <div class="timeline-body"><blockquote>
<p>Yeah, I think I mainly did this because the newline for a triple-quoted f-string is a newline character in the literal string and not an actual newline, so that didn't account for the fact that the f-string is multiline. For example, the following is not a multiline f-string:</p>
</blockquote>
<p>I learned this the hard way when working on this PR ðŸ˜…. Thanks for adding tests for it.</p>
<blockquote>
<p>In reality, I guess this should affect too many users as newlines in format spec should be rare enough especially now that it's a syntax error. So, I'm fine with this change.</p>
</blockquote>
<p>Yeah, that was my thinking too and seems to be confirmed by our ecosyste checks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-17 05:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/other/interpolated_string_element.rs</code>:269 on 2025-06-17 05:28</div>
            <div class="timeline-body"><p>The example is for the <code>format_spec.is_some</code> case. It will be removed in my next PR.</p>
<p>I mainly provided it because I found it helpful to reason about all the changes i've been making. I think I keep it, considering that I already have a PR that removes it again.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-17 05:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/other/interpolated_string_element.rs</code>:225 on 2025-06-17 05:30</div>
            <div class="timeline-body"><p>Yes, this is correct. I decided to keep supporting this case for now, so that the formatter doesn't mess it up until we make this a syntax error (which will only be in the next release because I want the formatter to fixup all format spec instances with trailing newlines that have no comments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-17 05:33</div>
            <div class="timeline-body"><p>@ntBre I'll merge this to main, considering that we plan to do the minor release today.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-06-17 05:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-06-17 05:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-17 05:39</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:13:26 UTC
    </footer>
</body>
</html>
