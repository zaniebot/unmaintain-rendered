<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Diagnostic for possibly unbound imports - astral-sh/ruff #14281</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Diagnostic for possibly unbound imports</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14281">#14281</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2024-11-11 14:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This adds a new diagnostic when possibly unbound symbols are imported. The <code>TODO</code> comment had a question mark, do I'm not sure if this is really something that we want.</p>
<p>This does not touch the un<em>declared</em> case, yet.</p>
<p>relates to: #14022</p>
<h2>Test Plan</h2>
<p>Updated already existing tests with new diagnostics</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2024-11-11 14:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @sharkdp on 2024-11-11 14:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2024-11-11 14:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-11 14:56</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-11 14:59</div>
            <div class="timeline-body"><p>This is an understand question from my side. When do we add a <code>possibly-unbound-xy</code> diagnostic because there are many situations where a value can be unbound. Do we want dedicated diagnostics for members (subscript), imports, variables? What about context managers, patterns, etc or should we rather have a single diagnostic code for all of them?</p>
<p>This discussion is entirely unrelated to this PR and shouldn't prevent it from landing. It's also something we can revisit later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2024-11-11 15:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/issubclass.md</code>:107 on 2024-11-11 16:01</div>
            <div class="timeline-body"><p>It'll actually get worse when we understand <code>sys.version_info</code> branches, because <code>types.NoneType</code> only exists on Python 3.10+, and our default Python version is 3.8, which means when we understand <code>sys.version_info</code> branches we'll infer <code>types.NoneType</code> as always-unbound with the default target version rather than possibly-unbound.</p>
<p>The solution here is really to add a feature to <code>mdtest</code> so that we can set <code>--target-version</code> to Python 3.10 or higher in this test snippet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2017 on 2024-11-11 16:59</div>
            <div class="timeline-body"><p>I'd go for a slightly shorter error message here</p>
<pre><code class="language-suggestion">                                    format_args!(&quot;Member `{name}` of module `{module_name}` is possibly unbound&quot;),
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-11-11 17:02</div>
            <div class="timeline-body"><p>I agree with adding a diagnostic for this. &quot;The member might be unbound&quot; <em>does</em> feel to me like a distinct thing to &quot;the module just doesn't have this member&quot;, so I guess I agree with this being a separate error code... but I also absolutely see @MichaReiser's point about this leading to the number of error codes exploding a bit :/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-11-11 17:58</div>
            <div class="timeline-body"><blockquote>
<p>&quot;The member might be unbound&quot; <em>does</em> feel to me like a distinct thing to &quot;the module just doesn't have this member&quot;, so I guess I agree with this being a separate error code... but I also absolutely see @MichaReiser's point about this leading to the number of error codes exploding a bit :/</p>
</blockquote>
<p>I understood something different from Micha's question. I didn't understand it to be about <code>unbound-x</code> vs <code>possibly-unbound-x</code> (I think these must be different error codes, and 2x for unbound error codes is a manageable level of &quot;explosion&quot;), but rather about how finely we divide the many different possible <code>x</code>. With this PR, we now have <code>unresolved-reference</code> and <code>possibly-unbound-reference</code> and now <code>unresolved-import</code> and <code>possibly-unbound-import</code>.</p>
<p>I think this is an area where it's worth looking at what other type checkers do. I lean towards separate error codes, and my understanding from mypy is that users seem to demand rather finely-grained error codes. It's also not clear to me what is the concrete <em>cost</em> of finer-grained error codes. It clearly provides more functionality, and the cost of &quot;longer reference docs&quot;, while real, doesn't seem to outweigh the user flexibility.</p>
<p>Imports are different in that an unbound-import error may often come from code you don't control. I think another useful guide may be &quot;which things raise different errors at runtime&quot;, which would suggest separate codes: unbound name references, nonexistent attributes, missing imports, and missing mapping keys all raise different exception types at runtime.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-11-11 17:59</div>
            <div class="timeline-body"><p>Looks great, thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-11 18:25</div>
            <div class="timeline-body"><blockquote>
<p>I think this is an area where it's worth looking at what other type checkers do. I lean towards separate error codes, and my understanding from mypy is that users seem to demand rather finely-grained error codes. It's also not clear to me what is the concrete cost of finer-grained error codes. It clearly provides more functionality, and the cost of &quot;longer reference docs&quot;, while real, doesn't seem to outweigh the user flexibility.</p>
</blockquote>
<p>The cost here is mainly:</p>
<ul>
<li>Each rule will come with some boilerplate and needs documenting. This is a one off cost but also leads to more code.</li>
<li>Users ideally don't toggle rules at such a fine granular level and instead use e.g. a rule selector. But every rule adds some cognitive overhead (e.g. the list of rules becomes longer and more difficult to search, it's harder for users to find the rules they care about).</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-11 19:17</div>
            <div class="timeline-body"><p>Thanks for the discussion about rule names. I'll leave the fine-grained rule name for now, assuming that we will do a overhaul at some point to enforce consistency across all rules. But let me know if you think something should be changed for this specific rule.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2024-11-11 19:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2024-11-11 19:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-11 19:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:07:39 UTC
    </footer>
</body>
</html>
