<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Use `ParamSpec` without the attr for inferable check - astral-sh/ruff #21934</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Use <code>ParamSpec</code> without the attr for inferable check</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21934">#21934</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2025-12-12 07:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-12-12 07:49</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>fixes: https://github.com/astral-sh/ty/issues/1820</p>
<h2>Test Plan</h2>
<p>Add new mdtests.</p>
<p>Ecosystem changes removes all false positives.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dhruvmanila on 2025-12-12 07:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @dhruvmanila on 2025-12-12 07:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-12 07:51</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-12 07:52</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">pytest-robotframework (https://github.com/detachhead/pytest-robotframework)
+ pytest_robotframework/__init__.py:358:14: warning[unused-ignore-comment] Unused `ty: ignore` directive
- Found 172 diagnostics
+ Found 173 diagnostics

async-utils (https://github.com/mikeshardmind/async-utils)
- src/async_utils/corofunc_cache.py:148:12: error[invalid-return-type] Return type does not match returned value: expected `CoroCacheDeco`, found `def wrapper[**P, R](coro: CoroLike[P@wrapper, R@wrapper], /) -&gt; CoroFunc[P@wrapper, R@wrapper]`
- src/async_utils/corofunc_cache.py:231:12: error[invalid-return-type] Return type does not match returned value: expected `CoroCacheDeco`, found `def wrapper[**P, R](coro: CoroLike[P@wrapper, R@wrapper], /) -&gt; CoroFunc[P@wrapper, R@wrapper]`
- src/async_utils/task_cache.py:213:12: error[invalid-return-type] Return type does not match returned value: expected `TaskCacheDeco`, found `def wrapper[**P, R](coro: TaskCoroFunc[P@wrapper, R@wrapper], /) -&gt; TaskFunc[P@wrapper, R@wrapper]`
- src/async_utils/task_cache.py:301:12: error[invalid-return-type] Return type does not match returned value: expected `TaskCacheDeco`, found `def wrapper[**P, R](coro: TaskCoroFunc[P@wrapper, R@wrapper], /) -&gt; TaskFunc[P@wrapper, R@wrapper]`
- Found 15 diagnostics
+ Found 11 diagnostics

antidote (https://github.com/Finistere/antidote)
- src/antidote/lib/interface_ext/__init__.py:61:24: error[invalid-assignment] Object of type `InterfaceImpl` is not assignable to `Interface`
- src/antidote/lib/lazy_ext/__init__.py:29:14: error[invalid-assignment] Object of type `LazyImpl` is not assignable to `Lazy`
- Found 275 diagnostics
+ Found 273 diagnostics

Expression (https://github.com/cognitedata/Expression)
- expression/effect/async_option.py:122:9: error[invalid-method-override] Invalid override of method `__call__`: Definition is incompatible with `AsyncBuilder.__call__`
- expression/effect/async_result.py:123:9: error[invalid-method-override] Invalid override of method `__call__`: Definition is incompatible with `AsyncBuilder.__call__`
- expression/effect/option.py:98:9: error[invalid-method-override] Invalid override of method `__call__`: Definition is incompatible with `Builder.__call__`
- expression/effect/result.py:89:9: error[invalid-method-override] Invalid override of method `__call__`: Definition is incompatible with `Builder.__call__`
- Found 214 diagnostics
+ Found 210 diagnostics

scikit-build-core (https://github.com/scikit-build/scikit-build-core)
+ src/scikit_build_core/build/wheel.py:98:20: error[no-matching-overload] No overload of bound method `__init__` matches arguments
- Found 41 diagnostics
+ Found 42 diagnostics

pandas (https://github.com/pandas-dev/pandas)
- pandas/core/resample.py:265:9: error[invalid-method-override] Invalid override of method `pipe`: Definition is incompatible with `BaseGroupBy.pipe`
- pandas/core/window/expanding.py:337:9: error[invalid-method-override] Invalid override of method `pipe`: Definition is incompatible with `RollingAndExpandingMixin.pipe`
- pandas/core/window/rolling.py:2266:9: error[invalid-method-override] Invalid override of method `pipe`: Definition is incompatible with `RollingAndExpandingMixin.pipe`
- Found 3717 diagnostics
+ Found 3714 diagnostics


</code></pre>
</details>

<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dhruvmanila on 2025-12-12 08:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dhruvmanila on 2025-12-12 08:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dhruvmanila on 2025-12-12 08:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @dhruvmanila on 2025-12-12 08:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @dhruvmanila on 2025-12-12 08:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types.rs</code>:2193 on 2025-12-13 01:03</div>
            <div class="timeline-body"><p>I find it a bit suspicious that this rule is so much simpler than our existing rules for other typevars, which require six or seven different match clauses to implement. It seems like in principle the rules should be the same, the only difference being that we need to account for stripping the attributes in this case.</p>
<p>Is it possible that this could be instead implemented by just checking the attribute is the same, stripping the attribute, and then delegating to a recursive call to <code>has_relation_to_impl</code> with the base typevars instead of the attributes?</p>
<p>Alternatively, given the restrictions on where ParamSpec attributes can legally appear (only in a callable signature, and only together, applied to <code>*args</code> and <code>**kwargs</code>), I wonder if this wouldn't be easier/simpler if we handled it directly in callable-type <code>has_relation_to_impl</code>?</p>
<p>If none of that seems to work easily, I think it'd be OK to land this version (ecosystem impact looks good as far as it goes!), but maybe with an added TODO that this probably isn't fully correct yet?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-12-13 01:03</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-12-15 04:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_python_semantic/src/types.rs</code>:2193 on 2025-12-15 04:55</div>
            <div class="timeline-body"><blockquote>
<p>Is it possible that this could be instead implemented by just checking the attribute is the same, stripping the attribute, and then delegating to a recursive call to <code>has_relation_to_impl</code> with the base typevars instead of the attributes?</p>
</blockquote>
<p>Yeah, I tried this but it fails in this test case that I added in this PR:</p>
<pre><code class="language-py">from typing import Callable

class Container[**P]:
    def method(self, f: Callable[P, None]) -&gt; Callable[P, None]:
        return f

    def try_assign[**Q](self, f: Callable[Q, None]) -&gt; Callable[Q, None]:
        # error: [invalid-return-type] &quot;Return type does not match returned value: expected `(**Q@try_assign) -&gt; None`, found `(**P@Container) -&gt; None`&quot;
        # error: [invalid-argument-type] &quot;Argument to bound method `method` is incorrect: Expected `(**P@Container) -&gt; None`, found `(**Q@try_assign) -&gt; None`&quot;
        return self.method(f)
</code></pre>
<p>where the <code>invalid-argument-type</code> diagnostic is not emitted.</p>
<blockquote>
<p>Alternatively, given the restrictions on where ParamSpec attributes can legally appear (only in a callable signature, and only together, applied to <code>*args</code> and <code>**kwargs</code>), I wonder if this wouldn't be easier/simpler if we handled it directly in callable-type <code>has_relation_to_impl</code>?</p>
</blockquote>
<p>Yeah, I think that makes sense. I'll move this check to the <code>Signature::has_relation_to_inner</code></p>
<p>Some additional context here: https://discord.com/channels/1039017663004942429/1449080092515893316/1449975836055703673</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2025-12-15 05:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2025-12-15 05:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-12-15 05:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-12-15 18:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types.rs</code>:2193 on 2025-12-15 18:09</div>
            <div class="timeline-body"><p>Interesting. I think perhaps this reveals a bug in our handling of non-ParamSpec typevars?</p>
<pre><code class="language-py">class Container[T]:
    def method(self, x: T) -&gt; T:
        return x

    def try_assign[U](self, x: U) -&gt; U:
        return self.method(x)
</code></pre>
<p>https://play.ty.dev/e477cd72-491d-4953-b77a-97ad0d47fd1f</p>
<p>It seems like there should be two diagnostics on the last line there as well (I wouldn't expect <code>U</code> to be assignable to <code>T</code> in the call to <code>self.method</code>), but we only get one (invalid return type).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-12-15 18:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types.rs</code>:2193 on 2025-12-15 18:36</div>
            <div class="timeline-body"><p>Filed https://github.com/astral-sh/ty/issues/1898</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:42:36 UTC
    </footer>
</body>
</html>
