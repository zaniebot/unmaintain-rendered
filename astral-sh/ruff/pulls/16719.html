<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`perflint`] Implement fix for `manual-dict-comprehension` (`PERF403`) - astral-sh/ruff #16719</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>perflint</code>] Implement fix for <code>manual-dict-comprehension</code> (<code>PERF403</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16719">#16719</a>
        opened by <a href="https://github.com/w0nder1ng">@w0nder1ng</a>
        on 2025-03-14 03:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/w0nder1ng">@w0nder1ng</a></div>
            <div class="timeline-body">Summary
<p>This change adds an auto-fix for manual dict comprehensions. It also copies many of the improvements from #13919 (and associated PRs fixing issues with it), and moves some of the utility functions from <code>manual_list_comprehension.rs</code> into a separate <code>helpers.rs</code> to be used in both.</p>
Test Plan
<p>I added a preview test case to showcase the new fix and added a test case in <code>PERF403.py</code> to make sure lines with semicolons function. I didn&#x27;t yet make similar tests to the ones I added earlier to <code>PERF401.py</code>, but the logic is the same, so it might be good to add those to make sure they work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-14 04:10</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+6 -8 violations, +0 -0 fixes in 3 projects; 52 projects unchanged)</p>
<a href="https://github.com/apache/airflow">apache/airflow</a> (+4 -4 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/apache/airflow/blob/d5e8b4b9301f9aef08f56fc12ef46c3cbf40a191/providers/cncf/kubernetes/src/airflow/providers/cncf/kubernetes/executors/kubernetes_executor_utils.py#L141">providers/cncf/kubernetes/src/airflow/providers/cncf/kubernetes/executors/kubernetes_executor_utils.py:141:17:</a> PERF403 Use `dict.update` instead of a for-loop
- <a href="https://github.com/apache/airflow/blob/d5e8b4b9301f9aef08f56fc12ef46c3cbf40a191/providers/cncf/kubernetes/src/airflow/providers/cncf/kubernetes/executors/kubernetes_executor_utils.py#L141">providers/cncf/kubernetes/src/airflow/providers/cncf/kubernetes/executors/kubernetes_executor_utils.py:141:17:</a> PERF403 Use a dictionary comprehension instead of a for-loop
+ <a href="https://github.com/apache/airflow/blob/d5e8b4b9301f9aef08f56fc12ef46c3cbf40a191/providers/exasol/src/airflow/providers/exasol/hooks/exasol.py#L70">providers/exasol/src/airflow/providers/exasol/hooks/exasol.py:70:17:</a> PERF403 Use `dict.update` instead of a for-loop
- <a href="https://github.com/apache/airflow/blob/d5e8b4b9301f9aef08f56fc12ef46c3cbf40a191/providers/exasol/src/airflow/providers/exasol/hooks/exasol.py#L70">providers/exasol/src/airflow/providers/exasol/hooks/exasol.py:70:17:</a> PERF403 Use a dictionary comprehension instead of a for-loop
+ <a href="https://github.com/apache/airflow/blob/d5e8b4b9301f9aef08f56fc12ef46c3cbf40a191/providers/mysql/src/airflow/providers/mysql/hooks/mysql.py#L191">providers/mysql/src/airflow/providers/mysql/hooks/mysql.py:191:17:</a> PERF403 Use `dict.update` instead of a for-loop
- <a href="https://github.com/apache/airflow/blob/d5e8b4b9301f9aef08f56fc12ef46c3cbf40a191/providers/mysql/src/airflow/providers/mysql/hooks/mysql.py#L191">providers/mysql/src/airflow/providers/mysql/hooks/mysql.py:191:17:</a> PERF403 Use a dictionary comprehension instead of a for-loop
+ <a href="https://github.com/apache/airflow/blob/d5e8b4b9301f9aef08f56fc12ef46c3cbf40a191/providers/postgres/src/airflow/providers/postgres/hooks/postgres.py#L171">providers/postgres/src/airflow/providers/postgres/hooks/postgres.py:171:17:</a> PERF403 Use `dict.update` instead of a for-loop
- <a href="https://github.com/apache/airflow/blob/d5e8b4b9301f9aef08f56fc12ef46c3cbf40a191/providers/postgres/src/airflow/providers/postgres/hooks/postgres.py#L171">providers/postgres/src/airflow/providers/postgres/hooks/postgres.py:171:17:</a> PERF403 Use a dictionary comprehension instead of a for-loop
</pre>

</p>

<a href="https://github.com/apache/superset">apache/superset</a> (+2 -2 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/apache/superset/blob/26ff734ef94658f622eef494555863c9f9f68aaa/superset/migrations/versions/2021-04-12_12-38_fc3a3a8ff221_migrate_filter_sets_to_new_format.py#L122">superset/migrations/versions/2021-04-12_12-38_fc3a3a8ff221_migrate_filter_sets_to_new_format.py:122:21:</a> PERF403 Use `dict.update` instead of a for-loop
- <a href="https://github.com/apache/superset/blob/26ff734ef94658f622eef494555863c9f9f68aaa/superset/migrations/versions/2021-04-12_12-38_fc3a3a8ff221_migrate_filter_sets_to_new_format.py#L122">superset/migrations/versions/2021-04-12_12-38_fc3a3a8ff221_migrate_filter_sets_to_new_format.py:122:21:</a> PERF403 Use a dictionary comprehension instead of a for-loop
+ <a href="https://github.com/apache/superset/blob/26ff734ef94658f622eef494555863c9f9f68aaa/superset/migrations/versions/2022-04-01_14-38_a9422eeaae74_new_dataset_models_take_2.py#L795">superset/migrations/versions/2022-04-01_14-38_a9422eeaae74_new_dataset_models_take_2.py:795:21:</a> PERF403 Use `dict.update` instead of a for-loop
- <a href="https://github.com/apache/superset/blob/26ff734ef94658f622eef494555863c9f9f68aaa/superset/migrations/versions/2022-04-01_14-38_a9422eeaae74_new_dataset_models_take_2.py#L795">superset/migrations/versions/2022-04-01_14-38_a9422eeaae74_new_dataset_models_take_2.py:795:21:</a> PERF403 Use a dictionary comprehension instead of a for-loop
</pre>

</p>

<a href="https://github.com/pandas-dev/pandas">pandas-dev/pandas</a> (+0 -2 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
- <a href="https://github.com/pandas-dev/pandas/blob/5fef9793dd23867e7b227a1df7aa60a283f6204e/pandas/tests/arrays/sparse/test_accessor.py#L247">pandas/tests/arrays/sparse/test_accessor.py:247:30:</a> RUF043 Pattern passed to `match=` contains metacharacters but is neither escaped nor raw
- <a href="https://github.com/pandas-dev/pandas/blob/5fef9793dd23867e7b227a1df7aa60a283f6204e/pandas/tests/arrays/sparse/test_accessor.py#L96">pandas/tests/arrays/sparse/test_accessor.py:96:50:</a> RUF043 Pattern passed to `match=` contains metacharacters but is neither escaped nor raw
</pre>

</p>

Changes by rule (2 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PERF403 | 12 | 6 | 6 | 0 | 0 |
| RUF043 | 2 | 0 | 2 | 0 | 0 |</p>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-14 08:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Skylion007">@Skylion007</a> on 2025-03-15 15:36</div>
            <div class="timeline-body"><p>Slight nit: had a situation where it didn&#x27;t simplify an <code>annotated dict = dict()</code> builtin to a single line comprehension. Still kept a sepereate call to the <code>dict()</code> builtin function followed by update. Manually fixed that.</p>
<pre><code>    node_to_step: dict[BaseSchedulerNode, int] = dict()
    for step, node in enumerate(nodes):
        node_to_step[node] = step
</code></pre>
<p>got transformed to</p>
<pre><code>     node_to_step: dict[BaseSchedulerNode, int] = dict()
     node_to_step.update(...)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/w0nder1ng">@w0nder1ng</a> on 2025-03-16 17:33</div>
            <div class="timeline-body"><p>I had forgotten about using a function call to make a dict, since it&#x27;s not typically something I do in my own code. I&#x27;ve now modified the &quot;is empty dict&quot; check to allow builtin function calls for both PERF403 and PERF401.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Skylion007">@Skylion007</a> on 2025-03-17 16:19</div>
            <div class="timeline-body"><p>Title is wrong, it&#x27;s PERF403, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[perflint] implement quick-fix for manual-dict-comprehension (PERF404)&quot; to &quot;[perflint] implement quick-fix for manual-dict-comprehension (PERF403)&quot; by <a href="https://github.com/w0nder1ng">@w0nder1ng</a> on 2025-03-17 16:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/w0nder1ng">@w0nder1ng</a> on 2025-03-23 23:17</div>
            <div class="timeline-body"><p>Do you know why the tests aren&#x27;t running? The test jobs in my fork of the repo are timing out while waiting for a runner.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-03-24 14:25</div>
            <div class="timeline-body"><p>I think the most recent commits came in while CI was disabled. You can try pushing another (possibly empty) commit, or closing and reopening the PR to retrigger CI.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Skylion007">@Skylion007</a> on 2025-04-02 13:54</div>
            <div class="timeline-body"><p>@ntBre CI is run now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-03 20:48</div>
            <div class="timeline-body"><p>Thanks for the ping, I&#x27;ll try to review this tomorrow.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/ntBre">@ntBre</a> by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-03 20:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/perflint/helpers.rs</code>:1 on 2025-04-04 20:34</div>
            <div class="timeline-body"><p>Just confirming: these were moved over from <code>manual_list_comprehension.rs</code> without any changes? (besides converting them to functions) I still looked at them pretty closely, but I didn&#x27;t review them as closely as I would brand-new code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_dict_comprehension.rs</code>:3 on 2025-04-04 20:36</div>
            <div class="timeline-body"><p>nit: I would  merge these two imports:</p>
<pre><code>use crate::rules::perflint::helpers::{comment_strings_in_range, statement_deletion_range};
</code></pre>
<p>and also move the <code>crate</code> imports back down to a separate block like <code>crate::checkers::ast::Checker</code> was before.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_dict_comprehension.rs</code>:5 on 2025-04-04 20:37</div>
            <div class="timeline-body"><pre><code>use ruff_diagnostics::{Diagnostic, Edit, Fix, FixAvailability, Violation};
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_dict_comprehension.rs</code>:11 on 2025-04-04 20:38</div>
            <div class="timeline-body"><p>nit: same as above, merge with the other <code>ruff_python_semantic</code> import.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_dict_comprehension.rs</code>:157 on 2025-04-04 20:49</div>
            <div class="timeline-body"><p>I think this is probably a reasonable <code>expect</code> call, but we might as well just return early if it&#x27;s <code>None</code>, just in case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_dict_comprehension.rs</code>:163 on 2025-04-04 20:50</div>
            <div class="timeline-body"><p>tiny nit: I think <code>other_reference.start() &gt; for_stmt.end()</code> would be slightly more intuitive, like the comment above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_dict_comprehension.rs</code>:190 on 2025-04-04 20:53</div>
            <div class="timeline-body"><p>Is this the same as inside the <code>tuple.iter().any</code> call above? It might be worth factoring out a small helper function here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_dict_comprehension.rs</code>:8 on 2025-04-04 20:55</div>
            <div class="timeline-body"><p>I&#x27;d also like an empty line here before the docs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_dict_comprehension.rs</code>:260 on 2025-04-04 20:59</div>
            <div class="timeline-body"><p>I think you can remove this block:</p>
<pre><code>    let assignment_in_same_statement = binding.source.is_some_and(|binding_source| {
        let for_loop_parent = checker.semantic().current_statement_parent_id();
        let binding_parent = checker.semantic().parent_statement_id(binding_source);
        for_loop_parent == binding_parent
    });
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_dict_comprehension.rs</code>:268 on 2025-04-04 21:01</div>
            <div class="timeline-body"><pre><code>    // If the binding gets used in between the assignment and the for loop, a dict comprehension is no longer safe
</code></pre>
<p>or just <code>comprehension</code> maybe?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_dict_comprehension.rs</code>:281 on 2025-04-04 21:03</div>
            <div class="timeline-body"><p>I thought we already checked the end of the <code>for</code> loop vs any references to the variable above? Maybe I&#x27;m missing something.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_dict_comprehension.rs</code>:301 on 2025-04-04 21:05</div>
            <div class="timeline-body"><p>How hard/intrusive would it be to check this earlier? There&#x27;s a lot of new code above this that would be nice to skip if we&#x27;re not going to use the fix. However, it&#x27;s also nice not to have to change much when stabilizing the rule, so if it&#x27;s more than moving this check up a bit, don&#x27;t worry about it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_dict_comprehension.rs</code>:303 on 2025-04-04 21:07</div>
            <div class="timeline-body"><p>I&#x27;d lean towards passing these as separate <code>key</code> and <code>value</code> arguments. If this was to avoid <code>clippy::too_many_arguments</code>, it&#x27;s fine to add an <code>#[allow(...)]</code> here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_dict_comprehension.rs</code>:84 on 2025-04-04 21:08</div>
            <div class="timeline-body"><p>Does this need to be <code>&amp;mut</code>? With <code>report_diagnostic</code>, I think <code>&amp;</code> should be fine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_dict_comprehension.rs</code>:352 on 2025-04-04 21:11</div>
            <div class="timeline-body"><pre><code>    // {... for i in (a, b)}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_dict_comprehension.rs</code>:357 on 2025-04-04 21:16</div>
            <div class="timeline-body"><p>This is slightly shorter but maybe not more readable. Up to you.</p>
<pre><code>    let iter_str = if let Expr::Tuple(ast::ExprTuple {
        parenthesized: false,
        ..
    }) = &amp;*for_stmt.iter
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_dict_comprehension.rs</code>:397 on 2025-04-04 21:20</div>
            <div class="timeline-body"><p>This is all a nice touch. I don&#x27;t usually worry about formatting when generating a fix :smile:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_dict_comprehension.rs</code>:402 on 2025-04-04 21:21</div>
            <div class="timeline-body"><p>It looks like these two are used in both arms of the <code>match</code> and could be hoisted out.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/perflint/snapshots/ruff_linter__rules__perflint__tests__preview__PERF403_PERF403.py.snap</code>:174 on 2025-04-04 21:25</div>
            <div class="timeline-body"><p>This is kind of a strange order. Is this how the list version works? It&#x27;s already an unsafe fix, so it&#x27;s pretty reasonable to drop the comments instead of trying to sort them out, if it&#x27;s difficult to do. We just need to mention it in the <code>## Fix safety</code> docs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-04 21:31</div>
            <div class="timeline-body"><p>Thanks for all of this work! It looks good, and most of my inline comments are just stylistic nits.</p>
<p>For tests, I think I&#x27;d like to see ~1 test for each of the (very helpful) comments that document some constraint, if that&#x27;s not too hard. Is that what you had in mind in the PR summary?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/w0nder1ng">@w0nder1ng</a> reviewed on 2025-04-07 01:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/w0nder1ng">@w0nder1ng</a> on <code>crates/ruff_linter/src/rules/perflint/helpers.rs</code>:1 on 2025-04-07 01:35</div>
            <div class="timeline-body"><p>Yes, there are no changes. I just extracted them into functions so I could reuse the code in <code>manual_dict_comprehension.rs</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/w0nder1ng">@w0nder1ng</a> reviewed on 2025-04-07 02:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/w0nder1ng">@w0nder1ng</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_dict_comprehension.rs</code>:281 on 2025-04-07 02:01</div>
            <div class="timeline-body"><p>This checks whether the result dictionary is accessed between its assignment and the for loop. I was trying to get across that it&#x27;s not safe to transform this:</p>
<pre><code>res = {}
print(len(res))
values = {&quot;a&quot;: 1, &quot;b&quot;: 2}
for k, v in values.items():
    res[k] = v
</code></pre>
<p>into this:</p>
<pre><code>print(len(res))  # NameError
values = {&quot;a&quot;: 1, &quot;b&quot;: 2}
res = {k: v for k, v in values.items()}
</code></pre>
<p>In this case, it needs to be <code>.update</code> instead, since the binding statement needs to stay put</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/w0nder1ng">@w0nder1ng</a> reviewed on 2025-04-07 02:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/w0nder1ng">@w0nder1ng</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_dict_comprehension.rs</code>:402 on 2025-04-07 02:11</div>
            <div class="timeline-body"><p>The indentation depends on whether the comments are empty, and the relevant comments depend on the type of fix, so I think indentation has to stay in both.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/w0nder1ng">@w0nder1ng</a> reviewed on 2025-04-07 02:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/w0nder1ng">@w0nder1ng</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_dict_comprehension.rs</code>:157 on 2025-04-07 02:23</div>
            <div class="timeline-body"><p>I was thinking that if it doesn&#x27;t exist, then there is some flaw in my code, so it&#x27;d be better to find out with a panic than to silently ignore the logic error. Is there a better way to report an invariant being broken without a panic?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/w0nder1ng">@w0nder1ng</a> on 2025-04-07 02:55</div>
            <div class="timeline-body"><p>@ntBre I think I&#x27;ve addressed all of your feedback, so please let me know if you need anything else changed.</p>
<p>Also, do you know why the <code>configuration.md</code> output test is failing? I don&#x27;t think I touched any files that affect it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-07 12:54</div>
            <div class="timeline-body"><blockquote>
<p>Also, do you know why the <code>configuration.md</code> output test is failing? I don&#x27;t think I touched any files that affect it.</p>
</blockquote>
<p>At the very top of the error message it says</p>
<blockquote>
<p>Error: docs/configuration.md changed, please run <code>cargo dev generate-all</code>:</p>
</blockquote>
<p>I think adding a fix probably changed the docs slightly, and you just need to run <code>cargo dev generate-all</code> to fix it. Some of the diffs look kind of weird, though, so you may also need to merge <code>main</code> or something, but try <code>generate-all</code> first.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-07 13:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_dict_comprehension.rs</code>:157 on 2025-04-07 13:04</div>
            <div class="timeline-body"><p>I might be going overboard here, but I&#x27;m pretty wary of user-facing panics, at least when they&#x27;re easily avoidable. There are a couple of other options here:</p>
<ol>
<li><code>debug_assert</code> that the <code>find</code> result is <code>Some</code> to panic only in dev builds</li>
<li>Log an error, probably with <code>debug!</code>, so that the user can see it with <code>--verbose</code> if they encounter a surprising false negative</li>
<li>There&#x27;s also a <code>warn_user_once</code> macro, but I think that&#x27;s for higher-priority issues whereas this is more for debugging</li>
</ol>
<p>I think I&#x27;d prefer (1) or (2) but no strong preference between them. <code>debug!</code> is probably slightly neater in a <code>let-else</code> with <code>return</code> but <code>debug_assert</code> gives the stronger guarantee, at least while testing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-07 13:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_dict_comprehension.rs</code>:402 on 2025-04-07 13:06</div>
            <div class="timeline-body"><p>Oh I see now, thanks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_dict_comprehension.rs</code>:302 on 2025-04-07 13:12</div>
            <div class="timeline-body"><p>You can use <code>Diagnostic::with_fix</code> here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-04-07 13:14</div>
            <div class="timeline-body"><p>Thanks! I&#x27;d still like to avoid the <code>expect</code> calls, and I added one more suggestion for <code>Diagnostic::with_fix</code> but this looks good to me otherwise, once the tests are passing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/w0nder1ng">@w0nder1ng</a> on 2025-04-07 18:33</div>
            <div class="timeline-body"><p>Turns out I just needed to merge with main. Did you also want the <code>.expect()</code> in <code>convert_to_dict_comprehension</code> removed?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-07 21:06</div>
            <div class="timeline-body"><blockquote>
<p>Turns out I just needed to merge with main. Did you also want the <code>.expect()</code> in <code>convert_to_dict_comprehension</code> removed?</p>
</blockquote>
<p>Yes please!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_dict_comprehension.rs</code>:143 on 2025-04-07 21:09</div>
            <div class="timeline-body"><p>You could include your previous <code>expect</code> message as the <code>debug_assert</code> message, if you want.</p>
<pre><code>        debug_assert!(target_binding.is_some(), &quot;for-loop target binding must exist&quot;);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-04-07 21:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/w0nder1ng">@w0nder1ng</a> on 2025-04-15 23:33</div>
            <div class="timeline-body"><p>@ntBre let me know if any other changes are necessary</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-04-16 16:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[perflint] implement quick-fix for manual-dict-comprehension (PERF403)&quot; to &quot;[`perflint`] Implement fix for `manual-dict-comprehension` (`PERF403`)&quot; by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-16 16:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-04-16 17:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_list_comprehension.rs</code>:282 on 2025-04-16 17:08</div>
            <div class="timeline-body"><p>Sorry for not noticing this earlier (or for bringing it up again if we already discussed it), but should this be included here? I think these changes (and the corresponding ones on the dict side) are causing the differences in the ecosystem check, and I would kind of like to limit this PR strictly to the autofix.</p>
<p>I would have at least expected some PERF401 snapshots to change with this, since it&#x27;s obviously affecting ecosystem packages.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Skylion007">@Skylion007</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_list_comprehension.rs</code>:282 on 2025-04-16 20:29</div>
            <div class="timeline-body"><p>We can split it off in a different PR, but it&#x27;s an ecosystem bug we noticed when testing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Skylion007">@Skylion007</a> reviewed on 2025-04-16 20:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-18 17:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-18 17:10</div>
            <div class="timeline-body"><p>Thanks, I thought we had to revert the <code>Call</code> check in the <code>dict</code> too, but that&#x27;s in the new preview part anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-18 17:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-18 17:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Skylion007">@Skylion007</a> on 2025-04-19 15:17</div>
            <div class="timeline-body"><p>@w0ndering Mind opening a new PR for that ecosystem fix to list Calls as well?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:12:20 UTC
    </footer>
</body>
</html>
