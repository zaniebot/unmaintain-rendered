<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add `static-frame` as a walltime benchmark - astral-sh/ruff #19844</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add <code>static-frame</code> as a walltime benchmark</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19844">#19844</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-08-10 13:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body">Summary
<p>An early version of <a href="https://github.com/astral-sh/ruff/pull/19811">astral-sh/ruff#19811</a> dramatically increased the time it took ty to type-check the <a href="https://github.com/static-frame/static-frame">static-frame</a> codebase: in mypy_primer runs, the execution time went from around 1 minute to around 10 minutes. However, on that early version of #19811, most benchmarks showed big improvements, with only a few benchmarks showing regressions of 1-2%.</p>
<p>The latest version of #19811 no longer exhibits a large increase in execution time when type-checking static-frame, but I find it somewhat concerning that none of our benchmarks flagged the early version; I only accidentally noticed the regression due to the fact that mypy_primer runs were taking much longer to complete! This PR therefore adds static-frame as a walltime benchmark, since it obviously contains Python code patterns that don&#x27;t currently have good coverage in our ty benchmark suite. The benchmark setup is basically copied from <a href="https://github.com/hauntsaninja/mypy_primer/blob/3cc3235fb80746b03d197fbbce485e7407858c81/mypy_primer/projects.py#L1530-L1537">the project&#x27;s mypy_primer setup</a>.</p>
Test Plan
<p><code>cargo bench -p ruff_benchmark --bench=ty_walltime</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ci</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-10 13:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-10 13:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-10 13:17</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-10 13:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-10 14:35</div>
            <div class="timeline-body"><p>Hmm, I&#x27;m not sure why (as it&#x27;s not the case for me locally), but it looks like the <code>arraykit</code> dependency of <code>static-frame</code> is being built from source in CI when preparing the environment for <code>static-frame</code>. <code>numpy</code> needs to be present in the build environment for building from source to work (which adds a fair amount of complexity to the benchmark setup). Building <code>arraykit</code> from source also means that setting up the environment for static-frame appears to take a fair bit longer than any other walltime benchmark (23.18 seconds). So this might not be worth it.</p>
<p>Having said all that, the walltime-benchmarks CI job is still completing in roughly the same amount of time as the instrumented-benchmarks CI job.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-10 14:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-08-11 06:54</div>
            <div class="timeline-body"><p>Looking at the install and wall time, it suggests that the wall time benchmark now takes 1 minute longer to run, reaching 10 minutes (for both wall and instrumented benchmarks). This is definitely reaching the point where it feels very long if you need the benchmark numbers. Unfortunately, codspeed also doesn&#x27;t support splitting the benchmarks.</p>
<blockquote>
<p>Having said all that, the walltime-benchmarks CI job is still completing in roughly the same amount of time as the instrumented-benchmarks CI job.</p>
</blockquote>
<p>Hehe, and the next instrumentation benchmark addition will not be much longer than the wall time run ;)</p>
<p>I&#x27;ll reach out to codspeed to see if there&#x27;s anything we can do to improve our benchmark runtime. Are there any benchmark that we could remove in favor of <code>static-frame</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-08-11 07:08</div>
            <div class="timeline-body"><p>Could we install some of the dependencies as part of the <code>setup-uv</code> build step?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-11 09:39</div>
            <div class="timeline-body"><p>It actually looks like the big slowdown on the &quot;bad version&quot; of #19811 is reproducible even without <code>arraykit</code> installed, so the simplest solution here is probably to avoid that dependency (though I&#x27;m still not sure why the C extension is being built from source in the context of the Codspeed run, since it just downloads a built wheel from PyPI when I install arraykit locally, and mypy_primer also manages to use a built wheel).</p>
<p>I&#x27;ll push that change and see how long the walltime benchmark takes then.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-11 09:59</div>
            <div class="timeline-body"><p>Okay, on the latest version of this PR, the walltime job is completing in 10m7s overall, which appears ~indistinguishable to the time it takes to complete on <code>main</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-11 09:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-08-11 14:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-11 14:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-11 14:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-11 14:38</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:17:35 UTC
    </footer>
</body>
</html>
