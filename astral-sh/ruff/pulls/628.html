<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Move check filtering to linter.rs - astral-sh/ruff #628</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Move check filtering to linter.rs</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/628">#628</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2022-11-06 22:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><p>Right now, we rely on the various checkers <em>not</em> adding disabled rules to the list of returned checks. This results in a lot of very rigorous validation against <code>settings.enabled</code> throughout the codebase. While this does guarantee that we avoid as much useless work as possible, I think it might be overkill, and makes for some very tedious code.</p>
<p>This PR instead adds a step to the core check path to filter out any disabled rules prior to returning. This is safer, in that we&#x27;re enforcing rule enablement at one singular location, and it means that we can use enablement and disablement purely as a performance optimization (skip unnecessary work) and not as something that we need to track throughout the codebase.</p>
<p>The downside heres here are (1) it does create a situation in which we&#x27;re not strictly required to skip unnecessary work (since we&#x27;ll always filter out unneeded checks at the last minute), and (2) technically we&#x27;re doing a little bit of extra work now in some minor cases.</p>
<p>Resolves #412 (though the approach isn&#x27;t exactly as-described in that issue).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-07 02:20</div>
            <div class="timeline-body"><p>(Need to benchmark this.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andersk">@andersk</a> on 2022-11-12 01:30</div>
            <div class="timeline-body"><p>I’m curious why you decided against filtering in <code>add_check</code>? It seems to me that would take the same amount of computation with less memory. Perhaps you’re concerned about increasing the code size of this <code>#[inline(always)]</code> function—but if we think its calls are rare enough that it’s okay for them to allocate extra memory, then they should also be rare enough that they aren’t worth inlining.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-12 01:41</div>
            <div class="timeline-body"><p>Primarily because there are other sources of checks apart from the AST <code>Checker</code>, and so we&#x27;d still have to guard against adding disabled checks in (e.g.) <code>check_lines.rs</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andersk">@andersk</a> on 2022-11-12 01:44</div>
            <div class="timeline-body"><p>Somewhat tangentially, I bet replacing <code>enabled: BTreeSet&lt;CheckCode&gt;</code> with a flat array <code>enabled: [bool; 173]</code> (or some bit-set library) would speed up these checks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-12 01:45</div>
            <div class="timeline-body"><p>Yeah I like that idea.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-11 15:23</div>
            <div class="timeline-body"><p>I&#x27;ll come back to this at some point but this PR is dated and lingering.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-11 15:23</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:51:25 UTC
    </footer>
</body>
</html>
