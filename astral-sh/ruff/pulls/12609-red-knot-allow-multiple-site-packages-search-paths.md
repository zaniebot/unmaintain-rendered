```yaml
number: 12609
title: "[red-knot] Allow multiple `site-packages` search paths"
type: pull_request
state: merged
author: AlexWaygood
labels:
  - ty
assignees: []
merged: true
base: main
head: alex/multiple-site-packages
created_at: 2024-08-01T11:12:59Z
updated_at: 2024-08-02T16:35:03Z
url: https://github.com/astral-sh/ruff/pull/12609
synced_at: 2026-01-12T15:55:41Z
```

# [red-knot] Allow multiple `site-packages` search paths

---

_@AlexWaygood_

## Summary

If a virtual environment's `pyvenv.cfg` file contains the line `include-system-site-packages = true`, anything installed in the system Python installation's site-packages directory will be accessible when the virtual environment is activated, *as well as* anything inside the virtual environment's site-packages directory. That means that we could have 0, 1, or many `site-packages` directories that we'd need to consider as search paths -- currently we only contemplate the `0` or `1` possibilities. As such, it makes sense for the `site_packages` field on `Program` to be a `Vec` rather than an `Option`. This is the first commit of this PR.

The second commit of the PR updates some of the logic in the resolver to reflect the fact that if there are two `site-packages` directories on `sys.path` at runtime, any editable installs provided via `.pth` files in the first `site-packages` directory will take precedence over the second `site-packages` directory when it comes to module resolution.

## Test plan

`cargo test`

---

_Label `red-knot` added by @AlexWaygood on 2024-08-01 11:12_

---

_Review requested from @carljm by @AlexWaygood on 2024-08-01 11:13_

---

_Review requested from @MichaReiser by @AlexWaygood on 2024-08-01 11:13_

---

_Converted to draft by @AlexWaygood on 2024-08-01 11:14_

---

_Comment by @github-actions[bot] on 2024-08-01 11:26_

<!-- generated-comment ecosystem -->
## `ruff-ecosystem` results
### Linter (stable)
âœ… ecosystem check detected no linter changes.

### Linter (preview)
âœ… ecosystem check detected no linter changes.




---

_Marked ready for review by @AlexWaygood on 2024-08-01 11:40_

---

_Renamed from "[red-knot] Make the `site-packages` search-path setting a vector of paths" to "[red-knot] Allow multiple `site-packages` search paths; enable easier mocking in tests" by @AlexWaygood on 2024-08-01 11:48_

---

_@MichaReiser reviewed on 2024-08-01 11:49_

---

_Review comment by @MichaReiser on `crates/ruff_db/src/program.rs`:83 on 2024-08-01 11:49_

The paths in `Program` all must be resolved or it will be impossible to implement persistent caching. That means, any python and site package discovery **must** happen before setting the search paths on `Program`. 

That's why I think we don't need this enum.

---

_Review comment by @AlexWaygood on `crates/ruff_db/src/program.rs`:83 on 2024-08-01 11:53_

That makes sense to me, but then I don't understand why we're setting `SystemPathBuf`s (which represent unvalidated, unresolved search paths) on `Program` at all, rather than `SearchPath`s (which represent validated, resolved search paths). This was my concern I expressed in my review comment https://github.com/astral-sh/ruff/pull/12318#discussion_r1677156390 when you created the `Program` struct.

---

_@AlexWaygood reviewed on 2024-08-01 11:53_

---

_@AlexWaygood reviewed on 2024-08-01 12:15_

---

_Review comment by @AlexWaygood on `crates/ruff_db/src/program.rs`:83 on 2024-08-01 12:15_

I'm working on an alternative solution which is a more significant refactor, but perhaps will address your concern here

---

_@MichaReiser reviewed on 2024-08-01 12:32_

---

_Review comment by @MichaReiser on `crates/ruff_db/src/program.rs`:83 on 2024-08-01 12:32_

We could validate the settings earlier, but we don't necessarily have to.  

The problem with storing `SearchPath` on `Program` is that `Program` is in `ruff_db`... That's what I commented in your other PR around validation.



---

_@MichaReiser reviewed on 2024-08-01 12:33_

---

_Review comment by @MichaReiser on `crates/ruff_db/src/program.rs`:83 on 2024-08-01 12:33_

> I'm working on an alternative solution which is a more significant refactor, but perhaps will address your concern here

I think what we have here is fine, except that it can always be a vec. I don't think we have to do any significant refactors.


---

_Review comment by @MichaReiser on `crates/ruff_db/src/program.rs`:83 on 2024-08-01 18:22_

The reason why I think we should do the validation outside of salsa is because I consider failing to resolve Python a fatal error. See this comment https://github.com/astral-sh/ruff/pull/12376#issuecomment-2247800148

That's why I want to avoid making any changes that need to be undone when migrating to this model.

I also strongly prefer avoiding any refactors until we've figured out the error handling. We should instead focus on shipping the features that we've set out for this week.

---

_@MichaReiser reviewed on 2024-08-01 18:22_

---

_@AlexWaygood reviewed on 2024-08-01 18:38_

---

_Review comment by @AlexWaygood on `crates/ruff_db/src/program.rs`:83 on 2024-08-01 18:38_

> I consider failing to resolve Python a fatal error

Failing to resolve Python is a very different thing to failing to resolve the site-packages directories from a resolved path to a Python executable.

> I also strongly prefer avoiding any refactors until we've figured out the error handling. We should instead focus on shipping the features that we've set out for this week.

Fair enough, but this is one of the features that I set out for the week, that we agreed a couple of weeks ago that it would be good for me to work on ðŸ˜…

I'm okay with putting off larger refactors for now, but it's unclear to me how to complete work on deriving site-packages from a Python executable unless we're agreed on where that logic should be. Anyway, I can do other work for now, and we can discuss in Runes planning tomorrow.

I did some interesting work today experimenting with broader refactors â€” I'm very unsure what I have locally is the way we want to go, but I think it was interesting anyway. I'll put it up tomorrow so you can see.

---

_@MichaReiser reviewed on 2024-08-01 19:09_

---

_Review comment by @MichaReiser on `crates/ruff_db/src/program.rs`:83 on 2024-08-01 19:09_

> Failing to resolve Python is a very different thing to failing to resolve the site-packages directories from a resolved path to a Python executable.

What would you expect to happen if we fail to detect python (and its site packages) when running the CLI?

---

_@AlexWaygood reviewed on 2024-08-01 19:15_

---

_Review comment by @AlexWaygood on `crates/ruff_db/src/program.rs`:83 on 2024-08-01 19:15_

When running the CLI, I agree that failing to resolve site-packages should probably be a fatal error. I just want to be clear about what exactly I'm trying to accomplish here, because they're very different things.

(In an LSP context, I definitely think it _shouldn't_ be fatal if e.g. the user deactivates a virtual environment so we try to fall back to the system site-packages directory instead, and we can't. But I think we agree on that.)

---

_@MichaReiser reviewed on 2024-08-01 19:29_

---

_Review comment by @MichaReiser on `crates/ruff_db/src/program.rs`:83 on 2024-08-01 19:29_

That makes sense. For now, I would suggest to plug your logic somewhere into the red knot crate (or at least call it from there when constructing Program). I think the change from one to many site packages is still worth landing 

---

_Review comment by @AlexWaygood on `crates/red_knot_module_resolver/src/resolver.rs`:207 on 2024-08-01 20:44_

I'll add some tests tomorrow for the changes made to this function.

---

_@AlexWaygood reviewed on 2024-08-01 20:44_

---

_Renamed from "[red-knot] Allow multiple `site-packages` search paths; enable easier mocking in tests" to "[red-knot] Allow multiple `site-packages` search paths" by @AlexWaygood on 2024-08-01 20:47_

---

_Comment by @MichaReiser on 2024-08-01 21:05_

Okay, I'll wait with reviewing then

---

_Review requested from @MichaReiser by @AlexWaygood on 2024-08-02 13:14_

---

_Comment by @AlexWaygood on 2024-08-02 13:16_

I added a test and updated the PR description. Ready for re-review!

---

_Review comment by @MichaReiser on `crates/red_knot_module_resolver/src/resolver.rs`:248 on 2024-08-02 13:18_

```suggestion
        let root = files.try_add_root(
            db.upcast(),
            site_packages_dir,
            FileRootKind::LibrarySearchPath,
        );
        
        dynamic_paths
            .push(SearchPath::site_packages(system, site_packages_dir.to_owned()).unwrap());

        // This query needs to be re-executed each time a `.pth` file
        // is added, modified or removed from the `site-packages` directory.
        // However, we don't use Salsa queries to read the source text of `.pth` files;
        // we use the APIs on the `System` trait directly. As such, add a dependency on the
        // site-package directory's revision.
				root.revision(db.upcast());
```

---

_Review comment by @MichaReiser on `crates/red_knot_module_resolver/src/resolver.rs`:238 on 2024-08-02 13:19_

I do think that moving site packages constructing into the dynamic modules query will make it harder for validation but whatever. Let's ignore this for now

---

_@MichaReiser approved on 2024-08-02 13:19_

---

_@AlexWaygood reviewed on 2024-08-02 13:26_

---

_Review comment by @AlexWaygood on `crates/red_knot_module_resolver/src/resolver.rs`:238 on 2024-08-02 13:26_

Yeah, @carljm was wondering if all this lazy `.pth`-file iteration was a bit too fancy -- we should maybe just collect all search paths eagerly. Definitely open to that; I have no idea how much lazy iteration through `.pth` files actually saves us.

---

_Merged by @AlexWaygood on 2024-08-02 13:33_

---

_Closed by @AlexWaygood on 2024-08-02 13:33_

---

_Branch deleted on 2024-08-02 13:33_

---

_@carljm reviewed on 2024-08-02 16:35_

---

_Review comment by @carljm on `crates/red_knot_module_resolver/src/resolver.rs`:238 on 2024-08-02 16:35_

I can't imagine lazy iteration of `.pth` files saves us anything at all in any realistic scenario. It would require that there is a site-packages path, with editables installed into it, that the project never actually imports anything from; all imports are first-party. So yeah, I'd favor simplifying by just collecting all search paths eagerly.

---
