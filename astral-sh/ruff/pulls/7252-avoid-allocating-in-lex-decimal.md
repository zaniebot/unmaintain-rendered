```yaml
number: 7252
title: Avoid allocating in lex_decimal
type: pull_request
state: merged
author: MichaReiser
labels:
  - parser
assignees: []
merged: true
base: main
head: lex-decimal-avoid-allocating
created_at: 2023-09-09T10:36:14Z
updated_at: 2023-09-11T07:36:28Z
url: https://github.com/astral-sh/ruff/pull/7252
synced_at: 2026-01-12T15:55:23Z
```

# Avoid allocating in lex_decimal

---

_@MichaReiser_

## Summary

`lex_decimal_number` shows up as one of the most expensive operations during lexing. This is partially due to it allocating a string before calling into `f64::parse` or `BigInt::parse`. 

This PR avoids allocating a string for numbers that don't use `_` or `E`.

## Test Plan

`cargo test`

This improves performance for files with many numbers (dataset.py +3%)

<!-- How was it tested? -->


---

_Comment by @MichaReiser on 2023-09-09 10:36_

Current dependencies on/for this PR:
* main
  * **PR #7252** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7252" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7252?utm_source=stack-comment).

---

_Label `parser` added by @MichaReiser on 2023-09-09 10:36_

---

_Review requested from @dhruvmanila by @MichaReiser on 2023-09-09 10:46_

---

_Comment by @github-actions[bot] on 2023-09-09 10:51_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.



---

_Review comment by @dhruvmanila on `crates/ruff_python_parser/src/lexer.rs`:311 on 2023-09-09 13:24_

Is there a specific reason that we're normalizing `E`? As per the [documentation of `f64::from_str`](https://doc.rust-lang.org/stable/std/primitive.f64.html#method.from_str), it accepts both `e` and `E`. I've tested it out locally as well with combinations of `(e|E)(+|-)`.

---

_Review comment by @dhruvmanila on `crates/ruff_python_parser/src/lexer.rs`:1240 on 2023-09-09 13:28_

nit: I wonder if we could rename both `push_matching` and `push_different` as otherwise I found it difficult to understand what it does without looking at the implementation.

---

_@dhruvmanila approved on 2023-09-09 13:29_

Thanks!

I like the `LexedText` abstraction. I think it could even be used in f-string normalization to normalize `{{`/`}}` to `{`/`}` using `LexedText::skip_char`.

---

_@MichaReiser reviewed on 2023-09-10 18:34_

---

_Review comment by @MichaReiser on `crates/ruff_python_parser/src/lexer.rs`:1240 on 2023-09-10 18:34_

Renaming is easy. The question is what better names are? 

---

_Review comment by @dhruvmanila on `crates/ruff_python_parser/src/lexer.rs`:1240 on 2023-09-11 06:07_

I wonder if `push_different` is necessary with my other comment above as it's only used here. As such I can't think of any other names ðŸ˜…

---

_@dhruvmanila reviewed on 2023-09-11 06:07_

---

_Merged by @MichaReiser on 2023-09-11 06:37_

---

_Closed by @MichaReiser on 2023-09-11 06:37_

---

_Branch deleted on 2023-09-11 06:37_

---

_@konstin reviewed on 2023-09-11 06:57_

---

_Review comment by @konstin on `crates/ruff_python_parser/src/lexer.rs`:1223 on 2023-09-11 06:57_

is that the same abstraction we use for normalizing strings?

---

_@MichaReiser reviewed on 2023-09-11 07:01_

---

_Review comment by @MichaReiser on `crates/ruff_python_parser/src/lexer.rs`:1223 on 2023-09-11 07:01_

The lexer doesn't normalize Strings. I haven't looked into what the whole `string.rs` is doing (and how much of it could be moved into the lexer)

---

_@konstin reviewed on 2023-09-11 07:17_

---

_Review comment by @konstin on `crates/ruff_python_parser/src/lexer.rs`:1223 on 2023-09-11 07:17_

i meant in the formatter, this was just a random thought because the logic looked familiar from the normalize functions of strings, ints and floats

---

_Review comment by @MichaReiser on `crates/ruff_python_parser/src/lexer.rs`:1223 on 2023-09-11 07:36_

It's similar but we don't use an abstraction in the formatter. 

---

_@MichaReiser reviewed on 2023-09-11 07:36_

---
