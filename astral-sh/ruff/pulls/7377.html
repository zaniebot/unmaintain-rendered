<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catch panics in formatter - astral-sh/ruff #7377</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Catch panics in formatter</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7377">#7377</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-09-14 02:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR ensures that we catch and render panics in the formatter identically to other kinds of errors. It also improves the consistency in error rendering throughout and makes a few stylistic changes to the messages.</p>
<p>Closes https://github.com/astral-sh/ruff/issues/7247.</p>
<h2>Test Plan</h2>
<p>I created a file <code>foo.py</code> with a syntax error, and a file <code>bar.py</code> with an intentional panic.</p>
<img width="1624" alt="Screen Shot 2023-09-13 at 10 25 22 PM" src="https://github.com/astral-sh/ruff/assets/1309177/605c2839-ad02-4376-a2e9-d5a593ab660f">

<img width="1624" alt="Screen Shot 2023-09-13 at 10 25 24 PM" src="https://github.com/astral-sh/ruff/assets/1309177/b1381909-157c-48cb-9630-d0bbfcb1b640">

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @charliermarsh on 2023-09-14 02:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-14 02:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/linter.rs</code>:556 on 2023-09-14 02:31</div>
            <div class="timeline-body"><p>This re-stylizes as &quot;Ruff&quot; instead of <code>ruff</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-14 02:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/linter.rs</code>:545 on 2023-09-14 02:33</div>
            <div class="timeline-body"><p>This is consistent with our <code>error!</code> and <code>warn!</code> formatting (bold the colon).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-14 02:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_cli/src/commands/format.rs</code>:115 on 2023-09-14 02:35</div>
            <div class="timeline-body"><p>These don't show up if you run with <code>--quiet</code>, which I guess is correct?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-14 02:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/lib.rs</code>:123 on 2023-09-14 02:36</div>
            <div class="timeline-body"><p>This was causing tracing to print the error, but we want to handle reporting it downstream of this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @charliermarsh on 2023-09-14 02:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2023-09-14 02:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-09-14 02:56</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2023-09-14 03:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/lib.rs</code>:123 on 2023-09-14 06:39</div>
            <div class="timeline-body"><p>Shouldn't it only print the error when the tracing level is <code>err</code>? @konstin can we tune our tracing setup in the cli instead? I would want to keep errors showing, e.g. in the VS code output panel (once rewritten to rust)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-09-14 06:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_cli/src/commands/format.rs</code>:115 on 2023-09-14 07:57</div>
            <div class="timeline-body"><p>I check that both cargo and black still print errors with <code>--quiet</code>. Should we do the same? I think of quiet as &quot;don't show status messages&quot;, but i'm against swallowing errors</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/lib.rs</code>:123 on 2023-09-14 08:01</div>
            <div class="timeline-body"><p>how would you determine whether to show these errors as log messages, as opposed to other not separately handled <code>error!()</code> that we always want to show?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-09-14 08:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/lib.rs</code>:123 on 2023-09-14 08:41</div>
            <div class="timeline-body"><p>I guess the main challenge is that we use <code>log</code> for both user-facing errors and tracing. I would recommend using the <code>log-tracing</code> for now. We never want to log any tracing events as user-visible messages.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-14 08:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-14 08:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/lib.rs</code>:123 on 2023-09-14 08:45</div>
            <div class="timeline-body"><p>switching to tracing is easy, i just have to figure out how to get the currrent <code>warning</code>/<code>error</code> formatting there</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/lib.rs</code>:123 on 2023-09-14 08:49</div>
            <div class="timeline-body"><p>I'm not sure if we are on the same page. What I'm trying to say is that I don't think we should use tracing to show user facing errors. Actually, we should avoid that tracing uses <code>log</code> to output its messages because they then end up in the console output.</p>
<p>I think my preference would be to instead use e.g. a rotating file logger to which we write our tracing logs. This would give us an additional debugging tool as well and prevents that the two log-streams from interleaving.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-14 08:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/lib.rs</code>:123 on 2023-09-14 10:44</div>
            <div class="timeline-body"><p>No the logging works, i meant something simpler: <code>fern</code> gives us custom formatting for warnings and errors, for tracing we need to either switch to tracing logging style or implement our own layer that formats them in the <code>**warning**: {message}</code> style:</p>
<pre><code>$ ruff --select PLR2 --no-cache asdf
warning: Failed to lint asdf: No such file or directory (os error 2)
$ target/debug/ruff --select PLR2 --no-cache asdf
2023-09-14T10:39:55.819547Z  WARN ruff_cli::commands::check: Failed to lint asdf: No such file or directory (os error 2)  
</code></pre>
<p><img src="https://github.com/astral-sh/ruff/assets/6826232/e8ac3041-cef5-4511-bde9-34c022b536b1" alt="image" /></p>
<p>I surprisingly couldn't find any example of how to intersect <code>warn!</code> and <code>error!</code> nor how to get our plain warn/error style without reimplementing the whole event formatting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-14 10:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-14 11:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/lib.rs</code>:123 on 2023-09-14 11:05</div>
            <div class="timeline-body"><p>But should tracing warnings even be user facing? I see tracing as a development tool and not a way to communicate to users.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-14 15:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_cli/src/commands/format.rs</code>:115 on 2023-09-14 15:43</div>
            <div class="timeline-body"><p>I'll consider this separately.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-09-14 15:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-09-14 15:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-09-14 15:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-14 15:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/lib.rs</code>:123 on 2023-09-14 15:44</div>
            <div class="timeline-body"><p>(I interpreted this discussion as non-blocking for the PR, but let me know if that's incorrect.)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:00:15 UTC
    </footer>
</body>
</html>
