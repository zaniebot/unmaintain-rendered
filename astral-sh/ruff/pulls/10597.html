<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`ruff server` now supports `source.fixAll` source action - astral-sh/ruff #10597</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>ruff server</code> now supports <code>source.fixAll</code> source action</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10597">#10597</a>
        opened by <a href="https://github.com/snowsignal">@snowsignal</a>
        on 2024-03-26 05:15
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-03-26 05:15</div>
            <div class="timeline-body"><h2>Summary</h2>
<p><code>ruff server</code> now has source action <code>source.fixAll</code> as an available code action.</p>
<p>This also fixes https://github.com/astral-sh/ruff/issues/10593 in the process of revising the code for quick fix code actions.</p>
<h2>Test Plan</h2>
<p>https://github.com/astral-sh/ruff/assets/19577865/f4c07425-e68a-445f-a4ed-949c9197a6be</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @snowsignal on 2024-03-26 05:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-03-26 05:29</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-03-26 07:48</div>
            <div class="timeline-body"><p>What do you think of implementing each checkbox in its own PR instead of having one large PR that implements all the features at once? To me, the individual features seem useful on its own and smaller PRs are easier to review, and tend to have a shorter lead time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-26 13:21</div>
            <div class="timeline-body"><p>üëç Smaller PRs means we can merge faster and even release these out in the wild faster too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "`ruff server` now supports source actions `fixAll` and `organizeImports`, along with commands `applyAutofix` and `applyOrganizeImports`" to "`ruff server` now supports `source.fixAll` source action" by @snowsignal on 2024-03-26 14:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @snowsignal on 2024-03-26 14:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @snowsignal on 2024-03-26 16:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/lint.rs</code>:95 on 2024-03-26 17:01</div>
            <div class="timeline-body"><p>Nit</p>
<pre><code class="language-suggestion">                    code: rule.noqa_code().to_string(),
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server.rs</code>:199 on 2024-03-26 17:03</div>
            <div class="timeline-body"><p>Ruff's current LSP also supports a ruff specific <code>fixAll</code> action. It's <a href="https://github.com/astral-sh/ruff-vscode?tab=readme-ov-file#configuring-vs-code">documented here</a> towards the end.</p>
<pre><code class="language-json">{
  &quot;[python]&quot;: {
    &quot;editor.codeActionsOnSave&quot;: {
      &quot;source.fixAll.ruff&quot;: &quot;explicit&quot;,
      &quot;source.organizeImports.ruff&quot;: &quot;explicit&quot;
    }
  }
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/code_action.rs</code>:207 on 2024-03-26 17:04</div>
            <div class="timeline-body"><p>Nit: Should we move this into a <code>all()</code> method on <code>SupportCodeAction</code>. It could be easier to spot (and reuse) in case new variants are added.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/code_action.rs</code>:202 on 2024-03-26 17:07</div>
            <div class="timeline-body"><p>Nit: We could consider using a bitflag for this, considering that the action kinds are a fixed set. But I'm also okay keeping with we have, avoiding the allocation here is probably overkill.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/code_action.rs</code>:219 on 2024-03-26 17:27</div>
            <div class="timeline-body"><p>Nice trick to have a single iterator type.</p>
<p>Nit: I do struggle reading this code. A lot is going on, including flattening. I wonder if the complexity is worth it to avoid a single <code>Vec</code> allocation, considering that we end up allocating a vec on line 174 anyway (we could avoid that by using an array instead).</p>
<p>I do find the non iterator version easier to reason about (I believe that's the equivalent code but I find it hard to say because I don't fully understand the iterator version)</p>
<pre><code>    let edits_made: Vec&lt;_&gt; = edits
        .filter(|edit| {
            edit.diagnostic_fix
                .fix
                .applies(ruff_diagnostics::Applicability::Safe)
        })
        .collect();

    if edits_made.is_empty() {
        return Vec::new();
    }

    let diagnostics_fixed = edits_made
        .iter()
        .map(|edit| edit.original_diagnostic.clone())
        .collect();

    vec![
        types::CodeActionOrCommand::CodeAction(types::CodeAction {
            title: format!(&quot;{DIAGNOSTIC_NAME}: Fix all auto-fixable problems&quot;),
            diagnostics: Some(diagnostics_fixed),
            kind: Some(types::CodeActionKind::SOURCE_FIX_ALL),
            edit: Some(types::WorkspaceEdit {
                document_changes: Some(types::DocumentChanges::Edits(
                    edits_made
                        .into_iter()
                        .flat_map(|edit| edit.document_edits.iter())
                        .cloned()
                        .collect(),
                )),
                ..Default::default()
            }),
            ..Default::default()
        }), // TODO: implement command handler for the server
            /*
            types::CodeActionOrCommand::Command(types::Command {
                ...
            }
             */
    ]
```

Edit: I think for now it would even be sufficient to return a single `Option`.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/code_action.rs</code>:82 on 2024-03-26 17:34</div>
            <div class="timeline-body"><p>Nit: I think I would just go with a <code>vec</code> here to keep things simple. We don't have any usages today where we want to pass an iterator</p>
<pre><code class="language-suggestion">    diagnostics: Vec&lt;types::Diagnostic&gt;,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/code_action.rs</code>:129 on 2024-03-26 17:40</div>
            <div class="timeline-body"><p>Nit: You can avoid cloning here by using <code>deref</code></p>
<pre><code class="language-suggestion">        let title = edit
            .diagnostic_fix
            .kind
            .suggestion
            .as_deref()
            .unwrap_or(&amp;edit.diagnostic_fix.kind.name);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/code_action.rs</code>:83 on 2024-03-26 17:46</div>
            <div class="timeline-body"><p>Nit: Considering that <code>available_actions</code> is a set (or bitset, see below), I would probably rewrite it as</p>
<pre><code>			  // Add a quick fix for the diagnostic
        if available_actions.contains(&amp;SupportedCodeAction::QuickFix) {
            response.extend(quick_fix(edits.iter()));
        }

				// Add a single fix all action for all diagnostics
        if available_actions.contains(&amp;SupportedCodeAction::FixAll) {
            response.extend(fix_all(edits.iter()));
        }

        if available_actions.contains(&amp;SupportedCodeAction::OrganizeImports) {
            todo!(&quot;Implement the `source.organizeImports` code action&quot;)
        }
</code></pre>
<p>I find this more readable because it makes the ordering explicit in code (no need to implement <code>Ord</code>) and allows for inline comments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/code_action.rs</code>:52 on 2024-03-26 17:50</div>
            <div class="timeline-body"><p>I'm struggling a bit with the terminology:</p>
<ul>
<li>A diagnostic has a list of edits</li>
<li>The diagnostic gets converted into a <code>DiagnosticEdit</code> but it itself has a list of edits</li>
<li><code>diagnostic_edits</code> returns a vec of <code>DiagnosticEdit</code> (which is a list of edits).</li>
</ul>
<p>My recommendation would have been to rename <code>DiagnosticEdit</code> to <code>DiagnosticFix</code> but that type already exists and that type also stores a list of edits (but different edits?).</p>
<p>I don't have a good recommendation on how to simplify this. Maybe rename <code>DiagnosticFix</code> to <code>SerializedFix</code> or <code>SerializedDiagnosticFix</code> to make it clear it's what is stored on <code>Diagnostic</code> or <code>SerializedDiagnosticData</code>. I mainly want to point out that I'm overwhelmed by this and struggle to understand the different data structures.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/code_action.rs</code>:121 on 2024-03-26 17:57</div>
            <div class="timeline-body"><p>Nit: I would remove the generic type considering that <code>edits</code> is always a slice</p>
<pre><code class="language-suggestion">fn quick_fix&lt;'d&gt;(
    edits: &amp;['d DiagnosticEdit],
) -&gt; impl Iterator&lt;Item = CodeActionOrCommand&gt; + 'd {
</code></pre>
<p>It simplifies the signature a great deal</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/code_action.rs</code>:86 on 2024-03-26 17:57</div>
            <div class="timeline-body"><p>Nit: I wonder if we could use <code>take</code> here and rename <code>original_diagnostic</code> to <code>fixed_diagnostic</code> to make it clear it's not the &quot;entire&quot; diagnostic anymore.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-03-26 18:00</div>
            <div class="timeline-body"><p>Nice, now we have almost feature parity with the old extension for Pyton files.</p>
<p>This looks good to me.</p>
<p>I have a few small nits. Feel free to disregard them; this is mainly a matter of personal preference. My main feedback is that I recommend avoiding <code>impl</code> when we only call the methods with a single type (same for return types). I do find <code>impl</code> types more difficult to understand and oftentimes require explicit lifetimes where they aren't required when using an explicit type</p>
<p>I do think there's an opportunity to improve the naming. It took me a while to understand all the different types involved. I made a suggestion inline.</p>
<p>We should make sure that the LSP also supports the ruff specific <code>fixAll</code> action, see my other inline comment for the details.</p>
<p>Once you add the test plan to the PR (which you planned on doing anyway), this is good to go.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-03-26 21:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server/api/requests/code_action.rs</code>:86 on 2024-03-26 21:56</div>
            <div class="timeline-body"><p>My only concern is that this would make the list of 'fixed' diagnostics that we provide (which hints at the diagnostics that get fixed with a code action) no longer perfectly match the original diagnostics the client has, since they'll be missing the <code>data</code> field. Unfortunately the specification isn't clear whether it has to be an exact match or whether it matches on certain fields. Since this is just supposed to be a hint though, it's probably fine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-03-26 23:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server/api/requests/code_action.rs</code>:52 on 2024-03-26 23:06</div>
            <div class="timeline-body"><p>I've made renamings similar to what you suggested, with one exception: I changed <code>DiagnosticFix</code> to <code>AssociatedDiagnosticData</code> because I think that describes what its actual role is as a serialized structure. <code>SerializedFix</code> may imply that it contains serialized values, which it doesn't.</p>
<p>I also reworked <code>DiagnosticEdit</code> (now <code>DiagnosticFix</code>) to only include the relevant fields from <code>AssociatedDiagnosticData</code> so it's a bit less confusing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-03-26 23:10</div>
            <div class="timeline-body"><p>I've addressed all the suggestions and rebased against <code>main</code> to get the fix for https://github.com/astral-sh/ruff/issues/10618. All that's left is the test plan video.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/server.rs</code>:199 on 2024-03-27 04:48</div>
            <div class="timeline-body"><p>We will need to advertise to the client that we support Ruff scoped code actions during initialization. Refer https://github.com/astral-sh/ruff-lsp/blob/187d7790be0783b9ac41ce025a724cf389bf575c/ruff_lsp/server.py#L852-L869</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-27 04:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-03-27 08:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/code_action.rs</code>:86 on 2024-03-27 08:19</div>
            <div class="timeline-body"><p>Yeah. That's why I'm unsure if it's okay to do so. I'm very surprised that the response must contain the entire diagnostic and not just an ID.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-03-27 08:22</div>
            <div class="timeline-body"><p>Thanks for addressing all the feedback.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @MichaReiser on 2024-03-28 08:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/lint.rs</code>:100 on 2024-03-28 08:26</div>
            <div class="timeline-body"><p>nit: this might just be a personal preference but I find it harder to read fully qualified path when the type itself should be sufficient. For example, <code>DocumentVersion</code> instead of <code>crate::edit::DocumentVersion</code>. But, it's up to you if you find having this easier</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/session/settings.rs</code>:11 on 2024-03-28 08:41</div>
            <div class="timeline-body"><p>Can you expand on why this is called &quot;extension&quot; capabilities? Which extension does this refer to? I think these are the extracted client capabilities to be queried at a later point. Maybe we can use <code>ClientCapabilities</code> (conflicting) / <code>ResolvedClientCapabilities</code> / <code>SupportedClientCapabilities</code> with <code>support_code_action_resolve</code> method?</p>
<pre><code class="language-rs">#[derive(Debug, Clone, PartialEq, Eq, Default)]
pub(crate) struct ResolvedClientCapabilities {
    code_action_resolve: bool,
}

impl ResolvedClientCapabilities {
	pub(crate) fn supports_code_action_resolve(&amp;self) -&gt; bool {
		self.code_action_resolve
	}
}

impl From&lt;&amp;ClientCapabilities&gt; for ResolvedClientCapabilities {
	fn from(client_capabilities: &amp;ClientCapabilities) -&gt; Self {
		// ...
	}
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/session/settings.rs</code>:6 on 2024-03-28 08:43</div>
            <div class="timeline-body"><p>Can you add please some documentation on what these server settings are? What is the intended use case of them and what should be included? To me it seems they're settings to configure the Ruff server but it contains capabilities which I find a bit confusing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/server.rs</code>:272 on 2024-03-28 08:47</div>
            <div class="timeline-body"><p>nit: should we use <code>into_available</code> / <code>to_available</code> as per the convention? Or, we could even define a <code>From</code> implementation for this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/server/api/requests/code_action_resolve.rs</code>:76 on 2024-03-28 09:00</div>
            <div class="timeline-body"><p>Do you think we should just return an owned vector of fixes here instead of an iterator impl? Returning an impl Iterator makes me wonder if there's any potential use case, you will have more knowledge on this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-28 09:00</div>
            <div class="timeline-body"><p>This is great work!</p>
<p>I just have one recommendation which is to document the types and functions. This would be really helpful. It's does not need to be done in this PR itself.</p>
<p>I'm going to test this out locally in Neovim now and approve then.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2024-03-28 09:13</div>
            <div class="timeline-body"><p>I just tested it in Neovim. It works really well.</p>
<p>I have noticed one minor thing but it could very well be something else. When I run the fixAll code action and then undo the edit via the editor, the cursor jumps to the first line of the file. This doesn't happen when I do so through <code>ruff-lsp</code>. This is a bit of inconvenience but I don't think it's related to your change. I can look into why this is happening. It could very well be an editor bug.</p>
<p>Here's a video showcasing that: the first code action applied is via <code>ruff-lsp</code> while the second one is the release build of this branch.</p>
<p>https://github.com/astral-sh/ruff/assets/67177269/c343e780-3d29-49c2-aabf-a17f7c1ecbb9</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-03-28 09:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/session/settings.rs</code>:6 on 2024-03-28 09:40</div>
            <div class="timeline-body"><p>I share the sentiment here, but I think it's mainly a naming issue than anything else:</p>
<ul>
<li>It's unexpected to find server settings in the session</li>
<li>The settings (as they are today) configure only the client capabilities</li>
</ul>
<p>I think my recommendation for today would be to</p>
<p>a) Remove <code>ServerSettings</code> and directly use <code>ClientCapabilities</code> or <code>ResolvedClientCapabilities</code> (inline today's <code>ExtensionCapabilities</code>).
b) Rename to <code>SessionSettings</code>?</p>
<p>I would go with <code>a</code> and figure out the precise naming once we know what other kind of data settings store (should be an easy refactor)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/code_action_resolve.rs</code>:43 on 2024-03-28 09:48</div>
            <div class="timeline-body"><p>NIt</p>
<pre><code class="language-suggestion">        debug_assert_eq!(
            available_action &amp; (available_action - AvailableCodeActions::all()),
            AvailableCodeActions::empty()
        );
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/code_action_resolve.rs</code>:55 on 2024-03-28 09:48</div>
            <div class="timeline-body"><p>I think this needs an error text</p>
<pre><code class="language-suggestion">            Err(anyhow::anyhow!(&quot;.....&quot;)).with_failure_code(ErrorCode::InvalidParams)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/code_action_resolve.rs</code>:47 on 2024-03-28 09:52</div>
            <div class="timeline-body"><p>What's the motivation here to call into <code>makes_available</code> over directly matching on the <code>SupportedCodeActionKind</code> considering that it should always be one action (you need to fall back to debug assertions to replace the static assertions when matching on <code>SupportedCodeActionsKind</code> direclty)</p>
<pre><code>match supported {
    SupportedCodeActionKind::SourceFixAll | SupportedCodeActionKind::SourceFixAllRuf =&gt; {

    }
    _ =&gt; {
        Err()
    }
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/code_action_resolve.rs</code>:53 on 2024-03-28 09:59</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        let supported: SupportedCodeActionKind = action
            .kind
            .clone()
            .ok_or(anyhow::anyhow!(&quot;No kind was given for code action&quot;))
            .with_failure_code(ErrorCode::InvalidParams)?
            .try_into()
            .map_err(|()| anyhow::anyhow!(&quot;Code action was of an invalid kind&quot;))
            .with_failure_code(ErrorCode::InvalidParams)?;
        let available_action = supported.makes_available();

        // ensures that only one code action kind was made available
        debug_assert!(
            (available_action &amp; (available_action - AvailableCodeActions::all()))
                == AvailableCodeActions::empty()
        );

        if available_action == AvailableCodeActions::SOURCE_FIX_ALL {
            resolve_edit_for_fix_all(
                action,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server.rs</code>:79 on 2024-03-28 10:00</div>
            <div class="timeline-body"><p>Would it be sufficient to only store the client capabilities on the session, or why do we need to store it on the sessoin and server?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/session/settings.rs</code>:30 on 2024-03-28 10:01</div>
            <div class="timeline-body"><p>We also need to check that the extension has data support:</p>
<blockquote>
<p>This is also guarded by an additional client capability codeAction.dataSupport. In general, a client should offer data support if it offers resolve support. It should also be noted that servers shouldn‚Äôt alter existing attributes of a code action in a codeAction/resolve request.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2024-03-28 10:03</div>
            <div class="timeline-body"><p>I've been a bit surprised by the amount of changes in your last commit.  Were the changes necessary to address a bug in the implementation?</p>
<p>If not, then I would recommend for the future to merge the existing PR (it's functional) and create a new PR with the changes instead. This has a few advantages in my view:</p>
<ul>
<li>It gives you place to explain and motivate your change. This prevents the situation I'm in now where it's unclear why we implemented a new resolve handler. What is it for, what does it enable? Why the added complexity?</li>
<li>It avoids that reviewers have to re-review the entire PR a second time. Instead, they can focus on the latest changes (in context of what you summarized)</li>
</ul>
<p>If you make such fundamental changes to existing PRs (because it's required to address a bug), then I recommend you to explicitly re-request review. It was unclear to me why the PR wasn't merged this morning and I only understood why after seeing @dhurvmanila's comments</p>
<p>Would you mind explaining the most recent changes in the PR summary. How does <code>resolve</code> and code action work together. How do we handle clients that don't support these client capabilities. I'm sure I could read this out from the code but that adds an extra burden to the reviewer because:</p>
<ul>
<li>I have to figure out the actual behavior from code</li>
<li>I have to figure out the expected behavior my self (or the behavior you intended)</li>
</ul>
<p>That makes it more difficult for me to make a useful review.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-03-28 23:58</div>
            <div class="timeline-body"><p>@MichaReiser My apologies for not explaining the reasons I made these changes more clearly. I'll try to go over the issue with this PR and the need to implement <code>codeAction/resolve</code> as a part of that:</p>
<ol>
<li>When we generate a list of code actions, we're given a list of diagnostics to generate those code actions for. My first pass implementation made the assumption that this diagnostic list would be for the entire file, and so the fixes used to create the <code>fixAll</code> workspace edit were taken directly from the diagnostics provided.</li>
<li>However, this isn't how the code action endpoint works, most of the time. The client usually asks for code actions based on diagnostics in a specific range, which for VS Code is usually just the underlined diagnostic the cursor is pointing to.</li>
<li>The way the existing LSP (<code>ruff-lsp</code>) solves this issue is by always making <code>source.fixAll</code> (and <code>source.organizeImports</code>) available as a code action, and attempting to defer calculating the <code>edit</code> field until the source action is actually being called.</li>
<li>That's essentially what I changed this PR to do - we check if the client supports deferred code action resolution, and defer calculating the diagnostic for the entire file. If the client supports this deferred resolution, we set the <code>edit</code> field to <code>None</code> when building the code action as part of the <code>textDocument/codeAction</code> request. It's then the client's job to call <code>codeAction/resolve</code> once the code action is about to be used, where we populate the <code>edit</code> field with the edits to make, if safe fixes exist for the file. If the client doesn't support deferred resolution, we populate the <code>edit</code> field during the <code>textDocument/codeAction</code> request.</li>
</ol>
<p>I hope that clears up the confusion around these changes. I'll try to have these explanations prepared in advance for the future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-03-29 00:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/lint.rs</code>:100 on 2024-03-29 00:00</div>
            <div class="timeline-body"><p>I generally like to keep <code>use</code> statements to a minimum, but I can agree it's a bit verbose. I'll try to remove fully qualified paths where the type in question has an obvious origin.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-03-29 00:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/session/settings.rs</code>:11 on 2024-03-29 00:05</div>
            <div class="timeline-body"><p>My intent for <code>ServerSettings</code> and its sub-structure <code>ExtensionCapabilities</code> was to reflect the configuration being set on the client side (AKA the 'editor extension'), along with the capabilities of the client. That being said, <code>ResolvedClientCapabilities</code> is probably a better name for this!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-03-29 00:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server.rs</code>:272 on 2024-03-29 00:07</div>
            <div class="timeline-body"><p>We take <code>self</code> by value here because <code>Self</code> is <code>Copy</code>-able and clippy complains if you take it by reference. It's not meant to be a conversion method, but maybe that needs to be clarified.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-03-29 00:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server/api/requests/code_action_resolve.rs</code>:76 on 2024-03-29 00:14</div>
            <div class="timeline-body"><p>Returning an <code>impl Iterator</code> tends to be my default when writing functions that use iterators (as opposed to collecting them preemptively) because it gives the caller more control over the allocation and execution of the iterator. I'm not opposed to <code>.collect()</code> in a function body if it makes the code easier to read though, so I'm fine with changing the signature.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-03-29 00:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server/api/requests/code_action_resolve.rs</code>:47 on 2024-03-29 00:21</div>
            <div class="timeline-body"><p>I wanted to avoid duplicating the logic of <code>makes_available</code>, since I was concerned about a misalignment in logic if we added new variants of code action kinds to be accounted for. However, I'd be fine with using a match statement like this if we make sure it's exhaustive, so that adding new variants would force us to update the <code>match</code> logic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server.rs</code>:79 on 2024-03-29 00:25</div>
            <div class="timeline-body"><p>We need a separate reference to <code>client_capabilities</code> to pass into <code>Server::try_register_capabilities</code> because the session is already borrowed mutably by the scheduler.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-03-29 00:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-03-29 00:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server/api/requests/code_action_resolve.rs</code>:53 on 2024-03-29 00:28</div>
            <div class="timeline-body"><p>I'm not sure what this suggestion is for - it just seems to be removing most of the <code>resolve_edit_for_fix_all</code> call, which wouldn't compile.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @snowsignal on 2024-03-29 05:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-03-29 07:55</div>
            <div class="timeline-body"><p>Thanks for the explanation. That's helfpul context for reviewing the PR</p>
<blockquote>
<p>If the client doesn't support deferred resolution, we populate the edit field during the textDocument/codeAction request.</p>
</blockquote>
<p>Does that mean that <code>fix all</code> for clients not supporting <code>resolve</code> doesn't fix all diagnostics but only the diagnostics in view (the trimmed-down diagnostics selected by the editor?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-03-29 07:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/code_action_resolve.rs</code>:53 on 2024-03-29 07:57</div>
            <div class="timeline-body"><p>Hmm yeah, this is nonsense. Sorry. I'm still struggling with the multiline suggestion feature and must have incorrectly submitted this suggestion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/code_action.rs</code>:86 on 2024-03-29 08:00</div>
            <div class="timeline-body"><p>Nit:</p>
<pre><code class="language-suggestion">        // The editor will request the edit in a `CodeActionsResolve` request
        edit: None,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-03-29 08:00</div>
            <div class="timeline-body"><blockquote>
<p>Does that mean that fix all for clients not supporting resolve doesn't fix all diagnostics but only the diagnostics in view (the trimmed-down diagnostics selected by the editor?)</p>
</blockquote>
<p>I should have been more clear on that: we <em>do</em> fix all diagnostics, it's just less performant because we have to lint the file right then instead of deferring that to when it's actually used.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/code_action.rs</code>:107 on 2024-03-29 08:04</div>
            <div class="timeline-body"><p>Nit: I found it a bit confusing that we initialize <code>action</code> only to override it then. It seems the motivation for doing this is so that the <code>action</code> can be passed to <code>resolve_edit_for_fix_all</code>, which sets <code>action.edit</code>. I think I would restructure this to</p>
<pre><code class="language-suggestion">    let (edit, data) = if snapshot.resolved_client_capabilities().code_action_deferred_edit_resolution {
        // This will be resolved later
        (None, Some(serde_json::to_value(snapshot.url()).expect(&quot;document url to serialize&quot;)))
    } else {
        (resolve_edit_for_fix_all(document, snapshot.url(), &amp;snapshot.configuration.linter, snapshot.encoding()), None)
    };

    let action = types::CodeAction {
        title: format!(&quot;{DIAGNOSTIC_NAME}: Fix all auto-fixable problems&quot;),
        kind: Some(types::CodeActionKind::SOURCE_FIX_ALL),
        edit: None,
        data,
        ..Default::default()
    };

    Ok(types::CodeActionOrCommand::CodeAction(action))
</code></pre>
<p>This way it's clearer what's different between the two paths and it avoids setting <code>data</code> for clients that don't support it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/code_action.rs</code>:14 on 2024-03-29 08:08</div>
            <div class="timeline-body"><p>Nit: It might be helpful to document the different code actions. What are they supposed to do and how do they work with other code actions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-03-29 08:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-29 11:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/server/api/requests/code_action.rs</code>:31 on 2024-03-29 11:09</div>
            <div class="timeline-body"><p>Did this get accidentally checked-in or is it suppose to be at a different log level?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-03-29 14:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server/api/requests/code_action.rs</code>:31 on 2024-03-29 14:45</div>
            <div class="timeline-body"><p>This was checked in by accident, my bad.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-04-02 20:58</div>
            <div class="timeline-body"><p>I've made one final major refactor (which I <em>hope</em> will be the last) in https://github.com/astral-sh/ruff/pull/10597/commits/de6870df6528455b59adbc10cfe8247cac449e78.</p>
<p>Up until now, we've been building a workspace edit for <code>source.fixAll</code> by aggregating fixes from individual diagnostics (which are taken from <code>ruff_linter::linter::check_path</code>). However, if these diagnostic fixes cause conflicting changes or result in additional diagnostics being surfaced, aggregating them is actually the wrong move. What we should be doing is incrementally applying fixes until we've reached convergence, which is what <code>ruff_linter::linter::lint_fix</code> does. So now, when resolving the workspace edit for <code>source.fixAll</code>, we call <code>lint_fix</code> to get a fixed source file, and then we use <code>Replacement::between</code> to create a diff between the original source and the transformed source, which is used as the workspace edit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @snowsignal on 2024-04-02 20:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-04-03 06:39</div>
            <div class="timeline-body"><p>Whoops. I directly commented on the commit https://github.com/astral-sh/ruff/commit/de6870df6528455b59adbc10cfe8247cac449e78 because that was the easiest to review the changes but it seems GitHub doesn't show these comments :( Anyway. Looks good to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2024-04-03 07:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-03 07:11</div>
            <div class="timeline-body"><blockquote>
<p>Whoops. I directly commented on the commit <a href="https://github.com/astral-sh/ruff/commit/de6870df6528455b59adbc10cfe8247cac449e78">de6870d</a> because that was the easiest to review the changes but it seems GitHub doesn't show these comments :( Anyway. Looks good to me.</p>
</blockquote>
<p>I think that only works if you open the commit from the PR's &quot;Files Changed&quot; tab. There's a commit filter on the top of the diff view. Maybe that should render the comments correctly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @snowsignal on 2024-04-03 16:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @snowsignal on 2024-04-03 16:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-04-03 16:22</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 22:48:06 UTC
    </footer>
</body>
</html>
