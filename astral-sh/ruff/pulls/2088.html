<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>refactor: Introduce crates folder - astral-sh/ruff #2088</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>refactor: Introduce crates folder</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/2088">#2088</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-01-22 16:01
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-01-22 16:01</div>
            <div class="timeline-body"><p>This PR introduces a new <code>crates</code> directory and moves all &quot;product&quot; crates into that folder.</p>
<p>Part of #2059</p>
<p><strong>TODO</strong></p>
<ul>
<li>Test Playground</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-01-22 16:04</div>
            <div class="timeline-body"><p>@chammika-become what 's the best way to verify that my PR doesn't introduce any regressions?</p>
<p>It seems that the <code>resources</code> folder is only used by tests in the <code>ruff_analyze</code> crate. Should I move it to <code>crates/rust_analyze/tests/resources</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-22 16:40</div>
            <div class="timeline-body"><p>Maybe you meant to tag me? :joy:</p>
<p>I think there are a few things we can do here from a testing perspective:</p>
<ol>
<li>Get CI passing (<code>fmt</code>, <code>clippy</code>, <code>test --all</code>).</li>
<li>Ensure that the built wheel is unchanged (modulo incidental file-size changes due to README or whatever else). This would involve installing <a href="https://maturin.rs/">maturin</a>, running <code>maturin build</code>, and then looking at the built wheel (which is just a zip archive containing the Ruff binary plus metadata):</li>
</ol>
<pre><code>‚ùØ maturin build
üçπ Building a mixed python/rust project
üîó Found bin bindings
üì° Using build options bindings from pyproject.toml
üíª Using `MACOSX_DEPLOYMENT_TARGET=11.0` for aarch64-apple-darwin by default
   Compiling ruff v0.0.229 (/Users/crmarsh/workspace/ruff)
   Compiling ruff_cli v0.0.229 (/Users/crmarsh/workspace/ruff/ruff_cli)
    Finished dev [unoptimized + debuginfo] target(s) in 18.11s
üì¶ Built wheel to /Users/crmarsh/workspace/ruff/target/wheels/ruff-0.0.229-py3-none-macosx_11_0_arm64.whl

‚ùØ unzip -l /Users/crmarsh/workspace/ruff/target/wheels/ruff-0.0.229-py3-none-macosx_11_0_arm64.whl
Archive:  /Users/crmarsh/workspace/ruff/target/wheels/ruff-0.0.229-py3-none-macosx_11_0_arm64.whl
  Length      Date    Time    Name
---------  ---------- -----   ----
   127520  01-22-2023 16:38   ruff-0.0.229.dist-info/METADATA
      103  01-22-2023 16:38   ruff-0.0.229.dist-info/WHEEL
     1070  01-22-2023 16:38   ruff-0.0.229.dist-info/license_files/LICENSE
        0  01-22-2023 16:38   ruff/__init__.py
      193  01-22-2023 16:38   ruff/__main__.py
 40091538  01-22-2023 16:38   ruff-0.0.229.data/scripts/ruff
      540  01-22-2023 16:38   ruff-0.0.229.dist-info/RECORD
---------                     -------
 40220964                     7 files
</code></pre>
<p>This artifact should be effectively identical before and after this change. (It's the thing that gets uploaded to PyPI and installed via <code>pip install ruff</code>.) It should also be possible to <code>pip install /Users/crmarsh/workspace/ruff/target/wheels/ruff-0.0.229-py3-none-macosx_11_0_arm64.whl</code> in a new virtual environment, then run <code>ruff /path/to/file.py</code>. I can help with that if your Python env isn't fully setup.</p>
<ol start="3">
<li>Ensure that the playground works as expected? I guess we can just validate that locally for the most part via running the documented <code>wasm-pack</code> commands, then <code>npm run dev</code> from <code>playground</code>.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-22 16:41</div>
            <div class="timeline-body"><blockquote>
<p>It seems that the resources folder is only used by tests in the ruff_analyze crate. Should I move it to crates/rust_analyze/tests/resources</p>
</blockquote>
<p>I <em>think</em> this would be a reasonable thing to do. That folder mostly contains Python text fixtures, some of which are used by the unit tests (for snapshot testing with <code>insta</code>), and some of which just exist for manual testing right now (e.g., the stuff in <code>resources/test/project</code>, which lets you test some of the config-resolution logic manually).</p>
<p>There may well be a better convention for this altogether. It's one of the things I ran with at the start of the project, and hasn't changed much since. (I <em>do</em> like having the fixtures as Python files and not embedded as strings in Rust code, so I wouldn't want to change <em>that</em> aspect of it, but e.g., I'd guess that <code>resources</code> is not the conventional name for a folder like this.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-01-22 20:15</div>
            <div class="timeline-body"><blockquote>
<p>This PR further renames the ruff package to ruff_analyze, mainly to avoid the CLI and the previous ruff crate having the same name. I don't know if that's desired but I found it confusing that the ruff binary comes from the CLI and not the ruff crate.</p>
</blockquote>
<p>I intentionally named the CLI crate this way when I split it from the library. I think it only makes sense that the ruff library is called <code>ruff</code> and not something random like ruff_analyze[^1]. Also there is precedence for this naming convention from very popular projects e.g. <a href="https://crates.io/crates/diesel">diesel</a> &amp; <a href="https://crates.io/crates/diesel_cli">diesel_cli</a> and <a href="https://crates.io/crates/wasm-bindgen">wasm-bindgen</a> &amp; <a href="https://crates.io/crates/wasm-bindgen-cli">wasm-bindgen-cli</a>. I think naming the library crate something other than ruff very much implies that the library is a second-class citizen, which might be true right now but I very much expect that to change as ruff stabilizes.</p>
<p>[^1]: Also sounds weird given the very popular <a href="https://github.com/rust-lang/rust-analyzer">rust-analyzer</a> ... we don't analyze ruff, we analyze python code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-22 21:40</div>
            <div class="timeline-body"><p>I remain happy to update the crate structure, though I agree that we should retain the <code>ruff</code> name for now rather than renaming to <code>ruff-analyzer</code>. There's some precedent for this pattern amongst other projects, and it feels like a reasonable structure from my perspective.</p>
<p>(Also: we can always make that change in the future -- it's harder to undo than to do -- and in a separate PR, rather than bundling with the crate reorganization.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-22 21:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>README.md</code>:1783 on 2023-01-22 21:41</div>
            <div class="timeline-body"><p>These <em>may</em> have been updated accidentally.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2023-01-26 15:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @charliermarsh on 2023-01-26 17:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>ruff_dev/Cargo.toml</code>:12 on 2023-01-27 00:08</div>
            <div class="timeline-body"><p>I believe <code>ruff_dev</code> needs to be moved to <code>./crates/ruff_dev</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-27 00:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-27 00:33</div>
            <div class="timeline-body"><p>I think we need to move <code>ruff_dev</code> as well. Apart from that, and a rebase, this looks good to me. I went ahead and tested both the playground, and <code>maturin build</code> + the installed wheel too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-27 00:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>.github/workflows/playground.yaml</code>:31 on 2023-01-27 00:34</div>
            <div class="timeline-body"><p>I was confused by this <code>../../</code> path, but I guess it's relative to <code>crates/ruff</code>, rather than the <code>cwd</code>? Seems to work!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>.github/workflows/playground.yaml</code>:31 on 2023-01-27 09:42</div>
            <div class="timeline-body"><p>Yeah, that's confusing. It seems that <code>wasm-pack</code> interprets the out dir path relative to the build target...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-01-27 09:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-01-27 09:52</div>
            <div class="timeline-body"><blockquote>
<p>I think we need to move <code>ruff_dev</code> as well. Apart from that, and a rebase, this looks good to me. I went ahead and tested both the playground, and <code>maturin build</code> + the installed wheel too.</p>
</blockquote>
<p>Awesome, and thanks for testing!</p>
<p>I haven't moved <code>ruff_dev</code> because we haven't yet reached a consensus in #2059 on crates that are build scripts. I proposed to move code-gen/rust-scripts into the <code>xtask</code> folder to separate them from the product code and also to avoid accidentally publishing such crates in the future (consider code in the <code>crates</code> folder as the &quot;public&quot; crates and crates in the <code>xtask</code> folder as private). However, I learned more about ruff's code structure when doing this refactor and realized that there are also many scripts written in Python, and it makes sense for ruff not to write all scripts in rust to dogfood ruff.</p>
<p>I would prefer not to move <code>ruff_dev</code> for now and first get a shared understanding of where we want to place build scripts (use a single folder, keep the python and rust scripts separate, ...).</p>
<p>I've also decided not to move the <code>resources</code> folder yet because I first want to figure out a way to reuse the test-setup code between tests (avoid the repetition of the <code>../../resources</code> path in every test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-01-27 18:04</div>
            <div class="timeline-body"><p>I'll be out for the next few days. Feel free to land this anytime or take over. I've given Maintainers push access in case some merge conflicts need to be solved (or other changes)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-27 23:04</div>
            <div class="timeline-body"><p>üëç Will do!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-31 23:21</div>
            <div class="timeline-body"><p>@not-my-profile - I'm hoping to rebase and merge this in the next release (not today's release, the following). Did you have any further comments on changing the structure? I know you'd mentioned somewhere (though I can't find it in this PR) creating a symlink or similar to <code>src</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-02-01 04:23</div>
            <div class="timeline-body"><p>I think the creation of that symlink can wait till we improve the structure of the <code>ruff</code> library.</p>
<p>Regarding this PR .. I think it would be nice to perform the change in 2 commits:</p>
<ol>
<li>The first commit only moves the files and changes nothing else.</li>
<li>The second commit updates all path references that need to be updated.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-02-01 04:27</div>
            <div class="timeline-body"><p>And to be honest I'd like to avoid changes such as:</p>
<pre><code class="language-diff">-           Path::new(&quot;./resources/test/fixtures/flake8_simplify&quot;)
+           Path::new(&quot;../../resources/test/fixtures/flake8_simplify&quot;)
</code></pre>
<p>I think it would be better to firstly refactor our code to have the <code>test_path</code> function automatically prefix <code>./resources/test/fixtures/</code> ... then we wouldn't have to update all of these paths for performing the move.</p>
<p>(Seeing that <code>./resources/test/fixtures</code> is also referenced in <code>Settings</code> structs in the tests ... this should really be a constant).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-01 04:27</div>
            <div class="timeline-body"><p>@not-my-profile - Ok, I can make that happen. It needs a big rebase anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-02-01 04:33</div>
            <div class="timeline-body"><p>Btw I have finally fully implemented the many-to-many mapping ... I'll only have to clean up my commits, update the <code>rule</code> command and add some tests :) I think I'll wait with doing the PR till this migration is over.</p>
<blockquote>
<p>I think it would be better to firstly refactor our code to factor out <code>./resources/test/fixtures</code> to a constant</p>
</blockquote>
<p>Should I get started with that?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-01 04:35</div>
            <div class="timeline-body"><blockquote>
<p>Should I get started with that?</p>
</blockquote>
<p>Yeah that'd be great! I'm not going to rebase and merge this until tomorrow anyway (getting late here).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-02-01 10:11</div>
            <div class="timeline-body"><blockquote>
<p>I haven't moved ruff_dev because we haven't yet reached a consensus in https://github.com/charliermarsh/ruff/issues/2059 on crates that are build scripts. I proposed to move code-gen/rust-scripts into the xtask folder to separate them from the product code</p>
</blockquote>
<p>If we have a <code>crates</code> directory I think it should certainly contain all of our crates ... no matter if they're internal or public. I don't like the name <code>xtask</code> since it's very nondescript (what tasks?).</p>
<blockquote>
<p>to avoid accidentally publishing such crates in the future</p>
</blockquote>
<p>We can simply set <code>publish = false</code> in <code>Cargo.toml</code> for crates that shouldn't be published, see <a href="https://doc.rust-lang.org/cargo/reference/manifest.html#the-publish-field">the Cargo documentation</a>.</p>
<p>Since this PR has gotten a bit messy, I have started a new PR #2435 for this migration ... I refactored the code beforehand in #2433 so that the actual migration doesn't require us to update hundreds of paths.</p>
<p>Looking at the other commits you pushed here Charlie:</p>
<blockquote>
<p>Tweak Cargo.toml files 2b9388b63b6577dba2d56719194af5dfe17592a0)</p>
</blockquote>
<p>I really think we should keep unrelated changes out of the PR we use for such a migration. I was really confused why this PR removed 3k lines ... until I realized it's because you deleted a no longer needed <code>Cargo.lock</code> file in that commit ... I think that's better done after the migration.</p>
<blockquote>
<p>Fix contributing references c01fe8c8ff068959356354b15d1c8948a12c4a49</p>
</blockquote>
<p>I think prefixing <code>crates/ruff/</code> to every path makes the file less readable ... I'd rather move the example sections to <code>crates/ruff/CONTRIBUTING.md</code> and link that file from the main <code>CONTRIBUTING.md</code> file.</p>
<blockquote>
<p>I think it would be nice to perform the change in 2 commits</p>
</blockquote>
<p>I was mostly concerned about making many changes in a huge commit that moves all these files. Now that all of these path updates aren't necessary anymore I think it makes more sense to do the <code>crates/</code> migration in a single atomic commit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-02-01 11:20</div>
            <div class="timeline-body"><p>After looking at the resulting file structure for a while:</p>
<pre><code>‚îú‚îÄ‚îÄ crates/
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ flake8_to_ruff/
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ ruff/
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ ruff_cli/
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ ruff_dev/
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ ruff_macros/
</code></pre>
<p>I think I don't like it ... in particular that <code>ruff_cli</code> and <code>ruff_dev</code> are between <code>ruff</code> and <code>ruff_macros</code>. (Yes moving <code>ruff_dev</code> out of <code>crates/</code> would improve that a bit but I think it would be counter-intuitive to have a crate outside of <code>crates/</code>). I have therefore updated my PR #2435 to instead implement the following structure:</p>
<pre><code>‚îú‚îÄ‚îÄ frontends/
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ flake8_to_ruff/
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ playground/
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ ruff_cli/
‚îú‚îÄ‚îÄ lib/
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ ruff/
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ ruff_macros/
‚îú‚îÄ‚îÄ ruff_dev/
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îî‚îÄ‚îÄ Cargo.toml
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-01 12:36</div>
            <div class="timeline-body"><p>Yeah I generally agree with keeping <code>ruff_dev</code> alongside other crates, regardless of the resulting structure.</p>
<p>I understanding your reasoning and appreciate the argument put forth here, but my current preference is:</p>
<pre><code>‚îú‚îÄ‚îÄ crates/
‚îÇ   ‚îú‚îÄ‚îÄ flake8_to_ruff/
‚îÇ   ‚îú‚îÄ‚îÄ ruff/
‚îÇ   ‚îú‚îÄ‚îÄ ruff_cli/
‚îÇ   ‚îú‚îÄ‚îÄ ruff_dev/
‚îÇ   ‚îî‚îÄ‚îÄ ruff_macros/
‚îú‚îÄ‚îÄ playground/
‚îÇ   ‚îî‚îÄ‚îÄ ....
</code></pre>
<p>I'd like all of the crates to be in <code>crates</code>. I think it's intuitive and follows a known convention that will be familiar to newcomers with Rust experience. (Note that I've included <code>ruff_dev</code> in there too.)</p>
<p>There's another issue here, which is that the <a href="https://matklad.github.io/2021/08/22/large-rust-workspaces.html">originating blog post</a> explicitly mentions using <code>libs</code> as distinct from <code>crates</code> to indicate published vs. unpublished packages, so using <code>lib</code> also may be confusing in that light.</p>
<p>(It may make sense to wait for @MichaReiser to get back before moving forward either way though so that we can build more consensus of the right structure -- I'll try not to rush a decision that will hopefully stand the test of time.)</p>
<p>P.S. I removed the unused <code>Cargo.lock</code> in #2437.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-02-01 13:44</div>
            <div class="timeline-body"><blockquote>
<p>I generally agree with keeping ruff_dev alongside other crates,</p>
</blockquote>
<p>I only said that <em>if</em> we have a <code>crates</code> directory it should contain all crates. But I in fact agree with Micha that <code>ruff_dev</code> should be separate from the other crates, since it's only our internal tooling.</p>
<p>I think it makes much more sense to structure code after its function than blindly putting all crates in one directory, even if that is a widely used convention.</p>
<p>I see the following advantages to separating <code>frontends</code> from <code>lib</code>raries:</p>
<ul>
<li><p>It makes the codebase more accessible to newcomers, e.g. compare the following two paths</p>
<pre><code>crates/ruff/src/flake8_to_ruff/mod.rs
crates/flake8_to_ruff/src/main.rs</code></pre>
<p>with:</p>
<pre><code>lib/ruff/src/flake8_to_ruff/mod.rs
frontends/flake8_to_ruff/src/main.rs</code></pre>
</li>
<li><p>You are more likely to be looking for a specific frontend or a specific library than for <em>any crate</em>. With my suggested structure we could even put a <code>README.md</code> in both <code>frontends</code> and <code>lib</code> to further explain the structure. E.g. <code>frontends/README.md</code> could also link <a href="https://github.com/charliermarsh/ruff-lsp">ruff-lsp</a>.</p>
</li>
<li><p>Our library crates should not depend on our frontend crates ... separating the crates into two directories makes it easier to conceptualize that.</p>
</li>
<li><p>The number of our library crate will only grow as we try to split them up in order to improve our compile time ... putting all crates in one directory would make the frontend crates harder to spot since all the software simply lists directory contents alphabetically.</p>
</li>
<li><p>The library crates depend on each other while the frontend crates don't. You are more likely to have to edit multiple crates in the case of libraries as opposed to frontend crates, and I think it makes sense to group code you're likely to edit together.</p>
</li>
</ul>
<blockquote>
<p>the <a href="https://matklad.github.io/2021/08/22/large-rust-workspaces.html">originating blog post</a> explicitly mentions using libs as distinct from crates to indicate published vs. unpublished packages</p>
</blockquote>
<p>I have not seen a single project following that convention, so I wouldn't pay that much attention to it. Also choosing <code>libs</code> to refer to unpublished packages strikes me as very counter-intuitive since published libraries are also libs (and technically even unpublished libraries are crates!).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-02-01 15:07</div>
            <div class="timeline-body"><p>In case you nonetheless decide to go with the all crates in one directory approach, I just opened #2441 for that (since I had already implemented that before changing the approach).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-01 15:17</div>
            <div class="timeline-body"><p>Thank you for writing this up :) All good points, and I especially appreciate that you're looking forward to a world in which we have many more library crates, in which case, the split becomes more impactful (both by way of isolating the <code>frontend</code> crates <em>and</em> providing clean definitions for allowed and disallowed inter-dependencies). Let me think on it for a bit... and I'd love to get @MichaReiser's take on it too as the original author.</p>
<blockquote>
<p>It makes the codebase more accessible to newcomers.</p>
</blockquote>
<p>I think the impact here is hard to predict... I can imagine that as a newcomer, I'd find it helpful to know that everything in <code>crates</code> is a crate, and that all the crates are in <code>crates</code>; whereas I may not understand the distinction between <code>lib</code> and <code>frontends</code>, or what a <code>frontend</code> is in this context (Is it a web frontend, like <code>playground</code>? Is it a frontend for invoking Ruff, like <code>ruff-cli</code>? But <code>flake8-to-ruff</code> arguably wouldn't fit that description). I don't think those names are wrong or bad, only that they may not be as crystal-clear to newcomers as they would be to us.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-02-01 15:24</div>
            <div class="timeline-body"><p>Somewhat related: I think <code>ruff_dev</code> and <code>scripts</code> belong together since they're both our internal tooling.</p>
<p>I think a structure like the following would make sense no matter if we decide to go with the <code>crates/</code> or the <code>frontends/</code> / <code>lib</code> approach:</p>
<pre><code>‚îú‚îÄ‚îÄ utils/
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ benchmarks/
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ ruff_dev/
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ add_plugin.py*
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ add_rule.py*
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ generate_mkdocs.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ pyproject.toml
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ transform_readme.py
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ _utils.py

</code></pre>
<p>While this does make the <code>ruff_dev</code> crate harder to find, I actually think that's a pro ... since most contributors should never have to deal with its source code.</p>
<blockquote>
<p>a newcomer, [..] may not understand the distinction between lib and frontends, or what a frontend is in this context</p>
</blockquote>
<p>I think this could be well explained in <code>CONTRIBUTING.md</code> and <code>frontends/README.md</code> / <code>lib/README.md</code>. The benefit is that once you have understood these terms you benefit form the more organized structure than all-crates-in-one-dir. Another point is that I think it's a bit weird if <code>playground</code> is in the directory hierarchy a level above all the Rust code despite it arguably being less important.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andersk">@andersk</a> on 2023-02-01 20:43</div>
            <div class="timeline-body"><p>It seems to me that <code>frontends</code> vs. <code>lib</code> is hierarchy for the sake of hierarchy. If a newcomer is looking for the code of <code>flake8_to_ruff</code>, they might not know whether we decided to call it a ‚Äúlib‚Äù or a ‚Äúfrontend‚Äù. They might even ignore ‚Äúfrontend‚Äù completely because they think of themselves as a backend developer and think ‚Äúfrontend‚Äù is for web stuff. And even for experienced contributions, it will always be one extra thing to think about when navigating the code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-02-02 02:02</div>
            <div class="timeline-body"><blockquote>
<p>hierarchy for the sake of hierarchy</p>
</blockquote>
<p>This hierarchy is defined via our dependency graph no matter where we put our crates.</p>
<p><img src="https://user-images.githubusercontent.com/73739153/216212069-057b8550-ee93-4a56-b22c-accf5e36f369.svg" alt="architecture" /></p>
<p>(lib-only crates are indicated via a square)</p>
<p>I'd rather have our directory hierarchy reflect our component hierarchy than having to conceptualize the latter from a flat directory structure, where everything is listed alphabetically in an order that does not carry any meaning beyond that.</p>
<blockquote>
<p>And even for experienced contributions, it will always be one extra thing to think about</p>
</blockquote>
<p>I'd argue that you have to think about it in any case ...  because just <code>ruff</code> is ambiguous since it's the name of both the binary of our CLI and the name of our Rust library. (Yes <code>ruff_cli</code> is currently easy to spot but that won't be the case when there are much more crates.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-03 21:47</div>
            <div class="timeline-body"><p>I've been thinking on this and my personal preference is still to use a single flat <code>crates</code> directory. I understand that it will fail to capture the hierarchy, but I think it's simplest structure for us to manage and still the clearest to newcomers. But I'd like to get @MichaReiser's take prior to making a final decision (I believe he's back next week) -- just didn't want to leave this thread idle, so thought I'd chime in before the weekend.</p>
<blockquote>
<p>I'd argue that you have to think about it in any case ... because just ruff is ambiguous since it's the name of both the binary of our CLI and the name of our Rust library.</p>
</blockquote>
<p>Separately: this could change, right? The current top-level crate will certainly be broken down, but it could also end up being renamed as <code>ruff_core</code> or something (like Ripgrep, which has <code>core</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-02-05 11:16</div>
            <div class="timeline-body"><p>Thanks for the feedback on the PR. I'll split my reply into two sections because some input is related to the code changes, and others discuss the project structure.</p>
<h2>Code changes</h2>
<blockquote>
<p>And to be honest I'd like to avoid changes such as:</p>
</blockquote>
<p>Not having this change across all files would be nice. I also noted in my comment that I plan to refactor the repetitive test pattern in a separate PR to avoid such changes in the future (and keep this PR pure mechanical, as you mentioned). I made this suggestion because I only learned very late in the refactoring that I had to change all tests (the tests didn't run on windows), and stacked PRs are painful, to say the least. I recommend doing the refactor after because I don't think the extra history entry is bothersome enough to justify someone investing additional time avoiding it.</p>
<blockquote>
<p>Regarding this PR .. I think it would be nice to perform the change in 2 commits:</p>
</blockquote>
<p>I planned to squash all commits into a single commit. We could even hide it from the git history (with gitattributes).</p>
<h2>Structure</h2>
<blockquote>
<p>I see the following advantages to separating frontends from libraries:</p>
</blockquote>
<p>I see a few challenges with this approach:
Unclear terminology: As brought up by others, it's unclear what frontend refers to. The frontend in a compiler parses the source code and lowers it to a machine-independent representation. But that's not it. As a frontend engineer, I might think this folder only contains assets for the website or playground.
It adds additional complexity to new contributors and navigating the project structure. As a new contributor, I may not know which crates are frontends, and it's likely not relevant to the change I make. Navigating the code also becomes more complicated because the &quot;frontend&quot; isn't encoded in the Rust path of a module (its <code>ruff_cli::</code> and not <code>frontend::ruff_cli::</code>).
These are also the reasons that <a href="https://matklad.github.io/2021/08/22/large-rust-workspaces.html#Flat-Is-Better-Than-Nested">matklad</a> brings up why flat is better than hierarchical.</p>
<blockquote>
<p>Somewhat related: I think ruff_dev and scripts belong together since they're both our internal tooling.</p>
</blockquote>
<p>That makes sense, but I would prefer not to name the directory <code>utils</code>. Maybe commands, tasks, or scripts (build scripts).</p>
<blockquote>
<p>While this does make the ruff_dev crate harder to find, I actually think that's a pro ... since most contributors should never have to deal with its source code.</p>
</blockquote>
<p>I wouldn't take that as a given. Rome received many excellent contributions to the code gen.</p>
<h2>Next steps</h2>
<p>This PR intentionally didn't move the <code>ruff_dev</code> crate because we haven't reached a consensus on its placement yet. I recommend keeping it this way to unblock this PR and continue the discussion around the xtasks folder in #2059.</p>
<p>That leaves us with the sole decision if we prefer a single <code>crates</code> folder or the<code>frontend</code>/<code>libs</code> folders. I recommend going with a single <code>crates</code> folder for simplicity reasons. We'll still have the option to split the folder if there's a need for it.</p>
<p>I'll rebase the branch when we reached consensus.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-05 12:48</div>
            <div class="timeline-body"><p>Thanks @MichaReiser -- and welcome back :)</p>
<p>Given the above, my preference is to move forward with the <code>crates</code> approach.</p>
<p>My only point of disagreement is that I'd still like to move <code>ruff_dev</code> into <code>crates</code> for now. We can always revert that decision later if we choose to change the &quot;tasks&quot; structure further, but as-is, I worry that it leaves the codebase in an inconsistent state on an unclear timeline. It's hard to know if/when we'll end up changing <code>ruff_dev</code> further, and so I'd rather bias towards applying the updated convention. (Moving the crate twice isn't ideal, but it's a small cost IMO.)</p>
<p>(Procedural comment: @not-my-profile also opened #2441, which is ~close to a rebase of this PR. I'd like to merge this one if we can, since it's attached to all the discussion history, and that one needs to be rebased anyway now, but note that it exists and may be useful to look at. Another change that was made in that PR vis-a-vis this version is that <code>resources</code> was moved into <code>crates/ruff</code>, which I think is also a fine thing to do too.)</p>
<p>Finally: we may not reach complete consensus -- that's ok. Every decision has tradeoffs. The most important thing (to me) is that we've laid them out here and given them thoughtful consideration.</p>
<p>P.S. On this point:</p>
<blockquote>
<p>I planned to squash all commits into a single commit. We could even hide it from the git history (with gitattributes).</p>
</blockquote>
<p>My preference within the project is to always &quot;squash and merge&quot;. We sometimes &quot;rebase and merge&quot; in the event that a PR contains multiple atomic commits with a clean history. But as much as possible, I try to adhere to the Phabricator-like model.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-02-05 13:51</div>
            <div class="timeline-body"><blockquote>
<p>My only point of disagreement is that I'd still like to move ruff_dev into crates for now.</p>
</blockquote>
<p>Sound's good to me.</p>
<blockquote>
<p>Another change that was made in that PR vis-a-vis this version is that resources was moved into crates/ruff, which I think is also a fine thing to do too.)</p>
</blockquote>
<p>I can do that in t his PR too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-02-05 16:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>CONTRIBUTING.md</code>:157 on 2023-02-05 16:19</div>
            <div class="timeline-body"><p>I hope I got all these references correctly</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-02-05 16:35</div>
            <div class="timeline-body"><p>@charliermarsh I moved <code>ruff_dev</code> and the <code>resources</code> folders. But it's not clear to me why the ubuntu tests are failing now (they pass fine on my linux machine)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-05 16:45</div>
            <div class="timeline-body"><p>Hmm, I wonder if it has to do with the <code>docs/</code> in the <code>.gitignore</code>. The failing test (<code>packaging::tests::package_detection</code>) is relying on <code>&quot;./resources/test/project/examples/docs/docs&quot;</code>, which was introduced prior to that addition to the <code>.gitignore</code> -- but if that directory is being moved, Git might think it's being deleted.</p>
<p>(Will check locally -- this is just first instinct.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-02-05 16:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>CONTRIBUTING.md</code>:138 on 2023-02-05 16:50</div>
            <div class="timeline-body"><p>I think this is now say <code>crates/ruff/src/flake8_to_ruff/converter.rs</code>. (The path listed here was incorrect, this got moved around.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-02-05 16:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>scripts/add_plugin.py</code>:48 on 2023-02-05 16:54</div>
            <div class="timeline-body"><p>Was the inclusion of <code>./resources/test/fixtures/</code> here wrong before? (I think so?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-02-05 16:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>scripts/add_plugin.py</code>:48 on 2023-02-05 16:57</div>
            <div class="timeline-body"><p>Uh, I didn't notice that I removed the <code>test/fixtures</code> too. I just searched for the committed code and inferred the pattern from there.</p>
<p>https://github.com/charliermarsh/ruff/blob/c6887fa4d35d67971930b7d681f70bb561423ef5/crates/ruff/src/rules/tryceratops/mod.rs#L26-L29</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>scripts/add_plugin.py</code>:48 on 2023-02-05 16:58</div>
            <div class="timeline-body"><p>Yeah since <code>test_path</code> was introduced, I think the pattern we have now is correct. (IIRC, we do test these scripts on CI, but only that the code still compiles after running them, which wouldn't catch this issue.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-02-05 16:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-02-05 16:59</div>
            <div class="timeline-body"><blockquote>
<p>Hmm, I wonder if it has to do with the <code>docs/</code> in the <code>.gitignore</code>. The failing test (<code>packaging::tests::package_detection</code>) is relying on <code>&quot;./resources/test/project/examples/docs/docs&quot;</code>, which was introduced prior to that addition to the <code>.gitignore</code> -- but if that directory is being moved, Git might think it's being deleted.</p>
<p>(Will check locally -- this is just first instinct.)</p>
</blockquote>
<p>Yeah, that was it. Took me a while to figure out that the failure indicated a test failure and not that some command failed to run...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-05 17:00</div>
            <div class="timeline-body"><p>I <em>think</em> the CI output used to be clearer, and should be improved once #344 is released (we use <code>cargo insta test</code> to help us detect unreferenced snapshots).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-02-05 17:20</div>
            <div class="timeline-body"><p>This looks good to me! Thanks for rebasing, and for putting this together in the first place. It puts us in a much better position to start introducing some new crates.</p>
<p>Once again I checked out locally and ran <code>pip install .</code> to verify that the Python package is building + installing as expected.</p>
<p>I'll look to merge this later today.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-02-05 21:18</div>
            <div class="timeline-body"><p>(Rebasing...)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-02-05 21:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-02-05 21:47</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 04:54:13 UTC
    </footer>
</body>
</html>
