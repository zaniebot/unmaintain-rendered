<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Fix assertion for invalid match pattern - astral-sh/ruff #14306</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Fix assertion for invalid match pattern</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14306">#14306</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2024-11-13 08:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes a failing debug assertion that triggers for the following code:</p>
<pre><code class="language-py">match some_int:
    case x:=2:
        pass
</code></pre>
<p>closes #14305</p>
<h2>Test Plan</h2>
<p>Added problematic code example to corpus.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @sharkdp on 2024-11-13 08:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2024-11-13 08:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @sharkdp on 2024-11-13 08:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2024-11-13 08:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:4090 on 2024-11-13 08:12</div>
            <div class="timeline-body"><p>We could also go with</p>
<pre><code class="language-suggestion">                ast::ExprContext::Store | ast::ExprContext::Del =&gt; todo!(),
</code></pre>
<p>here (and below) for now, if we want to be more explicit about the fact that we can't handle this yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-11-13 08:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-13 08:26</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-11-13 08:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:4090 on 2024-11-13 08:53</div>
            <div class="timeline-body"><p>I prefer your current version â€” I think we want to be able to check as much code as possible without false positives right now... And you can think of a panic as just an exceptionally dramatic false positive ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-13 08:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2024-11-13 09:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2024-11-13 09:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-13 09:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @sharkdp on 2024-11-13 10:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-11-13 16:15</div>
            <div class="timeline-body"><p>We should probably be emitting diagnostics on invalid type expressions here, but that's a bigger scope project, so this looks good for now.</p>
<p>The more strange thing here is that we are using <code>infer_type_expression</code> for match patterns. I think that is probably not right, but fixing up match pattern type inference is also a bigger-scope project.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-13 19:32</div>
            <div class="timeline-body"><blockquote>
<p>The more strange thing here is that we are using <code>infer_type_expression</code> for match patterns. I think that is probably not right, but fixing up match pattern type inference is also a bigger-scope project.</p>
</blockquote>
<p>Did you see the comment in the related issue (https://github.com/astral-sh/ruff/issues/14305#issue-2654609039) on how that example is parsed? The problematic AST element is an annotated assignment statement, and not related to the match. We call <code>infer_type_expression</code> on the annotation expression, and that caused the problem.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-13 19:33</div>
            <div class="timeline-body"><p>And to be clear, we emit lots of <code>invalid-syntax</code> diagnostics here:</p>
<pre><code>error[invalid-syntax] /home/shark/playground/test.py:2:11 Expected ':', found ':='
error[invalid-syntax] /home/shark/playground/test.py:2:13 Invalid annotated assignment target
error[invalid-syntax] /home/shark/playground/test.py:2:15 Expected an expression
error[invalid-syntax] /home/shark/playground/test.py:3:1 Unexpected indentation
error[invalid-syntax] /home/shark/playground/test.py:4:1 Expected a statement
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-11-13 19:41</div>
            <div class="timeline-body"><p>No, I hadn't seen the issue yet, sorry. (I don't see new issues labeled red-knot automatically in my notifications, whereas CODEOWNERS means I always see PRs. I'd love to get notified on all issues tagged red-knot, but it seems like that is currently only possible with a third-party GH Action.) Now I understand what's happening here, thanks!</p>
<p>My comment about &quot;invalid type annotation&quot; diagnostics that we should emit was not related to the specific triggering example here, but to the code change in general. There are valid-syntax cases (<code>x: (y := 2) = 3</code>, for example) where we could end up with a Store-context Name node in a type expression, and we should have a diagnostic for that. (Not saying that it's a priority to do it now.)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:07:41 UTC
    </footer>
</body>
</html>
