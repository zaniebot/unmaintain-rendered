<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escape template filenames in glob patterns - astral-sh/ruff #16407</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Escape template filenames in glob patterns</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16407">#16407</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-02-26 22:17
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes #9381. This PR fixes errors like</p>
<pre><code>Cause: error parsing glob '/Users/me/project/{{cookiecutter.project_dirname}}/__pycache__': nested alternate groups are not allowed
</code></pre>
<p>caused by glob special characters in filenames like <code>{{cookiecutter.project_dirname}}</code>. When the user is matching that directory exactly, they can use the workaround given by https://github.com/astral-sh/ruff/issues/7959#issuecomment-1764751734, but that doesn't work for a nested config file with relative paths. For example, the directory tree in the reproduction repo linked <a href="https://github.com/astral-sh/ruff/issues/9381#issuecomment-2677696408">here</a>:</p>
<pre><code>.
├── README.md
├── hello.py
├── pyproject.toml
├── uv.lock
└── {{cookiecutter.repo_name}}
    ├── main.py
    ├── pyproject.toml
    └── tests
        └── maintest.py
</code></pre>
<p>where the inner <code>pyproject.toml</code> contains a relative glob:</p>
<pre><code class="language-toml">[tool.ruff.lint.per-file-ignores]
&quot;tests/*&quot; = [&quot;F811&quot;]
</code></pre>
<h2>Test Plan</h2>
<p>A new CLI test in both the linter and formatter. The formatter test may not be necessary because I didn't have to modify any additional code to pass it, but the original report mentioned both <code>check</code> and <code>format</code>, so I wanted to be sure both were fixed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ntBre on 2025-02-26 22:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-02-26 22:23</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-02-26 23:15</div>
            <div class="timeline-body"><p>I'm not sure what's going wrong on Windows. It looks like the <code>tempdir_filter</code> isn't working. I force pushed back over it, but I even tried removing my second filter <a href="https://github.com/astral-sh/ruff/actions/runs/13554843187/job/37886774376">here</a> and the temp path is still wrong.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @MichaReiser on 2025-02-27 07:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-27 07:59</div>
            <div class="timeline-body"><blockquote>
<p>I'm not sure what's going wrong on Windows. It looks like the <code>tempdir_filter</code> isn't working. I force pushed back over it, but I even tried removing my second filter <a href="https://github.com/astral-sh/ruff/actions/runs/13554843187/job/37886774376">here</a> and the temp path is still wrong.</p>
</blockquote>
<p>Yeah, the filters are brutal on windows. Can you try what we have in</p>
<p>https://github.com/astral-sh/ruff/blob/3e840ca839e40d875e28ff7f15c94d88c4d6e7ae/crates/red_knot/tests/cli.rs#L863-L865</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-27 08:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/settings/types.rs</code>:665 on 2025-02-27 08:02</div>
            <div class="timeline-body"><p>This, indeed, feels somewhat hacky :D</p>
<p>I think my main concern with this is that it replaces nested alternates anywhere in the glob -- even in the part that the user provided.</p>
<p>What I understand is that the problem is mainly about <code>{{</code> and <code>}}</code> in the base path up to the project. Could we escape the <code>{{</code> and <code>}}</code> in the project's base-path only instead of applying this fix to the entire glob?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-02-27 14:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/settings/types.rs</code>:665 on 2025-02-27 14:44</div>
            <div class="timeline-body"><p>That's true, although the nested alternates will always cause an error even if the user provided them. I thought it might be nice to allow them to avoid manual escaping in that case, but at least they <em>can</em> control that directly, unlike the base paths.</p>
<p>We could also add the escapes to the whole path just before creating the glob. I think that version would also look less hacky than catching this error and retrying, but then we also do the work of trying to replace each time. That was the main reason I tried to keep the replacement in the error case, but we're still only compiling the globs once, so it's probably not a big deal.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-02-27 15:05</div>
            <div class="timeline-body"><p>Just pushing a test for Windows, I haven't addressed the hacky path stuff yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-02-27 15:14</div>
            <div class="timeline-body"><p>It looks like the regex escapes in <code>tempdir_filter</code> are causing problems, but it works for all of the other tests using this...</p>
<pre><code>C:\/Users\/RUNNER~1\/AppData\/Local\/Temp\/.tmpCazbkF\\{{cookiecutter.repo_name}}\/tests\\*
</code></pre>
<p>OH, maybe it's the cookiecutter causing problems again. The escapes for the braces might be getting in the way of the tempdir replacement. Let me try nesting it one level deeper.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-27 15:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/settings/types.rs</code>:665 on 2025-02-27 15:14</div>
            <div class="timeline-body"><blockquote>
<p>That's true, although the nested alternates will always cause an error even if the user provided them. I thought it might be nice to allow them to avoid manual escaping in that case, but at least they can control that directly, unlike the base paths.</p>
</blockquote>
<p>The problem I see with this is that they may have wanted to use nested alternates and are now surprised that the glob doesn't match anything.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-27 15:15</div>
            <div class="timeline-body"><p>You can try to use <code>regex::escape</code> to avoid regex problems</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-02-27 15:19</div>
            <div class="timeline-body"><p><code>tempdir_filter</code> uses <code>regex::escape</code> already, unless I'm misunderstanding. My current guess is that the escapes added by <code>regex::escape</code> are disrupting the TMP replacement because they end up right next to the tempdir.</p>
<pre><code>C:\/Users\/RUNNER~1\/AppData\/Local\/Temp\/.tmpCazbkF\\{{cookiecutter.repo_name}}\/tests\\*
                                                     ^^^ this looks suspicious to me
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_linter/src/settings/types.rs</code>:659 on 2025-02-27 16:13</div>
            <div class="timeline-body"><p>This is also not <em>technically</em> right in all cases I think, e.g., <code>[{{]</code>, although that's pretty pathological.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-02-27 16:16</div>
            <div class="timeline-body"><p>Thanks for taking a look at this!</p>
<p>I think the thing I'm not understanding here is why nested alternates are the only problem here? Isn't the problem that we're using arbitrary input to build a glob? And shouldn't that imply the input (in this case, a file path) should always be escaped? Like, the nested alternates is just <em>one</em> way for this problem to manifest. But what if a file path had a <code>*</code> or a <code>[</code> in it? We would want to escape it there too.</p>
<p>So I guess, can we fix this by just always escaping the literal inputs to a glob?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-02-27 16:42</div>
            <div class="timeline-body"><p>Thanks for the review! I failed to notice the <code>globset::escape</code> function. I think we can just use that on the base part of the path that we're adding to the glob pattern. That will be much more robust than my manual escaping here and also leave the user's glob alone in case that's what they intended.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-02-27 19:48</div>
            <div class="timeline-body"><p>This is now a much simpler fix, thanks again for the reviews and suggestions! I also removed the warning, which was the source of the path in the snapshot, ~~so hopefully the Windows tests will pass too~~.</p>
<p>I realized it was also possible to trigger this for the non-absolute path, although in a pretty niche case. The test I added extends <code>per-file-ignores</code> with the working directory set to <code>tempdir/{{cookiecutter.repo_name}}</code>. I peeked at the implementation of <code>Path::absolutize</code> and it just calls <code>Path::absolutize_from</code> with <code>CWD</code> (via the private <code>get_cwd!</code> macro), so I think the change here should be safe.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-02-27 20:05</div>
            <div class="timeline-body"><p>I was checking for the other uses of <code>Glob::new</code>, and I think this could also be a problem for the <code>FilePath::User</code> variant.</p>
<p>https://github.com/astral-sh/ruff/blob/cf83584abb130574059064ad5f0dd806c22e45d5/crates/ruff_linter/src/settings/types.rs#L162-L166</p>
<p>I'll start adding the <code>escape</code> calls for it too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/settings/types.rs</code>:239 on 2025-02-28 08:01</div>
            <div class="timeline-body"><p>Can we introduce a <code>cwd</code> helper function in <code>fs</code>. WASM doesn't like <code>path_dedot::CWD</code></p>
<p>https://github.com/astral-sh/ruff/blob/e7a6c19e3a2c88d2eaad88a311c60fbd4e733c14/crates/ruff_linter/src/fs.rs#L36-L48</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/settings/types.rs</code>:335 on 2025-02-28 08:02</div>
            <div class="timeline-body"><p>Same here, let's avoid spreading <code>path_dedot::CWD</code> over our code base and instead use a helper to maximize WASM compatibility</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-02-28 08:02</div>
            <div class="timeline-body"><p>Nice, this looks great</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @MichaReiser on 2025-02-28 08:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2025-02-28 12:42</div>
            <div class="timeline-body"><p>LGTM</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/settings/types.rs</code>:239 on 2025-02-28 16:23</div>
            <div class="timeline-body"><p>Oh good idea, I factored this out into a <code>get_cwd</code> function and call it everywhere in the linter. I left the calls in the <code>ruff</code> and <code>ruff_workspace</code> crates alone for now. Should I replace those too?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-02-28 16:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-03-03 14:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-03-03 14:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-03-03 14:30</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:10:22 UTC
    </footer>
</body>
</html>
