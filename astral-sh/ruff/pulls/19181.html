<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Track open files in the server - astral-sh/ruff #19181</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Track open files in the server</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19181">#19181</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2025-07-07 14:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body">Summary
<p>Closes: astral-sh/ty#619</p>
<p>This PR changes the way files are being tracked in the ty server. Specifically, it makes the following changes for the respective notification handler:</p>
<ul>
<li><code>didOpen</code>: Add the <code>File</code> corresponding to the document that was opened in the open file set. This requires interning the <code>File</code> eagerly because previously it was interned only when it was required and not on open notification</li>
<li><code>didClose</code>: Remove the <code>File</code> corresponding to the document was is closed from the open file set</li>
</ul>
<p>Note: This PR on it&#x27;s own breaks workspace diagnostics because the diagnostic builder is only created if the file (that the diagnostic is being reported for) is open. This will be fixed in a follow-up PR (#19182).</p>
Test Plan
<p>Confirmed that workspace diagnostics break as expected (refer to the above note) and confirmed that it&#x27;s fixed by #19182).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-07 14:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-07 14:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-07 14:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-07 14:36</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-08 09:15</div>
            <div class="timeline-body"><p>I don&#x27;t think this approach works well with workspace diagnostics. If we start tracking open files using the existing open file set, then workspace diagnostics will stop working because the diagnostic builder checks if the file is open or not and avoids creating the builder if it&#x27;s not opened.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-08 09:26</div>
            <div class="timeline-body"><blockquote>
<p>I don&#x27;t think this approach works well with workspace diagnostics. If we start tracking open files using the existing open file set, then workspace diagnostics will stop working because the diagnostic builder checks if the file is open or not and avoids creating the builder if it&#x27;s not opened.</p>
</blockquote>
<p>It may require changing how we define <code>is_file_open</code> and how <code>CheckMode</code> works. That&#x27;s what I mentioned on the workspace diagnostics where I said we may want to make more changes. I haven&#x27;t thought it through fully but the simplest solution is to change how <code>is_file_open</code> defined (at least the version of it that the diagnostic builder uses) but it could also mean that we re-think how we check the &quot;open files only&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-08 12:26</div>
            <div class="timeline-body"><blockquote>
<p>It may require changing how we define <code>is_file_open</code> and how <code>CheckMode</code> works. That&#x27;s what I mentioned on the workspace diagnostics where I said we may want to make more changes. I haven&#x27;t thought it through fully but the simplest solution is to change how <code>is_file_open</code> defined (at least the version of it that the diagnostic builder uses) but it could also mean that we re-think how we check the &quot;open files only&quot;</p>
</blockquote>
<p>Thanks, I&#x27;d need to spend some time thinking through what this would look like. I&#x27;m not exactly sure what kind of change are you thinking for the <code>is_file_open</code> function because this would somehow require the <code>CheckMode</code> as parameter.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-08 12:34</div>
            <div class="timeline-body"><blockquote>
<p>Thanks, I&#x27;d need to spend some time thinking through what this would look like. I&#x27;m not exactly sure what kind of change are you thinking for the is_file_open function because this would somehow require the CheckMode as parameter.</p>
</blockquote>
<p>One option is to store the <code>CheckMode</code> on Project rather than passing it as an argument. This way it becomes stateful the same as many other properties on <code>Project</code>. We could then introduce a new <code>is_checked</code> or similar method that returns <code>true</code> if the file is included according to the selected <code>CheckMode</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-08 13:05</div>
            <div class="timeline-body"><blockquote>
<p>One option is to store the <code>CheckMode</code> on Project rather than passing it as an argument. This way it becomes stateful the same as many other properties on <code>Project</code>. We could then introduce a new <code>is_checked</code> or similar method that returns <code>true</code> if the file is included according to the selected <code>CheckMode</code>.</p>
</blockquote>
<p>I see. Yeah, that could work. We&#x27;ll need to add it to the <code>ProjectMetadata</code>. I was wondering if changing the check mode would invalidate the salsa cache which doesn&#x27;t seem useful because the diagnostics wouldn&#x27;t really change here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-08 13:54</div>
            <div class="timeline-body"><blockquote>
<p>I see. Yeah, that could work. We&#x27;ll need to add it to the ProjectMetadata. I was wondering if changing the check mode would invalidate the salsa cache which doesn&#x27;t seem useful because the diagnostics wouldn&#x27;t really change here.</p>
</blockquote>
<p>That&#x27;s a fair concern and yes, it would invalidate all type inference queries that try to emit a diagnostic. These shouldn&#x27;t be too many</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-07-08 14:45</div>
            <div class="timeline-body"><p>How does WorkspaceDiagnostic ever even get requested? I don&#x27;t see any obvious setting/selections for it in vscode. (Intuitively it seems like workspace/file mode is a thing a user would set once and forget about, and I went digging for the setting to confirm that, but now I have no clue.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-08 14:57</div>
            <div class="timeline-body"><p>@Gankra see https://github.com/astral-sh/ty/blob/main/docs/reference/editor-settings.md#diagnosticmode (you may need to update your extension)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-07-08 16:04</div>
            <div class="timeline-body"><p>Aha yes, I didn&#x27;t realize this was bleeding edge! Then yes I think it&#x27;s ~fine to thrash if you toggle this setting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-10 14:36</div>
            <div class="timeline-body"><p>I&#x27;m going to merge them in a single PR as I&#x27;m finding it difficult to maintain this stack.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-10 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-10 14:41</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:16:21 UTC
    </footer>
</body>
</html>
