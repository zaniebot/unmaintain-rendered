<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-pyi`] Always autofix `duplicate-union-members` (`PYI016`) - astral-sh/ruff #14270</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-pyi</code>] Always autofix <code>duplicate-union-members</code> (<code>PYI016</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14270">#14270</a>
        opened by <a href="https://github.com/sbrugman">@sbrugman</a>
        on 2024-11-11 12:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sbrugman">@sbrugman</a></div>
            <div class="timeline-body">

Summary
<p>This PR extends the autofix for <code>PYI016</code> so that it&#x27;s always available.</p>
<p>It also improves the fix for a few cases where the previous fix would give awkward (but valid) results:</p>
<p><code>int | (str | int)</code></p>
<pre><code>-`int | (str)`
+`int | str`
</code></pre>
<p>The fix now also marks as unsafe when comments are present.</p>


Test Plan


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/sbrugman">@sbrugman</a> on 2024-11-11 12:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-11 12:19</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+0 -0 violations, +0 -2 fixes in 1 projects; 53 projects unchanged)</p>
<a href="https://github.com/apache/airflow">apache/airflow</a> (+0 -0 violations, +0 -2 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --no-preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/apache/airflow/blob/1bd061df6e4409c5330d258d11fb7633e861a622/providers/src/airflow/providers/microsoft/azure/operators/container_instances.py#L253">providers/src/airflow/providers/microsoft/azure/operators/container_instances.py:253:43:</a> PYI016 Duplicate union member `VolumeMount`
- <a href="https://github.com/apache/airflow/blob/1bd061df6e4409c5330d258d11fb7633e861a622/providers/src/airflow/providers/microsoft/azure/operators/container_instances.py#L253">providers/src/airflow/providers/microsoft/azure/operators/container_instances.py:253:43:</a> PYI016 [*] Duplicate union member `VolumeMount`
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PYI016 | 2 | 0 | 0 | 0 | 2 |</p>
</p>


Linter (preview)
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+0 -0 violations, +8 -0 fixes in 2 projects; 52 projects unchanged)</p>
<a href="https://github.com/apache/superset">apache/superset</a> (+0 -0 violations, +2 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
- <a href="https://github.com/apache/superset/blob/58f9be9b85cfd34f861d232cf834c96747133a39/superset/models/helpers.py#L900">superset/models/helpers.py:900:39:</a> PYI016 Duplicate union member `str`
+ <a href="https://github.com/apache/superset/blob/58f9be9b85cfd34f861d232cf834c96747133a39/superset/models/helpers.py#L900">superset/models/helpers.py:900:39:</a> PYI016 [*] Duplicate union member `str`
</pre>

</p>

<a href="https://github.com/bokeh/bokeh">bokeh/bokeh</a> (+0 -0 violations, +6 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
- <a href="https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/core/property/factors.py#L51">src/bokeh/core/property/factors.py:51:56:</a> PYI016 Duplicate union member `tuple[str, str]`
+ <a href="https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/core/property/factors.py#L51">src/bokeh/core/property/factors.py:51:56:</a> PYI016 [*] Duplicate union member `tuple[str, str]`
- <a href="https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/core/property/factors.py#L52">src/bokeh/core/property/factors.py:52:85:</a> PYI016 Duplicate union member `tp.Sequence[tuple[str, str]]`
+ <a href="https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/core/property/factors.py#L52">src/bokeh/core/property/factors.py:52:85:</a> PYI016 [*] Duplicate union member `tp.Sequence[tuple[str, str]]`
- <a href="https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/plotting/contour.py#L43">src/bokeh/plotting/contour.py:43:88:</a> PYI016 Duplicate union member `ContourColor`
+ <a href="https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/plotting/contour.py#L43">src/bokeh/plotting/contour.py:43:88:</a> PYI016 [*] Duplicate union member `ContourColor`
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PYI016 | 8 | 0 | 0 | 8 | 0 |</p>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/duplicate_union_member.rs</code>:35 on 2024-11-11 12:58</div>
            <div class="timeline-body"><p>Is the reason to mark the fix as unsafe because it could remove comments or is it because it could lead to invalid syntax?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-11 13:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-11 13:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sbrugman">@sbrugman</a> reviewed on 2024-11-11 16:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sbrugman">@sbrugman</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/duplicate_union_member.rs</code>:111 on 2024-11-11 16:46</div>
            <div class="timeline-body"><p>I haven&#x27;t yet looked into in which cases the import request errors (and probably should handle it differently)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/duplicate_union_member.rs</code>:38 on 2024-11-12 09:59</div>
            <div class="timeline-body"><p>It&#x27;s not clear to me if we rather want to have a dedicate rule that detects and fixes unnecessarily nested unions but I&#x27;m fine keeping it in here for now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/duplicate_union_member.rs</code>:111 on 2024-11-12 10:00</div>
            <div class="timeline-body"><p>Yes, we can&#x27;t <code>unwrap</code> here and it will mean that we can&#x27;t mark this rule as always fixable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-12 10:02</div>
            <div class="timeline-body"><p>This is great. I have about the same comments as on the other PR:</p>
<ul>
<li>Using text-edits over generator has the advantage that the fix preserves (more) comments and the formatting. Is there a specific reason why you chose to rewrite the fix to being generator based</li>
<li>I need to go through some other rules but I think we decided not to mark fixes as unsafe just because they could drop comments.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sbrugman">@sbrugman</a> reviewed on 2024-11-12 10:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sbrugman">@sbrugman</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/duplicate_union_member.rs</code>:35 on 2024-11-12 10:23</div>
            <div class="timeline-body"><p>The motivation is that comments might cause information loss (e.g. link to an issue, why a certain annotation was chosen) and the developer should be able to review this as possible. Marking comments as unsafe, users are able to automatically fix all other cases (comments inside type annotations are rare), and carefully review unsafe fixes.</p>
<p>Syntactically all is fine (edit: unless comments have semantics attached, e.g. <code>type: ignore</code>).</p>
<p>If there was a decision to mark comments as safe and instead document this in the rule, I can change it to that. If so, shall we then draw that as a conclusion on <a href="https://github.com/astral-sh/ruff/issues/9790">astral-sh/ruff#9790</a> and document it?</p>
<p>I see the point that removing comments is not &quot;unsafe&quot; in terms of possibly generating invalid syntax, but it is a way for users to automatically disambiguate between fixes that need careful review and which could be always applied instead of having to go through each &quot;Fix safety&quot; section in the docs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sbrugman">@sbrugman</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/duplicate_union_member.rs</code>:38 on 2024-11-12 10:30</div>
            <div class="timeline-body"><p>The reasons for removing the item are different: one is because of exact duplicates, the other because <code>complex</code> implies <code>float</code> and <code>int</code>. There are cases where libs prefer being explicit and disable the second rule (stdlib random is an example).</p>
<p>A dedicated rule for flatten a nested union could also work, but then should always be enabled together with these rules to clean up the fix result.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sbrugman">@sbrugman</a> reviewed on 2024-11-12 10:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sbrugman">@sbrugman</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/duplicate_union_member.rs</code>:35 on 2024-11-12 10:36</div>
            <div class="timeline-body"><p>In the other thread I see the suggestion to not offer a fix when comments are present, shall I continue in that direction?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sbrugman">@sbrugman</a> reviewed on 2024-11-12 10:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sbrugman">@sbrugman</a> reviewed on 2024-11-12 10:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sbrugman">@sbrugman</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/duplicate_union_member.rs</code>:35 on 2024-11-12 10:41</div>
            <div class="timeline-body"><p>@MichaReiser I recall I saw this as tweaks one previous PR, so that&#x27;s why I took it as policy:
<a href="https://github.com/astral-sh/ruff/pull/14008">astral-sh/ruff#14008</a>/commits/f099b0d371e25f4c87ae881309bf853931b18fc1</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-12 10:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/duplicate_union_member.rs</code>:35 on 2024-11-12 10:43</div>
            <div class="timeline-body"><blockquote>
<p>In the other thread I see the suggestion to not offer a fix when comments are present, shall I continue in that direction?</p>
</blockquote>
<p>Yes. I spent some more time in that review to see what we do in other places and not offering a fix is the most common. I suggest that we align the behavior here and revisit the decision holistically if we see need for it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-13 09:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/duplicate_union_member.rs</code>:35 on 2024-11-13 09:06</div>
            <div class="timeline-body"><p>It&#x27;s good that you waited with changing the applicability. We discussed it internally thanks to you and we agree that we should mark such rules as unsafe. See <a href="https://github.com/astral-sh/ruff/pull/14300">astral-sh/ruff#14300</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-13 09:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/duplicate_union_member.rs</code>:123 on 2024-11-13 09:06</div>
            <div class="timeline-body"><p>Let&#x27;s gate the fix behind preview for now to get some testing in</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-11-13 09:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-13 16:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-13 16:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-13 16:44</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:08:22 UTC
    </footer>
</body>
</html>
