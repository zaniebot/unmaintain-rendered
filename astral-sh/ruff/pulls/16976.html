<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`airflow`] Add autofix for `AIR302` method checks - astral-sh/ruff #16976</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>airflow</code>] Add autofix for <code>AIR302</code> method checks</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16976">#16976</a>
        opened by <a href="https://github.com/Lee-W">@Lee-W</a>
        on 2025-03-26 08:09
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Lee-W">@Lee-W</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<!-- What's the purpose of the change? What does it do, and why? -->

<p>Add autofix logic to AIR302 check_method</p>
<h2>Test Plan</h2>
<!-- How was it tested? -->

<p>test fixtures have been updated accordingly</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Lee-W">@Lee-W</a> on 2025-03-26 08:09</div>
            <div class="timeline-body"><p>based on https://github.com/astral-sh/ruff/pull/16975</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-26 08:15</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>ℹ️ ecosystem check <strong>encountered linter errors</strong>. (no lint changes; 1 project error)</p>
<details><summary><a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --no-preview --select A,E703,F704,B015,B018,D100</pre>
</p>
<p>

<pre><code>Failed to clone openai/openai-cookbook: error: 4282 bytes of body are still expected
fetch-pack: unexpected disconnect while reading sideband packet
fatal: early EOF
fatal: fetch-pack: invalid index-pack output
</code></pre>
</p>
</details>

<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @Lee-W on 2025-03-27 19:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-03-31 20:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/airflow/rules/removal_in_3.rs</code>:511 on 2025-03-31 20:59</div>
            <div class="timeline-body"><p>We can avoid the clone here by creating the <code>Fix</code>, before creating the <code>Diagnostic</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/airflow/rules/removal_in_3.rs</code>:511 on 2025-03-31 21:02</div>
            <div class="timeline-body"><p>Here's the patch as I can't push it to the branch:</p>
<pre><code class="language-diff">diff --git a/crates/ruff_linter/src/rules/airflow/rules/removal_in_3.rs b/crates/ruff_linter/src/rules/airflow/rules/removal_in_3.rs
index 2111b60b3..fc9f40551 100644
--- a/crates/ruff_linter/src/rules/airflow/rules/removal_in_3.rs
+++ b/crates/ruff_linter/src/rules/airflow/rules/removal_in_3.rs
@@ -72,7 +72,7 @@ impl Violation for Airflow3Removal {
     }
 }
 
-#[derive(Debug, Clone, Eq, PartialEq)]
+#[derive(Debug, Eq, PartialEq)]
 enum Replacement {
     None,
     Name(&amp;'static str),
@@ -505,18 +505,25 @@ fn check_method(checker: &amp;Checker, call_expr: &amp;ExprCall) {
         }
     };
 
+    // Create the `Fix` first to avoid cloning `Replacement`.
+    let fix = if let Replacement::Name(name) = replacement {
+        Some(Fix::safe_edit(Edit::range_replacement(
+            name.to_string(),
+            attr.range(),
+        )))
+    } else {
+        None
+    };
+
     let mut diagnostic = Diagnostic::new(
         Airflow3Removal {
             deprecated: attr.to_string(),
-            replacement: replacement.clone(),
+            replacement,
         },
         attr.range(),
     );
-    if let Replacement::Name(name) = replacement {
-        diagnostic.set_fix(Fix::safe_edit(Edit::range_replacement(
-            name.to_string(),
-            attr.range(),
-        )));
+    if let Some(fix) = fix {
+        diagnostic.set_fix(fix);
     }
     checker.report_diagnostic(diagnostic);
 }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-03-31 21:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @dhruvmanila on 2025-03-31 21:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @dhruvmanila on 2025-03-31 21:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[airflow] add autofix to AIR302 check_method" to "[`airflow`] Add autofix for `AIR302` method checks" by @dhruvmanila on 2025-03-31 21:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Lee-W">@Lee-W</a> reviewed on 2025-04-01 07:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Lee-W">@Lee-W</a> on <code>crates/ruff_linter/src/rules/airflow/rules/removal_in_3.rs</code>:511 on 2025-04-01 07:28</div>
            <div class="timeline-body"><p>just updated. Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2025-04-02 15:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2025-04-02 15:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:11:00 UTC
    </footer>
</body>
</html>
