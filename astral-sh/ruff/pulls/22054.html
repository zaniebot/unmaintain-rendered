<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add minimum fix safety to violation metadata - astral-sh/ruff #22054</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add minimum fix safety to violation metadata</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22054">#22054</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-12-18 17:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/ntBre">@ntBre</a> on 2025-12-18 17:47</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>I included fix safety in my draft of default rule criteria, but there's no
existing way to retrieve the safety of a rule's fixes. This PR is a quick draft of adding
this information to the <code>violation_metadata</code> attribute macro and then enforcing
its accuracy in our <code>test_contents</code> linter tests. The tests are failing here
because I wanted to gauge interest in adding this feature before adding all of
the proper attributes on the affected rules.</p>
<p>A couple of things I think we can do with this information:</p>
<ul>
<li>include it in the <code>ruff rule --output-format=json</code> (this would help my default
rules work)</li>
<li>display it in our docs along with the fix availability</li>
<li>enforce the presence of a <code>## Fix safety</code> section for rules with unsafe or
display-only fixes</li>
</ul>
<p>It's a bit annoying to add all these attributes again, but at least this one has
a sensible default (<code>Applicability::Safe</code>), which will work for safe rules and
rules without fixes.</p>
<p>I went with a string attribute again to avoid requiring <code>Applicability</code> imports
everywhere, but it would also be nice to make the attribute more like:</p>
<pre><code class="language-rust"> #[violation_metadata(safety = Applicability::Safe)]
</code></pre>
<p>instead of the current:</p>
<pre><code class="language-rust"> #[violation_metadata(safety = &quot;safe&quot;)]
</code></pre>
<h2>Test Plan</h2>
<p>Updated <code>test_contents</code> to fail if a diagnostic's attached fix is less safe than
its documented safety</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-12-18 17:50</div>
            <div class="timeline-body"><p>I'm a bit concerned about us forgetting to update the applicability but maybe it's fine thanks to the test integration?</p>
<p>It's just that always fixable is already something that's very easy to get outdated and adding more such information doesn't make me too excited :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-18 17:54</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-12-18 17:57</div>
            <div class="timeline-body"><p>Yeah I definitely wouldn't want this without the test integration. The existing integration also only enforces the minimum safety, so setting <code>safety = &quot;display-only&quot;</code> everywhere would pass all tests, <em>and</em> it only checks the safety of tests that run, so it won't be enforced if we're missing an unsafe test case, for example. So it's not without limitations.</p>
<p>I'm happy to close this if you think it will be too annoying to keep updated or correct. Just a quick proof of concept if it sounded interesting!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-12-19 15:29</div>
            <div class="timeline-body"><p>(Not trying to push this forward with the additional commits, necessarily. I just added the pieces I needed for my own data analysis)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:36:42 UTC
    </footer>
</body>
</html>
