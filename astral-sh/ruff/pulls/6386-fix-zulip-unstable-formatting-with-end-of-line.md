```yaml
number: 6386
title: Fix zulip unstable formatting with end-of-line comments
type: pull_request
state: merged
author: konstin
labels:
  - formatter
assignees: []
merged: true
base: main
head: fix_zulip_unstable_formatting
created_at: 2023-08-07T11:01:00Z
updated_at: 2023-08-08T09:42:28Z
url: https://github.com/astral-sh/ruff/pull/6386
synced_at: 2026-01-12T02:52:04Z
```

# Fix zulip unstable formatting with end-of-line comments

---

_Pull request opened by @konstin on 2023-08-07 11:01_

## Bug

Given
```python
x = () - (#
)
```
the comment is a dangling comment of the empty tuple. This is an end-of-line comment so it may move after the expression. It still expands the parent, so the operator breaks:
```python
x = (
    ()
    - ()  #
)
```
In the next formatting pass, the comment is not a trailing tuple but a trailing bin op comment, so the bin op doesn't break anymore. The comment again expands the parent, so we still add the superfluous parentheses
```python
x = (
    () - ()  #
)
```

## Fix

The new formatting is to keep the comment on the empty tuple. This is a log uglier and again has additional outer parentheses, but it's stable:
```python
x = (
    ()
    - (  #
    )
)
```

## Alternatives

Black formats all the examples above as
```python
x = () - ()  #
```
which i find better. 

I would be happy about any suggestions for better solutions than the current one. I'd mainly need a workaround for expand parent having an effect on the bin op instead of first moving the comment to the end and then applying expand parent to the assign statement.


---

_Comment by @konstin on 2023-08-07 11:01_

Current dependencies on/for this PR:
* main
  * **PR #6386** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6386" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6386?utm_source=stack-comment).

---

_Label `formatter` added by @konstin on 2023-08-07 11:04_

---

_Comment by @github-actions[bot] on 2023-08-07 11:28_

## PR Check Results
### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      8.1Â±0.02ms     5.0 MB/sec    1.04      8.5Â±0.07ms     4.8 MB/sec
formatter/numpy/ctypeslib.py               1.00   1612.1Â±9.05Âµs    10.3 MB/sec    1.04  1669.3Â±11.53Âµs    10.0 MB/sec
formatter/numpy/globals.py                 1.00    184.8Â±5.80Âµs    16.0 MB/sec    1.00    184.7Â±1.01Âµs    16.0 MB/sec
formatter/pydantic/types.py                1.00      3.4Â±0.04ms     7.4 MB/sec    1.04      3.6Â±0.05ms     7.1 MB/sec
linter/all-rules/large/dataset.py          1.00     10.2Â±0.25ms     4.0 MB/sec    1.01     10.2Â±0.37ms     4.0 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      2.7Â±0.06ms     6.2 MB/sec    1.00      2.7Â±0.00ms     6.2 MB/sec
linter/all-rules/numpy/globals.py          1.00    377.2Â±0.61Âµs     7.8 MB/sec    1.00    378.4Â±0.86Âµs     7.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      4.6Â±0.01ms     5.5 MB/sec    1.00      4.6Â±0.04ms     5.5 MB/sec
linter/default-rules/large/dataset.py      1.00      5.2Â±0.02ms     7.8 MB/sec    1.00      5.3Â±0.02ms     7.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1129.1Â±6.93Âµs    14.7 MB/sec    1.01   1136.6Â±9.73Âµs    14.6 MB/sec
linter/default-rules/numpy/globals.py      1.00    127.8Â±0.88Âµs    23.1 MB/sec    1.00    128.2Â±0.31Âµs    23.0 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.3Â±0.00ms    10.9 MB/sec    1.01      2.4Â±0.01ms    10.8 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.04     10.3Â±0.26ms     4.0 MB/sec    1.00      9.8Â±0.09ms     4.1 MB/sec
formatter/numpy/ctypeslib.py               1.00  1905.3Â±23.53Âµs     8.7 MB/sec    1.00  1897.2Â±30.10Âµs     8.8 MB/sec
formatter/numpy/globals.py                 1.00    210.8Â±4.89Âµs    14.0 MB/sec    1.00    209.8Â±7.93Âµs    14.1 MB/sec
formatter/pydantic/types.py                1.00      4.2Â±0.04ms     6.1 MB/sec    1.01      4.2Â±0.13ms     6.0 MB/sec
linter/all-rules/large/dataset.py          1.03     12.8Â±0.43ms     3.2 MB/sec    1.00     12.5Â±0.13ms     3.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.4Â±0.03ms     4.8 MB/sec    1.01      3.5Â±0.09ms     4.8 MB/sec
linter/all-rules/numpy/globals.py          1.00    422.0Â±5.58Âµs     7.0 MB/sec    1.00    423.3Â±8.92Âµs     7.0 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.8Â±0.08ms     4.4 MB/sec    1.01      5.9Â±0.21ms     4.3 MB/sec
linter/default-rules/large/dataset.py      1.00      6.8Â±0.07ms     6.0 MB/sec    1.00      6.7Â±0.07ms     6.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1380.4Â±10.52Âµs    12.1 MB/sec    1.01  1387.9Â±21.57Âµs    12.0 MB/sec
linter/default-rules/numpy/globals.py      1.01    159.4Â±3.49Âµs    18.5 MB/sec    1.00    158.0Â±2.54Âµs    18.7 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.0Â±0.04ms     8.5 MB/sec    1.00      3.0Â±0.04ms     8.5 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_@MichaReiser reviewed on 2023-08-07 11:46_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/builders.rs`:265 on 2023-08-07 11:46_

What's our motivation to keep the trailing end of line comments on the same line as the opening parentheses? 

I prefer

```python
x = () - (
	# comment
)
```

over 

```python
x = () - ( # comment
)
```

---

_@konstin reviewed on 2023-08-07 11:51_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/builders.rs`:265 on 2023-08-07 11:51_

Turning an end-of-line comment into an own line comment leads to unstable formatting by the two spaces we insert after the line, so we need turn one comment kind into the other atm.

From a style perspective i prefer black with `()  # comment`

---

_Comment by @MichaReiser on 2023-08-07 11:51_

> I would be happy about any suggestions for better solutions than the current one. I'd mainly need a workaround for expand parent having an effect on the bin op instead of first moving the comment to the end and then applying expand parent to the assign statement.

This isn't possible without moving the comment inside of `placement.rs`. I personally prefer if the formatter doesn't move my comments out of the parenthesis, because it does change the semantics of the comment:

```python
a = call([ 	# empty because of x
], b) + []
```

I prefer:

```python
a = call(
	[ 	
		# empty because of x
	], 
	b
) 	+ []
```

Over 

```python
a = call([], b) + [] # empty because of x
```

Because it is now unclear what the comment refers to

---

_Comment by @charliermarsh on 2023-08-07 12:39_

I havenâ€™t reviewed yet but just want to confirm - is this still necessary after my two PRs that get the stability checks passing?

---

_Comment by @konstin on 2023-08-07 12:52_

I think so, this is a slightly different case (empty tuple vs. empty function) that the minimizer stumbled into because you can get to it by removing the function. I'll rebase and check again once the other PRs are merged

---

_@MichaReiser reviewed on 2023-08-07 13:10_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/builders.rs`:265 on 2023-08-07 13:10_

> Turning an end-of-line comment into an own line comment leads to unstable formatting by the two spaces we insert after the line, 

We shouldn't insert the two empty spaces in that case. We just format them as own line comments.

---

_@MichaReiser approved on 2023-08-07 17:39_

---

_Comment by @charliermarsh on 2023-08-07 18:06_

Okay, should be all-clear to rebase.

---

_@MichaReiser reviewed on 2023-08-08 07:25_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/tests/snapshots/format@statement__delete.py.snap`:222 on 2023-08-08 07:25_

Can we add a test case of a empty parenthesized that has a trailing end of line and own line comments?

---

_Merged by @konstin on 2023-08-08 09:15_

---

_Closed by @konstin on 2023-08-08 09:15_

---

_Branch deleted on 2023-08-08 09:15_

---
