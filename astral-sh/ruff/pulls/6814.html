<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extend `BestFitting` with `mode` - astral-sh/ruff #6814</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Extend <code>BestFitting</code> with <code>mode</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6814">#6814</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-08-23 12:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR brings back the best fitting mode first introduced by https://github.com/astral-sh/ruff/pull/5184 and later reverted by https://github.com/astral-sh/ruff/commit/9a8ba58b4cbb2dcbebfe1397ebdb867b641e30ce because it was no longer necessary for the binary expression formatting.</p>
<p>This PR re-introduces the <code>BestFitting</code> mode to implement Black's behavior to only parenthesize non-breakable expressions if it makes them fit https://github.com/astral-sh/ruff/issues/6271.</p>
<pre><code class="language-python">x = aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
x_aaaa = aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa

# Output
x = aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
x_aaaa = (
	aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
)
</code></pre>
<p>This layout needs Best Fitting because with the new mode because</p>
<ul>
<li>it has three variations (not just two): flat, with parentheses, and flat as fallback</li>
<li>Best fitting by default assumes that the content fits when reaching the first line break. This doesn't work for this use case because we need to measure if all content up to the <code>)</code> fits (this is kind of the point)</li>
</ul>
<h2>Test Plan</h2>
<p>Re-added tests. Used by the stacked PRs</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-23 12:10</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #6814</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6814" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ<ul>
<li><strong>PR #6815</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6815" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #6816</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6816" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #6817</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6817" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #6848</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6848" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a></li>
<li><strong>PR #6819</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6819" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6814?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-08-23 12:36</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      4.0Â±0.19ms    10.1 MB/sec    1.00      4.0Â±0.12ms    10.1 MB/sec
formatter/numpy/ctypeslib.py               1.00   835.9Â±40.45Âµs    19.9 MB/sec    1.02   854.6Â±59.01Âµs    19.5 MB/sec
formatter/numpy/globals.py                 1.01     83.7Â±3.42Âµs    35.2 MB/sec    1.00     82.5Â±3.50Âµs    35.8 MB/sec
formatter/pydantic/types.py                1.01  1662.0Â±83.73Âµs    15.3 MB/sec    1.00  1650.3Â±50.47Âµs    15.5 MB/sec
linter/all-rules/large/dataset.py          1.00     12.3Â±0.27ms     3.3 MB/sec    1.01     12.4Â±0.32ms     3.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.3Â±0.10ms     5.1 MB/sec    1.00      3.2Â±0.06ms     5.1 MB/sec
linter/all-rules/numpy/globals.py          1.02   482.4Â±21.24Âµs     6.1 MB/sec    1.00   473.3Â±16.10Âµs     6.2 MB/sec
linter/all-rules/pydantic/types.py         1.01      6.5Â±0.19ms     3.9 MB/sec    1.00      6.4Â±0.15ms     4.0 MB/sec
linter/default-rules/large/dataset.py      1.01      6.6Â±0.13ms     6.2 MB/sec    1.00      6.5Â±0.15ms     6.2 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1434.9Â±53.55Âµs    11.6 MB/sec    1.00  1434.4Â±51.23Âµs    11.6 MB/sec
linter/default-rules/numpy/globals.py      1.00    174.2Â±6.46Âµs    16.9 MB/sec    1.02    177.0Â±9.12Âµs    16.7 MB/sec
linter/default-rules/pydantic/types.py     1.02      3.0Â±0.09ms     8.6 MB/sec    1.00      2.9Â±0.07ms     8.7 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01      3.0Â±0.04ms    13.4 MB/sec    1.00      3.0Â±0.02ms    13.5 MB/sec
formatter/numpy/ctypeslib.py               1.00    574.8Â±8.43Âµs    29.0 MB/sec    1.01    578.6Â±8.48Âµs    28.8 MB/sec
formatter/numpy/globals.py                 1.00     58.0Â±0.78Âµs    50.9 MB/sec    1.02     59.3Â±1.27Âµs    49.7 MB/sec
formatter/pydantic/types.py                1.00  1206.5Â±16.21Âµs    21.1 MB/sec    1.00  1202.1Â±15.30Âµs    21.2 MB/sec
linter/all-rules/large/dataset.py          1.00      9.4Â±0.19ms     4.3 MB/sec    1.02      9.6Â±0.10ms     4.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      2.6Â±0.06ms     6.3 MB/sec    1.02      2.7Â±0.04ms     6.2 MB/sec
linter/all-rules/numpy/globals.py          1.00    272.1Â±7.74Âµs    10.8 MB/sec    1.02    277.9Â±9.48Âµs    10.6 MB/sec
linter/all-rules/pydantic/types.py         1.00      4.9Â±0.17ms     5.2 MB/sec    1.01      5.0Â±0.13ms     5.1 MB/sec
linter/default-rules/large/dataset.py      1.00      5.2Â±0.09ms     7.8 MB/sec    1.01      5.2Â±0.06ms     7.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1073.7Â±17.95Âµs    15.5 MB/sec    1.02  1100.2Â±21.05Âµs    15.1 MB/sec
linter/default-rules/numpy/globals.py      1.00    108.5Â±1.53Âµs    27.2 MB/sec    1.00    108.8Â±1.64Âµs    27.1 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.4Â±0.03ms    10.7 MB/sec    1.00      2.4Â±0.03ms    10.7 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Re-introduce mode for `BestFitting`" to "Extend `BestFitting` with `mode`" by @MichaReiser on 2023-08-23 13:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2023-08-23 13:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_benchmark/benches/formatter.rs</code>:54 on 2023-08-23 13:39</div>
            <div class="timeline-body"><p>I got very flacky results without this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-23 13:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2023-08-23 13:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-23 15:23</div>
            <div class="timeline-body"><p>I'll merge this without review. You already reviewed the original PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-08-23 15:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-08-23 15:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-08-23 15:23</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:59:45 UTC
    </footer>
</body>
</html>
