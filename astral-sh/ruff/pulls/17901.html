<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] fix assigning a typevar to a union with itself - astral-sh/ruff #17901</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] fix assigning a typevar to a union with itself</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17901">#17901</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2025-05-06 23:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body">Summary
<p>Noticed in <a href="https://github.com/astral-sh/ruff/pull/17800">astral-sh/ruff#17800</a> that a typevar was not considered assignable to a union containing itself.</p>
<p>A bound typevar <code>T: int</code> must be assignable to e.g. <code>int | None</code> but must also be assignable to e.g. <code>T | None</code>. There&#x27;s no way to order the bound/constrained-typevar and union arms of <code>is_subtype_of</code> and <code>is_assignable_to</code> that would achieve both of these; it requires trying the recursive union treatment for one possibility (treat the typevar as itself), and then if that fails, also trying it for the other possibility (treat the typevar as its bound/constraints).</p>
<p>It doesn&#x27;t work to just put the union case first and let the typevar bound/constraint handling happen one level deeper, because then we fail to consider e.g. <code>T: (X, Y)</code> a subtype of <code>X | Y</code> -- we would separately try <code>X | Y &lt;: X</code> and <code>X | Y &lt;: Y</code>, and both fail. (There&#x27;s already a test for this, fortunately, or I probably would have pushed the simpler fix that breaks it.)</p>
Test Plan
<p>Added mdtest.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/carljm">@carljm</a> on 2025-05-06 23:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/carljm">@carljm</a> on 2025-05-06 23:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/carljm">@carljm</a> on 2025-05-06 23:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/carljm">@carljm</a> on 2025-05-06 23:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-05-06 23:42</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>kopf (https://github.com/nolar/kopf)
- error[lint:invalid-assignment] kopf/_cogs/aiokits/aioenums.py:54:9: Object of type `FlagReasonT | Unknown` is not assignable to `FlagReasonT | None`
- Found 227 diagnostics
+ Found 226 diagnostics

mkosi (https://github.com/systemd/mkosi)
- error[lint:invalid-return-type] mkosi/config.py:1092:16: Return type does not match returned value: Expected `SE | None`, found `SE`
- Found 327 diagnostics
+ Found 326 diagnostics

operator (https://github.com/canonical/operator)
- error[lint:invalid-argument-type] ops/pebble.py:1833:67: Argument to this function is incorrect: Expected `AnyStr | None`, found `AnyStr`
- Found 208 diagnostics
+ Found 207 diagnostics

setuptools (https://github.com/pypa/setuptools)
- error[lint:invalid-return-type] setuptools/_distutils/spawn.py:38:16: Return type does not match returned value: Expected `_MappingT | dict[str, str | int] | None`, found `_MappingT | None`
- Found 1212 diagnostics
+ Found 1211 diagnostics

arviz (https://github.com/arviz-devs/arviz)
- error[lint:invalid-return-type] arviz/data/inference_data.py:972:20: Return type does not match returned value: Expected `InferenceDataT | None`, found `InferenceDataT`
- error[lint:invalid-return-type] arviz/data/inference_data.py:1052:20: Return type does not match returned value: Expected `InferenceDataT | None`, found `InferenceDataT`
- Found 2605 diagnostics
+ Found 2603 diagnostics

streamlit (https://github.com/streamlit/streamlit)
- error[lint:invalid-return-type] lib/streamlit/elements/lib/options_selector_utils.py:121:16: Return type does not match returned value: Expected `E1 | E2`, found `E1`
- error[lint:invalid-return-type] lib/streamlit/elements/lib/options_selector_utils.py:131:16: Return type does not match returned value: Expected `E1 | E2`, found `E1`
- error[lint:invalid-return-type] lib/streamlit/elements/lib/options_selector_utils.py:150:16: Return type does not match returned value: Expected `E1 | E2`, found `E1`
- Found 3291 diagnostics
+ Found 3288 diagnostics

</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-05-06 23:45</div>
            <div class="timeline-body"><p>Not a huge number of false positives from this, but the ecosystem results all look like fixing false positives.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/LaBatata101">@LaBatata101</a> on 2025-05-07 01:36</div>
            <div class="timeline-body"><p>What does this <code>X | Y &lt;: X</code> notation means?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-05-07 03:19</div>
            <div class="timeline-body"><blockquote>
<p>What does this <code>X | Y &lt;: X</code> notation means?</p>
</blockquote>
<p><code>&lt;:</code> means &quot;is a subtype of&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-07 10:55</div>
            <div class="timeline-body"><p>It would be awesome if we could add a property test for this, but that obviously doesn&#x27;t need to be done in this PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-05-07 10:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types.rs</code>:1277 on 2025-05-07 10:58</div>
            <div class="timeline-body"><pre><code>        // be both a subtype of `int` and a subtype of e.g. `T | None`, so we need to also try
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-07 11:49</div>
            <div class="timeline-body"><p>I proposed a more targeted fix which I like somewhat more in <a href="https://github.com/astral-sh/ruff/pull/17910">astral-sh/ruff#17910</a> -- WDYT?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-05-07 14:03</div>
            <div class="timeline-body"><p>Closing in favor of <a href="https://github.com/astral-sh/ruff/pull/17910">astral-sh/ruff#17910</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2025-05-07 14:03</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:14:07 UTC
    </footer>
</body>
</html>
