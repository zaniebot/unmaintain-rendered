<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add tests for list expression parsing - astral-sh/ruff #10554</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add tests for list expression parsing</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10554">#10554</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-03-25 03:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR updates the existing valid test case for list expression and adds some invalid ones to check how the parser is recovering. It also updates the parsing function used to match the grammar.</p>
<p>The goal is mainly to check if the list parsing is correct or not as per the grammar.</p>
<p>There are test cases for unclosed bracket where the parser sometimes doesn't recover well or doesn't provide useful error messages. I think these will be improved by feeding the information back to the lexer. The lexer could then emit <code>Newline</code> where appropriate instead of <code>NonLogicalNewline</code> and the recovery set could include the <code>Newline</code> as the list terminator to recover from it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by @dhruvmanila on 2024-03-25 03:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by @dhruvmanila on 2024-03-25 03:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-25 12:32</div>
            <div class="timeline-body"><p>I need to do starred expression first before I can add related invalid test cases here as the parser is allowing syntax like <code>[1, * *name, 2]</code> and parsing it as nested starred expression.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:1264 on 2024-03-27 09:09</div>
            <div class="timeline-body"><p>What we will be doing is to use a more general rule for the first element as we don't yet know whether it's a comprehension or a normal list. For comprehension, we'll report an error later if a starred expression is being used.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-27 09:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dhruvmanila on 2024-03-27 09:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2024-03-27 09:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-03-27 09:39</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/tests/snapshots/invalid_syntax@expressions__list__missing_closing_bracket_0.py.snap</code>:26 on 2024-03-27 09:42</div>
            <div class="timeline-body"><p>Does the parser not generate an error message when parsing out an invalid name or is it because it de-duplicates the error messages?</p>
<p>Nit: I know this PR doesn't focus on recovery but you already touched that code, so I'll bring it up anyway. I think here it would be better to <strong>not</strong> create an empty name because
the parser now hallucinates elements that don't exist in the source. Instead, we should check if the parser is at an expression and only then parse it out.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:1453 on 2024-03-27 09:46</div>
            <div class="timeline-body"><p>Nit: We could consider keeping <code>parse_named_expression_or_higher</code> where it simply calls `self.parse_star_expression_or_higher(AllowNamedExpression::Yes)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-03-27 09:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-03-27 09:47</div>
            <div class="timeline-body"><p>Nice. I like the extensive tests. I think there's one invalid case that we could improve but we don't have to do this today. I recommend adding a TODO or creating an issue (maybe a tracking issue with all error recovery that needs improving) if you decide to improve it later</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-03-27 09:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:1264 on 2024-03-27 09:53</div>
            <div class="timeline-body"><p>You say that we report an error later. I wasn't able to spot the error reporting right away. Is this something you plan to add later (including tests)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-28 09:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:1264 on 2024-03-28 09:46</div>
            <div class="timeline-body"><p>Yes, it was added in the list comprehension PR. Sorry, I should've made that clear.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-28 09:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:1453 on 2024-03-28 09:48</div>
            <div class="timeline-body"><p>I don't understand this. Both methods correspond to different grammar rule. <code>parse_named_expression_or_higher</code> is for <code>named_expression</code> which does not limit the precedence of a starred expression while <code>parse_star_expression_or_higher</code> is a either  <code>star_expression</code> or <code>star_named_expression</code> where the starred expression should have a minimum precedence of a bitwise or (<code>|</code>) operator.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-28 09:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/tests/snapshots/invalid_syntax@expressions__list__missing_closing_bracket_0.py.snap</code>:26 on 2024-03-28 09:49</div>
            <div class="timeline-body"><p>I agree. I'll look into this for all container types (list, set, tuples, dict)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-03-28 10:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:1453 on 2024-03-28 10:04</div>
            <div class="timeline-body"><p>Ah okay, that was not clear to me from reviewing the PR. I assumed it was simply a rename (because you changed all call sites but what i understand from your comment is that this isn't the case and this PR instead changes the parse rule)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-28 10:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:1453 on 2024-03-28 10:06</div>
            <div class="timeline-body"><p>Yes, it changes to use the correct grammar rule for list expressions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2024-03-29 08:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-03-29 08:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-03-29 08:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-29 08:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:1264 on 2024-03-29 08:06</div>
            <div class="timeline-body"><p>Linking for posterity: https://github.com/astral-sh/ruff/pull/10634/files#diff-b0faf8ec2615ebd31aff987f04757ead6fcfef23e995cd370e5da1700e9ae684</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:03:16 UTC
    </footer>
</body>
</html>
