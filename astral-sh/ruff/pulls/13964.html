<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support inference for PEP 604 union annotations - astral-sh/ruff #13964</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Support inference for PEP 604 union annotations</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13964">#13964</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-10-28 13:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-28 13:11</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Supports return type inference for, e.g., <code>def f() -&gt; int | None:</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @charliermarsh on 2024-10-28 13:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @charliermarsh on 2024-10-28 13:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @charliermarsh on 2024-10-28 13:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/assignment/annotations.md</code>:26 on 2024-10-28 13:12</div>
            <div class="timeline-body"><pre><code class="language-suggestion">## PEP-604 annotations are supported
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-28 13:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3499 on 2024-10-28 13:12</div>
            <div class="timeline-body"><p>I struggled with this a bit -- should this line still be here? If it's left as-is, we hit the <code>assert!(previous.is_none());</code> assertion below. If we leave it as-is but use <code>let left_ty = self.expression_ty(&amp;binary.left);</code> instead of <code>let left_ty = self.infer_type_expression(&amp;binary.left);</code>, then we get inferences like <code>Literal[int] | Literal[None]</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-10-28 13:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @charliermarsh on 2024-10-28 13:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-28 13:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3499 on 2024-10-28 13:17</div>
            <div class="timeline-body"><p>I think the way you've done it in this PR is correct!</p>
<p>The invariant is that we should only insert a type into <code>self.types.expressions</code> <em>once</em> for each AST node in the tree. What <code>self.infer_binary_expression()</code> does here is it iterates through all the subnodes and stores a type in <code>self.types.expressions</code> for each subnode. But that's incorrect with the changes you're making here, because we're calling <code>self.infer_type_expression</code> on each subnode, and <code>self.infer_type_expression</code> already stores a type in <code>self.types.expressions</code> for each subnode (it's the <code>let previous = self.types.expressions.insert(expr_id, ty);</code> line at the bottom of this method).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-28 13:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3498 on 2024-10-28 13:19</div>
            <div class="timeline-body"><p>using <code>if</code>/<code>let</code> might be okay here. I don't think there are any other binary operations that are legal in type annotations right now, so it's unlikely we'll ever add any other branches in the medium term. In the long term, intersection types might eventually get standardised, which would mean <code>str &amp; int</code> would become a legal annotation... but I think that's still a long way off for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3498 on 2024-10-28 13:20</div>
            <div class="timeline-body"><p>I personally still find this clearer given the pattern-matching style of the file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-10-28 13:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-28 13:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3498 on 2024-10-28 13:22</div>
            <div class="timeline-body"><p>Fair. I'm not a massive fan of this Clippy rule in general TBH -- it feels like it has too many false positives for my liking</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/assignment/annotations.md</code>:30 on 2024-10-28 13:28</div>
            <div class="timeline-body"><p>Could you also add a test that uses a union with duplicate elements, e.g. <code>str | int | str | None</code>? We should infer the type as <code>str | int | None</code> (we should deduplicate the elements). I think your PR does that, but it would be great to verify it with an explicit test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-10-28 13:29</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-10-28 13:32</div>
            <div class="timeline-body"><p>LGTM! You'll need to update the list of expected diagnostics in our red-knot benchmark here -- we have an assertion in the benchmark that checks that exactly these diagnostics are emitted when benchmarking red-knot with <code>tomllib</code>.</p>
<p>https://github.com/astral-sh/ruff/blob/c593ccb529a8183d5016467adecf25b0981a31ad/crates/ruff_benchmark/benches/red_knot.rs#L25-L49</p>
<p>I <em>think</em> these are false positives caused by a pre-existing issue (exposed by your PR) that we need to address. But I don't think that should block your PR from being merged, since the bug was already present (just hidden)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-10-28 14:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-10-28 14:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-10-28 14:13</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 21:00:09 UTC
    </footer>
</body>
</html>
