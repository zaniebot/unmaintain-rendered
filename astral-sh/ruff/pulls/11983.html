<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Manually implement `Debug` for `VendoredFileSystem` - astral-sh/ruff #11983</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Manually implement <code>Debug</code> for <code>VendoredFileSystem</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11983">#11983</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-06-22 14:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-06-22 14:13</div>
            <div class="timeline-body"><p>I temporarily added this in a PR to my fork so I could debug some test failures on Windows that were a result of paths not being normalized when the zip archive was being created at build time. It seems like it could be a useful method to have around generally, in case we need to debug similar issues in the future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2024-06-22 14:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2024-06-22 14:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2024-06-22 14:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-06-22 14:27</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-06-22 16:52</div>
            <div class="timeline-body"><p>I'm in favor of easing debugging but I'm worried that the way it is done in this PR leaks abstraction and it has no safeguards (other than a comment) that prevents actual usage of the method (it's public, no conditional compilation).</p>
<p>I recommend to instead create a manual <code>Debug</code> implementation. This preserves the encapsulation and gives a better debugging experience by default, without having to know about the &quot;file_names&quot; function (just use <code>dbg!</code>).</p>
<p>The way I would implement <code>Debug</code> is by testing for the <a href="https://doc.rust-lang.org/std/fmt/struct.Formatter.html#method.alternate"><code>alternate</code></a> flag and if it is set, emit a map with all the file names (and maybe the size of each file?) using either <code>f.debug_map</code> or <code>f.debug_list</code>. If <code>alternate</code> isn't set, maybe just print the number of files?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-06-22 16:54</div>
            <div class="timeline-body"><p>That's a much better idea -- thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2024-06-22 18:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Add a convenience method to `VendoredFileSystem` to ease debugging" to "[red-knot] Manually implement `Debug` and `Display` for `VendoredFileSystem`" by @AlexWaygood on 2024-06-22 18:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-06-22 18:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/vendored.rs</code>:148 on 2024-06-22 18:38</div>
            <div class="timeline-body"><p>It's unclear to me what the benefit of implementing <code>Display</code> is. <code>Display</code> is mainly used as a representation shown to the user and it's unclear to me where this is needed. And if we need it, I think <code>debug_struct</code> isn't the right representation for it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-06-22 18:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/vendored.rs</code>:336 on 2024-06-22 18:40</div>
            <div class="timeline-body"><p>I'm slightly confused. Why does the manual debug still render the inner <code>Mutex</code> considering that it is implemented on <code>VendoredFileSystem</code>.</p>
<p>Ah, it's because it's implemented on the <code>Archive</code>. I would just implement it on <code>VendoredFileSystem</code>. The archive representation isn't relevant for <code>VendoredFileSystem</code> users.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Manually implement `Debug` and `Display` for `VendoredFileSystem`" to "[red-knot] Manually implement `Debug` for `VendoredFileSystem`" by @AlexWaygood on 2024-06-23 12:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-06-23 12:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_db/src/vendored.rs</code>:148 on 2024-06-23 12:02</div>
            <div class="timeline-body"><p>Fair enough, I removed <code>Display</code>!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-06-23 12:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_db/src/vendored.rs</code>:336 on 2024-06-23 12:05</div>
            <div class="timeline-body"><p>Agreed, though for debugging purposes I think it would be useful to know if the inner mutex were unexpectedly poisoned for some reason. I've just reworked it a bit to expose more information about the inner zip files (when the alternate debug representation has been specified) but expose less about the intermediate types between the zip archive and the <code>VendoredFileSystem</code> struct... let me know what you think!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-06-23 12:06</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/vendored-filesystem-convenience">CodSpeed Performance Report</a></h2>
<h3>Merging #11983 will <strong>degrade performances by 4.82%</strong></h3>
<p><sub>Comparing <code>vendored-filesystem-convenience</code> (5a053ef) with <code>main</code> (7156096)</sub></p>
<h3>Summary</h3>
<p><code>❌ 1</code> regressions
<code>✅ 29</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/vendored-filesystem-convenience">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>main</code> | <code>vendored-filesystem-convenience</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ❌ | <code>linter/default-rules[pydantic/types.py]</code> | 1.8 ms | 1.9 ms | -4.82% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2024-06-23 12:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-06-23 13:18</div>
            <div class="timeline-body"><p>This is fancy!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2024-06-23 13:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-06-23 13:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-06-23 13:25</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 21:56:33 UTC
    </footer>
</body>
</html>
