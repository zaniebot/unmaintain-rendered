```yaml
number: 7443
title: "perf(formatter): Allocation free interned"
type: pull_request
state: closed
author: MichaReiser
labels:
  - performance
  - formatter
assignees: []
draft: true
base: best-fitting-reduce-allocations
head: allocation-free-interned
created_at: 2023-09-16T17:15:24Z
updated_at: 2024-01-16T10:04:12Z
url: https://github.com/astral-sh/ruff/pull/7443
synced_at: 2026-01-10T22:57:09Z
```

# perf(formatter): Allocation free interned

---

_Pull request opened by @MichaReiser on 2023-09-16 17:15_

## Summary

This PR removes the need for an `Rc` to implement interned by using the `Buffer` as an interner

* Create an ID for the interned content
* Wrap the content in `StartInterned` and `EndInterned` tag with the corresponding `ID` and write the content directly to the target `Buffer`. 
* Write a `Reference(id)` node to reference to the interned content.


The `Printer` skips interned content but writes it to an internal `Index`. The `Printer` uses the internal `Index` to resolve the `Interned` content when it sees a `Reference`. The fact that `id`s tend to be monotonic allows the use of a `Vec` as an `Index` similar to `Group` ids

The downside of this approach is that it is more complicated to reason about and it is no longer possible to inspect the content of `Reference` without tracking all interned content. Another downside is that the IR is slightly misleading because you see `Interned` content and would assume it gets printed in that place, which is not true. For example, the interned content appears before the `best_fitting,` but the content only gets printed inside the best-fitting variants. Moving the `Interned` content into the first best fitting variant doesn't work because that content only gets printed conditionally, meaning the `Printer` would then not always see the `Interned` content, failing to resolve the `Reference`.

![image](https://github.com/astral-sh/ruff/assets/1203881/cc009b59-11a1-42df-a9a6-27a68db4166a)


## Alternatives

One alternative that I explored is to use `bumpallo` instead and use it to allocate `BestFitting` vectors, dynamic strings, and Rcs. This could improve performance even more because it eliminates the 3-4% drop-time too. However, it comes at the downside that `Buffer` requires a new `'elements` lifetime that needs to be added everywhere (`Format`, `Formatter`, `Buffer`, `FormatNode`, `FormatNodeRule`....). I gave up at some point because it made the API significantly more complicated. 

## Test Plan

`cargo test`


---

_Comment by @MichaReiser on 2023-09-16 17:15_

Current dependencies on/for this PR:
* main
  * **PR #7411** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7411" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7443** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7443" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  üëà

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7443?utm_source=stack-comment).

---

_Comment by @codspeed-hq[bot] on 2023-09-16 17:31_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/allocation-free-interned)

### Merging #7443 will **degrade performances by 2.45%**

<sub>Comparing <code>allocation-free-interned</code> (e112b02) with <code>best-fitting-reduce-allocations</code> (2843fc0)</sub>



### Summary

`‚ö° 2` improvements
`‚ùå 1` regressions
`‚úÖ 22` untouched benchmarks



> :warning: _Please fix the performance issues or [acknowledge them on CodSpeed](https://codspeed.io/astral-sh/ruff/branches/allocation-free-interned)._

### Benchmarks breakdown

|     | Benchmark | `best-fitting-reduce-allocations` | `allocation-free-interned` | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ‚ö° | `formatter[unicode/pypinyin.py]` | 3.7 ms | 3.6 ms | +2.26% |
| ‚ö° | `formatter[large/dataset.py]` | 57.3 ms | 56.2 ms | +2.01% |
| ‚ùå | `linter/all-rules[numpy/ctypeslib.py]` | 34.2 ms | 35 ms | -2.45% |


---

_Label `performance` added by @MichaReiser on 2023-09-16 18:33_

---

_Label `formatter` added by @MichaReiser on 2023-09-16 18:33_

---

_Comment by @MichaReiser on 2023-09-18 19:45_

We may want to bring this back when working on other best fitting layouts but closing for now

---

_Closed by @MichaReiser on 2023-09-18 19:45_

---

_Branch deleted on 2024-01-16 10:04_

---
