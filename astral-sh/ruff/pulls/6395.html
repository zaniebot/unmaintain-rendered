<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rename `Magic*` to `IpyEscape*` - astral-sh/ruff #6395</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Rename <code>Magic*</code> to <code>IpyEscape*</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6395">#6395</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2023-08-07 16:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR renames the <code>MagicCommand</code> token to <code>IpyEscapeCommand</code> token and <code>MagicKind</code> to <code>IpyEscapeKind</code> type to better reflect the purpose of the token and type. Similarly, it renames the AST nodes from <code>LineMagic</code> to <code>IpyEscapeCommand</code> prefixed with <code>Stmt</code>/<code>Expr</code> wherever necessary.</p>
<p>It also makes renames from using <code>jupyter_magic</code> to <code>ipython_escape_commands</code> in various function names.</p>
<p>The mode value is still <code>Mode::Jupyter</code> because the escape commands are part of the IPython syntax but the lexing/parsing is done for a Jupyter notebook.</p>
<h3>Motivation behind the rename:</h3>
<ul>
<li>IPython codebase defines it as &quot;EscapeCommand&quot; / &quot;Escape Sequences&quot;:<ul>
<li>Escape Sequences: https://github.com/ipython/ipython/blob/292e3a23459ca965b8c1bfe2c3707044c510209a/IPython/core/inputtransformer2.py#L329-L333</li>
<li>Escape command: https://github.com/ipython/ipython/blob/292e3a23459ca965b8c1bfe2c3707044c510209a/IPython/core/inputtransformer2.py#L410-L411</li>
</ul>
</li>
<li>The word &quot;magic&quot; is used mainly for the actual magic commands i.e., the ones starting with <code>%</code>/<code>%%</code> (https://ipython.readthedocs.io/en/stable/interactive/reference.html#magic-command-system). So, this avoids any confusion between the Magic token (<code>%</code>, <code>%%</code>) and the escape command itself.</li>
</ul>
<h2>Test Plan</h2>
<ul>
<li><code>cargo test</code> to make sure all renames are done correctly.</li>
<li><code>grep</code> for <code>jupyter_escape</code>/<code>magic</code> to make sure all renames are done correctly.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-08-07 16:11</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #6395</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6395" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6395?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-08-07 16:35</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01      8.4Â±0.17ms     4.9 MB/sec    1.00      8.2Â±0.04ms     4.9 MB/sec
formatter/numpy/ctypeslib.py               1.01  1679.0Â±54.62Âµs     9.9 MB/sec    1.00  1656.7Â±52.19Âµs    10.1 MB/sec
formatter/numpy/globals.py                 1.01    187.4Â±7.11Âµs    15.7 MB/sec    1.00    185.5Â±5.65Âµs    15.9 MB/sec
formatter/pydantic/types.py                1.00      3.5Â±0.11ms     7.2 MB/sec    1.00      3.5Â±0.10ms     7.2 MB/sec
linter/all-rules/large/dataset.py          1.00     10.3Â±0.09ms     4.0 MB/sec    1.00     10.3Â±0.06ms     4.0 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      2.7Â±0.02ms     6.1 MB/sec    1.00      2.7Â±0.01ms     6.1 MB/sec
linter/all-rules/numpy/globals.py          1.00    387.0Â±2.75Âµs     7.6 MB/sec    1.00    386.0Â±1.85Âµs     7.6 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.4Â±0.04ms     4.7 MB/sec    1.00      5.4Â±0.06ms     4.7 MB/sec
linter/default-rules/large/dataset.py      1.00      5.3Â±0.02ms     7.7 MB/sec    1.00      5.3Â±0.02ms     7.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01   1155.2Â±8.11Âµs    14.4 MB/sec    1.00   1143.4Â±8.02Âµs    14.6 MB/sec
linter/default-rules/numpy/globals.py      1.02    134.8Â±4.93Âµs    21.9 MB/sec    1.00    132.7Â±3.98Âµs    22.2 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.4Â±0.03ms    10.6 MB/sec    1.00      2.4Â±0.01ms    10.6 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     12.0Â±0.30ms     3.4 MB/sec    1.03     12.3Â±0.28ms     3.3 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.3Â±0.07ms     7.4 MB/sec    1.04      2.4Â±0.08ms     7.1 MB/sec
formatter/numpy/globals.py                 1.00   258.9Â±12.15Âµs    11.4 MB/sec    1.02   264.3Â±21.92Âµs    11.2 MB/sec
formatter/pydantic/types.py                1.00      5.1Â±0.15ms     5.0 MB/sec    1.02      5.2Â±0.17ms     4.9 MB/sec
linter/all-rules/large/dataset.py          1.02     15.3Â±0.36ms     2.7 MB/sec    1.00     15.1Â±0.31ms     2.7 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.02      4.2Â±0.14ms     3.9 MB/sec    1.00      4.2Â±0.09ms     4.0 MB/sec
linter/all-rules/numpy/globals.py          1.00   517.2Â±18.56Âµs     5.7 MB/sec    1.01   520.1Â±22.17Âµs     5.7 MB/sec
linter/all-rules/pydantic/types.py         1.01      7.9Â±0.19ms     3.2 MB/sec    1.00      7.9Â±0.13ms     3.2 MB/sec
linter/default-rules/large/dataset.py      1.00      8.3Â±0.12ms     4.9 MB/sec    1.00      8.3Â±0.12ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1716.9Â±40.04Âµs     9.7 MB/sec    1.02  1752.6Â±47.05Âµs     9.5 MB/sec
linter/default-rules/numpy/globals.py      1.00    197.0Â±7.68Âµs    15.0 MB/sec    1.03    203.2Â±8.21Âµs    14.5 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.7Â±0.08ms     7.0 MB/sec    1.02      3.7Â±0.07ms     6.9 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2023-08-07 17:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @dhruvmanila on 2023-08-07 17:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-07 20:07</div>
            <div class="timeline-body"><p>You mention that the rename is to better reflect the purpose and type. Can you expand on what makes the new name the better choice?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-08-08 04:14</div>
            <div class="timeline-body"><h2>IPython Escape Commands Terminology</h2>
<p>Before we get into the definitions, I'm omitting all of the rules of lexing/parsing because we're only interested in the definition.</p>
<ul>
<li>&quot;Magic commands&quot; are special IPython syntax which starts with a token to identify the magic kind followed by the command value itself.</li>
<li>&quot;Magic kind&quot; are the kind of magic commands which are recognized by the token itself: <code>%</code>, <code>%%</code>, <code>!</code>, <code>!!</code>, <code>?</code>, <code>??</code>, <code>/</code>, <code>;</code>, and <code>,</code>.</li>
<li>&quot;Help command&quot; (or &quot;Dynamic Object Introspection&quot; as it's called) are the escape commands of the kind <code>?</code> and <code>??</code>. (<code>?str.replace</code>)</li>
<li>&quot;Help end command&quot; are a subset of &quot;Help command&quot; where the token can be at the end of the line i.e., after the value itself (<code>str.replace?</code>). Here's where things get tricky. I'll divide the help end command into two types for better understanding:<ul>
<li>Strict version: The token is <em>only</em> at the end of the line (<code>str.replace?</code>, <code>str.replace??</code>)</li>
<li>Combined version: Not only either <code>?</code> or <code>??</code> is at the end of the line but other magic kind tokens are present at the start as well (<code>%matplotlib?</code>, <code>%%timeit?</code>)</li>
</ul>
</li>
<li>&quot;Priority&quot; comes into picture for the &quot;Combined version&quot; mentioned above. When there are magic kind tokens on both side of the value, how do we determine the magic kind i.e., which token to choose? The &quot;Help end command&quot; always takes priority over any other token i.e., if there is <code>?</code>/<code>??</code> at the end then that is used to determine the kind.</li>
</ul>
<h3>What the syntax would look like?</h3>
<ul>
<li><code>&lt;MagicKind&gt;&lt;Command value&gt;</code> (e.g., <code>%matplotlib</code>, <code>/foo</code>, <code>!pwd</code>, etc.)</li>
<li><code>&lt;Command value&gt;&lt;MagicKind (&quot;?&quot; or &quot;??&quot;)&gt;</code> (e.g., <code>str.replace?</code>, <code>math.pi??</code>, etc.)</li>
<li><code>&lt;MagicKind&gt;&lt;Command value&gt;&lt;MagicKind (&quot;?&quot; or &quot;??&quot;)&gt;</code> (e.g., <code>%matplotlib?</code>, <code>%%timeit??</code>, etc.)</li>
</ul>
<h3>Motivation behind the rename:</h3>
<ul>
<li>IPython codebase defines it as &quot;EscapeCommand&quot; / &quot;Escape Sequences&quot;:<ul>
<li>Escape Sequences: https://github.com/ipython/ipython/blob/292e3a23459ca965b8c1bfe2c3707044c510209a/IPython/core/inputtransformer2.py#L329-L333</li>
<li>Escape command: https://github.com/ipython/ipython/blob/292e3a23459ca965b8c1bfe2c3707044c510209a/IPython/core/inputtransformer2.py#L410-L411</li>
</ul>
</li>
<li>The word &quot;magic&quot; is used mainly for the actual magic commands i.e., the ones starting with <code>%</code>/<code>%%</code> (https://ipython.readthedocs.io/en/stable/interactive/reference.html#magic-command-system). So, this avoids any confusion between the Magic token (<code>%</code>, <code>%%</code>) and the escape command itself.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-08 07:53</div>
            <div class="timeline-body"><p>Thanks for the explanation. This is very helpful context that I didn't have before. We should preserve this in writing somewhere (maybe as documentation on <code>EscapeCommand</code>).</p>
<p>A few thoughts:</p>
<blockquote>
<p>The word &quot;magic&quot; is used mainly for the actual magic commands i.e., the ones starting with %/%%</p>
</blockquote>
<p>That makes sense now. So only the EscapeKind <code>%</code> and <code>%%</code> are &quot;magic&quot;</p>
<p>What I liked about the old &quot;Magic&quot; prefix is that it clearly marked them as not being part of the Python spec. Would it make sense to keep a similar prefix. Maybe IpyEscapeCommand and IpyEscapeSequence. Should we use the same prefix for the tokens and ast nodes?</p>
<p>We did something similar at rome where we prefixed the JS Spec nodes with <code>Js</code>, e.g. <code>JsBinaryExpression</code>, the type script syntax nodes with <code>Ts</code> (<code>TsTypeAliasDeclaration</code>), and the jsx nodes with <code>Jsx</code> (<code>JsxTagExpression</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-08-08 13:01</div>
            <div class="timeline-body"><blockquote>
<p>Thanks for the explanation. This is very helpful context that I didn't have before. We should preserve this in writing somewhere (maybe as documentation on <code>EscapeCommand</code>).</p>
</blockquote>
<p>Yes, will do so in a separate PR.</p>
<blockquote>
<p>What I liked about the old &quot;Magic&quot; prefix is that it clearly marked them as not being part of the Python spec. Would it make sense to keep a similar prefix. Maybe IpyEscapeCommand and IpyEscapeSequence. Should we use the same prefix for the tokens and ast nodes?</p>
</blockquote>
<p>Yes, my &quot;Other ideas&quot; section proposed something similar although a bit verbose. I like the &quot;Ipy&quot; prefix.</p>
<p>So, to summarize:</p>
<ul>
<li><code>MagicCommand</code> -&gt; <code>IpyEscapeCommand</code></li>
<li><code>MagicKind</code> -&gt; <code>IpyEscapeKind</code> (I'm leaning towards &quot;Kind&quot; suffix for consistency with <code>StringKind</code> although I have no problem with <code>IpyEscapeSequence</code>)</li>
<li><code>StmtLineMagic</code>/<code>ExprLineMagic</code> -&gt; <code>IpyEscapeCommandStatement</code>/<code>IpyEscapeCommandExpression</code> (Is this too verbose?) or <code>StmtIpyEscapeCommand</code>/<code>ExprIpyEscapeCommand</code> (for consistency with the current naming convention).</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-08 15:50</div>
            <div class="timeline-body"><p>Sounds good to me.</p>
<blockquote>
<p>StmtLineMagic/ExprLineMagic -&gt; IpyEscapeCommandStatement/IpyEscapeCommandExpression (Is this too verbose?) or StmtIpyEscapeCommand/ExprIpyEscapeCommand (for consistency with the current naming convention).</p>
</blockquote>
<p>I prefer the <code>IpyEscapeCommandStatement</code> but we may need to go with <code>StmtIpyEscapeCommand</code> for consistency (until we rename all nodes)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Rename `Magic*` to `Escape*`" to "Rename `Magic*` to `IpyEscape*`" by @dhruvmanila on 2023-08-09 03:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @dhruvmanila on 2023-08-09 05:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/node.rs</code>:51 on 2023-08-09 07:21</div>
            <div class="timeline-body"><p>Rename the node type</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/node.rs</code>:79 on 2023-08-09 07:21</div>
            <div class="timeline-body"><p>Rename the variant name</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/comparable.rs</code>:1168 on 2023-08-09 07:21</div>
            <div class="timeline-body"><p>Rename the struct name</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-08-09 07:23</div>
            <div class="timeline-body"><p>Looks good. You may want to search for <code>StmtLineMagic</code> and <code>ExprLineMagic</code> (text) and replace all occurrences with the new names</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-08-09 13:18</div>
            <div class="timeline-body"><p>Thanks for noticing the remaining renames! :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2023-08-09 13:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2023-08-09 13:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-08-09 13:28</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:59:23 UTC
    </footer>
</body>
</html>
