<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Consolidate all gradual types into single Type variant - astral-sh/ruff #15386</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Consolidate all gradual types into single Type variant</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15386">#15386</a>
        opened by <a href="https://github.com/dcreager">@dcreager</a>
        on 2025-01-09 20:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a></div>
            <div class="timeline-body"><p>Prompted by <a href="https://github.com/astral-sh/ty/issues/222">astral-sh/ty#222</a>:</p>
<blockquote>
<p>One nit: I think we need to consider <code>Any</code> and <code>Unknown</code> and <code>Todo</code> as all (gradually) equivalent to each other, and thus <code>type &amp; Any</code> and <code>type &amp; Unknown</code> and <code>type &amp; Todo</code> as also equivalent. The distinction between <code>Any</code> vs <code>Unknown</code> vs <code>Todo</code> is entirely about provenance/debugging, there is no type level distinction. (And I&#x27;ve been wondering if the <code>Any</code> vs <code>Unknown</code> distinction is really worth it.)</p>
</blockquote>
<p>The thought here is that <em>most</em> places want to treat <code>Any</code>, <code>Unknown</code>, and <code>Todo</code> identically.  So this PR simplifies things by having a single <code>Type::Any</code> variant, and moves the provenance part into a new <code>AnyType</code> type.  If you need to treat e.g. <code>Todo</code> differently, you still can by pattern-matching into the <code>AnyType</code>.  But if you don&#x27;t, you can just use <code>Type::Any(_)</code>.</p>
<p>(This would also allow us to (more easily) distinguish &quot;unknown via an unannotated value&quot; from &quot;unknown because of a typing error&quot; should we want to do that in the future)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/dcreager">@dcreager</a> on 2025-01-09 20:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/dcreager">@dcreager</a> on 2025-01-09 20:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/dcreager">@dcreager</a> on 2025-01-09 20:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/dcreager">@dcreager</a> on 2025-01-09 20:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Consolidate all gradual types into single Type variant&quot; to &quot;[red-knot] Consolidate all gradual types into single Type variant&quot; by <a href="https://github.com/dcreager">@dcreager</a> on 2025-01-09 20:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/dcreager">@dcreager</a> on 2025-01-09 20:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> approved on 2025-01-09 20:33</div>
            <div class="timeline-body"><p>I like it! (haven&#x27;t reviewed each and every change, but I guess it&#x27;s more or less mechanical)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:505 on 2025-01-09 20:34</div>
            <div class="timeline-body"><p>I&#x27;m on my phone so I don&#x27;t have have an easy way to verify it myself and I don&#x27;t remember if we have a check for this. Does this increase my the overall size of Type in release builds or does it remain unchanged?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-01-09 20:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-09 20:36</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:505 on 2025-01-09 20:37</div>
            <div class="timeline-body"><p>The static assertion is unmodified:</p>
<p>https://github.com/astral-sh/ruff/blob/b0905c4b043189879af78afb757270c4e0397e25/crates/red_knot_python_semantic/src/types.rs#L4001-L4004</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-09 20:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-09 20:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:505 on 2025-01-09 20:43</div>
            <div class="timeline-body"><p>The debug size is also the same (32 byte). Which was surprising to me because the <code>Todo</code> variant was the largest a while ago (24 byte). But now it has been replaced by <code>Type::SubclassOf</code>, which contains <code>SubclassOfType</code> of size 24 byte because it can also contain a heavy <code>Todo</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-01-09 21:05</div>
            <div class="timeline-body"><p>Brilliant idea! Is it possibly worth calling the variant and struct <code>Type::Gradual</code> and <code>GradualType</code> rather than <code>Type::Any</code> and <code>AnyType</code>? <code>Type::Any(AnyType::Unknown)</code> reads a bit strangely to me</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-01-09 21:12</div>
            <div class="timeline-body"><p>Also: <a href="https://github.com/python/mypy/blob/ccf05db67f6f99878c73eb902fc59a6f037b18a6/mypy/types.py#L182-L210">all roads lead to Rome</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:551 on 2025-01-09 21:12</div>
            <div class="timeline-body"><p>nit: I&#x27;d be inclined just to call this <code>Type::any()</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/class_base.rs</code>:21 on 2025-01-09 21:13</div>
            <div class="timeline-body"><p>(Same here)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-01-09 21:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:551 on 2025-01-09 21:28</div>
            <div class="timeline-body"><p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/red_knot_python_semantic/src/types/class_base.rs</code>:21 on 2025-01-09 21:28</div>
            <div class="timeline-body"><p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-01-09 21:29</div>
            <div class="timeline-body"><blockquote>
<p>Brilliant idea! Is it possibly worth calling the variant and struct <code>Type::Gradual</code> and <code>GradualType</code> rather than <code>Type::Any</code> and <code>AnyType</code>? <code>Type::Any(AnyType::Unknown)</code> reads a bit strangely to me</p>
</blockquote>
<p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:4155 on 2025-01-09 21:30</div>
            <div class="timeline-body"><p>e.g. here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-01-09 21:31</div>
            <div class="timeline-body"><blockquote>
<p>but I guess it&#x27;s more or less mechanical</p>
</blockquote>
<p>That is a good callout.  I did try to make this a pure refactoring.  For instance, there are a couple of places where we were doing something only for a <code>Todo</code>, but not for <code>Any</code> or <code>Unknown</code>.  Instead of inspecting and possibly changing those in this PR, I&#x27;ve left them as-is so that this PR does not combine a refactoring with a logic change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2334 on 2025-01-09 21:35</div>
            <div class="timeline-body"><pre><code>    // An unannotated value, or a gradual type resulting from an error
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-01-09 21:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:505 on 2025-01-09 21:47</div>
            <div class="timeline-body"><p>So I feel bad suggesting a naming change after you just changed the name for another reviewer... but I would rather call this <code>Type::Dynamic</code> and <code>DynamicType</code>. &quot;Dynamic&quot; or &quot;dyn&quot; is frequently used for this type in the literature, and usually the term &quot;gradual type&quot; is used as a blanket term encompassing all types, including both fully-static ones and partially-dynamic and fully-dynamic ones. That&#x27;s also how the Python typing spec uses the term &quot;gradual type&quot; (as a blanket term, not a description of the dynamic type specifically.) Whereas &quot;dynamic&quot; is the term we use for this type right here in the doc comment above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-01-09 21:48</div>
            <div class="timeline-body"><p>This is excellent!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-09 21:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:505 on 2025-01-09 21:49</div>
            <div class="timeline-body"><p>Yeah, this is on me -- I agree <code>Dynamic</code> is a better name, for all the reasons @carljm mentions. Sorry @dcreager!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2334 on 2025-01-09 21:55</div>
            <div class="timeline-body"><pre><code>    // An unannotated value, or a dynamic type resulting from an error
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2353 on 2025-01-09 21:56</div>
            <div class="timeline-body"><pre><code>            // `DynamicType::Todo`&#x27;s display should be explicit that is not a valid display of
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/class_base.rs</code>:156 on 2025-01-09 21:58</div>
            <div class="timeline-body"><pre><code>        match self {
            Self::Class(class) =&gt; Some(class),
            Self::Dynamic(_) =&gt; None,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-01-09 21:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1082 on 2025-01-09 21:59</div>
            <div class="timeline-body"><p>Side note on seeing this method, wondering why we need it, and going to look: I wonder if maybe we shouldn&#x27;t allow <code>Any/Unknown/Todo</code> to coexist in the same union/intersection, and instead should just define a hierarchy of preference, e.g. <code>Todo</code> takes top priority, <code>Any</code> second, and <code>Unknown</code> third?</p>
<p>Definitely not something for this PR, just musing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2087 on 2025-01-09 22:00</div>
            <div class="timeline-body"><pre><code>                ClassBase::Dynamic(dynamic) =&gt; Type::Dynamic(dynamic),
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-01-09 22:03</div>
            <div class="timeline-body"><p>This makes handling these in match statements so much nicer!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dcreager">@dcreager</a> on 2025-01-10 02:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dcreager">@dcreager</a> on 2025-01-10 02:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-10 02:32</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:10:12 UTC
    </footer>
</body>
</html>
