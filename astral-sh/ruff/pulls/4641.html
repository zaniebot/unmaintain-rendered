<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add `Comments` data structure - astral-sh/ruff #4641</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add <code>Comments</code> data structure</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4641">#4641</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-05-24 16:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR introduces the new <code>Comments</code> data structure. It is the main API for formatters to retrieve the <em>leading</em>, <em>dangling</em>, and <em>trailing</em> comments for a node. I'll add a <code>Comments</code> field to the <code>ASTFormatContext</code> in a follow-up PR.</p>
<p>The <code>Comments</code> data structure uses the <code>MultiMap</code> implementation introduced in #4639 to store the comments internally. It uses a <code>NodeRefEqualityKey</code> as the key into the multi-map because the RustPython AST nodes do not implement Hash (and we want a cheap hash function). This should work fine because the formatter doesn't mutate the tree and operates only on nodes passed in as references.</p>
<p>This PR does not yet implement the logic to extract comments.</p>
<h2>Test Plan</h2>
<p>There's a basic test that verifies the debug representation. The next PR adds more tests using the API.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-05-24 16:40</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #4639</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4639" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #4641</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4641" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ<ul>
<li><strong>PR #4642</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4642" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #4671</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4671" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #4748</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4748" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>
* <strong>PR #4751</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4751" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4641?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">autoformatter</span> added by @MichaReiser on 2023-05-24 16:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-05-24 17:31</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     14.9Â±0.03ms     2.7 MB/sec    1.01     15.1Â±0.13ms     2.7 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.7Â±0.01ms     4.5 MB/sec    1.00      3.7Â±0.01ms     4.5 MB/sec
linter/all-rules/numpy/globals.py          1.00    378.1Â±0.86Âµs     7.8 MB/sec    1.00    377.3Â±0.91Âµs     7.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.3Â±0.02ms     4.0 MB/sec    1.00      6.3Â±0.02ms     4.0 MB/sec
linter/default-rules/large/dataset.py      1.00      7.5Â±0.01ms     5.4 MB/sec    1.00      7.5Â±0.01ms     5.4 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1595.9Â±5.58Âµs    10.4 MB/sec    1.00   1598.5Â±3.85Âµs    10.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    176.0Â±0.50Âµs    16.8 MB/sec    1.00    176.1Â±0.54Âµs    16.8 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.4Â±0.01ms     7.5 MB/sec    1.13      3.8Â±0.82ms     6.7 MB/sec
parser/large/dataset.py                    1.01      5.8Â±0.01ms     7.0 MB/sec    1.00      5.7Â±0.00ms     7.1 MB/sec
parser/numpy/ctypeslib.py                  1.00   1133.6Â±1.31Âµs    14.7 MB/sec    1.00   1132.8Â±1.06Âµs    14.7 MB/sec
parser/numpy/globals.py                    1.00    115.6Â±0.27Âµs    25.5 MB/sec    1.00    115.7Â±0.29Âµs    25.5 MB/sec
parser/pydantic/types.py                   1.00      2.5Â±0.00ms    10.3 MB/sec    1.00      2.5Â±0.00ms    10.3 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     17.4Â±0.30ms     2.3 MB/sec    1.01     17.5Â±0.23ms     2.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.3Â±0.05ms     3.9 MB/sec    1.01      4.3Â±0.07ms     3.8 MB/sec
linter/all-rules/numpy/globals.py          1.00    506.0Â±6.73Âµs     5.8 MB/sec    1.00    506.2Â±9.45Âµs     5.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.2Â±0.10ms     3.5 MB/sec    1.02      7.3Â±0.14ms     3.5 MB/sec
linter/default-rules/large/dataset.py      1.00      8.3Â±0.11ms     4.9 MB/sec    1.06      8.8Â±0.08ms     4.6 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1769.3Â±36.10Âµs     9.4 MB/sec    1.05  1856.2Â±21.32Âµs     9.0 MB/sec
linter/default-rules/numpy/globals.py      1.00    204.1Â±4.04Âµs    14.5 MB/sec    1.04    211.8Â±5.54Âµs    13.9 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.8Â±0.04ms     6.8 MB/sec    1.05      3.9Â±0.04ms     6.5 MB/sec
parser/large/dataset.py                    1.00      6.3Â±0.04ms     6.4 MB/sec    1.01      6.4Â±0.05ms     6.4 MB/sec
parser/numpy/ctypeslib.py                  1.00  1195.4Â±16.03Âµs    13.9 MB/sec    1.00  1199.6Â±14.80Âµs    13.9 MB/sec
parser/numpy/globals.py                    1.00    121.0Â±2.60Âµs    24.4 MB/sec    1.01    121.7Â±2.77Âµs    24.2 MB/sec
parser/pydantic/types.py                   1.00      2.7Â±0.03ms     9.5 MB/sec    1.01      2.7Â±0.05ms     9.4 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2023-05-26 08:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2023-05-26 08:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Boshen">@Boshen</a> on <code>crates/ruff_python_formatter/src/comments/mod.rs</code>:29 on 2023-05-26 11:35</div>
            <div class="timeline-body"><p>Why are you so lucky this time T.T</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Boshen">@Boshen</a> reviewed on 2023-05-26 11:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Boshen">@Boshen</a> reviewed on 2023-05-26 11:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Boshen">@Boshen</a> on <code>crates/ruff_python_formatter/src/comments/mod.rs</code>:71 on 2023-05-26 11:39</div>
            <div class="timeline-body"><p>Given you don't have inline comments, I think it makes sense to have dedicated AST nodes for comments, but I guess it's too late now :-(</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Boshen">@Boshen</a> reviewed on 2023-05-26 11:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Boshen">@Boshen</a> on <code>crates/ruff_python_formatter/src/comments/mod.rs</code>:84 on 2023-05-26 11:44</div>
            <div class="timeline-body"><p>rustc wraps some of the operators with a span (and I'm considering this as well). But again, it's too late to add this.</p>
<p>https://doc.rust-lang.org/beta/nightly-rustc/rustc_ast/ast/type.BinOp.html</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/mod.rs</code>:71 on 2023-05-26 11:50</div>
            <div class="timeline-body"><p>It's never too late ;) I'm prototyping a Python parser when I have time. But we need to make progress in the meantime.</p>
<p>A similar structure would probably still be necessary because the &quot;default&quot; placement of the parser is not necessarily what user expect.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-26 11:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Boshen">@Boshen</a> reviewed on 2023-05-26 11:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Boshen">@Boshen</a> on <code>crates/ruff_python_formatter/src/comments/mod.rs</code>:88 on 2023-05-26 11:50</div>
            <div class="timeline-body"><p>In rustfmt, there's a bunch of hacks for these kinds of comments. (I haven't looked at the details).</p>
<p>https://github.com/rust-lang/rustfmt/blob/master/Contributing.md#a-quick-tour-of-rustfmt</p>
<p>https://github.com/rust-lang/rustfmt/blob/master/src/missed_spans.rs</p>
<blockquote>
<p>Our primary tool here is to look between spans for text we've missed. For example, in a function call foo(a, b), we have spans for a and b, in this case, there is only a comma and a single space between the end of a and the start of b, so there is nothing much to do. But if we look at foo(a /* a comment */, b), then between a and b we find the comment.</p>
</blockquote>
<blockquote>
<p>At a higher level, Rustfmt has machinery so that we account for text between 'top level' items. Then we can reproduce that text pretty much verbatim. We only count spans we actually reformat, so if we can't format a span it is not missed completely but is reproduced in the output without being formatted. This is mostly handled in <a href="https://github.com/rust-lang/rustfmt/blob/master/src/missed_spans.rs">src/missed_spans.rs</a>. See also FmtVisitor::last_pos in <a href="https://github.com/rust-lang/rustfmt/blob/master/src/visitor.rs">src/visitor.rs</a>.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/mod.rs</code>:84 on 2023-05-26 11:50</div>
            <div class="timeline-body"><p>That's interesting. That could be useful for my local python parser :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-26 11:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/mod.rs</code>:29 on 2023-05-26 11:51</div>
            <div class="timeline-body"><p>haha.. I'm waiting for the moment where we start formatting other languages and I'll be back in the game</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-26 11:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Boshen">@Boshen</a> reviewed on 2023-05-26 11:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Boshen">@Boshen</a> on <code>crates/ruff_python_formatter/src/comments/node_key.rs</code>:11 on 2023-05-26 11:55</div>
            <div class="timeline-body"><p>Probably need to document where this is used for, I got lost at this point :-)</p>
<p>Is this just a pointer?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-26 12:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/node_key.rs</code>:11 on 2023-05-26 12:01</div>
            <div class="timeline-body"><p>It's used as keys into the <code>Comments</code> struct because <code>AnyNodeRef</code> does not implement <code>Hash</code> (and we want hashing to be cheap.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/comments/mod.rs</code>:14 on 2023-05-26 18:26</div>
            <div class="timeline-body"><p>In addition to placement, we also have &quot;own-line&quot; vs. &quot;end-of-line&quot; comments:</p>
<pre><code class="language-python">def f():  # end-of-line
  # own-line
  pass
</code></pre>
<p>(Is that the correct terminology? Where and how is that behavior defined or handled?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-05-26 18:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-26 18:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/mod.rs</code>:14 on 2023-05-26 18:27</div>
            <div class="timeline-body"><p>Always thinking ahead. This is in the next PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-26 18:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/comments/mod.rs</code>:14 on 2023-05-26 18:30</div>
            <div class="timeline-body"><p>Hah, yes, sorry, just came back here to comment that :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-05-30 08:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-05-30 08:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-05-30 08:54</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:57:37 UTC
    </footer>
</body>
</html>
