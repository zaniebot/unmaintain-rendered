```yaml
number: 7802
title: Use correct start location for class/function clause header
type: pull_request
state: merged
author: dhruvmanila
labels:
  - bug
  - formatter
assignees: []
merged: true
base: main
head: dhruv/start-location
created_at: 2023-10-04T05:35:30Z
updated_at: 2023-10-04T07:59:45Z
url: https://github.com/astral-sh/ruff/pull/7802
synced_at: 2026-01-12T02:39:10Z
```

# Use correct start location for class/function clause header

---

_Pull request opened by @dhruvmanila on 2023-10-04 05:35_

## Summary

This PR fixes the bug where the formatter would panic if a class/function with
decorators had a suppression comment.

The fix is to use to correct start location to find the `async`/`def`/`class`
keyword when decorators are present which is the end of the last decorator.

## Test Plan

Add test cases for the fix and update the snapshots.


---

_Comment by @dhruvmanila on 2023-10-04 05:35_

Current dependencies on/for this PR:
* main
  * **PR #7802** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7802" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  üëà

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7802?utm_source=stack-comment).

---

_Label `bug` added by @dhruvmanila on 2023-10-04 05:35_

---

_Label `formatter` added by @dhruvmanila on 2023-10-04 05:35_

---

_Review requested from @konstin by @dhruvmanila on 2023-10-04 05:36_

---

_Comment by @codspeed-hq[bot] on 2023-10-04 06:58_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/dhruv/start-location)

### Merging #7802 will **degrade performances by 2.37%**

<sub>Comparing <code>dhruv/start-location</code> (b79b73d) with <code>main</code> (7b4fb4f)</sub>



### Summary

`‚ö° 1` improvements
`‚ùå 1` regressions
`‚úÖ 23` untouched benchmarks



> :warning: _Please fix the performance issues or [acknowledge them on CodSpeed](https://codspeed.io/astral-sh/ruff/branches/dhruv/start-location)._

### Benchmarks breakdown

|     | Benchmark | `main` | `dhruv/start-location` | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ‚ö° | `linter/default-rules[pydantic/types.py]` | 38.9 ms | 38 ms | +2.48% |
| ‚ùå | `linter/all-rules[numpy/ctypeslib.py]` | 34.6 ms | 35.5 ms | -2.37% |


---

_@konstin approved on 2023-10-04 07:16_

---

_Comment by @konstin on 2023-10-04 07:18_

What about `fmt_skip/decorators.py` for the tests?

---

_Merged by @dhruvmanila on 2023-10-04 07:55_

---

_Closed by @dhruvmanila on 2023-10-04 07:55_

---

_Branch deleted on 2023-10-04 07:55_

---
