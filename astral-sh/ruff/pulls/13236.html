<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] fix lookup of nonlocal names in deferred annotations - astral-sh/ruff #13236</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] fix lookup of nonlocal names in deferred annotations</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13236">#13236</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2024-09-03 22:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body"><p>Initially I had deferred annotation name lookups reuse the &quot;public symbol type&quot;, since that gives the correct &quot;from end of scope&quot; view of reaching definitions that we want. But there is a key difference; public symbol types are based only on definitions in the queried scope (or &quot;name in the given namespace&quot; in runtime terms), they don't ever look up a name in nonlocal/global/builtin scopes. Deferred annotation resolution should do this lookup.</p>
<p>Add a test, and fix deferred name resolution to support nonlocal/global/builtin names.</p>
<p>Fixes #13176</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @carljm on 2024-09-03 22:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @carljm on 2024-09-03 22:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @carljm on 2024-09-03 22:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-09-03 22:13</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/cjm/deferred-lookup">CodSpeed Performance Report</a></h2>
<h3>Merging #13236 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>cjm/deferred-lookup</code> (5260214) with <code>main</code> (e965f9c)</sub></p>
<h3>Summary</h3>
<p><code>✅ 32</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-09-03 22:21</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1833 on 2024-09-04 09:39</div>
            <div class="timeline-body"><p>TIL I learned from @dhruvmanila. Sharing for you https://doc.rust-lang.org/std/error/index.html#common-message-styles</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-09-04 09:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3564 on 2024-09-04 10:21</div>
            <div class="timeline-body"><p>nit: I'd generally only use <code>panic!()</code> over <code>.expect()</code> if I wanted to give a dynamic error message</p>
<pre><code class="language-suggestion">
        let base = ty
            .expect_class()
            .bases(&amp;db)
            .next()
            .expect(&quot;there should be at least one base&quot;);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-09-04 10:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @carljm on 2024-09-04 17:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2024-09-04 17:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-09-04 17:10</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:06:22 UTC
    </footer>
</body>
</html>
