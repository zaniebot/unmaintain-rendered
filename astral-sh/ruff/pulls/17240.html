<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`refurb`] Mark the `FURB161` fix unsafe except for integers and booleans - astral-sh/ruff #17240</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>refurb</code>] Mark the <code>FURB161</code> fix unsafe except for integers and booleans</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17240">#17240</a>
        opened by <a href="https://github.com/VascoSch92">@VascoSch92</a>
        on 2025-04-06 19:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/VascoSch92">@VascoSch92</a> on 2025-04-06 19:14</div>
            <div class="timeline-body"><p>The PR fixes #16457 .</p>
<p>Specifically, <code>FURB161</code> is marked safe, but the rule generates safe fixes only in specific cases. Therefore, we attempt to mark the fix as unsafe when we are not in one of these cases.</p>
<p>For instances, the fix is marked as aunsafe just in case of strings (as pointed out in the issue). Let me know if I should change something.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-06 19:22</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ntBre on 2025-04-06 23:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @ntBre on 2025-04-06 23:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @ntBre by @ntBre on 2025-04-06 23:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-07 06:40</div>
            <div class="timeline-body"><p>Thanks for looking into this. Could you update the rule's documentation with a <code>## Fif safety</code> header and explain when the fix is safe (or isn't)? This will also make reviewing easier</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dscorbett">@dscorbett</a> on 2025-04-07 12:36</div>
            <div class="timeline-body"><p>This PR doesn’t fully fix #16457. The point of that issue is that FURB161 should be unsafe by default, with a few exceptions. This PR keeps it safe by default, the only exception being string literals.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @VascoSch92 on 2025-04-07 19:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/VascoSch92">@VascoSch92</a> on 2025-04-07 19:25</div>
            <div class="timeline-body"><blockquote>
<p>This PR doesn’t fully fix #16457. The point of that issue is that FURB161 should be unsafe by default, with a few exceptions. This PR keeps it safe by default, the only exception being string literals.</p>
</blockquote>
<p>Thanks for the explanation. I approved the modification to make the rule unsafe if we can not determine if the argument of the <code>bin</code> method is of type <code>int</code> or <code>bool</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dscorbett">@dscorbett</a> on 2025-04-07 19:43</div>
            <div class="timeline-body"><p>Using <code>ResolvedPythonType::from</code> would help catch more expressions than literals, like <code>-1</code> or <code>1 + 2</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/refurb/rules/bit_count.rs</code>:33 on 2025-04-10 20:23</div>
            <div class="timeline-body"><p>We also want to say explicitly when it is safe, since it's not always unsafe. Maybe something like this?</p>
<pre><code class="language-suggestion">/// ## Fix safety
/// This rule's fix is marked as unsafe unless the argument to `bin` can be inferred as
/// an instance of a type that implements the `__index__` and `bit_count` methods.
///
</code></pre>
<p>I think we could also possibly drop the mention of <code>__index__</code> since we're always just calling <code>bit_count</code> right? Based on my reading of the <code>__index__</code> <a href="https://docs.python.org/3/reference/datamodel.html#object.__index__">docs</a>, it's actually a requirement for calling <code>bin</code> itself rather than a requirement to call <code>bit_count</code> as seems more relevant here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/refurb/rules/bit_count.rs</code>:125 on 2025-04-10 20:35</div>
            <div class="timeline-body"><p>I think instead of returning a second <code>bool</code> here, you can just return an <code>Applicability</code> and use that with <code>Fix::applicable_edit</code> instead of branching on <code>fix_is_safe</code> down below.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/refurb/rules/bit_count.rs</code>:169 on 2025-04-10 20:36</div>
            <div class="timeline-body"><p>I can't highlight the line directly, but I think <code>Expr::BooleanLiteral</code> should also allow a safe edit, at least that's what it sounds like from the issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/refurb/snapshots/ruff_linter__rules__refurb__tests__FURB161_FURB161.py.snap</code>:15 on 2025-04-10 20:38</div>
            <div class="timeline-body"><p>This is a separate issue from the changes here, but I don't think <code>Expr::Name</code>s need to be parenthesized. Let's not modify this here, but I'm surprised to see <code>(x).bit_count</code> instead of <code>x.bit_count</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/refurb/snapshots/ruff_linter__rules__refurb__tests__FURB161_FURB161.py.snap</code>:119 on 2025-04-10 20:40</div>
            <div class="timeline-body"><p>This one is also a bit unfortunate because this is obviously an integer. I think this would be helped by <code>ResolvedPythonType::from</code> as @dscorbett suggested.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> requested changes on 2025-04-10 20:52</div>
            <div class="timeline-body"><p>Thanks for working on this! Overall I think this is good, but we can simplify things a bit by using a fix <code>Applicability</code>, and then I think we can do a better job with type inference with <code>ResolvedPythonType::from</code>, specifically for <code>Expr::BinOp</code> (cases like <code>1 + 2</code>) and for <code>Expr::UnOp</code> (cases like <code>-1</code>).</p>
<p>If we extend the safe handling to <code>bool</code>, we may also be able to resolve expressions like <code>True or False</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/VascoSch92">@VascoSch92</a> on <code>crates/ruff_linter/src/rules/refurb/rules/bit_count.rs</code>:125 on 2025-04-18 10:00</div>
            <div class="timeline-body"><p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/VascoSch92">@VascoSch92</a> reviewed on 2025-04-18 10:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/VascoSch92">@VascoSch92</a> reviewed on 2025-04-18 10:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/VascoSch92">@VascoSch92</a> on <code>crates/ruff_linter/src/rules/refurb/snapshots/ruff_linter__rules__refurb__tests__FURB161_FURB161.py.snap</code>:119 on 2025-04-18 10:28</div>
            <div class="timeline-body"><p>Now it is safe ;-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/VascoSch92">@VascoSch92</a> on 2025-04-18 10:29</div>
            <div class="timeline-body"><blockquote>
<p>Thanks for working on this! Overall I think this is good, but we can simplify things a bit by using a fix <code>Applicability</code>, and then I think we can do a better job with type inference with <code>ResolvedPythonType::from</code>, specifically for <code>Expr::BinOp</code> (cases like <code>1 + 2</code>) and for <code>Expr::UnOp</code> (cases like <code>-1</code>).</p>
<p>If we extend the safe handling to <code>bool</code>, we may also be able to resolve expressions like <code>True or False</code>.</p>
</blockquote>
<p>Hey @ntBre
I changed to use <code>ResolvedPythonType</code>. Let me know if I used it in the correct way ;-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @VascoSch92 on 2025-04-18 10:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-18 17:36</div>
            <div class="timeline-body"><p>Thanks, it looks good to me!</p>
<p>Let's save this for a follow-up PR like the <code>Expr::Name</code> idea I mentioned above, but I think we can even do better than <code>ResolvedPythonType</code> to handle variable assignments too, like the <code>x = 10</code> case in the existing tests. There doesn't seem to be an existing <code>is_bool</code> function in our <code>typing</code> module, but we could easily add one similar to <code>is_int</code>:</p>
<p>https://github.com/astral-sh/ruff/blob/27a315b74095fa0d4dd83749b8a5ff567e06a38b/crates/ruff_python_semantic/src/analyze/typing.rs#L968-L971</p>
<p>You definitely don't have to work on this, just a couple of ideas if you're interested :)</p>
<p>I pushed two tiny tweaks:</p>
<ul>
<li>reverting a couple of lines that just moved around throughout the PR</li>
<li>adding a little more context to the fix safety docs</li>
</ul>
<p>I'll merge as soon as CI passes!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-04-18 17:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`refurb`] Unsafe fixes in `FURB161`" to "[`refurb`] Mark the `FURB161` fix unsafe except for integers and booleans" by @ntBre on 2025-04-18 17:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-04-18 17:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-04-18 17:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-18 18:00</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:33:28 UTC
    </footer>
</body>
</html>
