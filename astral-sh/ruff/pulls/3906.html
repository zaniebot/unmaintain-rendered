<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pretty print `Diagnostic`s in snapshot tests - astral-sh/ruff #3906</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Pretty print <code>Diagnostic</code>s in snapshot tests</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/3906">#3906</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-04-07 17:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><p>This PR extends the <code>TextEmitter</code> to print diffs for fixes (explicit opt-in) and changes the snapshot tests to use the <code>TextEmitter</code> instead of <code>assert_yaml_snapshot</code>.</p>
<p>Pretty printing the diagnostics makes our linter tests more resilient to changes.  For example, changing the field ordering of <code>Diagnostic</code> or its representation no longer breaks the snapshot tests because it doesn't change the pretty printed output.</p>
<p>The pretty printed output further has the advantage that it is easier to spot errors.  No more offset counting to verify that the diagnostic or edit points to the right locations.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-04-07 17:34</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #3895</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3895" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #3896</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3896" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #3897</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3897" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #3901</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3901" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #3904</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3904" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>
* <strong>PR #3905</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3905" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>
* <strong>PR #3906</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3906" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3906?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-04-07 17:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_blind_except/snapshots/ruff__rules__flake8_blind_except__tests__BLE001_BLE.py.snap</code>:51 on 2023-04-07 17:45</div>
            <div class="timeline-body"><p>a blind exception... interesting :see_no_evil:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-04-07 18:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/message/diff.rs</code>:13 on 2023-04-07 18:57</div>
            <div class="timeline-body"><p>What do we do in production? Continue to show just the changed line?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-04-07 18:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/message/diff.rs</code>:25 on 2023-04-07 18:57</div>
            <div class="timeline-body"><p>Should this be <code>try_from_message</code>? Or is <code>try_from_*</code> only used for <code>Result</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-04-07 18:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/message/diff.rs</code>:13 on 2023-04-07 18:58</div>
            <div class="timeline-body"><p>Oh right, sorry, in production we don't show suggested fixes at all, we only show the suggestion <em>message</em>, and highlight the relevant code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/message/diff.rs</code>:13 on 2023-04-07 18:59</div>
            <div class="timeline-body"><p>I do wonder if there's anything we can leverage from Clippy or rustc to facilitate printing diffs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-04-07 18:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-04-07 18:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-04-07 19:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/message/diff.rs</code>:182 on 2023-04-07 19:01</div>
            <div class="timeline-body"><p>Not sure if it was removed but we do have <code>num_digits</code> in <code>printer.rs</code>, maybe whatever was relying on that can leverage this now too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-04-07 19:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/message/diff.rs</code>:13 on 2023-04-07 19:40</div>
            <div class="timeline-body"><p>We can look into it when redoing Diagnostics. I would like to replace annotate snippet and colored. Ideally, the code frame and diff is something we build ourselves as it is an important core component of all our tools. This is something that we could inherit from Rome</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-04-07 20:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/message/diff.rs</code>:25 on 2023-04-07 20:15</div>
            <div class="timeline-body"><p>Not sure. <code>NonZeroUsize</code> returns <code>Option</code> from <code>new</code>. My reasoning is that it isn't failing, it's just that not all <code>Message</code>s can print a <code>diff</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-04-07 20:30</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.01     14.3Â±0.02ms     2.9 MB/sec    1.00     14.1Â±0.03ms     2.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.6Â±0.01ms     4.7 MB/sec    1.00      3.6Â±0.00ms     4.7 MB/sec
linter/all-rules/numpy/globals.py          1.00    458.9Â±1.56Âµs     6.4 MB/sec    1.00    457.8Â±0.81Âµs     6.4 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.1Â±0.03ms     4.2 MB/sec    1.00      6.0Â±0.05ms     4.2 MB/sec
linter/default-rules/large/dataset.py      1.02      7.3Â±0.01ms     5.5 MB/sec    1.00      7.2Â±0.01ms     5.6 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01   1637.4Â±8.55Âµs    10.2 MB/sec    1.00   1623.1Â±3.21Âµs    10.3 MB/sec
linter/default-rules/numpy/globals.py      1.00    180.4Â±0.34Âµs    16.4 MB/sec    1.00    180.4Â±1.29Âµs    16.4 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.4Â±0.00ms     7.6 MB/sec    1.00      3.3Â±0.01ms     7.7 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.01     16.1Â±0.31ms     2.5 MB/sec    1.00     16.0Â±0.27ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      4.2Â±0.15ms     4.0 MB/sec    1.00      4.1Â±0.10ms     4.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    498.7Â±8.04Âµs     5.9 MB/sec    1.01   503.7Â±13.83Âµs     5.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.8Â±0.16ms     3.7 MB/sec    1.00      6.8Â±0.15ms     3.7 MB/sec
linter/default-rules/large/dataset.py      1.00      8.2Â±0.13ms     5.0 MB/sec    1.00      8.2Â±0.12ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1789.4Â±34.77Âµs     9.3 MB/sec    1.01  1815.9Â±37.32Âµs     9.2 MB/sec
linter/default-rules/numpy/globals.py      1.00    196.3Â±5.87Âµs    15.0 MB/sec    1.01    197.3Â±6.50Âµs    15.0 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.7Â±0.06ms     6.8 MB/sec    1.01      3.8Â±0.07ms     6.8 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2023-04-11 07:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-04-11 09:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-04-11 09:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-04-11 09:03</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:56:59 UTC
    </footer>
</body>
</html>
