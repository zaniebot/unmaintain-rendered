<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Enforce `typing.Final` - astral-sh/ruff #19178</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Enforce <code>typing.Final</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19178">#19178</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-07-07 14:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body">Summary
<p>Emit a diagnostic when a <code>Final</code>-qualified symbol is modified. This first iteration only works for name targets. Tests with TODO comments were added for attribute assignments as well.</p>
<p>related ticket: <a href="https://github.com/astral-sh/ty/issues/158">astral-sh/ty#158</a></p>
Ecosystem impact
<p>Correctly identified <a href="https://github.com/sphinx-doc/sphinx/blob/7b4164a5f2b64781475e64daf2d05cce2a0261d8/sphinx/__init__.py#L44">modification of a <code>Final</code> symbol</a> (behind a <code># type: ignore</code>):</p>
<pre><code>- warning[unused-ignore-comment] sphinx/__init__.py:44:56: Unused blanket `type: ignore` directive
</code></pre>
<p>And the same <a href="https://github.com/python-trio/trio/blob/5471a37e82b36f556e0d26b36cb95a6b05afbef1/src/trio/_core/_run.py#L128">here</a>:</p>
<pre><code>- warning[unused-ignore-comment] src/trio/_core/_run.py:128:45: Unused blanket `type: ignore` directive
</code></pre>
Test Plan
<p>New Markdown tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-07 14:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-07 14:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-07 14:10</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>trio (https://github.com/python-trio/trio)
- warning[unused-ignore-comment] src/trio/_core/_run.py:128:45: Unused blanket `type: ignore` directive
- Found 799 diagnostics
+ Found 798 diagnostics

sphinx (https://github.com/sphinx-doc/sphinx)
- warning[unused-ignore-comment] sphinx/__init__.py:44:56: Unused blanket `type: ignore` directive
- Found 606 diagnostics
+ Found 605 diagnostics

</code></pre>


Memory usage changes were detected when running on open source projects

<pre><code>flake8 (https://github.com/pycqa/flake8)
-     memo fields = ~63MB
+     memo fields = ~66MB

trio (https://github.com/python-trio/trio)
-     memo fields = ~152MB
+     memo fields = ~159MB

sphinx (https://github.com/sphinx-doc/sphinx)
- TOTAL MEMORY USAGE: ~316MB
+ TOTAL MEMORY USAGE: ~332MB

prefect (https://github.com/PrefectHQ/prefect)
-     memo fields = ~541MB
+     memo fields = ~568MB

</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-08 11:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-08 11:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-08 11:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-08 11:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/type_qualifiers/final.md</code>:121 on 2025-07-08 13:02</div>
            <div class="timeline-body"><p>nit: maybe this might be a better message?</p>
<pre><code>FINAL_A = 2  # error: [invalid-assignment] &quot;Reassignment of `Final` symbol `FINAL_A` is not allowed&quot;
</code></pre>
<p>since you&#x27;re obviously allowed to assign to the <code>Final</code> symbol at the point where it&#x27;s initially declared ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/type_qualifiers/final.md</code>:164 on 2025-07-08 13:07</div>
            <div class="timeline-body"><p>relevant discussion on this: https://discuss.python.org/t/imported-final-variable/82429</p>
<p>I sort-of disagree with the resolution there, but don&#x27;t have the energy to relitigate the question now ðŸ˜† and it comes up very rarely. It&#x27;s good for us to follow the behaviour the spec mandates, anyway (no change requested!).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/type_qualifiers/final.md</code>:199 on 2025-07-08 13:13</div>
            <div class="timeline-body"><p>Yes -- pyre (and possibly pyrefly? Can&#x27;t remember the exact status) has a feature called <code>ImmutableRef</code>, which they <a href="https://youtu.be/7uixlNTOY4s?si=EcjO2lUf_vvx72iv&amp;t=7816">presented on</a> at the typing summit this year. It&#x27;s similar to <code>Final</code> but it also prevents any mutations to the symbol. It&#x27;s a far more invasive and more complicated feature to implement; I&#x27;m not sure if it&#x27;s ever going to be proposed for standardisation in the typing system.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:1587 on 2025-07-08 13:19</div>
            <div class="timeline-body"><p>doesn&#x27;t need to be done in this PR: should we add a <code>Place::is_definitely_bound()</code> method? It feels like we have a <em>lot</em> of these <code>if matches!()</code> conditions around the codebase</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:1666 on 2025-07-08 13:20</div>
            <div class="timeline-body"><p>Could we add a subdiagnostic pointing to the previous definition where it was declared as <code>Final</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-07-08 13:21</div>
            <div class="timeline-body"><p>ðŸš€</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-07-08 14:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:1666 on 2025-07-08 14:13</div>
            <div class="timeline-body"><p>Yes, thanks for the suggestion! It&#x27;s hard to do this for imported symbols (unless @Gankra adds a vector of <code>Definition</code>s to <code>Place</code> :smile:), but I added a subdiagnostic for same-module <code>Final</code>s:</p>
<p><img src="https://github.com/user-attachments/assets/a897eaac-3ec1-49cb-bd78-9a90a9898c84" alt="image"></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/snapshots/final.md_-_`typing.Final`_-_Full_diagnostics_(174fdd8134fb325b).snap</code>:38 on 2025-07-08 14:16</div>
            <div class="timeline-body"><p>even better might be</p>
<pre><code>3 | MY_CONSTANT: Final[int] = 1
  |              ---------- Symbol declared as `Final` here
4 |
5 | # more code
6 |
7 | MY_CONSTANT = 2  # error: [invalid-assignment]
  | ^^^^^^^^^^^^^^^ Symbol later reassigned here
</code></pre>
<p>but probably not worth spending time on that now if that&#x27;s hard to achieve!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-07-08 14:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-07-08 14:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/resources/mdtest/snapshots/final.md_-_`typing.Final`_-_Full_diagnostics_(174fdd8134fb325b).snap</code>:38 on 2025-07-08 14:25</div>
            <div class="timeline-body"><p>I tried to highlight the full range for the assignment, but for (annotated) assignments, <code>full_range</code> apparently only includes the left hand side target. I&#x27;ll try to change that in a follow-up, since it might affect other diagnostics.</p>
<p>Highlighting the annotation for the original definition would also be nice, but is a bit harder because we would need to explicitly match on different definition kinds.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-08 14:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-08 14:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-08 14:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-07-08 14:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:1587 on 2025-07-08 14:26</div>
            <div class="timeline-body"><p>will look into it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/oconnor663">@oconnor663</a> reviewed on 2025-07-09 18:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/oconnor663">@oconnor663</a> on <code>crates/ty_python_semantic/resources/mdtest/type_qualifiers/final.md</code>:150 on 2025-07-09 18:30</div>
            <div class="timeline-body"><p>This TODO isn&#x27;t going to last long: rebasing <a href="https://github.com/astral-sh/ruff/pull/19112">astral-sh/ruff#19112</a> on top of this PR makes this line fail :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-07-09 19:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/resources/mdtest/type_qualifiers/final.md</code>:150 on 2025-07-09 19:15</div>
            <div class="timeline-body"><p>I added that just for you :gift:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-07-10 12:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:1587 on 2025-07-10 12:08</div>
            <div class="timeline-body"><p>I looked into it, but it seems like such a function would only have this callsite. In most other cases, we also match on the type at the same time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-07-10 12:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:1587 on 2025-07-10 12:20</div>
            <div class="timeline-body"><p>Oh, fair enough!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:16:20 UTC
    </footer>
</body>
</html>
