<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Fix mixed tuple subtyping - astral-sh/ruff #18852</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Fix mixed tuple subtyping</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18852">#18852</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2025-06-21 18:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/carljm">@carljm</a> on 2025-06-21 18:03</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>The code in the <code>Variable</code> branch of <code>VariableLengthTupleSpec::has_relation_to</code> made the incorrect assumption that if you zip two possibly-different-length iterators together and iterate over the resulting zip iterator, the original two iterators will only have their common elements consumed. But in fact, the zip iterator detects that it is done when it receives a <code>None</code> from one iterator and <code>Some()</code> element from the other iterator, which means that it consumes one additional element from the longer iterator. This meant that we failed to detect mismatched types on this extra consumed element, because we never compared it to the variable type of the other tuple.</p>
<p>Use <code>zip_longest</code> from itertools as an alternative, which allows us to combine all the handling into just two <code>zip_longest</code>, one for prefixes and one for suffixes.</p>
<p>Marking this PR internal since it fixes a bug in a commit that wasn't released yet.</p>
<h2>Test Plan</h2>
<p>Added mdtests that failed before this fix and pass after it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @carljm on 2025-06-21 18:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @carljm on 2025-06-21 18:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @carljm on 2025-06-21 18:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @carljm on 2025-06-21 18:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @carljm on 2025-06-21 18:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-21 18:06</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-21 18:14</div>
            <div class="timeline-body"><p>Nit: An alternative would be https://docs.rs/itertools/latest/itertools/trait.Itertools.html#method.zip_longest</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-06-21 18:42</div>
            <div class="timeline-body"><p>@MichaReiser recommending itertools? What is happening? ðŸ˜†</p>
<p>...ok, that is pretty nice. Updated.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-06-21 19:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @carljm on 2025-06-21 20:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-06-21 20:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-21 20:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-06-23 12:47</div>
            <div class="timeline-body"><p>Thanks for catching this!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 18:39:36 UTC
    </footer>
</body>
</html>
