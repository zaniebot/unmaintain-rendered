```yaml
number: 4951
title: Format Function definitions
type: pull_request
state: merged
author: MichaReiser
labels:
  - internal
  - formatter
assignees: []
merged: true
base: main
head: format-function-definition
created_at: 2023-06-08T05:57:56Z
updated_at: 2023-06-09T06:18:44Z
url: https://github.com/astral-sh/ruff/pull/4951
synced_at: 2026-01-12T03:43:29Z
```

# Format Function definitions

---

_Pull request opened by @MichaReiser on 2023-06-08 05:57_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This PR implements formatting for function definitions and async function definitions. The formatting should be fairly complete.

## Test Plan

I added a few of my own test cases and reviewed the black differences.


---

_Comment by @MichaReiser on 2023-06-08 05:58_

Current dependencies on/for this PR:
* main
  * **PR #4954** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4954" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #4921** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4921" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #4922** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4922" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #4951** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4951" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
          * **PR #4961** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4961" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
            * **PR #4964** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4964" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
              * **PR #4979** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4979" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
              * **PR #4978** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4978" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/4951?utm_source=stack-comment).

---

_Comment by @github-actions[bot] on 2023-06-08 06:40_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      7.2Â±0.19ms     5.7 MB/sec    1.02      7.3Â±0.11ms     5.6 MB/sec
formatter/numpy/ctypeslib.py               1.00  1294.9Â±26.02Âµs    12.9 MB/sec    1.00  1297.4Â±26.58Âµs    12.8 MB/sec
formatter/numpy/globals.py                 1.00    146.5Â±3.94Âµs    20.1 MB/sec    1.02    149.2Â±1.42Âµs    19.8 MB/sec
formatter/pydantic/types.py                1.00      3.0Â±0.05ms     8.6 MB/sec    1.02      3.0Â±0.05ms     8.5 MB/sec
linter/all-rules/large/dataset.py          1.00     16.3Â±0.23ms     2.5 MB/sec    1.00     16.3Â±0.29ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.9Â±0.05ms     4.3 MB/sec    1.00      3.9Â±0.07ms     4.3 MB/sec
linter/all-rules/numpy/globals.py          1.00   469.2Â±13.01Âµs     6.3 MB/sec    1.03    484.2Â±4.42Âµs     6.1 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.7Â±0.11ms     3.8 MB/sec    1.02      6.8Â±0.10ms     3.7 MB/sec
linter/default-rules/large/dataset.py      1.00      7.7Â±0.18ms     5.3 MB/sec    1.03      7.9Â±0.07ms     5.2 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1628.2Â±44.42Âµs    10.2 MB/sec    1.04  1688.6Â±23.05Âµs     9.9 MB/sec
linter/default-rules/numpy/globals.py      1.02    186.4Â±2.03Âµs    15.8 MB/sec    1.00    183.4Â±3.77Âµs    16.1 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.5Â±0.08ms     7.3 MB/sec    1.02      3.5Â±0.04ms     7.2 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      9.1Â±0.29ms     4.5 MB/sec    1.01      9.3Â±0.23ms     4.4 MB/sec
formatter/numpy/ctypeslib.py               1.00  1581.2Â±59.49Âµs    10.5 MB/sec    1.03  1627.8Â±50.84Âµs    10.2 MB/sec
formatter/numpy/globals.py                 1.00   174.8Â±10.52Âµs    16.9 MB/sec    1.02    178.9Â±8.62Âµs    16.5 MB/sec
formatter/pydantic/types.py                1.00      3.7Â±0.11ms     6.9 MB/sec    1.04      3.8Â±0.13ms     6.7 MB/sec
linter/all-rules/large/dataset.py          1.00     18.6Â±0.44ms     2.2 MB/sec    1.11     20.7Â±0.51ms  2010.3 KB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.8Â±0.16ms     3.5 MB/sec    1.10      5.2Â±0.14ms     3.2 MB/sec
linter/all-rules/numpy/globals.py          1.00   561.3Â±27.93Âµs     5.3 MB/sec    1.06   597.6Â±18.10Âµs     4.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      8.0Â±0.25ms     3.2 MB/sec    1.09      8.8Â±0.25ms     2.9 MB/sec
linter/default-rules/large/dataset.py      1.00      9.4Â±0.25ms     4.3 MB/sec    1.13     10.6Â±0.22ms     3.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00      2.1Â±0.09ms     8.0 MB/sec    1.08      2.3Â±0.09ms     7.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    237.5Â±9.24Âµs    12.4 MB/sec    1.05   249.3Â±17.36Âµs    11.8 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.5Â±0.13ms     5.7 MB/sec    1.07      4.8Â±0.18ms     5.3 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Label `internal` added by @MichaReiser on 2023-06-08 10:15_

---

_Label `autoformatter` added by @MichaReiser on 2023-06-08 10:15_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/generate.py`:82 on 2023-06-08 10:16_

This was a bit unexpected haha... 

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/comments/placement.rs`:108 on 2023-06-08 10:17_

using `default` here yields an incorrect result if the body is on the same line as the case header. Using `usize::MAX` should be fairly safe ;)

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/lib.rs`:42 on 2023-06-08 10:18_

The leading and trailing comments normally appear before the node and have lower source positions. That's why we should move the node's source position to just cover the node itself. 

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/snapshots/ruff_python_formatter__tests__black_test__docstring_py.snap`:238 on 2023-06-08 10:20_

This PR does not implement any special handling for docstrings yet.

---

_@MichaReiser reviewed on 2023-06-08 11:01_

---

_Marked ready for review by @MichaReiser on 2023-06-08 11:01_

---

_Review requested from @konstin by @MichaReiser on 2023-06-08 11:07_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/other/arg.rs`:34 on 2023-06-08 12:12_

```suggestion
            // The name of the argument
            [source_text_slice(
```

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/other/arguments.rs`:36 on 2023-06-08 12:26_

strange decision on the grammar or parser side to emit the default separate from the argument

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/other/arguments.rs`:51 on 2023-06-08 12:29_

so confusing that pos only arguments are in front of the slash, but keyword arguments are after the star (your code is correct)

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/other/arguments.rs`:103 on 2023-06-08 12:41_

```suggestion
            // Break group if there is a trailing comma
            if let Some(last_node) = last_node {
```

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/other/arguments.rs`:103 on 2023-06-08 12:42_

Does this also need to read the magic trailing comma setting?

---

_@konstin approved on 2023-06-08 12:50_

---

_@MichaReiser reviewed on 2023-06-08 13:02_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/other/arguments.rs`:103 on 2023-06-08 13:02_

If we introduce a setting for this, then yes

---

_@MichaReiser reviewed on 2023-06-08 13:19_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/other/arg.rs`:34 on 2023-06-08 13:19_

Good point!

---

_@MichaReiser reviewed on 2023-06-08 13:19_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/other/arguments.rs`:36 on 2023-06-08 13:19_

Haha yeah. I got it wrong so many times. The most recent version of `RustPython` now tracks the `default` on the argument but I haven't had time to upgrade yet.

---

_@konstin reviewed on 2023-06-08 13:25_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/other/arguments.rs`:103 on 2023-06-08 13:25_

i forgot this isn't merged: https://github.com/astral-sh/ruff/pull/4878/files#diff-c1f1071e384c9f14936cad67780f301345744791e34afd93cada2cf43af8dcb5R18

I haven't looked into how to pass settings, but i think it makes sense to introduce the boolean for that now

---

_@MichaReiser reviewed on 2023-06-08 13:35_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/other/arguments.rs`:103 on 2023-06-08 13:35_

The intended way for settings is that Ruff defines a `PyFormatOption` struct that implements `FormatOptions` and is passed to the `PyFormatContext` (instead of using the generic `SimpleFormatOptions`). You can then access it with `f.context().options()....`

https://github.com/charliermarsh/ruff/blob/dc7cdb04e17cd9aae7ab63976424b01bf040f8d3/crates/ruff_formatter/src/lib.rs#L257-L277

---

_Closed by @MichaReiser on 2023-06-08 15:54_

---

_Reopened by @MichaReiser on 2023-06-08 15:54_

---

_Merged by @MichaReiser on 2023-06-08 16:07_

---

_Closed by @MichaReiser on 2023-06-08 16:07_

---

_Branch deleted on 2023-06-08 16:07_

---
