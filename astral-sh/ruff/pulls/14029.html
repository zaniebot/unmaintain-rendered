<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] use fixpoint iteration for all cycles - astral-sh/ruff #14029</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] use fixpoint iteration for all cycles</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14029">#14029</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2024-11-01 00:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body"><p>Pulls in the latest Salsa main branch, which supports fixpoint iteration, and uses it to handle all query cycles.</p>
<p>With this, we no longer need to skip any corpus files to avoid panics.</p>
<p>Latest perf results show a 6% incremental and 1% cold-check regression. This is not a &quot;no cycles&quot; regression, as tomllib and typeshed do trigger some definition cycles (previously handled by our old <code>infer_definition_types</code> fallback to <code>Unknown</code>). We don't currently have a benchmark we can use to measure the pure no-cycles regression, though I expect there would still be some regression; the fixpoint iteration feature in Salsa does add some overhead even for non-cyclic queries.</p>
<p>I think this regression is within the reasonable range for this feature. We can do further optimization work later, but I don't think it's the top priority right now. So going ahead and acknowledging the regression on CodSpeed.</p>
<p>Mypy primer is happy, so this doesn't regress anything on our currently-checked projects. I expect it probably unlocks adding a number of new projects to our ecosystem check that previously would have panicked.</p>
<p>Fixes #13792
Fixes #14672</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @carljm on 2024-11-01 00:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-11-01 00:28</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_INSTRUMENTATION_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/cjm%2Ffixpoint">CodSpeed Performance Report</a></h2>
<h3>Merging #14029 will <strong>degrade performances by 5.98%</strong></h3>
<p><sub>Comparing <code>cjm/fixpoint</code> (328e31e) with <code>main</code> (a6572a5)</sub></p>
<h3>Summary</h3>
<p><code>‚ùå 1 (üëÅ 1)</code> regressions<br />
<code>‚úÖ 31</code> untouched benchmarks</p>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| üëÅ | <code>red_knot_check_file[incremental]</code> | 4.9 ms | 5.2 ms | -5.98% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-01 00:43</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>‚úÖ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>‚úÖ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-15 06:29</div>
            <div class="timeline-body"><p>Nice on bringing down the regression. I'm still somewhat surprised that we see an 11% perf regression and a 4 perf regression in the salsa benchmarks (that don't have any cycles).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-11-15 14:59</div>
            <div class="timeline-body"><p>Yeah I planned to do some more looking at profiles; thanks for doing that!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[WIP] initial fixpoint iteration" to "[red-knot] use fixpoint iteration for all cycles" by @carljm on 2025-03-12 05:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-12 05:35</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ‚úÖ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @carljm on 2025-03-12 05:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @carljm on 2025-03-12 05:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @carljm on 2025-03-12 05:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @carljm on 2025-03-12 05:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_project/tests/check.rs</code>:282 on 2025-03-12 07:21</div>
            <div class="timeline-body"><p>Should we delete this functionality now that all known failures are fixed? Do we forsee situations where it is okay for a PR to introduce a new panic case over fixing the panic?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-03-12 07:22</div>
            <div class="timeline-body"><p>This looks good to me. Do you think it would be useful to have any documentation on when/where to add cycle fallbacks or documentation on the cycle fallback function itself?</p>
<p>And very impressive that this results in only a 1% perf regression in the cold case. Nice work!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-03-12 12:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_project/tests/check.rs</code>:282 on 2025-03-12 12:04</div>
            <div class="timeline-body"><p>It's a good question. I thought we could keep it for now. I <em>think</em> any new cycle cases we run into should be easy to fix by adding cycle handling for a new query, but it's possible we could run into such a case where it's difficult to get the cycle handling correct and it makes more sense to split it into a separate PR, in which scenario we might still use this? I don't feel strongly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-12 12:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_project/tests/check.rs</code>:282 on 2025-03-12 12:06</div>
            <div class="timeline-body"><p>That makes sense. Although that also likely means that we would start regressing on projects that Red Knot supported before. So maybe the correct order would be to fix the cycle first, and then land the behavior change?</p>
<p>I don't feel strongly either and am happy to go either way. It just feels nice if regressing panics is <em>not easy</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-03-12 12:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_project/tests/check.rs</code>:282 on 2025-03-12 12:11</div>
            <div class="timeline-body"><blockquote>
<p>we would start regressing on projects that Red Knot supported before</p>
</blockquote>
<p>Maybe; it depends whether the PR is actually regressing on existing files (in this case I would be more hesitant to allow using <code>KNOWN_FAILURES</code>), or if it is e.g. an unrelated Ruff linter PR adding a new test file, which reveals an existing-but-not-previously-tested cycle. This latter case is I think the strongest reason to keep <code>KNOWN_FAILURES</code> around for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-03-12 12:17</div>
            <div class="timeline-body"><blockquote>
<p>Do you think it would be useful to have any documentation on when/where to add cycle fallbacks or documentation on the cycle fallback function itself?</p>
</blockquote>
<p>Yes, I can add that. I think the latter is probably the most useful and will serve as the former by example, too? Not sure where to put the former that it would be discoverable when needed. Also, Salsa's panic message if you do hit a cycle on a query without cycle handling is pretty informative and would be enough to find existing examples to copy.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-03-12 12:37</div>
            <div class="timeline-body"><p>Changed my mind -- too many cases of cycle handling, felt too redundant to repeat the same docs on each. So I added a paragraph to the doc comment at the top of <code>infer.rs</code>, where all but one of our queries with cycle handling live.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @carljm on 2025-03-12 12:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-03-12 12:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-03-12 12:41</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:07:22 UTC
    </footer>
</body>
</html>
