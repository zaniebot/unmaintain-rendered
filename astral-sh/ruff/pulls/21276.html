<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Make special cases for `UnionType` slightly narrower - astral-sh/ruff #21276</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Make special cases for <code>UnionType</code> slightly narrower</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21276">#21276</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-11-04 20:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><p>Fixes <a href="https://github.com/astral-sh/ty/issues/1478">astral-sh/ty#1478</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-04 20:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-11-04 20:50</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-11-04 20:51</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>more-itertools (https://github.com/more-itertools/more-itertools)
+ more_itertools/more.pyi:215:16: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ more_itertools/more.pyi:216:15: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ more_itertools/more.pyi:218:23: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ more_itertools/more.pyi:638:42: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ more_itertools/more.pyi:642:52: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
- Found 24 diagnostics
+ Found 29 diagnostics

pytest (https://github.com/pytest-dev/pytest)
+ src/_pytest/_code/code.py:676:34: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ src/_pytest/_code/code.py:789:29: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ src/_pytest/_code/code.py:818:29: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
- Found 481 diagnostics
+ Found 484 diagnostics

Tanjun (https://github.com/FasterSpeeding/Tanjun)
+ tanjun/annotations.py:389:42: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ tanjun/annotations.py:414:45: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ tanjun/annotations.py:600:41: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ tanjun/annotations.py:615:41: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ tanjun/annotations.py:629:41: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ tanjun/annotations.py:2263:21: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ tanjun/annotations.py:2263:62: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ tanjun/annotations.py:2276:38: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ tanjun/annotations.py:2276:72: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ tanjun/annotations.py:2289:53: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ tanjun/annotations.py:2371:50: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
- Found 145 diagnostics
+ Found 156 diagnostics

trio (https://github.com/python-trio/trio)
+ src/trio/_core/_traps.py:67:10: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ src/trio/_core/_traps.py:68:16: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ src/trio/_core/_traps.py:75:16: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
- Found 592 diagnostics
+ Found 595 diagnostics

django-stubs (https://github.com/typeddjango/django-stubs)
+ django-stubs/test/utils.pyi:23:28: error[invalid-type-form] Variable of type `_SpecialForm` is not allowed in a type expression
- Found 480 diagnostics
+ Found 481 diagnostics

bokeh (https://github.com/bokeh/bokeh)
+ src/bokeh/embed/standalone.py:137:49: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ src/bokeh/embed/standalone.py:140:12: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ src/bokeh/embed/standalone.py:144:49: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ src/bokeh/embed/standalone.py:147:12: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ src/bokeh/embed/standalone.py:151:49: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ src/bokeh/embed/standalone.py:154:12: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ src/bokeh/embed/standalone.py:157:52: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ src/bokeh/embed/standalone.py:299:22: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ src/bokeh/embed/standalone.py:370:62: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
- Found 616 diagnostics
+ Found 625 diagnostics

pandas-stubs (https://github.com/pandas-dev/pandas-stubs)
+ pandas-stubs/_typing.pyi:506:49: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ pandas-stubs/_typing.pyi:526:56: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ pandas-stubs/_typing.pyi:526:64: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ pandas-stubs/_typing.pyi:911:26: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ pandas-stubs/_typing.pyi:913:26: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ pandas-stubs/_typing.pyi:914:40: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ pandas-stubs/_typing.pyi:916:28: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ pandas-stubs/_typing.pyi:918:36: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ pandas-stubs/_typing.pyi:919:26: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
+ pandas-stubs/_typing.pyi:932:5: error[invalid-type-form] Variable of type `UnionType` is not allowed in a type expression
- Found 5415 diagnostics
+ Found 5425 diagnostics

</code></pre>

No memory usage changes detected ✅

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-04 21:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-11-04 21:19</div>
            <div class="timeline-body">

<code>ecosystem-analyzer</code> results
<p>| Lint rule | Added | Removed | Changed |
|-----------|------:|--------:|--------:|
| <code>invalid-type-form</code> | 42 | 0 | 0 |
| <strong>Total</strong> | <strong>42</strong> | <strong>0</strong> | <strong>0</strong> |</p>
<p><strong><a href="https://alex-fix-union-wildcards.ecosystem-663.pages.dev/diff">Full report with detailed diff</a></strong> (<a href="https://alex-fix-union-wildcards.ecosystem-663.pages.dev/timing">timing results</a>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-04 21:23</div>
            <div class="timeline-body"><p>Nearly all the new diagnostics are false positive due to things like <code>X = type[str] | int</code>. We already have false positives like this on <code>main</code> (<a href="https://github.com/astral-sh/ruff/pull/21195">astral-sh/ruff#21195</a>#issuecomment-3482524821) and I think @sharkdp is planning on prioritising adding support for this kind of pattern in implicit type aliases</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-04 21:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-04 21:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-04 21:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-04 21:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/infer/builder.rs</code>:8514 on 2025-11-06 13:47</div>
            <div class="timeline-body"><p>I&#x27;m slightly confused why we don&#x27;t need the <code>convert_none_type</code> anymore?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> approved on 2025-11-06 13:47</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-11-06 14:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/infer/builder.rs</code>:8514 on 2025-11-06 14:00</div>
            <div class="timeline-body"><p>Because of <a href="https://github.com/astral-sh/ruff/pull/21263">astral-sh/ruff#21263</a>!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-06 14:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-06 14:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-11-06 14:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-11-06 14:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/infer/builder.rs</code>:8514 on 2025-11-06 14:02</div>
            <div class="timeline-body"><p>:see_no_evil:</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:20:15 UTC
    </footer>
</body>
</html>
