```yaml
number: 5947
title: "Prefer breaking the implicit string concatenation over breaking before `%`"
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: implicit-string-concat-modulo-operator
created_at: 2023-07-21T11:45:45Z
updated_at: 2023-07-24T16:30:44Z
url: https://github.com/astral-sh/ruff/pull/5947
synced_at: 2026-01-12T15:55:20Z
```

# Prefer breaking the implicit string concatenation over breaking before `%`

---

_@MichaReiser_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This PR implements custom formatting for the "old" `%` formatting in combination with implicit string concatination:

```python
( 
	"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
	"bbbbbbbbbbbbbbbbbbbb %s %s" % (a, b)
)
```

The preference is that string expands before breaking before the `%` operator. 

This fixes the most common case of the old style `%` formattign for the django project, but there are a few places where the formatting is used in an add expression:

```python
x = (
	my_value + "aaaaaaaaaaaaaaaaaaaaaaaaaaaa"
		"bbbbbbbbbbbbbbbbbb %s %s" % (a, b) + cc
)
```

The challenge with that formatting is that:
* It should propagate to the assignment that parentheses are necessary
* **but** the outer binary expression (`+`) should remain flat


It's unclear how we would model this with our existing IR.


<!-- What's the purpose of the change? What does it do, and why? -->

## Test Plan


This increases the django compatibility from 0.983 to 0.985. I reviewed the diff manually and it introduces no regressions. 
<!-- How was it tested? -->


---

_Comment by @MichaReiser on 2023-07-21 11:45_

Current dependencies on/for this PR:
* main
  * **PR #5947** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5947" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/5947?utm_source=stack-comment).

---

_Review requested from @konstin by @MichaReiser on 2023-07-21 11:46_

---

_@MichaReiser reviewed on 2023-07-21 11:46_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_bin_op.rs`:84 on 2023-07-21 11:46_

This is unchanged

---

_@MichaReiser reviewed on 2023-07-21 11:50_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/tests/snapshots/format@expression__binary_implicit_string.py.snap`:254 on 2023-07-21 11:50_

These parentheses are incorrect but they get inserted by the tuple formatting. This is probably similar to the *nested binary expression* case in that the string formatting should only enforce the optional parentheses of the `return` statement but not from the tuples. 

---

_Comment by @github-actions[bot] on 2023-07-21 12:27_

## PR Check Results
### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      9.9Â±0.46ms     4.1 MB/sec    1.04     10.3Â±0.39ms     4.0 MB/sec
formatter/numpy/ctypeslib.py               1.01      2.1Â±0.10ms     7.8 MB/sec    1.00      2.1Â±0.11ms     7.9 MB/sec
formatter/numpy/globals.py                 1.00   235.4Â±13.99Âµs    12.5 MB/sec    1.08   254.2Â±12.18Âµs    11.6 MB/sec
formatter/pydantic/types.py                1.00      4.6Â±0.33ms     5.5 MB/sec    1.00      4.6Â±0.22ms     5.5 MB/sec
linter/all-rules/large/dataset.py          1.17     17.9Â±1.15ms     2.3 MB/sec    1.00     15.3Â±0.60ms     2.7 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.2Â±0.23ms     3.9 MB/sec    1.00      4.2Â±0.28ms     3.9 MB/sec
linter/all-rules/numpy/globals.py          1.09   555.9Â±31.77Âµs     5.3 MB/sec    1.00   508.9Â±35.79Âµs     5.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.6Â±0.35ms     3.4 MB/sec    1.01      7.6Â±0.79ms     3.3 MB/sec
linter/default-rules/large/dataset.py      1.24      9.8Â±0.71ms     4.1 MB/sec    1.00      7.9Â±0.37ms     5.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.12      2.1Â±0.11ms     7.9 MB/sec    1.00  1878.1Â±116.59Âµs     8.9 MB/sec
linter/default-rules/numpy/globals.py      1.10   216.9Â±13.27Âµs    13.6 MB/sec    1.00    197.9Â±9.33Âµs    14.9 MB/sec
linter/default-rules/pydantic/types.py     1.17      4.4Â±0.26ms     5.8 MB/sec    1.00      3.7Â±0.22ms     6.8 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     10.8Â±0.10ms     3.8 MB/sec    1.05     11.4Â±0.16ms     3.6 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.2Â±0.03ms     7.7 MB/sec    1.03      2.2Â±0.03ms     7.5 MB/sec
formatter/numpy/globals.py                 1.00    244.9Â±4.65Âµs    12.0 MB/sec    1.02    249.8Â±6.37Âµs    11.8 MB/sec
formatter/pydantic/types.py                1.00      4.7Â±0.06ms     5.4 MB/sec    1.04      4.9Â±0.07ms     5.2 MB/sec
linter/all-rules/large/dataset.py          1.00     15.2Â±0.16ms     2.7 MB/sec    1.00     15.3Â±0.17ms     2.7 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      4.0Â±0.07ms     4.1 MB/sec    1.00      4.0Â±0.06ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.01    487.1Â±9.51Âµs     6.1 MB/sec    1.00    482.0Â±5.44Âµs     6.1 MB/sec
linter/all-rules/pydantic/types.py         1.01      7.0Â±0.10ms     3.6 MB/sec    1.00      7.0Â±0.08ms     3.7 MB/sec
linter/default-rules/large/dataset.py      1.01      8.0Â±0.07ms     5.1 MB/sec    1.00      8.0Â±0.07ms     5.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01  1676.0Â±19.65Âµs     9.9 MB/sec    1.00  1658.9Â±15.73Âµs    10.0 MB/sec
linter/default-rules/numpy/globals.py      1.00    190.7Â±2.64Âµs    15.5 MB/sec    1.01    191.9Â±2.98Âµs    15.4 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.6Â±0.04ms     7.1 MB/sec    1.00      3.6Â±0.04ms     7.1 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Label `formatter` added by @konstin on 2023-07-21 13:46_

---

_@konstin approved on 2023-07-24 10:42_

---

_Merged by @MichaReiser on 2023-07-24 16:30_

---

_Closed by @MichaReiser on 2023-07-24 16:30_

---

_Branch deleted on 2023-07-24 16:30_

---
