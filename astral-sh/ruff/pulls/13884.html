<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Use track_caller for expect_ methods - astral-sh/ruff #13884</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Use track_caller for expect_ methods</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13884">#13884</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2024-10-23 08:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-10-23 08:32</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>A minor quality-of-life improvement: add <a href="https://doc.rust-lang.org/reference/attributes/codegen.html#the-track_caller-attribute"><code>#[track_caller]</code></a> attribute to <code>Type::expect_xyz()</code> methods such that the panic-location is reported one level higher up in the stack trace.</p>
<p>before: reports location inside the <code>Type::expect_class_literal()</code> method. Not very useful.</p>
<pre><code>thread 'types::infer::tests::deferred_annotation_builtin' panicked at crates/red_knot_python_semantic/src/types.rs:304:14:
Expected a Type::ClassLiteral variant
</code></pre>
<p>after: reports location at the <code>Type::expect_class_literal()</code> call site, where the error was made.</p>
<pre><code>thread 'types::infer::tests::deferred_annotation_builtin' panicked at crates/red_knot_python_semantic/src/types/infer.rs:4302:14:
Expected a Type::ClassLiteral variant
</code></pre>
<h2>Test Plan</h2>
<p>Called <code>expect_class_literal()</code> on something that's not a <code>Type::ClassLiteral</code> and saw that the error was reported at the call site.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @sharkdp on 2024-10-23 08:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2024-10-23 08:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @sharkdp on 2024-10-23 08:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2024-10-23 08:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-10-23 08:45</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2024-10-23 08:57</div>
            <div class="timeline-body"><p>TIL, this is great, thanks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-10-23 09:03</div>
            <div class="timeline-body"><p>Nice! TIL as well :-D</p>
<p>Possibly we could also consider adding this attribute to <code>expression_ty</code>, <code>binding_ty</code> and <code>declaration_ty</code> here:</p>
<p>https://github.com/astral-sh/ruff/blob/2f88f849726d50de91efc48ac0148395b7231cd0/crates/red_knot_python_semantic/src/types/infer.rs#L208-L222</p>
<p>The most common source of panics in red-knot right now seems to be that a key is unexpectedly missing from one of these HashMaps, which results in a panic with the message &quot;No entry found for key&quot; and the line number pointing to the line inside the method that does the lookup. It's not a very helpful stack trace!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2024-10-23 10:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2024-10-23 10:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-10-23 10:48</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 21:00:09 UTC
    </footer>
</body>
</html>
