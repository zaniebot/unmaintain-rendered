<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Fix normalization of unions containing instances parameterized with unions - astral-sh/ruff #18112</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Fix normalization of unions containing instances parameterized with unions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18112">#18112</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-05-15 01:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-15 01:38</div>
            <div class="timeline-body"><h2>Summary</h2>
<ul>
<li>Recurse into the specialisations of specialised generics when normalizing them, in order to ensure that <code>Foo[int | str]</code> and <code>Foo[str | int]</code> have the same Salsa ID when normalized</li>
<li>Normalize <code>Unknown</code>, <code>Todo</code> and <code>Any</code> all to <code>Any</code>. I'll be honest here: I still don't totally understand why this is necessary, but I <em>can</em> say that it makes the nondeterministic behaviour on hydra-zen go away. And I think it may be a good thing to do anyway:<ul>
<li>It makes these types easier to reason about when they appear in unions/intersections</li>
<li>It reflects the fact that these types are in fact gradually equivalent.</li>
</ul>
</li>
</ul>
<p>This is stacked on top of https://github.com/astral-sh/ruff/pull/18111, because otherwise it causes some small regressions in our <code>redundant-cast</code> mdtests because of the new normalisations of dynamic types.</p>
<p>Fixes https://github.com/astral-sh/ty/issues/369</p>
<h2>Test Plan</h2>
<ul>
<li>Added mdtests for the issue with instances of specialised generics</li>
<li>Repeatedly ran this branch on hydra-zen using the setup described in https://github.com/astral-sh/ty/issues/369#issue-3061167191 and observed that there was no longer any non-deterministic behaviour when checking hydra-zen (and I can reproduce the non-deterministic behaviour on <code>main</code> using that setup)</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-05-15 01:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-05-15 01:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @AlexWaygood on 2025-05-15 01:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-05-15 01:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2025-05-15 01:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-05-15 01:42</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">hydra-zen (https://github.com/mit-ll-responsible-ai/hydra-zen)
- error[invalid-return-type] src/hydra_zen/wrapper/_implementations.py:945:16: Return type does not match returned value: expected `DataClass_`, found `@Todo(unsupported type[X] special form) | (((...) -&gt; Any) &amp; dict[Unknown, Unknown]) | (DataClass_ &amp; dict[Unknown, Unknown]) | (list[Any] &amp; dict[Unknown, Unknown]) | dict[Any, Any] | (((...) -&gt; Any) &amp; list[Unknown]) | (DataClass_ &amp; list[Unknown]) | list[Any] | (dict[Any, Any] &amp; list[Unknown])`
+ error[invalid-return-type] src/hydra_zen/wrapper/_implementations.py:945:16: Return type does not match returned value: expected `DataClass_`, found `@Todo(unsupported type[X] special form) | (((...) -&gt; Any) &amp; dict[Unknown, Unknown]) | (DataClass_ &amp; dict[Unknown, Unknown]) | (list[Any] &amp; dict[Unknown, Unknown]) | dict[Any, Any] | (((...) -&gt; Any) &amp; list[Unknown]) | (DataClass_ &amp; list[Unknown]) | list[Any]`
- error[type-assertion-failure] tests/annotations/declarations.py:969:5: Argument does not have asserted type `FullBuilds[@Todo(Support for `typing.TypeAlias`)] | PBuilds[@Todo(Support for `typing.TypeAlias`)] | StdBuilds[@Todo(Support for `typing.TypeAlias`)]`
- error[type-assertion-failure] tests/annotations/declarations.py:980:5: Argument does not have asserted type `FullBuilds[@Todo(Support for `typing.TypeAlias`)] | PBuilds[@Todo(Support for `typing.TypeAlias`)] | StdBuilds[@Todo(Support for `typing.TypeAlias`)]`
- Found 645 diagnostics
+ Found 643 diagnostics

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-05-15 02:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-05-15 02:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @AlexWaygood on 2025-05-15 02:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[ty] Fix normalization of unions containing instances generic over unions" to "[ty] Fix normalization of unions containing instances parameterized with unions" by @AlexWaygood on 2025-05-15 02:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-05-15 02:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-05-15 02:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-05-15 02:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-15 10:25</div>
            <div class="timeline-body"><p>Thank you @AlexWaygood.</p>
<p>With this PR, you fixed one particular problem in normalization. I'm not trying to imply that my attempt in https://github.com/astral-sh/ruff/pull/18091 is the right solution, but I think I'm not happy with the current state. There is nothing that prevents us from introducing similar problems in the future. And there is no guarantee that other problems already exist. In fact, it's easy to find <a href="https://play.ty.dev/04e56ba2-3912-4c4d-9158-1bef41d02ac9">other cases that are still problematic</a> by embedding unions in types that we don't have any special handling for, yet. A lot of <code>Type</code>-variants contain <code>Type</code>s further down in their structure, not just unions, intersections and tuples. Especially with the introduction of generics.</p>
<p>We have seen in https://github.com/astral-sh/ty/issues/369 that this can lead to extremely subtle bugs (maybe we'll be more aware next time, but it took me several hours to find the root cause). So I with there would be some way we could get help from the compiler to get this right.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-15 12:16</div>
            <div class="timeline-body"><p>@sharkdp yes, I agree! I think there are probably still other latent bugs with normalisation lurking in our codebase already. This PR fixes some specific issues with normalisation, but it doesn't fix the general problem that it's hard to get this approach right.</p>
<p>I'd also love to see if we can explore ways to make our design more robust. I liked the idea you mentioned on Discord the other day of having a generalised visitor pattern for recursing into types and applying transformations to all the sub-nodes â€” it's possible that might make this easier to get right?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 18:51:29 UTC
    </footer>
</body>
</html>
