<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preserve quote style in generated code - astral-sh/ruff #15726</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Preserve quote style in generated code</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15726">#15726</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-01-24 16:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/ntBre">@ntBre</a> on 2025-01-24 16:55</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This is a first step toward fixing #7799 by using the quoting style stored in the <code>flags</code> field on <code>ast::StringLiteral</code>s to select a quoting style. This PR does not include support for f-strings or byte strings.</p>
<p>Several rules also needed small updates to pass along existing quoting styles instead of using <code>StringLiteralFlags::default()</code>. The remaining snapshot changes are intentional and should preserve the quotes from the input strings. However, this has the unsatisfying, if not outright incorrect, effect of changes like the <code>quote3</code> case I note below.</p>
<p>I'm also not entirely happy with the new <code>DYNAMIC</code> flag, but I think it's useful to be able to determine whether the string flags are set intentionally or if we really want single quotes, which are the current default. I considered making the flags field an <code>Option</code> but thought this would be a less intrusive change. This test case was the main one I couldn't fix without this flag:</p>
<p>https://github.com/astral-sh/ruff/blob/aa2e3e2ce59469d1ed598c3efe625097ed4bdb47/crates/ruff_linter/resources/test/fixtures/pyupgrade/UP018.py#L45</p>
<p>There's no string literal to inherit the quote style from, and inheriting it from <code>checker.stylist.quote()</code> yields <code>f&quot;{&quot;&quot;}&quot;</code>, which is valid in Python 3.12+, but I don't think the generator knows that (cf #9660).</p>
<h2>Test Plan</h2>
<p>Existing tests with some accepted updates, plus a few new RUF055 tests for raw strings.</p>
<p>Fixes #14132</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-24 17:04</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+15 -15 violations, +0 -0 fixes in 4 projects; 51 projects unchanged)</p>
<details><summary><a href="https://github.com/apache/airflow">apache/airflow</a> (+2 -2 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --no-preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/apache/airflow/blob/d024cdab190eb46eb0ce21679f44f08df5690cb9/dev/breeze/src/airflow_breeze/global_constants.py#L591'>dev/breeze/src/airflow_breeze/global_constants.py:591:25:</a> FLY002 Consider `"common.compat cncf.kubernetes"` instead of string join
- <a href='https://github.com/apache/airflow/blob/d024cdab190eb46eb0ce21679f44f08df5690cb9/dev/breeze/src/airflow_breeze/global_constants.py#L591'>dev/breeze/src/airflow_breeze/global_constants.py:591:25:</a> FLY002 Consider `'common.compat cncf.kubernetes'` instead of string join
- <a href='https://github.com/apache/airflow/blob/d024cdab190eb46eb0ce21679f44f08df5690cb9/providers/src/airflow/providers/google/suite/hooks/drive.py#L194'>providers/src/airflow/providers/google/suite/hooks/drive.py:194:13:</a> SIM108 Use ternary operator `path = f"{file_info['name']}" if current_file_id == file_id else f"{file_info['name']}/{path}"` instead of `if`-`else`-block
+ <a href='https://github.com/apache/airflow/blob/d024cdab190eb46eb0ce21679f44f08df5690cb9/providers/src/airflow/providers/google/suite/hooks/drive.py#L194'>providers/src/airflow/providers/google/suite/hooks/drive.py:194:13:</a> SIM108 Use ternary operator `path = f'{file_info["name"]}' if current_file_id == file_id else f'{file_info["name"]}/{path}'` instead of `if`-`else`-block
</pre>

</p>
</details>
<details><summary><a href="https://github.com/binary-husky/gpt_academic">binary-husky/gpt_academic</a> (+3 -3 violations, +0 -0 fixes)</summary>
<p>

<pre>
- <a href='https://github.com/binary-husky/gpt_academic/blob/1213ef19e5e3d016e5a6cb73e007bc70bef98bb8/crazy_functions/diagram_fns/file_tree.py#L22'>crazy_functions/diagram_fns/file_tree.py:22:9:</a> SIM108 Use ternary operator `suf = "..." if len(comment) > self.comment_maxlen_show else ""` instead of `if`-`else`-block
+ <a href='https://github.com/binary-husky/gpt_academic/blob/1213ef19e5e3d016e5a6cb73e007bc70bef98bb8/crazy_functions/diagram_fns/file_tree.py#L22'>crazy_functions/diagram_fns/file_tree.py:22:9:</a> SIM108 Use ternary operator `suf = '...' if len(comment) > self.comment_maxlen_show else ''` instead of `if`-`else`-block
+ <a href='https://github.com/binary-husky/gpt_academic/blob/1213ef19e5e3d016e5a6cb73e007bc70bef98bb8/main.py#L139'>main.py:139:39:</a> SIM401 Use `functional[k].get("Color", "secondary")` instead of an `if` block
- <a href='https://github.com/binary-husky/gpt_academic/blob/1213ef19e5e3d016e5a6cb73e007bc70bef98bb8/main.py#L139'>main.py:139:39:</a> SIM401 Use `functional[k].get('Color', 'secondary')` instead of an `if` block
- <a href='https://github.com/binary-husky/gpt_academic/blob/1213ef19e5e3d016e5a6cb73e007bc70bef98bb8/request_llms/bridge_taichu.py#L12'>request_llms/bridge_taichu.py:12:5:</a> SIM103 Return the condition `not TAICHU_API_KEY == ""` directly
+ <a href='https://github.com/binary-husky/gpt_academic/blob/1213ef19e5e3d016e5a6cb73e007bc70bef98bb8/request_llms/bridge_taichu.py#L12'>request_llms/bridge_taichu.py:12:5:</a> SIM103 Return the condition `not TAICHU_API_KEY == ''` directly
</pre>

</p>
</details>
<details><summary><a href="https://github.com/bokeh/bokeh">bokeh/bokeh</a> (+9 -9 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --no-preview --select ALL</pre>
</p>
<p>

<pre>
+ examples/output/jupyter/push_notebook/Numba Image Example.ipynb:cell 20:1:10: RUF005 Consider `["none", *sorted(kernels.keys())]` instead of concatenation
- examples/output/jupyter/push_notebook/Numba Image Example.ipynb:cell 20:1:10: RUF005 Consider `['none', *sorted(kernels.keys())]` instead of concatenation
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/command/subcommands/file_output.py#L134'>src/bokeh/command/subcommands/file_output.py:134:9:</a> SIM108 Use ternary operator `base = "index" if route == "/" else route[1:]` instead of `if`-`else`-block
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/command/subcommands/file_output.py#L134'>src/bokeh/command/subcommands/file_output.py:134:9:</a> SIM108 Use ternary operator `base = 'index' if route == '/' else route[1:]` instead of `if`-`else`-block
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/core/json_encoder.py#L153'>src/bokeh/core/json_encoder.py:153:5:</a> SIM108 Use ternary operator `separators = (",", ": ") if pretty else (",", ":")` instead of `if`-`else`-block
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/core/json_encoder.py#L153'>src/bokeh/core/json_encoder.py:153:5:</a> SIM108 Use ternary operator `separators = (',', ': ') if pretty else (',', ':')` instead of `if`-`else`-block
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/plotting/_graph.py#L105'>src/bokeh/plotting/_graph.py:105:5:</a> SIM108 Use ternary operator `sedge_visuals = pop_visuals(MultiLine, kwargs, prefix="edge_selection_", defaults=edge_visuals) if any(x.startswith('edge_selection_') for x in kwargs) else None` instead of `if`-`else`-block
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/plotting/_graph.py#L105'>src/bokeh/plotting/_graph.py:105:5:</a> SIM108 Use ternary operator `sedge_visuals = pop_visuals(MultiLine, kwargs, prefix='edge_selection_', defaults=edge_visuals) if any(x.startswith('edge_selection_') for x in kwargs) else None` instead of `if`-`else`-block
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/plotting/_graph.py#L110'>src/bokeh/plotting/_graph.py:110:5:</a> SIM108 Use ternary operator `hedge_visuals = pop_visuals(MultiLine, kwargs, prefix="edge_hover_", defaults=edge_visuals) if any(x.startswith('edge_hover_') for x in kwargs) else None` instead of `if`-`else`-block
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/plotting/_graph.py#L110'>src/bokeh/plotting/_graph.py:110:5:</a> SIM108 Use ternary operator `hedge_visuals = pop_visuals(MultiLine, kwargs, prefix='edge_hover_', defaults=edge_visuals) if any(x.startswith('edge_hover_') for x in kwargs) else None` instead of `if`-`else`-block
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/plotting/_graph.py#L93'>src/bokeh/plotting/_graph.py:93:5:</a> SIM108 Use ternary operator `hnode_visuals = pop_visuals(marker_type, kwargs, prefix="node_hover_", defaults=node_visuals) if any(x.startswith('node_hover_') for x in kwargs) else None` instead of `if`-`else`-block
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/plotting/_graph.py#L93'>src/bokeh/plotting/_graph.py:93:5:</a> SIM108 Use ternary operator `hnode_visuals = pop_visuals(marker_type, kwargs, prefix='node_hover_', defaults=node_visuals) if any(x.startswith('node_hover_') for x in kwargs) else None` instead of `if`-`else`-block
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/server/tornado.py#L414'>src/bokeh/server/tornado.py:414:17:</a> SIM108 Use ternary operator `route = p[0] if key == "/" else key + p[0]` instead of `if`-`else`-block
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/server/tornado.py#L414'>src/bokeh/server/tornado.py:414:17:</a> SIM108 Use ternary operator `route = p[0] if key == '/' else key + p[0]` instead of `if`-`else`-block
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/util/compiler.py#L253'>src/bokeh/util/compiler.py:253:13:</a> SIM108 Use ternary operator `impl = FromFile(impl if isabs(impl) else join(self.path, impl)) if "\n" not in impl and impl.endswith(exts) else TypeScript(impl)` instead of `if`-`else`-block
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/util/compiler.py#L253'>src/bokeh/util/compiler.py:253:13:</a> SIM108 Use ternary operator `impl = FromFile(impl if isabs(impl) else join(self.path, impl)) if '\n' not in impl and impl.endswith(exts) else TypeScript(impl)` instead of `if`-`else`-block
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/tests/support/util/examples.py#L217'>tests/support/util/examples.py:217:9:</a> SIM108 Use ternary operator `example_type = getattr(Flags, example["type"]) if example.get("type") is not None else None` instead of `if`-`else`-block
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/tests/support/util/examples.py#L217'>tests/support/util/examples.py:217:9:</a> SIM108 Use ternary operator `example_type = getattr(Flags, example['type']) if example.get('type') is not None else None` instead of `if`-`else`-block
... 1 additional changes omitted for rule SIM108
</pre>

</p>
</details>
<details><summary><a href="https://github.com/zulip/zulip">zulip/zulip</a> (+1 -1 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --no-preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/zulip/zulip/blob/32f9ee7a62cdeb9cca5b694dc0fdb805dbcbff87/scripts/lib/sharding.py#L65'>scripts/lib/sharding.py:65:21:</a> SIM108 Use ternary operator `host = shard if "." in shard else f'{shard}.{external_host}'` instead of `if`-`else`-block
- <a href='https://github.com/zulip/zulip/blob/32f9ee7a62cdeb9cca5b694dc0fdb805dbcbff87/scripts/lib/sharding.py#L65'>scripts/lib/sharding.py:65:21:</a> SIM108 Use ternary operator `host = shard if '.' in shard else f'{shard}.{external_host}'` instead of `if`-`else`-block
</pre>

</p>
</details>
<details><summary>Changes by rule (5 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| SIM108 | 22 | 11 | 11 | 0 | 0 |
| FLY002 | 2 | 1 | 1 | 0 | 0 |
| SIM401 | 2 | 1 | 1 | 0 | 0 |
| SIM103 | 2 | 1 | 1 | 0 | 0 |
| RUF005 | 2 | 1 | 1 | 0 | 0 |</p>
</p>
</details>

<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+71 -71 violations, +0 -0 fixes in 4 projects; 51 projects unchanged)</p>
<details><summary><a href="https://github.com/apache/airflow">apache/airflow</a> (+2 -2 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/apache/airflow/blob/d024cdab190eb46eb0ce21679f44f08df5690cb9/dev/breeze/src/airflow_breeze/global_constants.py#L591'>dev/breeze/src/airflow_breeze/global_constants.py:591:25:</a> FLY002 Consider `"common.compat cncf.kubernetes"` instead of string join
- <a href='https://github.com/apache/airflow/blob/d024cdab190eb46eb0ce21679f44f08df5690cb9/dev/breeze/src/airflow_breeze/global_constants.py#L591'>dev/breeze/src/airflow_breeze/global_constants.py:591:25:</a> FLY002 Consider `'common.compat cncf.kubernetes'` instead of string join
- <a href='https://github.com/apache/airflow/blob/d024cdab190eb46eb0ce21679f44f08df5690cb9/providers/src/airflow/providers/google/suite/hooks/drive.py#L194'>providers/src/airflow/providers/google/suite/hooks/drive.py:194:13:</a> SIM108 Use ternary operator `path = f"{file_info['name']}" if current_file_id == file_id else f"{file_info['name']}/{path}"` instead of `if`-`else`-block
+ <a href='https://github.com/apache/airflow/blob/d024cdab190eb46eb0ce21679f44f08df5690cb9/providers/src/airflow/providers/google/suite/hooks/drive.py#L194'>providers/src/airflow/providers/google/suite/hooks/drive.py:194:13:</a> SIM108 Use ternary operator `path = f'{file_info["name"]}' if current_file_id == file_id else f'{file_info["name"]}/{path}'` instead of `if`-`else`-block
</pre>

</p>
</details>
<details><summary><a href="https://github.com/binary-husky/gpt_academic">binary-husky/gpt_academic</a> (+3 -3 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
- <a href='https://github.com/binary-husky/gpt_academic/blob/1213ef19e5e3d016e5a6cb73e007bc70bef98bb8/crazy_functions/diagram_fns/file_tree.py#L22'>crazy_functions/diagram_fns/file_tree.py:22:9:</a> SIM108 Use ternary operator `suf = "..." if len(comment) > self.comment_maxlen_show else ""` instead of `if`-`else`-block
+ <a href='https://github.com/binary-husky/gpt_academic/blob/1213ef19e5e3d016e5a6cb73e007bc70bef98bb8/crazy_functions/diagram_fns/file_tree.py#L22'>crazy_functions/diagram_fns/file_tree.py:22:9:</a> SIM108 Use ternary operator `suf = '...' if len(comment) > self.comment_maxlen_show else ''` instead of `if`-`else`-block
+ <a href='https://github.com/binary-husky/gpt_academic/blob/1213ef19e5e3d016e5a6cb73e007bc70bef98bb8/main.py#L139'>main.py:139:39:</a> SIM401 Use `functional[k].get("Color", "secondary")` instead of an `if` block
- <a href='https://github.com/binary-husky/gpt_academic/blob/1213ef19e5e3d016e5a6cb73e007bc70bef98bb8/main.py#L139'>main.py:139:39:</a> SIM401 Use `functional[k].get('Color', 'secondary')` instead of an `if` block
- <a href='https://github.com/binary-husky/gpt_academic/blob/1213ef19e5e3d016e5a6cb73e007bc70bef98bb8/request_llms/bridge_taichu.py#L12'>request_llms/bridge_taichu.py:12:5:</a> SIM103 Return the condition `TAICHU_API_KEY != ""` directly
+ <a href='https://github.com/binary-husky/gpt_academic/blob/1213ef19e5e3d016e5a6cb73e007bc70bef98bb8/request_llms/bridge_taichu.py#L12'>request_llms/bridge_taichu.py:12:5:</a> SIM103 Return the condition `TAICHU_API_KEY != ''` directly
</pre>

</p>
</details>
<details><summary><a href="https://github.com/bokeh/bokeh">bokeh/bokeh</a> (+65 -65 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/output/apis/components_themed.py#L89'>examples/output/apis/components_themed.py:89:6:</a> FURB103 `open` and `write` should be replaced by `Path(filename).write_text(html, encoding="utf-8")`
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/output/apis/components_themed.py#L89'>examples/output/apis/components_themed.py:89:6:</a> FURB103 `open` and `write` should be replaced by `Path(filename).write_text(html, encoding='utf-8')`
+ examples/output/jupyter/push_notebook/Numba Image Example.ipynb:cell 20:1:10: RUF005 Consider `["none", *sorted(kernels.keys())]` instead of concatenation
- examples/output/jupyter/push_notebook/Numba Image Example.ipynb:cell 20:1:10: RUF005 Consider `['none', *sorted(kernels.keys())]` instead of concatenation
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/server/app/movies/main.py#L28'>examples/server/app/movies/main.py:28:6:</a> FURB101 `open` and `read` should be replaced by `Path(join(dirname(__file__), "razzies-clean.csv")).read_text()`
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/server/app/movies/main.py#L28'>examples/server/app/movies/main.py:28:6:</a> FURB101 `open` and `read` should be replaced by `Path(join(dirname(__file__), 'razzies-clean.csv')).read_text()`
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/server/app/movies/main.py#L83'>examples/server/app/movies/main.py:83:25:</a> PLC1901 `director_val != ""` can be simplified to `director_val` as an empty string is falsey
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/server/app/movies/main.py#L83'>examples/server/app/movies/main.py:83:25:</a> PLC1901 `director_val != ''` can be simplified to `director_val` as an empty string is falsey
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/server/app/movies/main.py#L85'>examples/server/app/movies/main.py:85:21:</a> PLC1901 `cast_val != ""` can be simplified to `cast_val` as an empty string is falsey
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/server/app/movies/main.py#L85'>examples/server/app/movies/main.py:85:21:</a> PLC1901 `cast_val != ''` can be simplified to `cast_val` as an empty string is falsey
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/application/handlers/directory.py#L123'>src/bokeh/application/handlers/directory.py:123:18:</a> FURB101 `open` and `read` should be replaced by `Path(init_py).read_text(encoding="utf8")`
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/application/handlers/directory.py#L123'>src/bokeh/application/handlers/directory.py:123:18:</a> FURB101 `open` and `read` should be replaced by `Path(init_py).read_text(encoding='utf8')`
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/command/subcommands/file_output.py#L134'>src/bokeh/command/subcommands/file_output.py:134:9:</a> SIM108 Use ternary operator `base = "index" if route == "/" else route[1:]` instead of `if`-`else`-block
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/command/subcommands/file_output.py#L134'>src/bokeh/command/subcommands/file_output.py:134:9:</a> SIM108 Use ternary operator `base = 'index' if route == '/' else route[1:]` instead of `if`-`else`-block
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/command/subcommands/file_output.py#L175'>src/bokeh/command/subcommands/file_output.py:175:22:</a> FURB103 `open` and `write` should be replaced by `Path(filename).write_text(content, encoding="utf-8")`
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/command/subcommands/file_output.py#L175'>src/bokeh/command/subcommands/file_output.py:175:22:</a> FURB103 `open` and `write` should be replaced by `Path(filename).write_text(content, encoding='utf-8')`
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/core/json_encoder.py#L153'>src/bokeh/core/json_encoder.py:153:5:</a> SIM108 Use ternary operator `separators = (",", ": ") if pretty else (",", ":")` instead of `if`-`else`-block
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/core/json_encoder.py#L153'>src/bokeh/core/json_encoder.py:153:5:</a> SIM108 Use ternary operator `separators = (',', ': ') if pretty else (',', ':')` instead of `if`-`else`-block
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/io/export.py#L264'>src/bokeh/io/export.py:264:14:</a> FURB103 `open` and `write` should be replaced by `Path(tmp.path).write_text(html, encoding="utf-8")`
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/io/export.py#L264'>src/bokeh/io/export.py:264:14:</a> FURB103 `open` and `write` should be replaced by `Path(tmp.path).write_text(html, encoding='utf-8')`
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/io/export.py#L294'>src/bokeh/io/export.py:294:14:</a> FURB103 `open` and `write` should be replaced by `Path(tmp.path).write_text(html, encoding="utf-8")`
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/io/export.py#L294'>src/bokeh/io/export.py:294:14:</a> FURB103 `open` and `write` should be replaced by `Path(tmp.path).write_text(html, encoding='utf-8')`
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/io/export.py#L311'>src/bokeh/io/export.py:311:14:</a> FURB103 `open` and `write` should be replaced by `Path(tmp.path).write_text(html, encoding="utf-8")`
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/io/export.py#L311'>src/bokeh/io/export.py:311:14:</a> FURB103 `open` and `write` should be replaced by `Path(tmp.path).write_text(html, encoding='utf-8')`
... 7 additional changes omitted for rule FURB103
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/models/callbacks.py#L200'>src/bokeh/models/callbacks.py:200:14:</a> FURB101 `open` and `read` should be replaced by `Path(path).read_text(encoding="utf-8")`
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/models/callbacks.py#L200'>src/bokeh/models/callbacks.py:200:14:</a> FURB101 `open` and `read` should be replaced by `Path(path).read_text(encoding='utf-8')`
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/plotting/_graph.py#L105'>src/bokeh/plotting/_graph.py:105:5:</a> SIM108 Use ternary operator `sedge_visuals = pop_visuals(MultiLine, kwargs, prefix="edge_selection_", defaults=edge_visuals) if any(x.startswith('edge_selection_') for x in kwargs) else None` instead of `if`-`else`-block
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/plotting/_graph.py#L105'>src/bokeh/plotting/_graph.py:105:5:</a> SIM108 Use ternary operator `sedge_visuals = pop_visuals(MultiLine, kwargs, prefix='edge_selection_', defaults=edge_visuals) if any(x.startswith('edge_selection_') for x in kwargs) else None` instead of `if`-`else`-block
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/plotting/_graph.py#L110'>src/bokeh/plotting/_graph.py:110:5:</a> SIM108 Use ternary operator `hedge_visuals = pop_visuals(MultiLine, kwargs, prefix="edge_hover_", defaults=edge_visuals) if any(x.startswith('edge_hover_') for x in kwargs) else None` instead of `if`-`else`-block
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/plotting/_graph.py#L110'>src/bokeh/plotting/_graph.py:110:5:</a> SIM108 Use ternary operator `hedge_visuals = pop_visuals(MultiLine, kwargs, prefix='edge_hover_', defaults=edge_visuals) if any(x.startswith('edge_hover_') for x in kwargs) else None` instead of `if`-`else`-block
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/plotting/_graph.py#L93'>src/bokeh/plotting/_graph.py:93:5:</a> SIM108 Use ternary operator `hnode_visuals = pop_visuals(marker_type, kwargs, prefix="node_hover_", defaults=node_visuals) if any(x.startswith('node_hover_') for x in kwargs) else None` instead of `if`-`else`-block
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/plotting/_graph.py#L93'>src/bokeh/plotting/_graph.py:93:5:</a> SIM108 Use ternary operator `hnode_visuals = pop_visuals(marker_type, kwargs, prefix='node_hover_', defaults=node_visuals) if any(x.startswith('node_hover_') for x in kwargs) else None` instead of `if`-`else`-block
... 7 additional changes omitted for rule SIM108
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/plotting/_tools.py#L188'>src/bokeh/plotting/_tools.py:188:20:</a> PLC1901 `tool == ""` can be simplified to `not tool` as an empty string is falsey
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/plotting/_tools.py#L188'>src/bokeh/plotting/_tools.py:188:20:</a> PLC1901 `tool == ''` can be simplified to `not tool` as an empty string is falsey
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/sampledata/us_holidays.py#L79'>src/bokeh/sampledata/us_holidays.py:79:10:</a> FURB101 `open` and `read` should be replaced by `Path(package_path("USHolidays.ics")).read_text()`
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/sampledata/us_holidays.py#L79'>src/bokeh/sampledata/us_holidays.py:79:10:</a> FURB101 `open` and `read` should be replaced by `Path(package_path('USHolidays.ics')).read_text()`
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/server/util.py#L151'>src/bokeh/server/util.py:151:28:</a> PLC1901 `parts[0] == ""` can be simplified to `not parts[0]` as an empty string is falsey
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/server/util.py#L151'>src/bokeh/server/util.py:151:28:</a> PLC1901 `parts[0] == ''` can be simplified to `not parts[0]` as an empty string is falsey
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/server/util.py#L159'>src/bokeh/server/util.py:159:28:</a> PLC1901 `parts[0] == ""` can be simplified to `not parts[0]` as an empty string is falsey
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/server/util.py#L159'>src/bokeh/server/util.py:159:28:</a> PLC1901 `parts[0] == ''` can be simplified to `not parts[0]` as an empty string is falsey
... 77 additional changes omitted for rule PLC1901
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/util/compiler.py#L194'>src/bokeh/util/compiler.py:194:14:</a> FURB101 `open` and `read` should be replaced by `Path(path).read_text(encoding="utf-8")`
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/util/compiler.py#L194'>src/bokeh/util/compiler.py:194:14:</a> FURB101 `open` and `read` should be replaced by `Path(path).read_text(encoding='utf-8')`
... 1 additional changes omitted for rule FURB101
... 88 additional changes omitted for project
</pre>

</p>
</details>
<details><summary><a href="https://github.com/zulip/zulip">zulip/zulip</a> (+1 -1 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/zulip/zulip/blob/32f9ee7a62cdeb9cca5b694dc0fdb805dbcbff87/scripts/lib/sharding.py#L65'>scripts/lib/sharding.py:65:21:</a> SIM108 Use ternary operator `host = shard if "." in shard else f'{shard}.{external_host}'` instead of `if`-`else`-block
- <a href='https://github.com/zulip/zulip/blob/32f9ee7a62cdeb9cca5b694dc0fdb805dbcbff87/scripts/lib/sharding.py#L65'>scripts/lib/sharding.py:65:21:</a> SIM108 Use ternary operator `host = shard if '.' in shard else f'{shard}.{external_host}'` instead of `if`-`else`-block
</pre>

</p>
</details>
<details><summary>Changes by rule (8 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PLC1901 | 86 | 43 | 43 | 0 | 0 |
| SIM108 | 22 | 11 | 11 | 0 | 0 |
| FURB103 | 16 | 8 | 8 | 0 | 0 |
| FURB101 | 10 | 5 | 5 | 0 | 0 |
| FLY002 | 2 | 1 | 1 | 0 | 0 |
| SIM401 | 2 | 1 | 1 | 0 | 0 |
| SIM103 | 2 | 1 | 1 | 0 | 0 |
| RUF005 | 2 | 1 | 1 | 0 | 0 |</p>
</p>
</details>

<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @AlexWaygood on 2025-01-24 17:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @ntBre on 2025-01-24 17:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-01-24 17:21</div>
            <div class="timeline-body"><p>All of the ecosystem changes look like what I expected. The new version preserves the initial quoting styles instead of using the default single quotes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-24 17:59</div>
            <div class="timeline-body"><p>I haven't looked at the implementation closely because it's late here. So I might be off with what I write here.</p>
<p>Generally, my expectation would be that the generator only preserves quotes if it doesn't lead to a syntax error due to invalid quotes,e.g in nested f-strings. This would be similar to using the formatter with the <code>QuoteStyle::Preserve</code>. Unfortunately, just preserving isn't always possible (<a href="https://github.com/astral-sh/ruff/blob/420365811f27d597ea33a62270667ce9cee1bb5f/crates/ruff_python_formatter/src/string/normalize.rs#L36-L153">formatter logic</a>).</p>
<p>I agree with you that adding a <code>DYNAMIC</code> to <code>StringFlags</code> seems off. Do we need that functionality on a per string level or would it be enough to configure it at the generator level?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-01-24 18:17</div>
            <div class="timeline-body"><p>No worries, thanks for taking a look!</p>
<blockquote>
<p>Generally, my expectation would be that the generator only preserves quotes if it doesn't lead to a syntax error due to invalid quotes,e.g in nested f-strings.</p>
</blockquote>
<p>This is definitely important to keep in mind. I <em>think</em> this is handled by still calling <code>Generator::p_str_repr</code>, which calls <code>UnicodeEscape::with_preferred_quote</code>. Now we get the &quot;preferred&quot; quote from the string rather than the <code>Generator</code>, but the escape code can still override it. Only the raw string case skips this escaping path.</p>
<blockquote>
<p>I agree with you that adding a <code>DYNAMIC</code> to <code>StringFlags</code> seems off. Do we need that functionality on a per string level or would it be enough to configure it at the generator level?</p>
</blockquote>
<p>This is an interesting idea. I'll give it a try, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-24 18:32</div>
            <div class="timeline-body"><p>Thanks for explaining.</p>
<p>Another alternative to <code>DYNAMIC</code>: Could you use a stylist to determine the preferred quote in this one fixer where you don't have access to an existing quote style? Never mind, you explained why this doesn't work. Although I kind of would expect the generator not to generated invalid code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-01-24 18:45</div>
            <div class="timeline-body"><blockquote>
<p>Although I kind of would expect the generator not to generated invalid code.</p>
</blockquote>
<p>Yeah this case was pretty confusing to me. I think it only coincidentally worked in the original code because the default quotes are single quotes. It only uses the <code>Generator</code> to build the replacement for <code>str()</code>, so it doesn't consider the enclosing f-string at all: https://github.com/astral-sh/ruff/blob/aa2e3e2ce59469d1ed598c3efe625097ed4bdb47/crates/ruff_linter/src/rules/pyupgrade/rules/native_literals.rs#L200-L201</p>
<p>Maybe I focused too much on replicating the current behavior instead of fixing a latent bug.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-24 19:08</div>
            <div class="timeline-body"><p>Oh interesting. That makes sense and seems a general problem with how we use the <code>Generator</code>. The <code>Generator</code> can only generate valid code if it knows about the surrounding quotes but it seems we don't forward them here.</p>
<p>To me, that suggests that we should track the <code>quote_style</code> of the enclosing string (if any) in <code>Checker</code> as we traverse and pass it on to the <code>Generator</code> to ensure that it is aware of any surrounding quotes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-01-24 19:15</div>
            <div class="timeline-body"><p>Going back to the problem of how the <code>Generator</code> should determine whether to use the quote-style from the stylist versus the quote-style from the flags... here's another idea: I wonder if we could remove the <code>Default</code> implementation for <code>StringLiteralFlags</code>, and instead implement <code>From&lt;&amp;Stylist&gt;</code> for <code>StringLiteralFlags</code>. That way we'd add an easy way to construct a new <code>StringLiteralFlags</code> instance with the stylist-determined preferred quote, but we'd also force users of the API to think carefully about whether they really want an empty <code>StringLiteralFlags</code> instance or whether they should be taking the quote style from somewhere else. If we did this, I think we could have the generator only ever use the quote style from the flags rather than ever looking at the quote style given to it by the stylist. Here's a quick prototype (that I'm sure could be cleaned up a bit). (The diff is relative to <code>main</code> rather than your branch, I'm afraid!)</p>
<details>
<summary>Prototype</summary>

<pre><code class="language-diff">diff --git a/crates/ruff_linter/src/checkers/ast/analyze/expression.rs b/crates/ruff_linter/src/checkers/ast/analyze/expression.rs
index 74d877f91..a39ffae63 100644
--- a/crates/ruff_linter/src/checkers/ast/analyze/expression.rs
+++ b/crates/ruff_linter/src/checkers/ast/analyze/expression.rs
@@ -506,7 +506,7 @@ pub(crate) fn expression(expr: &amp;Expr, checker: &amp;mut Checker) {
                                     checker,
                                     attr,
                                     call,
-                                    string_value.to_str(),
+                                    string_value,
                                 );
                             }
                         } else if attr == &quot;format&quot; {
diff --git a/crates/ruff_linter/src/rules/flake8_pytest_style/rules/parametrize.rs b/crates/ruff_linter/src/rules/flake8_pytest_style/rules/parametrize.rs
index 9323ab6d7..16c60c8a5 100644
--- a/crates/ruff_linter/src/rules/flake8_pytest_style/rules/parametrize.rs
+++ b/crates/ruff_linter/src/rules/flake8_pytest_style/rules/parametrize.rs
@@ -4,8 +4,8 @@ use ruff_diagnostics::{Diagnostic, Edit, Fix, FixAvailability, Violation};
 use ruff_macros::{derive_message_formats, ViolationMetadata};
 use ruff_python_ast::comparable::ComparableExpr;
 use ruff_python_ast::parenthesize::parenthesized_range;
-use ruff_python_ast::{self as ast, Expr, ExprCall, ExprContext};
-use ruff_python_codegen::Generator;
+use ruff_python_ast::{self as ast, Expr, ExprCall, ExprContext, StringLiteralFlags};
+use ruff_python_codegen::{Generator, Stylist};
 use ruff_python_trivia::CommentRanges;
 use ruff_python_trivia::{SimpleTokenKind, SimpleTokenizer};
 use ruff_text_size::{Ranged, TextRange, TextSize};
@@ -280,7 +280,7 @@ impl Violation for PytestDuplicateParametrizeTestCases {
     }
 }
 
-fn elts_to_csv(elts: &amp;[Expr], generator: Generator) -&gt; Option&lt;String&gt; {
+fn elts_to_csv(elts: &amp;[Expr], generator: Generator, stylist: &amp;Stylist) -&gt; Option&lt;String&gt; {
     if !elts.iter().all(Expr::is_string_literal_expr) {
         return None;
     }
@@ -298,7 +298,8 @@ fn elts_to_csv(elts: &amp;[Expr], generator: Generator) -&gt; Option&lt;String&gt; {
                 acc
             })
             .into_boxed_str(),
-        ..ast::StringLiteral::default()
+        range: TextRange::default(),
+        flags: StringLiteralFlags::from(stylist),
     });
     Some(generator.expr(&amp;node))
 }
@@ -358,8 +359,9 @@ fn check_names(checker: &amp;mut Checker, call: &amp;ExprCall, expr: &amp;Expr, argvalues: &amp;
                                 .iter()
                                 .map(|name| {
                                     Expr::from(ast::StringLiteral {
-                                        value: (*name).to_string().into_boxed_str(),
-                                        ..ast::StringLiteral::default()
+                                        value: Box::from(*name),
+                                        range: TextRange::default(),
+                                        flags: StringLiteralFlags::from(checker.stylist()),
                                     })
                                 })
                                 .collect(),
@@ -393,8 +395,9 @@ fn check_names(checker: &amp;mut Checker, call: &amp;ExprCall, expr: &amp;Expr, argvalues: &amp;
                                 .iter()
                                 .map(|name| {
                                     Expr::from(ast::StringLiteral {
-                                        value: (*name).to_string().into_boxed_str(),
-                                        ..ast::StringLiteral::default()
+                                        value: Box::from(*name),
+                                        range: TextRange::default(),
+                                        flags: StringLiteralFlags::from(checker.stylist()),
                                     })
     if !elts.iter().all(Expr::is_string_literal_expr) {
         return None;
     }
@@ -298,7 +298,8 @@ fn elts_to_csv(elts: &amp;[Expr], generator: Generator) -&gt; Option&lt;String&gt; {
                 acc
             })
             .into_boxed_str(),
-        ..ast::StringLiteral::default()
+        range: TextRange::default(),
+        flags: StringLiteralFlags::from(stylist),
     });
     Some(generator.expr(&amp;node))
 }
@@ -358,8 +359,9 @@ fn check_names(checker: &amp;mut Checker, call: &amp;ExprCall, expr: &amp;Expr, argvalues: &amp;
                                 .iter()
                                 .map(|name| {
                                     Expr::from(ast::StringLiteral {
-                                        value: (*name).to_string().into_boxed_str(),
-                                        ..ast::StringLiteral::default()
+                                        value: Box::from(*name),
+                                        range: TextRange::default(),
+                                        flags: StringLiteralFlags::from(checker.stylist()),
                                     })
                                 })
                                 .collect(),
@@ -393,8 +395,9 @@ fn check_names(checker: &amp;mut Checker, call: &amp;ExprCall, expr: &amp;Expr, argvalues: &amp;
                                 .iter()
                                 .map(|name| {
                                     Expr::from(ast::StringLiteral {
-                                        value: (*name).to_string().into_boxed_str(),
-                                        ..ast::StringLiteral::default()
+                                        value: Box::from(*name),
+                                        range: TextRange::default(),
+                                        flags: StringLiteralFlags::from(checker.stylist()),
                                     })
                                 })
                                 .collect(),
@@ -444,7 +447,7 @@ fn check_names(checker: &amp;mut Checker, call: &amp;ExprCall, expr: &amp;Expr, argvalues: &amp;
                             },
                             expr.range(),
                         );
-                        if let Some(content) = elts_to_csv(elts, checker.generator()) {
+                        if let Some(content) = elts_to_csv(elts, checker.generator(), checker.stylist()) {
                             diagnostic.set_fix(Fix::unsafe_edit(Edit::range_replacement(
                                 content,
                                 expr.range(),
@@ -489,7 +492,7 @@ fn check_names(checker: &amp;mut Checker, call: &amp;ExprCall, expr: &amp;Expr, argvalues: &amp;
                             },
                             expr.range(),
                         );
-                        if let Some(content) = elts_to_csv(elts, checker.generator()) {
+                        if let Some(content) = elts_to_csv(elts, checker.generator(), checker.stylist()) {
                             diagnostic.set_fix(Fix::unsafe_edit(Edit::range_replacement(
                                 content,
                                 expr.range(),
diff --git a/crates/ruff_linter/src/rules/flake8_simplify/rules/ast_expr.rs b/crates/ruff_linter/src/rules/flake8_simplify/rules/ast_expr.rs
index 50c17cfeb..cb4aa3317 100644
--- a/crates/ruff_linter/src/rules/flake8_simplify/rules/ast_expr.rs
+++ b/crates/ruff_linter/src/rules/flake8_simplify/rules/ast_expr.rs
@@ -1,7 +1,7 @@
 use ruff_python_ast::{
     self as ast, str_prefix::StringLiteralPrefix, Arguments, Expr, StringLiteralFlags,
 };
-use ruff_text_size::Ranged;
+use ruff_text_size::{Ranged, TextRange};
 
 use crate::fix::snippet::SourceCodeSnippet;
 use ruff_diagnostics::{AlwaysFixableViolation, Diagnostic, Edit, Fix, FixAvailability, Violation};
@@ -220,14 +220,14 @@ fn check_os_environ_subscript(checker: &amp;mut Checker, expr: &amp;Expr) {
     );
     let node = ast::StringLiteral {
         value: capital_env_var.into_boxed_str(),
-        flags: StringLiteralFlags::default().with_prefix({
+        flags: StringLiteralFlags::from(checker.stylist()).with_prefix({
             if env_var.is_unicode() {
                 StringLiteralPrefix::Unicode
             } else {
                 StringLiteralPrefix::Empty
             }
         }),
-        ..ast::StringLiteral::default()
+        range: TextRange::default(),
     };
     let new_env_var = node.into();
     diagnostic.set_fix(Fix::unsafe_edit(Edit::range_replacement(
diff --git a/crates/ruff_linter/src/rules/flake8_simplify/rules/split_static_string.rs b/crates/ruff_linter/src/rules/flake8_simplify/rules/split_static_string.rs
index 375d30b49..a46635d5f 100644
--- a/crates/ruff_linter/src/rules/flake8_simplify/rules/split_static_string.rs
+++ b/crates/ruff_linter/src/rules/flake8_simplify/rules/split_static_string.rs
@@ -3,8 +3,8 @@ use std::cmp::Ordering;
 use ruff_diagnostics::{Applicability, Diagnostic, Edit, Fix, FixAvailability, Violation};
 use ruff_macros::{derive_message_formats, ViolationMetadata};
 use ruff_python_ast::{
-    Expr, ExprCall, ExprContext, ExprList, ExprStringLiteral, ExprUnaryOp, StringLiteral,
-    StringLiteralFlags, StringLiteralValue, UnaryOp,
+    str::Quote, Expr, ExprCall, ExprContext, ExprList, ExprStringLiteral, ExprUnaryOp, StringFlags,
+    StringLiteral, StringLiteralFlags, StringLiteralValue, UnaryOp,
 };
 use ruff_text_size::{Ranged, TextRange};
 
@@ -62,7 +62,7 @@ pub(crate) fn split_static_string(
     checker: &amp;mut Checker,
     attr: &amp;str,
     call: &amp;ExprCall,
-    str_value: &amp;str,
+    str_value: &amp;StringLiteralValue,
 ) {
     let ExprCall { arguments, .. } = call;
 
@@ -115,16 +115,16 @@ pub(crate) fn split_static_string(
     checker.diagnostics.push(diagnostic);
 }
 
-fn construct_replacement(elts: &amp;[&amp;str]) -&gt; Expr {
+fn construct_replacement(elts: &amp;[&amp;str], quote: Quote) -&gt; Expr {
     Expr::List(ExprList {
         elts: elts
             .iter()
             .map(|elt| {
                 Expr::StringLiteral(ExprStringLiteral {
                     value: StringLiteralValue::single(StringLiteral {
-                        value: (*elt).to_string().into_boxed_str(),
+                        value: Box::from(*elt),
                         range: TextRange::default(),
-                        flags: StringLiteralFlags::default(),
+                        flags: StringLiteralFlags::empty().with_quote_style(quote),
                     }),
                     range: TextRange::default(),
                 })
@@ -135,7 +135,7 @@ fn construct_replacement(elts: &amp;[&amp;str]) -&gt; Expr {
     })
 }
 
-fn split_default(str_value: &amp;str, max_split: i32) -&gt; Option&lt;Expr&gt; {
+fn split_default(str_value: &amp;StringLiteralValue, max_split: i32) -&gt; Option&lt;Expr&gt; {
     // From the Python documentation:
     // &gt; If sep is not specified or is None, a different splitting algorithm is applied: runs of
     // &gt; consecutive whitespace are regarded as a single separator, and the result will contain
@@ -151,30 +151,43 @@ fn split_default(str_value: &amp;str, max_split: i32) -&gt; Option&lt;Expr&gt; {
             None
         }
         Ordering::Equal =&gt; {
-            let list_items: Vec&lt;&amp;str&gt; = vec![str_value];
-            Some(construct_replacement(&amp;list_items))
+            let list_items: Vec&lt;&amp;str&gt; = vec![str_value.to_str()];
+            Some(construct_replacement(
+                &amp;list_items,
+                str_value.flags().quote_style(),
+            ))
         }
         Ordering::Less =&gt; {
-            let list_items: Vec&lt;&amp;str&gt; = str_value.split_whitespace().collect();
-            Some(construct_replacement(&amp;list_items))
+            let list_items: Vec&lt;&amp;str&gt; = str_value.to_str().split_whitespace().collect();
+            Some(construct_replacement(
+                &amp;list_items,
+                str_value.flags().quote_style(),
+            ))
         }
     }
 }
 
-fn split_sep(str_value: &amp;str, sep_value: &amp;str, max_split: i32, direction: Direction) -&gt; Expr {
+fn split_sep(
+    str_value: &amp;StringLiteralValue,
+    sep_value: &amp;str,
+    max_split: i32,
+    direction: Direction,
+) -&gt; Expr {
+    let value = str_value.to_str();
+    let quote = str_value.flags().quote_style();
     let list_items: Vec&lt;&amp;str&gt; = if let Ok(split_n) = usize::try_from(max_split) {
         match direction {
-            Direction::Left =&gt; str_value.splitn(split_n + 1, sep_value).collect(),
-            Direction::Right =&gt; str_value.rsplitn(split_n + 1, sep_value).collect(),
+            Direction::Left =&gt; value.splitn(split_n + 1, sep_value).collect(),
+            Direction::Right =&gt; value.rsplitn(split_n + 1, sep_value).collect(),
         }
     } else {
         match direction {
-            Direction::Left =&gt; str_value.split(sep_value).collect(),
-            Direction::Right =&gt; str_value.rsplit(sep_value).collect(),
+            Direction::Left =&gt; value.split(sep_value).collect(),
+            Direction::Right =&gt; value.rsplit(sep_value).collect(),
         }
     };
 
-    construct_replacement(&amp;list_items)
+    construct_replacement(&amp;list_items, quote)
 }
 
 /// Returns the value of the `maxsplit` argument as an `i32`, if it is a numeric value.
diff --git a/crates/ruff_linter/src/rules/flake8_type_checking/helpers.rs b/crates/ruff_linter/src/rules/flake8_type_checking/helpers.rs
index c6881536f..c5979c8c9 100644
--- a/crates/ruff_linter/src/rules/flake8_type_checking/helpers.rs
+++ b/crates/ruff_linter/src/rules/flake8_type_checking/helpers.rs
@@ -366,7 +366,7 @@ impl&lt;'a&gt; QuoteAnnotator&lt;'a&gt; {
         generator.expr(&amp;Expr::from(ast::StringLiteral {
             range: TextRange::default(),
             value: annotation.into_boxed_str(),
-            flags: ast::StringLiteralFlags::default(),
+            flags: ast::StringLiteralFlags::from(self.stylist),
         }))
     }
 
diff --git a/crates/ruff_linter/src/rules/flynt/rules/static_join_to_fstring.rs b/crates/ruff_linter/src/rules/flynt/rules/static_join_to_fstring.rs
index af100938e..d7c0cefda 100644
--- a/crates/ruff_linter/src/rules/flynt/rules/static_join_to_fstring.rs
+++ b/crates/ruff_linter/src/rules/flynt/rules/static_join_to_fstring.rs
@@ -75,7 +75,14 @@ fn build_fstring(joiner: &amp;str, joinees: &amp;[Expr]) -&gt; Option&lt;Expr&gt; {
                 })
                 .join(joiner)
                 .into_boxed_str(),
-            ..ast::StringLiteral::default()
+            range: TextRange::default(),
+            flags: joinees
+                .first()
+                .unwrap()
+                .as_string_literal_expr()
+                .unwrap()
+                .value
+                .flags(),
         };
         return Some(node.into());
     }
diff --git a/crates/ruff_linter/src/rules/pylint/rules/unspecified_encoding.rs b/crates/ruff_linter/src/rules/pylint/rules/unspecified_encoding.rs
index 1aa1ea934..812fd81e1 100644
--- a/crates/ruff_linter/src/rules/pylint/rules/unspecified_encoding.rs
+++ b/crates/ruff_linter/src/rules/pylint/rules/unspecified_encoding.rs
@@ -163,7 +163,7 @@ fn generate_keyword_fix(checker: &amp;Checker, call: &amp;ast::ExprCall) -&gt; Fix {
                 .expr(&amp;Expr::StringLiteral(ast::ExprStringLiteral {
                     value: ast::StringLiteralValue::single(ast::StringLiteral {
                         value: &quot;utf-8&quot;.to_string().into_boxed_str(),
-                        flags: StringLiteralFlags::default(),
+                        flags: StringLiteralFlags::from(checker.stylist()),
                         range: TextRange::default(),
                     }),
                     range: TextRange::default(),
diff --git a/crates/ruff_linter/src/rules/pyupgrade/rules/native_literals.rs b/crates/ruff_linter/src/rules/pyupgrade/rules/native_literals.rs
index 4e71ee73a..702249bec 100644
--- a/crates/ruff_linter/src/rules/pyupgrade/rules/native_literals.rs
+++ b/crates/ruff_linter/src/rules/pyupgrade/rules/native_literals.rs
@@ -35,7 +35,12 @@ impl FromStr for LiteralType {
 impl LiteralType {
     fn as_zero_value_expr(self) -&gt; Expr {
         match self {
-            LiteralType::Str =&gt; ast::ExprStringLiteral::default().into(),
+            LiteralType::Str =&gt; ast::StringLiteral {
+                value: Box::default(),
+                range: TextRange::default(),
+                flags: ast::StringLiteralFlags::empty(),
+            }
+            .into(),
             LiteralType::Bytes =&gt; ast::ExprBytesLiteral::default().into(),
             LiteralType::Int =&gt; ast::ExprNumberLiteral {
                 value: ast::Number::Int(Int::from(0u8)),
diff --git a/crates/ruff_linter/src/rules/ruff/rules/assert_with_print_message.rs b/crates/ruff_linter/src/rules/ruff/rules/assert_with_print_message.rs
index da9b3de4f..4a2b7ce0b 100644
--- a/crates/ruff_linter/src/rules/ruff/rules/assert_with_print_message.rs
+++ b/crates/ruff_linter/src/rules/ruff/rules/assert_with_print_message.rs
@@ -66,7 +66,8 @@ pub(crate) fn assert_with_print_message(checker: &amp;mut Checker, stmt: &amp;ast::StmtA
             diagnostic.set_fix(Fix::unsafe_edit(Edit::range_replacement(
                 checker.generator().stmt(&amp;Stmt::Assert(ast::StmtAssert {
                     test: stmt.test.clone(),
-                    msg: print_arguments::to_expr(&amp;call.arguments).map(Box::new),
+                    msg: print_arguments::to_expr(&amp;call.arguments, checker.stylist().quote())
+                        .map(Box::new),
                     range: TextRange::default(),
                 })),
                 // We have to replace the entire statement,
@@ -89,9 +90,9 @@ pub(crate) fn assert_with_print_message(checker: &amp;mut Checker, stmt: &amp;ast::StmtA
 mod print_arguments {
     use itertools::Itertools;
     use ruff_python_ast::{
-        Arguments, ConversionFlag, Expr, ExprFString, ExprStringLiteral, FString, FStringElement,
-        FStringElements, FStringExpressionElement, FStringFlags, FStringLiteralElement,
-        FStringValue, StringLiteral, StringLiteralFlags, StringLiteralValue,
+        str::Quote, Arguments, ConversionFlag, Expr, ExprFString, ExprStringLiteral, FString,
+        FStringElement, FStringElements, FStringExpressionElement, FStringFlags,
+        FStringLiteralElement, FStringValue, StringLiteral, StringLiteralFlags, StringLiteralValue,
     };
     use ruff_text_size::TextRange;
 
@@ -140,12 +141,13 @@ mod print_arguments {
     /// literals.
     fn fstring_elements_to_string_literals&lt;'a&gt;(
         mut elements: impl ExactSizeIterator&lt;Item = &amp;'a FStringElement&gt;,
+        quote: Quote,
     ) -&gt; Option&lt;Vec&lt;StringLiteral&gt;&gt; {
         elements.try_fold(Vec::with_capacity(elements.len()), |mut acc, element| {
             if let FStringElement::Literal(literal) = element {
                 acc.push(StringLiteral {
                     value: literal.value.clone(),
-                    flags: StringLiteralFlags::default(),
+                    flags: StringLiteralFlags::empty().with_quote_style(quote),
                     range: TextRange::default(),
                 });
                 Some(acc)
@@ -162,6 +164,7 @@ mod print_arguments {
     fn args_to_string_literal_expr&lt;'a&gt;(
         args: impl ExactSizeIterator&lt;Item = &amp;'a Vec&lt;FStringElement&gt;&gt;,
         sep: impl ExactSizeIterator&lt;Item = &amp;'a FStringElement&gt;,
+        quote: Quote,
     ) -&gt; Option&lt;Expr&gt; {
         // If there are no arguments, short-circuit and return `None`
         if args.len() == 0 {
@@ -174,8 +177,8 @@ mod print_arguments {
         // of a concatenated string literal. (e.g. &quot;text&quot;, &quot;text&quot; &quot;text&quot;) The `sep` will
         // be inserted only between the outer Vecs.
         let (Some(sep), Some(args)) = (
-            fstring_elements_to_string_literals(sep),
-            args.map(|arg| fstring_elements_to_string_literals(arg.iter()))
+            fstring_elements_to_string_literals(sep, quote),
+            args.map(|arg| fstring_elements_to_string_literals(arg.iter(), quote))
                 .collect::&lt;Option&lt;Vec&lt;_&gt;&gt;&gt;(),
         ) else {
             // If any of the arguments are not string literals, return None
@@ -203,7 +206,7 @@ mod print_arguments {
             range: TextRange::default(),
             value: StringLiteralValue::single(StringLiteral {
                 value: combined_string.into(),
-                flags: StringLiteralFlags::default(),
+                flags: StringLiteralFlags::empty().with_quote_style(quote),
                 range: TextRange::default(),
             }),
         }))
@@ -256,7 +259,7 @@ mod print_arguments {
     /// - [`Some`]&lt;[`Expr::StringLiteral`]&gt; if all arguments including `sep` are string literals.
     /// - [`Some`]&lt;[`Expr::FString`]&gt; if any of the arguments are not string literals.
     /// - [`None`] if the `print` contains no positional arguments at all.
-    pub(super) fn to_expr(arguments: &amp;Arguments) -&gt; Option&lt;Expr&gt; {
+    pub(super) fn to_expr(arguments: &amp;Arguments, quote: Quote) -&gt; Option&lt;Expr&gt; {
         // Convert the `sep` argument into `FStringElement`s
         let sep = arguments
             .find_keyword(&quot;sep&quot;)
@@ -286,7 +289,7 @@ mod print_arguments {
 
         // Attempt to convert the `sep` and `args` arguments to a string literal,
         // falling back to an f-string if the arguments are not all string literals.
-        args_to_string_literal_expr(args.iter(), sep.iter())
+        args_to_string_literal_expr(args.iter(), sep.iter(), quote)
             .or_else(|| args_to_fstring_expr(args.into_iter(), sep.into_iter()))
     }
 }
diff --git a/crates/ruff_python_ast/src/nodes.rs b/crates/ruff_python_ast/src/nodes.rs
index ac779c56a..71fd1de12 100644
--- a/crates/ruff_python_ast/src/nodes.rs
+++ b/crates/ruff_python_ast/src/nodes.rs
@@ -1221,14 +1221,14 @@ impl fmt::Debug for FStringElements {
 
 /// An AST node that represents either a single string literal or an implicitly
 /// concatenated string literals.
-#[derive(Clone, Debug, Default, PartialEq)]
+#[derive(Clone, Debug, PartialEq)]
 pub struct ExprStringLiteral {
     pub range: TextRange,
     pub value: StringLiteralValue,
 }
 
 /// The value representing a [`ExprStringLiteral`].
-#[derive(Clone, Debug, Default, PartialEq)]
+#[derive(Clone, Debug, PartialEq)]
 pub struct StringLiteralValue {
     inner: StringLiteralValueInner,
 }
@@ -1241,6 +1241,18 @@ impl StringLiteralValue {
         }
     }
 
+    /// Returns the [`StringLiteralFlags`] associated with this string literal.
+    ///
+    /// For an implicitly concatenated string, it returns the flags for the first literal.
+    pub fn flags(&amp;self) -&gt; StringLiteralFlags {
+        self.iter()
+            .next()
+            .expect(
+                &quot;There should always be at least one string literal in an `ExprStringLiteral` node&quot;,
+            )
+            .flags
+    }
+
     /// Creates a new string literal with the given values that represents an
     /// implicitly concatenated strings.
     ///
@@ -1371,12 +1383,6 @@ enum StringLiteralValueInner {
     Concatenated(ConcatenatedStringLiteral),
 }
 
-impl Default for StringLiteralValueInner {
-    fn default() -&gt; Self {
-        Self::Single(StringLiteral::default())
-    }
-}
-
 bitflags! {
     #[derive(Debug, Default, Copy, Clone, PartialEq, Eq, Hash)]
     struct StringLiteralFlagsInner: u8 {
@@ -1414,10 +1420,14 @@ bitflags! {
 
 /// Flags that can be queried to obtain information
 /// regarding the prefixes and quotes used for a string literal.
-#[derive(Default, Copy, Clone, Eq, PartialEq, Hash)]
+#[derive(Copy, Clone, Eq, PartialEq, Hash)]
 pub struct StringLiteralFlags(StringLiteralFlagsInner);
 
 impl StringLiteralFlags {
+    pub fn empty() -&gt; Self {
+        Self(StringLiteralFlagsInner::empty())
+    }
+
     #[must_use]
     pub fn with_quote_style(mut self, quote_style: Quote) -&gt; Self {
         self.0
@@ -1520,7 +1530,7 @@ impl fmt::Debug for StringLiteralFlags {
 
 /// An AST node that represents a single string literal which is part of an
 /// [`ExprStringLiteral`].
-#[derive(Clone, Debug, Default, PartialEq)]
+#[derive(Clone, Debug, PartialEq)]
 pub struct StringLiteral {
     pub range: TextRange,
     pub value: Box&lt;str&gt;,
@@ -1546,7 +1556,7 @@ impl StringLiteral {
         Self {
             range,
             value: &quot;&quot;.into(),
-            flags: StringLiteralFlags::default().with_invalid(),
+            flags: StringLiteralFlags::empty().with_invalid(),
         }
     }
 }
@@ -2115,7 +2125,7 @@ impl From&lt;AnyStringFlags&gt; for StringLiteralFlags {
                 value.prefix()
             )
         };
-        let new = StringLiteralFlags::default()
+        let new = StringLiteralFlags::empty()
             .with_quote_style(value.quote_style())
             .with_prefix(prefix);
         if value.is_triple_quoted() {
diff --git a/crates/ruff_python_codegen/src/stylist.rs b/crates/ruff_python_codegen/src/stylist.rs
index 20217c279..49b5fa380 100644
--- a/crates/ruff_python_codegen/src/stylist.rs
+++ b/crates/ruff_python_codegen/src/stylist.rs
@@ -4,6 +4,7 @@ use std::cell::OnceCell;
 use std::ops::Deref;
 
 use ruff_python_ast::str::Quote;
+use ruff_python_ast::StringLiteralFlags;
 use ruff_python_parser::{Token, TokenKind, Tokens};
 use ruff_source_file::{find_newline, LineEnding, LineRanges};
 use ruff_text_size::Ranged;
@@ -45,6 +46,12 @@ impl&lt;'a&gt; Stylist&lt;'a&gt; {
     }
 }
 
+impl From&lt;&amp;Stylist&lt;'_&gt;&gt; for StringLiteralFlags {
+    fn from(stylist: &amp;Stylist) -&gt; Self {
+        StringLiteralFlags::empty().with_quote_style(stylist.quote())
+    }
+}
+
 fn detect_quote(tokens: &amp;[Token]) -&gt; Quote {
     for token in tokens {
         match token.kind() {
diff --git a/crates/ruff_python_formatter/tests/normalizer.rs b/crates/ruff_python_formatter/tests/normalizer.rs
index b83a8cee0..dd83f0612 100644
--- a/crates/ruff_python_formatter/tests/normalizer.rs
+++ b/crates/ruff_python_formatter/tests/normalizer.rs
@@ -81,7 +81,7 @@ impl Transformer for Normalizer {
                         string.value = ast::StringLiteralValue::single(ast::StringLiteral {
                             value: string.value.to_str().to_string().into_boxed_str(),
                             range: string.range,
-                            flags: StringLiteralFlags::default(),
+                            flags: StringLiteralFlags::empty(),
                         });
                     }
                 }
</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-01-24 19:47</div>
            <div class="timeline-body"><p>I think removing the <code>Default</code> implementation is a really good idea. I was wondering how we would bring this to the attention of everyone using the <code>Generator</code> in the future, so this seems like a good fix.</p>
<p>For the UP018 case, I've obviously misunderstood something. It does look at the f-string somehow because this is the output for an f-string with single quotes:</p>
<pre><code class="language-shell">&gt; ruff check --select UP018 --diff try.py
--- try.py
+++ try.py
@@ -1 +1 @@
-f'{str()}'
+f'{&quot;&quot;}'

Would fix 1 error.
</code></pre>
<p>Now I see that <code>Checker::generator</code> calls <code>Checker::f_string_quote_style</code>, oops. I guess that's why the <code>DYNAMIC</code> code works: the generator does track the quote style to use like Micha suggested.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @ntBre on 2025-01-24 21:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-01-24 21:09</div>
            <div class="timeline-body"><p>Okay I rebased on main and applied Alex's patch. Unfortunately it still didn't get rid of the need for some kind of <code>DYNAMIC</code> behavior -- the tricky UP018 case still failed without it. I'll keep thinking about this over the weekend.</p>
<p>Also apparently I have not been running doctests locally, that's the cause of the CI failures (some of them used <code>StringLiteralFlags::default</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @ntBre on 2025-01-24 21:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-24 22:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_type_checking/snapshots/ruff_linter__rules__flake8_type_checking__tests__quote_typing-only-third-party-import_quote3.py.snap</code>:26 on 2025-01-24 22:01</div>
            <div class="timeline-body"><p>This is the <code>quote3</code> case I referred to in the PR. The single quotes on <code>active</code> are preserved at the cost of escaping them.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-24 22:21</div>
            <div class="timeline-body"><p>Is this a bug fix (and therefore allowed to change in stable) or a behavioral change (which should be gated by preview)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-01-24 22:49</div>
            <div class="timeline-body"><p>#7799 is labeled as a bug, but I think the specific bugs it links to have been fixed in other ways. It feels more like a behavioral change to me, but I'm interested to know what other people think.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-01-24 22:54</div>
            <div class="timeline-body"><p>Actually, I think #14132 is fixed by this PR, so I guess it's a bug fix!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-01-24 22:58</div>
            <div class="timeline-body"><p>I would say this is a bugfix. Ruff's autofixes shouldn't generally change the quoting style of strings if they don't need to; this PR fixes a number of cases where we <em>have</em> been changing those details unnecessarily as a side effect of autofixes.</p>
<p>I think this makes the changes that ruff will make in its autofixes strictly more minimal, so I don't think it's a breaking change</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-01-25 19:07</div>
            <div class="timeline-body"><blockquote>
<p>Okay I rebased on main and applied Alex's patch. Unfortunately it still didn't get rid of the need for some kind of <code>DYNAMIC</code> behavior -- the tricky UP018 case still failed without it. I'll keep thinking about this over the weekend.</p>
</blockquote>
<p>Ahh, I see. This is because the <code>self.quote</code> on the <code>Generator</code> produced by <code>Checker::generator()</code> tracks whether we're visiting a string (and tracks the quotation of that string, using this to determine what quotation the <code>Generator</code> should prefer), but the preferred quote on the <code>Stylist</code> does not take account of this.</p>
<p>https://github.com/astral-sh/ruff/blob/cb3361e682fc52d7ac9fdc5e2558373eb1d94a1f/crates/ruff_linter/src/checkers/ast/mod.rs#L295-L302</p>
<p>I think what this means is that my idea of a <code>From&lt;&amp;Stylist&gt;</code> implementation for <code>StringLiteralFlags</code> was a bad idea, since the <code>Stylist</code> struct doesn't keep track of where we are in the AST. Instead, we should factor out the logic in the <code>Checker::generator()</code> function so that we can use it in both <code>Checker::generator()</code> and for constructing <code>StringLiteralFlags</code> instances in autofix logic for various rules. Something like this?</p>
<pre><code class="language-diff">diff --git a/crates/ruff_linter/src/checkers/ast/mod.rs b/crates/ruff_linter/src/checkers/ast/mod.rs
index 80a7880b2..15916adeb 100644
--- a/crates/ruff_linter/src/checkers/ast/mod.rs
+++ b/crates/ruff_linter/src/checkers/ast/mod.rs
@@ -296,11 +296,21 @@ impl&lt;'a&gt; Checker&lt;'a&gt; {
     pub(crate) fn generator(&amp;self) -&gt; Generator {
         Generator::new(
             self.stylist.indentation(),
-            self.f_string_quote_style().unwrap_or(self.stylist.quote()),
+            self.preferred_quote(),
             self.stylist.line_ending(),
         )
     }
 
+    /// Return the preferred quote for a generated `StringLiteral` node, given where we are in the AST.
+    pub(crate) fn preferred_quote(&amp;self) -&gt; Quote {
+        self.f_string_quote_style().unwrap_or(self.stylist.quote())
+    }
+
+    /// Return the default string flags a generated `StringLiteral` node should use, given where we are in the AST.
+    pub(crate) fn default_string_flags(&amp;self) -&gt; ast::StringLiteralFlags {
+        ast::StringLiteralFlags::empty().with_quote_style(self.preferred_quote())
+    }
+
     /// Returns the appropriate quoting for f-string by reversing the one used outside of
     /// the f-string.
     ///
</code></pre>
<p>I <em>think</em> if we then use these methods everywhere we're currently doing things like <code>StringLiteralFlags::from(stylist)</code> or <code>StringLiteralFlags::empty().with_quote_style(stylist.quote())</code>, it should remove the need for <code>StringLiteralFlags::DYNAMIC</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2025-01-25 19:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-25 20:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flynt/rules/static_join_to_fstring.rs</code>:86 on 2025-01-25 20:00</div>
            <div class="timeline-body"><p>I know this just comes straight from my previous patch, but it would be good to do this with a little less <code>unwrap</code>ping. Maybe something like this?</p>
<pre><code class="language-diff">diff --git a/crates/ruff_linter/src/rules/flynt/rules/static_join_to_fstring.rs b/crates/ruff_linter/src/rules/flynt/rules/static_join_to_fstring.rs
index d7c0cefda..f26288f7d 100644
--- a/crates/ruff_linter/src/rules/flynt/rules/static_join_to_fstring.rs
+++ b/crates/ruff_linter/src/rules/flynt/rules/static_join_to_fstring.rs
@@ -1,5 +1,4 @@
 use ast::FStringFlags;
-use itertools::Itertools;
 
 use crate::fix::edits::pad;
 use ruff_diagnostics::{AlwaysFixableViolation, Diagnostic, Edit, Fix};
@@ -63,27 +62,29 @@ fn is_static_length(elts: &amp;[Expr]) -&gt; bool {
 fn build_fstring(joiner: &amp;str, joinees: &amp;[Expr]) -&gt; Option&lt;Expr&gt; {
     // If all elements are string constants, join them into a single string.
     if joinees.iter().all(Expr::is_string_literal_expr) {
+        let mut flags = None;
+        let mut new_value = String::new();
+
+        for (i, expr) in joinees
+            .iter()
+            .filter_map(Expr::as_string_literal_expr)
+            .enumerate()
+        {
+            new_value.push_str(expr.value.to_str());
+            if i &lt; joinees.len() - 1 {
+                new_value.push_str(joiner);
+            }
+            if flags.is_none() {
+                flags = Some(expr.value.flags());
+            }
+        }
+
         let node = ast::StringLiteral {
-            value: joinees
-                .iter()
-                .filter_map(|expr| {
-                    if let Expr::StringLiteral(ast::ExprStringLiteral { value, .. }) = expr {
-                        Some(value.to_str())
-                    } else {
-                        None
-                    }
-                })
-                .join(joiner)
-                .into_boxed_str(),
+            value: new_value.into_boxed_str(),
             range: TextRange::default(),
-            flags: joinees
-                .first()
-                .unwrap()
-                .as_string_literal_expr()
-                .unwrap()
-                .value
-                .flags(),
+            flags: flags.expect(&quot;Expected at least one element&quot;),
         };
+
         return Some(node.into());
     }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-25 20:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flynt/rules/static_join_to_fstring.rs</code>:86 on 2025-01-25 20:11</div>
            <div class="timeline-body"><p>Makes sense to me. We could also use some question marks since the function returns an <code>Option</code>, but I think <code>if flags.is_none() { ... }</code> is closer to what I had before anyway.</p>
<p>I was also slightly annoyed by the <code>if joinees.iter().all(Expr::is_string_literal_expr) {</code> immediately followed by <code>.filter_map(Expr::as_string_literal_expr)</code> but didn't see a good fix before. ~~By moving it out of a closure and into a for loop we could use let-else and return early!~~ Edit: I keep forgetting there's more code in this function...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-25 20:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flynt/rules/static_join_to_fstring.rs</code>:86 on 2025-01-25 20:16</div>
            <div class="timeline-body"><blockquote>
<p>I was also slightly annoyed by the <code>if joinees.iter().all(Expr::is_string_literal_expr) {</code> immediately followed by <code>.filter_map(Expr::as_string_literal_expr)</code></p>
</blockquote>
<p>Yeah, I agree that this is a bit annoying... I think it's a micro-optimisation to avoid allocating a <code>String</code> on the heap if <code>joinees</code> aren't all <code>ExprStringLiteral</code>s. But the micro-optimisation might well not be worth it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-25 20:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flynt/rules/static_join_to_fstring.rs</code>:86 on 2025-01-25 20:24</div>
            <div class="timeline-body"><p>Do you prefer moving <code>new_value</code> out into a separate loop? This is what I had before with the flag setting mixed into the existing closure:</p>
<pre><code class="language-rust">    if joinees.iter().all(Expr::is_string_literal_expr) {
        let mut flags = None;
        let node = ast::StringLiteral {
            value: joinees
                .iter()
                .filter_map(|expr| {
                    if let Expr::StringLiteral(ast::ExprStringLiteral { value, .. }) = expr {
                        if flags.is_none() {
                            // take the flags from the first Expr
                            flags = Some(value.flags());
                        }
                        Some(value.to_str())
                    } else {
                        None
                    }
                })
                .join(joiner)
                .into_boxed_str(),
            flags: flags.unwrap_or_default(),
            ..ast::StringLiteral::default()
        };
        return Some(node.into());
    }
</code></pre>
<p><code>unwrap_or_default</code> could be replaced with <code>expect</code> like your code above or <code>?</code> if we want to bail out.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-25 20:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flynt/rules/static_join_to_fstring.rs</code>:86 on 2025-01-25 20:26</div>
            <div class="timeline-body"><p>Ooh that diff LGTM! Happy to go with that!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-01-25 20:55</div>
            <div class="timeline-body"><p>Great call on <code>Checker::default_string_flags</code>! That did indeed allow us to delete the <code>DYNAMIC</code> flag, and I think it's a much nicer approach.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-01-25 21:18</div>
            <div class="timeline-body"><p>Should I revert the <code>Default</code> changes on <code>StringLiteralFlags</code>? I definitely want to point people toward the new <code>Checker</code> API for getting these flags. It would almost be nice if that were the only way to construct the flags, at least in rules, but I'm sure there are places where we really want either <code>default</code> or <code>empty</code>.</p>
<p>I tried marking <code>empty</code> <code>pub(crate)</code> to test this. 3/4 issues were reasonable to fix, but <code>Checker::default_string_flags</code> can't access it at <code>pub(crate)</code>! So I guess there's no way to enforce this, but I can at least add a note on the <code>empty</code> documentation. That's a benefit of <code>empty</code> over a derived <code>default</code> at least.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-01-25 22:15</div>
            <div class="timeline-body"><blockquote>
<p>I tried marking <code>empty</code> <code>pub(crate)</code> to test this. 3/4 issues were reasonable to fix, but <code>Checker::default_string_flags</code> can't access it at <code>pub(crate)</code>! So I guess there's no way to enforce this, but I can at least add a note on the <code>empty</code> documentation. That's a benefit of <code>empty</code> over a derived <code>default</code> at least.</p>
</blockquote>
<p>I think you could make <code>StringLiteralFlags::empty()</code> <code>pub(crate)</code> if you added a <code>pub</code> <code>StringLiteralFlags::new()</code> method, which <em>has</em> to have a <code>Quote</code> passed into it? Something like this (relative to your branch)?</p>
<pre><code class="language-diff">diff --git a/crates/ruff_linter/src/checkers/ast/mod.rs b/crates/ruff_linter/src/checkers/ast/mod.rs
index f82b5141d..7e0a730f8 100644
--- a/crates/ruff_linter/src/checkers/ast/mod.rs
+++ b/crates/ruff_linter/src/checkers/ast/mod.rs
@@ -310,7 +310,7 @@ impl&lt;'a&gt; Checker&lt;'a&gt; {
     /// Return the default string flags a generated `StringLiteral` node should use, given where we
     /// are in the AST.
     pub(crate) fn default_string_flags(&amp;self) -&gt; ast::StringLiteralFlags {
-        ast::StringLiteralFlags::empty().with_quote_style(self.preferred_quote())
+        ast::StringLiteralFlags::new(self.preferred_quote())
     }
 
     /// Returns the appropriate quoting for f-string by reversing the one used outside of
diff --git a/crates/ruff_linter/src/rules/ruff/rules/assert_with_print_message.rs b/crates/ruff_linter/src/rules/ruff/rules/assert_with_print_message.rs
index 4a2b7ce0b..07b1f31ee 100644
--- a/crates/ruff_linter/src/rules/ruff/rules/assert_with_print_message.rs
+++ b/crates/ruff_linter/src/rules/ruff/rules/assert_with_print_message.rs
@@ -147,7 +147,7 @@ mod print_arguments {
             if let FStringElement::Literal(literal) = element {
                 acc.push(StringLiteral {
                     value: literal.value.clone(),
-                    flags: StringLiteralFlags::empty().with_quote_style(quote),
+                    flags: StringLiteralFlags::new(quote),
                     range: TextRange::default(),
                 });
                 Some(acc)
@@ -206,7 +206,7 @@ mod print_arguments {
             range: TextRange::default(),
             value: StringLiteralValue::single(StringLiteral {
                 value: combined_string.into(),
-                flags: StringLiteralFlags::empty().with_quote_style(quote),
+                flags: StringLiteralFlags::new(quote),
                 range: TextRange::default(),
             }),
         }))
diff --git a/crates/ruff_python_ast/src/nodes.rs b/crates/ruff_python_ast/src/nodes.rs
index 71fd1de12..ca3b23a6b 100644
--- a/crates/ruff_python_ast/src/nodes.rs
+++ b/crates/ruff_python_ast/src/nodes.rs
@@ -1424,7 +1424,11 @@ bitflags! {
 pub struct StringLiteralFlags(StringLiteralFlagsInner);
 
 impl StringLiteralFlags {
-    pub fn empty() -&gt; Self {
+    pub fn new(quote_style: Quote) -&gt; Self {
+        Self::empty().with_quote_style(quote_style)
+    }
+
+    pub(crate) fn empty() -&gt; Self {
         Self(StringLiteralFlagsInner::empty())
     }
 
diff --git a/crates/ruff_python_formatter/tests/normalizer.rs b/crates/ruff_python_formatter/tests/normalizer.rs
index dd83f0612..f3027a569 100644
--- a/crates/ruff_python_formatter/tests/normalizer.rs
+++ b/crates/ruff_python_formatter/tests/normalizer.rs
@@ -8,7 +8,7 @@ use ruff_python_ast::visitor::transformer;
 use ruff_python_ast::visitor::transformer::Transformer;
 use ruff_python_ast::{
     self as ast, BytesLiteralFlags, Expr, FStringElement, FStringFlags, FStringLiteralElement,
-    FStringPart, Stmt, StringFlags, StringLiteralFlags,
+    FStringPart, Stmt, StringFlags,
 };
 use ruff_text_size::{Ranged, TextRange};
 
@@ -81,7 +81,7 @@ impl Transformer for Normalizer {
                         string.value = ast::StringLiteralValue::single(ast::StringLiteral {
                             value: string.value.to_str().to_string().into_boxed_str(),
                             range: string.range,
-                            flags: StringLiteralFlags::empty(),
+                            flags: string.value.flags(),
                         });
                     }
                 }
</code></pre>
<p>(not <em>100%</em> sure about that formatter change -- Micha or Dhruv can advise on that one!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/ruff/rules/assert_with_print_message.rs</code>:69 on 2025-01-26 09:54</div>
            <div class="timeline-body"><pre><code class="language-suggestion">                    msg: print_arguments::to_expr(&amp;call.arguments, checker.preferred_quote())
</code></pre>
<p>Or you could use <code>checker.default_string_flags()</code> and pass a <code>StringLiteralFlags</code> instance down into the lower functions rather than passing a <code>Quote</code> down -- either works!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-26 09:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-26 10:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_type_checking/snapshots/ruff_linter__rules__flake8_type_checking__tests__quote_typing-only-third-party-import_quote3.py.snap</code>:26 on 2025-01-26 10:55</div>
            <div class="timeline-body"><p>I actually think this is okay. The reason why escaping is necessary here is because double quotes are used for the second string in the slice here (for <code>&quot;inactive&quot;</code>); it's impossible to retain the quoting style for both strings without escaping the quotes on one of them. The annotation is still valid -- it's still understood by <a href="https://mypy-play.net/?mypy=latest&amp;python=3.12&amp;gist=db0b8efe8e8d9fca0441ab6fc0948b5f">mypy</a> and <a href="https://pyright-play.net/?strict=true&amp;enableExperimentalFeatures=true&amp;reportImplicitOverride=true&amp;reportShadowedImports=true&amp;reportUnusedCallResult=true&amp;code=GYJw9gtgBALgngBwJYDsDmUkQWEMoAySMApiAIYA2AUNQCYnBTAAUAHgFxQBERpFlANoAdbuVEBdbgEoO1KAqggSANxJUA%2BvAQl20oA">pyright</a>.</p>
<p>I agree that it would be <em>cleaner</em> if the quotes were normalized here so that no escaping is required. You could argue that that's a job for a formatter, though, rather than a linter autofix?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_type_checking/snapshots/ruff_linter__rules__flake8_type_checking__tests__quote_typing-only-third-party-import_quote3.py.snap</code>:26 on 2025-01-26 10:58</div>
            <div class="timeline-body"><p>hmm, but I suppose a formatter wouldn't fix the code introduced by this fix, since that would actually change the contents of the string from the formatter's perspective.</p>
<p>I guess in that case, it <em>would</em> be nice if this autofix didn't introduce escaped quotes... though I would still say it doesn't necessarily have to block the PR being merged</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-26 10:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-26 11:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_type_checking/snapshots/ruff_linter__rules__flake8_type_checking__tests__quote_typing-only-third-party-import_quote3.py.snap</code>:26 on 2025-01-26 11:22</div>
            <div class="timeline-body"><p>cc. @Daverball in case he has any ideas for an easy fix for this :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Daverball">@Daverball</a> on <code>crates/ruff_linter/src/rules/flake8_type_checking/snapshots/ruff_linter__rules__flake8_type_checking__tests__quote_typing-only-third-party-import_quote3.py.snap</code>:26 on 2025-01-26 12:26</div>
            <div class="timeline-body"><p>This looks like an artifact of how this specific fix works. First we stringize the quoted expression, taking care to expand nested forward references. Then we stringize the generated string again, treating it like a string literal in order to correctly render any nested quotes.</p>
<p>I think in this case it honestly makes more sense to ignore what quotes the original string literals were using, since ideally we always want to end up choosing the preferred quote for the outer string, even if that leads to an edit which changes more things. (I.e. the inner string should use either only our non-preferred quote or use both of them for nested cases, but never only our preferred quote)</p>
<p>I wouldn't want <code>Literal[&quot;Foo&quot;]</code> to be turned into <code>'Literal[&quot;Foo&quot;]'</code> if <code>&quot;</code> was my preferred quote, but rather <code>&quot;Literal['Foo']&quot;</code>, similarly I wouldn't want it to be turned into <code>&quot;Literal[\&quot;Foo\&quot;]&quot;</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Daverball">@Daverball</a> reviewed on 2025-01-26 12:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-26 14:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_type_checking/snapshots/ruff_linter__rules__flake8_type_checking__tests__quote_typing-only-third-party-import_quote3.py.snap</code>:26 on 2025-01-26 14:59</div>
            <div class="timeline-body"><p>Okay great -- thanks @Daverball! Practically speaking, I think we could get there with something like this @ntBre:</p>
<pre><code class="language-diff">diff --git a/crates/ruff_linter/src/rules/flake8_type_checking/helpers.rs b/crates/ruff_linter/src/rules/flake8_type_checking/helpers.rs
index cc976bf17..60970cbfc 100644
--- a/crates/ruff_linter/src/rules/flake8_type_checking/helpers.rs
+++ b/crates/ruff_linter/src/rules/flake8_type_checking/helpers.rs
@@ -3,6 +3,7 @@ use std::cmp::Reverse;
 use ruff_diagnostics::Edit;
 use ruff_python_ast::helpers::{map_callable, map_subscript};
 use ruff_python_ast::name::QualifiedName;
+use ruff_python_ast::str::Quote;
 use ruff_python_ast::visitor::transformer::{walk_expr, Transformer};
 use ruff_python_ast::{self as ast, Decorator, Expr, StringLiteralFlags};
 use ruff_python_codegen::{Generator, Stylist};
@@ -381,6 +382,12 @@ impl&lt;'a&gt; QuoteAnnotator&lt;'a&gt; {
         if let Expr::Tuple(ast::ExprTuple { elts, .. }) = slice {
             if !elts.is_empty() {
                 self.visit_expr(&amp;mut elts[0]);
+                // The outer annotation will use the preferred quote.
+                // As such, any quotes found in metadata elements inside an `Annotated` slice
+                // should use the opposite quote to the preferred quote.
+                for elt in elts.iter_mut().skip(1) {
+                    QuoteRewriter::new(self.stylist).visit_expr(elt);
+                }
             }
         }
     }
@@ -395,8 +402,10 @@ impl Transformer for QuoteAnnotator&lt;'_&gt; {
                         .semantic
                         .match_typing_qualified_name(&amp;qualified_name, &quot;Literal&quot;)
                     {
-                        // we don't want to modify anything inside `Literal`
-                        // so skip visiting this subscripts' slice
+                        // The outer annotation will use the preferred quote.
+                        // As such, any quotes found inside a `Literal` slice
+                        // should use the opposite quote to the preferred quote.
+                        QuoteRewriter::new(self.stylist).visit_expr(slice);
                     } else if self
                         .semantic
                         .match_typing_qualified_name(&amp;qualified_name, &quot;Annotated&quot;)
@@ -425,3 +434,22 @@ impl Transformer for QuoteAnnotator&lt;'_&gt; {
         }
     }
 }
+
+#[derive(Debug)]
+struct QuoteRewriter {
+    preferred_inner_quote: Quote,
+}
+
+impl QuoteRewriter {
+    fn new(stylist: &amp;Stylist) -&gt; Self {
+        Self {
+            preferred_inner_quote: stylist.quote().opposite(),
+        }
+    }
+}
+
+impl Transformer for QuoteRewriter {
+    fn visit_string_literal(&amp;self, literal: &amp;mut ast::StringLiteral) {
+        literal.flags = literal.flags.with_quote_style(self.preferred_inner_quote);
+    }
+}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-26 15:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_type_checking/snapshots/ruff_linter__rules__flake8_type_checking__tests__quote_typing-only-third-party-import_quote3.py.snap</code>:26 on 2025-01-26 15:27</div>
            <div class="timeline-body"><p>Thanks for this feedback! I agree that using the preferred quote on the outer expression and not escaping inner quotes would be nicest. And I confirmed that the formatter will not fix this currently.</p>
<p>It's not immediately clear to me how to fix this, but I will at least track it as a follow up. I'm really stuck on this <code>DYNAMIC</code> flag idea, but barring that, I think it will require changes in <a href="https://github.com/astral-sh/ruff/blob/brent%2Fquote-style/crates/ruff_linter/src/rules/flake8_type_checking/helpers.rs#L359"><code>QuoteAnnotator::into_annotation</code></a> or at least somewhere between there and <a href="https://github.com/astral-sh/ruff/blob/brent%2Fquote-style/crates/ruff_linter/src/rules/flake8_type_checking/helpers.rs#L247"><code>quote_annotation</code></a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-26 15:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_type_checking/snapshots/ruff_linter__rules__flake8_type_checking__tests__quote_typing-only-third-party-import_quote3.py.snap</code>:26 on 2025-01-26 15:28</div>
            <div class="timeline-body"><p>Oops, should have refreshed before commenting! I'll try Alex's fix!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-26 16:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_type_checking/snapshots/ruff_linter__rules__flake8_type_checking__tests__quote_typing-only-third-party-import_quote3.py.snap</code>:26 on 2025-01-26 16:02</div>
            <div class="timeline-body"><p>The patch worked perfectly! I was able to revert the quoting snapshot changes too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/assert_with_print_message.rs</code>:69 on 2025-01-26 16:15</div>
            <div class="timeline-body"><p>Ooh good catch. I went for the <code>StringLiteralFlags</code> approach, but I'm happy with either one too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-26 16:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-01-26 17:02</div>
            <div class="timeline-body"><p>Thanks for the patches! They should all be applied now.</p>
<blockquote>
<p>I think you could make <code>StringLiteralFlags::empty()</code> <code>pub(crate)</code> if you added a <code>pub</code> <code>StringLiteralFlags::new()</code> method, which <em>has</em> to have a <code>Quote</code> passed into it? Something like this (relative to your branch)?</p>
</blockquote>
<p>I think this is a little better, but I'm still looking for a good place to document the best way to construct these for rule authors. <code>Quote</code>s are also <code>pub</code> and easy to construct, so you can still do <code>StringLiteralFlags::new(Quote::Double)</code>, for example. I tried adding this locally on <code>StringLiteralFlags::new</code>, but the links are broken, again because of crate boundaries/privacy. I can just remove the square brackets, or leave this out if it's not a big deal. Removing <code>..default()</code> and having to think about the <code>Quote</code> may already be plenty of friction anyway.</p>
<pre><code class="language-rust">    /// Construct a new [`StringLiteralFlags`] with `quote_style`.
    ///
    /// If you're using a [`Generator`] to generate a fix from an existing string literal, consider
    /// passing along the [`StringLiteral.flags`] field or the result of the
    /// [`StringLiteralValue::flags`]` method. If you don't have an existing string but have a
    /// [`Checker`] available, consider using [`Checker::default_string_flags`], which will properly
    /// handle surrounding f-strings.
    pub fn new(quote_style: Quote) -&gt; Self {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:312 on 2025-01-26 17:07</div>
            <div class="timeline-body"><p>It looks like this is now only actually used within this module; I think we can make it private!</p>
<pre><code class="language-suggestion">    fn default_string_flags(&amp;self) -&gt; ast::StringLiteralFlags {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_formatter/tests/normalizer.rs</code>:84 on 2025-01-26 17:10</div>
            <div class="timeline-body"><p>I'd still love somebody more familiar with the formatter than me to OK this change -- I know Micha is out this week, so maybe @dhruvmanila?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-01-26 17:11</div>
            <div class="timeline-body"><p>Brilliant work! This is a big improvement to our autofix infrastructure</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-01-26 17:12</div>
            <div class="timeline-body"><blockquote>
<p>I think this is a little better, but I'm still looking for a good place to document the best way to construct these for rule authors. <code>Quote</code>s are also <code>pub</code> and easy to construct, so you can still do <code>StringLiteralFlags::new(Quote::Double)</code>, for example. I tried adding this locally on <code>StringLiteralFlags::new</code>, but the links are broken, again because of crate boundaries/privacy. I can just remove the square brackets, or leave this out if it's not a big deal.</p>
</blockquote>
<p>I think more internal documentation is almost always a good thing -- I'd add the docs, but just leave out the square brackets where necessary!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-26 17:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:312 on 2025-01-26 17:21</div>
            <div class="timeline-body"><p>This is still used by a bunch of rules on my branch. Did I miss a patch somewhere?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-01-26 17:23</div>
            <div class="timeline-body"><p>Thank you again! Sounds good, I'll add the docs and then hold off until we can double check the formatter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-26 17:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:312 on 2025-01-26 17:27</div>
            <div class="timeline-body"><p>Oops, sorry, I meant to suggest making <code>Checker::preferred_quote()</code> private, not <code>Checker::default_string_flags()</code>! <em>That</em> one is now only used within this module 😄</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-26 17:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:312 on 2025-01-26 17:30</div>
            <div class="timeline-body"><p>Oh of course, thanks for clarifying!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-01-26 17:32</div>
            <div class="timeline-body"><p>Oh, it might be good to adjust the docs for this field as well: https://github.com/astral-sh/ruff/blob/cb3361e682fc52d7ac9fdc5e2558373eb1d94a1f/crates/ruff_python_codegen/src/generator.rs#L68-L69</p>
<p>We need to:</p>
<ul>
<li>Clarify that it now only impacts f-strings and bytestrings, not normal string literals</li>
<li>Say that to control the quoting style of a <code>StringLiteral</code> you need to modify the <code>StringLiteralFlags</code> on the node before you pass it to the <code>Generator</code></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-26 17:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:1774 on 2025-01-26 17:37</div>
            <div class="timeline-body"><p>I suppose we <em>could</em> keep these tests, but use bytestrings (or f-strings) rather than regular strings? Though obviously we'll hopefully be making the same change for bytestrings and f-strings too fairly soon!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:1774 on 2025-01-26 17:58</div>
            <div class="timeline-body"><p>Yeah, I felt pretty bad deleting a test. On the other hand, the function being tested here (<code>round_trip_with</code>) is defined in this <code>tests</code> module, and the only remaining uses are with <code>Quote::default</code>, so the test did seem outdated to me. I'm happy to restore it with another string type if you prefer, though, or update <code>round_trip_with</code> not to take a <code>Quote</code> argument. That seems like another way to clarify things.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-26 17:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-26 18:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:1774 on 2025-01-26 18:04</div>
            <div class="timeline-body"><blockquote>
<p>the function being tested here (<code>round_trip_with</code>) is defined in this <code>tests</code> module, and the only remaining uses are with <code>Quote::default</code>, so the test did seem outdated to me.</p>
</blockquote>
<p>Right. But I think these tests are essentially a unit test for the <code>quote</code> field, to check that modifying the <code>quote</code> the struct is initialized with modifies the quotes that are used by the generated code (hence the test function's name <code>set_quote</code>). So if we delete these tests, there are no longer any dedicated unit tests for the <code>quote</code> field, even though that field <em>is</em> still used to decide what quotes the generator should use for bytestrings and f-strings.</p>
<p>Again, it's not a <em>huge</em> deal since hopefully we'll get to bytestrings and f-strings pretty soon in followup PRs! But I would <em>weakly</em> prefer to modify the tests slightly here rather than deleting them, until we're able to get rid of the <code>Generator::quote</code> field entirely.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-26 18:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:1774 on 2025-01-26 18:18</div>
            <div class="timeline-body"><p>That makes sense. I restored the test and extended it to all three string types. Hopefully the macro isn't too gratuitous. I thought it clarified the purpose of the test and made it more compact.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_type_checking/helpers.rs</code>:440 on 2025-01-26 18:26</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// A [`Transformer`] class that rewrites all strings in an expression
/// to use a specified quotation style
#[derive(Debug)]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/pylint/rules/unspecified_encoding.rs</code>:169 on 2025-01-26 18:32</div>
            <div class="timeline-body"><p>you could do a driveby simplification here, if you like (since we're here!):</p>
<pre><code class="language-diff">diff --git a/crates/ruff_linter/src/rules/pylint/rules/unspecified_encoding.rs b/crates/ruff_linter/src/rules/pylint/rules/unspecified_encoding.rs
index 6d785760b..ba16f7fd2 100644
--- a/crates/ruff_linter/src/rules/pylint/rules/unspecified_encoding.rs
+++ b/crates/ruff_linter/src/rules/pylint/rules/unspecified_encoding.rs
@@ -158,16 +158,11 @@ fn generate_keyword_fix(checker: &amp;Checker, call: &amp;ast::ExprCall) -&gt; Fix {
     Fix::unsafe_edit(add_argument(
         &amp;format!(
             &quot;encoding={}&quot;,
-            checker
-                .generator()
-                .expr(&amp;Expr::StringLiteral(ast::ExprStringLiteral {
-                    value: ast::StringLiteralValue::single(ast::StringLiteral {
-                        value: &quot;utf-8&quot;.to_string().into_boxed_str(),
-                        flags: checker.default_string_flags(),
-                        range: TextRange::default(),
-                    }),
-                    range: TextRange::default(),
-                }))
+            checker.generator().expr(&amp;Expr::from(ast::StringLiteral {
+                value: Box::from(&quot;utf-8&quot;),
+                flags: checker.default_string_flags(),
+                range: TextRange::default(),
+            }))
         ),
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1437 on 2025-01-26 18:58</div>
            <div class="timeline-body"><p>The way I find this documentation most useful is when hovering over a struct or function in VSCode when I'm in another module (it displays a rendered version for me). E.g. here's the tooltip I get when I hover over <code>ast::StringLiteral</code> in the module for a linter rule:</p>
<details>
<summary>Screenshot</summary>

<p><img src="https://github.com/user-attachments/assets/9cfc7a68-468d-4a55-b3b3-e84d4fe22ac8" alt="image" /></p>
</details>

<p>But I think I'm much more likely to hover over <code>StringLiteralFlags</code> in another module than <code>StringLiteralFlags::new()</code> if I want information on how to construct instances of the struct, especially if I'm not familiar with the struct and/or don't know about the <code>new()</code> method. The manual links you've included here also just give me a 404 if I click on them from inside VSCode :-(</p>
<details>
<summary>Screenshot</summary>

<p><img src="https://github.com/user-attachments/assets/72be58d7-f60e-40b7-ac55-c58e89d6ab9b" alt="image" /></p>
</details>

<p>So I think I'd prefer to move the docs to the struct itself, and probably skip the manual links. Something like this?</p>
<pre><code class="language-diff">diff --git a/crates/ruff_python_ast/src/nodes.rs b/crates/ruff_python_ast/src/nodes.rs
index 8de1a0098..e2aba34bd 100644
--- a/crates/ruff_python_ast/src/nodes.rs
+++ b/crates/ruff_python_ast/src/nodes.rs
@@ -1420,25 +1420,29 @@ bitflags! {
 
 /// Flags that can be queried to obtain information
 /// regarding the prefixes and quotes used for a string literal.
+///
+/// ## Notes on usage
+///
+/// If you're using a `Generator` from the `ruff_python_codegen` crate to generate a lint-rule
+/// fix from an existing string literal, consider passing along the [`StringLiteral::flags`]
+/// field or the result of the [`StringLiteralValue::flags`] method. If you don't have an
+/// existing string but have a `Checker` from the `ruff_linter` crate available, consider
+/// using `Checker::default_string_flags` to create instances of this struct; this method will
+/// properly handle surrounding f-strings. For usage that doesn't fit into one of these categories,
+/// the public constructor [`StringLiteralFlags::new`] can be used.
 #[derive(Copy, Clone, Eq, PartialEq, Hash)]
 pub struct StringLiteralFlags(StringLiteralFlagsInner);
 
 impl StringLiteralFlags {
     /// Construct a new [`StringLiteralFlags`] with `quote_style`.
     ///
-    /// If you're using a [`Generator`](../ruff_python_codegen/struct.Generator.html) to generate a
-    /// fix from an existing string literal, consider passing along the [`StringLiteral::flags`]
-    /// field or the result of the [`StringLiteralValue::flags`] method. If you don't have an
-    /// existing string but have a [`Checker`](../ruff_linter/checkers/ast/struct.Checker.html)
-    /// available, consider using [`Checker::default_string_flags`], which will properly handle
-    /// surrounding f-strings.
-    ///
-    /// [`Checker::default_string_flags`]:
-    /// ../ruff_linter/checkers/ast/struct.Checker.html#method.default_string_flags
+    /// See the documentation for [`StringLiteralFlags`] for caveats on this constructor,
+    /// and situations in which alternative ways to construct this struct should be used.
     pub fn new(quote_style: Quote) -&gt; Self {
         Self::empty().with_quote_style(quote_style)
     }
 
+    /// Private-to-the-crate method for creating a new [`StringLiteralFlags`].
     pub(crate) fn empty() -&gt; Self {
         Self(StringLiteralFlagsInner::empty())
     }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:2148 on 2025-01-26 18:59</div>
            <div class="timeline-body"><p>I guess this could now be</p>
<pre><code class="language-suggestion">        let new = StringLiteralFlags::new(value.quote_style())
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_codegen/src/generator.rs</code>:1774 on 2025-01-26 19:00</div>
            <div class="timeline-body"><p>Nice, the macro seems fine to me!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-01-26 19:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-26 20:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pylint/rules/unspecified_encoding.rs</code>:169 on 2025-01-26 20:17</div>
            <div class="timeline-body"><p>Oh nice. I actually looked at this code too and almost opened a separate PR just changing it to <code>&quot;encoding=\&quot;utf-8\&quot;&quot;</code>, but it turned out to be important to use the generator for weird cases where the <code>open</code> is nested in an f-string, for example. Something like <code>f&quot;{[line for line in open('foo.txt')]}&quot;</code> is what I came up with to break my &quot;fix.&quot;</p>
<p>There are some <code>local</code>/<code>locale</code> typos in the docs that we can get while we're here too!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-26 20:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1437 on 2025-01-26 20:20</div>
            <div class="timeline-body"><p>Sounds good! I meant to mention that I was happy to delete the manual links. It worked well for the docs I opened in the browser, but I'm not surprised that they aren't very robust. It also makes sense to put the docs on the struct itself!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-27 12:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:2148 on 2025-01-27 12:00</div>
            <div class="timeline-body"><p>...or we could consider getting rid of the <code>StringLiteralFlags::empty()</code> method altogether, and say that <code>StringLiteralFlags::new()</code> is the <em>only</em> way of constructing the struct!</p>
<pre><code class="language-diff">diff --git a/crates/ruff_python_ast/src/nodes.rs b/crates/ruff_python_ast/src/nodes.rs
index 8de1a0098..b272597b9 100644
--- a/crates/ruff_python_ast/src/nodes.rs
+++ b/crates/ruff_python_ast/src/nodes.rs
@@ -1436,11 +1436,7 @@ impl StringLiteralFlags {
     /// [`Checker::default_string_flags`]:
     /// ../ruff_linter/checkers/ast/struct.Checker.html#method.default_string_flags
     pub fn new(quote_style: Quote) -&gt; Self {
-        Self::empty().with_quote_style(quote_style)
-    }
-
-    pub(crate) fn empty() -&gt; Self {
-        Self(StringLiteralFlagsInner::empty())
+        Self(StringLiteralFlagsInner::empty()).with_quote_style(quote_style)
     }
 
     #[must_use]
@@ -1571,7 +1567,7 @@ impl StringLiteral {
         Self {
             range,
             value: &quot;&quot;.into(),
-            flags: StringLiteralFlags::empty().with_invalid(),
+            flags: StringLiteralFlags::new(Quote::default()).with_invalid(),
         }
     }
 }
@@ -2140,9 +2136,7 @@ impl From&lt;AnyStringFlags&gt; for StringLiteralFlags {
                 value.prefix()
             )
         };
-        let new = StringLiteralFlags::empty()
-            .with_quote_style(value.quote_style())
-            .with_prefix(prefix);
+        let new = StringLiteralFlags::new(value.quote_style()).with_prefix(prefix);
         if value.is_triple_quoted() {
             new.with_triple_quotes()
         } else {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-27 12:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1437 on 2025-01-27 12:01</div>
            <div class="timeline-body"><p>One other thought -- it might also be good to add to the doc-comment for <code>StringLiteralFlags::new()</code> that the instance returned will not have the triple-quoting flag set, nor any of the prefix flags.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-27 13:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1437 on 2025-01-27 13:25</div>
            <div class="timeline-body"><p>Oh that reminds me, I think one of the test cases loses its triple quotes. Actually the first SIM905 test case:</p>
<pre><code class="language-text">SIM905.py:6:1: SIM905 [*] Consider using a list literal instead of `str.split`
   |
 5 |   # positives
 6 | / &quot;&quot;&quot;
 7 | |     itemA
 8 | |     itemB
 9 | |     itemC
10 | | &quot;&quot;&quot;.split()
   | |___________^ SIM905
11 |
12 |   &quot;a,b,c,d&quot;.split(&quot;,&quot;)
   |
   = help: Replace with list literal

ℹ Safe fix
3  3  | no_sep = None
4  4  | 
5  5  | # positives
6     |-&quot;&quot;&quot;
7     |-	itemA
8     |-	itemB
9     |-	itemC
10    |-&quot;&quot;&quot;.split()
   6  |+[&quot;itemA&quot;, &quot;itemB&quot;, &quot;itemC&quot;]
11 7  | 
12 8  | &quot;a,b,c,d&quot;.split(&quot;,&quot;)
13 9  | &quot;a,b,c,d&quot;.split(None)
</code></pre>
<p>I guess calling <code>flags.quote_style()</code> in the generator means we only get single or double quote information, not all of the flags. This might be going beyond the scope of this PR, but is that something we want to preserve too? It would look pretty bad in this example as <code>[&quot;&quot;&quot;itemA&quot;&quot;&quot;, ...]</code> but I'm sure other cases would make more sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-27 13:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1437 on 2025-01-27 13:30</div>
            <div class="timeline-body"><p>Ah, interesting question! I think in general, probably yes, but for that specific autofix, probably no? So it's probably best to defer that question to a followup PR so we can examine the impact changing this has on each rule's autofix (and see what the ecosystem report is).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-27 13:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_simplify/snapshots/ruff_linter__rules__flake8_simplify__tests__SIM905_SIM905.py.snap</code>:572 on 2025-01-27 13:32</div>
            <div class="timeline-body"><p>micro-nit: could you update the comment in the fixture (which will also result in this snapshot being updated) to reflect that we now retain the <code>u</code> prefix? Similar for a number of other comments in this file on lines where the suggested fix is now being changed</p>
<pre><code class="language-suggestion">   58 |+[u&quot;a&quot;, u&quot;b&quot;]  # [u&quot;a&quot;, u&quot;b&quot;]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-01-27 13:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1440 on 2025-01-27 13:39</div>
            <div class="timeline-body"><p>I think it might be confusing to see that one can construct a <code>StringLiteralFlags</code> only by supplying the quote via the <code>new</code> function and not any other parameters like prefix. I'd either (a) inline the logic <code>::empty()::with_quote_style(...)</code> everywhere this is being used or (b) implement <code>From&lt;Quote&gt;</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-01-27 13:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1440 on 2025-01-27 13:40</div>
            <div class="timeline-body"><p>I see that this is only being used in <code>Checker::default_string_flags</code> so my preference would be to just inline the logic (a)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-27 13:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1440 on 2025-01-27 13:51</div>
            <div class="timeline-body"><p>I think our worry was that contributors writing an autofix for the linter might not know about the <code>Checker::default_string_flags()</code> method (which should be the preferred way to create an instance of <code>StringLiteralFlags</code> in many autofixes following this PR). So they might use <code>StringLiteralFlags::empty()</code> to create a new instance instead, and that could easily slip through the net in PR review.</p>
<p>I do see your point, though. Maybe it'll be okay if we just put a big warning in the doc-comment above <code>StringLiteralFlags::empty()</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-01-27 13:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_formatter/tests/normalizer.rs</code>:84 on 2025-01-27 13:51</div>
            <div class="timeline-body"><p>tl;dr, I don't think this matters but I'd prefer to keep using the default flags.</p>
<p>This normalizer is mainly used to normalize the formatted and unformatted AST to assert that both the ASTs are same (formatter shouldn't change the AST). This assertion happens here: https://github.com/astral-sh/ruff/blob/648ad8a20de2bc709470ffe908e42687d87dedc7/crates/ruff_python_formatter/tests/fixtures.rs#L384-L422</p>
<p>Why I think this doesn't matter is because after the normalization, we compare the AST using the comparable logic which only compares the string by its content and not any of the flags:</p>
<p>https://github.com/astral-sh/ruff/blob/648ad8a20de2bc709470ffe908e42687d87dedc7/crates/ruff_python_ast/src/comparable.rs#L694-L697</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-27 13:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_formatter/tests/normalizer.rs</code>:84 on 2025-01-27 13:59</div>
            <div class="timeline-body"><p>Cool. So this + our other conversation at https://github.com/astral-sh/ruff/pull/15726#discussion_r1930545195 suggests to me that we should:</p>
<ul>
<li>Get rid of <code>StringLiteralFlags::new()</code></li>
<li>Promote <code>StringLiteralFlags::empty()</code> to <code>pub</code> rather than <code>pub(crate)</code> (but add a doc-comment that warns that you probably don't really ever want to use <code>StringLiteralFlags::empty()</code> from the linter crate)</li>
<li>Use <code>StringLiteralFlags::empty()</code> at this location in the formatter</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-27 13:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_simplify/snapshots/ruff_linter__rules__flake8_simplify__tests__SIM905_SIM905.py.snap</code>:572 on 2025-01-27 13:59</div>
            <div class="timeline-body"><p>Oh good catch. I think I caught them all now!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-27 14:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:2148 on 2025-01-27 14:00</div>
            <div class="timeline-body"><p>(My suggestions here are superseded by my comment at https://github.com/astral-sh/ruff/pull/15726#discussion_r1930574926 😄)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-01-27 14:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1440 on 2025-01-27 14:28</div>
            <div class="timeline-body"><p>I discussed this with Alex on Discord and we think that the <code>new</code> method should be removed and the logic be inlined, and update the <code>empty</code> documentation to include a note about it's usage in the linter.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-27 14:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1440 on 2025-01-27 14:57</div>
            <div class="timeline-body"><p>Sounds good! Thanks for the suggestion and additional context!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_type_checking/helpers.rs</code>:438 on 2025-01-27 15:16</div>
            <div class="timeline-body"><p>Ugh, this is on me -- it's Rust, not Python!</p>
<pre><code class="language-suggestion">/// A [`Transformer`] struct that rewrites all strings in an expression
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1432 on 2025-01-27 15:17</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// public constructor [`StringLiteralFlags::empty`] can be used.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_formatter/tests/normalizer.rs</code>:84 on 2025-01-27 15:18</div>
            <div class="timeline-body"><p>(per the conversation at https://github.com/astral-sh/ruff/pull/15726#discussion_r1929823038 )</p>
<pre><code class="language-suggestion">                            flags: StringLiteralFlags::empty(),
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_parser/src/lib.rs</code>:203 on 2025-01-27 15:18</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// use ruff_python_ast::{StringLiteral, StringLiteralFlags};
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_parser/src/lib.rs</code>:208 on 2025-01-27 15:19</div>
            <div class="timeline-body"><p>(since <code>Quote::DOUBLE</code> is the default)</p>
<pre><code class="language-suggestion">///     flags: StringLiteralFlags::empty(),
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-01-27 15:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-27 15:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_type_checking/helpers.rs</code>:438 on 2025-01-27 15:24</div>
            <div class="timeline-body"><p>Wow I didn't notice either!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-27 15:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_formatter/tests/normalizer.rs</code>:84 on 2025-01-27 15:32</div>
            <div class="timeline-body"><p>Sorry, I got distracted by the rest of the thread.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-27 15:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_formatter/tests/normalizer.rs</code>:84 on 2025-01-27 15:33</div>
            <div class="timeline-body"><p>no worries!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-01-27 15:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/lib.rs</code>:208 on 2025-01-27 15:37</div>
            <div class="timeline-body"><p>Hmm, I think <code>Quote::Double</code> is the default for the <code>Quote</code> enum, but <code>StringLiteralFlags::empty</code> will default to single quotes since the <code>DOUBLE</code> flag is not set. Is that right?</p>
<p>I'm happy with the proposed changes here, and I don't think it has a big effect on the example code, just clarifying if we want single or double quotes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-27 15:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_parser/src/lib.rs</code>:208 on 2025-01-27 15:45</div>
            <div class="timeline-body"><p>Oh, great catch! Even more reason to get rid of the <code>StringLiteralFlags::default()</code> method, since I think we should usually prefer double quotes, but it looks like <code>StringLiteralFlags::default()</code> would have created a string with single quotes 😆</p>
<p>I don't think it matters much in this doctest whether single quotes or double quotes are used, though, so let's just use <code>::empty()</code>, which is simpler (and matches the behaviour on <code>main</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-01-27 15:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-01-27 18:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-01-27 18:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-27 18:41</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:57:51 UTC
    </footer>
</body>
</html>
