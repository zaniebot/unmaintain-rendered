```yaml
number: 4111
title: Fix B023 shadowed variables in nested functions
type: pull_request
state: merged
author: MichaReiser
labels: []
assignees: []
merged: true
base: main
head: fix-b023-shadow
created_at: 2023-04-26T04:43:50Z
updated_at: 2023-04-26T21:01:32Z
url: https://github.com/astral-sh/ruff/pull/4111
synced_at: 2026-01-12T04:28:19Z
```

# Fix B023 shadowed variables in nested functions

---

_Pull request opened by @MichaReiser on 2023-04-26 04:43_

Fixes #4090

The issue was that we didn't return early for `FunctionDefs` and `Lambda` expressions and, therefore, visited the body twice. This becomes a problem if there are nested functions because we then no-longer exclude the outer function's argument names from the suspicious variables.

This should also be good for performance because we no longer visit the body of every function twice (`O(l^2)` where `l` is the nesting level)

---

_Comment by @MichaReiser on 2023-04-26 04:44_

Current dependencies on/for this PR:
* main
  * **PR #4111** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4111" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/charliermarsh/ruff/4111?utm_source=stack-comment).

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/flake8_bugbear/rules/function_uses_loop_variable.rs`:76 on 2023-04-26 04:46_

This is the real fix. We don't want to walk the function node again because that results in visiting the argument initializers (and a lot of unnecessary visiting)

---

_@MichaReiser reviewed on 2023-04-26 04:50_

---

_Marked ready for review by @MichaReiser on 2023-04-26 04:50_

---

_Comment by @github-actions[bot] on 2023-04-26 04:55_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     15.3Â±0.05ms     2.7 MB/sec    1.00     15.4Â±0.07ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.9Â±0.00ms     4.3 MB/sec    1.00      3.9Â±0.00ms     4.3 MB/sec
linter/all-rules/numpy/globals.py          1.00    424.7Â±1.59Âµs     6.9 MB/sec    1.00    425.6Â±2.04Âµs     6.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.5Â±0.02ms     3.9 MB/sec    1.01      6.6Â±0.02ms     3.9 MB/sec
linter/default-rules/large/dataset.py      1.00      8.0Â±0.01ms     5.1 MB/sec    1.01      8.1Â±0.02ms     5.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1763.4Â±2.99Âµs     9.4 MB/sec    1.00   1767.9Â±4.27Âµs     9.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    182.7Â±0.29Âµs    16.1 MB/sec    1.02    185.7Â±1.14Âµs    15.9 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.6Â±0.01ms     7.0 MB/sec    1.02      3.7Â±0.01ms     6.9 MB/sec
parser/large/dataset.py                    1.02      6.4Â±0.00ms     6.3 MB/sec    1.00      6.3Â±0.00ms     6.4 MB/sec
parser/numpy/ctypeslib.py                  1.00   1259.0Â±2.33Âµs    13.2 MB/sec    1.00   1258.6Â±1.59Âµs    13.2 MB/sec
parser/numpy/globals.py                    1.00    124.9Â±1.09Âµs    23.6 MB/sec    1.01    126.6Â±0.51Âµs    23.3 MB/sec
parser/pydantic/types.py                   1.00      2.7Â±0.00ms     9.3 MB/sec    1.00      2.7Â±0.00ms     9.3 MB/sec
```

#### Windows
```
group                                      main                                    pr
-----                                      ----                                    --
linter/all-rules/large/dataset.py          1.01     22.0Â±0.56ms  1896.6 KB/sec     1.00     21.7Â±0.67ms  1919.2 KB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      5.6Â±0.18ms     3.0 MB/sec     1.00      5.6Â±0.17ms     3.0 MB/sec
linter/all-rules/numpy/globals.py          1.00   678.4Â±23.49Âµs     4.3 MB/sec     1.00   680.1Â±34.65Âµs     4.3 MB/sec
linter/all-rules/pydantic/types.py         1.00      9.3Â±0.40ms     2.7 MB/sec     1.01      9.3Â±0.54ms     2.7 MB/sec
linter/default-rules/large/dataset.py      1.04     11.3Â±0.57ms     3.6 MB/sec     1.00     10.9Â±0.28ms     3.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00      2.4Â±0.10ms     6.9 MB/sec     1.01      2.4Â±0.14ms     6.8 MB/sec
linter/default-rules/numpy/globals.py      1.00   294.0Â±19.95Âµs    10.0 MB/sec     1.00   292.7Â±18.53Âµs    10.1 MB/sec
linter/default-rules/pydantic/types.py     1.02      5.2Â±0.29ms     4.9 MB/sec     1.00      5.1Â±0.28ms     5.0 MB/sec
parser/large/dataset.py                    1.01      8.9Â±0.20ms     4.6 MB/sec     1.00      8.8Â±0.25ms     4.6 MB/sec
parser/numpy/ctypeslib.py                  1.03  1744.6Â±174.00Âµs     9.5 MB/sec    1.00  1687.4Â±52.22Âµs     9.9 MB/sec
parser/numpy/globals.py                    1.00   179.2Â±14.87Âµs    16.5 MB/sec     1.00    178.7Â±7.16Âµs    16.5 MB/sec
parser/pydantic/types.py                   1.00      3.8Â±0.16ms     6.6 MB/sec     1.01      3.9Â±0.52ms     6.6 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_@charliermarsh approved on 2023-04-26 16:44_

---

_Merged by @MichaReiser on 2023-04-26 21:01_

---

_Closed by @MichaReiser on 2023-04-26 21:01_

---

_Branch deleted on 2023-04-26 21:01_

---
