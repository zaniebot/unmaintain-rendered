<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add new `hover` mdtest assertion - astral-sh/ruff #20786</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add new <code>hover</code> mdtest assertion</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20786">#20786</a>
        opened by <a href="https://github.com/dcreager">@dcreager</a>
        on 2025-10-09 12:24
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a></div>
            <div class="timeline-body"><p>This PR adds a new <code>hover</code> mdtest assertion. This exercises the same logic as the hover LSP action. It's useful for when <code>reveal_type</code> would display a different infered type. (<code>reveal_type</code> is not transparent to bidirectional typing, so inserting a <code>reveal_type</code> call can sometimes <em>change</em> the type that we infer for an expression!)</p>
<p>I used Claude to help write large parts of this, but I have reviewed each step and the resulting diff in detail.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dcreager on 2025-10-09 12:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dcreager on 2025-10-09 12:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @dcreager on 2025-10-09 12:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @dcreager on 2025-10-09 12:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dcreager on 2025-10-09 12:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @dcreager on 2025-10-09 12:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-09 12:26</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ‚úÖ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-09 12:27</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ‚úÖ
No memory usage changes detected ‚úÖ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-09 12:38</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>‚úÖ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>‚úÖ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/hover.md</code>:86 on 2025-10-09 12:39</div>
            <div class="timeline-body"><p>This example confuses me somewhat, because the introduction to this mdtest suite states that</p>
<blockquote>
<p>You can use the <code>hover</code> assertion to test the infered type of an expression</p>
</blockquote>
<p>But <code>dict[str, int]</code> is <em>not</em> the inferred type of <code>{}</code> here. The inferred type of <code>{}</code> here <em>is</em> <code>dict[Unknown, Unknown]</code> (the answer <code>reveal_type</code> gave), but we allow <code>{}</code> to be passed into the <code>x</code> parameter of <code>f</code> because <code>dict[Unknown, Unknown]</code> is assignable to <code>dict[str, int]</code>, the annotation for the <code>x</code> parameter.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/hover.md</code>:26 on 2025-10-09 12:42</div>
            <div class="timeline-body"><p>nit: I feel like the <code>‚Üì</code> makes it a little hard to write hover assertions in mdtest, because I'd end up having to copy and paste it every time or open up a Unicode pallette üòÑ is there an ASCII character we could use instead? One of <code>+</code>, <code>!</code> or <code>|</code> might work?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-09 12:43</div>
            <div class="timeline-body"><p>Interesting! I haven't reviewed the new <code>ty_test</code> code thoroughly yet, but would you be able to give some more examples of where the current behaviour of <code>reveal_type</code> is problematic?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-10-09 13:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/resources/mdtest/hover.md</code>:26 on 2025-10-09 13:07</div>
            <div class="timeline-body"><p>It is the year 2025, Alex. Let us have some nice things.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/resources/mdtest/hover.md</code>:86 on 2025-10-09 13:46</div>
            <div class="timeline-body"><p>As of https://github.com/astral-sh/ruff/pull/20635, we're doing bidirectional type checking for call arguments, and using the parameter annotation as the type context. And as of https://github.com/astral-sh/ruff/pull/20523, we're using the type context to infer a more precise type for dictionary literals. So <code>dict[str, int]</code> really is the infered type of <code>{}</code> here, when it's passed directly in as the argument. But when passing it to <code>reveal_type</code>, the parameter annotation is just <code>_T</code>, and so we don't have the more precise type context.</p>
<p>That might suggest that we want to propagate the type context through these kinds of inner calls (not just for <code>reveal_type</code>), but even then, with bidi checking it's now the case that we can have different infered types for the same expression depending on how its used, and it's useful to have an assertion that cannot influence that type context in any way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/resources/mdtest/hover.md</code>:26 on 2025-10-09 13:48</div>
            <div class="timeline-body"><p>Yeah I had worried about that part. I went with the down arrow partly because I agree with David's half-snark, and partly because I thought that it was more important to optimize here for readability than writability, and the down arrow is visually much clearer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-10-09 13:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-09 14:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/hover.md</code>:26 on 2025-10-09 14:01</div>
            <div class="timeline-body"><blockquote>
<p>more important to optimize here for readability than writability</p>
</blockquote>
<p>Hmmm, I'm not sure I agree. <em>One</em> of the best things about mdtest is how readable it makes our tests, but another of the best things about mdtest is how low-friction it is to write new tests. It's so easy to add new assertions to an existing mdtest suite; it doesn't come with nearly as much boilerplate as writing all our unit tests in Rust or even Python would. And I think that's resulted in us writing lots and lots of assertions, and having a very robustly tested type checker -- great things happen when you make it easy to write tests!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-09 14:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/hover.md</code>:86 on 2025-10-09 14:18</div>
            <div class="timeline-body"><blockquote>
<p>That might suggest that we want to propagate the type context through these kinds of inner calls (not just for <code>reveal_type</code>)</p>
</blockquote>
<p>That sounds like it might make sense to me... It seems quite counterintuitive to me that hovering over the first <code>[&quot;&quot;]</code> in the playground for this example gives a different type than hovering over the second <code>[&quot;&quot;]</code>:</p>
<pre><code class="language-py">from typing import reveal_type

def needs_list_of_strings(x: list[str | None]): ...

def identity[T](x: T) -&gt; T:
    return x

needs_list_of_strings([&quot;&quot;])
needs_list_of_strings(identity([&quot;&quot;]))
</code></pre>
<p>https://play.ty.dev/53299738-b406-4e46-ba40-c0240225f0ae</p>
<blockquote>
<p>with bidi checking it's now the case that we can have different infered types for the same expression depending on how its used, and it's useful to have an assertion that cannot influence that type context in any way</p>
</blockquote>
<p>Fair enough! The additional code in <code>ty_test</code> to make it work also isn't <em>free</em>, though -- there's a maintenance burden there, and a small cognitive burden (I now have to think about whether a <code>reveal_type</code> assertion or a <code>hover</code> assertion will be more appropriate when I'm writing my tests!). I still feel like I'd be interested in a few more examples of where the current <code>reveal_type</code> behaviour is causing issues for your generics work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/resources/mdtest/hover.md</code>:26 on 2025-10-09 14:24</div>
            <div class="timeline-body"><p>I still prefer the down arrow over an ASCII character for this. It is much clearer in intent, and even if you have to fall back on copy/paste, I don't feel like that would be as much of a deterrent to writing these assertions as you suggest. (I completely agree with your argument when talking about mdtest existing in the first place ‚Äî the marginal ease of writing these over the previous Rust tests is <em>huge</em>! But I don't think that argument applies with the same force when considering something like this.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-10-09 14:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-09 14:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/hover.md</code>:86 on 2025-10-09 14:33</div>
            <div class="timeline-body"><blockquote>
<p>As of #20635, we're doing bidirectional type checking for call arguments, and using the parameter annotation as the type context. And as of #20523, we're using the type context to infer a more precise type for dictionary literals. So <code>dict[str, int]</code> really is the infered type of <code>{}</code> here, when it's passed directly in as the argument. But when passing it to <code>reveal_type</code>, the parameter annotation is just <code>_T</code>, and so we don't have the more precise type context.</p>
</blockquote>
<p>Thanks BTW -- I hadn't fully internalised that this was the consequence of those changes! Makes sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-09 14:44</div>
            <div class="timeline-body"><blockquote>
<p>That might suggest that we want to propagate the type context through these kinds of inner calls (not just for reveal_type)</p>
</blockquote>
<p>Yes, this sounds like something that we're going to want/need anyway</p>
<blockquote>
<p>but even then, with bidi checking it's now the case that we can have different infered types for the same expression depending on how its used, and it's useful to have an assertion that cannot influence that type context in any way.</p>
</blockquote>
<p>‚Ä¶ but assuming that we <em>would</em> already propagate the type context through a <code>reveal_type</code> call (which acts like an identity function), we could also solve this use case with <code>reveal_type</code>, right? Then there would be no need for hover-assertions anymore? You could then do:</p>
<pre><code class="language-py">x: list[Literal[1]] = reveal_type([1, 1])  # revealed: list[Literal[1]]
y: list[int] = reveal_type([1, 1])  # revealed: list[int]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-10-09 17:07</div>
            <div class="timeline-body"><blockquote>
<p>assuming that we <em>would</em> already propagate the type context through a <code>reveal_type</code> call (which acts like an identity function), we could also solve this use case with <code>reveal_type</code>, right? Then there would be no need for hover-assertions anymore? You could then do:</p>
</blockquote>
<p>Yes, but... :joy:</p>
<p>The particular example I want to write a (hover) test for is this:</p>
<pre><code class="language-py">def f[T](x: dict[str, T]) -&gt; None: ...

# TODO: should be dict[str, Unknown]
# ‚Üì hover: dict[str, T@f]
f({})
</code></pre>
<p>In a perfect world, I should be able to do this:</p>
<pre><code class="language-py"># TODO: should be dict[str, Unknown]
# revealed: dict[str, T@f]
f(reveal_type({}))
</code></pre>
<p>But this example is more complex than the annotated assignments you mention. We don't just need to propagate the type context through from the outer call to the inner call; we also need to solve the specialization inference for both calls simultaneously (<code>T@f</code> and <code>_T@reveal_type</code>). (Or maybe allow that the inner one can refer to typevars of the outer one?)</p>
<p>I agree that we need to make that work ‚Äî but it also seemed worth having an escape hatch that lets us test these expressions without relying on all of that machinery working correctly.</p>
<p>Maybe the escape hatch is to write that test over in <code>ty_ide</code>, where we already have hover tests that use <code>&lt;CURSOR&gt;</code> to indicate where the hover is triggered? But that also seemed less than ideal, since the test wouldn't really be exercising the LSP action; it's a test of our type inference behavior, which seems to properly belong in a <code>ty_python_semantic</code> mdtest.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-10-09 17:09</div>
            <div class="timeline-body"><blockquote>
<p>Maybe the escape hatch is to write that test over in <code>ty_ide</code></p>
</blockquote>
<p>Or alternatively, maybe the escape hatch is just to hover in the playground and write in the PR description that I did that</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-09 17:21</div>
            <div class="timeline-body"><p>I am certainly not opposed to this approach here, but it <em>does</em> feel like a rather large addition (judging from the line diff alone) for a seemingly small use case.</p>
<blockquote>
<p>over in <code>ty_ide</code>, where we already have hover tests that use <code>&lt;CURSOR&gt;</code> to indicate where the hover is triggered</p>
</blockquote>
<p>Maybe there is actually interest in porting those tests to your framework here? That would certainly be a strong argument in favor.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-09 17:32</div>
            <div class="timeline-body"><blockquote>
<p>I am certainly not opposed to this approach here, but it does feel like a rather large addition (judging from the line diff alone) for a seemingly small use case.</p>
</blockquote>
<p>(I'm also a little surprised that mypy, for example, has never needed this feature in its test suite. Mypy has a test framework that's pretty darn similar to mdtest, and a test suite that's much bigger than ours, but it still just uses <code>reveal_type</code> nearly everywhere)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/resources/mdtest/hover.md</code>:1 on 2025-10-10 06:31</div>
            <div class="timeline-body"><p>Should these tests be in <code>ty_ide</code>? I'd find it confusing that a change in <code>ty_ide</code> can break a test in <code>ty_python_semantic</code>. It would probably take me a while to realize that a test in <code>ty_python_semantic</code> isn't failing because of a change in <code>ty_python_semantic</code> (which would be the first place where I go look), but because of a change in <code>ty_ide</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/resources/mdtest/hover.md</code>:29 on 2025-10-10 06:36</div>
            <div class="timeline-body"><p>I don't have a good suggestion as an alternative, but a downside of the <code>arrow</code> is that I'd always have to copy paste it from somewhere because I don't know how to type it on a keyboard.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-10 06:36</div>
            <div class="timeline-body"><p>Having the ability to write hover tests in mdtests is nice. However, it adds a bit of confusion: Am I supposed to write a mdtest-hover test or a ty_ide hover test when making changes to hover and why? Do we need both?</p>
<blockquote>
<p>Maybe there is actually interest in porting those tests to your framework here? That would certainly be a strong argument in favor.</p>
</blockquote>
<p>Having the ability to write them in mdtests would certainly be nice. However, they often test for more than just the type (e.g. doc comments). This makes it difficult to replace them entirely unless we support snapshotting the entire hover but that doesn't seem that urgent right now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/resources/mdtest/hover.md</code>:29 on 2025-10-10 06:47</div>
            <div class="timeline-body"><p>see https://github.com/astral-sh/ruff/pull/20786#discussion_r2416666750 :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-10-10 06:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-10 06:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/resources/mdtest/hover.md</code>:26 on 2025-10-10 06:57</div>
            <div class="timeline-body"><blockquote>
<p>It is the year 2025, Alex. Let us have some nice things.</p>
</blockquote>
<p>Shouldn't it be an emoji then? ‚¨áÔ∏è</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2026-01-05 13:32</div>
            <div class="timeline-body"><p>Woah I completely missed this PR! I have occasionally briefly pined for this but I think ultimately mdtests end up being the wrong format for hover tests, which want to be much more (inline-)snapshoty (all of this is &quot;ui&quot; and so you want to see any changes to &quot;ui&quot;). The ty_ide tests are getting really unwieldy because from sheer volume of tests shoved in one file, but I think the solution there is just to split off a <code>tests/</code> dir with dirs and files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-05 13:36</div>
            <div class="timeline-body"><blockquote>
<p>The ty_ide tests are getting really unwieldy because from sheer volume of tests shoved in one file, but I think the solution there is just to split off a tests/ dir with dirs and files.</p>
</blockquote>
<p>Agree, we could even have fixtures discovered similar to what we do in the formatter's cursor tests instead of having to write normal rust tests</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:16:19 UTC
    </footer>
</body>
</html>
