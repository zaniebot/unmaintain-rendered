<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>implement flake8_async ASYNC102 await in finally or cancelled - astral-sh/ruff #14370</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>implement flake8_async ASYNC102 await in finally or cancelled</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14370">#14370</a>
        opened by <a href="https://github.com/altendky">@altendky</a>
        on 2024-11-15 21:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/altendky">@altendky</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>When working with async cleanup activities it is important to be aware of shielding the cleanup from cancellation.</p>
<p>https://anyio.readthedocs.io/en/stable/cancellation.html#shielding</p>
<p>This rule looks for unshielded awaits in relevant cleanup paths such as exception handling and finally blocks.  It walks the AST looking for awaits but prunes when it finds shielding context managers.</p>
<!-- What's the purpose of the change? What does it do, and why? -->

<h2>Test Plan</h2>
<!-- How was it tested? -->

<h2>Draft For:</h2>
<ul>
<li>[ ] review <code>TODO</code>s</li>
<li>[x] consider if this is the ruff implementation of https://flake8-async.readthedocs.io/en/latest/rules.html#async102 (at a glance the answer seems to be yes)</li>
<li>[x] explicitly test async for and async with</li>
<li>[ ] review <code># noqa: ASYNC102 - fixthis</code> which are mostly around direct assignment to the <code>.shield</code> attribute</li>
<li>[x] revisit linter message, it's just <code>shield it!</code> right now</li>
<li>[x] don't trigger on <code>anyio</code> and <code>trio.aclose_forcefully()</code></li>
<li>[x] review all panics and either implement or handle by having no output</li>
<li>[x] handle <code>.__aexit__()</code></li>
<li>[x] require a ~timeout~ deadline</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-15 22:35</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "very preliminary unshielded await rule" to "somewhat preliminary unshielded await rule" by @altendky on 2024-11-18 15:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "somewhat preliminary unshielded await rule" to "somewhat preliminary unshielded async rule" by @altendky on 2024-11-18 15:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "somewhat preliminary unshielded async rule" to "implement flake8_async ASYNC102 await in finally or cancelled" by @altendky on 2024-11-18 18:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @dhruvmanila on 2025-01-20 15:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @dhruvmanila on 2025-01-20 15:02</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:07:45 UTC
    </footer>
</body>
</html>
