<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add test and basic implementation for formatter preview mode - astral-sh/ruff #8044</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add test and basic implementation for formatter preview mode</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/8044">#8044</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2023-10-18 11:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><p><strong>Summary</strong> Prepare for the black preview style becoming the black stable style at the end of the year.</p>
<p>This adds a new test file to compare stable and preview on some relevant preview options in black, and makes <code>format_dev</code> understand the black preview flag. I&#x27;ve added poetry as a project that uses preview.</p>
<p>I&#x27;ve implemented one specific deviation (collapsing of stub implementation in non-stub files) which showed up in poetry for testing. This also improves poetry compatibility from 0.99891 to 0.99919.</p>
<p>Fixes #7440</p>
<p>New compatibility stats:
| project        | similarity index  | total files       | changed files     |
|----------------|------------------:|------------------:|------------------:|
| cpython        |           0.75803 |              1799 |              1647 |
| django         |           0.99983 |              2772 |                35 |
| home-assistant |           0.99953 |             10596 |               189 |
| poetry         |           0.99919 |               317 |                12 |
| transformers   |           0.99963 |              2657 |               332 |
| twine          |           1.00000 |                33 |                 0 |
| typeshed       |           0.99978 |              3669 |                20 |
| warehouse      |           0.99969 |               654 |                15 |
| zulip          |           0.99970 |              1459 |                22 |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/konstin">@konstin</a> on 2023-10-18 11:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-10-18 12:13</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>âœ… ecosystem check detected no changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/tests/snapshots/format@preview.py.snap</code>:3 on 2023-10-18 13:54</div>
            <div class="timeline-body"><p>Should we instead run every test under preview and non-preview?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-10-18 13:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-10-18 15:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_python_formatter/tests/snapshots/format@preview.py.snap</code>:3 on 2023-10-18 15:11</div>
            <div class="timeline-body"><p>If the cost is not too high that seems ideal</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-10-18 16:59</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #8049</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8049"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a><ul>
<li><strong>PR #8044</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8044"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8044?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-10-18 17:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/tests/snapshots/format@preview.py.snap</code>:3 on 2023-10-18 17:00</div>
            <div class="timeline-body"><p><code>hyperfine &quot;cargo test -p ruff_python_formatter&quot;</code> goes from 500ms to 580ms on my machine, acceptable for me.</p>
<p>Having both versions makes it hard to see what actually changed given our large snapshots, so i opted for instead adding the diff as separate code block if there is one. I also changed all non-function/class tests to use <code>pass</code> instead as real code generally does, which i split out to #8049 to keep the diff readable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-10-18 17:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/tests/snapshots/format@preview.py.snap</code>:3 on 2023-10-18 17:02</div>
            <div class="timeline-body"><p>I would like to keep <code>preview.py</code> as-is though, it&#x27;s a useful tool for tracking progress and comparing to black (i can diff both snapshots with what the black playground does)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/fixtures.rs</code>:150 on 2023-10-18 23:08</div>
            <div class="timeline-body"><p>Should we skip this if <code>options.preview == Enabled</code> when using a test specific options file?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/snapshots/format@statement__function.py.snap</code>:999 on 2023-10-18 23:10</div>
            <div class="timeline-body"><p>I wonder how noisy this gets once we start having many preview style rules. But let&#x27;s see how it goes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-10-18 23:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-10-19 09:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/tests/fixtures.rs</code>:150 on 2023-10-19 09:10</div>
            <div class="timeline-body"><p>This is the no-options-file branch; i think it&#x27;s better to not mix them to avoid combinatorial explosion</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/zanieb">@zanieb</a> by <a href="https://github.com/konstin">@konstin</a> on 2023-10-19 09:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/konstin">@konstin</a> on 2023-10-19 09:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-25 19:09</div>
            <div class="timeline-body"><p>@konstin - Is this good to merge?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-10-26 15:23</div>
            <div class="timeline-body"><p>yep</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/konstin">@konstin</a> on 2023-10-26 15:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/konstin">@konstin</a> on 2023-10-26 15:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-10-26 15:33</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:58:28 UTC
    </footer>
</body>
</html>
