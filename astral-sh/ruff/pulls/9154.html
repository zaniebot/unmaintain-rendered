<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Implement `no_blank_line_before_class_docstring` preview style - astral-sh/ruff #9154</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Implement <code>no_blank_line_before_class_docstring</code> preview style</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/9154">#9154</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2023-12-16 01:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body">Summary
<p>This PR implements the <code>no_blank_line_before_class_docstring</code> preview style.</p>
Test Plan
<p>Update existing snapshots.</p>
Formatter ecosystem
<p><code>main</code></p>
<p>| project        | similarity index  | total files       | changed files     |
|----------------|------------------:|------------------:|------------------:|
| cpython        |           0.75804 |              1799 |              1648 |
| django         |           0.99984 |              2772 |                34 |
| home-assistant |           0.99955 |             10596 |               213 |
| poetry         |           0.99905 |               321 |                15 |
| transformers   |           0.99967 |              2657 |               324 |
| twine          |           1.00000 |                33 |                 0 |
| typeshed       |           0.99980 |              3669 |                18 |
| warehouse      |           0.99976 |               654 |                14 |
| zulip          |           0.99958 |              1459 |                36 |</p>
<p><code>dhruv/no-blank-line-docstring</code></p>
<p>| project        | similarity index  | total files       | changed files     |
|----------------|------------------:|------------------:|------------------:|
| cpython        |           0.75804 |              1799 |              1648 |
| django         |           0.99984 |              2772 |                34 |
| home-assistant |           0.99955 |             10596 |               213 |
| poetry         |           0.99905 |               321 |                15 |
| transformers   |           0.99967 |              2657 |               324 |
| twine          |           1.00000 |                33 |                 0 |
| typeshed       |           0.99980 |              3669 |                18 |
| warehouse      |           0.99976 |               654 |                14 |
| zulip          |           0.99958 |              1459 |                36 |</p>
<p>fixes: #8888</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-12-16 01:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-12-16 01:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-12-16 01:12</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 0 project errors)</p>
<a href="https://github.com/demisto/content">demisto/content</a> (+0 -2 lines across 2 files)
<p>
<pre>ruff format --preview --exclude Packs/ThreatQ/Integrations/ThreatQ/ThreatQ.py</pre>
</p>
<p>

<p><a href="https://github.com/demisto/content/blob/10bf8d88360442939c6aa2d5491d74fe2dc5a087/Packs/Automox/Integrations/Automox/Automox.py#L42">Packs/Automox/Integrations/Automox/Automox.py~L42</a></p>
<pre><code> 
 
 class Client(BaseClient):
-
     &quot;&quot;&quot;Client class to interact with the service API
 
     This Client implements API calls, and does not contain any XSOAR logic.
</code></pre>
<p><a href="https://github.com/demisto/content/blob/10bf8d88360442939c6aa2d5491d74fe2dc5a087/Packs/MS-ISAC/Integrations/MSISAC/MSISAC.py#L13">Packs/MS-ISAC/Integrations/MSISAC/MSISAC.py~L13</a></p>
<pre><code> 
 
 class Client(BaseClient):
-
     &quot;&quot;&quot;
     This client class for MS-ISAC definies two API endpoints
     Query events in a set amount of days /albert/{days}
</code></pre>
</p>

<a href="https://github.com/freedomofpress/securedrop">freedomofpress/securedrop</a> (+0 -13 lines across 8 files)
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<p><a href="https://github.com/freedomofpress/securedrop/blob/531d08696a145b26dd918abbbc68b19d4ce505c0/securedrop/models.py#L336">securedrop/models.py~L336</a></p>
<pre><code> 
 
 class InvalidUsernameException(Exception):
-
     &quot;&quot;&quot;Raised when a user logs in with an invalid username&quot;&quot;&quot;
 
 
</code></pre>
<p><a href="https://github.com/freedomofpress/securedrop/blob/531d08696a145b26dd918abbbc68b19d4ce505c0/securedrop/models.py#L355">securedrop/models.py~L355</a></p>
<pre><code> 
 
 class LoginThrottledException(Exception):
-
     &quot;&quot;&quot;Raised when a user attempts to log in
     too many times in a given time period&quot;&quot;&quot;
 
 
 class WrongPasswordException(Exception):
-
     &quot;&quot;&quot;Raised when a user logs in with an incorrect password&quot;&quot;&quot;
 
 
 class PasswordError(Exception):
-
     &quot;&quot;&quot;Generic error for passwords that are invalid.&quot;&quot;&quot;
 
 
</code></pre>
<p><a href="https://github.com/freedomofpress/securedrop/blob/531d08696a145b26dd918abbbc68b19d4ce505c0/securedrop/models.py#L387">securedrop/models.py~L387</a></p>
<pre><code> 
 
 class NonDicewarePassword(PasswordError):
-
     &quot;&quot;&quot;Raised when attempting to validate a password that is not diceware-like&quot;&quot;&quot;
 
 
</code></pre>
<p><a href="https://github.com/freedomofpress/securedrop/blob/531d08696a145b26dd918abbbc68b19d4ce505c0/securedrop/models.py#L840">securedrop/models.py~L840</a></p>
<pre><code> 
 
 class JournalistLoginAttempt(db.Model):
-
     &quot;&quot;&quot;This model keeps track of journalist&#x27;s login attempts so we can
     rate limit them in order to prevent attackers from brute forcing
     passwords or two-factor tokens.&quot;&quot;&quot;
</code></pre>
<p><a href="https://github.com/freedomofpress/securedrop/blob/531d08696a145b26dd918abbbc68b19d4ce505c0/securedrop/tests/migrations/migration_15ac9509fc68.py#L18">securedrop/tests/migrations/migration_15ac9509fc68.py~L18</a></p>
<pre><code> 
 
 class UpgradeTester:
-
     &quot;&quot;&quot;This migration has no upgrade because there are no tables in the
     database prior to running, so there is no data to load or test.
     &quot;&quot;&quot;
</code></pre>
<p><a href="https://github.com/freedomofpress/securedrop/blob/531d08696a145b26dd918abbbc68b19d4ce505c0/securedrop/tests/migrations/migration_3d91d6948753.py#L12">securedrop/tests/migrations/migration_3d91d6948753.py~L12</a></p>
<pre><code> 
 
 class UpgradeTester:
-
     &quot;&quot;&quot;This migration verifies that the UUID column now exists, and that
     the data migration completed successfully.
     &quot;&quot;&quot;
</code></pre>
<p><a href="https://github.com/freedomofpress/securedrop/blob/531d08696a145b26dd918abbbc68b19d4ce505c0/securedrop/tests/migrations/migration_60f41bb14d98.py#L21">securedrop/tests/migrations/migration_60f41bb14d98.py~L21</a></p>
<pre><code> 
 
 class UpgradeTester:
-
     &quot;&quot;&quot;This migration verifies that the session_nonce column now exists, and
     that the data migration completed successfully.
     &quot;&quot;&quot;
</code></pre>
<p><a href="https://github.com/freedomofpress/securedrop/blob/531d08696a145b26dd918abbbc68b19d4ce505c0/securedrop/tests/migrations/migration_6db892e17271.py#L77">securedrop/tests/migrations/migration_6db892e17271.py~L77</a></p>
<pre><code> 
 
 class UpgradeTester:
-
     &quot;&quot;&quot;This migration verifies that the deleted_by_source column now exists,
     and that the data migration completed successfully.
     &quot;&quot;&quot;
</code></pre>
<p><a href="https://github.com/freedomofpress/securedrop/blob/531d08696a145b26dd918abbbc68b19d4ce505c0/securedrop/tests/migrations/migration_e0a525cbab83.py#L77">securedrop/tests/migrations/migration_e0a525cbab83.py~L77</a></p>
<pre><code> 
 
 class UpgradeTester:
-
     &quot;&quot;&quot;This migration verifies that the deleted_by_source column now exists,
     and that the data migration completed successfully.
     &quot;&quot;&quot;
</code></pre>
<p><a href="https://github.com/freedomofpress/securedrop/blob/531d08696a145b26dd918abbbc68b19d4ce505c0/securedrop/tests/migrations/migration_f2833ac34bb6.py#L20">securedrop/tests/migrations/migration_f2833ac34bb6.py~L20</a></p>
<pre><code> 
 
 class UpgradeTester:
-
     &quot;&quot;&quot;This migration verifies that the UUID column now exists, and that
     the data migration completed successfully.
     &quot;&quot;&quot;
</code></pre>
<p><a href="https://github.com/freedomofpress/securedrop/blob/531d08696a145b26dd918abbbc68b19d4ce505c0/securedrop/tests/migrations/migration_fccf57ceef02.py#L32">securedrop/tests/migrations/migration_fccf57ceef02.py~L32</a></p>
<pre><code> 
 
 class UpgradeTester:
-
     &quot;&quot;&quot;This migration verifies that the UUID column now exists, and that
     the data migration completed successfully.
     &quot;&quot;&quot;
</code></pre>
</p>

<a href="https://github.com/mlflow/mlflow">mlflow/mlflow</a> (+0 -2 lines across 2 files)
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<p><a href="https://github.com/mlflow/mlflow/blob/366c7211ebb66f1a23f37abae19f410b37dd0dae/mlflow/langchain/retriever_chain.py#L17">mlflow/langchain/retriever_chain.py~L17</a></p>
<pre><code> 
 @experimental
 class _RetrieverChain(Chain):
-
     &quot;&quot;&quot;
     Chain that wraps a retriever for use with MLflow.
 
</code></pre>
<p><a href="https://github.com/mlflow/mlflow/blob/366c7211ebb66f1a23f37abae19f410b37dd0dae/tests/sagemaker/mock/__init__.py#L707">tests/sagemaker/mock/<strong>init</strong>.py~L707</a></p>
<pre><code> 
 
 class TransformJob(TimestampedResource):
-
     &quot;&quot;&quot;
     Object representing a SageMaker transform job. The SageMakerBackend will create
     and manage transform jobs.
</code></pre>
</p>

<a href="https://github.com/pypa/pip">pypa/pip</a> (+0 -2 lines across 2 files)
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<p><a href="https://github.com/pypa/pip/blob/50e3c500bd2b27dd72317cfd5ff5bb498540e416/src/pip/_internal/index/collector.py#L395">src/pip/_internal/index/collector.py~L395</a></p>
<pre><code> 
 
 class LinkCollector:
-
     &quot;&quot;&quot;
     Responsible for collecting Link objects from all configured locations,
     making network requests as needed.
</code></pre>
<p><a href="https://github.com/pypa/pip/blob/50e3c500bd2b27dd72317cfd5ff5bb498540e416/src/pip/_internal/utils/logging.py#L212">src/pip/_internal/utils/logging.py~L212</a></p>
<pre><code> 
 
 class ExcludeLoggerFilter(Filter):
-
     &quot;&quot;&quot;
     A logging Filter that excludes records from a logger (or its children).
     &quot;&quot;&quot;
</code></pre>
</p>

<a href="https://github.com/pypa/setuptools">pypa/setuptools</a> (+0 -2 lines across 1 file)
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<p><a href="https://github.com/pypa/setuptools/blob/e92440ad6210b21f3ede64d7eb69dead94b37d3a/setuptools/_distutils/version.py#L111">setuptools/_distutils/version.py~L111</a></p>
<pre><code> 
 
 class StrictVersion(Version):
-
     &quot;&quot;&quot;Version numbering for anal retentives and software idealists.
     Implements the standard interface for version number classes as
     described above.  A version number consists of two or three
</code></pre>
<p><a href="https://github.com/pypa/setuptools/blob/e92440ad6210b21f3ede64d7eb69dead94b37d3a/setuptools/_distutils/version.py#L286">setuptools/_distutils/version.py~L286</a></p>
<pre><code> 
 
 class LooseVersion(Version):
-
     &quot;&quot;&quot;Version numbering for anarchists and software realists.
     Implements the standard interface for version number classes as
     described above.  A version number consists of a series of numbers,
</code></pre>
</p>

<a href="https://github.com/python/mypy">python/mypy</a> (+0 -2 lines across 1 file)
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<p><a href="https://github.com/python/mypy/blob/1dd8e7fe654991b01bd80ef7f1f675d9e3910c3a/mypy/main.py#L342">mypy/main.py~L342</a></p>
<pre><code> 
 
 class CapturableArgumentParser(argparse.ArgumentParser):
-
     &quot;&quot;&quot;Override ArgumentParser methods that use sys.stdout/sys.stderr directly.
 
     This is needed because hijacking sys.std* is not thread-safe,
</code></pre>
<p><a href="https://github.com/python/mypy/blob/1dd8e7fe654991b01bd80ef7f1f675d9e3910c3a/mypy/main.py#L396">mypy/main.py~L396</a></p>
<pre><code> 
 
 class CapturableVersionAction(argparse.Action):
-
     &quot;&quot;&quot;Supplement CapturableArgumentParser to handle --version.
 
     This is nearly identical to argparse._VersionAction except,
</code></pre>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/T-256">@T-256</a> on 2023-12-16 02:00</div>
            <div class="timeline-body"><p>It seems ecosystem reported numbers are wrong.
Also, links pointed lines aren&#x27;t exact.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-12-16 02:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-12-16 02:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/snapshots/format@statement__class_definition.py.snap</code>:535 on 2023-12-16 02:28</div>
            <div class="timeline-body"><p>Can we add a few tests where we have comments before the docstring (including new or empty lines)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-12-16 02:30</div>
            <div class="timeline-body"><p>Could you update your pr summary and include the &#x27;old&#x27; compatibility numbers. I don&#x27;t expect them to change but just to be safe</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-16 03:07</div>
            <div class="timeline-body"><p>The ecosystem line numbers are not guaranteed to be exact (hence the tilde). It’s a diff of two changes against HEAD, so mapping that diff back to a line number in HEAD is not trivial. (Not sure about the “number of lines changed” though.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-12-18 08:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-12-19 06:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_formatter/tests/snapshots/format@statement__class_definition.py.snap</code>:535 on 2023-12-19 06:12</div>
            <div class="timeline-body"><p>I&#x27;ve tested it out locally with different combinations of comments, newline and docstrings. It seems that the Black preview style is a bit inconsistent with the stable style.</p>
Original source code:
<p>

<pre><code>class OneBlankLineDocstring:

    &quot;&quot;&quot;This is a docstring.&quot;&quot;&quot;


class DocstringWithComment0:
    # This is a comment
    &quot;&quot;&quot;This is a docstring.&quot;&quot;&quot;


class DocstringWithComment1:
    # This is a comment

    &quot;&quot;&quot;This is a docstring.&quot;&quot;&quot;


class DocstringWithComment2:

    # This is a comment
    &quot;&quot;&quot;This is a docstring.&quot;&quot;&quot;


class DocstringWithComment3:

    # This is a comment

    &quot;&quot;&quot;This is a docstring.&quot;&quot;&quot;


class DocstringWithComment4:


    # This is a comment


    &quot;&quot;&quot;This is a docstring.&quot;&quot;&quot;
</code></pre>
</p>
 

Black stable formatting:
<p>

<pre><code>class NormalDocstring:

    &quot;&quot;&quot;This is a docstring.&quot;&quot;&quot;


class DocstringWithComment0:
    # This is a comment
    &quot;&quot;&quot;This is a docstring.&quot;&quot;&quot;


class DocstringWithComment1:
    # This is a comment

    &quot;&quot;&quot;This is a docstring.&quot;&quot;&quot;


class DocstringWithComment2:
    # This is a comment
    &quot;&quot;&quot;This is a docstring.&quot;&quot;&quot;


class DocstringWithComment3:
    # This is a comment

    &quot;&quot;&quot;This is a docstring.&quot;&quot;&quot;


class DocstringWithComment4:
    # This is a comment

    &quot;&quot;&quot;This is a docstring.&quot;&quot;&quot;
</code></pre>
</p>
 

Black preview formatting:
<p>

<pre><code>class OneBlankLineDocstring:
    &quot;&quot;&quot;This is a docstring.&quot;&quot;&quot;


class DocstringWithComment0:
    # This is a comment
    &quot;&quot;&quot;This is a docstring.&quot;&quot;&quot;


class DocstringWithComment1:
    # This is a comment

    &quot;&quot;&quot;This is a docstring.&quot;&quot;&quot;


class DocstringWithComment2:

    # This is a comment
    &quot;&quot;&quot;This is a docstring.&quot;&quot;&quot;


class DocstringWithComment3:

    # This is a comment

    &quot;&quot;&quot;This is a docstring.&quot;&quot;&quot;


class DocstringWithComment4:

    # This is a comment

    &quot;&quot;&quot;This is a docstring.&quot;&quot;&quot;
</code></pre>
</p>


<p>What I&#x27;m noticing is that the rules change if there&#x27;s a comment in between the class header and docstring in a way that for <code>n1</code> and <code>n2</code> number of blank lines before a comment and docstring respectively the following holds true:</p>
<ol>
<li>If <code>n1</code> / <code>n2</code> is 0, keep it 0</li>
<li>If <code>n1</code> / <code>n2</code> is 1, keep it 1</li>
<li>If <code>n1</code> / <code>n2</code> &gt; 1, then reduce it to 1</li>
</ol>
<p>It&#x27;s probably another preview style which is keeping the newline before the comment (<code>allow_empty_first_line_before_block_or_comment</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-12-19 06:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-12-19 06:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-12-19 06:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-12-19 06:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-12-19 06:43</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:00:00 UTC
    </footer>
</body>
</html>
