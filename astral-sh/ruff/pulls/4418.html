<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix expected-indentation errors with end-of-line comments - astral-sh/ruff #4418</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix expected-indentation errors with end-of-line comments</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4418">#4418</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-05-13 17:17
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>Given code like:</p>
<pre><code>if False:  #
    print()
</code></pre>
<p>The token stream will contain a comment, followed by a newline. At present, we end up creating a separate logical line for <em>just</em> the newline, which throws off our logic around expected-indentation rules, which needs to look back at the previous newline to determine the appropriate indentation.</p>
<p>I&#x27;ve looked at the lexer to better understand the logic around when to expect a newline token (following a comment). My understanding is that there should <em>always</em> be a newline unless the comment appears at the start of a (logical?) line, since the only codepath that consumes but doesn&#x27;t generate a newline is via <code>eat_indentation</code>.</p>
<p>Closes #4417.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-13 17:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/pycodestyle/rules/logical_lines/mod.rs</code>:119 on 2023-05-13 17:23</div>
            <div class="timeline-body"><p>Alternatively, we may be able to get away with checking if this is the first token in the line? In theory that should also work. It&#x27;s arguably more reliant on details of the lexer, but it&#x27;s also making the expectation more explicit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-13 17:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-05-13 18:08</div>
            <div class="timeline-body">PR Check Results
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     13.8±0.05ms     3.0 MB/sec    1.00     13.8±0.06ms     3.0 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.4±0.00ms     4.9 MB/sec    1.00      3.4±0.01ms     5.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    412.3±0.71µs     7.2 MB/sec    1.00    414.2±1.29µs     7.1 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.8±0.03ms     4.4 MB/sec    1.00      5.8±0.02ms     4.4 MB/sec
linter/default-rules/large/dataset.py      1.01      6.7±0.01ms     6.1 MB/sec    1.00      6.7±0.02ms     6.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01   1442.9±6.81µs    11.5 MB/sec    1.00   1432.9±1.87µs    11.6 MB/sec
linter/default-rules/numpy/globals.py      1.00    158.5±0.85µs    18.6 MB/sec    1.00    158.0±0.17µs    18.7 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.0±0.03ms     8.4 MB/sec    1.00      3.0±0.00ms     8.5 MB/sec
parser/large/dataset.py                    1.04      5.7±0.00ms     7.1 MB/sec    1.00      5.5±0.02ms     7.4 MB/sec
parser/numpy/ctypeslib.py                  1.03   1097.9±2.13µs    15.2 MB/sec    1.00   1064.1±0.75µs    15.6 MB/sec
parser/numpy/globals.py                    1.02    109.9±0.10µs    26.8 MB/sec    1.00    108.3±0.65µs    27.3 MB/sec
parser/pydantic/types.py                   1.03      2.4±0.00ms    10.6 MB/sec    1.00      2.3±0.00ms    10.9 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     16.4±0.46ms     2.5 MB/sec    1.25     20.6±0.69ms  2025.6 KB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.3±0.29ms     3.9 MB/sec    1.22      5.2±0.25ms     3.2 MB/sec
linter/all-rules/numpy/globals.py          1.00   486.4±20.42µs     6.1 MB/sec    1.30   634.0±40.27µs     4.7 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.1±0.32ms     3.6 MB/sec    1.23      8.7±0.68ms     2.9 MB/sec
linter/default-rules/large/dataset.py      1.00      8.3±0.32ms     4.9 MB/sec    1.21     10.0±0.45ms     4.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1744.4±92.48µs     9.5 MB/sec    1.21      2.1±0.10ms     7.9 MB/sec
linter/default-rules/numpy/globals.py      1.00   207.3±14.40µs    14.2 MB/sec    1.31   271.2±37.04µs    10.9 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.7±0.14ms     6.9 MB/sec    1.27      4.7±0.30ms     5.4 MB/sec
parser/large/dataset.py                    1.00      6.6±0.21ms     6.1 MB/sec    1.27      8.4±0.23ms     4.8 MB/sec
parser/numpy/ctypeslib.py                  1.00  1313.7±51.98µs    12.7 MB/sec    1.26  1649.0±67.66µs    10.1 MB/sec
parser/numpy/globals.py                    1.00    132.7±6.45µs    22.2 MB/sec    1.26    166.6±9.61µs    17.7 MB/sec
parser/pydantic/types.py                   1.00      2.9±0.09ms     8.9 MB/sec    1.27      3.6±0.15ms     7.1 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-14 17:13</div>
            <div class="timeline-body"><p>I&#x27;m guessing that might be a real performance regression? Although is it comparing against <code>main</code> or <code>charlie/pycodestyle</code>? The latter includes the logical line rules, the former does not. I&#x27;ll have to benchmark manually.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-14 21:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/pycodestyle/rules/logical_lines/mod.rs</code>:119 on 2023-05-14 21:17</div>
            <div class="timeline-body"><p>Should we fix this in the lexer instead? It feels odd that the newline is conditional on the comment placement. I would expect that a comment is always followed by a newline.</p>
<p>Nit. You can match directly on the Tok. Using TokenKind has some overhead that is only worth it when there are many reads.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-14 22:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/pycodestyle/rules/logical_lines/mod.rs</code>:119 on 2023-05-14 22:29</div>
            <div class="timeline-body"><p>Honestly not sure. \cc @youknowone - do you know, if it&#x27;s intentional that we don&#x27;t emit a newline when a comment is at start-of-line?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-14 22:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/pycodestyle/rules/logical_lines/mod.rs</code>:119 on 2023-05-14 22:41</div>
            <div class="timeline-body"><p>It may not actually be a bug, I&#x27;d have to compare to CPython.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-14 22:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/pycodestyle/rules/logical_lines/mod.rs</code>:119 on 2023-05-14 22:45</div>
            <div class="timeline-body"><p>It looks like CPython <em>does</em> emit a non-logical newline, even for entirely empty lines, unlike RustPython.</p>
<p>RustPython also has this test:</p>
<pre><code>#[test]
fn test_logical_newline_line_comment() {
    let source = &quot;#Hello\n#World&quot;;
    let tokens = lex_source(source);
    assert_eq!(
        tokens,
        vec![
            Tok::Comment(&quot;#Hello&quot;.to_owned()),
            // tokenize.py does put an NL here...
            Tok::Comment(&quot;#World&quot;.to_owned()),
            // ... and here, but doesn&#x27;t seem very useful.
        ]
    );
}
</code></pre>
<p>@youknowone - Do you know if this is intentional, or should I fix it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-15 03:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/pycodestyle/rules/logical_lines/mod.rs</code>:119 on 2023-05-15 03:09</div>
            <div class="timeline-body"><p>Put up <a href="https://github.com/RustPython/Parser/pull/27">RustPython/Parser#27</a>. (We&#x27;ll still need code changes here to fix this bug, once that merges.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/pycodestyle/rules/logical_lines/mod.rs</code>:119 on 2023-05-15 06:53</div>
            <div class="timeline-body"><p>Thank you! Makes sense. Is the change to remove the explicit <code>Comment</code> handling and only rely on the presence of <code>Newline</code> and <code>NonLogicalNewline</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-05-15 06:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-05-15 06:53</div>
            <div class="timeline-body"><blockquote>
<p>I&#x27;m guessing that might be a real performance regression? Although is it comparing against <code>main</code> or <code>charlie/pycodestyle</code>? The latter includes the logical line rules, the former does not. I&#x27;ll have to benchmark manually.</p>
</blockquote>
<p>I think it compares against <code>main</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/youknowone">@youknowone</a> on <code>crates/ruff/src/rules/pycodestyle/rules/logical_lines/mod.rs</code>:119 on 2023-05-15 07:25</div>
            <div class="timeline-body"><p>Thank you! I don&#x27;t think RustPython intended to have different behavior to CPython.
I will look in the patch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/youknowone">@youknowone</a> reviewed on 2023-05-15 07:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-15 13:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-15 13:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-05-15 13:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-15 13:22</div>
            <div class="timeline-body"><p>Ugh this got confused.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-15 13:22</div>
            <div class="timeline-body"><p>Because I tried to swap the upstreams between this and <code>charlie/pycodestyle</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-15 13:32</div>
            <div class="timeline-body"><p>Re-opened as #4438.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:53:41 UTC
    </footer>
</body>
</html>
