<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Garbage-collect reachability constraints - astral-sh/ruff #19414</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Garbage-collect reachability constraints</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19414">#19414</a>
        opened by <a href="https://github.com/dcreager">@dcreager</a>
        on 2025-07-17 21:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dcreager">@dcreager</a> on 2025-07-17 21:55</div>
            <div class="timeline-body"><p>This is a follow-on to #19410 that further reduces the memory usage of our reachability constraints. When finishing the building of a use-def map, we walk through all of the &quot;final&quot; states and mark only those reachability constraints as &quot;used&quot;. We then throw away the interior TDD nodes of any reachability constraints that weren't marked as used.</p>
<p>(This helps because we build up quite a few intermediate TDD nodes when constructing complex reachability constraints. These nodes can never be accessed if they were <em>only</em> used as an intermediate TDD node. The marking step ensures that we keep any nodes that ended up being referred to in some accessible use-def map state.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dcreager on 2025-07-17 21:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dcreager on 2025-07-17 21:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @dcreager on 2025-07-17 21:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @dcreager on 2025-07-17 21:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @dcreager on 2025-07-17 21:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @dcreager on 2025-07-17 21:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @dcreager on 2025-07-17 21:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @dcreager on 2025-07-17 21:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dcreager on 2025-07-17 21:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-07-17 22:10</div>
            <div class="timeline-body"><p>Looks like we are somehow failing to mark some nodes as used that we later try to query?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @carljm on 2025-07-17 22:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-07-17 22:20</div>
            <div class="timeline-body"><blockquote>
<p>Looks like we are somehow failing to mark some nodes as used that we later try to query?</p>
</blockquote>
<p>blerp blorp. Glad I added that assertion!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-17 22:25</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅</p>
<details>
<summary>Memory usage changes were detected when running on open source projects</summary>

<pre><code class="language-diff">trio (https://github.com/python-trio/trio)
- TOTAL MEMORY USAGE: ~176MB
+ TOTAL MEMORY USAGE: ~167MB
-     memo fields = ~138MB
+     memo fields = ~131MB

sphinx (https://github.com/sphinx-doc/sphinx)
- TOTAL MEMORY USAGE: ~301MB
+ TOTAL MEMORY USAGE: ~287MB
-     memo fields = ~236MB
+     memo fields = ~224MB

prefect (https://github.com/PrefectHQ/prefect)
- TOTAL MEMORY USAGE: ~626MB
+ TOTAL MEMORY USAGE: ~596MB
-     memo fields = ~490MB
+     memo fields = ~467MB

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-07-17 23:24</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_WALLTIME_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/dcreager%2Fsmoosh-reachability?runnerMode=WallTime">CodSpeed WallTime Performance Report</a></h2>
<h3>Merging #19414 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>dcreager/smoosh-reachability</code> (848c573) with <code>main</code> (dc66019)</sub></p>
<h3>Summary</h3>
<p><code>✅ 7</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-17 23:25</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<details><summary><a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)</summary>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to parse examples/mcp/databricks_mcp_cookbook.ipynb:12:1:8: Simple statements must be separated by newlines or semicolons
</code></pre>
</p>
</details>

<h3>Formatter (preview)</h3>
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<details><summary><a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)</summary>
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to parse examples/mcp/databricks_mcp_cookbook.ipynb:12:1:8: Simple statements must be separated by newlines or semicolons
</code></pre>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-07-18 14:31</div>
            <div class="timeline-body"><p>I've fixed all of the test failures here and tweaked how we keep track of the mapping between indexes in the pre-filtered and post-filtered vectors here.  The ecosystem memory usage is showing a slight memory <em>increase</em> for some small projects — this is expected since the index mapping adds a slight overhead if there are not a lot of reachability constraints that are thrown away. But @MichaReiser reports that we are seeing a 3× <em>reduction</em> in memory usage for very large projects. I don't know if we have a way to get some of those into CI, but I even without that I consider this PR to be a win.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dcreager on 2025-07-18 14:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-07-18 14:54</div>
            <div class="timeline-body"><blockquote>
<p>The ecosystem memory usage is showing a slight memory <em>increase</em> for some small projects</p>
</blockquote>
<p>Okay and now I fixed this by shrinking a vector that we were shrinking before</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dcreager on 2025-07-18 17:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @dcreager on 2025-07-18 17:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dcreager on 2025-07-18 17:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-07-18 17:13</div>
            <div class="timeline-body"><p>Somehow requesting Micha's review earlier removed everyone else! I've added you all back not because I specifically want :eyes: from everyone, but just in case any of you want to take a look at this. It does have implications on the <code>finish</code> step of the semantic index builder.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-07-18 23:41</div>
            <div class="timeline-body"><p>Looks good!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/rank.rs</code>:74 on 2025-07-19 07:28</div>
            <div class="timeline-body"><p>Isn't this the same as what the automatically derived GetSize implementation gives you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>Cargo.toml</code>:60 on 2025-07-19 14:04</div>
            <div class="timeline-body"><p>Can we disable the default features and only enable std (I don't think we need the atomic support). This, unfortunately, doesn't help with the new dependencies</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/rank.rs</code>:22 on 2025-07-19 14:17</div>
            <div class="timeline-body"><p>This is neat. It might be worth stating the size requirement more explicitly.</p>
<p>If my understanding is correct, both <code>bits</code> and <code>chunk_ranks</code> have a length of <code>O(len(large vec) / 64)</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/rank.rs</code>:68 on 2025-07-19 14:18</div>
            <div class="timeline-body"><p>Hmm, too sad that <code>as_raw_slice</code> isn't const. I wonder if it is worth to mark this function and <code>get_bit</code> as  <code>#[inline]</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/semantic_index/use_def/place_state.rs</code>:180 on 2025-07-19 14:21</div>
            <div class="timeline-body"><p>Nit: We might want to call this <code>finalize</code> or <code>finish</code> so that we also can call <code>shrink_to_fit</code> on the <code>live_declarations</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/semantic_index/use_def/place_state.rs</code>:229 on 2025-07-19 14:22</div>
            <div class="timeline-body"><p>Same here. I think it would be ncie if we could call <code>shrink_to_fit</code> on <code>live_bindings</code>.  This seems easy now given that we mark them as part of an extra traversal.</p>
<p>See https://github.com/astral-sh/ty/issues/850</p>
<p>Note that this currently won't show up as a memory win because the default <code>SmallVec</code> <code>GetSize</code> implementation is inaccurate (I'm about to fix that)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/semantic_index/use_def.rs</code>:1126 on 2025-07-19 14:23</div>
            <div class="timeline-body"><p>I haven't looked closely so there might be a very obvious reason why you decided not to do that.</p>
<p>Would it be possible to mark those constraints as used as we add bindings, place_state, constraint etc to avoid the extra traversals?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-07-19 14:24</div>
            <div class="timeline-body"><p>Nice. There's a small regression on the instrumented benchmarks but the walltime benchmarks are mostly neutral which makes this a huge win. Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-19 14:25</div>
            <div class="timeline-body"><blockquote>
<p>I don't know if we have a way to get some of those into CI, but I even without that I consider this PR to be a win.</p>
</blockquote>
<p>You can get more detailed numbers locally using <code>TY_MEMORY_REPORT=full</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @AlexWaygood on 2025-07-21 13:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/rank.rs</code>:74 on 2025-07-21 14:39</div>
            <div class="timeline-body"><p>I have to use a helper function to get the size of the <code>bits</code> field since <code>bitvec::BitBox</code> doesn't implement <code>GetSize</code>. I found a way to use the derive impl with a <code>size_fn</code> helper for just that one field.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>Cargo.toml</code>:60 on 2025-07-21 14:41</div>
            <div class="timeline-body"><p>Done. It's <code>alloc</code> that we need, not <code>std</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/rank.rs</code>:68 on 2025-07-21 14:43</div>
            <div class="timeline-body"><p>Will <code>#[inline]</code> be necessary if this is only used within the same crate?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/rank.rs</code>:22 on 2025-07-21 14:49</div>
            <div class="timeline-body"><p>Done. It's <code>O(1.5)</code> bits of overhead per element overall on 64-bit platforms, and <code>O(2)</code> bits on 32-bit platforms</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/semantic_index/use_def/place_state.rs</code>:180 on 2025-07-21 14:50</div>
            <div class="timeline-body"><p>Good idea, done!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/semantic_index/use_def.rs</code>:1126 on 2025-07-21 14:53</div>
            <div class="timeline-body"><p>It was two reasons:</p>
<ol>
<li><p>I wasn't sure if every binding, place_state, etc is actually used, so I wanted to only mark the ones that still exist at the <code>finish</code> step as used. (I don't think there's any place where we delete e.g. a binding but thought it would be easier to not even have to check.)</p>
</li>
<li><p>I thought that marking everything in one place would make it easier to make sure I got everything.</p>
</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/semantic_index/use_def/place_state.rs</code>:229 on 2025-07-21 14:57</div>
            <div class="timeline-body"><p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-07-21 15:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-21 16:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/rank.rs</code>:68 on 2025-07-21 16:25</div>
            <div class="timeline-body"><p>It still acts as a hint to the compiler. But yes, it's less useful compared to cross crate inlining without LTO.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-21 17:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/semantic_index/use_def.rs</code>:1126 on 2025-07-21 17:07</div>
            <div class="timeline-body"><p>Makes sense. I'm fine keeping it this way for now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-07-21 17:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/rank.rs</code>:68 on 2025-07-21 17:58</div>
            <div class="timeline-body"><p>:+1: Got it! Added</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dcreager on 2025-07-21 18:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dcreager on 2025-07-21 18:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-21 18:16</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:58:39 UTC
    </footer>
</body>
</html>
