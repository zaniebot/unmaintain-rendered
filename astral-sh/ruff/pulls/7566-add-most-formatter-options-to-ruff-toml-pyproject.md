```yaml
number: 7566
title: "Add most formatter options to `ruff.toml` / `pyproject.toml`"
type: pull_request
state: merged
author: MichaReiser
labels:
  - configuration
  - formatter
assignees: []
merged: true
base: main
head: format-options
created_at: 2023-09-21T09:50:00Z
updated_at: 2023-09-22T15:59:57Z
url: https://github.com/astral-sh/ruff/pull/7566
synced_at: 2026-01-12T15:55:24Z
```

# Add most formatter options to `ruff.toml` / `pyproject.toml`

---

_@MichaReiser_


## Summary

This PR adds most formatter configuration options under a new `[format]` section. 

**Missing options**

- Tab size 
- Respecting `exclude`

Closes https://github.com/astral-sh/ruff/issues/7061
Closes [#7570](https://github.com/astral-sh/ruff/issues/7570)

## Open Questions

* Should we add `line-ending` as a global configuration option similar to `line-width` and `tab-size` to that `Styleist` could use it to. My main hesitation is that the formatter should default to `LineEnding::Lf`, but `Styleist` uses `LineEnding::Auto` (which makes sense for a linter). 
* Naming of `LineEnding` options: Are people familiar with `Lf` and `CrLf` or should we use `Unix` and `Windows`

## Test Plan

* I added a few integration tests. 
* Unfortunately, it seems `insta-cmd` normalizes line endings in snapshots (makes sense). So I used a hex viewer to verify that `cr-lf` results in `\r\n` line endings
* I played around with the settings in the `Playground`


---

_Comment by @MichaReiser on 2023-09-21 09:50_

Current dependencies on/for this PR:
* main
  * **PR #7566** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7566" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #7591** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7591" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #7593** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7593" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #7549** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7549" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #7599** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7599" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7566?utm_source=stack-comment).

---

_@MichaReiser reviewed on 2023-09-21 09:57_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/settings.rs`:1 on 2023-09-21 09:57_

I had to move the file because `FiltePatternSet` and `FilePattern` is defined in `ruff_linter`. We may want to introduce a new crate for these types eventually but moving the struct to `ruff_workspace` is sufficient for now because the formatter doesn't use it.

---

_Comment by @codspeed-hq[bot] on 2023-09-21 09:58_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/format-options)

### Merging #7566 will **degrade performances by 3.15%**

<sub>Comparing <code>format-options</code> (7a13d26) with <code>main</code> (82978ac)</sub>



### Summary

`âŒ 1` regressions
`âœ… 24` untouched benchmarks



> :warning: _Please fix the performance issues or [acknowledge them on CodSpeed](https://codspeed.io/astral-sh/ruff/branches/format-options)._

### Benchmarks breakdown

|     | Benchmark | `main` | `format-options` | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| âŒ | `linter/default-rules[large/dataset.py]` | 91.1 ms | 94.1 ms | -3.15% |


---

_Review comment by @MichaReiser on `crates/ruff_workspace/src/options.rs`:2394 on 2023-09-21 09:59_

Using `untagged` allows us to support both the old `SerializationFormat` and `Format` group. The only downside is that serde's error messages aren't any useful because it only tells you that what you have is neither of the two.

---

_@MichaReiser reviewed on 2023-09-21 09:59_

---

_Label `configuration` added by @MichaReiser on 2023-09-21 10:18_

---

_Label `formatter` added by @MichaReiser on 2023-09-21 10:18_

---

_Marked ready for review by @MichaReiser on 2023-09-21 10:26_

---

_Comment by @github-actions[bot] on 2023-09-21 10:59_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.



---

_Review requested from @charliermarsh by @MichaReiser on 2023-09-21 11:35_

---

_@charliermarsh reviewed on 2023-09-21 13:26_

---

_Review comment by @charliermarsh on `crates/ruff_workspace/src/options.rs`:2452 on 2023-09-21 13:26_

These end up appearing under a `[tool.ruff]`, so I think these should be `[tool.ruff.format]`?

---

_@charliermarsh reviewed on 2023-09-21 13:26_

---

_Review comment by @charliermarsh on `crates/ruff_workspace/src/options.rs`:2452 on 2023-09-21 13:26_

These end up appearing under a `[tool.ruff]`, so I think these should be `[tool.ruff.format]`?

---

_@charliermarsh reviewed on 2023-09-21 13:26_

---

_Review comment by @charliermarsh on `crates/ruff_workspace/src/options.rs`:2444 on 2023-09-21 13:26_

Is this intentionally commented? (I see the TODO but not sure if it's related to this or something else.)

---

_Review comment by @charliermarsh on `crates/ruff_workspace/src/options.rs`:2466 on 2023-09-21 13:27_

Perhaps we can expand on "left separate", and even include a small example?

---

_@charliermarsh reviewed on 2023-09-21 13:27_

---

_@charliermarsh approved on 2023-09-21 13:27_

---

_Comment by @konstin on 2023-09-21 14:50_

What about the following semantics for a global `line-ending`?

* line-ending = "auto"
  * i'm using only the linter: line endings are determined from what the file already uses
  * i'm also using the formatter: line endings are changed to LF everywhere

* line-ending = "native"/"lf"/"cr-lf"
  * i'm using only the linter: line endings are set to native/lf/cr-lf
  * i'm also using the formatter: line endings are changed to native/lf/cr-lf everywhere

By default, if a user only uses the linter, they get the usual conservative linter behaviour that tries to match what is already there, and won't notice the more aggresive formatter behaviour. If they use the formatter they get maximized consistency, since the formatter runs after the linter, user don't need to care about the preservation attempt in the linter. If a user has specific wishes, they can specify. Depending on their git and editor configuration, they also have the native option to keep the platform behaviour.

The `formatter` section documentation will link all global options that impact formatting style.

---

_Comment by @MichaReiser on 2023-09-21 15:10_

> What about the following semantics for a global `line-ending`?
> 
>     * line-ending = "auto"
>       
>       * i'm using only the linter: line endings are determined from what the file already uses
>       * i'm also using the formatter: line endings are changed to LF everywhere
> 
>     * line-ending = "native"/"lf"/"cr-lf"
>       
>       * i'm using only the linter: line endings are set to native/lf/cr-lf
>       * i'm also using the formatter: line endings are changed to native/lf/cr-lf everywhere
> 
> 
> By default, if a user only uses the linter, they get the usual conservative linter behaviour that tries to match what is already there, and won't notice the more aggresive formatter behaviour. If they use the formatter they get maximized consistency, since the formatter runs after the linter, user don't need to care about the preservation attempt in the linter. If a user has specific wishes, they can specify. Depending on their git and editor configuration, they also have the native option to keep the platform behaviour.
> 
> The `formatter` section documentation will link all global options that impact formatting style.

The challenge is that we don't know whether someone uses the formatter other than when they run `ruff format` or explicitly opt out of formatting using `format.enabled = false`. 

I would also try to make settings as static as possible to avoid confusion. E.g. what happens if formatting is only used in some directories? Does `Auto` then have the same semantics for all files or depends on whether the file gets formatted?

---

_Comment by @konstin on 2023-09-21 21:13_

> The challenge is that we don't know whether someone uses the formatter other than when they run ruff format or explicitly opt out of formatting using format.enabled = false.
>
> I would also try to make settings as static as possible to avoid confusion. E.g. what happens if formatting is only used in some directories? Does Auto then have the same semantics for all files or depends on whether the file gets formatted?

Assuming that if we run the formatter, we run it consistently after the linter, i don't think either of this is a problem: Files that get formatted get LF consistency, files that are not formatted have their line endings preserved by the linter. Put differently, i think the default should be the linter doesn't change any line endings (wrt to the file it's fixing), while the formatter changes all line endings.

---

_Review comment by @dhruvmanila on `crates/ruff_workspace/src/options.rs`:2502 on 2023-09-22 07:17_

Can we mention what "auto" and "native" mean in the documentation? The "auto" is explained in the example so we could skip that but I would add it for consistency.

---

_@dhruvmanila reviewed on 2023-09-22 07:20_

---

_Comment by @qarmin on 2023-09-22 08:54_

Default format configuration should be added here - https://github.com/astral-sh/ruff#configuration

---

_@MichaReiser reviewed on 2023-09-22 10:05_

---

_Review comment by @MichaReiser on `crates/ruff_workspace/src/options.rs`:2502 on 2023-09-22 10:05_

Makes sense. It's a bit unfortunate because we already have the documentation on `LineEnding`. 

---

_@MichaReiser reviewed on 2023-09-22 11:03_

---

_Review comment by @MichaReiser on `crates/ruff_workspace/src/options.rs`:2452 on 2023-09-22 11:03_

I removed the section from all examples to align it with other examples.

---

_@MichaReiser reviewed on 2023-09-22 11:03_

---

_Review comment by @MichaReiser on `crates/ruff_workspace/src/options.rs`:2444 on 2023-09-22 11:03_

I decided to remove it for now

---

_Comment by @MichaReiser on 2023-09-22 11:04_

> > The challenge is that we don't know whether someone uses the formatter other than when they run ruff format or explicitly opt out of formatting using format.enabled = false.
> > I would also try to make settings as static as possible to avoid confusion. E.g. what happens if formatting is only used in some directories? Does Auto then have the same semantics for all files or depends on whether the file gets formatted?
> 
> Assuming that if we run the formatter, we run it consistently after the linter, i don't think either of this is a problem: Files that get formatted get LF consistency, files that are not formatted have their line endings preserved by the linter. Put differently, i think the default should be the linter doesn't change any line endings (wrt to the file it's fixing), while the formatter changes all line endings.

I agree with this and I think this aligns with only having `line-ending` under `format`. 

---

_Comment by @MichaReiser on 2023-09-22 11:20_

> Default format configuration should be added here - [astral-sh/ruff#configuration](https://github.com/astral-sh/ruff#configuration)

Thanks for calling this out. I wasn't aware that we list the defaults in the README. I'm unsure yet what we should do about this, considering that the formatter options are preview only. I'll ask internally 

---

_Comment by @MichaReiser on 2023-09-22 15:08_

> Default format configuration should be added here - [astral-sh/ruff#configuration](https://github.com/astral-sh/ruff#configuration)

We discussed this internally. We wait with adding the section until reaching beta / stable. 

---

_Merged by @MichaReiser on 2023-09-22 15:47_

---

_Closed by @MichaReiser on 2023-09-22 15:47_

---

_Branch deleted on 2023-09-22 15:48_

---
