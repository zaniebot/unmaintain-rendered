<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add support for descriptor checks with unions - astral-sh/ruff #22067</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add support for descriptor checks with unions</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22067">#22067</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2025-12-19 02:44
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR attempts to support cases like the following (<a href="https://play.ty.dev/cf79b56e-4350-49e2-ad3f-795e68613401">playground</a>):</p>
<pre><code class="language-python">from typing import Any

class DescriptorWithSet:
    def __set__(self, instance: object, value: Any) -&gt; None: ...

class NoSet:
    pass

class MyModel:
    state: DescriptorWithSet | NoSet

m = MyModel()
m.state = 1
</code></pre>
<p>At present, <code>m.state = 1</code> fails with <code>Invalid assignment to data descriptor attribute state on type MyModel with custom __set__ method (invalid-assignment)</code>, because we attempt to reconcile the <code>DescriptorWithSet | NoSet</code> against the <code>__set__</code> call. With this change, we instead partition the union into those members that implement <code>__set__</code> and those that don't.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-19 02:46</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-19 02:47</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">bidict (https://github.com/jab/bidict)
- bidict/_orderedbase.py:71:9: error[invalid-assignment] Invalid assignment to data descriptor attribute `nxt` on type `Self@__init__` with custom `__set__` method
- bidict/_orderedbase.py:82:9: error[invalid-assignment] Invalid assignment to data descriptor attribute `nxt` on type `Node` with custom `__set__` method
- bidict/_orderedbase.py:110:9: error[invalid-assignment] Invalid assignment to data descriptor attribute `nxt` on type `Node` with custom `__set__` method
- bidict/_orderedbidict.py:86:13: error[invalid-assignment] Invalid assignment to data descriptor attribute `nxt` on type `Node` with custom `__set__` method
- bidict/_orderedbidict.py:87:24: error[invalid-assignment] Object of type `Node` is not assignable to attribute `nxt` on type `Unknown | Node`
- bidict/_orderedbidict.py:91:13: error[invalid-assignment] Invalid assignment to data descriptor attribute `nxt` on type `Node` with custom `__set__` method
- Found 15 diagnostics
+ Found 9 diagnostics

scrapy (https://github.com/scrapy/scrapy)
+ tests/test_pqueues.py:101:9: error[invalid-assignment] Object of type `MockEngine` is not assignable to attribute `engine` of type `ExecutionEngine | None`
+ tests/test_scheduler.py:98:9: error[invalid-assignment] Object of type `MockEngine` is not assignable to attribute `engine` of type `ExecutionEngine | None`
- Found 1790 diagnostics
+ Found 1792 diagnostics

pytest (https://github.com/pytest-dev/pytest)
- testing/test_terminal.py:2029:33: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 433 diagnostics
+ Found 432 diagnostics

optuna (https://github.com/optuna/optuna)
- optuna/storages/_rdb/storage.py:325:17: error[invalid-assignment] Invalid assignment to data descriptor attribute `value_json` on type `StudyUserAttributeModel` with custom `__set__` method
- optuna/storages/_rdb/storage.py:337:17: error[invalid-assignment] Invalid assignment to data descriptor attribute `value_json` on type `StudySystemAttributeModel` with custom `__set__` method
- optuna/storages/_rdb/storage.py:572:13: error[invalid-assignment] Invalid assignment to data descriptor attribute `state` on type `TrialModel` with custom `__set__` method
- optuna/storages/_rdb/storage.py:574:9: error[invalid-assignment] Invalid assignment to data descriptor attribute `number` on type `TrialModel` with custom `__set__` method
- optuna/storages/_rdb/storage.py:668:17: error[invalid-assignment] Invalid assignment to data descriptor attribute `state` on type `TrialModel` with custom `__set__` method
- optuna/storages/_rdb/storage.py:671:21: error[invalid-assignment] Invalid assignment to data descriptor attribute `datetime_start` on type `TrialModel` with custom `__set__` method
- optuna/storages/_rdb/storage.py:674:21: error[invalid-assignment] Invalid assignment to data descriptor attribute `datetime_complete` on type `TrialModel` with custom `__set__` method
- optuna/storages/_rdb/storage.py:699:13: error[invalid-assignment] Invalid assignment to data descriptor attribute `value` on type `TrialValueModel` with custom `__set__` method
- optuna/storages/_rdb/storage.py:700:13: error[invalid-assignment] Invalid assignment to data descriptor attribute `value_type` on type `TrialValueModel` with custom `__set__` method
- optuna/storages/_rdb/storage.py:738:13: error[invalid-assignment] Invalid assignment to data descriptor attribute `intermediate_value` on type `TrialIntermediateValueModel` with custom `__set__` method
- optuna/storages/_rdb/storage.py:739:13: error[invalid-assignment] Invalid assignment to data descriptor attribute `intermediate_value_type` on type `TrialIntermediateValueModel` with custom `__set__` method
- optuna/storages/_rdb/storage.py:805:17: error[invalid-assignment] Object of type `str` is not assignable to attribute `value_json` on type `TrialUserAttributeModel | TrialSystemAttributeModel`
- optuna/storages/_rdb/storage.py:1035:17: error[invalid-assignment] Invalid assignment to data descriptor attribute `heartbeat` on type `TrialHeartbeatModel` with custom `__set__` method
- optuna/storages/_rdb/storage.py:1193:13: error[invalid-assignment] Invalid assignment to data descriptor attribute `schema_version` on type `VersionInfoModel` with custom `__set__` method
- optuna/storages/_rdb/storage.py:1194:13: error[invalid-assignment] Invalid assignment to data descriptor attribute `library_version` on type `VersionInfoModel` with custom `__set__` method
- tests/storages_tests/rdb_tests/test_storage.py:160:9: error[invalid-assignment] Object of type `Literal[11]` is not assignable to attribute `schema_version` on type `Unknown | VersionInfoModel`
- tests/storages_tests/rdb_tests/test_storage.py:361:13: error[invalid-assignment] Invalid assignment to data descriptor attribute `number` on type `TrialModel` with custom `__set__` method
- Found 577 diagnostics
+ Found 560 diagnostics

meson (https://github.com/mesonbuild/meson)
+ mesonbuild/interpreter/interpreter.py:1186:9: error[invalid-assignment] Object of type `list[str]` is not assignable to attribute `project_default_options` of type `dict[OptionKey, str | int | list[str]]`
- Found 1944 diagnostics
+ Found 1945 diagnostics

cloud-init (https://github.com/canonical/cloud-init)
+ tests/unittests/sources/test_azure.py:2849:9: error[invalid-assignment] Object of type `Literal[&quot;md&quot;]` is not assignable to attribute `metadata` of type `dict[Unknown, Unknown]`
- Found 1188 diagnostics
+ Found 1189 diagnostics

scikit-build-core (https://github.com/scikit-build/scikit-build-core)
+ src/scikit_build_core/build/wheel.py:98:20: error[no-matching-overload] No overload of bound method `__init__` matches arguments
- Found 47 diagnostics
+ Found 48 diagnostics

xarray (https://github.com/pydata/xarray)
- xarray/core/dataarray.py:5757:16: error[invalid-return-type] Return type does not match returned value: expected `T_Xarray@map_blocks`, found `T_Xarray@map_blocks | DataArray | Dataset`
+ xarray/core/dataarray.py:5757:16: error[invalid-return-type] Return type does not match returned value: expected `T_Xarray@map_blocks`, found `DataArray | Dataset`
- xarray/core/dataset.py:8873:16: error[invalid-return-type] Return type does not match returned value: expected `T_Xarray@map_blocks`, found `T_Xarray@map_blocks | DataArray | Dataset`
+ xarray/core/dataset.py:8873:16: error[invalid-return-type] Return type does not match returned value: expected `T_Xarray@map_blocks`, found `DataArray | Dataset`

jax (https://github.com/google/jax)
+ jax/_src/tree_util.py:302:31: error[invalid-argument-type] Argument to bound method `register_node` is incorrect: Expected `(Hashable, Iterable[object], /) -&gt; T@register_pytree_node`, found `(_AuxData@register_pytree_node, _Children@register_pytree_node, /) -&gt; T@register_pytree_node`
+ jax/_src/tree_util.py:305:31: error[invalid-argument-type] Argument to bound method `register_node` is incorrect: Expected `(Hashable, Iterable[object], /) -&gt; T@register_pytree_node`, found `(_AuxData@register_pytree_node, _Children@register_pytree_node, /) -&gt; T@register_pytree_node`
+ jax/_src/tree_util.py:308:31: error[invalid-argument-type] Argument to bound method `register_node` is incorrect: Expected `(Hashable, Iterable[object], /) -&gt; T@register_pytree_node`, found `(_AuxData@register_pytree_node, _Children@register_pytree_node, /) -&gt; T@register_pytree_node`
- Found 2802 diagnostics
+ Found 2805 diagnostics

pandas-stubs (https://github.com/pandas-dev/pandas-stubs)
+ pandas-stubs/_typing.pyi:1228:16: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 5125 diagnostics
+ Found 5126 diagnostics

core (https://github.com/home-assistant/core)
+ homeassistant/components/wallbox/coordinator.py:244:9: error[invalid-assignment] Object of type `timedelta` is not assignable to attribute `update_interval` of type `property`
- Found 14440 diagnostics
+ Found 14441 diagnostics


</code></pre>
</details>

<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Add support for descriptor checks with unions" to "[ty] Add support for descriptor checks with unions" by @AlexWaygood on 2025-12-19 14:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-12-19 14:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2025-12-19 14:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @charliermarsh on 2025-12-19 14:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @charliermarsh on 2025-12-19 14:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @charliermarsh on 2025-12-19 14:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @charliermarsh on 2025-12-19 14:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by @AlexWaygood on 2025-12-19 14:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-19 14:24</div>
            <div class="timeline-body"><!-- generated-comment ty ecosystem-analyzer -->

<h2><code>ecosystem-analyzer</code> results</h2>
<p>| Lint rule | Added | Removed | Changed |
|-----------|------:|--------:|--------:|
| <code>invalid-assignment</code> | 5 | 23 | 0 |
| <code>invalid-argument-type</code> | 0 | 3 | 1 |
| <code>invalid-return-type</code> | 1 | 0 | 3 |
| <code>unused-ignore-comment</code> | 0 | 1 | 0 |
| <strong>Total</strong> | <strong>6</strong> | <strong>27</strong> | <strong>4</strong> |</p>
<p><strong><a href="https://a4bfcb31.ty-ecosystem-ext.pages.dev/diff">Full report with detailed diff</a></strong> (<a href="https://a4bfcb31.ty-ecosystem-ext.pages.dev/timing">timing results</a>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-24 01:37</div>
            <div class="timeline-body"><p>Where did this case come from? Was it user-reported (there's no issue linked)? Did we see it in the ecosystem somewhere?</p>
<p>Just curious since it's kind of an odd case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-12-24 04:05</div>
            <div class="timeline-body"><p>@carljm -- I believe this was an attempt to fix some of the new diagnostics that fell out of https://github.com/astral-sh/ruff/pull/22014, specifically the new <code>optuna</code> diagnostics in the ecosystem report (https://charlie-set.ecosystem-663.pages.dev/diff).</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:18:13 UTC
    </footer>
</body>
</html>
