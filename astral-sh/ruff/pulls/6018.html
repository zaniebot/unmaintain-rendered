<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-pyi`] Implement PYI018 - astral-sh/ruff #6018</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-pyi</code>] Implement PYI018</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6018">#6018</a>
        opened by <a href="https://github.com/LaBatata101">@LaBatata101</a>
        on 2023-07-23 21:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/LaBatata101">@LaBatata101</a> on 2023-07-23 21:07</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Check for unused private <code>TypeVar</code>.  See <a href="https://github.com/PyCQA/flake8-pyi/blob/2a86db8271dc500247a8a69419536240334731cf/pyi.py#L1958">original implementation</a>.</p>
<pre><code>$ flake8 --select Y018 crates/ruff/resources/test/fixtures/flake8_pyi/PYI018.pyi

crates/ruff/resources/test/fixtures/flake8_pyi/PYI018.pyi:4:1: Y018 TypeVar &quot;_T&quot; is not used
crates/ruff/resources/test/fixtures/flake8_pyi/PYI018.pyi:5:1: Y018 TypeVar &quot;_P&quot; is not used
</code></pre>
<pre><code>$ ./target/debug/ruff --select PYI018 crates/ruff/resources/test/fixtures/flake8_pyi/PYI018.pyi --no-cache

crates/ruff/resources/test/fixtures/flake8_pyi/PYI018.pyi:4:1: PYI018 TypeVar `_T` is never used
crates/ruff/resources/test/fixtures/flake8_pyi/PYI018.pyi:5:1: PYI018 TypeVar `_P` is never used
Found 2 errors.
</code></pre>
<p>In the file <code>unused_private_type_declaration.rs</code>, I'm planning to add other rules that are similar to <code>PYI018</code> like the <code>PYI046</code>, <code>PYI047</code> and <code>PYI049</code>.</p>
<p>I'm not happy with all this nesting that is happening here:
https://github.com/astral-sh/ruff/blob/a8377770b21706ad82bee7f1230ef5e9d2ddaa12/crates/ruff/src/checkers/ast/mod.rs#L4486-L4502
I couldn't figure it out, a way to eliminate it.</p>
<p>ref #848</p>
<h2>Test Plan</h2>
<p>Snapshots and manual runs of flake8.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-07-23 21:39</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>✅ ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      9.0±0.07ms     4.5 MB/sec    1.13     10.1±0.05ms     4.0 MB/sec
formatter/numpy/ctypeslib.py               1.00   1715.8±4.85µs     9.7 MB/sec    1.10   1886.2±6.22µs     8.8 MB/sec
formatter/numpy/globals.py                 1.00    178.5±1.30µs    16.5 MB/sec    1.07    190.9±0.40µs    15.5 MB/sec
formatter/pydantic/types.py                1.00      3.8±0.02ms     6.8 MB/sec    1.10      4.2±0.01ms     6.1 MB/sec
linter/all-rules/large/dataset.py          1.01     12.8±0.17ms     3.2 MB/sec    1.00     12.8±0.14ms     3.2 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.2±0.03ms     5.2 MB/sec    1.00      3.2±0.01ms     5.2 MB/sec
linter/all-rules/numpy/globals.py          1.00    341.8±1.26µs     8.6 MB/sec    1.01    344.4±5.27µs     8.6 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.7±0.05ms     4.5 MB/sec    1.00      5.7±0.06ms     4.5 MB/sec
linter/default-rules/large/dataset.py      1.01      6.4±0.03ms     6.4 MB/sec    1.00      6.4±0.03ms     6.4 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1270.1±3.58µs    13.1 MB/sec    1.00   1271.2±4.17µs    13.1 MB/sec
linter/default-rules/numpy/globals.py      1.00    124.5±0.75µs    23.7 MB/sec    1.00    125.0±1.42µs    23.6 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.8±0.01ms     9.2 MB/sec    1.00      2.8±0.01ms     9.2 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.06     10.8±0.10ms     3.8 MB/sec    1.00     10.2±0.09ms     4.0 MB/sec
formatter/numpy/ctypeslib.py               1.05      2.0±0.03ms     8.1 MB/sec    1.00  1950.6±27.82µs     8.5 MB/sec
formatter/numpy/globals.py                 1.02    222.3±5.42µs    13.3 MB/sec    1.00    217.3±7.43µs    13.6 MB/sec
formatter/pydantic/types.py                1.05      4.5±0.05ms     5.7 MB/sec    1.00      4.3±0.11ms     5.9 MB/sec
linter/all-rules/large/dataset.py          1.00     14.4±0.15ms     2.8 MB/sec    1.01     14.5±0.19ms     2.8 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.8±0.06ms     4.4 MB/sec    1.00      3.8±0.03ms     4.4 MB/sec
linter/all-rules/numpy/globals.py          1.00    444.4±7.26µs     6.6 MB/sec    1.02    452.7±5.67µs     6.5 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.5±0.07ms     3.9 MB/sec    1.00      6.5±0.05ms     3.9 MB/sec
linter/default-rules/large/dataset.py      1.01      7.3±0.07ms     5.6 MB/sec    1.00      7.3±0.05ms     5.6 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1484.6±18.20µs    11.2 MB/sec    1.01  1495.4±25.42µs    11.1 MB/sec
linter/default-rules/numpy/globals.py      1.00    164.9±2.53µs    17.9 MB/sec    1.03    169.4±2.36µs    17.4 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.2±0.06ms     8.0 MB/sec    1.00      3.2±0.03ms     8.0 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[WIP] Implement PYI018" to "[`flake8-pyi`] Implement PYI018" by @LaBatata101 on 2023-07-24 22:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @LaBatata101 on 2023-07-24 23:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/src/rules/flake8_pyi/snapshots/ruff__rules__flake8_pyi__tests__PYI018_PYI018.pyi.snap</code>:9 on 2023-07-26 16:08</div>
            <div class="timeline-body"><p>Should we highlight the entire declaration?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-26 16:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-26 16:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/unused_private_type_definition.rs</code>:37 on 2023-07-26 16:09</div>
            <div class="timeline-body"><p>Should we note that the variable is private?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-07-26 16:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_pyi/snapshots/ruff__rules__flake8_pyi__tests__PYI018_PYI018.pyi.snap</code>:9 on 2023-07-26 16:40</div>
            <div class="timeline-body"><p>I personally think highlighting just the symbol is ok.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> requested changes on 2023-07-26 16:51</div>
            <div class="timeline-body"><p>Thank you! I know this follows the suggestions I gave in Discord, but looking at the changes and those involved in the downstream PRs, I want to make a few recommendations for modifying the overall data flow. (If you don't feel up for making these changes given the flip-flopping feedback I've given you, I'd also understand and can make them myself if you prefer.)</p>
<p>Overall, it's probably better to avoid (1) having to create a <code>BindingFlag</code> for every unused thing we might care about, and (2) having to add all the detection code (&quot;Is this an assignment to a private type var?&quot;) to the semantic model itself.</p>
<p>Instead, I'd like to structure it as follows:</p>
<ul>
<li>We can create a single <code>BindingFlag</code>, something like <code>PRIVATE_VARIABLE</code>, and set that within <code>SemanticModel#add_binding</code> (rather than having to set flags at all the <code>add_binding</code> call sites throughout <code>checkers/ast/mod.rs</code>). This flag would just check if the name is underscore-prefixed.</li>
<li>In <code>unused_private_type_var</code>, check if the kind is an unused assignment to a private variable. If so, check if it's an assignment to a private <code>TypeVar</code> using the code you already wrote in <code>handle_node_store</code> (you can access the statement that defines the binding via <code>binding.parent</code>).</li>
</ul>
<p>This should also generalize to the other variants we care about, without requiring any changes to the semantic model, only the rules themselves. What do you think?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/LaBatata101">@LaBatata101</a> on 2023-07-26 19:23</div>
            <div class="timeline-body"><blockquote>
<p>Thank you! I know this follows the suggestions I gave in Discord, but looking at the changes and those involved in the downstream PRs, I want to make a few recommendations for modifying the overall data flow. (If you don't feel up for making these changes given the flip-flopping feedback I've given you, I'd also understand and can make them myself if you prefer.)</p>
<p>Overall, it's probably better to avoid (1) having to create a <code>BindingFlag</code> for every unused thing we might care about, and (2) having to add all the detection code (&quot;Is this an assignment to a private type var?&quot;) to the semantic model itself.</p>
<p>Instead, I'd like to structure it as follows:</p>
<pre><code>* We can create a single `BindingFlag`, something like `PRIVATE_VARIABLE`, and set that within `SemanticModel#add_binding` (rather than having to set flags at all the `add_binding` call sites throughout `checkers/ast/mod.rs`). This flag would just check if the name is underscore-prefixed.

* In `unused_private_type_var`, check if the kind is an unused assignment to a private variable. If so, check if it's an assignment to a private `TypeVar` using the code you already wrote in `handle_node_store` (you can access the statement that defines the binding via `binding.parent`).</code></pre>
<p>This should also generalize to the other variants we care about, without requiring any changes to the semantic model, only the rules themselves. What do you think?</p>
</blockquote>
<p>That sounds good, I'll implement it myself. I actually thought about doing something more generic like the <code>PRIVATE_VARIABLE</code>  flag, but since I'm not that familiar with the code base yet, and I didn't know how to go about it.</p>
<p>I have one question, what about private classes, like we check in <code>PYI046</code>?
I don't know if  <code>PRIVATE_VARIABLE</code> would be fitting, should I create another just for the classes, like <code>PRIVATE_CLASS</code>? What do you think?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @LaBatata101 on 2023-07-26 21:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-07-26 22:44</div>
            <div class="timeline-body"><p>Great! I renamed to <code>PRIVATE_DECLARATION</code> which feels more appropriate when applied to classes and such. I also moved the flag setting into <code>add_binding</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-07-26 22:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @charliermarsh on 2023-07-26 22:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-07-26 22:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-07-26 22:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-07-27 21:04</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 03:24:31 UTC
    </footer>
</body>
</html>
