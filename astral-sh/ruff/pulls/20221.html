<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Attribute access on top/bottom materializations - astral-sh/ruff #20221</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Attribute access on top/bottom materializations</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20221">#20221</a>
        opened by <a href="https://github.com/JelleZijlstra">@JelleZijlstra</a>
        on 2025-09-03 23:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JelleZijlstra">@JelleZijlstra</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Part of astral-sh/ty#994. The goal of this PR was to add correct behavior for attribute access on the top and bottom materializations. This is necessary for the end goal of using the top materialization for narrowing generics (<code>isinstance(x, list)</code>): we want methods like <code>x.append</code> to work correctly in that case.</p>
<p>It turned out to be convenient to represent materialization as a TypeMapping, so it can be stashed in the <code>type_mappings</code> list of a function object. This also allowed me to remove most concrete <code>materialize</code> methods, since they usually just delegate to the subparts of the type, the same as other type mappings. That is why the net effect of this PR is to remove a few hundred lines.</p>
<h2>Test Plan</h2>
<p>I added a few more tests. Much of this PR is refactoring and covered by existing tests.</p>
<h2>Followups</h2>
<p>Assigning to attributes of top materializations is not yet covered. This seems less important so I'd like to defer it.</p>
<p>I noticed that the <code>materialize</code> implementation of <code>Parameters</code> was wrong; it did the same for the top and bottom materializations. This PR makes the bottom materialization slightly more reasonable, but implementing this correctly will require extending the struct.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @JelleZijlstra on 2025-09-03 23:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @JelleZijlstra on 2025-09-03 23:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @JelleZijlstra on 2025-09-03 23:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @JelleZijlstra on 2025-09-03 23:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-03 23:14</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-09-04 00:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types.rs</code>:830 on 2025-09-04 00:22</div>
            <div class="timeline-body"><p>I see some <code>materialize</code> methods in this PR, and some <code>materialize_impl</code>, with the same signature. What determines whether you chose to rename a given method to <code>materialize_impl</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/generics.rs</code>:614 on 2025-09-04 00:25</div>
            <div class="timeline-body"><p>So I am currently working on recursive type alias support, and as part of that I have a local branch where I'd already added a cycle-detection visitor to all materialize methods. I think this PR is an improvement, but it will probably mean I need all <code>materialize_impl</code> methods (at least any that can be called from an <code>apply_type_mapping_impl</code> method, such as in this spot) to accept and pass on an <code>ApplyTypeMappingVisitor</code>.</p>
<p>I think that should be fine, and I can handle it as a follow-up, just mentioning it in case you see any potential issues.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/generics.rs</code>:734 on 2025-09-04 00:27</div>
            <div class="timeline-body"><p>Here I think I will need this <code>materialize_impl</code> to already accept the <code>ApplyTypeMappingVisitor</code>, and I'll need to pass it along here, and in all the variance arms above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/signatures.rs</code>:450 on 2025-09-04 00:27</div>
            <div class="timeline-body"><p>I've seen this a couple places in this PR -- should it be a method on <code>TypeMapping</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/signatures.rs</code>:1237 on 2025-09-04 00:34</div>
            <div class="timeline-body"><p>Aren't these reversed? I think the bottom and top materializations are counter-intuitive here due to contravariance of parameters. Isn't <code>Parameters::object(db)</code> the subtype of all materializations of the gradual parameter-signature (it is a valid substitute for any parameter-signature, because it can accept any call arguments)? And the top materialization (the super-type of all materializations, for which any parameter-signature is a valid substitute) is more difficult to represent. Or is it actually just <code>*args: Never, **kwargs: Never</code>, which accepts no calls, and which any other parameter signature is a subtype of?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-09-04 00:36</div>
            <div class="timeline-body"><p>Looks good, thank you! A few comments, none blocking -- though the parameter materialization thing should probably be addressed, if I'm not wrong there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-09-04 00:41</div>
            <div class="timeline-body"><p>Oh, I just noticed the stack overflow in mypy-primer. So it may be that you actually do need to add some of the visitor-threading I mentioned above in this PR, to avoid regressing. (Though I'd recommend reproducing the stack overflow locally to verify the exact cyclic stack in lldb before trying to fix.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JelleZijlstra">@JelleZijlstra</a> reviewed on 2025-09-04 01:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/JelleZijlstra">@JelleZijlstra</a> on <code>crates/ty_python_semantic/src/types/signatures.rs</code>:1237 on 2025-09-04 01:12</div>
            <div class="timeline-body"><p>I think that may not be right because we flip the variance earlier (in whatever struct contains Parameters).</p>
<blockquote>
<p>Or is it actually just <code>*args: Never, **kwargs: Never</code>, which accepts no calls, and which any other parameter signature is a subtype of?</p>
</blockquote>
<p>That signature would accept a call with no arguments (<code>f()</code>), so a signature that has required arguments wouldn't be a subtype of it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JelleZijlstra">@JelleZijlstra</a> on 2025-09-04 01:13</div>
            <div class="timeline-body"><p>Yes, I'll need to look into the crash. Intuitively it's not clear why materialization would diverge, maybe it's for recursive aliases? If so would it make sense to wait for your more general fix?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-09-04 01:46</div>
            <div class="timeline-body"><p>I think it most likely is recursive aliases (though it could also be recursive protocols). The fix isn't really a &quot;general&quot; one; part of it is ensuring that we propagate cycle detection visitors through all recursive type visits (a stack overflow is usually caused by failing to do this thoroughly). It seems like this PR is regressing our existing cycle detection coverage in some way; ideally that would be fixed in this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-09-04 16:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/signatures.rs</code>:1237 on 2025-09-04 16:19</div>
            <div class="timeline-body"><blockquote>
<p>we flip the variance earlier (in whatever struct contains Parameters)</p>
</blockquote>
<p>Ah, that makes sense -- might be worth a comment. Or it might be worth changing this so we handle the variance flip in <code>Parameters</code>? To the extent we end up defining the &quot;top&quot; and &quot;bottom&quot; materializations of a <code>Parameters</code>, I think I would find it more intuitive for those to correspond with the actual top and bottom signature, not be reversed. (I know that in my previous comment I called it counter-intuitive ðŸ¤· ). Not an important point.</p>
<blockquote>
<p>That signature would accept a call with no arguments (<code>f()</code>), so a signature that has required arguments wouldn't be a subtype of it.</p>
</blockquote>
<p>Oh, yeah, of course. So we will need (not in this PR) a dedicated representation for &quot;parameters which accept no call&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JelleZijlstra">@JelleZijlstra</a> reviewed on 2025-09-04 16:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/JelleZijlstra">@JelleZijlstra</a> on <code>crates/ty_python_semantic/src/types.rs</code>:830 on 2025-09-04 16:49</div>
            <div class="timeline-body"><p>I think a good rule is going to be that materialize calls apply_type_mapping(_impl), and apply_type_mapping calls materialize_impl. I believe I do that mostly consistently already but will double check.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/JelleZijlstra">@JelleZijlstra</a> on <code>crates/ty_python_semantic/src/types/signatures.rs</code>:450 on 2025-09-04 16:50</div>
            <div class="timeline-body"><p>Yeah maybe, I was struggling a bit with getting things to compile. I can give it another try.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JelleZijlstra">@JelleZijlstra</a> reviewed on 2025-09-04 16:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JelleZijlstra">@JelleZijlstra</a> reviewed on 2025-09-04 17:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/JelleZijlstra">@JelleZijlstra</a> on <code>crates/ty_python_semantic/src/types/signatures.rs</code>:450 on 2025-09-04 17:34</div>
            <div class="timeline-body"><p>I couldn't get this to work, maybe I need to learn more Rust or something. The pattern only appears twice, so doesn't seem too bad to leave it duplicated for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JelleZijlstra">@JelleZijlstra</a> reviewed on 2025-09-04 17:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/JelleZijlstra">@JelleZijlstra</a> on <code>crates/ty_python_semantic/src/types/signatures.rs</code>:1237 on 2025-09-04 17:50</div>
            <div class="timeline-body"><p>I'll add a comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JelleZijlstra">@JelleZijlstra</a> reviewed on 2025-09-04 18:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/JelleZijlstra">@JelleZijlstra</a> on <code>crates/ty_python_semantic/src/types/generics.rs</code>:734 on 2025-09-04 18:09</div>
            <div class="timeline-body"><p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-04 18:15</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…
No memory usage changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JelleZijlstra">@JelleZijlstra</a> reviewed on 2025-09-04 18:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/JelleZijlstra">@JelleZijlstra</a> on <code>crates/ty_python_semantic/src/types/generics.rs</code>:614 on 2025-09-04 18:17</div>
            <div class="timeline-body"><p>I made them all accept an ApplyTypeMappingVisitor, that fixes the hang seen in mypy-primer though I won't pretend to understand how it actually helps.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-09-04 19:01</div>
            <div class="timeline-body"><p>Looks great, thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @carljm on 2025-09-04 19:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-09-04 19:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-09-04 19:27</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:15:30 UTC
    </footer>
</body>
</html>
