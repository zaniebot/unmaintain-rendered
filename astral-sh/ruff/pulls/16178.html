<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warn on invalid noqa even when there are no diagnostics - astral-sh/ruff #16178</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Warn on invalid noqa even when there are no diagnostics</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16178">#16178</a>
        opened by <a href="https://github.com/dylwil3">@dylwil3</a>
        on 2025-02-15 17:22
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-15 17:22</div>
            <div class="timeline-body"><p>On <code>main</code> we warn the user if there is an invalid noqa comment[^1] and at least one of the following holds:</p>
<ul>
<li>There is at least one diagnostic</li>
<li>A lint rule related to <code>noqa</code>s is enabled (e.g. <code>RUF100</code>)</li>
</ul>
<p>This is probably strange behavior from the point of view of the user, so we now show invalid <code>noqa</code>s even when there are no diagnostics.</p>
<p>Closes #12831</p>
<p>[^1]: For the current definition of &quot;invalid noqa comment&quot;, which may be expanded in #12811 . This PR is independent of loc. cit. in the sense that the CLI warnings should be consistent, regardless of which <code>noqa</code> comments are considered invalid.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cli</span> added by @dylwil3 on 2025-02-15 17:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">suppression</span> added by @dylwil3 on 2025-02-15 17:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-02-15 17:29</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-15 20:21</div>
            <div class="timeline-body"><p>It seems @charliermarsh introduced the check for performance reasons in https://github.com/astral-sh/ruff/pull/1898</p>
<p>Can you tell me a bit more: Is it possible that <code>check_noqa</code> creates warnings even if there are no diagnostics? Isn't it just iterating over the diagnostics? Or are those warnings emitted by the noqa parsings? Skipping the empty diagnostics does seem reasonable.</p>
<p>I'm not sure if we should skip the check if noqa is disabled because it gets initialized by the <code>--ignore-noqa</code> cli setting and it is documented as</p>
<pre><code>    --ignore-noqa
          Ignore any `# noqa` comments
</code></pre>
<p>Showing warning in this case seems not in the spirit of this flag. Unless I'm misunderstanding something.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-02-15 20:25</div>
            <div class="timeline-body"><p>Oh shoot. I thought you removed the entire check but you didn't. I think this looks correct. Assuming that those warnings are emitted as part of the noqa parsing logic</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-15 22:36</div>
            <div class="timeline-body"><p>Yep they are emitted as part of the parsing of <code>noqa</code> comments implicit in <code>check_noqa</code>.</p>
<p>I think the UX is worth the potential perf hit (I also think the situation you'd have to be in for the perf hit to be noticeable seems somewhat rare - something like a cold start on a large codebase with <em>no lint errors</em> and lots of comments?) But I can try to run some kind of benchmark tomorrow to double check.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-16 19:57</div>
            <div class="timeline-body"><p>This seems okay to me... and again, I think it's a relatively rare situation. After deleting files with syntax errors, I found a code that had no diagnostics (<code>YTT101</code>) and ran the below benchmark.</p>
<p>(Also, the absolute numbers below are probably misleading since I didn't do any work to make sure my CPU was idle etc. So it's only the relative difference that's of interest).</p>
<pre><code class="language-shell">❯ hyperfine --warmup 10 \
  &quot;./target/release/ruff check ./crates/ruff_linter/resources/test/cpython/ --select YTT101 --isolated --no-cache -e&quot; &quot;ruff check ./crates/ruff_linter/resources/test/cpython/ --select YTT101 --isolated --no-cache -e&quot;
Benchmark 1: ./target/release/ruff check ./crates/ruff_linter/resources/test/cpython/ --select YTT101 --isolated --no-cache -e
  Time (mean ± σ):      78.9 ms ±   1.6 ms    [User: 648.6 ms, System: 89.3 ms]
  Range (min … max):    76.3 ms …  82.9 ms    36 runs

Benchmark 2: ruff check ./crates/ruff_linter/resources/test/cpython/ --select YTT101 --isolated --no-cache -e
  Time (mean ± σ):      78.5 ms ±   1.5 ms    [User: 644.1 ms, System: 87.9 ms]
  Range (min … max):    75.9 ms …  82.3 ms    37 runs

Summary
  ruff check ./crates/ruff_linter/resources/test/cpython/ --select YTT101 --isolated --no-cache -e ran
    1.00 ± 0.03 times faster than ./target/release/ruff check ./crates/ruff_linter/resources/test/cpython/ --select YTT101 --isolated --no-cache -e
</code></pre>
<p>And with a warm cache it's even more of a non-issue:</p>
<pre><code class="language-shell">❯ hyperfine --warmup 10 \
  &quot;./target/release/ruff check ./crates/ruff_linter/resources/test/cpython/ --select YTT101 --isolated -e&quot; &quot;ruff check ./crates/ruff_linter/resources/test/cpython/ --select YTT101 --isolated -e&quot;
Benchmark 1: ./target/release/ruff check ./crates/ruff_linter/resources/test/cpython/ --select YTT101 --isolated -e
  Time (mean ± σ):      15.3 ms ±   1.0 ms    [User: 21.4 ms, System: 46.2 ms]
  Range (min … max):    13.3 ms …  18.1 ms    167 runs

Benchmark 2: ruff check ./crates/ruff_linter/resources/test/cpython/ --select YTT101 --isolated -e
  Time (mean ± σ):      15.1 ms ±   0.9 ms    [User: 21.8 ms, System: 46.2 ms]
  Range (min … max):    13.0 ms …  18.0 ms    167 runs

Summary
  ruff check ./crates/ruff_linter/resources/test/cpython/ --select YTT101 --isolated -e ran
    1.01 ± 0.09 times faster than ./target/release/ruff check ./crates/ruff_linter/resources/test/cpython/ --select YTT101 --isolated -e
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dylwil3 on 2025-02-16 19:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dylwil3 on 2025-02-16 19:58</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:57:53 UTC
    </footer>
</body>
</html>
