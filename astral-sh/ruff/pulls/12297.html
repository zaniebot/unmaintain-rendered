<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Add `walk_directories` to `System` - astral-sh/ruff #12297</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Add <code>walk_directories</code> to <code>System</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/12297">#12297</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-07-12 09:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR adds a <code>ignore::WalkDir</code> like API to <code>System</code> that allows walking a directory tree.</p>
<p>We'll need this to implement the analysis of an entire directory.</p>
<h2>Test Plan</h2>
<p>Added unit tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @MichaReiser on 2024-07-12 09:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-07-12 09:31</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/system-walk-directories">CodSpeed Performance Report</a></h2>
<h3>Merging #12297 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>system-walk-directories</code> (7cfe17b) with <code>system-walk-directories</code> (b22ac5e)</sub></p>
<h3>Summary</h3>
<p><code>✅ 33</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/system/memory_fs.rs</code>:257 on 2024-07-12 17:55</div>
            <div class="timeline-body"><p>I'm happy to revert this pack to returning an <code>impl</code>. I had to change it, because a first version of the walker had to store the current iteration state in a <code>struct</code> which doesn't work with <code>impl</code> (Unless you use <code>dyn</code>). I introduced the named type and thought I'll leave it, because it can be useful.</p>
<p>It's also nice that the type now implements <code>Debug</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-12 17:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2024-07-12 17:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MichaReiser on 2024-07-12 17:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MichaReiser on 2024-07-12 17:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-07-12 18:19</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<details><summary><a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)</summary>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to parse examples/chatgpt/gpt_actions_library/.gpt_action_getting_started.ipynb:11:1:1: Expected an expression
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_bigquery.ipynb:13:1:1: Expected an expression
</code></pre>
</p>
</details>

<h3>Formatter (preview)</h3>
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<details><summary><a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)</summary>
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to parse examples/chatgpt/gpt_actions_library/.gpt_action_getting_started.ipynb:11:1:1: Expected an expression
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_bigquery.ipynb:13:1:1: Expected an expression
</code></pre>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-12 20:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_db/src/system.rs</code>:160 on 2024-07-12 20:31</div>
            <div class="timeline-body"><p>Heh, this is what I had originally in #12289, before https://github.com/astral-sh/ruff/pull/12289/commits/be11d8682d706e0151b8e6ac51114a4550b58422! Doesn't this just reverse the change you asked me to make in https://github.com/astral-sh/ruff/pull/12289#discussion_r1674657856? ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/system.rs</code>:160 on 2024-07-12 21:00</div>
            <div class="timeline-body"><p>Yeah, that's probably true. I ran into the issue that <code>io::Error</code> isn't <code>Clone</code>. I could have worked around this problem by destructing both the <code>path</code> and the <code>result</code> from <code>file_type</code>, but I'm unsure if it's worth it.</p>
<p>The main advantage of <code>std::fs::DirEntry::file_type</code> is that the operation is lazy. This is different in our implementation, where we call <code>file_type</code> when returning the <code>DirEntry</code> (so it is eager).</p>
<p>Now, there's a semantic difference in the new implementation. The <code>read_dir</code> call will fail when calling <code>file_type</code> fails. I don't know in what situations it is possible to know that the entry is there, but it fails to read the file type.</p>
<p>I just spent some time looking into what <code>walker</code> does. It seems <code>walker' also eagerly reads the file type and returns an </code>Err` if it fails to retrieve it.</p>
<p>Ideally, I think we would make the <code>file_type</code> call lazy, but that's quiet a bit more complicated because it would require holding on to <code>System</code>.</p>
<p>TLDR: Not sure, but it felt like the most straightforward path and it's unclear to me what the benefit is of keeping the Result.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-12 21:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-12 21:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_db/src/system.rs</code>:160 on 2024-07-12 21:07</div>
            <div class="timeline-body"><p>That all makes sense to me. If we're no longer storing a <code>Result</code>, though, I think I'd also make the following simplifications:</p>
<pre><code class="language-diff">diff --git a/crates/ruff_db/src/system.rs b/crates/ruff_db/src/system.rs
index 2805137ec..5b1ce5b12 100644
--- a/crates/ruff_db/src/system.rs
+++ b/crates/ruff_db/src/system.rs
@@ -115,7 +115,7 @@ impl Metadata {
     }
 }
 
-#[derive(Copy, Clone, Eq, PartialEq, Debug, Hash)]
+#[derive(Copy, Clone, Eq, PartialEq, Debug, Hash, PartialOrd, Ord)]
 pub enum FileType {
     File,
     Directory,
@@ -136,7 +136,7 @@ impl FileType {
     }
 }
 
-#[derive(Debug)]
+#[derive(Debug, PartialEq, Eq, PartialOrd, Ord)]
 pub struct DirectoryEntry {
     path: SystemPathBuf,
     file_type: FileType,
@@ -155,9 +155,3 @@ impl DirectoryEntry {
         self.file_type
     }
 }
-
-impl PartialEq for DirectoryEntry {
-    fn eq(&amp;self, other: &amp;Self) -&gt; bool {
-        self.path == other.path
-    }
-}
diff --git a/crates/ruff_db/src/system/os.rs b/crates/ruff_db/src/system/os.rs
index 2b7dd397d..99fff9449 100644
--- a/crates/ruff_db/src/system/os.rs
+++ b/crates/ruff_db/src/system/os.rs
@@ -283,7 +283,7 @@ mod tests {
             .unwrap()
             .map(Result::unwrap)
             .collect();
-        sorted_contents.sort_by(|a, b| a.path.cmp(&amp;b.path));
+        sorted_contents.sort();
 
         let expected_contents = vec![
             DirectoryEntry::new(tempdir_path.join(&quot;a/bar.py&quot;), FileType::File),
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-12 21:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/system.rs</code>:160 on 2024-07-12 21:08</div>
            <div class="timeline-body"><p>Oh yeah, we can implement <code>PartialEq</code> and <code>Eq</code>.</p>
<p>I don't think I want to implement <code>PartialOrd</code> for <code>FileType</code> nor <code>DirectoryEntry</code>. Neither type has a natural ordering, in my view (mainly <code>FileType</code> but, because of that, also <code>DirectoryEntry</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-12 21:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_db/src/system.rs</code>:160 on 2024-07-12 21:10</div>
            <div class="timeline-body"><blockquote>
<p>Not sure what the use case (or even the order) is.</p>
</blockquote>
<p>I guess the use case is that you can easily derive <code>PartialOrd</code> on <code>DirectoryEntry</code>... but yeah, agreed that that one is questionable :) We can just not derive <code>PartialOrd</code> on <code>DirectoryEntry</code> and continue using <code>.sort_by()</code> rather than <code>.sort()</code> in <code>system/os.rs</code>, that's fine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-13 14:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_db/src/system/memory_fs.rs</code>:281 on 2024-07-13 14:24</div>
            <div class="timeline-body"><p>nit: I don't mind returning the named type too much, but I'm not sure I see the need to change to an imperative approach here. Does doing so fix a bug? You could do this with a much smaller diff by keeping most of the code as it was:</p>
<pre><code class="language-suggestion">        let collected = by_path
            .range(normalized.clone()..)
            .skip(1)
            .take_while(|(path, _)| path.starts_with(&amp;normalized))
            .filter_map(|(path, entry)| {
                if path.parent()? == normalized {
                    Some(Ok(DirectoryEntry {
                        path: SystemPathBuf::from_utf8_path_buf(path.to_owned()),
                        file_type: entry.file_type(),
                    }))
                } else {
                    None
                }
            })
            .collect()
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_db/src/system/walk_directory.rs</code>:263 on 2024-07-15 16:51</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    /// Test helper that creates a visual representation of the visited directory entries.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_db/src/system/walk_directory.rs</code>:320 on 2024-07-15 17:19</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        /// Stores the visited path. The key is the relative path to the root, using `/` as path separator.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_db/src/system/walk_directory.rs</code>:59 on 2024-07-15 17:25</div>
            <div class="timeline-body"><p>It doesn't seem right to always set <code>ignore_hidden</code> to <code>true</code> here, even if someone is turning <em>off</em> standard filters.</p>
<p>(And maybe add a test that would catch this?)</p>
<pre><code class="language-suggestion">        self.ignore_hidden = standard_filters;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_db/src/system/walk_directory.rs</code>:54 on 2024-07-15 17:28</div>
            <div class="timeline-body"><p>It's not clear to me what this is supposed to mean.</p>
<p>Does it mean that you cannot ever set <code>standard_filters = true</code> and <code>ignore_hidden = false</code>? (If so, we would need some additional code to enforce that, because right now you can just call <code>.ignore_hidden(false)</code> and easily achieve that state.)</p>
<p>Or does it just mean that <code>standard_filters(true)</code> also sets <code>ignore_hidden = true</code>, but you can still override with <code>ignore_hidden(false)</code> if you want? That seems to be the current implementation, but in that case I think this comment would be clearer if it said something like &quot;Unless explicitly overriden with <code>ignore_hidden(false)</code>, this defaults to ignoring hidden files.&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_db/src/system/walk_directory.rs</code>:157 on 2024-07-15 17:35</div>
            <div class="timeline-body"><p>Not sure what this comment means, since <code>file_type</code> isn't <code>Option</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_db/src/system/walk_directory.rs</code>:168 on 2024-07-15 17:43</div>
            <div class="timeline-body"><p>This method appears to be unused currently (not sure why clippy isn't complaining about it), and I'm having trouble seeing where it would ever be useful, with these odd semantics. In what use case would you ever want just the name for files but the full path for directories?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_db/src/system/walk_directory.rs</code>:181 on 2024-07-15 17:43</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    /// If the entry given is a directory, don't descend into it.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_db/src/system/walk_directory.rs</code>:246 on 2024-07-15 17:46</div>
            <div class="timeline-body"><p>It seems like most places we prefer having enum variants wrap independent named structs over struct enum variants. I'm curious if you have thoughts on when to choose one vs the other.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_db/src/system/test.rs</code>:41 on 2024-07-15 17:57</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    fn use_system&lt;S&gt;(&amp;mut self, system: S)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_db/src/system/os.rs</code>:144 on 2024-07-15 18:04</div>
            <div class="timeline-body"><p>This safety comment isn't clear to me, I assume because I'm missing some important context. How do we know that <code>entry</code> is a system path? What is a &quot;stdin path&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_db/src/system/os.rs</code>:152 on 2024-07-15 18:06</div>
            <div class="timeline-body"><p>How do we know that this is an error related to a git ignore file?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-07-15 18:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-15 19:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/system/os.rs</code>:152 on 2024-07-15 19:53</div>
            <div class="timeline-body"><p>This is the contract from the ignore crate.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-07-15 23:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_db/src/system/os.rs</code>:152 on 2024-07-15 23:35</div>
            <div class="timeline-body"><p>I see; I guess it wouldn't hurt to clarify that in the comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-16 06:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/system/walk_directory.rs</code>:246 on 2024-07-16 06:30</div>
            <div class="timeline-body"><p>To me it depends on how the enum variants are used. Our AST used to use struct enum variants over named structs. This was very cumbersome in downstream tools because it was impossible to pass an entire <code>StmtFunctionDef</code>, because it lacked a name. That's why you still see many lint rules accepting all individual fields of their node instead of the entire node.</p>
<p>Another motivation for named structs is if you want to lock-down access to individual fields because the enum fields always have the same visibility as the enum itself.</p>
<p>On the other hand, using variant structs allows Rust to be more clever when it comes to layout optimizations and it's a lot less boilerplate to define the enum and to match on it (no nesting).</p>
<p>I'm using struct variants here because</p>
<p>a) I think it's unlikely that some code would want to pass the entire variant (have it a named type) and even if, that code would at most have to accept two arguments
b) The main use case is to match on the variant and extract the fields, which is more brief with struct variants.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2024-07-16 06:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-07-16 06:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-07-16 06:40</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:05:16 UTC
    </footer>
</body>
</html>
