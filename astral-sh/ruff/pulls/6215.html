<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-pyi`] Implement PYI051 - astral-sh/ruff #6215</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-pyi</code>] Implement PYI051</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6215">#6215</a>
        opened by <a href="https://github.com/LaBatata101">@LaBatata101</a>
        on 2023-08-01 00:15
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/LaBatata101">@LaBatata101</a> on 2023-08-01 00:15</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Checks for the presence of redundant <code>Literal</code> types and builtin super types in an union. See <a href="https://github.com/PyCQA/flake8-pyi/blob/2a86db8271dc500247a8a69419536240334731cf/pyi.py#L1261">original source</a>.</p>
<p>This implementation has a couple of differences from the original. The first one is, we support the <code>complex</code> and <code>float</code> builtin types. The second is, when reporting diagnostic for a <code>Literal</code> with multiple members of the same type, we print the entire <code>Literal</code> while <code>flak8</code> only prints the <code>Literal</code> with its first member.
For example:</p>
<pre><code class="language-python">from typing import Literal

x: Literal[1, 2] | int
</code></pre>
<p>Ruff will show <code>Literal[1, 2]</code> while flake8 only shows <code>Literal[1]</code>.</p>
<pre><code class="language-shell">$ ruff crates/ruff/resources/test/fixtures/flake8_pyi/PYI051.pyi
crates/ruff/resources/test/fixtures/flake8_pyi/PYI051.pyi:4:18: PYI051 `Literal[&quot;foo&quot;]` is redundant in an union with `str`
crates/ruff/resources/test/fixtures/flake8_pyi/PYI051.pyi:5:37: PYI051 `Literal[b&quot;bar&quot;, b&quot;foo&quot;]` is redundant in an union with `bytes`
crates/ruff/resources/test/fixtures/flake8_pyi/PYI051.pyi:6:37: PYI051 `Literal[5]` is redundant in an union with `int`
crates/ruff/resources/test/fixtures/flake8_pyi/PYI051.pyi:6:67: PYI051 `Literal[&quot;foo&quot;]` is redundant in an union with `str`
crates/ruff/resources/test/fixtures/flake8_pyi/PYI051.pyi:7:37: PYI051 `Literal[b&quot;str_bytes&quot;]` is redundant in an union with `bytes`
crates/ruff/resources/test/fixtures/flake8_pyi/PYI051.pyi:7:51: PYI051 `Literal[42]` is redundant in an union with `int`
crates/ruff/resources/test/fixtures/flake8_pyi/PYI051.pyi:9:31: PYI051 `Literal[1J]` is redundant in an union with `complex`
crates/ruff/resources/test/fixtures/flake8_pyi/PYI051.pyi:9:53: PYI051 `Literal[3.14]` is redundant in an union with `float`
Found 8 errors.
</code></pre>
<pre><code class="language-shell">$ flake8 crates/ruff/resources/test/fixtures/flake8_pyi/PYI051.pyi
crates/ruff/resources/test/fixtures/flake8_pyi/PYI051.pyi:4:18: Y051 &quot;Literal['foo']&quot; is redundant in a union with &quot;str&quot;
crates/ruff/resources/test/fixtures/flake8_pyi/PYI051.pyi:5:37: Y051 &quot;Literal[b'bar']&quot; is redundant in a union with &quot;bytes&quot;
crates/ruff/resources/test/fixtures/flake8_pyi/PYI051.pyi:6:37: Y051 &quot;Literal[5]&quot; is redundant in a unionwith &quot;int&quot;
crates/ruff/resources/test/fixtures/flake8_pyi/PYI051.pyi:6:67: Y051 &quot;Literal['foo']&quot; is redundant in a union with &quot;str&quot;
crates/ruff/resources/test/fixtures/flake8_pyi/PYI051.pyi:7:37: Y051 &quot;Literal[b'str_bytes']&quot; is redundantin a union with &quot;bytes&quot;
crates/ruff/resources/test/fixtures/flake8_pyi/PYI051.pyi:7:51: Y051 &quot;Literal[42]&quot; is redundant in a union with &quot;int&quot;
</code></pre>
<p>While implementing this rule, I found a bug in the <code>is_unchecked_union</code> check. This is the new check.</p>
<p>https://github.com/astral-sh/ruff/blob/1ab86bad35e5edd1ba4cd82b0eb4c78416509dac/crates/ruff/src/checkers/ast/analyze/expression.rs#L85-L102</p>
<p>The purpose of the check was to prevent rules from navigating through nested <code>Union</code>s, as they already handle nested <code>Union</code>s. The way it was implemented, this was not happening, the rules were getting executed more than one time and sometimes were receiving expressions that were not <code>Union</code>. For example, with the following code:</p>
<pre><code class="language-python"> typing.Union[Literal[5], int, typing.Union[Literal[&quot;foo&quot;], str]]
</code></pre>
<p>The rules were receiving the expressions in the following order:
- <code>typing.Union[Literal[5], int, typing.Union[Literal[&quot;foo&quot;], str]]</code>
- <code>Literal[5]</code>
- <code>typing.Union[Literal[&quot;foo&quot;], str]]</code></p>
<p>This was causing <code>PYI030</code> to report redundant information, for example:</p>
<pre><code class="language-python"> typing.Union[Literal[5], int, typing.Union[Literal[&quot;foo&quot;], Literal[&quot;bar&quot;]]]
</code></pre>
<p>This is the <code>PYI030</code> output for this code:</p>
<pre><code class="language-shell">PYI030 Multiple literal members in a union. Use a single literal, e.g. `Literal[5, &quot;foo&quot;, &quot;bar&quot;]`
YI030 Multiple literal members in a union. Use a single literal, e.g.`Literal[5, &quot;foo&quot;]`
</code></pre>
<p>If I haven't misinterpreted the rule, that looks incorrect. I didn't have the time to check the <code>PYI016</code> rule.</p>
<p>The last thing is, I couldn't find a reason for the &quot;Why is this bad?&quot; section for <code>PYI051</code>.</p>
<p>Ref: #848</p>
<h2>Test Plan</h2>
<p>Snapshots and manual runs of flake8.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-08-01 00:28</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>✅ ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.04      8.8±0.08ms     4.6 MB/sec    1.00      8.5±0.06ms     4.8 MB/sec
formatter/numpy/ctypeslib.py               1.01  1675.0±25.16µs     9.9 MB/sec    1.00  1661.4±30.06µs    10.0 MB/sec
formatter/numpy/globals.py                 1.01    173.8±0.44µs    17.0 MB/sec    1.00    172.7±1.77µs    17.1 MB/sec
formatter/pydantic/types.py                1.03      3.8±0.09ms     6.8 MB/sec    1.00      3.7±0.08ms     7.0 MB/sec
linter/all-rules/large/dataset.py          1.04     11.7±0.04ms     3.5 MB/sec    1.00     11.3±0.01ms     3.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.04      3.1±0.07ms     5.4 MB/sec    1.00      2.9±0.01ms     5.7 MB/sec
linter/all-rules/numpy/globals.py          1.00    316.9±1.07µs     9.3 MB/sec    1.01    321.2±5.40µs     9.2 MB/sec
linter/all-rules/pydantic/types.py         1.06      5.4±0.05ms     4.7 MB/sec    1.00      5.1±0.01ms     5.0 MB/sec
linter/default-rules/large/dataset.py      1.01      6.1±0.04ms     6.6 MB/sec    1.00      6.1±0.03ms     6.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1199.5±6.73µs    13.9 MB/sec    1.01   1213.7±4.57µs    13.7 MB/sec
linter/default-rules/numpy/globals.py      1.00    120.5±3.44µs    24.5 MB/sec    1.01    121.4±1.03µs    24.3 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.6±0.01ms     9.7 MB/sec    1.00      2.6±0.01ms     9.7 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      9.8±0.08ms     4.1 MB/sec    1.02     10.0±0.10ms     4.1 MB/sec
formatter/numpy/ctypeslib.py               1.00  1926.9±36.83µs     8.6 MB/sec    1.00  1935.9±32.98µs     8.6 MB/sec
formatter/numpy/globals.py                 1.00    214.3±4.08µs    13.8 MB/sec    1.02    218.7±9.08µs    13.5 MB/sec
formatter/pydantic/types.py                1.00      4.2±0.06ms     6.1 MB/sec    1.02      4.3±0.08ms     6.0 MB/sec
linter/all-rules/large/dataset.py          1.00     13.3±0.19ms     3.1 MB/sec    1.00     13.3±0.15ms     3.1 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.5±0.05ms     4.7 MB/sec    1.00      3.5±0.03ms     4.7 MB/sec
linter/all-rules/numpy/globals.py          1.01    435.6±5.61µs     6.8 MB/sec    1.00    432.2±5.28µs     6.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.0±0.08ms     4.2 MB/sec    1.00      6.0±0.08ms     4.3 MB/sec
linter/default-rules/large/dataset.py      1.00      7.3±0.08ms     5.6 MB/sec    1.00      7.3±0.08ms     5.6 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.02  1506.5±18.21µs    11.1 MB/sec    1.00  1480.7±19.07µs    11.2 MB/sec
linter/default-rules/numpy/globals.py      1.02    170.0±3.40µs    17.4 MB/sec    1.00    165.8±2.20µs    17.8 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.2±0.07ms     8.0 MB/sec    1.00      3.2±0.04ms     8.0 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/LaBatata101">@LaBatata101</a> on 2023-08-01 01:03</div>
            <div class="timeline-body"><p>Looks like something is wrong in the implementation</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-01 04:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/redundant_literal_union.rs</code>:124 on 2023-08-01 04:20</div>
            <div class="timeline-body"><p>@LaBatata101 - I think the issue is that we needed to treat these two cases as separate. Otherwise, we were flagging cases like <code>Literal[1, 2]</code>, since we'd detect that we have <code>int</code> in the <code>Union</code> (by way of visiting the <code>1</code> and <code>2</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-01 04:43</div>
            <div class="timeline-body"><p>Oh sorry, I missed your comment about the <code>is_unchecked_union</code> check and accidentally reverted that code when merging. @zanieb, do you mind reviewing that comment in the PR summary and helping understand whether it's a valid change?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @charliermarsh on 2023-08-01 04:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @zanieb by @zanieb on 2023-08-02 19:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-02 19:37</div>
            <div class="timeline-body"><p>Mentioned to @zanieb offline but I think the current <code>is_unchecked_union</code> is &quot;more correct&quot; than the version proposed here (which will miss cases like <code>f(Union[...])</code>, since it ignores anything with a parent expression). However, there's at least one bug in the current version unrelated to the logic of the check itself and instead related to some quirks on the semantic model traversal, I think. I will document separately.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-08-02 19:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-08-02 19:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-02 19:46</div>
            <div class="timeline-body"><p>Documented here: https://github.com/astral-sh/ruff/issues/6285</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-08-02 20:15</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 02:52:41 UTC
    </footer>
</body>
</html>
