<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enable selection of preview rules - astral-sh/ruff #7046</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Enable selection of preview rules</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7046">#7046</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-09-01 15:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-01 15:38</div>
            <div class="timeline-body"><p>One proposal for supporting workflows like:</p>
<pre><code>ruff check --select E .  # Only includes stable E rules.
ruff check --select E --preview .  # Includes stable and preview E rules.
ruff check --select E225 .  # Includes E225, even though it's in preview.
ruff check --select E225 --preview .  # Includes E225.
ruff check --select ALL .  # Includes all stable rules.
ruff check --select ALL --preview .  # Includes all stable and preview rules.
</code></pre>
<p>The basic idea is to stop filtering out nursery rules in the macro code, and instead filter them out when we resolve the rule set. This alone wouldn't support selecting individual rules (<code>ruff check --select E225 .</code>), so to fix that, we add a new specificity and <code>RuleCodePrefix</code>, for selectors that extract a single rule.</p>
<p>There are a few downsides to this approach:</p>
<ul>
<li>All selectors will now appear in the JSON Schema and be supported on the CLI, including those that grab single rules (like <code>E225</code>) and those that only include preview rules (like <code>E22</code> -- all of the rules under that prefix are in preview, but <code>--select E22</code> without the preview flag won't work). This is not ideal, but... it's also somewhat rare and should be rarer over time.</li>
<li>Maybe others? Thinking...</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-01 15:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rule_selector.rs</code>:72 on 2023-09-01 15:39</div>
            <div class="timeline-body"><p>This isn't sufficiently robust, it can be refined... (E.g., this would match <code>--select CPY</code> since there's only one rule in that category).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-01 15:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_workspace/src/configuration.rs</code>:489 on 2023-09-01 15:40</div>
            <div class="timeline-body"><p>Actually, here's another idea...</p>
<p>Instead of matching on specific selector (like <code>--select E225</code>), what if we allow the selector if <em>all rules</em> in that selector are preview? So e.g. <code>--select CPY</code> would work, as would <code>--select CPY001</code>.</p>
<p>Similarly, <code>--select E2</code> <em>would</em> turn on the <code>E2</code> rules even though they're in preview. But <code>--select E</code> would not. The idea being that you'd have to explicitly select a preview category here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-01 15:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rule_selector.rs</code>:72 on 2023-09-01 15:48</div>
            <div class="timeline-body"><p>(Fixed.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @charliermarsh on 2023-09-01 15:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2023-09-01 15:57</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/charlie/cli-preview">CodSpeed Performance Report</a></h2>
<h3>Merging #7046 will <strong>degrade performances by 7.11%</strong></h3>
<p><sub>:warning: No base runs were found</sub></p>
<p><sub>Falling back to comparing <code>charlie/cli-preview</code> (b9f0ade) with <code>main</code> (fbc9b5a)</sub></p>
<h3>Summary</h3>
<p><code>❌ 8</code> regressions
<code>✅ 12</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/charlie/cli-preview">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>main</code> | <code>charlie/cli-preview</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ❌ | <code>linter/default-rules[numpy/ctypeslib.py]</code> | 18.7 ms | 19.4 ms | -3.27% |
| ❌ | <code>linter/default-rules[numpy/globals.py]</code> | 2.2 ms | 2.3 ms | -4.38% |
| ❌ | <code>linter/default-rules[pydantic/types.py]</code> | 39.4 ms | 41.6 ms | -5.37% |
| ❌ | <code>linter/default-rules[large/dataset.py]</code> | 93.6 ms | 100.7 ms | -7.11% |
| ❌ | <code>linter/all-rules[numpy/ctypeslib.py]</code> | 33.9 ms | 35.3 ms | -4.1% |
| ❌ | <code>linter/all-rules[unicode/pypinyin.py]</code> | 16.9 ms | 17.3 ms | -2.33% |
| ❌ | <code>linter/default-rules[unicode/pypinyin.py]</code> | 6.4 ms | 6.7 ms | -4.92% |
| ❌ | <code>linter/all-rules[pydantic/types.py]</code> | 72.3 ms | 74.7 ms | -3.23% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-09-01 18:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_workspace/src/configuration.rs</code>:489 on 2023-09-01 18:29</div>
            <div class="timeline-body"><p>I think that @MichaReiser had a really good point about preview mode possibly changing semantic model behavior and that allowing opt-in to specific preview rules without the <code>--preview</code> flag should probably not be allowed. I think if we really want opt-in to specific preview rules, we can provide <code>--ignore PREVIEW</code> to avoid turning them all on and <code>--select RULE</code> can be used to opt-in one at a time, but the <code>--preview</code> flag would still be required and the behavior of other things could change as a consequence.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-01 18:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/configuration.rs</code>:489 on 2023-09-01 18:35</div>
            <div class="timeline-body"><p>I'm a bit undecided and realized that part of the struggle comes from that it isn't entirely clear what use cases we want to enable with preview mode. Understanding that would be important in my view because a) what I pointed out isn't a problem, b) requiring <code>--preview</code> is okay, or c) a nursery category is the better solution.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-09-01 18:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_workspace/src/configuration.rs</code>:489 on 2023-09-01 18:45</div>
            <div class="timeline-body"><p>I think it is safer to require <code>--preview</code> for any preview behavior. Once we start allowing you to opt into it without that setting, we create a lot of complexity. We can always <em>expand</em> the behavior later if it seems like it'd be okay, but as a starting point I'd rather be restrictive.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-01 18:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rule_selector.rs</code>:198 on 2023-09-01 18:49</div>
            <div class="timeline-body"><p>@zanieb - Here's an alternative API: we remove the <code>into_iter()</code> so that there's no more implicit selection, and now require that the preview flag is passed in to the iteration API.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-01 18:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rule_selector.rs</code>:200 on 2023-09-01 18:49</div>
            <div class="timeline-body"><p>(If we want to avoid enabling preview selection for specific rules, then we'd want to remove <code>RuleSelector::Rule { .. })</code> here.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-01 18:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/flake8_to_ruff/src/plugin.rs</code>:335 on 2023-09-01 18:50</div>
            <div class="timeline-body"><p>Fine to use &quot;disabled&quot; here, since we don't support preview in <code>flake8-to-ruff</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-01 18:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/settings/defaults.rs</code>:76 on 2023-09-01 18:56</div>
            <div class="timeline-body"><p>I think this is maybe only used in tests...?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-01 18:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/settings/types.rs</code>:197 on 2023-09-01 18:57</div>
            <div class="timeline-body"><p>This is okay (not to use preview) because this is an ignore, so it's okay if it includes rules that will never be enabled. But we should comment as such.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2023-09-06 19:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-09-06 19:13</div>
            <div class="timeline-body"><p>Work continued in https://github.com/astral-sh/ruff/pull/7195</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 02:46:15 UTC
    </footer>
</body>
</html>
