<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Avoid panic for generic type aliases - astral-sh/ruff #14312</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Avoid panic for generic type aliases</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14312">#14312</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2024-11-13 09:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-13 09:45</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This avoids a panic inside <code>TypeInferenceBuilder::infer_type_parameters</code> when encountering generic type aliases:</p>
<pre><code class="language-py">type ListOrSet[T] = list[T] | set[T]
</code></pre>
<p>I'm not sure if this is the right call. To fix this properly, I believe we would have to treat type aliases as being <a href="https://docs.python.org/3/reference/compound_stmts.html#generic-type-aliases">their own annotation scope</a>. The left hand side is a definition for the type parameter <code>T</code> which is being used in the special annotation scope on the right hand side. Similar to how it works for generic functions and classes. This is something I've started to look into â€” but it seems to require larger-scale changes and I'm not sure if this is the right time to work on them.</p>
<p>closes #14307</p>
<h2>Test Plan</h2>
<p>Added new example to the corpus.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @sharkdp on 2024-11-13 09:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2024-11-13 09:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @sharkdp on 2024-11-13 09:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2024-11-13 09:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-13 09:59</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-13 11:26</div>
            <div class="timeline-body"><blockquote>
<p>I'm not sure if this is the right call.</p>
</blockquote>
<p>I'm not sure either ðŸ˜† But maybe it's acceptable for now to avoid a panic. Not sure -- let's wait for @carljm to wake up</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-13 13:55</div>
            <div class="timeline-body"><p>Just for reference: my â€” so far unsuccessful â€” attempt at solving this by adding a new scope for type aliases: https://github.com/astral-sh/ruff/compare/main...david/fix-14307</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-11-13 14:29</div>
            <div class="timeline-body"><p>It is true that generic type aliases also have a type-parameters scope, like generic functions and classes, and we should handle it similarly.</p>
<p>I think this TODO is fine for now, though I'm a bit surprised it doesn't cause us to have expressions missing in our test that walks the AST and pulls a type for every expression.</p>
<p>I didn't have PEP695 type alias support on the list for 2024, but we'll definitely need it and it's a bit tricky, so I'd be weakly inclined to go ahead with your PR to fix this properly, since it looks like you already made a lot of progress on it, and the direction looks right. I will need to check it out locally if it's still failing and you need help understanding why.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-13 14:59</div>
            <div class="timeline-body"><p>Ok, thanks. I'm merging this for now to close / clean-up a few tickets. And I can open a new ticket for proper type alias support.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2024-11-13 15:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2024-11-13 15:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-13 15:01</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 20:51:28 UTC
    </footer>
</body>
</html>
