<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use string flags to mark it as invalid - astral-sh/ruff #10385</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use string flags to mark it as invalid</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10385">#10385</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-03-13 14:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body">Summary
<p>This PR updates the string flags to include an <code>Invalid</code> variant for any invalid string nodes as deemed by the parser. This is to avoid dropping the nodes and instead just mark it as invalid. The nodes will be empty for now but we can discuss on whether to keep the raw source text or not. It&#x27;s not really required because the range can be used to get the same.</p>
<p>It also adds a new <code>handle_implicitly_concatenated_strings</code> method which is similar to existing <code>concatenated_strings</code> function. The reason to have a separate method is to avoid dropping all strings if there&#x27;s an error. The error being that it&#x27;s concatenating bytes and non-bytes literal. Now, we need to decide which strings to retain. Currently, I&#x27;ve kept it simple to retain bytes literal <em>only</em> if all of them are bytes otherwise we&#x27;ll have string / f-string with invalid nodes instead of bytes literal.</p>
<p>This removes the need for having a <code>StringType::Invalid</code> variant.</p>
Test Plan
<ul>
<li>[x] Existing test cases pass</li>
<li>[x] No performance regression</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-13 14:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:974 on 2024-03-13 15:01</div>
            <div class="timeline-body"><pre><code>/// An `FStringLiteralElement` with an empty `value` is an invalid f-string element.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1527 on 2024-03-13 15:02</div>
            <div class="timeline-body"><p>To avoid this sounding strangely judgemental:</p>
<pre><code>        /// The string was deemed invalid by the parser.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-03-13 15:16</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1878 on 2024-03-13 15:17</div>
            <div class="timeline-body"><pre><code>        /// The bytestring was deemed invalid by the parser.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1561 on 2024-03-13 15:19</div>
            <div class="timeline-body"><p>Could possibly call this method <code>marked_as_invalid</code>? (Same for the one on <code>BytesLiteralFlags</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-03-13 15:20</div>
            <div class="timeline-body"><p>Nice — a few suggestions on docs and naming</p>
<p>(sorry for reviewing a draft PR!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-13 16:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:974 on 2024-03-13 16:32</div>
            <div class="timeline-body"><p>Oops, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-13 16:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:927 on 2024-03-13 16:36</div>
            <div class="timeline-body"><p>Somewhat torn on whether we should keep the raw source text in the node as it&#x27;s not a valid information and any downstream tool can get the same through the range.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-14 02:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-14 02:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-14 02:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:974 on 2024-03-14 02:57</div>
            <div class="timeline-body"><p>This is fine because there can never be an empty <code>FStringLiteralElement</code> for any valid f-string including the ones which only contains expressions. This is because the lexer doesn&#x27;t emit any <code>FStringMiddle</code> token according to the PEP.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-14 03:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-14 03:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-03-14 03:28</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:02:14 UTC
    </footer>
</body>
</html>
