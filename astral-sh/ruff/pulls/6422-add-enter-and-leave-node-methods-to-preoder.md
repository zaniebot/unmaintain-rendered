```yaml
number: 6422
title: "Add `enter` and `leave_node` methods to Preoder visitor"
type: pull_request
state: merged
author: MichaReiser
labels:
  - internal
assignees: []
merged: true
base: main
head: preorder-enter-leave-node
created_at: 2023-08-08T10:42:28Z
updated_at: 2023-08-09T09:29:41Z
url: https://github.com/astral-sh/ruff/pull/6422
synced_at: 2026-01-12T15:55:21Z
```

# Add `enter` and `leave_node` methods to Preoder visitor

---

_@MichaReiser_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This PR adds `enter_node` and `leave_node` methods to the `Preorder` visitor that are called before entering and leaving any node. 
Having these methods on the Visitor prevents that we forget to override specific node methods when adding new nodes in the future for visitors
that must run for every node. 

The motivation for adding these methods is that I need to add a visitor to the formatter that marks every comment in the suppressed range as formatted.

<!-- What's the purpose of the change? What does it do, and why? -->

## Foot guns

Overriding a `visit_` function without calling the corresponding `walk_` methods results in the `enter_` and `leave_` methods not being called. 

## Alternative designs

An alternative design would be introducing a new `NodeVisitor` trait with only the `enter_node`, `leave_node`, and `visit` methods. The `visit` methods uses an internal `PreorderVisitor` implementation that overrides all relevant methods (similar to how it worked for `CommentsVisitor` before). 

The advantage of this solution is that it removes the foot gun because you can't override specific node visitor methods. The downside is that you can't override node-specific methods and it's easier to forget adding the new method to that visitor (although one should review all visitor implementations when adding a new visitor method)

## Test Plan

`cargo test`
<!-- How was it tested? -->


---

_Comment by @MichaReiser on 2023-08-08 10:42_

Current dependencies on/for this PR:
* main
  * **PR #6422** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6422" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #6426** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6426" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #6441** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6441" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #6178** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6178" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6422?utm_source=stack-comment).

---

_Label `internal` added by @MichaReiser on 2023-08-08 10:44_

---

_Review comment by @konstin on `crates/ruff_python_ast/src/visitor/preorder.rs`:12 on 2023-08-08 10:53_

nit: just `#[inline]`, even though I'd be surprised if that wasn't already inlined

---

_Review comment by @konstin on `crates/ruff_python_ast/src/visitor/preorder.rs`:20 on 2023-08-08 10:54_

do we have evidence that this is needed/helpful?

---

_Review comment by @konstin on `crates/ruff_python_ast/src/visitor/preorder.rs`:180 on 2023-08-08 10:55_

return early here to keep the indentation 

---

_@konstin approved on 2023-08-08 10:56_

---

_@MichaReiser reviewed on 2023-08-08 11:00_

---

_Review comment by @MichaReiser on `crates/ruff_python_ast/src/visitor/preorder.rs`:180 on 2023-08-08 11:00_

We need to call `leave_node` for all nodes, even if we're not traversing the node.

---

_Comment by @github-actions[bot] on 2023-08-08 11:13_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      8.3Â±0.02ms     4.9 MB/sec    1.00      8.3Â±0.03ms     4.9 MB/sec
formatter/numpy/ctypeslib.py               1.00  1611.6Â±33.17Âµs    10.3 MB/sec    1.00   1613.9Â±6.08Âµs    10.3 MB/sec
formatter/numpy/globals.py                 1.00    171.9Â±0.26Âµs    17.2 MB/sec    1.00    171.2Â±0.56Âµs    17.2 MB/sec
formatter/pydantic/types.py                1.01      3.5Â±0.07ms     7.2 MB/sec    1.00      3.5Â±0.02ms     7.2 MB/sec
linter/all-rules/large/dataset.py          1.00     10.5Â±0.07ms     3.9 MB/sec    1.01     10.6Â±0.08ms     3.8 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      2.9Â±0.01ms     5.8 MB/sec    1.01      2.9Â±0.03ms     5.8 MB/sec
linter/all-rules/numpy/globals.py          1.00    318.9Â±1.89Âµs     9.3 MB/sec    1.00    319.1Â±5.23Âµs     9.2 MB/sec
linter/all-rules/pydantic/types.py         1.00      4.9Â±0.02ms     5.2 MB/sec    1.01      4.9Â±0.07ms     5.2 MB/sec
linter/default-rules/large/dataset.py      1.00      5.5Â±0.03ms     7.4 MB/sec    1.00      5.5Â±0.07ms     7.3 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1153.9Â±12.57Âµs    14.4 MB/sec    1.00   1158.5Â±2.34Âµs    14.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    117.9Â±0.35Âµs    25.0 MB/sec    1.00    117.4Â±2.04Âµs    25.1 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.5Â±0.00ms    10.2 MB/sec    1.00      2.5Â±0.03ms    10.2 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     10.2Â±0.13ms     4.0 MB/sec    1.00     10.2Â±0.11ms     4.0 MB/sec
formatter/numpy/ctypeslib.py               1.00  1964.7Â±50.29Âµs     8.5 MB/sec    1.01  1986.2Â±99.49Âµs     8.4 MB/sec
formatter/numpy/globals.py                 1.00   216.7Â±10.93Âµs    13.6 MB/sec    1.02   221.6Â±12.31Âµs    13.3 MB/sec
formatter/pydantic/types.py                1.00      4.3Â±0.06ms     6.0 MB/sec    1.01      4.3Â±0.06ms     5.9 MB/sec
linter/all-rules/large/dataset.py          1.01     12.9Â±0.17ms     3.2 MB/sec    1.00     12.8Â±0.19ms     3.2 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.5Â±0.03ms     4.8 MB/sec    1.00      3.5Â±0.03ms     4.8 MB/sec
linter/all-rules/numpy/globals.py          1.00    434.3Â±5.83Âµs     6.8 MB/sec    1.00    432.2Â±4.97Âµs     6.8 MB/sec
linter/all-rules/pydantic/types.py         1.01      6.0Â±0.10ms     4.3 MB/sec    1.00      5.9Â±0.08ms     4.3 MB/sec
linter/default-rules/large/dataset.py      1.01      7.0Â±0.08ms     5.8 MB/sec    1.00      6.9Â±0.07ms     5.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1431.5Â±28.82Âµs    11.6 MB/sec    1.01  1439.6Â±19.36Âµs    11.6 MB/sec
linter/default-rules/numpy/globals.py      1.00    164.7Â±5.88Âµs    17.9 MB/sec    1.00    164.9Â±3.49Âµs    17.9 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.1Â±0.03ms     8.3 MB/sec    1.01      3.1Â±0.03ms     8.2 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_@konstin reviewed on 2023-08-08 12:27_

---

_Review comment by @konstin on `crates/ruff_python_ast/src/visitor/preorder.rs`:180 on 2023-08-08 12:27_

Would this work?
```python
if !visitor.enter_node(node).is_traverse() {
    visitor.leave_node();
    return;
}
```
(or if you want more abstractions, `EnterNodeGuard` with a Drop impl)

---

_@MichaReiser reviewed on 2023-08-08 13:07_

---

_Review comment by @MichaReiser on `crates/ruff_python_ast/src/visitor/preorder.rs`:180 on 2023-08-08 13:07_

That would work but seemed more complicated than adding the extra indentation. I also thought about 
```
visit_node(node, |node| {
})
```

But it all feels overly complicated for a very simple problem. 

---

_@MichaReiser reviewed on 2023-08-09 07:57_

---

_Review comment by @MichaReiser on `crates/ruff_python_ast/src/visitor/preorder.rs`:20 on 2023-08-09 07:57_

It can be beneficial across crate boundaries because it tells Rust to emit the necessary inline information to inline across crate boundaries. However, this isn't relevant for us because we use LTO. 

The use case where it is useful for us is in debug builds. To my knowledge, Rust doesn't perform any inline in debug builds *except* for functions attributed with `inline`. This means we get slightly better performance for debug builds.

---

_Merged by @MichaReiser on 2023-08-09 09:09_

---

_Closed by @MichaReiser on 2023-08-09 09:09_

---

_Branch deleted on 2023-08-09 09:09_

---
