```yaml
number: 5028
title: Add roundtrip support for Jupyter notebook
type: pull_request
state: merged
author: dhruvmanila
labels: []
assignees: []
merged: true
base: main
head: dhruv/jupyter-roundtrip
created_at: 2023-06-12T15:59:05Z
updated_at: 2023-06-12T18:00:16Z
url: https://github.com/astral-sh/ruff/pull/5028
synced_at: 2026-01-12T03:43:30Z
```

# Add roundtrip support for Jupyter notebook

---

_Pull request opened by @dhruvmanila on 2023-06-12 15:59_

## Summary

Add roundtrip support for Jupyter notebook.

1. Read the notebook
2. Extract out the source code content
3. Use it to update the notebook itself (should be exactly the same [^1])
4. Serialize into JSON and print it to stdout

## Test Plan

`cargo run --all-features --bin ruff_dev --package ruff_dev -- round-trip <path/to/notebook.ipynb>`

<details><summary>Example output:</summary>
<p>

```
{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "f3c286e9-fa52-4440-816f-4449232f199a",
   "metadata": {},
   "source": [
    "# Ruff Test"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "a2b7bc6c-778a-4b07-86ae-dde5a2d9511e",
   "metadata": {},
   "source": [
    "Markdown block before the first import"
   ]
  },
  {
   "cell_type": "code",
   "id": "5e3ef98e-224c-450a-80e6-be442ad50907",
   "metadata": {
    "tags": []
   },
   "source": "",
   "execution_count": 1,
   "outputs": []
  },
  {
   "cell_type": "code",
   "id": "6bced3f8-e0a4-450c-ae7c-f60ad5671ee9",
   "metadata": {},
   "source": "import contextlib\n\nwith contextlib.suppress(ValueError):\n    print()\n",
   "outputs": []
  },
  {
   "cell_type": "code",
   "id": "d7102cfd-5bb5-4f5b-a3b8-07a7b8cca34c",
   "metadata": {},
   "source": "import random\n\nrandom.randint(10, 20)",
   "outputs": []
  },
  {
   "cell_type": "code",
   "id": "88471d1c-7429-4967-898f-b0088fcb4c53",
   "metadata": {},
   "source": "foo = 1\nif foo < 2:\n    msg = f\"Invalid foo: {foo}\"\n    raise ValueError(msg)",
   "outputs": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python (ruff-playground)",
   "name": "ruff-playground",
   "language": "python"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "pygments_lexer": "ipython3",
   "nbconvert_exporter": "python",
   "version": "3.11.3"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
```

</p>
</details> 

[^1]: The type in JSON might be different (https://github.com/astral-sh/ruff/pull/4665#discussion_r1212663495)

Part of #1218


---

_Comment by @dhruvmanila on 2023-06-12 15:59_

Current dependencies on/for this PR:
* main
  * **PR #5028** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5028" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/5028?utm_source=stack-comment).

---

_@charliermarsh reviewed on 2023-06-12 16:08_

---

_Review comment by @charliermarsh on `crates/ruff/src/jupyter/notebook.rs`:27 on 2023-06-12 16:08_

I think this should be `Result<String>` -- can we remove all the unwraps here?

---

_@dhruvmanila reviewed on 2023-06-12 16:21_

---

_Review comment by @dhruvmanila on `crates/ruff/src/jupyter/notebook.rs`:27 on 2023-06-12 16:21_

The problem is that `Notebook::read` return type is `Result<Self, Box<Diagnostic>>` where the `Diagnostic` doesn't implement the `Error` trait.

---

_@charliermarsh reviewed on 2023-06-12 16:25_

---

_Review comment by @charliermarsh on `crates/ruff/src/jupyter/notebook.rs`:27 on 2023-06-12 16:25_

You should be able to use `map_err`? Something like `Notebook::read(path).map_err(|_| anyhow::anyhow!("Failed to read")` or similar.

---

_Comment by @github-actions[bot] on 2023-06-12 17:40_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      6.8Â±0.01ms     6.0 MB/sec    1.00      6.8Â±0.05ms     6.0 MB/sec
formatter/numpy/ctypeslib.py               1.00   1395.2Â±1.88Âµs    11.9 MB/sec    1.00   1396.0Â±2.88Âµs    11.9 MB/sec
formatter/numpy/globals.py                 1.01    138.5Â±0.39Âµs    21.3 MB/sec    1.00    137.7Â±1.69Âµs    21.4 MB/sec
formatter/pydantic/types.py                1.00      2.8Â±0.01ms     9.2 MB/sec    1.00      2.8Â±0.01ms     9.2 MB/sec
linter/all-rules/large/dataset.py          1.00     14.4Â±0.12ms     2.8 MB/sec    1.01     14.6Â±0.09ms     2.8 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.5Â±0.02ms     4.7 MB/sec    1.01      3.5Â±0.01ms     4.7 MB/sec
linter/all-rules/numpy/globals.py          1.00    364.8Â±1.44Âµs     8.1 MB/sec    1.00    365.9Â±1.30Âµs     8.1 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.1Â±0.02ms     4.2 MB/sec    1.01      6.2Â±0.01ms     4.1 MB/sec
linter/default-rules/large/dataset.py      1.00      7.1Â±0.01ms     5.7 MB/sec    1.01      7.2Â±0.02ms     5.6 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1515.7Â±2.74Âµs    11.0 MB/sec    1.00   1517.8Â±5.24Âµs    11.0 MB/sec
linter/default-rules/numpy/globals.py      1.00    163.0Â±1.23Âµs    18.1 MB/sec    1.00    162.9Â±2.20Âµs    18.1 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.2Â±0.01ms     7.9 MB/sec    1.01      3.3Â±0.01ms     7.8 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      7.5Â±0.08ms     5.4 MB/sec    1.00      7.5Â±0.07ms     5.4 MB/sec
formatter/numpy/ctypeslib.py               1.00  1534.4Â±15.19Âµs    10.9 MB/sec    1.01  1547.0Â±15.82Âµs    10.8 MB/sec
formatter/numpy/globals.py                 1.00    147.6Â±2.69Âµs    20.0 MB/sec    1.01    148.9Â±3.29Âµs    19.8 MB/sec
formatter/pydantic/types.py                1.00      3.1Â±0.08ms     8.3 MB/sec    1.00      3.1Â±0.04ms     8.2 MB/sec
linter/all-rules/large/dataset.py          1.00     15.8Â±0.12ms     2.6 MB/sec    1.03     16.2Â±0.13ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.1Â±0.04ms     4.1 MB/sec    1.02      4.1Â±0.04ms     4.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    485.4Â±6.91Âµs     6.1 MB/sec    1.00    487.6Â±9.74Âµs     6.1 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.9Â±0.06ms     3.7 MB/sec    1.02      7.0Â±0.07ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.00      7.9Â±0.05ms     5.1 MB/sec    1.08      8.5Â±0.08ms     4.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1678.8Â±14.06Âµs     9.9 MB/sec    1.06  1771.8Â±15.22Âµs     9.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    190.8Â±2.43Âµs    15.5 MB/sec    1.04    198.1Â±3.18Âµs    14.9 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.6Â±0.03ms     7.1 MB/sec    1.05      3.8Â±0.04ms     6.7 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_@charliermarsh approved on 2023-06-12 17:50_

---

_Merged by @dhruvmanila on 2023-06-12 17:57_

---

_Closed by @dhruvmanila on 2023-06-12 17:57_

---

_Branch deleted on 2023-06-12 17:57_

---
