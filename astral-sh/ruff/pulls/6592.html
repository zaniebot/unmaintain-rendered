<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Format function and class definitions into a single line if its body is an ellipsis - astral-sh/ruff #6592</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Format function and class definitions into a single line if its body is an ellipsis</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6592">#6592</a>
        opened by <a href="https://github.com/tjkuson">@tjkuson</a>
        on 2023-08-15 10:04
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tjkuson">@tjkuson</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Formats</p>
<pre><code class="language-python">class A:
    ...
</code></pre>
<p>to</p>
<pre><code class="language-python">class A: ...
</code></pre>
<p>Closes #5822.</p>
<h2>Test Plan</h2>
<p><code>cargo test</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @tjkuson on 2023-08-15 10:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-08-15 11:02</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      3.3±0.02ms    12.2 MB/sec    1.00      3.3±0.03ms    12.3 MB/sec
formatter/numpy/ctypeslib.py               1.00    671.3±7.06µs    24.8 MB/sec    1.00    674.7±6.34µs    24.7 MB/sec
formatter/numpy/globals.py                 1.00     69.1±0.39µs    42.7 MB/sec    1.00     69.3±0.43µs    42.6 MB/sec
formatter/pydantic/types.py                1.00  1310.0±13.27µs    19.5 MB/sec    1.01  1324.9±14.02µs    19.2 MB/sec
linter/all-rules/large/dataset.py          1.00     11.1±0.04ms     3.7 MB/sec    1.00     11.1±0.04ms     3.7 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.0±0.01ms     5.5 MB/sec    1.00      3.0±0.03ms     5.5 MB/sec
linter/all-rules/numpy/globals.py          1.03    337.1±1.20µs     8.8 MB/sec    1.00    326.5±1.11µs     9.0 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.8±0.02ms     4.4 MB/sec    1.00      5.8±0.02ms     4.4 MB/sec
linter/default-rules/large/dataset.py      1.02      5.8±0.02ms     7.0 MB/sec    1.00      5.7±0.02ms     7.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01   1208.3±5.44µs    13.8 MB/sec    1.00   1194.0±8.99µs    13.9 MB/sec
linter/default-rules/numpy/globals.py      1.00    124.7±0.44µs    23.7 MB/sec    1.01    125.4±5.41µs    23.5 MB/sec
linter/default-rules/pydantic/types.py     1.01      2.6±0.01ms     9.9 MB/sec    1.00      2.5±0.01ms    10.1 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                    pr
-----                                      ----                                    --
formatter/large/dataset.py                 1.02      4.6±0.28ms     8.8 MB/sec     1.00      4.5±0.20ms     9.0 MB/sec
formatter/numpy/ctypeslib.py               1.02   964.0±67.52µs    17.3 MB/sec     1.00   947.7±44.68µs    17.6 MB/sec
formatter/numpy/globals.py                 1.04     99.4±6.72µs    29.7 MB/sec     1.00     95.5±4.08µs    30.9 MB/sec
formatter/pydantic/types.py                1.01  1937.5±114.58µs    13.2 MB/sec    1.00  1917.2±156.22µs    13.3 MB/sec
linter/all-rules/large/dataset.py          1.00     16.5±0.49ms     2.5 MB/sec     1.01     16.6±0.45ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.5±0.20ms     3.7 MB/sec     1.00      4.5±0.18ms     3.7 MB/sec
linter/all-rules/numpy/globals.py          1.02   569.9±39.92µs     5.2 MB/sec     1.00   560.9±37.18µs     5.3 MB/sec
linter/all-rules/pydantic/types.py         1.02      8.6±0.33ms     3.0 MB/sec     1.00      8.5±0.34ms     3.0 MB/sec
linter/default-rules/large/dataset.py      1.00      9.0±0.30ms     4.5 MB/sec     1.02      9.2±0.36ms     4.4 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1912.2±80.18µs     8.7 MB/sec     1.08      2.1±0.13ms     8.1 MB/sec
linter/default-rules/numpy/globals.py      1.01   228.3±14.48µs    12.9 MB/sec     1.00   225.5±12.04µs    13.1 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.1±0.15ms     6.3 MB/sec     1.01      4.1±0.17ms     6.2 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-15 16:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_class_def.rs</code>:143 on 2023-08-15 16:57</div>
            <div class="timeline-body"><p>I think we need to generalize this logic because black doesn't just apply this to classes and functions but to any compound statement (it seems).</p>
<pre><code class="language-python">while True: ...

for i in []: ...

if True: ...

with True: ...

match x:
    case 1: ...
</code></pre>
<p>We can can take a similar approach as I took in https://github.com/astral-sh/ruff/pull/6593/files#diff-2a7940151585697a7844053afc3fc5c7beafc616a9e1dc49ec4d43b98258dc35 with <code>clause_header</code></p>
<pre><code class="language-rust">pub(crate) struct FormatClauseBody&lt;'a&gt; {
	body: &amp;'a Suite
	kind: SuiteKind,
	trailing_comments: &amp;'a [SourceComment],
}

impl FormatClauseBody {
	#[must_use]
	pub(crate) fn with_kind(mut self, kind: SuiteKind)  -&gt; Self {
		self.kind = kind;
		self
	}
}

pub(crate) fn clause_body(body: &amp;Suite, trailing_colon_comments: &amp;'a [SourceComment]) -&gt; FormatClauseBody {
	FormatClauseBody { body, kind: SuiteKind::default(), trailing_comments }
}

impl Format&lt;PyFormatContext&lt;'_&gt;&gt; or FormatClauseBody&lt;'_&gt; {
  fn fmt(&amp;self, f: &amp;mut Formatter&lt;PyFormatContext&lt;'ast&gt;&gt;) -&gt; FormatResult&lt;()&gt; {
		if f.options().source_type().is_stub() &amp;&amp; contains_only_an_ellipsis(self.body, f.context().comments()) &amp;&amp; self.trailing_comments.is_empty(){
			self.body.format().with_options(self.kind).fmt(f)
		} else {
			self.block_indent(&amp;body.format().with_options(self.kind)).fmt(f)
		}
  }
}
</code></pre>
<p>And I think you have to extend <code>contains_only_an_ellipsis</code> to assert that the <code>...</code> has no comments by using <code>f.context().comments().has_comments(stmt)</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-15 16:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_class_def.rs</code>:143 on 2023-08-15 16:58</div>
            <div class="timeline-body"><p>Oh, it seems <code>has_comments</code> no longer exists on <code>Comments</code>. You can re-introduce it by adding the following method</p>
<pre><code class="language-rust">#[inline]
    pub(crate) fn has_comments&lt;T&gt;(&amp;self, node: T) -&gt; bool
    where
        T: Into&lt;AnyNodeRef&lt;'a&gt;&gt;,
    {
        self.data
            .comments
            .has(&amp;NodeRefEqualityKey::from_ref(node.into()))
    }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @charliermarsh on 2023-08-16 17:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/statement/top_level.pyi</code>:82 on 2023-08-17 06:48</div>
            <div class="timeline-body"><p>Could you add an example with a leading comment too</p>
<pre><code>class EllipsisWithLeadingComment:
	# leading
	... 
</code></pre>
<p>and maybe another with two trailing comments</p>
<pre><code>class EllispsisWithMultipleTrailing: # trailing class comment
	... # trailing ellipsis comment
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/suite.rs</code>:347 on 2023-08-17 06:52</div>
            <div class="timeline-body"><p>I think I was wrong with suggesting <code>has_comments</code>. It should be sufficient to these whether <code>stmt</code> has any leading comments. Let's move the `has_comments check after the match. Looking up comments is more expensive than testing if it is a const ellipsis expression</p>
<pre><code class="language-suggestion">        [Stmt::Expr(stmt @ ast::StmtExpr { value, .. })] =&gt; {
            matches!(
                value.as_ref(),
                Expr::Constant(ast::ExprConstant {
                    value: Constant::Ellipsis,
                    ..
                })
            ) &amp;&amp; !comments.has_leading_comments((stmt)
        }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/suite.rs</code>:518 on 2023-08-17 06:52</div>
            <div class="timeline-body"><p>Nit: Can we move this to <code>caluse.rs</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/suite.rs</code>:480 on 2023-08-17 06:53</div>
            <div class="timeline-body"><p>We'll need a method to set the <code>kind</code> so that <code>class</code> and <code>functions</code> can set the right suite kind.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_class_def.rs</code>:136 on 2023-08-17 06:55</div>
            <div class="timeline-body"><p>It may have been because I incorrectly suggested to use <code>has_comments</code> and we'll need a way to pass the <code>SuiteKind::Class</code> to <code>clause_body</code>, e.g. by adding a <code>with_suite_kind</code> method to it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2023-08-17 06:57</div>
            <div class="timeline-body"><p>This starts to looking good. I left a few comments that hopefully help to solve the TODOs. We have to use the new <code>clause_body</code> everywhere where we do <code>block_indent(&amp;body.format())</code> today (all compound statements). But we can do this once the class and function formatting is stable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tjkuson">@tjkuson</a> reviewed on 2023-08-18 11:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/tjkuson">@tjkuson</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/statement/top_level.pyi</code>:82 on 2023-08-18 11:39</div>
            <div class="timeline-body"><p>Black fails to format that first example. What should ruff do?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @tjkuson on 2023-08-18 11:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-18 11:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/statement/top_level.pyi</code>:82 on 2023-08-18 11:59</div>
            <div class="timeline-body"><p>We should keep the first example as is (not collapse the <code>...</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-18 12:28</div>
            <div class="timeline-body"><p>Wow, nice work. This shoots our typeshed compatibility up by more than 20%</p>
<p>project | similarity index before | after
-- | -- | --
cpython | 0.75473 | 0.75473
django | 0.99805 | 0.99805
transformers | 0.99620 | 0.99620
twine | 0.99876 | 0.99876
typeshed | 0.74292 | 0.99953
warehouse | 0.99601 | 0.99601
zulip | 0.99727 | 0.99727</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tjkuson">@tjkuson</a> on 2023-08-18 12:37</div>
            <div class="timeline-body"><p>I'm trying to work out why it formats</p>
<pre><code class="language-python">class EllipsisWithLeadingComment:
	# leading
	... 
</code></pre>
<p>to</p>
<pre><code class="language-python">class EllipsisWithLeadingComment: # leading
...
</code></pre>
<p>Once that's sorted, it should be possible to do the same for every other clause body...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-18 12:54</div>
            <div class="timeline-body"><blockquote>
<p>I'm trying to work out why it formats</p>
<pre><code class="language-python">class EllipsisWithLeadingComment:
  # leading
  ... 
</code></pre>
<p>to</p>
<pre><code class="language-python">class EllipsisWithLeadingComment: # leading
...
</code></pre>
<p>Once that's sorted, it should be possible to do the same for every other clause body...</p>
</blockquote>
<p>Sounds good. Let me know if you want any help.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @tjkuson on 2023-08-18 13:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @tjkuson on 2023-08-18 13:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tjkuson">@tjkuson</a> on 2023-08-18 15:02</div>
            <div class="timeline-body"><p>The logic for match statements seems different to other compound statements</p>
<pre><code class="language-rust">let mut last_case = first;

for case in cases_iter {
    write!(
        f,
        [block_indent(&amp;format_args!(
            leading_alternate_branch_comments(
                comments.leading(case),
                last_case.body.last(),
            ),
            case.format()
        ))]
    )?;
    last_case = case;
}
</code></pre>
<p>I'm not quite sure how this would with <code>clause_body</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-08-18 15:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_while.rs</code>:46 on 2023-08-18 15:16</div>
            <div class="timeline-body"><p>Do we need to change the formatting for the else case too (line 66):</p>
<pre><code>while True:
	pass
else:
	...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_if.rs</code>:39 on 2023-08-18 15:17</div>
            <div class="timeline-body"><p>We'll need to use <code>clause_body</code> in the <code>else</code> and <code>elif</code> cases too (line 101). Could we add test cases as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_for.rs</code>:67 on 2023-08-18 15:18</div>
            <div class="timeline-body"><p>We'll also need to change the <code>else</code> case on line 88.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-18 15:19</div>
            <div class="timeline-body"><p>Nice, this change is so cool. Thanks for working on it.</p>
<p>Do we need to change the try formatting as well?</p>
<blockquote>
<p>The logic for match statements seems different to other compound statements</p>
</blockquote>
<p>I understand this isn't needed on the <code>match</code> level (that renders the cases), only on the case level. You can find its implementation here</p>
<p>https://github.com/astral-sh/ruff/blob/0cea4975fcfe09716c084c0a18d1b4c4cd9b8f05/crates/ruff_python_formatter/src/other/match_case.rs#L27-L63</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-18 15:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-18 16:31</div>
            <div class="timeline-body"><p>I think the last thing now is to add the handling to the try statement</p>
<p>https://github.com/astral-sh/ruff/blob/0cea4975fcfe09716c084c0a18d1b4c4cd9b8f05/crates/ruff_python_formatter/src/statement/stmt_try.rs#L136-L143</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-08-21 07:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-08-21 07:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-08-29 10:44</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:59:34 UTC
    </footer>
</body>
</html>
