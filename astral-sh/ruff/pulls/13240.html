<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Emit a diagnostic if the value of a starred expression or a `yield from` expression is not iterable - astral-sh/ruff #13240</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Emit a diagnostic if the value of a starred expression or a <code>yield from</code> expression is not iterable</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13240">#13240</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-09-04 12:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-09-04 12:05</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR builds on #13195. It ensures that we emit the <code>not-iterable</code> diagnostic on expressions such as the following:</p>
<pre><code class="language-py">class NotIterable: pass

def foo():
    [*NotIterable()]
    yield from NotIterable()
</code></pre>
<p>The <code>Type::iterate()</code> method is refactored slightly so that it's easier for callers of the method to all emit the same diagnostic: it now accepts a <code>diagnostic_fn</code> callback that emits a diagnostic if the type is not found to be an iterable type.</p>
<p>I deliberately haven't tackled comprehensions in this PR, for two reasons:</p>
<ol>
<li>There's some more complications there</li>
<li>I think @dhruvmanila has been working a lot on comprehensions/there are several TODOs in the code that are assigned to him!</li>
</ol>
<h2>Test Plan</h2>
<p><code>cargo test</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2024-09-04 12:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2024-09-04 12:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2024-09-04 12:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-09-04 12:12</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/alex/redknot-iterables">CodSpeed Performance Report</a></h2>
<h3>Merging #13240 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>alex/redknot-iterables</code> (53cc0a2) with <code>main</code> (46a4573)</sub></p>
<h3>Summary</h3>
<p><code>✅ 32</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-09-04 12:20</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:405 on 2024-09-04 12:21</div>
            <div class="timeline-body"><p>I prefer to avoid passing callback functions whenever possible. It tends to lead to more verbose code and monomorphization.</p>
<p>I wonder if we could use an approach similar to BiomeJS <a href="https://github.com/MichaReiser/biome/blob/98deae6e2409c1f9904356f6a6106e25cf3a89d6/crates/biome_parser/src/parsed_syntax.rs#L31"><code>ParsedSyntax</code></a> which is similar to an <code>Option</code> but with domain-specific helper methods.</p>
<p>For example, we could define</p>
<pre><code class="language-rust">enum ResolvedType&lt;'db&gt; {
	Known(Type&lt;'db&gt;),
	Unknown
}

impl&lt;'db&gt; ResolvedType&lt;'db&gt; {
	pub fn unwrap_with_diagnostic(self, builder: &amp;mut TypeInferenceBuilder, node: AnyNodeRef, rule: &amp;str, message: std::fmt::Arguments) -&gt; Type&lt;'db&gt; {
		match self {
			Known(ty) =&gt; ty,
			Unknown(ty) =&gt; {
				builder.add_diagnostic(node, rule, message);
				Type::Unknown
			}
 	}
  }
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:405 on 2024-09-04 12:24</div>
            <div class="timeline-body"><p>An alternative is that <code>unwrap_with_diagnostic</code> accepts an error builder similar to biomejs. This is fine because the <code>unwrap_with_diagnostic</code> function contains very little code.</p>
<p>This is how it was used in BiomeJS:</p>
<pre><code class="language-rust">parse_any_expression(p).or_add_diagnostic(p, expected_expression);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-09-04 12:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-09-04 12:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:405 on 2024-09-04 12:29</div>
            <div class="timeline-body"><p>Nice, I like the idea of the <code>ResolvedType</code> enum a lot!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-09-04 13:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:495 on 2024-09-04 13:06</div>
            <div class="timeline-body"><p>@MichaReiser this is a bit less generalised than what you suggested but my thinking is that we could easily generalise it in the future when we have a need for it. I'm also happy to do something more generalised now, though, if you prefer!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:476 on 2024-09-04 13:22</div>
            <div class="timeline-body"><p>Nit: I would not call this <code>Result</code> because it isn't a <code>std::result::Result</code>. Maybe <code>IterateType</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:479 on 2024-09-04 13:24</div>
            <div class="timeline-body"><p>I would use an <code>enum</code> here because <code>iterable_ty</code> is misleading when it is actually a non-iterable ty.</p>
<pre><code class="language-rust">enum IterateType&lt;'db&gt; {
	Iterable { element_ty: Type&lt;'db&gt; },
	NonIterable { ty: Type&lt;'db&gt; }
}
</code></pre>
<p>It also makes it more obvious that only one type is used at a time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:405 on 2024-09-04 13:24</div>
            <div class="timeline-body"><p>I think this comment is now outdated.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:429 on 2024-09-04 13:24</div>
            <div class="timeline-body"><p>We no longer need the inner function, now that there's no monomorphization happening in the function</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-09-04 13:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-09-04 13:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:405 on 2024-09-04 13:26</div>
            <div class="timeline-body"><p>thanks, sorry for missing that</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-09-04 13:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:429 on 2024-09-04 13:41</div>
            <div class="timeline-body"><p>I kept the inner function for simplicity and readability, since there are several places where we return early, and it seemed easier with the question mark operator. But it probably doesn't add much any more, you're right.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2024-09-04 14:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-09-04 14:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-09-04 14:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-09-04 15:19</div>
            <div class="timeline-body"><p>I don't much like the callback or the new iteration-specific returned enum. What I would prefer is a more general inference-context object that gets passed into all inference methods on <code>Type</code> and has the ability to emit a diagnostic. Then <code>iterate</code> itself can emit a consistent diagnostic.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 21:39:02 UTC
    </footer>
</body>
</html>
