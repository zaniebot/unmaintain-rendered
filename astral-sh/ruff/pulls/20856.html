<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Skip eagerly evaluated scopes for attribute storing - astral-sh/ruff #20856</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Skip eagerly evaluated scopes for attribute storing</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20856">#20856</a>
        opened by <a href="https://github.com/Glyphack">@Glyphack</a>
        on 2025-10-14 07:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Glyphack">@Glyphack</a></div>
            <div class="timeline-body">

Summary
<p>Fix <a href="https://github.com/astral-sh/ty/issues/664">astral-sh/ty#664</a></p>
<p>This PR adds support for storing attributes in comprehension scopes (any eager scope.)</p>
<p>For example in the following code we infer type of <code>z</code> correctly:</p>
<pre><code>class C:
    def __init__(self):
        [None for self.z in range(1)]
reveal_type(C().z) # previously [unresolved-attribute] but now shows Unknown | int
</code></pre>
<p>The fix works by adjusting the following logics:</p>
<p>To identify if an attriute is an assignment to self or cls we need to check the scope is a method. To allow comprehension scopes here we skip any eager scope in the check.
Also at this stage the code checks if self or the first method argument is shadowed by another binding that eager scope to prevent this:</p>
<pre><code>class D:
    g: int

class C:
    def __init__(self):
        [[None for self.g in range(1)] for self in [D()]]
reveal_type(C().g) # [unresolved-attribute]
</code></pre>
<p>When determining scopes that attributes might be defined after collecting all the methods of the class the code also returns any decendant scope that is eager and only has eager parents until the method scope.</p>
<p>When checking reachability of a attribute definition if the attribute is defined in an eager scope we use the reachability of the first non eager scope which must be a method. This allows attributes to be marked as reachable and be seen.</p>
<p>There are also which I didn&#x27;t add support for:</p>
<pre><code>class C:
    def __init__(self):
        def f():
            [None for self.z in range(1)]
        f()

reveal_type(C().z) # [unresolved-attribute]
</code></pre>
<p>In the above example we will not even return the comprehension scope as an attribute scope because there is a non eager scope (<code>f</code> function) between the comprehension and the <code>__init__</code> method</p>


Test Plan


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Skip eagerly evaluated scopes for attribute storing&quot; to &quot;[ty] Skip eagerly evaluated scopes for attribute storing&quot; by <a href="https://github.com/Glyphack">@Glyphack</a> on 2025-10-14 07:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-14 07:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-15 19:02</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-15 19:03</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>attrs (https://github.com/python-attrs/attrs)
- tests/test_hooks.py:154:48: error[missing-argument] No argument provided for required parameter `y`
- tests/test_next_gen.py:142:14: error[unresolved-attribute] Object of type `dataclasses.Field` has no attribute `validator`
- tests/test_next_gen.py:380:14: error[unresolved-attribute] Object of type `dataclasses.Field` has no attribute `validator`
- Found 584 diagnostics
+ Found 581 diagnostics

</code></pre>

No memory usage changes detected ✅

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Glyphack">@Glyphack</a> reviewed on 2025-10-15 19:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Glyphack">@Glyphack</a> on <code>crates/ty_python_semantic/src/semantic_index/builder.rs</code>:191 on 2025-10-15 19:34</div>
            <div class="timeline-body"><p>This function is also used at https://github.com/Glyphack/ruff/blob/8d53802bc7e9566a9087fd3e3a460345e40a7e6d/crates/ty_python_semantic/src/semantic_index/builder.rs#L1681 and I think this new behavior should be there as well.
I&#x27;m not happy with the name though, this now returns either method or an eager child scope of the class.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/Glyphack">@Glyphack</a> on 2025-10-15 19:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/Glyphack">@Glyphack</a> on 2025-10-15 19:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/Glyphack">@Glyphack</a> on 2025-10-15 19:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/Glyphack">@Glyphack</a> on 2025-10-15 19:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/Glyphack">@Glyphack</a> on 2025-10-15 19:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Glyphack">@Glyphack</a> on 2025-10-15 19:39</div>
            <div class="timeline-body"><p>There is no ecosystem change detected by mypy primer? With the amount of custom logic added I expected to have more effect. Do you think I should simplify the logic even more since there&#x27;s not much impact?</p>
<p>Other solution could be only support children eager scopes and don&#x27;t go into decendants. This would turn a lot of loops into if statements.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-16 08:15</div>
            <div class="timeline-body"><blockquote>
<p>There is no ecosystem change detected by mypy primer? With the amount of custom logic added I expected to have more effect. Do you think I should simplify the logic even more since there&#x27;s not much impact?</p>
</blockquote>
<p>I would expect the impact to be bigger when combined with type-of-<code>self</code>-in-method bodies, no? Maybe we could test that opening a draft PR that merges both. Not strictly necessary though.</p>
<blockquote>
<p>Other solution could be only support children eager scopes and don&#x27;t go into decendants. This would turn a lot of loops into if statements.</p>
</blockquote>
<p>I don&#x27;t really see a reason not to support that if you already implemented it correctly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-16 08:16</div>
            <div class="timeline-body"><p>Thank you for working on this? Could you please also add some tests with generic methods like described <a href="https://github.com/astral-sh/ty/issues/664#issuecomment-3380666555">here</a>? I&#x27;d like to see that we correctly skip the type params scope when detecting methods in classes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/AlexWaygood">@AlexWaygood</a> removed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-16 08:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Glyphack">@Glyphack</a> on 2025-10-16 15:10</div>
            <div class="timeline-body"><p>Thanks. I didn&#x27;t think of the impact there, I was still hoping to reduce the false positives like <a href="https://play.ty.dev/5f89a8f7-2d3e-456e-82e5-c6be2c9fbe62">this</a>. So let&#x27;s keep the current implementation.</p>
<p>I went over the tests again added more examples of what is supported.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-22 15:00</div>
            <div class="timeline-body"><p>I merged this branch into the type-of-self PR and compared it with the type-of-self PR alone. This seems to remove 4 diagnostics from the ecosystem:</p>
<p>type-of-self:</p>
<p><img alt="image" src="https://github.com/user-attachments/assets/09926e07-ce6e-46c2-877c-5deee16b2242"></p>
<p>type-of-self + this:</p>
<p><img alt="image" src="https://github.com/user-attachments/assets/dd1bda6a-4a84-4e70-8ca6-016a3144418d"></p>
<p>I did this to evaluate whether I need to prioritize this, or if it can land separately afterwards. After seeing these results, I&#x27;m going with the latter.</p>
<p>But we&#x27;ll come back to this eventually.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-11-06 14:18</div>
            <div class="timeline-body"><p>Just rebased this (and updated some tests) to get an updated ecosystem report.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/attributes.md</code>:454 on 2025-11-06 15:14</div>
            <div class="timeline-body"><p>It&#x27;s not totally clear to me if this is the right behavior or not. We can&#x27;t guarantee that these attributes will ever be initialized. We can definitely say that they <em>might</em> be.</p>
<p>For reference, this behavior <a href="https://pyright-play.net/?pyrightVersion=1.1.405&amp;strict=true&amp;code=GYJw9gtgBALgngBwJYDsDmUkQWEMogCmAboQIYA2A%2BvAoQFD0DGFZAzm1AMIBc9UAqABNCwKFSqokMCQAo2hCsACUfQeuGiowWav4aDAYiiEQ4EDygBtAK4oibMBVJCAtGRgwQSAEY2YhAC6%2BgbqVgB0kdq4UApK4WSYKNYAjIHBIRoiYmi6aqHqxqbmlrb2hI7OhG4eXr7%2BQZkFEVHAMXHA4T5JqemMBbnKjESklDSIhLJcuglDI%2BTUtJPTyl1zJAvjdFMzTMpAA">matches pyright</a>. <a href="https://mypy-play.net/?mypy=latest&amp;python=3.12&amp;gist=fe330769b4d8a148d2c801648eca02fb">Mypy</a> finds both attributes and gives them type <code>Any</code>. <a href="https://pyrefly.org/sandbox/?project=N4IgZglgNgpgziAXKOBDAdgEwEYHsAeAdAA4CeS4ATrgLYAEALqcROgOZ0Q3G6UN2UYANxiooAfSbEYAHXRyAxlFRw4dAMKI5dHXUwwwdceNYQGxgBRwYUMAEot6Xc70G6YCw%2B0ufAYjowlNSUiHQA2gCu6IJwuFAimAC0qAwMlBDYEQwwALrePs5hhMXuvHTWtoSonE5hAIw5efJOBfqGbJ6OBS7%2BgcGhkdHwcQnJqemZ2U3dhcWEpZTlNmCE2DXhDU35Lh12cnKCImKSzDAW6p5Ve0NHElJnF3ar14eid6fnlwrXIAA0IFloHASORECB-ABVBjQMykdxRBTQ3DoOD7LBuMC8GgpcToCI0bCBCz4UKsBh2OiJAB85TSXV0ggYEUoTjAMhAADl8YSQnRgPgAL7suR-EBkQRgKCkQgMWhQCj%2BAAKpAlUvKGBwBDoCmRkDYzJSEGRhDk-gAyjAYHQABapYhwRAAekd4oMUsIvDYjpg6EdmFwCjgjp16D1BqRvoWdFQQlQ0FQ2Fg2t1EH1lENyLouGIEeBcjIDGtyMSIkocCNTgAvHR2QBmQh1ABMwvQIAF-1QiIgIgAYtAYBQ0Fg8EQyG2gA">Pyrefly</a> finds both attributes and gives them type <code>int</code>. No type checker attempts to distinguish these cases based on trying to determine whether the nested function is ever called; this is quite complex to do in general and I doubt we should attempt it either.</p>
<p>Overall I think the current behavior in this PR is fine and this case is probably rare (and it doesn&#x27;t show up in the ecosystem report.) I don&#x27;t think we need TODOs to revisit it; we&#x27;ll revisit it only if there are real user reports.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/attributes.md</code>:452 on 2025-11-06 15:17</div>
            <div class="timeline-body"><p>I don&#x27;t think we need a TODO specifically here, because I don&#x27;t think we will ever attempt to distinguish <code>f()</code> / <code>self.a</code> from <code>g()</code> / <code>self.b</code> here, based on call-graph analysis.</p>
<pre><code></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/semantic_index/builder.rs</code>:192 on 2025-11-06 15:31</div>
            <div class="timeline-body"><pre><code>    /// Returns the scope ID of the current scope if the current scope
    /// is a method inside a class body or an eagerly executed scope inside a method.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/semantic_index.rs</code>:1231 on 2025-11-06 15:42</div>
            <div class="timeline-body"><p>It&#x27;s not clear to me that this test and the below test couldn&#x27;t be equally effective as mdtests (and/or aren&#x27;t already effectively duplicated by mdtests in this PR.) But these seem harder to maintain. Do you feel like they are important?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-11-06 15:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Glyphack">@Glyphack</a> reviewed on 2025-11-07 06:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Glyphack">@Glyphack</a> on <code>crates/ty_python_semantic/src/semantic_index.rs</code>:1231 on 2025-11-07 06:57</div>
            <div class="timeline-body"><p>Applied.
I had to change <code>semantic_index.rs</code> to track attributes and adjust the reachability analysis in <code>class.rs</code>. During development I used this test to ensure the <code>semantic_index</code> logic was working fine and then updated the other file at that point I didn&#x27;t know how to validate it with an mdtest. So now that we have the full implementation we can get rid of this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Glyphack">@Glyphack</a> reviewed on 2025-11-07 07:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Glyphack">@Glyphack</a> on <code>crates/ty_python_semantic/resources/mdtest/attributes.md</code>:454 on 2025-11-07 07:05</div>
            <div class="timeline-body"><p>I haven&#x27;t worked with call graph analysis and didn&#x27;t think about it&#x27;s complexity. If an issue was reported for this I would follow it up.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/carljm">@carljm</a> on 2025-11-11 22:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2025-11-11 22:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-11-11 22:45</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:19:30 UTC
    </footer>
</body>
</html>
