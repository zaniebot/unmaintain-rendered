<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix panic when formatting binary expression with two implicit concatenated string operands - astral-sh/ruff #7287</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix panic when formatting binary expression with two implicit concatenated string operands</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7287">#7287</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-09-12 06:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-12 06:49</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR fixes a panic when formatting a binary like expression where both operands are implicit concatenated strings: <code>&quot;a&quot; &quot;b&quot; + &quot;c&quot; &quot;d&quot;</code></p>
<p>The implementation formats the implicit concatenated string together with the right operator and than continues with the expressions to the right.
The next iteration then tried to format the expressions between the last formatted right operator (<code>+</code>) and the next string concatenation, assuming that it would never be empty.
This assumption was incorrect as the above example demonstrates. There's no other binary like expression between the <code>+</code> and <code>&quot;c&quot; &quot;d&quot;</code>.</p>
<p>This PR fixes this by skipping the formatting of the left side if the last operator is the same as the left operator of this implicit concatenated string.</p>
<p>Closes #7245</p>
<h2>Test Plan</h2>
<p>Added tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-12 06:50</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #7287</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7287" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7287?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @MichaReiser on 2023-09-12 06:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2023-09-12 06:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-09-12 07:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-09-12 07:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-09-12 07:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-09-12 07:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-12 11:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/expression/binary_like.rs</code>:323 on 2023-09-12 11:30</div>
            <div class="timeline-body"><p>I don't know if it matters, but doesn't this mean that the right side of <code>&quot;a&quot; &quot;b&quot; + &quot;c&quot; &quot;d&quot;</code> will be formatted using the right-side formatting logic, which doesn't include the <code>with_layout(StringLayout::ImplicitConcatenatedStringInBinaryLike)</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-12 11:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/binary_like.rs</code>:323 on 2023-09-12 11:39</div>
            <div class="timeline-body"><p>The implicit string formatting formats <code>left_operand</code> (optional) <code>left_operator</code> <code>implicit_concat</code> <code>right_operator</code>.</p>
<p>So for, <code>a + &quot;b&quot; &quot;c&quot; * &quot;d&quot; &quot;e&quot;</code> it formats <code>a</code>, <code>+</code>, <code>&quot;b&quot; &quot;c&quot;</code> and <code>*</code>. The right side of <code>*</code> gets formatted as part of the next implicit concatenated string.</p>
<p>https://github.com/astral-sh/ruff/blob/1e6df19a351170ded4b1e1a4e068993107bd1047/crates/ruff_python_formatter/src/expression/binary_like.rs#L393-L431</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-12 11:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/expression/binary_like.rs</code>:323 on 2023-09-12 11:48</div>
            <div class="timeline-body"><p>Ohh it only formats right <em>operator</em>, okay, got it, thank you. This is what was blocking me last night :D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-12 12:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/binary_like.rs</code>:323 on 2023-09-12 12:05</div>
            <div class="timeline-body"><p>Yes, it only formats the right operator, but starts a group that includes the right operand (without formatting it)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 02:39:46 UTC
    </footer>
</body>
</html>
