<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track symbol deletions separately from bindings - astral-sh/ruff #4888</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Track symbol deletions separately from bindings</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4888">#4888</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-06-06 01:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>#4746 revealed some subtle issues related to Python&#x27;s handling of <code>nonlocal</code>. If you use <code>nonlocal</code>, and the non-local symbol isn&#x27;t declared in the parent scope, Python raises a syntax error at parse time (!). However, I didn&#x27;t realize that, for the purpose of declarations, Python will respect a <code>del</code> statement -- so this works fine:</p>
<pre><code>def f():
    def g():
        nonlocal x

    del x
</code></pre>
<p>Previously, to determine whether the symbol was declared in the parent scope, we checked if the symbol was <em>bound</em> in the parent scope. But we don&#x27;t create bindings for deletions, and in fact, we remove any existing bindings when we hit a deletion.</p>
<p>This PR thus modifies <code>Scope</code> to track all deleted symbols, so that we can ask the scope whether the symbol should be considered &quot;declared&quot; for the purpose of <code>nonlocal</code> analysis.</p>
<p>Closes #4746.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-06 01:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_semantic/src/scope.rs</code>:27 on 2023-06-06 01:30</div>
            <div class="timeline-body"><p>This might be a bit of a heavy-handed change just to fix this one semantic issue... E.g., we could instead track <code>deleted_names</code>, and make <code>declares</code> something like <code>self.has(name) || self.deletions.contains(name)</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-06 01:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_semantic/src/scope.rs</code>:27 on 2023-06-06 01:32</div>
            <div class="timeline-body"><p>(We could also track <code>HashMap&lt;&amp;&#x27;a str, SymbolId&gt;</code>, and make <code>bindings: FxHashMap&lt;SymbolId, BindingId&gt;</code>.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-06 01:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-06-06 02:08</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>â„¹ï¸ ecosystem check <strong>detected changes</strong>. (+0, -1, 0 error(s))</p>
airflow (+0, -1)
<p>

<pre><code>- tests/decorators/test_task_group.py:108:18: PLE0117 Nonlocal name `tgp` found without binding
</code></pre>
</p>

Rules changed: 1

<p>| Rule | Changes | Additions | Removals |
| ---- | ------- | --------- | -------- |
| PLE0117 | 1 | 0 | 1 |</p>
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.10      6.5Â±0.02ms     6.3 MB/sec    1.00      5.9Â±0.02ms     6.9 MB/sec
formatter/numpy/ctypeslib.py               1.07   1297.3Â±1.98Âµs    12.8 MB/sec    1.00   1211.6Â±2.78Âµs    13.7 MB/sec
formatter/numpy/globals.py                 1.05    143.7Â±3.88Âµs    20.5 MB/sec    1.00    137.0Â±0.29Âµs    21.5 MB/sec
formatter/pydantic/types.py                1.08      2.8Â±0.00ms     9.1 MB/sec    1.00      2.6Â±0.01ms     9.8 MB/sec
linter/all-rules/large/dataset.py          1.01     14.1Â±0.07ms     2.9 MB/sec    1.00     13.9Â±0.06ms     2.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.4Â±0.00ms     5.0 MB/sec    1.00      3.4Â±0.01ms     5.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    413.7Â±0.78Âµs     7.1 MB/sec    1.00    414.4Â±0.84Âµs     7.1 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.9Â±0.03ms     4.3 MB/sec    1.00      5.9Â±0.03ms     4.4 MB/sec
linter/default-rules/large/dataset.py      1.00      6.8Â±0.02ms     6.0 MB/sec    1.00      6.8Â±0.01ms     6.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01   1468.7Â±4.74Âµs    11.3 MB/sec    1.00   1461.3Â±4.81Âµs    11.4 MB/sec
linter/default-rules/numpy/globals.py      1.01    163.5Â±0.44Âµs    18.0 MB/sec    1.00    161.7Â±0.25Âµs    18.2 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.0Â±0.01ms     8.4 MB/sec    1.00      3.0Â±0.00ms     8.4 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01      8.6Â±0.27ms     4.7 MB/sec    1.00      8.5Â±0.24ms     4.8 MB/sec
formatter/numpy/ctypeslib.py               1.00  1732.9Â±63.90Âµs     9.6 MB/sec    1.01  1753.6Â±73.40Âµs     9.5 MB/sec
formatter/numpy/globals.py                 1.00    196.5Â±9.47Âµs    15.0 MB/sec    1.00   196.7Â±13.69Âµs    15.0 MB/sec
formatter/pydantic/types.py                1.00      3.8Â±0.10ms     6.8 MB/sec    1.01      3.8Â±0.15ms     6.8 MB/sec
linter/all-rules/large/dataset.py          1.01     20.6Â±0.49ms  2018.8 KB/sec    1.00     20.4Â±0.39ms  2038.6 KB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      5.1Â±0.14ms     3.3 MB/sec    1.00      5.1Â±0.17ms     3.3 MB/sec
linter/all-rules/numpy/globals.py          1.02   604.7Â±24.19Âµs     4.9 MB/sec    1.00   595.1Â±22.40Âµs     5.0 MB/sec
linter/all-rules/pydantic/types.py         1.00      8.6Â±0.24ms     3.0 MB/sec    1.00      8.6Â±0.27ms     3.0 MB/sec
linter/default-rules/large/dataset.py      1.00     10.1Â±0.23ms     4.0 MB/sec    1.00     10.1Â±0.25ms     4.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01      2.2Â±0.18ms     7.7 MB/sec    1.00      2.1Â±0.08ms     7.8 MB/sec
linter/default-rules/numpy/globals.py      1.01   243.5Â±11.40Âµs    12.1 MB/sec    1.00   241.9Â±12.28Âµs    12.2 MB/sec
linter/default-rules/pydantic/types.py     1.02      4.6Â±0.24ms     5.5 MB/sec    1.00      4.5Â±0.16ms     5.6 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Boshen">@Boshen</a> reviewed on 2023-06-06 06:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Boshen">@Boshen</a> on <code>crates/ruff_python_semantic/src/scope.rs</code>:27 on 2023-06-06 06:41</div>
            <div class="timeline-body"><p>I&#x27;m having a hard time comprehending the difference between a <code>declared_symbol</code> vs a <code>binding</code> based on their names and comments alone ğŸ¤¯</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-06-06 07:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_semantic/src/scope.rs</code>:27 on 2023-06-06 13:39</div>
            <div class="timeline-body"><p>I&#x27;m going to rewrite this to special-case deletions. I need to reconsider deletions more holistically.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-06 13:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_semantic/src/scope.rs</code>:77 on 2023-06-06 15:26</div>
            <div class="timeline-body"><p>Would it make sense to instead <em>mark</em> the binding as deleted? I assume that causes some downstream problems because a lot of code freely access the bindings directly, so there isn&#x27;t a good way for us to hide deleted bindings. I&#x27;m mainly asking because I&#x27;m a bit worried about registering all bindings in two separate <code>HashMaps</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_semantic/src/scope.rs</code>:23 on 2023-06-06 15:29</div>
            <div class="timeline-body"><p>How is <code>declared_symbols</code> different from <code>bindings</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_semantic/src/scope.rs</code>:23 on 2023-06-06 15:30</div>
            <div class="timeline-body"><p>Would it make sense to instead track deleted <code>symbol</code>s, considering that deletions are rare (so that the vec is empty 99% of the cases)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-06 15:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_semantic/src/scope.rs</code>:23 on 2023-06-06 16:56</div>
            <div class="timeline-body"><p>Yes, I did that initially. I&#x27;m going to revert to that state.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-06 16:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-06 16:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_semantic/src/scope.rs</code>:23 on 2023-06-06 16:56</div>
            <div class="timeline-body"><p>This is defined on the relevant method docstrings (<code>declares</code> vs. <code>has</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-06 16:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_semantic/src/scope.rs</code>:77 on 2023-06-06 16:57</div>
            <div class="timeline-body"><p>This actually isn&#x27;t sufficient, because this needs to be considered valid (for the purpose of the <code>nonlocal</code> rule):</p>
<pre><code>def f():
    del x

    def g():
        nonlocal x
</code></pre>
<p><code>del x</code> adds <code>x</code> to the symbol table, but doesn&#x27;t bind it to the value (or something like that -- I don&#x27;t have the terminology nailed down).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Track symbol declarations separately from bindings&quot; to &quot;Track symbol deletions separately from bindings&quot; by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-06 18:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-06 18:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-06 18:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-06-06 18:49</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:54:16 UTC
    </footer>
</body>
</html>
