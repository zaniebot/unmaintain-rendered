<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix infinite loop due to rules `D207` &amp; `W605` - astral-sh/ruff #3609</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix infinite loop due to rules <code>D207</code> &amp; <code>W605</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/3609">#3609</a>
        opened by <a href="https://github.com/vlindhol">@vlindhol</a>
        on 2023-03-19 15:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/vlindhol">@vlindhol</a></div>
            <div class="timeline-body"><p>Closes #3522</p>
Issue addressed
<p>Given the following example case:</p>
<pre><code>class A:
    &quot;&quot;&quot;
\ a
    &quot;&quot;&quot;
</code></pre>
<p>With the config:</p>
<pre><code>select = [
  &quot;D207&quot;, # bad docstring indentation
  &quot;W605&quot;, # invalid escape sequence
]
</code></pre>
<p>Those two rules clash when autofixing, creating an infinite loop:</p>
<ol>
<li><code>W605</code> schedules an insertion of a <code>\</code> at column 0</li>
<li><code>D207</code> schedules an insertion of <code>....</code> (four spaces) at column 0</li>
<li>End result: <code>\ a</code> -&gt; <code>\</code> + <code>    </code> + <code>\ a</code> -&gt; <code>\    \ a</code></li>
<li>GOTO 1</li>
</ol>
Solution
<p>The culprit is the fairly simplistic way that &quot;fix overlaps&quot; are calculated.</p>
<ol>
<li>Firstly, add an explicit ordering of the rules so that they are applied
in an order that doesn&#x27;t break the intent (i.e. FIRST indent, THEN fix
the escape sequence.</li>
<li>For future, similar clashes: make <code>W605</code> insert the second <code>\</code> AFTER the
first one, rather than BEFORE. This marks one more character in the code
as &quot;dirty&quot;, postponing other fixes in that same column for the next
autofix iteration.</li>
</ol>
Test plan
<ul>
<li>[ ] ~~Add a new test covering this pathological case. (TODO: how?)~~</li>
<li>[x] Test manually that the above example now gets fixed correctly.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/vlindhol">@vlindhol</a> on 2023-03-19 16:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/vlindhol">@vlindhol</a> on 2023-03-19 16:01</div>
            <div class="timeline-body"><p>I would like to add a test that tests the interplay between these two rules, but not sure where to put it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-03-19 16:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/pycodestyle/rules/invalid_escape_sequence.rs</code>:119 on 2023-03-19 16:05</div>
            <div class="timeline-body"><p>It might <em>also</em> be possible to fix this by giving one rule precedence in <code>crates/ruff/src/autofix/mod.rs#cmp_fix</code>, so that we apply the fixes in a specific order even when they&#x27;re anchored to the same code point. But, what you have here is good too, arguably better.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-19 16:06</div>
            <div class="timeline-body"><blockquote>
<p>I would like to add a test that tests the interplay between these two rules, but not sure where to put it?</p>
</blockquote>
<p>Hmm, yeah, there&#x27;s not a natural place for this since it cuts across categories. But, the best I can think of is a dedicated test in <code>crates/ruff/src/rules/ruff/mod.rs</code>!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-03-19 16:12</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>✅ ecosystem check detected no changes.</p>
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     19.1±0.55ms     2.1 MB/sec    1.00     19.1±0.42ms     2.1 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.8±0.18ms     3.5 MB/sec    1.02      4.9±0.12ms     3.4 MB/sec
linter/all-rules/numpy/globals.py          1.00   649.7±17.71µs     4.5 MB/sec    1.03   668.8±26.35µs     4.4 MB/sec
linter/all-rules/pydantic/types.py         1.00      8.3±0.20ms     3.1 MB/sec    1.02      8.4±0.18ms     3.0 MB/sec
linter/default-rules/large/dataset.py      1.00     10.2±0.22ms     4.0 MB/sec    1.00     10.2±0.32ms     4.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00      2.2±0.12ms     7.5 MB/sec    1.03      2.3±0.09ms     7.3 MB/sec
linter/default-rules/numpy/globals.py      1.00    259.4±7.65µs    11.4 MB/sec    1.07   278.6±43.87µs    10.6 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.7±0.20ms     5.4 MB/sec    1.00      4.7±0.12ms     5.4 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     14.7±0.28ms     2.8 MB/sec    1.03     15.1±0.10ms     2.7 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.0±0.07ms     4.1 MB/sec    1.02      4.1±0.06ms     4.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    524.0±4.28µs     5.6 MB/sec    1.03    538.6±3.44µs     5.5 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.6±0.04ms     3.9 MB/sec    1.03      6.7±0.06ms     3.8 MB/sec
linter/default-rules/large/dataset.py      1.00      8.0±0.04ms     5.1 MB/sec    1.05      8.4±0.04ms     4.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1790.3±14.96µs     9.3 MB/sec    1.04  1867.5±15.72µs     8.9 MB/sec
linter/default-rules/numpy/globals.py      1.00    199.1±2.50µs    14.8 MB/sec    1.07    212.1±8.02µs    13.9 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.8±0.04ms     6.8 MB/sec    1.03      3.9±0.03ms     6.5 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/vlindhol">@vlindhol</a> reviewed on 2023-03-19 16:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/vlindhol">@vlindhol</a> on <code>crates/ruff/src/rules/pycodestyle/rules/invalid_escape_sequence.rs</code>:119 on 2023-03-19 16:14</div>
            <div class="timeline-body"><p>Good callout! <code>cmp_fix</code> wasn&#x27;t there when I forked the repo, I&#x27;ll make a change there as well, that potentially saves us an autofix iteration. Think I&#x27;ll still keep my &quot;insert at column 1&quot; change, might help with other rules clashing in a similar way.</p>
<p>I was thinking of how to make the overlap logic more robust, but didn&#x27;t come up with anything yet. Need to get the hang of the codebase a bit more I think :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/vlindhol">@vlindhol</a> on 2023-03-19 16:51</div>
            <div class="timeline-body"><blockquote>
<p>Hmm, yeah, there&#x27;s not a natural place for this since it cuts across categories. But, the best I can think of is a dedicated test in <code>crates/ruff/src/rules/ruff/mod.rs</code>!</p>
</blockquote>
<p>I gave it a shot, but couldn&#x27;t quite think of an elegant way of testing it without pulling in half the world or reimplementing the rules in the test, which kinda defeats the purpose. My Rust skills are not great, I&#x27;m contributing here to get better :)</p>
<p>Anyway, gave up on the test for now! My intuition says that for nice testability it should be easier to compose the rules. E.g. the <code>indent</code> rule takes the entire <code>Checker</code> object as a param, and checks if the rules are enabled from within the rule body. Itching to refactor that, but then again I&#x27;m not confident enough in the codebase to do that, and maybe it kills performance as well?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/vlindhol">@vlindhol</a> on 2023-03-19 17:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/vlindhol">@vlindhol</a> on 2023-03-19 17:24</div>
            <div class="timeline-body"><p>Not super stoked about the performance hit either... I&#x27;m guessing it&#x27;s the added <code>match</code> case in the rule sorting?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-03-19 17:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/autofix/mod.rs</code>:105 on 2023-03-19 17:49</div>
            <div class="timeline-body"><p>I think we can omit this for now if we&#x27;re gonna go with the other fix. I&#x27;d like to avoid these special-cases to the degree that we can.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-19 17:50</div>
            <div class="timeline-body"><p>Sounds good. It&#x27;s possible that the performance hit is noise, I&#x27;m surprised by it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/vlindhol">@vlindhol</a> on <code>crates/ruff/src/autofix/mod.rs</code>:105 on 2023-03-19 18:19</div>
            <div class="timeline-body"><p>Will do!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/vlindhol">@vlindhol</a> reviewed on 2023-03-19 18:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/vlindhol">@vlindhol</a> on 2023-03-19 18:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-19 18:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-19 18:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-19 18:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-03-19 18:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-19 18:35</div>
            <div class="timeline-body"><p>Rock on, thank you! If you&#x27;re interested in more good issues let me know :)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:52:52 UTC
    </footer>
</body>
</html>
