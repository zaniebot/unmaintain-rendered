<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[syntax-errors]: import from * only allowed at module scope (F406) - astral-sh/ruff #20166</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[syntax-errors]: import from * only allowed at module scope (F406)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20166">#20166</a>
        opened by <a href="https://github.com/11happy">@11happy</a>
        on 2025-08-30 12:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/11happy">@11happy</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff/ty! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title? (Please prefix with `[ty]` for ty pull
  requests.)
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>This PR implements F406 https://docs.astral.sh/ruff/rules/undefined-local-with-nested-import-star-usage/ as a semantic syntax error</p>
<h2>Test Plan</h2>
<p>I have written inline tests as directed in #17412</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @11happy on 2025-08-30 12:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @11happy on 2025-08-30 12:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "F406" to "[syntax-errors]: import from * only allowed at module scope" by @11happy on 2025-08-30 12:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[syntax-errors]: import from * only allowed at module scope" to "[syntax-errors]: import from * only allowed at module scope (F406)" by @11happy on 2025-08-30 12:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @11happy on 2025-09-01 15:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @11happy on 2025-09-01 15:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @11happy on 2025-09-01 15:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @11happy on 2025-09-01 15:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/11happy">@11happy</a> on 2025-09-01 15:27</div>
            <div class="timeline-body"><p>I have fixed the md file test which was causing CI to fail.</p>
<p>Thank you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-02 13:16</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @carljm on 2025-09-02 17:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @dhruvmanila on 2025-09-03 04:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:73 on 2025-09-03 04:34</div>
            <div class="timeline-body"><p>Let's add a few more test cases like including it in class scope, module scope, etc. to check both the error and non-error case. The non-error case would need to go under <code>test_ok</code> (instead of <code>test_err</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-09-03 04:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/11happy">@11happy</a> reviewed on 2025-09-04 16:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/11happy">@11happy</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:73 on 2025-09-04 16:08</div>
            <div class="timeline-body"><p>done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/11happy">@11happy</a> on 2025-09-04 16:12</div>
            <div class="timeline-body"><p>have resolved the merge conflict as well.
Thank you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/11happy">@11happy</a> on 2025-09-07 16:13</div>
            <div class="timeline-body"><p>Hii @ntBre, would appreciate your feedback on this when you get a chance.
Thank you : )</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:663 on 2025-09-12 17:14</div>
            <div class="timeline-body"><p>I know this is the name of the lint rule, but I think it would make sense to rename the syntax error to something like <code>LocalImportStar</code> or <code>NonModuleImportStar</code>. For the purpose of the syntax error, we don't actually care about the <code>undefined-local</code> part, it's still a syntax error even with no local variables:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; def foo():
...     from math import *
...
  File &quot;&lt;python-input-7&gt;&quot;, line 2
    from math import *
                     ^
SyntaxError: import * only allowed at module level
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:73 on 2025-09-12 17:18</div>
            <div class="timeline-body"><p>I see you added a module-scoped test, would you mind throwing in a class scope like Dhruv also suggested? It can be part of the same <code>test_err</code> block as the function:</p>
<pre><code class="language-rust">// test_err import_from_star
// def f():
//     from module import *
// class C:
//     from module import *
</code></pre>
<p>I think that will cover all of the scopes where you can actually have an import statement.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:80 on 2025-09-12 17:26</div>
            <div class="timeline-body"><p>I guess we don't have any tests covering this, but this looks very different from the code used in the lint rule:</p>
<p>https://github.com/astral-sh/ruff/blob/f507ff8cd036fd2d7ab8ad13f1a207555bc7596d/crates/ruff_linter/src/checkers/ast/analyze/statement.rs#L815-L820</p>
<p>Should we be using <code>format_import_from</code> again here?</p>
<p>For an example test, the <code>level</code> argument for this would be 3:</p>
<pre><code class="language-py">from ...math import *
</code></pre>
<p>I think without the helper function we would format that as just <code>math</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-09-12 17:34</div>
            <div class="timeline-body"><p>Thanks, this looks good overall, just a few smaller suggestions. While we're here, can we also update this comment:</p>
<p>https://github.com/astral-sh/ruff/blob/f507ff8cd036fd2d7ab8ad13f1a207555bc7596d/crates/ruff_linter/src/checkers/ast/analyze/unresolved_references.rs#L16-L22</p>
<p>I was getting confused about this other case of F406 we're not handling, but I finally realized that the comment is just wrong. It should say <code>F405</code>, which is not a syntax error.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/11happy">@11happy</a> reviewed on 2025-09-13 13:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/11happy">@11happy</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:663 on 2025-09-13 13:34</div>
            <div class="timeline-body"><p>done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/11happy">@11happy</a> reviewed on 2025-09-13 13:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/11happy">@11happy</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:80 on 2025-09-13 13:35</div>
            <div class="timeline-body"><p>yes , I checked without helper function it was just math, I have used helper function likewise.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/11happy">@11happy</a> reviewed on 2025-09-13 13:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/11happy">@11happy</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:73 on 2025-09-13 13:38</div>
            <div class="timeline-body"><p>done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:79 on 2025-09-15 22:59</div>
            <div class="timeline-body"><p>Would you mind adding one more test? <code>from module import *, *</code> is already a separate syntax error, but I'm wondering how many <code>NonModuleImportStar</code> errors we should emit in this case. We don't emit any <code>F406</code>s because the <code>Star import must be the only import</code> error is a parse error, but the interaction between the two syntax errors will be interesting in the future when we make <code>F406</code> a syntax error.</p>
<p>With the <code>break</code> on line 90, I think we'll only emit one <code>NonModuleImportStar</code> and one parse error, which seems reasonable to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-09-15 23:00</div>
            <div class="timeline-body"><p>Thank you! This looks great to me. I just had one more test idea for a future edge case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @MichaReiser removed by @ntBre on 2025-09-15 23:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @ntBre on 2025-09-15 23:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @ntBre on 2025-09-15 23:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dcreager removed by @ntBre on 2025-09-15 23:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/11happy">@11happy</a> reviewed on 2025-09-15 23:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/11happy">@11happy</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:79 on 2025-09-15 23:17</div>
            <div class="timeline-body"><p>done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-09-16 19:49</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @ntBre on 2025-09-16 19:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-09-16 19:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-09-16 19:53</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:15:26 UTC
    </footer>
</body>
</html>
