<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test to prevent continious reformatting when used together with black - astral-sh/ruff #1206</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Test to prevent continious reformatting when used together with black</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/1206">#1206</a>
        opened by <a href="https://github.com/squiddy">@squiddy</a>
        on 2022-12-12 07:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/squiddy">@squiddy</a> on 2022-12-12 07:20</div>
            <div class="timeline-body"><p>Runs the sequence <code>ruff -&gt; black -&gt; ruff</code> against all test fixtures and fails when that sequence is not stable.</p>
<p>Pretty slow right now and it should probably run against a specific version of black. Would like to get some guidance here on how best to approach that.</p>
<ul>
<li>[x] run against specific version of black</li>
<li>[x] skip test cases that (intentionally) trigger parser issues (E999.py)</li>
<li>[x] make fast enough?</li>
<li>[x] setup black to make CI work</li>
</ul>
<hr />
<p>This did turn up a bug:</p>
<p>When running ruff against</p>
<pre><code class="language-python">_ = lambda x: setattr(x, &quot;bar&quot;, 1)
</code></pre>
<p>with everything enabled, this produces</p>
<pre><code class="language-python">def _(x):
    return x.bar = 1
</code></pre>
<p>which is invalid syntax.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andersk">@andersk</a> on 2022-12-12 08:07</div>
            <div class="timeline-body"><p>Repeated invocations of the <code>black</code> script spend most of their time starting up the Python interpreter and importing things. So you can probably make this significantly faster using <a href="https://black.readthedocs.io/en/stable/usage_and_configuration/black_as_a_server.html"><code>blackd</code></a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> reviewed on 2022-12-12 13:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on <code>tests/integration_test.rs</code>:138 on 2022-12-12 13:18</div>
            <div class="timeline-body"><p>Stub files (<code>.pyi</code>) should also be checked.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on <code>tests/integration_test.rs</code>:152 on 2022-12-12 13:34</div>
            <div class="timeline-body"><p>Maybe use this instead.</p>
<pre><code class="language-suggestion">        CheckCategory::iter()
            .map(|category| category.codes().iter().map(AsRef::as_ref).join(&quot;, &quot;))
            .join(&quot;, &quot;)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> reviewed on 2022-12-12 13:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/squiddy">@squiddy</a> on <code>tests/integration_test.rs</code>:138 on 2022-12-12 18:37</div>
            <div class="timeline-body"><p>Thanks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/squiddy">@squiddy</a> reviewed on 2022-12-12 18:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/squiddy">@squiddy</a> on 2022-12-12 18:59</div>
            <div class="timeline-body"><p>In a hurry, so I'll just put it here (another bug):</p>
<pre><code>cargo run resources/test/fixtures/isort/leading_prefix.py --select F,E,W,C90,I,D,UP,N,YTT,ANN,S,BLE,FBT,B,A,C4,T10,ICN,T20,Q,RET,S
IM,TID,ARG,ERA,PGH,PLC,PLE,PLR,PLW --fix
</code></pre>
<p>Produces</p>
<pre><code>
if True:

</code></pre>
<p><em>edit</em> see #1226</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/squiddy">@squiddy</a> reviewed on 2022-12-12 19:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/squiddy">@squiddy</a> on <code>tests/integration_test.rs</code>:152 on 2022-12-12 19:00</div>
            <div class="timeline-body"><p>This is fantastic, thank you. :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/squiddy">@squiddy</a> reviewed on 2022-12-12 19:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/squiddy">@squiddy</a> on <code>tests/integration_test.rs</code>:152 on 2022-12-12 19:00</div>
            <div class="timeline-body"><p>I do exclude RUF codes currently, because those add <code># noqa</code>, but not always at the same run apparantely?!. Need to test that again.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/squiddy">@squiddy</a> on <code>tests/integration_test.rs</code>:152 on 2022-12-13 17:24</div>
            <div class="timeline-body"><p>It's <code>W292</code> (no end of newline) that was causing that. Ruff add a <code>noqa</code> it in the first run, black adds a newline, ruff removes the <code>noqa</code>.</p>
<p>For now I keep excluding RUF.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/squiddy">@squiddy</a> reviewed on 2022-12-13 17:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @squiddy on 2022-12-13 17:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/squiddy">@squiddy</a> on 2022-12-13 17:26</div>
            <div class="timeline-body"><p>Putting this up for final review.</p>
<p>The test surfaced some bugs which are reported. For CI's sake I ignore those fixture files explicitely.</p>
<p>I'm missing some alignment on how to setup the local development environment. Currently the code just assumes <code>blackd</code> is somewhere in <code>$PATH</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/andersk">@andersk</a> on <code>tests/black_compatibility_test.rs</code>:27 on 2022-12-13 19:24</div>
            <div class="timeline-body"><p><code>Ipv4Addr::LOCALHOST</code> is safer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/andersk">@andersk</a> on <code>tests/black_compatibility_test.rs</code>:105 on 2022-12-13 19:27</div>
            <div class="timeline-body"><p>Do we need to invoke Ruff as an external process here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/andersk">@andersk</a> reviewed on 2022-12-13 19:31</div>
            <div class="timeline-body"><p>Given that this test requires an external dependency and takes about a minute, maybe we should <code>#[ignore]</code> it by default and run it only in CI?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-13 20:58</div>
            <div class="timeline-body"><p>Yeah this is gonna be great to have! It's already surfaced a bunch of bugs. But I agree that it should probably only be included on an opt-in (on CI, and manually when desired).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/squiddy">@squiddy</a> reviewed on 2022-12-15 04:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/squiddy">@squiddy</a> on <code>tests/black_compatibility_test.rs</code>:27 on 2022-12-15 04:05</div>
            <div class="timeline-body"><p>Done, thanks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/squiddy">@squiddy</a> reviewed on 2022-12-15 04:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/squiddy">@squiddy</a> on <code>tests/black_compatibility_test.rs</code>:105 on 2022-12-15 04:07</div>
            <div class="timeline-body"><p>The initial ticket was mentioning integration test so I put it next to the others. As far as I understand that means I do not have access to the crate itself.</p>
<p>Nothing is really stopping us from moving this into the ruff tests though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/squiddy">@squiddy</a> on 2022-12-15 05:55</div>
            <div class="timeline-body"><p>Test now only runs on CI by default.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-15 17:39</div>
            <div class="timeline-body"><p>Sweet, I'll read through and merge today!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-12-15 19:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>tests/black_compatibility_test.rs</code>:25 on 2022-12-15 19:04</div>
            <div class="timeline-body"><p>Do you have a sense for how much of a difference <code>blackd</code> vs. <code>black</code> makes?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/squiddy">@squiddy</a> reviewed on 2022-12-15 20:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/squiddy">@squiddy</a> on <code>tests/black_compatibility_test.rs</code>:25 on 2022-12-15 20:01</div>
            <div class="timeline-body"><p>Did a couple runs with blackd vs. black on a Ryzen 5800X. ~44s with blackd, 64s with black.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-12-15 20:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>tests/black_compatibility_test.rs</code>:25 on 2022-12-15 20:17</div>
            <div class="timeline-body"><p>Ok cool. My only hesitation is around robustness. If we see flakiness on CI (e.g., from waiting for <code>blackd</code> to startup, or other daemon-related issues), I may ask that we convert back to <code>black</code>, since I'd rather CI be reliable than fast (at least, on that order of magnitude).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2022-12-15 20:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2022-12-15 20:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-15 20:26</div>
            <div class="timeline-body"><p>Awesome, thank you for this @squiddy!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2022-12-27 05:43</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 05:38:25 UTC
    </footer>
</body>
</html>
