<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avoid introducing new parentheses in annotated assignments - astral-sh/ruff #8233</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Avoid introducing new parentheses in annotated assignments</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/8233">#8233</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-10-25 22:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-25 22:10</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>We decided to avoid changing this in https://github.com/astral-sh/ruff/issues/7315, but it's been reported multiple times (e.g., in https://github.com/astral-sh/ruff/issues/8226, also on Discord). I suggest we change it to improve compatibility. In general, it also seems to lend itself to better code style.</p>
<p>Closes #8188
Closes #8226</p>
<h2>Test Plan</h2>
<p>Shows improvements for CPython, home-assistant, Poetry, and typeshed.</p>
<p>Before:</p>
<p>| project        | similarity index  | total files       | changed files     |
|----------------|------------------:|------------------:|------------------:|
| cpython        |           0.75803 |              1799 |              1647 |
| django         |           0.99983 |              2772 |                34 |
| home-assistant |           0.99953 |             10596 |               186 |
| poetry         |           0.99891 |               317 |                17 |
| transformers   |           0.99966 |              2657 |               330 |
| twine          |           1.00000 |                33 |                 0 |
| typeshed       |           0.99978 |              3669 |                20 |
| warehouse      |           0.99977 |               654 |                13 |
| zulip          |           0.99970 |              1459 |                22 |</p>
<p>After:</p>
<p>| project        | similarity index  | total files       | changed files     |
|----------------|------------------:|------------------:|------------------:|
| cpython        |           0.75804 |              1799 |              1647 |
| django         |           0.99983 |              2772 |                34 |
| home-assistant |           0.99960 |             10596 |               156 |
| poetry         |           0.99897 |               317 |                17 |
| transformers   |           0.99966 |              2657 |               330 |
| twine          |           1.00000 |                33 |                 0 |
| typeshed       |           0.99980 |              3669 |                18 |
| warehouse      |           0.99977 |               654 |                13 |
| zulip          |           0.99970 |              1459 |                22 |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @charliermarsh on 2023-10-25 22:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2023-10-25 22:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @charliermarsh on 2023-10-25 23:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_ann_assign.rs</code>:24 on 2023-10-25 23:57</div>
            <div class="timeline-body"><pre><code class="language-suggestion">            [target.format(), token(&quot;:&quot;), space(), annotation.format()]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-10-26 00:03</div>
            <div class="timeline-body"><p>We should update the documentation too.</p>
<p>Are there type annotations in other positions that need updating too?</p>
<p>I'm somewhat torn on this (see comment in #8188) because I think the unfortunate formatting will be fixed when implementing the preview style. Also, there are now cases (with unions on the left), that now exceed the line width, but didn't before. Should we special case instead to only avoid parenthesizing if the type annotation is a single name?</p>
<p>Could we gate the old behavior behind the preview flag? I think the old formatting yields better results if we parenthesize the left, if parenthesizing the right didn't make it fit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-26 01:49</div>
            <div class="timeline-body"><p>Went ahead and updated the docs. My current thinking here is that we should change this based on improving Black compatibility. The current formatting <em>is</em> better in some cases, e.g., from the docs:</p>
<pre><code class="language-python"># Black
StartElementHandler: Callable[[str, dict[str, str]], Any] | Callable[[str, list[str]], Any] | Callable[
    [str, dict[str, str], list[str]], Any
] | None

# Ruff
StartElementHandler: (
    Callable[[str, dict[str, str]], Any]
    | Callable[[str, list[str]], Any]
    | Callable[[str, dict[str, str], list[str]], Any]
    | None
)
</code></pre>
<p>But I think we can improve those by making progress on preview style -- and complex union annotations are also much rarer than simple annotations.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @charliermarsh on 2023-10-26 01:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-10-26 02:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-10-26 02:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-10-26 02:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-10-26 02:51</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 02:33:17 UTC
    </footer>
</body>
</html>
