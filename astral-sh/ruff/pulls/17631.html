<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Fix CLI hang when a dependent query panics - astral-sh/ruff #17631</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Fix CLI hang when a dependent query panics</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17631">#17631</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-04-25 16:19
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-25 16:19</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes https://github.com/astral-sh/ruff/issues/17537</p>
<p>Red Knot's CLI sometimes <em>hangs</em> after encountering a panic. This was due to non-determinsim related to how panics are propagated by rayon and Salsa.</p>
<ul>
<li>Our main loop spawns a job to run the check command to remain responsive to <code>Ctrl + C</code> commands and incoming file watcher changes</li>
<li>This thread is spawned using <code>rayon::spawn</code>. Rayon terminates the entire process if the task scheduled with <code>rayon::spawn</code> panics (we don't have any other panic handling today).</li>
<li>This thread calls <code>db.check</code> right away which calls <code>project.check</code>, but is wrapped in a <code>salsa::Cancelled::catch</code>. I assumed that this only catches cancellations because of a pending write (e.g. a file watcher change) but it turns out, that it also catches panics if thread A depends on a query running in thread B and thread B panics.</li>
<li>The actual checking happens in <code>project.check</code> where we use a thread pool and spawn a task for every file.</li>
<li><code>project.check</code> uses <code>rayon::scope</code>: Unlike <code>rayon::spawn</code>, it propagates panics instead of terminating the process. However, it propagates an arbitrary panic if two threads panic (which is the case if thread A depends on a query in thread B and B panics).</li>
</ul>
<p>What happened is that sometimes rayon propagated the <code>Cancelled::PropagatedPanic</code> (the panic raised by salsa in thread A that depends on the panicking query running in thread B) panic over the <em>actual</em> panic in thread B, which then got swallowed by our <code>Cancelled::catch</code> wrapper inside <code>db.check</code>.</p>
<p>We should probably change Salsa to use a different mechanism to handle thread-dependent panics because this is a logical error, whereas a pending write is not.</p>
<p>This PR fixes the hang by repeating the <code>Cancelled::catch</code> inside each spawned thread. This has the advantage that we propagate the <em>real</em> panic from thread B and never the <em>placeholder</em> <code>Cancelled::PropagatedPanic</code> from thread A (which doesn't contain any useful debug information). More specifically, we now catch panics inside <code>check_file_impl</code> and create a diagnostic for them.</p>
<pre><code>error: panic: Panicked while checking `/Users/micha/astral/ecosystem/hydpy/hydpy/core/devicetools.py`: `dependency graph cycle querying try_metaclass_(Id(250b7)); set cycle_fn/cycle_initial to fixpoint iterate`
info: This indicates a bug in Red Knot.
info: If you could open an issue at https://github.com/astral-sh/ruff/issues/new?title=%5BRed%20Knot%20panic%5D, we'd be very appreciative!
</code></pre>
<p>Ideally, we'd capture the backtrace too but that's a) more complicated and b) mostly empty in production builds.</p>
<h2>Test Plan</h2>
<p>I ran red knot on <a href="https://github.com/hydpy-dev/hydpy?rgh-link-date=2025-04-22T07%3A17%3A56.000Z">hydpy</a> for a couple of minutes and I couldn't reproduce the hang anymore (normally reproduces after 30s or so)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @MichaReiser on 2025-04-25 16:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-25 16:24</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2025-04-25 16:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MichaReiser on 2025-04-25 16:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MichaReiser on 2025-04-25 16:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @MichaReiser on 2025-04-25 16:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @MichaReiser on 2025-04-25 16:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @AlexWaygood on 2025-04-25 16:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @MichaReiser on 2025-04-25 16:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2025-04-25 17:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Fix CLI hang when a dependend query panics" to "[red-knot] Fix CLI hang when a dependent query panics" by @AlexWaygood on 2025-04-25 17:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_project/src/lib.rs</code>:607 on 2025-04-25 18:26</div>
            <div class="timeline-body"><p>nit: today we use <code>[red-knot]</code> prefix on all our issues and PRs, can we stay consistent with that? e.g. <code>[red-knot] panic:</code> maybe?</p>
<p>Of course we'll have to change this again soon :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-04-25 18:28</div>
            <div class="timeline-body"><p>Nice! Thank you so much for tracking this down.</p>
<p>The fix looks good, and also provides a better user experience for panics.</p>
<p>Is my understanding correct that this means new ecosystem panics will now again not show up as a failure in the ecosystem job, and instead just as a diagnostic output diff? I think that's OK, but it does mean we need to be careful to check ecosystem output on our diffs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-04-25 18:29</div>
            <div class="timeline-body"><p>Looks like clippy is not happy?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-25 20:18</div>
            <div class="timeline-body"><p>That's correct. But panics come first with Andrew's new sorting and should be easy to discover because of it (unless it gets truncated).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-04-26 06:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-04-26 06:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-26 06:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-28 07:07</div>
            <div class="timeline-body"><blockquote>
<p>Is my understanding correct that this means new ecosystem panics will now again not show up as a failure in the ecosystem job, and instead just as a diagnostic output diff? I think that's OK, but it does mean we need to be careful to check ecosystem output on our diffs.</p>
</blockquote>
<p>Maybe we could still exit with a code different from 1 (type checking failed) and 2 (some other red knot error), like before? In this case, it would still be easy to detect panics (require no changes in mypy_primer).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-28 07:15</div>
            <div class="timeline-body"><blockquote>
<p>Maybe we could still exit with a code different from 1 (type checking failed) and 2 (some other red knot error), like before? In this case, it would still be easy to detect panics (require no changes in mypy_primer).</p>
</blockquote>
<p>Oh, you already proposed that change in https://github.com/astral-sh/ruff/pull/17640. In that case, mypy_primer CI runs will still fail in case of panics.</p>
<p>Edit: well, not quite, still uses error code 2</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-28 07:25</div>
            <div class="timeline-body"><blockquote>
<p>Edit: well, not quite, still uses error code 2</p>
</blockquote>
<p>We could change the error code to something else but 2 is what Ruff/Red Knot already used for other errors.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:03:27 UTC
    </footer>
</body>
</html>
