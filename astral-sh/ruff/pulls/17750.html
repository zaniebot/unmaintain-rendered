<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Strict validation of protocol members - astral-sh/ruff #17750</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Strict validation of protocol members</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17750">#17750</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-04-30 21:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Emit warning-level diagnostics for symbols that are defined in protocol classes but not explicitly declared as protocol members. This leads to an ambiguous protocol interface that may result in ty misinterpreting the user's intent.</p>
<p>The mypy_primer output provides strong evidence that this is a useful lint: the protocols in ddtrace use Python 2 type comments for their members, which ty won't understand properly.</p>
<h2>Test Plan</h2>
<p>Snapshots and mdtests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-04-30 21:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-30 22:00</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">operator (https://github.com/canonical/operator)
+ ops/framework.py:61:5: warning[ambiguous-protocol-member] Cannot assign to undeclared variable in the body of a protocol class: Consider adding an annotation, e.g. `handle_kind: str = ...`
+ ops/pebble.py:231:5: warning[ambiguous-protocol-member] Cannot assign to undeclared variable in the body of a protocol class: Consider adding an annotation, e.g. `name: str = ...`
- Found 97 diagnostics
+ Found 99 diagnostics

dd-trace-py (https://github.com/DataDog/dd-trace-py)
+ ddtrace/internal/wrapping/__init__.py:30:5: warning[ambiguous-protocol-member] Cannot assign to undeclared variable in the body of a protocol class: Consider adding an annotation for `__dd_wrapped__`
+ ddtrace/internal/wrapping/__init__.py:31:5: warning[ambiguous-protocol-member] Cannot assign to undeclared variable in the body of a protocol class: Consider adding an annotation for `__dd_wrappers__`
+ ddtrace/internal/wrapping/context.py:417:5: warning[ambiguous-protocol-member] Cannot assign to undeclared variable in the body of a protocol class: Consider adding an annotation for `__dd_context_wrapped__`
- Found 6493 diagnostics
+ Found 6496 diagnostics

</code></pre>
</details>
No memory usage changes detected ✅

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-30 22:06</div>
            <div class="timeline-body"><p>This should probably be a different error code than <code>INVALID_PROTOCOL</code>, actually. Maybe <code>INVALID_PROTOCOL_MEMBER</code>. It deserves its own documentation, and it's pretty different from the other <code>INVALID_PROTOCOL</code> diagnostics in that it doesn't actually result in a runtime error.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Strict validation of protocol members" to "[ty] Strict validation of protocol members" by @AlexWaygood on 2025-06-04 18:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-17 12:46</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-17 12:47</div>
            <div class="timeline-body"><p>I put this on hold for a while because I was hopeful that the machinery needed for go-to definition would make creating these diagnostics less fiddly, but it doesn't actually help there ultimately.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @AlexWaygood on 2025-08-17 13:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-08-17 13:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-08-17 13:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @AlexWaygood on 2025-08-17 13:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2025-08-17 13:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-08-19 22:27</div>
            <div class="timeline-body"><p>Looks good, thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-08-19 22:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-08-19 22:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-19 22:45</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:12:05 UTC
    </footer>
</body>
</html>
