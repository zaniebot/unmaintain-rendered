<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix false positive for `S608` where SQL-like expression follows other text - astral-sh/ruff #8723</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix false positive for <code>S608</code> where SQL-like expression follows other text</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/8723">#8723</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2023-11-16 15:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>Closes <a href="https://github.com/astral-sh/ruff/issues/8717">astral-sh/ruff#8717</a></p>
<p>Updates the regex to enforce that the SQL keywords are at the start of the string. Unfortunately we are passing &quot;generated expression strings&quot; to the regular expression instead of the inner contents of a string, so I need to allow for all sorts of cruft in front e.g. <code>f&quot;</code>, <code>f&#x27;</code>, <code>&#x27;</code>, <code>&quot;</code>, <code>\n</code> (literal), and whitespace.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2023-11-16 15:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/BurntSushi">@BurntSushi</a> by <a href="https://github.com/zanieb">@zanieb</a> on 2023-11-16 15:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-11-16 16:02</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+0 -11 violations, +0 -0 fixes in 41 projects)</p>
<a href="https://github.com/apache/airflow">apache/airflow</a> (+0 -11 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --select ALL</pre>
</p>
<p>

<pre>
- <a href="https://github.com/apache/airflow/blob/be6e2cd0d42abc1b3099910c91982f31a98f4c3d/airflow/example_dags/tutorial_objectstorage.py#L118">airflow/example_dags/tutorial_objectstorage.py:118:22:</a> S608 Possible SQL injection vector through string-based query construction
- <a href="https://github.com/apache/airflow/blob/be6e2cd0d42abc1b3099910c91982f31a98f4c3d/airflow/providers/amazon/aws/transfers/s3_to_redshift.py#L185">airflow/providers/amazon/aws/transfers/s3_to_redshift.py:185:17:</a> S608 Possible SQL injection vector through string-based query construction
- <a href="https://github.com/apache/airflow/blob/be6e2cd0d42abc1b3099910c91982f31a98f4c3d/airflow/providers/databricks/operators/databricks_sql.py#L323">airflow/providers/databricks/operators/databricks_sql.py:323:24:</a> S608 Possible SQL injection vector through string-based query construction
- <a href="https://github.com/apache/airflow/blob/be6e2cd0d42abc1b3099910c91982f31a98f4c3d/airflow/utils/db.py#L1197">airflow/utils/db.py:1197:30:</a> S608 Possible SQL injection vector through string-based query construction
- <a href="https://github.com/apache/airflow/blob/be6e2cd0d42abc1b3099910c91982f31a98f4c3d/airflow/utils/db_cleanup.py#L236">airflow/utils/db_cleanup.py:236:12:</a> S608 Possible SQL injection vector through string-based query construction
- <a href="https://github.com/apache/airflow/blob/be6e2cd0d42abc1b3099910c91982f31a98f4c3d/tests/providers/amazon/aws/transfers/test_s3_to_redshift.py#L224">tests/providers/amazon/aws/transfers/test_s3_to_redshift.py:224:23:</a> S608 Possible SQL injection vector through string-based query construction
- <a href="https://github.com/apache/airflow/blob/be6e2cd0d42abc1b3099910c91982f31a98f4c3d/tests/providers/databricks/operators/test_databricks_copy.py#L107">tests/providers/databricks/operators/test_databricks_copy.py:107:12:</a> S608 Possible SQL injection vector through string-based query construction
- <a href="https://github.com/apache/airflow/blob/be6e2cd0d42abc1b3099910c91982f31a98f4c3d/tests/providers/databricks/operators/test_databricks_copy.py#L65">tests/providers/databricks/operators/test_databricks_copy.py:65:12:</a> S608 Possible SQL injection vector through string-based query construction
- <a href="https://github.com/apache/airflow/blob/be6e2cd0d42abc1b3099910c91982f31a98f4c3d/tests/providers/databricks/operators/test_databricks_copy.py#L87">tests/providers/databricks/operators/test_databricks_copy.py:87:12:</a> S608 Possible SQL injection vector through string-based query construction
- <a href="https://github.com/apache/airflow/blob/be6e2cd0d42abc1b3099910c91982f31a98f4c3d/tests/system/providers/google/cloud/bigquery/example_bigquery_queries_async.py#L67">tests/system/providers/google/cloud/bigquery/example_bigquery_queries_async.py:67:18:</a> S608 Possible SQL injection vector through string-based query construction
- <a href="https://github.com/apache/airflow/blob/be6e2cd0d42abc1b3099910c91982f31a98f4c3d/tests/system/providers/trino/example_trino.py#L64">tests/system/providers/trino/example_trino.py:64:13:</a> S608 Possible SQL injection vector through string-based query construction
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| S608 | 11 | 0 | 11 | 0 | 0 |</p>
</p>


Linter (preview)
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+0 -11 violations, +0 -0 fixes in 41 projects)</p>
<a href="https://github.com/apache/airflow">apache/airflow</a> (+0 -11 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --select ALL --preview</pre>
</p>
<p>

<pre>
- <a href="https://github.com/apache/airflow/blob/be6e2cd0d42abc1b3099910c91982f31a98f4c3d/airflow/example_dags/tutorial_objectstorage.py#L118">airflow/example_dags/tutorial_objectstorage.py:118:22:</a> S608 Possible SQL injection vector through string-based query construction
- <a href="https://github.com/apache/airflow/blob/be6e2cd0d42abc1b3099910c91982f31a98f4c3d/airflow/providers/amazon/aws/transfers/s3_to_redshift.py#L185">airflow/providers/amazon/aws/transfers/s3_to_redshift.py:185:17:</a> S608 Possible SQL injection vector through string-based query construction
- <a href="https://github.com/apache/airflow/blob/be6e2cd0d42abc1b3099910c91982f31a98f4c3d/airflow/providers/databricks/operators/databricks_sql.py#L323">airflow/providers/databricks/operators/databricks_sql.py:323:24:</a> S608 Possible SQL injection vector through string-based query construction
- <a href="https://github.com/apache/airflow/blob/be6e2cd0d42abc1b3099910c91982f31a98f4c3d/airflow/utils/db.py#L1197">airflow/utils/db.py:1197:30:</a> S608 Possible SQL injection vector through string-based query construction
- <a href="https://github.com/apache/airflow/blob/be6e2cd0d42abc1b3099910c91982f31a98f4c3d/airflow/utils/db_cleanup.py#L236">airflow/utils/db_cleanup.py:236:12:</a> S608 Possible SQL injection vector through string-based query construction
- <a href="https://github.com/apache/airflow/blob/be6e2cd0d42abc1b3099910c91982f31a98f4c3d/tests/providers/amazon/aws/transfers/test_s3_to_redshift.py#L224">tests/providers/amazon/aws/transfers/test_s3_to_redshift.py:224:23:</a> S608 Possible SQL injection vector through string-based query construction
- <a href="https://github.com/apache/airflow/blob/be6e2cd0d42abc1b3099910c91982f31a98f4c3d/tests/providers/databricks/operators/test_databricks_copy.py#L107">tests/providers/databricks/operators/test_databricks_copy.py:107:12:</a> S608 Possible SQL injection vector through string-based query construction
- <a href="https://github.com/apache/airflow/blob/be6e2cd0d42abc1b3099910c91982f31a98f4c3d/tests/providers/databricks/operators/test_databricks_copy.py#L65">tests/providers/databricks/operators/test_databricks_copy.py:65:12:</a> S608 Possible SQL injection vector through string-based query construction
- <a href="https://github.com/apache/airflow/blob/be6e2cd0d42abc1b3099910c91982f31a98f4c3d/tests/providers/databricks/operators/test_databricks_copy.py#L87">tests/providers/databricks/operators/test_databricks_copy.py:87:12:</a> S608 Possible SQL injection vector through string-based query construction
- <a href="https://github.com/apache/airflow/blob/be6e2cd0d42abc1b3099910c91982f31a98f4c3d/tests/system/providers/google/cloud/bigquery/example_bigquery_queries_async.py#L67">tests/system/providers/google/cloud/bigquery/example_bigquery_queries_async.py:67:18:</a> S608 Possible SQL injection vector through string-based query construction
- <a href="https://github.com/apache/airflow/blob/be6e2cd0d42abc1b3099910c91982f31a98f4c3d/tests/system/providers/trino/example_trino.py#L64">tests/system/providers/trino/example_trino.py:64:13:</a> S608 Possible SQL injection vector through string-based query construction
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| S608 | 11 | 0 | 11 | 0 | 0 |</p>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-11-16 16:07</div>
            <div class="timeline-body"><p>All of the airflow ecosystem checks are false negatives :(</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_linter/src/rules/flake8_bandit/rules/hardcoded_sql_expression.rs</code>:24 on 2023-11-16 16:33</div>
            <div class="timeline-body"><p>One possible thing that might help here is to use verbose mode in the regex. That lets you break things apart using insignificant whitespace and even add comments if you want:</p>
<pre><code>r#&quot;(?ix)
\A
(\&quot;|f\&quot;|\&#x27;|f\&#x27;|\\|\\n|\s)*
\b
(
  select\s.+\sfrom\s
  |
  delete\s+from\s
  |
  (insert|replace)\s.+\svalues\s
  |
  update\s.+\sset\s
)
&quot;#
</code></pre>
<p>Or somethinglike that. Dealer&#x27;s choice about how best to break it up.</p>
<p>Now that I&#x27;ve written out, it makes me wonder about the following:</p>
<ul>
<li>Is it intentional to have the escapes in <code>\&quot;|f\&quot;|\&#x27;|f\&#x27;|\\|\\n|\s</code> here?
Namely, since this is a raw string, <code>f\&quot;</code> will match <code>f\&quot;</code> literally and not
<code>f&quot;</code>. Similarly for the other branches.</li>
<li>While the regex didn&#x27;t previously have it, is it perhaps desirable to add a
word boundary assertion at the end as well? Although maybe not, since I see
that each of the <code>select</code>, <code>delete</code>, <code>insert|replace</code> and <code>update</code> branches
all must end with a <code>\s</code>.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-16 16:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_linter/src/rules/flake8_bandit/rules/hardcoded_sql_expression.rs</code>:24 on 2023-11-16 17:17</div>
            <div class="timeline-body"><p>I like a verbose regex with comments :)</p>
<blockquote>
<p>Is it intentional to have the escapes</p>
</blockquote>
<p>For <code>\\n</code>, yes I want to match the literal <code>\n</code> not a newline. For <code>f\&quot;</code> it looks like the <code>\</code> just has no effect? With or without it, we still match f-strings in the test fixture.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-11-16 17:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-11-16 17:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_linter/src/rules/flake8_bandit/rules/hardcoded_sql_expression.rs</code>:24 on 2023-11-16 17:18</div>
            <div class="timeline-body"><p>Do you have suggestions for handling the false negatives? It looks like the regex would need to get much more complicated. This change may not be worth it as-is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-11-16 17:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_linter/src/rules/flake8_bandit/rules/hardcoded_sql_expression.rs</code>:24 on 2023-11-16 17:32</div>
            <div class="timeline-body"><p>Derp, yes, <code>f\&quot;</code> is equivalent to <code>f&quot;</code>. (Older versions of the regex crate would actually reject such escapes as superfluous.)</p>
<p>With respect to FNs and FPs, are you constrained to a single regex? If not, you could combine the status quo with what you have here. You could change the status quo to only match for uppercase things like <code>SELECT</code>. That will reduce its false positives but greatly increase the false negatives. Then to decrease false negatives, you could use your second regex here which allows lowercase <code>select</code> but only at the start of a string.</p>
<p>It&#x27;s pretty hokey and probably is an overfitting to our current tests but is perhaps an improvement.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-11-16 20:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_linter/src/rules/flake8_bandit/rules/hardcoded_sql_expression.rs</code>:24 on 2023-11-16 20:02</div>
            <div class="timeline-body"><p>Hmm... definitely hokey but I was also thinking case sensitivity makes some sense...</p>
<p>I almost would rather have a &quot;case insensitive&quot; setting for this which is off by default...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-11-20 19:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/flake8_bandit/rules/hardcoded_sql_expression.rs</code>:24 on 2023-11-20 19:51</div>
            <div class="timeline-body"><p>For f-strings, we wouldn&#x27;t need to worry about the prefix and quotes as in <a href="https://github.com/astral-sh/ruff/pull/7927">astral-sh/ruff#7927</a>/files#diff-649016c25b517ba99e70caf422c95ef9d544e7c806d26e64624c0414777d54f5 I&#x27;ve removed them. That is, for f-strings, we&#x27;d do:</p>
<pre><code>/// Concatenates the contents of an f-string, without the prefix and quotes,
/// and escapes any special characters.
///
/// ## Example
///
/// ```python
/// &quot;foo&quot; f&quot;bar {x}&quot; &quot;baz&quot;
/// ```
///
/// becomes `foobar {x}baz`.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/brondsem">@brondsem</a> on 2023-12-19 16:02</div>
            <div class="timeline-body"><p>While this regex is being improved, here&#x27;s an example that is NOT detected by ruff currently (1.0.8) but is detected by bandit:</p>
<pre><code>f&quot;&quot;&quot;SELECT
    foo from bar where a={x}&quot;&quot;&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-19 21:14</div>
            <div class="timeline-body"><p>Thank you @brondsem :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/zanieb">@zanieb</a> on 2024-03-12 18:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-03-12 18:38</div>
            <div class="timeline-body"><p>This turned out to be hard to get right. I&#x27;d welcome help improving this but it&#x27;s going to be tough to balance.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/zanieb">@zanieb</a> on 2024-03-12 18:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Arexils">@Arexils</a> on 2024-08-24 22:16</div>
            <div class="timeline-body"><p>i have this problem :(</p>
<p>S608 Possible SQL injection vector through string-based query construction</p>
<p><code>logger.warning(f&#x27;The linked role &lt;{1}&gt; has been delete from the guild {2}&#x27;)</code></p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:59:25 UTC
    </footer>
</body>
</html>
