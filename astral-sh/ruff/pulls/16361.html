<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notify users for invalid client settings - astral-sh/ruff #16361</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Notify users for invalid client settings</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16361">#16361</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2025-02-25 07:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>As mentioned in https://github.com/astral-sh/ruff/pull/16296#discussion_r1967047387</p>
<p>This PR updates the client settings resolver to notify the user if there are any errors in the config using a very basic approach. In addition, each error related to specific settings are logged.</p>
<p>This isn't the best approach because it can log the same message multiple times when both workspace and global settings are provided and they both are the same. This is the case for a single workspace VS Code instance.</p>
<p>I do have some ideas on how to improve this and will explore them during my free time (low priority):</p>
<ul>
<li>Avoid resolving the global settings multiple times as they're static</li>
<li>Include the source of the setting (workspace or global?)</li>
<li>Maybe use a struct (<code>ResolvedClientSettings</code> + <code>Vec&lt;ClientSettingsResolverError&gt;</code>) instead to make unit testing easier</li>
</ul>
<h2>Test Plan</h2>
<p>Using:</p>
<pre><code class="language-jsonc">{
  &quot;ruff.logLevel&quot;: &quot;debug&quot;,
	
  // Invalid settings
  &quot;ruff.configuration&quot;: &quot;$RANDOM&quot;,
  &quot;ruff.lint.select&quot;: [&quot;RUF000&quot;, &quot;I001&quot;],
  &quot;ruff.lint.extendSelect&quot;: [&quot;B001&quot;, &quot;B002&quot;],
  &quot;ruff.lint.ignore&quot;: [&quot;I999&quot;, &quot;F401&quot;]
}
</code></pre>
<p>The error logs:</p>
<pre><code>2025-02-27 12:30:04.318736000 ERROR Failed to load settings from `configuration`: error looking key 'RANDOM' up: environment variable not found
2025-02-27 12:30:04.319196000 ERROR Failed to load settings from `configuration`: error looking key 'RANDOM' up: environment variable not found
2025-02-27 12:30:04.320549000 ERROR Unknown rule selectors found in `lint.select`: [&quot;RUF000&quot;]
2025-02-27 12:30:04.320669000 ERROR Unknown rule selectors found in `lint.extendSelect`: [&quot;B001&quot;]
2025-02-27 12:30:04.320764000 ERROR Unknown rule selectors found in `lint.ignore`: [&quot;I999&quot;]
</code></pre>
<p>Notification preview:</p>
<p><img width="470" alt="Screenshot 2025-02-27 at 12 29 06 PM" src="https://github.com/user-attachments/assets/61f41d5c-2558-46b3-a1ed-82114fd8ec22" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @dhruvmanila on 2025-02-25 07:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Expand ruff.configuration to allow inline config" to "Notify users for invalid client settings" by @dhruvmanila on 2025-02-25 07:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-02-25 08:06</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dhruvmanila on 2025-02-27 07:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2025-02-27 07:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/session/settings.rs</code>:421 on 2025-02-27 07:52</div>
            <div class="timeline-body"><p>As a user (mainly VS Code), I'd find it difficult to understand what client settings are because I never configured them explicitly. Can we say invalid Ruff extension settings or invalid Ruff LSP settings?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/session/settings.rs</code>:442 on 2025-02-27 07:54</div>
            <div class="timeline-body"><p>Is this an error message that we could log from within Ruff itself or does it only apply to a subset of settings?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-02-27 07:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-02-27 08:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/session/settings.rs</code>:442 on 2025-02-27 08:08</div>
            <div class="timeline-body"><p>I don't think Ruff has a tracing system configured as it uses a basic <a href="https://docs.rs/log/latest/log/"><code>log</code></a> crate. So, those logs might not show up in the editor log channel</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/session/settings.rs</code>:421 on 2025-02-27 08:10</div>
            <div class="timeline-body"><p>We can say &quot;Ruff received invalid settings from the editor. ...&quot; to make it not specific to VS Code and LSP (implementation detail).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-02-27 08:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-27 08:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/session/settings.rs</code>:442 on 2025-02-27 08:14</div>
            <div class="timeline-body"><p>Tracing seems to work. At least, I can' see logs for the <code>format_path</code> spans</p>
<pre><code>[2025-02-27][09:13:09][ruff::commands::format][DEBUG] format_path; path=/Users/micha/astral/ruff/scripts/knot_benchmark/src/benchmark/__init__.py
[2025-02-27][09:13:09][ruff::commands::format][DEBUG] format_path; path=/Users/micha/astral/ruff/scripts/knot_benchmark/src/benchmark/run.py
[2025-02-27][09:13:09][ruff::commands::format][DEBUG] format_path; path=/Users/micha/astral/ruff/scripts/knot_benchmark/src/benchmark/projects.py
[2025-02-27][09:13:09][ruff::commands::format][DEBUG] format_path; path=/Users/micha/astral/ruff/scripts/knot_benchmark/src/benchmark/cases.py
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-02-27 08:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/session/settings.rs</code>:442 on 2025-02-27 08:17</div>
            <div class="timeline-body"><p>This would also mean that a message can only contain a single rule, so there'll be <code>n</code> number of messages where <code>n</code> are the total number of unknown rule selectors.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-02-27 08:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/session/settings.rs</code>:442 on 2025-02-27 08:18</div>
            <div class="timeline-body"><p>I'm also a bit unsure if we should include a log message inside a <code>FromStr</code> impl. We also won't know which key did the selector belonged to, was it <code>lint.select</code>, <code>lint.extendSelect</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-02-27 08:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/session/settings.rs</code>:442 on 2025-02-27 08:19</div>
            <div class="timeline-body"><p>Oh, wait, you meant to put this directly in the resolution of <code>lint.select</code> inside Ruff. Let me check</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-02-27 08:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/session/settings.rs</code>:442 on 2025-02-27 08:20</div>
            <div class="timeline-body"><p>Hmm, actually no, I don't think that's possible as we need to resolve it on the server side.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-27 08:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/session/settings.rs</code>:442 on 2025-02-27 08:22</div>
            <div class="timeline-body"><p>Okay, thanks for checking.</p>
<p>I'm mainly asking because it would be nice to have less server specific logging.</p>
<p>It might be worth exploring if we should change all ruff <code>debug</code>, and <code>trace</code> usages to use tracing instead of <code>log</code> so that they'd be visible in the server too. But that's something for another day.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2025-02-27 08:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2025-02-27 08:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-27 08:28</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:10:19 UTC
    </footer>
</body>
</html>
