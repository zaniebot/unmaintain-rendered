<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Todo-types for `os.fdopen`, `NamedTemporaryFile`, and `Path.open` - astral-sh/ruff #20549</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Todo-types for <code>os.fdopen</code>, <code>NamedTemporaryFile</code>, and <code>Path.open</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20549">#20549</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-09-24 12:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This applies the trick that we use for <code>builtins.open</code> to similar functions that have the same problem. The reason is that the problem would otherwise become even more pronounced once we add understanding of the implicit type of <code>self</code> parameters, because then something like <code>(base_path / &quot;test.bin&quot;).open(&quot;rb&quot;)</code> also leads to a wrong return type and can result in false positives.</p>
<h2>Test Plan</h2>
<p>New Markdown tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @sharkdp on 2025-09-24 12:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-24 12:45</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-24 12:46</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">jinja (https://github.com/pallets/jinja)
- src/jinja2/bccache.py:298:39: error[invalid-argument-type] Argument to bound method `write_bytecode` is incorrect: Expected `IO[bytes]`, found `_TemporaryFileWrapper[str]`
- Found 185 diagnostics
+ Found 184 diagnostics

isort (https://github.com/pycqa/isort)
- isort/api.py:161:5: error[invalid-assignment] Object of type `(str &amp; ~AlwaysFalsy) | (Path &amp; ~AlwaysTruthy &amp; ~AlwaysFalsy)` is not assignable to `str | None`
- isort/api.py:214:13: error[invalid-argument-type] Argument to function `process` is incorrect: Expected `str`, found `str | None`
- Found 33 diagnostics
+ Found 31 diagnostics

scrapy (https://github.com/scrapy/scrapy)
- scrapy/extensions/feedexport.py:200:16: error[invalid-return-type] Return type does not match returned value: expected `IO[bytes]`, found `TextIOWrapper[_WrappedBuffer]`
- Found 1045 diagnostics
+ Found 1044 diagnostics

dulwich (https://github.com/dulwich/dulwich)
- dulwich/contrib/swift.py:885:60: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `IO[bytes]`, found `TextIOWrapper[_WrappedBuffer]`
- dulwich/object_store.py:1522:37: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `IO[bytes] | None`, found `TextIOWrapper[_WrappedBuffer]`
- Found 179 diagnostics
+ Found 177 diagnostics

check-jsonschema (https://github.com/python-jsonschema/check-jsonschema)
- src/check_jsonschema/cachedownloader.py:82:5: error[no-matching-overload] No overload of bound method `write` matches arguments
- Found 56 diagnostics
+ Found 55 diagnostics

schema_salad (https://github.com/common-workflow-language/schema_salad)
- schema_salad/utils.py:109:12: error[invalid-return-type] Return type does not match returned value: expected `BufferedWriter`, found `TextIOWrapper[_WrappedBuffer]`
- Found 172 diagnostics
+ Found 171 diagnostics

manticore (https://github.com/trailofbits/manticore)
- tests/native/test_lazy_memory.py:127:9: error[no-matching-overload] No overload of bound method `write` matches arguments
- tests/native/test_lazy_memory.py:140:9: error[no-matching-overload] No overload of bound method `write` matches arguments
- tests/native/test_lazy_memory.py:152:9: error[no-matching-overload] No overload of bound method `write` matches arguments
- tests/native/test_lazy_memory.py:164:9: error[no-matching-overload] No overload of bound method `write` matches arguments
- tests/native/test_lazy_memory.py:176:9: error[no-matching-overload] No overload of bound method `write` matches arguments
- tests/native/test_memory.py:938:9: error[no-matching-overload] No overload of bound method `write` matches arguments
- tests/native/test_memory.py:951:9: error[no-matching-overload] No overload of bound method `write` matches arguments
- tests/native/test_memory.py:963:9: error[no-matching-overload] No overload of bound method `write` matches arguments
- tests/native/test_memory.py:975:9: error[no-matching-overload] No overload of bound method `write` matches arguments
- tests/native/test_memory.py:987:9: error[no-matching-overload] No overload of bound method `write` matches arguments
- tests/native/test_memory.py:1005:9: error[no-matching-overload] No overload of bound method `write` matches arguments
- tests/native/test_memory.py:1031:9: error[no-matching-overload] No overload of bound method `write` matches arguments
- tests/native/test_memory.py:1039:9: error[no-matching-overload] No overload of bound method `write` matches arguments
- tests/native/test_memory.py:1053:9: error[no-matching-overload] No overload of bound method `write` matches arguments
- tests/native/test_memory.py:1527:9: error[no-matching-overload] No overload of bound method `write` matches arguments
- tests/native/test_memory.py:1557:9: error[no-matching-overload] No overload of bound method `write` matches arguments
- tests/native/test_memory.py:1570:9: error[no-matching-overload] No overload of bound method `write` matches arguments
- tests/native/test_memory.py:1594:9: error[no-matching-overload] No overload of bound method `write` matches arguments
- tests/native/test_memory.py:1652:9: error[no-matching-overload] No overload of bound method `write` matches arguments
- tests/native/test_memory.py:1706:9: error[no-matching-overload] No overload of bound method `write` matches arguments
- Found 1097 diagnostics
+ Found 1077 diagnostics

scikit-learn (https://github.com/scikit-learn/scikit-learn)
- sklearn/model_selection/tests/test_validation.py:2028:5: error[no-matching-overload] No overload of bound method `write` matches arguments
- Found 1955 diagnostics
+ Found 1954 diagnostics

CPython (cases_generator) (https://github.com/python/cpython)
- Lib/test/test_tempfile.py:986:13: error[no-matching-overload] No overload of bound method `write` matches arguments
- Lib/test/test_urllib.py:640:27: error[invalid-argument-type] Argument to bound method `write` is incorrect: Expected `str`, found `Unknown | Literal[b&quot;&quot;]`
- Found 23902 diagnostics
+ Found 23900 diagnostics

CPython (peg_generator) (https://github.com/python/cpython)
- Lib/test/test_tempfile.py:986:13: error[no-matching-overload] No overload of bound method `write` matches arguments
- Lib/test/test_urllib.py:640:27: error[invalid-argument-type] Argument to bound method `write` is incorrect: Expected `str`, found `Unknown | Literal[b&quot;&quot;]`
- Found 23901 diagnostics
+ Found 23899 diagnostics

CPython (Argument Clinic) (https://github.com/python/cpython)
- Lib/test/test_tempfile.py:986:13: error[no-matching-overload] No overload of bound method `write` matches arguments
- Lib/test/test_urllib.py:640:27: error[invalid-argument-type] Argument to bound method `write` is incorrect: Expected `str`, found `Unknown | Literal[b&quot;&quot;]`
- Found 23902 diagnostics
+ Found 23900 diagnostics

</code></pre>
</details>
No memory usage changes detected âœ…

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-09-24 12:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types.rs</code>:9702 on 2025-09-24 12:46</div>
            <div class="timeline-body"><p>This is overly aggressive, because now we replace the whole signature with <code>(*args, **kwargs) -&gt; @Todo</code>, i.e. we also have false negatives for wrong <code>Path.open</code> calls, and return a <code>@Todo</code> type for every call to <code>Path.open</code>. But manually constructing a overload set for <code>Path.open</code> seems daunting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by @sharkdp on 2025-09-24 12:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @sharkdp on 2025-09-24 12:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2025-09-24 12:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2025-09-24 12:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @sharkdp on 2025-09-24 12:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-24 12:55</div>
            <div class="timeline-body"><!-- generated-comment ty ecosystem-analyzer -->

<h2><code>ecosystem-analyzer</code> results</h2>
<p>| Lint rule | Added | Removed | Changed |
|-----------|------:|--------:|--------:|
| <code>no-matching-overload</code> | 0 | 22 | 0 |
| <code>invalid-argument-type</code> | 0 | 4 | 0 |
| <code>invalid-return-type</code> | 0 | 2 | 0 |
| <code>invalid-assignment</code> | 0 | 1 | 0 |
| <strong>Total</strong> | <strong>0</strong> | <strong>29</strong> | <strong>0</strong> |</p>
<p><strong><a href="https://david-open-calls.ecosystem-663.pages.dev/diff">Full report with detailed diff</a></strong></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/function.rs</code>:1754 on 2025-09-24 13:05</div>
            <div class="timeline-body"><p>could maybe combine these two branches</p>
<pre><code class="language-suggestion">            KnownFunction::Open | KnownFunction::Fdopen =&gt; {
                // TODO: Temporary special-casing for `builtins.open`/`os.fdopen` to avoid an excessive number of
                // false positives in lieu of proper support for PEP-613 type aliases.
                if let [_, Some(mode), ..] = parameter_types
                    &amp;&amp; is_mode_with_nontrivial_return_type(db, *mode)
                {
                    overload.set_return_type(todo_type!(&quot;`builtins.open`/`os.fdopen` return type&quot;));
                }
            }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/function.rs</code>:1695 on 2025-09-24 13:05</div>
            <div class="timeline-body"><p>I guess I originally introduced this typo in my previous PR ðŸ™ˆ</p>
<pre><code class="language-suggestion">                // false positives in lieu of proper support for PEP-613 type aliases.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/display.rs</code>:391 on 2025-09-24 13:08</div>
            <div class="timeline-body"><p>The runtime type of <code>Path(&quot;foo&quot;).open</code> is a <code>types.MethodType</code> instance rather than a <code>types.MethodWrapperType</code> instance, since <code>pathlib.Path</code> is just a pure-Python class with regular pure-Python methods</p>
<pre><code class="language-suggestion">                f.write_str(&quot;bound method `Path.open`&quot;)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types.rs</code>:9605 on 2025-09-24 13:10</div>
            <div class="timeline-body"><pre><code class="language-pycon">&gt;&gt;&gt; import pathlib
&gt;&gt;&gt; pathlib.Path(&quot;foo&quot;).open
&lt;bound method Path.open of PosixPath('foo')&gt;
&gt;&gt;&gt; import types
&gt;&gt;&gt; type(_) is types.MethodType
True
</code></pre>
<pre><code class="language-suggestion">            KnownBoundMethodType::PathOpen =&gt; KnownClass::MethodType,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-09-24 13:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-09-24 13:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/open_calls.rs</code>:6 on 2025-09-24 13:18</div>
            <div class="timeline-body"><p>this helper is only used from <code>function.rs</code>, and it might be easier to rip out the short-term hack out again later if this helper lived in <code>function.rs</code> rather than introducing a new module? Don't have a strong opinion though</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-09-24 13:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/open_calls.rs</code>:6 on 2025-09-24 13:21</div>
            <div class="timeline-body"><p>Right. I wanted to use it for <code>Path.open</code>, but then decided otherwise. Will move it back.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-09-24 13:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types.rs</code>:9605 on 2025-09-24 13:23</div>
            <div class="timeline-body"><p>Oops. I misinterpreted the docstring.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-09-24 13:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/function.rs</code>:1754 on 2025-09-24 13:32</div>
            <div class="timeline-body"><p>Will leave it as-is. We'll hopefully remove it soon.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2025-09-24 13:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-09-24 13:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-09-24 13:44</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:15:58 UTC
    </footer>
</body>
</html>
