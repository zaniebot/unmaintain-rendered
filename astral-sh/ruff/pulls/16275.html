<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Token system to avoid cross-module query dependencies - astral-sh/ruff #16275</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Token system to avoid cross-module query dependencies</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16275">#16275</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-02-20 13:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR introduces a token based system to reduce accidental cross-module query dependencies.</p>
<p>The basic idea is that we create a custom accessor for tracked struct fields that return an <code>AstNodeRef</code> and require an extra <code>query_file: File</code> argument.
The <code>query_file</code> is the file of the enclosing query and we compare it against the tracked struct's scope to ensure it is the same.</p>
<p>The basic idea here is: You should probably not access the node if don't know in which context your query runs or wrap your code in an extra query.</p>
<p>Getting the file should generally be easy. E.g. <code>TypeInferenceBuilder</code> has a <code>file</code> method.</p>
<p>This system doesn't prevent abuse. It's normally easy to get the correct file. E.g. you can call <code>definition.scope(db).file(db)</code> to get the file
but let's not do that ;).</p>
<p>The main downside of this approach is that it's sort of annoying. But I take that for extra peace of mind.</p>
<p>This should mitigate/fix https://github.com/astral-sh/ty/issues/208</p>
<h2>Alternative approach</h2>
<p>I considered changing <code>AstNodeRef::node</code> to take a <code>File</code> instead. But that quickly became annoying because we'd lose the <code>Deref</code> and <code>Debug</code> would also need a workaround. It also isn't <code>AstNodeRef::node</code> that's the problem, it's accessing the field on the tracked struct. That's why I opted for the custom-accessor on the tracked struct approach.</p>
<p>The ideal solution is to solve this problem by restructuring our modules and enforce it with visibility constraints but that's a bit more work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2025-02-20 13:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @MichaReiser on 2025-02-20 13:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2025-02-20 13:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MichaReiser on 2025-02-20 13:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MichaReiser on 2025-02-20 13:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @MichaReiser on 2025-02-20 13:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/semantic_index/definition.rs</code>:41 on 2025-02-20 14:04</div>
            <div class="timeline-body"><p>Should the WARNING message above this field now be changed to something like &quot;It's almost always incorrect to access this field diretcly; instead, go via the public <code>kind()</code> accessor getter&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/semantic_index/definition.rs</code>:58 on 2025-02-20 14:05</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    /// It acts as a token of proof that we aren't accessing an AST node from a different file
    /// to the one from which the current enclosing Salsa query is being called.
    /// Doing so would lead to cross-file dependencies, hurting incremental computation.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/narrow.rs</code>:183 on 2025-02-20 14:10</div>
            <div class="timeline-body"><pre><code class="language-suggestion"></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/semantic_index/expression.rs</code>:58 on 2025-02-20 14:11</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    /// It acts as a token of proof that we aren't accessing an AST node from a different file
    /// to the one from which the current enclosing Salsa query is being called.
    /// Doing so would lead to cross-file dependencies, hurting incremental computation.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:210 on 2025-02-20 14:12</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// `query_file` is the file for which the current query performs type inference.
/// It acts as a token of proof that we aren't accessing an AST node from a different file
/// to the one from which the current enclosing Salsa query is being called.
/// Doing so would lead to cross-file dependencies, hurting incremental computation.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/unpack.rs</code>:69 on 2025-02-20 14:13</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    /// It acts as a token of proof that we aren't accessing an AST node from a different file
    /// to the one from which the current enclosing Salsa query is being called.
    /// Doing so would lead to cross-file dependencies, hurting incremental computation.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/unpack.rs</code>:58 on 2025-02-20 14:14</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    /// It acts as a token of proof that we aren't accessing an AST node from a different file
    /// to the one from which the current enclosing Salsa query is being called.
    /// Doing so would lead to cross-file dependencies, hurting incremental computation.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-02-20 14:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-20 14:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/definition.rs</code>:41 on 2025-02-20 14:24</div>
            <div class="timeline-body"><p>I think the fact that it's private should be good enough</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-20 14:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/semantic_index/definition.rs</code>:41 on 2025-02-20 14:26</div>
            <div class="timeline-body"><p>oh good point, I missed that change</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-20 17:12</div>
            <div class="timeline-body"><p>One caveat. This doesn't protect us fully from cross-module dependencies. For example, a function can still call <code>semantic_index</code> (or <code>ast_ids</code>) and introduce a cross-module dependency that way. But I think it helps a little?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Token system to avoid cross-module query depndencies" to "[red-knot] Token system to avoid cross-module query dependencies" by @MichaReiser on 2025-02-20 17:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-02-20 19:40</div>
            <div class="timeline-body"><p>I have mixed feelings about this. It feels like it's not protecting the boundary at the layer where we need to protect it in order to get the results we actually want (as mentioned above about <code>semantic_index</code> and <code>ast_ids</code>), and it introduces a fair amount of &quot;noise&quot; in order to provide protection that isn't quite at the right layer (which means I would still want to explore other solutions to astral-sh/ty#208).</p>
<p>Exactly where the &quot;right&quot; layer is is still an open question: it could be set at &quot;anything below Type&quot;, which would be I think pretty conceptually clean but might result in too many queries needed? But it seems clear that it ought to be set &quot;above&quot; semantic index at the very least.</p>
<p>If you feel this alone would have avoided a significant number of the errors we've made in this area in the past, I'm not opposed to merging it for now and considering other approaches later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-21 07:30</div>
            <div class="timeline-body"><blockquote>
<p>If you feel this alone would have avoided a significant number of the errors we've made in this area in the past, I'm not opposed to merging it for now and considering other approaches later.</p>
</blockquote>
<p>I do think it would have caught the cross-module use in <code>Class::implicit_instance_attribute</code> and in visibility constraint's <code>evaluate</code>.</p>
<p>But I agree that it's not as good as I first thought it would be.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-02-28 09:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:10:12 UTC
    </footer>
</body>
</html>
