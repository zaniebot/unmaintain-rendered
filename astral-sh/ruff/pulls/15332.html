<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] all types are assignable to object - astral-sh/ruff #15332</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] all types are assignable to object</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15332">#15332</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2025-01-07 21:21
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p><code>Type[Any]</code> should be assignable to <code>object</code>. All types should be assignable to <code>object</code>.</p>
<p>We specifically didn't understand the former; this PR adds a test for it, and a case to ensure that <code>Type[Any]</code> is assignable to anything that <code>type</code> is assignable to (which includes <code>object</code>).</p>
<p>This PR also adds a property test that all types are assignable to object. In order to make it pass, I added a special case to check early if we are assigning to <code>object</code> and just return <code>true</code>. In principle, once we get all the more general cases correct, this special case might be removable. But having the special case for now allows the property test to pass.</p>
<p>And we add a property test that all types are subtypes of object. This failed for the case of an intersection with no positive elements (that is, a negation type). This really does need to be a special case for <code>object</code>, because there is no other type we can know that a negation type is a subtype of.</p>
<h2>Test Plan</h2>
<p>Added unit test and property test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @carljm on 2025-01-07 21:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @carljm on 2025-01-07 21:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @carljm on 2025-01-07 21:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @carljm on 2025-01-07 21:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-07 21:35</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/property_tests.rs</code>:301 on 2025-01-07 21:47</div>
            <div class="timeline-body"><p>Is it worth also adding a subtyping version of this for fully static types?</p>
<pre><code class="language-suggestion">    );

    // And for fully static types, they should also be subtypes of `object`
    type_property_test!(
        all_fully_static_types_subtype_of_object, db,
        forall types t. t.is_fully_static() =&gt; t.is_subtype_of(db, KnownClass::Object.to_instance(db))
    );
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:996 on 2025-01-07 21:58</div>
            <div class="timeline-body"><p>I've spent a while staring at this branch now ðŸ˜† I <em>think</em> it's correct, it just took me a little bit of time to wrap my head around it -- adding some comments might be good. It's saying that <code>type[Any]</code> is a consistent subtype of a type <code>T</code> if <code>T</code> is either a consistent subtype or a consistent supertype of <code>type</code>. Right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-01-07 21:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-07 22:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/property_tests.rs</code>:300 on 2025-01-07 22:16</div>
            <div class="timeline-body"><p>oops, you need a db here</p>
<pre><code class="language-suggestion">        forall types t. t.is_fully_static(db) =&gt; t.is_subtype_of(db, KnownClass::Object.to_instance(db))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/property_tests.rs</code>:300 on 2025-01-07 22:17</div>
            <div class="timeline-body"><p>Yes, I have it fixed locally, just working on another bug revealed by this property test :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-01-07 22:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-07 22:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:996 on 2025-01-07 22:22</div>
            <div class="timeline-body"><blockquote>
<p>I've spent a while staring at this branch now</p>
</blockquote>
<p>So glad I'm not the only one. I attributed it to tiredness :smile:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-01-07 22:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:996 on 2025-01-07 22:30</div>
            <div class="timeline-body"><p>I also found it confusing, both in its form prior to this change, and still after this change :) I think it's correct, though. I'll try to formulate a clear argument for why it is correct, and put that in a comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-07 22:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:778 on 2025-01-07 22:40</div>
            <div class="timeline-body"><p>Oh, nice!! Yet another win for the property tests ðŸ˜ƒ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:779 on 2025-01-07 22:42</div>
            <div class="timeline-body"><p>Subtype-of-object really does have to be a special case for negation types (that is, intersections with no positive elements). They are subtypes of <code>object</code> simply because <code>object</code> is the top type, so they must be, but there is no other type we can establish them to be a subtype of (other than another negation type, which is handled in the next case below.)</p>
<p>This case could be generalized to apply to any <code>self</code> type, not just intersections, and maybe it should be. I kind of like the fact that in most cases we don't need to special case <code>object</code> to get the right behavior (and the property test suggests we don't need to special case it for anything else). But practically speaking it might be faster to always shortcut for it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-01-07 22:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-07 22:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:779 on 2025-01-07 22:44</div>
            <div class="timeline-body"><p>Conceptually it feels more elegant to me to fallback to the supertype where possible and let the handling for <code>object</code> fall out naturally for everything except this branch. But obviously if it is more performant, we should do the more performant thing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-07 22:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:779 on 2025-01-07 22:46</div>
            <div class="timeline-body"><blockquote>
<p>This case could be generalized to apply to any <code>self</code> type, not just intersections, and maybe it should be.</p>
</blockquote>
<p>We did actually do this before https://github.com/astral-sh/ruff/pull/14924, but I took it out as part of that PR because (so I thought) we didn't need it anymore</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-01-07 23:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:996 on 2025-01-07 23:06</div>
            <div class="timeline-body"><p>I pushed comments for every case in <code>is_assignable_to</code>, including this one.</p>
<p>I found it pretty easy to justify the new clause I added here in this PR; <code>type[Any]</code> is assignable to anything <code>type[object]</code> is assignable to, because <code>type[Any]</code> can materialize to <code>type[object]</code>.</p>
<p>What I found harder to formulate a justification for was the previous clause that was already here, which said that <code>type[Any]</code> is assignable to anything which is assignable to <code>type[object]</code>. I found it clearer if I tightened that to &quot;<code>type[Any]</code> is assignable to anything which is a subtype of <code>type[object]</code>&quot;, and that form still passes all tests, including property tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-01-07 23:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:779 on 2025-01-07 23:07</div>
            <div class="timeline-body"><p>I'm not going to generalize it in this PR; we can explore it as a possible perf optimization later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-01-07 23:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @carljm on 2025-01-07 23:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-01-07 23:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-07 23:19</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:08:57 UTC
    </footer>
</body>
</html>
