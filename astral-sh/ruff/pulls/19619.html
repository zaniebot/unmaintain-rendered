<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-async`] Extend `ASYNC230` to detect blocking `pathlib` I/O methods - astral-sh/ruff #19619</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-async</code>] Extend <code>ASYNC230</code> to detect blocking <code>pathlib</code> I/O methods</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19619">#19619</a>
        opened by <a href="https://github.com/aidandj">@aidandj</a>
        on 2025-07-29 17:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/aidandj">@aidandj</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff/ty! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title? (Please prefix with `[ty]` for ty pull
  requests.)
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>Add detection for pathlib's blocking I/O methods (<code>read_text</code>, <code>read_bytes</code>, <code>write_text</code>, <code>write_bytes</code>) in async functions, beyond just the <code>open()</code> method. Under the hood, these methods call <code>open</code>, so they have the same issue that <code>open</code> does.</p>
<h2>Test Plan</h2>
<p>Added test cases to the existing ASYNC230 test suite and updated the snapshot.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_async/rules/blocking_open_call.rs</code>:82 on 2025-07-29 18:42</div>
            <div class="timeline-body"><p>I think we could use <code>matches!</code> here:</p>
<pre><code class="language-suggestion">    if !matches!(attr.as_str(), &quot;open&quot;
        | &quot;read_text&quot;
        | &quot;read_bytes&quot;
        | &quot;write_text&quot;
        | &quot;write_bytes&quot;)
    {
</code></pre>
<p>However, we will need two checks here for now because I think we should gate this behind preview since it's an expansion of a stable rule. You can see examples of these in <code>preview.rs</code>:</p>
<p>https://github.com/astral-sh/ruff/blob/d449c541cb2f232d06716cced5f0be27c437079b/crates/ruff_linter/src/preview.rs#L224-L227</p>
<p>and references to those functions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_async/ASYNC230.py</code>:25 on 2025-07-29 18:43</div>
            <div class="timeline-body"><p>Can you revert this? It will make the snapshots a bit easier to review since it won't shift everything down :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-07-29 18:49</div>
            <div class="timeline-body"><p>Thanks! This change makes sense to me, but I think we should preview-gate it since the rule itself is stable.</p>
<p>Otherwise I just had a couple of small nits.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @ntBre on 2025-07-29 18:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @ntBre on 2025-07-29 18:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/aidandj">@aidandj</a> reviewed on 2025-07-29 18:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/aidandj">@aidandj</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_async/ASYNC230.py</code>:25 on 2025-07-29 18:50</div>
            <div class="timeline-body"><p>Sorry, I kept trying to revert this but my formatter kept adding it back. I'll revert it again.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[flake8-async] Extend ASYNC230 to detect blocking pathlib I/O methods" to "[`flake8-async`] Extend `ASYNC230` to detect blocking `pathlib` I/O methods" by @ntBre on 2025-07-29 18:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/aidandj">@aidandj</a> on <code>crates/ruff_linter/src/rules/flake8_async/rules/blocking_open_call.rs</code>:82 on 2025-07-29 18:51</div>
            <div class="timeline-body"><p>Thanks for the <code>matches</code> suggestion. Rust newbie here, still learning.</p>
<p>I'll look into the preview stuff.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/aidandj">@aidandj</a> reviewed on 2025-07-29 18:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-07-29 18:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_async/ASYNC230.py</code>:25 on 2025-07-29 18:52</div>
            <div class="timeline-body"><p>No worries, I habitually hit my formatter binding and always have to hold back when modifying snapshots too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @aidandj on 2025-07-29 19:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/aidandj">@aidandj</a> on 2025-07-29 19:39</div>
            <div class="timeline-body"><p>I did a double check in the pathlib library and found <code>touch</code> as well calls io.open. Added that in there.</p>
<p>I found a pattern of enabling preview tests in another file and copied that over, if there is a better method for preview tests let me know. It would be nice to tie them to those helper methods so that when you deleted the helper method you would know to move the test out of the preview call. Maybe that could be as simple as calling the helper function in the preview test to bring attention to it.</p>
<p>Also, who's responsibility is it to take it out of preview? The PR author? Or the ruff team?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-30 07:00</div>
            <div class="timeline-body"><blockquote>
<p>Also, who's responsibility is it to take it out of preview? The PR author? Or the ruff team?</p>
</blockquote>
<p>We'll take it out of preview, following our versioning policy.</p>
<p>Is this change in line with the upstream ASYNC rule?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-30 12:14</div>
            <div class="timeline-body"><blockquote>
<p>Is this change in line with the upstream ASYNC rule?</p>
</blockquote>
<p>I should have mentioned this somewhere, but I looked into the upstream rule yesterday, and it looks like they only flag <code>open</code>, <code>io.open</code>, and <code>io.open_code</code>, so I concluded that we'd already diverged from upstream by handling <code>pathlib.Path.open</code>. But I'm certainly open to your input.</p>
<p>https://github.com/python-trio/flake8-async/blob/1bf61068d7cdaa25b8bdb91cbff017a785df1220/flake8_async/visitors/visitor2xx.py#L277-L278</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_async/snapshots/ruff_linter__rules__flake8_async__tests__ASYNC230_ASYNC230.py.snap</code>:108 on 2025-08-04 08:29</div>
            <div class="timeline-body"><p>The diagnostics here are fairly confusing as it's not clear to me where I'm calling <code>open</code>. Can we add a help text saying that <code>read_text</code> calls <code>open</code> internally`. We may also want to update the rule's documentation to mention the new (preview only behavior)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-04 08:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-08-04 08:40</div>
            <div class="timeline-body"><blockquote>
<p>I should have mentioned this somewhere, but I looked into the upstream rule yesterday, and it looks like they only flag open, io.open, and io.open_code, so I concluded that we'd already diverged from upstream by handling pathlib.Path.open. But I'm certainly open to your input.</p>
</blockquote>
<p>Considering <code>Path.open</code> does make sense and seems less of a divergence to me than including extra methods. While the new methods are in the spirit of the rule, it does push its boundaries, e.g., a better rule name might be <code>blocking-file-operation-in-async-function</code> as the problem isn't just open (I suspect it's any file IO operation)?</p>
<p>Unlike other rules, the upstream async linter is very actively maintained. That makes it more likely that we'll run into conflicting rules.</p>
<p>I tried to find a related issue or PR upstream but wasn't successful. @Zac-HD: Is this something that has come up with the async rules before? Is this a change you would be open to also make in <code>flake8-async</code> (I'm not expecting you to make the change yourself, just if it's in line with how you designed the rules)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/aidandj">@aidandj</a> reviewed on 2025-08-04 14:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/aidandj">@aidandj</a> on <code>crates/ruff_linter/src/rules/flake8_async/snapshots/ruff_linter__rules__flake8_async__tests__ASYNC230_ASYNC230.py.snap</code>:108 on 2025-08-04 14:51</div>
            <div class="timeline-body"><p>Another option would be to simplify and just remove the mention of open. And just say blocking methods.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Zac-HD">@Zac-HD</a> on 2025-08-04 16:42</div>
            <div class="timeline-body"><p>I think this'd be the first time ruff was ahead of flake8-async, nice!</p>
<p>How about we move this new logic to a new ASYNC233 code, and open an upstream issue to implement it / reserve the number?  I think this is a much better experience for users updating their linter too, since they can use some temporary ignores without missing the current 230 issues.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/aidandj">@aidandj</a> on 2025-08-04 16:59</div>
            <div class="timeline-body"><blockquote>
<p>I think this'd be the first time ruff was ahead of flake8-async, nice!</p>
<p>How about we move this new logic to a new ASYNC233 code, and open an upstream issue to implement it / reserve the number? I think this is a much better experience for users updating their linter too, since they can use some temporary ignores without missing the current 230 issues.</p>
</blockquote>
<p>This seems reasonable. Let me know if there is consensus and I could take a stab at that as well</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Zac-HD">@Zac-HD</a> on 2025-08-04 20:19</div>
            <div class="timeline-body"><p>Upstream issue opened!</p>
<p>Practically speaking, if you're interested in implementing more rules I'd pretty strongly prefer <a href="https://github.com/astral-sh/ruff/issues/8451">pulling more into <code>ruff</code></a> relative to moving this one in the other direction; I already mostly use ruff for speed üòÅ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-08-05 08:16</div>
            <div class="timeline-body"><p>Thanks @Zac-HD</p>
<blockquote>
<p>Practically speaking, if you're interested in implementing more rules I'd pretty strongly prefer https://github.com/astral-sh/ruff/issues/8451 relative to moving this one in the other direction; I already mostly use ruff for speed üòÅ</p>
</blockquote>
<p>We're interested, it's just hard to prioritize with everything else going but we could mark some of those as help wanted (CC: @ntBre wdty?)</p>
<p>A new code sounds good to me. But this may justify removing the exsting pathlib check from <code>ASYNC230</code> (under preview)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jakkdl">@jakkdl</a> on 2025-08-05 10:52</div>
            <div class="timeline-body"><blockquote>
<p>Thanks @Zac-HD</p>
<blockquote>
<p>Practically speaking, if you're interested in implementing more rules I'd pretty strongly prefer #8451 relative to moving this one in the other direction; I already mostly use ruff for speed üòÅ</p>
</blockquote>
<p>We're interested, it's just hard to prioritize with everything else going but we could mark some of those as help wanted (CC: @ntBre wdty?)</p>
<p>A new code sounds good to me. But this may justify removing the exsting pathlib check from <code>ASYNC230</code> (under preview)</p>
</blockquote>
<p>I don't think we have any preference between adding <code>pathlib.Path.open</code> to <code>ASYNC230</code> vs adding all <code>pathlib</code> methods to an <code>ASYNC233</code> in upstream, so we can simply sync to what you end up deciding to do.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-08-05 12:30</div>
            <div class="timeline-body"><blockquote>
<p>We're interested, it's just hard to prioritize with everything else going but we could mark some of those as help wanted (CC: @ntBre wdty?)</p>
</blockquote>
<p>Sounds good to me!</p>
<p>Thank y'all!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:14:39 UTC
    </footer>
</body>
</html>
