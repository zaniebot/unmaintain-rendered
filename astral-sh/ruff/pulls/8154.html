<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consider unterminated f-strings in `FStringRanges` - astral-sh/ruff #8154</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Consider unterminated f-strings in <code>FStringRanges</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/8154">#8154</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2023-10-24 05:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR removes the <code>debug_assertion</code> in the <code>Indexer</code> to allow unterminated f-strings. This is mainly a fix in the development build which now matches the release build.</p>
<p>The fix is simple: remove the <code>debug_assertion</code> which means that the there could be <code>FStringStart</code> and possibly <code>FStringMiddle</code> tokens without a corresponding f-string range in the <code>Indexer</code>. This means that the code requesting for the f-string index need to account for the <code>None</code> case, making the code safer.</p>
<p>This also updates the code which queries the <code>FStringRanges</code> to account for the <code>None</code> case. This will happen when the <code>FStringStart</code> / <code>FStringMiddle</code> tokens are present but the <code>FStringEnd</code> token isn't which means that the <code>Indexer</code> won't contain the range for that f-string.</p>
<h2>Test Plan</h2>
<p><code>cargo test</code></p>
<p>Taking the following code as an example:</p>
<pre><code class="language-python">f&quot;{123}
</code></pre>
<p>This only emits a <code>FStringStart</code> token, but no <code>FStringMiddle</code> or <code>FStringEnd</code> tokens.</p>
<p>And,</p>
<pre><code class="language-python">f&quot;\.png${
</code></pre>
<p>This emits a <code>FStringStart</code> and <code>FStringMiddle</code> token, but no <code>FStringEnd</code> token.</p>
<p>fixes: #8065</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-10-24 05:27</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #8154</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8154" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ<ul>
<li><strong>PR #8156</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8156" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8154?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-10-24 05:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_index/src/fstring_ranges.rs</code>:97 on 2023-10-24 05:33</div>
            <div class="timeline-body"><p>I guess this isn't really required because we'd be providing diagnostics for the same.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dhruvmanila on 2023-10-24 05:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2023-10-24 05:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @dhruvmanila on 2023-10-24 05:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-10-24 05:49</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-10-24 06:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_index/src/fstring_ranges.rs</code>:97 on 2023-10-24 06:42</div>
            <div class="timeline-body"><p>I wonnder if it would be useful to store the range with a missing and position instead of omitting it entirely.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-10-24 07:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_index/src/fstring_ranges.rs</code>:97 on 2023-10-24 07:15</div>
            <div class="timeline-body"><p>To extend on this:  It might even be more correct to simply assume that everything after the fstring start token is inside the fstring if the end token is missing. However, what the correct interpretation is might depend on the specific usage. E.g. adding noqa comments might be a bad idea for unclosed fstring. Rules testing if the range is part of a multiline string could get away by assuming the string goes to the end of the file</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-10-24 07:40</div>
            <div class="timeline-body"><p>Shouldn't unterminated f-strings be caught in the parser?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-10-24 09:18</div>
            <div class="timeline-body"><blockquote>
<p>Shouldn't unterminated f-strings be caught in the parser?</p>
</blockquote>
<p>Yes, they're being caught. The issue which was highlighted in the linked issue is a debug assertion present in constructing the f-string ranges in the indexer. And, the indexer uses the flattened tokens for that purpose which ignores the error tokens.</p>
<p>For the following code snippet,</p>
<pre><code class="language-python">f&quot;{123}
</code></pre>
<p>We would've panicked but only in the debug build which is what this PR fixes.</p>
<p>Actually, the release build could panic as well with:</p>
<pre><code class="language-python">f&quot;\.png${
</code></pre>
<p>And, running with:</p>
<pre><code class="language-console">$ pipx run &quot;ruff==0.1.1&quot; check --isolated --no-cache --select=W605,E999 ~/playground/ruff/fstring.py --fix
error: Panicked while linting /Users/dhruv/playground/ruff/fstring.py: This indicates a bug in Ruff. If you could open an issue at:

    https://github.com/astral-sh/ruff/issues/new?title=%5BLinter%20panic%5D

...with the relevant file contents, the `pyproject.toml` settings, and the following stack trace, we'd be very appreciative!

panicked at 'called `Option::unwrap()` on a `None` value', crates/ruff_linter/src/rules/pycodestyle/rules/invalid_escape_sequence.rs:175:18
Backtrace:    0: _rust_eh_personality
   1: _main
   2: _rust_eh_personality
   3: _rust_eh_personality
   4: _rust_eh_personality
   5: _rust_eh_personality
   6: __rjem_je_witnesses_cleanup
   7: __rjem_je_witnesses_cleanup
   8: _main
   9: _main
  10: _main
  11: _main
  12: _main
  13: _main
  14: _main
  15: _main
  16: start
  17: start
  18: _main
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-10-24 10:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_index/src/fstring_ranges.rs</code>:97 on 2023-10-24 10:02</div>
            <div class="timeline-body"><p>I thought of the same in one of my <a href="https://github.com/astral-sh/ruff/issues/8065#issuecomment-1776530001">proposed solution</a>.</p>
<p>For rules, they're only being used to check <code>W605</code> (invalid escape sequence) and <code>ISC</code> (implicit string concatenation) which will be fine. For the former, the fix will be created (see below) while for later the fix won't be created.</p>
<pre><code class="language-diff">-f&quot;\.png{
+rf&quot;\.png{
</code></pre>
<p>The NoQA logic will need to be looked into though. We might have to somehow mark these ranges as &quot;incomplete from source code point of view&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-10-24 10:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/flake8_implicit_str_concat/rules/implicit.rs</code>:124 on 2023-10-24 10:03</div>
            <div class="timeline-body"><p>These unwrap's aren't safe at all as I thought earlier. Ruff can panic on certain edge cases. It's better to account for the <code>None</code> case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-10-24 12:03</div>
            <div class="timeline-body"><blockquote>
<p>Yes, they're being caught. The issue which was highlighted in the linked issue is a debug assertion present in constructing the f-string ranges in the indexer. And, the indexer uses the flattened tokens for that purpose which ignores the error tokens.</p>
</blockquote>
<p>Sorry, i missed that the index is built during parsing, not after</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-10-24 12:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-24 12:47</div>
            <div class="timeline-body"><p>I believe the Indexer is built before parsing, but not as part of parsing itself. We need to build it regardless of whether the source code is valid, because we do support linting invalid programs (at least for the token-based rules).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-10-24 12:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_index/src/fstring_ranges.rs</code>:97 on 2023-10-24 12:50</div>
            <div class="timeline-body"><p>I'm also fine with adding the entire range, but just omitting the range of an unterminated string seems wrong to me (I rather overestimate than underestimate the f-string range)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-10-24 13:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_index/src/fstring_ranges.rs</code>:97 on 2023-10-24 13:25</div>
            <div class="timeline-body"><p>We should probably avoid adding NoQA directives then otherwise it won't be lexed as a comment and the <code>--add-noqa</code> will keep on adding them.</p>
<pre><code class="language-python">f&quot;\.png
  # noqa: W605
  # noqa: W605
  # ...
</code></pre>
<p>I'm not sure how to store this info. One solution could be to update the signature from <code>BTreeMap&lt;TextSize, TextRange&gt;</code> to <code>BTreeMap&lt;TextSize, FStringRange&gt;</code> where:</p>
<pre><code class="language-rust">struct FStringRange {
	range: TextRange,
	// Is this f-string complete i.e., does it have both the start and end tokens?
	complete: bool
}
</code></pre>
<p>Or, while computing the NoQA mapping we can ignore these ranges by somehow checking if they're for a <em>complete</em> f-string or not.</p>
<p>@charliermarsh Any thoughts here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-10-25 16:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_index/src/fstring_ranges.rs</code>:97 on 2023-10-25 16:39</div>
            <div class="timeline-body"><p>If we did change the type to <code>TreeMap&lt;TextSize, FStringRange&gt;</code>, where would we then use that information to avoid adding NOQA?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-10-26 04:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_index/src/fstring_ranges.rs</code>:97 on 2023-10-26 04:05</div>
            <div class="timeline-body"><p>Earlier I thought that ignoring such ranges here would work:</p>
<p>https://github.com/astral-sh/ruff/blob/29fb86e3c831fd6e72283c0342f85e2b2fa7479c/crates/ruff_linter/src/directives.rs#L154-L171</p>
<p>But, I don't think so as then, by default, Ruff will add the directive at the end of the line.</p>
<p>I think we can update this function to return a <code>Option&lt;TextSize&gt;</code> instead:</p>
<p>https://github.com/astral-sh/ruff/blob/29fb86e3c831fd6e72283c0342f85e2b2fa7479c/crates/ruff_linter/src/noqa.rs#L746-L762</p>
<p>which will be used here and <code>continue</code> on <code>None</code>:</p>
<p>https://github.com/astral-sh/ruff/blob/29fb86e3c831fd6e72283c0342f85e2b2fa7479c/crates/ruff_linter/src/noqa.rs#L527-L527</p>
<p>Note that even if we somehow support this, it'll be impossible to ignore any violation on that line manually. For example,</p>
<pre><code class="language-python"># Unterminated f-string
f&quot;\.png{x}  # noqa: W605
</code></pre>
<p>Here, the <code>noqa</code> comment is part of the f-string and is not a comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-10-26 04:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_index/src/fstring_ranges.rs</code>:97 on 2023-10-26 04:45</div>
            <div class="timeline-body"><p>The plan you described here makes sense to me. Thanks for walking me through it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-10-26 08:16</div>
            <div class="timeline-body"><p>I would prefer if we express the fact that unterminated f-strings are not stored in the return type of <code>innermost</code> rather than just a note but are fine moving forward with this solution.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2023-10-27 11:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @dhruvmanila on 2023-10-27 11:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-10-27 11:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_index/src/fstring_ranges.rs</code>:97 on 2023-10-27 11:02</div>
            <div class="timeline-body"><p>I've a local branch with a possible implementation for this but there are a few complexities involved. I'll proceed with merging this and open a new PR with that change instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Allow unterminated f-strings in the indexer" to "Consider unterminated f-strings in `FStringRanges`" by @dhruvmanila on 2023-10-27 11:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2023-10-27 11:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2023-10-27 11:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-10-27 11:11</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:01:00 UTC
    </footer>
</body>
</html>
