<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hide empty snippets for full-file diagnostics - astral-sh/ruff #19653</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Hide empty snippets for full-file diagnostics</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19653">#19653</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-07-30 23:24
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This is the other commit I wanted to spin off from #19415, currently stacked on #19644.</p>
<p>This PR suppresses blank snippets for empty ranges at the very beginning of a file, and for empty ranges in non-existent files. Ruff includes empty ranges for IO errors, for example.</p>
<p>https://github.com/astral-sh/ruff/blob/f4e93b63351bfe035b1fc5a7bc605a52979e7841/crates/ruff_linter/src/message/text.rs#L100-L110</p>
<p>The diagnostics now look like this (new snapshot test):</p>
<pre><code>error[test-diagnostic]: main diagnostic message
--&gt; example.py:1:1                             
</code></pre>
<p>Instead of [^*]</p>
<pre><code>error[test-diagnostic]: main diagnostic message
--&gt; example.py:1:1
 |
 |
</code></pre>
<h2>Test Plan</h2>
<p>A new <code>ruff_db</code> test showing the expected output format</p>
<p>[^*]: This doesn't correspond precisely to the example in the PR because of some details of the diagnostic builder helper methods in <code>ruff_db</code>, but you can see another example in the current version of the summary in #19415.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @ntBre on 2025-07-30 23:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by @ntBre on 2025-07-30 23:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-07-30 23:35</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_INSTRUMENTATION_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/brent%2Ffull-file-diagnostics?runnerMode=Instrumentation">CodSpeed Instrumentation Performance Report</a></h2>
<h3>Merging #19653 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>brent/full-file-diagnostics</code> (2cfad84) with <code>main</code> (2db4e5d)</sub></p>
<h3>Summary</h3>
<p><code>✅ 42</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-30 23:37</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[WIP] Hide empty snippets for full-file diagnostics" to "Hide empty snippets for full-file diagnostics" by @ntBre on 2025-07-31 20:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @ntBre on 2025-07-31 20:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @ntBre on 2025-07-31 20:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @ntBre on 2025-07-31 20:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @ntBre on 2025-07-31 20:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @ntBre on 2025-07-31 20:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @ntBre on 2025-07-31 20:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @ntBre on 2025-07-31 20:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dcreager removed by @ntBre on 2025-07-31 20:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @ntBre on 2025-07-31 20:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @ntBre on 2025-07-31 20:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @ntBre on 2025-07-31 20:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_annotate_snippets/src/renderer/display_list.rs</code>:1194 on 2025-08-01 08:19</div>
            <div class="timeline-body"><p>Nit: Would it make sense to add an assertion that the snippet has no body (e.g no associated message?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:718 on 2025-08-01 08:20</div>
            <div class="timeline-body"><p>We should mention that this also omits the annotation's message. Or we could phrase it differently and say that everything other than the file name and range are omitted.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:833 on 2025-08-01 08:23</div>
            <div class="timeline-body"><p>Can we document the meaning of a file level annotation here too</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/message/mod.rs</code>:52 on 2025-08-01 08:24</div>
            <div class="timeline-body"><p>Do we have any file level syntax errors? I don't think there should be any</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/message/mod.rs</code>:81 on 2025-08-01 08:28</div>
            <div class="timeline-body"><p>Would it be much more work to instead change the rules that add file level diagnostics rather than doing this &quot;global&quot; override?</p>
<p>(the rule would have to mutate the <code>Diagnostic</code> after reporting it with <code>report_diagnostic</code>).</p>
<p>The reason I'd prefer this is that it makes it more apparent where we rely on this behavior and it doesn't prevent other rules to use an empty range (e.g. what if we had a rule that enforces module level docstrings. That rule would probably ask you to insert the docstring at 0:0.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-01 08:28</div>
            <div class="timeline-body"><p>Thank you. The approach looks good to me but I'm unsure about the ruff integration</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-08-01 13:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/message/mod.rs</code>:81 on 2025-08-01 13:26</div>
            <div class="timeline-body"><p>Ah that's a great idea! We actually do have rules like you're describing. I think at least one import rule suggests adding an import at the top of the file (probably a <code>__future__</code> import rule). It might be easier to handle that in #19415 as I'm going through the snapshots, but I can revert this for now.</p>
<p>You're right about the syntax errors too, I don't think we have any file-level ones. That was just for consistency with the current version.</p>
<p>On second thought, we might want to hold off on this until we can cache the <code>Annotation</code>s. I don't think <code>set_file_level</code> will be cached currently.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-01 13:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/message/mod.rs</code>:81 on 2025-08-01 13:35</div>
            <div class="timeline-body"><blockquote>
<p>On second thought, we might want to hold off on this until we can cache the Annotations. I don't think set_file_level will be cached currently.</p>
</blockquote>
<p>I'm not sure I understand what you mean by caching.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-08-01 13:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_annotate_snippets/src/renderer/display_list.rs</code>:1194 on 2025-08-01 13:55</div>
            <div class="timeline-body"><p>Sure, some kind of assertion makes sense to me. I think we can assert that the snippet source is empty, I'll just have to rework the test to avoid using the builder, which expects a non-empty snippet. It looks like Ruff's real diagnostics that will go through this path should already have empty snippets. We could also check that the annotation labels are empty (the text after <code>^^^</code>), but I think those are always empty for us right now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_annotate_snippets/src/renderer/display_list.rs</code>:1194 on 2025-08-01 14:08</div>
            <div class="timeline-body"><p>I think <code>RenderableSnippet::new</code> might try to expand the snippet to the usual number of context lines, unless we also check <code>is_file_level</code> there. We might have to remove or update the assertion when running this in #19415, but I'll add it for now. It'll be a good reminder to revisit it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-08-01 14:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-08-01 14:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_annotate_snippets/src/renderer/display_list.rs</code>:1194 on 2025-08-01 14:10</div>
            <div class="timeline-body"><p>Oh, maybe that's in line with your suggestion about applying this per-rule. I guess we shouldn't render one of these except in cases where the snippet isn't available, like an <code>io-error</code>!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:833 on 2025-08-01 14:19</div>
            <div class="timeline-body"><p>Good idea, I added a note here about <code>Span</code> too, referring to this section of the <code>Span</code> docs:
https://github.com/astral-sh/ruff/blob/e7e7b7bf216caf6ea2b323c7484550d736ef1ddb/crates/ruff_db/src/diagnostic/mod.rs#L1080-L1084</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-08-01 14:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-08-01 14:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/message/mod.rs</code>:81 on 2025-08-01 14:57</div>
            <div class="timeline-body"><p>(also discussed on Discord, just recording here for future reference)</p>
<p>For caching, I just mean in ruff's diagnostic cache. I think we would lose the <code>is_file_level</code> field on the annotation when converting to a <a href="https://github.com/astral-sh/ruff/blob/main/crates/ruff/src/cache.rs#L454"><code>CacheMessage</code></a></p>
<p>I'll drop the syntax error check because that shouldn't affect any real diagnostics and open an issue to follow up on this after a caching PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/message/mod.rs</code>:81 on 2025-08-01 15:30</div>
            <div class="timeline-body"><p>Let's maybe add a TODO here too</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-08-01 15:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:833 on 2025-08-04 15:26</div>
            <div class="timeline-body"><p>Should this get a TODO that it ought to be removed in favor of Ruff diagnostics being updated to use a <code>None</code> span?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2025-08-04 15:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-08-04 18:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:833 on 2025-08-04 18:42</div>
            <div class="timeline-body"><p>Ah that's a good point. I added an explicit TODO in the code here and also wrote some notes from looking into the options today: https://github.com/astral-sh/ruff/issues/19688#issuecomment-3151925617. In short, I thought we would handle this with a <code>None</code> range on the span, but I think you're right that we should omit the span entirely instead.</p>
<p>It might be a bit tangential to the main issue in #19688, but at least it's recorded somewhere, and I can spin it off later if needed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-08-05 12:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:833 on 2025-08-05 12:17</div>
            <div class="timeline-body"><p>Yeah this at least gives us a possible path toward eventually merging back with upstream.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-08-05 15:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-08-05 15:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-05 15:20</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:14:41 UTC
    </footer>
</body>
</html>
