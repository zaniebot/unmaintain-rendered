<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>enforce required imports even with useless alias - astral-sh/ruff #14287</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>enforce required imports even with useless alias</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14287">#14287</a>
        opened by <a href="https://github.com/dylwil3">@dylwil3</a>
        on 2024-11-11 22:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-11-11 22:29</div>
            <div class="timeline-body"><p>This PR handles a panic that occurs when applying unsafe fixes if a user inserts a required import (I002) that has a &quot;useless alias&quot; in it, like <code>import numpy as numpy</code>, and also selects PLC0414 (useless-import-alias)</p>
<p>In this case, the fixes alternate between adding the required import statement, then removing the alias, until the recursion limit is reached. See linked issue for an example.</p>
<h1>Tests to confirm panic resolved:</h1>
<pre><code class="language-console">$ echo 1 | cargo run --quiet -p ruff -- check --no-cache --isolated --select I002,PLC0414 --config 'lint.isort.required-imports = [&quot;from module import this as this&quot;]' - --unsafe-fixes --fix
from module import this as this
1
Found 1 error (1 fixed, 0 remaining).
</code></pre>
<pre><code class="language-console">$ echo 1 | cargo run --quiet -p ruff -- check --no-cache --isolated --select I002,PLC0414 --config 'lint.isort.required-imports = [&quot;import numpy as numpy&quot;]' - --unsafe-fixes --fix
import numpy as numpy
1
Found 1 error (1 fixed, 0 remaining).
</code></pre>
<p>Closes #14283</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-11-11 22:30</div>
            <div class="timeline-body"><p>Not so happy about the big diff in such a simple rule for an edge case... I welcome alternative suggestions!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-11 22:43</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-12 08:28</div>
            <div class="timeline-body"><p>Could you expand the PR summary with details about what was causing the infinite loop or panic? It would help me review this PR and possibly suggest alternatives.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-11-12 12:23</div>
            <div class="timeline-body"><p>Done! It also occurred to me that it might be better to keep the diagnostic but elide the fix for useless-import-alias. That would serve the purpose of warning the user that something was amiss, and they could override the warning by ignoring the rule.</p>
<p>Edit: Made this change. I did not change the &quot;Fix availability&quot; or documentation because it seems like this is a very rare (nonexistent?) exception, but let me know what you think.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-11-12 21:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/pylint/rules/useless_import_alias.rs</code>:100 on 2024-11-12 21:01</div>
            <div class="timeline-body"><p>Why this part?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2024-11-12 22:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/pylint/rules/useless_import_alias.rs</code>:100 on 2024-11-12 22:13</div>
            <div class="timeline-body"><p>I don't know... This seems to have been there since the original implementation: https://github.com/harupy/ruff/blob/d765fbe5ddca1fa7b735256ebb303799a2e7aa95/src/pylint/plugins.rs#L16</p>
<p>I don't think it's possible to have an alias with a dot in it... maybe it's supposed to be an early return? Is checking for a dot faster than comparing two strings? Certainly can't be that much of a speed up... Anyway, happy to remove it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-11-13 03:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/pylint/rules/useless_import_alias.rs</code>:100 on 2024-11-13 03:41</div>
            <div class="timeline-body"><p>Thanks. Do you mind removing it (here and in the linked location) in a separate PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-13 03:43</div>
            <div class="timeline-body"><p>Do you mind adding a dedicated test for this? Sorry!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2024-11-13 08:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @MichaReiser on 2024-11-13 08:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-13 08:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pylint/rules/useless_import_alias.rs</code>:61 on 2024-11-13 08:57</div>
            <div class="timeline-body"><p>I don't think our testing framework will accept that an always fixable fix isn't always fixable, which makes sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-13 08:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pylint/rules/useless_import_alias.rs</code>:100 on 2024-11-13 08:58</div>
            <div class="timeline-body"><p>Would it make sense to implement helper methods on the <code>isort</code> settings to test if it is a required import to avoid duplicating the logic?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2024-11-14 05:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/pylint/rules/useless_import_alias.rs</code>:100 on 2024-11-14 05:45</div>
            <div class="timeline-body"><p>Ok! Refactored to use new helper methods on <code>isort</code> settings, and I will follow up after this PR is merged to get rid of the check for &quot;.&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-11-14 05:45</div>
            <div class="timeline-body"><blockquote>
<p>Do you mind adding a dedicated test for this? Sorry!</p>
</blockquote>
<p>Added!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2024-11-14 05:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/pylint/rules/useless_import_alias.rs</code>:61 on 2024-11-14 05:52</div>
            <div class="timeline-body"><p>Of course you're right! Changed to &quot;Sometimes&quot; with special message/fix title emitted in case of conflict.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pylint/rules/useless_import_alias.rs</code>:95 on 2024-11-14 06:47</div>
            <div class="timeline-body"><p>Nit: To reduce the amount of repeated code</p>
<pre><code class="language-suggestion">		let mut diagnostic = Diagnostic::new(
          UselessImportAlias {
              required_import_conflict: true,
          },
          alias.range(),
      );
        
    if !checker
        .settings
        .isort
        .requires_module_import(alias.name.to_string(), Some(asname.to_string()))
    {
        
        diagnostic.set_fix(Fix::unsafe_edit(Edit::range_replacement(
		        asname.to_string(),
		        alias.range(),
		    )));
    }

    checker.diagnostics.push(diagnostic);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pylint/rules/useless_import_alias.rs</code>:105 on 2024-11-14 06:47</div>
            <div class="timeline-body"><p>Is it possible to move this as well into <code>requires_member_import</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pylint/rules/useless_import_alias.rs</code>:137 on 2024-11-14 06:48</div>
            <div class="timeline-body"><p>Nit: Same as above, let's invert the check so that we don't need to duplicate the diagnostic creation</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/isort/settings.rs</code>:79 on 2024-11-14 06:49</div>
            <div class="timeline-body"><p>Can we use these new methods in the <code>isort</code> implementation as well? It would help to ensure that both implementations stay in sync</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-11-14 06:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2024-11-14 17:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/pylint/rules/useless_import_alias.rs</code>:95 on 2024-11-14 17:05</div>
            <div class="timeline-body"><p>After creating the diagnostic, the <code>UselessImportAlias</code> object is no longer accessible so we can't change the <code>required_import_conflict</code> field to <code>false</code>. I could create a mutable instance of the violation, but I'd still have to make the diagnostic twice unless I'm missing something (which I probably am!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2024-11-14 17:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/pylint/rules/useless_import_alias.rs</code>:105 on 2024-11-14 17:06</div>
            <div class="timeline-body"><p>I'm not sure I understand the suggestion because <code>required_member_import</code> might check for something like <code>import numpy</code> which is not aliased at all (and shouldn't cause an early return). This block seems to belong to the logic of &quot;are you aliased and useless&quot; rather than &quot;are you required&quot;, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-14 17:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pylint/rules/useless_import_alias.rs</code>:95 on 2024-11-14 17:07</div>
            <div class="timeline-body"><p>You could assign <code>requried_import_conflict</code> to a variable and initialize the property with it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2024-11-14 17:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/isort/settings.rs</code>:79 on 2024-11-14 17:08</div>
            <div class="timeline-body"><p>In the <code>isort</code> implementation we are doing the reverse thing: iterating through the required imports and unpacking them to see if they are found (and adding them if not), rather than packaging up some strings into a named import and then checking if the isort settings contain that. So I'm not sure how to use these specific methods in that case. (apologies again if I'm misunderstanding something here!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-14 17:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pylint/rules/useless_import_alias.rs</code>:105 on 2024-11-14 17:08</div>
            <div class="timeline-body"><p>Makes sense. I assumed that a similar check exists in the isort code and I wanted to deduplicate it. Thanks for explaining.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2024-11-14 17:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/pylint/rules/useless_import_alias.rs</code>:95 on 2024-11-14 17:19</div>
            <div class="timeline-body"><p>ðŸ¤¦ duh thanks ðŸ˜„</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dylwil3 on 2024-11-14 21:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dylwil3 on 2024-11-14 21:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-14 21:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch restored on 2024-11-17 14:28</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 20:51:28 UTC
    </footer>
</body>
</html>
