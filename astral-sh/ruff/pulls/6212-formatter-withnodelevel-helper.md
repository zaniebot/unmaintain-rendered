```yaml
number: 6212
title: "formatter: `WithNodeLevel` helper"
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: with-node-level-helper
created_at: 2023-07-31T21:07:24Z
updated_at: 2023-07-31T21:40:54Z
url: https://github.com/astral-sh/ruff/pull/6212
synced_at: 2026-01-12T15:55:20Z
```

# formatter: `WithNodeLevel` helper

---

_@MichaReiser_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary
There are multiple places where we have formatting code that changes the node level and needs to restore
it once the formatting is complete. 

This is very error prone because it is easy to early return on a formatting error without resturing the node level on the context. 

This PR introduces a new `WithNodeLevel` helper struct that changes the `node_level` during construction and restores it in its `Drop` implementation. 
The new `struct` can be used with the `write` macro because it implements `write_fmt`. However, it lacks the extension methods like `join`, because it isn't a `Formatter` (can't be)

<!-- What's the purpose of the change? What does it do, and why? -->

## Test Plan

`cargo test`
<!-- How was it tested? -->


---

_Label `formatter` added by @MichaReiser on 2023-07-31 21:07_

---

_Review requested from @charliermarsh by @MichaReiser on 2023-07-31 21:07_

---

_Comment by @MichaReiser on 2023-07-31 21:07_

Current dependencies on/for this PR:
* main
  * **PR #6212** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6212" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6212?utm_source=stack-comment).

---

_@charliermarsh approved on 2023-07-31 21:09_

Nice.

---

_Merged by @MichaReiser on 2023-07-31 21:22_

---

_Closed by @MichaReiser on 2023-07-31 21:22_

---

_Branch deleted on 2023-07-31 21:22_

---

_Comment by @github-actions[bot] on 2023-07-31 21:40_

## PR Check Results
### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     10.2Â±0.49ms     4.0 MB/sec    1.01     10.3Â±0.47ms     4.0 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.0Â±0.10ms     8.3 MB/sec    1.03      2.1Â±0.12ms     8.0 MB/sec
formatter/numpy/globals.py                 1.00   234.1Â±11.75Âµs    12.6 MB/sec    1.02   238.7Â±17.94Âµs    12.4 MB/sec
formatter/pydantic/types.py                1.00      4.4Â±0.17ms     5.8 MB/sec    1.02      4.5Â±0.16ms     5.7 MB/sec
linter/all-rules/large/dataset.py          1.00     14.5Â±0.49ms     2.8 MB/sec    1.01     14.6Â±0.53ms     2.8 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.6Â±0.13ms     4.6 MB/sec    1.00      3.6Â±0.15ms     4.6 MB/sec
linter/all-rules/numpy/globals.py          1.00   511.6Â±16.17Âµs     5.8 MB/sec    1.02   521.8Â±23.88Âµs     5.7 MB/sec
linter/all-rules/pydantic/types.py         1.02      6.5Â±0.22ms     3.9 MB/sec    1.00      6.4Â±0.26ms     4.0 MB/sec
linter/default-rules/large/dataset.py      1.00      7.6Â±0.24ms     5.4 MB/sec    1.02      7.7Â±0.40ms     5.3 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1586.6Â±74.30Âµs    10.5 MB/sec    1.04  1643.8Â±59.28Âµs    10.1 MB/sec
linter/default-rules/numpy/globals.py      1.00    180.8Â±7.51Âµs    16.3 MB/sec    1.00   180.0Â±11.31Âµs    16.4 MB/sec
linter/default-rules/pydantic/types.py     1.02      3.4Â±0.13ms     7.5 MB/sec    1.00      3.3Â±0.20ms     7.6 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.03     10.8Â±0.41ms     3.8 MB/sec    1.00     10.4Â±0.34ms     3.9 MB/sec
formatter/numpy/ctypeslib.py               1.02      2.0Â±0.13ms     8.2 MB/sec    1.00  1998.5Â±88.41Âµs     8.3 MB/sec
formatter/numpy/globals.py                 1.00   219.2Â±12.29Âµs    13.5 MB/sec    1.03   226.3Â±27.61Âµs    13.0 MB/sec
formatter/pydantic/types.py                1.01      4.5Â±0.23ms     5.7 MB/sec    1.00      4.4Â±0.13ms     5.8 MB/sec
linter/all-rules/large/dataset.py          1.00     14.0Â±0.32ms     2.9 MB/sec    1.02     14.2Â±0.41ms     2.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.7Â±0.13ms     4.5 MB/sec    1.00      3.7Â±0.11ms     4.5 MB/sec
linter/all-rules/numpy/globals.py          1.00   449.0Â±17.00Âµs     6.6 MB/sec    1.01   453.8Â±19.02Âµs     6.5 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.3Â±0.47ms     4.0 MB/sec    1.00      6.3Â±0.17ms     4.0 MB/sec
linter/default-rules/large/dataset.py      1.00      7.7Â±0.17ms     5.3 MB/sec    1.01      7.8Â±0.22ms     5.2 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1583.6Â±59.55Âµs    10.5 MB/sec    1.00  1588.0Â±67.55Âµs    10.5 MB/sec
linter/default-rules/numpy/globals.py      1.01    177.8Â±7.99Âµs    16.6 MB/sec    1.00    175.6Â±5.68Âµs    16.8 MB/sec
linter/default-rules/pydantic/types.py     1.02      3.5Â±0.13ms     7.4 MB/sec    1.00      3.4Â±0.10ms     7.5 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---
