<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix RUF100 to detect unused file-level noqa directives with specific codes (#17042) - astral-sh/ruff #17061</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix RUF100 to detect unused file-level noqa directives with specific codes (#17042)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17061">#17061</a>
        opened by <a href="https://github.com/maxmynter">@maxmynter</a>
        on 2025-03-30 09:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/maxmynter">@maxmynter</a></div>
            <div class="timeline-body"><p>Closes #17042</p>
Summary
<p>This PR fixes the issue outlined in #17042 where RUF100 (unused-noqa) fails to detect unused file-level noqa directives (<code># ruff: noqa</code> or <code># ruff: noqa: {code}</code>).</p>
<p>The issue stems from two underlying causes:</p>
<ol>
<li><p>For blanket file-level directives (<code># ruff: noqa</code>), there&#x27;s a circular dependency: the directive exempts all rules including RUF100 itself, which prevents checking for usage. This isn&#x27;t changed by this PR. I would argue it is intendend behavior - a blanket <code># ruff: noqa</code> directive should exempt all rules including RUF100 itself.</p>
</li>
<li><p>For code-specific file-level directives (e.g. <code># ruff: noqa: F841</code>), the handling was missing in the <code>check_noqa</code> function. This is added in this PR.</p>
</li>
</ol>
Notes
<ul>
<li><p>For file-level directives, the <code>matches</code> array is pre-populated with the specified codes during parsing, unlike line-level directives which only populate their <code>matches</code> array when actually suppressing diagnostics. This difference requires the somewhat clunky handling of both cases. I would appreciate guidance on a cleaner design :)</p>
</li>
<li><p>A more fundamental solution would be to change how file-level directives initialize the <code>matches</code> array in <code>FileNoqaDirectives::extract()</code>, but that requires more substantial changes as it breaks existing functionality. I suspect discussions in #16483 are relevant for this.</p>
</li>
</ul>
Test Plan
<ul>
<li>Local verification</li>
<li>Added a test case and fixture</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dylwil3">@dylwil3</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-30 12:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/dylwil3">@dylwil3</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-30 12:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-30 14:59</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+17 -0 violations, +0 -0 fixes in 5 projects; 50 projects unchanged)</p>
<a href="https://github.com/ibis-project/ibis">ibis-project/ibis</a> (+1 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/ibis-project/ibis/blob/8e813b0a73c6898273ffc688dc1eebfe56029a6d/ibis/backends/tests/signature/typecheck.py#L8">ibis/backends/tests/signature/typecheck.py:8:1:</a> RUF100 Unused `noqa` directive (unused: `D205`, `D415`, `D400`)
</pre>

</p>

<a href="https://github.com/python/typeshed">python/typeshed</a> (+2 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview --select E,F,FA,I,PYI,RUF,UP,W</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/python/typeshed/blob/1c17cd429c2f91b0066547deb99c537af3e54d39/stdlib/asyncio/__init__.pyi#L1">stdlib/asyncio/__init__.pyi:1:1:</a> RUF100 [*] Unused `noqa` directive (non-enabled: `PLR5501`)
+ <a href="https://github.com/python/typeshed/blob/1c17cd429c2f91b0066547deb99c537af3e54d39/stdlib/typing.pyi#L2">stdlib/typing.pyi:2:1:</a> RUF100 [*] Unused `noqa` directive (unused: `F811`)
</pre>

</p>

<a href="https://github.com/scikit-build/scikit-build-core">scikit-build/scikit-build-core</a> (+6 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/scikit-build/scikit-build-core/blob/155776370261210d1d8d3e69b7f4823f4a8a4183/tests/packages/importlib_editable/pkg/pmod_a.py#L1">tests/packages/importlib_editable/pkg/pmod_a.py:1:1:</a> RUF100 [*] Unused `noqa` directive (unused: `I001`)
+ <a href="https://github.com/scikit-build/scikit-build-core/blob/155776370261210d1d8d3e69b7f4823f4a8a4183/tests/packages/importlib_editable/pkg/sub_a/pmod_b.py#L1">tests/packages/importlib_editable/pkg/sub_a/pmod_b.py:1:1:</a> RUF100 [*] Unused `noqa` directive (unused: `I001`)
+ <a href="https://github.com/scikit-build/scikit-build-core/blob/155776370261210d1d8d3e69b7f4823f4a8a4183/tests/packages/importlib_editable/pkg/sub_b/pmod_c.py#L1">tests/packages/importlib_editable/pkg/sub_b/pmod_c.py:1:1:</a> RUF100 [*] Unused `noqa` directive (unused: `I001`)
+ <a href="https://github.com/scikit-build/scikit-build-core/blob/155776370261210d1d8d3e69b7f4823f4a8a4183/tests/packages/importlib_editable/pkg/sub_b/sub_c/pmod_d.py#L1">tests/packages/importlib_editable/pkg/sub_b/sub_c/pmod_d.py:1:1:</a> RUF100 [*] Unused `noqa` directive (unused: `I001`)
+ <a href="https://github.com/scikit-build/scikit-build-core/blob/155776370261210d1d8d3e69b7f4823f4a8a4183/tests/packages/importlib_editable/pkg/sub_b/sub_d/pmod_e.py#L1">tests/packages/importlib_editable/pkg/sub_b/sub_d/pmod_e.py:1:1:</a> RUF100 [*] Unused `noqa` directive (unused: `I001`)
+ <a href="https://github.com/scikit-build/scikit-build-core/blob/155776370261210d1d8d3e69b7f4823f4a8a4183/tests/packages/importlib_editable/pmod.py#L1">tests/packages/importlib_editable/pmod.py:1:1:</a> RUF100 [*] Unused `noqa` directive (unused: `I001`)
</pre>

</p>

<a href="https://github.com/indico/indico">indico/indico</a> (+1 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/indico/indico/blob/1adbb9e152a5414935f8ab0af5601738ff7becef/indico/legacy/pdfinterface/conference.py#L8">indico/legacy/pdfinterface/conference.py:8:1:</a> RUF100 [*] Unused `noqa` directive (unused: `PLR1702`)
</pre>

</p>

<a href="https://github.com/astropy/astropy">astropy/astropy</a> (+7 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/astropy/astropy/blob/2f687fc9c25c102f95e0869d49edafd9f2929322/astropy/cosmology/_src/core.py#L2">astropy/cosmology/_src/core.py:2:1:</a> RUF100 [*] Unused `noqa` directive (unused: `RUF009`)
+ <a href="https://github.com/astropy/astropy/blob/2f687fc9c25c102f95e0869d49edafd9f2929322/astropy/cosmology/_src/flrw/base.py#L2">astropy/cosmology/_src/flrw/base.py:2:1:</a> RUF100 [*] Unused `noqa` directive (unused: `RUF009`)
+ <a href="https://github.com/astropy/astropy/blob/2f687fc9c25c102f95e0869d49edafd9f2929322/astropy/cosmology/_src/flrw/w0cdm.py#L2">astropy/cosmology/_src/flrw/w0cdm.py:2:1:</a> RUF100 [*] Unused `noqa` directive (unused: `RUF009`)
+ <a href="https://github.com/astropy/astropy/blob/2f687fc9c25c102f95e0869d49edafd9f2929322/astropy/cosmology/_src/flrw/w0wacdm.py#L2">astropy/cosmology/_src/flrw/w0wacdm.py:2:1:</a> RUF100 [*] Unused `noqa` directive (unused: `RUF009`)
+ <a href="https://github.com/astropy/astropy/blob/2f687fc9c25c102f95e0869d49edafd9f2929322/astropy/cosmology/_src/flrw/w0wzcdm.py#L2">astropy/cosmology/_src/flrw/w0wzcdm.py:2:1:</a> RUF100 [*] Unused `noqa` directive (unused: `RUF009`)
+ <a href="https://github.com/astropy/astropy/blob/2f687fc9c25c102f95e0869d49edafd9f2929322/astropy/cosmology/_src/flrw/wpwazpcdm.py#L2">astropy/cosmology/_src/flrw/wpwazpcdm.py:2:1:</a> RUF100 [*] Unused `noqa` directive (unused: `RUF009`)
+ <a href="https://github.com/astropy/astropy/blob/2f687fc9c25c102f95e0869d49edafd9f2929322/astropy/units/tests/test_quantity_annotations.py#L2">astropy/units/tests/test_quantity_annotations.py:2:1:</a> RUF100 [*] Unused `noqa` directive (unused: `FA100`, `FA102`)
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| RUF100 | 17 | 17 | 0 | 0 | 0 |</p>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-31 08:43</div>
            <div class="timeline-body"><p>I&#x27;ll leave this to @dylwil3 to review. What&#x27;s important is that we gate these changes behind preview because it is a &quot;significant&quot; increase of a stable rule&#x27;s scope.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-31 08:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ddeepwell">@ddeepwell</a> on 2025-03-31 17:56</div>
            <div class="timeline-body"><p>I&#x27;m curious how this PR handles the case with <code># ruff: noqa: {code1}, {code2}</code>, where code2 is a code for a used directive while code1 is for an unused directive which should be removed? This case isn&#x27;t in the original issue (#17042), but it&#x27;s basically the same concern, except that the valid code should remain after a fix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-03-31 18:02</div>
            <div class="timeline-body"><p>@maxmynter could you add some test cases along the lines of what @ddeepwell mentioned? and also gate the change behind preview when you get a chance?</p>
<p>I&#x27;m gonna try to check out some of the ecosystem reports to see if we&#x27;re getting any false positives before diving into the implementation</p>
<p>Thank you for your help with this!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/maxmynter">@maxmynter</a> on 2025-03-31 23:15</div>
            <div class="timeline-body"><p>@dylwil3 is the implementation of the feature guard in ecbe562 sufficient?</p>
<p>I am a unsure since I haven&#x27;t worked with feature guards -- let me know if something is missing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/maxmynter">@maxmynter</a> on 2025-03-31 23:47</div>
            <div class="timeline-body"><p>Thanks for flagging @ddeepwell, ~~the current implementation deletes the whole file level <code>ruff: noqa:</code> directive if one code is wrong.~~</p>
<p>Edit: This is not the case. I had misremembered rule <a href="https://docs.astral.sh/ruff/rules/unused-variable/">F841</a> which does not apply at the file root; deletion in the example that prompted this comment was wanted.</p>
<p>The proposed changes handle (and test) the cases when one code is unused and the other one is used.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/maxmynter">@maxmynter</a> on 2025-04-02 21:01</div>
            <div class="timeline-body"><p>@dylwil3 ping :)</p>
<p>No worries if you don&#x27;t have the bandwidth at the moment; i just wanted to let you know that I&#x27;m unsure about the next steps here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-04-02 21:15</div>
            <div class="timeline-body"><p>Thanks for the ping! Hoping to get to this tomorrow morning - sorry for the delay!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/checkers/noqa.rs</code>:200 on 2025-04-03 13:22</div>
            <div class="timeline-body"><p>We also support <code>flake8: noqa:</code> and we should probably use the same prefix that the user had originally (even though that will likely be a bit annoying to implement). Luckily, since the directive has already been parsed, you know that it&#x27;s valid syntax and could probably do something naive to tell the difference between <code>flake8</code> and <code>ruff</code> prefixes. The alternative option would be to modify the <code>noqa</code>-lexing (https://github.com/astral-sh/ruff/blob/755ece0c36ea0f1064b496f2daf4c5fd97565667/crates/ruff_linter/src/noqa.rs) to preserve the prefix. But I would recommend first seeing if there&#x27;s an ad-hoc way to discern the prefix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> requested changes on 2025-04-03 13:25</div>
            <div class="timeline-body"><p>This looks good, thank you! The gating behind <code>preview</code> looks correct. I&#x27;m not sure why it&#x27;s not reflected in the ecosystem check... I can&#x27;t reproduce it locally. I&#x27;ll try to investigate it.</p>
<p>In the meantime, I&#x27;ve just left one more issue to address about preserving the prefix used by the user for file-level directives.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/maxmynter">@maxmynter</a> reviewed on 2025-04-04 04:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/maxmynter">@maxmynter</a> on <code>crates/ruff_linter/src/checkers/noqa.rs</code>:200 on 2025-04-04 04:19</div>
            <div class="timeline-body"><p>I went with an ad hoc solution in <a href="https://github.com/astral-sh/ruff/pull/17061/commits/f8947c48ef2730f0a428378ffa332fa028ee56ba">f8947c4</a> that seems to work fine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dylwil3">@dylwil3</a> by <a href="https://github.com/maxmynter">@maxmynter</a> on 2025-04-04 04:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/checkers/noqa.rs</code>:201 on 2025-04-04 18:13</div>
            <div class="timeline-body"><p>We allow whitespace before the colon during <code>noqa</code> parsing, so you should just search for <code>flake8</code> here</p>
<pre><code>                                if original_text.contains(&quot;flake8&quot;) {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> requested changes on 2025-04-04 18:14</div>
            <div class="timeline-body"><p>Looks good! One small change and then looks like there are some merge conflicts to resolve as well</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dylwil3">@dylwil3</a> by <a href="https://github.com/maxmynter">@maxmynter</a> on 2025-04-04 21:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/maxmynter">@maxmynter</a> on 2025-04-04 22:08</div>
            <div class="timeline-body"><p>Merge conflicts were with test cases that i added in #17138. They&#x27;re resolved now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> approved on 2025-04-07 14:21</div>
            <div class="timeline-body"><p>Wonderful, thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-04-07 14:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-04-07 14:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:12:42 UTC
    </footer>
</body>
</html>
