<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] add if-statement support to FlowGraph - astral-sh/ruff #11673</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] add if-statement support to FlowGraph</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11673">#11673</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2024-06-01 04:01
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body">Summary
<p>Add if-statement support to FlowGraph. This introduces branches and joins in the graph for the first time.</p>
Test Plan
<p>Added tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/carljm">@carljm</a> on 2024-06-01 04:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/carljm">@carljm</a> on 2024-06-01 04:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/carljm">@carljm</a> on 2024-06-01 04:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/plredmond">@plredmond</a> reviewed on 2024-06-01 06:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/plredmond">@plredmond</a> on <code>crates/red_knot/src/symbols.rs</code>:570 on 2024-06-01 06:56</div>
            <div class="timeline-body"><p>Does the order that we explore the basic blocks prior to a phi node matter? I guess it&#x27;s going to just be whatever order they are within <code>.predecessors</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/symbols.rs</code>:574 on 2024-06-01 08:00</div>
            <div class="timeline-body"><p>Nit: You could have kept the loop</p>
<pre><code>
        loop {
						let flow_node_id = self.pending.pop()?;
            match &amp;self.table.flow_graph.flow_nodes_by_id[flow_node_id] {
                FlowNode::Start =&gt; break Some(Definition::None),
                FlowNode::Definition(def_node) =&gt; {
                    if def_node.symbol_id == self.symbol_id {
                        break Some(def_node.definition.clone());
                    }
                    self.pending.push(def_node.predecessor);
                }
                FlowNode::Branch(branch_node) =&gt; {
                    self.pending.push(branch_node.predecessor);
                }
                FlowNode::Phi(phi_node) =&gt; {
                    self.pending.extend_from_slice(&amp;phi_node.predecessors);
                }
            }
        }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/symbols.rs</code>:608 on 2024-06-01 08:06</div>
            <div class="timeline-body"><p>I&#x27;m not sure how the <code>unreachable</code> PR solved this but having a <code>Vec</code> here is somewhat expensive because we now have to allocate whenever two branches join, and that&#x27;s very common.</p>
<p>It might be worth to spend some time exploring how we can improve this by:</p>
<ul>
<li>Change the <code>Phi</code> node to only ever join 2 branches, and chain them together</li>
<li>Store the predecessors in a centralized storage and only store the <code>Range</code> in the <code>PhiFlowNode</code> into that <code>Vec</code> (requires that we can write all predecessor entries at once).</li>
<li>I would prefer not to, but these are valid options:<ul>
<li>Use an arena allocator for the <code>Vec</code>s</li>
<li>Use <code>SmallVec</code> (reduces the cost for reading but we still pay the cost of having to call <code>Drop</code> when the node goes out of Scope and it adds a cost in the read path which I often found too expensive)</li>
</ul>
</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/symbols.rs</code>:914 on 2024-06-01 08:09</div>
            <div class="timeline-body"><p>This is a nit, but I think adding some empty lines to group the logic would help readers to better understand what&#x27;s happening. It now reads like a text without any paragraphs, which makes it hard to scan.</p>
<pre><code>                self.visit_expr(&amp;node.test);

                let pre_body = self.current_flow_node();
                let if_branch = self.new_flow_node(FlowNode::Branch(BranchFlowNode {
                    predecessor: pre_body,
                }));
                
                self.set_current_flow_node(if_branch);
                self.visit_body(&amp;node.body);
                
                let mut phi_node = PhiFlowNode {
                    predecessors: vec![self.current_flow_node()],
                };
                let mut last_branch = if_branch;
                let mut last_branch_is_else = false;
                
                for clause in &amp;node.elif_else_clauses {
                    if clause.test.is_some() {
                        let clause_branch = self.new_flow_node(FlowNode::Branch(BranchFlowNode {
                            predecessor: last_branch,
                        }));
                        last_branch = clause_branch;
                        self.set_current_flow_node(clause_branch);
                    } else {
                        self.set_current_flow_node(last_branch);
                        last_branch_is_else = true;
                    }
                    self.visit_elif_else_clause(clause);
                    phi_node.predecessors.push(self.current_flow_node());
                }
                
                if !last_branch_is_else {
                    phi_node.predecessors.push(last_branch);
                }
                
                let phi_node_id = self.new_flow_node(FlowNode::Phi(phi_node));
                self.set_current_flow_node(phi_node_id);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/symbols.rs</code>:898 on 2024-06-01 08:10</div>
            <div class="timeline-body"><p>Unrelated question. Does our CFG support branching inside expression or only on a statement level?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-06-01 08:15</div>
            <div class="timeline-body"><p>Nice! The functionality looks good to me. You may want to consider to move the implementation to <code>symbols/cfg</code> (or rename <code>symbols</code> to <code>semantic</code> or <code>binding</code>).</p>
<p>I think we should spend some more time to see if we can come up with a design that avoids the nested <code>Vec</code> inside of the <code>Phi</code> node. The <code>Vec</code> is problematic because it means that we create a ton of allocations because Phi nodes are very common.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-06-01 14:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/src/symbols.rs</code>:574 on 2024-06-01 14:22</div>
            <div class="timeline-body"><p>Good point. Do you find this clearer or more readable than the <code>while let</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-06-01 14:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/src/symbols.rs</code>:898 on 2024-06-01 14:24</div>
            <div class="timeline-body"><p>It should support within expressions too, but it&#x27;s a good callout that I should prioritize implementing a case of that to surface any issues. Also walrus expressions (within expression definitions).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-06-01 14:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/symbols.rs</code>:574 on 2024-06-01 14:25</div>
            <div class="timeline-body"><p>Not really. I may have a slight preference to <code>loop</code> but not that it matters. I was mainly wondering if you rewrote it to a <code>while</code> loop because it wasn&#x27;t clear to you how to achieve the same with a loop.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-06-01 14:26</div>
            <div class="timeline-body"><p>I was holding off on renaming / restructuring for now so as to minimize conflicts with your salsa work and Patrick&#x27;s symbol table work. But I definitely want to do that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-06-01 15:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/src/symbols.rs</code>:570 on 2024-06-01 15:55</div>
            <div class="timeline-body"><p>In principle it shouldn&#x27;t matter; in practice it may be more intuitive if, when we synthesize a union type from multiple reachable definitions, we try to display that union with elements in source order. I can look at this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/plredmond">@plredmond</a> reviewed on 2024-06-03 04:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/plredmond">@plredmond</a> on <code>crates/red_knot/src/symbols.rs</code>:570 on 2024-06-03 04:11</div>
            <div class="timeline-body"><p>I wonder if the text-locations on the AST nodes can be included in these predecessors, and then instead of a vec we could store them as a heap. That would allow you to add them in any order but obtain source order.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-03 06:46</div>
            <div class="timeline-body"><p>@carljm I&#x27;m still very far off with my salsa work and I probably need to redo my stack once we figured out the entire data model (or at least parts of it) because  @AlexWaygood already made many changes that I need to incorporate somehow. So, don&#x27;t feel blocked by my salsa work but I&#x27;m sure Patrick appreciates it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-06-03 23:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/src/symbols.rs</code>:570 on 2024-06-03 23:44</div>
            <div class="timeline-body"><p>I think we could do that, but we can also achieve the same result just by being careful about the order we list predecessors in a phi node and push them to the pending list in the flow graph.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-06-04 00:12</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+0 -1 violations, +0 -0 fixes in 1 projects; 49 projects unchanged)</p>
<a href="https://github.com/bokeh/bokeh">bokeh/bokeh</a> (+0 -1 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --no-preview --select ALL</pre>
</p>
<p>

<pre>
- <a href="https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/server/app/selection_histogram.py#L88">examples/server/app/selection_histogram.py:88:42:</a> NPY001 [*] Type alias `np.bool` is deprecated, replace with builtin type
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| NPY001 | 1 | 0 | 1 | 0 | 0 |</p>
</p>


Linter (preview)
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+0 -1 violations, +0 -0 fixes in 1 projects; 49 projects unchanged)</p>
<a href="https://github.com/bokeh/bokeh">bokeh/bokeh</a> (+0 -1 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
- <a href="https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/server/app/selection_histogram.py#L88">examples/server/app/selection_histogram.py:88:42:</a> NPY001 [*] Type alias `np.bool` is deprecated, replace with builtin type
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| NPY001 | 1 | 0 | 1 | 0 | 0 |</p>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-06-04 18:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/src/symbols.rs</code>:570 on 2024-06-04 18:44</div>
            <div class="timeline-body"><p>Got this working and pushed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-06-04 18:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/src/symbols.rs</code>:608 on 2024-06-04 18:45</div>
            <div class="timeline-body"><p>Switched to exactly two predecessors per Phi node, no more vec. Thanks for the suggestion!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-06-04 18:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/src/symbols.rs</code>:574 on 2024-06-04 18:46</div>
            <div class="timeline-body"><p>Switched back to the loop.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-06-04 19:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/src/symbols.rs</code>:914 on 2024-06-04 19:21</div>
            <div class="timeline-body"><p>Good call; I did this, and also added comments explaining the algorithm.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-06-04 19:36</div>
            <div class="timeline-body"><p>Refactoring CFG out of symbol table is tracked in <a href="https://github.com/astral-sh/ruff/issues/11657">astral-sh/ruff#11657</a>, not going to do it in this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/carljm">@carljm</a> on 2024-06-04 21:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2024-06-04 21:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-06-04 21:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-06-05 22:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/src/symbols.rs</code>:570 on 2024-06-05 22:03</div>
            <div class="timeline-body"><p>I was wrong here (inadequate test cases.) It&#x27;s not generally possible to do this the way I was trying to do it (statically in the structure of the flow graph), since some names may be defined in branches where others aren&#x27;t. If we really want to guarantee source order of inferred unions, we would have to explicitly include source-order information in definitions. Not going to prioritize that right now, though.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:04:21 UTC
    </footer>
</body>
</html>
