<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix lexing single-quoted f-string with multi-line format spec - astral-sh/ruff #7787</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix lexing single-quoted f-string with multi-line format spec</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7787">#7787</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2023-10-03 17:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Reported at https://github.com/python/cpython/issues/110259</p>
<h2>Test Plan</h2>
<p>Add test cases for the fix and update the snapshots</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-10-03 17:12</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #7787</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7787" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7787?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dhruvmanila on 2023-10-03 17:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2023-10-03 17:26</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/dhruv/multiline-fstring-with-format-spec">CodSpeed Performance Report</a></h2>
<h3>Merging #7787 will <strong>improve performances by 2.5%</strong></h3>
<p><sub>Comparing <code>dhruv/multiline-fstring-with-format-spec</code> (9e6ae10) with <code>main</code> (17fba99)</sub></p>
<h3>Summary</h3>
<p><code>âš¡ 1</code> improvements
<code>âœ… 24</code> untouched benchmarks</p>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>main</code> | <code>dhruv/multiline-fstring-with-format-spec</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| âš¡ | <code>linter/default-rules[pydantic/types.py]</code> | 38.9 ms | 38 ms | +2.5% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-10-03 17:29</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dhruvmanila on 2023-10-04 10:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @dhruvmanila on 2023-10-04 10:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @dhruvmanila on 2023-10-05 13:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-10-05 13:46</div>
            <div class="timeline-body"><p>The CPython PR has been merged: https://github.com/python/cpython/pull/110271</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pablogsal">@pablogsal</a> on 2023-10-05 13:47</div>
            <div class="timeline-body"><p>Friendly reminder to review the discussion in https://github.com/python/cpython/issues/110259 so you end implementing the same as CPython ðŸ˜‰</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-10-05 13:54</div>
            <div class="timeline-body"><blockquote>
<p>Friendly reminder to review the discussion in <a href="https://github.com/python/cpython/issues/110259">python/cpython#110259</a> so you end implementing the same as CPython ðŸ˜‰</p>
</blockquote>
<p>I did, thanks for the heads up! :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-10-05 14:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:2079 on 2023-10-05 14:56</div>
            <div class="timeline-body"><p>How should this one be interpreted? What is the intended &quot;meaning&quot;? Does this have a format spec, or no?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-10-05 15:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:2079 on 2023-10-05 15:32</div>
            <div class="timeline-body"><p>It does have the format spec and it contains newlines. The interpretation of the actual value is left to the runtime but the parser should preserve the newlines. The reason this is the case for triple-quoted f-strings is to maintain backwards compatibility as the following code works on 3.11 and earlier as well:</p>
<pre><code>In [3]: f&quot;&quot;&quot;{datetime.datetime.now():%Y
   ...:     %m
   ...:     %d}&quot;&quot;&quot;
Out[3]: '2023\n    10\n    05'
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_parser/src/snapshots/ruff_python_parser__lexer__tests__fstring_with_multiline_format_spec.snap</code>:95 on 2023-10-05 15:36</div>
            <div class="timeline-body"><p>Does the parser handle treating this as a format spec?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-10-05 15:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-10-05 15:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/snapshots/ruff_python_parser__lexer__tests__fstring_with_multiline_format_spec.snap</code>:95 on 2023-10-05 15:40</div>
            <div class="timeline-body"><p>Yes, I'll add a test case for it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-10-05 15:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-10-05 15:57</div>
            <div class="timeline-body"><p>Actually, there's more to it for single-quoted f-string that I missed (sorry!). The newline should basically <em>end</em> the lexing of format spec which we currently don't.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pablogsal">@pablogsal</a> on 2023-10-05 16:06</div>
            <div class="timeline-body"><blockquote>
<p>Actually, there's more to it for single-quoted f-string that I missed (sorry!). The newline should basically <em>end</em> the lexing of format spec which we currently don't.</p>
</blockquote>
<p>That's why I suggested to double check :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-10-05 16:30</div>
            <div class="timeline-body"><blockquote>
<p>That's why I suggested to double check :)</p>
</blockquote>
<p>Hehe, I must've missed that part ðŸ˜…</p>
<hr />
<p>I'm going to try a couple solutions and look at the benchmarks, please bear with me :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-10-05 16:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:1208 on 2023-10-05 16:49</div>
            <div class="timeline-body"><p>We need to end the lexing of format spec at every non logical newline because we're still inside the curly braces. This might be error prone if in the future there's other place where we might need to emit a <code>NonLogicalNewline</code> but I think it's not that likely.</p>
<p>Another solution is to have a new <code>State::AfterNonLogicalNewline</code> which then will be checked before we lex for <code>FStringMiddle</code>/<code>FStringEnd</code> token:</p>
<pre><code class="language-rust">pub fn next_token(&amp;mut self) -&gt; LexResult {
    if let Some(fstring) = self.fstrings.current() {
		if self.state.is_after_non_logical_newline() &amp;&amp; fstring.is_in_format_spec(self.nesting) {
			fstring.try_end_format_spec(self.nesting);
		} else if !fstring.is_in_expression(self.nesting) {
			// ...
		}
	}
	// ...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-10-05 17:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:1208 on 2023-10-05 17:07</div>
            <div class="timeline-body"><p>This involves other changes as well so I'm leaning towards solution 1.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-10-05 17:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/snapshots/ruff_python_parser__lexer__tests__fstring_with_multiline_format_spec.snap</code>:220 on 2023-10-05 17:17</div>
            <div class="timeline-body"><p>It's important that <code>b</code> is a <code>Name</code> token as we ended the format spec lexing at the newline. This will help the parser to raise a syntax error (unexpected token 'b') similar to the CPython implementation.</p>
<pre><code class="language-python">f'__{
	x:a
		b
}__'
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Allow multi-line f-string with format spec" to "Fix lexing single-quoted f-string with multi-line format spec" by @dhruvmanila on 2023-10-05 17:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @dhruvmanila on 2023-10-05 17:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-10-05 17:29</div>
            <div class="timeline-body"><p>Update after the first review is that the following case will now raise a syntax error as it should:</p>
<pre><code class="language-python">f'__{
	x:a
		b
}__'
</code></pre>
<p>The reason it didn't earlier is because we didn't end the format spec lexing after we reached the newline (after <code>a</code>). Now, we do which means the lexer will emit a <code>Name</code> token for <code>b</code> for which the parser will raise an unexpected token error.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-10-05 17:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2023-10-05 17:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2023-10-05 17:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-10-05 17:42</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:00:41 UTC
    </footer>
</body>
</html>
