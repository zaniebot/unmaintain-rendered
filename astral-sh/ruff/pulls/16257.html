<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add `per-file-target-version` option - astral-sh/ruff #16257</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add <code>per-file-target-version</code> option</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16257">#16257</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-02-19 15:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR is another step in preparing to detect syntax errors in the parser. It introduces the new <code>per-file-target-version</code> top-level configuration option, which holds a mapping of compiled glob patterns to Python versions. I intend to use the <code>LinterSettings::resolve_target_version</code> method here to pass to the parser:</p>
<p>https://github.com/astral-sh/ruff/blob/f50849aeef51a381af6c27df8595ac0e1ef5a891/crates/ruff_linter/src/linter.rs#L491-L493</p>
<h2>Test Plan</h2>
<p>I added two new CLI tests to show that the <code>per-file-target-version</code> is respected in both the formatter and the linter.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-02-19 15:15</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-19 16:27</div>
            <div class="timeline-body"><p>We should respect the <code>per-file-target-version</code> when resolving the target version for a file being linted or formatted. Ideally, we'd add a CLI test that demonstrates that the <code>per-file-target-version</code> override is respected both for linting and formatting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by @MichaReiser on 2025-02-19 16:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-02-19 16:33</div>
            <div class="timeline-body"><p>That makes sense to me. How does the approach of making the current <code>target_version</code> fields private and requiring callers to use the <code>resolve_target_version</code> method sound to you? I only added <code>LinterSettings::resolve_target_version</code> so far, but I'm assuming a formatter analog would be easy too.</p>
<p>I wasn't sure how many changes to put in this PR, but I think it definitely makes sense to wire it up somehow for useful tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @ntBre on 2025-02-19 16:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-02-19 16:34</div>
            <div class="timeline-body"><p>I'll convert to a draft because I think it's incomplete based on your suggestion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-19 17:31</div>
            <div class="timeline-body"><p>Hmm. I haven't really thought about it. We probably want to avoid calling <code>resolve_target_version</code> everywhere where we compare the target versions. That would become expensive very quickly. Ideally, we would compute the target version for the current file once and then store it somewhere (on <code>Checker</code>?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-02-19 19:33</div>
            <div class="timeline-body"><p>Reopening for review. I added</p>
<ul>
<li><code>Checker::target_version</code> as a field and <code>const</code> method to return the resolved <code>PythonVersion</code> [^1] to be used in lint rules</li>
<li>Target version resolution to the formatter</li>
<li>Two new CLI tests showing that both the linter and formatter respect the new option</li>
</ul>
<p>[^1]: I tried also making the <code>LinterSettings::target_version</code> private, as I mentioned above, but it disrupts a ton of tests that create them directly with code like <code>LinterSettings { ..LinterSettings::default() }</code>. This could be solved with a bunch of <code>with_*</code> methods to build a <code>LinterSettings</code> without <code>pub</code> fields, but after adding two of those and seeing the number of remaining errors, I just made them <code>pub</code> again. I think I caught all of the (current) uses in lint rules while they were private, though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @ntBre on 2025-02-19 19:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @ntBre on 2025-02-19 19:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/settings.rs</code>:168 on 2025-02-20 08:00</div>
            <div class="timeline-body"><p>I'd probably rename this field to <code>default_target_version</code> or <code>unresolved_target_version</code> mainly so that it isn't the <em>perfect fit</em> for what someone might need when writing formatter or linter code. This ensures we take a moment to think about: Is this the right field and maybe consult the documentation. I'm otherwise concerned that it's too easy to accidentally use <code>target_version</code> over the resolved target version.</p>
<p>We should document this field and hint the user toward how they can get the correct target version. The same applies for the <code>LinterSettings</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/options.rs</code>:337 on 2025-02-20 08:02</div>
            <div class="timeline-body"><p>We might want to extend this documentation by mentioning that it is to override the global default <code>target-version</code> or <code>requires-python</code> and mention a use case where this is desired (and what the implications are)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/settings/types.rs</code>:666 on 2025-02-20 08:04</div>
            <div class="timeline-body"><p>Do I understand it correctly that we don't support negated patterns for <code>per-file-target-version</code>? I'm worried that this might be confusing, considering that <code>per-file-ignore</code> does support them.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/settings/types.rs</code>:801 on 2025-02-20 08:05</div>
            <div class="timeline-body"><p>We should use <code>.context</code> or <code>with_context</code> or the error messages will be very unhelpful (e.g. invalid glob, good luck figuring out which glob).</p>
<p>We may also want to use <code>context</code> or <code>with_context</code> in <code>from_options</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/settings/types.rs</code>:670 on 2025-02-20 08:06</div>
            <div class="timeline-body"><p>Do we need to implement <code>Display</code> similar to <code>PerFileIgnores</code>? How does the output in <code>--show-settings</code> look like?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/settings/types.rs</code>:805 on 2025-02-20 08:09</div>
            <div class="timeline-body"><p>I think it's fine to ignore this for now, considering that this is a pre-existing issue with <code>per-file-ignore</code> and it has never come up before. But TOML tables have no defined ordering. This could be problematic if two patterns are overlapping but specify different versions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/settings/types.rs</code>:639 on 2025-02-20 08:11</div>
            <div class="timeline-body"><p>I don't think this comment is useful for future readers, considering that <code>PerFileIgnore</code> has no documentation. It only tells users: Here are two versions of this.</p>
<p>We should instead document whta this struct does (It specifies the target version for a glob pattern). We could also consider extracting a <code>PerFile&lt;T&gt;</code> that's shared between <code>PerFileIgnore</code> and <code>PerFileVersion</code>.</p>
<p>I'd suggest renaming this struct to <code>PerFileTargetVersion</code>. It helps clarifying what kind of version it is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/isort/rules/organize_imports.rs</code>:85 on 2025-02-20 08:13</div>
            <div class="timeline-body"><p>I think I'd prefer to pass in the <code>TargetVersion</code> instead of the <code>path</code>, considering that the <code>path</code> isn't needed here otherwise.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_builtins/rules/stdlib_module_shadowing.rs</code>:103 on 2025-02-20 08:15</div>
            <div class="timeline-body"><p>Could we pass in the target version here instead of resolving it over and over again for every file that's being linted?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/checkers/imports.rs</code>:23 on 2025-02-20 08:16</div>
            <div class="timeline-body"><p>I'd prefer if we pass the <code>PythonVersion</code> here rather than the <code>Path</code>. It currently feels inconsistent where almost all rules take a <code>PythonVersion</code> but there are a few exceptions where we pass the <code>Path</code> and the rule has to figure out how to get the target version.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:253 on 2025-02-20 08:17</div>
            <div class="timeline-body"><p>It could make sense to explicitly pass the <code>PythonVersion</code> as an argument and instead compute it once inside <code>lint_path</code> (or whatever the function is called that finally calls into <code>Checker</code>, there are too many of them)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:509 on 2025-02-20 08:17</div>
            <div class="timeline-body"><p>Let's add some documentation</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/settings.rs</code>:237 on 2025-02-20 08:19</div>
            <div class="timeline-body"><p>I can't comment on line 251 -- thanks GitHub -- but we need to include the new file in the <code>Display</code> implementation (same for <code>LinterSettings</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/commands/format.rs</code>:351 on 2025-02-20 08:22</div>
            <div class="timeline-body"><p>I'd prefer if <code>to_format_options</code> takes an <code>Option&lt;Path&gt;</code> argument. That should also reveal that the <code>per-file-target-version</code> -- as is in this commit -- doesn't work in the LSP. It probably makes sense to quickly spin up a VS code instance, set the <code>ruff.path</code> setting to the debug build executable, and test if the option is respected correctfully in VS Code (I also suggest testing notebooks)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/tests/lint.rs</code>:2628 on 2025-02-20 08:23</div>
            <div class="timeline-body"><p>You may want to add an assertion above without the <code>per-file-target-version</code> override that asserts that <code>UP046</code> triggers on this code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/tests/format.rs</code>:2134 on 2025-02-20 08:25</div>
            <div class="timeline-body"><p>Same as for the linter. I think it would be good to have two assertions in this test:</p>
<ol>
<li>One that asserts how the code gets formatted without the <code>--per-file-target-version</code> configuration set</li>
<li>One that asserts how the code gets formatted <strong>with</strong> the <code>--per-file-target-version</code> set.</li>
</ol>
<p>This ensures that the formatting change is, in fact, only due to the <code>--per-file-target-version</code> configuration and not because the formatter detected any other Python 3.9 syntax in the file and, therefore, decided that it's fine to parenthesize with items.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2025-02-20 08:26</div>
            <div class="timeline-body"><p>This is great! I suggest renaming the field on the setting structs to e.g. <code>default_target_version</code> or <code>global_target_version</code> so that its name raises questions: <em>Hmm, why global? maybe this is not the field I want. Let me check the documentation</em></p>
<p>We should also test this feature in the editor. I think it currently doesn't work for the formatter.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_builtins/rules/stdlib_module_shadowing.rs</code>:136 on 2025-02-20 11:47</div>
            <div class="timeline-body"><p>I'd prefer to pass around a <code>PythonVersion</code> in the <code>ruff_linter</code> crate where possible (only converting it to a <code>u8</code> representing the minor version when crossing the crate boundary and calling a function from the <code>ruff_python_stdlib</code> crate) as it's more strongly typed</p>
<pre><code class="language-suggestion">fn is_allowed_module(settings: &amp;LinterSettings, version: PythonVersion, module: &amp;str) -&gt; bool {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-20 11:48</div>
            <div class="timeline-body"><p>I'll leave this one mostly to Micha, just a quick nit I spotted</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-02-20 18:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/settings/types.rs</code>:805 on 2025-02-20 18:48</div>
            <div class="timeline-body"><p>Ah that's a good point. Based on this outdated(?) comment, it looks like the <code>CompiledPerFileIgnoreList</code> used to be sorted, but I don't see it being sorted anymore.</p>
<p>https://github.com/astral-sh/ruff/blob/470f852f04f0e4284c78d15ce81637540e127558/crates/ruff_linter/src/settings/types.rs#L584-L588</p>
<p>I factored out a generic <code>CompiledPerFileList&lt;T&gt;</code> type, so if we end up needing to sort the lists, we should be able to handle them both at once, at least.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-02-20 18:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/settings/types.rs</code>:666 on 2025-02-20 18:57</div>
            <div class="timeline-body"><p>I took your suggestion in another comment of factoring out a <code>PerFile&lt;T&gt;</code> type, so we should now inherit the same negated globbing behavior as <code>per-file-ignore</code>!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-02-20 19:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_workspace/src/settings.rs</code>:168 on 2025-02-20 19:12</div>
            <div class="timeline-body"><p>Ooh, I like <code>unresolved_target_version</code>. I think that will capture most of what I hoped for with making it private.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-02-20 21:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff/src/commands/format.rs</code>:351 on 2025-02-20 21:15</div>
            <div class="timeline-body"><p>Nice catch! I tested a script and notebook manually in VS Code, and they both seem to be working now. Is there any way to test that here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-02-20 22:45</div>
            <div class="timeline-body"><p>Wow I didn't know eliding the lifetime in a const was a recent feature. I thought clippy used to suggest that :shrug: Maybe I need to start building with 1.80 locally instead of 1.82...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_wasm/src/lib.rs</code>:306 on 2025-02-20 22:56</div>
            <div class="timeline-body"><p>This is the one place I couldn't find a way to get a <code>Path</code>. I noticed some <code>Path::new(&quot;.&quot;)</code> calls up above, though. Is there something useful I could pass here, or do path-based settings not make sense in WASM?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-02-20 22:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-02-20 23:08</div>
            <div class="timeline-body"><p>Thanks @MichaReiser for the thorough review. I think it's in a much better place now. The only open question I see now is how to add tests for the editor integration (if that's possible).</p>
<p>I also feel like there might be a more elegant solution to the generic <code>PerFile&lt;T&gt;</code> stuff, but I haven't found it yet. Probably we could remove some of the wrapper newtypes and just use the generic versions directly at least, if we want to.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-21 07:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_wasm/src/lib.rs</code>:306 on 2025-02-21 07:10</div>
            <div class="timeline-body"><p>The files in the wasm playground don't have a path, so I think this is fine</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/settings/mod.rs</code>:232 on 2025-02-21 07:13</div>
            <div class="timeline-body"><p>I'd probably mention <code>Checker.target_version</code> first because that's what most devs should use.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/settings/types.rs</code>:677 on 2025-02-21 07:15</div>
            <div class="timeline-body"><p>I'd probably add a third argument: <code>debug_label: &amp;'static str</code> over introducing my own trait. Seems simpler</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/settings/types.rs</code>:728 on 2025-02-21 07:16</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    T: Display,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/settings/types.rs</code>:625 on 2025-02-21 07:17</div>
            <div class="timeline-body"><pre><code class="language-suggestion">pub struct CompiledPerFileList&lt;T&gt; {
</code></pre>
<p>I prefer to avoid having type constraints in struct and instead, only add them on the impls where needed.</p>
<p>I think the downside of this is that you'd have to implement <code>CacheKey</code> manually (because we aren't using Rust edition 2024 yet)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-02-21 07:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-21 07:21</div>
            <div class="timeline-body"><blockquote>
<p>The only open question I see now is how to add tests for the editor integration (if that's possible).</p>
</blockquote>
<p>There are a few end to end tests in the VS code extension but it isn't something we have good infrastructure today. But @dhruvmanila knows better than I.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-02-21 13:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/settings/mod.rs</code>:232 on 2025-02-21 13:08</div>
            <div class="timeline-body"><p>Oh, of course</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-02-21 13:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/settings/types.rs</code>:625 on 2025-02-21 13:35</div>
            <div class="timeline-body"><p>Ah that makes sense, I did find it annoying to have to  put <code>: CacheKey</code> everywhere. I took a brief look at adding the trait bounds in the derive macro, but I probably need a little more proc macro practice before tackling that!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/settings/types.rs</code>:625 on 2025-02-21 13:38</div>
            <div class="timeline-body"><p>I'm not sure if that's something that you even can do in the proc macro? I'd suggest to simply implement <code>CacheKey</code> manually.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-21 13:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-02-21 13:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/settings/types.rs</code>:625 on 2025-02-21 13:42</div>
            <div class="timeline-body"><p>That's what <code>Clone</code> does, so I thought it was possible. But I looked for the source code, and it said <code>Clone</code> was a compiler builtin, so maybe you're right. I already switched to the manual impl locally, I was just curious.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-02-21 13:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/settings/types.rs</code>:625 on 2025-02-21 13:59</div>
            <div class="timeline-body"><p>I think <a href="https://github.com/serde-rs/serde/blob/e3eaa6a3dd6edd701476097182313cdbd73da78c/serde_derive/src/ser.rs#L130">serde</a> might be able to do it too, again just for my curiositiy, I don't think we need to do this here. <code>CacheKey</code> is easy to implement.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-02-21 14:02</div>
            <div class="timeline-body"><blockquote>
<p>There are a few end to end tests in the VS code extension but it isn't something we have good infrastructure today. But @dhruvmanila knows better than I.</p>
</blockquote>
<p>I've talked with Brent in regards to this on Discord. Looking at the change that fixed the issue which you were pointing out earlier there are two options:</p>
<ol>
<li>Add unit tests in https://github.com/astral-sh/ruff/blob/df9fbdce3af5af826115780f2d8c5cc4d91be650/crates/ruff_server/src/format.rs for <code>format</code> function specifically for per-file-target-version</li>
<li>Add a E2E test in https://github.com/astral-sh/ruff-vscode/blob/main/src/test/e2e.test.ts with a fixture that sets this new option but this would only work <em>after</em> the Ruff release with this option is went out. I wouldn't recommend using this for a new option in Ruff.</li>
</ol>
<p>I'd suggest (1) but I'm longing to create a mock server xD</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-02-21 15:16</div>
            <div class="timeline-body"><p>Yes, thanks @dhruvmanila! I've added unit tests for <code>format</code> and <code>format_range</code> for scripts that parallel the other linter and formatter tests I added, so I think this was a really nice idea.</p>
<p>It looks like notebooks also go through this code path, but I'm happy to add notebook-specific tests if either of you want. It shouldn't be too much trouble if I reuse the <code>create_test_notebook</code> infrastructure from <code>notebook.rs</code>.</p>
<p>Similarly, it looks like linting goes straight through <code>check_path</code>, where the target version resolution happens and is tested in the linter. But again, I'd be happy to add linter tests in the server crate if you want.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-02-24 10:42</div>
            <div class="timeline-body"><p>Thank you for adding those test cases in the language server, they look good.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-02-24 13:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-02-24 13:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-24 13:47</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:10:11 UTC
    </footer>
</body>
</html>
