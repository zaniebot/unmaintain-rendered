```yaml
number: 5047
title: Format Slice Expressions
type: pull_request
state: merged
author: konstin
labels:
  - formatter
assignees: []
merged: true
base: main
head: format-expr-slice
created_at: 2023-06-13T10:36:23Z
updated_at: 2023-06-21T15:29:33Z
url: https://github.com/astral-sh/ruff/pull/5047
synced_at: 2026-01-12T03:43:30Z
```

# Format Slice Expressions

---

_Pull request opened by @konstin on 2023-06-13 10:36_

This formats slice expressions and subscript expressions.

Spaces around the colons follows the same rules as black (https://black.readthedocs.io/en/stable/the_black_code_style/current_style.html#slices):
```python
e00 = "e"[:]
e01 = "e"[:1]
e02 = "e"[: a()]
e10 = "e"[1:]
e11 = "e"[1:1]
e12 = "e"[1 : a()]
e20 = "e"[a() :]
e21 = "e"[a() : 1]
e22 = "e"[a() : a()]
e200 = "e"[a() : :]
e201 = "e"[a() :: 1]
e202 = "e"[a() :: a()]
e210 = "e"[a() : 1 :]
```

Comment placement is different due to our very different infrastructure. If we have explicit bounds (e.g. `x[1:2]`) all comments get assigned as leading or trailing to the bound expression. If a bound is missing `[:]`, comments get marked as dangling and placed in the same section as they were originally in:
```python
x = "x"[ # a
      # b
    :  # c
      # d
]
```
to
```python
x = "x"[
    # a
    # b
    :
    # c
    # d
]
```
Except for the potential trailing end-of-line comments, all comments get formatted on their own line. This can be improved by keeping end-of-line comments after the opening bracket or after a colon as such but the changes were already complex enough.

I added tests for comment placement and spaces.


---

_Comment by @konstin on 2023-06-13 10:36_

Current dependencies on/for this PR:
* main
  * **PR #5047** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5047" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/5047?utm_source=stack-comment).

---

_Comment by @github-actions[bot] on 2023-06-13 10:51_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01      6.6Â±0.03ms     6.2 MB/sec    1.00      6.5Â±0.02ms     6.3 MB/sec
formatter/numpy/ctypeslib.py               1.01   1355.0Â±2.03Âµs    12.3 MB/sec    1.00   1341.3Â±3.36Âµs    12.4 MB/sec
formatter/numpy/globals.py                 1.00    129.8Â±0.98Âµs    22.7 MB/sec    1.00    130.0Â±1.55Âµs    22.7 MB/sec
formatter/pydantic/types.py                1.01      2.7Â±0.01ms     9.3 MB/sec    1.00      2.7Â±0.00ms     9.4 MB/sec
linter/all-rules/large/dataset.py          1.00     13.2Â±0.09ms     3.1 MB/sec    1.02     13.5Â±0.10ms     3.0 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.4Â±0.01ms     5.0 MB/sec    1.00      3.4Â±0.02ms     5.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    423.7Â±0.90Âµs     7.0 MB/sec    1.00    425.8Â±1.00Âµs     6.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.9Â±0.05ms     4.4 MB/sec    1.01      5.9Â±0.05ms     4.3 MB/sec
linter/default-rules/large/dataset.py      1.00      6.7Â±0.03ms     6.1 MB/sec    1.01      6.8Â±0.04ms     6.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1467.2Â±7.27Âµs    11.3 MB/sec    1.01   1478.5Â±1.93Âµs    11.3 MB/sec
linter/default-rules/numpy/globals.py      1.00    164.2Â±0.87Âµs    18.0 MB/sec    1.01    166.3Â±0.31Âµs    17.7 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.0Â±0.01ms     8.4 MB/sec    1.00      3.1Â±0.01ms     8.4 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.12     10.3Â±0.51ms     4.0 MB/sec    1.00      9.2Â±0.28ms     4.4 MB/sec
formatter/numpy/ctypeslib.py               1.07      2.1Â±0.08ms     8.1 MB/sec    1.00  1909.1Â±77.11Âµs     8.7 MB/sec
formatter/numpy/globals.py                 1.05    197.5Â±8.07Âµs    14.9 MB/sec    1.00    188.2Â±7.54Âµs    15.7 MB/sec
formatter/pydantic/types.py                1.05      4.1Â±0.14ms     6.2 MB/sec    1.00      3.9Â±0.13ms     6.5 MB/sec
linter/all-rules/large/dataset.py          1.00     18.6Â±0.39ms     2.2 MB/sec    1.00     18.6Â±0.40ms     2.2 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.9Â±0.10ms     3.4 MB/sec    1.01      4.9Â±0.27ms     3.4 MB/sec
linter/all-rules/numpy/globals.py          1.03   616.1Â±19.68Âµs     4.8 MB/sec    1.00   595.4Â±21.85Âµs     5.0 MB/sec
linter/all-rules/pydantic/types.py         1.00      8.2Â±0.23ms     3.1 MB/sec    1.01      8.3Â±0.26ms     3.1 MB/sec
linter/default-rules/large/dataset.py      1.05      9.9Â±0.27ms     4.1 MB/sec    1.00      9.4Â±0.25ms     4.3 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.05      2.1Â±0.06ms     7.9 MB/sec    1.00  1998.5Â±69.67Âµs     8.3 MB/sec
linter/default-rules/numpy/globals.py      1.07    243.2Â±9.55Âµs    12.1 MB/sec    1.00    227.1Â±8.76Âµs    13.0 MB/sec
linter/default-rules/pydantic/types.py     1.08      4.5Â±0.17ms     5.7 MB/sec    1.00      4.2Â±0.12ms     6.1 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Review requested from @MichaReiser by @konstin on 2023-06-19 06:36_

---

_Label `formatter` added by @konstin on 2023-06-19 06:36_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/comments/placement.rs`:838 on 2023-06-19 09:23_

This comment seems incomplete

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/comments/placement.rs`:853 on 2023-06-19 09:23_

Nit: Does that work?
```suggestion
            if expr_subscript.value.end() < expr_subscript.slice.start() {
```

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/comments/placement.rs`:909 on 2023-06-19 09:26_

Is this something that we want to follow up later (add a todo) or are fine with for now (I'm fine with this but we should then document it in our Black divergence document)

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/comments/visitor.rs`:444 on 2023-06-19 09:27_

Nit: I think taking a `&mut self` would be fine here. It could simplify some of your call sites .

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_slice.rs`:50 on 2023-06-19 09:34_

Nit: Can we optimize this to only iterate over the *after first colon* comments

```suggestion
		let (first_colon_comments, remaining_comments) = slice_dangling_comments.split_at(first_colon_partition_index);
		
        let second_colon_partition_index = 
            second_colon
                .as_ref()
                .map_or(remaining_comments.len(), |second_colon| {
                    remaining_comments
                        .partition_point(|x| x.slice().start() < second_colon.range.start())
                });
```



---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_slice.rs`:69 on 2023-06-19 09:35_

Nit
```suggestion
            let lower_trailing_comments = comments.has_trailing_comments(lower.as_ref().into());
```

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_slice.rs`:105 on 2023-06-19 09:37_

Nit

```suggestion
            let upper_leading_comments = comments.has_leading_comments(upper.as_ref().into());
```

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_slice.rs`:113 on 2023-06-19 09:37_

```suggestion
            let upper_trailing_comments = comments.has_trailing_comments(upper.as_ref().into());
```

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_slice.rs`:73 on 2023-06-19 09:40_

Would the following also work? It would be cheaper because querying comments is somewhat expensive (not very but it requires a hash map lookup). 

```rust
write!(f, [group(&format_args[lower.format(), soft_line_break(), first_colon_space, text(:)])]?;
```

Or does that not work because we want to keep the `:` on the same line as `lower` even if it expands?

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_slice.rs`:146 on 2023-06-19 09:41_

```suggestion
                let step_leading_comments = comments.has_leading_comments(step.as_ref().into());
```

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_slice.rs`:157 on 2023-06-19 09:41_

```suggestion
                if !dangling.is_empty() {
                    // Put the colon and comments on their own lines
                    write!(f, [hard_line_break(), dangling_comments(dangling)])?;
                }
```

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_slice.rs`:122 on 2023-06-19 09:42_

Nit: We shouldn't call into the dangling comments formatting if we know that there are none. 

```suggestion
            if !dangling.is_empty() {
                // put the colon and comments on their own lines
                write!(f, [hard_line_break(), dangling_comments(dangling)])?;
            }
```

---

_@MichaReiser approved on 2023-06-19 09:44_

---

_@konstin reviewed on 2023-06-19 10:00_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/comments/placement.rs`:853 on 2023-06-19 10:00_

it does!

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/comments/placement.rs`:909 on 2023-06-19 10:33_

good idea, done

---

_@konstin reviewed on 2023-06-19 10:33_

---

_@konstin reviewed on 2023-06-19 11:00_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/expr_slice.rs`:50 on 2023-06-19 11:00_

not with that snippet, but a different solution works

---

_@konstin reviewed on 2023-06-19 11:06_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/expr_slice.rs`:73 on 2023-06-19 11:06_

that sounds like a really complex rewrite and i'd like to avoid that :grimacing: 

---

_@MichaReiser reviewed on 2023-06-19 11:10_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_slice.rs`:73 on 2023-06-19 11:10_

You could give it a try for a single expression AND/OR try it as a separate PR. 

---

_Review requested from @MichaReiser by @konstin on 2023-06-19 11:10_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_slice.rs`:47 on 2023-06-21 09:57_

Nit: Would it make sense to already split the halves to avoid the manual slicing e.g. on line 75.

```rust
let (dangling_first_colon_comments, slice_dangling_comments) = slice_dangling_comments.split_at(first_colon_partition_index);
```

It also removes the need to manually add the `first_colon_partition_index` offset to the computed `second_colon_partition_index`

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_slice.rs`:73 on 2023-06-21 09:59_

Nit. You could also use a `line_suffix_boundary` here. That removes the need for checking if there's a comment. A `line_suffix_boundary` automatically enforces a hard line break if there's any pending `line_suffix` (trailing comment)


```suggestion
			write!(f, [left.format(), line_suffix_boundary()])?;
```

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_slice.rs`:94 on 2023-06-21 10:00_

You don't like the `write` macro, do you ;)

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_slice.rs`:259 on 2023-06-21 10:03_

Nit: An alternative would be to format all `end_of_line` comments as `trailing_comments` which does the whitespace normalization for you but it may be more complicated in the end

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_slice.rs`:111 on 2023-06-21 10:04_

Nit: use a line suffix boundary to avoid checking `comments` for trailing comments

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_subscript.rs`:25 on 2023-06-21 10:06_

What's the reason for this assertion? What happens if it is violated in production? Is it necessary because we use `trailing_comments` instead of `dangling_comments` during formatting?

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_subscript.rs`:35 on 2023-06-21 10:08_

I believe that this can result in two comments joining if the subscript has a trailing comment and the `slice`. 

Also, I believe this is a divergence from how we format dangling comments in other places where we preserve the placement between the brackets if the user placed the comments there intentionally.

---

_@MichaReiser approved on 2023-06-21 10:10_

---

_@konstin reviewed on 2023-06-21 11:45_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/expr_subscript.rs`:25 on 2023-06-21 11:45_

The only dangling comment a subscript can have is the one after the `[`, the rest has been assigned to the slice expression.

> What happens if it is violated in production?

Bad, potentially unstable formatting. I can see no case where it would be violated, and there is none in the cpython code base.

---

_@konstin reviewed on 2023-06-21 11:46_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/expr_subscript.rs`:35 on 2023-06-21 11:46_

Could you show an example of what you mean?

---

_@MichaReiser reviewed on 2023-06-21 11:57_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_subscript.rs`:35 on 2023-06-21 11:57_

If I would know python... yes. I would need to familiarize myself with the syntax first. The situation I'm thinking about is what happens if `value` (or any of its children if it doesn't expand) has a trailing comment? 

---

_@konstin reviewed on 2023-06-21 14:17_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/expr_subscript.rs`:35 on 2023-06-21 14:17_

i don't think line breaks are allowed after `value`, so also no comments

---

_@konstin reviewed on 2023-06-21 15:03_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/expr_slice.rs`:94 on 2023-06-21 15:03_

procedural code is kinda convenient :see_no_evil: 

---

_@konstin reviewed on 2023-06-21 15:03_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/expr_slice.rs`:47 on 2023-06-21 15:03_

done, i refactored the whole splitting

---

_Merged by @konstin on 2023-06-21 15:09_

---

_Closed by @konstin on 2023-06-21 15:09_

---

_Branch deleted on 2023-06-21 15:09_

---
