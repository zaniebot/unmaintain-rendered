<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add basic support for `dataclasses.field` - astral-sh/ruff #19553</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add basic support for <code>dataclasses.field</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19553">#19553</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-07-25 08:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body">Summary
<p>Add basic support for <code>dataclasses.field</code>:</p>
<ul>
<li>remove fields with <code>init=False</code> from the signature of the synthesized <code>__init__</code> method</li>
<li>infer correct default value types from <code>default</code> or <code>default_factory</code> arguments</li>
</ul>
<pre><code>from dataclasses import dataclass, field

def default_roles() -&gt; list[str]:
    return [&quot;user&quot;]

@dataclass
class Member:
    name: str
    roles: list[str] = field(default_factory=default_roles)
    tag: str | None = field(default=None, init=False)

# revealed: (self: Member, name: str, roles: list[str] = list[str]) -&gt; None
reveal_type(Member.__init__)
</code></pre>
<p>Support for <code>kw_only</code> has <strong>not</strong> been added.</p>
<p>part of <a href="https://github.com/astral-sh/ty/issues/111">astral-sh/ty#111</a></p>
Test Plan
<p>New Markdown tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-25 08:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-25 08:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-25 08:31</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>hydra-zen (https://github.com/mit-ll-responsible-ai/hydra-zen)
- src/hydra_zen/structured_configs/_implementations.py:3812:62: error[missing-argument] No argument provided for required parameter `CBuildsFn`
- Found 569 diagnostics
+ Found 568 diagnostics

poetry (https://github.com/python-poetry/poetry)
- src/poetry/console/exceptions.py:211:46: error[invalid-argument-type] Argument is incorrect: Expected `ConsoleMessage`, found `CalledProcessError`
- Found 932 diagnostics
+ Found 931 diagnostics

pwndbg (https://github.com/pwndbg/pwndbg)
- pwndbg/aglib/godbg.py:671:54: error[invalid-argument-type] Argument is incorrect: Expected `int`, found `list[Unknown] | Unknown`
- pwndbg/aglib/godbg.py:686:50: error[invalid-argument-type] Argument is incorrect: Expected `int`, found `list[Unknown]`
- pwndbg/aglib/godbg.py:707:60: error[invalid-argument-type] Argument is incorrect: Expected `int`, found `list[Unknown] | Unknown`
- Found 2259 diagnostics
+ Found 2256 diagnostics

meson (https://github.com/mesonbuild/meson)
- mesonbuild/cargo/interpreter.py:428:9: error[invalid-argument-type] Argument is incorrect: Expected `dict[str, dict[str, Dependency]]`, found `str`
- Found 757 diagnostics
+ Found 756 diagnostics

</code></pre>

No memory usage changes detected âœ…

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-25 08:37</div>
            <div class="timeline-body">

<code>ecosystem-analyzer</code> results
<p>| Lint rule | Added | Removed | Changed |
|-----------|------:|--------:|--------:|
| <code>invalid-argument-type</code> | 0 | 5 | 0 |
| <code>missing-argument</code> | 0 | 1 | 0 |
| <strong>Total</strong> | <strong>0</strong> | <strong>6</strong> | <strong>0</strong> |</p>
<p><strong><a href="https://david-dataclasses-field.ecosystem-663.pages.dev/diff">Full report with detailed diff</a></strong></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> removed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-25 08:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-25 08:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[ty] Add support for `dataclasses.field`&quot; to &quot;[ty] Add basic support for `dataclasses.field`&quot; by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-25 09:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-25 09:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-25 09:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-25 09:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-25 09:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/dataclasses/fields.md</code>:41 on 2025-07-25 11:13</div>
            <div class="timeline-body"><p>I think this is a slightly confusing signature for us to display in on-hover tooltips and the like. The reason why the <code>default_factory</code> parameter exists is to avoid this classic footgun in Python, where multiple instances of the same class end up inintentionally sharing the <em>same</em> list as an instance attribute:</p>
<pre><code>&gt;&gt;&gt; class Foo:
...     def __init__(self, x: list[int] = []) -&gt; None:
...         self.x = x
...         
&gt;&gt;&gt; f1 = Foo()
&gt;&gt;&gt; f2 = Foo()
&gt;&gt;&gt; f1.x.append(42)
&gt;&gt;&gt; f1.x
[42]
&gt;&gt;&gt; f2.x
[42]
</code></pre>
<p>The reason why this happens is because the default value of the <code>x</code> parameter is evaluated at class-creation time, not at method-call time, so if you don&#x27;t pass an argument explicitly for the <code>x</code> parameter then an instance of <code>Foo</code> stores a reference to that list instance that was created at class-creation time for its <code>x</code> attribute.</p>
<p>This is typically not what you want, so the usual recommendation to work around this for a non-dataclass is to do something like this:</p>
<pre><code>&gt;&gt;&gt; class Bar:
...     def __init__(self, x: list[int] | None = None) -&gt; None:
...         self.x: list[int] = x or []
...         
&gt;&gt;&gt; b1 = Bar()
&gt;&gt;&gt; b2 = Bar()
&gt;&gt;&gt; b1.x.append(42)
&gt;&gt;&gt; b1.x
[42]
&gt;&gt;&gt; b2.x
[]
</code></pre>
<p>And indeed, at runtime, we see that dataclasses uses a special sentinel as the default value for the synthesized <code>__init__</code> method, rather than a list:</p>
<pre><code>&gt;&gt;&gt; from dataclasses import dataclass, field
&gt;&gt;&gt; @dataclass
... class Baz:
...     x: list[int] = field(default_factory=list)
...     
&gt;&gt;&gt; help(Baz.__init__)
Help on function __init__ in module __main__:

__init__(self, x: list[int] = &lt;factory&gt;) -&gt; None
    Initialize self.  See help(type(self)) for accurate signature.
</code></pre>
<p>I think it would be great if we could show something similar in our synthesized signature, so that it&#x27;s clear to users that the <code>__init__</code> method synthesized by the <code>dataclasses</code> module does not fall into the class trap of mutable default values. It&#x27;s really very central to the design of the dataclasses module to try to guide users away from this footgun: if you attempt to naively provide a mutable default value for a field, an exception is raised that tells you to use <code>default_factory</code> instead:</p>
<pre><code>&gt;&gt;&gt; from dataclasses import dataclass
&gt;&gt;&gt; @dataclass
... class Spam:
...     x: list[int] = []
...     
Traceback (most recent call last):
  File &quot;&lt;python-input-22&gt;&quot;, line 1, in &lt;module&gt;
    @dataclass
     ^^^^^^^^^
  File &quot;/Users/alexw/.pyenv/versions/3.13.1/lib/python3.13/dataclasses.py&quot;, line 1305, in dataclass
    return wrap(cls)
  File &quot;/Users/alexw/.pyenv/versions/3.13.1/lib/python3.13/dataclasses.py&quot;, line 1295, in wrap
    return _process_class(cls, init, repr, eq, order, unsafe_hash,
                          frozen, match_args, kw_only, slots,
                          weakref_slot)
  File &quot;/Users/alexw/.pyenv/versions/3.13.1/lib/python3.13/dataclasses.py&quot;, line 1008, in _process_class
    cls_fields.append(_get_field(cls, name, type, kw_only))
                      ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/Users/alexw/.pyenv/versions/3.13.1/lib/python3.13/dataclasses.py&quot;, line 860, in _get_field
    raise ValueError(f&#x27;mutable default {type(f.default)} for field &#x27;
                     f&#x27;{f.name} is not allowed: use default_factory&#x27;)
ValueError: mutable default &lt;class &#x27;list&#x27;&gt; for field x is not allowed: use default_factory
</code></pre>
<p>(Ideally we would catch this error and emit a diagnostic on it, but we&#x27;d need to be quite careful to avoid false positives. At runtime, any type is rejected if <code>__hash__</code> is set to <code>None</code> on the type, indicating that it is not hashable (and therefore probably mutable). But statically determining whether a type is hashable is surprisingly difficult, because unhashable types often have hashable subclasses in Python -- the Liskov principle is a poor fit for this area of the language.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-07-25 11:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-07-25 12:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/resources/mdtest/dataclasses/fields.md</code>:41 on 2025-07-25 12:44</div>
            <div class="timeline-body"><blockquote>
<p>I think this is a slightly confusing signature for us to display in on-hover tooltips and the like. The reason why the <code>default_factory</code> parameter exists is to avoid this classic footgun in Python</p>
</blockquote>
<p>Right. FWIW, I think there are also other very valid use cases for <code>default_factory</code>, like demonstrated in this example. Or when initialization of a field is expensive.</p>
<blockquote>
<p>I think it would be great if we could show something similar in our synthesized signature, so that it&#x27;s clear to users that the <code>__init__</code> method synthesized by the <code>dataclasses</code> module does not fall into the class trap of mutable default values.</p>
</blockquote>
<p>Hm. I agree that it would be concerning if we displayed something like <code>content: list[int] = []</code>, which rings alarm bells. But we display <code>content: list[int] = list[Unknown]</code>, i.e. a type and not a list literal. Other type checkers simply show <code>content: list[int] =</code> (mypy) or <code>content: list[int] = ...</code> (pyrefly) instead, but I like ty&#x27;s output better. It&#x27;s sometimes helpful to see the default value: <code>max_retries: int = Literal[3]</code>. pyright also shows <code>content: list[int] = list</code>, which seems very similar to what we do.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-07-25 12:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/dataclasses/fields.md</code>:41 on 2025-07-25 12:53</div>
            <div class="timeline-body"><blockquote>
<p>But we display <code>content: list[int] = list[Unknown]</code>, i.e. a type and not a list literal.</p>
</blockquote>
<p>Hm, fair point. I think this in general is pretty confusing TBH: at runtime, the default value is obviously an instance of list, not the type <code>list</code> itself. So why do we tell the user that the default value is the type <code>list</code> itself when they hover over a function? And we don&#x27;t actually use the type of the default value for anything anywhere; we only ever care that the parameter <em>has</em> a default value -- so why do we store the type of the default value on the <code>Signature</code> at all? <em>Users</em> care about the default value, but they generally care about the <em>value</em> of the default value, not the <em>type</em> of the default value -- it would be much more useful if we could display the former (as it appears in the source code) rather than the latter, in the tooltip.</p>
<p>But none of that&#x27;s relevant to your PR here! So I guess I withdraw my objection :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-07-25 12:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/resources/mdtest/dataclasses/fields.md</code>:41 on 2025-07-25 12:55</div>
            <div class="timeline-body"><blockquote>
<p>but they generally care about the <em>value</em> of the default value, not the <em>type</em> of the default value -- it would be much more useful if we could display the former (as it appears in the source code) rather than the latter, in the tooltip.</p>
</blockquote>
<p>Agree!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-25 12:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-25 12:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-25 12:56</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:17:00 UTC
    </footer>
</body>
</html>
