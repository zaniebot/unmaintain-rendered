<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add import insertion support to autofix capabilities - astral-sh/ruff #3787</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add import insertion support to autofix capabilities</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/3787">#3787</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-03-28 22:17
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-28 22:17</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>We often have rules (and violations) that could in theory be autofixed, but that rely on the presence of an imported symbol that may or may not be available in scope.</p>
<p>The <code>sys-exit-alias</code> rule is a good example. It recommends replacing calls to the builtin <code>exit</code> and <code>quit</code> methods with calls to <code>sys.exit</code>. That's &quot;easy&quot; to autofix... as long as <code>sys.exit</code> is in-scope.</p>
<p>This PR enables rules to import symbols into the current scope in a fairly general way, enabling autofix support for rules like <code>sys-exit-alias</code>. Below, I've also extended autofix support for <code>lru-cache-with-maxsize-none</code>, which relies on making <code>functools.cache</code> available.</p>
<h3>How it works</h3>
<p>From a rule's perspective, the end-user API leans on a single <code>get_or_import_symbol</code> method, which returns (1) an <code>Edit</code> (to &quot;insert&quot; the symbol into the scope) and (2) the bound name of the resolved symbol (e.g., <code>exit</code>, if we added <code>from sys import exit</code>, or <code>sys.exit</code>, if we added <code>import sys</code>).</p>
<p>Under-the-hood, that method performs a series of lookups:</p>
<ol>
<li>First, it checks to see if <code>sys.exit</code> is <em>already</em> available in any form (e.g., <code>from sys import exit as foo</code>, <code>import sys as foo</code>); if so, it returns a reference to it.</li>
<li>Otherwise, it checks to see if there's an <code>import ... from</code> for the relevant module (e.g., <code>from sys import path</code>). If so, it modifies that import to include the necessary symbol (<code>from sys import path, exit</code>). If <code>exit</code> is already bound to something else, it aborts and logs an error.</li>
<li>Otherwise, it generates an edit to insert an <code>import sys</code>, and returns <code>sys.exit</code> as the bound reference.</li>
</ol>
<p>The logic for inserting imports is crude and follows LibCST's own logic: if there are no imports, we insert at top-of-file; otherwise, we insert after the last-seen top-level import statement.</p>
<h3>Limitations</h3>
<p>There are a few limitations to the current approach:</p>
<ol>
<li><p>We don't attempt to retain import order at all. We leave that up to the <code>isort</code> rules (or <code>isort</code> itself, if you're using <code>isort</code>).</p>
</li>
<li><p>We <em>only</em> respect top-level imports, so here, we'd still insert an <code>import sys</code>:</p>
</li>
</ol>
<pre><code class="language-py">def f():
  from sys import path

  quit()
</code></pre>
<ol start="3">
<li>Every individual fix (that relies on import insertion) has to go through this process. We may want to implement some sort of cache here.</li>
</ol>
<p>Closes #835.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2023-03-28 22:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @charliermarsh on 2023-03-28 22:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2023-03-28 22:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-03-28 22:54</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     17.1Â±0.34ms     2.4 MB/sec    1.04     17.8Â±0.36ms     2.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.3Â±0.12ms     3.9 MB/sec    1.03      4.5Â±0.16ms     3.7 MB/sec
linter/all-rules/numpy/globals.py          1.00   572.2Â±15.38Âµs     5.2 MB/sec    1.00   573.5Â±14.79Âµs     5.1 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.3Â±0.25ms     3.5 MB/sec    1.03      7.6Â±0.16ms     3.4 MB/sec
linter/default-rules/large/dataset.py      1.00      8.6Â±0.13ms     4.7 MB/sec    1.09      9.4Â±0.32ms     4.3 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1977.1Â±55.79Âµs     8.4 MB/sec    1.03      2.0Â±0.08ms     8.2 MB/sec
linter/default-rules/numpy/globals.py      1.00    235.8Â±7.58Âµs    12.5 MB/sec    1.03   242.3Â±11.21Âµs    12.2 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.0Â±0.09ms     6.4 MB/sec    1.06      4.3Â±0.11ms     6.0 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     13.7Â±0.17ms     3.0 MB/sec    1.00     13.7Â±0.18ms     3.0 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.4Â±0.03ms     4.9 MB/sec    1.00      3.4Â±0.04ms     4.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    358.0Â±6.67Âµs     8.2 MB/sec    1.00    357.8Â±3.90Âµs     8.2 MB/sec
linter/all-rules/pydantic/types.py         1.01      5.7Â±0.06ms     4.4 MB/sec    1.00      5.7Â±0.06ms     4.5 MB/sec
linter/default-rules/large/dataset.py      1.01      7.3Â±0.07ms     5.6 MB/sec    1.00      7.2Â±0.07ms     5.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01  1508.0Â±13.70Âµs    11.0 MB/sec    1.00  1494.8Â±18.25Âµs    11.1 MB/sec
linter/default-rules/numpy/globals.py      1.00    156.1Â±1.85Âµs    18.9 MB/sec    1.00    156.3Â±3.88Âµs    18.9 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.2Â±0.03ms     7.9 MB/sec    1.00      3.2Â±0.04ms     8.0 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-03-28 22:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/importer.rs</code>:145 on 2023-03-28 22:54</div>
            <div class="timeline-body"><p>GitHub isn't picking it up, but everything from here down is moved from <code>rules/isort/rules/add_required_import.rs</code> (which now uses this <code>Importer</code> struct).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/autofix/helpers.rs</code>:488 on 2023-03-28 22:56</div>
            <div class="timeline-body"><p>This piece here is a hack. Consider:</p>
<pre><code class="language-py">import sys

quit()
</code></pre>
<p>Assume you <em>omit</em> this hack. If you run with <code>unused-imports</code> and <code>sys-exit-alias</code> here, then we'll generate two fixes: (1) we'll remove the unused <code>import sys</code>; (2) we'll replace <code>quit()</code> with <code>sys.exit()</code>, under the assumption that <code>sys</code> is already imported and available. That'd leave us with an invalid reference.</p>
<p>The workaround is to add a &quot;fake&quot; edit to replace <code>import sys</code> with <code>import sys</code>. This ensures that we don't try to apply conflicting autofixes to the file.</p>
<p>We may be getting to the point at which we want to avoid trying to apply multiple fixes in the same autofix pass (which would also avoid this issue).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-03-28 22:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-03-29 05:36</div>
            <div class="timeline-body"><p>What happens if <code>sys</code>is shadowed?
Do you import <code>sys</code> with an alias like <code>sys_</code> with as many <code>_</code> necessary to avoid the shadowing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-29 13:47</div>
            <div class="timeline-body"><p>No, we avoid fixing if the name is already bound to something else. In practice, I think that's the least surprising behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/checkers/ast/mod.rs</code>:205 on 2023-03-30 06:36</div>
            <div class="timeline-body"><p>Nit: Surprising that clippy isn't flagging this</p>
<pre><code class="language-suggestion">            if scope_index.is_global() &amp;&amp;self.ctx.current_stmt_parent().is_none() {
                self.importer.visit_import(stmt);
            }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/cst/matchers.rs</code>:64 on 2023-03-30 06:37</div>
            <div class="timeline-body"><p>What's the reason for using <code>bail</code> here instead of returning <code>Err</code> and propagating the error (we'll have to replace all <code>bail</code>, <code>warn_once</code> at some point in the future if we want to build a python API)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/importer.rs</code>:54 on 2023-03-30 06:39</div>
            <div class="timeline-body"><p>Nit: I would use <code>panic</code> here instead of <code>unreachable</code> because you use it as an invariant. It isn't that the code above guarantees that this path isn't possible.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-03-30 06:42</div>
            <div class="timeline-body"><p>Nice!</p>
<p>Can we add a test case that demonstrates what happens if we have</p>
<pre><code class="language-python">if test:
	import path


exit(1)
</code></pre>
<p>or</p>
<pre><code class="language-python">import path

if test:
	pass

import numpy

// ...

exit(1)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff/src/autofix/helpers.rs</code>:488 on 2023-03-30 09:56</div>
            <div class="timeline-body"><p>i'd add this to the code comment</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff/src/autofix/helpers.rs</code>:508 on 2023-03-30 09:59</div>
            <div class="timeline-body"><p>why not <code>from functools import lru_cache</code>? that's what i'd expect and afaik that's what pycharm generally does</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff/src/cst/matchers.rs</code>:64 on 2023-03-30 10:03</div>
            <div class="timeline-body"><p>(fwiw there's anyhow integration with pyo3 that translates them into <code>RuntimeError</code>, but i agree that proper error types are better)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff/src/importer.rs</code>:17 on 2023-03-30 10:08</div>
            <div class="timeline-body"><p>learning question: why is this type called a suit?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff/src/importer.rs</code>:47 on 2023-03-30 10:14</div>
            <div class="timeline-body"><p>Nit: i find those easier to read</p>
<pre><code class="language-suggestion">                if level == Some(0) {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_ast/src/imports.rs</code>:64 on 2023-03-30 10:31</div>
            <div class="timeline-body"><p>i never realized that <code>from ....bar import foo</code> valid syntax and now i'm a scared of imports</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-03-30 10:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/cst/matchers.rs</code>:64 on 2023-03-30 10:33</div>
            <div class="timeline-body"><p>Oh, I think I confused what <code>bail!</code> does. Does bail return an <code>Err</code>? If so, then I think that's fine for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-03-30 10:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-03-30 10:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff/src/cst/matchers.rs</code>:64 on 2023-03-30 10:47</div>
            <div class="timeline-body"><p>yes it's just a convenience macro around that: https://docs.rs/anyhow/latest/src/anyhow/macros.rs.html#56-66</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-03-30 15:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/checkers/ast/mod.rs</code>:205 on 2023-03-30 15:18</div>
            <div class="timeline-body"><p>We have that rule disabled, I actually find nested <code>if</code> blocks to be much clearer but it's a completely subjective thing ðŸ™ˆ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-03-30 15:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/importer.rs</code>:17 on 2023-03-30 15:19</div>
            <div class="timeline-body"><p>It comes from RustPython. It's kind of like how a test suite is a collection of tests. <code>Suite</code> is just <code>Vec&lt;Stmt&gt;</code> IIRC -- so, a collection of statements.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/importer.rs</code>:54 on 2023-03-30 15:20</div>
            <div class="timeline-body"><p>Let me change this in a separate pass because we do this in a lot of places (but what you're saying makes sense).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-03-30 15:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-03-30 15:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_ast/src/imports.rs</code>:64 on 2023-03-30 15:20</div>
            <div class="timeline-body"><p>As you should be!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-03-30 15:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/autofix/helpers.rs</code>:508 on 2023-03-30 15:23</div>
            <div class="timeline-body"><p>Yeah I wasn't sure what the default should be here. I was thinking that it should be rule-dependent (e.g., it makes sense to do <code>from typing import List</code> rather than <code>import typing; typing.List</code> if we need to inject from typing).</p>
<p>Where does PyCharm do this? When you have <code>@cache</code> and cache isn't imported? (But in that case, the user has already expressed that they want the member, not the fully-qualified name.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-03-30 15:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/importer.rs</code>:47 on 2023-03-30 15:24</div>
            <div class="timeline-body"><p>In this case, though, we want to allow <code>None</code> or <code>Some(0)</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/checkers/ast/mod.rs</code>:205 on 2023-03-30 15:26</div>
            <div class="timeline-body"><p>It was useful for us because we often had things gated beyond <code>settings.rules.enabled</code> checks and it was useful to separate them conceptually, like:</p>
<pre><code class="language-rust">if settings.rules.enabled(Rule:...) {
  if condition_for_rule {
    do_rule
  }
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-03-30 15:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/checkers/ast/mod.rs</code>:205 on 2023-03-30 15:27</div>
            <div class="timeline-body"><p>Changed here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-03-30 15:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-03-30 15:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff/src/autofix/helpers.rs</code>:508 on 2023-03-30 15:29</div>
            <div class="timeline-body"><p>yes, this:</p>
<pre><code class="language-python">@cache
def foo():
    ...
</code></pre>
<p>quck fix -&gt; enter -&gt; enter:</p>
<pre><code class="language-python">from functools import cache


@cache
def foo():
    ...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-03-30 15:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-03-30 15:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-03-30 15:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/autofix/helpers.rs</code>:508 on 2023-03-30 15:33</div>
            <div class="timeline-body"><p>Yeah but in that case, the user has already written <code>@cache</code>.</p>
<p>Given:</p>
<pre><code class="language-py">@functools.cache
def f(x):
    return x
</code></pre>
<p>Then the same action yields:</p>
<pre><code class="language-py">import functools

@functools.cache
def f(x):
    return x
</code></pre>
<p>Here, we don't know which the user prefers ahead-of-time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-03-30 15:33</div>
            <div class="timeline-body"></div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 04:29:43 UTC
    </footer>
</body>
</html>
