<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allow discovery of venv in VIRTUAL_ENV env variable - astral-sh/ruff #16853</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Allow discovery of venv in VIRTUAL_ENV env variable</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16853">#16853</a>
        opened by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a>
        on 2025-03-19 17:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a></div>
            <div class="timeline-body">

Summary
<p>Fixes astral-sh/ty#171</p>
<p>Allows the cli to find a virtual environment from the VIRTUAL_ENV environment variable if no --python is set</p>
Test Plan
<p>Unsure how to mock a venv to test that this works</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-19 17:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-19 17:37</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/program.rs</code>:166 on 2025-03-19 17:41</div>
            <div class="timeline-body"><p>Using this approach for when <code>VIRTUAL_ENV</code> is set does make sense to me because we probably want Red Knot to fail if <em>whatever <code>VIRTUAL_ENV</code></em> is pointing to doesn&#x27;t turn out to be a virtual env.</p>
<p>I&#x27;m not sure if it&#x27;s the right approach to e.g. support <code>.venv</code> because we then only want to use the folder if it actually is a virtual env.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/program.rs</code>:148 on 2025-03-19 17:41</div>
            <div class="timeline-body"><p>What&#x27;s the motivation for introducing a new variant over using <code>SysPrefix</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-19 17:41</div>
            <div class="timeline-body"><p>Nice</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-19 18:56</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-03-19 19:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/red_knot_python_semantic/src/program.rs</code>:166 on 2025-03-19 19:57</div>
            <div class="timeline-body"><p>I should probably look at this for parity with uv..</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-03-20 11:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-03-20 11:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-03-20 11:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-03-20 11:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-03-20 11:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_project/src/metadata/options.rs</code>:111 on 2025-03-20 11:29</div>
            <div class="timeline-body"><p>Arguments to <code>.or()</code> are eagerly evaluated. If we use <code>.or_else()</code>, it will be lazily evaluated:</p>
<pre><code>                .or_else(|| PythonPath::find_virtual_env(system))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/module_resolver/resolver.rs</code>:231 on 2025-03-20 11:31</div>
            <div class="timeline-body"><p>I think you can just use a reference here rather than a clone -- it should be slightly more efficient:</p>
<pre><code>                VirtualEnvironment::new(&amp;sys_prefix.inner, sys_prefix.origin, system)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/program.rs</code>:4 on 2025-03-20 11:32</div>
            <div class="timeline-body"><p>nit:</p>
<pre><code>use crate::site_packages::{SysPrefixPath, SysPrefixPathOrigin};
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/program.rs</code>:165 on 2025-03-20 11:36</div>
            <div class="timeline-body"><p>You can simplify this a little by short-circuiting immediately using <code>?</code> if <code>std::env::var(&quot;VIRTUAL_ENV&quot;).ok()</code> returns <code>None</code>:</p>
<pre><code>        let virtual_env = std::env::var(&quot;VIRTUAL_ENV&quot;).ok()?;
        tracing::debug!(&quot;Found virtual environment at {:?}&quot;, virtual_env);
        SysPrefixPath::new(virtual_env, SysPrefixPathOrigin::VirtualEnvVar, system)
            .ok()
            .map(Self::SysPrefix)
</code></pre>
<p>I think it might also be good to say in the tracing message that we found the virtual environment from the <code>VIRTUAL_ENV</code> variable rather than <code>--python</code> or anything else -- that could be useful information when debugging. So maybe something like this?</p>
<pre><code>        let virtual_env = std::env::var(&quot;VIRTUAL_ENV&quot;).ok()?;
        tracing::debug!(&quot;Found virtual environment at {:?} from `VIRTUAL_ENV` environment variable&quot;, virtual_env);
        SysPrefixPath::new(virtual_env, SysPrefixPathOrigin::VirtualEnvVar, system)
            .ok()
            .map(Self::SysPrefix)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/site_packages.rs</code>:385 on 2025-03-20 11:39</div>
            <div class="timeline-body"><p>it might be slightly better to keep these fields private and have <code>pub(crate)</code> accessor methods:</p>
<pre><code>pub struct SysPrefixPath {
    inner: SystemPathBuf,
    origin: SysPrefixPathOrigin,
}

impl SysPrefixPath {
    pub(crate) fn inner(&amp;self) -&gt; &amp;SystemPath {
        &amp;self.inner
    }
    
    pub(crate) fn origin(&amp;self) -&gt; SysPrefixPathOrigin {
        self.origin
    }

</code></pre>
<p>though it probably doesn&#x27;t matter that much in practice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-03-20 11:40</div>
            <div class="timeline-body"><p>this is looking great!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-03-20 12:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-03-20 12:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/site_packages.rs</code>:62 on 2025-03-20 12:26</div>
            <div class="timeline-body"><p>I&#x27;ve realised that there&#x27;s an issue here, which is that now the path to the virtual environment is validated twice:</p>
<ul>
<li>Once eagerly in <code>PythonPath::find_virtual_env()</code> / <code>PythonPath::from_cli_flag()</code></li>
<li>And then again later on in <code>VirtualEnvironment::new()</code> here</li>
</ul>
<p>It&#x27;s better if we validate the path to the virtual environment later, because we can use the <code>Result</code> return type of <code>VirtualEnvironment::new()</code> to give a nice error message to the user about why the path given to the virtual environment is invalid (with the eager validation that we&#x27;re doing on this PR branch currently, we have to throw away all the details about the error by calling <code>.ok()</code> on it). The validation is done by <code>SysPrefixPath::new()</code>, so if we only want the validation to be done inside this module, that implies that we should make <code>SysPrefixPath</code> private again. Instead, I think we can just add another field to the <code>SysPrefix</code> variant of <code>PythonPath</code>. Something like this (the diff is relative to your branch):</p>
<pre><code>diff --git a/crates/red_knot_project/src/metadata/options.rs b/crates/red_knot_project/src/metadata/options.rs
index b115141ee..43a6c4233 100644
--- a/crates/red_knot_project/src/metadata/options.rs
+++ b/crates/red_knot_project/src/metadata/options.rs
@@ -105,10 +105,14 @@ impl Options {
             src_roots,
             custom_typeshed: typeshed.map(|path| path.absolute(project_root, system)),
             python_path: python
-                .and_then(|python_path| {
-                    PythonPath::from_cli_flag(python_path.absolute(project_root, system), system)
+                .map(|python_path| {
+                    PythonPath::from_cli_flag(python_path.absolute(project_root, system))
+                })
+                .or_else(|| {
+                    std::env::var(&quot;VIRTUAL_ENV&quot;)
+                        .ok()
+                        .map(PythonPath::from_virtual_env_var)
                 })
-                .or_else(|| PythonPath::find_virtual_env(system))
                 .unwrap_or_else(|| PythonPath::KnownSitePackages(vec![])),
         }
     }
diff --git a/crates/red_knot_python_semantic/src/module_resolver/resolver.rs b/crates/red_knot_python_semantic/src/module_resolver/resolver.rs
index 1ce5c3ea2..ba9150f3c 100644
--- a/crates/red_knot_python_semantic/src/module_resolver/resolver.rs
+++ b/crates/red_knot_python_semantic/src/module_resolver/resolver.rs
@@ -223,12 +223,12 @@ impl SearchPaths {
         static_paths.push(stdlib_path);
 
         let site_packages_paths = match python_path {
-            PythonPath::SysPrefix(sys_prefix) =&gt; {
+            PythonPath::SysPrefix(sys_prefix, origin) =&gt; {
                 // TODO: We may want to warn here if the venv&#x27;s python version is older
                 //  than the one resolved in the program settings because it indicates
                 //  that the `target-version` is incorrectly configured or that the
                 //  venv is out of date.
-                VirtualEnvironment::new(sys_prefix.inner(), sys_prefix.origin(), system)
+                VirtualEnvironment::new(sys_prefix, *origin, system)
                     .and_then(|venv| venv.site_packages_directories(system))?
             }
 
diff --git a/crates/red_knot_python_semantic/src/program.rs b/crates/red_knot_python_semantic/src/program.rs
index 5315be124..325d594fa 100644
--- a/crates/red_knot_python_semantic/src/program.rs
+++ b/crates/red_knot_python_semantic/src/program.rs
@@ -1,10 +1,10 @@
 use crate::module_resolver::SearchPaths;
 use crate::python_platform::PythonPlatform;
-use crate::site_packages::{SysPrefixPath, SysPrefixPathOrigin};
+use crate::site_packages::SysPrefixPathOrigin;
 use crate::Db;
 
 use anyhow::Context;
-use ruff_db::system::{System, SystemPath, SystemPathBuf};
+use ruff_db::system::{SystemPath, SystemPathBuf};
 use ruff_python_ast::PythonVersion;
 use salsa::Durability;
 use salsa::Setter;
@@ -143,7 +143,7 @@ pub enum PythonPath {
     /// `/opt/homebrew/lib/python3.X/site-packages`.
     ///
     /// [`sys.prefix`]: https://docs.python.org/3/library/sys.html#sys.prefix
-    SysPrefix(SysPrefixPath),
+    SysPrefix(SystemPathBuf, SysPrefixPathOrigin),
 
     /// Resolved site packages paths.
     ///
@@ -153,20 +153,11 @@ pub enum PythonPath {
 }
 
 impl PythonPath {
-    pub fn find_virtual_env(system: &amp;dyn System) -&gt; Option&lt;Self&gt; {
-        let virtual_env = std::env::var(&quot;VIRTUAL_ENV&quot;).ok()?;
-        tracing::debug!(
-            &quot;Found virtual environment at {:?} from `VIRTUAL_ENV` environment variable&quot;,
-            virtual_env
-        );
-        SysPrefixPath::new(virtual_env, SysPrefixPathOrigin::VirtualEnvVar, system)
-            .ok()
-            .map(Self::SysPrefix)
+    pub fn from_virtual_env_var(path: impl Into&lt;SystemPathBuf&gt;) -&gt; Self {
+        Self::SysPrefix(path.into(), SysPrefixPathOrigin::VirtualEnvVar)
     }
 
-    pub fn from_cli_flag(path: SystemPathBuf, system: &amp;dyn System) -&gt; Option&lt;Self&gt; {
-        SysPrefixPath::new(path, SysPrefixPathOrigin::PythonCliFlag, system)
-            .ok()
-            .map(Self::SysPrefix)
+    pub fn from_cli_flag(path: SystemPathBuf) -&gt; Self {
+        Self::SysPrefix(path, SysPrefixPathOrigin::PythonCliFlag)
     }
 }
diff --git a/crates/red_knot_python_semantic/src/site_packages.rs b/crates/red_knot_python_semantic/src/site_packages.rs
index 99f8837db..0d97a5945 100644
--- a/crates/red_knot_python_semantic/src/site_packages.rs
+++ b/crates/red_knot_python_semantic/src/site_packages.rs
@@ -377,20 +377,12 @@ fn site_packages_directory_from_sys_prefix(
 /// [`sys.prefix`]: https://docs.python.org/3/library/sys.html#sys.prefix
 #[derive(Debug, PartialEq, Eq, Clone)]
 #[cfg_attr(feature = &quot;serde&quot;, derive(serde::Serialize, serde::Deserialize))]
-pub struct SysPrefixPath {
+pub(crate) struct SysPrefixPath {
     inner: SystemPathBuf,
     origin: SysPrefixPathOrigin,
 }
 
 impl SysPrefixPath {
-    pub(crate) fn inner(&amp;self) -&gt; &amp;SystemPath {
-        &amp;self.inner
-    }
-
-    pub(crate) fn origin(&amp;self) -&gt; SysPrefixPathOrigin {
-        self.origin
-    }
-
     pub(crate) fn new(
         unvalidated_path: impl AsRef&lt;SystemPath&gt;,
         origin: SysPrefixPathOrigin,
@@ -464,7 +456,7 @@ impl fmt::Display for SysPrefixPath {
 
 #[derive(Debug, PartialEq, Eq, Copy, Clone)]
 #[cfg_attr(feature = &quot;serde&quot;, derive(serde::Serialize, serde::Deserialize))]
-pub(crate) enum SysPrefixPathOrigin {
+pub enum SysPrefixPathOrigin {
     PythonCliFlag,
     VirtualEnvVar,
     Derived,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-03-20 13:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/red_knot_python_semantic/src/program.rs</code>:166 on 2025-03-20 13:09</div>
            <div class="timeline-body"><p>(there&#x27;s actually not much to review here — uv&#x27;s discovery is far more complicated and doesn&#x27;t really seem relevant for this particular change)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/site_packages.rs</code>:48 on 2025-03-20 13:21</div>
            <div class="timeline-body"><p>Should we pass the <code>sys_prefix</code> path instead of <code>path</code> and <code>SysPrefixPathOrigin</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/site_packages.rs</code>:215 on 2025-03-20 13:22</div>
            <div class="timeline-body"><p>Same here, Should we just store the <code>SysPrefixPath</code> instead of individual fields or do we use separate fields to derive the error message?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/program.rs</code>:146 on 2025-03-20 13:24</div>
            <div class="timeline-body"><p>Same here. Should this store a <code>SysPrefixPath</code> instead of the two individual fields</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-03-20 13:26</div>
            <div class="timeline-body"><p>Nice!</p>
<p>I think we can use <code>SysPrefixPath</code> in more places to avoid having to reduce the number of arguments that need to be routed through the different levels.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-03-20 13:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/program.rs</code>:146 on 2025-03-20 13:28</div>
            <div class="timeline-body"><p><code>SysPrefixPath</code> represents a <em>validated</em> path to <code>sys.prefix</code>, but at this stage the path hasn&#x27;t yet been validated (and I don&#x27;t think we want to do the validation this early; it&#x27;s better if we do it in <code>SearchPaths::from_settings()</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-03-20 13:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/site_packages.rs</code>:215 on 2025-03-20 13:34</div>
            <div class="timeline-body"><p>We can&#x27;t store a <code>SysPrefixPath</code> here because the first two error variants are returned by <code>SysPrefixPath::new()</code>, so we don&#x27;t have a validated <code>SysPrefixPath</code> yet at the point when we&#x27;d construct this error variant</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-20 13:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/program.rs</code>:146 on 2025-03-20 13:36</div>
            <div class="timeline-body"><p>I see. It&#x27;s somewhat annoying that we have to pass through all those arguments and I&#x27;m not sure if it&#x27;s necessary to restrict <code>SysPrefixPath</code> to <em>valid paths</em> only. But changing this constraint seems out of the scope for this PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-03-20 13:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/program.rs</code>:146 on 2025-03-20 13:37</div>
            <div class="timeline-body"><p>yeah, agreed, we could consider a redesign where the validation is moved out of <code>SysPrefixPath::new()</code>. But I also agree that it&#x27;s out of scope here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/site_packages.rs</code>:379 on 2025-03-20 13:38</div>
            <div class="timeline-body"><p>I think this change is no longer needed on the latest version of the PR</p>
<pre><code></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/site_packages.rs</code>:386 on 2025-03-20 13:39</div>
            <div class="timeline-body"><p>same here</p>
<pre><code>    fn new(
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-03-20 13:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-03-20 13:39</div>
            <div class="timeline-body"><p>Could anyone help with testing, I&#x27;m unsure about how to go about testing this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-20 13:42</div>
            <div class="timeline-body"><blockquote>
<p>Could anyone help with testing, I&#x27;m unsure about how to go about testing this</p>
</blockquote>
<p>I&#x27;m curious if @MichaReiser has any ideas but my best idea here is lots of manual testing:</p>
<ul>
<li>If we manually create an environment and activate it, can red-knot automatically resolve imports that refer to third-party packages in the venv&#x27;s <code>site_packages</code> directory?</li>
<li>If the environment is implicitly activated via <code>uv run</code>, can can red-knot automatically resolve imports that refer to third-party packages in the venv&#x27;s <code>site_packages</code> directory?</li>
<li>If we deliberately &quot;break&quot; a venv in one of the ways that we try to detect using the <code>site_packages::SitePackagesDiscoveryError</code> enum and then activate the venv and run red-knot, what do the error messages from red-knot look like?</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-20 13:46</div>
            <div class="timeline-body"><p>An automated CLI test would be great, but it&#x27;s probably somewhat painful to set up because <code>SysPrefixPath</code> does a lot of validation, and the behavior is even platform-dependent. I&#x27;m fine skipping an automated test here because it doesn&#x27;t do much more than <code>--python &lt;path&gt;</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-03-20 13:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/site_packages.rs</code>:218 on 2025-03-20 13:47</div>
            <div class="timeline-body"><p>I think we should get rid of the colon here. I manually tested this by:</p>
<ol>
<li>Creating a virtual environment using <code>uv venv</code></li>
<li>Breaking the virtual environment by running <code>rm .venv/pyvenv.cfg</code></li>
<li>Activating the virtual environment by running <code>source .venv/bin/activate</code></li>
<li>Running <code>../ruff/target/debug/red_knot check</code></li>
</ol>
<p>The error message displayed to the terminal was:</p>
<pre><code>~/dev/typeshed-stats (main) % uv run ../ruff/target/debug/red_knot check
Red Knot failed
  Cause: Invalid search path settings
  Cause: Failed to discover the site-packages directory: `VIRTUAL_ENV` environment variable: points to a broken venv with no pyvenv.cfg file
</code></pre>
<p>And I don&#x27;t think the second colon on the last line there is necessary</p>
<pre><code>    #[error(&quot;{0} points to a broken venv with no pyvenv.cfg file&quot;)]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-03-20 13:48</div>
            <div class="timeline-body"><p>I manually tested with both &quot;good&quot; and &quot;broken&quot; virtual environments, and it all looks great. Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-20 13:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-20 13:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-03-20 14:00</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:12:28 UTC
    </footer>
</body>
</html>
