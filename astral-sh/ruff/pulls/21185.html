<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adjust own-line comment placement between branches - astral-sh/ruff #21185</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Adjust own-line comment placement between branches</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21185">#21185</a>
        opened by <a href="https://github.com/dylwil3">@dylwil3</a>
        on 2025-11-01 16:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a></div>
            <div class="timeline-body"><p>This PR attempts to improve the placement of own-line comments between branches in the setting where the comment is more indented than the preceding node.</p>
<p>There are two main changes.</p>
First change: Preceding node has leading content
<p>If the preceding node has leading content, we now regard the comment as automatically <em>less</em> indented than the preceding node, and format accordingly.</p>
<p>For example,</p>
<pre><code>if True: preceding_node
# leading on `else`, not trailing on `preceding_node`
else: ...
</code></pre>
<p>This is more compatible with <code>black</code>, although there is a (presumably very uncommon) edge case:</p>
<pre><code>if True:
    this;that
    # leading on `else`, but trailing in `black`
else: ...
</code></pre>
<p>I&#x27;m sort of okay with this - presumably if one wanted a comment for those semi-colon separated statements, one should have put it <em>above</em> them, and one wanted a comment only for <code>that</code> then it ought to have been on the same line?</p>
Second change: searching for last child in body
<p>While searching for the (recursively) last child in the body of the preceding <em>branch</em>, we implicitly assumed that the preceding node had to have a body to begin the recursion. But actually, in the base case, the preceding node <em>is</em> the last child in the body of the preceding branch. So, for example:</p>
<pre><code>if True:
    something
    last_child_but_no_body
    # leading on else for `main` but trailing in this PR
else: ...
</code></pre>
More examples
<p>The table below is an attempt to summarize the changes in behavior. The rows alternate between an example snippet with <code>while</code> and the same example with <code>if</code> - in the former case we do <em>not</em> have an <code>else</code> node and in the latter we do.</p>
<p>Notice that:</p>
<ol>
<li>On <code>main</code> our handling of <code>if</code> vs. <code>while</code> is not consistent, whereas it is consistent in the present PR</li>
<li>We disagree with <code>black</code> in all cases except that last example on <code>main</code>, but agree in all cases for the present PR (though see above for a wonky edge case where we disagree).</li>
</ol>
<table>
<tr>
<th>Original &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>
<th><code>main</code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>
<th>This PR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>
<th><code>black</code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>
</tr>
<tr>
<td>

<pre>
while True: 
    pass
        # comment
else:
    pass
</pre>

</td>
<td>

<pre>
while True:
    pass
else:
    # comment
    pass
</pre>

</td>
<td>

<pre>
while True:
    pass
    # comment
else:
    pass
</pre>

</td>
<td>

<pre>
while True:
    pass
    # comment
else:
    pass
</pre>

</td>
</tr>
<tr>
<td>

<pre>
if True:
    pass
        # comment
else:
    pass
</pre>

</td>
<td>

<pre>
if True:
    pass
# comment
else:
    pass
</pre>

</td>
<td>

<pre>
if True:
    pass
    # comment
else:
    pass
</pre>

</td>
<td>

<pre>
if True:
    pass
    # comment
else:
    pass
</pre>

</td>
</tr>
<tr>
<td>

<pre>
while True: pass
# comment
else:
    pass
</pre>

</td>
<td>

<pre>
while True:
    pass
    # comment
else:
    pass
</pre>

</td>
<td>

<pre>
while True:
    pass
# comment
else:
    pass
</pre>

</td>
<td>

<pre>
while True:
    pass
# comment
else:
    pass
</pre>

</td>
</tr>
<tr>
<td>

<pre>
if True: pass
# comment
else:
    pass
</pre>

</td>
<td>

<pre>
if True:
    pass
    # comment
else:
    pass
</pre>

</td>
<td>

<pre>
if True:
    pass
# comment
else:
    pass
</pre>

</td>
<td>

<pre>
if True:
    pass
# comment
else:
    pass
</pre>

</td>
</tr>
<tr>
<td>

<pre>
while True: pass
    # comment
else:
    pass
</pre>

</td>
<td>

<pre>
while True:
    pass
else:
    # comment
    pass
</pre>

</td>
<td>

<pre>
while True:
    pass
# comment
else:
    pass
</pre>

</td>
<td>

<pre>
while True:
    pass
# comment
else:
    pass
</pre>

</td>
</tr>
<tr>
<td>

<pre>
if True: pass
    # comment
else:
    pass
</pre>

</td>
<td>

<pre>
if True:
    pass
# comment
else:
    pass
</pre>

</td>
<td>

<pre>
if True:
    pass
# comment
else:
    pass
</pre>

</td>
<td>

<pre>
if True:
    pass
# comment
else:
    pass
</pre>

</td>
</tr>
</table>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-11-01 16:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-11-01 16:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-11-01 16:22</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Adjust comment placement before `else`/`finally` clauses&quot; to &quot;Adjust indented comment placement before `else`/`finally` clauses&quot; by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-11-10 16:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:580 on 2025-11-10 21:32</div>
            <div class="timeline-body"><p>Note that <code>max_empty_lines</code> also uses a <code>SimpleTokenizer</code>. We could combine that into a single pass here, I think, but it would be less readable. Is it worth it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-11-10 21:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-11-10 21:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-11-10 21:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-11-11 10:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:572 on 2025-11-11 10:54</div>
            <div class="timeline-body"><p>Can you say more why we&#x27;re handling this case here? I&#x27;d expect this to be handled by <code>handle_own_line_comment_between_branches</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Adjust indented comment placement before `else`/`finally` clauses&quot; to &quot;Adjust comment placement between branches&quot; by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-11-11 16:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Adjust comment placement between branches&quot; to &quot;Adjust own-line comment placement between branches&quot; by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-11-11 16:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-11-11 16:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:572 on 2025-11-11 16:53</div>
            <div class="timeline-body"><p>After our offline discussion I&#x27;ve tried a hopefully more reasonable spot in the logic for the fix</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:626 on 2025-11-11 18:01</div>
            <div class="timeline-body"><p>What&#x27;s the <code>+1</code> for? I like to use <code>char.text_len</code>() (e.g. <code>&#x27; &#x27;.text_len()</code>) to more clearly what character we&#x27;re skipping.</p>
<p>Is it important what value we use for <code>comment_indentation</code> or can it be any value for as long as it is larger than <code>comment_indentation</code> (so that we hit the <code>Less</code> case?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/snapshots/format@statement__while.py.snap</code>:39 on 2025-11-11 18:04</div>
            <div class="timeline-body"><p>I often find it useful to number the comments. It makes it easier to match the input/output (and debug panics if we forgot to format a comment)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:726 on 2025-11-11 18:08</div>
            <div class="timeline-body"><p>This seems risky. There isn&#x27;t really anything enforcing that we&#x27;re within a block statement. I think we, at least, want to assert that the enclosing node is a block statement.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2025-11-11 18:10</div>
            <div class="timeline-body"><p>This looks much better to me and it&#x27;s nice that this matches black in almost all cases.</p>
<p>However, there are a couple of tests that now fail because of instable formatting (the invariant <code>format(source) == format(format(source))</code> doesn&#x27;t hold anymore). I think it&#x27;s because the fallback to <code>preceding</code> is too liberal.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-11-11 20:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_formatter/tests/snapshots/format@statement__while.py.snap</code>:39 on 2025-11-11 20:43</div>
            <div class="timeline-body"><p>Here I didn&#x27;t do that because there is only one comment in each example - do you want me to the number them across the whole fixture? Among these examples? Or just make them all <code>#1</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-11-11 20:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:626 on 2025-11-11 20:44</div>
            <div class="timeline-body"><p>We are just trying to hit the <code>Less</code> case - it can be any positive number. I&#x27;ve clarified with a comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-11-12 00:25</div>
            <div class="timeline-body"><p>Sorry about the failing tests! I made the beginner mistake of running tests, fixing snapshots, but then not re-running tests after that. Whoops!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-11-14 18:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:743 on 2025-11-15 18:13</div>
            <div class="timeline-body"><p>Could we use <code>if following.is_first_statement_in_body()</code> or even <code>is_first_statement_in_alternate_body</code></p>
<p>I&#x27;m surprised that we need <code>MatchCase</code> and <code>ExceptHandler</code> here, as those nodes don&#x27;t have alternate branches? How did you pick the nodes listed here? Did you add tests demonstrating that they&#x27;re all necessary?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/snapshots/format@statement__while.py.snap</code>:39 on 2025-11-15 18:16</div>
            <div class="timeline-body"><p>I would give them unique numbers within the <code># Compare behavior with </code>while<code>/</code>else<code> comment placement</code> section</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-11-15 18:22</div>
            <div class="timeline-body"><p>Thank you. This overall looks good. I just don&#x27;t feel 100 confident about the new <code>Non</code> if <code>matches</code> case. Did you pick them individually or did you list all compound statements just to be sure? If it&#x27;s the latter, than I&#x27;d prefer to only pick the once that are indeed necessary.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-11-17 13:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:743 on 2025-11-17 13:20</div>
            <div class="timeline-body"><p>Yes, sorry - I added all of those because that was my interpretation of</p>
<blockquote>
<p>There isn&#x27;t really anything enforcing that we&#x27;re within a block statement. I think we, at least, want to assert that the enclosing node is a block statement.</p>
</blockquote>
<p>But you&#x27;re right that <code>is_first_statement_in_alternate_body</code> is more targeted, so I&#x27;ve changed it to that, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-11-17 13:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-11-17 13:30</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:20:05 UTC
    </footer>
</body>
</html>
