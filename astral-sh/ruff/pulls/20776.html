<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Type-context aware literal promotion - astral-sh/ruff #20776</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Type-context aware literal promotion</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20776">#20776</a>
        opened by <a href="https://github.com/ibraheemdev">@ibraheemdev</a>
        on 2025-10-08 21:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a></div>
            <div class="timeline-body">Summary
<p>Avoid literal promotion when a literal type annotation is provided, e.g.,</p>
<pre><code>x: list[Literal[1]] = [1]
</code></pre>
<p>Resolves <a href="https://github.com/astral-sh/ty/issues/1198">astral-sh/ty#1198</a>. This does not fix issue <a href="https://github.com/astral-sh/ty/issues/1284">astral-sh/ty#1284</a>, but it does make it more relevant because after this change, it is possible to directly instantiate a generic type with a literal specialization.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-10-08 21:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-10-08 21:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-10-08 21:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-10-08 21:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-10-08 21:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-08 21:38</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a>

Changes were detected when running ty on typing conformance tests

<pre><code>--- old-output.txt	2025-10-09 20:41:23.943326536 +0000
+++ new-output.txt	2025-10-09 20:41:27.257340205 +0000
@@ -643,9 +643,7 @@
 literals_literalstring.py:75:5: error[invalid-assignment] Object of type `Literal[b&quot;test&quot;]` is not assignable to `LiteralString`
 literals_literalstring.py:79:21: error[invalid-return-type] Function always implicitly returns `None`, which is not assignable to return type `bool`
 literals_literalstring.py:120:22: error[invalid-argument-type] Argument to function `literal_identity` is incorrect: Argument type `str` does not satisfy upper bound `LiteralString` of type variable `TLiteral`
-literals_literalstring.py:130:35: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `Container[T@Container]`, found `Container[str]`
 literals_literalstring.py:134:51: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Argument type `str` does not satisfy upper bound `LiteralString` of type variable `T`
-literals_literalstring.py:138:1: error[invalid-assignment] Object of type `list[Unknown | str]` is not assignable to `list[LiteralString]`
 literals_literalstring.py:167:1: error[type-assertion-failure] Argument does not have asserted type `A`
 literals_literalstring.py:171:5: error[invalid-assignment] Object of type `list[LiteralString]` is not assignable to `list[str]`
 literals_parameterizations.py:41:15: error[invalid-type-form] Type arguments for `Literal` must be `None`, a literal value (int, bool, str, or bytes), or an enum member
@@ -900,5 +898,5 @@
 typeddicts_usage.py:28:17: error[missing-typed-dict-key] Missing required key &#x27;name&#x27; in TypedDict `Movie` constructor
 typeddicts_usage.py:28:18: error[invalid-key] Invalid key access on TypedDict `Movie`: Unknown key &quot;title&quot;
 typeddicts_usage.py:40:24: error[invalid-type-form] The special form `typing.TypedDict` is not allowed in type expressions. Did you mean to use a concrete TypedDict or `collections.abc.Mapping[str, object]` instead?
-Found 901 diagnostics
+Found 899 diagnostics
 WARN A fatal error occurred while checking some files. Not all project files were analyzed. See the diagnostics list above for details.
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-08 21:50</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>porcupine (https://github.com/Akuli/porcupine)
- porcupine/plugins/longlinemarker.py:56:17: error[invalid-assignment] Object of type `list[Unknown | str]` is not assignable to `list[Literal[&quot;bgcolor&quot;, &quot;color&quot;, &quot;border&quot;]]`
- Found 24 diagnostics
+ Found 23 diagnostics

pydantic (https://github.com/pydantic/pydantic)
- pydantic/_internal/_generate_schema.py:1967:9: error[invalid-assignment] Object of type `dict[Unknown | _ParameterKind, Unknown | str]` is not assignable to `dict[_ParameterKind, Literal[&quot;positional_only&quot;, &quot;positional_or_keyword&quot;, &quot;keyword_only&quot;]]`
- pydantic/_internal/_generate_schema.py:2041:9: error[invalid-assignment] Object of type `dict[Unknown | _ParameterKind, Unknown | str]` is not assignable to `dict[_ParameterKind, Literal[&quot;positional_only&quot;, &quot;positional_or_keyword&quot;, &quot;var_args&quot;, &quot;keyword_only&quot;]]`
- Found 768 diagnostics
+ Found 766 diagnostics

freqtrade (https://github.com/freqtrade/freqtrade)
- freqtrade/exchange/binance.py:54:37: error[invalid-argument-type] Invalid argument to key &quot;order_props_in_contracts&quot; with declared type `list[Literal[&quot;amount&quot;, &quot;cost&quot;, &quot;filled&quot;, &quot;remaining&quot;]]` on TypedDict `FtHas`: value of type `list[str]`
- freqtrade/exchange/exchange.py:161:37: error[invalid-argument-type] Invalid argument to key &quot;order_props_in_contracts&quot; with declared type `list[Literal[&quot;amount&quot;, &quot;cost&quot;, &quot;filled&quot;, &quot;remaining&quot;]]` on TypedDict `FtHas`: value of type `list[str]`
- Found 404 diagnostics
+ Found 402 diagnostics

meson (https://github.com/mesonbuild/meson)
- mesonbuild/modules/_qt.py:941:9: error[invalid-assignment] Object of type `list[Unknown | bool]` is not assignable to `list[str | Literal[False]]`
- Found 887 diagnostics
+ Found 886 diagnostics

discord.py (https://github.com/Rapptz/discord.py)
- discord/ui/select.py:1227:13: error[invalid-assignment] Object of type `dict[Unknown | &lt;class &#x27;UserSelect&#x27;&gt; | &lt;class &#x27;RoleSelect&#x27;&gt; | &lt;class &#x27;MentionableSelect&#x27;&gt; | &lt;class &#x27;ChannelSelect&#x27;&gt;, Unknown | ComponentType]` is not assignable to `dict[type[BaseSelect[Unknown]], Literal[ComponentType.user_select, ComponentType.channel_select, ComponentType.role_select, ComponentType.mentionable_select]]`
- Found 509 diagnostics
+ Found 508 diagnostics

sphinx (https://github.com/sphinx-doc/sphinx)
- sphinx/environment/__init__.py:94:1: error[invalid-assignment] Object of type `dict[Unknown | str, Unknown | bool | ((node: Node) -&gt; bool)]` is not assignable to `dict[str, Literal[False] | ((Node, /) -&gt; bool)]`
- Found 493 diagnostics
+ Found 492 diagnostics

pyodide (https://github.com/pyodide/pyodide)
- pyodide-build/pyodide_build/recipe/skeleton.py:359:47: error[invalid-argument-type] Argument to function `_find_dist` is incorrect: Expected `list[Literal[&quot;wheel&quot;, &quot;sdist&quot;]]`, found `list[Unknown | str]`
- Found 986 diagnostics
+ Found 985 diagnostics

openlibrary (https://github.com/internetarchive/openlibrary)
- openlibrary/book_providers.py:747:9: error[invalid-argument-type] Argument to function `multisort_best` is incorrect: Expected `list[tuple[Literal[&quot;min&quot;, &quot;max&quot;], (@Todo, /) -&gt; int | float]]`, found `list[Unknown | tuple[str, (rec) -&gt; Unknown]]`
- Found 850 diagnostics
+ Found 849 diagnostics

prefect (https://github.com/PrefectHQ/prefect)
- src/integrations/prefect-aws/prefect_aws/observers/ecs.py:44:1: error[invalid-assignment] Object of type `dict[Unknown | str, Unknown | str]` is not assignable to `dict[str, Literal[&quot;task&quot;, &quot;container-instance&quot;, &quot;deployment&quot;]]`
- Found 3203 diagnostics
+ Found 3202 diagnostics

pwndbg (https://github.com/pwndbg/pwndbg)
- pwndbg/lib/zig.py:17:1: error[invalid-assignment] Object of type `dict[Unknown | tuple[str, str, int], Unknown | str]` is not assignable to `dict[tuple[@Todo, Literal[&quot;little&quot;, &quot;big&quot;], int], str]`
- Found 2581 diagnostics
+ Found 2580 diagnostics

colour (https://github.com/colour-science/colour)
- colour/notation/munsell.py:2037:5: error[invalid-assignment] Object of type `dict[Unknown | int, Unknown | None | str]` is not assignable to `dict[int, Literal[&quot;Linear&quot;, &quot;Radial&quot;] | None]`
- Found 479 diagnostics
+ Found 478 diagnostics

streamlit (https://github.com/streamlit/streamlit)
- lib/streamlit/config.py:1189:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1205:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1220:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1235:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1250:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1265:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1287:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1309:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1331:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1353:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1375:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1396:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1418:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1439:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1460:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1481:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1502:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1523:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1544:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1565:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1586:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1607:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1628:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1649:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1670:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1691:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1712:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1727:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1743:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1763:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1778:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1807:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1838:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1852:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1866:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1893:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1932:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1969:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:1994:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:2014:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:2036:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:2062:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:2090:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:2105:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:2122:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:2143:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:2159:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:2170:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- lib/streamlit/config.py:2213:5: error[invalid-argument-type] Argument to function `_create_theme_options` is incorrect: Expected `list[Literal[&quot;theme&quot;] | CustomThemeCategories]`, found `list[Unknown | str]`
- Found 194 diagnostics
+ Found 145 diagnostics

pandas (https://github.com/pandas-dev/pandas)
- pandas/core/frame.py:14046:5: error[invalid-assignment] Object of type `list[Unknown | str]` is not assignable to `list[Literal[&quot;index&quot;, &quot;columns&quot;]]`
- pandas/core/generic.py:5417:9: error[invalid-assignment] Object of type `dict[Unknown | str, Unknown | None]` is not assignable to `dict[Literal[&quot;index&quot;, &quot;columns&quot;], Any]`
- Found 3388 diagnostics
+ Found 3386 diagnostics

rotki (https://github.com/rotki/rotki)
- rotkehlchen/chain/bitcoin/xpub.py:217:25: error[invalid-argument-type] Argument to function `replace_tag_mappings` is incorrect: Expected `list[Literal[&quot;identifier&quot;, &quot;chain&quot;, &quot;address&quot;, &quot;xpub.xpub&quot;, &quot;derivation_path&quot;]]`, found `list[Unknown | str]`
- rotkehlchen/chain/bitcoin/xpub.py:223:25: error[invalid-argument-type] Argument to function `replace_tag_mappings` is incorrect: Expected `list[Literal[&quot;identifier&quot;, &quot;chain&quot;, &quot;address&quot;, &quot;xpub.xpub&quot;, &quot;derivation_path&quot;]]`, found `list[Unknown | str]`
- rotkehlchen/chain/evm/decoding/balancer/constants.py:27:1: error[invalid-assignment] Object of type `dict[Unknown | str, Unknown | int]` is not assignable to `dict[str, Literal[1, 2, 3]]`
- rotkehlchen/db/dbhandler.py:1315:75: error[invalid-argument-type] Argument to function `insert_tag_mappings` is incorrect: Expected `list[Literal[&quot;identifier&quot;, &quot;chain&quot;, &quot;address&quot;, &quot;xpub.xpub&quot;, &quot;derivation_path&quot;]]`, found `list[Unknown | str]`
- rotkehlchen/db/dbhandler.py:1370:13: error[invalid-argument-type] Argument to function `replace_tag_mappings` is incorrect: Expected `list[Literal[&quot;identifier&quot;, &quot;chain&quot;, &quot;address&quot;, &quot;xpub.xpub&quot;, &quot;derivation_path&quot;]]`, found `list[Unknown | str]`
- rotkehlchen/db/dbhandler.py:1731:67: error[invalid-argument-type] Argument to function `insert_tag_mappings` is incorrect: Expected `list[Literal[&quot;identifier&quot;, &quot;chain&quot;, &quot;address&quot;, &quot;xpub.xpub&quot;, &quot;derivation_path&quot;]]`, found `list[Unknown | str]`
- rotkehlchen/db/dbhandler.py:1765:68: error[invalid-argument-type] Argument to function `replace_tag_mappings` is incorrect: Expected `list[Literal[&quot;identifier&quot;, &quot;chain&quot;, &quot;address&quot;, &quot;xpub.xpub&quot;, &quot;derivation_path&quot;]]`, found `list[Unknown | str]`
- rotkehlchen/db/dbhandler.py:3213:17: error[invalid-argument-type] Argument to function `replace_tag_mappings` is incorrect: Expected `list[Literal[&quot;identifier&quot;, &quot;chain&quot;, &quot;address&quot;, &quot;xpub.xpub&quot;, &quot;derivation_path&quot;]]`, found `list[Unknown | str]`
- rotkehlchen/db/dbhandler.py:3222:17: error[invalid-argument-type] Argument to function `replace_tag_mappings` is incorrect: Expected `list[Literal[&quot;identifier&quot;, &quot;chain&quot;, &quot;address&quot;, &quot;xpub.xpub&quot;, &quot;derivation_path&quot;]]`, found `list[Unknown | str]`
- rotkehlchen/rotkehlchen.py:939:17: error[invalid-argument-type] Argument to function `replace_tag_mappings` is incorrect: Expected `list[Literal[&quot;identifier&quot;, &quot;chain&quot;, &quot;address&quot;, &quot;xpub.xpub&quot;, &quot;derivation_path&quot;]]`, found `list[Unknown | str]`
- rotkehlchen/tests/utils/xpubs.py:34:13: error[invalid-argument-type] Argument to function `insert_tag_mappings` is incorrect: Expected `list[Literal[&quot;identifier&quot;, &quot;chain&quot;, &quot;address&quot;, &quot;xpub.xpub&quot;, &quot;derivation_path&quot;]]`, found `list[Unknown | str]`
- rotkehlchen/tests/utils/xpubs.py:52:13: error[invalid-argument-type] Argument to function `insert_tag_mappings` is incorrect: Expected `list[Literal[&quot;identifier&quot;, &quot;chain&quot;, &quot;address&quot;, &quot;xpub.xpub&quot;, &quot;derivation_path&quot;]]`, found `list[Unknown | str]`
- Found 1714 diagnostics
+ Found 1702 diagnostics

core (https://github.com/home-assistant/core)
- homeassistant/components/recorder/statistics.py:1913:9: error[invalid-argument-type] Argument to function `_statistics_at_time` is incorrect: Expected `set[Literal[&quot;last_reset&quot;, &quot;max&quot;, &quot;mean&quot;, &quot;min&quot;, &quot;state&quot;, &quot;sum&quot;]]`, found `set[Unknown | str]`
- homeassistant/components/sensor/recorder.py:584:34: error[invalid-argument-type] Argument to function `get_latest_short_term_statistics_with_session` is incorrect: Expected `set[Literal[&quot;last_reset&quot;, &quot;max&quot;, &quot;mean&quot;, &quot;min&quot;, &quot;state&quot;, &quot;sum&quot;]]`, found `set[Unknown | str]`
- Found 13695 diagnostics
+ Found 13693 diagnostics

materialize (https://github.com/MaterializeInc/materialize)
- ci/deploy/pypi.py:23:1: error[invalid-assignment] Object of type `dict[Unknown | str, Unknown | str]` is not assignable to `dict[str, Literal[&quot;setup.py&quot;, &quot;pyproject.toml&quot;]]`
- Found 3388 diagnostics
+ Found 3387 diagnostics

scipy (https://github.com/scipy/scipy)
- scipy/stats/_qmc.py:2609:26: error[invalid-argument-type] Method `__getitem__` of type `bound method dict[str, ((...) -&gt; Unknown) | ((best_sample: ndarray[@Todo, Unknown], n_iters: int, n_nochange: int, rng: GeneratorType@_random_cd, **kwargs: dict[Unknown, Unknown]) -&gt; ndarray[@Todo, Unknown]) | ((sample: @Todo, *, tol: @Todo = float, maxiter: @Todo = int, qhull_options: str | None = None, **kwargs: dict[Unknown, Unknown]) -&gt; ndarray[@Todo, Unknown])].__getitem__(key: str, /) -&gt; ((...) -&gt; Unknown) | ((best_sample: ndarray[@Todo, Unknown], n_iters: int, n_nochange: int, rng: GeneratorType@_random_cd, **kwargs: dict[Unknown, Unknown]) -&gt; ndarray[@Todo, Unknown]) | ((sample: @Todo, *, tol: @Todo = float, maxiter: @Todo = int, qhull_options: str | None = None, **kwargs: dict[Unknown, Unknown]) -&gt; ndarray[@Todo, Unknown])` cannot be called with key of type `Literal[&quot;random-cd&quot;, &quot;lloyd&quot;] | None` on object of type `dict[str, ((...) -&gt; Unknown) | ((best_sample: ndarray[@Todo, Unknown], n_iters: int, n_nochange: int, rng: GeneratorType@_random_cd, **kwargs: dict[Unknown, Unknown]) -&gt; ndarray[@Todo, Unknown]) | ((sample: @Todo, *, tol: @Todo = float, maxiter: @Todo = int, qhull_options: str | None = None, **kwargs: dict[Unknown, Unknown]) -&gt; ndarray[@Todo, Unknown])]`
+ scipy/stats/_qmc.py:2609:26: error[invalid-argument-type] Method `__getitem__` of type `bound method dict[str, ((...) -&gt; Unknown) | ((best_sample: ndarray[@Todo, Unknown], n_iters: int, n_nochange: int, rng: GeneratorType@_random_cd, **kwargs: dict[Unknown, Unknown]) -&gt; ndarray[@Todo, Unknown]) | ((sample: @Todo, *, tol: @Todo = float, maxiter: @Todo = Literal[10], qhull_options: str | None = None, **kwargs: dict[Unknown, Unknown]) -&gt; ndarray[@Todo, Unknown])].__getitem__(key: str, /) -&gt; ((...) -&gt; Unknown) | ((best_sample: ndarray[@Todo, Unknown], n_iters: int, n_nochange: int, rng: GeneratorType@_random_cd, **kwargs: dict[Unknown, Unknown]) -&gt; ndarray[@Todo, Unknown]) | ((sample: @Todo, *, tol: @Todo = float, maxiter: @Todo = Literal[10], qhull_options: str | None = None, **kwargs: dict[Unknown, Unknown]) -&gt; ndarray[@Todo, Unknown])` cannot be called with key of type `Literal[&quot;random-cd&quot;, &quot;lloyd&quot;] | None` on object of type `dict[str, ((...) -&gt; Unknown) | ((best_sample: ndarray[@Todo, Unknown], n_iters: int, n_nochange: int, rng: GeneratorType@_random_cd, **kwargs: dict[Unknown, Unknown]) -&gt; ndarray[@Todo, Unknown]) | ((sample: @Todo, *, tol: @Todo = float, maxiter: @Todo = Literal[10], qhull_options: str | None = None, **kwargs: dict[Unknown, Unknown]) -&gt; ndarray[@Todo, Unknown])]`

</code></pre>

No memory usage changes detected ✅

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-10-08 21:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-08 21:55</div>
            <div class="timeline-body">

<code>ecosystem-analyzer</code> results
<p>| Lint rule | Added | Removed | Changed |
|-----------|------:|--------:|--------:|
| <code>invalid-argument-type</code> | 0 | 66 | 1 |
| <code>invalid-assignment</code> | 0 | 13 | 0 |
| <strong>Total</strong> | <strong>0</strong> | <strong>79</strong> | <strong>1</strong> |</p>
<p><strong><a href="https://ibraheem-literal-promotion.ecosystem-663.pages.dev/diff">Full report with detailed diff</a></strong> (<a href="https://ibraheem-literal-promotion.ecosystem-663.pages.dev/timing">timing results</a>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-10-08 21:56</div>
            <div class="timeline-body">

<a href="https://codspeed.io/astral-sh/ruff/branches/ibraheem%2Fliteral-promotion">CodSpeed Performance Report</a>
Merging #20776 will <strong>not alter performance</strong>
<p>Comparing <code>ibraheem/literal-promotion</code> (41af679) with <code>main</code> (537ec5f)</p>
Summary
<p><code>✅ 21</code> untouched<br>
<code>⏩ 30</code> skipped[^skipped]</p>
<p>[^skipped]: 30 benchmarks were skipped, so the baseline results were used instead. If they were deleted from the codebase, <a href="https://codspeed.io/astral-sh/ruff/branches/ibraheem%2Fliteral-promotion?sectionId=benchmark-comparison-section-baseline-result-skipped">click here and archive them to remove them from the performance reports</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-10-09 00:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_python_semantic/src/types/generics.rs</code>:1148 on 2025-10-09 00:19</div>
            <div class="timeline-body"><p>Hmm.. this is incorrect, because we&#x27;re promoting the type of each parameter, not the type of the generic class, so the type annotation specialization does not match. We might need to delay the promotion step for this to work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types.rs</code>:858 on 2025-10-09 11:21</div>
            <div class="timeline-body"><p>So far, I think we only required <code>object</code> to exist. It looks like this requires a custom typeshed to have all known classes?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types.rs</code>:1215 on 2025-10-09 11:32</div>
            <div class="timeline-body"><p>An interesting consequence here is that we would still perform promotion if something else in the annotation makes the promoted type assignable. For example:</p>
<pre><code>from typing import Any, Literal

xs: list[Any | Literal[1]] = [1, 1]

reveal_type(xs)  # list[Any | int]
</code></pre>
<p>Probably nothing to worry about, though...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-09 11:32</div>
            <div class="timeline-body"><blockquote>
<pre><code>+ tests/core/test_scope.py:127:23: error[invalid-argument-type] Argument to bound method `set` is incorrect: Expected `Box[str]`, found `Box[str]`
+ tests/core/test_scope.py:148:19: error[invalid-argument-type] Argument to bound method `set` is incorrect: Expected `Box[str]`, found `Box[str]`
+ tests/core/test_scope.py:159:19: error[invalid-argument-type] Argument to bound method `set` is incorrect: Expected `Box[str]`, found `Box[str]`
</code></pre>
</blockquote>
<p>These look quite odd -- any idea what&#x27;s causing these diagnostics? <code>Box[str]</code> must refer to the same <code>Box[str]</code> across any single diagnostic in these instances, or we&#x27;d automatically use the fully qualified name of <code>Box</code> in the diagnostic to disambiguate it (e.g. <a href="https://github.com/astral-sh/ruff/pull/20756">astral-sh/ruff#20756</a>#issuecomment-3379038485)</p>
<p>This also doesn&#x27;t look correct -- <code>dict[str, str]</code> is one of the union elements in the first type here, so it seems like it should be assignable to that union:</p>
<pre><code>tornado (https://github.com/tornadoweb/tornado)
+ tornado/test/auth_test.py:563:69: error[invalid-argument-type] Argument to function `url_concat` is incorrect: Expected `None | dict[str, str] | list[tuple[str, str]] | tuple[tuple[str, str], ...]`, found `dict[str, str]`
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-09 11:37</div>
            <div class="timeline-body"><blockquote>
<pre><code>- colour/graph/conversion.py:1121:30: error[invalid-argument-type] Argument is incorrect: Expected `str`, found `Unknown | str | ((sd: @Todo | SpectralDistribution | MultiSpectralDistributions, cmfs: MultiSpectralDistributions | None = None, illuminant: SpectralDistribution | None = None, k: @Todo | None = None, method: str = str, **kwargs: Any) -&gt; @Todo) | ... omitted 60 union elements`
+ colour/graph/conversion.py:1121:30: error[invalid-argument-type] Argument is incorrect: Expected `str`, found `Unknown | Literal[&quot;Spectral Distribution&quot;, &quot;CIE XYZ&quot;, &quot;Luminous Flux&quot;, &quot;Luminous Efficiency&quot;, &quot;Luminous Efficacy&quot;, &quot;Luminance&quot;, &quot;Lightness&quot;, &quot;Whiteness&quot;, &quot;Yellowness&quot;, &quot;CIE xy&quot;, &quot;Colorimetric Purity&quot;, &quot;Complementary Wavelength&quot;, &quot;Dominant Wavelength&quot;, &quot;Excitation Purity&quot;, &quot;Wavelength&quot;, &quot;CIE xyY&quot;, &quot;CIE Lab&quot;, &quot;CIE Luv&quot;, &quot;CIE Luv uv&quot;, &quot;CIE UCS&quot;, &quot;CIE UCS uv&quot;, &quot;CIE UVW&quot;, &quot;DIN99&quot;, &quot;hdr-CIELAB&quot;, &quot;Hunter Lab&quot;, &quot;Hunter Rdab&quot;, &quot;ICaCb&quot;, &quot;ICtCp&quot;, &quot;IgPgTg&quot;, &quot;IPT&quot;, &quot;IPT Ragoo 2021&quot;, &quot;Jzazbz&quot;, &quot;hdr-IPT&quot;, &quot;OSA UCS&quot;, &quot;Oklab&quot;, &quot;ProLab&quot;, &quot;sUCS&quot;, &quot;Yrg&quot;, &quot;CIE 1931&quot;, &quot;CIE 1960 UCS&quot;, &quot;CIE 1976 UCS&quot;, &quot;RGB&quot;, &quot;Scene-Referred RGB&quot;, &quot;HSV&quot;, &quot;HSL&quot;, &quot;HCL&quot;, &quot;IHLS&quot;, &quot;CMY&quot;, &quot;CMYK&quot;, &quot;RGB Luminance&quot;, &quot;Prismatic&quot;, &quot;Output-Referred RGB&quot;, &quot;YCbCr&quot;, &quot;YcCbcCrc&quot;, &quot;YCoCg&quot;, &quot;sRGB&quot;, &quot;Hexadecimal&quot;, &quot;CSS Color 3&quot;, &quot;Munsell Colour&quot;, &quot;Munsell Value&quot;, &quot;CRI&quot;, &quot;CQS&quot;, &quot;CCT&quot;, &quot;Mired&quot;, &quot;ATD95&quot;, &quot;CIECAM02&quot;, &quot;CIECAM02 JMh&quot;, &quot;CAM16&quot;, &quot;CAM16 JMh&quot;, &quot;CIECAM16&quot;, &quot;CIECAM16 JMh&quot;, &quot;Hellwig 2022&quot;, &quot;Hellwig 2022 JMh&quot;, &quot;Kim 2009&quot;, &quot;Hunt&quot;, &quot;LLAB&quot;, &quot;Nayatani95&quot;, &quot;RLAB&quot;, &quot;sCAM&quot;, &quot;sCAM JMh&quot;, &quot;ZCAM&quot;, &quot;CAM02LCD&quot;, &quot;CAM02SCD&quot;, &quot;CAM02UCS&quot;, &quot;CAM16LCD&quot;, &quot;CAM16SCD&quot;, &quot;CAM16UCS&quot;] | (def sd_to_XYZ(sd: @Todo | SpectralDistribution | MultiSpectralDistributions, cmfs: MultiSpectralDistributions | None = None, illuminant: SpectralDistribution | None = None, k: @Todo | None = None, method: str = Literal[&quot;ASTM E308&quot;], **kwargs: Any) -&gt; @Todo) | ... omitted 117 union elements`
</code></pre>
</blockquote>
<p>Possibly not something for this PR, but we should look into why we&#x27;re creating these huge unions in <code>colour</code> (the size of which apparently doubles with this PR!). It obviously really slows us down when we get unions that big. We might want to look into whether it&#x27;s really correct/beneficial to be inferring these huge unions on that codebase. Even if it is, maybe there are some places where we handle unions in an inefficient way that we can optimise. (Operations on unions are inherently at least quadratic, but we might be able to add caching in some places, and there still might be some places where our handling is accidentally worse than quadratic unnecessarily.)</p>
<p>(The reason why we added <code>colour</code> as a benchmark originally is that both pyright and mypy used to have truly pathological performance on that codebase. I guess we&#x27;re starting to see why that might be the case...!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/generics.rs</code>:1148 on 2025-10-09 11:42</div>
            <div class="timeline-body"><p>I think I&#x27;d need an example to understand this better..</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> approved on 2025-10-09 11:43</div>
            <div class="timeline-body"><p>Thank you — this looks great.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-09 11:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types.rs</code>:858 on 2025-10-09 11:47</div>
            <div class="timeline-body"><p>we also require <code>tuple</code>, here: <a href="https://github.com/astral-sh/ruff/blob/f0d0b5790079cc38ec0f4b34d771a056f1cd1481/crates/ty_python_semantic/src/types/tuple.rs#L200-L217">https://github.com/astral-sh/ruff/blob/f0d0b5790079cc38ec0f4b34d771a056f1cd1481/crates/ty_python_semantic/src/types/tuple.rs#L200-L217</a></p>
<p>But yes, in general I think we should try to impose as few restrictions as possible on users of custom typesheds, and should try our hardest to gracefully fallback to <code>Unknown</code> in situations when we try to lookup classes in typeshed</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/type_compendium/tuple.md</code>:531 on 2025-10-09 12:02</div>
            <div class="timeline-body"><p>there are some interesting examples above this for unannotated <code>frozenset</code>s (which don&#x27;t need to be fixed in this PR, I&#x27;m just mentioning it because it might be something you&#x27;d be interested in fixing in future work). <code>frozenset</code>, like <code>tuple</code>, is covariant, so for an unannotated <code>x = frozenset((1, 2, 3))</code> call, we would ideally infer the type as <code>frozenset[Literal[1, 2, 3]]</code>, the same as we would infer <code>(1, 2, 3)</code> as <code>tuple[Literal[1], Literal[2], Literal[3]]</code> rather than <code>tuple[int, int, int]</code>. Unlike with invariant generics, <code>Literal</code> types don&#x27;t really cause any ergonomic issues when they appear in specializations of covariant types.</p>
<p>But we need to be careful: <code>list(frozenset((1, 2, 3)))</code> should still be inferred as <code>list[int]</code> rather than <code>list[Literal[1, 2, 3]]</code> if there&#x27;s no declared type! And <code>[frozenset((1, 2))]</code> should be <code>list[frozenset[int]]</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types.rs</code>:1215 on 2025-10-09 12:11</div>
            <div class="timeline-body"><p>Hrm, I think I <em>would</em> prefer <code>list[Any | Literal[1]]</code> to be the revealed type there... but I do agree that this seems unlikely to come up in the real world, so it doesn&#x27;t need to block this PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types.rs</code>:5216 on 2025-10-09 12:22</div>
            <div class="timeline-body"><p>It seems like we currently have only one use of <code>try_call_dunder</code> that passes a <code>tcx</code> which isn&#x27;t <code>TypeContext::default()</code>, but all callsites become more verbose because of the new parameter. Is it worth maybe having two methods?</p>
<pre><code>    fn try_call_dunder(
        self,
        db: &amp;&#x27;db dyn Db,
        name: &amp;str,
        mut argument_types: CallArguments&lt;&#x27;_, &#x27;db&gt;,
    ) -&gt; Result&lt;Bindings&lt;&#x27;db&gt;, CallDunderError&lt;&#x27;db&gt;&gt; {
        self.try_call_dunder_with_type_context(
	        self,
	        db: &amp;&#x27;db dyn Db,
	        name: &amp;str,
	        mut argument_types: CallArguments&lt;&#x27;_, &#x27;db&gt;,
            TypeContext::default()
	    )
    }

    fn try_call_dunder_with_type_context(
        self,
        db: &amp;&#x27;db dyn Db,
        name: &amp;str,
        mut argument_types: CallArguments&lt;&#x27;_, &#x27;db&gt;,
        tcx: TypeContext&lt;&#x27;db&gt;,
    ) -&gt; Result&lt;Bindings&lt;&#x27;db&gt;, CallDunderError&lt;&#x27;db&gt;&gt; {
        // Has the body of the method called `try_call_dunder` on your branch
    }
</code></pre>
<p>Then most callsites could use the <code>try_call_dunder()</code> method and not have to worry about the <code>tcx</code> argument.</p>
<p>Or are we anticipating that we&#x27;ll want to eventually plumb the type context through many more of these <code>try_call_dunder</code> calls in due course?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types.rs</code>:6364 on 2025-10-09 12:25</div>
            <div class="timeline-body"><p>same question here -- it seems like the vast majority of <code>apply_type_mapping()</code> calls currently just pass in <code>TypeContext::default()</code>, so I wonder if it would be more ergonomic to have separate <code>apply_type_mapping</code> and <code>apply_type_mapping_with_context</code> methods, where the former would just be a thin wrapper around the latter?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-09 12:28</div>
            <div class="timeline-body"><p>Cool stuff!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/T-256">@T-256</a> reviewed on 2025-10-09 16:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/T-256">@T-256</a> on <code>crates/ty_python_semantic/resources/mdtest/assignment/annotations.md</code>:133 on 2025-10-09 16:01</div>
            <div class="timeline-body"><p>is that mean <code>x: list[Literal[1, 2, 3]] = [2]</code> declaration is fine?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-10-09 19:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_python_semantic/src/types/generics.rs</code>:1148 on 2025-10-09 19:41</div>
            <div class="timeline-body"><p>Nevermind, I just needed to map the type variable instances, instead of relying on the order of the parameters.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-10-09 19:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_python_semantic/src/types.rs</code>:858 on 2025-10-09 19:45</div>
            <div class="timeline-body"><p>We also require this for <code>list</code>, <code>set</code>, and <code>dict</code>, which are the same classes that this method is used for: <a href="https://github.com/astral-sh/ruff/blob/db91ac7dce312b24dc7d7adbf0f2857f6771fccd/crates/ty_python_semantic/src/types/infer/builder.rs#L5589-L5592">https://github.com/astral-sh/ruff/blob/db91ac7dce312b24dc7d7adbf0f2857f6771fccd/crates/ty_python_semantic/src/types/infer/builder.rs#L5589-L5592</a></p>
<p>It would be easy to fallback and ignore the type context though, if that&#x27;s preferable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-10-09 19:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_python_semantic/src/types.rs</code>:6364 on 2025-10-09 19:48</div>
            <div class="timeline-body"><p>I think passing <code>TypeContext::default()</code> is a useful cue that we are ignoring a potential type context. There are probably cases where we currently have type context but are not making use of it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-10-09 19:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_python_semantic/resources/mdtest/assignment/annotations.md</code>:133 on 2025-10-09 19:49</div>
            <div class="timeline-body"><p>Yes, that works fine, as it&#x27;s equivalent to <code>x: list[Literal[1] | Literal[2] | Literal[3]] = [2]</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> removed by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-10-09 19:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-10-09 19:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-10-09 19:57</div>
            <div class="timeline-body"><blockquote>
<p>These look quite odd -- any idea what&#x27;s causing these diagnostics?</p>
</blockquote>
<p>I fixed these, we were passing incorrect <code>TypeContext</code> to generic constructors in some cases, the ecosystem report is much better now.</p>
<p>The diagnostics are interesting though — we currently reinfer the RHS of annotated assignments without any type-context before displaying the diagnostics. This was originally to avoid unioning the inferred type with the type annotation, but it now also means that we always perform literal promotion (as there is no type-context to prevent it). For example:</p>
<pre><code>x: list[Literal[3]] = [2]
</code></pre>
<pre><code>error[invalid-assignment]: Object of type `list[Unknown | int]` is not assignable to `list[Literal[3]]`
 --&gt; x.py:3:1
  |
1 | from typing import Literal
2 |
3 | x: list[Literal[3]] = [2]
  | ^
</code></pre>
<p>The type in the diagnostic is now <em>less</em> precise because of the reinference. I don&#x27;t think the &quot;<code>X[T]</code> is not assignable to <code>X[T]</code>&quot; error is ever possible without a bug in ty, but this example also seems problematic. I&#x27;m not sure if we should avoid literal promotion entirely during reinference (which could lead to large unions in diagnostics), or just remove the reinference step entirely.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-09 19:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types.rs</code>:858 on 2025-10-09 19:58</div>
            <div class="timeline-body"><blockquote>
<p>It would be easy to fallback and ignore the type context though, if that&#x27;s preferable.</p>
</blockquote>
<p>I think that would be better, if it&#x27;s easy. Even if it&#x27;s unlikely that users would actually try to use custom typesheds that didn&#x27;t include these classes, it makes it easier to write tests that have custom typesheds in them if we keep the requirements here to an absolute minimum</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-09 19:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types.rs</code>:6364 on 2025-10-09 19:58</div>
            <div class="timeline-body"><p>Okay, that&#x27;s fine then 👍</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-09 20:01</div>
            <div class="timeline-body"><blockquote>
<p>The diagnostics are interesting though — we currently reinfer the RHS of annotated assignments without any type-context before displaying the diagnostics. This was originally to avoid unioning the inferred type with the type annotation, but it now also means that we always perform literal promotion (as there is no type-context to prevent it).</p>
</blockquote>
<p>Those diagnostics don&#x27;t seem <em>too</em> bad to me tbh — I&#x27;ve seen worse from mypy/pyright for this kind of thing 😆 I wouldn&#x27;t spend too much time on that right now, personally</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/T-256">@T-256</a> reviewed on 2025-10-09 20:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/T-256">@T-256</a> on <code>crates/ty_python_semantic/resources/mdtest/assignment/annotations.md</code>:133 on 2025-10-09 20:14</div>
            <div class="timeline-body"><p>it&#x27;s worth to add such example to mdtests, At first, I thought all values in <code>Literal[</code> part of annotation must be as same as declared values.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-10-09 20:40</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> removed by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-10-09 20:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-10-09 20:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-10-09 20:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-10-09 20:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-10-09 20:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-10-09 20:59</div>
            <div class="timeline-body"><p>The regression on <code>colour</code> seemed to be because of a bug in the literal promotion code. This change now has no performance impact.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:19:21 UTC
    </footer>
</body>
</html>
