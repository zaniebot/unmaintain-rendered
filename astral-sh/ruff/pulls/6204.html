<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-pyi`] Implement `custom_type_var_return_type` (`PYI019`) - astral-sh/ruff #6204</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-pyi</code>] Implement <code>custom_type_var_return_type</code> (<code>PYI019</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6204">#6204</a>
        opened by <a href="https://github.com/qdegraaf">@qdegraaf</a>
        on 2023-07-31 17:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/qdegraaf">@qdegraaf</a></div>
            <div class="timeline-body">Summary
<p>Implements <code>Y019</code> from <a href="https://github.com/PyCQA/flake8-pyi">flake8-pyi</a>.</p>
<p>The rule checks if</p>
<ul>
<li>instance methods that return <code>self</code></li>
<li>class methods that return an instance of <code>cls</code></li>
<li><code>__new__</code> methods</li>
</ul>
<p>Return a custom <code>TypeVar</code> instead of <code>typing.Self</code> and raises a violation if this is the case. The rule also covers <a href="https://peps.python.org/pep-0695/">PEP-695</a> syntax as introduced in upstream in <a href="https://github.com/PyCQA/flake8-pyi/pull/402">PyCQA/flake8-pyi#402</a></p>
Test Plan
<p>Added fixtures with test cases from upstream implementation (plus additional one for an excluded edge case, mentioned in upstream implementation)</p>
Issue link:
<p>Refers: <a href="https://github.com/astral-sh/ruff/issues/848">astral-sh/ruff#848</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/qdegraaf">@qdegraaf</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/custom_typevar_return.rs</code>:145 on 2023-07-31 17:22</div>
            <div class="timeline-body"><p>Upstream implementation mentions the exception as follows:</p>
<pre><code># Don&#x27;t error if the first argument is annotated
# with `builtins.type[T]` or `typing.Type[T]`
# These are edge cases, and it&#x27;s hard to give good error messages for them.
if not _is_name(first_arg_annotation.value, &quot;type&quot;):
    return
</code></pre>
<p>Source: https://github.com/PyCQA/flake8-pyi/blob/2a86db8271dc500247a8a69419536240334731cf/pyi.py#L1843C1-L1847</p>
<p>Unsure if this was a typo or I am missing something. But it seems to me that <code>builtins.type[T]</code> is not the edge case but the thing we want to check.</p>
<p>I&#x27;ve implemented what I think they meant. But just mentioning it here as I might be confused or missing something.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/qdegraaf">@qdegraaf</a> reviewed on 2023-07-31 17:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/qdegraaf">@qdegraaf</a> reviewed on 2023-07-31 17:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/qdegraaf">@qdegraaf</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/custom_typevar_return.rs</code>:19 on 2023-07-31 17:24</div>
            <div class="timeline-body"><p>Scanned through PRs relating to Y019 in upstream repo but found no further explanation as to why this is problematic precisely.</p>
<p>I assumed, similar to <code>NonSelfReturnType</code> (or <code>PYI034</code>) it&#x27;s hard for type checkers to infer the type when subclassed.</p>
<p>Input for a more complete explanation is welcomed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/resources/test/fixtures/flake8_pyi/PYI019.pyi</code>:4 on 2023-07-31 17:34</div>
            <div class="timeline-body"><p>Should there be coverage for PEP 695 declarations like <code>type _S = ...</code>? or is that not relevant?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-31 17:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-07-31 17:40</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>âœ… ecosystem check detected no changes.</p>
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01      9.9Â±0.05ms     4.1 MB/sec    1.00      9.8Â±0.05ms     4.2 MB/sec
formatter/numpy/ctypeslib.py               1.00  1945.8Â±15.00Âµs     8.6 MB/sec    1.00  1939.5Â±10.08Âµs     8.6 MB/sec
formatter/numpy/globals.py                 1.00    216.9Â±3.77Âµs    13.6 MB/sec    1.00    216.1Â±0.99Âµs    13.7 MB/sec
formatter/pydantic/types.py                1.00      4.2Â±0.02ms     6.1 MB/sec    1.00      4.2Â±0.01ms     6.1 MB/sec
linter/all-rules/large/dataset.py          1.00     13.1Â±0.10ms     3.1 MB/sec    1.00     13.1Â±0.10ms     3.1 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.4Â±0.00ms     5.0 MB/sec    1.00      3.4Â±0.01ms     5.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    453.8Â±0.88Âµs     6.5 MB/sec    1.00    454.5Â±1.16Âµs     6.5 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.9Â±0.02ms     4.3 MB/sec    1.00      5.9Â±0.02ms     4.4 MB/sec
linter/default-rules/large/dataset.py      1.00      6.8Â±0.01ms     6.0 MB/sec    1.00      6.8Â±0.03ms     5.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1432.0Â±4.15Âµs    11.6 MB/sec    1.00   1426.3Â±7.56Âµs    11.7 MB/sec
linter/default-rules/numpy/globals.py      1.01    157.2Â±1.53Âµs    18.8 MB/sec    1.00    156.0Â±1.06Âµs    18.9 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.0Â±0.01ms     8.4 MB/sec    1.00      3.0Â±0.01ms     8.4 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01     12.3Â±0.52ms     3.3 MB/sec    1.00     12.2Â±0.30ms     3.3 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.3Â±0.08ms     7.1 MB/sec    1.03      2.4Â±0.14ms     6.9 MB/sec
formatter/numpy/globals.py                 1.00   262.5Â±12.21Âµs    11.2 MB/sec    1.02   267.6Â±18.42Âµs    11.0 MB/sec
formatter/pydantic/types.py                1.00      5.1Â±0.18ms     5.0 MB/sec    1.03      5.3Â±0.21ms     4.8 MB/sec
linter/all-rules/large/dataset.py          1.00     16.4Â±0.51ms     2.5 MB/sec    1.01     16.6Â±0.39ms     2.4 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.4Â±0.16ms     3.8 MB/sec    1.01      4.4Â±0.13ms     3.8 MB/sec
linter/all-rules/numpy/globals.py          1.03   549.7Â±72.49Âµs     5.4 MB/sec    1.00   534.5Â±23.76Âµs     5.5 MB/sec
linter/all-rules/pydantic/types.py         1.03      7.7Â±0.28ms     3.3 MB/sec    1.00      7.5Â±0.24ms     3.4 MB/sec
linter/default-rules/large/dataset.py      1.00      9.0Â±0.19ms     4.5 MB/sec    1.00      9.0Â±0.29ms     4.5 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01  1878.1Â±73.24Âµs     8.9 MB/sec    1.00  1856.0Â±57.93Âµs     9.0 MB/sec
linter/default-rules/numpy/globals.py      1.00   210.5Â±13.40Âµs    14.0 MB/sec    1.00    211.0Â±9.84Âµs    14.0 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.0Â±0.11ms     6.5 MB/sec    1.01      4.0Â±0.17ms     6.4 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2023-07-31 19:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/custom_typevar_return.rs</code>:145 on 2023-07-31 19:59</div>
            <div class="timeline-body"><p>I think what I was trying to say in that comment was that we emit Y019 for this:</p>
<pre><code>def __new__(cls: type[S]) -&gt; S: ...
</code></pre>
<p>But not for any of these:</p>
<pre><code>def __new__(cls: builtins.type[S]) -&gt; S: ...
def __new__(cls: Type[S]) -&gt; S: ...
def __new__(cls: typing.Type[S]) -&gt; S: ...
</code></pre>
<p>Whereas the behaviour most consistent with how flake8-pyi usually works would be to emit the same error for all of them.</p>
<p>I can&#x27;t promise that this is the optimal  behaviour, though, just what seemed most reasonable to me at the time :D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/qdegraaf">@qdegraaf</a> reviewed on 2023-07-31 20:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/qdegraaf">@qdegraaf</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/custom_typevar_return.rs</code>:145 on 2023-07-31 20:15</div>
            <div class="timeline-body"><p>Hey Alex,</p>
<p>Thanks for chipping in! Then the confusion is on me, and not the comment ðŸ˜… .</p>
<p>Can you explain why <code>builtins.type[S]</code> is more problematic than just <code>type[S]</code>? Or <code>typing.Type</code> for that matter? Is it just a message formatting thing or are there functional differences?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2023-07-31 20:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/custom_typevar_return.rs</code>:145 on 2023-07-31 20:22</div>
            <div class="timeline-body"><p>Yeah I think, as the comment says, it just felt complicated to get a good error message in that kind of situation without excessively complicating the code. For <code>Type</code> and <code>typing.Type</code>, I think I might also have been worried about having two error messages telling the user to do contradictory things (one flake8-pyi code tells you to use <code>type</code> instead of <code>Type</code>; the other tells you to use <code>Self</code>, what do you do?!)</p>
<p>But I can&#x27;t really remember the exact reasoning for making the decision (it was a while ago!) and it&#x27;s entirely possible we could/should revisit it at flake8-pyi!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/qdegraaf">@qdegraaf</a> reviewed on 2023-07-31 20:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/qdegraaf">@qdegraaf</a> on <code>crates/ruff/resources/test/fixtures/flake8_pyi/PYI019.pyi</code>:4 on 2023-07-31 20:24</div>
            <div class="timeline-body"><p>The full heuristic, as derived from upsteam, right now is:</p>
<pre><code>fn is_likely_private_typevar(
    checker: &amp;Checker,
    tvar_name: &amp;str,
    type_params: &amp;[TypeParam],
) -&gt; bool {
    if tvar_name.starts_with(&#x27;_&#x27;) {
        return true;
    }
    if checker.settings.target_version &lt; PythonVersion::Py312 {
        return false;
    }

    for param in type_params {
        if let TypeParam::TypeVar(ast::TypeParamTypeVar { name, .. }) = param {
            return name == tvar_name;
        }
    }
    false
}
</code></pre>
<p>Which should catch</p>
<pre><code>type _S = ...
type T = ...

class Foo:
    def foo[T](self: T) -&gt; T: ...
    def bar(self: _S) -&gt; _S: ...
</code></pre>
<p>But will miss any TypeVar or type not prefixed by a &quot;_&quot; and not used with PEP-695 style type parameters regardless of Python version.</p>
<p>I tried letting go of upstream&#x27;s implementation and replacing the heuristic with a check on the binding to see if it was assigned to a TypeVar or type but could not get it to work (and it was not pretty). If this is possible and doable in a performant manner with some input, I would be open to replacing the heuristic with that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/qdegraaf">@qdegraaf</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/custom_typevar_return.rs</code>:145 on 2023-07-31 20:33</div>
            <div class="timeline-body"><p>Clear! I&#x27;ll leave it like this for now. Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/qdegraaf">@qdegraaf</a> reviewed on 2023-07-31 20:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2023-07-31 20:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/custom_typevar_return.rs</code>:19 on 2023-07-31 20:36</div>
            <div class="timeline-body"><p>This rule (unlike Y034) isn&#x27;t to do with correctness; it&#x27;s mainly just to enforce a consistent style and not have to have needles TypeVar definitions cluttering up stub files</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-08-01 14:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/resources/test/fixtures/flake8_pyi/PYI019.pyi</code>:4 on 2023-08-01 14:33</div>
            <div class="timeline-body"><p>cc @charliermarsh who will probably have a better suggestion than me</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-03 00:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/resources/test/fixtures/flake8_pyi/PYI019.pyi</code>:4 on 2023-08-03 00:32</div>
            <div class="timeline-body"><p>I think it&#x27;s okay to use this heuristic for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-03 00:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[`flake8-pyi`] Implement `PYI019`&quot; to &quot;[`flake8-pyi`] Implement `custom_type_var_return_type` (`PYI019`)&quot; by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-03 00:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-03 00:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-03 00:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-08-03 11:20</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:55:51 UTC
    </footer>
</body>
</html>
