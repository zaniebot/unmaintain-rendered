<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pygrep_hooks`] Check blanket ignores via file-level pragmas (`PGH004`) - astral-sh/ruff #11540</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pygrep_hooks</code>] Check blanket ignores via file-level pragmas (<code>PGH004</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11540">#11540</a>
        opened by <a href="https://github.com/ajesipow">@ajesipow</a>
        on 2024-05-25 10:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ajesipow">@ajesipow</a></div>
            <div class="timeline-body">Summary
<p>Should resolve <a href="https://github.com/astral-sh/ruff/issues/11454">astral-sh/ruff#11454</a>.</p>
<p>This is my first PR to <code>ruff</code>, so I may have missed something.</p>
<p>If I understood the suggestion in the issue correctly, rule <code>PGH004</code> should be set to <code>Preview</code> again.</p>
Test Plan
<p>Created two fixtures derived from the issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-05-25 11:14</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+5 -0 violations, +0 -0 fixes in 4 projects; 46 projects unchanged)</p>
<a href="https://github.com/apache/airflow">apache/airflow</a> (+1 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/apache/airflow/blob/8b99ad0fbe136371de4c303f7ffee9b5469e77e0/docs/exts/exampleinclude.py#L1">docs/exts/exampleinclude.py:1:1:</a> PGH004 Use specific rule codes when using `ruff: noqa`
</pre>

</p>

<a href="https://github.com/indico/indico">indico/indico</a> (+2 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/indico/indico/blob/ae28f6b55c09cf3cc1508e921977ae9f0cb46cb8/indico/legacy/pdfinterface/base.py#L8">indico/legacy/pdfinterface/base.py:8:1:</a> PGH004 Use specific rule codes when using `ruff: noqa`
+ <a href="https://github.com/indico/indico/blob/ae28f6b55c09cf3cc1508e921977ae9f0cb46cb8/indico/legacy/pdfinterface/conference.py#L8">indico/legacy/pdfinterface/conference.py:8:1:</a> PGH004 Use specific rule codes when using `ruff: noqa`
</pre>

</p>

<a href="https://github.com/pytest-dev/pytest">pytest-dev/pytest</a> (+1 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/pytest-dev/pytest/blob/7be95f9b30ffd418483bdb57112f9339465d4695/testing/code/test_source.py#L2">testing/code/test_source.py:2:1:</a> PGH004 Use specific rule codes when using `ruff: noqa`
</pre>

</p>

<a href="https://github.com/pdm-project/pdm">pdm-project/pdm</a> (+1 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/pdm-project/pdm/blob/f429652f856a61f59ce5013e3195a30fbe88ce62/src/pdm/installers/__init__.py#L1">src/pdm/installers/__init__.py:1:1:</a> PGH004 Use specific rule codes when using `ruff: noqa`
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PGH004 | 5 | 5 | 0 | 0 | 0 |</p>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2024-05-25 12:55</div>
            <div class="timeline-body"><p>The stable behavior should be unchanged, the added behavior should only be present in preview.
i.e. The ruff ecosystem results should not change for stable, only preview should have additional violations.
Otherwise, the users of stable will lose the PGH004 rule.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ajesipow">@ajesipow</a> on 2024-05-25 17:10</div>
            <div class="timeline-body"><p>Thanks for the swift feedback.</p>
<p>I added a check for <code>PreviewMode::Enabled</code> and added tests for the preview case.</p>
<p>Would you like me to also update the docs for <code>BlanketNOQA</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/zanieb">@zanieb</a> by <a href="https://github.com/zanieb">@zanieb</a> on 2024-05-25 17:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-27 00:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/pygrep_hooks/rules/blanket_noqa.rs</code>:89 on 2024-05-27 00:39</div>
            <div class="timeline-body"><p>One downside here is that this is only going to flag the <em>first</em> <code># ruff: noqa</code> in the file. I assume if you add multiple such comments, only the first is flagged as a diagnostic?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-27 00:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/pygrep_hooks/rules/blanket_noqa.rs</code>:89 on 2024-05-27 00:40</div>
            <div class="timeline-body"><p>We might need to do something like <code>NoqaDirectives</code>, whereby we parse all of these upfront, then use the parsed exemptions in <code>crates/ruff_linter/src/checkers/noqa.rs</code> (and here).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-28 13:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-28 13:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-28 13:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-30 03:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/pygrep_hooks/rules/blanket_noqa.rs</code>:89 on 2024-05-30 03:59</div>
            <div class="timeline-body"><p>@ajesipow - Do you want to give that a try?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ajesipow">@ajesipow</a> reviewed on 2024-05-30 07:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ajesipow">@ajesipow</a> on <code>crates/ruff_linter/src/rules/pygrep_hooks/rules/blanket_noqa.rs</code>:89 on 2024-05-30 07:24</div>
            <div class="timeline-body"><p>Thanks for the ping @charliermarsh.
I haven&#x27;t found the time yet after work this week, but today is a public holiday over here so I&#x27;ll look into it today :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ajesipow">@ajesipow</a> reviewed on 2024-05-30 10:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ajesipow">@ajesipow</a> on <code>crates/ruff_linter/src/noqa.rs</code>:285 on 2024-05-30 10:21</div>
            <div class="timeline-body"><p>I left this as a <code>Vec</code>, but we could consider using a <code>HashSet</code> instead as we&#x27;re checking if certain <code>NoqaCode</code>s are contained in a few places (one being the loop on line 54 in <code>checkers/noqa.rs</code>).</p>
<p>It&#x27;s probably fine though as I&#x27;d expect there will usually only be very few elements here and checking the small <code>Vec</code> is likely faster compared to the overhead of hashing every time (and building the <code>HashSet</code> in the first place).
We&#x27;d also have to derive <code>Hash</code> on <code>NoqaCode</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ajesipow">@ajesipow</a> on <code>crates/ruff_linter/src/rules/pygrep_hooks/rules/blanket_noqa.rs</code>:89 on 2024-05-30 10:26</div>
            <div class="timeline-body"><p>I just pushed the changes and adapted the tests again accordingly.</p>
<p>Looking forward to your feedback again.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ajesipow">@ajesipow</a> reviewed on 2024-05-30 10:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-30 17:44</div>
            <div class="timeline-body"><p>Thanks @ajesipow, I will take a look.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-06-04 03:41</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[pygrep_hooks] Check file-level pragmas (PGH004)&quot; to &quot;[`pygrep_hooks`] Check blanket ignores via file-level pragmas (`PGH004`)&quot; by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-04 03:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-04 03:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-04 03:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-06-04 03:44</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/ajesipow:pgh004-file-level">CodSpeed Performance Report</a>
Merging #11540 will <strong>degrade performances by 5.63%</strong>
<p>Comparing <code>ajesipow:pgh004-file-level</code> (4e80490) with <code>ajesipow:pgh004-file-level</code> (8574036)</p>
Summary
<p><code>❌ 1</code> regressions
<code>✅ 29</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/ajesipow:pgh004-file-level">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
Benchmarks breakdown
<p>|     | Benchmark | <code>ajesipow:pgh004-file-level</code> | <code>ajesipow:pgh004-file-level</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ❌ | <code>linter/all-rules[unicode/pypinyin.py]</code> | 2 ms | 2.1 ms | -5.63% |</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:04:12 UTC
    </footer>
</body>
</html>
