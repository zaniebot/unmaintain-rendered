<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Place comments of left and right binary expression operands - astral-sh/ruff #4751</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Place comments of left and right binary expression operands</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4751">#4751</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-05-31 09:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">

Summary
<p>This PR implements the custom logic that associates comments between the left binary expression operand and the oprator as trailing comments to the <code>left</code> AND trailing end of line comments that are on the same line as the operator as dangling comments of the binary expression.</p>
<pre><code>a = (
    5 # trailing left comment
    + # trailing operator comment
    # leading right comment
    3
)
</code></pre>


Test Plan
<p>I added a few new snapshot tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-05-31 09:40</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #4639</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4639"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite"></a><ul>
<li><strong>PR #4641</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4641"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite"></a><ul>
<li><strong>PR #4642</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4642"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite"></a><ul>
<li><strong>PR #4671</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4671"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite"></a><ul>
<li><strong>PR #4748</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4748"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite"></a>
* <strong>PR #4751</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4751"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite"></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4751?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-05-31 09:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">autoformatter</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-05-31 09:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/trivia.rs</code>:12 on 2023-05-31 09:55</div>
            <div class="timeline-body"><p>I extracted this utility because we can re-use it when e.g. searching for a trailing <code>,</code>.</p>
<p>We probably want another utility that searches backwards. This is going to be more expensive if the range contains line breaks, because we need to run to the start of the line to verify that the non-trivia character isn&#x27;t a comment. However, we only need to do this for the second line:</p>
<pre><code>(a) # Cheap, because no line break between `(` and `a`
(
	# this is a comment
	a
) # Needs to process all characters, including the comment. 

(b + 
	a
) # Must process all of `(b +` only to return `+` the plus when searching from the `a` because it must test if `(b + ` is a comment
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-31 09:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-05-31 09:56</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>âœ… ecosystem check detected no changes.</p>
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.01     15.3Â±0.08ms     2.7 MB/sec    1.00     15.2Â±0.11ms     2.7 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.6Â±0.01ms     4.6 MB/sec    1.00      3.6Â±0.02ms     4.6 MB/sec
linter/all-rules/numpy/globals.py          1.01    374.2Â±0.65Âµs     7.9 MB/sec    1.00    371.7Â±1.09Âµs     7.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.3Â±0.01ms     4.0 MB/sec    1.00      6.3Â±0.02ms     4.1 MB/sec
linter/default-rules/large/dataset.py      1.00      7.5Â±0.01ms     5.4 MB/sec    1.00      7.5Â±0.02ms     5.4 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1594.7Â±3.54Âµs    10.4 MB/sec    1.00   1589.7Â±9.11Âµs    10.5 MB/sec
linter/default-rules/numpy/globals.py      1.00    175.0Â±0.54Âµs    16.9 MB/sec    1.00    175.0Â±1.95Âµs    16.9 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.4Â±0.01ms     7.5 MB/sec    1.00      3.4Â±0.01ms     7.6 MB/sec
parser/large/dataset.py                    1.00      5.7Â±0.00ms     7.1 MB/sec    1.01      5.8Â±0.00ms     7.1 MB/sec
parser/numpy/ctypeslib.py                  1.00   1118.6Â±0.98Âµs    14.9 MB/sec    1.01   1132.3Â±2.10Âµs    14.7 MB/sec
parser/numpy/globals.py                    1.00    115.0Â±0.32Âµs    25.7 MB/sec    1.02    116.9Â±0.50Âµs    25.2 MB/sec
parser/pydantic/types.py                   1.00      2.4Â±0.00ms    10.4 MB/sec    1.01      2.5Â±0.00ms    10.3 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     17.0Â±0.21ms     2.4 MB/sec    1.03     17.5Â±0.28ms     2.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.3Â±0.06ms     3.9 MB/sec    1.04      4.4Â±0.08ms     3.8 MB/sec
linter/all-rules/numpy/globals.py          1.00   506.4Â±15.70Âµs     5.8 MB/sec    1.03    522.1Â±9.48Âµs     5.7 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.2Â±0.14ms     3.5 MB/sec    1.05      7.5Â±0.09ms     3.4 MB/sec
linter/default-rules/large/dataset.py      1.00      8.4Â±0.09ms     4.8 MB/sec    1.01      8.5Â±0.23ms     4.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1784.7Â±19.60Âµs     9.3 MB/sec    1.00  1787.1Â±21.69Âµs     9.3 MB/sec
linter/default-rules/numpy/globals.py      1.00    204.8Â±3.31Âµs    14.4 MB/sec    1.02   208.6Â±10.66Âµs    14.1 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.8Â±0.04ms     6.7 MB/sec    1.00      3.8Â±0.04ms     6.7 MB/sec
parser/large/dataset.py                    1.00      6.5Â±0.08ms     6.3 MB/sec    1.00      6.5Â±0.12ms     6.3 MB/sec
parser/numpy/ctypeslib.py                  1.00  1217.5Â±22.00Âµs    13.7 MB/sec    1.00  1212.0Â±19.85Âµs    13.7 MB/sec
parser/numpy/globals.py                    1.00    125.1Â±2.90Âµs    23.6 MB/sec    1.00    125.1Â±1.94Âµs    23.6 MB/sec
parser/pydantic/types.py                   1.00      2.8Â±0.04ms     9.2 MB/sec    1.00      2.8Â±0.04ms     9.3 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-31 15:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:478 on 2023-05-31 15:06</div>
            <div class="timeline-body"><p>Where should this be placed, in the formatted output?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/comments/snapshots/ruff_python_formatter__comments__tests__nested_binary_expression.snap</code>:5 on 2023-05-31 15:58</div>
            <div class="timeline-body"><p>I continue to find these very very useful.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-31 15:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-05-31 15:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:478 on 2023-06-01 06:52</div>
            <div class="timeline-body"><p>The same as shown in this code snippet at the end of the operator line.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-01 06:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-01 07:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-01 07:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-06-01 07:01</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:54:06 UTC
    </footer>
</body>
</html>
