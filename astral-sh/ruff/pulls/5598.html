<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add support for `Union` declarations without `|` to PYI016 - astral-sh/ruff #5598</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add support for <code>Union</code> declarations without <code>|</code> to PYI016</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5598">#5598</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2023-07-07 17:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/zanieb">@zanieb</a> on 2023-07-07 17:27</div>
            <div class="timeline-body"><p>Previously, PYI016 only supported reporting violations for unions defined with <code>|</code>. Now, union declarations with <code>typing.Union</code> are supported.</p>
<p>This implementation reuses the union traversal logic from #5570.</p>
<p>PYI016 will not attempt to fix cases where <code>Union</code> is used. Unlike <code>|</code>, removing members from a <code>Union</code> can result in an invalid union definition. We may be able to support this in the future as in PYI030 the complexity seems high.</p>
<p>Tested with new snapshot cases <code>./target/debug/ruff --select PYI016 crates/ruff/resources/test/fixtures/flake8_pyi/PYI016.pyi --show-source</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/resources/test/fixtures/flake8_pyi/PYI016.pyi</code>:50 on 2023-07-07 17:29</div>
            <div class="timeline-body"><p>I've added some more edge cases that are not relevant for this pull request but are good to cover</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-07 17:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-07-07 17:38</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>â„¹ï¸ ecosystem check <strong>detected changes</strong>. (+3, -0, 0 error(s))</p>
<details><summary>bokeh (+3, -0)</summary>
<p>

<pre>
+ <a href='https://github.com/bokeh/bokeh/blob/branch-3.2/src/bokeh/core/property/factors.py#L51'>src/bokeh/core/property/factors.py:51:56:</a> PYI016 Duplicate union member `tuple[str, str]`
+ <a href='https://github.com/bokeh/bokeh/blob/branch-3.2/src/bokeh/core/property/factors.py#L52'>src/bokeh/core/property/factors.py:52:85:</a> PYI016 Duplicate union member `tp.Sequence[tuple[str, str]]`
+ <a href='https://github.com/bokeh/bokeh/blob/branch-3.2/src/bokeh/plotting/contour.py#L43'>src/bokeh/plotting/contour.py:43:88:</a> PYI016 Duplicate union member `ContourColor`
</pre>

</p>
</details>
Rules changed: 1

<p>| Rule | Changes | Additions | Removals |
| ---- | ------- | --------- | -------- |
| PYI016 | 3 | 3 | 0 |</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01      9.5Â±0.03ms     4.3 MB/sec    1.00      9.4Â±0.03ms     4.3 MB/sec
formatter/numpy/ctypeslib.py               1.02      2.1Â±0.01ms     7.9 MB/sec    1.00      2.1Â±0.02ms     8.0 MB/sec
formatter/numpy/globals.py                 1.00    235.5Â±1.50Âµs    12.5 MB/sec    1.00    235.3Â±1.40Âµs    12.5 MB/sec
formatter/pydantic/types.py                1.03      4.7Â±0.03ms     5.5 MB/sec    1.00      4.5Â±0.01ms     5.6 MB/sec
linter/all-rules/large/dataset.py          1.03     16.9Â±0.10ms     2.4 MB/sec    1.00     16.3Â±0.11ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      4.2Â±0.01ms     4.0 MB/sec    1.00      4.1Â±0.02ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.00    526.0Â±2.37Âµs     5.6 MB/sec    1.00    524.5Â±3.25Âµs     5.6 MB/sec
linter/all-rules/pydantic/types.py         1.02      7.4Â±0.03ms     3.5 MB/sec    1.00      7.3Â±0.03ms     3.5 MB/sec
linter/default-rules/large/dataset.py      1.08      8.8Â±0.04ms     4.6 MB/sec    1.00      8.1Â±0.02ms     5.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.05   1879.3Â±4.13Âµs     8.9 MB/sec    1.00  1792.9Â±48.92Âµs     9.3 MB/sec
linter/default-rules/numpy/globals.py      1.03    211.8Â±1.06Âµs    13.9 MB/sec    1.00    204.7Â±0.72Âµs    14.4 MB/sec
linter/default-rules/pydantic/types.py     1.07      3.9Â±0.02ms     6.5 MB/sec    1.00      3.7Â±0.01ms     7.0 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                    pr
-----                                      ----                                    --
formatter/large/dataset.py                 1.00     11.1Â±0.43ms     3.7 MB/sec     1.00     11.2Â±0.43ms     3.6 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.4Â±0.11ms     7.0 MB/sec     1.02      2.4Â±0.19ms     6.9 MB/sec
formatter/numpy/globals.py                 1.00   278.4Â±21.02Âµs    10.6 MB/sec     1.03   286.8Â±19.95Âµs    10.3 MB/sec
formatter/pydantic/types.py                1.04      5.4Â±0.28ms     4.7 MB/sec     1.00      5.2Â±0.25ms     4.9 MB/sec
linter/all-rules/large/dataset.py          1.00     17.6Â±0.88ms     2.3 MB/sec     1.07     18.9Â±0.53ms     2.2 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      4.9Â±0.36ms     3.4 MB/sec     1.00      4.9Â±0.15ms     3.4 MB/sec
linter/all-rules/numpy/globals.py          1.00   552.8Â±35.29Âµs     5.3 MB/sec     1.09   601.9Â±31.64Âµs     4.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.8Â±0.31ms     3.3 MB/sec     1.09      8.5Â±0.40ms     3.0 MB/sec
linter/default-rules/large/dataset.py      1.00      8.9Â±0.54ms     4.6 MB/sec     1.10      9.7Â±0.34ms     4.2 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1993.0Â±115.12Âµs     8.4 MB/sec    1.02      2.0Â±0.08ms     8.2 MB/sec
linter/default-rules/numpy/globals.py      1.00    244.7Â±9.98Âµs    12.1 MB/sec     1.01   246.6Â±13.32Âµs    12.0 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.3Â±0.18ms     6.0 MB/sec     1.03      4.4Â±0.24ms     5.8 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-07-07 17:43</div>
            <div class="timeline-body"><p>Example bokeh change https://github.com/bokeh/bokeh/blob/ee3f7f27fb744860763edd1d44fcac9b797e36b4/src/bokeh/core/property/factors.py#L51</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/checkers/ast/mod.rs</code>:2201 on 2023-07-08 19:20</div>
            <div class="timeline-body"><p>Nit: this part above can be rewritten with some optional chaining:</p>
<pre><code class="language-rust">let check = self
    .semantic
    .expr_grandparent()
    .and_then(Expr::as_subscript_expr)
    .map_or(true, |parent| {
        !self.semantic.match_typing_expr(&amp;parent.value, &quot;Union&quot;)
    });
</code></pre>
<p>This is nice because you can avoid the <code>mut</code>, and all the logic is contained in one fluid expression. You could even inline this condition in the <code>if</code> and avoid creating <code>check</code> entirely.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-07-08 19:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-07-08 19:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_pyi/helpers.rs</code>:8 on 2023-07-08 19:21</div>
            <div class="timeline-body"><p>Nit: this could be <code>pub(super)</code>, since only modules in <code>flake8_pyi</code> need to have access to it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-07-08 19:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/duplicate_union_member.rs</code>:34 on 2023-07-08 19:22</div>
            <div class="timeline-body"><p>I'd probably recommend importing <code>HashSet</code> from <code>std::collections</code> so that you can just do: <code>let mut seen_nodes: HashSet&lt;...&gt; = ...</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-07-08 19:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/duplicate_union_member.rs</code>:55 on 2023-07-08 19:23</div>
            <div class="timeline-body"><p>I think this could be written as <code>if let Some(Expr::BinOp(...)) = parent</code> to avoid the <code>.expect</code> above. (I think this code already existed, but we generally prefer safe over unsafe even if the condition is <em>always</em> expected to hold true -- it's debatable whether this is the right policy, here's a blog post that argues for the opposite: https://blog.burntsushi.net/unwrap/.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-07-08 19:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/duplicate_union_member.rs</code>:76 on 2023-07-08 19:24</div>
            <div class="timeline-body"><p>(It'd be nice to append these directly as we go rather than allocate an intermediary vector, but it's not critical. I assume that lifetimes and borrowing got in the way per Discord.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-07-08 19:25</div>
            <div class="timeline-body"><p>This looks great! Love the additional test coverage too. Couple nits but nothing blocking.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2023-07-09 08:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/checkers/ast/mod.rs</code>:2201 on 2023-07-10 07:42</div>
            <div class="timeline-body"><p>Nit: I would prefer keeping the variable (I find such lengthy if's hard to read) but give it a name with more semantical meaning. Like, what are we testing here? <code>is_union</code> maybe?</p>
<p>This has the advantage that if there's a bug I have an easier time fixing it because:</p>
<ul>
<li>if <code>is_union</code> is <code>false</code> when the <code>expression</code> is a union -&gt; Okay, the bug must be with the expression initializing <code>is_union</code>. The same if <code>is_union</code> is <code>true</code> when it should not.</li>
<li>I don't need to spend time understanding this expression if the bug is with the diagnostic or fix generation but not identifying what a union is.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_pyi/helpers.rs</code>:24 on 2023-07-10 07:42</div>
            <div class="timeline-body"><p>These comments are awesome. They make reviewing the code much easier and will certainly be useful when reading this code in the future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-07-10 07:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/src/checkers/ast/mod.rs</code>:2201 on 2023-07-10 15:07</div>
            <div class="timeline-body"><p><code>is_union_but_grandparent_is_not</code> :) I'm not sure what a good name would be yet. I'll think on it.</p>
<p>edit: maybe <code>is_unchecked_union</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-10 15:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-10 15:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/src/rules/flake8_pyi/helpers.rs</code>:24 on 2023-07-10 15:13</div>
            <div class="timeline-body"><p>These actually came from the previous contribution so I can't take credit :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/duplicate_union_member.rs</code>:55 on 2023-07-10 15:21</div>
            <div class="timeline-body"><p>This is a little awkward actually we still need to have an <code>.unwrap()</code> when we call <code>range()</code> unless we want to write two <code>if let</code> statements? Perhaps I'm missing something. It is kind of nice to panic here because the traversal code is <em>broken</em> if this invariant does not hold but ğŸ¤·â€â™€ï¸ I can see both sides.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-10 15:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-10 15:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/duplicate_union_member.rs</code>:55 on 2023-07-10 15:21</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/5598/commits/cffdd346ad9fa37c3bc8c21de9ddd139a15160e6</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/duplicate_union_member.rs</code>:76 on 2023-07-10 15:25</div>
            <div class="timeline-body"><p>Yeah I tried to do this a couple ways and it seems like a pain</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-10 15:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @zanieb on 2023-07-10 16:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_pyi/mod.rs</code>:2 on 2023-07-10 16:59</div>
            <div class="timeline-body"><p>Can this just be <code>mod helpers</code>, since it doesn't need to accessed from outside of this module?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-07-10 17:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-10 17:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/src/rules/flake8_pyi/mod.rs</code>:2 on 2023-07-10 17:02</div>
            <div class="timeline-body"><p>ğŸ‘ thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2023-07-10 17:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2023-07-10 17:11</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 03:37:35 UTC
    </footer>
</body>
</html>
