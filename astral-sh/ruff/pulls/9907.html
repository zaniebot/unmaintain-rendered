<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix `E30X` panics on blank lines with trailing white spaces - astral-sh/ruff #9907</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix <code>E30X</code> panics on blank lines with trailing white spaces</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/9907">#9907</a>
        opened by <a href="https://github.com/hoel-bagard">@hoel-bagard</a>
        on 2024-02-09 09:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/hoel-bagard">@hoel-bagard</a> on 2024-02-09 09:25</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>closes #9906
The #9906 issue is triggered by blank lines with trailing white spaces. The trailing spaces cause the  <code>assert_eq!</code> that was added in <a href="https://github.com/astral-sh/ruff/pull/9266#discussion_r1452383949">this discussion</a> to fail.</p>
<p>This PR removes the  <code>assert_eq!</code>.</p>
<h2>Test Plan</h2>
<p>I tested the change on the python files provided in #9906 (on top of cargo test).
I also added a few fixtures with blank lines with trailing white spaces.</p>
<h2>Issue example/explaination</h2>
<p>The issue is triggered by blank lines with trailing white spaces.
For example, by creating a blank file with <code>echo &quot;\n     \n&quot; &gt;&gt; temp.py</code>, we get the snippet given in the issue:</p>
<pre><code>
     
</code></pre>
<p>Running ruff on this, we get the following tokens:</p>
<pre><code>(NonLogicalNewline, 0..1)
(NonLogicalNewline, 6..7)
(NonLogicalNewline, 7..8)
</code></pre>
<p>We can see that the end of the first token range's end and the second token range's start do not match because of the 5 spaces.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-02-09 09:41</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+33 -0 violations, +0 -0 fixes in 1 projects; 42 projects unchanged)</p>
<details><summary><a href="https://github.com/aws/aws-sam-cli">aws/aws-sam-cli</a> (+33 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/aws/aws-sam-cli/blob/06502930837677227f7975c93402039821d1f0ea/tests/integration/testdata/start_api/lambda_authorizers/app.py#L122'>tests/integration/testdata/start_api/lambda_authorizers/app.py:122:17:</a> E203 [*] Whitespace before ':'
+ <a href='https://github.com/aws/aws-sam-cli/blob/06502930837677227f7975c93402039821d1f0ea/tests/integration/testdata/start_api/lambda_authorizers/app.py#L123'>tests/integration/testdata/start_api/lambda_authorizers/app.py:123:15:</a> E203 [*] Whitespace before ':'
+ <a href='https://github.com/aws/aws-sam-cli/blob/06502930837677227f7975c93402039821d1f0ea/tests/integration/testdata/start_api/lambda_authorizers/app.py#L131'>tests/integration/testdata/start_api/lambda_authorizers/app.py:131:8:</a> E221 [*] Multiple spaces before operator
+ <a href='https://github.com/aws/aws-sam-cli/blob/06502930837677227f7975c93402039821d1f0ea/tests/integration/testdata/start_api/lambda_authorizers/app.py#L132'>tests/integration/testdata/start_api/lambda_authorizers/app.py:132:9:</a> E221 [*] Multiple spaces before operator
+ <a href='https://github.com/aws/aws-sam-cli/blob/06502930837677227f7975c93402039821d1f0ea/tests/integration/testdata/start_api/lambda_authorizers/app.py#L133'>tests/integration/testdata/start_api/lambda_authorizers/app.py:133:8:</a> E221 [*] Multiple spaces before operator
+ <a href='https://github.com/aws/aws-sam-cli/blob/06502930837677227f7975c93402039821d1f0ea/tests/integration/testdata/start_api/lambda_authorizers/app.py#L134'>tests/integration/testdata/start_api/lambda_authorizers/app.py:134:10:</a> E221 [*] Multiple spaces before operator
+ <a href='https://github.com/aws/aws-sam-cli/blob/06502930837677227f7975c93402039821d1f0ea/tests/integration/testdata/start_api/lambda_authorizers/app.py#L135'>tests/integration/testdata/start_api/lambda_authorizers/app.py:135:9:</a> E221 [*] Multiple spaces before operator
+ <a href='https://github.com/aws/aws-sam-cli/blob/06502930837677227f7975c93402039821d1f0ea/tests/integration/testdata/start_api/lambda_authorizers/app.py#L136'>tests/integration/testdata/start_api/lambda_authorizers/app.py:136:11:</a> E221 [*] Multiple spaces before operator
+ <a href='https://github.com/aws/aws-sam-cli/blob/06502930837677227f7975c93402039821d1f0ea/tests/integration/testdata/start_api/lambda_authorizers/app.py#L138'>tests/integration/testdata/start_api/lambda_authorizers/app.py:138:8:</a> E221 [*] Multiple spaces before operator
+ <a href='https://github.com/aws/aws-sam-cli/blob/06502930837677227f7975c93402039821d1f0ea/tests/integration/testdata/start_api/lambda_authorizers/app.py#L140'>tests/integration/testdata/start_api/lambda_authorizers/app.py:140:1:</a> E302 [*] Expected 2 blank lines, found 1
+ <a href='https://github.com/aws/aws-sam-cli/blob/06502930837677227f7975c93402039821d1f0ea/tests/integration/testdata/start_api/lambda_authorizers/app.py#L14'>tests/integration/testdata/start_api/lambda_authorizers/app.py:14:1:</a> I001 [*] Import block is un-sorted or un-formatted
+ <a href='https://github.com/aws/aws-sam-cli/blob/06502930837677227f7975c93402039821d1f0ea/tests/integration/testdata/start_api/lambda_authorizers/app.py#L159'>tests/integration/testdata/start_api/lambda_authorizers/app.py:159:5:</a> E303 [*] Too many blank lines (2)
+ <a href='https://github.com/aws/aws-sam-cli/blob/06502930837677227f7975c93402039821d1f0ea/tests/integration/testdata/start_api/lambda_authorizers/app.py#L17'>tests/integration/testdata/start_api/lambda_authorizers/app.py:17:1:</a> E302 [*] Expected 2 blank lines, found 1
+ <a href='https://github.com/aws/aws-sam-cli/blob/06502930837677227f7975c93402039821d1f0ea/tests/integration/testdata/start_api/lambda_authorizers/app.py#L203'>tests/integration/testdata/start_api/lambda_authorizers/app.py:203:30:</a> E203 [*] Whitespace before ':'
+ <a href='https://github.com/aws/aws-sam-cli/blob/06502930837677227f7975c93402039821d1f0ea/tests/integration/testdata/start_api/lambda_authorizers/app.py#L204'>tests/integration/testdata/start_api/lambda_authorizers/app.py:204:29:</a> E203 [*] Whitespace before ':'
+ <a href='https://github.com/aws/aws-sam-cli/blob/06502930837677227f7975c93402039821d1f0ea/tests/integration/testdata/start_api/lambda_authorizers/app.py#L208'>tests/integration/testdata/start_api/lambda_authorizers/app.py:208:30:</a> E203 [*] Whitespace before ':'
+ <a href='https://github.com/aws/aws-sam-cli/blob/06502930837677227f7975c93402039821d1f0ea/tests/integration/testdata/start_api/lambda_authorizers/app.py#L209'>tests/integration/testdata/start_api/lambda_authorizers/app.py:209:29:</a> E203 [*] Whitespace before ':'
+ <a href='https://github.com/aws/aws-sam-cli/blob/06502930837677227f7975c93402039821d1f0ea/tests/integration/testdata/start_api/lambda_authorizers/app.py#L212'>tests/integration/testdata/start_api/lambda_authorizers/app.py:212:9:</a> PLR6301 Method `_getEmptyStatement` could be a function, class method, or static method
+ <a href='https://github.com/aws/aws-sam-cli/blob/06502930837677227f7975c93402039821d1f0ea/tests/integration/testdata/start_api/lambda_authorizers/app.py#L284'>tests/integration/testdata/start_api/lambda_authorizers/app.py:284:26:</a> E203 [*] Whitespace before ':'
+ <a href='https://github.com/aws/aws-sam-cli/blob/06502930837677227f7975c93402039821d1f0ea/tests/integration/testdata/start_api/lambda_authorizers/app.py#L285'>tests/integration/testdata/start_api/lambda_authorizers/app.py:285:29:</a> E203 [*] Whitespace before ':'
+ <a href='https://github.com/aws/aws-sam-cli/blob/06502930837677227f7975c93402039821d1f0ea/tests/integration/testdata/start_api/lambda_authorizers/app.py#L286'>tests/integration/testdata/start_api/lambda_authorizers/app.py:286:26:</a> E203 [*] Whitespace before ':'
... 8 additional changes omitted for rule E203
+ <a href='https://github.com/aws/aws-sam-cli/blob/06502930837677227f7975c93402039821d1f0ea/tests/integration/testdata/start_api/lambda_authorizers/app.py#L34'>tests/integration/testdata/start_api/lambda_authorizers/app.py:34:1:</a> E302 [*] Expected 2 blank lines, found 1
+ <a href='https://github.com/aws/aws-sam-cli/blob/06502930837677227f7975c93402039821d1f0ea/tests/integration/testdata/start_api/lambda_authorizers/app.py#L44'>tests/integration/testdata/start_api/lambda_authorizers/app.py:44:1:</a> E302 [*] Expected 2 blank lines, found 1
+ <a href='https://github.com/aws/aws-sam-cli/blob/06502930837677227f7975c93402039821d1f0ea/tests/integration/testdata/start_api/lambda_authorizers/app.py#L47'>tests/integration/testdata/start_api/lambda_authorizers/app.py:47:1:</a> E302 [*] Expected 2 blank lines, found 1
+ <a href='https://github.com/aws/aws-sam-cli/blob/06502930837677227f7975c93402039821d1f0ea/tests/integration/testdata/start_api/lambda_authorizers/app.py#L59'>tests/integration/testdata/start_api/lambda_authorizers/app.py:59:1:</a> E302 [*] Expected 2 blank lines, found 1
+ <a href='https://github.com/aws/aws-sam-cli/blob/06502930837677227f7975c93402039821d1f0ea/tests/integration/testdata/start_api/lambda_authorizers/app.py#L68'>tests/integration/testdata/start_api/lambda_authorizers/app.py:68:1:</a> E302 [*] Expected 2 blank lines, found 1
</pre>

</p>
</details>
<details><summary>Changes by rule (6 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| E203 | 16 | 16 | 0 | 0 | 0 |
| E221 | 7 | 7 | 0 | 0 | 0 |
| E302 | 7 | 7 | 0 | 0 | 0 |
| I001 | 1 | 1 | 0 | 0 | 0 |
| E303 | 1 | 1 | 0 | 0 | 0 |
| PLR6301 | 1 | 1 | 0 | 0 | 0 |</p>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @hoel-bagard on 2024-02-09 09:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-09 12:44</div>
            <div class="timeline-body"><p>Thanks for looking into the panic. I'm reluctant to just remove the assertion without better understanding the reason why it is incorrect (I added it to guarantee it's only called on two directly following lines). Would you mind adding an example explaining why the two ranges don't end and start at the same position to the PR summary?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2024-02-09 12:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hoel-bagard">@hoel-bagard</a> on 2024-02-09 13:45</div>
            <div class="timeline-body"><p>@MichaReiser  This happens because of the whitespaces, I added an explanation to the PR summary.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-02-09 14:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2024-02-09 14:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-02-09 14:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-09 14:00</div>
            <div class="timeline-body"><p>Thanks for the explanation. That makes sense</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 22:58:17 UTC
    </footer>
</body>
</html>
