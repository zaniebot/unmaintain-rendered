```yaml
number: 4641
title: "Add `Comments` data structure"
type: pull_request
state: merged
author: MichaReiser
labels:
  - internal
  - formatter
assignees: []
merged: true
base: main
head: add-comments-data-structure
created_at: 2023-05-24T16:40:13Z
updated_at: 2023-05-31T09:40:54Z
url: https://github.com/astral-sh/ruff/pull/4641
synced_at: 2026-01-12T03:50:03Z
```

# Add `Comments` data structure

---

_Pull request opened by @MichaReiser on 2023-05-24 16:40_

## Summary

This PR introduces the new `Comments` data structure. It is the main API for formatters to retrieve the *leading*, *dangling*, and *trailing* comments for a node. I'll add a `Comments` field to the `ASTFormatContext` in a follow-up PR. 

The `Comments` data structure uses the `MultiMap` implementation introduced in #4639 to store the comments internally. It uses a `NodeRefEqualityKey` as the key into the multi-map because the RustPython AST nodes do not implement Hash (and we want a cheap hash function). This should work fine because the formatter doesn't mutate the tree and operates only on nodes passed in as references. 

This PR does not yet implement the logic to extract comments. 

## Test Plan

There's a basic test that verifies the debug representation. The next PR adds more tests using the API.


---

_Comment by @MichaReiser on 2023-05-24 16:40_

Current dependencies on/for this PR:
* main
  * **PR #4639** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4639" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #4641** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4641" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
      * **PR #4642** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4642" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #4671** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4671" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #4748** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4748" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
            * **PR #4751** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4751" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/charliermarsh/ruff/4641?utm_source=stack-comment).

---

_Label `autoformatter` added by @MichaReiser on 2023-05-24 16:42_

---

_Comment by @github-actions[bot] on 2023-05-24 17:31_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     14.9Â±0.03ms     2.7 MB/sec    1.01     15.1Â±0.13ms     2.7 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.7Â±0.01ms     4.5 MB/sec    1.00      3.7Â±0.01ms     4.5 MB/sec
linter/all-rules/numpy/globals.py          1.00    378.1Â±0.86Âµs     7.8 MB/sec    1.00    377.3Â±0.91Âµs     7.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.3Â±0.02ms     4.0 MB/sec    1.00      6.3Â±0.02ms     4.0 MB/sec
linter/default-rules/large/dataset.py      1.00      7.5Â±0.01ms     5.4 MB/sec    1.00      7.5Â±0.01ms     5.4 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1595.9Â±5.58Âµs    10.4 MB/sec    1.00   1598.5Â±3.85Âµs    10.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    176.0Â±0.50Âµs    16.8 MB/sec    1.00    176.1Â±0.54Âµs    16.8 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.4Â±0.01ms     7.5 MB/sec    1.13      3.8Â±0.82ms     6.7 MB/sec
parser/large/dataset.py                    1.01      5.8Â±0.01ms     7.0 MB/sec    1.00      5.7Â±0.00ms     7.1 MB/sec
parser/numpy/ctypeslib.py                  1.00   1133.6Â±1.31Âµs    14.7 MB/sec    1.00   1132.8Â±1.06Âµs    14.7 MB/sec
parser/numpy/globals.py                    1.00    115.6Â±0.27Âµs    25.5 MB/sec    1.00    115.7Â±0.29Âµs    25.5 MB/sec
parser/pydantic/types.py                   1.00      2.5Â±0.00ms    10.3 MB/sec    1.00      2.5Â±0.00ms    10.3 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     17.4Â±0.30ms     2.3 MB/sec    1.01     17.5Â±0.23ms     2.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.3Â±0.05ms     3.9 MB/sec    1.01      4.3Â±0.07ms     3.8 MB/sec
linter/all-rules/numpy/globals.py          1.00    506.0Â±6.73Âµs     5.8 MB/sec    1.00    506.2Â±9.45Âµs     5.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.2Â±0.10ms     3.5 MB/sec    1.02      7.3Â±0.14ms     3.5 MB/sec
linter/default-rules/large/dataset.py      1.00      8.3Â±0.11ms     4.9 MB/sec    1.06      8.8Â±0.08ms     4.6 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1769.3Â±36.10Âµs     9.4 MB/sec    1.05  1856.2Â±21.32Âµs     9.0 MB/sec
linter/default-rules/numpy/globals.py      1.00    204.1Â±4.04Âµs    14.5 MB/sec    1.04    211.8Â±5.54Âµs    13.9 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.8Â±0.04ms     6.8 MB/sec    1.05      3.9Â±0.04ms     6.5 MB/sec
parser/large/dataset.py                    1.00      6.3Â±0.04ms     6.4 MB/sec    1.01      6.4Â±0.05ms     6.4 MB/sec
parser/numpy/ctypeslib.py                  1.00  1195.4Â±16.03Âµs    13.9 MB/sec    1.00  1199.6Â±14.80Âµs    13.9 MB/sec
parser/numpy/globals.py                    1.00    121.0Â±2.60Âµs    24.4 MB/sec    1.01    121.7Â±2.77Âµs    24.2 MB/sec
parser/pydantic/types.py                   1.00      2.7Â±0.03ms     9.5 MB/sec    1.01      2.7Â±0.05ms     9.4 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Label `internal` added by @MichaReiser on 2023-05-26 08:14_

---

_Marked ready for review by @MichaReiser on 2023-05-26 08:23_

---

_Review comment by @Boshen on `crates/ruff_python_formatter/src/comments/mod.rs`:29 on 2023-05-26 11:35_

Why are you so lucky this time T.T

---

_@Boshen reviewed on 2023-05-26 11:35_

---

_@Boshen reviewed on 2023-05-26 11:39_

---

_Review comment by @Boshen on `crates/ruff_python_formatter/src/comments/mod.rs`:71 on 2023-05-26 11:39_

Given you don't have inline comments, I think it makes sense to have dedicated AST nodes for comments, but I guess it's too late now :-(

---

_@Boshen reviewed on 2023-05-26 11:44_

---

_Review comment by @Boshen on `crates/ruff_python_formatter/src/comments/mod.rs`:84 on 2023-05-26 11:44_

rustc wraps some of the operators with a span (and I'm considering this as well). But again, it's too late to add this.

https://doc.rust-lang.org/beta/nightly-rustc/rustc_ast/ast/type.BinOp.html

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/comments/mod.rs`:71 on 2023-05-26 11:50_

It's never too late ;) I'm prototyping a Python parser when I have time. But we need to make progress in the meantime. 

A similar structure would probably still be necessary because the "default" placement of the parser is not necessarily what user expect.

---

_@MichaReiser reviewed on 2023-05-26 11:50_

---

_@Boshen reviewed on 2023-05-26 11:50_

---

_Review comment by @Boshen on `crates/ruff_python_formatter/src/comments/mod.rs`:88 on 2023-05-26 11:50_

In rustfmt, there's a bunch of hacks for these kinds of comments. (I haven't looked at the details).

https://github.com/rust-lang/rustfmt/blob/master/Contributing.md#a-quick-tour-of-rustfmt

https://github.com/rust-lang/rustfmt/blob/master/src/missed_spans.rs

> Our primary tool here is to look between spans for text we've missed. For example, in a function call foo(a, b), we have spans for a and b, in this case, there is only a comma and a single space between the end of a and the start of b, so there is nothing much to do. But if we look at foo(a /* a comment */, b), then between a and b we find the comment.

> At a higher level, Rustfmt has machinery so that we account for text between 'top level' items. Then we can reproduce that text pretty much verbatim. We only count spans we actually reformat, so if we can't format a span it is not missed completely but is reproduced in the output without being formatted. This is mostly handled in [src/missed_spans.rs](https://github.com/rust-lang/rustfmt/blob/master/src/missed_spans.rs). See also FmtVisitor::last_pos in [src/visitor.rs](https://github.com/rust-lang/rustfmt/blob/master/src/visitor.rs).

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/comments/mod.rs`:84 on 2023-05-26 11:50_

That's interesting. That could be useful for my local python parser :) 

---

_@MichaReiser reviewed on 2023-05-26 11:50_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/comments/mod.rs`:29 on 2023-05-26 11:51_

haha.. I'm waiting for the moment where we start formatting other languages and I'll be back in the game 

---

_@MichaReiser reviewed on 2023-05-26 11:51_

---

_@Boshen reviewed on 2023-05-26 11:55_

---

_Review comment by @Boshen on `crates/ruff_python_formatter/src/comments/node_key.rs`:11 on 2023-05-26 11:55_

Probably need to document where this is used for, I got lost at this point :-)

Is this just a pointer?

---

_@MichaReiser reviewed on 2023-05-26 12:01_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/comments/node_key.rs`:11 on 2023-05-26 12:01_

It's used as keys into the `Comments` struct because `AnyNodeRef` does not implement `Hash` (and we want hashing to be cheap.)

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/comments/mod.rs`:14 on 2023-05-26 18:26_

In addition to placement, we also have "own-line" vs. "end-of-line" comments:

```python
def f():  # end-of-line
  # own-line
  pass
```

(Is that the correct terminology? Where and how is that behavior defined or handled?)

---

_@charliermarsh approved on 2023-05-26 18:26_

---

_@MichaReiser reviewed on 2023-05-26 18:27_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/comments/mod.rs`:14 on 2023-05-26 18:27_

Always thinking ahead. This is in the next PR

---

_@charliermarsh reviewed on 2023-05-26 18:30_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/comments/mod.rs`:14 on 2023-05-26 18:30_

Hah, yes, sorry, just came back here to comment that :)

---

_Merged by @MichaReiser on 2023-05-30 08:54_

---

_Closed by @MichaReiser on 2023-05-30 08:54_

---

_Branch deleted on 2023-05-30 08:54_

---
