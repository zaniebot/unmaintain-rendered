```yaml
number: 5601
title: "Check for `Any` in other types for `ANN401`"
type: pull_request
state: merged
author: dhruvmanila
labels:
  - rule
assignees: []
merged: true
base: main
head: dhruv/typing-target-contains-any
created_at: 2023-07-07T20:38:51Z
updated_at: 2023-07-13T12:49:28Z
url: https://github.com/astral-sh/ruff/pull/5601
synced_at: 2026-01-12T15:55:18Z
```

# Check for `Any` in other types for `ANN401`

---

_@dhruvmanila_

## Summary

Check for `Any` in other types for `ANN401`. This reuses the logic from `implicit-optional` rule to resolve the type to `Any`.

Following types are supported:
* `Union[Any, ...]`
* `Any | ...`
* `Optional[Any]`
* `Annotated[<any of the above variant>, ...]`
* Forward references i.e., `"Any | ..."`

## Test Plan

Added test cases for various combinations.

fixes: #5458


---

_Comment by @dhruvmanila on 2023-07-07 20:39_

Current dependencies on/for this PR:
* main
  * **PR #5601** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5601" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #5717** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5717" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/5601?utm_source=stack-comment).

---

_Comment by @github-actions[bot] on 2023-07-07 21:13_

## PR Check Results
### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.03      8.6Â±0.05ms     4.7 MB/sec    1.00      8.4Â±0.03ms     4.9 MB/sec
formatter/numpy/ctypeslib.py               1.03   1940.9Â±3.08Âµs     8.6 MB/sec    1.00   1893.5Â±4.20Âµs     8.8 MB/sec
formatter/numpy/globals.py                 1.01    206.8Â±1.06Âµs    14.3 MB/sec    1.00    204.3Â±0.33Âµs    14.4 MB/sec
formatter/pydantic/types.py                1.04      4.3Â±0.01ms     5.9 MB/sec    1.00      4.2Â±0.01ms     6.1 MB/sec
linter/all-rules/large/dataset.py          1.00     14.1Â±0.11ms     2.9 MB/sec    1.01     14.3Â±0.11ms     2.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.5Â±0.02ms     4.7 MB/sec    1.00      3.6Â±0.01ms     4.7 MB/sec
linter/all-rules/numpy/globals.py          1.00    364.3Â±1.25Âµs     8.1 MB/sec    1.01    369.0Â±2.21Âµs     8.0 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.3Â±0.03ms     4.1 MB/sec    1.02      6.4Â±0.05ms     4.0 MB/sec
linter/default-rules/large/dataset.py      1.00      7.1Â±0.03ms     5.7 MB/sec    1.01      7.2Â±0.03ms     5.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1466.1Â±5.45Âµs    11.4 MB/sec    1.02   1500.1Â±5.44Âµs    11.1 MB/sec
linter/default-rules/numpy/globals.py      1.00    155.1Â±0.25Âµs    19.0 MB/sec    1.03    159.9Â±0.90Âµs    18.5 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.2Â±0.01ms     8.0 MB/sec    1.02      3.2Â±0.01ms     7.9 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.03     12.7Â±0.41ms     3.2 MB/sec    1.00     12.4Â±0.29ms     3.3 MB/sec
formatter/numpy/ctypeslib.py               1.05      2.9Â±0.34ms     5.7 MB/sec    1.00      2.8Â±0.07ms     6.0 MB/sec
formatter/numpy/globals.py                 1.00   320.1Â±12.87Âµs     9.2 MB/sec    1.00   320.1Â±15.93Âµs     9.2 MB/sec
formatter/pydantic/types.py                1.00      6.1Â±0.20ms     4.2 MB/sec    1.00      6.1Â±0.20ms     4.2 MB/sec
linter/all-rules/large/dataset.py          1.02     21.4Â±0.54ms  1949.2 KB/sec    1.00     21.0Â±0.57ms  1981.4 KB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      5.5Â±0.19ms     3.0 MB/sec    1.00      5.4Â±0.20ms     3.1 MB/sec
linter/all-rules/numpy/globals.py          1.00   652.1Â±23.18Âµs     4.5 MB/sec    1.04   679.3Â±53.73Âµs     4.3 MB/sec
linter/all-rules/pydantic/types.py         1.00      9.5Â±0.35ms     2.7 MB/sec    1.00      9.5Â±0.25ms     2.7 MB/sec
linter/default-rules/large/dataset.py      1.02     10.9Â±0.36ms     3.7 MB/sec    1.00     10.6Â±0.18ms     3.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.02      2.2Â±0.09ms     7.4 MB/sec    1.00      2.2Â±0.06ms     7.5 MB/sec
linter/default-rules/numpy/globals.py      1.00    271.3Â±7.94Âµs    10.9 MB/sec    1.00   270.0Â±11.35Âµs    10.9 MB/sec
linter/default-rules/pydantic/types.py     1.01      4.8Â±0.18ms     5.3 MB/sec    1.00      4.8Â±0.15ms     5.3 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Marked ready for review by @dhruvmanila on 2023-07-08 05:37_

---

_Review comment by @dhruvmanila on `crates/ruff/src/rules/flake8_annotations/rules/definition.rs`:438 on 2023-07-08 05:38_

I've moved the `is_overriden` check outside the function as it seems common. This avoids having many arguments to a function.

---

_@dhruvmanila reviewed on 2023-07-08 05:38_

---

_@dhruvmanila reviewed on 2023-07-08 05:39_

---

_Review comment by @dhruvmanila on `crates/ruff/src/rules/ruff/mod.rs`:4 on 2023-07-08 05:39_

Is this the correct place to keep the common functionality? We could move this to `ruff_python_ast` crate which would add dependencies to other crates mainly `ruff_python_semantic`.

---

_@dhruvmanila reviewed on 2023-07-08 05:44_

---

_Review comment by @dhruvmanila on `crates/ruff/src/rules/ruff/typing.rs`:84 on 2023-07-08 05:44_

Here's the difference between `None` and `Some(TypingTarget::Unknown)`:

| `None` | `Some(TypingTarget::Unknown)` |
|--------|--------|
| Known type but not a `TypingTarget` | Unknown type and not a `TypingTarget` |
| When `ExprSubscript.slice` is not a `ExprTuple` | Parsing fails for forward references |
| **Flag violation** | **Do NOT flag violation** |

My thought is to just remove the `None` variant. This means in failure we would _not_ flag violation (currently we would). Any thoughts? \cc @charliermarsh 

---

_Comment by @dhruvmanila on 2023-07-10 05:38_

(forced push to check ecosystem result via links :))

---

_Review requested from @charliermarsh by @dhruvmanila on 2023-07-10 05:38_

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/ruff/typing.rs`:291 on 2023-07-12 03:57_

Just a stylistic thing, but consider doing this match on `Some` in the `match target` below? Like:

```rust
match TypingTarget::try_from_expr(annotation, semantic, locator, minor_version) {
  None => false,
  Some(TypingTarget::Any) => true,
  ...
}
```

But not blocking, up to your discretion of course.

---

_@charliermarsh reviewed on 2023-07-12 03:57_

---

_@charliermarsh reviewed on 2023-07-12 04:07_

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/ruff/typing.rs`:84 on 2023-07-12 04:07_

Could we replace `None` with `Known`, and use `Result` to return an error when "Parsing fails for forward references" and "When `ExprSubscript.slice` is not a `ExprTuple`"? Even if we can't use `Result`, I think it makes sense to encode "Known type but not a `TypingTarget`" as its own variant. It's confusing that it's represented by `None`.

---

_@charliermarsh reviewed on 2023-07-12 04:17_

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/ruff/mod.rs`:4 on 2023-07-12 04:17_

It's probably okay for now, but you may be able to make it `pub(super)`.

---

_@charliermarsh approved on 2023-07-12 04:17_

---

_@dhruvmanila reviewed on 2023-07-12 17:16_

---

_Review comment by @dhruvmanila on `crates/ruff/src/rules/ruff/typing.rs`:291 on 2023-07-12 17:16_

I like this, updated at other relevant places as well. Thanks!

---

_@dhruvmanila reviewed on 2023-07-12 17:16_

---

_Review comment by @dhruvmanila on `crates/ruff/src/rules/ruff/typing.rs`:84 on 2023-07-12 17:16_

> Even if we can't use `Result`, I think it makes sense to encode "Known type but not a `TypingTarget`" as its own variant. It's confusing that it's represented by `None`.

This makes sense. Thanks!

I'm going with `Option<...>` and not flagging any violation in case of `None`.

---

_Comment by @dhruvmanila on 2023-07-12 17:43_

## Updates since last review

1. Explicit `Known` type for known types and not `TypingTarget`
2. Refactor to use `match` expressions wherever possible
3. Fix a bug where single element like `Union[None]` would give false positive for implicit optionals **(done in the child PR)**

The (3) was due to the fact that `None` represented the "When `ExprSubscript.slice` is not a `ExprTuple`" case but the slice could be other types as well such as `ExprConstant` or `ExprName` in `Union[None]` and `Union[int]` respectively.

---

_Review requested from @charliermarsh by @dhruvmanila on 2023-07-12 17:43_

---

_@dhruvmanila reviewed on 2023-07-12 18:20_

---

_Review comment by @dhruvmanila on `crates/ruff/src/rules/ruff/snapshots/ruff__rules__ruff__tests__RUF013_RUF013_0.py.snap`:44 on 2023-07-12 18:20_

This is intentional in this PR and is fixed in the child PR.

---

_Review request for @charliermarsh removed by @dhruvmanila on 2023-07-12 18:34_

---

_Comment by @charliermarsh on 2023-07-12 20:47_

Still LGTM.

---

_Closed by @dhruvmanila on 2023-07-13 05:41_

---

_Reopened by @dhruvmanila on 2023-07-13 05:41_

---

_Comment by @dhruvmanila on 2023-07-13 05:41_

(Re-opening the PR to trigger CI, don't know why it went into "waiting...")

---

_Label `rule` added by @dhruvmanila on 2023-07-13 05:42_

---

_Comment by @dhruvmanila on 2023-07-13 05:58_

FYI, the PR stack is in reverse order which is the reason for `pre-commit` failure. Re-ordering involved resolving a bunch of merge conflicts and so I decided not to do it. I didn't realize the bug until quite later. Sorry for any failure notification ðŸ˜…

---

_Merged by @dhruvmanila on 2023-07-13 12:49_

---

_Closed by @dhruvmanila on 2023-07-13 12:49_

---

_Branch deleted on 2023-07-13 12:49_

---
