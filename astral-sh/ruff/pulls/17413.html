<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Acknowledge that `T &amp; anything` is assignable to `T` - astral-sh/ruff #17413</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Acknowledge that <code>T &amp; anything</code> is assignable to <code>T</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17413">#17413</a>
        opened by <a href="https://github.com/dcreager">@dcreager</a>
        on 2025-04-15 19:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a></div>
            <div class="timeline-body"><p>This reworks the assignability/subtyping relations a bit to handle typevars better:</p>
<ol>
<li><p>For the most part, types are not assignable to typevars, since there&#x27;s no guarantee what type the typevar will be specialized to.</p>
</li>
<li><p>An intersection is an exception, if it contains the typevar itself as one of the positive elements. This should fall out from the other clauses automatically, since a typevar is assignable to itself, and an intersection is assignable to something if any positive element is assignable to that something.</p>
</li>
<li><p>Constrained typevars are an exception, since they must be specialized to <em>exactly</em> one of the constraints, not to a <em>subtype</em> of a constraint. If a type is assignable to every constraint, then the type is also assignable to the constrained typevar.</p>
</li>
</ol>
<p>We already had a special case for (3), but the ordering of it relative to the intersection clauses meant we weren&#x27;t catching (2) correctly.  To fix this, we keep the special case for (3), but fall through to the other match arms for non-constrained typevars and if the special case isn&#x27;t true for a constrained typevar.</p>
<p>Closes <a href="https://github.com/astral-sh/ruff/issues/17364">astral-sh/ruff#17364</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/dcreager">@dcreager</a> on 2025-04-15 19:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/dcreager">@dcreager</a> on 2025-04-15 19:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/dcreager">@dcreager</a> on 2025-04-15 19:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/dcreager">@dcreager</a> on 2025-04-15 19:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-15 19:29</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:895 on 2025-04-15 19:31</div>
            <div class="timeline-body"><p>This comment is true, but I have a hard time understanding how it&#x27;s relevant to the code below. Would we write this arm any differently if constraints had to be disjoint? It would still be the case that the lhs type must be a subtype of <em>all</em> constraints (separately; not just the union of them) in order to be a subtype of the constrained typevar, which seems like the more important point to make here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1193 on 2025-04-15 19:32</div>
            <div class="timeline-body"><p>Same question as above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-04-15 19:32</div>
            <div class="timeline-body"><p>Excellent, thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-04-15 19:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:895 on 2025-04-15 19:57</div>
            <div class="timeline-body"><p>My thinking was that the possibility of non-disjoint constraints is the only reason that this arm is needed. If the constraints are disjoint, I don&#x27;t think there&#x27;s any lhs that could be a subtype of all of them, is there?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-04-15 20:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:895 on 2025-04-15 20:28</div>
            <div class="timeline-body"><p>Oh! Yes, that totally makes sense :) Disregard this comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dcreager">@dcreager</a> on 2025-04-15 20:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dcreager">@dcreager</a> on 2025-04-15 20:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-15 20:34</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:13:21 UTC
    </footer>
</body>
</html>
