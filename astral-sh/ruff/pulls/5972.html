<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Format numeric constants - astral-sh/ruff #5972</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Format numeric constants</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5972">#5972</a>
        opened by <a href="https://github.com/lkh42t">@lkh42t</a>
        on 2023-07-22 09:44
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/lkh42t">@lkh42t</a></div>
            <div class="timeline-body">Summary
<p>Format int, float and complex constants.</p>
Test Plan
<p>Existing snapshots.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-07-22 10:12</div>
            <div class="timeline-body">PR Check Results
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.04      9.7±0.14ms     4.2 MB/sec    1.00      9.3±0.10ms     4.4 MB/sec
formatter/numpy/ctypeslib.py               1.04  1927.2±30.10µs     8.6 MB/sec    1.00   1854.3±4.19µs     9.0 MB/sec
formatter/numpy/globals.py                 1.05    213.5±0.56µs    13.8 MB/sec    1.00    203.0±0.59µs    14.5 MB/sec
formatter/pydantic/types.py                1.03      4.1±0.01ms     6.2 MB/sec    1.00      4.0±0.02ms     6.4 MB/sec
linter/all-rules/large/dataset.py          1.00     13.2±0.23ms     3.1 MB/sec    1.00     13.2±0.18ms     3.1 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.3±0.04ms     5.0 MB/sec    1.00      3.3±0.04ms     5.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    430.9±1.10µs     6.8 MB/sec    1.00    429.2±0.55µs     6.9 MB/sec
linter/all-rules/pydantic/types.py         1.01      5.9±0.10ms     4.3 MB/sec    1.00      5.9±0.07ms     4.3 MB/sec
linter/default-rules/large/dataset.py      1.00      6.6±0.05ms     6.2 MB/sec    1.00      6.6±0.06ms     6.2 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01   1411.3±2.00µs    11.8 MB/sec    1.00   1399.0±3.99µs    11.9 MB/sec
linter/default-rules/numpy/globals.py      1.02    157.9±1.19µs    18.7 MB/sec    1.00    155.0±0.87µs    19.0 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.0±0.01ms     8.6 MB/sec    1.01      3.0±0.07ms     8.5 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.07     14.4±0.83ms     2.8 MB/sec    1.00     13.4±0.67ms     3.0 MB/sec
formatter/numpy/ctypeslib.py               1.03      2.8±0.20ms     5.9 MB/sec    1.00      2.7±0.21ms     6.1 MB/sec
formatter/numpy/globals.py                 1.07   316.7±29.17µs     9.3 MB/sec    1.00   295.9±26.09µs    10.0 MB/sec
formatter/pydantic/types.py                1.02      5.8±0.27ms     4.4 MB/sec    1.00      5.7±0.29ms     4.5 MB/sec
linter/all-rules/large/dataset.py          1.01     19.3±0.90ms     2.1 MB/sec    1.00     19.1±1.17ms     2.1 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.7±0.30ms     3.6 MB/sec    1.09      5.1±0.24ms     3.3 MB/sec
linter/all-rules/numpy/globals.py          1.00   593.9±46.89µs     5.0 MB/sec    1.03   610.7±32.02µs     4.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      9.0±0.55ms     2.8 MB/sec    1.03      9.2±0.54ms     2.8 MB/sec
linter/default-rules/large/dataset.py      1.03     10.2±0.54ms     4.0 MB/sec    1.00      9.9±0.49ms     4.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.03      2.1±0.10ms     7.9 MB/sec    1.00      2.0±0.15ms     8.2 MB/sec
linter/default-rules/numpy/globals.py      1.07   246.7±18.02µs    12.0 MB/sec    1.00   230.5±14.44µs    12.8 MB/sec
linter/default-rules/pydantic/types.py     1.02      4.5±0.20ms     5.7 MB/sec    1.00      4.4±0.20ms     5.9 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/number.rs</code>:24 on 2023-07-22 10:32</div>
            <div class="timeline-body"><p>We should pass <code>range.start()</code> as the second argument to all <code>dynamic_text</code> usages. The position is used in the generated source map and we&#x27;ll use the source map for range formatting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-07-22 10:32</div>
            <div class="timeline-body"><p>Oh wow nice! Excellent work.</p>
<p>What I understand from the code is that the formatted now uses <code>dynamic_text</code> for every number constant even if it is already correctly formatted. This is, unfortunately, somewhat expensive because every <code>dynamic_text</code>  allocates a <code>String</code> when writing the text.</p>
<p>Would you be interested in taking a stab at implementing an optimisation similar to what we did in <code>normalize_string</code></p>
<p>https://github.com/astral-sh/ruff/blob/33657d3a1ccc5ccfefa26f50758ba46b74946da0/crates/ruff_python_formatter/src/expression/string.rs#L413-L481</p>
<p>The trick is to use a <code>Cow</code> and return <code>Cow::Borrowed</code> if the number is already correctly formatted (in which case we can print the code from the source using <code>source_text_slice</code> (extremely fast). The implementation returns a <code>Cow::Owned</code> if it reformatted the number and it then uses <code>dynamic_text</code>.</p>
<p>The benefit of this optimisation is that we only pay the cost of allocating when formatting the file for the first time. Checking the formatting in subsequent passes (when there are no changes) takes the fast path instead.</p>
<p>Let me know if that&#x27;s something you&#x27;re interested in and if so, if you want to tackle this as part of this PR or want to do a follow up instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lkh42t">@lkh42t</a> on 2023-07-22 11:01</div>
            <div class="timeline-body"><p>I&#x27;ll implement optimization like <code>normalize_string</code>. Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2023-07-22 11:50</div>
            <div class="timeline-body"><p>Alright. I&#x27;ll assign this back to you. Feel free to ping me if you have any questions and request another review once your done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/lkh42t">@lkh42t</a> on 2023-07-22 12:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/number.rs</code>:158 on 2023-07-23 09:57</div>
            <div class="timeline-body"><p>i think you can simplify this to <code>input.as_bytes().get(index - 1).copied() == Some(b&#x27;.&#x27;)</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/tests/snapshots/black_compatibility@simple_cases__attribute_access_on_number_literals.py.snap</code>:46 on 2023-07-23 10:00</div>
            <div class="timeline-body"><p>now that we have no more trailing dots in floats we can also fix the parentheses rules for them (maybe better in a follow-up PR so that the scope of this PR doesn&#x27;t get too large)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-07-23 10:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/konstin">@konstin</a> on 2023-07-23 13:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/number.rs</code>:157 on 2023-07-24 06:39</div>
            <div class="timeline-body"><p>I believe this could, at least in theory, result in indexing between two character boundaries if the text starts with <code>[e10]</code>. I don&#x27;t think this is a problem in practice because it&#x27;s impossible that the preceding character is a unicode character, because the number would then be part of an identifier. I still recommend fixing this just to be sure (e.g. by assigning `is_float on line 147)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-07-24 06:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-24 07:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-24 07:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-07-29 05:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:55:36 UTC
    </footer>
</body>
</html>
