<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Offer &quot;Did you mean...?&quot; suggestions for unresolved `from` imports and unresolved attributes - astral-sh/ruff #18705</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Offer &quot;Did you mean...?&quot; suggestions for unresolved <code>from</code> imports and unresolved attributes</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18705">#18705</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-06-16 12:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR (a collaboration with @ntBre) adds &quot;Did you mean...?&quot; suggestions for unresolved <code>from</code> imports and unresolved attributes. For example:</p>
<p><img src="https://github.com/user-attachments/assets/328a575b-f83b-46c2-ab11-4e8c9f6de8eb" alt="image" /></p>
<p>The implementation uses the <a href="https://en.wikipedia.org/wiki/Levenshtein_distance">Levenshtein distance</a> algorithm to calculate which possible member of the type is a closest match to the unresolved member that triggered the diagnostic. This specific Levenshtein implementation is an almost exact 1:1 port of CPython's implementation <a href="https://github.com/python/cpython/blob/b102f091feebe8597d14ac69b9fd982a4cda6c8d/Lib/traceback.py#L1578-L1743">here</a>, and many of the tests in this PR are also ported from CPython's tests. You can see CPython's Levenshtein implementation in action if you access a nonexistent attribute or import in the REPL:</p>
<pre><code class="language-pycon">Python 3.13.1 (main, Jan  3 2025, 12:04:03) [Clang 15.0.0 (clang-1500.3.9.4)] on darwin
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; import collections
&gt;&gt;&gt; collections.dequee
Traceback (most recent call last):
  File &quot;&lt;python-input-1&gt;&quot;, line 1, in &lt;module&gt;
    collections.dequee
AttributeError: module 'collections' has no attribute 'dequee'. Did you mean: 'deque'?
&gt;&gt;&gt; from asyncio import gett_event_lop
Traceback (most recent call last):
  File &quot;&lt;python-input-2&gt;&quot;, line 1, in &lt;module&gt;
    from asyncio import gett_event_lop
ImportError: cannot import name 'gett_event_lop' from 'asyncio' (/Users/alexw/.pyenv/versions/3.13.1/lib/python3.13/asyncio/__init__.py). Did you mean: 'get_event_loop'?
&gt;&gt;&gt; 
</code></pre>
<p>Our motivation for copying CPython's implementation almost exactly is that CPython has had this feature for several Python versions now, and during that time many bug reports have been filed regarding incorrect suggestions, which have since been fixed. This implementation is thus very well &quot;battle-tested&quot; by this point; we can say with a reasonable degree of confidence that it gives good suggestions for unresolved members in the Python context.</p>
<h2>Test Plan</h2>
<ul>
<li>Unit tests in <code>levenshtein.rs</code></li>
<li>Mdtest integration tests</li>
</ul>
<hr />
<p>Co-authored-by: Brent Westbrook <a href="mailto:brentrwestbrook@gmail.com">brentrwestbrook@gmail.com</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-06-16 12:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-06-16 12:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @AlexWaygood on 2025-06-16 12:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-06-16 12:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by @AlexWaygood on 2025-06-16 12:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-16 12:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/all_members.rs</code>:1 on 2025-06-16 12:23</div>
            <div class="timeline-body"><p>This module has been renamed from <code>ide_support</code> to <code>all_members</code> because it's no longer just used for autocompletions; it's now also used for diagnostic suggestions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2025-06-16 12:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-16 12:30</div>
            <div class="timeline-body"><p>Mypy_primer is failing because this <code>.unwrap()</code> call is panicking when checking <code>sympy</code>:</p>
<p>https://github.com/astral-sh/ruff/blob/869d7bf9a8c037a51e5ac319ee2286987bc54d76/crates/ty_python_semantic/src/types/ide_support.rs#L189</p>
<p>Which seems like it is probably a pre-existing bug exposed by this PR (but we obviously won't be able to land this PR without fixing it!).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-16 13:09</div>
            <div class="timeline-body"><p>Minimal repro for the primer panic on this branch:</p>
<pre><code class="language-py">class Point:
    def orthogonal_direction(self):
        self[0].is_zero


def test_point(p2: Point):
    p2.y
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-16 13:15</div>
            <div class="timeline-body"><p>And yes, it's easy to trigger the panic on <code>main</code> by adding this test:</p>
<pre><code class="language-diff">diff --git a/crates/ty_ide/src/completion.rs b/crates/ty_ide/src/completion.rs
index a8b93080b4..9f0a013b31 100644
--- a/crates/ty_ide/src/completion.rs
+++ b/crates/ty_ide/src/completion.rs
@@ -1835,6 +1835,23 @@ f&quot;{f.&lt;CURSOR&gt;
         test.assert_completions_include(&quot;method&quot;);
     }
 
+    #[test]
+    fn no_panic_for_attribute_table_that_contains_subscript() {
+        let test = cursor_test(
+            r#&quot;
+class Point:
+    def orthogonal_direction(self):
+        self[0].is_zero
+
+def test_point(p2: Point):
+    p2.&lt;CURSOR&gt;
+&quot;#,
+        );
+
+        let completions = test.completions();
+        assert_eq!(completions, &quot;orthogonal_direction&quot;);
+    }

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-16 13:37</div>
            <div class="timeline-body"><p>The primer panic should be fixed by https://github.com/astral-sh/ruff/pull/18707, but I won't attempt to rebase this PR branch on top of that as the commit history got somewhat messy here ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-16 22:25</div>
            <div class="timeline-body"><p>Mypy_primer is now timing out, but it appears that it ran ty successfully on all selected projects. I'm guessing it's taking <em>ages</em> to compute the diff between <code>old_ty</code>'s results and <code>new_ty</code>'s results, because there are many, many diagnostics where the message will change like so:</p>
<pre><code class="language-diff">- error[unresolved-attribute] Type `Foo` has no attribute `bar`
+ error[unresolved-attribute] Type `Foo` has no attribute `bar`: Did you mean `baz`?
</code></pre>
<p>So this PR is ready for review!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/diagnostic/levenshtein.rs</code>:70 on 2025-06-17 01:36</div>
            <div class="timeline-body"><p>Not sure I understand this. It sounds like this is saying that we consider an <em>access</em> of <code>self.attribute</code> (no assignment) sufficient to include <code>attribute</code> in <code>all_members</code>? Do we really do that? Why?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-06-17 01:44</div>
            <div class="timeline-body"><p>I reviewed the tests and did a high-level review of the implementation.</p>
<p>This will probably make us look a lot slower on early benchmarks of codebases where we raise a lot of AttributeError false positives, but so it goes; we should eliminate the false positive AttributeErrors.</p>
<p>Very cool feature!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/diagnostic/levenshtein.rs</code>:70 on 2025-06-17 09:48</div>
            <div class="timeline-body"><blockquote>
<p>It sounds like this is saying that we consider an <em>access</em> of <code>self.attribute</code> (no assignment) sufficient to include <code>attribute</code> in <code>all_members</code>? Do we really do that?</p>
</blockquote>
<p>That does appear to be the case, yes. If I make this diff to the PR branch:</p>
<pre><code class="language-diff">diff --git a/crates/ty_python_semantic/src/types/diagnostic/levenshtein.rs b/crates/ty_python_semantic/src/types/diagnostic/levenshtein.rs
index 11fc59674e..ff1fc86a28 100644
--- a/crates/ty_python_semantic/src/types/diagnostic/levenshtein.rs
+++ b/crates/ty_python_semantic/src/types/diagnostic/levenshtein.rs
@@ -66,18 +66,6 @@ where
         return None;
     }
 
-    // Filter out the unresolved member itself.
-    // Otherwise (due to our implementation of implicit instance attributes),
-    // we end up giving bogus suggestions like this:
-    //
-    // ```python
-    // class Foo:
-    //     _attribute = 42
-    //     def bar(self):
-    //         print(self.attribute)  # error: unresolved attribute `attribute`; did you mean `attribute`?
-    // ```
-    let options = options.filter(|name| name != unresolved_member);
-
</code></pre>
<p>then we get these changes to the snapshots:</p>
<p><img src="https://github.com/user-attachments/assets/f88e1e8b-2522-44bf-87db-a8e82a76baea" alt="image" /></p>
<p>And those seem to be self-evidently worse &quot;Did you mean?&quot; suggestions ðŸ˜†</p>
<blockquote>
<p>Why?</p>
</blockquote>
<p>I'm not sure. I agree that it seems a bit suspect. @sharkdp, do you have any ideas off the top of your head for why <code>attribute</code> might be included in the list returned by <code>all_members</code> here? If not, I can look into this as a followup.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-17 09:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-06-17 10:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-06-17 10:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-17 10:10</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:13:26 UTC
    </footer>
</body>
</html>
