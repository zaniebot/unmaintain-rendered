<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Hand-written MDTest parser - astral-sh/ruff #15926</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Hand-written MDTest parser</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15926">#15926</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-02-04 11:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body">Summary
<p>Replaces our existing Markdown test parser with a fully hand-written parser. I tried to fix this bug using the old approach and kept running into problems. Eventually this seemed like the easier way. It&#x27;s more code (+50 lines, excluding the new test), but I hope it&#x27;s relatively straightforward to understand, compared to the complex interplay between the byte-stream-manipulation and regex-parsing that we had before.</p>
<p>I did not really focus on performance, as the parsing time does not dominate the test execution time, but this seems to be slightly faster than what we had before (executing all MD tests; debug):</p>
<p>| Command | Mean [s] | Min [s] | Max [s] | Relative |
|:---|---:|---:|---:|---:|
| this branch | 2.775 ± 0.072 | 2.690 | 2.877 | 1.00 |
| <code>main</code> | 2.921 ± 0.034 | 2.865 | 2.967 | 1.05 ± 0.03 |</p>
<p>closes #15923</p>
Test Plan
<p>One new regression test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-02-04 11:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-02-04 11:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-02-04 11:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-02-04 11:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-02-04 11:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_test/src/parser.rs</code>:344 on 2025-02-04 11:24</div>
            <div class="timeline-body"><p>This is something that we could remove. It seems strange that we trim trailing newlines of code blocks. But I didn&#x27;t want to change the behavior in this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-04 11:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-04 11:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_test/src/parser.rs</code>:318 on 2025-02-04 11:26</div>
            <div class="timeline-body"><p>This message could be improved/adjusted according to the logic in the <code>if</code> condition, but I didn&#x27;t want to introduce and behavioral changes here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/parser.rs</code>:286 on 2025-02-04 11:35</div>
            <div class="timeline-body"><p>Are <code>#</code> considered header even if they&#x27;re not at the start of a line? E.g. I think the following are just regular hash signs.</p>
<pre><code>    ## not a title
   # title
  # title
 # title
# title
</code></pre>
<p>Huh, at least github&#x27;s markdown seems odd about what it considers a title. The same probably applies to code blocks.</p>
<p>I&#x27;d be okay to disallow code blocks and headers that aren&#x27;t at the start of the line.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/parser.rs</code>:286 on 2025-02-04 11:39</div>
            <div class="timeline-body"><p>Nit: I&#x27;ve a slight preference to use <code>self.cursor.bump()</code> over <code>self.cursor.is_eof</code> &amp; <code>self.cursor.first</code> because:</p>
<ul>
<li>It guarantees that the lexer/parser progresses in each iteration</li>
<li>It&#x27;s easy to forget a <code>bump</code> call with <code>first</code>.</li>
</ul>
<pre><code>while let Some(first) = self.cursor.bump() {
	match first {
		&#x27;#&#x27; =&gt; {
			...
		}
		c =&gt; if c.is_whitespace() {
			self.skip_whitespace()
		}
		c =&gt; {
			self.skip_to_end_of_line()
		}
	}
}
</code></pre>
<p>But I admit it&#x27;s somewhat more awkward with the <code>skip_whitespace</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/parser.rs</code>:319 on 2025-02-04 11:41</div>
            <div class="timeline-body"><p>Nit: I&#x27;d use a <code>eat_char</code> here OR <code>eat_char2</code></p>
<pre><code>if self.cursor.eat_char2(&#x27;`&#x27;, &#x27;`&#x27;) {
	// Handle triple quotes
} else if self.preceding_blank_lines &gt; 0 {
	... 
} else {
}
</code></pre>
<p>I generally prefer <code>eat</code> over <code>first</code> + <code>bump</code> because <code>first</code> is easy to get wrong if at <code>EOF</code> and it removes the guessing around which token <code>bump</code> &quot;bumps&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/parser.rs</code>:334 on 2025-02-04 11:43</div>
            <div class="timeline-body"><p>Calling <code>skip_to_beginning_of_next_line</code> seems unnecessary here because it will always eat the <code>\n</code>. Should this just be <code>if !self.cursor.eat(&#x27;\n&#x27;) { bail!(...) }</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/parser.rs</code>:343 on 2025-02-04 11:44</div>
            <div class="timeline-body"><p>Nit: I find using <code>char::len_utf8</code> improves readability of code handling byte offsets because it makes it explicit what character we&#x27;re offseting</p>
<pre><code>                                    code = &amp;code[..code.len() - &#x27;\n&#x27;.len_utf8()];
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-02-04 11:45</div>
            <div class="timeline-body"><p>This is great. No more regex :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-04 12:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_test/src/parser.rs</code>:334 on 2025-02-04 12:38</div>
            <div class="timeline-body"><p>Yes!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-04 12:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_test/src/parser.rs</code>:286 on 2025-02-04 12:45</div>
            <div class="timeline-body"><p>Good catch. This was just wrong. I added two new tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-04 12:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_test/src/parser.rs</code>:286 on 2025-02-04 12:46</div>
            <div class="timeline-body"><p>Thanks Micha. This is much nicer now, actually (the skip_whitespace was wrong anyway). I eliminated all <code>.first()</code> occurrences except for one in <code>consume_until</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-02-04 12:51</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-02-04 13:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-02-04 13:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-04 13:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-04 13:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_trivia/src/cursor.rs</code>:97 on 2025-02-04 13:03</div>
            <div class="timeline-body"><p>Oh, I wasn&#x27;t aware that <code>eat_char2</code> is only available on the ruff_python_parser <code>Cursor</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-04 13:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ruff_python_trivia/src/cursor.rs</code>:97 on 2025-02-04 13:54</div>
            <div class="timeline-body"><p>Oh. And I didn&#x27;t notice that <code>eat_char2</code> was available <em>somewhere</em>. My implementation is slightly different:</p>
<pre><code>pub fn eat_char2(&amp;mut self, c1: char, c2: char) -&gt; bool {
        if self.first() == c1 &amp;&amp; self.second() == c2 {
            self.bump();
            self.bump();
            true
        } else {
            false
        }
    }
</code></pre>
<p>vs the existing:</p>
<pre><code>pub(super) fn eat_char2(&amp;mut self, c1: char, c2: char) -&gt; bool {
        let mut chars = self.chars.clone();
        if chars.next() == Some(c1) &amp;&amp; chars.next() == Some(c2) {
            self.bump();
            self.bump();
            true
        } else {
            false
        }
    }
</code></pre>
<p>Should I do anything about this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-04 13:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_trivia/src/cursor.rs</code>:97 on 2025-02-04 13:57</div>
            <div class="timeline-body"><p>I think it&#x27;s fine. The second might be slightly faster but then, it&#x27;s used rarely.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:11:06 UTC
    </footer>
</body>
</html>
