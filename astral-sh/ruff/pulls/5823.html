<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>perf(formatter): Use memchar for faster back tokenization - astral-sh/ruff #5823</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>perf(formatter): Use memchar for faster back tokenization</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5823">#5823</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-07-17 07:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">

Summary
<p>@konsti found <a href="https://github.com/angr/angr/blob/master/angr/procedures/definitions/win32_fwpuclnt.py">this somewhat minified file</a> that took several seconds to format on my machine.</p>
<p>I did some profiling and found that our formatter spends about 90%+ of the time lexing backwards to identify if an expression is parenthesized or not. The reason why this is slow
is because the file contains very large files and backwards lexing must first check if the token on this line is not a comment.</p>
<p>This PR changes the implementation to use <code>memchr</code> to find the start of the line or comment position and only validate if it is a <em>valid</em> comment if a comment was found.
This reduces the formatting time on my machine to a few ms.</p>


<p>This change is not strictly necessary after <a href="https://github.com/astral-sh/ruff/pull/5825">astral-sh/ruff#5825</a> as it reduces the time we call into <code>next_back()</code> but I thought it would still be nice to keep it around.</p>
Test Plan
<p>Formatting the aformentioned file now only takes 500ms (~16s before)</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-17 07:58</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #5823</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5823"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite"></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5823?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-17 08:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-17 08:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-17 08:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-17 08:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-07-17 08:56</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>âœ… ecosystem check detected no changes.</p>
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     11.0Â±0.25ms     3.7 MB/sec    1.01     11.1Â±0.12ms     3.7 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.1Â±0.09ms     7.8 MB/sec    1.03      2.2Â±0.04ms     7.5 MB/sec
formatter/numpy/globals.py                 1.00    249.0Â±2.74Âµs    11.8 MB/sec    1.01    251.0Â±1.84Âµs    11.8 MB/sec
formatter/pydantic/types.py                1.00      4.8Â±0.02ms     5.3 MB/sec    1.01      4.8Â±0.02ms     5.3 MB/sec
linter/all-rules/large/dataset.py          1.01     15.6Â±0.15ms     2.6 MB/sec    1.00     15.5Â±0.26ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.9Â±0.08ms     4.3 MB/sec    1.02      4.0Â±0.07ms     4.2 MB/sec
linter/all-rules/numpy/globals.py          1.00   515.2Â±12.31Âµs     5.7 MB/sec    1.01    520.0Â±1.51Âµs     5.7 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.0Â±0.13ms     3.7 MB/sec    1.01      7.1Â±0.10ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.01      7.9Â±0.06ms     5.2 MB/sec    1.00      7.8Â±0.12ms     5.2 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1666.3Â±28.23Âµs    10.0 MB/sec    1.00  1672.1Â±28.59Âµs    10.0 MB/sec
linter/default-rules/numpy/globals.py      1.00    184.1Â±2.39Âµs    16.0 MB/sec    1.01    185.7Â±1.85Âµs    15.9 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.6Â±0.06ms     7.2 MB/sec    1.00      3.5Â±0.06ms     7.2 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01     11.6Â±0.45ms     3.5 MB/sec    1.00     11.5Â±0.22ms     3.5 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.2Â±0.11ms     7.5 MB/sec    1.00      2.2Â±0.08ms     7.5 MB/sec
formatter/numpy/globals.py                 1.00    246.2Â±6.76Âµs    12.0 MB/sec    1.03   253.0Â±15.30Âµs    11.7 MB/sec
formatter/pydantic/types.py                1.00      4.8Â±0.13ms     5.3 MB/sec    1.01      4.9Â±0.08ms     5.2 MB/sec
linter/all-rules/large/dataset.py          1.00     15.6Â±0.16ms     2.6 MB/sec    1.02     16.0Â±0.45ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.2Â±0.06ms     4.0 MB/sec    1.00      4.2Â±0.14ms     4.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    498.6Â±9.54Âµs     5.9 MB/sec    1.01   503.8Â±13.30Âµs     5.9 MB/sec
linter/all-rules/pydantic/types.py         1.01      7.2Â±0.14ms     3.6 MB/sec    1.00      7.1Â±0.14ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.01      8.5Â±0.25ms     4.8 MB/sec    1.00      8.4Â±0.18ms     4.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01  1733.3Â±48.98Âµs     9.6 MB/sec    1.00  1713.8Â±26.13Âµs     9.7 MB/sec
linter/default-rules/numpy/globals.py      1.01    195.3Â±7.74Âµs    15.1 MB/sec    1.00    193.2Â±4.12Âµs    15.3 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.7Â±0.07ms     6.9 MB/sec    1.00      3.7Â±0.05ms     7.0 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/trivia.rs</code>:444 on 2023-07-18 11:59</div>
            <div class="timeline-body"><p>why do you filter on an option? (i got really confused reading this code because i expected an iterator)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-07-18 11:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/trivia.rs</code>:444 on 2023-07-18 20:49</div>
            <div class="timeline-body"><p>Hmm, yeah, I can see how the method name makes one think that it is an iterator. I, thanks god, wasn&#x27;t responsible for naming.</p>
<p>I first used <code>last_comment_offset.and_then(|last_comment_offset| if ... { Some(offset) else { None }} </code> but it&#x27;s so long. I then found <code>filter</code> which does exactly what I need.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-07-18 20:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-18 20:51</div>
            <div class="timeline-body"><p>I&#x27;m going to merge this and look into handling</p>
<pre><code>&#x27;&#x27;&#x27; a multiline string containing a comment
# comment &#x27;&#x27;&#x27; + test
</code></pre>
<p>in a separate PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-18 21:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-18 21:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-07-18 21:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:55:24 UTC
    </footer>
</body>
</html>
