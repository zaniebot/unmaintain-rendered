```yaml
number: 3735
title: "perf(pycodestyle): Remove regex captures"
type: pull_request
state: merged
author: MichaReiser
labels: []
assignees: []
merged: true
base: main
head: logical-lines_Avoid_Regex_captures
created_at: 2023-03-26T00:29:14Z
updated_at: 2023-03-28T07:50:36Z
url: https://github.com/astral-sh/ruff/pull/3735
synced_at: 2026-01-12T04:39:45Z
```

# perf(pycodestyle): Remove regex captures

---

_Pull request opened by @MichaReiser on 2023-03-26 00:29_

From the regex documentation:

> Advice: Prefer in this order: is_match, find, captures.

[source](https://github.com/rust-lang/regex/blob/master/PERFORMANCE.md#only-ask-for-what-you-need)

This PR removes our usages of `capture_iter` with `find_iter` and and implements the whitespace-testing manually. 

## Performance

* `no-logical`: pycode style rules disabled
* `pr3715`: The base version with logical lines enabled
* `pr3735`: This PR with logical lines enabled.

```
group                                      no-logical                             pr3735                                  pr3715
-----                                      ----------                             -----                                  ------
linter/all-rules/large/dataset.py          1.00      8.5Â±0.01ms     4.8 MB/sec    1.10      9.4Â±0.05ms     4.3 MB/sec    1.10      9.4Â±0.15ms     4.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      2.1Â±0.01ms     7.8 MB/sec    1.09      2.3Â±0.00ms     7.1 MB/sec    1.15      2.5Â±0.00ms     6.8 MB/sec
linter/all-rules/numpy/globals.py          1.00    247.9Â±3.25Âµs    11.9 MB/sec    1.10    272.6Â±1.25Âµs    10.8 MB/sec    1.16    286.9Â±3.46Âµs    10.3 MB/sec
linter/all-rules/pydantic/types.py         1.00      3.7Â±0.04ms     7.0 MB/sec    1.11      4.1Â±0.07ms     6.3 MB/sec    1.19      4.4Â±0.02ms     5.9 MB/sec
linter/default-rules/large/dataset.py      1.00      4.7Â±0.01ms     8.7 MB/sec    1.19      5.6Â±0.11ms     7.3 MB/sec    1.24      5.8Â±0.08ms     7.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00    999.5Â±5.57Âµs    16.7 MB/sec    1.22   1216.5Â±2.35Âµs    13.7 MB/sec    1.31  1304.4Â±16.73Âµs    12.8 MB/sec
linter/default-rules/numpy/globals.py      1.00    101.0Â±0.41Âµs    29.2 MB/sec    1.36    137.5Â±1.36Âµs    21.5 MB/sec    1.44    145.7Â±1.31Âµs    20.2 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.1Â±0.01ms    11.9 MB/sec    1.19      2.5Â±0.06ms    10.0 MB/sec    1.26      2.7Â±0.03ms     9.5 MB/sec
```

We're getting closer, but a 36% regression for some cases is still heavy....

---

_Comment by @MichaReiser on 2023-03-26 00:29_

Current dependencies on/for this PR:
* main
  * **PR #3714** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3714" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #3715** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3715" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #3735** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3735" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
        * **PR #3736** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3736" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #3745** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3745" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
            * **PR #3757** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3757" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #3737** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3737" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/charliermarsh/ruff/3735?utm_source=stack-comment).

---

_Comment by @github-actions[bot] on 2023-03-26 00:58_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     17.5Â±0.10ms     2.3 MB/sec    1.00     17.5Â±0.07ms     2.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.02      4.6Â±0.04ms     3.6 MB/sec    1.00      4.5Â±0.02ms     3.7 MB/sec
linter/all-rules/numpy/globals.py          1.00    620.0Â±1.39Âµs     4.8 MB/sec    1.00    621.6Â±1.77Âµs     4.7 MB/sec
linter/all-rules/pydantic/types.py         1.01      7.8Â±0.07ms     3.3 MB/sec    1.00      7.7Â±0.05ms     3.3 MB/sec
linter/default-rules/large/dataset.py      1.01      9.2Â±0.05ms     4.4 MB/sec    1.00      9.2Â±0.06ms     4.4 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00      2.1Â±0.01ms     8.1 MB/sec    1.00      2.1Â±0.01ms     8.1 MB/sec
linter/default-rules/numpy/globals.py      1.00    229.8Â±1.34Âµs    12.8 MB/sec    1.00    228.8Â±0.64Âµs    12.9 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.3Â±0.02ms     5.9 MB/sec    1.00      4.3Â±0.04ms     5.9 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.01     15.0Â±0.03ms     2.7 MB/sec    1.00     14.9Â±0.03ms     2.7 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      4.1Â±0.02ms     4.1 MB/sec    1.00      4.0Â±0.02ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.03    453.6Â±3.19Âµs     6.5 MB/sec    1.00    439.7Â±3.14Âµs     6.7 MB/sec
linter/all-rules/pydantic/types.py         1.01      6.7Â±0.02ms     3.8 MB/sec    1.00      6.6Â±0.02ms     3.9 MB/sec
linter/default-rules/large/dataset.py      1.04      8.3Â±0.03ms     4.9 MB/sec    1.00      8.0Â±0.03ms     5.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.02   1752.4Â±5.15Âµs     9.5 MB/sec    1.00   1722.7Â±8.36Âµs     9.7 MB/sec
linter/default-rules/numpy/globals.py      1.06    185.1Â±1.48Âµs    15.9 MB/sec    1.00    174.4Â±3.12Âµs    16.9 MB/sec
linter/default-rules/pydantic/types.py     1.03      3.8Â±0.02ms     6.7 MB/sec    1.00      3.7Â±0.02ms     6.9 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Renamed from "Avoid using Regex captures" to "perf(pycodestyle): Remove regex captures" by @MichaReiser on 2023-03-26 10:59_

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/pycodestyle/snapshots/ruff__rules__pycodestyle__tests__E221_E22.py.snap`:117 on 2023-03-26 11:16_

The changes to the tests make sense to me, but I would appreciate it if someone more familiar with pycodestyle could review the changes, just to be sure.

---

_@MichaReiser reviewed on 2023-03-26 11:16_

---

_Marked ready for review by @MichaReiser on 2023-03-26 11:29_

---

_Review requested from @charliermarsh by @MichaReiser on 2023-03-27 12:31_

---

_@charliermarsh reviewed on 2023-03-27 15:06_

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/pycodestyle/logical_lines.rs`:346 on 2023-03-27 15:06_

Nit: `strinig`

---

_@charliermarsh reviewed on 2023-03-27 15:07_

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/pycodestyle/rules/mod.rs`:91 on 2023-03-27 15:07_

Wonder whether we should find another home for this? Maybe `pycodestyle/whitespace.rs`? Or `pycodestyle/rules/helpers.rs`?

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/pycodestyle/snapshots/ruff__rules__pycodestyle__tests__E221_E22.py.snap`:117 on 2023-03-27 15:10_

So I guess the difference here is that `-` is considered an operator (as in `-1`), whereas before it wasn't? And thus, `x =            -1` is considered  `MultipleSpacesBeforeOperator`?


---

_@charliermarsh reviewed on 2023-03-27 15:10_

---

_@charliermarsh reviewed on 2023-03-27 15:11_

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/pycodestyle/snapshots/ruff__rules__pycodestyle__tests__E274_E27.py.snap`:19 on 2023-03-27 15:11_

Looks like it's triggering twice because we have two tabs here, which seems ok to me.

---

_@charliermarsh reviewed on 2023-03-27 15:13_

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/pycodestyle/snapshots/ruff__rules__pycodestyle__tests__E274_E27.py.snap`:6 on 2023-03-27 15:13_

Confused why this one only triggers once, but row 12 triggers twice. In both cases we have two tabs.

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/pycodestyle/snapshots/ruff__rules__pycodestyle__tests__E274_E27.py.snap`:11 on 2023-03-27 15:13_

I think this one might be wrong because it's considering `False` to be a keyword.

---

_@charliermarsh reviewed on 2023-03-27 15:13_

---

_@charliermarsh reviewed on 2023-03-27 15:13_

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/pycodestyle/snapshots/ruff__rules__pycodestyle__tests__E272_E27.py.snap`:11 on 2023-03-27 15:13_

I think this one might be wrong, it's considering `False` to be a keyword.

---

_@charliermarsh reviewed on 2023-03-27 15:24_

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/pycodestyle/snapshots/ruff__rules__pycodestyle__tests__E221_E22.py.snap`:117 on 2023-03-27 15:24_

It'd be nice if we didn't flag this (any changes in these snapshots are deviations from pycodestyle, I think), but we could live with this if handling the `-` in `x = 1 - 2` vs. `x = -2` is hard or complicated. Either way, it'll be a lint error, it's just a question of whether it's "spaces after the `=`" or `"spaces before the `-`".

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/pycodestyle/snapshots/ruff__rules__pycodestyle__tests__E221_E22.py.snap`:117 on 2023-03-27 15:25_

Ah yeah, I guess pycodestyle doesn't flag `x = -   2` as a lint error at all. That seems wrong. What you have here (treating `-` as an operator everywhere) may be better anyway.

---

_@charliermarsh reviewed on 2023-03-27 15:25_

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/pycodestyle/rules/mod.rs`:91 on 2023-03-27 15:49_

I can put it into `whitespace` and potentially gate it to the feature. 

I prefer not to put code into `helpers`/`util` modules because they often end up being this huge pile of random things that you have a hard time finding in the future. I prefer to come up with a concrete concept where the code fits in. 

---

_@MichaReiser reviewed on 2023-03-27 15:49_

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/pycodestyle/snapshots/ruff__rules__pycodestyle__tests__E221_E22.py.snap`:117 on 2023-03-27 15:58_

Pycodestyle does report the error but as `MultipleSpacesAfterOperator` where the `=` is the operator

```
crates/ruff/resources/test/fixtures/pycodestyle/E22.py:31:4: E222 multiple spaces after operator
crates/ruff/resources/test/fixtures/pycodestyle/E22.py:32:4: E222 multiple spaces after operator
```

Let me have a look why we report it differently



---

_Review comment by @MichaReiser on `crates/ruff/src/rules/pycodestyle/snapshots/ruff__rules__pycodestyle__tests__E272_E27.py.snap`:11 on 2023-03-27 15:59_

Pylint seems to agree (`False` is a keyword, right?). Except that it should be multiple spaces after keyword and not before. Maybe we are now double-reporting the spaces?

```
crates/ruff/resources/test/fixtures/pycodestyle/E27.py:4:9: E271 multiple spaces after keyword
```

The column numbers seem to be off-tough. 

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/pycodestyle/snapshots/ruff__rules__pycodestyle__tests__E274_E27.py.snap`:20 on 2023-03-27 16:01_

Having two here seems correct but one should be after keyword:

```
crates/ruff/resources/test/fixtures/pycodestyle/E27.py:12:5: E274 tab before keyword
crates/ruff/resources/test/fixtures/pycodestyle/E27.py:12:10: E273 tab after keyword
```

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/pycodestyle/snapshots/ruff__rules__pycodestyle__tests__E274_E27.py.snap`:11 on 2023-03-27 16:01_

Again, should be after keyword and not before: 

```
crates/ruff/resources/test/fixtures/pycodestyle/E27.py:8:3: E271 multiple spaces after keyword
```

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/pycodestyle/snapshots/ruff__rules__pycodestyle__tests__E274_E27.py.snap`:19 on 2023-03-27 16:01_

```
crates/ruff/resources/test/fixtures/pycodestyle/E27.py:30:10: E273 tab after keyword
```

Same, should only trigger after keyword, not both

---

_@MichaReiser reviewed on 2023-03-27 16:01_

---

_@MichaReiser reviewed on 2023-03-27 16:38_

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/pycodestyle/snapshots/ruff__rules__pycodestyle__tests__E221_E22.py.snap`:117 on 2023-03-27 16:38_

I have a fix for the token based implementation (stack on top of this stack). I have to look closer to understand what's causing the difference in the regex based implementations (only if I can figure it out quickly)

---

_@charliermarsh reviewed on 2023-03-27 18:58_

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/pycodestyle/snapshots/ruff__rules__pycodestyle__tests__E221_E22.py.snap`:117 on 2023-03-27 18:58_

Ah yeah, if it's fixed upstream, then I don't feel strongly about debugging here.

---

_@charliermarsh reviewed on 2023-03-27 18:59_

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/pycodestyle/rules/mod.rs`:91 on 2023-03-27 18:59_

Embrace the helpers...

---

_@charliermarsh approved on 2023-03-27 19:00_

I trust you to resolve any necessary issues based on discussion around the deviations, but just tag me if you want eyes on anything as you follow up.

---

_@MichaReiser reviewed on 2023-03-27 21:06_

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/pycodestyle/rules/mod.rs`:91 on 2023-03-27 21:06_

I'll move this into `LogicalLines` in my top most PR (easier than dealing with all the merge conflicts). The idea is that the `LogicalLine` already has a `before_text` and I think it's only used to determine the Whitespace... so I'll add it there.

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/pycodestyle/snapshots/ruff__rules__pycodestyle__tests__E274_E27.py.snap`:12 on 2023-03-27 21:06_

I checked these numbers and they match pycodestyle

```
crates/ruff/resources/test/fixtures/pycodestyle/E27.py:28:2: E274 tab before keyword
crates/ruff/resources/test/fixtures/pycodestyle/E27.py:30:5: E274 tab before keyword
```

The other tests are fixed (very hacky solution but the next PR replaces it anyway)

---

_@MichaReiser reviewed on 2023-03-27 21:06_

---

_Merged by @MichaReiser on 2023-03-28 07:50_

---

_Closed by @MichaReiser on 2023-03-28 07:50_

---

_Branch deleted on 2023-03-28 07:50_

---
