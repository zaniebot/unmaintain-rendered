<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add newline after import only if blocks (`TYPE_CHECKING`) - astral-sh/ruff #18413</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add newline after import only if blocks (<code>TYPE_CHECKING</code>)</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18413">#18413</a>
        opened by <a href="https://github.com/maxmynter">@maxmynter</a>
        on 2025-06-01 16:01
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/maxmynter">@maxmynter</a></div>
            <div class="timeline-body">

<p>Closes: #18410</p>
Summary
<p>Formatter adds a newline after a standalone <code>if</code> block that only contains imports.</p>
<p>This adresses the concern from the linked issue that usually the Ruff formatter requires blank lines after imports.</p>
Note:
<p>I could not fully reproduce the formatting behaviour of the issue.</p>
<p>Running the example:</p>
<pre><code>echo &quot;from __future__ import annotations

from pathlib import Path

path: Path&quot; &gt; tmp.py &amp;&amp; ruff check --select TC003 --fix --unsafe-fixes --diff tmp.py
</code></pre>
<p>gives</p>
<pre><code>--- tmp.py
+++ tmp.py
@@ -1,5 +1,8 @@
 from __future__ import annotations

-from pathlib import Path
+from typing import TYPE_CHECKING
+
+if TYPE_CHECKING:
+    from pathlib import Path

 path: Path

Would fix 1 error.
</code></pre>
<p>(note the empty line that persists between the import and <code>path: Path</code>.)</p>
<p>However, without the separating line, no empty line is added:</p>
<pre><code>echo &quot;from __future__ import annotations

from pathlib import Path
path: Path&quot; &gt; tmp.py &amp;&amp; ruff check --select TC003 --fix --unsafe-fixes --diff tmp.py
</code></pre>
<p>gives</p>
<pre><code>--- tmp.py
+++ tmp.py
@@ -1,4 +1,7 @@
 from __future__ import annotations

-from pathlib import Path
+from typing import TYPE_CHECKING
+
+if TYPE_CHECKING:
+    from pathlib import Path
 path: Path

Would fix 1 error.
</code></pre>
<p>And for consistency with empty lines after imports, agreeing with the issue, I feel like it should.
This is addressed in this PR on format.</p>


Test Plan
<p>Added a test case.</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/maxmynter">@maxmynter</a> on 2025-06-01 16:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-01 16:08</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Formatter (stable)
<p>‚ÑπÔ∏è ecosystem check <strong>detected format changes</strong>. (+1 -0 lines in 1 file in 1 projects; 54 projects unchanged)</p>
<a href="https://github.com/rotki/rotki">rotki/rotki</a> (+1 -0 lines across 1 file)
<p>

<p><a href="https://github.com/rotki/rotki/blob/e97367d555c4acd36d9ad597d76f3cfd93aff3da/rotkehlchen/tests/api/test_sushiswap.py#L23">rotkehlchen/tests/api/test_sushiswap.py~L23</a></p>
<pre><code> 
 if TYPE_CHECKING:
     from rotkehlchen.api.server import APIServer
+
 SWAP_ADDRESS = string_to_evm_address(&quot;0x63BC843b9640c4D79d6aE0105bc39F773172d121&quot;)
 
 
</code></pre>
</p>


Formatter (preview)
<p>‚ÑπÔ∏è ecosystem check <strong>detected format changes</strong>. (+5 -1 lines in 6 files in 5 projects; 50 projects unchanged)</p>
<a href="https://github.com/apache/superset">apache/superset</a> (+0 -1 lines across 1 file)
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<p><a href="https://github.com/apache/superset/blob/c09f8f6f7665e503a376926700fa815add6892ca/superset/db_engine_specs/bigquery.py#L74">superset/db_engine_specs/bigquery.py~L74</a></p>
<pre><code> if TYPE_CHECKING:
     from superset.models.core import Database  # pragma: no cover
 
-
 logger = logging.getLogger()
 
 CONNECTION_DATABASE_PERMISSIONS_REGEX = re.compile(
</code></pre>
</p>

<a href="https://github.com/pandas-dev/pandas">pandas-dev/pandas</a> (+2 -0 lines across 2 files)
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<p><a href="https://github.com/pandas-dev/pandas/blob/c708e152c42f81b17cf6e47f7939a86e4c3fc77f/pandas/core/indexes/interval.py#L100">pandas/core/indexes/interval.py~L100</a></p>
<pre><code>         Self,
         npt,
     )
+
 _index_doc_kwargs = dict(ibase._index_doc_kwargs)
 
 _index_doc_kwargs.update({
</code></pre>
<p><a href="https://github.com/pandas-dev/pandas/blob/c708e152c42f81b17cf6e47f7939a86e4c3fc77f/pandas/io/formats/style_render.py#L47">pandas/io/formats/style_render.py~L47</a></p>
<pre><code>         Axis,
         Level,
     )
+
 jinja2 = import_optional_dependency(&quot;jinja2&quot;, extra=&quot;DataFrame.style requires jinja2.&quot;)
 from markupsafe import escape as escape_html  # markupsafe is jinja2 dependency
 
</code></pre>
</p>

<a href="https://github.com/python/typeshed">python/typeshed</a> (+1 -0 lines across 1 file)
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<p><a href="https://github.com/python/typeshed/blob/09b6802dc7a568309db46cae14c52e44787f8494/stdlib/ntpath.pyi#L47">stdlib/ntpath.pyi~L47</a></p>
<pre><code> 
 if sys.version_info &gt;= (3, 12):
     from posixpath import isjunction as isjunction, splitroot as splitroot
+
 if sys.version_info &gt;= (3, 13):
     from genericpath import isdevdrive as isdevdrive
 
</code></pre>
</p>

<a href="https://github.com/rotki/rotki">rotki/rotki</a> (+1 -0 lines across 1 file)
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<p><a href="https://github.com/rotki/rotki/blob/e97367d555c4acd36d9ad597d76f3cfd93aff3da/rotkehlchen/tests/api/test_sushiswap.py#L23">rotkehlchen/tests/api/test_sushiswap.py~L23</a></p>
<pre><code> 
 if TYPE_CHECKING:
     from rotkehlchen.api.server import APIServer
+
 SWAP_ADDRESS = string_to_evm_address(&quot;0x63BC843b9640c4D79d6aE0105bc39F773172d121&quot;)
 
 
</code></pre>
</p>

<a href="https://github.com/astropy/astropy">astropy/astropy</a> (+1 -0 lines across 1 file)
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<p><a href="https://github.com/astropy/astropy/blob/c8ef6b1bd29ec2436ef6595e24c7988c467c0ac7/astropy/time/core.py#L58">astropy/time/core.py~L58</a></p>
<pre><code> 
 if TYPE_CHECKING:
     from astropy.coordinates import EarthLocation
+
 __all__ = [
     &quot;STANDARD_TIME_SCALES&quot;,
     &quot;TIME_DELTA_SCALES&quot;,
</code></pre>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/maxmynter">@maxmynter</a> on 2025-06-01 16:29</div>
            <div class="timeline-body"><p>The apache superset ecosystem change is the deletion of a line (before there were 2 empty ones). The others are an added line.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-01 16:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-01 16:40</div>
            <div class="timeline-body"><p>Is this change compatible with black? It also sets a new precedence to change formatting based on semantics</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/maxmynter">@maxmynter</a> on 2025-06-01 17:30</div>
            <div class="timeline-body"><p>I&#x27;m unsure on the exact definition of compatibility.</p>
<p>It&#x27;s compatible in the sense that Black doesn&#x27;t complain on the changed file. However, it doesn&#x27;t do the change either.</p>
<p>I.e.</p>
<pre><code>black tmp.py --diff
All done! ‚ú® üç∞ ‚ú®
1 file would be left unchanged.
</code></pre>
<p>for both</p>
<pre><code>cat tmp.py
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from pathlib import Path

path: Path
</code></pre>
<p>and</p>
<pre><code>cat tmp.py
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from pathlib import Path
path: Path
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-01 17:42</div>
            <div class="timeline-body"><p>Yeah. We definitely can&#x27;t change this outside preview. But I&#x27;m not sure if we should change this because ruff/black are intentionally unopinionated about spacing around if statements.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/maxmynter">@maxmynter</a> on 2025-06-01 19:56</div>
            <div class="timeline-body"><p>Does that also mean we should not address the issue (#18410)?</p>
<p>In principle one could add this empty line formatting to the fix for TC003. But I fear this is going to be janky and breaks Ruff&#x27;s usual lifecycle of fix -&gt; format.</p>
<p>I personally like the empty line after the type check if clause but don&#x27;t have arguments to supercede being unoponionated on spacing.
And in that case, the existing fix seems to preserve whatever spacing was there previously.</p>
<p>Let me know if you would like a different implementation. Otherwise feel free to close this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-02 09:13</div>
            <div class="timeline-body"><p>I think this requires some more design before we can even consider adding this to the formatter. E.g. what if the if statement has an else branch? What about other conditional imports (e.g. python version specific imports)? What about conditional imports using try-catch.</p>
<p>Given the scope, I don&#x27;t feel comfortable merging this as is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-02 09:13</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:15:05 UTC
    </footer>
</body>
</html>
