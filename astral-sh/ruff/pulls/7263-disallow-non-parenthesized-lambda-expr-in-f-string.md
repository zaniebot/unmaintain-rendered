```yaml
number: 7263
title: Disallow non-parenthesized lambda expr in f-string
type: pull_request
state: merged
author: dhruvmanila
labels:
  - parser
  - python312
assignees: []
merged: true
base: dhruv/pep-701
head: dhruv/fstring-parser-3
created_at: 2023-09-11T06:06:47Z
updated_at: 2023-09-14T02:23:53Z
url: https://github.com/astral-sh/ruff/pull/7263
synced_at: 2026-01-12T02:39:09Z
```

# Disallow non-parenthesized lambda expr in f-string

---

_Pull request opened by @dhruvmanila on 2023-09-11 06:06_

## Summary

This PR updates the handling of disallowing non-parenthesized lambda expr in
f-strings.

Previously, the lexer was used to emit an empty `FStringMiddle` token in certain
cases for which there's no pattern in the parser to match. That would then raise
an unexpected token error while parsing.

This PR adds a new f-string error type `LambdaWithoutParentheses`. In cases
where the parser still can't detect the error, it's guaranteed to be caught by
the fact that there's no `FStringMiddle` token in the pattern.

## Test Plan

Add test cases wherever we throw the `LambdaWithoutParentheses` error.

## Benchmarks

As this is the final PR for the parser, I'm putting the parser benchmarks here:

```
group                         fstring-parser                         main
-----                         --------------                         ----
parser/large/dataset.py       1.00      4.7Â±0.24ms     8.7 MB/sec    1.03      4.8Â±0.25ms     8.4 MB/sec
parser/numpy/ctypeslib.py     1.03   921.8Â±39.00Âµs    18.1 MB/sec    1.00   897.6Â±39.03Âµs    18.6 MB/sec
parser/numpy/globals.py       1.01     90.4Â±5.23Âµs    32.6 MB/sec    1.00     89.6Â±6.24Âµs    32.9 MB/sec
parser/pydantic/types.py      1.00  1899.5Â±94.78Âµs    13.4 MB/sec    1.03  1954.4Â±105.88Âµs    13.0 MB/sec
parser/unicode/pypinyin.py    1.03   292.3Â±21.14Âµs    14.4 MB/sec    1.00   283.2Â±13.16Âµs    14.8 MB/sec
```

---

_Comment by @dhruvmanila on 2023-09-11 06:07_

Current dependencies on/for this PR:
* main
  * **PR #7035** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7035" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7013** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7013" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #6659** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6659" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #7041** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7041" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #7211** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7211" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
            * **PR #7263** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7263" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ğŸ‘ˆ
              * **PR #7331** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7331" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
                * **PR #7325** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7325" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
                  * **PR #7326** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7326" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
                    * **PR #7327** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7327" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
                      * **PR #7328** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7328" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
                        * **PR #7329** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7329" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7263?utm_source=stack-comment).

---

_Review comment by @dhruvmanila on `crates/ruff_python_parser/src/python.lalrpop`:1354 on 2023-09-11 06:09_

I tried to add the `fstring_middle` optional token after the body but that creates conflict when generating. This makes sense and I guess the solution would be to modify `Test<"all">` as you suggested in Discord but I don't think it's worth the complexity right now.

---

_@dhruvmanila reviewed on 2023-09-11 06:10_

---

_Review requested from @MichaReiser by @dhruvmanila on 2023-09-11 06:10_

---

_Label `parser` added by @dhruvmanila on 2023-09-11 06:11_

---

_Review comment by @MichaReiser on `crates/ruff_python_ast/src/nodes.rs`:3258 on 2023-09-11 06:42_

```suggestion
    /// Returns `true` if the expression is parenthesized.
```

---

_Review comment by @MichaReiser on `crates/ruff_python_parser/src/lexer/fstring.rs`:133 on 2023-09-11 06:43_

```suggestion
            self.format_spec_depth -= 1;
```

`is_in_formt_spec` guarantees that `format_spec_depth >= 1` -> subtracting can never overflow

---

_Review comment by @MichaReiser on `crates/ruff_python_parser/src/python.lalrpop`:1598 on 2023-09-11 06:44_

Nice

---

_Review comment by @MichaReiser on `crates/ruff_python_parser/src/string.rs`:312 on 2023-09-11 06:45_

Nit: Maybe move part of this description to the lambda parse rule?

---

_Review comment by @MichaReiser on `crates/ruff_python_parser/src/string.rs`:503 on 2023-09-11 06:46_

Nit: This comment is confusing IMO because I understand that our Parser + Lexer accepts invalid input. I don't think that's the case. What you're trying to say is that the parser only accepts some of it. Maybe move the other comment from the Lexer here and explain which errors are captured by the lexer and which errors are captured by the parser.

---

_Review comment by @MichaReiser on `crates/ruff_python_parser/src/string.rs`:520 on 2023-09-11 06:47_

```suggestion
                write!(f, "lambda expressions are not allowed in f-strings without parentheses")
```

---

_@MichaReiser approved on 2023-09-11 06:47_

---

_@dhruvmanila reviewed on 2023-09-12 05:03_

---

_Review comment by @dhruvmanila on `crates/ruff_python_parser/src/string.rs`:520 on 2023-09-12 05:03_

All variants of `FStringErrorType` gets prefixed with "f-string: ", so the message would be:
```
f-string: lambda expressions are not allowed without parentheses
```

---

_@dhruvmanila reviewed on 2023-09-12 05:18_

---

_Review comment by @dhruvmanila on `crates/ruff_python_parser/src/string.rs`:503 on 2023-09-12 05:18_

I'm not sure if that's the case. What I mean here is that in all cases the parser won't accept a lambda expression without parentheses inside a f-string. It'll always throw an error in such scenarios. The problem I'm highlighting here is that the parser won't give an appropriate error in all scenarios but only in a few of them while in the others it'll just give "an unexpected token" error. I'll update the comment though.

---

_Label `python312` added by @dhruvmanila on 2023-09-12 11:17_

---

_Merged by @dhruvmanila on 2023-09-14 02:15_

---

_Closed by @dhruvmanila on 2023-09-14 02:15_

---

_Branch deleted on 2023-09-14 02:15_

---

_Comment by @codspeed-hq[bot] on 2023-09-14 02:23_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/dhruv/fstring-parser-3)

### Merging #7263 will **degrade performances by 10.1%**

<sub>:warning: No base runs were found</sub>

<sub>Falling back to comparing <code>dhruv/fstring-parser-3</code> (85e5c01) with <code>main</code> (04183b0)</sub>



### Summary

`âŒ 8` regressions
`âœ… 17` untouched benchmarks



> :warning: _Please fix the performance issues or [acknowledge them on CodSpeed](https://codspeed.io/astral-sh/ruff/branches/dhruv/fstring-parser-3)._

### Benchmarks breakdown

|     | Benchmark | `main` | `dhruv/fstring-parser-3` | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| âŒ | `lexer[pydantic/types.py]` | 4.1 ms | 4.6 ms | -10.1% |
| âŒ | `lexer[numpy/ctypeslib.py]` | 2 ms | 2.1 ms | -8.07% |
| âŒ | `parser[large/dataset.py]` | 68.4 ms | 70.2 ms | -2.59% |
| âŒ | `lexer[unicode/pypinyin.py]` | 620.2 Âµs | 676.3 Âµs | -8.29% |
| âŒ | `parser[numpy/ctypeslib.py]` | 12.4 ms | 12.7 ms | -2.62% |
| âŒ | `lexer[large/dataset.py]` | 9.8 ms | 10.8 ms | -8.8% |
| âŒ | `lexer[numpy/globals.py]` | 233.2 Âµs | 253.9 Âµs | -8.17% |
| âŒ | `parser[unicode/pypinyin.py]` | 4.3 ms | 4.4 ms | -2.8% |


---
