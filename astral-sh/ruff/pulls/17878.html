<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pylint`] add fix safety section (`PLW3301`) - astral-sh/ruff #17878</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pylint</code>] add fix safety section (<code>PLW3301</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17878">#17878</a>
        opened by <a href="https://github.com/yunchipang">@yunchipang</a>
        on 2025-05-06 03:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/yunchipang">@yunchipang</a></div>
            <div class="timeline-body"><p>parent: #15584
issue: #16163</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-05-06 03:40</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">documentation</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-06 06:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pylint/rules/nested_min_max.rs</code>:31 on 2025-05-06 19:17</div>
            <div class="timeline-body"><p>This isn&#x27;t really a fix safety issue, this is a bug with an open issue that needs to be fixed.</p>
<p>I went through the git blame on this one, and I&#x27;m not really sure it actually needs to be unsafe. It was first converted from <code>Fix::unspecified</code> to <code>Fix::suggested</code> in <a href="https://github.com/astral-sh/ruff/pull/5251">astral-sh/ruff#5251</a>, which became <code>Fix::sometimes_applies</code>, which became <code>Fix::unsafe_edit</code>. I didn&#x27;t see any specific discussion of the fix being unsafe, so I think it may have just been the more conservative option.</p>
<p>All that to say, it&#x27;s not clear to me why this rule would need to be unsafe, at least from its description and development history. We even check for comment ranges and avoid a fix entirely if comments are present, so let&#x27;s hold off on this for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-06 19:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dscorbett">@dscorbett</a> on <code>crates/ruff_linter/src/rules/pylint/rules/nested_min_max.rs</code>:31 on 2025-05-06 20:25</div>
            <div class="timeline-body"><p>The <code>min</code> fix is unsafe when <code>__lt__</code> is not commutative. The <code>max</code> fix is unsafe when <code>__gt__</code> is not commutative.</p>
<pre><code>$ cat &gt;plw3301.py &lt;&lt;&#x27;# EOF&#x27;
print(min(2.0, min(float(&quot;nan&quot;), 1.0)))
print(max(1.0, max(float(&quot;nan&quot;), 2.0)))
# EOF

$ python plw3301.py
2.0
1.0

$ ruff check --isolated --select PLW3301 plw3301.py --unsafe-fixes --fix
Found 2 errors (2 fixed, 0 remaining).

$ python plw3301.py
1.0
2.0
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dscorbett">@dscorbett</a> reviewed on 2025-05-06 20:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/yunchipang">@yunchipang</a> reviewed on 2025-05-06 23:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/yunchipang">@yunchipang</a> on <code>crates/ruff_linter/src/rules/pylint/rules/nested_min_max.rs</code>:31 on 2025-05-06 23:45</div>
            <div class="timeline-body"><p>@ntBre @dscorbett thanks so much for the input! I&#x27;ve updated the docs, though I&#x27;m not exactly sure, referencing the above case, is this rule always or sometimes unsafe? In general, what&#x27;s makes a rule always/sometimes unsafe?</p>
<p>thanks a lot.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pylint/rules/nested_min_max.rs</code>:28 on 2025-05-07 18:24</div>
            <div class="timeline-body"><pre><code>/// print(min(2.0, float(&quot;nan&quot;), 1.0))      # after fix: 1.0
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pylint/rules/nested_min_max.rs</code>:31 on 2025-05-07 18:25</div>
            <div class="timeline-body"><pre><code>/// print(max(1.0, float(&quot;nan&quot;), 2.0))      # after fix: 2.0
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pylint/rules/nested_min_max.rs</code>:25 on 2025-05-07 18:27</div>
            <div class="timeline-body"><p>I&#x27;d probably phrase this more like</p>
<blockquote>
<p>This fix is always unsafe because it can change the program&#x27;s behavior in cases where the underlying dunder methods (<code>__lt__</code> for <code>min</code> and <code>__gt__</code> for <code>max</code>) are not commutative, as is the case for floats, for example:</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-07 18:28</div>
            <div class="timeline-body"><p>Thanks, this is looking good.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-07 18:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pylint/rules/nested_min_max.rs</code>:31 on 2025-05-07 18:30</div>
            <div class="timeline-body"><p>Ah great catch as always, @dscorbett! I was hoping you might see this one.</p>
<p>I may have mentioned this on another PR, but the way I check for safety is to search the file for <code>safe_edit</code>. If you find cases of <code>Fix::safe_edit</code> <em>and</em> <code>Fix::unsafe_edit</code>, then the rule is sometimes safe. If you only find <code>Fix::unsafe_edit</code>, as I believe is the case here, the rule is always unsafe. You&#x27;ll have to be slightly more careful with your search range in files with multiple rules, but the general strategy still applies.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dscorbett">@dscorbett</a> reviewed on 2025-05-07 18:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dscorbett">@dscorbett</a> on <code>crates/ruff_linter/src/rules/pylint/rules/nested_min_max.rs</code>:25 on 2025-05-07 18:55</div>
            <div class="timeline-body"><p>“Commutative” is the wrong word: I meant “associative”. Sorry for the confusion. Actually, I’m not sure associativity is precisely what is necessary and sufficient here. It’s probably best to avoid the technical jargon unless someone proves it’s correct.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/yunchipang">@yunchipang</a> on 2025-05-07 23:46</div>
            <div class="timeline-body"><p>@nefrob @dscorbett thanks for the reviews! I’ve adjusted the wording slightly based on my understanding—hope it’s clearer and aligns with the intent. Let me know if there’s any part that could be further improved!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-09 20:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pylint/rules/nested_min_max.rs</code>:27 on 2025-05-09 20:57</div>
            <div class="timeline-body"><pre><code>/// This fix is always unsafe and may change the program&#x27;s behavior for
/// types without full equivalence relations, such as float comparisons involving `NaN`.
</code></pre>
<p>I <em>think</em> associativity is the correct property, but this is another possibility that I borrowed from the Rust <a href="https://doc.rust-lang.org/std/cmp/trait.PartialEq.html"><code>PartialEq</code></a> docs. I think we could also phrase it as &quot;types without a total ordering&quot; or something. Maybe associative is close enough to stick with that :sweat_smile:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/ntBre">@ntBre</a> by <a href="https://github.com/yunchipang">@yunchipang</a> on 2025-05-09 21:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-05-12 20:34</div>
            <div class="timeline-body"><p>Looks good, thanks! I just pushed one small change putting the section back at the end.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-12 20:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-12 20:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-05-12 21:34</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:14:05 UTC
    </footer>
</body>
</html>
