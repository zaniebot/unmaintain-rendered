<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Jupyter Notebook document change snapshot test - astral-sh/ruff #11944</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add Jupyter Notebook document change snapshot test</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11944">#11944</a>
        opened by <a href="https://github.com/snowsignal">@snowsignal</a>
        on 2024-06-20 01:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-06-20 01:37</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Closes #11914.</p>
<p>This PR introduces a snapshot test that replays the LSP requests made during a document formatting request, and confirms that the notebook document is updated in the expected way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @snowsignal on 2024-06-20 01:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by @snowsignal on 2024-06-20 01:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Ruff Server: Stable" by @snowsignal on 2024-06-20 01:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @snowsignal on 2024-06-20 01:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-06-20 01:58</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/tests/notebook.rs</code>:14 on 2024-06-20 06:41</div>
            <div class="timeline-body"><p>Can we use a more generic name for the notebook. For some reason, my brain tries to give meaning to the notebook name (e.g. that it is relevant for this specific test case) where I think it isn't. Maybe just <code>test_notebook.ipynb</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/tests/snapshots/notebook__changed_notebook.snap</code>:5 on 2024-06-20 07:10</div>
            <div class="timeline-body"><p>Would it make sense in your view to instead render a visual representation of the notebook (by e.g. calling <code>to_string()</code> instead of snapshoting all internal fields? Snapshoting all fields seems brittle to internal changes of the notebook (which is exactly when we want to ensure that we didn't break anything, but the tests all change in that case, and become useless)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-06-20 07:11</div>
            <div class="timeline-body"><p>What I like about the snapshot tests is that they're in the <code>ruff-server</code> crate. That means, we dont' need to update <code>ruff-server</code> in the <code>ruff-vscode</code> repository to see if the tests are passing.</p>
<p>What makes me worried about this kind of tests is that they encode our understanding of the LSP protocol and directly call into low level functionalities, which makes them brittle to changes and requires exposing internals.</p>
<p>I think my ideal setup would be that we have a way to record LSP messages. This doesn't have to be automated. I'm fine copying those messages from the tracing panel for now.</p>
<blockquote>
<p>To fully capture LSP messages between the editor and the server, set &quot;rust-analyzer.trace.server&quot;: &quot;verbose&quot; config and check Output &gt; Rust Analyzer Language Server Trace.</p>
</blockquote>
<p>The second piece in the puzzle would be a test-runner that reads all the messages from the input file and passes them to the server. But I don't know how complicated it is to build a test bed like this. I think there's some complication involved once the server needs to respond to client requests because it then becomes necessary to map the requests?</p>
<p>An alternative to this is to rely on VS code directly. It's unclear how we would run such tests in CI, especially as part of the ruff repository but it would give us the best coverage. See https://github.com/prettier/prettier-vscode/blob/main/CONTRIBUTING.md</p>
<p>I'm okay merging this specific test but I think I'm hesitant of adding too many &quot;hand crafted&quot; tests that snapshot internal data structures because they encode our LSP understanding and will break whenever we make changes to the internal representation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/tests/notebook.rs</code>:44 on 2024-06-20 08:02</div>
            <div class="timeline-body"><p>What's the process of ensuring that any changes in the actual notebook is being reflected here? I assume it needs to be manually updated so it might be useful for a future developer to provide a brief documentation on how to update them.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/resources/test/fixtures/super_resolution_overview.ipynb</code>:1 on 2024-06-20 08:04</div>
            <div class="timeline-body"><p>I think it will be more useful to have minimal code in the Notebook (could be hand-written) as the test is about whether the edits are correct. This will make it quicker to verify whether the ranges of the edits themselves are correct or not. Otherwise, a developer might need to read the notebook and extract the relevant ranges to make sure the updates are in the correct place.</p>
<p>An example notebook would be around 3-5 cells mixed with markdown cells where some cells would need formatting while others don't. The number of lines doesn't really matter.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2024-06-20 08:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-06-20 18:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/tests/snapshots/notebook__changed_notebook.snap</code>:5 on 2024-06-20 18:35</div>
            <div class="timeline-body"><p>I'm fine with that! It's probably easier to understand a diff like that, too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-06-20 18:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/tests/notebook.rs</code>:44 on 2024-06-20 18:36</div>
            <div class="timeline-body"><p>These changes were copied over from custom traces I had set up temporarily in the server. It's far from ideal, but I can add some documentation on how I went about it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-06-20 18:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/resources/test/fixtures/super_resolution_overview.ipynb</code>:1 on 2024-06-20 18:37</div>
            <div class="timeline-body"><p>For this snapshot I wanted a 'real world' test case, and one that comes from performing an operation that can easily be replicated (running a full-document format). For future notebook snapshots I think what you suggested makes sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-06-20 18:42</div>
            <div class="timeline-body"><blockquote>
<p>I think my ideal setup would be that we have a way to record LSP messages. This doesn't have to be automated. I'm fine copying those messages from the tracing panel for now.</p>
</blockquote>
<p>@MichaReiser I agree completely - I eventually want to have a system in place that can fully capture the back-and-forth with VS Code and build snapshot tests automatically.</p>
<blockquote>
<p>The second piece in the puzzle would be a test-runner that reads all the messages from the input file and passes them to the server. But I don't know how complicated it is to build a test bed like this. I think there's some complication involved once the server needs to respond to client requests because it then becomes necessary to map the requests?</p>
</blockquote>
<p>Mapping requests shouldn't be too hard since they have IDs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-06-21 05:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/tests/notebook.rs</code>:44 on 2024-06-21 05:10</div>
            <div class="timeline-body"><p>Thank you. No need to go into too much detail, some high level instructions are fine. It can be done as a follow-up as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-06-21 05:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/tests/notebook.rs</code>:44 on 2024-06-21 05:26</div>
            <div class="timeline-body"><p>I'll do this as a follow-up, then!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @snowsignal on 2024-06-21 05:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @snowsignal on 2024-06-21 05:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-06-21 05:29</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 21:56:33 UTC
    </footer>
</body>
</html>
