<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Respect `fmt: skip` for compound statements on single line - astral-sh/ruff #20633</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Respect <code>fmt: skip</code> for compound statements on single line</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20633">#20633</a>
        opened by <a href="https://github.com/dylwil3">@dylwil3</a>
        on 2025-09-29 17:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-09-29 17:20</div>
            <div class="timeline-body"><p>Closes #11216</p>
<p>Essentially the approach is to implement <code>Format</code> for a new struct <code>FormatClause</code> which is just a clause header <em>and</em> its body. We then have the information we need to see whether there is a skip suppression comment on the last child in the body and it all fits on one line.</p>
<p>The <code>ruff</code> test fixture (credit: mostly created by Claude) contains several lines that seem to crash <code>black</code>, see:</p>
<ul>
<li>https://github.com/psf/black/issues/4782</li>
<li>https://github.com/psf/black/issues/4781</li>
</ul>
<p>and another line containing a deviation that I <em>think</em> is unintentional for <code>black</code>, see:</p>
<ul>
<li>https://github.com/psf/black/issues/4783</li>
</ul>
<p>However, it's not clear whether we want the same behavior here? In this PR we have:</p>
<pre><code class="language-python">if True: print(&quot;this&quot;); print(&quot;that&quot;) # fmt: skip
</code></pre>
<p>unchanged, but we <em>do</em> add a newline between the statements here (unlike Black):</p>
<pre><code class="language-python">print(&quot;this&quot;); print(&quot;that&quot;) # fmt: skip
</code></pre>
<p>(see https://github.com/astral-sh/ruff/issues/11430 and https://github.com/astral-sh/ruff/issues/17331 .)</p>
<p>The other deviation from <code>black</code> is that we format the placement of the skip comment itself.</p>
<p>For review, it is simplest to go commit by commit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dylwil3 on 2025-09-29 17:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @dylwil3 on 2025-09-29 17:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @dylwil3 on 2025-09-29 17:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-29 17:28</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Formatter (stable)</h3>
<p>âœ… ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>âœ… ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-10-06 20:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_formatter/src/statement/clause.rs</code>:483 on 2025-10-06 20:43</div>
            <div class="timeline-body"><p>We no longer use <code>clause_body</code>, but we do use <code>clause_header</code> alone in one place - the formatting of <code>match</code> statements. Unlike match <em>cases</em>, I don't think it is legal to have an entire match statement lie on a single line, so it's okay that we don't handle that here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dylwil3 on 2025-10-06 20:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dylwil3 on 2025-10-06 20:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-07 07:59</div>
            <div class="timeline-body"><blockquote>
<p>unchanged, but we do add a newline between the statements here (unlike Black):</p>
<pre><code class="language-py">print(&quot;this&quot;); print(&quot;that&quot;) # fmt: skip
</code></pre>
</blockquote>
<p>This seems unrelated to this PR as it is a pre-existing issue, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/preview.rs</code>:43 on 2025-10-07 08:01</div>
            <div class="timeline-body"><p>Is the reason for gating this behind preview that we're concerned about bugs or are there cases where it can change existing formatted code?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/clause.rs</code>:41 on 2025-10-07 08:02</div>
            <div class="timeline-body"><p>Nit: I prefer to have those &quot;helper&quot; trait implementations after the types own <code>impl</code> block as the latter seems more important to the type</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/clause.rs</code>:70 on 2025-10-07 08:04</div>
            <div class="timeline-body"><p>I find this comment slightly confusing. Are you asking me to compare with <code>last_child_in_body</code> and spot the differences? ðŸ˜†</p>
<p>I assume this is the same as <code>last_child_in_body</code> but specific and limited to clause headers</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/clause.rs</code>:84 on 2025-10-07 08:05</div>
            <div class="timeline-body"><p>Nit, similar to <code>last_child_in_body</code></p>
<pre><code class="language-suggestion">            ClauseHeader::Class(StmtClassDef { body, .. }) 
            | ClauseHeader::Function(StmtFunctionDef { body, .. }) 
            | ClauseHeader::If(StmtIf { body, .. }) 
            | ClauseHeader::ElifElse(ElifElseClause { body, .. }) 
            | ClauseHeader::Try(StmtTry { body, .. }) 
            | 
            ClauseHeader::ExceptHandler(ExceptHandlerExceptHandler { body, .. }) =&gt; {
                body.last().map(AnyNodeRef::from)
            }
</code></pre>
<p>Same for other branches that are over <code>&amp;[Stmt]</code> and return the last element. It makes it easier for readers to see which branches are the same</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/clause.rs</code>:743 on 2025-10-07 08:09</div>
            <div class="timeline-body"><p>I was confused for a second because I wondered: what about multiline clause headers that are suppressed by a <code>fmt: skip</code>? But that's handled by <code>clause_header</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/clause.rs</code>:683 on 2025-10-07 08:10</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    let clause_start = header.first_keyword_range(f.context().source())?.start();

    let comments = f.context().comments().clone();

    let last_child = header
        .last_child_in_clause()
        .expect(&quot;last child to exist if `should_suppress_clause` is `Ok(true)`&quot;);
    let clause_end = last_child.end();
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/clause.rs</code>:775 on 2025-10-07 08:13</div>
            <div class="timeline-body"><p>I think this is correct but an explanation why this is correct might be useful.</p>
<ul>
<li>What happens with the leading comments of the clause headers?</li>
<li>What about dangling comments (I think they're fine because a clause header with dangling comments is always guaranteed to be multiline</li>
<li>What about trailing clause comments?</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_class_def.rs</code>:136 on 2025-10-07 08:14</div>
            <div class="timeline-body"><p>Can we derive the <code>SuiteKind</code> from the <code>ClauseHeader</code> to reduce the number of arguments?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/clause.rs</code>:537 on 2025-10-07 08:16</div>
            <div class="timeline-body"><p>It seems that <code>trailing_colon_comment</code> and <code>trailing_comments</code> are the same for all call sites.</p>
<pre><code class="language-suggestion">    header_formatter: &amp;'a Content,
    trailing_colon_comments: &amp;'a [SourceComment],
    body: &amp;'a Suite,
    kind: SuiteKind,
</code></pre>
<p>I'd also flip the <code>header</code> and <code>trailing_colon</code> arguments as it matches the formatting order more closely:</p>
<pre><code>&lt;clause_header&gt;: &lt;trailing_colon_comments&gt;
	&lt;body&gt;
``
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/snapshots/format@fmt_skip__compound_one_liners.py.snap</code>:26 on 2025-10-07 08:20</div>
            <div class="timeline-body"><p>Change it to something that would format differently to demonstrate that this doesn't break normal <code>fmt: skip</code> behavior</p>
<pre><code class="language-suggestion">    y  =  2  # fmt: skip
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/snapshots/format@fmt_skip__compound_one_liners.py.snap</code>:156 on 2025-10-07 08:22</div>
            <div class="timeline-body"><p>What about:</p>
<pre><code class="language-py">if (
	long_condition
):  a     +     b # fmt: skip
</code></pre>
<p>I would expect that this doesn't get formatted according to how <code>fmt:skip</code>s semantic is defined.</p>
<p>I don't expect this to be hard to support. It might be as easy as only changing the <code>countains_line_break</code> check to only test from <code>:</code> to the end of the clause</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/snapshots/format@fmt_skip__compound_one_liners.py.snap</code>:208 on 2025-10-07 08:24</div>
            <div class="timeline-body"><p>Let's add a few more test cases with different comment placements</p>
<pre><code class="language-suggestion">try: risky_operation()  # fmt: skip
# leading 1
except ValueError: handle_error()  # fmt: skip
# leading 2
except: handle_any_error()  # fmt: skip
# leading 3
else: success_case()  # fmt: skip
# leading 4
finally: cleanup()  # fmt: skip
# trailing
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-07 08:24</div>
            <div class="timeline-body"><p>This is great :) I suggest adding a few more tests with different comment placements. Just to make sure we handle them correctly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-10-20 20:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_formatter/src/statement/clause.rs</code>:70 on 2025-10-20 20:03</div>
            <div class="timeline-body"><p>Changed. (Maybe this is an academia thing but I'm used to &quot;compare&quot; sometimes meaning &quot;see also&quot;.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-10-20 20:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_formatter/tests/snapshots/format@fmt_skip__compound_one_liners.py.snap</code>:208 on 2025-10-20 20:07</div>
            <div class="timeline-body"><p>This was tricky! It has dangling comments.</p>
<p>But I think I figured it out: <code>clause_header</code> has us pass in optional leading comments and I wasn't handling those in the suppressed version of writing <code>clause</code>. (The correct transformation of dangling comments to leading comments happens inside the implementation of formatting for <code>StmtTry</code>, where they are passed in this way to <code>clause</code>.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-10-20 20:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_formatter/src/statement/stmt_class_def.rs</code>:136 on 2025-10-20 20:19</div>
            <div class="timeline-body"><p>I don't think so because I think we have to be told whether we're the last suite in the statement (but I think that's the only missing info)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-10-20 20:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_formatter/src/preview.rs</code>:43 on 2025-10-20 20:29</div>
            <div class="timeline-body"><p>removed gating</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-10-24 17:40</div>
            <div class="timeline-body"><p>The CI failure here https://github.com/astral-sh/ruff/actions/runs/18664070057/job/53211233008?pr=20633 was caused by this PR uncovering a pre-existing bug. See #21065 and #21067 . Will rebase once that PR is merged and then continue working on this!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @dylwil3 on 2025-10-27 16:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-10-27 20:56</div>
            <div class="timeline-body"><p>Cut down a comment-related hydra head and more grew in its place. This snippet causes a panic because the indented comment is not marked as formatted. Annoyingly it is attached to <code>bar()</code> (because there is no <code>orelse</code> node).</p>
<pre><code class="language-python">for x in it: foo()
    # comment
else: bar() # fmt: skip
</code></pre>
<p>Converting to draft while I sort it out ðŸ˜„</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> removed by @dylwil3 on 2025-11-10 22:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_formatter/src/statement/clause.rs</code>:775 on 2025-11-17 16:45</div>
            <div class="timeline-body"><p>Added handling for comments in headers (turns out they can happen now because of a change we made during the course of this code review - we allow multiline headers, it's only the range starting from the colon that has to be on one line). Also clarified in comment how leading and trailing comments are handled.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-11-17 16:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dylwil3 on 2025-11-17 16:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dylwil3 on 2025-11-17 16:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/clause.rs</code>:537 on 2025-11-18 09:52</div>
            <div class="timeline-body"><p>Nit: I think I'd store the data here rather than the formatters and construct the formatters on the fly in <code>fmt</code></p>
<pre><code class="language-suggestion">    header: ClauseHeader&lt;'a&gt;,
    header_formatter: &amp;'a Content,
    leading_comments: &amp;'a [SourceComment],
    trailing_colon_comment: &amp;'a [SourceComment],
    body: &amp;'a Suite,
    kind: SuiteKind,
</code></pre>
<p>Mainly because it avoids storing the <code>trailing_comments</code> twice, we only construct the formatters when necessary, and expressions like <code>clause.format_header.header.last_child_in_clause()</code> require a little less drilling (becomes <code>clause.header.last_child_in_clause()</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/clause.rs</code>:739 on 2025-11-18 09:56</div>
            <div class="timeline-body"><p>I don't understand this comment. What are we <code>recalling</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/clause.rs</code>:759 on 2025-11-18 09:58</div>
            <div class="timeline-body"><p>You could consider changing <code>should_suppress_clause</code> to return an enum</p>
<pre><code class="language-rust">enum SuppressClauseHeader&lt;'a&gt; {
	No,
	Yes { last_child: AnyNodeRef&lt;'a&gt; }
}
</code></pre>
<p>But I don't think either's fine really</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-11-18 09:58</div>
            <div class="timeline-body"><p>Nice</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-11-18 17:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_formatter/src/statement/clause.rs</code>:739 on 2025-11-18 17:54</div>
            <div class="timeline-body"><p>I meant the line above where we did an early return, but I think the comment didn't add much so I just removed it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-11-18 17:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_formatter/src/statement/clause.rs</code>:537 on 2025-11-18 17:54</div>
            <div class="timeline-body"><p>Done, good idea!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-11-18 17:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_formatter/src/statement/clause.rs</code>:759 on 2025-11-18 17:54</div>
            <div class="timeline-body"><p>Done!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dylwil3 on 2025-11-18 18:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dylwil3 on 2025-11-18 18:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-11-18 18:02</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:48:26 UTC
    </footer>
</body>
</html>
