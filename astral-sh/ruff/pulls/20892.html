<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto-accept snapshot changes as part of typeshed-sync PRs - astral-sh/ruff #20892</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Auto-accept snapshot changes as part of typeshed-sync PRs</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20892">#20892</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-10-15 13:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Some of our ty snapshots (in particular, several in the <code>ty_ide</code> crate that relate to autocompletions) are very sensitive to changes in typeshed. If typeshed changes the line number a class or function is defined on, that often leads to the snapshots in <code>ty_ide</code> needing to be updated manually before a typeshed-sync PR can be merged, which is a bit of a pain.</p>
<p>This PR adds a step to the <code>sync_typeshed.yaml</code> workflow that checks for changes to snapshots and automatically accepts them all before the PR is made. This should hopefully reduce the number of changes we need to make manually to sync-typeshed PRs. (We'll still need to review these PRs carefully to check that all the changes to the snapshots are <em>desirable</em>, but I still think that this will probably save us time overall.) The step is allowed to fail; if checking for changes to snapshots produces a nonzero exit code, the sync-typeshed PR should still be filed.</p>
<p>The <code>cargo insta</code> docs are here: https://insta.rs/docs/cli/</p>
<h2>Test Plan</h2>
<p>I:</p>
<ol>
<li>Ran <code>git checkout dc64c086336148c57db14060c86f448351710b2e -- crates/ty_python_semantic/resources/mdtest/snapshots</code>. This reverted all the snapshot changes from https://github.com/astral-sh/ruff/pull/20820, a PR which resulted in lots of snapshot changes -- multiple snapshot changes per mdtest file, in some cases.</li>
<li>Ran <code>cargo insta test --accept</code>. I observed that this command reverted all changes from step (1).</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-10-15 13:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ci</span> added by @AlexWaygood on 2025-10-15 13:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-10-15 13:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-10-15 14:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @AlexWaygood on 2025-10-15 14:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-15 14:34</div>
            <div class="timeline-body"><p>I don't know why the Ruff ecosystem job is repeatedly failing on this PR (I tried rerunning it), but it seems unrelated.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> approved on 2025-10-15 14:47</div>
            <div class="timeline-body"><p>Awesome idea.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-15 14:57</div>
            <div class="timeline-body"><p>I kicked off a test run here using this branch: https://github.com/astral-sh/ruff/actions/runs/18533177734</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-15 16:37</div>
            <div class="timeline-body"><blockquote>
<p>I kicked off a test run here using this branch: <a href="https://github.com/astral-sh/ruff/actions/runs/18533177734">astral-sh/ruff/actions/runs/18533177734</a></p>
</blockquote>
<p>It took a few iterations but I think it all looks good now:</p>
<ul>
<li>Workflow run: https://github.com/astral-sh/ruff/actions/runs/18535425113</li>
<li>PR: https://github.com/astral-sh/ruff/pull/20899</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-10-15 16:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-10-15 16:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-10-15 16:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-15 14:26</div>
            <div class="timeline-body"><p>It doesn't look this worked, but I don't really understand why :/</p>
<p>The typeshed sync workflow last night ran the full test suite, and I can see snapshot tests failing as part of the run. But no snapshot changes were accepted afterwards; it just says</p>
<blockquote>
<p>error: test run failed</p>
</blockquote>
<p>https://github.com/astral-sh/ruff/actions/runs/19381406943/job/55460969374</p>
<p>I've tried running the same command locally with the same environment variables set, and it always results in snapshots being updated at the end of the run. Not sure what's up here.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:16:27 UTC
    </footer>
</body>
</html>
