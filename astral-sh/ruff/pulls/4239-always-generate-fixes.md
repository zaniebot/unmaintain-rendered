```yaml
number: 4239
title: Always generate fixes
type: pull_request
state: merged
author: MichaReiser
labels: []
assignees: []
merged: true
base: main
head: remove-autofix-mode
created_at: 2023-05-05T09:51:20Z
updated_at: 2023-05-10T07:06:17Z
url: https://github.com/astral-sh/ruff/pull/4239
synced_at: 2026-01-12T03:56:39Z
```

# Always generate fixes

---

_Pull request opened by @MichaReiser on 2023-05-05 09:51_

This PR removes `autofx` and instead always generates the fixes. This allows us to rely on `fix.is_empty` (or `fix.is_some` after #4198) to determine whether a violation is fixable. 

This will also allow us to always render the fix suggestions in the future. 

I fixed a few violations that incorrectly returned an autofix title even when the violation wasn't fixable or the other way around. 

## Are you sure?

Not entirely. Having the functionality to conditionally generate `Fix`es seems useful. For example, we could avoid generating fixes when we've seen a suppression comment, or if we've seen a large number of `Diagnostic`s and aren't running in verbose mode. I think we can still support this by consistently using `checker.patch` or refactor our rules into two: 

* Part 1: Generates the `Violations`
* Part 2: Creates the fixes (code actions) when necessary

This would have the added advantage that code authors don't need to know when to emit fixes (not as today) and are instead guided by the infrastructure/API.

## Performance

This change slightly regresses performance for projects with many (500k) diagnostics. 

| Command | Mean [ms] | Min [ms] | Max [ms] | Relative |
|:---|---:|---:|---:|---:|
| `./target/release/ruff ./crates/ruff/resources/test/cpython/ -e --no-cache  ` | 220.9 Â± 3.2 | 216.8 | 226.8 | 1.15 Â± 0.03 |
| `./ruff-main ./crates/ruff/resources/test/cpython/ -e --no-cache  ` | 221.1 Â± 3.5 | 216.3 | 226.5 | 1.15 Â± 0.03 |
| `./target/release/ruff ./crates/ruff/resources/test/cpython/ -e --no-cache --select=ALL ` | 1544.1 Â± 27.6 | 1492.2 | 1586.2 | 8.04 Â± 0.23 |
| `./ruff-main ./crates/ruff/resources/test/cpython/ -e --no-cache --select=ALL ` | 1482.7 Â± 22.2 | 1454.3 | 1529.2 | 7.72 Â± 0.21 |
| `./target/release/ruff ./crates/ruff/resources/test/cpython/ -e --no-cache   -s` | 192.1 Â± 4.4 | 185.0 | 200.0 | 1.00 |
| `./ruff-main ./crates/ruff/resources/test/cpython/ -e --no-cache   -s` | 193.7 Â± 10.2 | 187.3 | 228.7 | 1.01 Â± 0.06 |
| `./target/release/ruff ./crates/ruff/resources/test/cpython/ -e --no-cache --select=ALL  -s` | 1302.3 Â± 25.2 | 1262.6 | 1334.4 | 6.78 Â± 0.20 |
| `./ruff-main ./crates/ruff/resources/test/cpython/ -e --no-cache --select=ALL  -s` | 1241.5 Â± 20.3 | 1220.6 | 1280.7 | 6.46 Â± 0.18 |


---

_Comment by @MichaReiser on 2023-05-05 09:51_

Current dependencies on/for this PR:
* main
  * **PR #4239** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4239" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #4245** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4245" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #4191** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4191" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #4192** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4192" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #4193** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4193" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/charliermarsh/ruff/4239?utm_source=stack-comment).

---

_Converted to draft by @MichaReiser on 2023-05-05 10:22_

---

_Comment by @github-actions[bot] on 2023-05-05 10:24_

## PR Check Results
### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     18.7Â±0.95ms     2.2 MB/sec    1.02     19.1Â±0.57ms     2.1 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.2Â±0.18ms     3.9 MB/sec    1.06      4.5Â±0.29ms     3.7 MB/sec
linter/all-rules/numpy/globals.py          1.02   564.2Â±31.20Âµs     5.2 MB/sec    1.00   553.9Â±19.50Âµs     5.3 MB/sec
linter/all-rules/pydantic/types.py         1.01      7.6Â±0.27ms     3.4 MB/sec    1.00      7.5Â±0.27ms     3.4 MB/sec
linter/default-rules/large/dataset.py      1.00      9.1Â±0.41ms     4.5 MB/sec    1.03      9.4Â±0.35ms     4.3 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1918.4Â±58.12Âµs     8.7 MB/sec    1.02  1965.9Â±90.87Âµs     8.5 MB/sec
linter/default-rules/numpy/globals.py      1.00    226.4Â±9.84Âµs    13.0 MB/sec    1.03   234.0Â±10.16Âµs    12.6 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.8Â±0.14ms     6.6 MB/sec    1.07      4.1Â±0.14ms     6.2 MB/sec
parser/large/dataset.py                    1.02      7.2Â±0.15ms     5.7 MB/sec    1.00      7.0Â±0.25ms     5.8 MB/sec
parser/numpy/ctypeslib.py                  1.02  1418.7Â±53.10Âµs    11.7 MB/sec    1.00  1387.0Â±57.77Âµs    12.0 MB/sec
parser/numpy/globals.py                    1.03    137.2Â±5.73Âµs    21.5 MB/sec    1.00    133.7Â±5.04Âµs    22.1 MB/sec
parser/pydantic/types.py                   1.00      3.1Â±0.10ms     8.3 MB/sec    1.00      3.1Â±0.12ms     8.3 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     16.5Â±0.09ms     2.5 MB/sec    1.00     16.5Â±0.05ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.2Â±0.03ms     3.9 MB/sec    1.00      4.2Â±0.02ms     3.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    431.2Â±3.50Âµs     6.8 MB/sec    1.00    430.6Â±7.69Âµs     6.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.1Â±0.02ms     3.6 MB/sec    1.00      7.1Â±0.02ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.00      8.4Â±0.03ms     4.8 MB/sec    1.00      8.4Â±0.03ms     4.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1780.2Â±7.94Âµs     9.4 MB/sec    1.01   1799.6Â±8.15Âµs     9.3 MB/sec
linter/default-rules/numpy/globals.py      1.00    191.6Â±1.28Âµs    15.4 MB/sec    1.02   195.6Â±14.79Âµs    15.1 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.8Â±0.02ms     6.7 MB/sec    1.00      3.8Â±0.02ms     6.7 MB/sec
parser/large/dataset.py                    1.00      6.8Â±0.03ms     6.0 MB/sec    1.00      6.8Â±0.02ms     6.0 MB/sec
parser/numpy/ctypeslib.py                  1.01   1294.2Â±6.58Âµs    12.9 MB/sec    1.00   1281.7Â±9.87Âµs    13.0 MB/sec
parser/numpy/globals.py                    1.01    134.1Â±0.92Âµs    22.0 MB/sec    1.00    132.5Â±0.84Âµs    22.3 MB/sec
parser/pydantic/types.py                   1.01      2.9Â±0.01ms     8.9 MB/sec    1.00      2.8Â±0.01ms     9.0 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_@MichaReiser reviewed on 2023-05-05 12:04_

---

_Review comment by @MichaReiser on `crates/ruff/src/test.rs`:148 on 2023-05-05 12:04_

This should help us in the future to keep the metadata up to date

---

_Marked ready for review by @MichaReiser on 2023-05-05 12:10_

---

_@konstin approved on 2023-05-08 08:00_

---

_Comment by @konstin on 2023-05-08 08:20_

I manually checked bokeh with `--select ALL` which generates a lot of fixes and got only insignificant differences in the benchmarks

---

_Review requested from @charliermarsh by @MichaReiser on 2023-05-09 06:08_

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/pyupgrade/rules/format_literals.rs`:20 on 2023-05-09 15:36_

For all these rules that changed from `AlwaysAutofixableViolation` to `Violation`, should this not be `AutofixKind::Always`?

---

_@charliermarsh reviewed on 2023-05-09 15:36_

---

_@charliermarsh reviewed on 2023-05-09 15:37_

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/flake8_pytest_style/rules/parametrize.rs`:5 on 2023-05-09 15:37_

Can this trait be removed entirely?

---

_@MichaReiser reviewed on 2023-05-09 15:41_

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/pyupgrade/rules/format_literals.rs`:20 on 2023-05-09 15:41_

I only changed the rules to Violation, because they don't always provide a fix (I found out about this by the added assertions in the tests). That's why Sometimes is correct(or we have to change the implementation to always emit a fix)

---

_@MichaReiser reviewed on 2023-05-09 15:41_

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/flake8_pytest_style/rules/parametrize.rs`:5 on 2023-05-09 15:41_

We still need it for fixes that always generate an autofix.

---

_@charliermarsh approved on 2023-05-09 15:44_

I'm also torn on this but ultimately it seems like the right change.

The current state of affairs leads to some confusing user experiences, since in some cases we can't know for sure whether an issue is fixable unless we try to fix it. Similarly, we rely on the rule-level fixability rather than checking whether "This violation has a fix", which causes problems like in #3273 (which I believe is closed with this issue).

While there is a performance hit, it's within the realm of "reasonable", and most projects have fewer diagnostics anyway.


---

_@charliermarsh reviewed on 2023-05-09 15:45_

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/pyupgrade/rules/format_literals.rs`:20 on 2023-05-09 15:45_

Ahh right right. I didn't realize that.

---

_Comment by @MichaReiser on 2023-05-09 16:25_

> The current state of affairs leads to some confusing user experiences, since in some cases we can't know for sure whether an issue is fixable unless we try to fix it. Similarly, we rely on the rule-level fixability rather than checking whether "This violation has a fix", which causes problems like in https://github.com/charliermarsh/ruff/issues/3273 (which I believe is closed with this issue).

I think we should always generate fixes if we want to display fixes in some way (that includes a fixable indicator). We could decide to not generate fixes if we don't need them at all. E.g, when running with `--add-noqa` because we then never render nor use the fixes.

---

_Merged by @MichaReiser on 2023-05-10 07:06_

---

_Closed by @MichaReiser on 2023-05-10 07:06_

---

_Branch deleted on 2023-05-10 07:06_

---
