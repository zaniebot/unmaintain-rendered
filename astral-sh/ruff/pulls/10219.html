<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Move shell expansion into `--config` lookup - astral-sh/ruff #10219</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Move shell expansion into <code>--config</code> lookup</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10219">#10219</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-03-04 00:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>When users provide configurations via <code>--config</code>, we use <code>shellexpand</code> to ensure that we expand signifiers like <code>~</code> and environment variables.</p>
<p>In https://github.com/astral-sh/ruff/pull/9599, we modified <code>--config</code> to accept either a path or an arbitrary setting. However, the detection (to determine whether the value is a path or a setting) was lacking the <code>shellexpand</code> behavior -- it was downstream. So we were always treating paths like <code>~/ruff.toml</code> as values, not paths.</p>
<p>Closes https://github.com/astral-sh/ruff-vscode/issues/413.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-03-04 00:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by @charliermarsh on 2024-03-04 00:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @charliermarsh on 2024-03-04 00:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-03-04 02:08</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+0 -8 violations, +0 -0 fixes in 1 projects; 42 projects unchanged)</p>
<details><summary><a href="https://github.com/pandas-dev/pandas">pandas-dev/pandas</a> (+0 -8 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
- <a href='https://github.com/pandas-dev/pandas/blob/1bf86a35a56405e07291aec8e07bd5f7b8b6b748/pandas/core/internals/__init__.py#L21'>pandas/core/internals/__init__.py:21:5:</a> PLC0415 `import` should be at the top-level of a file
- <a href='https://github.com/pandas-dev/pandas/blob/1bf86a35a56405e07291aec8e07bd5f7b8b6b748/pandas/core/internals/__init__.py#L33'>pandas/core/internals/__init__.py:33:9:</a> PLC0415 `import` should be at the top-level of a file
- <a href='https://github.com/pandas-dev/pandas/blob/1bf86a35a56405e07291aec8e07bd5f7b8b6b748/pandas/core/internals/__init__.py#L37'>pandas/core/internals/__init__.py:37:16:</a> PLR6201 Use a `set` literal when testing for membership
- <a href='https://github.com/pandas-dev/pandas/blob/1bf86a35a56405e07291aec8e07bd5f7b8b6b748/pandas/core/internals/__init__.py#L53'>pandas/core/internals/__init__.py:53:13:</a> PLC0415 `import` should be at the top-level of a file
- <a href='https://github.com/pandas-dev/pandas/blob/1bf86a35a56405e07291aec8e07bd5f7b8b6b748/pandas/core/internals/__init__.py#L57'>pandas/core/internals/__init__.py:57:13:</a> PLC0415 `import` should be at the top-level of a file
- <a href='https://github.com/pandas-dev/pandas/blob/1bf86a35a56405e07291aec8e07bd5f7b8b6b748/pandas/core/internals/__init__.py#L61'>pandas/core/internals/__init__.py:61:13:</a> PLC0415 `import` should be at the top-level of a file
- <a href='https://github.com/pandas-dev/pandas/blob/1bf86a35a56405e07291aec8e07bd5f7b8b6b748/pandas/core/internals/__init__.py#L65'>pandas/core/internals/__init__.py:65:13:</a> PLC0415 `import` should be at the top-level of a file
- <a href='https://github.com/pandas-dev/pandas/blob/1bf86a35a56405e07291aec8e07bd5f7b8b6b748/pandas/core/internals/__init__.py#L69'>pandas/core/internals/__init__.py:69:13:</a> PLC0415 `import` should be at the top-level of a file
</pre>

</p>
</details>
<details><summary>Changes by rule (2 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PLC0415 | 7 | 0 | 7 | 0 | 0 |
| PLR6201 | 1 | 0 | 1 | 0 | 0 |</p>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff/tests/lint.rs</code>:1169 on 2024-03-04 09:49</div>
            <div class="timeline-body"><p>No need for the tempdir filter here -- the tempdir path doesn't appear in the stderr or stdout:</p>
<pre><code class="language-suggestion">    assert_cmd_snapshot!(Command::new(get_cargo_bin(BIN_NAME))
        .args(STDIN_BASE_OPTIONS)
        .arg(&quot;--config&quot;)
        .arg(&quot;${NAME}.toml&quot;)
        .env(&quot;NAME&quot;, &quot;ruff&quot;)
        .arg(&quot;-&quot;)
        .current_dir(tempdir.path())
        .pass_stdin(r#&quot;
import os

def func():
    x = 1
&quot;#), @r###&quot;
    success: false
    exit_code: 1
    ----- stdout -----
    -:2:8: F401 [*] `os` imported but unused
    Found 1 error.
    [*] 1 fixable with the `--fix` option.

    ----- stderr -----
    &quot;###);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/args.rs</code>:827 on 2024-03-04 09:51</div>
            <div class="timeline-body"><pre><code class="language-suggestion">            shellexpand::full(value).map(|config| PathBuf::from(&amp;config))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/args.rs</code>:815 on 2024-03-04 09:55</div>
            <div class="timeline-body"><p>What's the motivation for changing the ordering from path, value to value, path? Is it because <code>shellexpand</code> requires an UTF8 path?</p>
<p>True, it's an edge case but I think it might be worth falling back to normal paths if it's not valid UTF 8</p>
<pre><code>let Ok(value) = value.to_str() else {
  let path_to_config_file = PathBuf::from(value);
  if path_to_config_file.is_file() {
    return Ok(SingleConfigArgument::FilePath(path_to_config_file));
  }
  return Err(clap::error::ErrorKind::InvalidUtf8);
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-03-04 09:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cli</span> added by @MichaReiser on 2024-03-04 09:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> removed by @MichaReiser on 2024-03-04 09:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff/src/args.rs</code>:829 on 2024-03-04 10:00</div>
            <div class="timeline-body"><p>The error message on line 884/887 specifically complains to the user that the configuration path &quot;does not exist&quot;, but with this new logic, we're (correctly) checking that it's a <em>file</em> that exists as well as just checking that it exists. So maybe we should change that error message to something like</p>
<pre><code class="language-diff">diff --git a/crates/ruff/src/args.rs b/crates/ruff/src/args.rs
index 6c3e0f056..93f9ebe3e 100644
--- a/crates/ruff/src/args.rs
+++ b/crates/ruff/src/args.rs
@@ -884,7 +884,7 @@ A `--config` flag must either be a path to a `.toml` configuration file
                     &quot;
 
 It looks like you were trying to pass a path to a configuration file.
-The path `{value}` does not exist&quot;
+The path `{value}` does not point to a configuration file.&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-03-04 10:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-03-04 10:06</div>
            <div class="timeline-body"><p>Thanks for fixing -- sorry I missed this!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/args.rs</code>:827 on 2024-03-04 17:13</div>
            <div class="timeline-body"><p>You'll be surprised to learn that this doesn't work, because <code>config</code> is <code>Cow&lt;Xstr&gt;</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-04 17:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-03-04 17:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/args.rs</code>:827 on 2024-03-04 17:19</div>
            <div class="timeline-body"><p>You just need to find the right number of stars: Maybe <code>&amp;**config</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff/src/args.rs</code>:817 on 2024-03-04 17:26</div>
            <div class="timeline-body"><p>Worth adding a test with a non-UTF-8 path?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-03-04 17:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-03-04 17:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-03-04 17:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-03-04 17:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-04 17:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/args.rs</code>:817 on 2024-03-04 17:46</div>
            <div class="timeline-body"><p>I'm gonna defer it, I don't even know if Ruff as a whole will work with non-UTF-8 paths.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:02:58 UTC
    </footer>
</body>
</html>
