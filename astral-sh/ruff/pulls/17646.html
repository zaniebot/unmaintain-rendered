<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collect preview lint behaviors in separate module - astral-sh/ruff #17646</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Collect preview lint behaviors in separate module</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17646">#17646</a>
        opened by <a href="https://github.com/dylwil3">@dylwil3</a>
        on 2025-04-26 19:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a></div>
            <div class="timeline-body"><p>This PR collects all behavior gated under preview into a new module <code>ruff_linter::preview</code> that exposes functions like <code>is_my_new_feature_enabled</code> - just as is done in the formatter crate.</p>
<p>One thing I'd like to do before moving this out of draft is see if there is a way to enforce that <code>ruff_linter::rules</code> can never access the <code>preview</code> field in <code>LinterSettings</code>.</p>
<p>Here is one approach to this:</p>
<ul>
<li>Make the <code>preview</code> field private</li>
<li>Make a public trait like <code>QueryPreview</code> with one member <code>fn preview(&amp;self) -&gt; PreviewMode;</code>, then implement this member for <code>LinterSettings</code></li>
<li>Inside <code>ruff_linter::preview</code>, import the trait. But <em>don't</em> import it in <code>ruff_linter::rules</code></li>
</ul>
<p>The downside of this approach is that there are several places where we <em>initialize</em> <code>LinterSettings</code> by specifying all of its fields. So we'd have to change those to builder methods.</p>
<p>I would not be surprised if there is a simple and standard way to enforce the visibility I'm after, I just don't quite know which <code>pub(in ...)</code>, <code>pub(super)</code>, <code>pub(crate)</code>, etc. thing I should be doing that would basically make <code>preview</code> accessible everywhere <em>except</em> in <code>ruff_linter::rules</code>. Suggestions?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @dylwil3 on 2025-04-26 19:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-26 19:45</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-27 09:51</div>
            <div class="timeline-body"><p>You could probably do a <code>pub(in crate::preview)</code> but I'm not sure if we have to enforce this statically.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dylwil3 on 2025-04-27 20:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dylwil3 on 2025-04-27 20:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-04-27 20:43</div>
            <div class="timeline-body"><blockquote>
<p>You could probably do a pub(in crate::preview) but I'm not sure if we have to enforce this statically.</p>
</blockquote>
<p>Unfortunately that's not an allowed visibility (it has to be an ancestor module). But if you think it's okay to not enforce this statically, then I'm on board too!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @AlexWaygood on 2025-04-27 20:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/preview.rs</code>:14 on 2025-04-28 06:36</div>
            <div class="timeline-body"><p>Nit: It would be nice if each function had a link to the PR/issue that introduced/documents the new preview behavior.</p>
<p>Adding it now would mainly be nice to set a good example for future added preview features</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/preview.rs</code>:70 on 2025-04-28 06:37</div>
            <div class="timeline-body"><p>Nit, let's be more consistent with the empty lines between the functions</p>
<pre><code class="language-suggestion">pub(crate) const fn is_shell_injection_only_trusted_input_enabled(
    settings: &amp;LinterSettings,
) -&gt; bool {
    settings.preview.is_enabled()
}

pub(crate) const fn is_suspicious_function_reference_enabled(settings: &amp;LinterSettings) -&gt; bool {
    settings.preview.is_enabled()
}

pub(crate) const fn is_bool_subtype_of_annotation_enabled(settings: &amp;LinterSettings) -&gt; bool {
    settings.preview.is_enabled()
}

pub(crate) const fn is_comprehension_with_min_max_sum_enabled(settings: &amp;LinterSettings) -&gt; bool {
    settings.preview.is_enabled()
}

pub(crate) const fn is_check_comprehensions_in_tuple_call_enabled(
    settings: &amp;LinterSettings,
) -&gt; bool {
    settings.preview.is_enabled()
}

pub(crate) const fn is_bad_version_info_in_non_stub_enabled(settings: &amp;LinterSettings) -&gt; bool {
    settings.preview.is_enabled()
}

pub(crate) const fn is_fix_future_annotations_in_stub_enabled(settings: &amp;LinterSettings) -&gt; bool {
    settings.preview.is_enabled()
}

pub(crate) const fn is_only_add_return_none_at_end_enabled(settings: &amp;LinterSettings) -&gt; bool {
    settings.preview.is_enabled()
}

pub(crate) const fn is_simplify_ternary_to_binary_enabled(settings: &amp;LinterSettings) -&gt; bool {
    settings.preview.is_enabled()
}

pub(crate) const fn is_fix_manual_dict_comprehension_enabled(settings: &amp;LinterSettings) -&gt; bool {
    settings.preview.is_enabled()
}
pub(crate) const fn is_fix_manual_list_comprehension_enabled(settings: &amp;LinterSettings) -&gt; bool {
    settings.preview.is_enabled()
}

pub(crate) const fn is_dunder_init_fix_unused_import_enabled(settings: &amp;LinterSettings) -&gt; bool {
    settings.preview.is_enabled()
}

pub(crate) const fn is_defer_optional_to_up045_enabled(settings: &amp;LinterSettings) -&gt; bool {
    settings.preview.is_enabled()
}

pub(crate) const fn is_unicode_to_unicode_confusables_enabled(settings: &amp;LinterSettings) -&gt; bool {
    settings.preview.is_enabled()
}

pub(crate) const fn is_support_slices_in_literal_concatenation_enabled(
    settings: &amp;LinterSettings,
) -&gt; bool {
    settings.preview.is_enabled()
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-04-28 06:42</div>
            <div class="timeline-body"><p>Nice. Thanks for going through all existing preview checks. I'm surprised that there aren't more.</p>
<p>Would the visibility restriction work if you moved <code>preview.rs</code> to <code>settings/preview</code>?</p>
<p>As an &quot;alternative&quot;, we could consider making <code>preview</code> private and instead expose it as a <code>preview</code> method and document that it's recommended to add a new function to <code>preview.rs</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-04-28 14:03</div>
            <div class="timeline-body"><blockquote>
<p>Would the visibility restriction work if you moved preview.rs to settings/preview?</p>
</blockquote>
<blockquote>
<p>As an &quot;alternative&quot;, we could consider making preview private and instead expose it as a preview method and document that it's recommended to add a new function to preview.rs.</p>
</blockquote>
<p>So I tried something like this, but the issue was:</p>
<blockquote>
<p>The downside of this approach is that there are several places where we initialize LinterSettings by specifying all of its fields. So we'd have to change those to builder methods.</p>
</blockquote>
<p>So it's less about controlling the visibility of <em>querying</em> preview, and more about figuring out how to deal with the resulting difficulty in <em>setting</em> preview. I'm also happy to leave this as is for now if there isn't a simple solution, or if we want to do a follow up later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-28 14:07</div>
            <div class="timeline-body"><p>Oh, I missed that. I'm fine leaving it <code>pub</code>. It's pub in the formatter and that hasn't been a problem.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dylwil3 on 2025-04-28 14:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dylwil3 on 2025-04-28 14:12</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:11:56 UTC
    </footer>
</body>
</html>
