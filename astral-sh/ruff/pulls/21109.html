<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Render `import &lt;...&gt;` in completions when &quot;label details&quot; isn't supported - astral-sh/ruff #21109</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Render <code>import &lt;...&gt;</code> in completions when &quot;label details&quot; isn't supported</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21109">#21109</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2025-10-28 15:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-10-28 15:34</div>
            <div class="timeline-body"><p>This fixes a bug where the <code>import module</code> part of a completion for
unimported candidates would be missing. This makes it especially
confusing because the user can't tell where the symbol is coming from,
and there is no hint that an <code>import</code> statement will be inserted.</p>
<p>Previously, we were using <a href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#completionItemLabelDetails"><code>CompletionItemLabelDetails</code></a> to render the
<code>import module</code> part of the suggestion. But this is only supported in
clients that support version 3.17 (or newer) of the LSP specification.
It turns out that this support isn't widespread yet. In particular,
Heliex doesn't seem to support &quot;label details.&quot;</p>
<p>To fix this, we take a <a href="https://github.com/rust-lang/rust-analyzer/blob/5d905576d49233ed843bb40df4ed57e5534558f5/crates/rust-analyzer/src/lsp/to_proto.rs#L391-L404">cue from rust-analyzer</a>.
We detect if the client supports &quot;label details,&quot; and if so, use it.
Otherwise, we push the <code>import module</code> text into the completion label
itself.</p>
<p>Fixes https://github.com/astral-sh/ruff/pull/20439#issuecomment-3313689568</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @BurntSushi on 2025-10-28 15:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @BurntSushi on 2025-10-28 15:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @BurntSushi on 2025-10-28 15:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @BurntSushi on 2025-10-28 15:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-10-28 15:35</div>
            <div class="timeline-body"><p>Demo:</p>
<p>https://github.com/user-attachments/assets/39ccbdb4-edfd-416b-b3f9-14d95e5fbe82</p>
<p>In this demo, I show the VS Code rendering, which is unchanged. Then I show Helix. Previously, it didn't include the modules for unimported symbols. But now it does!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dcreager removed by @BurntSushi on 2025-10-28 15:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @BurntSushi on 2025-10-28 15:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @BurntSushi on 2025-10-28 15:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @BurntSushi on 2025-10-28 15:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-28 15:36</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-28 15:38</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @MichaReiser on 2025-10-28 17:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @MichaReiser on 2025-10-28 17:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api/requests/completion.rs</code>:98 on 2025-10-28 17:44</div>
            <div class="timeline-body"><p>Is there a leading whitespace at the start of <code>import_suffix</code> (I'm asking because it's hard to tell from Github's review page and I can't load your test plan with the onboard wifi ;)).</p>
<p>If not, should we add one?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-10-28 17:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-10-29 12:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_server/src/server/api/requests/completion.rs</code>:98 on 2025-10-29 12:50</div>
            <div class="timeline-body"><p>Yes there is! From above:</p>
<pre><code class="language-rust">let import_suffix = comp.module_name.map(|name| format!(&quot; (import {name})&quot;));
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @BurntSushi on 2025-10-29 12:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2025-10-29 12:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-10-29 12:50</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:00:13 UTC
    </footer>
</body>
</html>
