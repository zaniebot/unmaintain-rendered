<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`refurb`] Make the fix for `FURB163` unsafe for `log2`, `log10`, `*args`, and deleted comments - astral-sh/ruff #18645</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>refurb</code>] Make the fix for <code>FURB163</code> unsafe for <code>log2</code>, <code>log10</code>, <code>*args</code>, and deleted comments</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18645">#18645</a>
        opened by <a href="https://github.com/chirizxc">@chirizxc</a>
        on 2025-06-12 11:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/chirizxc">@chirizxc</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff/ty! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title? (Please prefix with `[ty]` for ty pull
  requests.)
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>/closes #18639</p>
<!-- What's the purpose of the change? What does it do, and why? -->

<h2>Test Plan</h2>
<p>update snapshots</p>
<!-- How was it tested? -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-12 11:58</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chirizxc">@chirizxc</a> on 2025-06-12 12:12</div>
            <div class="timeline-body"><p>do we have to update doc as well? because examples from the <a href="https://github.com/astral-sh/ruff/issues/18639#issue-3138599071">ussie</a> and the doc are different</p>
<p>i mean
<img src="https://github.com/user-attachments/assets/3846f580-d8d0-4553-8c8e-d569b5d5387e" alt="изображение" />
<img src="https://github.com/user-attachments/assets/7afe0034-0f7f-4aa7-9431-273b071f135c" alt="изображение" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chirizxc">@chirizxc</a> on 2025-06-12 12:27</div>
            <div class="timeline-body"><p>although it should only work for float</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/chirizxc">@chirizxc</a> reviewed on 2025-06-12 12:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/chirizxc">@chirizxc</a> on <code>crates/ruff_linter/src/rules/refurb/rules/redundant_log_base.rs</code>:139 on 2025-06-12 12:46</div>
            <div class="timeline-body"><p>i'm not sure, but maybe such a <code>is_float</code> already exists somewhere in the helper or something like that</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chirizxc">@chirizxc</a> on 2025-06-12 13:19</div>
            <div class="timeline-body"><p>there's also a question about <a href="https://github.com/astral-sh/ruff/blob/main/crates/ruff_python_ast/src/generated.rs">ruff_python_ast/src/generated.rs</a> file
<img src="https://github.com/user-attachments/assets/a3ba28ec-3ae2-4698-9037-dd322b33e162" alt="изображение" /></p>
<p>rustrover writes that <code>crate::</code> is not needed in 834 places, should the <code>crates/ruff_python_ast/generate.py</code> itself be corrected?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/refurb/rules/redundant_log_base.rs</code>:139 on 2025-06-12 17:24</div>
            <div class="timeline-body"><p>There's this:</p>
<p>https://github.com/astral-sh/ruff/blob/4cfaa39412ab33825c834f7da4bca3f96e550ba1/crates/ruff_python_semantic/src/analyze/typing.rs#L981-L984</p>
<p>which would work on a <code>Binding</code> if you wanted to resolve variables too, but do we need to check if the argument is a float? You can see the same floating point behavior with less exotic arguments:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; math.log2(10)
3.321928094887362
&gt;&gt;&gt; math.log(10, 2)
3.3219280948873626
</code></pre>
<p>and I think we're already checking for number literals.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/refurb/rules/redundant_log_base.rs</code>:156 on 2025-06-12 17:25</div>
            <div class="timeline-body"><p>nit: I think you can use <code>arg.is_starred_expr</code> here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-12 17:32</div>
            <div class="timeline-body"><p>Thanks! I just had a couple of suggestions.</p>
<p>And yes, we need to update the documentation with a <code>## Fix safety</code> section because the fix is now unsafe in many cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-12 17:33</div>
            <div class="timeline-body"><blockquote>
<p>there's also a question about <a href="https://github.com/astral-sh/ruff/blob/main/crates/ruff_python_ast/src/generated.rs">ruff_python_ast/src/generated.rs</a> file <img src="https://private-user-images.githubusercontent.com/109767616/454415857-a3ba28ec-3ae2-4698-9037-dd322b33e162.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NDk3NDk4NDgsIm5iZiI6MTc0OTc0OTU0OCwicGF0aCI6Ii8xMDk3Njc2MTYvNDU0NDE1ODU3LWEzYmEyOGVjLTNhZTItNDY5OC05MDM3LWRkMzIyYjMzZTE2Mi5wbmc_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUwNjEyJTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MDYxMlQxNzMyMjhaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT0zZjBjNzgyZjIyYzhlMjkwMTQxYmI5MzU2OTYwZjZjYzg3MDI0MDgwZDI1NjUxMzJiZjllMzgwNDYwM2FhNjYzJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.I_VCJxgt8BZUJ1xaFWKyVcgtMCxA-WCvp0LDwG6Kf1M" alt="изображение" /></p>
<p>rustrover writes that <code>crate::</code> is not needed in 834 places, should the <code>crates/ruff_python_ast/generate.py</code> itself be corrected?</p>
</blockquote>
<p>This is interesting, I guess clippy doesn't warn about this. We could probably open a separate issue or PR for this, if you wanted!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/refurb/rules/redundant_log_base.rs</code>:43 on 2025-06-12 19:42</div>
            <div class="timeline-body"><p>I think I would treat these two cases separately. My understanding is that the fix is unsafe when comments are in the replacement range because they will be deleted, which seems a bit separate from either semantics or readability.</p>
<p>And I don't think the <code>*args</code> case has any effect on readability, it &quot;just&quot; changes the semantics of the code by raising an error when a different number of arguments are passed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-06-12 19:51</div>
            <div class="timeline-body"><p>Nice! One more docs nit, but this is otherwise good to go.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/chirizxc">@chirizxc</a> on <code>crates/ruff_linter/src/rules/refurb/rules/redundant_log_base.rs</code>:43 on 2025-06-12 20:05</div>
            <div class="timeline-body"><p>if write it like this, i think it would make more sense:</p>
<p>This fix is marked unsafe when the argument is a starred expression, as this changes the call semantics and may raise runtime errors. It is also unsafe if comments are present within the call, as they will be removed. Additionally, <code>math.log(x, base)</code> and <code>math.log2(x)</code> / <code>math.log10(x)</code> may differ due to floating-point rounding.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/chirizxc">@chirizxc</a> reviewed on 2025-06-12 20:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @MichaReiser on 2025-06-13 06:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/refurb/rules/redundant_log_base.rs</code>:44 on 2025-06-16 18:07</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// and `math.log2(x)` / `math.log10(x)` may differ due to floating-point rounding, so 
/// the fix is also unsafe when making this transformation.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-06-16 18:07</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`refurb`] make fix for FURB163 (`redundant-log-base`) unsafe if log2/log10, starred arg, or comments" to "[`refurb`] Make the fix for `FURB163` unsafe for `log2`, `log10`, `*args`, and deleted comments" by @ntBre on 2025-06-16 18:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-06-16 18:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-06-16 18:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-16 18:17</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:13:22 UTC
    </footer>
</body>
</html>
