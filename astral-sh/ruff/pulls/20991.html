<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Avoid ever-growing default types - astral-sh/ruff #20991</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Avoid ever-growing default types</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20991">#20991</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-10-20 11:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body">Summary
<p>We currently panic in the seemingly rare case where the type of a default value of a parameter depends on the callable itself:</p>
<pre><code>class C:
    def f(self: C):
        self.x = lambda a=self.x: a
</code></pre>
<p>Types of default values are only used for display reasons, and it&#x27;s unclear if we even want to track them (or if we should rather track the actual value). So it didn&#x27;t seem to me that we should spend a lot of effort (and runtime) trying to achieve a theoretically correct type here (which would be infinite).</p>
<p>Instead, we simply replace <em>nested</em> default types with <code>Unknown</code>, i.e. only if the type of the default value is a callable itself.</p>
<p>closes <a href="https://github.com/astral-sh/ty/issues/1402">astral-sh/ty#1402</a></p>
Test Plan
<p>Regression tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-20 11:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-20 14:55</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-20 14:57</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-20 15:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-20 15:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-20 15:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-20 15:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-20 16:58</div>
            <div class="timeline-body"><blockquote>
<p>Types of default values are only used for display reasons,</p>
</blockquote>
<p>We do also check whether the type of the default value is assignable to the type of the annotation (if there is an annotation), right?</p>
<p>It looks like we still emit an error for something like this on your branch, but it might be worth adding a test for it:</p>
<pre><code>class A:
    def __init__(self: &quot;A&quot;):
        def f(a: int = self.f): ...
        self.f = f
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-20 18:01</div>
            <div class="timeline-body"><blockquote>
<p>We do also check whether the type of the default value is assignable to the type of the annotation (if there is an annotation), right?</p>
</blockquote>
<p>Yes, correct. Type inference for the actual default value did not change. And we still perform that check. Only the type inside the generated signature changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-20 18:05</div>
            <div class="timeline-body"><blockquote>
<p>but it might be worth adding a test for it</p>
</blockquote>
<p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-21 11:31</div>
            <div class="timeline-body"><blockquote>
<p>We currently panic in the seemingly rare case where the type of a default value of a parameter depends on the callable itself:</p>
</blockquote>
<p>Is this a too-many-iterations panic?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-21 11:32</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>We currently panic in the seemingly rare case where the type of a default value of a parameter depends on the callable itself:</p>
</blockquote>
<p>Is this a too-many-iterations panic?</p>
</blockquote>
<p>Yes</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-10-21 11:39</div>
            <div class="timeline-body"><p>I don&#x27;t have a good sense for whether there&#x27;s a better solution but i agree with the sentiment, that it&#x27;s probably not worth spending too much time on.</p>
<p>I was worried that it could regress signature completions in the LSP but this isn&#x27;t the case</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-21 11:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-21 12:47</div>
            <div class="timeline-body"><p>I think the <em>better</em> solution (which David gestures at in his PR description) would be not to store the type of the parameter default as part of the function signature at all. I think our current UX here is somewhat bad: if you have a function like this in your source code:</p>
<pre><code>def f(x: bool = True) -&gt; None: ...
</code></pre>
<p>Why do we display the signature on hover as <code>(x: bool = Literal[True]) -&gt; None</code>? That honestly just seems incorrect -- it should just be <code>(x: bool = True) -&gt; None</code>, as it is in the source code (that&#x27;s what pyright does -- try hovering over <code>print</code> in VSCode). This implies that rather than storing the default value&#x27;s type in the signature, we should ideally just grab the slice of the source code that the parameter default occupies and store it as a <code>Box&lt;str&gt;</code> in the function&#x27;s signature.</p>
<p>This PR doesn&#x27;t regress UX, so I&#x27;m okay with it as a temporary measure. But it does also add <em>some</em> additional complexity to our codebase (by introducing a new <code>TypeMapping</code> variant), and I do wonder how hard it would be to just implement the &quot;better solution&quot; (which feels like it would also solve a significant UX painpoint).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-10-21 12:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-21 12:58</div>
            <div class="timeline-body"><blockquote>
<p>This implies that rather than storing the default value&#x27;s type in the signature, we should ideally just grab the slice of the source code that the parameter default occupies and store it as a <code>Box&lt;str&gt;</code> in the function&#x27;s signature.</p>
</blockquote>
<p>That&#x27;s not ideal either, I think. Consider:</p>
<pre><code>def outer(x: int):
    def inner(y: int=x):
        pass
</code></pre>
<p>Do you want to see a default value of <code>x</code> there? I think what we could do instead would be to see if the default type is a <code>Literal[…]</code> type (that could be generalized to single-value types probably). If so, we turn it into a value and show <code>param = True</code> instead of <code>param = Literal[True]</code>. If not, we simply show <code>param = ...</code>. What do you think?</p>
<p>I can attempt to implement that instead of this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-21 13:01</div>
            <div class="timeline-body"><blockquote>
<p>Do you want to see a default value of <code>x</code> there?</p>
</blockquote>
<p>Not sure I understand the example -- none of the parameters have default values in this snippet? Did you mean <code>y=x</code> rather than <code>y: x</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-21 13:09</div>
            <div class="timeline-body"><blockquote>
<p>Not sure I understand the example -- none of the parameters have default values in this snippet? Did you mean <code>y=x</code> rather than <code>y: x</code>?</p>
</blockquote>
<p>yes, fixed</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-21 13:10</div>
            <div class="timeline-body"><blockquote>
<p>I think what we could do instead would be to see if the default type is a <code>Literal[…]</code> type (that could be generalized to single-value types probably). If so, we turn it into a value and show <code>param = True</code> instead of <code>param = Literal[True]</code>. If not, we simply show <code>param = ...</code>. What do you think?</p>
</blockquote>
<p>I don&#x27;t think this will do a great job for things like <code>tuple.index</code>, where <code>sys.maxsize</code> (a value that varies depending on the specific build of Python you&#x27;re running) is used as the parameter default:</p>
<p>https://github.com/astral-sh/ruff/blob/e1cada1ec30d289acb00390058fab8bce765836e/crates/ty_vendored/vendor/typeshed/stdlib/builtins.pyi#L2739-L2743</p>
<p>And what about parameter defaults that typeshed faithfully gives to us in octal, so that they will be nicely readable for IDE users?</p>
<p>https://github.com/astral-sh/ruff/blob/e1cada1ec30d289acb00390058fab8bce765836e/crates/ty_vendored/vendor/typeshed/stdlib/dbm/dumb.pyi#L57</p>
<p>While I don&#x27;t think it ever occurs in typeshed, I think things like <code>x=(foo if some condition else bar)</code> are also not unusual in user code, and it&#x27;s probably useful to have the full condition printed in the on-hover signature so that you can see how the default value changes under certain conditions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-21 13:15</div>
            <div class="timeline-body"><p>A compromise that might work quite well: if the function comes from a stub file, just grab a string slice from the source code (typeshed, for example, actually has pretty strict lint rules to stop us from using arbitrary expressions in default values; we just use <code>=...</code> for anything complicated at runtime). If it&#x27;s not a stub file, we can implement your <code>Literal</code> heuristic, to avoid us possibly printing strange default values that reference global variables the user has no context on.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-21 14:15</div>
            <div class="timeline-body"><p>The issue isn&#x27;t just about values the user doesn&#x27;t have control over. It also means that comments, or line breaks within the default value are preserved.</p>
<p>I&#x27;m not sure if this is worth prioritizing right now. It seems there are enough details at play that are worth considering in a separate PR (and later)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-21 14:22</div>
            <div class="timeline-body"><blockquote>
<p>I&#x27;m not sure if this is worth prioritizing right now. It seems there are enough details at play that are worth considering in a separate PR (and later)</p>
</blockquote>
<p>Yes, it does seem like pyright/pylance is doing something <em>quite</em> sophisticated here. For this function:</p>
<pre><code>def f(x=[
    1,
    2,
    # some comment,
    4
]): ...
</code></pre>
<p>Pyright/pylance gives this signature when I hover over it:</p>

Screenshot

<p><img alt="image" src="https://github.com/user-attachments/assets/acf89dc2-f23f-48dd-9d6a-c793b7fe8347"></p>


<p>But pyright/pylance doesn&#x27;t do a <em>great</em> job for the <code>sys.maxsize</code> or octal defaults that I showed from typeshed above (the <code>sys.maxsize</code> defaults just become <code>...</code>, and the <code>0o666</code> default becomes <code>438</code>), so there&#x27;s arguably room for improvement over what pyright/pylance does too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-21 17:13</div>
            <div class="timeline-body"><p>Seeing this discussion, I feel like this change should be done separately, and probably at a later time. I&#x27;d love to work on this, but it&#x27;s honestly not high priority. And it seems like there will be some things to decide. So I&#x27;m going to merge this (because solving that panic <em>is</em> a high priority), even if I fully agree with Alex&#x27;s comment above. It looks to me like it&#x27;ll be easy to rip this out once we switch to the value-based representation. I&#x27;ll write down a todo task for me and/or create a ticket.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-21 17:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-21 17:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-10-21 17:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-21 18:17</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:19:44 UTC
    </footer>
</body>
</html>
