<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TypeRelationError - astral-sh/ruff #19580</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>TypeRelationError</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19580">#19580</a>
        opened by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a>
        on 2025-07-27 22:44
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Towards https://github.com/astral-sh/ty/issues/163</p>
<h2>Test Plan</h2>
<!-- How was it tested? -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-07-27 22:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-07-27 23:57</div>
            <div class="timeline-body"><p>One thing I just can't catch is messing everything up, will go over it tmr evening. If anyone has a time for a quick scan it should be in types.rs, but im not too sure</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-28 07:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types.rs</code>:1253 on 2025-07-28 07:56</div>
            <div class="timeline-body"><p>Nit: It feels a bit off to me to use a <code>Result</code> here. I would expect an <code>Err</code> only if two types can't be compared but that's not how <code>Result</code> is used here.</p>
<p>I think I'd use a custom enum over <code>Result</code> with a <code>Yes</code> and <code>No(reason)</code> variants. We can mark the type as <code>#[must_use]</code> if we're worried about callers not handling the error but it seems not handling the error actually seems to be the default?</p>
<p>What's unclear to me is how we plan on aggregating <code>TypeRelationError</code>s. But maybe that's just because it's not yet clear to me what variants <code>TypeRelationError</code> will have</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-07-28 10:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types.rs</code>:1253 on 2025-07-28 10:17</div>
            <div class="timeline-body"><p>I think using <code>Result</code> might have some advantages further down the line: methods like <code>map_err</code> could be useful for bubbling up a low-level assignability failure of a wrapped type into a high-level assignability failure for the wrapping type. But I agree that we need a more ergonomic solution for the default case: I was going to suggest having low-level methods <code>try_type_relation</code>, <code>try_subtype_relation</code> and <code>try_assignability_relation</code> (which you can use if you need to know <em>why</em> the relation doesn't apply between two types), but to also have high-level <code>has_relation_to</code>, <code>is_subtype_of</code> and <code>is_assignable_to</code> methods like we have now:</p>
<pre><code class="language-rs">impl&lt;'db&gt; Type&lt;'db&gt; {
    fn has_relation_to(db: &amp;'db dyn Db, other: Type&lt;'db&gt;, relation: TypeRelation) -&gt; bool {
        self.try_type_relation(db, other, relation).is_ok()
    }

    fn is_subtype_of(db: &amp;'db dyn Db, other: Type&lt;'db&gt;) -&gt; bool {
        self.has_relation_to(db, other, TypeRelation::Subtyping)
    }

    fn is_assignable_to(db: &amp;'db dyn Db, other: Type&lt;'db&gt;) -&gt; bool {
        self.has_relation_to(db, other, TypeRelation::Assignability)
    }
}
</code></pre>
<p>it's a bit hard to tell what the best design is, however, until we try to start trying to use (in diagnostics) the extra information now available to us.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-28 10:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types.rs</code>:1253 on 2025-07-28 10:19</div>
            <div class="timeline-body"><p>We can always implement <code>map_err</code> etc. on the custom enum. I just find <code>is_ok</code> to be too implicit and <code>has_relation_to(db, other, relation) == Ok(())</code> seems to verbose (and also confusing).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-07-28 10:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types.rs</code>:1253 on 2025-07-28 10:22</div>
            <div class="timeline-body"><p>I don't have a strong opinion</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-07-28 10:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/ty_python_semantic/src/types.rs</code>:1253 on 2025-07-28 10:26</div>
            <div class="timeline-body"><p>try_... seems like a good structure and simplifies this PR a lot</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-07-28 10:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/ty_python_semantic/src/types.rs</code>:1253 on 2025-07-28 10:32</div>
            <div class="timeline-body"><p>Creating our own enum also means we can implement from bool. Which also simplifies a lot of code</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-28 17:06</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on typing conformance tests</h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-28 17:52</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-07-28 18:00</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/MatthewMckee4%3Atype-relation-error?utm_source=github&amp;utm_medium=comment&amp;utm_content=header">CodSpeed Performance Report</a></h2>
<h3>Merging #19580 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>MatthewMckee4:type-relation-error</code> (e26ec50) with <code>main</code> (81867ea)</sub></p>
<h3>Summary</h3>
<p><code>✅ 8</code> untouched</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-07-28 18:01</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_WALLTIME_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/MatthewMckee4%3Atype-relation-error?runnerMode=WallTime">CodSpeed WallTime Performance Report</a></h2>
<h3>Merging #19580 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>MatthewMckee4:type-relation-error</code> (e26ec50) with <code>main</code> (81867ea)</sub></p>
<h3>Summary</h3>
<p><code>✅ 7</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-07-28 19:32</div>
            <div class="timeline-body"><p>Will mark as ready for some initial feedback</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-07-28 19:55</div>
            <div class="timeline-body"><p>Not sure as of now what to do about the regressions</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-29 06:56</div>
            <div class="timeline-body"><p>One thing you could try is ot use <code>thin_vec</code>. I suspect that the performance regression is mainly because the result of the type operations no longer fit into a single register. But it might also be that we return <code>false</code> in many places and tracking the information is anything but free.</p>
<p>But I think I'll need a better understanding for what we want to use this new information and if it's even worth tracking all possible errors.</p>
<p>It might be good to start with: What exact information do we need and, from there, backtrack on what information we need to propagate in these relation methods.</p>
<p>It might also be that we want separate relation methods to avoid the overhead in the most common path.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-07-29 08:05</div>
            <div class="timeline-body"><p>It's probably also useful if I turn TypeRelationError into an enum? All of the todo fails right now will create a new vec, but for the most part most vec will have one item</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-29 11:01</div>
            <div class="timeline-body"><blockquote>
<p>But I think I'll need a better understanding for what we want to use this new information and if it's even worth tracking all possible errors.</p>
<p>It might be good to start with: What exact information do we need and, from there, backtrack on what information we need to propagate in these relation methods.</p>
</blockquote>
<p>https://github.com/astral-sh/ty/issues/163#issuecomment-3131926504 and https://github.com/astral-sh/ty/issues/163#issuecomment-3127554546 show examples of why we need to track this information</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-07-29 11:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/class.rs</code>:472 on 2025-07-29 11:04</div>
            <div class="timeline-body"><p>this is a lot more expensive than what we do on <code>main</code> because it means that we now have to iterate through the entire MRO (and allocate a <code>Vec</code>) whereas previously we could short-circuit as soon as we spotted that one class was a subclass of the other. We should avoid <code>.collect()</code> calls in this and similar cases wherever possible, and continue to short-circuit. I think in most cases, it's probably okay if we only provide a single reason why one type is not a subtype of another, even if there are multiple underlying reasons why the relation cannot be satisfied.</p>
<p><code>Protocol</code>s might be an exception to this, but we can deal with that later</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/ty_python_semantic/src/types/class.rs</code>:472 on 2025-07-29 11:38</div>
            <div class="timeline-body"><p>Yeah I realised this, will address later</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-07-29 11:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-29 11:58</div>
            <div class="timeline-body"><blockquote>
<p>https://github.com/astral-sh/ty/issues/163#issuecomment-3131926504 and https://github.com/astral-sh/ty/issues/163#issuecomment-3127554546 show examples of why we need to track this information</p>
</blockquote>
<p>What's not clear to me from this if this is something we need to integrate into the <code>is_</code> methods directly or if we should have a separate method that visits a type again and then diagnoses why it isn't assignable (by re-testing each union element to find the one that isn't assignable).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-29 12:09</div>
            <div class="timeline-body"><blockquote>
<p>What's not clear to me from this if this is something we need to integrate into the <code>is_</code> methods directly or if we should have a separate method that visits a type again and then diagnoses why it isn't assignable (by re-testing each union element to find the one that isn't assignable).</p>
</blockquote>
<p>Yeah, that's a good question. It would be interesting to experiment with some different designs here.</p>
<p>The nice thing about the current approach in this PR is that it does not increase the maintenance burden of the type-relational methods. I would definitely not want to go back to a situation similar to what we had before https://github.com/astral-sh/ruff/pull/18430: having separate <code>Type::is_assignable_to</code> and <code>Type::is_subtype_of</code> methods was a maintenance nightmare that led to many subtle bugs across our code. I'm concerned that your suggestion <em>might</em> similarly lead to us trying to have duplicated implementations of <code>Type::has_relation_to</code> which would be very hard to keep in sync (this method is very subtle, and very complex!).</p>
<p>There might also be ways of implementing your suggestion that would not significantly increase the maintenance burden. On the other hand, I also think there are some obvious ways of optimising this PR branch, as I commented above</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-07-29 13:38</div>
            <div class="timeline-body"><p>Nice, thats a bit better</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-07-29 14:17</div>
            <div class="timeline-body"><p>nice!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-07-29 16:05</div>
            <div class="timeline-body"><p>There's maybe an argument to rename <code>TypeRelationErrorKind</code> to <code>TypeRelationErrorReason</code>?</p>
<p>I'm also not sure if we should have a base (<code>NoReason</code>) case, it seems like most of those cases would be a simple <code>DoesNotInheritFrom</code> or similar.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-08-12 14:06</div>
            <div class="timeline-body"><p>Is there any interest in taking this further?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-12 14:21</div>
            <div class="timeline-body"><blockquote>
<p>Is there any interest in taking this further?</p>
</blockquote>
<p>Yes, definitely! I think we absolutely need something like this.</p>
<p>Sorry we haven't got back to you, that's on me :-( There's a lot of things to juggle right now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-08-18 22:55</div>
            <div class="timeline-body"><p>All good, when you want to revisit let me know and I can fix the merge conflicts</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:14:35 UTC
    </footer>
</body>
</html>
