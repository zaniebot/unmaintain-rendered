<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed symbol state merging back up - astral-sh/ruff #15731</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Speed symbol state merging back up</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15731">#15731</a>
        opened by <a href="https://github.com/dcreager">@dcreager</a>
        on 2025-01-24 20:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a></div>
            <div class="timeline-body"><p>This is a follow-up to #15702 that hopefully claws back the 1% performance regression.  Assuming it works, the trick is to iterate over the constraints vectors via mut reference (aka a single pointer), so that we're not copying <code>BitSet</code>s into and out of the zip tuples as we iterate.  We use <code>std::mem::take</code> as a poor-man's move constructor only at the very end, when we're ready to emplace it into the result.  (C++ idioms intended! :smile:)</p>
<p>With local testing via hyperfine, I'm seeing this be 1-3% faster than <code>main</code> most of the time â€” though a small number of runs (1 in 10, maybe?) are a wash or have <code>main</code> faster.  Fingers crossed to see what codspeed says!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dcreager on 2025-01-24 20:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dcreager on 2025-01-24 20:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dcreager on 2025-01-24 20:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @dcreager on 2025-01-24 20:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-01-24 20:32</div>
            <div class="timeline-body"><blockquote>
<p>Fingers crossed to see what codspeed says!</p>
</blockquote>
<p>2% faster <a href="https://codspeed.io/astral-sh/ruff/branches/dcreager%2Fmerge-speedup">according to codspeed</a>! :tada: :taco:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/use_def/symbol_state.rs</code>:307 on 2025-01-24 20:46</div>
            <div class="timeline-body"><p>A comment here would probably be useful. It wasn't immediately clear to me why we use a <code>&amp;mut</code> here even with your explanation. Should we do the same in the other <code>merge</code> method and for `visibility_constraints?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-01-24 20:46</div>
            <div class="timeline-body"><p>Nice</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-01-24 20:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/red_knot_python_semantic/src/semantic_index/use_def/symbol_state.rs</code>:307 on 2025-01-24 20:48</div>
            <div class="timeline-body"><p>I think it won't be as beneficial for <code>visibility_constraints</code>, since those are already smaller.  But I can check!  (And I will add the comment)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-01-24 20:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/red_knot_python_semantic/src/semantic_index/use_def/symbol_state.rs</code>:307 on 2025-01-24 20:58</div>
            <div class="timeline-body"><p>Yep as expected, it was a wash doing the same thing to <code>visibility_constraints</code>.  (Those are 32-bit IDs, which are cheap to copy, and not 24-byte <code>BitSet</code>s.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dcreager on 2025-01-24 21:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dcreager on 2025-01-24 21:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-24 21:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-01-24 21:08</div>
            <div class="timeline-body"><p>Amazing, thank you!!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:09:29 UTC
    </footer>
</body>
</html>
