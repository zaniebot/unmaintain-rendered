<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-type-checking`] Fix syntax error introduced by fix (`TC008`) - astral-sh/ruff #19150</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-type-checking</code>] Fix syntax error introduced by fix (<code>TC008</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19150">#19150</a>
        opened by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a>
        on 2025-07-04 20:19
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> on 2025-07-04 20:19</div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff/ty! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title? (Please prefix with `[ty]` for ty pull
  requests.)
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<!-- What's the purpose of the change? What does it do, and why? -->

<p>I noticed this while working on #18972. If the string targeted by <a href="https://docs.astral.sh/ruff/rules/quoted-type-alias/#quoted-type-alias-tc008">quoted-type-alias (TC008)</a> is a multiline string, the fix would introduce a syntax error. This PR fixes that by adding parenthesis around the resulting replacement if the string contained any newline characters (<code>\n</code>, <code>\r</code>) if it doesn't already have parenthesis outside <code>(&quot;&quot;&quot;...&quot;&quot;&quot;)</code> or inside <code>&quot;&quot;&quot;(...)&quot;&quot;&quot;</code> the annotation.</p>
<p>Failing examples: https://play.ruff.rs/8793eb95-860a-4bb3-9cbc-6a042fee2946</p>
<pre><code>PS D:\rust_projects\ruff&gt; Get-Content issue.py
</code></pre>
<pre><code class="language-py">from typing import TypeAlias

OptInt: TypeAlias = &quot;&quot;&quot;int
| None&quot;&quot;&quot;

type OptInt = &quot;&quot;&quot;int
| None&quot;&quot;&quot;
</code></pre>
<pre><code>PS D:\rust_projects\ruff&gt; uvx ruff check issue.py --isolated --select TC008 --fix --diff --preview
</code></pre>
<pre><code>
error: Fix introduced a syntax error. Reverting all changes.

This indicates a bug in Ruff. If you could open an issue at:

    https://github.com/astral-sh/ruff/issues/new?title=%5BFix%20error%5D

...quoting the contents of `issue.py`, the rule codes TC008, along with the `pyproject.toml` settings and executed command, we'd be very appreciative!
</code></pre>
<p>This PR also makes the example error out-of-the-box for #18972</p>
<p>Old example: https://play.ruff.rs/f6cd5adb-7f9b-444d-bb3e-8c045241d93e</p>
<pre><code class="language-py">OptInt: TypeAlias = &quot;int | None&quot;
</code></pre>
<p>New example: https://play.ruff.rs/906c1056-72c0-4777-b70b-2114eb9e6eaf</p>
<pre><code class="language-py">from typing import TypeAlias

OptInt: TypeAlias = &quot;int | None&quot;
</code></pre>
<p>The import was also added to the &quot;Use instead&quot; section.</p>
<h2>Test Plan</h2>
<!-- How was it tested? -->

<p>Added multiple test cases</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`flake8-typechecking" to "[`flake8-type-checking`] Fix syntax error introduced by fix (`TC008`)" by @MeGaGiGaGon on 2025-07-04 20:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-04 20:29</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2025-07-05 13:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @AlexWaygood on 2025-07-05 13:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_type_checking/TC008.py</code>:32 on 2025-07-07 14:11</div>
            <div class="timeline-body"><p>If you move these fixtures to the end of the file the diff will be smaller</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/flake8_type_checking/rules/type_alias_quotes.rs</code>:296 on 2025-07-07 14:13</div>
            <div class="timeline-body"><ol>
<li>let's use <code>checker.indexer().multiline_ranges()</code> here</li>
<li>we should avoid adding parentheses if we don't need to. So within this branch maybe check whether the expression is already parenthesized using <code>ruff_python_ast::parenthesize::parenthesized_range</code></li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_type_checking/TC008.py</code>:49 on 2025-07-07 14:16</div>
            <div class="timeline-body"><p>Can you add a test for a triple-quoted, multiline annotation that <em>already</em> has parentheses? Also, perhaps more awkwardly, one where the parentheses are on the <em>inside</em> of the quote?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> requested changes on 2025-07-07 14:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> reviewed on 2025-07-07 18:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> on <code>crates/ruff_linter/src/rules/flake8_type_checking/rules/type_alias_quotes.rs</code>:296 on 2025-07-07 18:32</div>
            <div class="timeline-body"><p>Is there another test I should use in addition to <code>checker.indexer().multiline_ranges()</code>? Since when I swap over to that it causes a single line multiline string to also get parenthesized:</p>
<pre><code class="language-diff">-r: TypeAlias = &quot;&quot;&quot;int | None&quot;&quot;&quot;
+r: TypeAlias = (int | None)
-type R = &quot;&quot;&quot;int | None&quot;&quot;&quot;
+type R = (int | None)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> reviewed on 2025-07-07 19:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_type_checking/TC008.py</code>:32 on 2025-07-07 19:02</div>
            <div class="timeline-body"><p>Moved</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_type_checking/TC008.py</code>:49 on 2025-07-07 19:03</div>
            <div class="timeline-body"><p>I added those as test cases, and used <code>ruff_python_ast::parenthesize::parenthesized_range</code> to make sure parenthesis aren't added in those cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> reviewed on 2025-07-07 19:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-07-07 19:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/flake8_type_checking/rules/type_alias_quotes.rs</code>:296 on 2025-07-07 19:46</div>
            <div class="timeline-body"><p>Oh no! My bad ðŸ˜… , you're right and what you had previously was correct. Apologies!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-07-07 19:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/flake8_type_checking/rules/type_alias_quotes.rs</code>:296 on 2025-07-07 19:49</div>
            <div class="timeline-body"><p>But I could've sworn we had <em>some</em> utility method that already knows about newlines even within strings... let me search a bit harder</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-07-07 20:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/flake8_type_checking/rules/type_alias_quotes.rs</code>:296 on 2025-07-07 20:32</div>
            <div class="timeline-body"><p>Couldn't find it stored someplace - so this looks good to me!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> approved on 2025-07-07 20:33</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dylwil3 on 2025-07-07 20:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dylwil3 on 2025-07-07 20:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-07 20:37</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 18:33:38 UTC
    </footer>
</body>
</html>
