<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-type-checking`] Fix syntax error introduced by fix (`TC008`) - astral-sh/ruff #19150</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-type-checking</code>] Fix syntax error introduced by fix (<code>TC008</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19150">#19150</a>
        opened by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a>
        on 2025-07-04 20:19
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a></div>
            <div class="timeline-body">

Summary


<p>I noticed this while working on #18972. If the string targeted by <a href="https://docs.astral.sh/ruff/rules/quoted-type-alias/#quoted-type-alias-tc008">quoted-type-alias (TC008)</a> is a multiline string, the fix would introduce a syntax error. This PR fixes that by adding parenthesis around the resulting replacement if the string contained any newline characters (<code>\n</code>, <code>\r</code>) if it doesn&#x27;t already have parenthesis outside <code>(&quot;&quot;&quot;...&quot;&quot;&quot;)</code> or inside <code>&quot;&quot;&quot;(...)&quot;&quot;&quot;</code> the annotation.</p>
<p>Failing examples: https://play.ruff.rs/8793eb95-860a-4bb3-9cbc-6a042fee2946</p>
<pre><code>PS D:\rust_projects\ruff&gt; Get-Content issue.py
</code></pre>
<pre><code>from typing import TypeAlias

OptInt: TypeAlias = &quot;&quot;&quot;int
| None&quot;&quot;&quot;

type OptInt = &quot;&quot;&quot;int
| None&quot;&quot;&quot;
</code></pre>
<pre><code>PS D:\rust_projects\ruff&gt; uvx ruff check issue.py --isolated --select TC008 --fix --diff --preview
</code></pre>
<pre><code>
error: Fix introduced a syntax error. Reverting all changes.

This indicates a bug in Ruff. If you could open an issue at:

    https://github.com/astral-sh/ruff/issues/new?title=%5BFix%20error%5D

...quoting the contents of `issue.py`, the rule codes TC008, along with the `pyproject.toml` settings and executed command, we&#x27;d be very appreciative!
</code></pre>
<p>This PR also makes the example error out-of-the-box for #18972</p>
<p>Old example: https://play.ruff.rs/f6cd5adb-7f9b-444d-bb3e-8c045241d93e</p>
<pre><code>OptInt: TypeAlias = &quot;int | None&quot;
</code></pre>
<p>New example: https://play.ruff.rs/906c1056-72c0-4777-b70b-2114eb9e6eaf</p>
<pre><code>from typing import TypeAlias

OptInt: TypeAlias = &quot;int | None&quot;
</code></pre>
<p>The import was also added to the &quot;Use instead&quot; section.</p>
Test Plan


<p>Added multiple test cases</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[`flake8-typechecking&quot; to &quot;[`flake8-type-checking`] Fix syntax error introduced by fix (`TC008`)&quot; by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> on 2025-07-04 20:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-04 20:29</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>âœ… ecosystem check detected no linter changes.</p>
Linter (preview)
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-05 13:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-05 13:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_type_checking/TC008.py</code>:32 on 2025-07-07 14:11</div>
            <div class="timeline-body"><p>If you move these fixtures to the end of the file the diff will be smaller</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/flake8_type_checking/rules/type_alias_quotes.rs</code>:296 on 2025-07-07 14:13</div>
            <div class="timeline-body"><ol>
<li>let&#x27;s use <code>checker.indexer().multiline_ranges()</code> here</li>
<li>we should avoid adding parentheses if we don&#x27;t need to. So within this branch maybe check whether the expression is already parenthesized using <code>ruff_python_ast::parenthesize::parenthesized_range</code></li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_type_checking/TC008.py</code>:49 on 2025-07-07 14:16</div>
            <div class="timeline-body"><p>Can you add a test for a triple-quoted, multiline annotation that <em>already</em> has parentheses? Also, perhaps more awkwardly, one where the parentheses are on the <em>inside</em> of the quote?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> requested changes on 2025-07-07 14:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> reviewed on 2025-07-07 18:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> on <code>crates/ruff_linter/src/rules/flake8_type_checking/rules/type_alias_quotes.rs</code>:296 on 2025-07-07 18:32</div>
            <div class="timeline-body"><p>Is there another test I should use in addition to <code>checker.indexer().multiline_ranges()</code>? Since when I swap over to that it causes a single line multiline string to also get parenthesized:</p>
<pre><code>-r: TypeAlias = &quot;&quot;&quot;int | None&quot;&quot;&quot;
+r: TypeAlias = (int | None)
-type R = &quot;&quot;&quot;int | None&quot;&quot;&quot;
+type R = (int | None)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> reviewed on 2025-07-07 19:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_type_checking/TC008.py</code>:32 on 2025-07-07 19:02</div>
            <div class="timeline-body"><p>Moved</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_type_checking/TC008.py</code>:49 on 2025-07-07 19:03</div>
            <div class="timeline-body"><p>I added those as test cases, and used <code>ruff_python_ast::parenthesize::parenthesized_range</code> to make sure parenthesis aren&#x27;t added in those cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> reviewed on 2025-07-07 19:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-07-07 19:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/flake8_type_checking/rules/type_alias_quotes.rs</code>:296 on 2025-07-07 19:46</div>
            <div class="timeline-body"><p>Oh no! My bad ðŸ˜… , you&#x27;re right and what you had previously was correct. Apologies!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-07-07 19:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/flake8_type_checking/rules/type_alias_quotes.rs</code>:296 on 2025-07-07 19:49</div>
            <div class="timeline-body"><p>But I could&#x27;ve sworn we had <em>some</em> utility method that already knows about newlines even within strings... let me search a bit harder</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-07-07 20:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/flake8_type_checking/rules/type_alias_quotes.rs</code>:296 on 2025-07-07 20:32</div>
            <div class="timeline-body"><p>Couldn&#x27;t find it stored someplace - so this looks good to me!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> approved on 2025-07-07 20:33</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-07-07 20:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-07-07 20:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-07 20:37</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:16:16 UTC
    </footer>
</body>
</html>
