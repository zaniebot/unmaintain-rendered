<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merge subsettings when extending configurations - astral-sh/ruff #4431</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Merge subsettings when extending configurations</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4431">#4431</a>
        opened by <a href="https://github.com/bendoerry">@bendoerry</a>
        on 2023-05-14 14:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/bendoerry">@bendoerry</a> on 2023-05-14 14:12</div>
            <div class="timeline-body"><p>Currently we override entire config sections when extending configurations.
This change allows us to preserve sections and only override specific config options.</p>
<p>I've verified this works with the tree specified in the linked issue, and with the codebase that spurred me to look into this issue.</p>
<p>(This is my first OSS contribution so please lmk if I've got the process wrong somehow :) )</p>
<p>Closes  #4348</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-05-14 14:18</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>✅ ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     16.5±0.15ms     2.5 MB/sec    1.00     16.5±0.17ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.0±0.03ms     4.2 MB/sec    1.00      4.0±0.04ms     4.2 MB/sec
linter/all-rules/numpy/globals.py          1.01    497.7±1.62µs     5.9 MB/sec    1.00    493.9±3.59µs     6.0 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.9±0.04ms     3.7 MB/sec    1.00      6.9±0.04ms     3.7 MB/sec
linter/default-rules/large/dataset.py      1.00      8.0±0.03ms     5.1 MB/sec    1.00      8.0±0.05ms     5.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01   1726.8±8.59µs     9.6 MB/sec    1.00   1713.4±8.70µs     9.7 MB/sec
linter/default-rules/numpy/globals.py      1.00    190.1±1.51µs    15.5 MB/sec    1.00    190.5±5.78µs    15.5 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.6±0.01ms     7.0 MB/sec    1.00      3.6±0.02ms     7.1 MB/sec
parser/large/dataset.py                    1.01      6.5±0.06ms     6.2 MB/sec    1.00      6.4±0.03ms     6.3 MB/sec
parser/numpy/ctypeslib.py                  1.00   1256.5±5.16µs    13.3 MB/sec    1.00   1256.0±5.58µs    13.3 MB/sec
parser/numpy/globals.py                    1.00    127.2±0.61µs    23.2 MB/sec    1.00    126.8±0.73µs    23.3 MB/sec
parser/pydantic/types.py                   1.00      2.8±0.01ms     9.3 MB/sec    1.00      2.7±0.01ms     9.3 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.01     16.4±0.11ms     2.5 MB/sec    1.00     16.3±0.10ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.2±0.05ms     4.0 MB/sec    1.00      4.2±0.06ms     4.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    488.2±6.13µs     6.0 MB/sec    1.00    488.3±6.07µs     6.0 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.9±0.13ms     3.7 MB/sec    1.00      6.9±0.08ms     3.7 MB/sec
linter/default-rules/large/dataset.py      1.01      8.1±0.05ms     5.0 MB/sec    1.00      8.0±0.05ms     5.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01  1724.4±24.04µs     9.7 MB/sec    1.00  1709.0±16.76µs     9.7 MB/sec
linter/default-rules/numpy/globals.py      1.00    193.9±4.86µs    15.2 MB/sec    1.00    194.6±5.14µs    15.2 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.7±0.05ms     7.0 MB/sec    1.00      3.6±0.04ms     7.0 MB/sec
parser/large/dataset.py                    1.02      6.7±0.08ms     6.0 MB/sec    1.00      6.6±0.04ms     6.2 MB/sec
parser/numpy/ctypeslib.py                  1.02  1284.9±13.50µs    13.0 MB/sec    1.00  1258.6±12.15µs    13.2 MB/sec
parser/numpy/globals.py                    1.01    131.2±2.33µs    22.5 MB/sec    1.00    129.4±2.93µs    22.8 MB/sec
parser/pydantic/types.py                   1.02      2.9±0.03ms     8.9 MB/sec    1.00      2.8±0.02ms     9.1 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-14 17:07</div>
            <div class="timeline-body"><p>This looks great, I like the solution you settled on here with the trait-based approach.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-14 17:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_annotations/settings.rs</code>:108 on 2023-05-14 17:11</div>
            <div class="timeline-body"><p>We may be able to code-gen these via a Derive macro (you could look at how <code>ConfigurationOptions</code> works as an example), if you're interested.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/bendoerry">@bendoerry</a> on <code>crates/ruff/src/settings/configuration.rs</code>:317 on 2023-05-14 19:50</div>
            <div class="timeline-body"><p>This part I'm slightly unsure of, I feel like there's a better way of doing this.
I looked at doing something along the lines of</p>
<pre><code class="language-rust">if let (Some(base), Some(other)) = (self, other) {
    Some(base.combine(other))
} else {
    self.or(other)
}
</code></pre>
<p>but ran into an issue with <code>other</code> being used after move.</p>
<p>Seeing as the <code>match</code> statement worked, if being a bit more verbose, I left it at that for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/bendoerry">@bendoerry</a> on <code>crates/ruff/src/rules/flake8_annotations/settings.rs</code>:108 on 2023-05-14 20:03</div>
            <div class="timeline-body"><p>Not done any macro stuff before, but I can give it a go. Would this potentially run into an issue with <a href="https://github.com/charliermarsh/ruff/pull/4431/files#diff-31f36219ba85fb7b29ddb087a9bf221cdec719f50d5af228a2f6e3dc3de1ce1aR79-R83"><code>flake8_gettext</code></a> since this is using a <code>Vec</code> instead of an <code>Option&lt;T&gt;</code>? This is the only occurrence of not using <code>Option&lt;T&gt;</code> that I came across, so arguably I could just not use a derive for that instance, but it does strike me as slightly strange that this isn't an <code>Option&lt;T&gt;</code>. I see no reference/reasoning for the difference given in the associated commits/PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/bendoerry">@bendoerry</a> reviewed on 2023-05-14 20:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-14 22:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_annotations/settings.rs</code>:108 on 2023-05-14 22:24</div>
            <div class="timeline-body"><p>Is that the only field that's not <code>Option</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-14 22:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/settings/configuration.rs</code>:317 on 2023-05-14 22:25</div>
            <div class="timeline-body"><p>I was gonna suggest roughly what you wrote in this comment. Lemme see if I can figure it out.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/bendoerry">@bendoerry</a> reviewed on 2023-05-14 22:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/bendoerry">@bendoerry</a> on <code>crates/ruff/src/rules/flake8_annotations/settings.rs</code>:108 on 2023-05-14 22:29</div>
            <div class="timeline-body"><p>Derive macro ended up not being too difficult to implement once I'd figured out how it worked, so I've handled the <code>Vec&lt;T&gt;</code> field case as well. So now all <code>Options</code> structs have their <code>CombinePluginOptions</code> impls derived (at least the ones that had an impl in the first place).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/bendoerry">@bendoerry</a> reviewed on 2023-05-14 22:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/bendoerry">@bendoerry</a> on <code>crates/ruff/src/rules/flake8_annotations/settings.rs</code>:108 on 2023-05-14 22:41</div>
            <div class="timeline-body"><blockquote>
<p>Is that the only field that's not <code>Option</code>?</p>
</blockquote>
<p>Yep thats the only field in all the plugin options thats not <code>Option</code> that I could find.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-05-15 02:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-05-15 02:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-15 02:36</div>
            <div class="timeline-body"><p>Thanks for this! Really nice PR. I removed the need for <code>Vec</code> support via #4434.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hotpxl">@hotpxl</a> on 2023-05-16 20:22</div>
            <div class="timeline-body"><p>Thanks for doing this!!!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 03:50:42 UTC
    </footer>
</body>
</html>
