<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix incorect placement of trailing stub function comments - astral-sh/ruff #11632</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix incorect placement of trailing stub function comments</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11632">#11632</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-05-31 08:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">Summary
<p>This fixes an issue in the formatter where it reorder comments or, worse, moved trailing stub function comments into the next&#x27;s function body.</p>
<p>The problem is that the formatter uses <code>line_suffix</code> for the trailing comments and the line suffixes are only flushed after the next newline. However, there&#x27;s no such newline directly after the comment(s) because the formatter now allows newlines to be omitted between stub functions.</p>
<p>The fix of this PR is to match Black&#x27;s behavior to insert the empty lines if a collapsed stub has a trailing comment. I&#x27;m not very fond of the empty lines, because I think the comments should remain close to the stub body and not be separated by empty lines but it is consistent with how we format trailing function comments in other places and matches Black.</p>
<p>Closes <a href="https://github.com/astral-sh/ruff/issues/11569">astral-sh/ruff#11569</a></p>
Test Plan
<p>See added tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-05-31 09:10</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-05-31 09:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-05-31 09:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-05-31 09:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/suite.rs</code>:244 on 2024-05-31 09:18</div>
            <div class="timeline-body"><p>This is the actual fix</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-05-31 09:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-05-31 09:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dhruvmanila">@dhruvmanila</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-05-31 09:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;fix function trailing comments&quot; to &quot;Fix misplacement of trailing stub function comments&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-05-31 09:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Fix misplacement of trailing stub function comments&quot; to &quot;Fix incorecty placement of trailing stub function comments&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-05-31 09:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Fix incorecty placement of trailing stub function comments&quot; to &quot;Fix incorect placement of trailing stub function comments&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-05-31 09:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/statement/stub_functions_trailing_comments.py</code>:25 on 2024-05-31 11:10</div>
            <div class="timeline-body"><p>nit: maybe also add a comment before end of file? I think that should also give the same behavior where the formatter will add two empty lines between the function (<code>baz</code>) and the comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2024-05-31 11:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-05-31 12:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-05-31 12:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-05-31 12:06</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:04:20 UTC
    </footer>
</body>
</html>
