<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add diagnostic for integer division by zero - astral-sh/ruff #13576</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add diagnostic for integer division by zero</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13576">#13576</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2024-09-30 21:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>Adds a diagnostic for division by the integer zero in <code>//</code>, <code>/</code>, and <code>%</code>.</p>
<p>Doesn't handle <code>&lt;int&gt; / 0.0</code> because we don't track the values of float literals.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @zanieb on 2024-09-30 21:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @zanieb on 2024-09-30 21:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @zanieb on 2024-09-30 21:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @zanieb on 2024-09-30 21:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2301 on 2024-09-30 21:11</div>
            <div class="timeline-body"><p>I'd remove this TODO as it's not clear that we ever need to do this.</p>
<p>(Interestingly, it looks like neither mypy nor pyright consider division by zero for integers to be a type error. I think we should, since we can, but I don't think this feature alone justifies adding a float literal type.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2308 on 2024-09-30 21:13</div>
            <div class="timeline-body"><p>Not sure if we should infer <code>Unknown</code> here, or go ahead and infer <code>builtins_symbol_ty(db, &quot;float&quot;)</code> (or int for FloorDiv) despite the error? No other type would be reasonable for checking subsequent code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2318 on 2024-09-30 21:14</div>
            <div class="timeline-body"><pre><code class="language-suggestion">                // It should be impossible to hit this as we handle division by zero above and
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-09-30 21:14</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2322 on 2024-09-30 21:15</div>
            <div class="timeline-body"><p>I'd be fine with turning this into an <code>expect</code> -- if the comment above is wrong, I'd rather find out loudly so we can consider that case, rather than just silently get Unknown.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-09-30 21:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:4212 on 2024-09-30 21:16</div>
            <div class="timeline-body"><p>We could want a special message for modulo.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:4178 on 2024-09-30 21:16</div>
            <div class="timeline-body"><p>I would rather have this as a separate test case function.</p>
<p>Though since it will all change with test framework anyway, it's OK to not bother.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-09-30 21:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-09-30 21:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2301 on 2024-09-30 21:22</div>
            <div class="timeline-body"><p>We can support a diagnostic for <code>1.0 / 0</code> today without tracking float literals though, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2308 on 2024-09-30 21:23</div>
            <div class="timeline-body"><p>I'm not sure. I defer to you. It seems fairly reasonable either way, though not using <code>Unknown</code> lets us check more code in a single invocation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-09-30 21:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-09-30 21:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2301 on 2024-09-30 21:25</div>
            <div class="timeline-body"><p>Oh true, I guess I didn't know which this todo referred to. And that reminds me, I forgot to reply to your comment about handling non-literal types. Will do that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-09-30 21:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2308 on 2024-09-30 21:26</div>
            <div class="timeline-body"><p>Yeah, I think I'd favor inferring float or int rather than Unknown here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-09-30 21:27</div>
            <div class="timeline-body"><blockquote>
<p>Doesn't handle <code>&lt;float&gt; / 0</code> because it's not clear to me what the proper pattern is to match that type. I presume I would check for equality after looking up the builtin?</p>
</blockquote>
<p>I think it should be something like a match pattern for <code>Type::Instance(cls) if cls.is_stdlib_symbol(db, &quot;builtins&quot;, &quot;float&quot;)</code> to match the float type; similar for int.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-09-30 21:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2322 on 2024-09-30 21:55</div>
            <div class="timeline-body"><p>I did some refactoring here in light of the desire for retaining the return types as in https://github.com/astral-sh/ruff/pull/13576#discussion_r1781740580</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @zanieb on 2024-09-30 22:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-30 22:14</div>
            <div class="timeline-body"><p>I made some relatively significant changes per the review. Thanks again Carl.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-09-30 22:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2342 on 2024-09-30 22:20</div>
            <div class="timeline-body"><p>Per discussion, division by zero (and overflows, which should never occur here) don't matter when determining the inferred type.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:520 on 2024-09-30 22:25</div>
            <div class="timeline-body"><p>For @AlexWaygood ;)</p>
<pre><code class="language-suggestion">            format_args!(&quot;Cannot divide object of type '{}' by zero.&quot;, left.display(self.db),),
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:4212 on 2024-09-30 22:27</div>
            <div class="timeline-body"><p>Modulo requires division to calculate, so I think the error message is accurate and adequate as is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-09-30 22:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-09-30 22:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:4212 on 2024-09-30 22:34</div>
            <div class="timeline-body"><p>Agree, but not all beginners may realize that! Seems fine unless we receive significant feedback though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2024-09-30 22:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-09-30 22:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-09-30 22:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-01 10:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:4212 on 2024-10-01 10:31</div>
            <div class="timeline-body"><p>Yeah I agree with @zanieb here -- the current message is entirely accurate, but I think even your <em>average</em> Python user (letalone a beginner) doesn't necessarily think about modulo operations in terms of their desugared sub-operations, so I think encountering this error message here might be pretty surprising to a lot of our users. It's definitely not the biggest issue in the world, but I think a better error message here would be really worthwhile (and I actually think it's probably better to do it now before we forget about it)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:06:48 UTC
    </footer>
</body>
</html>
