<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Support &quot;legacy&quot; `typing.Self` in combination with PEP 695 generic contexts - astral-sh/ruff #20304</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Support &quot;legacy&quot; <code>typing.Self</code> in combination with PEP 695 generic contexts</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20304">#20304</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-09-08 11:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body">Summary
<p>Support cases like the following, where we need the generic context to include both <code>Self</code> and <code>T</code> (not just <code>T</code>):</p>
<pre><code>from typing import Self

class C:
    def method[T](self: Self, arg: T): ...

C().method(1)
</code></pre>
<p>closes <a href="https://github.com/astral-sh/ty/issues/1131">astral-sh/ty#1131</a></p>
Test Plan
<p>Added regression test</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-08 11:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-08 11:56</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-08 12:02</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-08 12:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-08 12:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-08 12:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-08 12:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-09-08 12:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/signatures.rs</code>:380 on 2025-09-08 12:18</div>
            <div class="timeline-body"><p>The previous comment here indicates that this is probably not the right fix, but I don&#x27;t see an immediate problem with merging legacy typevars and PEP 695 typevars in a single method, and it solves the problem with <code>self: Self</code>. So I&#x27;m opening this for discussion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-09-08 12:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/signatures.rs</code>:380 on 2025-09-08 12:27</div>
            <div class="timeline-body"><p>yes... I think it&#x27;s invalid to combine legacy and PEP-695 type variables in general... but I think the sole exception to this rule is probably <code>Self</code>, which I <em>guess</em> counts as a &quot;legacy type variable&quot;, but is obviously different in several ways to most legacy type variables</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-09-08 12:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/signatures.rs</code>:380 on 2025-09-08 12:44</div>
            <div class="timeline-body"><p>Yes, https://peps.python.org/pep-0695/#compatibility-with-traditional-typevars states that this is not legal in all situations. Maybe this indicates that implicit <code>self</code> should work differently for functions with an explicit <code>[S, T, U, …]</code> PEP 695 generic context. Maybe those functions shouldn&#x27;t use <code>typing.Self</code>, but rather explicitly add a new synthetic type variable to this context: <code>[_Self: C, S, T, U, …]</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-09-08 12:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/signatures.rs</code>:380 on 2025-09-08 12:53</div>
            <div class="timeline-body"><p>The <a href="https://typing.python.org/en/latest/spec/generics.html#self">section about <code>typing.Self</code></a> doesn&#x27;t seem to explicitly say one way or the other whether it&#x27;s allowed in a PEP 695 generic function. I think it&#x27;s worth supporting, and I think a slight modification to this approach is the right way to handle it.</p>
<p>Instead of merging the <em>entirety</em> of the legacy generic context, I would suggest looking to see if it contains (only) <code>typing.Self</code>. If so, add it to the PEP 695 generic context. If not, continue to &quot;TODO: raise a diagnostic&quot;.</p>
<p>(Note that we do have a distinct <code>TypeVarKind::TypingSelf</code> for <code>typing.Self</code>, so it should be easy to distinguish from &quot;real&quot; legacy typevars.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-09-08 12:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/signatures.rs</code>:380 on 2025-09-08 12:57</div>
            <div class="timeline-body"><blockquote>
<p>Maybe those functions shouldn&#x27;t use <code>typing.Self</code>, but rather explicitly add a new synthetic type variable to this context: <code>[_Self: C, S, T, U, …]</code>.</p>
</blockquote>
<p>Hmm, I don&#x27;t think the intention was to deprecate <code>typing.Self</code> as part of PEP 695. I think the PEP would have stated this explicitly if that was the intention.</p>
<p>Adding <code>Self</code> to the type system didn&#x27;t make it possible to express anything in type annotations that couldn&#x27;t be expressed before (except <em>maybe</em> in attribute annotations): it just made a common case much less verbose and much more ergonomic. Before you would have done this:</p>
<pre><code>from typing import TypeVar

_SelfT = TypeVar(&quot;_SelfT&quot;, bound=&quot;MyClass&quot;)

class MyClass:
    def method(self: _SelfT) -&gt; SelfT:
        return self
</code></pre>
<p>and after the introduction of <code>Self</code>, you would do this:</p>
<pre><code>from typing import Self

class MyClass:
    def method(self) -&gt; Self:
        return self
</code></pre>
<p>And the two mean exactly the same thing. The ergonomics argument for <code>Self</code> maybe isn&#x27;t quite as strong for methods that use PEP-695 parameters, since there&#x27;s no need to declare the type variable outside the body of the method anymore -- but I still think I&#x27;d find it a pain to have to explicitly include it in the type parameter list every time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-09-08 13:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/signatures.rs</code>:380 on 2025-09-08 13:11</div>
            <div class="timeline-body"><p>Yes, I didn&#x27;t mean to imply that PEP 695 made <code>typing.Self</code> unnecessary. I was trying to illustrate the inner workings of a type checker that encounters <code>def pep695_method[T](self, x: T)</code>. And it makes sense to me that this would be syntactic sugar for <code>def pep695_method[_Self: MyClass, T](self: _Self, x: T)</code> instead of <code>def pep605_method[T](self: typing.Self, x: T)</code>, because the former wouldn&#x27;t have to mix legacy and PEP 695 type variables.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-09-08 13:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/signatures.rs</code>:380 on 2025-09-08 13:13</div>
            <div class="timeline-body"><blockquote>
<p>Before you would have done this:</p>
<pre><code>from typing import TypeVar

_SelfT = TypeVar(&quot;_SelfT&quot;, bound=&quot;MyClass&quot;)

class MyClass:
    def method(self: _SelfT) -&gt; SelfT:
        return self
</code></pre>
</blockquote>
<p>I don&#x27;t think they&#x27;re equivalent, since <code>Self</code> does something more sophisticated with the bound:</p>
<pre><code>from typing import Self

class Base:
    def method(self: Self, other: Self) -&gt; None: ...

class Sub(Base): ...

Sub().method(Base())  # error: [invalid-argument-type]
</code></pre>
<p>i.e. the upper bound of <code>Self</code> is that class that you access the method from (which can be different for different member accesses!), not the class where it&#x27;s defined.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-09-08 13:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/signatures.rs</code>:380 on 2025-09-08 13:14</div>
            <div class="timeline-body"><p>(Though my point about them not being equivalent is a <em>stronger</em> argument in favor of what you&#x27;re suggesting, @AlexWaygood, which is that we should support <code>Self</code> in PEP 695 methods!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-09-08 13:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/signatures.rs</code>:380 on 2025-09-08 13:41</div>
            <div class="timeline-body"><blockquote>
<p>it makes sense to me that this would be syntactic sugar for <code>def pep695_method[_Self: MyClass, T](self: _Self, x: T)</code> instead of <code>def pep605_method[T](self: typing.Self, x: T)</code>, because the former wouldn&#x27;t have to mix legacy and PEP 695 type variables.</p>
</blockquote>
<p>Yeah, that makes sense to me too</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/signatures.rs</code>:380 on 2025-09-08 13:42</div>
            <div class="timeline-body"><blockquote>
<p>I don&#x27;t think they&#x27;re equivalent, since <code>Self</code> does something more sophisticated with the bound:</p>
</blockquote>
<p>(We discussed this example on Discord -- other type checkers have the same behaviour on this snippet if you use a legacy TypeVar with an upper bound, and we should probably aim to have that behaviour too in the long run!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-09-08 13:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-08 13:49</div>
            <div class="timeline-body"><p>This change removes ~800 false positives across the ecosystem when based on <a href="https://github.com/astral-sh/ruff/pull/20303">astral-sh/ruff#20303</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[ty] Merge legacy and PEP 695 generic contexts&quot; to &quot;[ty] Support &quot;legacy&quot; `typing.Self` in combination with PEP 695 generic contexts&quot; by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-08 14:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-09-08 14:17</div>
            <div class="timeline-body"><p>This looks reasonable to me now that it only applies to <code>Self</code>, but I&#x27;d appreciate it if @dcreager could take another look!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/signatures.rs</code>:384 on 2025-09-08 14:40</div>
            <div class="timeline-body"><p>:sob: TIL <code>exactly_one</code>, I&#x27;ve been looking for an adapter like that forever!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> approved on 2025-09-08 14:40</div>
            <div class="timeline-body"><p>Looks good!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-08 14:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-08 14:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-09-08 14:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-09-08 16:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/signatures.rs</code>:380 on 2025-09-08 16:33</div>
            <div class="timeline-body"><blockquote>
<p>we should probably aim to have that behaviour too in the long run</p>
</blockquote>
<p>I don&#x27;t think that behavior is right, either for <code>typing.Self</code> or for an explicit typevar -- discussed more on Discord.</p>
<blockquote>
<p>it makes sense to me that this would be syntactic sugar for <code>def pep695_method[_Self: MyClass, T](self: _Self, x: T)</code> instead of <code>def pep605_method[T](self: typing.Self, x: T)</code>, because the former wouldn&#x27;t have to mix legacy and PEP 695 type variables.</p>
</blockquote>
<p>Is this a distinction that matters in any practical way? Ultimately legacy and PEP 695 typevars are the same thing, the only difference is that they are declared differently -- and in the case of un-annotated <code>self</code>, there is no explicit declaration, so that sole difference disappears, too. And if explicit <code>typing.Self</code> annotations are allowed in a PEP 695 generic method signature, then the need to mix <code>typing.Self</code> with PEP 695 generic contexts exists regardless.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-09-08 17:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/signatures.rs</code>:380 on 2025-09-08 17:56</div>
            <div class="timeline-body"><blockquote>
<p>Is this a distinction that matters in any practical way?</p>
</blockquote>
<p>Not if <code>typing.Self</code>, <code>TypeVar(&quot;_SelfT&quot;, bound=&quot;MyClass&quot;)</code>, and <code>[_Self: MyClass]</code> all behave the same in all situations. From what I understand now, this is the case (which is a relief). I think I was maybe confused by the fact that <code>TypeVarKind::TypingSelf</code> exists, implying that it needs special treatment somehow (and @dcreager&#x27;s example seemed to indicate that, but apparently that is just wrong behavior of other type checkers).</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:18:27 UTC
    </footer>
</body>
</html>
