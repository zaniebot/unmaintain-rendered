<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Improve completion ranking based on origin and exact match - astral-sh/ruff #22460</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Improve completion ranking based on origin and exact match</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22460">#22460</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2026-01-08 16:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a></div>
            <div class="timeline-body"><p>This PR does some refactoring to completions and improves ranking based
on the origin of the symbol and whether there is an exact match.</p>
<p>This addresses a lot of the feedback around preferring, e.g., symbols
from <code>typing</code> over symbols from other stdlib modules. This also
establishes a more general preference ordering for symbols based on
their origin: current module, project modules, third party modules and
then stdlib modules.</p>
<p>Finally, we give very high ranking to symbols that exactly match what
the end user has typed.</p>
<p>Reviewers are encouraged to read this PR commit-by-commit.</p>
<p>Fixes astral-sh/ty#1274</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2026-01-08 16:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2026-01-08 16:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2026-01-08 16:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/Gankra">@Gankra</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2026-01-08 16:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2026-01-08 16:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2026-01-08 16:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/dcreager">@dcreager</a> removed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2026-01-08 16:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/carljm">@carljm</a> removed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2026-01-08 16:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/Gankra">@Gankra</a> removed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2026-01-08 16:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/sharkdp">@sharkdp</a> removed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2026-01-08 16:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2026-01-08 16:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2026-01-08 16:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2026-01-08 16:09</div>
            <div class="timeline-body"><p>cc @RasmusNygren in case you want to review here. In particular the refactoring in the earlier commits here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-08 16:09</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-08 16:10</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>Tanjun (https://github.com/FasterSpeeding/Tanjun)
- tanjun/dependencies/data.py:347:12: error[invalid-return-type] Return type does not match returned value: expected `_T@cached_inject`, found `_T@cached_inject | Coroutine[Any, Any, _T@cached_inject | Coroutine[Any, Any, _T@cached_inject]]`
+ tanjun/dependencies/data.py:347:12: error[invalid-return-type] Return type does not match returned value: expected `_T@cached_inject`, found `Coroutine[Any, Any, _T@cached_inject | Coroutine[Any, Any, _T@cached_inject]] | _T@cached_inject`

prefect (https://github.com/PrefectHQ/prefect)
- src/prefect/deployments/runner.py:795:70: warning[possibly-missing-attribute] Attribute `__name__` may be missing on object of type `Unknown | (((...) -&gt; Any) &amp; ((*args: object, **kwargs: object) -&gt; object))`
+ src/prefect/deployments/runner.py:795:70: warning[possibly-missing-attribute] Attribute `__name__` may be missing on object of type `Unknown | ((...) -&gt; Any)`
+ src/prefect/flow_engine.py:812:32: error[invalid-await] `Unknown | R@FlowRunEngine | Coroutine[Any, Any, R@FlowRunEngine]` is not awaitable
+ src/prefect/flow_engine.py:1401:24: error[invalid-await] `Unknown | R@AsyncFlowRunEngine | Coroutine[Any, Any, R@AsyncFlowRunEngine]` is not awaitable
+ src/prefect/flow_engine.py:1482:43: error[invalid-argument-type] Argument to function `next` is incorrect: Expected `SupportsNext[Unknown]`, found `Unknown | R@run_generator_flow_sync`
+ src/prefect/flow_engine.py:1490:21: warning[possibly-missing-attribute] Attribute `throw` may be missing on object of type `Unknown | R@run_generator_flow_sync`
+ src/prefect/flow_engine.py:1524:44: warning[possibly-missing-attribute] Attribute `__anext__` may be missing on object of type `Unknown | R@run_generator_flow_async`
+ src/prefect/flow_engine.py:1531:25: warning[possibly-missing-attribute] Attribute `throw` may be missing on object of type `Unknown | R@run_generator_flow_async`
- src/prefect/flows.py:286:34: error[unresolved-attribute] Object of type `((**P@Flow) -&gt; R@Flow) &amp; ((*args: object, **kwargs: object) -&gt; object)` has no attribute `__name__`
+ src/prefect/flows.py:286:34: error[unresolved-attribute] Object of type `(**P@Flow) -&gt; R@Flow` has no attribute `__name__`
- src/prefect/flows.py:404:68: error[unresolved-attribute] Object of type `((**P@Flow) -&gt; R@Flow) &amp; ((*args: object, **kwargs: object) -&gt; object)` has no attribute `__name__`
+ src/prefect/flows.py:404:68: error[unresolved-attribute] Object of type `(**P@Flow) -&gt; R@Flow` has no attribute `__name__`
- src/prefect/flows.py:1750:53: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 5363 diagnostics
+ Found 5368 diagnostics

static-frame (https://github.com/static-frame/static-frame)
- static_frame/core/index.py:580:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[TVContainer_co@loc, TVDtype@Index]`, found `InterGetItemLocReduces[Any | Bottom[Series[Any, Any]], TVDtype@Index]`
+ static_frame/core/index.py:580:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[TVContainer_co@loc, TVDtype@Index]`, found `InterGetItemLocReduces[Bottom[Series[Any, Any]] | Any, TVDtype@Index]`
+ static_frame/core/series.py:772:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Series[Any, Any], TVDtype@Series]`, found `InterGetItemILocReduces[Series[Any, Any] | Bottom[Index[Any]] | TypeBlocks | ... omitted 6 union elements, TVDtype@Series]`
- static_frame/core/series.py:4072:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[SeriesHE[Any, Any], TVDtype@SeriesHE]`, found `InterGetItemILocReduces[Bottom[Series[Any, Any]] | ndarray[Never, Never] | TypeBlocks | ... omitted 7 union elements, TVDtype@SeriesHE]`
+ static_frame/core/series.py:4072:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[SeriesHE[Any, Any], TVDtype@SeriesHE]`, found `InterGetItemILocReduces[Bottom[Series[Any, Any]] | Bottom[Index[Any]] | TypeBlocks | ... omitted 7 union elements, TVDtype@SeriesHE]`
- Found 1837 diagnostics
+ Found 1838 diagnostics

pandas-stubs (https://github.com/pandas-dev/pandas-stubs)
+ pandas-stubs/_typing.pyi:1232:16: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 5160 diagnostics
+ Found 5161 diagnostics


</code></pre>


<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/completion.rs</code>:358 on 2026-01-09 08:36</div>
            <div class="timeline-body"><p>Nit: You could use <code>format_compact</code> here:</p>
<p>https://docs.rs/compact_str/latest/compact_str/macro.format_compact.html</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/completion.rs</code>:285 on 2026-01-09 08:39</div>
            <div class="timeline-body"><p>Should we make the fields on <code>Completion</code> private and expose getter methods instead to ensure a <code>Completion</code> is never modified after computing its relevance?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/completion.rs</code>:117 on 2026-01-09 08:47</div>
            <div class="timeline-body"><p>Could <code>Completion</code> import <code>PartialOrd</code> and <code>Ord</code> now that <code>Relevance</code> is stored on the <code>Completion</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/all_symbols.rs</code>:70 on 2026-01-09 08:50</div>
            <div class="timeline-body"><p>Oops, I think that&#x27;s on me. I&#x27;m not sure how verbose <code>file</code> is but we might want to use <code>file.path(db)</code> here :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_completion_eval/truth/typing-gets-priority/main.py</code>:19 on 2026-01-09 08:53</div>
            <div class="timeline-body"><p>I&#x27;m curious how this plays out. E.g. it could be annoying to get a suggestion for a non stdlib <code>Ordering</code> just because someone ended up naming their class <code>Ordering</code> somewhere in a 2 Million-line project :) But I think it&#x27;s a good start and we can wait on user reports to see how to improve completions further (e.g. consider the distance between two modules)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/completion.rs</code>:1170 on 2026-01-09 08:57</div>
            <div class="timeline-body"><p>Is it intentional that we prioritize third-party dependencies over stdlib?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/completion.rs</code>:1172 on 2026-01-09 08:59</div>
            <div class="timeline-body"><p>I guess it&#x27;s safe to compare by name here but I would probably still use <code>module.is_known</code> over matching by name, given that we have this API</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2026-01-09 09:01</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2026-01-09 13:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:285 on 2026-01-09 13:21</div>
            <div class="timeline-body"><p>That&#x27;s kinda my inclination personally, yeah. Even aside from this new <code>Relevance</code> thing being attached to <code>Completion</code>.</p>
<p>I&#x27;ll try this out in a follow-up PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2026-01-09 13:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:117 on 2026-01-09 13:23</div>
            <div class="timeline-body"><p>It could, but I at least for now chose not to do that. See the <code>rank</code> function docs:</p>
<pre><code>/// Return an ordering relating the two completions.
///
/// A `Ordering::Less` is returned when `c1` should be ranked above
/// `c2`. A `Ordering::Greater` is returned when `c1` should be ranked
/// below `c2`. In other words, a standard ascending sort used with
/// this comparison routine will yields the &quot;best ranked&quot; completions
/// first.
///
/// Note that this could have been implemented via `Eq` and `Ord`
/// impls on `Completion`, but is instead a separate function to avoid
/// conflating relevance ranking with identity.
fn rank(c1: &amp;Completion&lt;&#x27;_&gt;, c2: &amp;Completion&lt;&#x27;_&gt;) -&gt; Ordering {
    (&amp;c1.relevance, &amp;c1.name).cmp(&amp;(&amp;c2.relevance, &amp;c2.name))
}
</code></pre>
<p>(I think it&#x27;s possible we do ultimately do this.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_completion_eval/truth/typing-gets-priority/main.py</code>:19 on 2026-01-09 13:52</div>
            <div class="timeline-body"><p>Yeah I&#x27;m definitely not 100% sold on this either. Very curious to get user feedback on this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2026-01-09 13:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2026-01-09 13:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:1170 on 2026-01-09 13:55</div>
            <div class="timeline-body"><p>That was my thinking yeah. With the idea being that third party dependencies are &quot;more specific&quot; to the user&#x27;s context.</p>
<p>But this may very well be overruled by the ubiquity and frequency of use for stdlib packages.</p>
<p>Another factor here is that it&#x27;s <em>all</em> third party code, not just direct dependencies. So it&#x27;s likelier to be noisier.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2026-01-09 13:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:1172 on 2026-01-09 13:57</div>
            <div class="timeline-body"><p>Fair enough!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-09 14:09</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2026-01-09 14:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/completion.rs</code>:1170 on 2026-01-09 14:14</div>
            <div class="timeline-body"><p>Yeah, my thinking here is: if something&#x27;s available in the standard library, I probably want to use that over any third-party equivalent.</p>
<p>I&#x27;m also surprised that this doesn&#x27;t regress the <code>typing</code> use case, or import <code>os</code> as they are now both less specific than a similarly named module in any third-party library.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2026-01-09 14:20</div>
            <div class="timeline-body"><p>I checked out the mypy_primer differences, but they look like flakes. When I re-run it, it still reports differences, but <em>different</em> differences from the previous run. Since there&#x27;s no conspicuous change in this PR that should lead to such differences, I&#x27;m assuming they are flakes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2026-01-09 14:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:1170 on 2026-01-09 14:43</div>
            <div class="timeline-body"><p>For <code>typing</code>, a lot of the conflicts come from other standard library modules.</p>
<p>The reason why I went this route was this evaluation task:</p>
<pre><code># This test was originally written to
# check that a third party dependency
# gets priority over stdlib. But it was
# not clearly the right choice[1].
#
# 2026-01-09: We stuck with it for now,
# but it seems likely that we&#x27;ll want
# to regress this task in favor of
# another.
#
# [1]: <a href="https://github.com/astral-sh/ruff/pull/22460">astral-sh/ruff#22460</a>#discussion_r2676343225
fullma&lt;CURSOR: regex.fullmatch&gt;
</code></pre>
<p>Where <code>pyproject.toml</code> contains the <code>regex</code> dependency. In this context, you probably want <code>fullmatch</code> from <code>regex</code> over the stdlib <code>re</code> module. I assume this applies to other third party packages that provide a drop-in replacement for stdlib modules. But maybe this case isn&#x27;t more important than the ones you point out.</p>
<p>I added the comment above in response here. I think you&#x27;re ultimately going to be right here, but I&#x27;d like to iterate on this in response to user feedback.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2026-01-09 14:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2026-01-09 14:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2026-01-09 14:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/RasmusNygren">@RasmusNygren</a> reviewed on 2026-01-09 19:14</div>
            <div class="timeline-body"><p>LGTM!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:22:48 UTC
    </footer>
</body>
</html>
