<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix python_formatter generate.py with rust path - astral-sh/ruff #5475</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix python_formatter generate.py with rust path</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5475">#5475</a>
        opened by <a href="https://github.com/LouisDISPA">@LouisDISPA</a>
        on 2023-07-03 12:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/LouisDISPA">@LouisDISPA</a></div>
            <div class="timeline-body">Summary
<p>This PR fix an issue with the <code>generate.py</code> file of the python formatter.<br>
Since <a href="https://github.com/astral-sh/ruff/pull/5369">astral-sh/ruff#5369</a> the <a href="https://github.com/astral-sh/ruff/blob/f51dc204979964b7a7d9a2469c0c1b0c06d26980/crates/ruff_python_ast/src/node.rs">node.rs file</a> used to generate the types now has <code>ast::</code> in the enum.</p>
<pre><code>pub enum AnyNode {
   ModModule(ModModule),
   ModInteractive(ModInteractive),
   ModExpression(ModExpression),
   ModFunctionType(ModFunctionType),
   ...
</code></pre>
<p>And now:</p>
<pre><code>pub enum AnyNode {
   ModModule(ast::ModModule),
   ModInteractive(ast::ModInteractive),
   ModExpression(ast::ModExpression),
   ModFunctionType(ast::ModFunctionType),
   ...
</code></pre>
<p>The python script was not parsing rust paths. This PR adds the possibility to have it.</p>
Test Plan
<p>This was tested locally.</p>
Script output
<p>Before</p>
<pre><code>[&#x27;ast::ModModule),&#x27;, &#x27;ast::ModInteractive),&#x27;, &#x27;ast::ModExpression),&#x27;, &#x27;ast::ModFunctionType),&#x27;, &#x27;ast::StmtFunctionDef),&#x27;, &#x27;ast::StmtAsyncFunctionDef),&#x27;, &#x27;ast::StmtClassDef),&#x27;, &#x27;ast::StmtReturn),&#x27;, &#x27;ast::StmtDelete),&#x27;, &#x27;ast::StmtAssign),&#x27;, &#x27;ast::StmtAugAssign),&#x27;, &#x27;ast::StmtAnnAssign),&#x27;, &#x27;ast::StmtFor),&#x27;, &#x27;ast::StmtAsyncFor),&#x27;, &#x27;ast::StmtWhile),&#x27;, &#x27;ast::StmtIf),&#x27;, &#x27;ast::StmtWith),&#x27;, &#x27;ast::StmtAsyncWith),&#x27;, &#x27;ast::StmtMatch),&#x27;, &#x27;ast::StmtRaise),&#x27;, &#x27;ast::StmtTry),&#x27;, &#x27;ast::StmtTryStar),&#x27;, &#x27;ast::StmtAssert),&#x27;, &#x27;ast::StmtImport),&#x27;, &#x27;ast::StmtImportFrom),&#x27;, &#x27;ast::StmtGlobal),&#x27;, &#x27;ast::StmtNonlocal),&#x27;, &#x27;ast::StmtExpr),&#x27;, &#x27;ast::StmtPass),&#x27;, &#x27;ast::StmtBreak),&#x27;, &#x27;ast::StmtContinue),&#x27;, &#x27;ast::ExprBoolOp),&#x27;, &#x27;ast::ExprNamedExpr),&#x27;, &#x27;ast::ExprBinOp),&#x27;, &#x27;ast::ExprUnaryOp),&#x27;, &#x27;ast::ExprLambda),&#x27;, &#x27;ast::ExprIfExp),&#x27;, &#x27;ast::ExprDict),&#x27;, &#x27;ast::ExprSet),&#x27;, &#x27;ast::ExprListComp),&#x27;, &#x27;ast::ExprSetComp),&#x27;, &#x27;ast::ExprDictComp),&#x27;, &#x27;ast::ExprGeneratorExp),&#x27;, &#x27;ast::ExprAwait),&#x27;, &#x27;ast::ExprYield),&#x27;, &#x27;ast::ExprYieldFrom),&#x27;, &#x27;ast::ExprCompare),&#x27;, &#x27;ast::ExprCall),&#x27;, &#x27;ast::ExprFormattedValue),&#x27;, &#x27;ast::ExprJoinedStr),&#x27;, &#x27;ast::ExprConstant),&#x27;, &#x27;ast::ExprAttribute),&#x27;, &#x27;ast::ExprSubscript),&#x27;, &#x27;ast::ExprStarred),&#x27;, &#x27;ast::ExprName),&#x27;, &#x27;ast::ExprList),&#x27;, &#x27;ast::ExprTuple),&#x27;, &#x27;ast::ExprSlice),&#x27;, &#x27;ast::ExceptHandlerExceptHandler),&#x27;, &#x27;ast::PatternMatchValue),&#x27;, &#x27;ast::PatternMatchSingleton),&#x27;, &#x27;ast::PatternMatchSequence),&#x27;, &#x27;ast::PatternMatchMapping),&#x27;, &#x27;ast::PatternMatchClass),&#x27;, &#x27;ast::PatternMatchStar),&#x27;, &#x27;ast::PatternMatchAs),&#x27;, &#x27;ast::PatternMatchOr),&#x27;, &#x27;ast::TypeIgnoreTypeIgnore),&#x27;, &#x27;Comprehension),&#x27;, &#x27;Arguments),&#x27;, &#x27;Arg),&#x27;, &#x27;ArgWithDefault),&#x27;, &#x27;Keyword),&#x27;, &#x27;Alias),&#x27;, &#x27;WithItem),&#x27;, &#x27;MatchCase),&#x27;, &#x27;Decorator),&#x27;]

error: unexpected closing delimiter: `)`
 --&gt; &lt;stdin&gt;:3:55
  |
2 |             use ruff_formatter::{write, Buffer, FormatResult};
  |                                 - this opening brace...     - ...matches this closing brace
3 |             use rustpython_parser::ast::ast::ModModule),;
  |                                                       ^ unexpected closing delimiter

Traceback (most recent call last):
  File &quot;/Users/ldispa/Documents/perso/ruff/crates/ruff_python_formatter/generate.py&quot;, line 100, in &lt;module&gt;
    node_path.write_text(rustfmt(code))
                         ^^^^^^^^^^^^^
  File &quot;/Users/ldispa/Documents/perso/ruff/crates/ruff_python_formatter/generate.py&quot;, line 12, in rustfmt
    return check_output([&quot;rustfmt&quot;, &quot;--emit=stdout&quot;], input=code, text=True)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/opt/homebrew/Cellar/python@3.11/3.11.4_1/Frameworks/Python.framework/Versions/3.11/lib/python3.11/subprocess.py&quot;, line 466, in check_output
    return run(*popenargs, stdout=PIPE, timeout=timeout, check=True,
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/opt/homebrew/Cellar/python@3.11/3.11.4_1/Frameworks/Python.framework/Versions/3.11/lib/python3.11/subprocess.py&quot;, line 571, in run
    raise CalledProcessError(retcode, process.args,
subprocess.CalledProcessError: Command &#x27;[&#x27;rustfmt&#x27;, &#x27;--emit=stdout&#x27;]&#x27; returned non-zero exit status 1.
</code></pre>
<p>After:</p>
<pre><code>[&#x27;ModModule&#x27;, &#x27;ModInteractive&#x27;, &#x27;ModExpression&#x27;, &#x27;ModFunctionType&#x27;, &#x27;StmtFunctionDef&#x27;, &#x27;StmtAsyncFunctionDef&#x27;, &#x27;StmtClassDef&#x27;, &#x27;StmtReturn&#x27;, &#x27;StmtDelete&#x27;, &#x27;StmtAssign&#x27;, &#x27;StmtAugAssign&#x27;, &#x27;StmtAnnAssign&#x27;, &#x27;StmtFor&#x27;, &#x27;StmtAsyncFor&#x27;, &#x27;StmtWhile&#x27;, &#x27;StmtIf&#x27;, &#x27;StmtWith&#x27;, &#x27;StmtAsyncWith&#x27;, &#x27;StmtMatch&#x27;, &#x27;StmtRaise&#x27;, &#x27;StmtTry&#x27;, &#x27;StmtTryStar&#x27;, &#x27;StmtAssert&#x27;, &#x27;StmtImport&#x27;, &#x27;StmtImportFrom&#x27;, &#x27;StmtGlobal&#x27;, &#x27;StmtNonlocal&#x27;, &#x27;StmtExpr&#x27;, &#x27;StmtPass&#x27;, &#x27;StmtBreak&#x27;, &#x27;StmtContinue&#x27;, &#x27;ExprBoolOp&#x27;, &#x27;ExprNamedExpr&#x27;, &#x27;ExprBinOp&#x27;, &#x27;ExprUnaryOp&#x27;, &#x27;ExprLambda&#x27;, &#x27;ExprIfExp&#x27;, &#x27;ExprDict&#x27;, &#x27;ExprSet&#x27;, &#x27;ExprListComp&#x27;, &#x27;ExprSetComp&#x27;, &#x27;ExprDictComp&#x27;, &#x27;ExprGeneratorExp&#x27;, &#x27;ExprAwait&#x27;, &#x27;ExprYield&#x27;, &#x27;ExprYieldFrom&#x27;, &#x27;ExprCompare&#x27;, &#x27;ExprCall&#x27;, &#x27;ExprFormattedValue&#x27;, &#x27;ExprJoinedStr&#x27;, &#x27;ExprConstant&#x27;, &#x27;ExprAttribute&#x27;, &#x27;ExprSubscript&#x27;, &#x27;ExprStarred&#x27;, &#x27;ExprName&#x27;, &#x27;ExprList&#x27;, &#x27;ExprTuple&#x27;, &#x27;ExprSlice&#x27;, &#x27;ExceptHandlerExceptHandler&#x27;, &#x27;PatternMatchValue&#x27;, &#x27;PatternMatchSingleton&#x27;, &#x27;PatternMatchSequence&#x27;, &#x27;PatternMatchMapping&#x27;, &#x27;PatternMatchClass&#x27;, &#x27;PatternMatchStar&#x27;, &#x27;PatternMatchAs&#x27;, &#x27;PatternMatchOr&#x27;, &#x27;TypeIgnoreTypeIgnore&#x27;, &#x27;Comprehension&#x27;, &#x27;Arguments&#x27;, &#x27;Arg&#x27;, &#x27;ArgWithDefault&#x27;, &#x27;Keyword&#x27;, &#x27;Alias&#x27;, &#x27;WithItem&#x27;, &#x27;MatchCase&#x27;, &#x27;Decorator&#x27;]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-07-03 12:55</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>✅ ecosystem check detected no changes.</p>
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01      9.6±0.29ms     4.2 MB/sec    1.00      9.5±0.28ms     4.3 MB/sec
formatter/numpy/ctypeslib.py               1.01      2.1±0.09ms     7.9 MB/sec    1.00      2.1±0.10ms     7.9 MB/sec
formatter/numpy/globals.py                 1.00   237.9±10.83µs    12.4 MB/sec    1.02   243.8±10.34µs    12.1 MB/sec
formatter/pydantic/types.py                1.00      4.5±0.12ms     5.6 MB/sec    1.01      4.6±0.16ms     5.6 MB/sec
linter/all-rules/large/dataset.py          1.00     17.1±0.45ms     2.4 MB/sec    1.01     17.3±0.33ms     2.4 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.1±0.10ms     4.0 MB/sec    1.00      4.1±0.10ms     4.0 MB/sec
linter/all-rules/numpy/globals.py          1.00   545.3±30.02µs     5.4 MB/sec    1.00   543.5±12.82µs     5.4 MB/sec
linter/all-rules/pydantic/types.py         1.02      7.5±0.45ms     3.4 MB/sec    1.00      7.4±0.13ms     3.4 MB/sec
linter/default-rules/large/dataset.py      1.00      8.2±0.23ms     5.0 MB/sec    1.00      8.2±0.14ms     5.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1787.2±68.91µs     9.3 MB/sec    1.01  1799.1±100.47µs     9.3 MB/sec
linter/default-rules/numpy/globals.py      1.00    208.1±5.78µs    14.2 MB/sec    1.01   210.6±14.04µs    14.0 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.7±0.09ms     6.9 MB/sec    1.00      3.7±0.06ms     6.9 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.02      9.6±0.16ms     4.2 MB/sec    1.00      9.4±0.12ms     4.3 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.0±0.04ms     8.2 MB/sec    1.00      2.0±0.04ms     8.2 MB/sec
formatter/numpy/globals.py                 1.00    227.2±4.36µs    13.0 MB/sec    1.02   231.6±16.16µs    12.7 MB/sec
formatter/pydantic/types.py                1.00      4.4±0.06ms     5.7 MB/sec    1.00      4.5±0.06ms     5.7 MB/sec
linter/all-rules/large/dataset.py          1.00     15.9±0.24ms     2.6 MB/sec    1.04     16.4±0.36ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.1±0.04ms     4.1 MB/sec    1.04      4.3±0.09ms     3.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    503.7±8.12µs     5.9 MB/sec    1.00    501.8±5.32µs     5.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.0±0.09ms     3.6 MB/sec    1.01      7.1±0.11ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.02      8.4±0.14ms     4.9 MB/sec    1.00      8.2±0.09ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.03  1796.0±51.13µs     9.3 MB/sec    1.00  1749.6±15.79µs     9.5 MB/sec
linter/default-rules/numpy/globals.py      1.01    206.2±4.88µs    14.3 MB/sec    1.00    204.1±3.92µs    14.5 MB/sec
linter/default-rules/pydantic/types.py     1.02      3.8±0.07ms     6.7 MB/sec    1.00      3.7±0.03ms     6.9 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-07-03 14:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/konstin">@konstin</a> on 2023-07-03 14:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/konstin">@konstin</a> on 2023-07-03 14:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-07-03 14:09</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:54:59 UTC
    </footer>
</body>
</html>
