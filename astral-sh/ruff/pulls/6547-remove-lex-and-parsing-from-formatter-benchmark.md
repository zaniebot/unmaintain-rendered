```yaml
number: 6547
title: Remove lex and parsing from formatter benchmark
type: pull_request
state: merged
author: MichaReiser
labels:
  - internal
assignees: []
merged: true
base: main
head: formatter-bench-only-measure-formatting-time
created_at: 2023-08-14T06:22:10Z
updated_at: 2023-08-14T08:54:55Z
url: https://github.com/astral-sh/ruff/pull/6547
synced_at: 2026-01-12T15:55:21Z
```

# Remove lex and parsing from formatter benchmark

---

_@MichaReiser_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This PR changes the formatter benchmark to only benchmark the formatting time by excluding the lexing and parsing time. 

Excluding the lexing and parsing time (which make up more than 50% of the whole formatting time) allows us to more cleary identify performance changes in the formatter itself.
It further helps to gather profiles that don't include the whole parsing noise.

<!-- What's the purpose of the change? What does it do, and why? -->



<!-- How was it tested? -->


---

_Comment by @MichaReiser on 2023-08-14 06:22_

Current dependencies on/for this PR:
* main
  * **PR #6547** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6547" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #6548** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6548" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #6549** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6549" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #6550** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6550" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #6552** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6552" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #6551** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6551" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6547?utm_source=stack-comment).

---

_Comment by @github-actions[bot] on 2023-08-14 06:37_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 2.05      8.4Â±0.03ms     4.9 MB/sec    1.00      4.1Â±0.02ms    10.0 MB/sec
formatter/numpy/ctypeslib.py               2.14  1665.2Â±32.43Âµs    10.0 MB/sec    1.00    777.8Â±2.91Âµs    21.4 MB/sec
formatter/numpy/globals.py                 2.44    195.7Â±7.46Âµs    15.1 MB/sec    1.00     80.0Â±0.29Âµs    36.9 MB/sec
formatter/pydantic/types.py                2.12      3.5Â±0.10ms     7.3 MB/sec    1.00  1651.8Â±16.78Âµs    15.4 MB/sec
linter/all-rules/large/dataset.py          1.00     10.2Â±0.02ms     4.0 MB/sec    1.00     10.2Â±0.07ms     4.0 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      2.8Â±0.01ms     6.0 MB/sec    1.00      2.8Â±0.01ms     6.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    396.2Â±1.95Âµs     7.4 MB/sec    1.00    396.5Â±0.93Âµs     7.4 MB/sec
linter/all-rules/pydantic/types.py         1.01      5.4Â±0.04ms     4.8 MB/sec    1.00      5.3Â±0.01ms     4.8 MB/sec
linter/default-rules/large/dataset.py      1.00      5.4Â±0.02ms     7.6 MB/sec    1.01      5.4Â±0.01ms     7.5 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1194.9Â±13.23Âµs    13.9 MB/sec    1.01   1205.3Â±2.12Âµs    13.8 MB/sec
linter/default-rules/numpy/globals.py      1.03    145.8Â±6.59Âµs    20.2 MB/sec    1.00    141.8Â±0.40Âµs    20.8 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.4Â±0.01ms    10.4 MB/sec    1.01      2.5Â±0.04ms    10.4 MB/sec
```

#### Windows
```
group                                      main                                    pr
-----                                      ----                                    --
formatter/large/dataset.py                 2.19     11.3Â±0.83ms     3.6 MB/sec     1.00      5.2Â±0.26ms     7.9 MB/sec
formatter/numpy/ctypeslib.py               2.51      2.2Â±0.23ms     7.5 MB/sec     1.00   890.6Â±48.63Âµs    18.7 MB/sec
formatter/numpy/globals.py                 2.88   255.8Â±33.59Âµs    11.5 MB/sec     1.00     88.8Â±7.46Âµs    33.2 MB/sec
formatter/pydantic/types.py                2.19      4.6Â±0.25ms     5.6 MB/sec     1.00      2.1Â±0.16ms    12.2 MB/sec
linter/all-rules/large/dataset.py          1.00     16.7Â±1.01ms     2.4 MB/sec     1.00     16.7Â±0.89ms     2.4 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.02      4.4Â±0.21ms     3.8 MB/sec     1.00      4.3Â±0.22ms     3.9 MB/sec
linter/all-rules/numpy/globals.py          1.02   554.1Â±27.94Âµs     5.3 MB/sec     1.00   544.1Â±20.49Âµs     5.4 MB/sec
linter/all-rules/pydantic/types.py         1.04      8.6Â±0.45ms     3.0 MB/sec     1.00      8.3Â±0.35ms     3.1 MB/sec
linter/default-rules/large/dataset.py      1.00      8.2Â±0.57ms     4.9 MB/sec     1.08      8.9Â±0.35ms     4.6 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1824.4Â±113.58Âµs     9.1 MB/sec    1.04  1901.3Â±74.47Âµs     8.8 MB/sec
linter/default-rules/numpy/globals.py      1.00   234.8Â±18.89Âµs    12.6 MB/sec     1.02   240.3Â±12.73Âµs    12.3 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.7Â±0.15ms     6.8 MB/sec     1.05      3.9Â±0.15ms     6.5 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Review requested from @charliermarsh by @MichaReiser on 2023-08-14 07:04_

---

_Label `internal` added by @MichaReiser on 2023-08-14 07:04_

---

_Merged by @MichaReiser on 2023-08-14 08:25_

---

_Closed by @MichaReiser on 2023-08-14 08:25_

---

_Branch deleted on 2023-08-14 08:25_

---

_@konstin approved on 2023-08-14 08:54_

---
