<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Add `AlwaysTruthy` and `AlwaysFalsy` to `knot_extensions` - astral-sh/ruff #15437</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Add <code>AlwaysTruthy</code> and <code>AlwaysFalsy</code> to <code>knot_extensions</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15437">#15437</a>
        opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a>
        on 2025-01-12 00:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-01-12 00:12</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Part of #15397. There are quite a few tests that use <code>AlwaysTruthy</code>/<code>AlwaysFalsy</code>/<code>ClassLiteral</code>/<code>FunctionLiteral</code>, so it's would be convenient to have direct access to them via <code>knot_extensions</code>.</p>
<h2>Test Plan</h2>
<p>Markdown tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @InSyncWithFoo on 2025-01-12 00:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @InSyncWithFoo on 2025-01-12 00:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @InSyncWithFoo on 2025-01-12 00:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @InSyncWithFoo on 2025-01-12 00:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-12 00:19</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_api.md</code>:377 on 2025-01-12 07:26</div>
            <div class="timeline-body"><p>You can't use it for <em>unions</em> of literals, but I think you should be able to use <code>knot_extensions.TypeOf</code> for function literals and slice literals, in addition to class literals, as is demonstrated in the section above this one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-12 07:30</div>
            <div class="timeline-body"><p>Thank you. Adding <code>AlwaysTruthy</code> and <code>AlwaysFalsy</code> seems sensible to me. I considered adding something like <code>LiteralExt</code> in the <code>knot_extensions</code> PR, but we then decided to go with the more general <code>TypeOf</code> for now. If we add <code>LiteralExt</code>, we should probably remove <code>TypeOf</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_api.md</code>:377 on 2025-01-12 09:55</div>
            <div class="timeline-body"><p>The concept of <code>TypeOf</code> seems better than that of <code>LiteralExt</code>. I'll leave it to you to make the call.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2025-01-12 09:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-01-12 10:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-12 11:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_api.md</code>:377 on 2025-01-12 11:08</div>
            <div class="timeline-body"><p>I think I'd also prefer to stick with <code>TypeOf</code> for now rather than adding <code>LiteralExt</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_api.md</code>:99 on 2025-01-12 12:57</div>
            <div class="timeline-body"><pre><code class="language-suggestion">`AlwaysTruthy` and `AlwaysFalsy` represent the sets of all possible objects whose truthiness is always truthy
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:5415 on 2025-01-12 13:05</div>
            <div class="timeline-body"><p>I think it would be better (and certainly simpler) to be consistent with what we do for <code>Self</code> and <code>TypeAlias</code> -- i.e., infer <code>Unknown</code> if we see it subscripted. The reasoning is that we know that it's an invalid type form but we don't know what the user intended, and it may be better not to guess.</p>
<p>Maybe we could consider changing this, and instead infer <code>Self</code> if we see <code>Self[int]</code> etc., but I'd prefer to be consistent in our handling of all these special symbols. I.e., if we wanted to change that, we should change them all at once in the same PR, rather than being inconsistent about our treatment between different symbols.</p>
<p>TL;DR, I'd make this change to your PR branch:</p>
<pre><code class="language-diff">--- a/crates/red_knot_python_semantic/src/types/infer.rs
+++ b/crates/red_knot_python_semantic/src/types/infer.rs
@@ -5386,7 +5386,9 @@ impl&lt;'db&gt; TypeInferenceBuilder&lt;'db&gt; {
             }
             KnownInstanceType::TypingSelf
             | KnownInstanceType::TypeAlias
-            | KnownInstanceType::Unknown =&gt; {
+            | KnownInstanceType::Unknown
+            | KnownInstanceType::AlwaysFalsy
+            | KnownInstanceType::AlwaysTruthy =&gt; {
                 self.context.report_lint(
                     &amp;INVALID_TYPE_FORM,
                     subscript.into(),
@@ -5397,22 +5399,6 @@ impl&lt;'db&gt; TypeInferenceBuilder&lt;'db&gt; {
                 );
                 Type::unknown()
             }
-            KnownInstanceType::AlwaysTruthy | KnownInstanceType::AlwaysFalsy =&gt; {
-                self.context.report_lint(
-                    &amp;INVALID_TYPE_FORM,
-                    subscript.into(),
-                    format_args!(
-                        &quot;Special form `{}` expected no type parameter&quot;,
-                        known_instance.repr(self.db())
-                    ),
-                );
-
-                if matches!(known_instance, KnownInstanceType::AlwaysTruthy) {
-                    Type::AlwaysTruthy
-                } else {
-                    Type::AlwaysFalsy
-                }
-            }
</code></pre>
<p>It would also be good to add a test covering this branch -- no tests failed when I applied this change locally to your PR branch</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-12 13:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-12 16:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_api.md</code>:122 on 2025-01-12 16:30</div>
            <div class="timeline-body"><p>this still doesn't provide test coverage for the issue we were dicussing earlier, which is &quot;What type is inferred if a type argument is invalidly provided for one of these symbols?&quot;. To provide test coverage for that, you'd need to do something like this:</p>
<pre><code class="language-suggestion">def f(
    a: AlwaysTruthy[int],  # error: [invalid-type-form]
    b: AlwaysFalsy[str],  # error: [invalid-type-form]
):
    reveal_type(a)  # revealed: Unknown
    reveal_type(b)  # revealed: Unknown
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-01-12 16:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Extend `knot_extensions` with a few more symbols" to "[red-knot] Add `AlwaysTruthy` and `AlwaysFalsy` to `knot_extensions`" by @InSyncWithFoo on 2025-01-12 16:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-01-12 17:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-01-12 17:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-12 17:07</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 20:34:30 UTC
    </footer>
</body>
</html>
