<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upgrade upload/download artifact actions in release workflow - astral-sh/ruff #10105</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Upgrade upload/download artifact actions in release workflow</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10105">#10105</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-02-23 20:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">Summary
<p>This PR upgrades the upload and download artifact GitHub actions to v4 for the release workflow.</p>
<p>Upgrading the release workflow isn&#x27;t as straightforward because it relies on the fact that the v3 action automatically merges artifacts with the same name.</p>
<p>The existing release workflow merges all <code>wheels</code> and <code>binaries</code> into two artifacts and downloads these in the publish step.  There are two ways of how we can implement this with the new actions where one is safer and the other avoids storing the artifacts twice:</p>
<p>We can either be bold and use</p>
<pre><code>      - uses: actions/download-artifact@v4
        with:
          pattern: binaries-*
          path: binaries
          merge-multiple: true
</code></pre>
<p>This should download all <code>binaries</code> artifacts and merge them in the <code>binaries</code> path. See <a href="https://github.com/actions/download-artifact/tree/main?tab=readme-ov-file#download-multiple-filtered-artifacts-to-the-same-directory">the action example</a>.</p>
<p>That&#x27;s what the current implementation uses, but I can&#x27;t test the workflow without shipping a release...</p>
<p>The safer approach (testable) is to use one additional step that merges all artifacts and reuploads them as a single archive:</p>
<pre><code>  merge-artifact:
    name: Merge Wheel and Bianaries
    runs-on: ubuntu-latest
    needs:
      - macos-universal
      - macos-x86_64
      - windows
      - linux
      - linux-cross
      - musllinux
      - musllinux-cross
    steps:
      - name: Merge Wheels
        uses: actions/upload-artifact/merge@v4
        with:
          name: wheels
          pattern: wheels-*
      - name: Merge Binaries
        uses: actions/upload-artifact/merge@v4
        with:
          name: binaries
          pattern: binaries-*
</code></pre>
<p>I verified that the step produces the same artifact as the existing workflow. However, it means we upload each artifact twice: Once as its own archive and once as a merged archive.</p>
<p>I went with the first approach.... With the risk that we have to fix it during the next release.</p>
<p>Closes of <a href="https://github.com/astral-sh/ruff/issues/9527">astral-sh/ruff#9527</a></p>
Test Plan
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Upgrade upload/download artifact actions in CI.yaml workflow&quot; to &quot;Upgrade upload/download artifact actions in release workflow&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-23 20:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-02-23 20:28</div>
            <div class="timeline-body"><p>Nice, thanks for doing this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-23 20:30</div>
            <div class="timeline-body"><p>Lol wait no... I&#x27;m not done yet and there&#x27;s some discussion to be had.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-23 20:32</div>
            <div class="timeline-body"><p>Ship it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-02-23 20:50</div>
            <div class="timeline-body"><p>Also <a href="https://github.com/astral-sh/uv/issues/1943">astral-sh/uv#1943</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-02-23 20:54</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to read examples/How_to_handle_rate_limits.ipynb: Expected a Jupyter Notebook, which must be internally stored as JSON, but this file isn&#x27;t valid JSON: trailing comma at line 47 column 4
</code></pre>
</p>


Formatter (preview)
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to read examples/How_to_handle_rate_limits.ipynb: Expected a Jupyter Notebook, which must be internally stored as JSON, but this file isn&#x27;t valid JSON: trailing comma at line 47 column 4
</code></pre>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-23 20:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/zanieb">@zanieb</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-23 20:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-23 20:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ci</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-23 20:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-23 20:57</div>
            <div class="timeline-body"><blockquote>
<p>Also <a href="https://github.com/astral-sh/uv/issues/1943">astral-sh/uv#1943</a></p>
</blockquote>
<p>Let&#x27;s see how this goes first :laughing:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-23 20:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-02-25 22:00</div>
            <div class="timeline-body"><p>If the release breaks, so be it -- we&#x27;ll debug it live.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-26 07:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-26 07:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-02-26 07:23</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:01:47 UTC
    </footer>
</body>
</html>
