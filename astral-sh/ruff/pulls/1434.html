<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyUpgrade: Turn errors into OSError - astral-sh/ruff #1434</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>PyUpgrade: Turn errors into OSError</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/1434">#1434</a>
        opened by <a href="https://github.com/colin99d">@colin99d</a>
        on 2022-12-29 02:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/colin99d">@colin99d</a></div>
            <div class="timeline-body"><p>A part of #827. The following needs to be happen for this to be moved out of draft status:</p>
<ul>
<li>[x] Handle statements with multiple except statements</li>
<li>[x] Handle <code>raise</code> statements</li>
<li>[x] Add the rest of the tests from pyupgrade</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @colin99d on 2022-12-29 18:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-29 18:14</div>
            <div class="timeline-body"><p>@colin99d - Is this all set to review?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/colin99d">@colin99d</a> on 2022-12-29 18:15</div>
            <div class="timeline-body"><p>@charliermarsh I got this done and we are passing all pyupgrade tests. I intentionally left it a little messy because I figured it would need refactored, and I wanted your input on how. This one was a lot more code because there were a lot more possible situations. Also please show me how to get Located<ExprKind> out of the box, so that I only need two implement my trait for two types. I tried using (*item).downcast::&lt;Located<ExprKind>&gt;(), but rust was saying that Box&lt;Located<ExprKind>&gt; has no method downcast (same with downcast_ref).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-29 18:32</div>
            <div class="timeline-body"><p>Ok thanks, I'll try to review today!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-29 18:32</div>
            <div class="timeline-body"><p>(And will look to answer your questions too.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/colin99d">@colin99d</a> on 2022-12-29 18:49</div>
            <div class="timeline-body"><p>Perfect! Also is there a Discord server or something similar for people contributing to chat on?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-29 22:27</div>
            <div class="timeline-body"><p>There's not, but I've considered creating one ðŸ¤”</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/ast/types.rs</code>:25 on 2022-12-29 22:28</div>
            <div class="timeline-body"><p>I agree we should have this. It'd be nice to fix the existing call-sites though... Not sure if you're interested in doing that :D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-12-29 22:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/colin99d">@colin99d</a> on <code>src/ast/types.rs</code>:25 on 2022-12-29 23:55</div>
            <div class="timeline-body"><p>I can bust it out.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/colin99d">@colin99d</a> reviewed on 2022-12-29 23:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/colin99d">@colin99d</a> on 2022-12-29 23:56</div>
            <div class="timeline-body"><blockquote>
<p>There's not, but I've considered creating one ðŸ¤”</p>
</blockquote>
<p>Would be nice just so that I can know where you plan on taking this thing and how I can help it get there. You could make it private for now if your worried about spammers and randos.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/colin99d">@colin99d</a> reviewed on 2022-12-30 01:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/colin99d">@colin99d</a> on <code>src/ast/types.rs</code>:25 on 2022-12-30 01:00</div>
            <div class="timeline-body"><p>Got this done. I will fix clippy once you are good with the rest of my code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/pyupgrade/plugins/os_error_alias.rs</code>:228 on 2022-12-30 01:26</div>
            <div class="timeline-body"><p>I'm wondering if this whole part (handling try, raise, etc.) could be changed to instead look at <code>ExprKind::Attribute</code> and <code>ExprKind::Name</code> (that is: in <code>ast.rs</code>, call this plugin for every <code>ExprKind::Attribute</code> and every <code>ExprKind::Name</code>).</p>
<p>Like, ultimately, we just want to rewrite all references. It doesn't matter if they occur in try, or raise, or wherever. And here, you're just delegating to checks on attribute and name anyway. (Within call, you're then checking name and attribute.)</p>
<p>Would that work? Would it simplify things?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-12-30 01:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-12-30 01:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/pyupgrade/plugins/os_error_alias.rs</code>:33 on 2022-12-30 01:27</div>
            <div class="timeline-body"><p>Everywhere that we do <code>Located&lt;ExprKind&gt;</code>, we should instead of the RustPython type <code>Expr</code>. There are analogous types for every <code>Located&lt;T&gt;</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/colin99d">@colin99d</a> reviewed on 2022-12-30 01:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/colin99d">@colin99d</a> on <code>src/pyupgrade/plugins/os_error_alias.rs</code>:33 on 2022-12-30 01:29</div>
            <div class="timeline-body"><p>This is very good to know.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/colin99d">@colin99d</a> reviewed on 2022-12-30 01:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/colin99d">@colin99d</a> on <code>src/pyupgrade/plugins/os_error_alias.rs</code>:228 on 2022-12-30 01:30</div>
            <div class="timeline-body"><p>I think you are right here... Will take me a minute to confirm but im on it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-12-30 01:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/pyupgrade/plugins/os_error_alias.rs</code>:228 on 2022-12-30 01:31</div>
            <div class="timeline-body"><p>Iâ€™m guessing pyupgrade doesnâ€™t do this, but Iâ€™d have to look. If not, I wonder why.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/colin99d">@colin99d</a> on <code>src/pyupgrade/plugins/os_error_alias.rs</code>:228 on 2022-12-30 01:42</div>
            <div class="timeline-body"><p>So there is one issue with this implementation. If the exceptions are in a tuple, we lose our ability to intelligently group them if we only go by name and attribute (unless there is something I am missing here).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/colin99d">@colin99d</a> reviewed on 2022-12-30 01:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/pyupgrade/plugins/os_error_alias.rs</code>:228 on 2022-12-30 01:53</div>
            <div class="timeline-body"><p>Ahhh interesting. We actually have a different rule, in flake8-bugbear, that detects and removes duplicate exceptions. So perhaps we can accept that limitation here, and rely on the other rule to clean up those rare errors? What do you think? It feels like weâ€™re accepting a lot of complexity here to accommodate that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-12-30 01:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/colin99d">@colin99d</a> on <code>src/pyupgrade/plugins/os_error_alias.rs</code>:228 on 2022-12-30 02:01</div>
            <div class="timeline-body"><p>I have one idea I like a little more. Let me see if I can get it to work, and if not I will do your way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/colin99d">@colin99d</a> reviewed on 2022-12-30 02:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/pyupgrade/plugins/os_error_alias.rs</code>:228 on 2022-12-30 02:12</div>
            <div class="timeline-body"><p>I can also give the code a closer read now that I understand that limitation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-12-30 02:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/colin99d">@colin99d</a> reviewed on 2022-12-30 02:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/colin99d">@colin99d</a> on <code>src/pyupgrade/plugins/os_error_alias.rs</code>:228 on 2022-12-30 02:51</div>
            <div class="timeline-body"><p>Haha still thinking through this. The issue with the solution you provided is that if the simplifier ends up with only one option the final value will show as (OSError,) when it should be OSError per pyupgrade. This means we will then have to run a third check. So I am weighing three checks, vs how I can simplify the current code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/colin99d">@colin99d</a> reviewed on 2022-12-30 02:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/colin99d">@colin99d</a> on <code>src/pyupgrade/plugins/os_error_alias.rs</code>:228 on 2022-12-30 02:55</div>
            <div class="timeline-body"><pre><code>            ExprKind::Name{ .. } | ExprKind::Attribute{ .. } =&gt; {
                handle();
            }
</code></pre>
<p>Thinking about doing something like this. That way we can reduce having the same code copied everywhere.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-12-30 02:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/pyupgrade/plugins/os_error_alias.rs</code>:228 on 2022-12-30 02:56</div>
            <div class="timeline-body"><p>It's ok with me if it ends up as <code>(OSError,)</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-12-30 02:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/pyupgrade/plugins/os_error_alias.rs</code>:228 on 2022-12-30 02:56</div>
            <div class="timeline-body"><p>If helpful.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/colin99d">@colin99d</a> reviewed on 2022-12-30 02:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/colin99d">@colin99d</a> on <code>src/pyupgrade/plugins/os_error_alias.rs</code>:228 on 2022-12-30 02:56</div>
            <div class="timeline-body"><p>Additionally, if we figure out how to get rid of the box I can remove one of the three implementations of OSErrorAliasChecker.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-12-30 02:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/pyupgrade/plugins/os_error_alias.rs</code>:228 on 2022-12-30 02:59</div>
            <div class="timeline-body"><pre><code class="language-diff">index b0e48f5d..73e39976 100644
--- a/src/checkers/ast.rs
+++ b/src/checkers/ast.rs
@@ -1087,7 +1087,7 @@ where
                 }
                 if self.settings.enabled.contains(&amp;CheckCode::UP024) {
                     if let Some(item) = exc {
-                        pyupgrade::plugins::os_error_alias(self, item);
+                        pyupgrade::plugins::os_error_alias(self, &amp;**item);
                     }
                 }
             }
diff --git a/src/pyupgrade/plugins/os_error_alias.rs b/src/pyupgrade/plugins/os_error_alias.rs
index f6032b6a..32c9a0a8 100644
--- a/src/pyupgrade/plugins/os_error_alias.rs
+++ b/src/pyupgrade/plugins/os_error_alias.rs
@@ -1,5 +1,5 @@
 use itertools::Itertools;
-use rustpython_ast::{Excepthandler, ExcepthandlerKind, ExprKind, Located};
+use rustpython_ast::{Excepthandler, ExcepthandlerKind, Expr, ExprKind, Located};
 
 use crate::ast::helpers::match_module_member;
 use crate::ast::types::Range;
@@ -162,29 +162,7 @@ impl OSErrorAliasChecker for &amp;Vec&lt;Excepthandler&gt; {
     }
 }
 
-impl OSErrorAliasChecker for &amp;Box&lt;Located&lt;ExprKind&gt;&gt; {
-    fn check_error(&amp;self, checker: &amp;mut Checker) {
-        let mut replacements: Vec&lt;String&gt;;
-        let mut before_replace: Vec&lt;String&gt;;
-        match &amp;self.node {
-            ExprKind::Name { id, .. } =&gt; {
-                (replacements, before_replace) = check_module(checker, self);
-                if replacements.is_empty() {
-                    let new_name = get_correct_name(&amp;id);
-                    replacements.push(new_name);
-                    before_replace.push(id.to_string());
-                }
-            }
-            ExprKind::Attribute { .. } =&gt; {
-                (replacements, before_replace) = check_module(checker, self);
-            }
-            _ =&gt; return,
-        }
-        handle_making_changes(checker, self, before_replace, replacements);
-    }
-}
-
-impl OSErrorAliasChecker for &amp;Located&lt;ExprKind&gt; {
+impl OSErrorAliasChecker for &amp;Expr {
     fn check_error(&amp;self, checker: &amp;mut Checker) {
         let mut replacements: Vec&lt;String&gt;;
         let mut before_replace: Vec&lt;String&gt;;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/colin99d">@colin99d</a> reviewed on 2022-12-30 03:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/colin99d">@colin99d</a> on <code>src/pyupgrade/plugins/os_error_alias.rs</code>:228 on 2022-12-30 03:03</div>
            <div class="timeline-body"><p>Push that real quick!! I can add my simplified function to it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/colin99d">@colin99d</a> reviewed on 2022-12-30 03:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/colin99d">@colin99d</a> on <code>src/pyupgrade/plugins/os_error_alias.rs</code>:228 on 2022-12-30 03:03</div>
            <div class="timeline-body"><p>Still more complicated, but I can add a bunch of comments so its crystal clear.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/colin99d">@colin99d</a> reviewed on 2022-12-30 03:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/colin99d">@colin99d</a> on <code>src/pyupgrade/plugins/os_error_alias.rs</code>:228 on 2022-12-30 03:28</div>
            <div class="timeline-body"><blockquote>
<p>Push that real quick!! I can add my simplified function to it.</p>
</blockquote>
<p>Nvmd I got it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @colin99d on 2022-12-30 03:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/colin99d">@colin99d</a> on 2022-12-30 03:45</div>
            <div class="timeline-body"><p>Switched this to draft until I get done with all our changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @colin99d on 2022-12-30 16:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/colin99d">@colin99d</a> on 2022-12-30 16:54</div>
            <div class="timeline-body"><p>@charliermarsh I am switching this out of draft now. Unfortunately, trying to consolidate to two implementations caused tests to fail, so I did not do it. Let me know if you want anything else cleaned up or more comments anywhere else.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/ast/types.rs</code>:25 on 2022-12-30 18:10</div>
            <div class="timeline-body"><p>Thank you! That's no small feat! Really appreciate it!</p>
<p>(Please don't take this as discouragement, solely advice.) In the future, for a change like that, I'd suggest breaking it out into a separate PR, which has a bunch of benefits. For example:</p>
<ol>
<li>Each PR remains clearer in its responsibilities. In the future, when someone digs up this PR to understand the <code>pyupgrade</code> changes, they'll need to sift through the <code>Range</code> refactor too.</li>
<li>Each PR can be merged faster. A PR that just does the <code>Range</code> change would be easy to approve and merge, since it'd be decoupled from the <code>pyupgrade</code> changes.</li>
</ol>
<p>Not gonna ask that in this case since it's already done, unless you're eager to try it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-12-30 18:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-31 04:45</div>
            <div class="timeline-body"><p>Going to revisit this tomorrow!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2022-12-31 21:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2022-12-31 21:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andersk">@andersk</a> on 2023-01-02 04:43</div>
            <div class="timeline-body"><blockquote>
<p>Perfect! Also is there a Discord server or something similar for people contributing to chat on?</p>
</blockquote>
<p>@charliermarsh If youâ€™re interested, Zulip will happily sponsor free Zulip Cloud hosting for Ruff (as we do <a href="https://zulip.com/for/open-source/">for any open-source project</a>).</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:55:16 UTC
    </footer>
</body>
</html>
