<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control flow: `return` and `raise` - astral-sh/ruff #17121</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Control flow: <code>return</code> and <code>raise</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17121">#17121</a>
        opened by <a href="https://github.com/dylwil3">@dylwil3</a>
        on 2025-04-01 13:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a></div>
            <div class="timeline-body"><p>We add support for <code>return</code> and <code>raise</code> statements in the control flow graph: we simply add an edge to the terminal block, push the statements to the current block, and proceed.</p>
<p>This implementation will have to be modified somewhat once we add support for <code>try</code> statements - then we will need to check whether to <em>defer</em> the jump. But for now this will do!</p>
<p>Also in this PR: We fix the <code>unreachable</code> diagnostic range so that it lumps together consecutive unreachable blocks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-04-01 13:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-01 13:52</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+18 -0 violations, +0 -0 fixes in 5 projects; 50 projects unchanged)</p>
<a href="https://github.com/apache/airflow">apache/airflow</a> (+13 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/apache/airflow/blob/bc04e4e31e062264f9ed515b9914b7c4831d1b18/airflow-core/src/airflow/models/mappedoperator.py#L71">airflow-core/src/airflow/models/mappedoperator.py:71:9:</a> PLW0101 Unreachable code in `expand_start_from_trigger`
+ <a href="https://github.com/apache/airflow/blob/bc04e4e31e062264f9ed515b9914b7c4831d1b18/airflow-core/src/airflow/triggers/base.py#L103">airflow-core/src/airflow/triggers/base.py:103:9:</a> PLW0101 Unreachable code in `run`
+ <a href="https://github.com/apache/airflow/blob/bc04e4e31e062264f9ed515b9914b7c4831d1b18/airflow-core/tests/unit/models/test_baseoperator.py#L213">airflow-core/tests/unit/models/test_baseoperator.py:213:21:</a> PLW0101 Unreachable code in `my_work`
+ <a href="https://github.com/apache/airflow/blob/bc04e4e31e062264f9ed515b9914b7c4831d1b18/airflow-core/tests/unit/models/test_mappedoperator.py#L1171">airflow-core/tests/unit/models/test_mappedoperator.py:1171:17:</a> PLW0101 Unreachable code in `my_work`
+ <a href="https://github.com/apache/airflow/blob/bc04e4e31e062264f9ed515b9914b7c4831d1b18/airflow-core/tests/unit/models/test_mappedoperator.py#L1209">airflow-core/tests/unit/models/test_mappedoperator.py:1209:25:</a> PLW0101 Unreachable code in `my_work`
+ <a href="https://github.com/apache/airflow/blob/bc04e4e31e062264f9ed515b9914b7c4831d1b18/airflow-core/tests/unit/models/test_mappedoperator.py#L1256">airflow-core/tests/unit/models/test_mappedoperator.py:1256:25:</a> PLW0101 Unreachable code in `my_work`
+ <a href="https://github.com/apache/airflow/blob/bc04e4e31e062264f9ed515b9914b7c4831d1b18/airflow-core/tests/unit/models/test_mappedoperator.py#L565">airflow-core/tests/unit/models/test_mappedoperator.py:565:21:</a> PLW0101 Unreachable code in `my_setup`
+ <a href="https://github.com/apache/airflow/blob/bc04e4e31e062264f9ed515b9914b7c4831d1b18/airflow-core/tests/unit/models/test_mappedoperator.py#L636">airflow-core/tests/unit/models/test_mappedoperator.py:636:21:</a> PLW0101 Unreachable code in `other_setup`
+ <a href="https://github.com/apache/airflow/blob/bc04e4e31e062264f9ed515b9914b7c4831d1b18/airflow-core/tests/unit/models/test_mappedoperator.py#L652">airflow-core/tests/unit/models/test_mappedoperator.py:652:21:</a> PLW0101 Unreachable code in `my_setup`
+ <a href="https://github.com/apache/airflow/blob/bc04e4e31e062264f9ed515b9914b7c4831d1b18/airflow-core/tests/unit/models/test_mappedoperator.py#L678">airflow-core/tests/unit/models/test_mappedoperator.py:678:21:</a> PLW0101 Unreachable code in `other_setup`
+ <a href="https://github.com/apache/airflow/blob/bc04e4e31e062264f9ed515b9914b7c4831d1b18/airflow-core/tests/unit/models/test_mappedoperator.py#L851">airflow-core/tests/unit/models/test_mappedoperator.py:851:21:</a> PLW0101 Unreachable code in `my_work`
+ <a href="https://github.com/apache/airflow/blob/bc04e4e31e062264f9ed515b9914b7c4831d1b18/airflow-core/tests/unit/models/test_mappedoperator.py#L868">airflow-core/tests/unit/models/test_mappedoperator.py:868:21:</a> PLW0101 Unreachable code in `my_work`
+ <a href="https://github.com/apache/airflow/blob/bc04e4e31e062264f9ed515b9914b7c4831d1b18/airflow-core/tests/unit/models/test_taskinstance.py#L3423">airflow-core/tests/unit/models/test_taskinstance.py:3423:13:</a> PLW0101 Unreachable code in `on_finish_callable`
</pre>

</p>

<a href="https://github.com/langchain-ai/langchain">langchain-ai/langchain</a> (+2 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/langchain-ai/langchain/blob/8c8bca68b25464c8064952534c7e8d4769186120/libs/core/tests/unit_tests/runnables/test_fallbacks.py#L267">libs/core/tests/unit_tests/runnables/test_fallbacks.py:267:5:</a> PLW0101 Unreachable code in `_generate_immediate_error`
+ <a href="https://github.com/langchain-ai/langchain/blob/8c8bca68b25464c8064952534c7e8d4769186120/libs/core/tests/unit_tests/runnables/test_fallbacks.py#L295">libs/core/tests/unit_tests/runnables/test_fallbacks.py:295:5:</a> PLW0101 Unreachable code in `_agenerate_immediate_error`
</pre>

</p>

<a href="https://github.com/latchbio/latch">latchbio/latch</a> (+1 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/latchbio/latch/blob/62c4d98a8256e7f179d69632fa00d24aa440bf57/src/latch_cli/snakemake/single_task_snakemake.py#L236">src/latch_cli/snakemake/single_task_snakemake.py:236:5:</a> PLW0101 Unreachable code in `empty_generator`
</pre>

</p>

<a href="https://github.com/milvus-io/pymilvus">milvus-io/pymilvus</a> (+1 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/milvus-io/pymilvus/blob/0f037ba3cb1a23466d4d5ae111240ca85170da57/examples/iterator/iterator.py#L64">examples/iterator/iterator.py:64:9:</a> PLW0101 Unreachable code in `external_filter_func`
</pre>

</p>

<a href="https://github.com/astropy/astropy">astropy/astropy</a> (+1 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/astropy/astropy/blob/2382a9912a025c71eb9802c2efe566457b524a7c/astropy/table/tests/test_bst.py#L18">astropy/table/tests/test_bst.py:18:5:</a> PLW0101 Unreachable code in `tree`
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PLW0101 | 18 | 18 | 0 | 0 | 0 |</p>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pylint/snapshots/ruff_linter__rules__pylint__tests__PLW0101_unreachable.py.snap</code>:8 on 2025-04-01 14:10</div>
            <div class="timeline-body"><p>We need multiline span diagnostics so that we can highlight the &quot;why&quot;. (CC: @ntBre might be a good first rule to port)</p>
<p>With our current noqa system. Would a user have to put the noqa on the last line? Would that be confusing if they have</p>
<pre><code>return 1

if a:
	pass
else:
	other # noqa: unreachable
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_semantic/src/cfg/graph.rs</code>:197 on 2025-04-01 14:12</div>
            <div class="timeline-body"><p>Nit: Too much math for my brain ;)</p>
<pre><code>        // `start &lt; end`. Since `end &lt; stmts.len()` we conclude that
        // `start &lt;= stmts.len()`. It is therefore always safe to use `start` as
</code></pre>
<p>And should it be <code>start &lt; stmts.len</code>. If not, then indexing isn&#x27;t safe because <code>stmts[len]</code> panics</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_semantic/src/cfg/graph.rs</code>:238 on 2025-04-01 14:15</div>
            <div class="timeline-body"><p>This seems a bit repetitive. We may want to abstract this somehow (e.g. store <code>stmts</code> in the current block and have a <code>self.branch(offset)</code> or similar). But I&#x27;m fine deferring this a little longer</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-04-01 14:16</div>
            <div class="timeline-body"><p>Doing this incrementally makes it convenient to review. Thank you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-04-01 15:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_python_semantic/src/cfg/graph.rs</code>:197 on 2025-04-01 15:10</div>
            <div class="timeline-body"><p>Unfortunately the math is necessary to be correct! <code>start &lt;= end + 1</code> is not the same as <code>start &lt; end</code>, and I kept the second inequality as <code>&lt;=</code> so it would be easier to combine them.</p>
<p>It can happen that <code>start == stmts.len()</code> but only upon exiting the loop. This is safe because the only other place we use <code>start</code> to slice is in the form <code>stmts[start..]</code>. This is safe even if <code>start = stmts.len()</code>.</p>
<p>I&#x27;ll add some clarification to the comment</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-04-01 18:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/pylint/snapshots/ruff_linter__rules__pylint__tests__PLW0101_unreachable.py.snap</code>:8 on 2025-04-01 18:40</div>
            <div class="timeline-body"><p>I think it&#x27;s the opposite: noqa comments go at the <em>start</em> of the range. So I think it would be</p>
<pre><code>return 1

if a: # noqa: unreachable
	pass
else:
	other 
</code></pre>
<p><a href="https://play.ruff.rs/6b0806b8-b409-4951-8cfc-a82c5359106e">Playground example with existing rule</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-04-03 13:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-04-03 13:30</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:12:48 UTC
    </footer>
</body>
</html>
