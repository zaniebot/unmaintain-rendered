```yaml
number: 7287
title: Fix panic when formatting binary expression with two implicit concatenated string operands
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: fix-panic-implicit-concat-binary
created_at: 2023-09-12T06:49:50Z
updated_at: 2023-09-12T12:05:34Z
url: https://github.com/astral-sh/ruff/pull/7287
synced_at: 2026-01-12T15:55:23Z
```

# Fix panic when formatting binary expression with two implicit concatenated string operands

---

_@MichaReiser_


## Summary

This PR fixes a panic when formatting a binary like expression where both operands are implicit concatenated strings: `"a" "b" + "c" "d"`

The implementation formats the implicit concatenated string together with the right operator and than continues with the expressions to the right. 
The next iteration then tried to format the expressions between the last formatted right operator (`+`) and the next string concatenation, assuming that it would never be empty. 
This assumption was incorrect as the above example demonstrates. There's no other binary like expression between the `+` and `"c" "d"`. 

This PR fixes this by skipping the formatting of the left side if the last operator is the same as the left operator of this implicit concatenated string. 

Closes #7245


## Test Plan

Added tests



---

_Comment by @MichaReiser on 2023-09-12 06:50_

Current dependencies on/for this PR:
* main
  * **PR #7287** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7287" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7287?utm_source=stack-comment).

---

_Review requested from @konstin by @MichaReiser on 2023-09-12 06:50_

---

_Label `formatter` added by @MichaReiser on 2023-09-12 06:50_

---

_@konstin approved on 2023-09-12 07:16_

---

_Merged by @MichaReiser on 2023-09-12 07:49_

---

_Closed by @MichaReiser on 2023-09-12 07:49_

---

_Branch deleted on 2023-09-12 07:49_

---

_@charliermarsh reviewed on 2023-09-12 11:30_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/expression/binary_like.rs`:323 on 2023-09-12 11:30_

I don't know if it matters, but doesn't this mean that the right side of `"a" "b" + "c" "d"` will be formatted using the right-side formatting logic, which doesn't include the `with_layout(StringLayout::ImplicitConcatenatedStringInBinaryLike)`?

---

_@MichaReiser reviewed on 2023-09-12 11:39_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/binary_like.rs`:323 on 2023-09-12 11:39_

The implicit string formatting formats `left_operand` (optional) `left_operator` `implicit_concat` `right_operator`. 

So for, `a + "b" "c" * "d" "e"` it formats `a`, `+`, `"b" "c"` and `*`. The right side of `*` gets formatted as part of the next implicit concatenated string.

https://github.com/astral-sh/ruff/blob/1e6df19a351170ded4b1e1a4e068993107bd1047/crates/ruff_python_formatter/src/expression/binary_like.rs#L393-L431

---

_@charliermarsh reviewed on 2023-09-12 11:48_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/expression/binary_like.rs`:323 on 2023-09-12 11:48_

Ohh it only formats right _operator_, okay, got it, thank you. This is what was blocking me last night :D

---

_@MichaReiser reviewed on 2023-09-12 12:05_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/binary_like.rs`:323 on 2023-09-12 12:05_

Yes, it only formats the right operator, but starts a group that includes the right operand (without formatting it)

---
