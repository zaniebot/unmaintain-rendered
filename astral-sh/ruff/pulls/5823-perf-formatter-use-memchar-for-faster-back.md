```yaml
number: 5823
title: "perf(formatter): Use memchar for faster back tokenization"
type: pull_request
state: merged
author: MichaReiser
labels:
  - performance
  - formatter
assignees: []
merged: true
base: main
head: back-tokenization-perf
created_at: 2023-07-17T07:57:55Z
updated_at: 2023-07-18T21:24:43Z
url: https://github.com/astral-sh/ruff/pull/5823
synced_at: 2026-01-12T15:55:19Z
```

# perf(formatter): Use memchar for faster back tokenization

---

_@MichaReiser_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

@konsti found [this somewhat minified file](https://github.com/angr/angr/blob/master/angr/procedures/definitions/win32_fwpuclnt.py) that took several seconds to format on my machine.

I did some profiling and found that our formatter spends about 90%+ of the time lexing backwards to identify if an expression is parenthesized or not. The reason why this is slow
is because the file contains very large files and backwards lexing must first check if the token on this line is not a comment. 

This PR changes the implementation to use `memchr` to find the start of the line or comment position and only validate if it is a *valid* comment if a comment was found.
This reduces the formatting time on my machine to a few ms. 

<!-- What's the purpose of the change? What does it do, and why? -->

This change is not strictly necessary after https://github.com/astral-sh/ruff/pull/5825 as it reduces the time we call into `next_back()` but I thought it would still be nice to keep it around.

## Test Plan

Formatting the aformentioned file now only takes 500ms (~16s before)

<!-- How was it tested? -->


---

_Comment by @MichaReiser on 2023-07-17 07:58_

Current dependencies on/for this PR:
* main
  * **PR #5823** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5823" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/5823?utm_source=stack-comment).

---

_Review requested from @konstin by @MichaReiser on 2023-07-17 08:22_

---

_Label `performance` added by @MichaReiser on 2023-07-17 08:22_

---

_Label `formatter` added by @MichaReiser on 2023-07-17 08:22_

---

_Marked ready for review by @MichaReiser on 2023-07-17 08:24_

---

_Comment by @github-actions[bot] on 2023-07-17 08:56_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     11.0Â±0.25ms     3.7 MB/sec    1.01     11.1Â±0.12ms     3.7 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.1Â±0.09ms     7.8 MB/sec    1.03      2.2Â±0.04ms     7.5 MB/sec
formatter/numpy/globals.py                 1.00    249.0Â±2.74Âµs    11.8 MB/sec    1.01    251.0Â±1.84Âµs    11.8 MB/sec
formatter/pydantic/types.py                1.00      4.8Â±0.02ms     5.3 MB/sec    1.01      4.8Â±0.02ms     5.3 MB/sec
linter/all-rules/large/dataset.py          1.01     15.6Â±0.15ms     2.6 MB/sec    1.00     15.5Â±0.26ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.9Â±0.08ms     4.3 MB/sec    1.02      4.0Â±0.07ms     4.2 MB/sec
linter/all-rules/numpy/globals.py          1.00   515.2Â±12.31Âµs     5.7 MB/sec    1.01    520.0Â±1.51Âµs     5.7 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.0Â±0.13ms     3.7 MB/sec    1.01      7.1Â±0.10ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.01      7.9Â±0.06ms     5.2 MB/sec    1.00      7.8Â±0.12ms     5.2 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1666.3Â±28.23Âµs    10.0 MB/sec    1.00  1672.1Â±28.59Âµs    10.0 MB/sec
linter/default-rules/numpy/globals.py      1.00    184.1Â±2.39Âµs    16.0 MB/sec    1.01    185.7Â±1.85Âµs    15.9 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.6Â±0.06ms     7.2 MB/sec    1.00      3.5Â±0.06ms     7.2 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01     11.6Â±0.45ms     3.5 MB/sec    1.00     11.5Â±0.22ms     3.5 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.2Â±0.11ms     7.5 MB/sec    1.00      2.2Â±0.08ms     7.5 MB/sec
formatter/numpy/globals.py                 1.00    246.2Â±6.76Âµs    12.0 MB/sec    1.03   253.0Â±15.30Âµs    11.7 MB/sec
formatter/pydantic/types.py                1.00      4.8Â±0.13ms     5.3 MB/sec    1.01      4.9Â±0.08ms     5.2 MB/sec
linter/all-rules/large/dataset.py          1.00     15.6Â±0.16ms     2.6 MB/sec    1.02     16.0Â±0.45ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.2Â±0.06ms     4.0 MB/sec    1.00      4.2Â±0.14ms     4.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    498.6Â±9.54Âµs     5.9 MB/sec    1.01   503.8Â±13.30Âµs     5.9 MB/sec
linter/all-rules/pydantic/types.py         1.01      7.2Â±0.14ms     3.6 MB/sec    1.00      7.1Â±0.14ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.01      8.5Â±0.25ms     4.8 MB/sec    1.00      8.4Â±0.18ms     4.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01  1733.3Â±48.98Âµs     9.6 MB/sec    1.00  1713.8Â±26.13Âµs     9.7 MB/sec
linter/default-rules/numpy/globals.py      1.01    195.3Â±7.74Âµs    15.1 MB/sec    1.00    193.2Â±4.12Âµs    15.3 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.7Â±0.07ms     6.9 MB/sec    1.00      3.7Â±0.05ms     7.0 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/trivia.rs`:444 on 2023-07-18 11:59_

why do you filter on an option? (i got really confused reading this code because i expected an iterator)

---

_@konstin approved on 2023-07-18 11:59_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/trivia.rs`:444 on 2023-07-18 20:49_

Hmm, yeah, I can see how the method name makes one think that it is an iterator. I, thanks god, wasn't responsible for naming.

I first used `last_comment_offset.and_then(|last_comment_offset| if ... { Some(offset) else { None }} ` but it's so long. I then found `filter` which does exactly what I need. 

---

_@MichaReiser reviewed on 2023-07-18 20:49_

---

_Comment by @MichaReiser on 2023-07-18 20:51_

I'm going to merge this and look into handling 

```python
''' a multiline string containing a comment
# comment ''' + test
```

in a separate PR. 

---

_Merged by @MichaReiser on 2023-07-18 21:05_

---

_Closed by @MichaReiser on 2023-07-18 21:05_

---

_Branch deleted on 2023-07-18 21:05_

---
