<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use `visit_annotation` for type alias value - astral-sh/ruff #17495</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use <code>visit_annotation</code> for type alias value</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17495">#17495</a>
        opened by <a href="https://github.com/Glyphack">@Glyphack</a>
        on 2025-04-20 12:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Glyphack">@Glyphack</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>This was a follow up task from https://github.com/astral-sh/ruff/pull/17180#discussion_r2037973858 separated into this PR.</p>
<!-- What's the purpose of the change? What does it do, and why? -->

<h2>Test Plan</h2>
<p>The tests run. There was already a test for type alias that I updated.
TBH I don't understand why in the representation the <code>ExprSubscript</code> is repeated.</p>
<p>But I created a sample test to check this behavior and it happens everytime <code>visit_annotation</code> is used:</p>
<pre><code>- ModModule
  - StmtFunctionDef
    - Identifier
    - Parameters
      - ParameterWithDefault
        - Parameter
          - Identifier
          - ExprSubscript
            - ExprSubscript
              - ExprName
              - ExprName
    - StmtPass
</code></pre>
<p>for:</p>
<pre><code>def f(x: list[T]): pass
</code></pre>
<!-- How was it tested? -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-20 12:41</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @Glyphack on 2025-04-20 13:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-04-21 16:23</div>
            <div class="timeline-body"><blockquote>
<p>TBH I don't understand why in the representation the <code>ExprSubscript</code> is repeated.</p>
</blockquote>
<p>Yeah, I think this is happening because we <code>enter_node</code> twice (1) for the <code>visit_annotation</code> (via <code>walk_annotation</code>) and (2) for the <code>visit_expr</code> that's inside <code>visit_annotation</code> so I think this is an expected behavior.</p>
<pre><code>          - ExprSubscript (visit_annotation)
            - ExprSubscript (visit_expr in visit_annotation)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @dhruvmanila on 2025-04-21 16:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2025-04-21 16:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-04-21 16:31</div>
            <div class="timeline-body"><p>We'll need to update other visitors as well i.e., <code>Visitor</code> and <code>Transformer</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-22 07:05</div>
            <div class="timeline-body"><p>I'm a bit worried about this change, specifically that <code>enter_node</code> is now called twice. This can break existing visitiors that override <code>enter_node</code> and assume that it is only called exactly once (Which I think is true for the formatter).</p>
<p>It seems to me that <code>SourceOrderVisitor::visit_annotation</code> isn't overriden anywhere. That makes me wonder if we should just remove the method for now and simply call <code>visit_expr</code>.</p>
<p>I think we should also update the <code>Visitor</code> implementation to call <code>visit_annotation</code></p>
<p>https://github.com/astral-sh/ruff/blob/8a4158c5f828b4391db91a2177af8490813dd3d2/crates/ruff_python_ast/src/visitor.rs#L185</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Glyphack">@Glyphack</a> on 2025-04-22 19:15</div>
            <div class="timeline-body"><p>Thanks for the link I somehow didn't find that.</p>
<p>Do you mean we can remove the <code>SourceOrderVisitor::visit_annotation</code>? Could it be useful in the future? Although with generator script it's easy to add it back.</p>
<p>We are not overriding <code>Transformer::visit_annotation</code> Shall we remove that as well?
https://github.com/Glyphack/ruff/blob/c3c799802740e497ceed7ea7cd62d467e6f22217/crates/ruff_python_ast/src/visitor/transformer.rs#L14</p>
<p>About the breaking change you mentioned I don't understand in what situation it can break(Should I look for an <code>enter_node</code> override in formatter that gives an error if it visits the node twice?) If you can give me an example I can add it to one of the test cases for future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-23 07:29</div>
            <div class="timeline-body"><p>Here's an example of an visitor that I'm worried that would break:</p>
<p>https://github.com/astral-sh/ruff/blob/8a4158c5f828b4391db91a2177af8490813dd3d2/crates/ruff_python_formatter/src/comments/visitor.rs#L73-L112</p>
<p>But there are probably others. Any visitor that internally maintains a stack of &quot;parents&quot; is affected by this because we may end up with a situation where the <code>subscript</code> becomes its own parent which, obviously, is nonsensical</p>
<blockquote>
<p>Do you mean we can remove the SourceOrderVisitor::visit_annotation? Could it be useful in the future? Although with generator script it's easy to add it back.</p>
</blockquote>
<p>Yes, I think we can simply remove it entirely because it's unused (I think)</p>
<blockquote>
<p>We are not overriding Transformer::visit_annotation Shall we remove that as well?</p>
</blockquote>
<p>If that's the case, yes, I'd remove it too</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @Glyphack on 2025-05-01 17:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-20 06:42</div>
            <div class="timeline-body"><p>I'll close this due to inactivity. If anyone is interested in picking this up again, feel free to submit a new PR and reference this PR in the summary.</p>
<p>Thanks @Glyphack for exploring this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-06-20 06:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-10-22 15:47</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:11:43 UTC
    </footer>
</body>
</html>
