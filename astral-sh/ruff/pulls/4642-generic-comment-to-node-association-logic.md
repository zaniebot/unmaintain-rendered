```yaml
number: 4642
title: "Generic \"comment to node\" association logic"
type: pull_request
state: merged
author: MichaReiser
labels:
  - internal
  - formatter
assignees: []
merged: true
base: main
head: comments-extraction
created_at: 2023-05-24T16:40:17Z
updated_at: 2023-05-31T09:40:55Z
url: https://github.com/astral-sh/ruff/pull/4642
synced_at: 2026-01-12T03:50:03Z
```

# Generic "comment to node" association logic

---

_Pull request opened by @MichaReiser on 2023-05-24 16:40_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This is not as much code as it looks ;) Most of it is tests, test snapshots, and a lot of documentation. 

This PR implements the generic logic for associating comments with the AST nodes that they're commenting. This version implements the "default behavior" but does not yet implement the logic to handle edge cases (e.g., a comment on the `/` positional-only arguments separator). 

The algorithm traverses the tree, but it skips entire subtrees if the subtree does not contain any comments. Meaning, the algorithm only traverses all statements for files that have statement-level comments only.

I've now exposed `comments` on the `ASTFormatContext` even though it isn't used yet anywhere. 

## Test Plan

I added a handful of tests verifying the extraction.


---

_Comment by @MichaReiser on 2023-05-24 16:40_

Current dependencies on/for this PR:
* main
  * **PR #4639** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4639" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #4641** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4641" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #4642** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4642" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
        * **PR #4671** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4671" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #4748** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4748" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
            * **PR #4751** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4751" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/charliermarsh/ruff/4642?utm_source=stack-comment).

---

_Label `autoformatter` added by @MichaReiser on 2023-05-24 16:42_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/comments/mod.rs`:236 on 2023-05-26 08:53_

We should support other roots in the future but I wanted to keep it simple for now.

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/comments/visitor.rs`:145 on 2023-05-26 08:55_

The visitor isn't as fast as a binary search but it skips entire subtrees if they don't contain any comments. So it should still be reasonably fast (and may have better cache locality than binary search)

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/comments/placement.rs`:7 on 2023-05-26 08:57_

Placeholder for our custom comment placement logic. For example, for comments at the end of a body

```python
def test():
	pass

	# This comment is a trailing comment of `pass`

print("Hy")
```

or for positional only arguments

```python
def test(
	a,
	/, # comment for the positional only separator
	b
): 
	pass
```

---

_Comment by @github-actions[bot] on 2023-05-26 09:23_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     14.0Â±0.09ms     2.9 MB/sec    1.02     14.3Â±0.20ms     2.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.4Â±0.02ms     4.9 MB/sec    1.00      3.4Â±0.01ms     4.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    424.8Â±1.08Âµs     6.9 MB/sec    1.00    424.1Â±0.77Âµs     7.0 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.9Â±0.03ms     4.4 MB/sec    1.00      5.9Â±0.01ms     4.3 MB/sec
linter/default-rules/large/dataset.py      1.00      6.8Â±0.02ms     6.0 MB/sec    1.00      6.9Â±0.03ms     5.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1508.4Â±3.02Âµs    11.0 MB/sec    1.00   1514.2Â±1.73Âµs    11.0 MB/sec
linter/default-rules/numpy/globals.py      1.00    170.2Â±0.19Âµs    17.3 MB/sec    1.01    171.2Â±0.18Âµs    17.2 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.1Â±0.01ms     8.2 MB/sec    1.00      3.1Â±0.01ms     8.2 MB/sec
parser/large/dataset.py                    1.00      5.2Â±0.00ms     7.9 MB/sec    1.01      5.2Â±0.02ms     7.8 MB/sec
parser/numpy/ctypeslib.py                  1.00   1027.4Â±2.88Âµs    16.2 MB/sec    1.00   1030.1Â±0.39Âµs    16.2 MB/sec
parser/numpy/globals.py                    1.00    105.8Â±0.19Âµs    27.9 MB/sec    1.01    106.4Â±0.15Âµs    27.7 MB/sec
parser/pydantic/types.py                   1.00      2.2Â±0.00ms    11.4 MB/sec    1.00      2.2Â±0.01ms    11.4 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.01     16.9Â±0.14ms     2.4 MB/sec    1.00     16.8Â±0.12ms     2.4 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.2Â±0.05ms     3.9 MB/sec    1.00      4.2Â±0.06ms     3.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    504.9Â±7.97Âµs     5.8 MB/sec    1.00    504.0Â±7.78Âµs     5.9 MB/sec
linter/all-rules/pydantic/types.py         1.01      7.1Â±0.07ms     3.6 MB/sec    1.00      7.0Â±0.06ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.01      8.3Â±0.05ms     4.9 MB/sec    1.00      8.2Â±0.05ms     5.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1774.0Â±17.34Âµs     9.4 MB/sec    1.00  1766.3Â±18.92Âµs     9.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    204.5Â±3.14Âµs    14.4 MB/sec    1.00    205.0Â±4.80Âµs    14.4 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.8Â±0.04ms     6.8 MB/sec    1.00      3.8Â±0.03ms     6.8 MB/sec
parser/large/dataset.py                    1.00      6.5Â±0.04ms     6.3 MB/sec    1.03      6.6Â±0.04ms     6.1 MB/sec
parser/numpy/ctypeslib.py                  1.00  1225.7Â±10.13Âµs    13.6 MB/sec    1.03  1262.7Â±13.92Âµs    13.2 MB/sec
parser/numpy/globals.py                    1.00    124.8Â±1.68Âµs    23.7 MB/sec    1.02    127.4Â±1.90Âµs    23.2 MB/sec
parser/pydantic/types.py                   1.00      2.8Â±0.02ms     9.2 MB/sec    1.03      2.8Â±0.03ms     9.0 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_@MichaReiser reviewed on 2023-05-26 10:46_

---

_Label `internal` added by @MichaReiser on 2023-05-26 10:46_

---

_Renamed from "Extract comments" to "Generic comment to node association logic" by @MichaReiser on 2023-05-26 10:51_

---

_@MichaReiser reviewed on 2023-05-26 10:52_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/lib.rs`:77 on 2023-05-26 10:52_

This is obviously bad but I didn't bother to spend any time on fixing it because I want to remove the CST. I need to think about how to best transition from old to new. 

But this will be gone soon, so I decided not to worry.

---

_Marked ready for review by @MichaReiser on 2023-05-26 10:55_

---

_Renamed from "Generic comment to node association logic" to "Generic *comment to node* association logic" by @MichaReiser on 2023-05-26 11:34_

---

_Renamed from "Generic *comment to node* association logic" to "Generic "comment to node" association logic" by @MichaReiser on 2023-05-26 11:34_

---

_@charliermarsh reviewed on 2023-05-26 18:31_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/comments/mod.rs`:165 on 2023-05-26 18:31_

I got confused reading this -- I think we should remove this example from this specific docstring since it's already documented above `OwnLine`?

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/comments/placement.rs`:149 on 2023-05-26 18:33_

These examples are great.

---

_@charliermarsh reviewed on 2023-05-26 18:33_

---

_@charliermarsh reviewed on 2023-05-26 18:34_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/comments/mod.rs`:563 on 2023-05-26 18:34_

I find this testing strategy to be very nice and quite clever.

---

_@charliermarsh reviewed on 2023-05-26 18:37_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/comments/visitor.rs`:599 on 2023-05-26 18:37_

If you want, you can derive `is_macro::Is` for this.

---

_@charliermarsh reviewed on 2023-05-26 18:37_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/comments/visitor.rs`:86 on 2023-05-26 18:37_

This is clever, and I like the use of the traversal signal.

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/lib.rs`:77 on 2023-05-26 18:38_

Remaining calm...

---

_@charliermarsh reviewed on 2023-05-26 18:38_

---

_@charliermarsh reviewed on 2023-05-26 18:40_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/comments/visitor.rs`:620 on 2023-05-26 18:40_

I'm having trouble following `CommentPlacement::Default`. `place_comment` always returns default, so we're always taking this path. Why does `CommentPlacement::Default` exist at all? Could `place_comment` not contain this logic, and `CommentPlacement::Default` be removed entirely?

---

_@charliermarsh approved on 2023-05-26 18:40_

One outstanding question but biasing towards approval :)

---

_@charliermarsh reviewed on 2023-05-26 18:41_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/comments/visitor.rs`:620 on 2023-05-26 18:41_

Oh, sorry, there's a comment about this but it's marked as "outdated" so didn't appear in the diff. Reading...

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/comments/visitor.rs`:620 on 2023-05-26 18:42_

I think my question still stands -- why does `Default` exist? Can `place_comment` not contain this logic + any special-casing?

---

_@charliermarsh reviewed on 2023-05-26 18:42_

---

_@MichaReiser reviewed on 2023-05-26 19:59_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/comments/visitor.rs`:620 on 2023-05-26 19:59_

`place_comment` could contain all the logic, but I prefer to have it separated because the custom logic itself can get very messy ([see rome](https://github.com/rome/tools/blob/main/crates/rome_js_formatter/src/comments.rs#L156-L1165)). Other considerations are:

* At least for rome, the `Default` logic was shared across all languages, and `place_comment` was language specific. This does not (or not yet?) apply to ruff. 
* The way `place_comment` works is to have different handle functions that pass the comment through, for as long as the prevous handler returned `CommentPlacement::Default` (chain of responsibility pattern?). Option doesn't work because we need to pass `comment` as an owned value and returning `None` would "drop" the comment and we could not retrieve it again. We could change the design to decouple the "placement" and the comment, pass the comment by reference, and change the return type of `place_comment` to `(Placement, Comment)`. Individual handlers could then return a `Option<Placement>`. The downside of this is that it becomes easier to "ignore" the value of a handler because the `comment `doesn't get "consumed" when explicitly specifying that it's a *leading*, *dangling* or *trailing* comment (you can still manually extract it again, but you would need to be very deliberate about it). 
* Having `CommentPlacement::Default` as a concept provides a great opportunity to document the rule with examples. 

Would you find it easier to understand if all the logic is in one place? Where would you document the "default" behavior? 

---

_@charliermarsh reviewed on 2023-05-28 04:04_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/comments/visitor.rs`:620 on 2023-05-28 04:04_

Seeing ahead to the version in Rome is helpful. I think the thing I was missing here was that I was wondering: won't this restrict our ability to use `CommentPlacement` elsewhere? E.g., imagine that we wanted to use `CommentPlacement` in the formatter itself, to figure out whether a given comment should be printed before or after a given node. In that case... how would we handle `CommentPlacement::Default`?

But, the comments data structure effectively implements a refined enum by way of tracking leading, trailing, and dangling comments. So this `CommentPlacement` enum is only used in the building phase, and `CommentPlacement::Default` doesn't extend outwards to any sites in which it's existence would be confusing or cause problems.

---

_@MichaReiser reviewed on 2023-05-28 07:59_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/comments/visitor.rs`:620 on 2023-05-28 07:59_

That's a good point. I think I'll move the CommentPlacement definition into the visitor.rs file to make that clear. The placement.rs will only contain our custom logic 

---

_@MichaReiser reviewed on 2023-05-30 07:55_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/comments/visitor.rs`:599 on 2023-05-30 07:55_

I've mixed feelings on `is_macro::Is` ;)

---

_Merged by @MichaReiser on 2023-05-30 09:28_

---

_Closed by @MichaReiser on 2023-05-30 09:28_

---

_Branch deleted on 2023-05-30 09:28_

---
