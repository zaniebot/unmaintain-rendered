<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Infer `Unknown` for the loop var in `async for` loops - astral-sh/ruff #13243</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Infer <code>Unknown</code> for the loop var in <code>async for</code> loops</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13243">#13243</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-09-04 13:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p><code>async for</code> loops use the asynchronous iteration protocol (involving <code>__aiter__</code> and <code>__anext__</code>) rather than the synchronous iteration protocol (involving <code>__iter__</code> and <code>__next__</code>). Understanding <code>__anext__</code> calls is beyond our capabilities until we can understanding async call expressions (which is probably blocked on generic coroutine types). For now, inferring <code>Unknown</code> for loop vars in <code>async for</code> loops is more accurate than erroneously using the synchronous iteration protocol for the types of these definitions.</p>
<h2>Test Plan</h2>
<p><code>cargo test -p red_knot_python_semantic --lib</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2024-09-04 13:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2024-09-04 13:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2024-09-04 13:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-09-04 13:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-09-04 13:46</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2024-09-04 14:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-09-04 14:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-09-04 14:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1060 on 2024-09-04 15:29</div>
            <div class="timeline-body"><p>I haven't brought this up in reviews before, but I would prefer if we don't tag our TODOs with a name. The TODOs belong to the project, and anyone might address them in future. I realize it's intended as a way to take responsibility for the issue, but I think in practice it functions more like cookie-licking (https://communitymgt.fandom.com/wiki/Cookie_Licking), discouraging anyone else from contributing an improvement, while the person who created the TODO may not have time for it yet either.</p>
<p>cc @dhruvmanila</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-09-04 15:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-09-04 15:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1060 on 2024-09-04 15:36</div>
            <div class="timeline-body"><p>Heh. Dhruv just this morning told me via DM that we were encouraged to do this at Astral :) he linked <a href="https://gist.github.com/dmnd/ed5d8ef8de2e4cfea174bd5dafcda382#whats-the-point-of-putting-your-name-on-a-todo">this</a> by way of explanation</p>
<p>I don't have a strong preference either way!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1060 on 2024-09-04 15:42</div>
            <div class="timeline-body"><p>Interesting. I see that rationale, and I am more OK with it if the interpretation is more &quot;this person might have relevant context&quot; and not &quot;you shouldn't work on this unless you check with this person first.&quot; But I'm still concerned that the non-cookie-licking interpretation isn't necessarily clear to a new contributor reading the code.</p>
<p>Overall I still think I don't like it. If there's relevant context that's needed to understand the TODO, I'd rather that be in the comment with the TODO, rather than a person's name to go talk to. The case where you really need to go talk to a specific person to understand some code shouldn't be <em>that</em> common, if we are writing reasonably understandable and well-commented code, and when that case arises, <code>git blame</code> exists. (That case can just as well arise for changes in an area of the code that doesn't have a TODO comment, so should we just comment every piece of code we write with our name, because <code>git blame</code> is too hard to use?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-09-04 15:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-09-04 15:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1060 on 2024-09-04 15:43</div>
            <div class="timeline-body"><p>Opened a convo in Discord about this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-09-04 15:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1060 on 2024-09-04 15:44</div>
            <div class="timeline-body"><p>@charliermarsh may have more context. He prefers adding the name.</p>
<p>I agree that <code>git blame</code> may give you the same context. But it can be difficult if the code went through multiple refactors or was even moved to a different location.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-09-04 15:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1060 on 2024-09-04 15:45</div>
            <div class="timeline-body"><p>I don't really have a preference here, though I think it's pretty easy for code to move around enough to make <code>git blame</code> useless at our pace of refactoring and development. I wouldn't mind skipping the inclusion of a name.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-09-04 15:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1060 on 2024-09-04 15:51</div>
            <div class="timeline-body"><p>Before I was sent the above link, it was 100% my assumption that the meaning of the name in the TODO comment was &quot;This is a TODO for me, i.e. I am going to fix it&quot; (and thus, implicitly, nobody else should do it without asking me first.)</p>
<p>We can of course clarify this internally, but that doesn't mean it will be clear to the rest of the world.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:06:22 UTC
    </footer>
</body>
</html>
