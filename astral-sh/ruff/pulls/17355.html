<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`airflow`] Apply auto fixes to cases where the names have changed in Airflow 3 (`AIR301`) - astral-sh/ruff #17355</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>airflow</code>] Apply auto fixes to cases where the names have changed in Airflow 3 (<code>AIR301</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17355">#17355</a>
        opened by <a href="https://github.com/Lee-W">@Lee-W</a>
        on 2025-04-11 15:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Lee-W">@Lee-W</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<!-- What's the purpose of the change? What does it do, and why? -->

<p>Apply auto fixes to cases where the names have changed in Airflow 3</p>
<h2>Test Plan</h2>
<!-- How was it tested? -->

<p>Add <code>AIR301_names_fix.py</code> and <code>AIR301_provider_names_fix.py</code> test fixtures</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Lee-W">@Lee-W</a> on 2025-04-11 16:06</div>
            <div class="timeline-body"><p>Hey @ntBre , I found out a <code>Failed to converge after 10 iterations. This likely indicates a bug in the implementation of the fix. Last diagnostics:</code> error during testing. but the traceback does not provide much information. Do you know what the cause might be? thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-11 16:12</div>
            <div class="timeline-body"><blockquote>
<p>Hey @ntBre , I found out a <code>Failed to converge after 10 iterations. This likely indicates a bug in the implementation of the fix. Last diagnostics:</code> error during testing. but the traceback does not provide much information. Do you know what the cause might be? thanks!</p>
</blockquote>
<p>That usually points to a loop between two rules, for example one rule might add an import and the other deletes it. Based on the test that's failing, it probably only has one rule (AIR301) enabled, so it would probably have to be a loop within that rule. Do any of the replacements overlap? Something like</p>
<pre><code class="language-python">import a  # error, import b instead
</code></pre>
<p>Fixed to</p>
<pre><code class="language-python">import b  # error, import a instead
</code></pre>
<p>Fixed to</p>
<pre><code class="language-python">import a
</code></pre>
<p>and so on. There could even be more parts in the chain like <code>a -&gt; b -&gt; c -&gt; a</code>, which could make it harder to identify, but something like this should be the cause.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Lee-W">@Lee-W</a> on 2025-04-12 01:47</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>Hey @ntBre , I found out a <code>Failed to converge after 10 iterations. This likely indicates a bug in the implementation of the fix. Last diagnostics:</code> error during testing. but the traceback does not provide much information. Do you know what the cause might be? thanks!</p>
</blockquote>
<p>That usually points to a loop between two rules, for example one rule might add an import and the other deletes it. Based on the test that's failing, it probably only has one rule (AIR301) enabled, so it would probably have to be a loop within that rule. Do any of the replacements overlap? Something like</p>
<pre><code class="language-python">import a  # error, import b instead
</code></pre>
<p>Fixed to</p>
<pre><code class="language-python">import b  # error, import a instead
</code></pre>
<p>Fixed to</p>
<pre><code class="language-python">import a
</code></pre>
<p>and so on. There could even be more parts in the chain like <code>a -&gt; b -&gt; c -&gt; a</code>, which could make it harder to identify, but something like this should be the cause.</p>
</blockquote>
<p>Hmm... don't think we have such case. but will take a deeper look.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-04-15 13:45</div>
            <div class="timeline-body"><p>I'm not sure how the fix has been implemented but a potential reason this might be happening is there are multiple autofixes (more than the iteration limit) which is trying to edit the same line of import. This could happen when there are multiple references of the same deprecated symbol and each reference has generated an edit to update the import. Now, that edit belongs to the same line so Ruff will only apply a single edit and avoid fixing the rest. Those will then be carried over to the next iteration. I guess this is why the autoimporter logic created an error. But, I'll need to look closely as to why this is happening.</p>
<p>It might be worth printing out some of the variables in the fix loop to see why the linter is not able to apply the fixes in a single loop.</p>
<p>(Posting from phone)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Lee-W">@Lee-W</a> on 2025-04-15 14:18</div>
            <div class="timeline-body"><blockquote>
<p>I'm not sure how the fix has been implemented but a potential reason this might be happening is there are multiple autofixes (more than the iteration limit) which is trying to edit the same line of import. This could happen when there are multiple references of the same deprecated symbol and each reference has generated an edit to update the import. Now, that edit belongs to the same line so Ruff will only apply a single edit and avoid fixing the rest. Those will then be carried over to the next iteration. I guess this is why the autoimporter logic created an error. But, I'll need to look closely as to why this is happening.</p>
<p>It might be worth printing out some of the variables in the fix loop to see why the linter is not able to apply the fixes in a single loop.</p>
<p>(Posting from phone)</p>
</blockquote>
<p>I've not yet had the bandwidth to come back to this one. üòû But multiple fix on the same line sounds like a highly likely cause ü§î</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Apply auto import" to "[`airflow`] Apply fixes to cases that names that have been changed in Airflow 3 (`AIR301`)" by @Lee-W on 2025-04-21 14:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`airflow`] Apply fixes to cases that names that have been changed in Airflow 3 (`AIR301`)" to "[`airflow`] Apply fixes to cases that names changed in Airflow 3 (`AIR301`)" by @Lee-W on 2025-04-21 14:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`airflow`] Apply fixes to cases that names changed in Airflow 3 (`AIR301`)" to "[`airflow`] Apply auto fixes to cases where the names have changed in Airflow 3 (`AIR301`)" by @Lee-W on 2025-04-21 14:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @Lee-W on 2025-04-21 14:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Lee-W">@Lee-W</a> on 2025-04-21 14:59</div>
            <div class="timeline-body"><p>Hey, @ntBre I just wrap up this one. Would be nice if you could take a look when you have time. Thanks üôÇ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-21 15:03</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>‚ÑπÔ∏è ecosystem check <strong>detected linter changes</strong>. (+0 -1 violations, +10 -0 fixes in 1 projects; 54 projects unchanged)</p>
<details><summary><a href="https://github.com/apache/airflow">apache/airflow</a> (+0 -1 violations, +10 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/apache/airflow/blob/c01772f959fd5c73198456e429c5d7823db3fc45/providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py#L39'>providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py:39:32:</a> AIR301 [*] `airflow.lineage.hook.DatasetLineageInfo` is removed in Airflow 3.0
- <a href='https://github.com/apache/airflow/blob/c01772f959fd5c73198456e429c5d7823db3fc45/providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py#L39'>providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py:39:32:</a> AIR301 `airflow.lineage.hook.DatasetLineageInfo` is removed in Airflow 3.0
+ <a href='https://github.com/apache/airflow/blob/c01772f959fd5c73198456e429c5d7823db3fc45/providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py#L39'>providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py:39:5:</a> AIR301 [*] `airflow.lineage.hook.DatasetLineageInfo` is removed in Airflow 3.0
- <a href='https://github.com/apache/airflow/blob/c01772f959fd5c73198456e429c5d7823db3fc45/providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py#L39'>providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py:39:5:</a> AIR301 `airflow.lineage.hook.DatasetLineageInfo` is removed in Airflow 3.0
+ <a href='https://github.com/apache/airflow/blob/c01772f959fd5c73198456e429c5d7823db3fc45/providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py#L63'>providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py:63:17:</a> AIR301 [*] `airflow.lineage.hook.DatasetLineageInfo` is removed in Airflow 3.0
- <a href='https://github.com/apache/airflow/blob/c01772f959fd5c73198456e429c5d7823db3fc45/providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py#L63'>providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py:63:17:</a> AIR301 `airflow.lineage.hook.DatasetLineageInfo` is removed in Airflow 3.0
+ <a href='https://github.com/apache/airflow/blob/c01772f959fd5c73198456e429c5d7823db3fc45/providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py#L67'>providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py:67:17:</a> AIR301 [*] `airflow.lineage.hook.DatasetLineageInfo` is removed in Airflow 3.0
- <a href='https://github.com/apache/airflow/blob/c01772f959fd5c73198456e429c5d7823db3fc45/providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py#L67'>providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py:67:17:</a> AIR301 `airflow.lineage.hook.DatasetLineageInfo` is removed in Airflow 3.0
- <a href='https://github.com/apache/airflow/blob/c01772f959fd5c73198456e429c5d7823db3fc45/providers/common/compat/src/airflow/providers/common/compat/openlineage/utils/utils.py#L40'>providers/common/compat/src/airflow/providers/common/compat/openlineage/utils/utils.py:40:59:</a> AIR301 `airflow.providers.openlineage.utils.utils.translate_airflow_dataset` is removed in Airflow 3.0
+ <a href='https://github.com/apache/airflow/blob/c01772f959fd5c73198456e429c5d7823db3fc45/providers/openlineage/tests/unit/openlineage/plugins/test_utils.py#L580'>providers/openlineage/tests/unit/openlineage/plugins/test_utils.py:580:21:</a> AIR301 [*] `airflow.timetables.simple.DatasetTriggeredTimetable` is removed in Airflow 3.0
- <a href='https://github.com/apache/airflow/blob/c01772f959fd5c73198456e429c5d7823db3fc45/providers/openlineage/tests/unit/openlineage/plugins/test_utils.py#L580'>providers/openlineage/tests/unit/openlineage/plugins/test_utils.py:580:21:</a> AIR301 `airflow.timetables.simple.DatasetTriggeredTimetable` is removed in Airflow 3.0
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| AIR301 | 11 | 0 | 1 | 10 | 0 |</p>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @ntBre by @ntBre on 2025-04-21 17:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-04-21 21:52</div>
            <div class="timeline-body"><p>Thanks, looks good to me!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @ntBre on 2025-04-21 21:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @ntBre on 2025-04-21 21:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-21 21:55</div>
            <div class="timeline-body"><p>I guess one quick question about the ecosystem check: <code>airflow.providers.openlineage.utils.utils.translate_airflow_dataset</code> is no longer being detected/fixed. Is that expected?</p>
<p>Otherwise the ecosystem check looks good, it shows new fixes for the other matches.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Lee-W">@Lee-W</a> on 2025-04-22 06:15</div>
            <div class="timeline-body"><blockquote>
<p>I guess one quick question about the ecosystem check: <code>airflow.providers.openlineage.utils.utils.translate_airflow_dataset</code> is no longer being detected/fixed. Is that expected?</p>
<p>Otherwise the ecosystem check looks good, it shows new fixes for the other matches.</p>
</blockquote>
<p>I think it's fixed here? https://github.com/astral-sh/ruff/pull/17355/files#diff-493d19bbac615454a597e22069204d09be7c4e125ce6494d9cd85289278b141fR231</p>
<p>or are you referring to something else</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-22 20:06</div>
            <div class="timeline-body"><p>I'm talking about this entry from the ecosystem check: https://github.com/apache/airflow/blob/689608d7423cebf7c72d0e0c0081eceeeac51b3a/providers/common/compat/src/airflow/providers/common/compat/openlineage/utils/utils.py#L40</p>
<p>All of the other entries have one new diagnostic (+) and one removed diagnostic (-), but this one shows only a removed diagnostic:</p>
<pre><code class="language-text">+ [providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py:39:32:](https://github.com/apache/airflow/blob/689608d7423cebf7c72d0e0c0081eceeeac51b3a/providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py#L39) AIR301 [*] `airflow.lineage.hook.DatasetLineageInfo` is removed in Airflow 3.0
- [providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py:39:32:](https://github.com/apache/airflow/blob/689608d7423cebf7c72d0e0c0081eceeeac51b3a/providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py#L39) AIR301 `airflow.lineage.hook.DatasetLineageInfo` is removed in Airflow 3.0
+ [providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py:39:5:](https://github.com/apache/airflow/blob/689608d7423cebf7c72d0e0c0081eceeeac51b3a/providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py#L39) AIR301 [*] `airflow.lineage.hook.DatasetLineageInfo` is removed in Airflow 3.0
- [providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py:39:5:](https://github.com/apache/airflow/blob/689608d7423cebf7c72d0e0c0081eceeeac51b3a/providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py#L39) AIR301 `airflow.lineage.hook.DatasetLineageInfo` is removed in Airflow 3.0
+ [providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py:63:17:](https://github.com/apache/airflow/blob/689608d7423cebf7c72d0e0c0081eceeeac51b3a/providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py#L63) AIR301 [*] `airflow.lineage.hook.DatasetLineageInfo` is removed in Airflow 3.0
- [providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py:63:17:](https://github.com/apache/airflow/blob/689608d7423cebf7c72d0e0c0081eceeeac51b3a/providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py#L63) AIR301 `airflow.lineage.hook.DatasetLineageInfo` is removed in Airflow 3.0
+ [providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py:67:17:](https://github.com/apache/airflow/blob/689608d7423cebf7c72d0e0c0081eceeeac51b3a/providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py#L67) AIR301 [*] `airflow.lineage.hook.DatasetLineageInfo` is removed in Airflow 3.0
- [providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py:67:17:](https://github.com/apache/airflow/blob/689608d7423cebf7c72d0e0c0081eceeeac51b3a/providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py#L67) AIR301 `airflow.lineage.hook.DatasetLineageInfo` is removed in Airflow 3.0
this one -&gt; - [providers/common/compat/src/airflow/providers/common/compat/openlineage/utils/utils.py:40:59:](https://github.com/apache/airflow/blob/689608d7423cebf7c72d0e0c0081eceeeac51b3a/providers/common/compat/src/airflow/providers/common/compat/openlineage/utils/utils.py#L40) AIR301 `airflow.providers.openlineage.utils.utils.translate_airflow_dataset` is removed in Airflow 3.0
+ [providers/openlineage/tests/unit/openlineage/plugins/test_utils.py:580:21:](https://github.com/apache/airflow/blob/689608d7423cebf7c72d0e0c0081eceeeac51b3a/providers/openlineage/tests/unit/openlineage/plugins/test_utils.py#L580) AIR301 [*] `airflow.timetables.simple.DatasetTriggeredTimetable` is removed in Airflow 3.0
- [providers/openlineage/tests/unit/openlineage/plugins/test_utils.py:580:21:](https://github.com/apache/airflow/blob/689608d7423cebf7c72d0e0c0081eceeeac51b3a/providers/openlineage/tests/unit/openlineage/plugins/test_utils.py#L580) AIR301 `airflow.timetables.simple.DatasetTriggeredTimetable` is removed in Airflow 3.0
</code></pre>
<p>I just wanted to make sure that was an expected result before merging.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Lee-W">@Lee-W</a> on 2025-04-23 00:32</div>
            <div class="timeline-body"><blockquote>
<ul>
<li><a href="https://github.com/apache/airflow/blob/689608d7423cebf7c72d0e0c0081eceeeac51b3a/providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py#L63">providers/common/compat/src/airflow/providers/common/compat/lineage/hook.py:63:17:</a> AIR301 <code>airflow.lineage.hook.DatasetLineageInfo</code> is removed in Airflow 3.0</li>
</ul>
</blockquote>
<p>If I'm not mistaken, it seems we'll be running this branch against the Airflow codebase.I think the behavior is correct in this version as the code is guarded by try-catch. I'm not sure why it was there though ü§î</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-23 16:43</div>
            <div class="timeline-body"><p>Sounds good, I'll go ahead and merge. Just wanted to make sure that was expected :slightly_smiling_face:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-04-23 16:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-04-23 16:43</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:11:30 UTC
    </footer>
</body>
</html>
