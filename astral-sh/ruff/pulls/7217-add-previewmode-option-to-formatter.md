```yaml
number: 7217
title: Add PreviewMode option to formatter
type: pull_request
state: merged
author: MichaReiser
labels:
  - cli
  - formatter
  - preview
assignees: []
merged: true
base: main
head: add-preview-flag-to-formatter
created_at: 2023-09-07T11:08:58Z
updated_at: 2023-09-21T10:38:46Z
url: https://github.com/astral-sh/ruff/pull/7217
synced_at: 2026-01-12T15:55:23Z
```

# Add PreviewMode option to formatter

---

_@MichaReiser_


## Summary

This PR adds the `--preview` and `--no-preview` options to the `format` command (hidden) and passes it through to the formatte. 

## Test Plan

I added the `dbg(f.options().preview())` statement in `FormatNodeRule::fmt` and verified that the option gets correctly passed to the formatter.


---

_Review requested from @zanieb by @MichaReiser on 2023-09-07 11:09_

---

_Comment by @MichaReiser on 2023-09-07 11:09_

Current dependencies on/for this PR:
* main
  * **PR #7145** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7145" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7193** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7193" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #7215** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7215" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #7217** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7217" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
          * **PR #7219** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7219" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
            * **PR #7242** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7242" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
              * **PR #7567** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7567" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7217?utm_source=stack-comment).

---

_Label `cli` added by @MichaReiser on 2023-09-07 11:09_

---

_Label `formatter` added by @MichaReiser on 2023-09-07 11:09_

---

_Comment by @codspeed-hq[bot] on 2023-09-07 11:19_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/add-preview-flag-to-formatter)

### Merging #7217 will **degrade performances by 2.54%**

<sub>Comparing <code>add-preview-flag-to-formatter</code> (65c5853) with <code>main</code> (41f0aad)</sub>



### Summary

`âŒ 1` regressions
`âœ… 24` untouched benchmarks



> :warning: _Please fix the performance issues or [acknowledge them on CodSpeed](https://codspeed.io/astral-sh/ruff/branches/add-preview-flag-to-formatter)._

### Benchmarks breakdown

|     | Benchmark | `main` | `add-preview-flag-to-formatter` | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| âŒ | `linter/all-rules[numpy/ctypeslib.py]` | 32.6 ms | 33.5 ms | -2.54% |


---

_Comment by @github-actions[bot] on 2023-09-07 11:24_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.



---

_@zanieb reviewed on 2023-09-07 13:58_

---

_Review comment by @zanieb on `crates/ruff_python_formatter/src/options.rs`:277 on 2023-09-07 13:58_

Why this instead of deriving the `is` macro?

---

_@MichaReiser reviewed on 2023-09-07 13:59_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/options.rs`:277 on 2023-09-07 13:59_

Because I and the `is` macro aren't good friends ;) 

---

_@zanieb reviewed on 2023-09-07 14:01_

---

_Review comment by @zanieb on `crates/ruff_python_formatter/src/options.rs`:277 on 2023-09-07 14:01_

Hm could you change the other one for consistency then?

Also why lol

---

_@charliermarsh reviewed on 2023-09-07 14:57_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/options.rs`:277 on 2023-09-07 14:57_

Subscribe, I like the `is` macro :joy:

---

_@MichaReiser reviewed on 2023-09-07 16:21_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/options.rs`:277 on 2023-09-07 16:21_

Damn, I'm outmatched

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/mod.rs`:719 on 2023-09-08 08:13_

nit: one magic macro less

```suggestion
        self == OwnParentheses::NonEmpty
```

---

_@konstin reviewed on 2023-09-08 08:17_

Is preview mode a global only flag or can it also be hierarchical?

---

_@MichaReiser reviewed on 2023-09-08 08:23_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/mod.rs`:719 on 2023-09-08 08:23_

`PartialEq` is not const :( 

---

_Comment by @MichaReiser on 2023-09-08 08:23_

> Is preview mode a global only flag or can it also be hierarchical?

I would expect it to be hierarchical the same way as any other configuration option.

CC: @zanieb 

---

_@konstin reviewed on 2023-09-08 08:41_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/mod.rs`:719 on 2023-09-08 08:41_

The compiler knows that these are identical: https://godbolt.org/z/Monn4Y53T

---

_@MichaReiser reviewed on 2023-09-08 08:51_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/mod.rs`:719 on 2023-09-08 08:51_

That's correct but it means that any method using `is_non_empty` can't be `const` either... 

---

_@konstin approved on 2023-09-08 08:57_

forgot to approve

---

_@konstin reviewed on 2023-09-08 09:00_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/mod.rs`:719 on 2023-09-08 09:00_

do we need it to be const, given that the function is transparent to the compiler either way?

---

_Comment by @charliermarsh on 2023-09-08 09:10_

IMO it should match the behavior of other settings (and I assume it will by default based on the implementation): hierarchical, but providing it on the command-line overrides it for all files.

---

_@MichaReiser reviewed on 2023-09-08 09:23_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/mod.rs`:719 on 2023-09-08 09:23_

I prefer keeping functions const if we can because it allows using const on call sites which may enable compile time optimisations that the compiler otherwise would not do (because the function isn't marked as `const`).

---

_Comment by @MichaReiser on 2023-09-08 09:50_

### Merge Activity

* **Sep 8, 5:50 AM**: [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7217) rebased this pull request as part of a merge.
* **Sep 8, 6:04 AM**: @MichaReiser merged this pull request with [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7217).


---

_Merged by @MichaReiser on 2023-09-08 10:04_

---

_Closed by @MichaReiser on 2023-09-08 10:04_

---

_Branch deleted on 2023-09-08 10:04_

---

_Label `preview` added by @zanieb on 2023-09-11 18:37_

---
