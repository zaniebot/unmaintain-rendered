<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Handle `PossiblyUndefinedDunder` as an error - astral-sh/ruff #16120</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Handle <code>PossiblyUndefinedDunder</code> as an error</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16120">#16120</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-02-12 14:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-12 14:48</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>I won't pretend that I know what I'm doing here.</p>
<p>However, I noticed that our handling of <code>PossiblyUnbound</code> for dunder methods is inconsistent:</p>
<ul>
<li><code>CallDunderResult::return_type</code> returns <code>None</code></li>
<li><code>CallOutcome::return_type</code> might return <code>Some</code> for <code>PossiblyUnboundDunder</code> unlike all other variants taht return an <code>Err</code> in <code>return_type_result</code>.</li>
</ul>
<p>To me, this seems wrong. The idea of those methods is to return the type if it is know but the possibly unbound suggests that the type is actually not known.
Unfortunately, there are no tests...</p>
<p>Edit: I included a small refactor in this PR that renames <code>CallDunderResult</code> to <code>CallDunderOutcome</code>. But it's a separate commit to ease reviewing.</p>
<h2>Test Plan</h2>
<p><code>cargo test</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MichaReiser on 2025-02-12 14:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MichaReiser on 2025-02-12 14:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @MichaReiser on 2025-02-12 14:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @MichaReiser on 2025-02-12 14:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-02-12 15:53</div>
            <div class="timeline-body"><p>I don't see an inconsistency here, or anything that needs fixing?</p>
<p>There are many cases where we want to raise a diagnostic about something, but we still want to return a type. In this case, the dunder might be unbound, which is an error, but if it is bound, we know what its type must be, and the best thing for the user is to a) emit a diagnostic about it being possibly unbound, but also b) check the rest of the code with that type, rather than with <code>Unknown</code>.</p>
<p>Whatever refactoring we do with operations of type outcomes, it cannot rely on an assumption that &quot;emit a diagnostic&quot; and &quot;return a type&quot; are mutually exclusive.</p>
<p>Edit: on re-reading the summary, I understand where it looks like an inconsistency, because <code>return_type_result</code> has to choose between <code>Err</code> and <code>Ok</code>. But even the <code>Err</code> variant it returns still includes the actual known type, which matches what is returned from <code>return_type</code>. The core problem here is that the contract of <code>return_type_result</code> is too limiting, because <code>Ok</code> and <code>Err</code> are the only options, so there isn't a clear way to express &quot;we need to emit a diagnostic, but we also do have a type from this operation.&quot; (I think this issue with <code>return_type_result</code> is at the core of a lot of the API problems on <code>CallOutcome</code>.) But I think the behavior of <code>return_type</code> (given its contract &quot;give me the type, I don't care about diagnostics&quot;) is fine here, if anything it is <code>return_type_result</code> that is problematic (but its current API contract doesn't give it any better options.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-12 16:27</div>
            <div class="timeline-body"><p>I see. That makes me lean even stronger into separating checking vs this public: try guess a type API ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-02-12 16:27</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:57:53 UTC
    </footer>
</body>
</html>
