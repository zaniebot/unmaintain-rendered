<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Support for not equal narrowing - astral-sh/ruff #13749</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Support for not equal narrowing</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13749">#13749</a>
        opened by <a href="https://github.com/Lexxxzy">@Lexxxzy</a>
        on 2024-10-14 12:01
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Lexxxzy">@Lexxxzy</a></div>
            <div class="timeline-body">Summary
<p>Planning to support type narrowing for <code>!=</code> expression as stated in #13694.</p>
Test Plan
<p>Add tests in new md format.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/Lexxxzy">@Lexxxzy</a> on 2024-10-14 12:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/Lexxxzy">@Lexxxzy</a> on 2024-10-14 12:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/Lexxxzy">@Lexxxzy</a> on 2024-10-14 12:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-14 12:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Lexxxzy">@Lexxxzy</a> on 2024-10-14 12:09</div>
            <div class="timeline-body"><p>I have a question: Why isn’t there a case for (1 positive, 1 negative) in the match statement of InnerIntersectionBuilder::build? It seems like (1 &amp; ~0) is essentially just 1. Asking because for this example:</p>
<pre><code>x = None if flag else 1
y = 0

if x != 1:
    y = x

    reveal_type(y) # revealed: None &amp; ~Literal[1]

reveal_type(y) # revealed: Literal[0] | None &amp; ~Literal[1]
</code></pre>
<p><code>y</code> in <code>if x != 1</code> scope should be just <code>None</code>. Also <code>y</code> should be <code>Literal[0] | None</code> outside of condition scope.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-10-14 12:15</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/conditionals.md</code>:14 on 2024-10-15 13:38</div>
            <div class="timeline-body"><p>With the new test framework, we can now write this in a shorter way, without using additional variables:</p>
<pre><code>x = None if flag else 1

if x != None:
    reveal_type(x)  # revealed: Literal[1]

reveal_type(x)  # revealed: None | Literal[1]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/narrow.rs</code>:158 on 2024-10-15 13:41</div>
            <div class="timeline-body"><p>This branch needs the same fix that I did for the <code>IsNot</code> branch here: <a href="https://github.com/astral-sh/ruff/pull/13758">astral-sh/ruff#13758</a>. If you re-apply this <code> | ast::CmpOp::NotEq</code> to the current version on <code>main</code>, that should work automatically.</p>
<p>If we don&#x27;t filter out non-singleton types, you would get a type of <code>list[int] &amp; ~list[int] == Never</code> in a case like this:</p>
<pre><code>x = [1]
y = [1, 2]

if x != y:
    reveal_type(x)  # should still have type list[int]!
</code></pre>
<p>It might make sense to add an explicit test for this as well, even though we have one for <code>is not</code> already. Just in case we ever split the <code>IsNot</code>/<code>NotEq</code> branches for some reason.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/conditionals.md</code>:1 on 2024-10-15 13:41</div>
            <div class="timeline-body"><p>Can you please move this test to <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals_not_equals.md</code> and adapt the structure to the what the other files in this folder have?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/conditionals.md</code>:5 on 2024-10-15 13:42</div>
            <div class="timeline-body"><pre><code>### `x != None`
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> requested changes on 2024-10-15 13:43</div>
            <div class="timeline-body"><p>Thank you very much for working on this. I added a few comments. Let me know if you need any help.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-10-15 13:56</div>
            <div class="timeline-body"><blockquote>
<p>I have a question: Why isn’t there a case for (1 positive, 1 negative) in the match statement of InnerIntersectionBuilder::build?</p>
</blockquote>
<p>There is a case for that. The <code>_</code> catch-all pattern. If there is a positive and a negative contribution, an intersection type needs to be built.</p>
<pre><code>match (self.positive.len(), self.negative.len()) {
    (0, 0) =&gt; Type::Never,
    (1, 0) =&gt; self.positive[0],
    _ =&gt; {
        self.positive.shrink_to_fit();
        self.negative.shrink_to_fit();
        Type::Intersection(IntersectionType::new(db, self.positive, self.negative))
    }
}
</code></pre>
<p>There&#x27;s still the question on how to simplify those intersection types. For example, <code>A &amp; ~A</code> could be simplified to <code>Never</code>. Maybe this is what you had in mind. I will try to look into this soon.</p>
<blockquote>
<p>It seems like (1 &amp; ~0) is essentially just 1.</p>
</blockquote>
<p>It is. This simplification is exactly what the <code>(1, 0)</code> branch does.</p>
<blockquote>
<p><code>y</code> in <code>if x != 1</code> scope should be just <code>None</code></p>
</blockquote>
<p>If we ignore the problem that <code>Literal[1]</code> is not a singleton type (<a href="https://github.com/astral-sh/ruff/pull/13758">astral-sh/ruff#13758</a>), then yes. We would expect <code>None &amp; ~Literal[1]</code> to be simplified to <code>None</code>. This is harder than the <code>A &amp; ~A</code> case above. <code>A &amp; ~B == A</code> is only true if <code>A</code> and <code>B</code> are disjoint.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-10-21 14:04</div>
            <div class="timeline-body"><p>@Lexxxzy I hope that you don&#x27;t mind that I followed up on this myself. There was an additional point I hadn&#x27;t thought about in my initial review. There actually is a difference in the narrowing-logic, compared to the <code>not in</code> branch. When we see</p>
<pre><code>magic_number = 345
x = something()

if x is not magic_number:
    ...
</code></pre>
<p>we&#x27;re not allowed to narrow the type by adding a <code>~Literal[345]</code> constraint (because there could be other Python objects that also have the type <code>Literal[345]</code>). However, if we have a <code>x != magic_number</code> constraint, we are allowed to exclude <code>Literal[345]</code>. Because all inhabitants of <code>Literal[345]</code> would result in the condition being false.</p>
<blockquote>
<p><code>y</code> in <code>if x != 1</code> scope should be just <code>None</code>. Also <code>y</code> should be <code>Literal[0] | None</code> outside of condition scope.</p>
</blockquote>
<p>With #13775, both of these simplifications now work just as you expected.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-10-21 14:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals_nested.md</code>:1 on 2024-10-21 14:21</div>
            <div class="timeline-body"><p>This test is not related to the new feature here, but it&#x27;s something I wanted to add. Using <code>!=</code> narrowing, we can now construct &quot;meaningful&quot; large intersection types.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-10-21 15:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:714 on 2024-10-21 15:00</div>
            <div class="timeline-body"><p>There are probably ways in which an intersection can be single-valued, but I did not invest time into it for now. I can add a TODO, if we think it&#x27;s important.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals_nested.md</code>:12 on 2024-10-21 18:42</div>
            <div class="timeline-body"><p>This display could be improved, but I don&#x27;t think that&#x27;s a priority unless we see it causing unreadable types in real-world code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals_not_eq.md</code>:56 on 2024-10-21 18:48</div>
            <div class="timeline-body"><p>This test doesn&#x27;t currently seem to make sense. The comparison here is against <code>Literal[0]</code>, which is a single-valued type, and we will narrow for <code>!= 0</code>, as shown just a couple tests above. This test is really just testing that <code>Literal[1]</code> and <code>Literal[0]</code> are disjoint, meaning the intersection <code>Literal[1] &amp; ~Literal[0]</code> immediately simplifies to <code>Literal[1]</code>. So this test should either be removed, or re-titled to describe what it actually tests.</p>
<p>I do think we should add some tests here showing that we don&#x27;t do wrong narrowings against non-single-valued types, particularly instance types. For example, <code>a = A(); b = B(); if a != b: ...</code> should not narrow to <code>A &amp; ~B</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:714 on 2024-10-21 19:04</div>
            <div class="timeline-body"><p>I think an intersection would be single-valued if at least one type in its positive side is single-valued.</p>
<p>But I think this can only occur, given intersection simplification, if there is a single-valued type that is overlapping (not disjoint) with some other type, but neither is a subtype of the other. If they are disjoint, or if one is a subtype of the other, then they can&#x27;t occur in the same intersection without one or both of them disappearing (unless they are disjoint and both on the negative side, which wouldn&#x27;t make the intersection single-valued).</p>
<p>I have a hard time imagining that we&#x27;d ever introduce such a pair of types; I can&#x27;t think of an example for any of our current single-valued types.</p>
<p>So I don&#x27;t think this case is important :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-10-21 19:05</div>
            <div class="timeline-body"><p>Looks great, thank you! One comment on the tests that should probably be addressed before landing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-10-21 20:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals_nested.md</code>:12 on 2024-10-21 20:41</div>
            <div class="timeline-body"><blockquote>
<p>This display could be improved</p>
</blockquote>
<p>You mean <code>int &amp; ~Literal[1, 2, 3]</code>? Or the general fact that we show intersection types to users? (which pyright and mypy don&#x27;t seem to do?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-21 20:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals_nested.md</code>:12 on 2024-10-21 20:43</div>
            <div class="timeline-body"><p>I meant condensed, yeah. I&#x27;m ok with showing intersection types to users. (Pyright and mypy will in some cases do so, but they format it like &quot;subclass of A and B&quot;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-10-21 20:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals_not_eq.md</code>:56 on 2024-10-21 20:45</div>
            <div class="timeline-body"><blockquote>
<p>This test doesn&#x27;t currently seem to make sense</p>
</blockquote>
<p>Absolutely. I just pushed the version which I had lying around locally already, but didn&#x27;t commit+push because I got interrupted (sorry). I think it&#x27;s more or less equivalent to what you proposed, but let me know if I should add something similar to <code>a = A(); b = B(); if a != b: ...</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-21 20:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/conditionals_not_eq.md</code>:56 on 2024-10-21 20:49</div>
            <div class="timeline-body"><p>The test you pushed looks sufficient!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-10-21 21:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-10-21 21:08</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:07:26 UTC
    </footer>
</body>
</html>
