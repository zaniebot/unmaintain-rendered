<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dedicated cache directory per ruff version - astral-sh/ruff #8333</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Dedicated cache directory per ruff version</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/8333">#8333</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-10-30 02:21
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR changes our cache to use a dedicated cache directory per ruff version.</p>
<ul>
<li>Before: <code>.ruff_cache/content</code></li>
<li>After: <code>.ruff_cache/0.1.3</code></li>
</ul>
<p>The motivation is that I want to rule out that hash collisions between cache keys causing ruff to load a cache created by another version.
Loading incompatible caches might be the root cause for https://github.com/astral-sh/ruff/issues/8147 (although unlikely, because users mention that they didn't upgrade ruff)
Other hash collissions are less problematic, because the Cache checks if the loaded file is for the same package, and otherwise clears the cache for that package.</p>
<h2>Open questions</h2>
<p>I'm unsure if this is considered a breaking change or not. It does change observable behavior of Ruff but we never included it in our public API.</p>
<h2>Test Plan</h2>
<p>Verified that the cache is still used by comparing performance before/after</p>
<!-- How was it tested? -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-10-30 02:21</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #8333</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8333" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8333?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-10-30 02:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_cli/src/cache.rs</code>:105 on 2023-10-30 02:21</div>
            <div class="timeline-body"><p>Using <code>itoa</code> to write a single number felt overkill.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-10-30 02:27</div>
            <div class="timeline-body"><p>Will we still automatically clear old entries with this approach?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-10-30 02:38</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<p>âœ… ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-10-30 02:45</div>
            <div class="timeline-body"><blockquote>
<p>Will we still automatically clear old entries with this approach?</p>
</blockquote>
<p>We continue to automatically clear old file entries, the same as the old version.</p>
<p>What the version doesn't (nor did the baseline) is to clean up caches of old versions (except if you run <code>ruff clean</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-30 02:59</div>
            <div class="timeline-body"><p>Oh interesting, so even the existing cache will <em>never</em> remove files from old versions?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-10-30 02:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-10-30 03:07</div>
            <div class="timeline-body"><blockquote>
<p>Oh interesting, so even the existing cache will <em>never</em> remove files from old versions?</p>
</blockquote>
<p>Not as far as I know. The only cleanup code that I see is the removal of stale entries:</p>
<p>https://github.com/astral-sh/ruff/blob/6199590072e1d3817d983ec2b8c0136859fedbda/crates/ruff_cli/src/cache.rs#L192-L197</p>
<p>But there's no operation that iterates over all files and cleans unused entries, other than the <code>ruff clean</code>  command</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-10-30 09:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-10-30 09:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-10-30 09:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cli</span> added by @MichaReiser on 2023-10-30 09:08</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:01:08 UTC
    </footer>
</body>
</html>
