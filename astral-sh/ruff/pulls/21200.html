<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-bugbear`] Catch `yield` expressions within other statements (`B901`) - astral-sh/ruff #21200</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-bugbear</code>] Catch <code>yield</code> expressions within other statements (<code>B901</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21200">#21200</a>
        opened by <a href="https://github.com/11happy">@11happy</a>
        on 2025-11-02 09:35
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/11happy">@11happy</a> on 2025-11-02 09:35</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR re-implements <a href="https://docs.astral.sh/ruff/rules/return-in-generator/#return-in-generator-b901">return-in-generator (B901)</a> for async generators as a semantic syntax error. This is not a syntax error for sync generators, so we'll need to preserve both the lint rule and the syntax error in this case.</p>
<p>It also updates B901 and the new implementation to catch cases where the generator's <code>yield</code> or <code>yield from</code> expression is part of another statement, as in:</p>
<pre><code class="language-py">def foo():
    return (yield)
</code></pre>
<p>These were previously not caught because we only looked for <code>Stmt::Expr(Expr::Yield)</code> in <code>visit_stmt</code> instead of visiting <code>yield</code> expressions directly. I think this modification is within the spirit of the rule and safe to try out since the rule is in preview.</p>
<h2>Test Plan</h2>
<!-- How was it tested? -->

<p>I have written tests as directed in #17412</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-11-02 09:37</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ‚úÖ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-11-02 09:38</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ‚úÖ</p>
<details>
<summary>Memory usage changes were detected when running on open source projects</summary>

<pre><code class="language-diff">trio (https://github.com/python-trio/trio)
+ WARN expected `heap_size` to be provided by Salsa query `ClassLiteral &lt; 'db &gt;::variance_of_`
+ WARN expected `heap_size` to be provided by Salsa query `ClassLiteral &lt; 'db &gt;::variance_of_`
+ WARN expected `heap_size` to be provided by Salsa query `ClassLiteral &lt; 'db &gt;::variance_of_`
+ WARN expected `heap_size` to be provided by Salsa query `ClassLiteral &lt; 'db &gt;::variance_of_`
+ WARN expected `heap_size` to be provided by Salsa query `ClassLiteral &lt; 'db &gt;::variance_of_`
+ WARN expected `heap_size` to be provided by Salsa query `ClassLiteral &lt; 'db &gt;::variance_of_`
+ WARN expected `heap_size` to be provided by Salsa query `ClassLiteral &lt; 'db &gt;::variance_of_`
+ WARN expected `heap_size` to be provided by Salsa query `ClassLiteral &lt; 'db &gt;::variance_of_`
+ WARN expected `heap_size` to be provided by Salsa query `GenericAlias &lt; 'db &gt;::variance_of_`
+ WARN expected `heap_size` to be provided by Salsa query `GenericAlias &lt; 'db &gt;::variance_of_`
+ WARN expected `heap_size` to be provided by Salsa query `GenericAlias &lt; 'db &gt;::variance_of_`
+ WARN expected `heap_size` to be provided by Salsa query `GenericAlias &lt; 'db &gt;::variance_of_`
+ WARN expected `heap_size` to be provided by Salsa query `GenericAlias &lt; 'db &gt;::variance_of_`
+ WARN expected `heap_size` to be provided by Salsa query `GenericAlias &lt; 'db &gt;::variance_of_`
+ WARN expected `heap_size` to be provided by Salsa query `GenericAlias &lt; 'db &gt;::variance_of_`
+ WARN expected `heap_size` to be provided by Salsa query `GenericAlias &lt; 'db &gt;::variance_of_`
+ WARN expected `heap_size` to be provided by Salsa query `GenericAlias &lt; 'db &gt;::variance_of_`
+ WARN expected `heap_size` to be provided by Salsa query `GenericAlias &lt; 'db &gt;::variance_of_`
+ WARN expected `heap_size` to be provided by Salsa query `GenericAlias &lt; 'db &gt;::variance_of_`

sphinx (https://github.com/sphinx-doc/sphinx)
- WARN expected `heap_size` to be provided by Salsa query `GenericAlias &lt; 'db &gt;::variance_of_`
- WARN expected `heap_size` to be provided by Salsa query `GenericAlias &lt; 'db &gt;::variance_of_`
- WARN expected `heap_size` to be provided by Salsa query `ClassLiteral &lt; 'db &gt;::variance_of_`
- WARN expected `heap_size` to be provided by Salsa query `GenericAlias &lt; 'db &gt;::variance_of_`
- WARN expected `heap_size` to be provided by Salsa query `ClassLiteral &lt; 'db &gt;::variance_of_`
- WARN expected `heap_size` to be provided by Salsa query `GenericAlias &lt; 'db &gt;::variance_of_`
- WARN expected `heap_size` to be provided by Salsa query `GenericAlias &lt; 'db &gt;::variance_of_`

prefect (https://github.com/PrefectHQ/prefect)
- WARN expected `heap_size` to be provided by Salsa query `GenericAlias &lt; 'db &gt;::variance_of_`
- WARN expected `heap_size` to be provided by Salsa query `GenericAlias &lt; 'db &gt;::variance_of_`
- WARN expected `heap_size` to be provided by Salsa query `ClassLiteral &lt; 'db &gt;::variance_of_`
- WARN expected `heap_size` to be provided by Salsa query `ClassLiteral &lt; 'db &gt;::variance_of_`
- WARN expected `heap_size` to be provided by Salsa query `ClassLiteral &lt; 'db &gt;::variance_of_`
- WARN expected `heap_size` to be provided by Salsa query `ClassLiteral &lt; 'db &gt;::variance_of_`
- WARN expected `heap_size` to be provided by Salsa query `ClassLiteral &lt; 'db &gt;::variance_of_`
- WARN expected `heap_size` to be provided by Salsa query `ClassLiteral &lt; 'db &gt;::variance_of_`
- WARN expected `heap_size` to be provided by Salsa query `ClassLiteral &lt; 'db &gt;::variance_of_`
- WARN expected `heap_size` to be provided by Salsa query `GenericAlias &lt; 'db &gt;::variance_of_`
- WARN expected `heap_size` to be provided by Salsa query `GenericAlias &lt; 'db &gt;::variance_of_`
- WARN expected `heap_size` to be provided by Salsa query `GenericAlias &lt; 'db &gt;::variance_of_`
- WARN expected `heap_size` to be provided by Salsa query `GenericAlias &lt; 'db &gt;::variance_of_`
- WARN expected `heap_size` to be provided by Salsa query `GenericAlias &lt; 'db &gt;::variance_of_`
- WARN expected `heap_size` to be provided by Salsa query `GenericAlias &lt; 'db &gt;::variance_of_`
- WARN expected `heap_size` to be provided by Salsa query `ClassLiteral &lt; 'db &gt;::variance_of_`
- WARN expected `heap_size` to be provided by Salsa query `GenericAlias &lt; 'db &gt;::variance_of_`
- WARN expected `heap_size` to be provided by Salsa query `GenericAlias &lt; 'db &gt;::variance_of_`

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/11happy">@11happy</a> on 2025-11-02 09:43</div>
            <div class="timeline-body"><p>Hii @ntBre would appreciate your views on some design decisions for this PR ,</p>
<ul>
<li><p>I am currently detecting return statements like this,</p>
<pre><code>body.iter().any(|stmt| matches!(stmt, Stmt::Return(_)))
</code></pre>
<p>I think it migh miss the nested ones, should I also use visitor pattern like in original <code>B901</code></p>
</li>
<li><p>also if you have any suggestions for the error message, currently kept it short.</p>
</li>
<li><p>right now its pointing to yield should it point to return ?</p>
</li>
</ul>
<p>Thank you : )</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-11-02 09:57</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>‚ÑπÔ∏è ecosystem check <strong>detected linter changes</strong>. (+35 -0 violations, +0 -0 fixes in 4 projects; 51 projects unchanged)</p>
<details><summary><a href="https://github.com/binary-husky/gpt_academic">binary-husky/gpt_academic</a> (+2 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/binary-husky/gpt_academic/blob/0aa0472da44edc0a888c7f83b564c6d0d1089366/crazy_functions/paper_fns/auto_git/query_analyzer.py#L292'>crazy_functions/paper_fns/auto_git/query_analyzer.py:292:13:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/binary-husky/gpt_academic/blob/0aa0472da44edc0a888c7f83b564c6d0d1089366/crazy_functions/review_fns/query_analyzer.py#L380'>crazy_functions/review_fns/query_analyzer.py:380:13:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
</pre>

</p>
</details>
<details><summary><a href="https://github.com/agronholm/anyio">agronholm/anyio</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/agronholm/anyio/blob/e415faf9df854e559e855970fe0d892792c1abb8/src/anyio/pytest_plugin.py#L145'>src/anyio/pytest_plugin.py:145:5:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
</pre>

</p>
</details>
<details><summary><a href="https://github.com/python-trio/trio">python-trio/trio</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/python-trio/trio/blob/0ae6e622fb618ca833a6106dedb1aed4884ca94a/src/trio/_core/_traps.py#L69'>src/trio/_core/_traps.py:69:5:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
</pre>

</p>
</details>
<details><summary><a href="https://github.com/pytest-dev/pytest">pytest-dev/pytest</a> (+31 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/assertion/__init__.py#L192'>src/_pytest/assertion/__init__.py:192:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/cacheprovider.py#L298'>src/_pytest/cacheprovider.py:298:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/cacheprovider.py#L419'>src/_pytest/cacheprovider.py:419:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/cacheprovider.py#L461'>src/_pytest/cacheprovider.py:461:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/capture.py#L890'>src/_pytest/capture.py:890:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/capture.py#L895'>src/_pytest/capture.py:895:13:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/capture.py#L900'>src/_pytest/capture.py:900:13:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/capture.py#L905'>src/_pytest/capture.py:905:13:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/config/__init__.py#L1412'>src/_pytest/config/__init__.py:1412:13:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/debugging.py#L308'>src/_pytest/debugging.py:308:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/faulthandler.py#L102'>src/_pytest/faulthandler.py:102:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/helpconfig.py#L152'>src/_pytest/helpconfig.py:152:5:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/logging.py#L780'>src/_pytest/logging.py:780:17:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/logging.py#L788'>src/_pytest/logging.py:788:17:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/logging.py#L801'>src/_pytest/logging.py:801:17:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/logging.py#L873'>src/_pytest/logging.py:873:17:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/pytester.py#L171'>src/_pytest/pytester.py:171:13:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/setuponly.py#L36'>src/_pytest/setuponly.py:36:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/skipping.py#L268'>src/_pytest/skipping.py:268:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/skipping.py#L312'>src/_pytest/skipping.py:312:5:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/terminal.py#L717'>src/_pytest/terminal.py:717:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/terminal.py#L981'>src/_pytest/terminal.py:981:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/terminal.py#L992'>src/_pytest/terminal.py:992:13:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/tmpdir.py#L315'>src/_pytest/tmpdir.py:315:5:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/unittest.py#L587'>src/_pytest/unittest.py:587:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/warnings.py#L109'>src/_pytest/warnings.py:109:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/warnings.py#L118'>src/_pytest/warnings.py:118:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/warnings.py#L128'>src/_pytest/warnings.py:128:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/warnings.py#L89'>src/_pytest/warnings.py:89:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/src/_pytest/warnings.py#L98'>src/_pytest/warnings.py:98:9:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
+ <a href='https://github.com/pytest-dev/pytest/blob/8b3550c6cb4ea3898140df153a83addc8cd65710/testing/conftest.py#L91'>testing/conftest.py:91:5:</a> B901 Using `yield` and `return {value}` in a generator function can lead to confusing behavior
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| B901 | 35 | 35 | 0 | 0 | 0 |</p>
</p>
</details>

<h3>Formatter (stable)</h3>
<p>‚úÖ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>‚úÖ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-11-03 18:47</div>
            <div class="timeline-body"><blockquote>
<p>Hii @ntBre would appreciate your views on some design decisions for this PR ,</p>
<ul>
<li><p>I am currently detecting return statements like this,</p>
<pre><code>body.iter().any(|stmt| matches!(stmt, Stmt::Return(_)))
</code></pre>
<p>I think it migh miss the nested ones, should I also use visitor pattern like in original <code>B901</code></p>
</li>
<li><p>also if you have any suggestions for the error message, currently kept it short.</p>
</li>
<li><p>right now its pointing to yield should it point to return ?</p>
</li>
</ul>
<p>Thank you : )</p>
</blockquote>
<p>Yes, I think we should use a visitor like in B901. We can't fully replace B901 since it also applies to sync functions, but we should make sure we catch all of the async cases B901 handles.</p>
<p>I think the error message looks good currently and matches CPython, but I think it should point to <code>return</code> rather than <code>yield</code>, also like CPython and B901.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @11happy on 2025-11-07 03:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @11happy on 2025-11-07 03:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @11happy on 2025-11-07 03:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @11happy on 2025-11-07 03:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @11happy on 2025-11-07 03:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @11happy on 2025-11-07 03:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @11happy on 2025-11-07 03:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/11happy">@11happy</a> on 2025-11-07 03:18</div>
            <div class="timeline-body"><p>its ready for review : )
Thank you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dcreager removed by @MichaReiser on 2025-11-10 12:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @MichaReiser on 2025-11-10 12:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @MichaReiser on 2025-11-10 12:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @MichaReiser on 2025-11-10 12:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dhruvmanila removed by @MichaReiser on 2025-11-10 12:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @MichaReiser on 2025-11-10 12:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/resources/test/fixtures/syntax_errors/return_in_generator.py</code>:1 on 2025-11-10 17:04</div>
            <div class="timeline-body"><p>Could we add a few more test cases here? As a couple of examples, this is not a syntax error for non-async functions:</p>
<pre><code class="language-py">def gen():
    yield 1
    return 42
</code></pre>
<p>and it's also not a syntax error for <code>return</code> without a value:</p>
<pre><code class="language-py">async def gen():
    yield 1
    return
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:867 on 2025-11-10 17:09</div>
            <div class="timeline-body"><p>Does this need to be a <code>SemanticSyntaxContext</code> method? From looking at B901, it seems that it runs on <code>StmtFunctionDef</code>s, not on <code>yield</code> statements. I think we could do the same in <code>SemanticSyntaxChecker::visit_stmt</code>. That would be a bit simpler and we wouldn't have to implement methods for Ruff and ty separately.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:1594 on 2025-11-10 17:10</div>
            <div class="timeline-body"><p>Could we add some docs here? I think it's especially important to capture the &quot;with value&quot; part since it's not in the name.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> requested changes on 2025-11-10 17:10</div>
            <div class="timeline-body"><p>Thanks! I think we could simplify things slightly by following the B901 implementation more closely.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @ntBre on 2025-11-10 17:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-11-10 17:14</div>
            <div class="timeline-body"><p>Oh, one other thing I forgot to mention: I think we need to make B901 only run on sync generators and this syntax error only run on async generators. Then we'll need to convert the syntax error into a B901 error for now to preserve backwards compatibility.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/11happy">@11happy</a> reviewed on 2025-11-12 03:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/11happy">@11happy</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:1594 on 2025-11-12 03:09</div>
            <div class="timeline-body"><p>done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/11happy">@11happy</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:867 on 2025-11-12 03:10</div>
            <div class="timeline-body"><p>done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/11happy">@11happy</a> reviewed on 2025-11-12 03:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/11happy">@11happy</a> reviewed on 2025-11-12 03:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/11happy">@11happy</a> on <code>crates/ruff_linter/resources/test/fixtures/syntax_errors/return_in_generator.py</code>:1 on 2025-11-12 03:10</div>
            <div class="timeline-body"><p>done added more cases</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_bugbear/rules/return_in_generator.rs</code>:99 on 2025-11-12 21:58</div>
            <div class="timeline-body"><p>small nit: It might be worth a comment here like:</p>
<pre><code class="language-suggestion">    // Async functions are flagged by the `ReturnInAsyncGenerator` semantic syntax error.
    if function_def.is_async {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/linter.rs</code>:983 on 2025-11-12 22:00</div>
            <div class="timeline-body"><p>nit: I think we should maybe use <code>PythonVersion::default()</code> or <code>PythonVersion::latest()</code> unless we have a specific reason to choose a version. I think most of our tests run with <code>latest</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:840 on 2025-11-12 22:05</div>
            <div class="timeline-body"><p>nit: can we revert this?</p>
<pre><code class="language-suggestion"></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:1769 on 2025-11-12 22:07</div>
            <div class="timeline-body"><p>I think it's probably worth copying the comment from B901:</p>
<pre><code class="language-suggestion">            // Do not recurse into nested functions; they're evaluated separately.
            Stmt::FunctionDef(_) | Stmt::ClassDef(_) =&gt; {}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:1736 on 2025-11-12 22:10</div>
            <div class="timeline-body"><p>I like that this would take the first return like CPython does rather than the last return like B901, but I think for the sake of compatibility with B901, we should just take the last return and always overwrite:</p>
<pre><code class="language-suggestion">                self.return_range = Some(*range);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:741 on 2025-11-12 22:13</div>
            <div class="timeline-body"><p>We need to convert this into a B901 error right? It looks like we actually don't have any B901 test cases with async functions (that trigger the lint), otherwise I would have expected tests to fail. We should probably add one of those as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:16 on 2025-11-12 22:14</div>
            <div class="timeline-body"><p>Let's keep this empty line.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:7 on 2025-11-12 22:14</div>
            <div class="timeline-body"><p>nit:</p>
<pre><code class="language-suggestion">use ruff_python_ast::statement_visitor::{self, StatementVisitor};
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-11-12 22:16</div>
            <div class="timeline-body"><p>Thanks, this is looking great. I just had a few more nits.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @11happy on 2025-11-26 11:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:1727 on 2025-12-01 22:13</div>
            <div class="timeline-body"><p>I noticed this while reviewing a different PR (https://github.com/astral-sh/ruff/pull/21177#discussion_r2539702728), but I think this logic is actually incorrect here and in B901 itself. This only catches <code>yield</code> and <code>yield from</code> in standalone statements, but the syntax error applies even when these expressions are nested within other statements:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; async def foo():
...     return (yield 1)
...
  File &quot;&lt;python-input-1&gt;&quot;, line 2
    return (yield 1)
    ^^^^^^^^^^^^^^^^
SyntaxError: 'return' with value in async generator
</code></pre>
<p>That's one compact example that won't be flagged here.</p>
<p>The fix is to implement both <code>visit_stmt</code> and <code>visit_expr</code> and to perform the <code>yield</code> checks in <code>visit_expr</code>, as in PLR1708:</p>
<p>https://github.com/astral-sh/ruff/blob/0e651b50b7d0c2614c5958e78525213e759e5b41/crates/ruff_linter/src/rules/pylint/rules/stop_iteration_return.rs#L99-L100</p>
<p>We also have to call <code>walk_stmt</code> in the <code>Return</code> branch, or this case will still not be caught.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/linter.rs</code>:1046 on 2025-12-01 22:19</div>
            <div class="timeline-body"><p>I think it's okay to leave this in the <code>test_semantic_errors</code> test case. It's a bit confusing to see the non-async errors in the snapshot here, especially with the <code>ok</code> comments.</p>
<p>I think we should just add 1 or 2 <code>async</code> test cases to <code>B901.py</code> to make sure the syntax error is being converted correctly for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> requested changes on 2025-12-01 22:21</div>
            <div class="timeline-body"><p>Thank you, this is looking great! I just had one more nit about test placement, and I noticed a preexisting error that I think we can fix here too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/11happy">@11happy</a> reviewed on 2025-12-02 11:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/11happy">@11happy</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:1727 on 2025-12-02 11:04</div>
            <div class="timeline-body"><p>done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/11happy">@11happy</a> reviewed on 2025-12-02 11:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/11happy">@11happy</a> on <code>crates/ruff_linter/src/linter.rs</code>:1046 on 2025-12-02 11:04</div>
            <div class="timeline-body"><p>done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @amyreese on 2025-12-02 23:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-12-02 23:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/linter.rs</code>:1046 on 2025-12-02 23:38</div>
            <div class="timeline-body"><p>Oh I see, the error doesn't trigger at all in <code>test_semantic_errors</code> because we map it back to the rule. I will restore the <code>test_syntax_errors</code> version that you had initially in that case and just clarify the <code>ok</code> comments.</p>
<p>I think it's still nice to have the B901 tests you added :+1:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-12-02 23:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:1727 on 2025-12-02 23:43</div>
            <div class="timeline-body"><p>After this change, we didn't need the <code>Stmt::Expr</code> part anymore. I also copied this change over to B901 proper.</p>
<p>For future reference, I also checked the blame for the &quot;not broken&quot; B901 tests that this changed. They were part of the original PR adding the rule (https://github.com/astral-sh/ruff/pull/11644) and were copied from the upstream linter. However, I think the upstream tests were added incorrectly in https://github.com/PyCQA/flake8-bugbear/commit/05002b5cc7b56f06ff2f84a133339eedb0f470f2 when the real fix was to avoid flagging the error in <code>__await__</code> methods, as we already do. As I noted in one of my commit messages, these cases <em>are</em> syntax errors in async generators, so I think we should be flagging them.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-12-02 23:43</div>
            <div class="timeline-body"><p>Thanks! I pushed a few commits. Just waiting for CI and then I'll merge!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-12-03 00:08</div>
            <div class="timeline-body"><p>Hmm, there are actually 35 new ecosystem hits. They all look like true positives to me, and this is a preview rule, so I think it's okay to accept this, but @amyreese, do you know if code like this is common enough that we should allow it?</p>
<pre><code class="language-py">@pytest.hookimpl(wrapper=True, tryfirst=True)
def pytest_collection(session: Session) -&gt; Generator[None, object, object]:
    config = session.config
    with catch_warnings_for_item(
        config=config, ihook=config.hook, when=&quot;collect&quot;, item=None
    ):
        return (yield)  # &lt;--
</code></pre>
<p>It popped up many times in <code>pytest</code>, but maybe they just wouldn't want to enable this rule.</p>
<p>It seems to me that the motivation for the rule applies whether the yield is a standalone expression or not. But we should probably include this in the release notes, either by splitting out the visitor change/bug fix or at least by updating the title and labels.</p>
<p>For a bit more context, my suggestion to start flagging these was in https://github.com/astral-sh/ruff/pull/21200#discussion_r2578909298.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amyreese">@amyreese</a> on 2025-12-03 01:37</div>
            <div class="timeline-body"><p>I've literally never seen <code>return (yield)</code> in the wild before today. üòÖ</p>
<p>Since most of the ecosystem hits seem related to pytest hooks, I think it would be ok as-is ‚Äî¬†it's a really weird pattern and seems to negate most of the &quot;purpose&quot; of a generator function.</p>
<p>I presume that pytest is doing something like sending a value back into a generator and then capturing that in the <code>StopIteration</code> when it returns, and I suspect they would already have B901 disabled.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amyreese">@amyreese</a> on 2025-12-03 01:41</div>
            <div class="timeline-body"><p>2.2k hits on github, some of which at least seem mildly more useful than what I saw in pytest: https://github.com/search?q=%22return+%28yield%29%22&amp;type=code</p>
<p>I can't imagine people are actually using the actual value from their yield expressions as a return value, probably more as shorthand for <code>yield X; return</code>.</p>
<p>I guess as exceptions to a rule go, it's not crazy to allow it, just weird.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-12-03 15:33</div>
            <div class="timeline-body"><p>Thanks! Sounds like it's probably reasonable to land this, especially since the rule is still in preview. I'll try to update the title and labels so that it shows up in the release notes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[syntax-errors]: semantic syntax error for async generator with return" to "[`flake8-bugbear`] Catch `yield` expressions within other statements (`B901`)" by @ntBre on 2025-12-03 15:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> removed by @ntBre on 2025-12-03 15:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @ntBre on 2025-12-03 15:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @ntBre on 2025-12-03 15:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-12-03 15:52</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/11happy%3Areturn_in_async_generator?utm_source=github&amp;utm_medium=comment&amp;utm_content=header">CodSpeed Performance Report</a></h2>
<h3>Merging #21200 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>11happy:return_in_async_generator</code> (fe9fb9a) with <code>main</code> (4488e9d)</sub></p>
<h3>Summary</h3>
<p><code>‚úÖ 52</code> untouched</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-12-03 15:54</div>
            <div class="timeline-body"><p>Hmm, these benchmarks don't seem right. I'll try to merge main again.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-03 16:09</div>
            <div class="timeline-body"><blockquote>
<p>Hmm, these benchmarks don't seem right. I'll try to merge main again.</p>
</blockquote>
<p>The pydantic benchmark seems to fairly regularly vary around 5% or so since we landed https://github.com/astral-sh/ruff/pull/21467, unfortunately :/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-12-03 17:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-12-03 17:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-12-03 21:54</div>
            <div class="timeline-body"><p>Hmm maybe I should have searched around a bit more. I stumbled across https://github.com/astral-sh/ruff/issues/14453 and https://github.com/astral-sh/ruff/pull/15101 and https://github.com/astral-sh/ruff/pull/15254 for unrelated reasons this afternoon. Apparently this change has already been considered and rejected.</p>
<p>I still think it makes sense to flag these, including after checking the upstream implementation (https://github.com/astral-sh/ruff/pull/21200#discussion_r2583138174), but I guess we should either revert the visitor changes (not the syntax error part) like #15254 or close #14453 as now completed. As I say in my other comment, we at least have to visit sub-expressions in the async case because that's a syntax error:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; async def foo():
...     return (yield 1)
...
  File &quot;&lt;python-input-0&gt;&quot;, line 2
    return (yield 1)
    ^^^^^^^^^^^^^^^^
SyntaxError: 'return' with value in async generator
</code></pre>
<p>but I think that bolsters the sync case too.</p>
<p>cc @MichaReiser who reviewed the earlier PR</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:48:27 UTC
    </footer>
</body>
</html>
