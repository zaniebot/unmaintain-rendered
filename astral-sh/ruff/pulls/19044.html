<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Eagerly evaluate `TYPE_CHECKING` constraints - astral-sh/ruff #19044</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Eagerly evaluate <code>TYPE_CHECKING</code> constraints</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19044">#19044</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-06-30 11:17
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body">Summary
<p>Evaluate <code>TYPE_CHECKING</code> to <code>ALWAYS_TRUE</code> and <code>not TYPE_CHECKING</code> to <code>ALWAYS_FALSE</code> during semantic index building. This is a follow-up to <a href="https://github.com/astral-sh/ruff/pull/18998">astral-sh/ruff#18998</a> and is in principle just a performance optimization. We see some (favorable) ecosystem changes because we can eliminate definitely-unreachable branches early now and retain narrowing constraints without solving <a href="https://github.com/astral-sh/ty/issues/690">astral-sh/ty#690</a> first.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-06-30 11:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-30 11:21</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>yarl (https://github.com/aio-libs/yarl)
- error[invalid-argument-type] yarl/_url.py:1463:53: Argument to function `unsplit_result` is incorrect: Expected `str`, found `str | None`
- error[invalid-argument-type] yarl/_url.py:1463:73: Argument to function `unsplit_result` is incorrect: Expected `str`, found `str | None`
- Found 154 diagnostics
+ Found 152 diagnostics

dulwich (https://github.com/dulwich/dulwich)
- TOTAL MEMORY USAGE: ~156MB
+ TOTAL MEMORY USAGE: ~142MB

alerta (https://github.com/alerta/alerta)
- TOTAL MEMORY USAGE: ~106MB
+ TOTAL MEMORY USAGE: ~117MB

discord.py (https://github.com/Rapptz/discord.py)
-     memo fields = ~207MB
+     memo fields = ~189MB

mkosi (https://github.com/systemd/mkosi)
- TOTAL MEMORY USAGE: ~117MB
+ TOTAL MEMORY USAGE: ~129MB
-     memo fields = ~97MB
+     memo fields = ~106MB

schemathesis (https://github.com/schemathesis/schemathesis)
- TOTAL MEMORY USAGE: ~171MB
+ TOTAL MEMORY USAGE: ~156MB

black (https://github.com/psf/black)
- TOTAL MEMORY USAGE: ~129MB
+ TOTAL MEMORY USAGE: ~142MB

mkdocs (https://github.com/mkdocs/mkdocs)
- error[invalid-assignment] mkdocs/localization.py:88:13: Object of type `NullTranslations` is not assignable to `Translations | None`
- Found 193 diagnostics
+ Found 192 diagnostics

paasta (https://github.com/yelp/paasta)
-     memo fields = ~171MB
+     memo fields = ~156MB

freqtrade (https://github.com/freqtrade/freqtrade)
-     memo fields = ~304MB
+     memo fields = ~276MB

static-frame (https://github.com/static-frame/static-frame)
-     memo fields = ~334MB
+     memo fields = ~304MB

prefect (https://github.com/PrefectHQ/prefect)
- error[unsupported-operator] src/prefect/_internal/compatibility/deprecated.py:90:20: Operator `+` is unsupported between objects of type `datetime | None` and `timedelta`
- warning[possibly-unbound-attribute] src/prefect/_internal/concurrency/calls.py:452:16: Attribute `timedout` on type `None | Unknown` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/_internal/concurrency/calls.py:455:18: Attribute `cancelled` on type `None | Unknown` is possibly unbound
- error[invalid-argument-type] src/prefect/automations.py:268:62: Argument to bound method `read_automations_by_name` is incorrect: Expected `str`, found `str | None`
- warning[possibly-unbound-attribute] src/prefect/blocks/core.py:975:36: Attribute `read_block_document` on type `PrefectClient | None` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/blocks/core.py:1355:32: Attribute `read_block_type_by_slug` on type `PrefectClient | None` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/blocks/core.py:1365:23: Attribute `update_block_type` on type `PrefectClient | None` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/blocks/core.py:1391:32: Attribute `create_block_type` on type `PrefectClient | None` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/blocks/core.py:1395:34: Attribute `read_block_schema_by_checksum` on type `PrefectClient | None` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/blocks/core.py:1405:34: Attribute `create_block_schema` on type `PrefectClient | None` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/blocks/core.py:1469:36: Attribute `create_block_document` on type `PrefectClient | None` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/blocks/core.py:1476:53: Attribute `read_block_document_by_name` on type `PrefectClient | None` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/blocks/core.py:1489:23: Attribute `update_block_document` on type `PrefectClient | None` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/blocks/core.py:1493:40: Attribute `read_block_document` on type `PrefectClient | None` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/blocks/core.py:1541:15: Attribute `delete_block_document` on type `PrefectClient | None` is possibly unbound
- error[invalid-argument-type] src/prefect/cli/block.py:226:58: Argument to function `_register_blocks_in_module` is incorrect: Expected `ModuleType`, found `None | ModuleType | @Todo(generic `typing.Awaitable` type)`
- error[invalid-argument-type] src/prefect/cli/cloud/__init__.py:155:35: Argument to function `print_exception` is incorrect: Expected `type[BaseException] | None`, found `type[BaseException] | &lt;class &#x27;NoneType&#x27;&gt;`
- warning[possibly-unbound-attribute] src/prefect/cli/cloud/__init__.py:155:64: Attribute `__traceback__` on type `BaseException | None` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/cli/cloud/__init__.py:512:16: Attribute `startswith` on type `str | None | Unknown` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/cli/cloud/__init__.py:518:22: Attribute `startswith` on type `str | None | Unknown` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/cli/cloud/__init__.py:518:53: Attribute `startswith` on type `str | None | Unknown` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/cli/cloud/__init__.py:588:30: Attribute `api_url` on type `None | @Todo(generic `typing.Awaitable` type) | (Workspace &amp; ~AlwaysFalsy)` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/cli/cloud/__init__.py:593:62: Attribute `handle` on type `None | @Todo(generic `typing.Awaitable` type) | (Workspace &amp; ~AlwaysFalsy)` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/cli/deployment.py:191:19: Attribute `read_work_pool` on type `PrefectClient | None` is possibly unbound
- error[invalid-argument-type] src/prefect/flow_runs.py:277:13: Argument to function `propose_state` is incorrect: Expected `PrefectClient`, found `PrefectClient | None`
- warning[possibly-unbound-attribute] src/prefect/flow_runs.py:315:30: Attribute `read_flow_run` on type `PrefectClient | None` is possibly unbound
- error[invalid-argument-type] src/prefect/flow_runs.py:432:13: Argument to function `propose_state` is incorrect: Expected `PrefectClient`, found `PrefectClient | None`
- error[invalid-return-type] src/prefect/results.py:127:12: Return type does not match returned value: expected `WritableFileSystem`, found `Unknown | Coroutine[Any, Any, Unknown] | LocalFileSystem`
- error[invalid-assignment] src/prefect/results.py:186:9: Object of type `Unknown | Coroutine[Any, Any, Unknown]` is not assignable to `WritableFileSystem`
- error[unsupported-operator] src/prefect/runner/server.py:67:12: Operator `&gt;` is not supported for types `int` and `None`, in comparing `int | float` with `int | None`
- warning[possibly-unbound-attribute] src/prefect/server/services/task_run_recorder.py:58:15: Attribute `model_dump` on type `State | None` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/task_worker.py:72:9: Attribute `state_details` on type `State[Any] | None` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/task_worker.py:289:60: Attribute `name` on type `State[Any] | None` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/task_worker.py:310:29: Attribute `state_details` on type `State[Any] | None` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/task_worker.py:419:27: Attribute `isoformat` on type `@Todo(Support for `typing.TypeAlias`) | None` is possibly unbound
- error[unresolved-attribute] src/prefect/utilities/_ast.py:92:31: Type `expr` has no attribute `keywords`
- error[unsupported-operator] src/prefect/utilities/_engine.py:31:56: Operator `+` is unsupported between objects of type `Unknown | str | int` and `Literal[1]`
- warning[possibly-unbound-attribute] src/prefect/utilities/engine.py:482:20: Attribute `id` on type `State[Any] | None` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/utilities/engine.py:483:27: Attribute `timestamp` on type `State[Any] | None` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/utilities/engine.py:484:12: Attribute `state_details` on type `State[Any] | None` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/utilities/engine.py:485:35: Attribute `state_details` on type `State[Any] | None` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/utilities/engine.py:497:12: Attribute `is_paused` on type `State[Any] | None` is possibly unbound
- error[invalid-return-type] src/prefect/utilities/engine.py:499:16: Return type does not match returned value: expected `State[Any]`, found `State[Any] | None`
- error[invalid-argument-type] src/prefect/utilities/importtools.py:113:46: Argument to function `module_from_spec` is incorrect: Expected `ModuleSpec`, found `ModuleSpec | None`
- warning[possibly-unbound-attribute] src/prefect/utilities/importtools.py:120:13: Attribute `loader` on type `ModuleSpec | None` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/utilities/importtools.py:120:13: Attribute `exec_module` on type `Loader | None` is possibly unbound
- error[invalid-argument-type] src/prefect/utilities/importtools.py:248:40: Argument to bound method `__init__` is incorrect: Expected `Loader`, found `Loader | None`
- warning[possibly-unbound-attribute] src/prefect/utilities/importtools.py:390:45: Attribute `__package__` on type `None | ModuleType` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/utilities/importtools.py:390:45: Attribute `split` on type `str | None` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/utilities/templating.py:313:36: Attribute `read_block_document` on type `PrefectClient | None` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/utilities/templating.py:349:36: Attribute `read_block_document_by_name` on type `PrefectClient | None` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/utilities/templating.py:421:30: Attribute `read_variable_by_name` on type `PrefectClient | None` is possibly unbound
- warning[possibly-unbound-attribute] src/prefect/utilities/templating.py:430:38: Attribute `read_variable_by_name` on type `PrefectClient | None` is possibly unbound
- Found 4196 diagnostics
+ Found 4143 diagnostics

rotki (https://github.com/rotki/rotki)
-     memo fields = ~490MB
+     memo fields = ~445MB

</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-06-30 11:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-06-30 11:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-06-30 11:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-06-30 11:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-30 12:21</div>
            <div class="timeline-body"><p>I would sort-of be tempted to use a recursive inner function here -- I know it&#x27;s not <em>necessary</em>, but I also doubt it would hurt, and it feels more elegant and extensible:</p>
<pre><code>    fn build_predicate(&amp;mut self, predicate_node: &amp;ast::Expr) -&gt; PredicateOrLiteral&lt;&#x27;db&gt; {
        // Some commonly used test expressions are eagerly evaluated as `true`
        // or `false` here for performance reasons. This list does not need to
        // be exhaustive. More complex expressions will still evaluate to the
        // correct value during type-checking.
        fn build_predicate_inner(node: &amp;ast::Expr) -&gt; Truthiness {
            match node {
                ast::Expr::BooleanLiteral(ast::ExprBooleanLiteral { value, .. }) =&gt; {
                    Truthiness::from(*value)
                }
                ast::Expr::Name(ast::ExprName { id, .. }) if id == &quot;TYPE_CHECKING&quot; =&gt; {
                    Truthiness::AlwaysTrue
                }
                ast::Expr::UnaryOp(ast::ExprUnaryOp {
                    op: ast::UnaryOp::Not,
                    operand,
                    ..
                }) =&gt; build_predicate_inner(operand).negate(),
                _ =&gt; Truthiness::Ambiguous,
            }
        }

        let expression = self.add_standalone_expression(predicate_node);

        match build_predicate_inner(predicate_node) {
            Truthiness::AlwaysTrue =&gt; PredicateOrLiteral::Literal(true),
            Truthiness::AlwaysFalse =&gt; PredicateOrLiteral::Literal(false),
            Truthiness::Ambiguous =&gt; PredicateOrLiteral::Predicate(Predicate {
                node: PredicateNode::Expression(expression),
                is_positive: true,
            }),
        }
    }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-06-30 12:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-01 08:52</div>
            <div class="timeline-body"><blockquote>
<p>I would sort-of be tempted to use a recursive inner function here -- I know it&#x27;s not <em>necessary</em>, but I also doubt it would hurt, and it feels more elegant and extensible:</p>
</blockquote>
<p>I love it. Thanks. Modified it to return <code>Option&lt;bool&gt;</code> instead of <code>Truthiness</code>, as a return value of <code>Truthiness::Ambigous</code> would imply that we know for sure that some patterns has ambiguous truthiness, which is not the case. Also makes the code a bit simpler.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-01 09:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-01 09:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-01 09:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:16:04 UTC
    </footer>
</body>
</html>
