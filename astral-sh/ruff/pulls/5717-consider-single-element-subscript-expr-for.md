```yaml
number: 5717
title: Consider single element subscript expr for implicit optional
type: pull_request
state: merged
author: dhruvmanila
labels:
  - rule
assignees: []
merged: true
base: main
head: dhruv/implicit-optional-tests
created_at: 2023-07-12T17:39:37Z
updated_at: 2023-07-13T13:10:09Z
url: https://github.com/astral-sh/ruff/pull/5717
synced_at: 2026-01-12T15:55:19Z
```

# Consider single element subscript expr for implicit optional

---

_@dhruvmanila_

## Summary

Consider single element subscript expr for implicit optional.

On `main`, the cases where there is only a single element in the subscript
list was giving false positives such as for the following:

```python
typing.Union[None]
typing.Literal[None]
```

## Test Plan

`cargo test`


---

_Comment by @dhruvmanila on 2023-07-12 17:39_

Current dependencies on/for this PR:
* main
  * **PR #5601** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5601" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #5717** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5717" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  üëà

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/5717?utm_source=stack-comment).

---

_Converted to draft by @dhruvmanila on 2023-07-12 18:07_

---

_Comment by @github-actions[bot] on 2023-07-12 18:15_

## PR Check Results
### Ecosystem
‚ÑπÔ∏è ecosystem check **detected changes**. (+56, -0, 0 error(s))

<details><summary>airflow (+28, -0)</summary>
<p>

<pre>
+ <a href='https://github.com/apache/airflow/blob/145b16caaa43f0c42bffd97344df916c602cddde/airflow/decorators/base.py#L333'>airflow/decorators/base.py:333:16:</a> PLR1714 Consider merging multiple comparisons: `ttype in (dict, Dict)`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/apache/airflow/blob/145b16caaa43f0c42bffd97344df916c602cddde/airflow/decorators/task_group.py#L150'>airflow/decorators/task_group.py:150:13:</a> PLR1714 Consider merging multiple comparisons: `v.kind in (inspect.Parameter.VAR_POSITIONAL, inspect.Parameter.VAR_KEYWORD)`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/apache/airflow/blob/145b16caaa43f0c42bffd97344df916c602cddde/airflow/models/dagrun.py#L704'>airflow/models/dagrun.py:704:12:</a> PLR1714 Consider merging multiple comparisons: `self._state in (DagRunState.FAILED, DagRunState.SUCCESS)`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/apache/airflow/blob/145b16caaa43f0c42bffd97344df916c602cddde/airflow/providers/amazon/aws/hooks/redshift_data.py#L115'>airflow/providers/amazon/aws/hooks/redshift_data.py:115:18:</a> PLR1714 Consider merging multiple comparisons: `status in ("FAILED", "ABORTED")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/apache/airflow/blob/145b16caaa43f0c42bffd97344df916c602cddde/airflow/providers/google/cloud/hooks/kubernetes_engine.py#L127'>airflow/providers/google/cloud/hooks/kubernetes_engine.py:127:16:</a> PLR1714 Consider merging multiple comparisons: `operation.status in (Operation.Status.RUNNING, Operation.Status.PENDING)`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/apache/airflow/blob/145b16caaa43f0c42bffd97344df916c602cddde/airflow/providers/google/cloud/operators/bigquery_dts.py#L373'>airflow/providers/google/cloud/operators/bigquery_dts.py:373:20:</a> PLR1714 Consider merging multiple comparisons: `state in (TransferState.FAILED, TransferState.CANCELLED)`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/apache/airflow/blob/145b16caaa43f0c42bffd97344df916c602cddde/airflow/providers/google/cloud/operators/bigquery_dts.py#L395'>airflow/providers/google/cloud/operators/bigquery_dts.py:395:12:</a> PLR1714 Consider merging multiple comparisons: `event["status"] in ("failed", "cancelled")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/apache/airflow/blob/145b16caaa43f0c42bffd97344df916c602cddde/airflow/providers/google/cloud/operators/dataflow.py#L708'>airflow/providers/google/cloud/operators/dataflow.py:708:12:</a> PLR1714 Consider merging multiple comparisons: `event["status"] in ("error", "stopped")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/apache/airflow/blob/145b16caaa43f0c42bffd97344df916c602cddde/airflow/providers/google/cloud/operators/dataflow.py#L893'>airflow/providers/google/cloud/operators/dataflow.py:893:12:</a> PLR1714 Consider merging multiple comparisons: `event["status"] in ("error", "stopped")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/apache/airflow/blob/145b16caaa43f0c42bffd97344df916c602cddde/airflow/providers/google/cloud/operators/dataproc.py#L1795'>airflow/providers/google/cloud/operators/dataproc.py:1795:12:</a> PLR1714 Consider merging multiple comparisons: `event["status"] in ("failed", "error")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/apache/airflow/blob/145b16caaa43f0c42bffd97344df916c602cddde/airflow/providers/google/cloud/operators/dataproc.py#L1920'>airflow/providers/google/cloud/operators/dataproc.py:1920:12:</a> PLR1714 Consider merging multiple comparisons: `event["status"] in ("failed", "error")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/apache/airflow/blob/145b16caaa43f0c42bffd97344df916c602cddde/airflow/providers/google/cloud/operators/kubernetes_engine.py#L166'>airflow/providers/google/cloud/operators/kubernetes_engine.py:166:12:</a> PLR1714 Consider merging multiple comparisons: `status in ("failed", "error")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/apache/airflow/blob/145b16caaa43f0c42bffd97344df916c602cddde/airflow/providers/google/cloud/operators/kubernetes_engine.py#L373'>airflow/providers/google/cloud/operators/kubernetes_engine.py:373:12:</a> PLR1714 Consider merging multiple comparisons: `status in ("failed", "error")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/apache/airflow/blob/145b16caaa43f0c42bffd97344df916c602cddde/airflow/providers/google/cloud/triggers/kubernetes_engine.py#L202'>airflow/providers/google/cloud/triggers/kubernetes_engine.py:202:22:</a> PLR1714 Consider merging multiple comparisons: `status in (Operation.Status.RUNNING, Operation.Status.PENDING)`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/apache/airflow/blob/145b16caaa43f0c42bffd97344df916c602cddde/airflow/providers/google/common/hooks/base_google.py#L101'>airflow/providers/google/common/hooks/base_google.py:101:16:</a> PLR1714 Consider merging multiple comparisons: `exception.resp.status in (429, 409)`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/apache/airflow/blob/145b16caaa43f0c42bffd97344df916c602cddde/airflow/www/fab_security/manager.py#L616'>airflow/www/fab_security/manager.py:616:12:</a> PLR1714 Consider merging multiple comparisons: `provider in ("github", "githublocal")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/apache/airflow/blob/145b16caaa43f0c42bffd97344df916c602cddde/airflow/www/views.py#L3999'>airflow/www/views.py:3999:24:</a> PLR1714 Consider merging multiple comparisons: `dep.dependency_type in ("dag", "dataset")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/apache/airflow/blob/145b16caaa43f0c42bffd97344df916c602cddde/dev/breeze/src/airflow_breeze/utils/host_info_utils.py#L38'>dev/breeze/src/airflow_breeze/utils/host_info_utils.py:38:8:</a> PLR1714 Consider merging multiple comparisons: `os in ("linux", "darwin")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/apache/airflow/blob/145b16caaa43f0c42bffd97344df916c602cddde/dev/breeze/src/airflow_breeze/utils/host_info_utils.py#L48'>dev/breeze/src/airflow_breeze/utils/host_info_utils.py:48:8:</a> PLR1714 Consider merging multiple comparisons: `os in ("linux", "darwin")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/apache/airflow/blob/145b16caaa43f0c42bffd97344df916c602cddde/dev/provider_packages/prepare_provider_packages.py#L742'>dev/provider_packages/prepare_provider_packages.py:742:12:</a> PLR1714 Consider merging multiple comparisons: `ex.returncode in (128, 2)`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/apache/airflow/blob/145b16caaa43f0c42bffd97344df916c602cddde/docker_tests/test_docker_compose_quick_start.py#L90'>docker_tests/test_docker_compose_quick_start.py:90:16:</a> PLR1714 Consider merging multiple comparisons: `health_status in ("healthy", "no-check")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/apache/airflow/blob/145b16caaa43f0c42bffd97344df916c602cddde/helm_tests/airflow_aux/test_basic_helm_chart.py#L42'>helm_tests/airflow_aux/test_basic_helm_chart.py:42:12:</a> PLR1714 Consider merging multiple comparisons: `version in ("2.3.2", "default")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/apache/airflow/blob/145b16caaa43f0c42bffd97344df916c602cddde/scripts/ci/pre_commit/pre_commit_check_lazy_logging.py#L44'>scripts/ci/pre_commit/pre_commit_check_lazy_logging.py:44:17:</a> PLR1714 Consider merging multiple comparisons: `self.cur_node.func.value.id in ("logger", "logging", "log")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/apache/airflow/blob/145b16caaa43f0c42bffd97344df916c602cddde/scripts/ci/pre_commit/pre_commit_json_schema.py#L145'>scripts/ci/pre_commit/pre_commit_json_schema.py:145:8:</a> PLR1714 Consider merging multiple comparisons: `default not in (instance, "See values.yaml")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/apache/airflow/blob/145b16caaa43f0c42bffd97344df916c602cddde/tests/jobs/test_backfill_job.py#L1286'>tests/jobs/test_backfill_job.py:1286:16:</a> PLR1714 Consider merging multiple comparisons: `ti.task_id in ("leave1", "leave2")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/apache/airflow/blob/145b16caaa43f0c42bffd97344df916c602cddde/tests/jobs/test_triggerer_job.py#L203'>tests/jobs/test_triggerer_job.py:203:16:</a> PLR1714 Consider merging multiple comparisons: `job_runner.capacity in (input_str, 1000)`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/apache/airflow/blob/145b16caaa43f0c42bffd97344df916c602cddde/tests/providers/elasticsearch/log/elasticmock/fake_elasticsearch.py#L372'>tests/providers/elasticsearch/log/elasticmock/fake_elasticsearch.py:372:16:</a> PLR1714 Consider merging multiple comparisons: `target in ("_all", "")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/apache/airflow/blob/145b16caaa43f0c42bffd97344df916c602cddde/tests/providers/google/cloud/operators/test_bigquery.py#L1829'>tests/providers/google/cloud/operators/test_bigquery.py:1829:16:</a> PLR1714 Consider merging multiple comparisons: `missing_param.value.args[0] in (expected, expected1)`. Use a `set` if the elements are hashable.
</pre>

</p>
</details>
<details><summary>bokeh (+4, -0)</summary>
<p>

<pre>
+ <a href='https://github.com/bokeh/bokeh/blob/4ad3732a2753ac62dd3668ba8a044d11b88d86ba/src/bokeh/server/tornado.py#L619'>src/bokeh/server/tornado.py:619:12:</a> PLR1714 Consider merging multiple comparisons: `mode in ("server", "server-dev")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/bokeh/bokeh/blob/4ad3732a2753ac62dd3668ba8a044d11b88d86ba/tests/unit/bokeh/embed/test_server__embed.py#L215'>tests/unit/bokeh/embed/test_server__embed.py:215:16:</a> PLR1714 Consider merging multiple comparisons: `r in ("&foo=10&bar=baz", "&bar=baz&foo=10")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/bokeh/bokeh/blob/4ad3732a2753ac62dd3668ba8a044d11b88d86ba/tests/unit/bokeh/embed/test_server__embed.py#L222'>tests/unit/bokeh/embed/test_server__embed.py:222:16:</a> PLR1714 Consider merging multiple comparisons: `r in ("&foo=10&bar=baz", "&bar=baz&foo=10")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/bokeh/bokeh/blob/4ad3732a2753ac62dd3668ba8a044d11b88d86ba/tests/unit/bokeh/test_objects.py#L575'>tests/unit/bokeh/test_objects.py:575:16:</a> PLR1714 Consider merging multiple comparisons: `i in (('a', 1), ('b', 2), ('c', 3))`. Use a `set` if the elements are hashable.
</pre>

</p>
</details>
<details><summary>typeshed (+2, -0)</summary>
<p>

<pre>
+ <a href='https://github.com/python/typeshed/blob/f2ee9e9368a18b19bbf2ac05b6eb6bfea96d9a0c/stdlib/builtins.pyi#L867'>stdlib/builtins.pyi:867:27:</a> PYI036 The first argument in `__exit__` should be annotated with `object` or `type[BaseException] | None`
+ <a href='https://github.com/python/typeshed/blob/f2ee9e9368a18b19bbf2ac05b6eb6bfea96d9a0c/stdlib/typing.pyi#L758'>stdlib/typing.pyi:758:23:</a> PYI036 The first argument in `__exit__` should be annotated with `object` or `type[BaseException] | None`
</pre>

</p>
</details>
<details><summary>zulip (+22, -0)</summary>
<p>

<pre>
+ <a href='https://github.com/zulip/zulip/blob/654fb188327cf9d22fe27118c6a531146be5e247/analytics/views/user_activity.py#L63'>analytics/views/user_activity.py:63:12:</a> PLR1714 Consider merging multiple comparisons: `k in ("name", "user_profile_id")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/zulip/zulip/blob/654fb188327cf9d22fe27118c6a531146be5e247/tools/lib/sanity_check.py#L17'>tools/lib/sanity_check.py:17:12:</a> PLR1714 Consider merging multiple comparisons: `user_name not in ("vagrant", "zulipdev")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/zulip/zulip/blob/654fb188327cf9d22fe27118c6a531146be5e247/zerver/actions/create_realm.py#L102'>zerver/actions/create_realm.py:102:9:</a> PLR1714 Consider merging multiple comparisons: `realm.org_type in (Realm.ORG_TYPES["education_nonprofit"]["id"], Realm.ORG_TYPES["education"]["id"])`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/zulip/zulip/blob/654fb188327cf9d22fe27118c6a531146be5e247/zerver/actions/create_realm.py#L220'>zerver/actions/create_realm.py:220:13:</a> PLR1714 Consider merging multiple comparisons: `realm.org_type in (Realm.ORG_TYPES["education_nonprofit"]["id"], Realm.ORG_TYPES["education"]["id"])`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/zulip/zulip/blob/654fb188327cf9d22fe27118c6a531146be5e247/zerver/actions/custom_profile_fields.py#L113'>zerver/actions/custom_profile_fields.py:113:9:</a> PLR1714 Consider merging multiple comparisons: `field.field_type in (CustomProfileField.SELECT, CustomProfileField.EXTERNAL_ACCOUNT)`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/zulip/zulip/blob/654fb188327cf9d22fe27118c6a531146be5e247/zerver/actions/custom_profile_fields.py#L65'>zerver/actions/custom_profile_fields.py:65:9:</a> PLR1714 Consider merging multiple comparisons: `custom_profile_field.field_type in (CustomProfileField.SELECT, CustomProfileField.EXTERNAL_ACCOUNT)`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/zulip/zulip/blob/654fb188327cf9d22fe27118c6a531146be5e247/zerver/lib/email_notifications.py#L528'>zerver/lib/email_notifications.py:528:24:</a> PLR1714 Consider merging multiple comparisons: `m["trigger"] in (NotificationTriggers.MENTION, NotificationTriggers.STREAM_WILDCARD_MENTION, NotificationTriggers.STREAM_WILDCARD_MENTION_IN_FOLLOWED_TOPIC)`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/zulip/zulip/blob/654fb188327cf9d22fe27118c6a531146be5e247/zerver/lib/logging_util.py#L155'>zerver/lib/logging_util.py:155:12:</a> PLR1714 Consider merging multiple comparisons: `module_name in (logger_name, record.name)`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/zulip/zulip/blob/654fb188327cf9d22fe27118c6a531146be5e247/zerver/lib/onboarding.py#L46'>zerver/lib/onboarding.py:46:9:</a> PLR1714 Consider merging multiple comparisons: `user.realm.org_type in (Realm.ORG_TYPES["education_nonprofit"]["id"], Realm.ORG_TYPES["education"]["id"])`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/zulip/zulip/blob/654fb188327cf9d22fe27118c6a531146be5e247/zerver/models.py#L2039'>zerver/models.py:2039:13:</a> PLR1714 Consider merging multiple comparisons: `self.role in (UserProfile.ROLE_REALM_ADMINISTRATOR, UserProfile.ROLE_REALM_OWNER)`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/zulip/zulip/blob/654fb188327cf9d22fe27118c6a531146be5e247/zerver/views/custom_profile_fields.py#L83'>zerver/views/custom_profile_fields.py:83:8:</a> PLR1714 Consider merging multiple comparisons: `field_type in (CustomProfileField.LONG_TEXT, CustomProfileField.USER)`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/zulip/zulip/blob/654fb188327cf9d22fe27118c6a531146be5e247/zerver/webhooks/clubhouse/view.py#L403'>zerver/webhooks/clubhouse/view.py:403:12:</a> PLR1714 Consider merging multiple comparisons: `entity in ("pull-request", "pull-request-comment")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/zulip/zulip/blob/654fb188327cf9d22fe27118c6a531146be5e247/zerver/webhooks/github/view.py#L80'>zerver/webhooks/github/view.py:80:8:</a> PLR1714 Consider merging multiple comparisons: `action in ("opened", "merged")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/zulip/zulip/blob/654fb188327cf9d22fe27118c6a531146be5e247/zerver/webhooks/gitlab/view.py#L453'>zerver/webhooks/gitlab/view.py:453:10:</a> PLR1714 Consider merging multiple comparisons: `event in ("Job Hook", "Build Hook")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/zulip/zulip/blob/654fb188327cf9d22fe27118c6a531146be5e247/zerver/webhooks/gitlab/view.py#L478'>zerver/webhooks/gitlab/view.py:478:10:</a> PLR1714 Consider merging multiple comparisons: `event in ("Note Hook Issue", "Confidential Note Hook Issue")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/zulip/zulip/blob/654fb188327cf9d22fe27118c6a531146be5e247/zerver/webhooks/pagerduty/view.py#L217'>zerver/webhooks/pagerduty/view.py:217:9:</a> PLR1714 Consider merging multiple comparisons: `message_type in ("incident.resolve", "incident.resolved")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/zulip/zulip/blob/654fb188327cf9d22fe27118c6a531146be5e247/zerver/webhooks/pagerduty/view.py#L221'>zerver/webhooks/pagerduty/view.py:221:9:</a> PLR1714 Consider merging multiple comparisons: `message_type in ("incident.resolve", "incident.resolved")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/zulip/zulip/blob/654fb188327cf9d22fe27118c6a531146be5e247/zerver/webhooks/pagerduty/view.py#L224'>zerver/webhooks/pagerduty/view.py:224:10:</a> PLR1714 Consider merging multiple comparisons: `message_type in ("incident.assign", "incident.reassigned")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/zulip/zulip/blob/654fb188327cf9d22fe27118c6a531146be5e247/zerver/webhooks/raygun/view.py#L230'>zerver/webhooks/raygun/view.py:230:8:</a> PLR1714 Consider merging multiple comparisons: `event_type in ("NewErrorOccurred", "ErrorReoccurred")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/zulip/zulip/blob/654fb188327cf9d22fe27118c6a531146be5e247/zerver/webhooks/raygun/view.py#L289'>zerver/webhooks/raygun/view.py:289:9:</a> PLR1714 Consider merging multiple comparisons: `event_type in ("StatusChanged", "AssignedToUser", "CommentAdded")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/zulip/zulip/blob/654fb188327cf9d22fe27118c6a531146be5e247/zerver/webhooks/sonarr/view.py#L59'>zerver/webhooks/sonarr/view.py:59:8:</a> PLR1714 Consider merging multiple comparisons: `event_type not in ("Test", "Health")`. Use a `set` if the elements are hashable.
+ <a href='https://github.com/zulip/zulip/blob/654fb188327cf9d22fe27118c6a531146be5e247/zerver/webhooks/wordpress/view.py#L46'>zerver/webhooks/wordpress/view.py:46:8:</a> PLR1714 Consider merging multiple comparisons: `hook in ("publish_post", "publish_page")`. Use a `set` if the elements are hashable.
</pre>

</p>
</details>
Rules changed: 2

| Rule | Changes | Additions | Removals |
| ---- | ------- | --------- | -------- |
| PLR1714 | 54 | 54 | 0 |
| PYI036 | 2 | 2 | 0 |

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      8.4¬±0.01ms     4.9 MB/sec    1.01      8.4¬±0.01ms     4.8 MB/sec
formatter/numpy/ctypeslib.py               1.00   1901.0¬±4.02¬µs     8.8 MB/sec    1.01  1918.2¬±10.77¬µs     8.7 MB/sec
formatter/numpy/globals.py                 1.00    203.7¬±0.36¬µs    14.5 MB/sec    1.01    206.0¬±0.53¬µs    14.3 MB/sec
formatter/pydantic/types.py                1.00      4.2¬±0.01ms     6.0 MB/sec    1.01      4.3¬±0.01ms     6.0 MB/sec
linter/all-rules/large/dataset.py          1.00     14.1¬±0.04ms     2.9 MB/sec    1.00     14.1¬±0.02ms     2.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.5¬±0.00ms     4.7 MB/sec    1.00      3.5¬±0.01ms     4.7 MB/sec
linter/all-rules/numpy/globals.py          1.00    365.8¬±1.20¬µs     8.1 MB/sec    1.00    364.4¬±1.00¬µs     8.1 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.3¬±0.02ms     4.1 MB/sec    1.00      6.3¬±0.04ms     4.1 MB/sec
linter/default-rules/large/dataset.py      1.00      7.2¬±0.01ms     5.7 MB/sec    1.00      7.2¬±0.02ms     5.6 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1473.3¬±5.73¬µs    11.3 MB/sec    1.00   1476.4¬±2.90¬µs    11.3 MB/sec
linter/default-rules/numpy/globals.py      1.00    156.7¬±0.22¬µs    18.8 MB/sec    1.00    157.4¬±0.61¬µs    18.7 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.2¬±0.01ms     8.0 MB/sec    1.00      3.2¬±0.01ms     8.0 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      9.4¬±0.06ms     4.3 MB/sec    1.00      9.4¬±0.08ms     4.3 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.1¬±0.03ms     7.8 MB/sec    1.02      2.2¬±0.03ms     7.7 MB/sec
formatter/numpy/globals.py                 1.00    239.3¬±4.40¬µs    12.3 MB/sec    1.02    243.5¬±7.86¬µs    12.1 MB/sec
formatter/pydantic/types.py                1.00      4.6¬±0.05ms     5.5 MB/sec    1.02      4.7¬±0.05ms     5.4 MB/sec
linter/all-rules/large/dataset.py          1.01     15.8¬±0.14ms     2.6 MB/sec    1.00     15.6¬±0.13ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.1¬±0.07ms     4.0 MB/sec    1.00      4.1¬±0.05ms     4.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    498.2¬±6.05¬µs     5.9 MB/sec    1.01    502.3¬±7.88¬µs     5.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.1¬±0.12ms     3.6 MB/sec    1.00      7.1¬±0.05ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.01      8.0¬±0.05ms     5.1 MB/sec    1.00      8.0¬±0.05ms     5.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1698.3¬±16.61¬µs     9.8 MB/sec    1.00  1703.5¬±49.55¬µs     9.8 MB/sec
linter/default-rules/numpy/globals.py      1.00    199.2¬±3.42¬µs    14.8 MB/sec    1.01    200.4¬±3.34¬µs    14.7 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.6¬±0.03ms     7.1 MB/sec    1.00      3.6¬±0.04ms     7.1 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Renamed from "Update implicit optional tests for coverage" to "Consider single element subscript expr for implicit optional" by @dhruvmanila on 2023-07-12 18:19_

---

_Marked ready for review by @dhruvmanila on 2023-07-12 18:19_

---

_@charliermarsh reviewed on 2023-07-12 21:13_

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/ruff/typing.rs`:63 on 2023-07-12 21:13_

I think you can avoid these allocations by just storing the `slice` `Expr` on the enums directly, and then doing this match later, when you actually need to iterate over the members.

---

_@charliermarsh reviewed on 2023-07-12 23:57_

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/ruff/typing.rs`:63 on 2023-07-12 23:57_

Here's a patch of what I'm imagining:

```diff
diff --git a/crates/ruff/src/rules/ruff/typing.rs b/crates/ruff/src/rules/ruff/typing.rs
index f96ea22d8..3ad7d9c9f 100644
--- a/crates/ruff/src/rules/ruff/typing.rs
+++ b/crates/ruff/src/rules/ruff/typing.rs
@@ -1,3 +1,4 @@
+use itertools::Either::{Left, Right};
 use rustpython_parser::ast::{self, Constant, Expr, Operator};
 
 use ruff_python_ast::call_path::CallPath;
@@ -54,10 +55,10 @@ fn is_known_type(call_path: &CallPath, minor_version: u32) -> bool {
 
 /// Returns a vector of all the expressions in a slice. If the slice is not a
 /// tuple, it will be wrapped in a vector.
-fn resolve_slice_value(slice: &Expr) -> Vec<&Expr> {
+fn resolve_slice_value(slice: &Expr) -> impl Iterator<Item = &Expr> {
     match slice {
-        Expr::Tuple(ast::ExprTuple { elts: elements, .. }) => elements.iter().collect(),
-        _ => vec![slice],
+        Expr::Tuple(ast::ExprTuple { elts: elements, .. }) => Left(elements.iter()),
+        _ => Right(std::iter::once(slice)),
     }
 }
 
@@ -77,10 +78,14 @@ enum TypingTarget<'a> {
 
     /// A `typing.Union` type or `|` separated types e.g., `Union[int, str]`
     /// or `int | str`.
-    Union(Vec<&'a Expr>),
+    Union(&'a Expr),
+
+    /// A `typing.Union` type or `|` separated types e.g., `Union[int, str]`
+    /// or `int | str`.
+    Pep604Union(&'a Expr),
 
     /// A `typing.Literal` type e.g., `Literal[1, 2, 3]`.
-    Literal(Vec<&'a Expr>),
+    Literal(&'a Expr),
 
     /// A `typing.Optional` type e.g., `Optional[int]`.
     Optional(&'a Expr),
@@ -110,13 +115,13 @@ impl<'a> TypingTarget<'a> {
                 if semantic.match_typing_expr(value, "Optional") {
                     Some(TypingTarget::Optional(slice.as_ref()))
                 } else if semantic.match_typing_expr(value, "Literal") {
-                    Some(TypingTarget::Literal(resolve_slice_value(slice)))
+                    Some(TypingTarget::Literal(slice))
                 } else if semantic.match_typing_expr(value, "Union") {
-                    Some(TypingTarget::Union(resolve_slice_value(slice)))
+                    Some(TypingTarget::Union(slice))
                 } else if semantic.match_typing_expr(value, "Annotated") {
                     resolve_slice_value(slice.as_ref())
-                        .first()
-                        .map(|&expr| TypingTarget::Annotated(expr))
+                        .next()
+                        .map(|expr| TypingTarget::Annotated(expr))
                 } else {
                     semantic.resolve_call_path(value).map_or(
                         // If we can't resolve the call path, it must be defined
@@ -132,9 +137,7 @@ impl<'a> TypingTarget<'a> {
                     )
                 }
             }
-            Expr::BinOp(..) => Some(TypingTarget::Union(
-                PEP604UnionIterator::new(expr).collect(),
-            )),
+            Expr::BinOp(..) => Some(TypingTarget::Pep604Union(expr)),
             Expr::Constant(ast::ExprConstant {
                 value: Constant::None,
                 ..
@@ -179,7 +182,7 @@ impl<'a> TypingTarget<'a> {
             | TypingTarget::Object
             | TypingTarget::Unknown => true,
             TypingTarget::Known => false,
-            TypingTarget::Literal(elements) => elements.iter().any(|element| {
+            TypingTarget::Literal(element) => resolve_slice_value(element).any(|element| {
                 // Literal can only contain `None`, a literal value, other `Literal`
                 // or an enum value.
                 match TypingTarget::try_from_expr(element, semantic, locator, minor_version) {
@@ -190,12 +193,20 @@ impl<'a> TypingTarget<'a> {
                     _ => false,
                 }
             }),
-            TypingTarget::Union(elements) => elements.iter().any(|element| {
+            TypingTarget::Union(element) => resolve_slice_value(element).any(|element| {
                 TypingTarget::try_from_expr(element, semantic, locator, minor_version)
                     .map_or(true, |new_target| {
                         new_target.contains_none(semantic, locator, minor_version)
                     })
             }),
+            TypingTarget::Pep604Union(element) => {
+                PEP604UnionIterator::new(element).any(|element| {
+                    TypingTarget::try_from_expr(element, semantic, locator, minor_version)
+                        .map_or(true, |new_target| {
+                            new_target.contains_none(semantic, locator, minor_version)
+                        })
+                })
+            }
             TypingTarget::Annotated(element) => {
                 TypingTarget::try_from_expr(element, semantic, locator, minor_version)
                     .map_or(true, |new_target| {
@@ -226,12 +237,20 @@ impl<'a> TypingTarget<'a> {
             | TypingTarget::Object
             | TypingTarget::Known
             | TypingTarget::Unknown => false,
-            TypingTarget::Union(elements) => elements.iter().any(|element| {
+            TypingTarget::Union(element) => resolve_slice_value(element).any(|element| {
                 TypingTarget::try_from_expr(element, semantic, locator, minor_version)
                     .map_or(true, |new_target| {
                         new_target.contains_any(semantic, locator, minor_version)
                     })
             }),
+            TypingTarget::Pep604Union(element) => {
+                PEP604UnionIterator::new(element).any(|element| {
+                    TypingTarget::try_from_expr(element, semantic, locator, minor_version)
+                        .map_or(true, |new_target| {
+                            new_target.contains_any(semantic, locator, minor_version)
+                        })
+                })
+            }
             TypingTarget::Annotated(element) | TypingTarget::Optional(element) => {
                 TypingTarget::try_from_expr(element, semantic, locator, minor_version)
                     .map_or(true, |new_target| {
```

---

_@charliermarsh reviewed on 2023-07-12 23:57_

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/ruff/typing.rs`:63 on 2023-07-12 23:57_

This lets you avoid any allocations üòç 

---

_@dhruvmanila reviewed on 2023-07-13 05:27_

---

_Review comment by @dhruvmanila on `crates/ruff/src/rules/ruff/typing.rs`:63 on 2023-07-13 05:27_

Oh wow! That's neat :)

We could even go further and merge `Union` and `|` separated unions together in the slice resolver but then that would need to an enum as `itertools::Either` is only for 2 sum types. It would be kinda similar to this implementation except that the duplication of `PEP604UnionIterator` call will be avoided at the expense of having an additional type.

I think this separation is ok for now.

---

_Review requested from @charliermarsh by @dhruvmanila on 2023-07-13 06:43_

---

_Review comment by @dhruvmanila on `scripts/pyproject.toml`:22 on 2023-07-13 12:49_

Refactoring the implementation as described [here](https://github.com/astral-sh/ruff/pull/5601#discussion_r1260543950) introduced a subtle bug which this PR is solving but the bug exists in the parent PR. Ideally, the stack should've been in the reverse order such that this PR is based on the `main` branch but I didn't realize this until quite late. Then, the rebase required a lot of effort which didn't seem worthwhile.

So, the simple solution is to disable the check on the parent PR and enable it back again in this PR. Sorry for the confusion!

---

_@dhruvmanila reviewed on 2023-07-13 12:49_

---

_Label `rule` added by @dhruvmanila on 2023-07-13 12:58_

---

_Merged by @dhruvmanila on 2023-07-13 13:10_

---

_Closed by @dhruvmanila on 2023-07-13 13:10_

---

_Branch deleted on 2023-07-13 13:10_

---
