<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Property test improvements - astral-sh/ruff #15358</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Property test improvements</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15358">#15358</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-01-08 20:17
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body">Summary
<ul>
<li>Add a workflow to run property tests on a daily basis (based on <code>daily_fuzz.yaml</code>)</li>
<li>Mark <code>assignable_to_is_reflexive</code> as flaky (related to #14899)</li>
<li>Add new (failing) <code>intersection_assignable_to_both</code> test (also related to #14899)</li>
</ul>
Test Plan
<pre><code>export QUICKCHECK_TESTS=100000
while cargo test --release -p red_knot_python_semantic -- \
  --ignored types::property_tests::stable; do :; done
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-08 20:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-08 20:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-08 20:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-08 20:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-08 20:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-08 20:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>.github/workflows/daily_property_tests.yaml</code>:53 on 2025-01-08 20:19</div>
            <div class="timeline-body"><p>Like the rest of this workflow, this is copied over from <code>daily_fuzz.yaml</code>. It seems like a reasonable idea (how would we notice otherwise?), but I haven&#x27;t actually seen any <em>&quot;Daily parser fuzz failed on â€¦&quot;</em> in the issue tracker. Did the <code>daily_fuzz</code> workflow never run, or is this issue-creation disabled somehow?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>.github/workflows/daily_property_tests.yaml</code>:43 on 2025-01-08 20:20</div>
            <div class="timeline-body"><p>My reading of this comment would suggest that the next line would do a debug build, but the line below appears to do a release build? (I personally don&#x27;t have strong feelings either way, just curious if this comment should be updated to explain why you actually chose a release build.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-01-08 20:22</div>
            <div class="timeline-body"><p>Looks good to me!</p>
<p>I have no idea how to verify that the cron thing actually works, other than to land this and wait and see? (I don&#x27;t even know where to go look tomorrow to see if it ran, assuming it doesn&#x27;t fail and notify us.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-08 20:26</div>
            <div class="timeline-body"><blockquote>
<p>I have no idea how to verify that the cron thing actually works, other than to land this and wait and see?</p>
</blockquote>
<p>The fuzzer tests run daily at 00:00 (UTM?), so I decided to run the property test daily at 12:00, to distribute a bit among timezones, and so I will be awake when they run :smile:</p>
<p>https://crontab.guru/#0_12_<em>_</em>_*</p>
<blockquote>
<p>I don&#x27;t even know where to go look tomorrow to see if it ran</p>
</blockquote>
<p>Here: https://github.com/astral-sh/ruff/actions/workflows/daily_property_tests.yaml</p>
<p>Sample run is here: https://github.com/astral-sh/ruff/actions/runs/12678401447/job/35335911931</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-08 20:35</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>âœ… ecosystem check detected no linter changes.</p>
Linter (preview)
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-08 20:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>.github/workflows/daily_property_tests.yaml</code>:43 on 2025-01-08 20:36</div>
            <div class="timeline-body"><p>Yes, thanks. Should have left this in draft mode until I gathered all the data. I ran two experiments.</p>
<p>Release mode: https://github.com/astral-sh/ruff/actions/runs/12678401447 (build: 1m 53s, five test iterations: 1m 26s)
Debug mode: https://github.com/astral-sh/ruff/actions/runs/12678489298/job/35336173933 (build: 53s, five test iterations: 14 minutes)</p>
<p>The number of tests (5 iterations Ã— 100000 tests / iteration = 0.5 million tests) is not chosen completely arbitrarily. From local tests, this seems to be the right order of magnitude to uncover some bugs that were not detected at one or two orders of magnitude fewer.</p>
<p>So release mode seems like the way to go. Will update that comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-01-08 21:19</div>
            <div class="timeline-body"><p>@sharkdp</p>
<blockquote>
<p>Like the rest of this workflow, this is copied over from <code>daily_fuzz.yaml</code>. It seems like a reasonable idea (how would we notice otherwise?), but I haven&#x27;t actually seen any <em>&quot;Daily parser fuzz failed on â€¦&quot;</em> in the issue tracker. Did the <code>daily_fuzz</code> workflow never run, or is this issue-creation disabled somehow?</p>
</blockquote>
<p>@carljm</p>
<blockquote>
<p>I have no idea how to verify that the cron thing actually works, other than to land this and wait and see? (I don&#x27;t even know where to go look tomorrow to see if it ran, assuming it doesn&#x27;t fail and notify us.)</p>
</blockquote>
<p>The py-fuzzer script found a number of bugs in our parser immediately after the big parser rewrite in early 2024, but to my knowledge, the daily cron job that we set up to fuzz the parser shortly after the parser rewrite has never failed. @dhruvmanila just wrote a really good parser! ðŸ˜ƒ (And also, we haven&#x27;t made any major updates since the big rewrite.)</p>
<p>However, I&#x27;m pretty confident that the issue-creation logic works, because I&#x27;ve used it to great success in multiple other repos. For examples, see:</p>
<ul>
<li>Typeshed:<ul>
<li>Example issue: <a href="https://github.com/python/typeshed/issues/13330">python/typeshed#13330</a></li>
<li>Workflow: https://github.com/python/typeshed/blob/main/.github/workflows/daily.yml</li>
</ul>
</li>
<li>typing_extensions:<ul>
<li>Example issue: <a href="https://github.com/python/typing_extensions/issues/513">python/typing_extensions#513</a></li>
<li>Workflow: https://github.com/python/typing_extensions/blob/main/.github/workflows/third_party.yml</li>
</ul>
</li>
<li>typeshed-stats:<ul>
<li>Example issue: <a href="https://github.com/AlexWaygood/typeshed-stats/issues/255">AlexWaygood/typeshed-stats#255</a></li>
<li>Workflow: https://github.com/AlexWaygood/typeshed-stats/blob/main/.github/workflows/test.yml</li>
</ul>
</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-08 21:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-08 21:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-08 21:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>.github/workflows/daily_property_tests.yaml</code>:70 on 2025-01-08 21:26</div>
            <div class="timeline-body"><p>this should be</p>
<pre><code>              labels: [&quot;bug&quot;, &quot;red-knot&quot;, &quot;testing&quot;],
</code></pre>
<p>(https://github.com/astral-sh/ruff/issues?q=is%3Aissue%20state%3Aopen%20label%3Ared-knot)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>.github/workflows/daily_property_tests.yaml</code>:69 on 2025-01-08 21:28</div>
            <div class="timeline-body"><p>A typeshed contributor recently made a great improvement to the typeshed version of this workflow so that the issue text links directly to the exact run that failed rather than a list of all the runs that have ever happened: <a href="https://github.com/python/typeshed/pull/13210">python/typeshed#13210</a>/files</p>
<p>We could probably make the same improvement to this workflow and <code>daily_fuzz.yaml</code>!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-08 21:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-08 21:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>.github/workflows/daily_property_tests.yaml</code>:70 on 2025-01-08 21:35</div>
            <div class="timeline-body"><p>Thank you: <a href="https://github.com/astral-sh/ruff/pull/15361">astral-sh/ruff#15361</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-08 21:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>.github/workflows/daily_property_tests.yaml</code>:69 on 2025-01-08 21:35</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/15361</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:10:09 UTC
    </footer>
</body>
</html>
