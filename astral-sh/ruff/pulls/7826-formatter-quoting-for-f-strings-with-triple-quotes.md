```yaml
number: 7826
title: Formatter quoting for f-strings with triple quotes
type: pull_request
state: merged
author: konstin
labels: []
assignees: []
merged: true
base: main
head: formatter_f-strings_with_triple_quotes
created_at: 2023-10-05T13:16:14Z
updated_at: 2023-10-11T11:38:58Z
url: https://github.com/astral-sh/ruff/pull/7826
synced_at: 2026-01-12T02:32:41Z
```

# Formatter quoting for f-strings with triple quotes

---

_Pull request opened by @konstin on 2023-10-05 13:16_

**Summary** Quoting of f-strings can change if they are triple quoted and only contain single quotes inside.

Fixes #6841

**Test Plan** New fixtures


---

_Comment by @konstin on 2023-10-05 13:16_

Current dependencies on/for this PR:
* main
  * **PR #7825** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7825" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7826** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7826" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7826?utm_source=stack-comment).

---

_@konstin reviewed on 2023-10-06 09:00_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/string.rs`:65 on 2023-10-06 09:00_

I don't think this logic belongs here (it should be part of normalize), but i'll wait for dhruv's f-string changes first

---

_Marked ready for review by @konstin on 2023-10-06 09:00_

---

_Review requested from @dhruvmanila by @konstin on 2023-10-10 08:52_

---

_Review comment by @dhruvmanila on `crates/ruff_python_formatter/src/expression/string.rs`:55 on 2023-10-10 13:38_

If I understand this correctly, we need to figure out if this f-string is triple-quoted or not. If so, could we use `ruff_python_ast::str::is_triple_quote` here?

---

_Review comment by @dhruvmanila on `crates/ruff_python_formatter/src/expression/string.rs`:59 on 2023-10-10 13:39_

nit:
```suggestion
                        if triple_quoted {
```

---

_Review comment by @dhruvmanila on `crates/ruff_python_formatter/src/expression/string.rs`:60 on 2023-10-10 13:40_

```suggestion
                            string_content.contains(r#"""""#) || string_content.contains("'''")
```

---

_@dhruvmanila approved on 2023-10-10 13:43_

---

_@konstin reviewed on 2023-10-11 11:21_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/string.rs`:55 on 2023-10-11 11:21_

That method only takes a prefix, so i'd need to extract the prefix here, which is surprisingly complex (iterators don't work because we don't want to allocate a new String when collecting)

---

_Merged by @konstin on 2023-10-11 11:30_

---

_Closed by @konstin on 2023-10-11 11:30_

---

_Branch deleted on 2023-10-11 11:30_

---

_Comment by @codspeed-hq[bot] on 2023-10-11 11:38_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/formatter_f-strings_with_triple_quotes)

### Merging #7826 will **improve performances by 4.06%**

<sub>Comparing <code>formatter_f-strings_with_triple_quotes</code> (c5fe59a) with <code>main</code> (a1ee6d2)</sub>



### Summary

`âš¡ 1` improvements
`âœ… 24` untouched benchmarks




### Benchmarks breakdown

|     | Benchmark | `main` | `formatter_f-strings_with_triple_quotes` | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| âš¡ | `linter/default-rules[large/dataset.py]` | 95.4 ms | 91.7 ms | +4.06% |


---
