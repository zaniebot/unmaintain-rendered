<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update lexer snapshots with token flags - astral-sh/ruff #11614</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Update lexer snapshots with token flags</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11614">#11614</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-05-30 08:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR updates the lexer test snapshots to include the <code>TokenFlags</code>.</p>
<h2>Test Plan</h2>
<p>Verify the snapshots.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by @dhruvmanila on 2024-05-30 08:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-05-30 08:31</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/dhruv/lexer-tests">CodSpeed Performance Report</a></h2>
<h3>Merging #11614 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>dhruv/lexer-tests</code> (66953c5) with <code>dhruv/parser-phase-2</code> (d55bfcc)</sub></p>
<h3>Summary</h3>
<p><code>âœ… 30</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-05-30 08:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/snapshots/ruff_python_parser__lexer__tests__empty_fstrings.snap</code>:49 on 2024-05-30 08:31</div>
            <div class="timeline-body"><p>what's the usage of the <code>FStringFlag</code>. Can't we tell that it is an <code>FString</code> by looking at the <code>TokenKind</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-05-30 08:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/snapshots/ruff_python_parser__lexer__tests__empty_fstrings.snap</code>:49 on 2024-05-30 08:34</div>
            <div class="timeline-body"><p>Yeah, good point. Currently, it's only used inside the lexer to call either <code>lex_fstring_start</code> or <code>lex_string</code> method.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-05-30 11:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:597 on 2024-05-30 11:24</div>
            <div class="timeline-body"><p>Set the token flags only if we know that it's <code>FStringEnd</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-05-30 11:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:720 on 2024-05-30 11:24</div>
            <div class="timeline-body"><p>Set the token flags only if we know that it's <code>FStringMiddle</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-05-30 11:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/snapshots/ruff_python_parser__lexer__tests__empty_fstrings.snap</code>:49 on 2024-05-30 11:35</div>
            <div class="timeline-body"><p>I think it's required because we represent regular string with no string kind flag set. And, <code>prefix</code> method would also not be able to differentiate because the flags themselves don't have access to the token kind.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-05-30 11:35</div>
            <div class="timeline-body"><p>(I'll look at the remaining test cases in a separate PR.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dhruvmanila on 2024-05-30 11:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:1905 on 2024-05-30 12:27</div>
            <div class="timeline-body"><p>Nit: At least debug_map etc. mutate the state in place.</p>
<pre><code class="language-suggestion">						if matches!(self.value, TokenValue::None) {
                tuple.field(&amp;self.kind);
            } else {
                tuple.field(&amp;self.value);
            };
						tuple.field(&amp;self.range);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:1906 on 2024-05-30 12:28</div>
            <div class="timeline-body"><p>Nit: Maybe</p>
<pre><code class="language-rust">if !self.flags.is_empty() {
	tuple.field(&amp;self.flags);
}

tuple.finish()
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/snapshots/ruff_python_parser__lexer__tests__empty_fstrings.snap</code>:49 on 2024-05-30 12:31</div>
            <div class="timeline-body"><p>Hmm okay. I would need to check out the code to better understand it. We could move the <code>prefix</code> method to the <code>Token</code>? And could we only keep it for <code>FStringFlags</code>? But it's probably not that important.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-05-30 12:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:1905 on 2024-05-30 15:11</div>
            <div class="timeline-body"><p>Are you suggesting to use <code>debug_map</code>? I want to keep the tuple here to have minimal diff which makes it easier to verify the changes. We can explore other formats as a follow-up.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-05-30 15:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2024-05-30 15:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-05-30 15:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-05-30 15:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-05-30 16:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:1905 on 2024-05-30 16:09</div>
            <div class="timeline-body"><p>Oh no, I'm suggesting to not use <code>let mut tuple = tuple.field</code> because I think it might not be necessary (it's not necessary for <code>debug_map</code>)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:04:31 UTC
    </footer>
</body>
</html>
