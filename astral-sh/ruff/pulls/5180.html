<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Implement pylint import-outside-toplevel rule (C0415) - astral-sh/ruff #5180</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Implement pylint import-outside-toplevel rule (C0415)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5180">#5180</a>
        opened by <a href="https://github.com/ashanbrown">@ashanbrown</a>
        on 2023-06-19 14:17
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/ashanbrown">@ashanbrown</a> on 2023-06-19 14:17</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Implements pylint C0415 (import-outside-toplevel) ‚Äî imports should be at the top level of a file.</p>
<p>The great debate I had on this implementation is whether &quot;top-level&quot; is one word or two (<code>toplevel</code> or <code>top_level</code>).  I opted for 2 because that seemed to be how it is used in the codebase but the rule string itself uses one-word &quot;toplevel.&quot;  ü§∑   I'd be happy to change it as desired.</p>
<p>I suppose this could be auto-fixed by moving the import to the top-level, but it seems likely that the author's intent was to actually import this dynamically, so I view the main point of this rule is to force some sort of explanation, and auto-fixing might be annoying.</p>
<p>For reference, this is what &quot;pylint&quot; reports:</p>
<pre><code>&gt; pylint crates/ruff/resources/test/fixtures/pylint/import_outside_top_level.py
************* Module import_outside_top_level
...
crates/ruff/resources/test/fixtures/pylint/import_outside_top_level.py:4:4: C0415: Import outside toplevel (string) (import-outside-toplevel)
</code></pre>
<p>ruff would now report:</p>
<pre><code>import_outside_top_level.py:4:5: PLC0415 `import` should be used only at the top level of a file
  |
3 | def import_outside_top_level():
4 |     import string # [import-outside-toplevel]
  |     ^^^^^^^^^^^^^ PLC0415
  |
</code></pre>
<p>Contributes to https://github.com/astral-sh/ruff/issues/970.</p>
<h2>Test Plan</h2>
<!-- How was it tested? -->

<p>Snapshot test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Add pylint import-outside-toplevel rule" to "Implement pylint import-outside-toplevel rule (C0415)" by @ashanbrown on 2023-06-19 14:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-06-19 14:37</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>‚ÑπÔ∏è ecosystem check <strong>detected linter changes</strong>. (+10 -0 violations, +0 -0 fixes in 41 projects)</p>
<details><summary><a href="https://github.com/rotki/rotki">rotki/rotki</a> (+10 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/rotki/rotki/blob/a013e976fd650a78aa7786e69eb0e5e6a1e4e859/rotkehlchen/assets/resolver.py#L127'>rotkehlchen/assets/resolver.py:127:9:</a> PLC0415 `import` should be at the top-level of a file
+ <a href='https://github.com/rotki/rotki/blob/a013e976fd650a78aa7786e69eb0e5e6a1e4e859/rotkehlchen/assets/resolver.py#L128'>rotkehlchen/assets/resolver.py:128:9:</a> PLC0415 `import` should be at the top-level of a file
+ <a href='https://github.com/rotki/rotki/blob/a013e976fd650a78aa7786e69eb0e5e6a1e4e859/rotkehlchen/assets/resolver.py#L158'>rotkehlchen/assets/resolver.py:158:9:</a> PLC0415 `import` should be at the top-level of a file
+ <a href='https://github.com/rotki/rotki/blob/a013e976fd650a78aa7786e69eb0e5e6a1e4e859/rotkehlchen/assets/resolver.py#L159'>rotkehlchen/assets/resolver.py:159:9:</a> PLC0415 `import` should be at the top-level of a file
+ <a href='https://github.com/rotki/rotki/blob/a013e976fd650a78aa7786e69eb0e5e6a1e4e859/rotkehlchen/assets/resolver.py#L70'>rotkehlchen/assets/resolver.py:70:9:</a> PLC0415 `import` should be at the top-level of a file
+ <a href='https://github.com/rotki/rotki/blob/a013e976fd650a78aa7786e69eb0e5e6a1e4e859/rotkehlchen/assets/resolver.py#L71'>rotkehlchen/assets/resolver.py:71:9:</a> PLC0415 `import` should be at the top-level of a file
+ <a href='https://github.com/rotki/rotki/blob/a013e976fd650a78aa7786e69eb0e5e6a1e4e859/rotkehlchen/assets/resolver.py#L96'>rotkehlchen/assets/resolver.py:96:9:</a> PLC0415 `import` should be at the top-level of a file
+ <a href='https://github.com/rotki/rotki/blob/a013e976fd650a78aa7786e69eb0e5e6a1e4e859/rotkehlchen/assets/resolver.py#L97'>rotkehlchen/assets/resolver.py:97:9:</a> PLC0415 `import` should be at the top-level of a file
+ <a href='https://github.com/rotki/rotki/blob/a013e976fd650a78aa7786e69eb0e5e6a1e4e859/rotkehlchen/tests/conftest.py#L133'>rotkehlchen/tests/conftest.py:133:9:</a> PLC0415 `import` should be at the top-level of a file
+ <a href='https://github.com/rotki/rotki/blob/a013e976fd650a78aa7786e69eb0e5e6a1e4e859/tools/pyinstaller_hooks/pre_find_module_path/hook-distutils.py#L40'>tools/pyinstaller_hooks/pre_find_module_path/hook-distutils.py:40:5:</a> PLC0415 `import` should be at the top-level of a file
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

</p>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PLC0415 | 10 | 10 | 0 | 0 | 0 |</p>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/pylint/rules/import_outside_top_level.rs</code>:30 on 2023-06-19 16:11</div>
            <div class="timeline-body"><p>Will this rule need special handling to allow typing only imports?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-19 16:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ashanbrown">@ashanbrown</a> reviewed on 2023-06-19 16:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ashanbrown">@ashanbrown</a> on <code>crates/ruff/src/rules/pylint/rules/import_outside_top_level.rs</code>:30 on 2023-06-19 16:51</div>
            <div class="timeline-body"><p>I imagine so.  I'll revert this to draft while I sort this out.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @ashanbrown on 2023-06-19 16:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @ashanbrown on 2023-06-19 19:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ashanbrown">@ashanbrown</a> reviewed on 2023-06-19 19:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ashanbrown">@ashanbrown</a> on <code>crates/ruff/src/rules/pylint/rules/import_outside_top_level.rs</code>:30 on 2023-06-19 19:05</div>
            <div class="timeline-body"><p>@MichaReiser I've excluded anything in a type-checking block.  Ideally, we might be able to detect &quot;top-level type-checking blocks&quot; and treat those differently, but I suspect it isn't that important as type-checking blocks are generally at the top-level.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @MichaReiser on 2023-06-19 20:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-20 03:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/pylint/rules/import_outside_top_level.rs</code>:39 on 2023-06-20 03:07</div>
            <div class="timeline-body"><p>As far as I can tell, Pylint only flags this for imports outside of the module scope:</p>
<pre><code class="language-python">if True:
  import sys  # Pylint doesn't flag this.

def foo():
  import sys  # It does flag this!
</code></pre>
<p>I think this should perhaps be <code>!checker.scope().kind.is_module()</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ashanbrown">@ashanbrown</a> on 2023-06-20 05:28</div>
            <div class="timeline-body"><p>@charliermarsh I've gone with your suggestion of just checking the semantic scope kind.  I had misinterpreted one of the tests from pylint and it does look like they considered nested conditionals to be at the top-level (and that's why pylint needs no special handling for type-checking).</p>
<p>I've also updated the documentation for this check as I don't think <a href="https://peps.python.org/pep-0008/#imports">PEP8</a> completely offers a rationale for this rule.  The <a href="https://github.com/pylint-dev/pylint/pull/3079">pylint PR</a> for this rule also doesn't provide a lot of explanation, so I've done my best to offer a more complete rationale for this check, but I'd welcome suggestions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ashanbrown">@ashanbrown</a> on 2023-06-20 05:45</div>
            <div class="timeline-body"><p>For the record, this is why ChatGPT thinks we should place our imports at the top-level of a module:</p>
<blockquote>
<p>why should I place my imports at the top-level of a module in python?
ChatGPT
In Python, it is generally recommended to place your imports at the top-level of a module. Here are some reasons why this is a good practice:</p>
<p>Readability: Placing imports at the top of your module makes it easier for other developers (including yourself) to understand and navigate your code. When imports are at the top, it provides a clear and concise view of the dependencies required by your module.</p>
<p>Avoiding Confusion: Placing imports at the top-level helps prevent potential conflicts and confusion. It allows you to easily see which external modules or libraries your code relies on, reducing the chances of accidentally redefining or overriding names used in other parts of your code.</p>
<p>Consistency: Placing imports at the top-level is a widely followed convention in the Python community. By adhering to this convention, you make your code more familiar and consistent with other Python projects, which can facilitate collaboration and code maintenance.</p>
<p>Dependency Analysis: When imports are located at the top, it becomes easier to analyze the dependencies of a module. Tools like static analyzers or linters can quickly scan the imports and identify any potential issues or unused imports.</p>
<p>Performance: Import statements at the top-level are executed only once when the module is first imported, and subsequent imports of the same module do not execute those statements again. Placing imports within functions or conditional blocks may lead to repeated imports, which can impact performance.</p>
<p>However, it's worth noting that there are a few exceptions or alternative approaches to consider. For instance, if an import is only needed within a specific function or block of code, it can be placed there to improve the performance of the module as a whole. Additionally, there may be cases where conditional imports are required based on runtime conditions. But as a general guideline, placing imports at the top-level is considered a good practice in Python.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-06-21 05:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @charliermarsh on 2023-06-25 22:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sbrugman">@sbrugman</a> on 2023-07-17 15:06</div>
            <div class="timeline-body"><p>The autofix for this could be https://github.com/astral-sh/ruff/issues/1251</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2023-07-27 13:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @charliermarsh on 2023-10-29 16:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-10-29 16:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-10-29 16:40</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 02:13:13 UTC
    </footer>
</body>
</html>
