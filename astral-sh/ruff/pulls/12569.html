<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pyflakes`] Fix preview-mode bugs in `F401` when attempting to autofix unused first-party submodule imports in an `__init__.py` file - astral-sh/ruff #12569</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pyflakes</code>] Fix preview-mode bugs in <code>F401</code> when attempting to autofix unused first-party submodule imports in an <code>__init__.py</code> file</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/12569">#12569</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-07-29 16:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body">Summary
<p>Fixes #12513.</p>
<p>To summarise, if you have an unused first-party submodule import (e.g. <code>import submodule.a</code>) in an <code>__init__.py</code> file:</p>
<ul>
<li>Without a preexisting <code>__all__</code> definition:<ul>
<li>We used to produce invalid syntax in our autofix: <code>import submodule.a as submodule.a</code>.</li>
<li>We now offer no autofix</li>
</ul>
</li>
<li>With a preexisting <code>__all__</code> definition:<ul>
<li>We used to enter an infinite loop when attempting to provide an autofix</li>
<li>We now don&#x27;t enter an infinite loop, and add <code>&quot;submodule&quot;</code> to <code>__all__</code> in our autofix</li>
</ul>
</li>
</ul>
<p>The error message has also changed slightly if you have an unused import in an <code>__init__.py</code> file that isn&#x27;t a first-party import. This was a side effect of the refactoring, but I think it&#x27;s for the better. For <code>import sys</code> in an <code>__init__.py</code> file:</p>
<ul>
<li>The error message used to be:<blockquote>
<p><code>sys</code> imported but unused; consider removing, adding to <code>__all__</code>, or using a redundant alias</p>
</blockquote>
</li>
<li>It is now:<blockquote>
<p><code>sys</code> imported but unused</p>
</blockquote>
</li>
</ul>
<p>I think that&#x27;s an improvement. If it&#x27;s not a first-party import, there&#x27;s very little chance that the user wants it to be reexported, either by adding it to <code>__all__</code> or by using a redundant alias, so the more concise error message feels like an improvement to me.</p>
Test Plan
<p><code>cargo test -p ruff_linter --lib</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-29 16:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-29 16:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[`pyflakes`] Fix preview-mode infinite loop when attempting to autofix unused first-party submodule import in an `__init__.py` file that has an `__all__` definition&quot; to &quot;[`pyflakes`] Fix preview-mode infinite loop in `F401` when attempting to autofix unused first-party submodule import in an `__init__.py` file that has an `__all__` definition&quot; by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-29 16:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-07-29 16:53</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>‚úÖ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>‚úÖ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/qarmin">@qarmin</a> on 2024-07-29 17:41</div>
            <div class="timeline-body"><p>Will this fix <a href="https://github.com/astral-sh/ruff/issues/12570">astral-sh/ruff#12570</a> ?
Also F401 causes infinite loop, but without <code>__all__</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-29 17:45</div>
            <div class="timeline-body"><blockquote>
<p>Will this fix #12570 ?</p>
</blockquote>
<p>Doesn&#x27;t look like it (not as the PR currently stands, anyway). I can still repro that infinite loop even with this PR branch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-29 17:59</div>
            <div class="timeline-body"><p>I&#x27;m still looking into it, but it looks like <a href="https://github.com/astral-sh/ruff/issues/12570">astral-sh/ruff#12570</a> is a distinct bug from the one this PR is fixing. So we&#x27;ll fix it, but not in this PR üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-07-30 06:26</div>
            <div class="timeline-body"><p>LGTM.</p>
<p>What&#x27;s the reason that you decided not to add sub imports (by adding <code>a</code>) to <code>__ALL__</code>? Is it because that&#x27;s not what sub imports are commonly used for?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-30 10:06</div>
            <div class="timeline-body"><blockquote>
<p>What&#x27;s the reason that you decided not to add sub imports (by adding <code>a</code>) to <code>__ALL__</code>? Is it because that&#x27;s not what sub imports are commonly used for?</p>
</blockquote>
<p>Submodule imports have... odd semantics in Python. Here&#x27;s what happens if I import a regular module: the <code>email</code> module is loaded and assigned to an <code>email</code> symbol in the global namespace:</p>
<pre><code>&gt;&gt;&gt; globals().keys()
dict_keys([&#x27;__name__&#x27;, &#x27;__doc__&#x27;, &#x27;__package__&#x27;, &#x27;__loader__&#x27;, &#x27;__spec__&#x27;, &#x27;__annotations__&#x27;, &#x27;__builtins__&#x27;])
&gt;&gt;&gt; import email
&gt;&gt;&gt; globals().keys()
dict_keys([&#x27;__name__&#x27;, &#x27;__doc__&#x27;, &#x27;__package__&#x27;, &#x27;__loader__&#x27;, &#x27;__spec__&#x27;, &#x27;__annotations__&#x27;, &#x27;__builtins__&#x27;, &#x27;email&#x27;])
&lt;module &#x27;email&#x27; from &#x27;/Users/alexw/.pyenv/versions/3.12.4/lib/python3.12/email/__init__.py&#x27;&gt;
</code></pre>
<p>That&#x27;s <em>not</em> what happens with a submodule import, however:</p>
<pre><code>Python 3.12.4 (main, Jun 12 2024, 09:54:41) [Clang 15.0.0 (clang-1500.3.9.4)] on darwin
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; import email.utils
&gt;&gt;&gt; globals().keys()
dict_keys([&#x27;__name__&#x27;, &#x27;__doc__&#x27;, &#x27;__package__&#x27;, &#x27;__loader__&#x27;, &#x27;__spec__&#x27;, &#x27;__annotations__&#x27;, &#x27;__builtins__&#x27;, &#x27;email&#x27;])
&gt;&gt;&gt; email
&lt;module &#x27;email&#x27; from &#x27;/Users/alexw/.pyenv/versions/3.12.4/lib/python3.12/email/__init__.py&#x27;&gt;
&gt;&gt;&gt; email.utils
&lt;module &#x27;email.utils&#x27; from &#x27;/Users/alexw/.pyenv/versions/3.12.4/lib/python3.12/email/utils.py&#x27;&gt;
</code></pre>
<p>In the REPL snippet above, the <code>import email.utils</code> statement does the following things:</p>
<ol>
<li>Loads the <code>email</code> module</li>
<li>Assigns the <code>email</code> module to an <code>email</code> symbol in the global namespace</li>
<li>Loads the <code>email.utils</code> submodule</li>
<li>Assigns the <code>email.utils</code> submodule as an <code>email</code> attribute on the <code>email</code> module that&#x27;s now in the global namespace.</li>
</ol>
<p><code>__all__</code> is a list of symbols in the global namespace that are publicly exported from a given module. If <code>__all__</code> is validly defined, it should only contain strings which are valid identifiers, and all the identifiers listed in <code>__all__</code> should refer to symbols that exist in the global namespace. Therefore, we shouldn&#x27;t add <code>submodule.a</code> or <code>a</code> to <code>__all__</code>: the first isn&#x27;t a valid identifier, and neither of them refers to a symbol that exists in the global namespace as a result of the statement <code>import submodule.a</code>.</p>
<p>Possibly we <em>could</em> autofix this by adding <code>submodule</code> to <code>__all__</code>, however... possibly that would be better than just removing the import if we know that the <code>import submodule.a</code> statement is a first-party import. @carljm, do you have any opinion here on what the better autofix would be?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-07-30 14:03</div>
            <div class="timeline-body"><p>I might be missing some context here, but if we autofix this:</p>
<pre><code>import mod
__all__ = [&quot;FOO&quot;]
FOO = 42
</code></pre>
<p>to this:</p>
<pre><code>import mod
__all__ = [&quot;FOO&quot;, &quot;mod&quot;]
FOO = 42
</code></pre>
<p>Then I think we should also autofix this:</p>
<pre><code>import mod.sub
__all__ = [&quot;FOO&quot;]
FOO = 42
</code></pre>
<p>to this:</p>
<pre><code>import mod.sub
__all__ = [&quot;FOO&quot;, &quot;mod&quot;]
FOO = 42
</code></pre>
<p>It doesn&#x27;t make sense to me that we would remove <code>import mod.sub</code>, but if its <code>import mod</code> we would add <code>&quot;mod&quot;</code> to <code>__all__</code>. Both <code>import mod</code> and <code>import mod.sub</code> define the symbol <code>mod</code>, and we should handle them consistently; either remove the import as autofix in both cases, or add to <code>__all__</code> in both cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-30 14:07</div>
            <div class="timeline-body"><p>I don&#x27;t think you&#x27;re missing something! I think I just spent too long tracking down the source of the bug, and didn&#x27;t think hard enough about what the correct autofix should be. I&#x27;ll make that change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-31 11:15</div>
            <div class="timeline-body"><p>I found another bug! If you have <code>import submodule.a</code> in an <code>__init__.py</code> file that <em>doesn&#x27;t</em> have an <code>__all__</code> definition, our autofix currently produces invalid syntax:</p>
<pre><code>__init__.py:1:8: F401 [*] `submodule.a` imported but unused; consider removing, adding to `__all__`, or using a redundant alias
  |
1 | import submodule.a
  |        ^^^^^^^^^^^ F401
  |
  = help: Use an explicit re-export: `submodule.a as submodule.a`

‚Ñπ Safe fix
1   |-import submodule.a
  1 |+import submodule.a as submodule.a
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-31 12:28</div>
            <div class="timeline-body"><p>I pushed some updates. They required a bit of refactoring as the code for this rule is quite complex.</p>
<p>To summarise, if you have an unused first-party submodule import (e.g. <code>import submodule.a</code>) in an <code>__init__.py</code> file:</p>
<ul>
<li>Without a preexisting <code>__all__</code> definition:<ul>
<li>We used to produce invalid syntax in our autofix: <code>import submodule.a as submodule.a</code>.</li>
<li>We now offer no autofix</li>
</ul>
</li>
<li>With a preexisting <code>__all__</code> definition:<ul>
<li>We used to enter an infinite loop when attempting to provide an autofix</li>
<li>We now don&#x27;t enter an infinite loop, and add <code>&quot;submodule&quot;</code> to <code>__all__</code> in our autofix</li>
</ul>
</li>
</ul>
<p>The error message has also changed slightly if you have an unused import in an <code>__init__.py</code> file that isn&#x27;t a first-party import. This was a side effect of the refactoring, but I think it&#x27;s for the better. For <code>import sys</code> in an <code>__init__.py</code> file:</p>
<ul>
<li>The error message used to be:<blockquote>
<p><code>sys</code> imported but unused; consider removing, adding to <code>__all__</code>, or using a redundant alias</p>
</blockquote>
</li>
<li>It is now:<blockquote>
<p><code>sys</code> imported but unused</p>
</blockquote>
</li>
</ul>
<p>I think that&#x27;s an improvement. If it&#x27;s not a first-party import, there&#x27;s very little chance that the user wants it to be reexported, either by adding it to <code>__all__</code> or by using a redundant alias, so the more concise error message feels like an improvement to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[`pyflakes`] Fix preview-mode infinite loop in `F401` when attempting to autofix unused first-party submodule import in an `__init__.py` file that has an `__all__` definition&quot; to &quot;[`pyflakes`] Fix preview-mode bugs in `F401` when attempting to autofix unused first-party submodule imports in an `__init__.py` file&quot; by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-31 12:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-31 12:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-31 12:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-07-31 12:34</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:05:33 UTC
    </footer>
</body>
</html>
