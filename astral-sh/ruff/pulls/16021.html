<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] User-level configuration - astral-sh/ruff #16021</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] User-level configuration</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16021">#16021</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-02-07 14:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR adds support for user-level configurations (<code>~/.config/knot/knot.toml</code>) to Red Knot.</p>
<p>Red Knot will watch the user-level configuration file for changes but only if it exists
when the process start. It doesn't watch for new configurations,
mainly to simplify things for now (it would require watching the entire <code>.config</code> directory because the <code>knot</code> subfolder might not exist either).</p>
<p>The new <code>ConfigurationFile</code> struct seems a bit overkill for now but I plan to use it for
hierarchical configurations as well.</p>
<p>Red Knot uses the same strategy as uv and Ruff by using the etcetera crate.</p>
<h2>Test Plan</h2>
<p>Added CLI and file watching test</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MichaReiser on 2025-02-07 14:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MichaReiser on 2025-02-07 14:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @MichaReiser on 2025-02-07 14:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @MichaReiser on 2025-02-07 14:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-07 14:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/main.rs</code>:102 on 2025-02-07 14:36</div>
            <div class="timeline-body"><p>We may want nicer error messages here that use proper diagnostics but I decided to not tackle that for now and continue doing what we do for other errors at this stage.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-07 14:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_project/src/db/changes.rs</code>:51 on 2025-02-07 14:36</div>
            <div class="timeline-body"><p>Whoops</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-07 14:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_project/src/db/changes.rs</code>:152 on 2025-02-07 14:37</div>
            <div class="timeline-body"><p>We may want to use proper diagnostics here so that LSP users get notified about this error but there are other errors in this file where we're using <code>tracing</code> -&gt; A problem for another day</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-07 14:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_project/src/db/changes.rs</code>:220 on 2025-02-07 14:38</div>
            <div class="timeline-body"><p>I got really confused when red knot started parsing my <code>knot.toml</code> file as a python file. For now, I did the simplest fix by copying this condition from <code>Project::discover_files</code>. I have to rework this code next month anyway to properly support file inclusion and exclusions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-07 18:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/tests/utils.rs</code>:6 on 2025-02-07 18:54</div>
            <div class="timeline-body"><p>This is actually not sufficient because cargo runs tests concurrently. So we also need some form of a lock to avoid that multiple tests hold on to the same env variable. Ugh, this is getting out of hand.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-02-08 16:55</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-10 08:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_project/src/metadata.rs</code>:244 on 2025-02-10 08:05</div>
            <div class="timeline-body"><p>Haven't thought about this in detail, but in principle, it could even make sense to add configuration paths that were <em>not</em> existent when we started up, in order to pick them up if they are being created later on. Of course, this would probably be a bit more involved to implement, as we would have to watch for file-creation events in the containing directory etc.; so I'm not sure if it's worth it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-10 08:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_project/src/metadata/configuration_file.rs</code>:20 on 2025-02-10 08:16</div>
            <div class="timeline-body"><p>Minor</p>
<pre><code class="language-suggestion">    /// Returns `None` if the file does not exist or if the concept of user-level configurations
    /// doesn't exist on `system`.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-10 08:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_project/src/metadata/configuration_file.rs</code>:10 on 2025-02-10 08:18</div>
            <div class="timeline-body"><p>This mentions <code>knot.toml</code> explicitly because this struct does not apply to <code>pyproject.toml</code> files?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-10 08:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_project/src/metadata.rs</code>:244 on 2025-02-10 08:26</div>
            <div class="timeline-body"><p>Yeah, I called this out as a simplification in the PR summary:</p>
<blockquote>
<p>Red Knot will watch the user-level configuration file for changes but only if it exists when the process start. It doesn't watch for new configurations,
mainly to simplify things for now (it would require watching the entire .config directory because the knot subfolder might not exist either)</p>
</blockquote>
<p>I think it would be nice to have but doesn't seem a priority right now (and can easily be added later)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-10 08:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_project/src/metadata/configuration_file.rs</code>:10 on 2025-02-10 08:26</div>
            <div class="timeline-body"><p>Yes, we don't pick up <code>pyproject.toml</code> in user directories (unlike ruff, the same as uv) because <code>pyproject.toml</code>s are for projects</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-10 08:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_project/src/metadata.rs</code>:244 on 2025-02-10 08:29</div>
            <div class="timeline-body"><p>Oops, I missed that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-10 08:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_project/src/metadata/configuration_file.rs</code>:39 on 2025-02-10 08:36</div>
            <div class="timeline-body"><p>Unrelated to this PR, but why does the <code>ValueSource::File</code> variant wrap the <code>SystemPathBuf</code> in an <code>Arc</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-10 08:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ruff_db/src/system/os.rs</code>:104 on 2025-02-10 08:48</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        // thread local because overriding the environment variables breaks test isolation
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-10 08:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_project/src/metadata/configuration_file.rs</code>:39 on 2025-02-10 08:52</div>
            <div class="timeline-body"><p>We don't have to, but it saves a bit of memory when deserializing large configurations. Each deserialized value from a toml file gets associated with the same file. We might then merge the configurations from multiple files (which is why we need to track the source on a value-level).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ruff_db/src/system/os.rs</code>:397 on 2025-02-10 08:59</div>
            <div class="timeline-body"><p>This seems unused?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-10 08:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-10 09:05</div>
            <div class="timeline-body"><p>From @sharkdp on discord</p>
<blockquote>
<p>On your micha/user-level-configuration branch, if I run cargo test -p red_knot_python_semantic locally, it fails with</p>
</blockquote>
<pre><code>error[E0432]: unresolved import `ruff_db::system::OsSystem`
    --&gt; crates/red_knot_python_semantic/src/module_resolver/resolver.rs:1274:31
     |
1274 |         use ruff_db::system::{OsSystem, SystemPath};
     |                               ^^^^^^^^
     |                               |
     |                               no `OsSystem` in `system`
     |                               help: a similar name exists in the module: `System`
     |
note: found an item that was configured out
    --&gt; /home/shark/ruff/crates/ruff_db/src/system.rs:8:13
     |
8    | pub use os::OsSystem;
     |             ^^^^^^^^
note: the item is gated behind the `os` feature
    --&gt; /home/shark/ruff/crates/ruff_db/src/system.rs:7:7
     |
7    | #[cfg(feature = &quot;os&quot;)]
     |       ^^^^^^^^^^^^^^
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-10 09:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ruff_db/src/system/os.rs</code>:359 on 2025-02-10 09:08</div>
            <div class="timeline-body"><p>Just to make sure I understand. We can't add something like a <code>#cfg(test)</code>-level <code>set_user_configuration_directory_override(…)</code> function to <code>OsSystem</code>, because we use the same <code>OsSystem</code> from multiple tests (and therefore, multiple threads)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> approved on 2025-02-10 09:09</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-10 09:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/system/os.rs</code>:359 on 2025-02-10 09:13</div>
            <div class="timeline-body"><p>Hmm, no that was just me being dumb... I should do that instead because it fixes the single-thread limitation. It still wont work in CLI tests but that's because those tests spawn a new process</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-10 15:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/system/os.rs</code>:359 on 2025-02-10 15:44</div>
            <div class="timeline-body"><p>This turned out a bit annoying because it is now required to pass around the <code>OsSystem</code> in the <code>file_watching</code> tests but it's way more robust. Thanks for suggesting this. I completely missed that we have an instance where we could store the state on.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-02-10 15:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-02-10 15:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-10 15:44</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:09:50 UTC
    </footer>
</body>
</html>
