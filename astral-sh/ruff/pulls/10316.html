<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-bandit`]: Implement `S610` rule - astral-sh/ruff #10316</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-bandit</code>]: Implement <code>S610</code> rule</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10316">#10316</a>
        opened by <a href="https://github.com/mkniewallner">@mkniewallner</a>
        on 2024-03-09 18:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mkniewallner">@mkniewallner</a></div>
            <div class="timeline-body"><p>Part of https://github.com/astral-sh/ruff/issues/1646.</p>
<h2>Summary</h2>
<p>Implement <code>S610</code> rule from <code>flake8-bandit</code>.</p>
<p>Upstream references:</p>
<ul>
<li>Implementation: https://github.com/PyCQA/bandit/blob/1.7.8/bandit/plugins/django_sql_injection.py#L20-L97</li>
<li>Test cases: https://github.com/PyCQA/bandit/blob/1.7.8/examples/django_sql_injection_extra.py</li>
<li>Test assertion: https://github.com/PyCQA/bandit/blob/1.7.8/tests/functional/test_functional.py#L517-L524</li>
</ul>
<p>The implementation in <code>bandit</code> targets additional arguments (<code>params</code>, <code>order_by</code> and <code>select_params</code>) but doesn't seem to do anything with them in the end, so I did not include them in the implementation.</p>
<p>Note that this rule could be prone to false positives, as ideally we would want to check if <code>extra()</code> is tied to a <a href="https://docs.djangoproject.com/en/5.0/ref/models/querysets/">Django queryset</a>, but AFAIK Ruff is not able to resolve classes outside of the current module.</p>
<h2>Test Plan</h2>
<p>Snapshot tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/mkniewallner">@mkniewallner</a> on <code>crates/ruff_linter/src/rules/flake8_bandit/rules/django_extra.rs</code>:40 on 2024-03-09 18:19</div>
            <div class="timeline-body"><p>This is also done for <a href="https://github.com/astral-sh/ruff/blob/0c84fbb6db646550e00eed5560a692f2ea1b6224/crates/ruff_linter/src/rules/flake8_bandit/rules/django_raw_sql.rs#L39-L41">django_raw_sql</a>, but I'm wondering if this should also be done for this rule.</p>
<p>In <code>django_raw_sql</code>, <code>RawSQL</code> import comes from <code>django</code> module, so this is reliable, but in our case, <code>extra</code> can be used even if no <code>django</code> imports occurs, if for instance a model defined in another file in a codebase is used, so this could skip the check for several valid cases.</p>
<p>On the other hand, the entire rule has the potential of having several false positives, so this could be seen as a way to know if a file belongs to a project using Django. But if I'm not mistaken, <code>seen_module</code> only applies to the current file, not the whole codebase, and in this specific case the latter would probably be preferable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-03-09 18:39</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+22 -0 violations, +0 -0 fixes in 1 projects; 42 projects unchanged)</p>
<details><summary><a href="https://github.com/zulip/zulip">zulip/zulip</a> (+22 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/zulip/zulip/blob/3a0621fb66a1805dacb267fff5c9c75773a9d985/zerver/actions/message_flags.py#L108'>zerver/actions/message_flags.py:108:19:</a> S610 Use of Django `extra` can lead to SQL injection vulnerabilities
+ <a href='https://github.com/zulip/zulip/blob/3a0621fb66a1805dacb267fff5c9c75773a9d985/zerver/actions/message_flags.py#L160'>zerver/actions/message_flags.py:160:19:</a> S610 Use of Django `extra` can lead to SQL injection vulnerabilities
+ <a href='https://github.com/zulip/zulip/blob/3a0621fb66a1805dacb267fff5c9c75773a9d985/zerver/actions/message_flags.py#L232'>zerver/actions/message_flags.py:232:15:</a> S610 Use of Django `extra` can lead to SQL injection vulnerabilities
+ <a href='https://github.com/zulip/zulip/blob/3a0621fb66a1805dacb267fff5c9c75773a9d985/zerver/actions/message_flags.py#L42'>zerver/actions/message_flags.py:42:15:</a> S610 Use of Django `extra` can lead to SQL injection vulnerabilities
+ <a href='https://github.com/zulip/zulip/blob/3a0621fb66a1805dacb267fff5c9c75773a9d985/zerver/actions/message_flags.py#L56'>zerver/actions/message_flags.py:56:23:</a> S610 Use of Django `extra` can lead to SQL injection vulnerabilities
+ <a href='https://github.com/zulip/zulip/blob/3a0621fb66a1805dacb267fff5c9c75773a9d985/zerver/lib/message.py#L536'>zerver/lib/message.py:536:15:</a> S610 Use of Django `extra` can lead to SQL injection vulnerabilities
+ <a href='https://github.com/zulip/zulip/blob/3a0621fb66a1805dacb267fff5c9c75773a9d985/zerver/lib/message.py#L576'>zerver/lib/message.py:576:36:</a> S610 Use of Django `extra` can lead to SQL injection vulnerabilities
+ <a href='https://github.com/zulip/zulip/blob/3a0621fb66a1805dacb267fff5c9c75773a9d985/zerver/lib/push_notifications.py#L1076'>zerver/lib/push_notifications.py:1076:15:</a> S610 Use of Django `extra` can lead to SQL injection vulnerabilities
+ <a href='https://github.com/zulip/zulip/blob/3a0621fb66a1805dacb267fff5c9c75773a9d985/zerver/lib/query_helpers.py#L26'>zerver/lib/query_helpers.py:26:24:</a> S610 Use of Django `extra` can lead to SQL injection vulnerabilities
+ <a href='https://github.com/zulip/zulip/blob/3a0621fb66a1805dacb267fff5c9c75773a9d985/zerver/lib/users.py#L200'>zerver/lib/users.py:200:89:</a> S610 Use of Django `extra` can lead to SQL injection vulnerabilities
+ <a href='https://github.com/zulip/zulip/blob/3a0621fb66a1805dacb267fff5c9c75773a9d985/zerver/models/streams.py#L265'>zerver/models/streams.py:265:47:</a> S610 Use of Django `extra` can lead to SQL injection vulnerabilities
+ <a href='https://github.com/zulip/zulip/blob/3a0621fb66a1805dacb267fff5c9c75773a9d985/zerver/tests/test_message_flags.py#L267'>zerver/tests/test_message_flags.py:267:19:</a> S610 Use of Django `extra` can lead to SQL injection vulnerabilities
+ <a href='https://github.com/zulip/zulip/blob/3a0621fb66a1805dacb267fff5c9c75773a9d985/zerver/tests/test_message_flags.py#L300'>zerver/tests/test_message_flags.py:300:19:</a> S610 Use of Django `extra` can lead to SQL injection vulnerabilities
+ <a href='https://github.com/zulip/zulip/blob/3a0621fb66a1805dacb267fff5c9c75773a9d985/zerver/tests/test_message_flags.py#L577'>zerver/tests/test_message_flags.py:577:19:</a> S610 Use of Django `extra` can lead to SQL injection vulnerabilities
+ <a href='https://github.com/zulip/zulip/blob/3a0621fb66a1805dacb267fff5c9c75773a9d985/zerver/tests/test_message_flags.py#L681'>zerver/tests/test_message_flags.py:681:19:</a> S610 Use of Django `extra` can lead to SQL injection vulnerabilities
+ <a href='https://github.com/zulip/zulip/blob/3a0621fb66a1805dacb267fff5c9c75773a9d985/zerver/tests/test_message_flags.py#L692'>zerver/tests/test_message_flags.py:692:19:</a> S610 Use of Django `extra` can lead to SQL injection vulnerabilities
+ <a href='https://github.com/zulip/zulip/blob/3a0621fb66a1805dacb267fff5c9c75773a9d985/zerver/tests/test_message_move_topic.py#L1505'>zerver/tests/test_message_move_topic.py:1505:19:</a> S610 Use of Django `extra` can lead to SQL injection vulnerabilities
+ <a href='https://github.com/zulip/zulip/blob/3a0621fb66a1805dacb267fff5c9c75773a9d985/zerver/tests/test_message_move_topic.py#L1512'>zerver/tests/test_message_move_topic.py:1512:19:</a> S610 Use of Django `extra` can lead to SQL injection vulnerabilities
+ <a href='https://github.com/zulip/zulip/blob/3a0621fb66a1805dacb267fff5c9c75773a9d985/zerver/tests/test_message_move_topic.py#L1577'>zerver/tests/test_message_move_topic.py:1577:19:</a> S610 Use of Django `extra` can lead to SQL injection vulnerabilities
+ <a href='https://github.com/zulip/zulip/blob/3a0621fb66a1805dacb267fff5c9c75773a9d985/zerver/tests/test_message_move_topic.py#L1584'>zerver/tests/test_message_move_topic.py:1584:19:</a> S610 Use of Django `extra` can lead to SQL injection vulnerabilities
+ <a href='https://github.com/zulip/zulip/blob/3a0621fb66a1805dacb267fff5c9c75773a9d985/zerver/views/read_receipts.py#L80'>zerver/views/read_receipts.py:80:15:</a> S610 Use of Django `extra` can lead to SQL injection vulnerabilities
+ <a href='https://github.com/zulip/zulip/blob/3a0621fb66a1805dacb267fff5c9c75773a9d985/zerver/worker/queue_processors.py#L1079'>zerver/worker/queue_processors.py:1079:93:</a> S610 Use of Django `extra` can lead to SQL injection vulnerabilities
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| S610 | 22 | 22 | 0 | 0 | 0 |</p>
</p>
</details>

<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mkniewallner">@mkniewallner</a> reviewed on 2024-03-09 19:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mkniewallner">@mkniewallner</a> reviewed on 2024-03-09 19:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/mkniewallner">@mkniewallner</a> on <code>crates/ruff_linter/src/rules/flake8_bandit/rules/django_extra.rs</code>:40 on 2024-03-09 19:38</div>
            <div class="timeline-body"><p>Case in point, the ecosystem checks detects 18 errors while <code>bandit</code> detects 22. That's because there are 4 things that would have been flagged in https://github.com/zulip/zulip/blob/29ca4ba6620f16598e1171be7495356f56b84328/zerver/tests/test_message_move_topic.py, but are skipped because there is no import from <code>django</code> in this file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mkniewallner">@mkniewallner</a> reviewed on 2024-03-09 19:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/mkniewallner">@mkniewallner</a> on <code>crates/ruff_linter/src/rules/flake8_bandit/rules/django_extra.rs</code>:58 on 2024-03-09 19:40</div>
            <div class="timeline-body"><p><code>flatten()</code> is used to remove optional keys here. Not sure that this is really a clean way to do this, let me know if not.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @mkniewallner on 2024-03-09 19:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @charliermarsh on 2024-03-11 22:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @charliermarsh on 2024-03-11 22:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @charliermarsh on 2024-03-11 22:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-11 22:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/flake8_bandit/rules/django_extra.rs</code>:40 on 2024-03-11 22:33</div>
            <div class="timeline-body"><p>I think I'm okay with leaving this in for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-11 22:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/flake8_bandit/rules/django_extra.rs</code>:40 on 2024-03-11 22:33</div>
            <div class="timeline-body"><p>I could go either way though. <code>extra</code> isn't a common method name.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mkniewallner">@mkniewallner</a> reviewed on 2024-03-11 22:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/mkniewallner">@mkniewallner</a> on <code>crates/ruff_linter/src/rules/flake8_bandit/rules/django_extra.rs</code>:40 on 2024-03-11 22:38</div>
            <div class="timeline-body"><p>Yeah, I think that the combination of <code>extra</code> and <code>select</code>/<code>where</code>/<code>tables</code> arguments should not be that common outside of Django. Worst case, for the few times it would get triggered, it's always possible for users to ignore the false positives, while skipping the check entirely if Ruff does not find a <code>django</code> import would leave the user with no clue that the check was not run because of that. So I think it might be best in the end to not check if Django was seen.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/mkniewallner">@mkniewallner</a> on <code>crates/ruff_linter/src/rules/flake8_bandit/rules/django_extra.rs</code>:40 on 2024-03-11 22:48</div>
            <div class="timeline-body"><p>I went ahead and removed the check in https://github.com/astral-sh/ruff/pull/10316/commits/4e881428c95628d03504b2d7ce5001256a2a26bf. Also updated the error message so that in case of false positives, the user at least knows that this is related to Django.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mkniewallner">@mkniewallner</a> reviewed on 2024-03-11 22:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-11 23:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/flake8_bandit/rules/django_extra.rs</code>:58 on 2024-03-11 23:12</div>
            <div class="timeline-body"><p>Do we want to flag on <code>select(**kwargs)</code>? It seems like this wouldn't, but it probably <em>should</em>, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-12 00:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/flake8_bandit/rules/django_extra.rs</code>:58 on 2024-03-12 00:21</div>
            <div class="timeline-body"><p>Nevermind, I misread.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-03-12 00:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-03-12 00:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-12 00:22</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-12 00:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/flake8_bandit/rules/django_extra.rs</code>:58 on 2024-03-12 00:23</div>
            <div class="timeline-body"><p>We might want to consider allowing: <code>select(**{&quot;foo&quot;: &quot;bar&quot;})</code></p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:03:03 UTC
    </footer>
</body>
</html>
