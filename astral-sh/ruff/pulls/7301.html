<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Introduce `IndentWidth` - astral-sh/ruff #7301</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Introduce <code>IndentWidth</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7301">#7301</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-09-12 11:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">Summary
<p>This PR introduces the new configuration <code>IndentWidth</code> that specifies the visual width of a <code>\t</code> character or the number of spaces of an indent when using <code>IndentStyle::Space</code>.
<code>IndentWidth</code> replaces <code>TabWidth</code> and the count on the <code>IndentStyle::Space(count)</code> setting.</p>
<p>The motivation for this change is to reduce the configuration options and align it with Prettier and editor config that both use a single width for the tab width and number of spaces in an indent.</p>
<p>Unifying the two settings makes sense in my view because both <code>\t</code> and the number of spaces in an indentation are about the width of an indentation and they should use consistent values.
The only downside of the change is that we no longer support the configuration used by black&#x27;s <code>docstring</code> test where it uses 4-space indentation but a tab width of 8.</p>
Test Plan
<p><code>cargo test</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-12 11:27</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #7301</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7301"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7301?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-12 11:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/snapshots/black_compatibility@simple_cases__docstring.py.snap</code>:1 on 2023-09-12 11:30</div>
            <div class="timeline-body"><p>This test uses an indentation of 4 spaces and tab width of 8. We can&#x27;t support this anymore but I think that&#x27;s fine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-12 11:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-12 11:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/snapshots/format@tab_width.py.snap</code>:1 on 2023-09-12 11:37</div>
            <div class="timeline-body"><p>These tests were off, probably because we now use best fitting for strings now. I verified manually that they don&#x27;t exceed the line width for the configured indent width.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-12 11:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/tests/snapshots/black_compatibility@simple_cases__docstring.py.snap</code>:1 on 2023-09-12 11:59</div>
            <div class="timeline-body"><p>It seems reasonable though hopefully we&#x27;re not overlooking some valid usage. This is all inferred, right, so there&#x27;s no way to GitHub Code Search to find users that might rely on this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-09-12 12:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-12 12:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/snapshots/black_compatibility@simple_cases__docstring.py.snap</code>:1 on 2023-09-12 12:04</div>
            <div class="timeline-body"><p>Editorconfig doesn&#x27;t support different visual width for tabs and indent. And I think that makes sense. You don&#x27;t need a tab-width setting if you don&#x27;t use tabs.</p>
<p>This particular test case applies only to unformatted code where black assumes a tab size of 8 for tabs in docstrings before normalizing the docstring indentation. This is only a heuristic and I think it probably works best anyway if the space indentation and tab indentation sizes match, because that&#x27;s probably how you aligned your docstring before even if you happened to have mixed tabs and spaces.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:738 on 2023-09-12 15:55</div>
            <div class="timeline-body"><p>Both black and <a href="https://github.com/python/cpython/blob/b303d3ad3e80e1d9b3befe6650f61f38b72179a4/Lib/inspect.py#L884">cpython itself</a> have this hardcoded to 8, e.g.</p>
<pre><code>print(inspect.cleandoc(&#x27;&#x27;&#x27;
def a():
    &quot;&quot;&quot;doc line 1
    doc line 2
\tdoc line 3
    &quot;&quot;&quot;
&#x27;&#x27;&#x27;))
</code></pre>
<p>expands to</p>
<pre><code>def a():
    &quot;&quot;&quot;doc line 1
    doc line 2
        doc line 3
    &quot;&quot;&quot;
</code></pre>
<p>Given that this is a cpython choice, i don&#x27;t think we should have an option to overwrite it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> requested changes on 2023-09-12 15:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-09-12 15:58</div>
            <div class="timeline-body"><p>I like the general improvement, but unfortunately cpython gives us hardcoded precedence about tabs handling in docstrings</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:738 on 2023-09-12 16:09</div>
            <div class="timeline-body"><p>Thanks for bringing this up. I wasn&#x27;t aware of this (although this PR doesn&#x27;t change the configurable nature of tab width).</p>
<p>I think the reason why Black hardcoded this is simply because black doesn&#x27;t support tab indentation and choosing the default tab size used by cpython seems a good choice.</p>
<p>Picking the configured <code>indent-width</code> still seems reasonable to me, except we foresee issues when using <code>indent-style: tab</code> with any <code>tab-width</code> value other than 8. For example, does it mean that the output of <code>inspect.cleancode</code> has incorrect indentation or is it okay for as long as all code uses tabs?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-12 16:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:738 on 2023-09-13 09:36</div>
            <div class="timeline-body"><p>I&#x27;ve tested the semantics:</p>
<pre><code>source = &#x27;&#x27;&#x27;
class A:
\tdef a():
\t\t&quot;&quot;&quot;doc line 1
\t\tdoc line 2
\t\t  doc line 3
\t\t&quot;&quot;&quot;

def a():
\t&quot;&quot;&quot;doc line 1
\tdoc line 2
\t  doc line 3
\t&quot;&quot;&quot;

class A2:
\tdef a():
\t\t&quot;&quot;&quot;doc line 1
\t\t\tdoc line 2
\t\t  doc line 3
\t\t&quot;&quot;&quot;

def a2():
\t&quot;&quot;&quot;doc line 1
\t\tdoc line 2
\t  doc line 3
\t&quot;&quot;&quot;
&#x27;&#x27;&#x27;
exec(source)
docs = [A.a.__doc__, a.__doc__, A2.a.__doc__, a2.__doc__]
for doc in docs:
    print(f&quot;---\n{inspect.cleandoc(doc)}&quot;)
</code></pre>
<p>prints</p>
<pre><code>---
doc line 1
doc line 2
  doc line 3
---
doc line 1
doc line 2
  doc line 3
---
doc line 1
      doc line 2
doc line 3
---
doc line 1
      doc line 2
doc line 3
</code></pre>
<p>I&#x27;ve also checked that</p>
<pre><code>source2 = &#x27;&#x27;&#x27;
def f():
 \tprint()
 \tprint()

def f():
              \t          \t     print()
              \t          \t     print()
&#x27;&#x27;&#x27;
exec(source2)
</code></pre>
<p>passes. Python seems to not care about how you mix tabs and spaces as long as you&#x27;re consistent.</p>
<p>Inside of docstrings, <code>cleandoc</code> doesn&#x27;t mind inconsistent indentation and will just pad to multiples of 8:</p>
<pre><code>source2 = &#x27;&#x27;&#x27;
class A:
\tdef a():
\t\t&quot;&quot;&quot;doc line 1
 \t    \t doc line 2
\t \t  doc line 3
\t\t&quot;&quot;&quot;
&#x27;&#x27;&#x27;
exec(source2)
print(f&quot;---\n{inspect.cleandoc(A.a.__doc__)}&quot;)
</code></pre>
<p>My suggestion would be to special case <code>count_indentation_like_black</code> by hard code padding to 8 and converting to spaces in docstrings.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-13 09:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-13 11:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:738 on 2023-09-13 11:57</div>
            <div class="timeline-body"><p>Thanks for taking a closer look at this. I updated the PR to hardcode 8 for the normalization.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-13 11:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-09-13 12:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-13 12:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-13 12:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-09-13 12:52</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:57:07 UTC
    </footer>
</body>
</html>
