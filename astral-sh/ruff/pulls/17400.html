<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Add object to intersection if positive is empty - astral-sh/ruff #17400</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Add object to intersection if positive is empty</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17400">#17400</a>
        opened by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a>
        on 2025-04-14 23:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>Empty positive can cause some unwanted effects</p>
<h2>Test Plan</h2>
<p>Will have to update some regressions</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-14 23:47</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-14 23:49</div>
            <div class="timeline-body"><p>Okay there are some obvious regressions:</p>
<pre><code class="language-py">def _(x: Not[int]):
    reveal_type(x) # revealed: object &amp; ~int
</code></pre>
<p>And just any intersection with no positive now shows this in the reveal type</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-04-14 23:51</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_INSTRUMENTATION_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/MatthewMckee4%3Afix-empty-intersection-positive">CodSpeed Performance Report</a></h2>
<h3>Merging #17400 will <strong>degrade performances by 9.66%</strong></h3>
<p><sub>Comparing <code>MatthewMckee4:fix-empty-intersection-positive</code> (5ea428b) with <code>main</code> (312a487)</sub></p>
<h3>Summary</h3>
<p><code>❌ 2</code> regressions<br />
<code>✅ 31</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/MatthewMckee4%3Afix-empty-intersection-positive">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ❌ | <code>red_knot_check_file[incremental]</code> | 5.4 ms | 5.7 ms | -5.48% |
| ❌ | <code>red_knot_micro[many_string_assignments]</code> | 97.8 ms | 108.2 ms | -9.66% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-14 23:57</div>
            <div class="timeline-body"><p>I think theres an argument to ignore object in the positive if its the only one there for display.
My thinking is that from
https://typing.python.org/en/latest/spec/concepts.html#union-types
we see:</p>
<pre><code class="language-py">def _(x: object | int):
    reveal_type(x) # revealed: object
</code></pre>
<p>So we could extend this to <code>Intersection</code> like</p>
<pre><code class="language-py">def _(x: Intersection[object, Not[int]]):
    reveal_type(x) # revealed: ~int
</code></pre>
<p>From the typing docs:</p>
<blockquote>
<p>If <code>B</code> is a subtype of <code>A</code>, <code>B | A</code> is equivalent to <code>A</code>.</p>
</blockquote>
<p>For intersection would it make sense to say
If <code>B</code> is a subtype of <code>A</code>, <code>B &amp; A</code> is equivalent to <code>B</code>.</p>
<p>And if so i think it is fair to remove object from intersection display like how we do for union display. There could be more to think about here, like it could depend on the negative, but im not sure</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-04-14 23:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:5324 on 2025-04-14 23:58</div>
            <div class="timeline-body"><p>I think this has caused the codespeed warning</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-04-15 09:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Add object to intersection if positive is empty" to "[red-knot] Add object to intersection if positive is empty" by @MatthewMckee4 on 2025-04-15 12:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:6242 on 2025-04-15 14:34</div>
            <div class="timeline-body"><p>It seems like we shouldn't need this change, if <code>IntersectionBuilder</code> always ensures it already.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-04-15 14:35</div>
            <div class="timeline-body"><p>Ok, this is too much regression indeed. I suspect it comes from just having to look up <code>object</code> in typeshed so often?</p>
<p>Also, I hadn't considered the impact on display of negation types; I agree with you that we don't want to display <code>object</code> in every negation type.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-04-15 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-19 13:59</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:11:35 UTC
    </footer>
</body>
</html>
