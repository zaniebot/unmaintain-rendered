```yaml
number: 3352
title: "Decouple `Diagnostic` from \"all violations\" enumeration"
type: pull_request
state: merged
author: charliermarsh
labels: []
assignees: []
merged: true
base: main
head: charlie/diagnostic-kind
created_at: 2023-03-05T20:35:06Z
updated_at: 2023-03-08T17:51:40Z
url: https://github.com/astral-sh/ruff/pull/3352
synced_at: 2026-01-12T15:55:12Z
```

# Decouple `Diagnostic` from "all violations" enumeration

---

_@charliermarsh_

## Summary

Today, we capture all diagnostics in a `Diagnostic` struct. One of the fields of that struct is of type `DiagnosticKind`, which is a struct generated by the `register_rules!` proc macro, alongside `Rule`. Like `Rule`, `DiagnosticKind` is an enum over all diagnostic variants. The net effect is that every diagnostic depends on every other diagnostic, which makes it difficult for us to break up the rule-implementing modules, since they _all_ rely on one another.

This PR modifies the object hierarchy such that `DiagnosticKind` is no longer an enum over all diagnostics. Instead, it's a dumb struct, like:

```rust
#[derive(Debug, PartialEq, Eq, Serialize, Deserialize)]
pub struct DiagnosticKind {
    /// The identifier of the corresponding [`Rule`].
    pub name: String,
    /// The message body to display to the user, to explain the diagnostic.
    pub body: String,
    /// The message to display to the user, to explain the suggested fix.
    pub commit: Option<String>,
    /// Whether the diagnostic is automatically fixable.
    pub fixable: bool,
}
```

...meaning we can pass it around anywhere, it depends on nothing, etc.

Notably, before, `DiagnosticKind` implemented methods that created `body`, `commit`, etc. Now, they're eagerly evaluated as fields on the struct. Similarly, all of our test fixtures will change, as instead of containing the denormalized `DiagnosticKind`, they now contain the evaluated `DiagnosticKind` with all of its fields. (I've intentionally avoided checking in more than one of these, to make the PR more readable, so tests will fail for now.)

The `Rule` enum is unchanged. Instead of implementing a `.rule()` method on `DiagnosticKind`, we implement `From<&DiagnosticKind> for &'static Rule`, and convert via a stringly-typed match statement that's generated as part of the proc macro. It's not statically enforced, but it _is_ automated. (Perhaps there's a way to enforce it statically? But the whole point is that `DiagnosticKind` can't depend on "all rules", so that may be difficult.)

We may want to consider the object hierarchy more holistically, but the net effect of this PR is that we could in theory start decomposing `ruff` into smaller crates by breaking up this inter-dependency.

In my preliminary testing, the CPython benchmarks are unchanged.

## Test Plan

`cargo test --lib` passes locally, though invalidates _every_ snapshot in roughly the same way -- the objects now look like this:

```diff
+---
+source: crates/ruff/src/rules/flake8_simplify/mod.rs
+assertion_line: 49
+expression: diagnostics
+---
+- kind:
+    body: "Multiple `isinstance` calls for `a`, merge into a single call"
+    fixable: true
+    commit: "Merge `isinstance` calls for `a`"
+    rule: DuplicateIsinstanceCall
+  location:
+    row: 1
+    column: 3
+  end_location:
+    row: 1
+    column: 45
+  fix:
+    content: "isinstance(a, (int, float))"
+    location:
+      row: 1
+      column: 3
+    end_location:
+      row: 1
+      column: 45
+  parent: ~
```


---

_Review requested from @konstin by @charliermarsh on 2023-03-05 20:35_

---

_Review requested from @MichaReiser by @charliermarsh on 2023-03-05 20:35_

---

_@charliermarsh reviewed on 2023-03-05 20:35_

---

_Review comment by @charliermarsh on `crates/ruff/src/registry.rs`:888 on 2023-03-05 20:35_

As an aside, this might be better-named `DiagnosticMeta` now.

---

_@charliermarsh reviewed on 2023-03-05 20:36_

---

_Review comment by @charliermarsh on `crates/ruff/src/registry.rs`:894 on 2023-03-05 20:36_

As an aside, this might be better-named `suggestion` or something. `commit` is bad (I think I came up with it).

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/flake8_annotations/rules.rs`:669 on 2023-03-05 20:36_

We could shorthand this by either (1) implementing more `From` variants (like `impl From<&Diagnostic> for &'static Rule`), or (2) letting `checker.patch` take `Diagnostic`.

---

_@charliermarsh reviewed on 2023-03-05 20:36_

---

_@charliermarsh reviewed on 2023-03-05 20:38_

---

_Review comment by @charliermarsh on `crates/ruff/src/registry.rs`:890 on 2023-03-05 20:38_

I kind of wish there were `&'static str`, but it causes problems with `Deserialize`.

---

_@charliermarsh reviewed on 2023-03-05 20:38_

---

_Review comment by @charliermarsh on `crates/ruff_macros/src/register_rules.rs`:67 on 2023-03-05 20:38_

Goodbye, no longer an enum...

---

_@charliermarsh reviewed on 2023-03-05 20:38_

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/pyupgrade/rules/unnecessary_future_import.rs`:87 on 2023-03-05 20:38_

Very mechanical.

---

_Comment by @charliermarsh on 2023-03-05 21:19_

Confusingly these failing CI checks are running on an older revision?

---

_@konstin approved on 2023-03-06 10:06_

Can't say too much about the proc macro code, but otherwise looks good

---

_@charliermarsh reviewed on 2023-03-06 13:49_

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/flake8_simplify/snapshots/ruff__rules__flake8_simplify__tests__SIM101_SIM101.py.snap.new`:10 on 2023-03-06 13:49_

I don't know if there's a way for us to avoid denormalizing the rule here. Previously, this would've been a `DuplicateIsinstanceCall` struct with its fields, rather than the materialized message, which is arguably better than what we have here.


---

_@charliermarsh reviewed on 2023-03-06 13:57_

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/flake8_simplify/snapshots/ruff__rules__flake8_simplify__tests__SIM101_SIM101.py.snap.new`:10 on 2023-03-06 13:57_

More succinctly, there isn't a way to go from `DiagnosticKind` back to the originating `Violation` struct. Instead, you can only go from `DiagnosticKind` to `Rule` (which is a singleton object, not something that contains the relevant fields).

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/flake8_annotations/rules.rs`:669 on 2023-03-06 14:00_

@konstin - Do you know of any pattern to make these conversions more streamlined? Or does this look right to you?

---

_@charliermarsh reviewed on 2023-03-06 14:00_

---

_Review comment by @konstin on `crates/ruff/src/rules/flake8_annotations/rules.rs`:669 on 2023-03-07 10:56_

i think `From` is the wrong trait for the kind of trick we want to do. i'd actually go with a `.rule()` on Diagnostic:

```rust
impl Diagnostic {
    pub fn rule(&self) -> &'static Rule {
        (&self.kind).into()
    }
}
```

otherwise this also works `diagnostic.kind.rule()`

```rust
        impl DiagnosticKind {
            pub fn rule(&self) -> &'static Rule {
                match self.rule.as_str() {
                    #from_impls_for_diagnostic_kind
                    _ => unreachable!("invalid rule name: {}", self.rule),
                }
            }
        }
```



---

_@konstin reviewed on 2023-03-07 10:56_

---

_Review comment by @konstin on `crates/ruff/src/rules/pandas_vet/mod.rs`:50 on 2023-03-07 10:58_

is there are reason for the fully qualified notation here?

---

_@konstin reviewed on 2023-03-07 10:58_

---

_@charliermarsh reviewed on 2023-03-07 14:56_

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/flake8_annotations/rules.rs`:669 on 2023-03-07 14:56_

The issue is that we need to keep `Diagnostic` and `DiagnosticKind` separate from `Rule` -- they can't depend on `Rule`, otherwise all diagnostic implementations end up depending on all other implementations.

Specifically, `Rule` will end up being defined in the `ruff` crate, while `Diagnostic` and `DiagnosticKind` will probably be defined in some kind of `ruff_linter_base_types` crate (not the actual name, just an example).

Perhaps we could have an `AsRule` trait that we implement in the `ruff` crate for this conversion?


---

_@charliermarsh reviewed on 2023-03-08 03:07_

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/flake8_annotations/rules.rs`:669 on 2023-03-08 03:07_

Yeah, maybe a trait is the way to go here.

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/flake8_annotations/rules.rs`:669 on 2023-03-08 03:10_

Let me push a variant that uses that approach. It's actually far fewer changes.

---

_@charliermarsh reviewed on 2023-03-08 03:10_

---

_Comment by @charliermarsh on 2023-03-08 04:30_

Ok, went ahead and regenerated the fixtures. As mentioned above, the fixtures now contain the denormalized `DiagnosticKind` data (i.e., the full message, rather than the struct type with its fields).

---

_Review comment by @MichaReiser on `crates/ruff/src/lib_wasm.rs`:217 on 2023-03-08 09:12_

Cloning shouldn't be necessary here (`message` isn't borrowed). You may need to destruct `body` and `commit` in case the borrow checker isn't clever enough to understand that the moves are non-overlapping.

```suggestion
            message: message.kind.body,
            location: message.location,
            end_location: message.end_location,
            fix: message.fix.map(|fix| ExpandedFix {
                content: fix.content,
                message: message.kind.commit,
```

---

_Review comment by @MichaReiser on `crates/ruff/src/registry.rs`:888 on 2023-03-08 09:21_

I'm not sure on the name `DiagnosticMeta` but to me it seems that this struct is an instantiated (or serialized) diagnostic. In java, you would probably call this a `DiagnosticDto` :D 

---

_@MichaReiser approved on 2023-03-08 09:25_

LGTM. At least as far as I can tell. I'm still trying to get my head around how lint rules and diagnostics work. But this should solve our immediate needs.

---

_@charliermarsh reviewed on 2023-03-08 17:46_

---

_Review comment by @charliermarsh on `crates/ruff/src/registry.rs`:888 on 2023-03-08 17:46_

I don't think `DiagnosticMeta` is right either, I almost PR'd that but then I realized it was off too.

---

_Merged by @charliermarsh on 2023-03-08 17:51_

---

_Closed by @charliermarsh on 2023-03-08 17:51_

---

_Branch deleted on 2023-03-08 17:51_

---
