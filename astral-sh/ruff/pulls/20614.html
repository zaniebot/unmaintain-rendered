<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`ruff`] Ability to specify `--range` multiple times. - astral-sh/ruff #20614</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>ruff</code>] Ability to specify <code>--range</code> multiple times.</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20614">#20614</a>
        opened by <a href="https://github.com/cristian64">@cristian64</a>
        on 2025-09-28 21:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/cristian64">@cristian64</a> on 2025-09-28 21:12</div>
            <div class="timeline-body"><p>[<code>ruff</code>] Ability to specify <code>--range</code> multiple times.</p>
<h2>Summary</h2>
<p>Text ranges that overlap (or are adjacent) will be collapsed. This is done after text ranges have been adjusted to their enclosing nodes in the tree. Formatting of each range is then performed starting from the bottom of the file, ensuring that the following range still applies to the lines that the user intended to format.</p>
<p>Implements #12800.</p>
<h2>Test Plan</h2>
<ul>
<li>Pre-existing unit tests ensure no regression or unexpected behavior change in regular executions with a single <code>--range</code> argument.</li>
<li>New unit tests have been added to cover the feature enhancement.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cristian64">@cristian64</a> reviewed on 2025-09-28 21:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/cristian64">@cristian64</a> on <code>crates/ruff/src/commands/format.rs</code>:298 on 2025-09-28 21:14</div>
            <div class="timeline-body"><p>Note for the reviewer: the only change in this block is <code>range</code> -&gt; <code>ranges</code>; hiding whitespace changes in the diff viewer may improve readability of the diff.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-28 21:21</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/commands/format.rs</code>:372 on 2025-09-29 06:57</div>
            <div class="timeline-body"><p>It should be fine to use the same code path for one and multiple ranges. The overhead should be minimal compared to the formatting itself.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2025-09-29 06:59</div>
            <div class="timeline-body"><p>Thank you for looking into this.</p>
<p>Unfortunately, I don't think the way the ranges are collapsed is correct and this, instead, requires deeper integration into <code>format_range</code>.</p>
<p>The issue is that <code>format_range</code> can expand the formatting range. E.g. for:</p>
<pre><code class="language-py">a = (1 + 
	3 + 2)
</code></pre>
<p>A range <code>2:3</code> will be expanded to <code>1:3</code> because Ruff can only format entire statements (or clause headers), not sub-expressions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2025-09-29 06:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cristian64">@cristian64</a> on 2025-09-29 07:12</div>
            <div class="timeline-body"><blockquote>
<p>Thank you for looking into this.</p>
<p>Unfortunately, I don't think the way the ranges are collapsed is correct and this, instead, requires deeper integration into <code>format_range</code>.</p>
<p>The issue is that <code>format_range</code> can expand the formatting range. E.g. for:</p>
<pre><code class="language-python">a = (1 + 
  3 + 2)
</code></pre>
<p>A range <code>2:3</code> will be expanded to <code>1:3</code> because Ruff can only format entire statements (or clause headers), not sub-expressions.</p>
</blockquote>
<p>I'm trying to digest why this would be a problem.</p>
<p>If the user provides ranges that overlap with these expanded ranges (which I think can be considered an edge case), the only drawback would be that Ruff would perform a redundant format operation, but the end result would be correct.</p>
<p>Would you have a more concrete example where things can go wrong? (And would we be happy to document the case and/or file a separate issue for it, while providing a solution for the general case?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-09-29 07:17</div>
            <div class="timeline-body"><blockquote>
<p>Formatting of each range is performed starting from the bottom of the file, ensuring that the following range still applies to the lines that the user intended to format.</p>
</blockquote>
<p>I think the assumption that ranges will not be invalidated because they're format from back to front is no longer correct if a range can be extended forward.</p>
<p>I think the right approach is:</p>
<ul>
<li>Expand every range and collapse overlapping ranges</li>
<li>Find the minimal range that covers all ranges</li>
<li>Expand that minimal range too</li>
<li>Format the minimal range (avoids re-parsing the same file multiple times)</li>
<li>Now replace the text of the expanded (and collapsed) ranges)</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cristian64">@cristian64</a> reviewed on 2025-09-29 07:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/cristian64">@cristian64</a> on <code>crates/ruff/src/commands/format.rs</code>:372 on 2025-09-29 07:17</div>
            <div class="timeline-body"><p>I'm not that familiar with Rust, and the use of <code>mut</code> wasn't too comforting, so I went with the option that produced a smaller diff for the sake of the reviewer.</p>
<p>Happy to collapse the two cases if we are okay with the solution, pending discussion of the other point you raised.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cristian64">@cristian64</a> on 2025-09-29 07:23</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>Formatting of each range is performed starting from the bottom of the file, ensuring that the following range still applies to the lines that the user intended to format.</p>
</blockquote>
<p>I think the assumption that ranges will not be invalidated because they're format from back to front is no longer correct if a range can be extended forward.</p>
</blockquote>
<p>If I understand correctly, the range would be invalidated, but it would sit on top of code that has just been formatted, so the format operation would be no-op, with no other side effect. (At least that was how I reasoned about this.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-09-29 07:28</div>
            <div class="timeline-body"><p>I don't think this assumption is correct because you replace <code>unformatted</code> with the newly formatted content, invalidating any prevoius source range.</p>
<p>What's the reaosnf or updating the unformatted code. Can't we keep using the same unformatted code and simply format different slices (in which case we should avoid reparsing the AST over and over again)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cristian64">@cristian64</a> on 2025-09-29 07:44</div>
            <div class="timeline-body"><blockquote>
<p>I don't think this assumption is correct because you replace <code>unformatted</code> with the newly formatted content, invalidating any prevoius source range.</p>
</blockquote>
<p>They would be invalidated if a range was expanded, but even then that shouldn't be a problem as the invalidated range would now sit on code that has been formatted, and a second format operation is no-op.</p>
<blockquote>
<p>What's the reaosnf or updating the unformatted code. Can't we keep using the same unformatted code and simply format different slices (in which case we should avoid reparsing the AST over and over again)</p>
</blockquote>
<p>The unformatted code needs to be updated due to the potential existence of expanded ranges. I see how performance-wise it'd be better to implement this at a lower level, but it's also less trivial.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-09-29 07:52</div>
            <div class="timeline-body"><blockquote>
<p>They would be invalidated if a range was expanded, but even then that shouldn't be a problem as the invalidated range would now sit on code that has been formatted, and a second format operation is no-op.</p>
</blockquote>
<p>The range could now point between Unicode characters which results in a panic. Or the range now points passed the end of the source file which is an error.</p>
<blockquote>
<p>The unformatted code needs to be updated due to the potential existence of expanded ranges. I see how performance-wise it'd be better to implement this at a lower level, but it's also less trivial.</p>
</blockquote>
<p>That's fair. However, performance is a crucial aspect of our tooling.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cristian64">@cristian64</a> on 2025-09-29 08:01</div>
            <div class="timeline-body"><blockquote>
<p>The range could now point between Unicode characters which results in a panic.</p>
</blockquote>
<p>I thought the numbers in the range were to be treated as unicode units, meaning that this shouldn't be possible.</p>
<blockquote>
<p>Or the range now points passed the end of the source file which is an error.</p>
</blockquote>
<p>This case should not be possible. The range would have been joined with the previous range, or the formatting of the previous range should have hit the error earlier. (Doing it from back to front guarantees correctness.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-09-29 08:29</div>
            <div class="timeline-body"><p>Oh right, you convert from <code>TextRange</code> to <code>FormatRange</code> in each iteration. This might also protect against going past the file end.</p>
<blockquote>
<p>This case should not be possible. The range would have been joined with the previous range, or the formatting of the previous range should have hit the error earlier. (Doing it from back to front guarantees correctness.)</p>
</blockquote>
<p>It's possible on the byte range level but I suspect that <code>to_range</code> protects against going past the file range?</p>
<p>E.g.</p>
<pre><code class="language-py">a = (1 + 
    3 + 2)
b = (x)
</code></pre>
<p>with 2:5 to 2:6 (3) and 2:11 to 2:8</p>
<p>The ranges don't overlap, so they aren't merged. Formatting 2:7 to 2:8 results in</p>
<pre><code>a = 1 + 3 + 2
b = (x)
</code></pre>
<p>The range 2:5 to 2:6 now incorrectly selects the <code>(</code> of <code>b = (x)</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cristian64">@cristian64</a> on 2025-09-29 08:44</div>
            <div class="timeline-body"><p>I think there is a typo in <code>2:11</code> (should be <code>2:7</code>), but I see how it can lead to the formatting of unsolicited code blocks.</p>
<p>Joining of overlapping ranges must indeed be done after ranges have been potentially expanded.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cristian64">@cristian64</a> on 2025-09-29 18:00</div>
            <div class="timeline-body"><p>I've added a unit test to cover the discussed case (which should be failing now). I'll see if I can look into a more robust implementation in the upcoming days.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cristian64">@cristian64</a> on 2025-10-04 10:27</div>
            <div class="timeline-body"><p>I've made some progress on this. The new implementation collapses ranges <em>after</em> they have been expanded. The unit test that was added earlier in the week is now passing, and another unit test with ranges that touch on various statements has been added.</p>
<p>Performance wise there should be room for improvement (avoid copies of the text; avoid parsing more than once), but the deeper in the code the harder it gets.</p>
<p>@MichaReiser How do you feel about this? Would this be good enough for a first iteration? Would you like to take it from here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-04 11:34</div>
            <div class="timeline-body"><blockquote>
<p>@MichaReiser How do you feel about this? Would this be good enough for a first iteration? Would you like to take it from here?</p>
</blockquote>
<p>Nice. I'll try to take a look at this sometime soon but it probably won't be in the next two weeks. I'm stretched extremely thin as we're working towards the ty beta. I'm sorry. Please ping me if I forget to get back to this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/range.rs</code>:146 on 2025-10-30 14:06</div>
            <div class="timeline-body"><p>We should avoid parsing and extracting the comments here. Both are very expensive operations and we only want to perform them exactly one per file</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/range.rs</code>:191 on 2025-10-30 14:10</div>
            <div class="timeline-body"><p>I'm not sure if simply joining here is correct. <code>covering_node</code> handles a few special cases, e.g. only formatting the clause header and <code>slice_range</code> assumes on some of those assumptions too (I think).</p>
<p>So this might be a bit trickier than just joining ranges together but I'd have to take a closer look myself.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/commands/format.rs</code>:372 on 2025-10-30 14:11</div>
            <div class="timeline-body"><p>I'd very much prefer to share as much of the code because we already have very low test coverage for range formatting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-30 14:12</div>
            <div class="timeline-body"><p>Thanks. This looks better but I still don't feel very confident about the change. Have you looked at how prettier implements multi range formatting? Maybe there's something we could learn from them as our approach is very similar.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/cristian64">@cristian64</a> on <code>crates/ruff/src/commands/format.rs</code>:372 on 2025-10-30 18:49</div>
            <div class="timeline-body"><p>I was leaving the removal to the end, to keep the diff a bit easier to read until we would be happy with the rest of the changes. Would you rather like this removed <em>now</em>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/cristian64">@cristian64</a> on <code>crates/ruff_python_formatter/src/range.rs</code>:146 on 2025-10-30 18:52</div>
            <div class="timeline-body"><p>Perhaps I'm unable to see how this can be skipped. It seems the other functions require this context to be provided.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cristian64">@cristian64</a> reviewed on 2025-10-30 18:59</div>
            <div class="timeline-body"></div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:00:12 UTC
    </footer>
</body>
</html>
