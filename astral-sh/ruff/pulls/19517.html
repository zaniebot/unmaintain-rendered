<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Fallback to Unknown if no type is stored for an expression - astral-sh/ruff #19517</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Fallback to Unknown if no type is stored for an expression</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19517">#19517</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2025-07-24 00:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/carljm">@carljm</a> on 2025-07-24 00:03</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>See discussion at https://github.com/astral-sh/ruff/pull/19478/files#r2223870292</p>
<p>Fixes https://github.com/astral-sh/ty/issues/865</p>
<h2>Test Plan</h2>
<p>Added one mdtest for invalid Callable annotation; removed <code>pull-types: skip</code> from that test file.</p>
<p>Co-authored-by: lipefree <a href="mailto:willy.ngo.2000@gmail.com">willy.ngo.2000@gmail.com</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @carljm on 2025-07-24 00:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @carljm on 2025-07-24 00:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @carljm on 2025-07-24 00:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @carljm on 2025-07-24 00:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-24 00:06</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-07-24 00:10</div>
            <div class="timeline-body"><p>I don't know what's up with &quot;CodSpeed Macro Runners&quot; but I don't think it's related to this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> approved on 2025-07-24 01:16</div>
            <div class="timeline-body"><p>:+1: I like this. There are definitely places where we're currently jumping through extra hoops to infer a type for every expression, but we can simplify those as needed moving forward.</p>
<p>This also opens the door for storing separate value form and type form types for each expression, I think? That would in turn let us simplify parts of the call binding machinery.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-07-24 05:09</div>
            <div class="timeline-body"><p>This also resolves https://github.com/astral-sh/ty/issues/865 (I tested this PR locally on the examples mentioned in that issue), it might be useful to add a couple of test cases from that issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-24 05:25</div>
            <div class="timeline-body"><p>I think it's worth a try and we can always come back if it makes tracking down bugs harder</p>
<p>What I would find useful is to add least log a tracing debug message if we take the fallback branch</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-24 06:31</div>
            <div class="timeline-body"><blockquote>
<p>What I would find useful is to add least log a tracing debug message if we take the fallback branch</p>
</blockquote>
<p>I thought about that as well. In https://github.com/astral-sh/ruff/pull/19478/files#r2223870292, I suggested that we might only want to do that in valid code (and in this case, it could even be an error?). Because otherwise, if the <code>Unknown</code> fallback is now our preferred way of dealing with AST nodes inside invalid code, we would see a lot of these tracing messages (in the LSP), e.g. when the user is currently typing a annotation, but it's not yet valid?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-07-24 09:59</div>
            <div class="timeline-body"><p>I agree that some logging for the fallback case might be good, but also that it might be hard to stop that from being very noisy in an IDE context. Even if you only emit the logs when there's valid syntax, there are lots of situations where you might have valid syntax but an invalid type expression when you're halfway through typing an annotation</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-24 10:03</div>
            <div class="timeline-body"><blockquote>
<p>If the Unknown fallback is now our preferred way of dealing with AST nodes inside invalid code, we would see a lot of these tracing messages (in the LSP), e.g. when the user is currently typing a annotation, but it's not yet valid?</p>
</blockquote>
<p>That's a fair concern. I don't think it should impact most users because the LSP only shows info level logs by default.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-07-25 02:03</div>
            <div class="timeline-body"><p>The tracing feels likely to be quite noisy to me, I would rather try without it -- if anyone finds themselves debugging a case like this and the tracing would have helped, we can add it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @carljm on 2025-07-25 02:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-07-25 02:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-25 02:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:58:39 UTC
    </footer>
</body>
</html>
