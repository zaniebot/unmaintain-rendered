<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8_import_conventions`] Avoid false positives for NFKC-normalized `__debug__` import aliases in ICN001 - astral-sh/ruff #19411</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8_import_conventions</code>] Avoid false positives for NFKC-normalized <code>__debug__</code> import aliases in ICN001</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19411">#19411</a>
        opened by <a href="https://github.com/danparizher">@danparizher</a>
        on 2025-07-17 20:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danparizher">@danparizher</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes #19118</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-17 20:18</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_import_conventions/rules/unconventional_import_alias.rs</code>:73 on 2025-07-18 13:18</div>
            <div class="timeline-body"><p>It would be better to do this normalization when loading the settings. We otherwise pay the cost for every import statement</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-18 13:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ntBre on 2025-07-18 13:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @ntBre on 2025-07-18 13:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danparizher">@danparizher</a> reviewed on 2025-07-18 15:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/danparizher">@danparizher</a> on <code>crates/ruff_linter/src/rules/flake8_import_conventions/rules/unconventional_import_alias.rs</code>:73 on 2025-07-18 15:51</div>
            <div class="timeline-body"><p>I'm not sure if I've worked with settings before, how would it be implemented? Via these?</p>
<ul>
<li><code>crates\ruff_workspace\src\options.rs</code></li>
<li><code>crates\ruff_linter\src\rules\flake8_import_conventions\settings.rs</code></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @ntBre on 2025-07-24 13:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_import_conventions/rules/unconventional_import_alias.rs</code>:73 on 2025-07-28 12:46</div>
            <div class="timeline-body"><p>Ideally, we'd validate the settings when loading the configuration. The idea is to rename the <a href="https://github.com/astral-sh/ruff/blob/8c0743df97dc7afa1deab7506b322551f2e392bb/crates/ruff_workspace/src/options.rs#L1653-L1674"><code>into_settings</code></a> method to <code>try_into_settings</code> and change its return type to <code>Result</code>, similar to</p>
<p>https://github.com/astral-sh/ruff/blob/8c0743df97dc7afa1deab7506b322551f2e392bb/crates/ruff_workspace/src/options.rs#L1416-L1428</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-28 12:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-28 19:06</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-28 19:08</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-29 07:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/options.rs</code>:1678 on 2025-07-29 07:19</div>
            <div class="timeline-body"><p>Oh. I don't think we need to use <code>try_into_settings</code> if we only do the normalization here.</p>
<p>What I had in mind is to error if the user provides an alias that normalizes to <code>__debug__</code>. Or are there cases where we use <code>aliases</code> where <code>__debug__</code> should be allowed?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danparizher">@danparizher</a> reviewed on 2025-07-30 15:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/danparizher">@danparizher</a> on <code>crates/ruff_workspace/src/options.rs</code>:1678 on 2025-07-30 15:10</div>
            <div class="timeline-body"><p>I don't think <code>__debug__</code> is ever valid as an alias. Is this the right idea?</p>
<pre><code class="language-rust">let mut normalized_aliases: FxHashMap&lt;String, String&gt; = FxHashMap::default();
for (module, alias) in aliases {
    let normalized_alias = alias.nfkc().collect::&lt;String&gt;();
    if normalized_alias == &quot;__debug__&quot; {
        anyhow::bail!(
            &quot;Invalid alias for module '{module}': alias normalizes to '__debug__', which is not allowed.&quot;
        );
    }
    normalized_aliases.insert(module, normalized_alias);
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-31 06:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/options.rs</code>:1678 on 2025-07-31 06:34</div>
            <div class="timeline-body"><p>Yes, I think that would be the ideal user experience (telling them that the configuration is invalid).</p>
<p>An alternative is to use <code>warn_user_once</code> to log a warning instead (and not adding the alias)</p>
<p>I think either's fine</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @danparizher on 2025-07-31 22:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_import_conventions/rules/unconventional_import_alias.rs</code>:80 on 2025-08-04 07:58</div>
            <div class="timeline-body"><p>Is this check still required, given that we now error in <code>Flake8ImportConventionsOptions</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_import_conventions/mod.rs</code>:231 on 2025-08-04 07:59</div>
            <div class="timeline-body"><p>I don't think it's possible to implement a fix in the linter. We can implement this as a unit test next to <code>Flake8ImportConventionsOptions</code> or as a CLI test (see ruff/tests)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-04 07:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @danparizher on 2025-08-05 16:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-08-06 06:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-08-06 06:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-06 12:36</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:14:21 UTC
    </footer>
</body>
</html>
