<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pygrep_hooks`] Fix `blanket-noqa` panic when last line has noqa with no newline (`PGH004`) - astral-sh/ruff #11108</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pygrep_hooks</code>] Fix <code>blanket-noqa</code> panic when last line has noqa with no newline (<code>PGH004</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11108">#11108</a>
        opened by <a href="https://github.com/augustelalande">@augustelalande</a>
        on 2024-04-23 17:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/augustelalande">@augustelalande</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>Resolves #11102</p>
<p>The error stems from these lines
https://github.com/astral-sh/ruff/blob/f5c7a62aa65decb9e286bd65ba17f1a3bd1f91e6/crates/ruff_linter/src/noqa.rs#L697-L702
I don't really understand the purpose of incrementing the last index, but it makes the resulting range invalid for indexing into <code>contents</code>.</p>
<p>For now I just detect if the index is too high in <code>blanket_noqa</code> and adjust it if necessary.</p>
<h2>Test Plan</h2>
<p>Created fixture from issue example.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-04-23 17:19</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`pygreb_hooks`] Fix `blanket-noqa` panic when last line has noqa with no newline (`PGH004`)" to "[`pygrep_hooks`] Fix `blanket-noqa` panic when last line has noqa with no newline (`PGH004`)" by @AlexWaygood on 2024-04-23 18:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/pygrep_hooks/rules/blanket_noqa.rs</code>:91 on 2024-04-23 19:08</div>
            <div class="timeline-body"><p>This seems like a bug, if the <code>.end()</code> is greater than the contents... Have you looked into how that happens?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-23 19:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-23 19:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/pygrep_hooks/rules/blanket_noqa.rs</code>:91 on 2024-04-23 19:09</div>
            <div class="timeline-body"><p>I see the PR summary, but what happens if we remove it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/augustelalande">@augustelalande</a> reviewed on 2024-04-23 19:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/augustelalande">@augustelalande</a> on <code>crates/ruff_linter/src/rules/pygrep_hooks/rules/blanket_noqa.rs</code>:91 on 2024-04-23 19:44</div>
            <div class="timeline-body"><p>Ya it generates a fixture failure with W292_1.py</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/augustelalande">@augustelalande</a> on <code>crates/ruff_linter/src/rules/pygrep_hooks/rules/blanket_noqa.rs</code>:91 on 2024-04-23 19:45</div>
            <div class="timeline-body"><p>It seems the code mentioned in the PR summary was added by @MichaReiser so maybe he can shed some light.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/augustelalande">@augustelalande</a> reviewed on 2024-04-23 19:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-04-24 07:10</div>
            <div class="timeline-body"><p>Uff, I wrote this code like a year ago. But what I did is uncomment that specific code in the <code>noqa</code> file and run all tests and the following test now fails</p>
<p>https://github.com/astral-sh/ruff/blob/5849a752235f5384bfef733e64dbfc6a01e30be9/crates/ruff_linter/resources/test/fixtures/pycodestyle/W292_1.py#L1-L2</p>
<p>The problem is that we have fixes reported at the very end of the file, and there must be a way to suppress them.</p>
<p>The way the noqa lines are found is by searching by a given offset:</p>
<p>https://github.com/astral-sh/ruff/blob/de46a36bbcdc1df4a56fc486ae5c7bcf2c4bbba0/crates/ruff_linter/src/noqa.rs#L722-L734</p>
<p>If we have two lines, than the <code>previous_line.end() == next_line.start()</code>. That's why the above methods searches the line using <code>directive.end() &lt; offset</code> to avoid that a noqa comment suppresses a violation on the next lines.</p>
<p>I must admit, my &quot;solution&quot; is a hack and it would be nice if we could support end-of-file noqa comments in a better way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/augustelalande">@augustelalande</a> on 2024-04-24 18:08</div>
            <div class="timeline-body"><p>@MichaReiser @charliermarsh I implemented a fix which addresses the issue at its source. Let me know if you like it better.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:707 on 2024-04-25 07:11</div>
            <div class="timeline-body"><p>Nit: I think I would rename this to <code>includes_end</code> to make it clear that the comparison should include the end range.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:746 on 2024-04-25 07:20</div>
            <div class="timeline-body"><p>The search then becomes</p>
<pre><code>self inner.binary_search_by(|directive| {
	if directive.range.end() &lt; offset {
		std::cmp::Ordering::Less
	} else if directive.range.start() &gt;  offset {
		std::cmp::Ordering::Greater
	} 
	// At this point, end &gt;= offset, start &lt;= offset
	else if !directive.includes_end &amp;&amp; directive.range.end() == offset  {
		std::cmp::Ordering::Less // I think or should it be greater?
	} else {
		std::cmp::Ordering::Equal
	}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-04-25 07:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/augustelalande">@augustelalande</a> on 2024-04-25 18:21</div>
            <div class="timeline-body"><p>Done. I don't know what that wasm test failure is about.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-25 18:24</div>
            <div class="timeline-body"><p>I think it's spurious, I'll re-run it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-04-25 18:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-04-25 18:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-04-25 18:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-04-25 19:41</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:03:57 UTC
    </footer>
</body>
</html>
