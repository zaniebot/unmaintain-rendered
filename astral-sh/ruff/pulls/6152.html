<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preserve backslash in raw string literal - astral-sh/ruff #6152</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Preserve backslash in raw string literal</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6152">#6152</a>
        opened by <a href="https://github.com/harupy">@harupy</a>
        on 2023-07-28 14:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harupy">@harupy</a></div>
            <div class="timeline-body">

Summary


<p>Fix #5941</p>
Test Plan


<p>Existing tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-07-28 14:39</div>
            <div class="timeline-body">PR Check Results
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      9.0±0.05ms     4.5 MB/sec    1.00      9.0±0.06ms     4.5 MB/sec
formatter/numpy/ctypeslib.py               1.00   1730.8±7.25µs     9.6 MB/sec    1.00  1726.8±15.26µs     9.6 MB/sec
formatter/numpy/globals.py                 1.00    181.1±0.53µs    16.3 MB/sec    1.00    180.2±0.88µs    16.4 MB/sec
formatter/pydantic/types.py                1.01      3.8±0.01ms     6.7 MB/sec    1.00      3.8±0.02ms     6.7 MB/sec
linter/all-rules/large/dataset.py          1.02     12.0±0.12ms     3.4 MB/sec    1.00     11.8±0.12ms     3.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.0±0.02ms     5.5 MB/sec    1.00      3.0±0.01ms     5.6 MB/sec
linter/all-rules/numpy/globals.py          1.00    325.1±1.64µs     9.1 MB/sec    1.00    326.4±0.92µs     9.0 MB/sec
linter/all-rules/pydantic/types.py         1.03      5.5±0.05ms     4.7 MB/sec    1.00      5.3±0.02ms     4.8 MB/sec
linter/default-rules/large/dataset.py      1.04      6.7±0.03ms     6.0 MB/sec    1.00      6.5±0.03ms     6.3 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.03   1314.0±2.36µs    12.7 MB/sec    1.00   1278.9±2.27µs    13.0 MB/sec
linter/default-rules/numpy/globals.py      1.04    129.8±0.63µs    22.7 MB/sec    1.00    125.2±0.35µs    23.6 MB/sec
linter/default-rules/pydantic/types.py     1.03      2.9±0.01ms     8.8 MB/sec    1.00      2.8±0.01ms     9.1 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     14.0±0.77ms     2.9 MB/sec    1.02     14.3±0.71ms     2.8 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.6±0.14ms     6.3 MB/sec    1.02      2.7±0.11ms     6.2 MB/sec
formatter/numpy/globals.py                 1.00   298.1±16.71µs     9.9 MB/sec    1.00   297.3±17.43µs     9.9 MB/sec
formatter/pydantic/types.py                1.00      5.6±0.24ms     4.5 MB/sec    1.04      5.9±0.28ms     4.3 MB/sec
linter/all-rules/large/dataset.py          1.04     20.1±0.90ms     2.0 MB/sec    1.00     19.2±0.97ms     2.1 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      4.9±0.29ms     3.4 MB/sec    1.00      4.9±0.26ms     3.4 MB/sec
linter/all-rules/numpy/globals.py          1.00   577.0±41.43µs     5.1 MB/sec    1.05   606.8±35.50µs     4.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      8.5±0.55ms     3.0 MB/sec    1.01      8.6±0.47ms     3.0 MB/sec
linter/default-rules/large/dataset.py      1.04     11.0±0.46ms     3.7 MB/sec    1.00     10.6±0.53ms     3.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.03      2.2±0.11ms     7.6 MB/sec    1.00      2.1±0.09ms     7.9 MB/sec
linter/default-rules/numpy/globals.py      1.00   238.4±11.41µs    12.4 MB/sec    1.04   247.2±13.92µs    11.9 MB/sec
linter/default-rules/pydantic/types.py     1.01      4.6±0.17ms     5.6 MB/sec    1.00      4.5±0.26ms     5.6 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:213 on 2023-07-28 16:31</div>
            <div class="timeline-body"><p>Nit: I would implement this as a method on <code>StringPrefix</code> to reduce the complexity here</p>
<pre><code>			prefix.is_raw_string()
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/snapshots/black_compatibility@miscellaneous__string_quotes.py.snap</code>:90 on 2023-07-28 16:33</div>
            <div class="timeline-body"><p>There seems to be a related issue that we don&#x27;t count the <code>&quot;</code> in <code>preferred_quotes</code> for raw strings. Do you want to take a look at this as well, and if so, as part of this PR or do you prefer a second pr?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-07-28 16:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harupy">@harupy</a> reviewed on 2023-07-28 16:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/harupy">@harupy</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:213 on 2023-07-28 16:37</div>
            <div class="timeline-body"><p>Sounds good. I&#x27;ll make the change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/harupy">@harupy</a> on <code>crates/ruff_python_formatter/tests/snapshots/black_compatibility@miscellaneous__string_quotes.py.snap</code>:90 on 2023-07-28 16:45</div>
            <div class="timeline-body"><p>@MichaReiser</p>
<blockquote>
<p>There seems to be a related issue that we don&#x27;t count the &quot; in preferred_quotes for raw strings.</p>
</blockquote>
<p>Can you elaborate on this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harupy">@harupy</a> reviewed on 2023-07-28 16:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/harupy">@harupy</a> on <code>crates/ruff_python_formatter/tests/snapshots/black_compatibility@miscellaneous__string_quotes.py.snap</code>:90 on 2023-07-28 17:21</div>
            <div class="timeline-body"><p>Anyway, I prefer a second PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harupy">@harupy</a> reviewed on 2023-07-28 17:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-07-28 17:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:479 on 2023-07-28 17:30</div>
            <div class="timeline-body"><p>Do we need to move this check to line 490 instead because we need to make sure that quotes are properly escaped. Can you add the following test</p>
<pre><code>r&#x27;It\&#x27;s normalizing \&#x27; and &quot; quotes&#x27;
</code></pre>
<p>This should be formatted as:</p>
<pre><code>r&quot;It&#x27;s normalizing &#x27; and \&quot; quotes&quot;r
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harupy">@harupy</a> reviewed on 2023-07-29 00:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/harupy">@harupy</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:479 on 2023-07-29 00:45</div>
            <div class="timeline-body"><p>@MichaReiser <code>r&#x27;It\&#x27;s normalizing \&#x27; and &quot; quotes&#x27;</code> is not equivalent to <code>r&quot;It&#x27;s normalizing &#x27; and \&quot; quotes&quot;</code>:</p>
<pre><code>&gt;&gt;&gt; r&#x27;It\&#x27;s normalizing \&#x27; and &quot; quotes&#x27;
&#x27;It\\\&#x27;s normalizing \\\&#x27; and &quot; quotes&#x27;
&gt;&gt;&gt; r&quot;It&#x27;s normalizing &#x27; and \&quot; quotes&quot;
&#x27;It\&#x27;s normalizing \&#x27; and \\&quot; quotes&#x27;
&gt;&gt;&gt; r&#x27;It\&#x27;s normalizing \&#x27; and &quot; quotes&#x27; == r&quot;It&#x27;s normalizing &#x27; and \&quot; quotes&quot;
False
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/harupy">@harupy</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:532 on 2023-07-29 02:36</div>
            <div class="timeline-body"><p>Is this the right place to insert <code>is_raw</code>? We can&#x27;t insert or remove <code>/</code> if we&#x27;re normalizing a raw string.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harupy">@harupy</a> reviewed on 2023-07-29 02:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-07-29 07:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:479 on 2023-07-29 07:52</div>
            <div class="timeline-body"><p>Okay, I now played with your PR and found an example that produces invalid syntax:</p>
<pre><code># Input
r&#x27;Not-so-tricky &quot;quote \&#x27;\&#x27;&#x27;

# Ruff
r&quot;Not-so-tricky &quot;quote \&#x27;\&#x27;&quot;

# Black
r&#x27;Not-so-tricky &quot;quote \&#x27;\&#x27;&#x27;
</code></pre>
<p>Note how Ruff changes the quotes from <code>&#x27;</code> to <code>&quot;</code> but fails to escape the <code>&quot;</code>.</p>
<p>We need to play a bit more with black to understand how black determines the preferred quotes for raw strings, and how the normalization has to work. Maybe @konstin knows more, because I&#x27;m not that familiar with Python and I must say, the escaping logic behind raw strings is confusing to me (you have to escape quotes)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/harupy">@harupy</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:479 on 2023-07-29 08:16</div>
            <div class="timeline-body"><p>Thanks for the investigation. I&#x27;m reading black&#x27;s source code. It looks like black returns the original string if it contains unescaped opposite quotes:</p>
<p>https://github.com/psf/black/blob/1a972e3e11b144912155babdf48ff23d68059d57/src/black/strings.py#L201</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harupy">@harupy</a> reviewed on 2023-07-29 08:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-07-31 09:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:479 on 2023-07-31 09:06</div>
            <div class="timeline-body"><p>tbh i find python&#x27;s raw string escaping rules confusing and i think there are cases that are just not properly representable (as the case above where black returns)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:303 on 2023-07-31 10:42</div>
            <div class="timeline-body"><p>Would you mind extending the documentation by explaining when normalizing is possible for raw strings?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-07-31 10:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/konstin">@konstin</a> on 2023-07-31 12:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-31 12:44</div>
            <div class="timeline-body"><p>Thanks for implementing Raw-strings. Something I entirely overlooked.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-07-31 12:47</div>
            <div class="timeline-body"><p>The formatter ecosystem checks are currently failing in CI. You can run the script locally (<code>scripts/formatter_progress.sh</code>). You can also merge main where to get the fix from <a href="https://github.com/astral-sh/ruff/pull/6187">astral-sh/ruff#6187</a> that will print the ecosystem check results in CI also.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-31 12:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-31 12:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-07-31 13:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harupy">@harupy</a> on 2023-07-31 13:02</div>
            <div class="timeline-body"><p>@MichaReiser @konstin Thanks for reviewing this PR :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-07-31 16:29</div>
            <div class="timeline-body"><p>Fixed the end-of-string unescaped quote in <a href="https://github.com/astral-sh/ruff/pull/6202">astral-sh/ruff#6202</a></p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:55:47 UTC
    </footer>
</body>
</html>
