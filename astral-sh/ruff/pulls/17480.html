<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`ruff`] add fix safety section (`RUF017`) - astral-sh/ruff #17480</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>ruff</code>] add fix safety section (<code>RUF017</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17480">#17480</a>
        opened by <a href="https://github.com/VascoSch92">@VascoSch92</a>
        on 2025-04-19 15:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/VascoSch92">@VascoSch92</a></div>
            <div class="timeline-body"><p>The PR add the <code>fix safety</code> section for rule <code>RUF017</code> (#15584 )</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-19 15:12</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`ruff`] add fix safety section (`RUFF017`)" to "[`ruff`] add fix safety section (`RUF017`)" by @VascoSch92 on 2025-04-19 16:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">documentation</span> added by @AlexWaygood on 2025-04-22 19:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @dylwil3 by @dylwil3 on 2025-04-22 19:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-04-26 11:56</div>
            <div class="timeline-body"><p>Thanks for this!</p>
<p>Looking at the implementation for this rule, I notice that it is only emitted when the user explicitly provides the <code>start</code> argument for <code>sum</code> as an empty list (either <code>list()</code> or <code>[]</code>). The expression <code>sum(lists,[])</code> would raise a type error if the iterable <code>lists</code> had any non-list items, and the user has no control over the implementation of <code>__add__</code> or <code>__iadd__</code> for the primitive <code>list</code>.</p>
<p>However, there is a small difference in implementation between <code>__add__</code> and <code>__iadd__</code> for <code>list</code>: the former requires the right summand to be a list, whereas the latter allows for any iterable.</p>
<p>So, unless I'm misunderstanding, I think the only thing the fix could do that would change behavior is turn code that used to raise an exception into code that no longer raises an exception. Namely:</p>
<pre><code class="language-python">import functools
import operator

ranges = [range(2), range(3)]

# raises a TypeError
sum(ranges, []) 

# evaluates to [0, 1, 0, 1, 2]
functools.reduce(operator.iadd, ranges, [])
</code></pre>
<p>So maybe we can reword the fix safety section in light of this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/VascoSch92">@VascoSch92</a> on 2025-04-26 21:20</div>
            <div class="timeline-body"><p>Hey @dylwil3
thanks for the explanation. It is really subtile the case here, and pretty interesting.</p>
<p>Perhaps something on this direction?</p>
<pre><code class="language-text">The fix is always marked as unsafe because `sum` uses the `__add__` magic method while
`operator.iadd` uses the `__iadd__` magic method, and these behaves different on lists, i.e., 
the former requires the right summand to be a list, whereas the latter allows for any iterable. 
Therefore, the fix could inadvertently cause code that previously raised an error to silently 
succeed with different results. Moreover, the fix could remove comments from the original code.
</code></pre>
<p>Another question: what is the politic with deleted comments? Should this be mentioned in the <code>fix safety</code> section? I think yes but not sure.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> approved on 2025-04-28 22:04</div>
            <div class="timeline-body"><p>Thank you! Your wording was good - I added it in with some minor corrections.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dylwil3 on 2025-04-28 22:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dylwil3 on 2025-04-28 22:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-05-01 06:03</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:11:42 UTC
    </footer>
</body>
</html>
