<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`fastapi`] Implement `FAST001` (`fastapi-redundant-response-model`) and `FAST002` (`fastapi-non-annotated-dependency`) - astral-sh/ruff #11579</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>fastapi</code>] Implement <code>FAST001</code> (<code>fastapi-redundant-response-model</code>) and <code>FAST002</code> (<code>fastapi-non-annotated-dependency</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11579">#11579</a>
        opened by <a href="https://github.com/TomerBin">@TomerBin</a>
        on 2024-05-28 07:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/TomerBin">@TomerBin</a></div>
            <div class="timeline-body">

Summary
<p>Implements ruff specific role for fastapi routes, and its autofix.</p>
Test Plan
<p><code>cargo test</code> / <code>cargo insta review</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-05-28 07:34</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>‚úÖ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>‚ÑπÔ∏è ecosystem check <strong>detected linter changes</strong>. (+3 -0 violations, +0 -0 fixes in 1 projects; 49 projects unchanged)</p>
<a href="https://github.com/lnbits/lnbits">lnbits/lnbits</a> (+3 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/lnbits/lnbits/blob/2db5a83f4ed5dd21d99123a0947238f0674270c0/lnbits/core/views/api.py#L66">lnbits/core/views/api.py:66:37:</a> RUF102 FastAPI route with redundant response_model argument
+ <a href="https://github.com/lnbits/lnbits/blob/2db5a83f4ed5dd21d99123a0947238f0674270c0/lnbits/core/views/node_api.py#L79">lnbits/core/views/node_api.py:79:34:</a> RUF102 FastAPI route with redundant response_model argument
+ <a href="https://github.com/lnbits/lnbits/blob/2db5a83f4ed5dd21d99123a0947238f0674270c0/lnbits/core/views/wallet_api.py#L72">lnbits/core/views/wallet_api.py:72:25:</a> RUF102 FastAPI route with redundant response_model argument
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| RUF102 | 3 | 3 | 0 | 0 | 0 |</p>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-05-28 07:40</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/TomerBin:fastapi-redundant-response-model">CodSpeed Performance Report</a>
Merging #11579 will <strong>not alter performance</strong>
<p>Comparing <code>TomerBin:fastapi-redundant-response-model</code> (dd50d3b) with <code>TomerBin:fastapi-redundant-response-model</code> (13df570)</p>
Summary
<p><code>‚úÖ 33</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-04 04:00</div>
            <div class="timeline-body"><p>Thank you for this! Two reactions, which I&#x27;d in-turn like your reaction on:</p>
<ol>
<li>I think we&#x27;ll need to find someone who feels comfortable reviewing these rules for correctness and quality (e.g., is this a recommended pattern?). I&#x27;m not familiar enough with FastAPI to be a good judge here. Perhaps I can ask Sebastian what he thinks of it.</li>
<li>Ideally we&#x27;d implement multiple FastAPI rules before committing to supporting a one-off rule. This helps prevent Ruff from feeling like an unwieldy collection of one-off rules.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TomerBin">@TomerBin</a> on 2024-06-15 11:33</div>
            <div class="timeline-body"><p>@charliermarsh Thanks for your comments.</p>
<ol>
<li>It would be great if Sebastian could confirm that rule. Could you please ask for his opinion?</li>
<li>Another rule I&#x27;m considering is to use the <a href="https://fastapi.tiangolo.com/tutorial/dependencies/#__tabbed_3_4">new Annotated style</a> for dependencies declaration. Other rules I have in mind require complicated type inference and cross-file analysis, so they are probably out of scope for this PR. Do you think multiple rules are mandatory for merging this PR?</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TomerBin">@TomerBin</a> on 2024-07-06 16:48</div>
            <div class="timeline-body"><p>@charliermarsh Any chance you could provide feedback on my previous message when you have a moment?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-10 07:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tiangolo">@tiangolo</a> on 2024-07-15 23:56</div>
            <div class="timeline-body"><p>Thanks @TomerBin for emailing me! This looks great.</p>
<p>And recommending <code>Annotated</code> would be awesome as well.</p>
<p>Additionally, if there was a way to auto-fix code that uses the old style to now use <code>Annotated</code> in Ruff, that would be a dream come true. It applies to dependencies or to <code>Security</code> as well (another type of dependency.</p>
<p>An old dependency and <code>Security</code> param would look like:</p>
<pre><code>@app.get(&quot;/items/&quot;)
def get_items(
    current_user: User = Depends(get_current_user),
    some_security_param: str = Security(get_oauth2_user),
):
    # do stuff
    pass
</code></pre>
<p>That would be ideally transformed into:</p>
<pre><code>@app.get(&quot;/items/&quot;)
def get_items(
    current_user: Annotated[User, Depends(get_current_user)],
    some_security_param: Annotated[str, Security(get_oauth2_user)],
):
    # do stuff
    pass
</code></pre>
<p>Additionally, the same transformation would apply to other types of parameters, like <code>Query</code>, <code>Path</code>, <code>Body</code>, <code>Cookie</code>.</p>
<p>The only caveat is that if one of those has a <code>default</code> argument (or the first argument), as in <code>Query(default=&quot;foo&quot;)</code> then that would become the new default value. For example:</p>
<pre><code>@app.post(&quot;/stuff/&quot;)
def do_stuff(
    some_query_param: str | None = Query(default=None),
    some_path_param: str = Path(),
    some_body_param: str = Body(&quot;foo&quot;),
    some_cookie_param: str = Cookie(),
    some_header_param: int = Header(default=5),
    some_file_param: UploadFile = File(),
    some_form_param: str = Form(),
):
    # do stuff
    pass
</code></pre>
<p>would ideally be transformed into:</p>
<pre><code>@app.post(&quot;/stuff/&quot;)
def do_stuff(
    some_query_param: Annotated[str | None, Query()] = None,
    some_path_param: Annotated[str, Path()],
    some_body_param: Annotated[str, Body()] = &quot;foo&quot;,
    some_cookie_param: Annotated[str, Cookie()],
    some_header_param: Annotated[int, Header()] = 5,
    some_file_param: Annotated[UploadFile, File()],
    some_form_param: Annotated[str, Form()],
):
    # do stuff
    pass
</code></pre>
<hr>
<p><strong>Note</strong>: please keep pinging me on email if I miss a GitHub notification around this, I miss most GitHub notifications as I still have around 10k unread. :sweat_smile:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-16 00:00</div>
            <div class="timeline-body"><p>Thank you @TomerBin and @tiangolo üôè</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[`ruff`] Implement `RUF102` (`fastapi-redundant-response-model`)&quot; to &quot;[`fastapi`] Implement `FAST001` (`fastapi-redundant-response-model`) and `FAST002` (`fastapi-non-annotated-dependency`)&quot; by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-21 18:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-07-21 18:19</div>
            <div class="timeline-body"><p>Thanks. I decided to move these to a dedicated FastAPI category. There&#x27;s precedence for it with NumPy (<code>NPY</code>), and I think I&#x27;d prefer to keep the Ruff rules framework-agnostic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-21 18:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-21 18:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-21 18:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-21 18:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/marcuslimdw">@marcuslimdw</a> on 2024-07-30 04:35</div>
            <div class="timeline-body"><p>@TomerBin, thanks for your work on this!</p>
<p>Is this rule intended to apply only to route functions? I ask because at my company, we have a pretty comprehensive set of free functions that are used as dependency providers, for example:</p>
<p><code>controller.py</code>:</p>
<pre><code>@app.post(&quot;/&quot;)
def route(dependency: Annotated[str, Depends(providers.base_provider)]) -&gt; None:
    ...
</code></pre>
<p><code>providers.py</code>:</p>
<pre><code>def base_provider(sub_provider: Annotated[str, Depends(sub_provder)]) -&gt; str:
    ...

def sub_provider() -&gt; str:
    ...
</code></pre>
<p>Currently, this rule only detects and fixes the route function, and not the provider function in <code>providers.py</code> (which would be pretty nice). As far as I can tell, this wouldn&#x27;t be susceptible to false positives, since FastAPI dependencies are marked with a FastAPI-specific class.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:04:16 UTC
    </footer>
</body>
</html>
