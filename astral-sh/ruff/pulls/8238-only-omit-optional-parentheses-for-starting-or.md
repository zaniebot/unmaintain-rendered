```yaml
number: 8238
title: Only omit optional parentheses for starting or ending with parentheses
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: 10-26-Fix_parenthesizing_of_expression_starting_with_unary_expressions
created_at: 2023-10-26T03:31:16Z
updated_at: 2023-10-26T06:28:59Z
url: https://github.com/astral-sh/ruff/pull/8238
synced_at: 2026-01-12T02:32:42Z
```

# Only omit optional parentheses for starting or ending with parentheses

---

_Pull request opened by @MichaReiser on 2023-10-26 03:31_

## Summary

This PR fixes a black deviation where Ruff omitted parentheses for expressions that don't end with a parenthesized expression
but the "first" node was parenthesized:

```python
def foo():
    while (
        not (aaaaaaaaaaaaaaaaaaaaa(bbbbbbbb, ccccccc)) and dddddddddd < eeeeeeeeeeeeeee
    ):
        pass
```

Ruff ommitted parentheses for this expression because it assumed that the expression starts with `(aaaaa...(bbbb, ccc)` which is parenthesized.
However, this is incorrect. The expression starts with the `not` keyword which isn't a parentheses and Ruff should thus add parentheses. 

 

Closes https://github.com/astral-sh/ruff/issues/8183

## Test Plan

Added tests. 

**PR**
| project        | similarity index  | total files       | changed files     |
|----------------|------------------:|------------------:|------------------:|
| cpython        |           0.75803 |              1799 |              1648 |
| **django**         |           0.99984 |              2772 |                33 | 
| **home-assistant** |           0.99955 |             10596 |               178 |
| poetry         |           0.99891 |               317 |                17 |
| **transformers**   |           0.99967 |              2657 |               328 |
| twine          |           1.00000 |                33 |                 0 |
| typeshed       |           0.99978 |              3669 |                20 |
| warehouse      |           0.99977 |               654 |                13 |
| zulip          |           0.99970 |              1459 |                22 |


**main**

| project        | similarity index  | total files       | changed files     |
|----------------|------------------:|------------------:|------------------:|
| cpython        |           0.75803 |              1799 |              1648 |
| django         |           0.99983 |              2772 |                34 | <- improved
| home-assistant |           0.99953 |             10596 |               186 | <- improved
| poetry         |           0.99891 |               317 |                17 |
| transformers   |           0.99966 |              2657 |               330 | <- improved
| twine          |           1.00000 |                33 |                 0 |
| typeshed       |           0.99978 |              3669 |                20 |
| warehouse      |           0.99977 |               654 |                13 |
| zulip          |           0.99970 |              1459 |                22 |



---

_Comment by @MichaReiser on 2023-10-26 03:31_

Current dependencies on/for this PR:
* main
  * **PR #8238** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8238" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/8238?utm_source=stack-comment).

---

_Label `formatter` added by @MichaReiser on 2023-10-26 03:32_

---

_Review requested from @charliermarsh by @MichaReiser on 2023-10-26 03:37_

---

_Marked ready for review by @MichaReiser on 2023-10-26 03:37_

---

_@charliermarsh reviewed on 2023-10-26 04:00_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/expression/mod.rs`:542 on 2023-10-26 04:00_

I tend to write this as:

```rust
if first_condition {
    return true;
}

if second_condition {
    return true;
}

false
```

But it's extremely personal :joy:

---

_@charliermarsh approved on 2023-10-26 04:02_

Makes sense.

---

_@charliermarsh reviewed on 2023-10-26 04:03_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/expression/mod.rs`:677 on 2023-10-26 04:03_

Is this correct for all unary operators?

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/mod.rs`:677 on 2023-10-26 06:28_

All unary operators come before the operand, so I think yes. Like `+(a, b, c)` doesn't start with a `(` but with `+`

---

_@MichaReiser reviewed on 2023-10-26 06:28_

---

_Renamed from "Fix parenthesizing of expression starting with unary expressions" to "Only omit optional parentheses for starting or ending with parentheses" by @MichaReiser on 2023-10-26 06:28_

---

_Merged by @MichaReiser on 2023-10-26 06:28_

---

_Closed by @MichaReiser on 2023-10-26 06:28_

---

_Branch deleted on 2023-10-26 06:28_

---
