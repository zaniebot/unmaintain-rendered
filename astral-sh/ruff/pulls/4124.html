<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Truncate `SyntaxError`s before newline character - astral-sh/ruff #4124</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Truncate <code>SyntaxError</code>s before newline character</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4124">#4124</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-04-26 21:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><p>Fixes #3520</p>
<p><strong>Before</strong></p>
<pre><code>error: Failed to parse  C:\Users\Micha\Downloads\fix_except0.py:39:14: invalid syntax. Got unexpected token &quot;&quot;&quot;
    try_stmt&lt; 'try' ':' (simple_stmt | suite)
                  cleanup=(except_clause ':' (simple_stmt | suite))+
                  tail=(['except' ':' (simple_stmt | suite)]
                        ['else' ':' (simple_stmt | suite)]
                        ['finally' ':' (simple_stmt | suite)]) &gt;
    &quot;&quot;&quot;
C:\Users\Micha\Downloads\fix_except0.py:39:14: E999 SyntaxError: invalid syntax. Got unexpected token &quot;&quot;&quot;
    try_stmt&lt; 'try' ':' (simple_stmt | suite)
                  cleanup=(except_clause ':' (simple_stmt | suite))+
                  tail=(['except' ':' (simple_stmt | suite)]
                        ['else' ':' (simple_stmt | suite)]
                        ['finally' ':' (simple_stmt | suite)]) &gt;
    &quot;&quot;&quot;
   |
39 |     BM_compatible = True
40 |
41 |     PATTERN  &quot;&quot;&quot;
   |              ^ E999
42 |     try_stmt&lt; 'try' ':' (simple_stmt | suite)
43 |                   cleanup=(except_clause ':' (simple_stmt | suite))+
   |

Found 1 error.
</code></pre>
<p><strong>After</strong></p>
<pre><code>error: Failed to parse C:\Users\Micha\Downloads\fix_except0.py:39:14: unexpected token &quot;&quot;&quot;‚èé...
C:\Users\Micha\Downloads\fix_except0.py:39:14: E999 SyntaxError: unexpected token &quot;&quot;&quot;‚èé...
   |
39 |     BM_compatible = True
40 |
41 |     PATTERN  &quot;&quot;&quot;
   |              ^ E999
42 |     try_stmt&lt; 'try' ':' (simple_stmt | suite)
43 |                   cleanup=(except_clause ':' (simple_stmt | suite))+
   |

Found 1 error.

</code></pre>
<p>I decided to implement this in Ruff rather than RustPython becuse this behaviour must only apply in a context where each error should only span a single line.</p>
<p>Ideally, the parser emit the full range for the token so that we can proberly highlight it in the diagnostic and use the Token text as it appears in the source document (RustPython assumes <code>&quot;</code> even if the source text uses <code>'</code>).</p>
<h2>Alternatives</h2>
<p>An alternative would be to escape newlines. I decided not to escape newlines because it can lead to extremelly long lines in the output.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-04-26 21:47</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #4124</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4124" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  üëà</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4124?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-04-26 21:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/logging.rs</code>:173 on 2023-04-26 21:50</div>
            <div class="timeline-body"><p>I copied this from <code>RustPython</code> but wrapped all <code>tok</code> variables.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-04-26 21:57</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>‚úÖ ecosystem check detected no changes.</p>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @MichaReiser on 2023-05-09 06:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-05-09 15:47</div>
            <div class="timeline-body"><p>Sorry, I looked at this before, but I felt like I was missing the context and got side-tracked. Does this not have the potential to confuse by way of emitting partial error messages? Why truncate at the first newline?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-05-09 16:19</div>
            <div class="timeline-body"><blockquote>
<p>Sorry, I looked at this before, but I felt like I was missing the context and got side-tracked. Does this not have the potential to confuse by way of emitting partial error messages? Why truncate at the first newline?</p>
</blockquote>
<p>It only truncates the token text, not the message itself. I guess, it could be confusing if the unexpected token was a newline, but I think that would already have been confusing today, because Ruff doesn't use special formatting for whitespace.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-09 16:36</div>
            <div class="timeline-body"><p>Sounds reasonable -- go for it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-05-10 06:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-05-10 06:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-05-10 06:37</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:57:10 UTC
    </footer>
</body>
</html>
