```yaml
number: 6894
title: Optional source map generation
type: pull_request
state: merged
author: MichaReiser
labels:
  - performance
  - formatter
assignees: []
merged: true
base: main
head: configurable-source-map-generation
created_at: 2023-08-26T11:54:59Z
updated_at: 2023-08-26T16:00:44Z
url: https://github.com/astral-sh/ruff/pull/6894
synced_at: 2026-01-12T02:45:38Z
```

# Optional source map generation

---

_Pull request opened by @MichaReiser on 2023-08-26 11:54_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This PR makes the formatter's source map generation optional. 

Source mapping informatin is useful to implement range formatting or to move the cursor to the same position in the formatted document. But it comes at the cost of a much larger `Document` (one each at the start and end of every node) and a large source map created by writting source markers in the Printer (one marker at the start and end of every text). 
This PR makes the source map generation option so that we don't pay the overhead when it isn't needed.


## Test Plan

```
cargo test
```

Performance improves locally by about 16%

```
formatter/numpy/globals.py
                        time:   [36.860 Âµs 36.908 Âµs 36.971 Âµs]
                        thrpt:  [79.811 MiB/s 79.946 MiB/s 80.050 MiB/s]
                 change:
                        time:   [-16.602% -16.431% -16.245%] (p = 0.00 < 0.05)
                        thrpt:  [+19.396% +19.662% +19.907%]
                        Performance has improved.
Found 6 outliers among 100 measurements (6.00%)
  4 (4.00%) high mild
  2 (2.00%) high severe
formatter/pydantic/types.py
                        time:   [771.54 Âµs 773.43 Âµs 775.26 Âµs]
                        thrpt:  [32.896 MiB/s 32.974 MiB/s 33.055 MiB/s]
                 change:
                        time:   [-17.740% -17.519% -17.303%] (p = 0.00 < 0.05)
                        thrpt:  [+20.923% +21.240% +21.566%]
                        Performance has improved.
formatter/numpy/ctypeslib.py
                        time:   [408.12 Âµs 408.48 Âµs 408.90 Âµs]
                        thrpt:  [40.722 MiB/s 40.763 MiB/s 40.799 MiB/s]
                 change:
                        time:   [-16.845% -15.595% -14.821%] (p = 0.00 < 0.05)
                        thrpt:  [+17.400% +18.476% +20.257%]
                        Performance has improved.
Found 7 outliers among 100 measurements (7.00%)
  3 (3.00%) high mild
  4 (4.00%) high severe
formatter/large/dataset.py
                        time:   [2.1040 ms 2.1059 ms 2.1084 ms]
                        thrpt:  [19.295 MiB/s 19.318 MiB/s 19.336 MiB/s]
                 change:
                        time:   [-14.956% -14.812% -14.648%] (p = 0.00 < 0.05)
                        thrpt:  [+17.162% +17.387% +17.586%]
                        Performance has improved.
Found 11 outliers among 100 measurements (11.00%)
  6 (6.00%) high mild
  5 (5.00%) high severe

```

---

_Comment by @MichaReiser on 2023-08-26 11:55_

Current dependencies on/for this PR:
* main
  * **PR #6894** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6894" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6894?utm_source=stack-comment).

---

_Renamed from "Make source map generation configurable" to "Make source map generation optional" by @MichaReiser on 2023-08-26 11:56_

---

_Renamed from "Make source map generation optional" to "Optional source map generation" by @MichaReiser on 2023-08-26 11:56_

---

_Label `performance` added by @MichaReiser on 2023-08-26 11:57_

---

_Label `formatter` added by @MichaReiser on 2023-08-26 11:57_

---

_Review requested from @charliermarsh by @MichaReiser on 2023-08-26 11:57_

---

_Comment by @github-actions[bot] on 2023-08-26 12:26_

## PR Check Results
### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.16      4.5Â±0.02ms     9.1 MB/sec    1.00      3.8Â±0.02ms    10.6 MB/sec
formatter/numpy/ctypeslib.py               1.12    882.8Â±2.44Âµs    18.9 MB/sec    1.00    789.3Â±2.16Âµs    21.1 MB/sec
formatter/numpy/globals.py                 1.10     82.7Â±0.35Âµs    35.7 MB/sec    1.00     75.5Â±0.37Âµs    39.1 MB/sec
formatter/pydantic/types.py                1.17   1680.5Â±9.86Âµs    15.2 MB/sec    1.00   1437.5Â±3.35Âµs    17.7 MB/sec
linter/all-rules/large/dataset.py          1.00     10.1Â±0.05ms     4.0 MB/sec    1.00     10.1Â±0.06ms     4.0 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      2.7Â±0.00ms     6.1 MB/sec    1.00      2.7Â±0.00ms     6.1 MB/sec
linter/all-rules/numpy/globals.py          1.01    381.0Â±0.65Âµs     7.7 MB/sec    1.00    378.9Â±1.44Âµs     7.8 MB/sec
linter/all-rules/pydantic/types.py         1.01      5.3Â±0.09ms     4.8 MB/sec    1.00      5.2Â±0.02ms     4.9 MB/sec
linter/default-rules/large/dataset.py      1.00      5.3Â±0.03ms     7.6 MB/sec    1.02      5.4Â±0.05ms     7.5 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1180.2Â±3.65Âµs    14.1 MB/sec    1.01   1190.1Â±4.07Âµs    14.0 MB/sec
linter/default-rules/numpy/globals.py      1.00    136.7Â±0.23Âµs    21.6 MB/sec    1.01    138.7Â±0.23Âµs    21.3 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.4Â±0.02ms    10.6 MB/sec    1.01      2.4Â±0.01ms    10.5 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.22      5.2Â±0.07ms     7.8 MB/sec    1.00      4.3Â±0.06ms     9.5 MB/sec
formatter/numpy/ctypeslib.py               1.18  1010.4Â±25.81Âµs    16.5 MB/sec    1.00   854.0Â±12.90Âµs    19.5 MB/sec
formatter/numpy/globals.py                 1.16     94.1Â±1.57Âµs    31.3 MB/sec    1.00     80.8Â±1.95Âµs    36.5 MB/sec
formatter/pydantic/types.py                1.24  1954.0Â±25.11Âµs    13.1 MB/sec    1.00  1578.0Â±21.39Âµs    16.2 MB/sec
linter/all-rules/large/dataset.py          1.01     12.6Â±0.20ms     3.2 MB/sec    1.00     12.4Â±0.21ms     3.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.4Â±0.06ms     4.8 MB/sec    1.00      3.4Â±0.04ms     4.9 MB/sec
linter/all-rules/numpy/globals.py          1.01    422.3Â±5.60Âµs     7.0 MB/sec    1.00    418.7Â±5.23Âµs     7.0 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.6Â±0.14ms     3.9 MB/sec    1.00      6.6Â±0.11ms     3.9 MB/sec
linter/default-rules/large/dataset.py      1.00      6.9Â±0.08ms     5.9 MB/sec    1.00      6.9Â±0.08ms     5.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1471.5Â±19.77Âµs    11.3 MB/sec    1.00  1474.0Â±15.48Âµs    11.3 MB/sec
linter/default-rules/numpy/globals.py      1.01    170.8Â±4.53Âµs    17.3 MB/sec    1.00    169.4Â±3.10Âµs    17.4 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.1Â±0.04ms     8.3 MB/sec    1.00      3.1Â±0.04ms     8.3 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Comment by @codspeed-hq[bot] on 2023-08-26 14:58_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/configurable-source-map-generation)

### Merging #6894 will **improve performances by 19.02%**

<sub>:warning: No base runs were found</sub>

<sub>Falling back to comparing <code>configurable-source-map-generation</code> (3053c1b) with <code>main</code> (ed1b412)</sub>



### Summary

`ðŸ”¥ 4` improvements
`âœ… 12` untouched benchmarks




### Benchmarks breakdown

|     | Benchmark | `main` | `configurable-source-map-generation` | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ðŸ”¥ | `formatter[numpy/ctypeslib.py]` | 13.9 ms | 12 ms | +16.19% |
| ðŸ”¥ | `formatter[pydantic/types.py]` | 26.3 ms | 22.1 ms | +19.02% |
| ðŸ”¥ | `formatter[numpy/globals.py]` | 1.4 ms | 1.3 ms | +10.53% |
| ðŸ”¥ | `formatter[large/dataset.py]` | 72.7 ms | 61.7 ms | +17.77% |


---

_@charliermarsh approved on 2023-08-26 15:45_

---

_Merged by @MichaReiser on 2023-08-26 16:00_

---

_Closed by @MichaReiser on 2023-08-26 16:00_

---

_Branch deleted on 2023-08-26 16:00_

---
