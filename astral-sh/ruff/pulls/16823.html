<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Improve property test performance by cloning db instead of holding `MutexGuard` - astral-sh/ruff #16823</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Improve property test performance by cloning db instead of holding <code>MutexGuard</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16823">#16823</a>
        opened by <a href="https://github.com/cake-monotone">@cake-monotone</a>
        on 2025-03-18 07:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/cake-monotone">@cake-monotone</a> on 2025-03-18 07:46</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR brings an optimization.</p>
<ul>
<li><code>get_cached_db</code> no longer returns a <code>MutexGuard</code>; instead, it returns a cloned database.</li>
</ul>
<h3><code>get_cached_db</code></h3>
<p>Previously, the <code>MutexGuard</code> was held inside the property test function (defined in the macro), which prevented multiple property tests from running in parallel. More specifically, the program could only test one random test case at a time, which likely caused a significant bottleneck.</p>
<p>On my local machine, running:</p>
<pre><code>QUICKCHECK_TESTS=100000 cargo test --release -p red_knot_python_semantic -- --ignored stable
</code></pre>
<p>showed about <strong>a 75% speedup</strong> (from ~60s to ~15s).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @cake-monotone on 2025-03-18 07:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @cake-monotone on 2025-03-18 07:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @cake-monotone on 2025-03-18 07:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @cake-monotone on 2025-03-18 07:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Make proprety tests faster" to "[red-knot] Improve property test performance by cloning db instead of holding `MutexGuard`" by @cake-monotone on 2025-03-18 07:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-18 07:52</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-03-18 08:09</div>
            <div class="timeline-body"><p>Nice find.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by @MichaReiser on 2025-03-18 08:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @MichaReiser on 2025-03-18 08:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-03-18 08:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-03-18 08:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-03-18 08:19</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:41:04 UTC
    </footer>
</body>
</html>
