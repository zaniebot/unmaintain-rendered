```yaml
number: 6286
title: "Add formatting for `StmtMatch`"
type: pull_request
state: merged
author: dhruvmanila
labels:
  - formatter
assignees: []
merged: true
base: main
head: dhruv/format-match-stmt
created_at: 2023-08-02T20:04:40Z
updated_at: 2023-08-08T13:18:50Z
url: https://github.com/astral-sh/ruff/pull/6286
synced_at: 2026-01-12T02:52:03Z
```

# Add formatting for `StmtMatch`

---

_Pull request opened by @dhruvmanila on 2023-08-02 20:04_

## Summary

This PR adds support for `StmtMatch` with subs for `MatchCase`.

## Test Plan

Add a few additional test cases around `match` statement, comments, line breaks.

resolves: #6298 

---

_Comment by @dhruvmanila on 2023-08-02 20:04_

Current dependencies on/for this PR:
* main
  * **PR #6286** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6286" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #6360** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6360" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6286?utm_source=stack-comment).

---

_Comment by @github-actions[bot] on 2023-08-02 20:30_

## PR Check Results
### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      8.2Â±0.06ms     5.0 MB/sec    1.00      8.2Â±0.06ms     5.0 MB/sec
formatter/numpy/ctypeslib.py               1.00  1625.9Â±46.67Âµs    10.2 MB/sec    1.00   1620.8Â±7.58Âµs    10.3 MB/sec
formatter/numpy/globals.py                 1.00    182.0Â±3.88Âµs    16.2 MB/sec    1.00    182.9Â±0.27Âµs    16.1 MB/sec
formatter/pydantic/types.py                1.00      3.4Â±0.06ms     7.4 MB/sec    1.00      3.5Â±0.04ms     7.4 MB/sec
linter/all-rules/large/dataset.py          1.00     10.1Â±0.05ms     4.0 MB/sec    1.03     10.3Â±0.12ms     3.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      2.7Â±0.01ms     6.2 MB/sec    1.01      2.7Â±0.02ms     6.1 MB/sec
linter/all-rules/numpy/globals.py          1.00    377.9Â±0.90Âµs     7.8 MB/sec    1.00    379.4Â±0.77Âµs     7.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      4.6Â±0.02ms     5.5 MB/sec    1.02      4.7Â±0.04ms     5.4 MB/sec
linter/default-rules/large/dataset.py      1.00      5.3Â±0.01ms     7.7 MB/sec    1.00      5.3Â±0.04ms     7.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1133.9Â±1.12Âµs    14.7 MB/sec    1.00   1132.8Â±1.35Âµs    14.7 MB/sec
linter/default-rules/numpy/globals.py      1.00    127.4Â±2.46Âµs    23.2 MB/sec    1.00    127.0Â±1.33Âµs    23.2 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.3Â±0.02ms    10.9 MB/sec    1.00      2.3Â±0.01ms    10.9 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     10.0Â±0.13ms     4.1 MB/sec    1.04     10.4Â±0.16ms     3.9 MB/sec
formatter/numpy/ctypeslib.py               1.00  1896.9Â±30.41Âµs     8.8 MB/sec    1.03  1953.7Â±30.67Âµs     8.5 MB/sec
formatter/numpy/globals.py                 1.00    208.9Â±6.80Âµs    14.1 MB/sec    1.02    213.9Â±7.44Âµs    13.8 MB/sec
formatter/pydantic/types.py                1.00      4.2Â±0.06ms     6.1 MB/sec    1.04      4.3Â±0.05ms     5.9 MB/sec
linter/all-rules/large/dataset.py          1.00     12.8Â±0.12ms     3.2 MB/sec    1.01     13.0Â±0.14ms     3.1 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.5Â±0.04ms     4.8 MB/sec    1.01      3.5Â±0.04ms     4.8 MB/sec
linter/all-rules/numpy/globals.py          1.00    432.2Â±8.97Âµs     6.8 MB/sec    1.00    432.4Â±6.83Âµs     6.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.8Â±0.05ms     4.4 MB/sec    1.03      6.0Â±0.12ms     4.3 MB/sec
linter/default-rules/large/dataset.py      1.00      6.9Â±0.17ms     5.9 MB/sec    1.00      6.9Â±0.10ms     5.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.02  1444.7Â±19.62Âµs    11.5 MB/sec    1.00  1415.7Â±15.93Âµs    11.8 MB/sec
linter/default-rules/numpy/globals.py      1.00    164.4Â±2.92Âµs    17.9 MB/sec    1.00    164.8Â±2.84Âµs    17.9 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.0Â±0.03ms     8.4 MB/sec    1.01      3.1Â±0.05ms     8.3 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Label `formatter` added by @konstin on 2023-08-03 07:46_

---

_Renamed from "Add formatting for `StmtMatch` and `MatchCase`" to "Add formatting for `StmtMatch`" by @dhruvmanila on 2023-08-05 04:23_

---

_Review comment by @dhruvmanila on `crates/ruff_python_formatter/src/statement/stmt_match.rs`:45 on 2023-08-05 05:57_

Temporary until the `MatchCase` formatting is implemented.

---

_Review comment by @dhruvmanila on `crates/ruff_python_formatter/tests/snapshots/format@statement__match.py.snap`:76 on 2023-08-05 06:02_

This seems to be a known issue where the comment right next to an opening parentheses is moved down instead.

```diff
- match (  # leading expr comment
+ match (
+     # leading expr comment
```

---

_@dhruvmanila reviewed on 2023-08-05 06:33_

---

_Marked ready for review by @dhruvmanila on 2023-08-05 06:33_

---

_Review requested from @MichaReiser by @dhruvmanila on 2023-08-05 06:33_

---

_Review requested from @konstin by @dhruvmanila on 2023-08-05 06:33_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/comments/placement.rs`:428 on 2023-08-07 08:44_

Do we need this function? i left it because i hadn't worked with match yet, but that case should be handled by the generic if/while/for/try logic

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/statement/stmt_match.rs`:32 on 2023-08-07 08:45_

Can this be more than one comment, and if not, could you add a debug assert?

---

_@konstin approved on 2023-08-07 08:46_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/statement/stmt_match.rs`:46 on 2023-08-07 08:46_

Could we move the mock implementations to the match cases instead and call into `case.format().fmt(f)` here? 

This has the benefit that implementing a specific match case requires no changes to the statement formatting (and we can even provide match case mocks of the right pattern)

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/statement/stmt_match.rs`:37 on 2023-08-07 08:48_

Do we need to retain empty lines between match cases?

Micha trying to write valid python code :sweat_smile: 

```python
match test:
	case "a":
		pass

	case "b":
		pass
```

---

_@MichaReiser reviewed on 2023-08-07 08:48_

---

_Review comment by @konstin on `crates/ruff_python_formatter/tests/snapshots/format@statement__match.py.snap`:76 on 2023-08-07 08:56_

See also #6380 and #6381, but we don't have the handling for this for general expression parentheses yet, leading end-of-line comments inside of optional expression parentheses are rather rare

---

_@konstin reviewed on 2023-08-07 08:56_

---

_@dhruvmanila reviewed on 2023-08-07 17:08_

---

_Review comment by @dhruvmanila on `crates/ruff_python_formatter/src/comments/placement.rs`:428 on 2023-08-07 17:08_

Oh, thanks for letting me know. Yeah, we don't actually need it as the comments are placed properly around the match statements and case nodes.

---

_Review comment by @dhruvmanila on `crates/ruff_python_formatter/src/statement/stmt_match.rs`:46 on 2023-08-07 17:36_

Yeah, we can.

> (and we can even provide match case mocks of the right pattern)

By this, do you mean the different kinds of patterns for the match cases? If so, that will make the formatting unstable because in the first iteration each pattern type will be formatted as it's not implemented equivalent but on the second iteration (now that the pattern is a variable semantically), some of them will be formatted again.

```python
match p:
	case Point(x, y):  # Pattern::MatchClass
		pass

# vvvvv
match p:
	case NOT_YET_IMPLEMENTED_MatchClass:  # Pattern::MatchValue
		pass

# vvvvv
match p:
	case NOT_YET_IMPLEMENTED_MatchValue:
		pass
```

---

_@dhruvmanila reviewed on 2023-08-07 17:36_

---

_Review comment by @dhruvmanila on `crates/ruff_python_formatter/src/statement/stmt_match.rs`:37 on 2023-08-07 17:37_

I think the newline handling will be done in the `MatchCase` implementation. Any newline between the `match` statement and the first case will be removed as is done in black as well:

```python
match test:

	case "a":
		pass

# vvvvv
match test:
	case "a":
		pass
```

---

_@dhruvmanila reviewed on 2023-08-07 17:37_

---

_Review requested from @MichaReiser by @dhruvmanila on 2023-08-07 17:55_

---

_@MichaReiser reviewed on 2023-08-07 18:20_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/statement/stmt_match.rs`:46 on 2023-08-07 18:20_

You can use the not_implemented_custom_text to provide a specific text. You then need to make sure that the class item uses a class verbatim text.

If it's not already the case: The MatchCase formatting should be a match statement that dispatches the formatting to the specific case item (see FormatStmt)

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/comments/visitor.rs`:76 on 2023-08-08 08:52_

Nice!

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/other/match_case.rs`:27 on 2023-08-08 08:55_

We can also do this as a separate PR: Ideally, we call into `pattern.format()` here. This requires implementing `AsFormat` and `IntoFormat` for `Pattern`, similar to how it is done for `Mod`

https://github.com/astral-sh/ruff/blob/f45e8645d7c4a2ad4e934ebbbadd91ca59fd543a/crates/ruff_python_formatter/src/module/mod.rs#L1-L35

---

_@MichaReiser approved on 2023-08-08 08:56_

---

_@dhruvmanila reviewed on 2023-08-08 13:03_

---

_Review comment by @dhruvmanila on `crates/ruff_python_formatter/src/other/match_case.rs`:27 on 2023-08-08 13:03_

Yes, it's already a work in progress in the next PR (https://github.com/astral-sh/ruff/pull/6360/files#diff-05760c9829e7694c86aaf97014143c0785c12da546f06dcfbc87caf67b15d773) ;)

---

_Merged by @dhruvmanila on 2023-08-08 13:18_

---

_Closed by @dhruvmanila on 2023-08-08 13:18_

---

_Branch deleted on 2023-08-08 13:18_

---
