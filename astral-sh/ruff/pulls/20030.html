<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Use Salsa to cache workspace symbols - astral-sh/ruff #20030</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Use Salsa to cache workspace symbols</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20030">#20030</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2025-08-21 18:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a></div>
            <div class="timeline-body"><p>This PR pretty much does what astral-sh/ty#998 suggests: it turns the
symbol gathering at the file level into a Salsa query while being
careful not to make the query string a dependency of that query. This
lets Salsa cache the symbols on a per-file basis, while we do the
filtering in a separate aggregation step.</p>
<p>This PR also includes a (small) bonus optimization using a regex for
query filtering. :-)</p>
<p>Fixes astral-sh/ty#998</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @BurntSushi on 2025-08-21 18:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @BurntSushi on 2025-08-21 18:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @BurntSushi on 2025-08-21 18:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @BurntSushi on 2025-08-21 18:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @BurntSushi on 2025-08-21 18:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-21 19:00</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-21 19:03</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @AlexWaygood on 2025-08-21 19:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-08-21 19:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dcreager removed by @BurntSushi on 2025-08-21 19:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @BurntSushi on 2025-08-21 19:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @BurntSushi on 2025-08-21 19:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @BurntSushi on 2025-08-21 19:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-21 19:10</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_ide/src/symbols.rs</code>:46 on 2025-08-22 05:25</div>
            <div class="timeline-body"><p>Is this a leftover? Or, should this instead of <code>unreachable</code> / <code>panic</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_ide/src/symbols.rs</code>:138 on 2025-08-22 05:31</div>
            <div class="timeline-body"><p>Should we special case an empty string here so that we don't pay the cost of trying to match it when it's going to match every symbol? My main motivation is that the spec mentions:</p>
<blockquote>
<p>Clients may send an empty string here to request all symbols.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/requests/workspace_symbols.rs</code>:38 on 2025-08-22 05:33</div>
            <div class="timeline-body"><p>nit: I think the server does log the time it takes for the entire request to run, so we might want to re-word this to not mention &quot;request&quot; to avoid any confusion? Maybe something like: &quot;Found {len} workspace symbols in {elapsed:?}&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-08-22 05:35</div>
            <div class="timeline-body"><p>Looks great! Do we have any numbers on the difference between a few requests like (a) no query (b) with small and large query string?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/symbols.rs</code>:154 on 2025-08-22 07:00</div>
            <div class="timeline-body"><p>I'm not sure if it's worth it but I'm wondering if we want to remove the <code>hierarchical</code> flag here. I suspect that the most costly part is iterating over all files, parsing them, and not necessarily the filtering/post processing once we found a matching file.</p>
<p>Also, having both <code>hierarchical</code> and <code>global_only</code> also means that we have up to 4 cached results for each file.</p>
<p>Could we instead change <code>symbols_for_file_inner</code> to return <code>IndexVec&lt;SymbolIndex, SymbolInfo&gt;</code> where:</p>
<pre><code class="language-rust">struc SymbolInfo {
	parent: Option&lt;SymbolIndex&gt;,
	/// The name of the symbol
  pub name: String,
  /// The kind of symbol (function, class, variable, etc.)
  pub kind: SymbolKind,
  /// The range of the symbol name
  pub name_range: TextRange,
  /// The full range of the symbol (including body)
  pub full_range: TextRange,
}
</code></pre>
<p>and we do the transformation to a hierarchical representation post filtering.</p>
<p>This would then allow us to remove this struct altogether and simply have two queries:</p>
<pre><code class="language-rust">#[salsa::tracked(returns(ref))]
fn global_symbols_for_file(db: &amp;dyn Db, file: File);

#[salsa::tracked(returns(ref))]
fn symbols_for_file(db: &amp;dyn Db, file: File);
</code></pre>
<p>The advantage of using two different queries is that it removes the need of interning the arguments because the function has exactly one argument</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/symbols.rs</code>:148 on 2025-08-22 07:02</div>
            <div class="timeline-body"><p>We should use <code>returns(ref)</code> or <code>returns(deref)</code> here to avoid cloning the returned vector</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/symbols.rs</code>:142 on 2025-08-22 07:04</div>
            <div class="timeline-body"><p>You don't need to intern the <code>Options</code> struct. In fact, <code>symbols_for_file_inner</code> now requires two level of interning:</p>
<ol>
<li>Your manual interning of <code>SymbolsOptionsIngredient</code></li>
<li>Salsa creates a hidden interned struct <code>Arguments { file: File, options: SymbolsOptionsIngredient }</code> because the query has more than 1 argument (besides <code>db</code>).</li>
</ol>
<p>You can simply remove the <code>interned</code> here and use salsa's &quot;behind the scene&quot; interning</p>
<p>This is the code in salsa that decides if an interner is required:</p>
<p>First, Salsa decides the &quot;function type&quot; by looking at how many arguments a function has</p>
<p>https://github.com/MichaReiser/salsa/blob/f39e1947af0b00f63afac32e27449029c1b1499c/components/salsa-macros/src/tracked_fn.rs#L335-L344</p>
<p>Based on that, it decides if interning is required or not</p>
<p>https://github.com/MichaReiser/salsa/blob/f39e1947af0b00f63afac32e27449029c1b1499c/components/salsa-macros/src/tracked_fn.rs#L164-L167</p>
<p>Ideally, interning wouldn't be required for constant functions but it currently does :(</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api/requests/workspace_symbols.rs</code>:32 on 2025-08-22 07:16</div>
            <div class="timeline-body"><p>This is, sort of, a separate optimization but parallelization would help a great deal with workspace symbols:</p>
<pre><code class="language-rust">    let files = project.files(db);
    let results = std::sync::Mutex::new(Vec::new());
    {
        let db = db.dyn_clone();
        let files = &amp;files;
        let options = &amp;options;
        let results = &amp;results;

        rayon::scope(move |s| {
            // For each file, extract symbols and add them to results
            for file in files.iter() {
                let db = db.dyn_clone();
                s.spawn(move |_| {
                    let file_symbols = symbols_for_file(&amp;*db, *file, options);

                    for symbol in file_symbols {
                        results.lock().unwrap().push(WorkspaceSymbolInfo {
                            symbol,
                            file: *file,
                        });
                    }
                });
            }
        });
    }

    results.into_inner().unwrap()
</code></pre>
<p>This makes workspace symbols complete on home assistant and without caching and with a debug build in under 2 seconds and it is instant with caching</p>
<pre><code>9:16:47.935070000 DEBUG request{id=8 method=&quot;workspace/symbol&quot;}: Workspace symbols request returned 133750 suggestions in 631.400375ms
2025-08-22 09:16:47.968469000 DEBUG request{id=9 method=&quot;workspace/symbol&quot;}: Workspace symbols request returned 101056 suggestions in 412.80475ms
2025-08-22 09:16:49.367840000 DEBUG request{id=10 method=&quot;workspace/symbol&quot;}: Workspace symbols request returned 42840 suggestions in 33.498042ms
2025-08-22 09:16:52.971051000 DEBUG request{id=11 method=&quot;workspace/symbol&quot;}: Workspace symbols request returned 1874 suggestions in 57.296833ms
2025-08-22 09:16:55.151914000 DEBUG request{id=12 method=&quot;workspace/symbol&quot;}: Workspace symbols request returned 4162 suggestions in 48.12ms
2025-08-22 09:16:55.993286000 DEBUG request{id=13 method=&quot;workspace/symbol&quot;}: Workspace symbols request returned 7559 suggestions in 57.637541ms
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-08-22 07:23</div>
            <div class="timeline-body"><p>I think there are ways on how we could improve the caching further (or, at least, reduce the caching overhead) and concurrency should make this much faster.</p>
<p>It does hurt us a little that we garbage collect parsed ASTs when workspace diagnostics are enabled, but that's out of scope for this change</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-08-22 12:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/symbols.rs</code>:46 on 2025-08-22 12:07</div>
            <div class="timeline-body"><p>Whoops, forgot to circle back around to this!</p>
<p>I'd enable a Clippy lint for checking <code>todo!()</code>, but it looks like we're meaningfully using it in at least one place. I added a comment near there to add <code>todo = &quot;warn&quot;</code> once <code>todo!()</code> is gone.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-08-22 12:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/symbols.rs</code>:138 on 2025-08-22 12:09</div>
            <div class="timeline-body"><p>Sounds reasonable! Done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-08-22 12:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_server/src/server/api/requests/workspace_symbols.rs</code>:38 on 2025-08-22 12:10</div>
            <div class="timeline-body"><p>Makes sense!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/symbols.rs</code>:148 on 2025-08-22 12:49</div>
            <div class="timeline-body"><p>Nice. This required a few other touchups, and we do ultimately still clone the <code>SymbolInfo</code>, but at least now we only clone the ones that have passed the query string filter.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-08-22 12:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/symbols.rs</code>:142 on 2025-08-22 12:58</div>
            <div class="timeline-body"><p>Got it, makes sense. Done!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-08-22 12:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-08-22 13:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_server/src/server/api/requests/workspace_symbols.rs</code>:32 on 2025-08-22 13:08</div>
            <div class="timeline-body"><p>Nice! Applied!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-23 12:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/symbols.rs</code>:154 on 2025-08-23 12:48</div>
            <div class="timeline-body"><p>Uff, this turned out to be more complicated than I thought. I'm sorry</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-08-23 12:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/symbols.rs</code>:154 on 2025-08-23 12:49</div>
            <div class="timeline-body"><p>Phew, this is done. I think the API is now better for it too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-08-23 12:52</div>
            <div class="timeline-body"><blockquote>
<p>Do we have any numbers on the difference between a few requests like (a) no query (b) with small and large query string?</p>
</blockquote>
<p>After the initial cold run, requests generally take a few dozen milliseconds. There isn't a ton of variation with respect to query string length (which is what I'd expect I think).</p>
<p>The slowest part of the process here is when we return <em>a lot</em> of symbols and VS Code needs to update its drop-down UI. There's a fairly sizeable delay there (on the order of a couple seconds). But to VS Code's credit, if you keep typing, it's pretty good about stopping what it was doing and moving on to the next request.</p>
<p>It overall feels pretty good. It'd be nice if VS Code was a little snappier, but I think the only thing we could do there is return fewer symbols. And I'm not sure if that's a good idea.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/symbols.rs</code>:133 on 2025-08-23 13:04</div>
            <div class="timeline-body"><p>I'm a bit surprised this works. Is it guaranteed that we add all symbols (children) in breadth-first and not depth-first order? Or am I overlooking something here that makes this possible?</p>
<p>We use a similar representation for <code>Scope</code> in the <code>SemanticIndex</code> where each <code>Scope</code> stores a <code>Range&lt;FileScopeId&gt;</code>. However, that range doesn't capture the <code>Scope's</code> children; it's the <code>Scope'</code>s descendants. Finding the <code>Scope'</code>s children requires iterating over the descendants and skipping all those with a different <code>parent</code>.</p>
<p>It's not fully clear to me why we don't have the descendants problem here. Maybe it's worth adding a comment why <code>start + child_symbol_ids.len()</code> works.</p>
<p>https://github.com/astral-sh/ruff/blob/4ac2b2c22283c9f8eb7f7fd945ab1c5f08098ab4/crates/ty_python_semantic/src/semantic_index.rs#L612-L615</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-08-23 13:07</div>
            <div class="timeline-body"><p>Nice! Thank you for figuring out this tricky representation. This required more work than I expected</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-08-23 13:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/symbols.rs</code>:133 on 2025-08-23 13:30</div>
            <div class="timeline-body"><p>Yeah I can add a comment. It works because we guarantee all parents are added before their children in the visitor. I think I wrote a comment about that somewhere, but I should make it more prominent.</p>
<p>All this code is doing is taking the <code>Map&lt;SymbolId, Vec&lt;SymbolId&gt;&gt;</code> representation created above and flattening it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @BurntSushi on 2025-08-23 16:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2025-08-23 16:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-23 16:53</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:15:14 UTC
    </footer>
</body>
</html>
