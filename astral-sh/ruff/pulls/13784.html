<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Do not put a space between `#` and `SBATCH` for comments - astral-sh/ruff #13784</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Do not put a space between <code>#</code> and <code>SBATCH</code> for comments</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13784">#13784</a>
        opened by <a href="https://github.com/smsutherland">@smsutherland</a>
        on 2024-10-16 22:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/smsutherland">@smsutherland</a></div>
            <div class="timeline-body">

Summary
<p>The Slurm workload manager allows users to create job scripts and specify parameters to run the job with <code>#SBATCH [flag]</code>.
ruff currently reformats these to <code># SBATCH [flag]</code>, which isn&#x27;t recognized by Slurm because of the extra space.
This commit checks if comments start with <code>SBATCH</code>, and if so, does not add the space, similar to how shebangs are treated.</p>


Test Plan
<p>I didn&#x27;t see any existing tests for adding that space, so I didn&#x27;t add any of my own. I could go back and add tests though, if requested.</p>


Additional Note
<p>I understand if this doesn&#x27;t get merged, since this change does technically constitute intentionally violating formatting guidelines.
However, this violation is in a situation where the user would very rarely want the current behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/smsutherland">@smsutherland</a> on 2024-10-16 22:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-16 22:13</div>
            <div class="timeline-body"><p>I wonder if we need a regex configuration option or something for comment exclusions like this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-10-16 22:23</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-17 05:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-17 05:53</div>
            <div class="timeline-body"><p>The implementation itself looks correct to me but I don&#x27;t think we want hardcoded exclusions in the formatter. A regex is an option, but it opens the door for many other regex-like settings.</p>
<p>There was a recent ask for skipping formatting of x number of lines at the beginning of a file and I would rather like to solve this with as few options as possible. Could you share a few examples of where these SBATCH comments are allowed? Would the Slurm manager be open to also recognize <code>#:SBATCH</code> or <code># SBATCH</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-17 05:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/smsutherland">@smsutherland</a> on 2024-10-17 12:41</div>
            <div class="timeline-body"><p>Skipping formatting of x lines at the start could solve this, but the number of lines needing to be skipped would vary from file to file, and would need to be changed if someone ever changes their script. Looking into this more, the desired behavior can be achieved by wrapping the relevant comments in <code># fmt: off</code> <code># fmt: on</code>. While a regex-based config option to, for example, disable formatting on lines matching some regex would be useful for similar cases which don&#x27;t allow for the inclusion of an extra comment like <code># fmt: off</code>, it wouldn&#x27;t be in the scope of this PR. I&#x27;m happy to close this if there are no objections.</p>
<p>To answer your question though, <code>#SBATCH</code> comments must appear before any non-comment lines (not counting empty lines) of whichever script they appear in. The line <em>must</em> start with <code>#SBATCH</code> exactly to count (technically <code>#SLURM</code> is also recognized but this behavior is deprecated). As an example</p>
<pre><code>#!/bin/bash
#SBATCH -a
# SBATCH -b
# another comment

#SBATCH --c=d
echo hello, world!
#SBATCH -e
</code></pre>
<p>would only recognize the options <code>-a --c=d</code>.
For the curious, the this behavior is encoded here: https://github.com/SchedMD/slurm/blob/master/src/sbatch/opt.c#L582-L609.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Skylion007">@Skylion007</a> on 2024-10-17 13:27</div>
            <div class="timeline-body"><p>Just being able to define comment types as a &quot;pragma&quot; with a regex would solve this. Some comments are unfortunately magic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-17 13:33</div>
            <div class="timeline-body"><p>I don&#x27;t really buy the slippery-slope argument. Pragmas are a real use-case that we should clearly avoid breaking — I don&#x27;t think adding support for excluding those means we&#x27;ll be forced to support other configuration.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-17 14:08</div>
            <div class="timeline-body"><blockquote>
<p>Pragmas are a real use-case that we should clearly avoid breaking</p>
</blockquote>
<p>The challenge here is that many pragma comments are fine with whitespace insertion. So the configuration isn&#x27;t a regex that specifies what pragma comments are. The formatter has other behavior around pragma comments: It excludes them from the measured line width. Would that behavior apply as well?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-17 14:11</div>
            <div class="timeline-body"><blockquote>
<p>The formatter has other behavior around pragma comments: It excludes them from the measured line width. Would that behavior apply as well?</p>
</blockquote>
<p>I don&#x27;t see why not.</p>
<p>Perhaps someone should open an issue with SLURM asking if they&#x27;re willing to support pragmas with leading whitespace as is standard in Python?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-17 14:45</div>
            <div class="timeline-body"><blockquote>
<p>I don&#x27;t see why not.</p>
</blockquote>
<p>Because that&#x27;s where I think it becomes less clear what the setting configures because other pragma comments allow whitespace. The configuration would really be about a specific subset of pragma comments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-17 15:04</div>
            <div class="timeline-body"><blockquote>
<p>Because that&#x27;s where I think it becomes less clear what the setting configures because other pragma comments allow whitespace. The configuration would really be about a specific subset of pragma comments.</p>
</blockquote>
<p>I don&#x27;t think it needs to change the semantics for pragma comments in general, just allow definition of <em>additional</em> patterns to be treated pragma comments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-17 20:28</div>
            <div class="timeline-body"><p>Agree, but we would have to distinguish between pragmas where the whitespace normalization should take place and those where it shouldn&#x27;t</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-19 19:57</div>
            <div class="timeline-body"><p>I&#x27;ll close this PR as is because we first need to align on a design. Let&#x27;s continue the discussion in an issue if needed</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-19 19:57</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:07:30 UTC
    </footer>
</body>
</html>
