<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Simplify visibility constraint handling for `*`-import definitions - astral-sh/ruff #17486</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Simplify visibility constraint handling for <code>*</code>-import definitions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17486">#17486</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-04-19 20:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>A bank-holiday-weekend refactoring PR ðŸ˜†</p>
<p>I was curious about just how invasive the change would be if I took action on my comment in https://github.com/astral-sh/ruff/pull/17375#issuecomment-2804644637 (optimising the slow path for <code>*</code> imports as well as the fast path). It turns out, not very invasive at all! Only one new API has to be added to the use-def map, and it's a fairly innocuous API in my opinion.</p>
<p>I doubt this provides a meaningful speedup in many cases, since it's just very uncommon to use a <code>*</code>-import definition to override a pre-existing definition. I'm filing the PR anyway, however, as it ends up simplifying the code in <code>builder.rs</code> a fair bit. We no longer have to branch on whether the symbol is newly added or not; we can just do the same thing in both cases.</p>
<h2>Test Plan</h2>
<p><code>cargo test -p red_knot_python_semantic</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-04-19 20:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-04-19 20:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-04-19 20:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @AlexWaygood on 2025-04-19 20:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-19 20:47</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-19 20:55</div>
            <div class="timeline-body"><p>neutral on codspeed: https://codspeed.io/astral-sh/ruff/branches/alex%2Foptimize-star-imports</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:360 on 2025-04-21 13:33</div>
            <div class="timeline-body"><p>Doc comment needs to be updated</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/red_knot_python_semantic/src/semantic_index/use_def.rs</code>:800 on 2025-04-21 13:35</div>
            <div class="timeline-body"><p>grammar nit:</p>
<pre><code class="language-suggestion">    /// - We only apply and negate the visibility constraints to a single symbol, rather than to
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/red_knot_python_semantic/src/semantic_index/use_def/symbol_state.rs</code>:317 on 2025-04-21 13:37</div>
            <div class="timeline-body"><p>:exploding_head: We <em>do</em> have <code>pub(grandparent)</code> as a possibility, I did not know that! I still worry that we might be over-thinking visibility within this crate, but that is not at all a blocker for this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> approved on 2025-04-21 13:39</div>
            <div class="timeline-body"><blockquote>
<p>I doubt this provides a meaningful speedup in many cases, since it's just very uncommon to use a <code>*</code>-import definition to override a pre-existing definition. I'm filing the PR anyway, however, as it ends up simplifying the code in <code>builder.rs</code> a fair bit. We no longer have to branch on whether the symbol is newly added or not; we can just do the same thing in both cases.</p>
</blockquote>
<p>Simplified code with no performance regression counts as a win to me!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-04-21 15:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-04-21 15:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-21 15:33</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:11:42 UTC
    </footer>
</body>
</html>
