```yaml
number: 7532
title: "Unify `Settings` and `AllSettings`"
type: pull_request
state: merged
author: MichaReiser
labels:
  - internal
assignees: []
merged: true
base: main
head: merge-settings-and-all-settings
created_at: 2023-09-20T07:24:12Z
updated_at: 2023-09-20T16:04:52Z
url: https://github.com/astral-sh/ruff/pull/7532
synced_at: 2026-01-12T15:55:24Z
```

# Unify `Settings` and `AllSettings`

---

_@MichaReiser_

## Summary

This PR merges `AllSettings` and `Settings` (by merging `CliSettings` into `Settings`). The main motivation is to avoid the confusion of why the two settings exist, which still isn't entirely clear to me. 
Here's what I understand today (I am happy to close this PR if we can get to the bottom of why the two structs exist)

#1891 split `Settings` into `AllSettings` and `Settings` 

> We want to automatically derive Hash for the library settings, which
requires us to split off all the settings unused by the library
(since these shouldn't affect the hash used by ruff_cli::cache).

I solved this by extending the `CacheKey` derive macro to support the `cache_key(ignore)` field attribute to ignore individual fields. We can keep the automatically derived `CacheKey` implementation and explicitly mark the excluded fields.

There has been some argument whether the two settings exist because the `CliSettings` are only respected for the "root" configuration. This holds true for all `CliSettings` except `cache-dir` as #7520 showed. Meaning that distinction may have been true but no longer is. 

My final guess is that the `CliSettings` used to be unique to using `ruff` from the cli. I think this is still mostly true (although most of the resolver code now lives inside `ruff_workspace`). However, I don't think it is sufficient reason to separate the two structs, especially considering that we could show diagnostics in our playground similar to [biome](https://biomejs.dev/playground/?code=aQBmACAAKABhACAAPQA9ACAAYgApAA%3D%3D) (see console tab) where we would want to respect the `output-format` configuration (and `--show-sources` etc). `fix`, `fix-only` and `cache-dir` likely remain CLI only settings but, IMO, don't justify the cognitive load of having multiple settings structs. 

The main justification for me to keep the separate settings struct is that the linter doesn't need the `CliSettings`. These are settings that only concern the diagnostic rendering, and file traversal (although the same is true for `exclude`, `respect_gitignore` and other global settings). That's why I plan to split settings in more semantic sub-settings:

* Linter settings
* Formatter settings
* common / shared settings
* Maybe; Resolver settings?

## Test Plan

`cargo test`


---

_Review requested from @charliermarsh by @MichaReiser on 2023-09-20 07:24_

---

_Comment by @MichaReiser on 2023-09-20 07:24_

Current dependencies on/for this PR:
* main
  * **PR #7532** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7532" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #7542** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7542" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #7543** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7543" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #7544** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7544" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #7545** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7545" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
            * **PR #7548** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7548" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
              * **PR #7549** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7549" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7536** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7536" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7532?utm_source=stack-comment).

---

_Label `internal` added by @MichaReiser on 2023-09-20 07:24_

---

_Comment by @github-actions[bot] on 2023-09-20 07:49_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.



---

_Review comment by @charliermarsh on `crates/ruff_linter/src/settings/defaults.rs`:78 on 2023-09-20 12:58_

Nit: maybe a comment on why these are separated from the rest? Same with other instantiations.

---

_@charliermarsh approved on 2023-09-20 12:58_

---

_@MichaReiser reviewed on 2023-09-20 13:48_

---

_Review comment by @MichaReiser on `crates/ruff_linter/src/settings/defaults.rs`:78 on 2023-09-20 13:48_

I'll leave it as is because these will be moved to their own `struct` in a PR higher in the stack, making the reason clear

---

_Merged by @MichaReiser on 2023-09-20 13:56_

---

_Closed by @MichaReiser on 2023-09-20 13:56_

---

_Branch deleted on 2023-09-20 13:56_

---
