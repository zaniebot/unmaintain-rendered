<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Better class def completions - astral-sh/ruff #22571</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Better class def completions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22571">#22571</a>
        opened by <a href="https://github.com/RasmusNygren">@RasmusNygren</a>
        on 2026-01-14 14:28
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/RasmusNygren">@RasmusNygren</a></div>
            <div class="timeline-body">Summary
<p>Prefer completions of type <code>ClassLiteral</code> inside class-def context.</p>
<p>Fixes <a href="https://github.com/astral-sh/ty/issues/1776">astral-sh/ty#1776</a></p>
Test Plan
<p>New completion-eval test that has incorrect ranking on main but correct after this patch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/RasmusNygren">@RasmusNygren</a> on 2026-01-14 14:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/RasmusNygren">@RasmusNygren</a> on 2026-01-14 14:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/RasmusNygren">@RasmusNygren</a> on 2026-01-14 14:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/RasmusNygren">@RasmusNygren</a> on 2026-01-14 14:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/RasmusNygren">@RasmusNygren</a> on 2026-01-14 14:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/Gankra">@Gankra</a> by <a href="https://github.com/RasmusNygren">@RasmusNygren</a> on 2026-01-14 14:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-14 14:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-14 14:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/RasmusNygren">@RasmusNygren</a> reviewed on 2026-01-14 14:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/RasmusNygren">@RasmusNygren</a> on <code>crates/ty_ide/src/completion.rs</code>:853 on 2026-01-14 14:47</div>
            <div class="timeline-body"><p>This leads to us calculating whether or not we&#x27;re in a class def twice, here and in <code>add_argument_completions</code>. I think this is fine for now but we probably want to do some refactors here and store more information on the context such that we only run the detection once and can re-use that both to add completions and for ranking. Perhaps the <code>NonImportContext</code> can store another enum and track if we&#x27;re in a class-def/raising_exception etc.</p>
<p>Have you already thought about how to best scale this @BurntSushi ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/dcreager">@dcreager</a> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-14 20:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/carljm">@carljm</a> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-14 20:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/sharkdp">@sharkdp</a> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-14 20:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/BurntSushi">@BurntSushi</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-14 20:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:853 on 2026-01-15 13:29</div>
            <div class="timeline-body"><p>I haven&#x27;t thought too much about this, no. But what you say sounds plausible to me. Possibly the challenge here is making sure we don&#x27;t try to pre-compute too much stuff, particularly if we end up not needing it.</p>
<p>But yeah I agree that this is fine for now. Especially given that <code>covering_node</code> is only computed once now. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2026-01-15 13:30</div>
            <div class="timeline-body"><p>Beautiful. This looks great as-is, thank you!!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2026-01-15 13:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2026-01-15 13:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2026-01-15 18:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:23:01 UTC
    </footer>
</body>
</html>
