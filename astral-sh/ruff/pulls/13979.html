<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cached inference of all definitions in an unpacking - astral-sh/ruff #13979</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Cached inference of all definitions in an unpacking</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13979">#13979</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-10-29 11:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR adds a new salsa query and an ingredient to resolve all the variables involved in an unpacking assignment like <code>(a, b) = (1, 2)</code> at once. Previously, we'd recursively try to match the correct type for each definition individually which will result in creating duplicate diagnostics.</p>
<p>This PR still doesn't solve the duplicate diagnostics issue because that requires a different solution like using salsa accumulator or de-duplicating the diagnostics manually.</p>
<p>Related: #13773</p>
<h2>Test Plan</h2>
<p>Make sure that all unpack assignment test cases pass, there are no panics in the corpus tests.</p>
<h2>Todo</h2>
<ul>
<li>[x] Look at the performance regression</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @dhruvmanila on 2024-10-29 11:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-10-29 11:18</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/dhruv/unpack">CodSpeed Performance Report</a></h2>
<h3>Merging #13979 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>dhruv/unpack</code> (c039525) with <code>main</code> (012f385)</sub></p>
<h3>Summary</h3>
<p><code>✅ 32</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-10-30 11:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1360 on 2024-10-30 11:02</div>
            <div class="timeline-body"><p>I'm not exactly a big fan of this; what I want here is to get the target expression for the unpacking and it should be a <code>AstNodeRef</code>. It doesn't really matter if we know where the target is coming from which we currently do using the <code>UnpackTarget</code> enum.</p>
<p>Another way would be to accept the <code>target: AstNodeRef&lt;Expr&gt;</code> parameter for <code>infer_assignment_definition</code> but then we'd need to update the <code>AssignmentDefinitionKind</code> to contain this target expression as <code>AstNodeRef</code> instead of just storing the target index:</p>
<p>https://github.com/astral-sh/ruff/blob/c03f9873a1e884a03e1ccfd5fa4848df5fae863f/crates/red_knot_python_semantic/src/semantic_index/definition.rs#L518-L524</p>
<p>And, then for the <code>ForStmtDefinitionKind</code>, we'd update the existing <code>target</code> field type to be <code>AstNodeRef&lt;Expr&gt;</code>:</p>
<p>https://github.com/astral-sh/ruff/blob/c03f9873a1e884a03e1ccfd5fa4848df5fae863f/crates/red_knot_python_semantic/src/semantic_index/definition.rs#L563-L568</p>
<p>And, similarly for other nodes where unpacking is supported.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-10-30 19:11</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1360 on 2024-11-01 10:01</div>
            <div class="timeline-body"><p>I've resolved this by changing the <code>AssignmentDefinitionKind</code> to:</p>
<pre><code class="language-rs">#[derive(Clone, Debug)]
pub struct AssignmentDefinitionKind {
    target: TargetKind,
    value: AstNodeRef&lt;ast::Expr&gt;,
    name: AstNodeRef&lt;ast::ExprName&gt;,
}
</code></pre>
<p>which is the same size as the current structure.</p>
<p>This utilizes the fact that the target expression is required only for unpacking purpose, so it combines the existing <code>assignment</code>, <code>target_index</code> and <code>kind</code> into a single enum and extracts the <code>value</code> field as its own.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-11-01 10:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-11-01 11:29</div>
            <div class="timeline-body"><p>I'm not exactly sure what's causing the performance regression. It might very well be the fact that this PR creates additional ingredients and goes through a new salsa query which adds the overhead. This is because the <code>tomllib</code> contains multiple assignment statements where unpacking is required:</p>
<pre><code>1red_knot_python_semantic::types::unpack::Unpack                             55           55           55
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dhruvmanila on 2024-11-01 11:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dhruvmanila on 2024-11-01 11:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2024-11-01 11:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dhruvmanila on 2024-11-01 11:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @dhruvmanila on 2024-11-01 11:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-01 11:55</div>
            <div class="timeline-body"><p>Is it only that there are 55 new unpackings, or are there other ingredients with a different count?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-11-01 12:57</div>
            <div class="timeline-body"><blockquote>
<p>Is it only that there are 55 new unpackings, or are there other ingredients with a different count?</p>
</blockquote>
<p>There are other ingredients with different count:</p>
<p><code>main</code></p>
<pre><code>1red_knot_python_semantic::semantic_index::definition::Definition         6_643        6_643        6_643
1red_knot_python_semantic::semantic_index::expression::Expression           553          553          553
1red_knot_python_semantic::semantic_index::symbol::ScopeId                1_978        1_978        1_978
1ruff_db::files::File                                                        59           59           59
1ruff_db::source::SourceText                                                 15           15           15
1                                                                         total     max_live         live
</code></pre>
<p><code>dhruv/unpack</code></p>
<pre><code>1red_knot_python_semantic::semantic_index::definition::Definition         6_620        6_620        6_620
1red_knot_python_semantic::semantic_index::expression::Expression           549          549          549
1red_knot_python_semantic::semantic_index::symbol::ScopeId                1_974        1_974        1_974
1red_knot_python_semantic::types::unpack::Unpack                             55           55           55
1ruff_db::files::File                                                        59           59           59
1ruff_db::source::SourceText                                                 15           15           15
1                                                                         total     max_live         live
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-11-01 13:03</div>
            <div class="timeline-body"><p>Oh ok, I got it. I think the <code>Unpack</code> ingredient is not well isolated for each statement.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-11-01 13:23</div>
            <div class="timeline-body"><p>Actually, I think it's because I'm creating the ingredient multiple times. I think I need to create it once in the semantic index and store it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @dhruvmanila on 2024-11-01 13:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-11-01 15:00</div>
            <div class="timeline-body"><p>(I've put this in draft to fix the regression.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dhruvmanila on 2024-11-04 07:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/unpacker.rs</code>:33 on 2024-11-04 07:52</div>
            <div class="timeline-body"><pre><code class="language-suggestion"></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/unpacker.rs</code>:29 on 2024-11-04 07:52</div>
            <div class="timeline-body"><p>I assume this is copied over from <code>infer</code> or do I have to review this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/unpack.rs</code>:16 on 2024-11-04 07:54</div>
            <div class="timeline-body"><p>Could we add some documentation explaining why <code>Unpack</code> has to be its own ingredient and what it's used for?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-11-04 07:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-11-04 08:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/types/unpacker.rs</code>:29 on 2024-11-04 08:38</div>
            <div class="timeline-body"><p>Yes, this is copied over and it's not required to be reviewed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2024-11-04 11:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-11-04 11:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-04 11:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:55 on 2024-11-04 19:57</div>
            <div class="timeline-body"><p>This is a small nit, but it seems like maybe this could be part of <code>CurrentAssignment</code> rather than its own separately-maintained state? But maybe I've missed some subtlety why that can't work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1363 on 2024-11-04 20:02</div>
            <div class="timeline-body"><p>I guess the quick-fix approach to the duplicate diagnostics would be to track on <code>self</code> which unpacks we've queried already, and if we've seen it already, don't merge the diagnostics.</p>
<p>But I think it makes sense to see if accumulators can work, since that's a more general approach that doesn't require us to manually track when we might call a sub-query more than once.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-11-04 20:03</div>
            <div class="timeline-body"><p>This is great, thank you!! And thanks for starting the process of slimming down <code>infer.rs</code> a little bit :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-04 20:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1363 on 2024-11-04 20:19</div>
            <div class="timeline-body"><p>Yeah, I suggest not to spend more time on deduplicating diagnostics because I plan to look into this soon anyway</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-11-05 04:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:55 on 2024-11-05 04:50</div>
            <div class="timeline-body"><p>Yeah, I initially started with moving this information via <code>CurrentAssignment</code> -&gt; <code>DefinitionNodeRef</code> -&gt; <code>DefinitionKind</code> but that'll involve adding lifetimes and moving them around because <code>Unpack</code> uses a different lifetime while <code>CurrentAssignment</code> and <code>DefinitionNodeRef</code> uses the AST lifetime. But, now that I look at it again I think it might work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-11-05 04:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:55 on 2024-11-05 04:55</div>
            <div class="timeline-body"><p>Opened https://github.com/astral-sh/ruff/pull/14101</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:07:18 UTC
    </footer>
</body>
</html>
