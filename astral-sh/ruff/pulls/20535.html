<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pydoclint`] Fix false positive when Sphinx directives follow Raises section (`DOC502`) - astral-sh/ruff #20535</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pydoclint</code>] Fix false positive when Sphinx directives follow Raises section (<code>DOC502</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20535">#20535</a>
        opened by <a href="https://github.com/danparizher">@danparizher</a>
        on 2025-09-23 14:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/danparizher">@danparizher</a> on 2025-09-23 14:33</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes #18959</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-23 14:41</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+4 -8 violations, +0 -0 fixes in 2 projects; 53 projects unchanged)</p>
<details><summary><a href="https://github.com/apache/superset">apache/superset</a> (+0 -4 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
- <a href='https://github.com/apache/superset/blob/a5eb02d178d34dc72e6415134e8377868da8e4fd/superset/utils/date_parser.py#L173'>superset/utils/date_parser.py:173:5:</a> DOC502 Raised exceptions are not explicitly raised: `Relation to `time_range_lookup``, `- Example`
- <a href='https://github.com/apache/superset/blob/a5eb02d178d34dc72e6415134e8377868da8e4fd/superset/utils/date_parser.py#L203'>superset/utils/date_parser.py:203:5:</a> DOC502 Raised exceptions are not explicitly raised: `Relation to `time_range_lookup``, `- Example`
- <a href='https://github.com/apache/superset/blob/a5eb02d178d34dc72e6415134e8377868da8e4fd/superset/utils/date_parser.py#L234'>superset/utils/date_parser.py:234:5:</a> DOC502 Raised exceptions are not explicitly raised: `Relation to `time_range_lookup``, `- Example`
- <a href='https://github.com/apache/superset/blob/a5eb02d178d34dc72e6415134e8377868da8e4fd/superset/utils/date_parser.py#L279'>superset/utils/date_parser.py:279:5:</a> DOC502 Raised exceptions are not explicitly raised: `Relation to `time_range_lookup``, `- Example`
</pre>

</p>
</details>
<details><summary><a href="https://github.com/langchain-ai/langchain">langchain-ai/langchain</a> (+4 -4 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/langchain-ai/langchain/blob/d2189367630d9d35b2048dcfc017803ef4635881/libs/langchain/langchain_classic/chat_models/base.py#L79'>libs/langchain/langchain_classic/chat_models/base.py:79:5:</a> DOC502 Raised exceptions are not explicitly raised: `ValueError`, `ImportError`
- <a href='https://github.com/langchain-ai/langchain/blob/d2189367630d9d35b2048dcfc017803ef4635881/libs/langchain/langchain_classic/chat_models/base.py#L79'>libs/langchain/langchain_classic/chat_models/base.py:79:5:</a> DOC502 Raised exceptions are not explicitly raised: `ValueError`, `ImportError`, `o3_mini = init_chat_model("openai`, `claude_sonnet = init_chat_model("anthropic`, `"google_vertexai`, `"what's your name", config={"configurable"`, `config={"configurable"`, `"openai`, `"configurable"`, `"foo_model"`, `"foo_temperature"`, `same way that you would with a normal model`, `class GetWeather(BaseModel)`, `location`, `class GetPopulation(BaseModel)`, `location`, `"Which city is hotter today and which is bigger`, `"Which city is hotter today and which is bigger`, `config={"configurable"`
+ <a href='https://github.com/langchain-ai/langchain/blob/d2189367630d9d35b2048dcfc017803ef4635881/libs/langchain/langchain_classic/embeddings/base.py#L133'>libs/langchain/langchain_classic/embeddings/base.py:133:5:</a> DOC502 Raised exception is not explicitly raised: `ImportError`
- <a href='https://github.com/langchain-ai/langchain/blob/d2189367630d9d35b2048dcfc017803ef4635881/libs/langchain/langchain_classic/embeddings/base.py#L133'>libs/langchain/langchain_classic/embeddings/base.py:133:5:</a> DOC502 Raised exceptions are not explicitly raised: `ImportError`, `model = init_embeddings("openai`, `model = init_embeddings("openai`
+ <a href='https://github.com/langchain-ai/langchain/blob/d2189367630d9d35b2048dcfc017803ef4635881/libs/langchain_v1/langchain/chat_models/base.py#L67'>libs/langchain_v1/langchain/chat_models/base.py:67:5:</a> DOC502 Raised exceptions are not explicitly raised: `ValueError`, `ImportError`
- <a href='https://github.com/langchain-ai/langchain/blob/d2189367630d9d35b2048dcfc017803ef4635881/libs/langchain_v1/langchain/chat_models/base.py#L67'>libs/langchain_v1/langchain/chat_models/base.py:67:5:</a> DOC502 Raised exceptions are not explicitly raised: `ValueError`, `ImportError`, `o3_mini = init_chat_model("openai`, `claude_sonnet = init_chat_model("anthropic`, `gemini_2-5_flash = init_chat_model("google_vertexai`, `configurable_model.invoke("what's your name", config={"configurable"`, `config={"configurable"`, `"openai`, `"configurable"`, `"foo_model"`, `"foo_temperature"`, `same way that you would with a normal model`, `class GetWeather(BaseModel)`, `location`, `class GetPopulation(BaseModel)`, `location`, `"Which city is hotter today and which is bigger`, `"Which city is hotter today and which is bigger`, `config={"configurable"`
+ <a href='https://github.com/langchain-ai/langchain/blob/d2189367630d9d35b2048dcfc017803ef4635881/libs/langchain_v1/langchain/embeddings/base.py#L129'>libs/langchain_v1/langchain/embeddings/base.py:129:5:</a> DOC502 Raised exception is not explicitly raised: `ImportError`
- <a href='https://github.com/langchain-ai/langchain/blob/d2189367630d9d35b2048dcfc017803ef4635881/libs/langchain_v1/langchain/embeddings/base.py#L129'>libs/langchain_v1/langchain/embeddings/base.py:129:5:</a> DOC502 Raised exceptions are not explicitly raised: `ImportError`, `model = init_embeddings("openai`, `model = init_embeddings("openai`
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| DOC502 | 12 | 4 | 8 | 0 | 0 |</p>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/danparizher">@danparizher</a> on 2025-09-23 14:54</div>
            <div class="timeline-body"><p>Note on <code>ruff-ecosystem</code> results: a net decrease in violations overall.</p>
<ul>
<li>Instances where a “removal/addition” pair appears at the same location.<ul>
<li>Those paired changes indicate message normalization rather than behavioral regression—the false positives are being eliminated where Sphinx directives follow a Raises section</li>
</ul>
</li>
<li>Remaining diagnostics have cleaner messages without stray directive/markup fragments.</li>
</ul>
<p>Net effect is reduced noise and improved precision</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @MichaReiser on 2025-10-12 06:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @MichaReiser on 2025-10-12 06:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pydoclint/rules/check_docstring.rs</code>:479 on 2025-10-13 22:03</div>
            <div class="timeline-body"><p>What do you think about something more like this for this function?</p>
<pre><code class="language-rust">fn parse_entries_google(content: &amp;str) -&gt; Vec&lt;QualifiedName&lt;'_&gt;&gt; {
    let mut entries: Vec&lt;QualifiedName&gt; = Vec::new();
    let mut lines = content.lines().peekable();
    let Some(first) = lines.peek() else {
        return entries;
    };
    let indentation = &amp;first[..first.len() - first.trim_start().len()];
    for potential in lines {
        if let Some(entry) = potential.strip_prefix(indentation) {
            if let Some(first_char) = entry.chars().next() {
                if !first_char.is_whitespace() {
                    if let Some(colon_idx) = entry.find(':') {
                        let entry = entry[..colon_idx].trim();
                        if !entry.is_empty() {
                            entries.push(QualifiedName::user_defined(entry));
                        }
                    }
                }
            }
        }
    }
    entries
}
</code></pre>
<p>This is closer to the <code>parse_entries_numpy</code> down below and seems to work on the new test case when I tried it locally.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-10-13 22:12</div>
            <div class="timeline-body"><p>Thanks! I had an idea for a possibly simpler implementation more similar to the numpy version. Let me know what you think. We should keep a close eye on the ecosystem results to make sure they are still improved.</p>
<p>This new result actually looks incorrect to me:</p>
<blockquote>
<ul>
<li><a href="https://github.com/langchain-ai/langchain/blob/9c1285cf5b538ebebfffc903621df8a3c5f0b53c/libs/langchain_v1/langchain/agents/react_agent.py#L304">libs/langchain_v1/langchain/agents/react_agent.py:304:9:</a> DOC502 Raised exception is not explicitly raised: <code>MultipleStructuredOutputsError</code></li>
</ul>
</blockquote>
<p>Maybe my suggestion will help with that too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">docstring</span> added by @ntBre on 2025-10-13 22:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @ntBre on 2025-10-13 22:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danparizher">@danparizher</a> reviewed on 2025-10-15 01:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/danparizher">@danparizher</a> on <code>crates/ruff_linter/src/rules/pydoclint/rules/check_docstring.rs</code>:479 on 2025-10-15 01:08</div>
            <div class="timeline-body"><p>This is significantly better, thank you! We will have to see what the ecosystem results will look like.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @danparizher on 2025-10-15 01:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-15 14:24</div>
            <div class="timeline-body"><p>Could you take a look at the ecosystem results? It looks like there are still some issues. I think we may need a combination of the two approaches we've tried, especially breaking early if we find a dedented line like you had initially. We should extract some test cases from the erroneous ecosystem results too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/danparizher">@danparizher</a> on 2025-10-15 22:37</div>
            <div class="timeline-body"><p>Just to clarify, for the &quot;dedented line&quot; breaking logic, should it:</p>
<ol>
<li>Break immediately when ANY line has less indentation than the first line</li>
<li>Break only when a line has NO indentation at all</li>
<li>Break when a line is dedented to the same level as the section header</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-15 22:46</div>
            <div class="timeline-body"><p>I think I was picturing option 1, possibly excluding completely blank lines, assuming those are allowed. I'm looking at</p>
<blockquote>
<ul>
<li><a href="https://github.com/apache/superset/blob/78907d08cd5a3a53e25050a08328bb3b7770f3c2/superset/utils/date_parser.py#L173">superset/utils/date_parser.py:173:5:</a> DOC502 Raised exception is not explicitly raised: <code>- Example</code></li>
</ul>
</blockquote>
<p>for example. The <code>- Example</code> point under a different heading is being flagged, so I assumed breaking when the indentation decreases would help:</p>
<pre><code class="language-py">    Returns:
        str: The resulting expression for the start of the specified unit.

    Raises:
        ValueError: If the unit is not one of the valid options.

    Relation to `time_range_lookup`:
        - Handles the &quot;start of&quot; or &quot;beginning of&quot; modifiers in the first regex pattern.
        - Example: &quot;start of this month&quot; → `DATETRUNC(DATETIME('today'), month)`.
    &quot;&quot;&quot;
</code></pre>
<p>But that's just an idea.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-10-28 18:15</div>
            <div class="timeline-body"><p>Thank you! This looks great and shows a very clear improvement in the ecosystem check.</p>
<p>I'm tempted to go ahead and land this, but I think this could also be a problem for numpy-style docstrings (<a href="https://play.ruff.rs/bf640866-ee7a-4f67-96c7-3a36573b735f">example</a>). These seem a little trickier since the exceptions are already dedented to the same level as the sphinx directive, assuming I followed the docs correctly. We may just have to check for a leading <code>..</code> in that case.</p>
<p>Do you want to try fixing that here too, or would it be better as a separate PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/danparizher">@danparizher</a> on 2025-10-29 21:58</div>
            <div class="timeline-body"><p>I'll try to fix that here too, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @danparizher on 2025-10-29 22:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-11-12 21:35</div>
            <div class="timeline-body"><p>Thanks again!</p>
<p>I just pushed one commit moving the <code>..</code> check into the indentation-stripped branch. I don't think this is likely to be common, but I could at least imagine a case like the new test I added where a Sphinx directive was used in the description of an exception, so the outer <code>break</code> would have been too eager.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-11-12 21:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-11-12 21:37</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:54:19 UTC
    </footer>
</body>
</html>
