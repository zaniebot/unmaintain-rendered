<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8_pyi`] Fix `PYI041`'s fix causing TypeError with `None | None | ...` - astral-sh/ruff #18637</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8_pyi</code>] Fix <code>PYI041</code>&#x27;s fix causing TypeError with <code>None | None | ...</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18637">#18637</a>
        opened by <a href="https://github.com/robsdedude">@robsdedude</a>
        on 2025-06-11 21:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a></div>
            <div class="timeline-body">

Summary
<p>Fix <code>PYI041</code>&#x27;s fix turning <code>None | int | None | float</code> into <code>None | None | float</code>, which raises a <code>TypeError</code> when executed.</p>
<p>The fix consists of making sure that the merged super-type is inserted where the first type that is merged was before.</p>
Test Plan
<p>Tests have been expanded with examples from the issue.</p>
Related Issue
<p>Fixes <a href="https://github.com/astral-sh/ruff/issues/18298">astral-sh/ruff#18298</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-11 21:57</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/robsdedude">@robsdedude</a> on 2025-06-11 22:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/robsdedude">@robsdedude</a> on 2025-06-11 22:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-12 04:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-12 04:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_pyi/PYI041.py</code>:96 on 2025-06-12 10:45</div>
            <div class="timeline-body"><pre><code># fix must not yield `None | None | ...` (TypeError)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_pyi/PYI041.pyi</code>:76 on 2025-06-12 10:46</div>
            <div class="timeline-body"><pre><code># fix must not yield `None | None | ...` (TypeError)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_numeric_union.rs</code>:108 on 2025-06-12 10:46</div>
            <div class="timeline-body"><p>why is this commented out?</p>
<pre><code></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/snapshots/ruff_linter__rules__flake8_pyi__tests__PYI041_PYI041.pyi.snap</code>:33 on 2025-06-12 10:50</div>
            <div class="timeline-body"><p>this is a clever way of fixing the issue, but I&#x27;m not totally sure that users will like it if the fix ends up reordering unions like this, even when the unions don&#x27;t contain <code>None</code>. I think that would be pretty unexpected if I were a Ruff user.</p>
<p>I&#x27;m leaning towards just not providing a fix for the rule if there are multiple <code>None</code>s in the union. It feels easy to understand, and well-written code should never have multiple <code>None</code>s in a union anyway -- we even have other lints that would already detect that!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-12 10:50</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a> reviewed on 2025-06-12 11:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robsdedude">@robsdedude</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/snapshots/ruff_linter__rules__flake8_pyi__tests__PYI041_PYI041.pyi.snap</code>:33 on 2025-06-12 11:36</div>
            <div class="timeline-body"><p>Sure. Your project, your direction. I personally wouldn&#x27;t be surprised. I&#x27;ve seen ruff fixes go beyond such changes. Further, I&#x27;d think of this more as merging elements in the union than reordering them. The PR will put the super-type in the place of the first type it&#x27;s subsuming.</p>
<p>Anyway, I&#x27;ll change the PR to just omit the fix. However, I suggest to only suppress the fix if not in a typing only context (as this is only a problem at runtime).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a> reviewed on 2025-06-12 12:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robsdedude">@robsdedude</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_numeric_union.rs</code>:1 on 2025-06-12 12:21</div>
            <div class="timeline-body"><p>While working on this fix, I&#x27;ve noticed that this checker is run before deferred string type annotations are visited and resolved. This means that the lint won&#x27;t trigger on those. Not sure you&#x27;d want that to be changed or whether that&#x27;s a deliberate design decision. Happy to pour this into an issue to tackle it later if you&#x27;re interested.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a> reviewed on 2025-06-12 12:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robsdedude">@robsdedude</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_numeric_union.rs</code>:108 on 2025-06-12 12:35</div>
            <div class="timeline-body"><p>Left-over from an earlier approach :innocent:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/robsdedude">@robsdedude</a> on 2025-06-12 12:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/ntBre">@ntBre</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-17 09:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_numeric_union.rs</code>:279 on 2025-06-20 18:30</div>
            <div class="timeline-body"><p>Do these get sorted somewhere? It&#x27;s not obvious to me why just checking the first two would work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_pyi/PYI041_1.py</code>:111 on 2025-06-20 18:31</div>
            <div class="timeline-body"><p>This one is also not obvious to me. Why does this get a fix and <code>f1</code> doesn&#x27;t?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_numeric_union.rs</code>:1 on 2025-06-20 18:37</div>
            <div class="timeline-body"><p>Yeah I think it makes sense to follow up on this, thanks! While testing this in the playground, I noticed that PYI016 <em>does</em> apply to string annotations, so you may be able to copy however it handles this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-20 18:37</div>
            <div class="timeline-body"><p>Thanks, I think this looks good overall. I just had a couple of questions to make sure I&#x27;m understanding what&#x27;s going on.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dscorbett">@dscorbett</a> reviewed on 2025-06-20 19:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dscorbett">@dscorbett</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_numeric_union.rs</code>:279 on 2025-06-20 19:00</div>
            <div class="timeline-body"><p>There’s only a problem if the first two are <code>None</code>. Other combinations work fine.</p>
<pre><code>&gt;&gt;&gt; None | int | None
None | int
&gt;&gt;&gt; int | None | None
int | None
&gt;&gt;&gt; None | None | int
Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
TypeError: unsupported operand type(s) for |: &#x27;NoneType&#x27; and &#x27;NoneType&#x27;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-20 19:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_numeric_union.rs</code>:279 on 2025-06-20 19:02</div>
            <div class="timeline-body"><p>Oh gotcha, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-20 19:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_pyi/PYI041_1.py</code>:111 on 2025-06-20 19:03</div>
            <div class="timeline-body"><p>The answer to my other question resolved this one too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-06-20 19:04</div>
            <div class="timeline-body"><p>Questions resolved! I was just confused, as expected.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-20 19:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-20 19:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-24 20:52</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:15:30 UTC
    </footer>
</body>
</html>
