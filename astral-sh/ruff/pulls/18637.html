<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8_pyi`] Fix `PYI041`'s fix causing TypeError with `None | None | ...` - astral-sh/ruff #18637</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8_pyi</code>] Fix <code>PYI041</code>'s fix causing TypeError with <code>None | None | ...</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18637">#18637</a>
        opened by <a href="https://github.com/robsdedude">@robsdedude</a>
        on 2025-06-11 21:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/robsdedude">@robsdedude</a> on 2025-06-11 21:51</div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff/ty! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title? (Please prefix with `[ty]` for ty pull
  requests.)
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>Fix <code>PYI041</code>'s fix turning <code>None | int | None | float</code> into <code>None | None | float</code>, which raises a <code>TypeError</code> when executed.</p>
<p>The fix consists of making sure that the merged super-type is inserted where the first type that is merged was before.</p>
<h2>Test Plan</h2>
<p>Tests have been expanded with examples from the issue.</p>
<h2>Related Issue</h2>
<p>Fixes https://github.com/astral-sh/ruff/issues/18298</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-11 21:57</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @robsdedude on 2025-06-11 22:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @robsdedude on 2025-06-11 22:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ntBre on 2025-06-12 04:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @ntBre on 2025-06-12 04:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_pyi/PYI041.py</code>:96 on 2025-06-12 10:45</div>
            <div class="timeline-body"><pre><code class="language-suggestion"># fix must not yield `None | None | ...` (TypeError)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_pyi/PYI041.pyi</code>:76 on 2025-06-12 10:46</div>
            <div class="timeline-body"><pre><code class="language-suggestion"># fix must not yield `None | None | ...` (TypeError)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_numeric_union.rs</code>:108 on 2025-06-12 10:46</div>
            <div class="timeline-body"><p>why is this commented out?</p>
<pre><code class="language-suggestion"></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/snapshots/ruff_linter__rules__flake8_pyi__tests__PYI041_PYI041.pyi.snap</code>:33 on 2025-06-12 10:50</div>
            <div class="timeline-body"><p>this is a clever way of fixing the issue, but I'm not totally sure that users will like it if the fix ends up reordering unions like this, even when the unions don't contain <code>None</code>. I think that would be pretty unexpected if I were a Ruff user.</p>
<p>I'm leaning towards just not providing a fix for the rule if there are multiple <code>None</code>s in the union. It feels easy to understand, and well-written code should never have multiple <code>None</code>s in a union anyway -- we even have other lints that would already detect that!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-12 10:50</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a> reviewed on 2025-06-12 11:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robsdedude">@robsdedude</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/snapshots/ruff_linter__rules__flake8_pyi__tests__PYI041_PYI041.pyi.snap</code>:33 on 2025-06-12 11:36</div>
            <div class="timeline-body"><p>Sure. Your project, your direction. I personally wouldn't be surprised. I've seen ruff fixes go beyond such changes. Further, I'd think of this more as merging elements in the union than reordering them. The PR will put the super-type in the place of the first type it's subsuming.</p>
<p>Anyway, I'll change the PR to just omit the fix. However, I suggest to only suppress the fix if not in a typing only context (as this is only a problem at runtime).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a> reviewed on 2025-06-12 12:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robsdedude">@robsdedude</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_numeric_union.rs</code>:1 on 2025-06-12 12:21</div>
            <div class="timeline-body"><p>While working on this fix, I've noticed that this checker is run before deferred string type annotations are visited and resolved. This means that the lint won't trigger on those. Not sure you'd want that to be changed or whether that's a deliberate design decision. Happy to pour this into an issue to tackle it later if you're interested.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a> reviewed on 2025-06-12 12:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robsdedude">@robsdedude</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_numeric_union.rs</code>:108 on 2025-06-12 12:35</div>
            <div class="timeline-body"><p>Left-over from an earlier approach :innocent:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @robsdedude on 2025-06-12 12:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @AlexWaygood on 2025-06-17 09:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_numeric_union.rs</code>:279 on 2025-06-20 18:30</div>
            <div class="timeline-body"><p>Do these get sorted somewhere? It's not obvious to me why just checking the first two would work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_pyi/PYI041_1.py</code>:111 on 2025-06-20 18:31</div>
            <div class="timeline-body"><p>This one is also not obvious to me. Why does this get a fix and <code>f1</code> doesn't?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_numeric_union.rs</code>:1 on 2025-06-20 18:37</div>
            <div class="timeline-body"><p>Yeah I think it makes sense to follow up on this, thanks! While testing this in the playground, I noticed that PYI016 <em>does</em> apply to string annotations, so you may be able to copy however it handles this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-20 18:37</div>
            <div class="timeline-body"><p>Thanks, I think this looks good overall. I just had a couple of questions to make sure I'm understanding what's going on.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dscorbett">@dscorbett</a> reviewed on 2025-06-20 19:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dscorbett">@dscorbett</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_numeric_union.rs</code>:279 on 2025-06-20 19:00</div>
            <div class="timeline-body"><p>There’s only a problem if the first two are <code>None</code>. Other combinations work fine.</p>
<pre><code class="language-pycon">&gt;&gt;&gt; None | int | None
None | int
&gt;&gt;&gt; int | None | None
int | None
&gt;&gt;&gt; None | None | int
Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
TypeError: unsupported operand type(s) for |: 'NoneType' and 'NoneType'
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-20 19:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_numeric_union.rs</code>:279 on 2025-06-20 19:02</div>
            <div class="timeline-body"><p>Oh gotcha, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-20 19:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_pyi/PYI041_1.py</code>:111 on 2025-06-20 19:03</div>
            <div class="timeline-body"><p>The answer to my other question resolved this one too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-06-20 19:04</div>
            <div class="timeline-body"><p>Questions resolved! I was just confused, as expected.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-06-20 19:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-06-20 19:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-24 20:52</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 18:39:35 UTC
    </footer>
</body>
</html>
