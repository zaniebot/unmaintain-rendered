<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pycodestyle`] Handle each cell separately for `too-many-newlines-at-end-of-file` (`W391`) - astral-sh/ruff #15308</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pycodestyle</code>] Handle each cell separately for <code>too-many-newlines-at-end-of-file</code> (<code>W391</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15308">#15308</a>
        opened by <a href="https://github.com/dylwil3">@dylwil3</a>
        on 2025-01-06 23:21
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a></div>
            <div class="timeline-body"><p>Jupyter notebooks are converted into source files by joining with newlines, which confuses the check <a href="https://docs.astral.sh/ruff/rules/too-many-newlines-at-end-of-file/#too-many-newlines-at-end-of-file-w391">too-many-newlines-at-end-of-file (W391)</a>. This PR introduces logic to apply the check cell-wise (and, in particular, correctly handles empty cells.)</p>
<p>Closes #13763</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-01-06 23:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-01-06 23:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">notebook</span> added by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-01-06 23:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-01-06 23:23</div>
            <div class="timeline-body"><p>One aesthetic question is whether internal cells should still be allowed to have a single trailing newline (at the moment this is what the fix produces/allows).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-06 23:27</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+2 -17 violations, +0 -0 fixes in 3 projects; 52 projects unchanged)</p>
<a href="https://github.com/PlasmaPy/PlasmaPy">PlasmaPy/PlasmaPy</a> (+0 -1 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
- docs/notebooks/dispersion/stix_dispersion.ipynb:cell 34:1:1: W391 [*] Extra newline at end of file
</pre>

</p>

<a href="https://github.com/bokeh/bokeh">bokeh/bokeh</a> (+2 -5 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ examples/output/jupyter/push_notebook/Basic Usage.ipynb:cell 14:1:1: W391 [*] Extra newline at end of cell
- examples/output/jupyter/push_notebook/Basic Usage.ipynb:cell 14:1:1: W391 [*] Too many newlines at end of file
- examples/output/jupyter/push_notebook/Continuous Updating.ipynb:cell 8:1:1: W391 [*] Extra newline at end of file
- examples/output/jupyter/push_notebook/Jupyter Interactors.ipynb:cell 8:1:1: W391 [*] Extra newline at end of file
- examples/output/jupyter/push_notebook/Numba Image Example.ipynb:cell 28:1:1: W391 [*] Extra newline at end of file
+ examples/server/api/notebook_embed.ipynb:cell 7:1:1: W391 [*] Extra newline at end of cell
- examples/server/api/notebook_embed.ipynb:cell 7:1:1: W391 [*] Too many newlines at end of file
</pre>

</p>

<a href="https://github.com/mlflow/mlflow">mlflow/mlflow</a> (+0 -11 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
- docs/source/llms/llm-evaluate/notebooks/question-answering-evaluation.ipynb:cell 29:1:1: W391 [*] Extra newline at end of file
- docs/source/llms/llm-evaluate/notebooks/rag-evaluation.ipynb:cell 19:1:1: W391 [*] Extra newline at end of file
- docs/source/llms/rag/notebooks/retriever-evaluation-tutorial.ipynb:cell 50:1:1: W391 [*] Extra newline at end of file
- docs/source/traditional-ml/hyperparameter-tuning-with-child-runs/notebooks/parent-child-runs.ipynb:cell 15:1:1: W391 [*] Extra newline at end of file
- docs/source/traditional-ml/serving-multiple-models-with-pyfunc/notebooks/MME_Tutorial.ipynb:cell 25:1:1: W391 [*] Extra newline at end of file
- examples/evaluation/qa-evaluation.ipynb:cell 29:1:1: W391 [*] Extra newline at end of file
- examples/evaluation/rag-evaluation.ipynb:cell 16:1:1: W391 [*] Extra newline at end of file
- examples/h2o/random_forest.ipynb:cell 6:1:1: W391 [*] Extra newline at end of file
- examples/llms/RAG/retriever-evaluation-tutorial.ipynb:cell 48:1:1: W391 [*] Extra newline at end of file
- examples/rapids/mlflow_project/notebooks/rapids_mlflow.ipynb:cell 14:1:1: W391 [*] Extra newline at end of file
- examples/sklearn_elasticnet_wine/train.ipynb:cell 6:1:1: W391 [*] Extra newline at end of file
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| W391 | 19 | 2 | 17 | 0 | 0 |</p>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pycodestyle/snapshots/ruff_linter__rules__pycodestyle__tests__preview__W391_W391.ipynb.snap</code>:4 on 2025-01-07 08:09</div>
            <div class="timeline-body"><p>I think we should change the message to: Too many newlines at the end of the cell</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pycodestyle/rules/too_many_newlines_at_end_of_file.rs</code>:10 on 2025-01-07 08:10</div>
            <div class="timeline-body"><p>We should extend the rule documentation to mention its behavior in a notebook context</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pycodestyle/rules/too_many_newlines_at_end_of_file.rs</code>:75 on 2025-01-07 08:15</div>
            <div class="timeline-body"><p>It feels like the only part that needs sharing between notebooks and regular documents is line 98 to 142. Would it make sense to extract this logic into its own function instead of &quot;faking&quot; a notebook for normal documents?</p>
<p>This would have the advantage that you can move the <code>cell_offsets.iter().rev</code> into <code>collect_trailing_newlines_diagnostics</code> (you probably want to rename that method), which, in turn, makes the comment about <code>offset_iter</code> being reverse obsolete.</p>
<p>I&#x27;d also expect that doing this would reduce the diff size.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pycodestyle/rules/too_many_newlines_at_end_of_file.rs</code>:96 on 2025-01-07 08:17</div>
            <div class="timeline-body"><p>Nit: You could use <code>tokens_iter.peeking_take_while</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-01-07 08:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-07 08:19</div>
            <div class="timeline-body"><blockquote>
<p>One aesthetic question is whether internal cells should still be allowed to have a single trailing newline (at the moment this is what the fix produces/allows).</p>
</blockquote>
<p>I think we should and doing so would be consistent with the formatter.</p>
<p>It would be very annoying if you write a cell with a newline at the end, hit save and Ruff fixes away the newline before you had a chance to write the next content.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-01-07 17:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-01-08 07:28</div>
            <div class="timeline-body"><p>Thanks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-01-09 16:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-01-09 16:50</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:10:03 UTC
    </footer>
</body>
</html>
