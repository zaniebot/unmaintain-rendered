<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detect unneeded `async` keywords on functions - astral-sh/ruff #9966</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Detect unneeded <code>async</code> keywords on functions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/9966">#9966</a>
        opened by <a href="https://github.com/plredmond">@plredmond</a>
        on 2024-02-13 00:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/plredmond">@plredmond</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This change adds a rule to detect functions declared <code>async</code> but lacking any of <code>await</code>, <code>async with</code>, or <code>async for</code>. This resolves #9951.</p>
<h2>Test Plan</h2>
<p>This change was tested by following https://docs.astral.sh/ruff/contributing/#rule-testing-fixtures-and-snapshots and adding positive and negative cases for each of <code>await</code> vs nothing, <code>async with</code> vs <code>with</code>, and <code>async for</code> vs <code>for</code>.</p>
<h2>Questions/todo</h2>
<ul>
<li>[x] I'm unsure whether the rule should also check for <code>yield</code> appearing in functions. My understanding is that there has been several rounds of iteration in how python async is supposed to be done, and that <code>yield</code> is not considered current, and so I haven't added a case for that. Therefore an <code>async</code> function containing only <code>yield</code> will cause this rule to fire.<ul>
<li>resolved by &quot;async doesn't require yield&quot; so the rule will fire when an async function's only async feature is yield</li>
<li>https://github.com/astral-sh/ruff/pull/9966#issuecomment-2044527147</li>
<li>https://github.com/astral-sh/ruff/pull/9966#pullrequestreview-2002255367</li>
</ul>
</li>
<li>[x] I was unsure how to access just the range of the function declaration (without the body), so the rule currently indicates the whole function declaration &amp; body as the problem area.</li>
<li>~~[ ] Needs review by @zanieb~~</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/plredmond">@plredmond</a> on 2024-02-13 00:05</div>
            <div class="timeline-body"><p>Sorry, I neglected formatting and linting of the rust code. I'll do that now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-02-13 00:13</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+314 -0 violations, +0 -0 fixes in 5 projects; 39 projects unchanged)</p>
<details><summary><a href="https://github.com/DisnakeDev/disnake">DisnakeDev/disnake</a> (+65 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/DisnakeDev/disnake/blob/5e2ced2aa08a85ff555eb79bf70119bfa077e846/disnake/ext/commands/core.py#L1722'>disnake/ext/commands/core.py:1722:19:</a> RUF029 Function `wrapper` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/DisnakeDev/disnake/blob/5e2ced2aa08a85ff555eb79bf70119bfa077e846/disnake/utils.py#L522'>disnake/utils.py:522:11:</a> RUF029 Function `_assetbytes_to_base64_data` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/DisnakeDev/disnake/blob/5e2ced2aa08a85ff555eb79bf70119bfa077e846/disnake/utils.py#L527'>disnake/utils.py:527:11:</a> RUF029 Function `_assetbytes_to_base64_data` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/DisnakeDev/disnake/blob/5e2ced2aa08a85ff555eb79bf70119bfa077e846/examples/basic_bot.py#L81'>examples/basic_bot.py:81:11:</a> RUF029 Function `on_ready` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/DisnakeDev/disnake/blob/5e2ced2aa08a85ff555eb79bf70119bfa077e846/examples/basic_voice.py#L136'>examples/basic_voice.py:136:11:</a> RUF029 Function `on_ready` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/DisnakeDev/disnake/blob/5e2ced2aa08a85ff555eb79bf70119bfa077e846/examples/converters.py#L77'>examples/converters.py:77:11:</a> RUF029 Function `on_ready` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/DisnakeDev/disnake/blob/5e2ced2aa08a85ff555eb79bf70119bfa077e846/examples/edit_delete.py#L52'>examples/edit_delete.py:52:11:</a> RUF029 Function `on_ready` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/DisnakeDev/disnake/blob/5e2ced2aa08a85ff555eb79bf70119bfa077e846/examples/guessing_game.py#L39'>examples/guessing_game.py:39:11:</a> RUF029 Function `on_ready` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/DisnakeDev/disnake/blob/5e2ced2aa08a85ff555eb79bf70119bfa077e846/examples/interactions/autocomplete.py#L25'>examples/interactions/autocomplete.py:25:11:</a> RUF029 Function `autocomplete_langs` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/DisnakeDev/disnake/blob/5e2ced2aa08a85ff555eb79bf70119bfa077e846/examples/interactions/autocomplete.py#L31'>examples/interactions/autocomplete.py:31:11:</a> RUF029 Function `languages_1` is declared `async`, but doesn't `await` or use `async` features.
... 55 additional changes omitted for project
</pre>

</p>
</details>
<details><summary><a href="https://github.com/RasaHQ/rasa">RasaHQ/rasa</a> (+168 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/RasaHQ/rasa/blob/7807b19ad5fffab73ca1a04dc710f812115a9288/rasa/core/channels/botframework.py#L293'>rasa/core/channels/botframework.py:293:19:</a> RUF029 Function `health` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/RasaHQ/rasa/blob/7807b19ad5fffab73ca1a04dc710f812115a9288/rasa/core/channels/callback.py#L68'>rasa/core/channels/callback.py:68:19:</a> RUF029 Function `health` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/RasaHQ/rasa/blob/7807b19ad5fffab73ca1a04dc710f812115a9288/rasa/core/channels/console.py#L106'>rasa/core/channels/console.py:106:11:</a> RUF029 Function `_get_user_input` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/RasaHQ/rasa/blob/7807b19ad5fffab73ca1a04dc710f812115a9288/rasa/core/channels/console.py#L111'>rasa/core/channels/console.py:111:11:</a> RUF029 Function `_get_user_input` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/RasaHQ/rasa/blob/7807b19ad5fffab73ca1a04dc710f812115a9288/rasa/core/channels/facebook.py#L359'>rasa/core/channels/facebook.py:359:19:</a> RUF029 Function `health` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/RasaHQ/rasa/blob/7807b19ad5fffab73ca1a04dc710f812115a9288/rasa/core/channels/facebook.py#L363'>rasa/core/channels/facebook.py:363:19:</a> RUF029 Function `token_verification` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/RasaHQ/rasa/blob/7807b19ad5fffab73ca1a04dc710f812115a9288/rasa/core/channels/hangouts.py#L295'>rasa/core/channels/hangouts.py:295:19:</a> RUF029 Function `health` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/RasaHQ/rasa/blob/7807b19ad5fffab73ca1a04dc710f812115a9288/rasa/core/channels/mattermost.py#L208'>rasa/core/channels/mattermost.py:208:19:</a> RUF029 Function `health` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/RasaHQ/rasa/blob/7807b19ad5fffab73ca1a04dc710f812115a9288/rasa/core/channels/rest.py#L138'>rasa/core/channels/rest.py:138:19:</a> RUF029 Function `health` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/RasaHQ/rasa/blob/7807b19ad5fffab73ca1a04dc710f812115a9288/rasa/core/channels/rocketchat.py#L148'>rasa/core/channels/rocketchat.py:148:19:</a> RUF029 Function `health` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/RasaHQ/rasa/blob/7807b19ad5fffab73ca1a04dc710f812115a9288/rasa/core/channels/slack.py#L503'>rasa/core/channels/slack.py:503:19:</a> RUF029 Function `health` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/RasaHQ/rasa/blob/7807b19ad5fffab73ca1a04dc710f812115a9288/rasa/core/channels/socketio.py#L198'>rasa/core/channels/socketio.py:198:19:</a> RUF029 Function `health` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/RasaHQ/rasa/blob/7807b19ad5fffab73ca1a04dc710f812115a9288/rasa/core/channels/socketio.py#L202'>rasa/core/channels/socketio.py:202:19:</a> RUF029 Function `connect` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/RasaHQ/rasa/blob/7807b19ad5fffab73ca1a04dc710f812115a9288/rasa/core/channels/socketio.py#L220'>rasa/core/channels/socketio.py:220:19:</a> RUF029 Function `disconnect` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/RasaHQ/rasa/blob/7807b19ad5fffab73ca1a04dc710f812115a9288/rasa/core/channels/telegram.py#L202'>rasa/core/channels/telegram.py:202:19:</a> RUF029 Function `health` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/RasaHQ/rasa/blob/7807b19ad5fffab73ca1a04dc710f812115a9288/rasa/core/channels/twilio.py#L126'>rasa/core/channels/twilio.py:126:19:</a> RUF029 Function `health` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/RasaHQ/rasa/blob/7807b19ad5fffab73ca1a04dc710f812115a9288/rasa/core/channels/twilio_voice.py#L233'>rasa/core/channels/twilio_voice.py:233:19:</a> RUF029 Function `health` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/RasaHQ/rasa/blob/7807b19ad5fffab73ca1a04dc710f812115a9288/rasa/core/channels/webexteams.py#L102'>rasa/core/channels/webexteams.py:102:19:</a> RUF029 Function `health` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/RasaHQ/rasa/blob/7807b19ad5fffab73ca1a04dc710f812115a9288/rasa/core/jobs.py#L13'>rasa/core/jobs.py:13:11:</a> RUF029 Function `scheduler` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/RasaHQ/rasa/blob/7807b19ad5fffab73ca1a04dc710f812115a9288/rasa/core/run.py#L129'>rasa/core/run.py:129:15:</a> RUF029 Function `configure_async_logging` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/RasaHQ/rasa/blob/7807b19ad5fffab73ca1a04dc710f812115a9288/rasa/core/run.py#L292'>rasa/core/run.py:292:11:</a> RUF029 Function `create_connection_pools` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/RasaHQ/rasa/blob/7807b19ad5fffab73ca1a04dc710f812115a9288/rasa/core/training/interactive.py#L1630'>rasa/core/training/interactive.py:1630:15:</a> RUF029 Function `ignore_404s` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/RasaHQ/rasa/blob/7807b19ad5fffab73ca1a04dc710f812115a9288/rasa/server.py#L1264'>rasa/server.py:1264:15:</a> RUF029 Function `tracker_predict` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/RasaHQ/rasa/blob/7807b19ad5fffab73ca1a04dc710f812115a9288/rasa/server.py#L1365'>rasa/server.py:1365:15:</a> RUF029 Function `unload_model` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/RasaHQ/rasa/blob/7807b19ad5fffab73ca1a04dc710f812115a9288/rasa/server.py#L1376'>rasa/server.py:1376:15:</a> RUF029 Function `get_domain` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/RasaHQ/rasa/blob/7807b19ad5fffab73ca1a04dc710f812115a9288/rasa/server.py#L403'>rasa/server.py:403:11:</a> RUF029 Function `authenticate` is declared `async`, but doesn't `await` or use `async` features.
... 142 additional changes omitted for project
</pre>

</p>
</details>
<details><summary><a href="https://github.com/apache/airflow">apache/airflow</a> (+12 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/apache/airflow/blob/4a288460a501364cd228c4b2f7a24401c4c4e992/tests/providers/apache/livy/hooks/test_livy.py#L508'>tests/providers/apache/livy/hooks/test_livy.py:508:19:</a> RUF029 Function `mock_fun` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/apache/airflow/blob/4a288460a501364cd228c4b2f7a24401c4c4e992/tests/providers/apache/livy/hooks/test_livy.py#L531'>tests/providers/apache/livy/hooks/test_livy.py:531:19:</a> RUF029 Function `mock_fun` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/apache/airflow/blob/4a288460a501364cd228c4b2f7a24401c4c4e992/tests/providers/apache/livy/hooks/test_livy.py#L556'>tests/providers/apache/livy/hooks/test_livy.py:556:19:</a> RUF029 Function `mock_fun` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/apache/airflow/blob/4a288460a501364cd228c4b2f7a24401c4c4e992/tests/providers/apache/livy/hooks/test_livy.py#L597'>tests/providers/apache/livy/hooks/test_livy.py:597:19:</a> RUF029 Function `mock_fun` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/apache/airflow/blob/4a288460a501364cd228c4b2f7a24401c4c4e992/tests/providers/apache/livy/hooks/test_livy.py#L616'>tests/providers/apache/livy/hooks/test_livy.py:616:19:</a> RUF029 Function `mock_fun` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/apache/airflow/blob/4a288460a501364cd228c4b2f7a24401c4c4e992/tests/providers/cncf/kubernetes/triggers/test_pod.py#L76'>tests/providers/cncf/kubernetes/triggers/test_pod.py:76:15:</a> RUF029 Function `mock_read_namespaced_pod` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/apache/airflow/blob/4a288460a501364cd228c4b2f7a24401c4c4e992/tests/providers/google/cloud/hooks/test_cloud_batch.py#L322'>tests/providers/google/cloud/hooks/test_cloud_batch.py:322:19:</a> RUF029 Function `_get_job` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/apache/airflow/blob/4a288460a501364cd228c4b2f7a24401c4c4e992/tests/providers/google/cloud/hooks/test_dataproc.py#L68'>tests/providers/google/cloud/hooks/test_dataproc.py:68:11:</a> RUF029 Function `mock_awaitable` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/apache/airflow/blob/4a288460a501364cd228c4b2f7a24401c4c4e992/tests/providers/google/cloud/triggers/test_cloud_batch.py#L137'>tests/providers/google/cloud/triggers/test_cloud_batch.py:137:19:</a> RUF029 Function `_mock_job` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/apache/airflow/blob/4a288460a501364cd228c4b2f7a24401c4c4e992/tests/providers/google/cloud/triggers/test_cloud_run.py#L109'>tests/providers/google/cloud/triggers/test_cloud_run.py:109:19:</a> RUF029 Function `_mock_operation` is declared `async`, but doesn't `await` or use `async` features.
... 2 additional changes omitted for project
</pre>

</p>
</details>
<details><summary><a href="https://github.com/python/typeshed">python/typeshed</a> (+65 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select E,F,FA,I,PYI,RUF,UP,W</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/python/typeshed/blob/7d56cd9a6cf6e0a4ea89c68d0397e197aff32cbe/stdlib/asyncio/staggered.pyi#L8'>stdlib/asyncio/staggered.pyi:8:11:</a> RUF029 Function `staggered_race` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/python/typeshed/blob/7d56cd9a6cf6e0a4ea89c68d0397e197aff32cbe/stdlib/asyncio/streams.pyi#L29'>stdlib/asyncio/streams.pyi:29:15:</a> RUF029 Function `open_connection` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/python/typeshed/blob/7d56cd9a6cf6e0a4ea89c68d0397e197aff32cbe/stdlib/asyncio/streams.pyi#L37'>stdlib/asyncio/streams.pyi:37:15:</a> RUF029 Function `start_server` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/python/typeshed/blob/7d56cd9a6cf6e0a4ea89c68d0397e197aff32cbe/stdlib/asyncio/streams.pyi#L48'>stdlib/asyncio/streams.pyi:48:15:</a> RUF029 Function `open_connection` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/python/typeshed/blob/7d56cd9a6cf6e0a4ea89c68d0397e197aff32cbe/stdlib/asyncio/streams.pyi#L57'>stdlib/asyncio/streams.pyi:57:15:</a> RUF029 Function `start_server` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/python/typeshed/blob/7d56cd9a6cf6e0a4ea89c68d0397e197aff32cbe/stdlib/asyncio/streams.pyi#L70'>stdlib/asyncio/streams.pyi:70:19:</a> RUF029 Function `open_unix_connection` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/python/typeshed/blob/7d56cd9a6cf6e0a4ea89c68d0397e197aff32cbe/stdlib/asyncio/streams.pyi#L73'>stdlib/asyncio/streams.pyi:73:19:</a> RUF029 Function `start_unix_server` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/python/typeshed/blob/7d56cd9a6cf6e0a4ea89c68d0397e197aff32cbe/stdlib/asyncio/streams.pyi#L77'>stdlib/asyncio/streams.pyi:77:19:</a> RUF029 Function `open_unix_connection` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/python/typeshed/blob/7d56cd9a6cf6e0a4ea89c68d0397e197aff32cbe/stdlib/asyncio/streams.pyi#L80'>stdlib/asyncio/streams.pyi:80:19:</a> RUF029 Function `start_unix_server` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/python/typeshed/blob/7d56cd9a6cf6e0a4ea89c68d0397e197aff32cbe/stdlib/asyncio/subprocess.pyi#L104'>stdlib/asyncio/subprocess.pyi:104:15:</a> RUF029 Function `create_subprocess_shell` is declared `async`, but doesn't `await` or use `async` features.
... 55 additional changes omitted for project
</pre>

</p>
</details>
<details><summary><a href="https://github.com/zulip/zulip">zulip/zulip</a> (+4 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/zulip/zulip/blob/16a08a8b6b35f11cdc27410ef80043a2b8025563/zerver/lib/push_notifications.py#L183'>zerver/lib/push_notifications.py:183:15:</a> RUF029 Function `err_func` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/zulip/zulip/blob/16a08a8b6b35f11cdc27410ef80043a2b8025563/zerver/lib/push_notifications.py#L188'>zerver/lib/push_notifications.py:188:15:</a> RUF029 Function `make_apns` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/zulip/zulip/blob/16a08a8b6b35f11cdc27410ef80043a2b8025563/zerver/tornado/event_queue.py#L687'>zerver/tornado/event_queue.py:687:11:</a> RUF029 Function `setup_event_queue` is declared `async`, but doesn't `await` or use `async` features.
+ <a href='https://github.com/zulip/zulip/blob/16a08a8b6b35f11cdc27410ef80043a2b8025563/zerver/tornado/views.py#L42'>zerver/tornado/views.py:42:15:</a> RUF029 Function `wrapped` is declared `async`, but doesn't `await` or use `async` features.
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| RUF029 | 314 | 314 | 0 | 0 | 0 |</p>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-02-13 00:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF029.py</code>:4 on 2024-02-13 00:48</div>
            <div class="timeline-body"><p>Usually we'd indicate this with something like</p>
<pre><code class="language-suggestion">async def pass_case(): # OK: awaits a coroutine
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-02-13 00:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF029.py</code>:4 on 2024-02-13 00:48</div>
            <div class="timeline-body"><p>It's not really standardized though, so it's okay either way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-02-13 00:52</div>
            <div class="timeline-body"><p>The <code>rasa</code> ecosystem checks look like a bunch of false positives due to methods that are overriding an <a href="https://github.com/RasaHQ/rasa/blob/cca30d4e06af5aba177e916d64c60313fc537005/rasa/core/actions/action.py#L241-L263">abstract method which must be async</a>. This common enough that we should attempt to avoid it, but it requires multifile analysis in most cases which we do not yet support yet. There are some other issues like this, but I can't recall them — perhaps @charliermarsh knows. We could consider just not applying this to methods in classes with base classes for now?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-13 00:54</div>
            <div class="timeline-body"><p>Ah yeah, the thing we often do there (at the very least) is check if the method has an <code>@override</code> decorator (can grep for <code>is_override</code>), since that's used to hint to static analysis tools that the method doesn't have control over its own signature. So users at least have a way to opt-out of these kinds of rules entirely for methods that override a parent method. I would be fine omitting this entirely for classes with base classes though (or even classes at all?).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-02-13 00:55</div>
            <div class="timeline-body"><p>Here's another interesting edge-case false positive https://github.com/zulip/zulip/blob/35098f49597895718343091881fbd6198bd2022d/zerver/tornado/views.py#L35 — this one I'm less sure we can/should do anything about.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-02-13 01:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_linter/src/rules/ruff/rules/spurious_async.rs</code>:16 on 2024-02-13 01:00</div>
            <div class="timeline-body"><p>I think we'll want to include an example here too</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF029.py</code>:49 on 2024-02-13 01:02</div>
            <div class="timeline-body"><p>Do you mind running <code>ruff format</code> over this file, just to standardize the comment spacing, lines between functions, etc.? (We don't <em>always</em> run it over fixtures, since fixtures sometimes include intentionally-odd comments and syntax, but this one doesn't, so seems like a nice improvement.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/checkers/ast/analyze/statement.rs</code>:370 on 2024-02-13 01:03</div>
            <div class="timeline-body"><p>For newer rules, we're trying to pass the entire node (like <code>function_def</code>, above), to ensure that callers can't pass in &quot;incorrect&quot; data. Do you mind revising the signature?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-02-13 01:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_linter/src/rules/ruff/rules/spurious_async.rs</code>:16 on 2024-02-13 01:04</div>
            <div class="timeline-body"><p>You can also probably say &quot;will limit the contexts&quot; instead of &quot;may artificially limit&quot;.</p>
<p>There's also something to be said about it actually being <em>bad</em> to say that your function is async without it containing a yield as it's breaking the fundamental promise of the async label. Some more context on this idea <a href="https://trio.readthedocs.io/en/stable/reference-core.html#checkpoints">in the trio documentation</a>. I'm not sure if we can get into that without confusing users though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/ruff/rules/spurious_async.rs</code>:80 on 2024-02-13 01:04</div>
            <div class="timeline-body"><p>Ahh, if you have the <code>function_def: &amp;ast::StmtFunctionDef</code> as an argument to this method, you can use <code>function_def.identifier()</code> to get <em>just</em> the range of the function name (per your PR summary).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-13 01:05</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-02-13 01:15</div>
            <div class="timeline-body"><p>Perhaps @AlexWaygood can elucidate whether or not this should trigger for functions with <code>yield</code>.</p>
<p>https://peps.python.org/pep-0525 may be helpful.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/spurious_async.rs</code>:32 on 2024-02-13 16:28</div>
            <div class="timeline-body"><p>Nit: I first assumed that the visitor only searches for <code>yield</code> expressions because of its name and the variable's name. Maybe consider renaming the visitor and the variable field.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/spurious_async.rs</code>:35 on 2024-02-13 16:30</div>
            <div class="timeline-body"><p>This visitor is somewhat expensive because it has to traverse the entire sub-tree of the function to the end, even when it has already found a <code>yield</code> or <code>await</code>able.</p>
<p>You could consider implementing <code>PreorderVisitor</code> instead. It differs from <code>Visitor</code> that it visits the fields in the source order instead of semantical ordering (not important in this case) and that it has a <code>enter_node</code> function which can either return <code>TraverseSignal::Traverse</code> to continue traversing or <code>TraverseSignal::Skip</code> to stop traversing, which we could return here when <code>found_yield</code> is <code>true</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/spurious_async.rs</code>:70 on 2024-02-13 16:30</div>
            <div class="timeline-body"><p>Nit: You could derive <code>Default</code> for <code>YieldingExprVisitor</code> so that this becomes</p>
<pre><code class="language-suggestion">        let mut visitor = YieldingExprVisitor::default();
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/spurious_async.rs</code>:65 on 2024-02-13 16:33</div>
            <div class="timeline-body"><p>This is a Python noob question from a JS engineer. How does Python handle default arguments? Can you use <code>await</code> in a default initializer? Does this count as async call (because it pauses the function execution) or not because defaults are initialized once during declaration and not when calling the function.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-02-13 16:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/ruff/rules/spurious_async.rs</code>:65 on 2024-02-13 16:40</div>
            <div class="timeline-body"><p>That's a fun question that I'd never considered before.</p>
<p><code>await</code> isn't allowed at the top-level in a usual Python file (only inside async functions), so normally this isn't really something that would ever come up, since function defaults are evaluated in the scope the function is in rather than the scope the function creates:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; import asyncio
&gt;&gt;&gt; async def foo(x=await asyncio.sleep(0.1)): ...
...
  File &quot;&lt;stdin&gt;&quot;, line 1
SyntaxError: 'await' outside function
</code></pre>
<p>But theoretically you could use <code>await</code> in a function default argument if it was an inner function inside an async function:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; import asyncio
&gt;&gt;&gt; async def foo():
...     def bar(x=await asyncio.sleep(0.1)): ...
...     return bar
...
&gt;&gt;&gt; bar = asyncio.run(foo())
&gt;&gt;&gt; import inspect
&gt;&gt;&gt; inspect.iscoroutinefunction(bar)
False
&gt;&gt;&gt; type(bar)
&lt;class 'function'&gt;
</code></pre>
<p>As you can see from that REPL snippet, using <code>await</code> inside the default argument for the inner function doesn't impact whether or not the inner function is considered to be a coroutine function, since the <code>await</code> in the function's default argument is evaluated before the function has even finished being defined.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-02-13 16:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-02-13 16:48</div>
            <div class="timeline-body"><blockquote>
<p>Perhaps @AlexWaygood can elucidate whether or not this should trigger for functions with <code>yield</code>.</p>
<p><a href="https://peps.python.org/pep-0525">peps.python.org/pep-0525</a> may be helpful.</p>
</blockquote>
<p>Yeah, async functions that contain <code>yield</code> are async generators that can be used in <code>async for</code> loops by other async functions. So I don't think ruff should emit this diagnostic for async functions that have a <code>yield</code> in them:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; import asyncio
&gt;&gt;&gt; async def x():
...     yield 42
...     yield 56
...
&gt;&gt;&gt; x
&lt;function x at 0x00000274CDC52200&gt;
&gt;&gt;&gt; x()
&lt;async_generator object x at 0x00000274CC36BE20&gt;
&gt;&gt;&gt; async def y():
...     async for number in x():
...         print(number)
...
&gt;&gt;&gt; asyncio.run(y())
42
56
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-02-13 17:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/spurious_async.rs</code>:65 on 2024-02-13 17:10</div>
            <div class="timeline-body"><p>Thanks for the detailed explanation.</p>
<p>I tested if <code>foo</code> is considered a co-routine and that seems to be the case. Do you know if that's only because the function is marked as <code>async</code>?</p>
<pre><code class="language-python">&gt;&gt;&gt; import asyncio
&gt;&gt;&gt; async def foo():
...     def bar(x=await asyncio.sleep(0.1)): ...
...     return bar
... 
&gt;&gt;&gt; import inspect
&gt;&gt;&gt; inspect.iscoroutinefunction(foo)
True
</code></pre>
<p>I'm trying to understand if the use of <code>async</code> on <code>foo</code> is something this lint rule should warn about or not.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-02-13 17:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/ruff/rules/spurious_async.rs</code>:65 on 2024-02-13 17:16</div>
            <div class="timeline-body"><p><code>foo</code> is considered a coroutine function because it's a function that returns a coroutine ;)</p>
<pre><code class="language-pycon">&gt;&gt;&gt; foo
&lt;function foo at 0x00000274CBC2A160&gt;
&gt;&gt;&gt; foo()
&lt;coroutine object foo at 0x00000274CDC19300&gt;
</code></pre>
<p>But the short answer to your question is &quot;yes&quot; -- all <code>async def</code> functions are &quot;coroutine functions&quot; -- functions that return coroutine objects that can then be <code>await</code>ed inside other coroutine functions.</p>
<p>The use of <code>async</code> on <code>foo</code> should not be something that this lint rule warn about, because the <code>await</code> expression in the default for the <code>x</code> parameter of <code>bar</code> is executed within the scope of <code>foo</code>. So removing the <code>async</code> on <code>foo</code> would mean that that <code>await</code> expression would no longer be found in an async context (== illegal syntax).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-02-13 17:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/spurious_async.rs</code>:65 on 2024-02-13 17:20</div>
            <div class="timeline-body"><p>Perfect. That's what this lint rule should support already today. It might be worth to copy the example as a test case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/plredmond">@plredmond</a> reviewed on 2024-02-13 18:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/plredmond">@plredmond</a> on <code>crates/ruff_linter/src/rules/ruff/rules/spurious_async.rs</code>:32 on 2024-02-13 18:37</div>
            <div class="timeline-body"><p>I originally used &quot;yielding_expression&quot;. Does that name seem acceptable?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/plredmond">@plredmond</a> reviewed on 2024-02-13 18:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/plredmond">@plredmond</a> on <code>crates/ruff_linter/src/rules/ruff/rules/spurious_async.rs</code>:70 on 2024-02-13 18:38</div>
            <div class="timeline-body"><p>Yes, I followed that pattern in an earlier draft when the field was a vector of yielding-expression-TextRanges, but reverted to explicit construction when I changed it to a boolean. Is the convention to always prefer default where applicable?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/spurious_async.rs</code>:70 on 2024-02-13 18:40</div>
            <div class="timeline-body"><p>There's no strong convention for private types. For public types, yes, I would say we prefer using <code>::default</code> or <code>::new</code> to encapsulate the initialization logic. Here I would do it because it's less to type but that's also why it is a Nit. It's up to you what you prefer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-02-13 18:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-02-13 18:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/spurious_async.rs</code>:32 on 2024-02-13 18:46</div>
            <div class="timeline-body"><p>Good question. <code>yield</code> or <code>yielding</code> is too close to the <code>yield</code> expression semantics. I would probably be explicit and call it <code>awaits_or_yields</code> or <code>found_await_or_yield</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-13 18:48</div>
            <div class="timeline-body"><p>I think there's one issue that we might need to look into and it's that the visitor will cross function boundaries when searching for <code>await</code> and <code>yield</code>, resulting in false negatives</p>
<pre><code class="language-python">async def unnecessary_async():
	async def inner():
		await x

async def unnecessary_async2():
	class Inner:
		async def inner():	
			await x


</code></pre>
<p>I don't think the rule flags <code>unnecessary_async</code> or <code>unnecessary_async2</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/plredmond">@plredmond</a> on 2024-02-13 18:50</div>
            <div class="timeline-body"><p>Thanks for your review! I've looked over the comments above and can work on the changes later today. I need to devote this morning to a different task.</p>
<blockquote>
<p>Ah yeah, the thing we often do there (at the very least) is check if the method has an <code>@override</code> decorator (can grep for <code>is_override</code>), since that's used to hint to static analysis tools that the method doesn't have control over its own signature. So users at least have a way to opt-out of these kinds of rules entirely for methods that override a parent method. I would be fine omitting this entirely for classes with base classes though (or even classes at all?).</p>
</blockquote>
<p>@charliermarsh should I omit this check in both the cases (1) in the context of a class or (2) when the override decorator is present? Based on your description, it seems preferable to limit case (1) to classes with a base class, since they're actually likely to be overriding things, though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/plredmond">@plredmond</a> on 2024-02-13 19:05</div>
            <div class="timeline-body"><blockquote>
<p>I don't think the rule flags <code>unnecessary_async</code> or <code>unnecessary_async2</code>.</p>
</blockquote>
<p>@MichaReiser These examples make the problem a bit harder. :slightly_smiling_face: I need to check if the visitor has a callback for when an inner-function ends; I could use that to track which scope I'm in when detecting yielding-expressions to attribute them correctly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/plredmond">@plredmond</a> reviewed on 2024-02-13 19:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/plredmond">@plredmond</a> on <code>crates/ruff_linter/src/rules/ruff/rules/spurious_async.rs</code>:35 on 2024-02-13 19:07</div>
            <div class="timeline-body"><p>Combined with your point about nested-functions (e.g. <code>unnecessary_async2</code>) from <a href="https://github.com/astral-sh/ruff/pull/9966#issuecomment-1942180352">this comment</a>, I need to rethink my approach a bit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-13 20:36</div>
            <div class="timeline-body"><p>@plredmond I think there are only two cases where this is relevant: classes and functions. You could extend your visitor to handle <code>visit_stmt explicitly</code> and traverse classes and functions manually (don't call <code>walk_stmt</code>). This allows you to skip traversing the body (you still want to traverse decorators and the function header)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/plredmond">@plredmond</a> on 2024-03-05 05:56</div>
            <div class="timeline-body"><p>Hi! Sorry to let this PR languish. I have a paper deadline just before I start my astral internship, so I have to put this on ice until then.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">accepted</span> added by @MichaReiser on 2024-04-05 10:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-04-05 10:29</div>
            <div class="timeline-body"><p>IMO, <code>unused-async</code> is easier to understand than spurious (which I mainly associate with threading). It also fits well into other rules that catch &quot;unused&quot; syntax.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-04-09 09:16</div>
            <div class="timeline-body"><blockquote>
<p>Yeah, async functions that contain <code>yield</code> are async generators that can be used in <code>async for</code> loops by other async functions. So I don't think ruff should emit this diagnostic for async functions that have a <code>yield</code> in them:</p>
</blockquote>
<p>So, I chatted to @carljm about this offline... and he persuaded me that the rationale I gave in https://github.com/astral-sh/ruff/pull/9966#issuecomment-1941990446 for excluding async generators from this check <em>basically</em> makes no sense :-)</p>
<p>It's true that removing the <code>async</code> keyword from a function with a <code>yield</code> statement in it will mean that it will become a sync generator function rather than an async generator function. That means that it will only be usable in <code>for</code> loops, not <code>async for</code> loops, which means callsites of the function will have to be rewritten to use <code>for</code> loops rather than <code>async for</code> loops -- potentially a sweeping and disruptive refactor. <em>However</em>... that's not really materially different from the changes this rule recommends to non-generator functions. Removing redundant <code>async</code> keywords from non-generator functions that don't have any <code>await</code>s in them will <em>also</em> necessitate callsites being refactored: you'll have to do this refactor everywhere:</p>
<pre><code class="language-diff">- x = await function_in_question()
+ x = function_in_question()
</code></pre>
<p>As such, I'm now persuaded that there's no reason to exclude async generator functions from this check. (Thanks @carljm!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/plredmond">@plredmond</a> on 2024-04-15 16:45</div>
            <div class="timeline-body"><p>Picking this up today. Sorry for the delay.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/plredmond">@plredmond</a> on 2024-04-15 19:19</div>
            <div class="timeline-body"><blockquote>
<p>IMO, <code>unused-async</code> is easier to understand than spurious (which I mainly associate with threading). It also fits well into other rules that catch &quot;unused&quot; syntax.</p>
</blockquote>
<p>Saving this rename for last b/c it'll disrupt the above comments on diffs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/plredmond">@plredmond</a> reviewed on 2024-04-15 21:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/plredmond">@plredmond</a> on <code>crates/ruff_linter/src/rules/ruff/rules/spurious_async.rs</code>:80 on 2024-04-15 21:34</div>
            <div class="timeline-body"><p>Is it desirable for the error message to only indicate the name, given that the problem is to the left of the name (the use of the <code>async</code> keyword) and to the right of it (the function body lacking a reason for the use of the <code>async</code> keyword)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/plredmond">@plredmond</a> on 2024-04-15 21:49</div>
            <div class="timeline-body"><p>I've made a bunch of smaller/cosmetic changes per the comments above. Additionally, I've added four new test cases (two pass, and two fail). <strong>Note, that the tests do not pass right now, because i need to implement the changes.</strong> The remaining work is:</p>
<ul>
<li>make the new test cases pass<ul>
<li>~~change the rule to <em>not</em> fire when an <code>async</code> function contains a <code>yield</code>~~ (this was switched to fire, per @carljm &amp; @AlexWaygood)</li>
<li>change the rule to fire when an <code>async</code> function using no async features contains an <code>async</code> function which does</li>
<li>change the rule to fire when an <code>async</code> function using no async features contains a class with an <code>async</code> function which does</li>
<li>skip applying this rule to class methods entirely and make an issue to track doing so in a limited way (per @zanieb)</li>
</ul>
</li>
<li>fix the visitor to stop traversing early when it finds a problem</li>
<li>rename &quot;spurious async&quot; to &quot;unused async&quot; throughout</li>
</ul>
<p>Could somebody take a look at the two pass-cases and fail-cases that I just added and confirm that this is the desired behavior?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/plredmond">@plredmond</a> reviewed on 2024-04-15 21:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/plredmond">@plredmond</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF029.py</code>:4 on 2024-04-15 21:54</div>
            <div class="timeline-body"><p>I've made this change below.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/plredmond">@plredmond</a> reviewed on 2024-04-15 21:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/plredmond">@plredmond</a> on <code>crates/ruff_linter/src/rules/ruff/rules/spurious_async.rs</code>:16 on 2024-04-15 21:55</div>
            <div class="timeline-body"><p>I've made this change below.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/plredmond">@plredmond</a> reviewed on 2024-04-15 21:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/plredmond">@plredmond</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF029.py</code>:49 on 2024-04-15 21:56</div>
            <div class="timeline-body"><p>Formatted!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/plredmond">@plredmond</a> reviewed on 2024-04-15 21:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/plredmond">@plredmond</a> on <code>crates/ruff_linter/src/checkers/ast/analyze/statement.rs</code>:370 on 2024-04-15 21:56</div>
            <div class="timeline-body"><p>I've made this change below.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/plredmond">@plredmond</a> reviewed on 2024-04-15 21:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/plredmond">@plredmond</a> on <code>crates/ruff_linter/src/rules/ruff/rules/spurious_async.rs</code>:32 on 2024-04-15 21:56</div>
            <div class="timeline-body"><p>I've made this rename change below.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/plredmond">@plredmond</a> reviewed on 2024-04-15 21:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/plredmond">@plredmond</a> on <code>crates/ruff_linter/src/rules/ruff/rules/spurious_async.rs</code>:70 on 2024-04-15 21:57</div>
            <div class="timeline-body"><p>I've made this change below.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/plredmond">@plredmond</a> reviewed on 2024-04-15 21:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/plredmond">@plredmond</a> on <code>crates/ruff_linter/src/rules/ruff/rules/spurious_async.rs</code>:65 on 2024-04-15 21:59</div>
            <div class="timeline-body"><p>I've added a test case (which should pass, without causing the rule to fire) where an async function defines an inner function by setting the inner function's default argument value to the result of an await expression, below. Implementing it is todo.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF029.py</code>:45 on 2024-04-15 22:02</div>
            <div class="timeline-body"><p>For the reasons mentioned in  @AlexWaygood's most recent comment, this case should fire <code>RUF029</code> -- yielding a value does not require an async function.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF029.py</code>:56 on 2024-04-15 22:03</div>
            <div class="timeline-body"><p>and &quot;or yield&quot; should be removed from the comments here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_linter/src/rules/ruff/rules/spurious_async.rs</code>:38 on 2024-04-15 22:04</div>
            <div class="timeline-body"><p>and &quot;yield or&quot; should be removed from this error message</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-04-15 22:05</div>
            <div class="timeline-body"><p>The test cases look right to me, apart from the inline comments about <code>yield</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-16 02:19</div>
            <div class="timeline-body"><p>Many reviewers on here -- who wants to own the final review + approval? \cc @carljm @AlexWaygood @zanieb @MichaReiser</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/plredmond">@plredmond</a> reviewed on 2024-04-16 07:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/plredmond">@plredmond</a> on <code>crates/ruff_linter/src/rules/ruff/rules/spurious_async.rs</code>:35 on 2024-04-16 07:03</div>
            <div class="timeline-body"><p>Implemented this below.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/plredmond">@plredmond</a> on 2024-04-16 07:06</div>
            <div class="timeline-body"><p>Sorry for the excessive number of commits here. I've had a bit of churn in the test cases because I found them confusing and reorganized them. The real work is these three commits:</p>
<ul>
<li><a href="https://github.com/astral-sh/ruff/pull/9966/commits/1cb7765b62046fe32050d08671e08d32a8839a4c">switch to preorder visitor</a>, <a href="https://github.com/astral-sh/ruff/pull/9966/commits/1cb7765b62046fe32050d08671e08d32a8839a4c">1cb7765</a></li>
<li><a href="https://github.com/astral-sh/ruff/pull/9966/commits/41f0ac5bfaaf5ca939be84e003f9fe7d008b7b9c">skip the rest of traversal after finding an async/await</a>, <a href="https://github.com/astral-sh/ruff/pull/9966/commits/41f0ac5bfaaf5ca939be84e003f9fe7d008b7b9c">41f0ac5</a></li>
<li><a href="https://github.com/astral-sh/ruff/pull/9966/commits/b714e808d8f403bdecbaa9a16df0f4b548261d33">don't traverse the body of inner-functions or inner-classes</a>, <a href="https://github.com/astral-sh/ruff/pull/9966/commits/b714e808d8f403bdecbaa9a16df0f4b548261d33">b714e80</a></li>
</ul>
<p>I believe this covers the test cases @MichaReiser shared <a href="https://github.com/astral-sh/ruff/pull/9966#issuecomment-1942180352">above</a> with the nested asyncs using his <a href="https://github.com/astral-sh/ruff/pull/9966#issuecomment-1942437370">suggested</a> solution (partially reimplementing traversal of function defs and class defs), as well as his <a href="https://github.com/astral-sh/ruff/pull/9966#discussion_r1488203954">suggested</a> optimization to stop traversing once some evidence that the function is actually async has been found.</p>
<p>However, this <em>doesn't</em> cover @charliermarsh's <a href="https://github.com/astral-sh/ruff/pull/9966#issuecomment-1939953539">suggestion</a> to just omit checking methods in classes. I'm not sure how to approach that (and the test case is commented out). The rule is currently written in terms of a function definition; to omit the rule for methods, we'd need to know whether that function definition is a method. I didn't see a way to do that in <code>analyze/statement.rs</code>.</p>
<p>Except for @charliermarsh's suggestion, the remaining work is just to rename spurious-&gt;unused.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/plredmond">@plredmond</a> on 2024-04-16 07:16</div>
            <div class="timeline-body"><p>Ok, I think everything is done except for this:</p>
<blockquote>
<p>However, this <em>doesn't</em> cover @charliermarsh's <a href="https://github.com/astral-sh/ruff/pull/9966#issuecomment-1939953539">suggestion</a> to just omit checking methods in classes. I'm not sure how to approach that (and the test case is commented out). The rule is currently written in terms of a function definition; to omit the rule for methods, we'd need to know whether that function definition is a method. I didn't see a way to do that in <code>analyze/statement.rs</code>.</p>
</blockquote>
<p>[EDIT: I'll look at the test failure in the morning. I don't see one when I test locally.]</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-04-16 07:51</div>
            <div class="timeline-body"><p>@plredmond I'm not entirely sure if that's what you mean but you can test if you're inside a class by using</p>
<pre><code>    // Assignments in class bodies are attributes (e.g., `x = x` assigns `x` to `self.x`, and thus
    // is not a self-assignment).
    if checker.semantic().current_scope().kind.is_class() {
        return;
    }
</code></pre>
<p>You can also use the <code>kind</code> to retrieve more information about the enclosing class (e.g. if it has any base class or whatnot)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kkom">@kkom</a> on 2024-04-16 09:38</div>
            <div class="timeline-body"><p>Came across this PR when looking at #9951 – thank you for adding this rule, very excited about it!</p>
<p>Regarding the latest discussion – I'm curious why not omit it for method marked with <code>@override</code> and continue linting methods? This is analogous to how https://docs.astral.sh/ruff/rules/no-self-use/ works – and that rule has worked really well for us in that way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-16 14:16</div>
            <div class="timeline-body"><p>@kkom we're just cutting scope from the initial rule. We could consider it in the future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unused_async.rs</code>:38 on 2024-04-16 16:42</div>
            <div class="timeline-body"><p>Nit: wrap await in backticks here for consistency with async?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-16 16:42</div>
            <div class="timeline-body"><p>This looks good to me, but I suggest adding the snippet that Micha posted above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-16 16:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/plredmond">@plredmond</a> reviewed on 2024-04-16 16:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/plredmond">@plredmond</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unused_async.rs</code>:38 on 2024-04-16 16:55</div>
            <div class="timeline-body"><p>Implemented below.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-16 17:05</div>
            <div class="timeline-body"><p>@plredmond - Try running <code>cargo dev generate-all</code> -- you need to regenerate the JSON Schema since we added a new rule.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-16 17:05</div>
            <div class="timeline-body"><p>(I believe that's the cause of your failing test.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/plredmond">@plredmond</a> on 2024-04-16 17:08</div>
            <div class="timeline-body"><pre><code class="language-sh-session">$ cargo dev generate-all
...
$ git diff
diff --git a/ruff.schema.json b/ruff.schema.json
index 871cce40b..90582fc67 100644
--- a/ruff.schema.json
+++ b/ruff.schema.json
@@ -3951,4 +3951,4 @@
       ]
     }
   }
-}
+}
\ No newline at end of file
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-16 17:09</div>
            <div class="timeline-body"><p>Is your editor adding a newline?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/plredmond">@plredmond</a> on 2024-04-16 17:09</div>
            <div class="timeline-body"><p>I also tried fetching and merging in the latest <code>main</code> in. Still no success. Strangely, I'm not seeing this locally.</p>
<p>I'll look at the CI output.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/plredmond">@plredmond</a> on 2024-04-16 17:10</div>
            <div class="timeline-body"><blockquote>
<p>Is your editor adding a newline?</p>
</blockquote>
<p>It was modified by <code>cargo dev generate-all</code> afaik. My editor is vim and I didn't modify that file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-16 17:11</div>
            <div class="timeline-body"><p>We do <em>expect</em> the Schema to change on this branch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/plredmond">@plredmond</a> on 2024-04-16 17:14</div>
            <div class="timeline-body"><p>I was wrong. I <em>did</em> edit it, back in feb, and that seems to have lead to the CI complaining about the newline. It should be fixed now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-16 17:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/codes.rs</code>:965 on 2024-04-16 17:16</div>
            <div class="timeline-body"><p>Sorry, annoying, but do you mind flipping the order here so that this rule comes last (after <code>RUF028</code>)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-04-16 17:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/plredmond">@plredmond</a> reviewed on 2024-04-16 17:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/plredmond">@plredmond</a> on <code>crates/ruff_linter/src/codes.rs</code>:965 on 2024-04-16 17:18</div>
            <div class="timeline-body"><p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @plredmond on 2024-04-16 17:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @plredmond on 2024-04-16 17:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-04-16 17:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @dhruvmanila on 2024-04-18 18:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @dhruvmanila on 2024-04-18 18:34</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:02:46 UTC
    </footer>
</body>
</html>
