<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pyupgrade`] Ignore strings with string-only escapes (`UP012`) - astral-sh/ruff #16058</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pyupgrade</code>] Ignore strings with string-only escapes (<code>UP012</code>)</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16058">#16058</a>
        opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a>
        on 2025-02-10 00:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-02-10 00:20</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Resolves #12753.</p>
<p>After this change, <code>UP012</code> will no longer report strings containing any of the following:</p>
<ul>
<li>Name escapes (<code>\N{NAME}</code>)</li>
<li>Short (<code>\u0000</code>) and long (<code>\U00000000</code>) Unicode escapes</li>
<li>Octal escapes (<code>\0</code>, <code>\00</code>, <code>\000</code>) where the codepoint value is greater than 255 (377<sub>8</sub>)</li>
</ul>
<h2>Test Plan</h2>
<p><code>cargo nextest run</code> and <code>cargo insta test</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-02-10 00:35</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2025-02-10 07:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @MichaReiser on 2025-02-10 07:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/unnecessary_encode_utf8.rs</code>:298 on 2025-02-10 08:02</div>
            <div class="timeline-body"><p>I don't think this is correct. It will always return <code>false</code> if <code>string_fragtment_contains_string_only_escapes</code> returns <code>false</code> for the first string where <code>value_len &gt; fragtment.as_str().text_len()</code> is true</p>
<pre><code class="language-py">a = &quot;test \
more&quot; &quot;a\\ escaped&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/unnecessary_encode_utf8.rs</code>:275 on 2025-02-10 08:03</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        let total_len = fragment.range().len()
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/unnecessary_encode_utf8.rs</code>:287 on 2025-02-10 08:04</div>
            <div class="timeline-body"><p>Can we use the same terminology as in the ast: <code>literal</code> instead of inventing a new term.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/unnecessary_encode_utf8.rs</code>:294 on 2025-02-10 08:06</div>
            <div class="timeline-body"><p>Let's add a <code>content_range</code> method to <code>StringLiteral</code>. It seems generally useful, similar to</p>
<p>https://github.com/astral-sh/ruff/blob/ef85c682bdd76ed63457bdfbec72e09424ac20ab/crates/ruff_python_ast/src/expression.rs#L221-L228</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/unnecessary_encode_utf8.rs</code>:307 on 2025-02-10 08:08</div>
            <div class="timeline-body"><p>I think this is incorrect for a sequence of <code>\\</code> followed by <code>\\</code>. The <code>escaped</code> flag then remains <code>true</code> but there's no longer an active escape.</p>
<p>I suggest rewritting the section to:</p>
<pre><code class="language-rust">    while let Some(backslash_offset) = cursor.as_str().find('\\') {
        cursor.skip_bytes(backslash_offset);

        let Some(escaped) = cursor.bump() else {
            continue;
        };

        match escaped {
            // Unicode name or unicode character escape
            'N' | 'u' | 'U' =&gt; return true,

            // Octal value:
            // In a bytes literal, hexadecimal and octal escapes denote the byte with the given value.
            // In a string literal, these escapes denote a Unicode character with the given value.
            'o' =&gt; {
                ...
            }

            // Hex value:
            // In a bytes literal, hexadecimal and octal escapes denote the byte with the given value.
            // In a string literal, these escapes denote a Unicode character with the given value.
            'x' =&gt; {
                ...
            }

            _ =&gt; {
                
            }
        }
</code></pre>
<p>To avoid the outer <code>escaped</code> state.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2025-02-10 08:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dscorbett">@dscorbett</a> reviewed on 2025-10-28 19:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dscorbett">@dscorbett</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/unnecessary_encode_utf8.rs</code>:319 on 2025-10-28 19:59</div>
            <div class="timeline-body"><p><code>..</code> should be the inclusive operator <code>..=</code>, here and in <code>is_octal_digit</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> requested changes on 2025-10-29 00:09</div>
            <div class="timeline-body"><p>Needs a rebase or merge from latest main.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-10-29 06:45</div>
            <div class="timeline-body"><p>@amyreese I'll rebase this PR if someone from Astral (like you or Micha) confirms that it will be reviewed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amyreese">@amyreese</a> on 2025-10-30 22:51</div>
            <div class="timeline-body"><p>Yes, it will be reviewed after rebasing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-11-06 08:37</div>
            <div class="timeline-body"><p>@amyreese Rebased.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:54:18 UTC
    </footer>
</body>
</html>
