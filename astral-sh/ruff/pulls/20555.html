<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add tests for interactions of `@classmethod`, `@staticmethod`, and protocol method members - astral-sh/ruff #20555</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add tests for interactions of <code>@classmethod</code>, <code>@staticmethod</code>, and protocol method members</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20555">#20555</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-09-24 16:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body">Summary
<p>This PR adds more tests for interactions between <code>@classmethod</code>, <code>@staticmethod</code>, and subtyping/assignability checks for protocols with method members. This partially addresses @sharkdp&#x27;s post-merge review comment in <a href="https://github.com/astral-sh/ruff/pull/20165">astral-sh/ruff#20165</a>#discussion_r2348190613.</p>
<p>There are a lot of TODOs in these tests that are tricky to fix right now due to the fact that we currently consider function-types as not being fully static if their signature includes a <code>self</code> or <code>cls</code> argument that isn&#x27;t annotated. That means that doing tests regarding the type of a method when accessed on the class object itself is currently quite tricky. I expect it to be a lot easier to resolve these TODOs after <a href="https://github.com/astral-sh/ruff/pull/20517">astral-sh/ruff#20517</a> has landed (but I also don&#x27;t think it&#x27;s urgent to resolve these TODOs, since <code>@classmethod</code> and <code>@staticmethod</code> members are quite rare).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-09-24 16:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-09-24 16:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-09-24 16:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-09-24 16:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-09-24 16:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-09-25 07:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/resources/mdtest/protocols.md</code>:2107 on 2025-09-25 07:51</div>
            <div class="timeline-body"><p>I can understand the reasoning, but this seems a bit surprising to me. Can I extend this reasoning to instance methods as well? Does <code>C</code> implement the <code>HasFInstanceMethod</code> protocol? All type checkers seem to think so, but it does feel wrong to me. Shouldn&#x27;t there be some constraints on the implicit type of the first parameter that would prevent this?</p>
<pre><code>from typing import Protocol

class HasFInstanceMethod(Protocol):
    def f(self, x: int, /) -&gt; str: ...

class C:
    @classmethod
    def f(cls, *args) -&gt; str:
        return &quot;&quot;

def accept(_: HasFInstanceMethod): ...

accept(C())  # pyright, mypy, pyrefly, ty: fine!
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> approved on 2025-09-25 07:52</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-09-25 09:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/protocols.md</code>:2107 on 2025-09-25 09:13</div>
            <div class="timeline-body"><blockquote>
<p>Does <code>C</code> implement the <code>HasFInstanceMethod</code> protocol? All type checkers seem to think so, but it does feel wrong to me. Shouldn&#x27;t there be some constraints on the implicit type of the first parameter that would prevent this?</p>
</blockquote>
<p>Yes, I agree with you -- and I added (currently failing) tests in this PR that assert this, too ;) they&#x27;re up on lines 1791-1795.</p>
<p>The rule I intend to implement for ty is that (given a protocol <code>P</code>, a method member <code>f</code> and a would-be nominal subtype <code>N</code>), two things must be true in order for <code>N</code> to satisfy <code>P</code></p>
<ul>
<li>the get-type of <code>f</code> when accessed on instances of <code>N</code> must be consistent with the signature of <code>f</code> when accessed on instances of <code>P</code></li>
<li>the get-type of <code>f</code> on <code>type[N]</code> must be consistent with the signature of <code>f</code> on when accessed on the class object <code>P</code></li>
</ul>
<p>As you note, this is a bit stricter than any other type checker currently implements, so we&#x27;ll see how it goes; we might have to back out of this. But I&#x27;d like to give it a go, at least.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-09-25 09:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-09-25 09:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-09-25 09:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/resources/mdtest/protocols.md</code>:2107 on 2025-09-25 11:05</div>
            <div class="timeline-body"><blockquote>
<p>I added (currently failing) tests in this PR that assert this, too ;) they&#x27;re up on lines 1791-1795.</p>
</blockquote>
<p>They looked slightly different to me, because with the <code>*args</code> signature in my comment, you can even make type checkers think that the <code>classmethod</code> signature <em>is</em> compatible with a non-classmethod protocol signature.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-09-25 11:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/protocols.md</code>:2107 on 2025-09-25 11:12</div>
            <div class="timeline-body"><p>Oh, sorry -- I missed that. Hmm, I can see how that might be counter-intuitive, but yes, I can&#x27;t immediately see a principled reason whereby we&#x27;d decide that <code>C</code> shouldn&#x27;t be a subtype of <code>HasFInstanceMethod</code> there...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-09-25 11:12</div>
            <div class="timeline-body"></div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:18:56 UTC
    </footer>
</body>
</html>
