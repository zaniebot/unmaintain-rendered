<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] add tests for workspaces - astral-sh/ruff #21741</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] add tests for workspaces</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21741">#21741</a>
        opened by <a href="https://github.com/Gankra">@Gankra</a>
        on 2025-12-01 21:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/Gankra">@Gankra</a> on 2025-12-01 21:07</div>
            <div class="timeline-body"><p>Here are a bunch of (variously failing and passing) mdtests that reflect the kinds of issues people encounter when running ty over an entire workspace without sufficient hand-holding (especially because in the IDE it is unclear <em>how</em> to provide that hand-holding).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @Gankra on 2025-12-01 21:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @Gankra on 2025-12-01 21:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @Gankra on 2025-12-01 21:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @Gankra on 2025-12-01 21:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @Gankra on 2025-12-01 21:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @Gankra on 2025-12-01 21:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @Gankra on 2025-12-01 21:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-01 21:09</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-01 21:11</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">pandas-stubs (https://github.com/pandas-dev/pandas-stubs)
+ pandas-stubs/_typing.pyi:1207:16: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 5814 diagnostics
+ Found 5815 diagnostics

rotki (https://github.com/rotki/rotki)
- rotkehlchen/accounting/structures/processed_event.py:85:75: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- rotkehlchen/api/rest.py:1039:73: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 2040 diagnostics
+ Found 2038 diagnostics


</code></pre>
</details>

<p>No memory usage changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-12-01 21:30</div>
            <div class="timeline-body"><p>Note that some real-world examples are combinations of these. For instance &quot;Tests Directory With Overlapping Names&quot; actually works perfectly, but it fails in pyx because it's actually technically hitting &quot;Current Directory Is Invalid Module Name&quot; (because we try to resolve relative imports like <code>.setup</code> to <code>aproj.tests.setup</code>, which in pyx's case ends up being <code>a-proj.tests.setup</code>, which is rejected).</p>
<p>Some approaches to workspaces may dodge the invalid-module-name situation, some may not. I tried to get a good coverage of interesting cases that different solutions would show differences on.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @AlexWaygood on 2025-12-01 22:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/resources/mdtest/import/workspaces.md</code>:13 on 2025-12-02 08:11</div>
            <div class="timeline-body"><p>Yes, the way I think about it is that you can run a python script with an (mostly?) arbitrary name but whether you can import it depends on the segments relative to the search roots.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/resources/mdtest/import/workspaces.md</code>:17 on 2025-12-02 08:11</div>
            <div class="timeline-body"><p>okay, I didn't know that</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/resources/mdtest/import/workspaces.md</code>:142 on 2025-12-02 08:14</div>
            <div class="timeline-body"><p>Long term, I think we want a different solution to correctly support cases where the projects have different configurations (e.g. enabled / disabled some rules). But that shouldn't prevent us from doing better when there's no member-level configuration.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/resources/mdtest/import/workspaces.md</code>:172 on 2025-12-02 08:16</div>
            <div class="timeline-body"><p>Those tests work because we also apply our default <code>environment.root</code> paths in mdtests?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-12-02 08:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @sharkdp on 2025-12-02 08:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-12-02 11:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/resources/mdtest/import/workspaces.md</code>:172 on 2025-12-02 11:42</div>
            <div class="timeline-body"><p>I believe so</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @Gankra on 2025-12-02 11:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Gankra on 2025-12-02 11:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-12-02 11:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/import/workspaces.md</code>:32 on 2025-12-02 17:08</div>
            <div class="timeline-body"><p>Both of these imports fail at runtime with <code>ImportError: attempted relative import with no known parent package</code> if you execute <code>python my-main.py</code>.</p>
<p>This is true (both at runtime and in ty today) even if we rename <code>my-main.py</code> to just <code>main.py</code> -- that is, it's unrelated to the use of an invalid module name. It's because you cannot relative-import top-level modules.</p>
<p>The only way these two imports can work is if all of these modules are imported as part of the same top-level parent package (that is, the directory containing these files is a Python package, and its parent directory is on the search path). (With the name <code>my-main.py</code>, the only way <em>that</em> can happen is via <code>importlib.import_module</code>.)</p>
<p>In other words, as this test is currently written, I think the above TODO is wrong, and these imports should error. If we add an outer containing directory and place it on the search path, then I think these imports should work (and already would with a valid module name). With that change, I think the TODO to make them also work with an invalid module name would be correct.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/import/workspaces.md</code>:33 on 2025-12-02 17:53</div>
            <div class="timeline-body"><p>The only scenario in which this import can work, and the two imports above also work, is overlapping search paths. The two relative imports can only work if this is all part of a containing package (as described above); this import can only work if these are all top-level modules. Overlapping search paths is the only way those two things can both be true.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/import/workspaces.md</code>:144 on 2025-12-02 17:59</div>
            <div class="timeline-body"><p>Nit: &quot;eachother&quot; is not a word, it's two words. (I assumed this was a typo but then saw multiple other occurrences below. Not worth fixing alone but if we're changing this file anyway we may as well.)</p>
<pre><code class="language-suggestion">It's common for a monorepo to define many separate projects that may or may not depend on each other
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/import/workspaces.md</code>:173 on 2025-12-02 18:25</div>
            <div class="timeline-body"><p>The use of <code>extra-paths</code> here is significantly different from an installed editable, in that <code>extra-paths</code> are higher priority than <code>environment.roots</code>, while editable installs are lower priority. This seems like it could make a noticeable difference in the behavior of these tests, particularly those that test the interaction between same-named &quot;outer&quot; and &quot;inner&quot; packages.</p>
<p>It would be a bit more boilerplate, but I think these tests could better reflect a realistic scenario if they instead used <code>python =</code> config and then created <code>.pth</code> files in the fake site-packages that pointed to <code>aproj/src</code>, <code>bproj/src</code> -- that would actually get those paths added as editable installs. <code>import/site_packages_discovery.md</code> demonstrates this, minus the <code>.pth</code> file part.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/import/workspaces.md</code>:259 on 2025-12-02 18:32</div>
            <div class="timeline-body"><p>So I guess what happens here is we decide the package we should import is <code>a.tests.setup</code>, but then (because <code>./a/src/</code> is a higher priority search path than <code>.</code>) we go looking for <code>a/src/a/tests/setup.py</code> and don't find it.</p>
<p>This behavior seems correct (i.e. matches runtime)? Except that as discussed above, a more realistic test would not use <code>extra-paths</code>, which would make <code>.</code> higher priority than <code>./a/src/</code> and thus totally change the behavior of this test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/import/workspaces.md</code>:328 on 2025-12-02 18:34</div>
            <div class="timeline-body"><p>This all seems totally redundant? It's testing the exact same thing as the <code>a</code> part above, in exactly the same way, and with no interaction between the two parts. Just delete it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/import/workspaces.md</code>:424 on 2025-12-02 18:35</div>
            <div class="timeline-body"><p>Same comment as above: the existence of <code>b</code> seems irrelevant to the test, we're just doing exactly the same test twice, once with the name <code>a</code> and once with the name <code>b</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/import/workspaces.md</code>:443 on 2025-12-02 18:37</div>
            <div class="timeline-body"><p>I don't understand why either of these imports should work. Nothing places <code>a/</code> on the search path, so <code>main</code> is not a top-level module, and these aren't relative imports.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/import/workspaces.md</code>:333 on 2025-12-02 18:40</div>
            <div class="timeline-body"><p>I don't think it can make a difference to this test. In theory testing various cases makes sense, but there are an infinite number of possible scenarios to test, and I'm not sure it scales to sort of randomly test little tweaks &quot;in case&quot;, even if we haven't ever seen evidence (i.e. a failure in real code) that it makes a difference. So I'm kind of not convinced we should have both this test and the previous one, unless there's an observed behavior difference.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/import/workspaces.md</code>:511 on 2025-12-02 18:40</div>
            <div class="timeline-body"><p>Same comment as above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/import/workspaces.md</code>:525 on 2025-12-02 18:40</div>
            <div class="timeline-body"><p>Same as above -- it seems entirely correct to me for these imports not to work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>my-script.py</code>:1 on 2025-12-02 18:43</div>
            <div class="timeline-body"><p>I don't think we want this as a new top-level file in the ruff repo ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-12-02 18:43</div>
            <div class="timeline-body"><p>Thanks for adding these tests!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-02 19:18</div>
            <div class="timeline-body"><p>I think another test we should add here is where we have overlapping search paths, where the outer path (say <code>.</code>) is a higher-priority search path than the inner path (say <code>./src</code>). If a file inside <code>./src</code> (say <code>./src/foo/bar.py</code>) does <code>from . import baz</code>, we currently reverse-resolve the module name of <code>./src/foo/bar.py</code> as <code>src.foo.bar</code> (rather than <code>foo.bar</code>) and then import <code>./src/foo/baz.py</code> as the module name <code>src.foo.baz</code>.</p>
<p>I think it would be better if we always preferred the inner, or more precise, matching search path instead. So <code>./src/foo/bar.py</code> would then reverse-resolve to the module name <code>foo.bar</code> (instead of <code>src.foo.bar</code>), even though <code>.</code> comes before <code>./src</code> in the search paths. And then our relative import would import <code>foo.baz</code> instead of <code>src.foo.baz</code>.</p>
<p>Cc @AlexWaygood since this is related to what we were discussing on https://github.com/astral-sh/ty/issues/1682</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-12-02 19:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>my-script.py</code>:1 on 2025-12-02 19:20</div>
            <div class="timeline-body"><p>beat you to it ;) https://github.com/astral-sh/ruff/pull/21751</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-12-02 19:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/import/workspaces.md</code>:443 on 2025-12-02 19:38</div>
            <div class="timeline-body"><p>Ok, I guess we want these to work via https://github.com/astral-sh/ty/issues/1539 &quot;desperation mode&quot;, where effectively we want to treat <code>a/</code> locally as an undeclared import root.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-12-02 19:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/import/workspaces.md</code>:525 on 2025-12-02 19:40</div>
            <div class="timeline-body"><p>Also here we want these to work via https://github.com/astral-sh/ty/issues/1539</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-02 19:44</div>
            <div class="timeline-body"><p>Created https://github.com/astral-sh/ty/issues/1730 to track the suggested new case separately.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-12-03 14:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/resources/mdtest/import/workspaces.md</code>:32 on 2025-12-03 14:34</div>
            <div class="timeline-body"><p>Great callout --  I've put everything but <code>mod3</code> under a <code>tests/</code> directory and renamed <code>my-main.py</code> to <code>my-mod.py</code>, and made a clarifying comment that in this case we're assuming <code>importlib</code> shenanigans.</p>
<p>(We in fact have had one user complain that they had a random <code>def.py</code> that they just <code>importlib.import_module</code> but we wouldn't resolve relative imports from it)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-12-03 14:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/resources/mdtest/import/workspaces.md</code>:33 on 2025-12-03 14:35</div>
            <div class="timeline-body"><p>(Fix mentioned in previous comment also handles this)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/resources/mdtest/import/workspaces.md</code>:144 on 2025-12-03 14:36</div>
            <div class="timeline-body"><p>~~it's Canadian English~~</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-12-03 14:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-12-03 14:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/resources/mdtest/import/workspaces.md</code>:173 on 2025-12-03 14:40</div>
            <div class="timeline-body"><p>Also a great point, I misremembered the order of extra and first-party.</p>
<p>I think per discussion of &quot;we should be auto-sorting nested search-paths&quot; I probably want to have at least one test that uses editables and one that uses extra-paths (I imagine some users will find extra-paths, do this kind of thing manually, and it will behoove us to untangle it).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-12-03 14:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/resources/mdtest/import/workspaces.md</code>:328 on 2025-12-03 14:44</div>
            <div class="timeline-body"><p>Having these duplicates is important, as discussed in the opening to the &quot;Multiple Projects&quot; section:</p>
<blockquote>
<p>Often the fact that there is both an <code>a</code> and <code>b</code> project seemingly won't matter, but many possible
solutions will misbehave under these conditions, as e.g. if both define a <code>main.py</code> and test code
has <code>import main</code>, we need to resolve each project's main as appropriate.</p>
</blockquote>
<p>For instance without <code>b</code> also existing it's easy to convince yourself that, instead of doing desperate resolution, you could globally add every <code>pyproject.toml</code> as a search-path. However this would result in <code>a/main.py</code> and <code>b/main.py</code> both being the absolute module <code>main</code>.</p>
<p>I agree it's tedious boilerplate but I think it's really important for convincing ourselves the approach actually works in real monorepos with repetitive per-project structures.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-12-03 14:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/resources/mdtest/import/workspaces.md</code>:333 on 2025-12-03 14:48</div>
            <div class="timeline-body"><p>This particular case was because I was perplexed by seeing this random variation in pyx's codebase and got a bit paranoid about whether it mattered if <code>tests</code> was a namespace package or a normal package. I think the <code>__init__.py</code> version is &quot;strictly harder&quot; for us to handle, so I should probably only have that one.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:48:28 UTC
    </footer>
</body>
</html>
