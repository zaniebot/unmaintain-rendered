<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`ruff`] Implement `inefficient-membership-test` (`RUF066`) - astral-sh/ruff #21116</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>ruff</code>] Implement <code>inefficient-membership-test</code> (<code>RUF066</code>)</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21116">#21116</a>
        opened by <a href="https://github.com/Zaczero">@Zaczero</a>
        on 2025-10-28 22:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/Zaczero">@Zaczero</a> on 2025-10-28 22:43</div>
            <div class="timeline-body"><p>Closes https://github.com/astral-sh/ruff/issues/19933</p>
<h2>Summary</h2>
<p>Add new rule to detect membership tests against list, tuple, or set literals containing complex elements that prevent Python's <code>LOAD_CONST</code> bytecode optimization.</p>
<p>When containers have complex elements (nested lists, dicts, function calls, operations), Python reconstructs the container on every membership test, causing performance degradation in hot code paths.</p>
<p>The rule detects:</p>
<ul>
<li>Lists/tuples with complex elements (nested containers, dicts, function calls, operations, lambdas)</li>
<li>Sets with complex elements (function calls, operations, etc.)</li>
<li>Both <code>in</code> and <code>not in</code> operators</li>
</ul>
<p>Provides unsafe autofix converting to equality comparisons:</p>
<ul>
<li><code>x in [a, b]</code> → <code>x == a or x == b</code></li>
<li><code>x not in [a, b]</code> → <code>x != a and x != b</code></li>
</ul>
<p>Fix is marked unsafe because it changes evaluation semantics (short-circuit behavior and potential side effects in custom <code>__eq__</code>).</p>
<h2>Test Plan</h2>
<p>Implementing RUFF066.py test case.</p>
<p>I verified locally whether this performance optimization applies to non-trivial lists and sets of any size, and it appears it does. There's always a performance win, but the smaller the collection, the better.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Zaczero">@Zaczero</a> on 2025-10-28 22:45</div>
            <div class="timeline-body"><p>I wanted to push forward the idea of https://github.com/astral-sh/ruff/issues/19933 and arrogantly implemented a functional rule. I am really new to ruff and have fairly basic Rust knowledge so it may need improvement.</p>
<p>cc @ntBre since you interacted</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @amyreese on 2025-10-29 00:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @amyreese on 2025-10-29 00:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dscorbett">@dscorbett</a> on <code>crates/ruff_linter/src/rules/ruff/rules/inefficient_membership_test.rs</code>:53 on 2025-10-29 13:45</div>
            <div class="timeline-body"><p>More reasons:</p>
<ul>
<li><code>in</code> also checks for identity: compare <code>math.nan in [math.nan]</code> to <code>math.nan == math.nan</code>.</li>
<li>The left argument of <code>in</code> may have a side effect.</li>
<li><code>in</code> always returns a <code>bool</code> but <code>==</code> can return anything.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dscorbett">@dscorbett</a> on <code>crates/ruff_linter/src/rules/ruff/rules/inefficient_membership_test.rs</code>:138 on 2025-10-29 13:45</div>
            <div class="timeline-body"><p>Not all operations on literals are const-folded, e.g. <code>&quot;%s&quot; % 3</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dscorbett">@dscorbett</a> reviewed on 2025-10-29 13:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-29 13:54</div>
            <div class="timeline-body"><p>Thanks for your work on this! I quickly skimmed the implementation, and it looks good overall :)</p>
<p>However, we're not really prioritizing adding new rules at the moment, so I'd like to hold off a bit longer to see if there's more interest in this rule. I'll approve the workflow run so that we can get an ecosystem report, though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Zaczero">@Zaczero</a> reviewed on 2025-10-29 14:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Zaczero">@Zaczero</a> on <code>crates/ruff_linter/src/rules/ruff/rules/inefficient_membership_test.rs</code>:138 on 2025-10-29 14:08</div>
            <div class="timeline-body"><p>TYVM for very nice findings! I'll resolve it when and if ruff decides to include such rule.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-29 15:45</div>
            <div class="timeline-body"><p>We've been hesitant about adding rules that encode specific optimizations that Python does because that can change between Python versions and is out of our control or might even become irrelevant. That's why this rule will require some more discussion before being added and I'll close this PR for now, as there's no clear path forward.</p>
<p>But thanks for your work. It's a great starting point if we decide to implement this rule.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-10-29 15:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Zaczero">@Zaczero</a> on 2025-10-29 17:01</div>
            <div class="timeline-body"><p>No prob, I was surprised by how convenient it was to add a new rule and test it in Ruff. Good job on that!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-29 19:09</div>
            <div class="timeline-body"><p>Thanks for the kind words and for being so understanding.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:00:13 UTC
    </footer>
</body>
</html>
