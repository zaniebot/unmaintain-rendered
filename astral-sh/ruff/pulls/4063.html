<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix SIM222 and SIM223 false positives and auto-fix - astral-sh/ruff #4063</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix SIM222 and SIM223 false positives and auto-fix</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4063">#4063</a>
        opened by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a>
        on 2023-04-22 14:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-04-22 14:30</div>
            <div class="timeline-body"><ul>
<li>Close #4058</li>
</ul>
<p>Special case truthy expressions like side-effect expressions.
If a truthy expression is followed by the short-circuiting boolean, remove the short-circuiting boolean too as it is unnecessary.
The violation message should be changed in this case to something like &quot;remove everything after the truth expression&quot;.</p>
<pre><code class="language-python">assert (&quot;foo&quot; and False) == &quot;foo&quot;
assert (&quot;foo&quot; or True) == &quot;foo&quot;
</code></pre>
<p>I use <code>Truthiness</code> from <code>flake8-bandit</code>, but <code>flake8-pytest</code> also has <code>is_falsy_constant()</code>.
Should we make extract <code>Truthiness</code> from <code>flake8-bandit</code>, add the missing cases from <code>flake8-pytest</code>, and use it for <code>flake8-bandit</code>, <code>flake8-pytest</code>, and <code>flake8-simplify</code>?
I would be open making another PR for this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-04-22 14:51</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>ℹ️ ecosystem check <strong>detected changes</strong>. (+0, -1, 0 error(s))</p>
<details><summary>airflow (+0, -1)</summary>
<p>

<pre><code class="language-diff">- airflow/providers/apache/kafka/operators/consume.py:100:29: SIM222 [*] Use `True` instead of `... or True`
</code></pre>
</p>
</details>

<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     15.5±0.04ms     2.6 MB/sec    1.00     15.4±0.02ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.9±0.01ms     4.3 MB/sec    1.00      3.9±0.01ms     4.3 MB/sec
linter/all-rules/numpy/globals.py          1.03    431.4±8.32µs     6.8 MB/sec    1.00    420.7±1.34µs     7.0 MB/sec
linter/all-rules/pydantic/types.py         1.01      6.6±0.01ms     3.9 MB/sec    1.00      6.6±0.01ms     3.9 MB/sec
linter/default-rules/large/dataset.py      1.02      8.2±0.02ms     4.9 MB/sec    1.00      8.1±0.01ms     5.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01   1791.0±3.17µs     9.3 MB/sec    1.00   1775.1±4.08µs     9.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    184.6±0.93µs    16.0 MB/sec    1.00    185.5±1.35µs    15.9 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.7±0.01ms     6.8 MB/sec    1.00      3.7±0.01ms     6.9 MB/sec
parser/large/dataset.py                    1.00      6.4±0.01ms     6.4 MB/sec    1.01      6.5±0.00ms     6.3 MB/sec
parser/numpy/ctypeslib.py                  1.00   1257.8±1.34µs    13.2 MB/sec    1.01   1272.6±1.50µs    13.1 MB/sec
parser/numpy/globals.py                    1.00    126.4±0.35µs    23.4 MB/sec    1.01    127.5±0.30µs    23.1 MB/sec
parser/pydantic/types.py                   1.00      2.8±0.00ms     9.3 MB/sec    1.01      2.8±0.00ms     9.2 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.01     17.6±0.33ms     2.3 MB/sec    1.00     17.4±0.29ms     2.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.4±0.07ms     3.8 MB/sec    1.02      4.5±0.08ms     3.7 MB/sec
linter/all-rules/numpy/globals.py          1.00   546.1±11.96µs     5.4 MB/sec    1.00   548.7±10.70µs     5.4 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.3±0.10ms     3.5 MB/sec    1.01      7.4±0.11ms     3.4 MB/sec
linter/default-rules/large/dataset.py      1.00      8.8±0.06ms     4.6 MB/sec    1.03      9.1±0.14ms     4.5 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1925.1±18.13µs     8.6 MB/sec    1.03  1976.8±26.42µs     8.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    216.5±3.16µs    13.6 MB/sec    1.03   223.7±13.01µs    13.2 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.0±0.06ms     6.4 MB/sec    1.02      4.1±0.06ms     6.2 MB/sec
parser/large/dataset.py                    1.00      7.0±0.07ms     5.8 MB/sec    1.01      7.0±0.04ms     5.8 MB/sec
parser/numpy/ctypeslib.py                  1.00  1326.4±21.77µs    12.6 MB/sec    1.01  1335.3±15.68µs    12.5 MB/sec
parser/numpy/globals.py                    1.00    131.9±2.01µs    22.4 MB/sec    1.01    133.7±2.12µs    22.1 MB/sec
parser/pydantic/types.py                   1.00      3.0±0.04ms     8.4 MB/sec    1.00      3.0±0.03ms     8.4 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-04-22 22:15</div>
            <div class="timeline-body"><p>Yeah, I'd vote to extract that concept into <code>ruff_python_semantic</code> and use it in more places!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_bool_op.rs</code>:529 on 2023-04-22 22:15</div>
            <div class="timeline-body"><p>Nit: Can we move the <code>to_string</code> call to where we create the <code>Edit</code> to avoid allocating a string on the heap if there are no diagnostics.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-04-22 22:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_bandit/rules/shell_injection.rs</code>:185 on 2023-04-22 22:16</div>
            <div class="timeline-body"><p>I guess we should also include <code>JoinedStr</code> here, and maybe the <code>ITERABLE_INITIALIZERS</code> logic we see in <code>flake8-pytest</code>? Whatever's most comprehensive.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-04-22 22:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_simplify/snapshots/ruff__rules__flake8_simplify__tests__SIM222_SIM222.py.snap</code>:157 on 2023-04-23 05:11</div>
            <div class="timeline-body"><p>Can we update these diagnostic messages, since they no longer reflect the suggestion IIUC?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-04-23 05:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_simplify/snapshots/ruff__rules__flake8_simplify__tests__SIM223_SIM223.py.snap</code>:152 on 2023-04-23 05:12</div>
            <div class="timeline-body"><p>So in the summary, we mention:</p>
<pre><code class="language-py">assert (&quot;foo&quot; and False) == &quot;foo&quot;
</code></pre>
<p>But I don't <em>think</em> this holds, since the left-hand side evaluates to <code>False</code>. And in this example here, <code>a and &quot;foo&quot;</code> isn't equivalent to <code>a and &quot;foo&quot; and False and &quot;bar&quot;</code>, is it? If <code>a</code> is truth-y, then <code>a and &quot;foo&quot; and False and &quot;bar&quot;</code> gives you <code>False</code>; if <code>a</code> is false-y, it gives you <code>a</code>. But <code>a and &quot;foo&quot;</code> gives you either <code>a</code> or <code>&quot;foo&quot;</code>. I think the logic is different for the false case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-04-23 05:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> reviewed on 2023-04-23 07:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on <code>crates/ruff/src/rules/flake8_simplify/snapshots/ruff__rules__flake8_simplify__tests__SIM223_SIM223.py.snap</code>:152 on 2023-04-23 07:27</div>
            <div class="timeline-body"><p>You are right it should check for falsey value not truthy value for <code>and</code> operands.</p>
<pre><code class="language-python">assert (&quot;&quot; and False) == &quot;&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> reviewed on 2023-04-23 13:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on <code>crates/ruff/src/rules/flake8_bandit/rules/shell_injection.rs</code>:185 on 2023-04-23 13:33</div>
            <div class="timeline-body"><p>Done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> reviewed on 2023-04-23 13:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_bool_op.rs</code>:527 on 2023-04-23 13:38</div>
            <div class="timeline-body"><pre><code class="language-python">a and &quot;&quot;
a or &quot;a&quot;
</code></pre>
<p>is replaced by</p>
<pre><code class="language-python">&quot;&quot;
&quot;a&quot;
</code></pre>
<p>This auto-fix is valid only if the result of the boolean operations is used by <code>bool(...)</code> or <code>if ...</code>.</p>
<p>We should only check for truthiness is unknown and not <code>contains_effect</code> in the other cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> reviewed on 2023-04-23 14:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on <code>crates/ruff/src/rules/flake8_simplify/snapshots/ruff__rules__flake8_simplify__tests__SIM222_SIM222.py.snap</code>:157 on 2023-04-23 14:54</div>
            <div class="timeline-body"><p>Done!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> reviewed on 2023-04-23 14:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_bool_op.rs</code>:527 on 2023-04-23 14:56</div>
            <div class="timeline-body"><p>I am working on a visitor to know if we are in a boolean context (i.e. boolean operation result will be converted to a boolean).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-04-23 16:32</div>
            <div class="timeline-body"><p>I added <code>in_test</code> to <code>Context</code>.
It is considered to be in a test context when you are inside an <code>if</code> or an <code>assert</code> test, or inside the builtin <code>bool</code>.
Boolean operations inside other expressions than boolean operations are not in a test context.</p>
<p>For example:</p>
<pre><code class="language-python"># Inside test `a` is simplified

bool(a or [1] or True or [2])

assert a or [1] or True or [2]

if (a or [1] or True or [2]) and (a or [1] or True or [2]):
    pass

# Outside test `a` is not simplified

a or [1] or True or [2]

if (a or [1] or True or [2]) == (a or [1]):
    pass

if f(a or [1] or True or [2]):
    pass
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-04-23 17:10</div>
            <div class="timeline-body"><p>There is a false positive that has been fixed in <code>airflow</code>.</p>
<pre><code class="language-python">self.max_messages = max_messages or True
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Fix SIM222 SIM223 false positive with truthy value" to "Fix SIM222 and SIM223 false positives and auto-fix" by @JonathanPlasse on 2023-04-23 18:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-04-23 19:21</div>
            <div class="timeline-body"><p>Should I split this PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-04-23 19:55</div>
            <div class="timeline-body"><p>I think it would be helpful. What do you think we can carve out into separate PRs?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-04-23 20:54</div>
            <div class="timeline-body"><p>Here is the list of possible PRs</p>
<ol>
<li>#4071</li>
<li>#4072</li>
<li>#4063 (This PR)</li>
</ol>
<p>I will rebase this PR on <code>main</code> after the first two are merged.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-04-24 06:13</div>
            <div class="timeline-body"><p>The rebase is done.
It is ready for review.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-04-24 06:20</div>
            <div class="timeline-body"><p>I will document the rules as we diverge a lot from the behavior of <code>flake8-simplify</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-04-24 10:42</div>
            <div class="timeline-body"><p>I documented the rules and detect when <code>... or True</code>, <code>True or ...</code>, or <code>... or True or ...</code> is used and adapted the violation message.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-04-25 04:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-04-25 04:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-04-25 04:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-04-25 07:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-04-25 07:17</div>
            <div class="timeline-body"><p>You for your edits, it is much cleaner and clearer now.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 04:29:50 UTC
    </footer>
</body>
</html>
