<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Implement deferred annotations for Python 3.14 - astral-sh/ruff #17658</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Implement deferred annotations for Python 3.14</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17658">#17658</a>
        opened by <a href="https://github.com/dylwil3">@dylwil3</a>
        on 2025-04-27 21:01
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a></div>
            <div class="timeline-body"><p>This PR updates the semantic model for Python 3.14 by essentially equating &quot;run using Python 3.14&quot; with &quot;uses <code>from __future__ import annotations</code>&quot;.</p>
<p>While this is not technically correct under the hood, it appears to be correct for the purposes of our semantic model. That is: from the point of view of deciding when to parse, bind, etc. annotations, these two contexts behave the same. More generally these contexts behave the same unless you are performing some kind of introspection like the following:</p>
<p>Without future import:</p>
<pre><code>&gt;&gt;&gt; from annotationlib import get_annotations,Format
&gt;&gt;&gt; def foo()-&gt;Bar:...
...
&gt;&gt;&gt; get_annotations(foo,format=Format.FORWARDREF)
{&#x27;return&#x27;: ForwardRef(&#x27;Bar&#x27;)}
&gt;&gt;&gt; get_annotations(foo,format=Format.STRING)
{&#x27;return&#x27;: &#x27;Bar&#x27;}
&gt;&gt;&gt; get_annotations(foo,format=Format.VALUE)
Traceback (most recent call last):
[...]
NameError: name &#x27;Bar&#x27; is not defined
&gt;&gt;&gt; get_annotations(foo)
Traceback (most recent call last):
[...]
NameError: name &#x27;Bar&#x27; is not defined
</code></pre>
<p>With future import:</p>
<pre><code>&gt;&gt;&gt; from __future__ import annotations
&gt;&gt;&gt; from annotationlib import get_annotations,Format
&gt;&gt;&gt; def foo()-&gt;Bar:...
...
&gt;&gt;&gt; get_annotations(foo,format=Format.FORWARDREF)
{&#x27;return&#x27;: &#x27;Bar&#x27;}
&gt;&gt;&gt; get_annotations(foo,format=Format.STRING)
{&#x27;return&#x27;: &#x27;Bar&#x27;}
&gt;&gt;&gt; get_annotations(foo,format=Format.VALUE)
{&#x27;return&#x27;: &#x27;Bar&#x27;}
&gt;&gt;&gt; get_annotations(foo)
{&#x27;return&#x27;: &#x27;Bar&#x27;}
</code></pre>
<p>(Note: the result of the last call to <code>get_annotations</code> in these examples relies on the fact that, as of this writing, the default value for <code>format</code> is <code>Format.VALUE</code>).</p>
<p>If one day we support lint rules targeting code that introspects using the new <code>annotationlib</code>, then it is possible we will need to revisit our approximation.</p>
<p>Closes #15100</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">python314</span> added by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-04-27 21:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-27 21:10</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>‚úÖ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>‚úÖ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>‚ÑπÔ∏è ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<a href="https://github.com/mesonbuild/meson-python">mesonbuild/meson-python</a> (error)
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to read tests/packages/symlinks/baz.py: No such file or directory (os error 2)
error: Failed to read tests/packages/symlinks/qux.py: No such file or directory (os error 2)
</code></pre>
</p>


Formatter (preview)
<p>‚ÑπÔ∏è ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<a href="https://github.com/mesonbuild/meson-python">mesonbuild/meson-python</a> (error)
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to read tests/packages/symlinks/baz.py: No such file or directory (os error 2)
error: Failed to read tests/packages/symlinks/qux.py: No such file or directory (os error 2)
</code></pre>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-28 06:22</div>
            <div class="timeline-body"><p>This is a PR where I&#x27;d appreciate if you @AlexWaygood could take a look at the <em>semantics</em> of the change. I can review the code changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-28 06:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-05-01 17:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/checkers/ast/annotation.rs</code>:66 on 2025-05-01 17:48</div>
            <div class="timeline-body"><p>If there are no situations where we want to treat PEP-563 differently from PEP-649, should we just have the <code>semantic.future_annotations_or_stub()</code> method itself always return <code>true</code> if the Python version is 3.14 or higher? We could rewrite <code>SemanticModelFlags::new()</code> so that it takes a <code>PythonVersion</code> argument as well as a <code>Path</code> argument, and always sets the <code>FUTURE_ANNOTATIONS</code> flag if the Python version is &gt;= 3.14?</p>
<p>https://github.com/astral-sh/ruff/blob/b7ce694162bcd82592926afbbbf918ed61c49bad/crates/ruff_python_semantic/src/model.rs#L2574-L2582</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-05-01 17:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/checkers/ast/annotation.rs</code>:66 on 2025-05-01 17:56</div>
            <div class="timeline-body"><p>I audited existing uses of <code>future_annotations_or_stub()</code> and I can&#x27;t see any uses where it would be problematic if we had the method return <code>true</code> for either PEP-563 or PEP-649 being activated</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-05-01 17:59</div>
            <div class="timeline-body"><p>The semantics LGTM here. Thank you! And sorry for the delay -- I wanted to re-read PEP-649 and PEP-749 before reviewing, but they&#x27;re both long and I kept getting distracted üôÉ</p>
<p>I do think there are some other changes we could do as well in this area, but don&#x27;t need to be done in this PR:</p>
<ul>
<li>We should probably at least update the docs for rules that tell you to add <code>from __future__ import annotations</code> or that tell you to stringify annotations, to say that this isn&#x27;t necessary on Python 3.14+</li>
<li>Certain idioms (some of them pretty common!) that were usable prior to Python 3.14 will no longer be usable; it would be great if we could add diagnostics warning users against doing <code>cls.__annotations__</code> or <code>cls.__dict__.get(&quot;__annotations__&quot;, {})</code>. Both are ill-advised on Python 3.14+</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JelleZijlstra">@JelleZijlstra</a> on 2025-05-01 22:34</div>
            <div class="timeline-body"><blockquote>
<p>we could add diagnostics warning users against doing cls.<strong>annotations</strong> or cls.<strong>dict</strong>.get(&quot;<strong>annotations</strong>&quot;, {}). Both are ill-advised on Python 3.14+</p>
</blockquote>
<p><code>cls.__annotations__</code> will be safe as of a recent change, but <code>__dict__</code> access will be very unreliable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/JelleZijlstra">@JelleZijlstra</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:1006 on 2025-05-01 22:35</div>
            <div class="timeline-body"><p>This comment is out of date</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JelleZijlstra">@JelleZijlstra</a> reviewed on 2025-05-01 22:36</div>
            <div class="timeline-body"><p>Feel free to ping me with any questions about this (for context I implemented PEP 649 in CPython).</p>
<p>I am not familiar with how Ruff uses this logic but it generally makes sense to me that it should treat everything as if <code>from __future__ import annotations</code> is present in Python 3.14+.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/checkers/ast/annotation.rs</code>:66 on 2025-05-05 11:20</div>
            <div class="timeline-body"><p>Hmm - I&#x27;m torn here. I wanted to keep these separate because the two conditions aren&#x27;t technically identical. So it may be misleading/surprising for contributors implementing something if <code>semantic.future_annotations_or_stub</code> returns <code>true</code> when we aren&#x27;t in a stub file and <code>annotations</code> hasn&#x27;t been imported. (And I figured <code>semantic.future_annotations_or_stub_or_version_defers_annotations</code> was unwieldy üòÑ ).</p>
<p>A less compelling reason is that we may want to eventually target situations like the example in the PR summary, in which case it&#x27;s important to distinguish between the two.</p>
<p>Since it&#x27;s only a couple call sites, I think I&#x27;m gonna keep them separate for now and get this merged, and we can always combine them later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-05-05 11:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-05-05 11:40</div>
            <div class="timeline-body"><p>Thanks for your help @AlexWaygood and @JelleZijlstra ! I&#x27;ve made a tiny issue recording the idea for a lint rule checking for <code>__dict__</code> access of annotations here: <a href="https://github.com/astral-sh/ruff/issues/17853">astral-sh/ruff#17853</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-05-05 11:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-05-05 11:40</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:13:44 UTC
    </footer>
</body>
</html>
