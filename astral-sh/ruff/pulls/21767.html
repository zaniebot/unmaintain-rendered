<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Improve `@override`, `@final` and Liskov checks in cases where there are multiple reachable definitions - astral-sh/ruff #21767</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Improve <code>@override</code>, <code>@final</code> and Liskov checks in cases where there are multiple reachable definitions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21767">#21767</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-12-02 23:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-02 23:50</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>(Stacked on top of https://github.com/astral-sh/ruff/pull/21756; review that first.)</p>
<p>Fixes https://github.com/astral-sh/ty/issues/1677. Currently we only keeping track of a <code>Definition</code> if there was only one single reachable definition for a <code>Place</code>. Now, we always keep track of the first <code>Definition</code>, even if there are multiple reachable definitions for that <code>Place</code>.</p>
<h2>Test Plan</h2>
<p>mdtests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-12-02 23:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-02 23:54</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-02 23:56</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">beartype (https://github.com/beartype/beartype)
- beartype/claw/_package/clawpkgtrie.py:66:29: warning[unsupported-base] Unsupported class base with type `&lt;class 'dict[str, PackagesTrieBlacklist]'&gt; | &lt;class 'dict[str, Divergent]'&gt;`
- beartype/claw/_package/clawpkgtrie.py:247:29: warning[unsupported-base] Unsupported class base with type `&lt;class 'dict[str, PackagesTrieWhitelist]'&gt; | &lt;class 'dict[str, Divergent]'&gt;`
- Found 494 diagnostics
+ Found 492 diagnostics

dulwich (https://github.com/dulwich/dulwich)
- dulwich/porcelain.py:481:71: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- dulwich/porcelain.py:485:76: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 228 diagnostics
+ Found 226 diagnostics

mypy (https://github.com/python/mypy)
+ mypy/typeshed/stdlib/_frozen_importlib.pyi:79:13: error[invalid-method-override] Invalid override of method `create_module`: Definition is incompatible with `Loader.create_module`
+ mypy/typeshed/stdlib/_frozen_importlib.pyi:118:13: error[invalid-method-override] Invalid override of method `create_module`: Definition is incompatible with `Loader.create_module`
+ mypy/typeshed/stdlib/array.pyi:65:13: error[invalid-method-override] Invalid override of method `index`: Definition is incompatible with `Sequence.index`
+ mypy/typeshed/stdlib/asyncio/base_events.pyi:325:19: error[invalid-method-override] Invalid override of method `create_server`: Definition is incompatible with `AbstractEventLoop.create_server`
+ mypy/typeshed/stdlib/asyncio/base_events.pyi:325:19: error[invalid-method-override] Invalid override of method `create_server`: Definition is incompatible with `AbstractEventLoop.create_server`
+ mypy/typeshed/stdlib/fractions.pyi:125:13: error[invalid-method-override] Invalid override of method `__pow__`: Definition is incompatible with `Complex.__pow__`
+ mypy/typeshed/stdlib/fractions.pyi:125:13: error[invalid-method-override] Invalid override of method `__pow__`: Definition is incompatible with `Complex.__pow__`
+ mypy/typeshed/stdlib/fractions.pyi:135:13: error[invalid-method-override] Invalid override of method `__rpow__`: Definition is incompatible with `Complex.__rpow__`
+ mypy/typeshed/stdlib/fractions.pyi:135:13: error[invalid-method-override] Invalid override of method `__rpow__`: Definition is incompatible with `Complex.__rpow__`
- mypy/typeshed/stdlib/pydoc.pyi:166:26: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- mypy/typeshed/stdlib/pydoc.pyi:176:132: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- mypy/typeshed/stdlib/pydoc.pyi:177:128: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- mypy/typeshed/stdlib/pydoc.pyi:229:131: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- mypy/typeshed/stdlib/pydoc.pyi:230:107: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- mypy/typeshed/stdlib/pydoc.pyi:231:132: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- mypy/typeshed/stdlib/pydoc.pyi:232:128: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- mypy/typeshed/stdlib/pydoc.pyi:233:24: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- mypy/typeshed/stdlib/tempfile.pyi:379:67: warning[unused-ignore-comment] Unused blanket `type: ignore` directive

scikit-build-core (https://github.com/scikit-build/scikit-build-core)
+ src/scikit_build_core/_logging.py:153:13: warning[unsupported-base] Unsupported class base with type `&lt;class 'Mapping[str, Style]'&gt; | &lt;class 'Mapping[str, Divergent]'&gt;`
- Found 41 diagnostics
+ Found 42 diagnostics

pandas-stubs (https://github.com/pandas-dev/pandas-stubs)
- pandas-stubs/_typing.pyi:1209:16: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 5512 diagnostics
+ Found 5511 diagnostics


</code></pre>
</details>

<p>No memory usage changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[ty] Improve @override and @final checks in cases where there are multiple reachable definitions" to "[ty] Improve `@override`, `@final` and Liskov checks in cases where there are multiple reachable definitions" by @AlexWaygood on 2025-12-02 23:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by @AlexWaygood on 2025-12-02 23:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-03 00:06</div>
            <div class="timeline-body"><!-- generated-comment ty ecosystem-analyzer -->

<h2><code>ecosystem-analyzer</code> results</h2>
<p>| Lint rule | Added | Removed | Changed |
|-----------|------:|--------:|--------:|
| <code>unused-ignore-comment</code> | 1 | 11 | 0 |
| <code>invalid-method-override</code> | 9 | 0 | 0 |
| <code>invalid-argument-type</code> | 2 | 0 | 0 |
| <strong>Total</strong> | <strong>12</strong> | <strong>11</strong> | <strong>0</strong> |</p>
<p><strong><a href="https://alex-first-declaration.ecosystem-663.pages.dev/diff">Full report with detailed diff</a></strong> (<a href="https://alex-first-declaration.ecosystem-663.pages.dev/timing">timing results</a>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-03 00:37</div>
            <div class="timeline-body"><p>Okay, the weird new Liskov violations on mypy's vendored version of typeshed are because e.g. ty thinks that the <code>ModuleSpec</code> definition in mypy's vendored version of <code>stdlib/importlib/_frozen_importlib.pyi</code> is a different class to the <code>ModuleSpec</code> definition in ty's vendored version of <code>stdlib/importlib/_frozen_importlib.pyi</code>. So &quot;obviously&quot; a class that overrides the a method that takes one <code>ModuleSpec</code> with a method that takes another <code>ModuleSpec</code> must violate the Liskov Subsitution Principle.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @AlexWaygood on 2025-12-03 00:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-12-03 00:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-12-03 00:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @AlexWaygood on 2025-12-03 00:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2025-12-03 00:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-12-03 00:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/importer.rs</code>:1 on 2025-12-03 00:46</div>
            <div class="timeline-body"><p>@BurntSushi -- both of the tests being changed in this file have FIXME comments above them. But I'm not sure if the changes this PR makes to the tests fixes the problems, or makes the problems worse ðŸ˜† I'm not totally sure I understand what these tests are meant to be asserting</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/final.md</code>:498 on 2025-12-03 06:30</div>
            <div class="timeline-body"><p>It seems like we do? At least at the first definition...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-12-03 06:38</div>
            <div class="timeline-body"><p>Looks good!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/final.md</code>:498 on 2025-12-03 11:46</div>
            <div class="timeline-body"><p>no, we emit a diagnostic stating that an <code>@final</code> method has been overridden (which is not to my mind a Liskov violation), but we are silent about the fact that the <em>type</em> has also been incompatibly overridden (which is, to my mind, a Liskov violation)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-12-03 11:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-12-03 12:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/importer.rs</code>:1 on 2025-12-03 12:16</div>
            <div class="timeline-body"><p>LMK if you consider this a regression and I can fix it in a followup. It shouldn't be too hard to track whether a member has multiple definitions and propagate that information upwards, if that's what the autocomplete machinery wants to know</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-12-03 12:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-12-03 12:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-12-03 12:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/importer.rs</code>:1 on 2025-12-03 13:54</div>
            <div class="timeline-body"><p>I think the idea here was just trying to test what happens when we try to insert an import for a symbol that is already imported, but whose imports are conditional. I think in this case we don't want to add any new imports. But we weren't doing that before either. So I think this is fine for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-12-03 13:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-12-03 13:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/importer.rs</code>:1 on 2025-12-03 13:56</div>
            <div class="timeline-body"><p>cool, thank you!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:48:28 UTC
    </footer>
</body>
</html>
