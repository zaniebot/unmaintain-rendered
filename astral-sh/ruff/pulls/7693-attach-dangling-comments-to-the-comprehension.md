```yaml
number: 7693
title: "Attach dangling comments to the comprehension instead of the `if` or `iter` nodes"
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: attach-dangling-comments-to-comprehension
created_at: 2023-09-28T09:20:43Z
updated_at: 2023-09-29T09:45:02Z
url: https://github.com/astral-sh/ruff/pull/7693
synced_at: 2026-01-12T15:55:24Z
```

# Attach dangling comments to the comprehension instead of the `if` or `iter` nodes

---

_@MichaReiser_

## Summary

This PR fixes the attachment of dangling comments for `comprehension`s. 

The comprehension formatting used to attach some dangling comments to the `iter` or `if`s node as dangling comments. 
This causes problems when the `iter` or `if` nodes have their own custom logic for handling dangling comments. 

For example, binary expressions use the dangling comments to store comments after the operator. 
Attaching dangling `iter` comments to the binary expression misguides the binary expression formatting because
it now formats it as if it has trailing operator comments, which it has not. 

This PR fixes the issue by attaching all special comprehension comments as dangling comments to the comprehension and use indexing to split the comments during formatting.

Closes #7605 
Closes https://github.com/astral-sh/ruff/issues/6588

## Test Plan

`cargo test`. Added test, added debug assertions for nodes that can never have dangling comments (wasn't possible before)


---

_Comment by @MichaReiser on 2023-09-28 09:20_

Current dependencies on/for this PR:
* main
  * **PR #7693** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7693" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7693?utm_source=stack-comment).

---

_Comment by @codspeed-hq[bot] on 2023-09-28 09:29_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/attach-dangling-comments-to-comprehension)

### Merging #7693 will **not alter performance**

<sub>Comparing <code>attach-dangling-comments-to-comprehension</code> (5f399a5) with <code>main</code> (e62e245)</sub>



### Summary

`âœ… 25` untouched benchmarks






---

_Renamed from "Attach dangling comments to comprehension instead of `if` or `in` node" to "Attach dangling comments to the comprehension instead of the `if` or `iter` nodes" by @MichaReiser on 2023-09-28 09:31_

---

_Label `formatter` added by @MichaReiser on 2023-09-28 09:31_

---

_Marked ready for review by @MichaReiser on 2023-09-28 09:36_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/lib.rs`:88 on 2023-09-28 09:53_

nit: break this line

---

_@konstin approved on 2023-09-28 10:28_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/module/mod_module.rs`:44 on 2023-09-28 13:06_

Not: I think these changes to fmt_dangling_comments could be a separate PR.

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/Cargo.toml`:41 on 2023-09-28 13:07_

Whatâ€™s this?

---

_@charliermarsh approved on 2023-09-28 13:07_

---

_@MichaReiser reviewed on 2023-09-28 13:46_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/module/mod_module.rs`:44 on 2023-09-28 13:46_

Yeah, that's fair. I used it to verify that no other node does something similar. But it could certainly have been its own PR. Would you prefer if I split it out?

---

_@MichaReiser reviewed on 2023-09-28 13:47_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/Cargo.toml`:41 on 2023-09-28 13:47_

A fix-up from my changes. Could have been it's own PR too, I guess. There's a `serde` feature. The `ruff_formatter` serde feature should depend on whether `serde` is enabled for `ruff_python_formatter`

---

_@charliermarsh reviewed on 2023-09-28 14:05_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/module/mod_module.rs`:44 on 2023-09-28 14:05_

I think it's fine as-is actually -- I assume these debug checks _don't_ pass without these changes.

---

_@MichaReiser reviewed on 2023-09-28 15:48_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/module/mod_module.rs`:44 on 2023-09-28 15:48_

Yeah they don't. That's how I discovered that comprehension attach dangling comments to other nodes in the fist place (because I wanted to add the assertions and then got really confused why some of the nodes suddenly had dangling comments)

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/module/mod_module.rs`:44 on 2023-09-28 17:36_

Totally fine with merging as-is.

---

_@charliermarsh reviewed on 2023-09-28 17:36_

---

_Merged by @MichaReiser on 2023-09-29 09:45_

---

_Closed by @MichaReiser on 2023-09-29 09:45_

---

_Branch deleted on 2023-09-29 09:45_

---
