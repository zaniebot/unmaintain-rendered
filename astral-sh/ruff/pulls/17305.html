<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Silence `unresolved-attribute` in unreachable code - astral-sh/ruff #17305</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Silence <code>unresolved-attribute</code> in unreachable code</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17305">#17305</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-04-09 08:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-09 08:34</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Basically just repeat the same thing that we did for <code>unresolved-reference</code>, but now for attribute expressions.</p>
<p>We now also handle the case where the unresolved attribute (or the unresolved reference) diagnostic originates from a stringified type annotation.</p>
<p>And I made the evaluation of reachability constraints lazy (will only be evaluated right before we are about to emit a diagnostic).</p>
<h2>Test Plan</h2>
<p>New Markdown tests for stringified annotations.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @sharkdp on 2025-04-09 08:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-09 08:36</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">zipp (https://github.com/jaraco/zipp)
+ warning[lint:unused-ignore-comment] /tmp/mypy_primer/projects/zipp/zipp/compat/py310.py:10:23: Unused blanket `type: ignore` directive
- Found 2 diagnostics
+ Found 3 diagnostics

pyp (https://github.com/hauntsaninja/pyp)
- error[lint:unresolved-attribute] /tmp/mypy_primer/projects/pyp/pyp.py:604:16: Type `&lt;module 'ast'&gt;` has no attribute `unparse`
- Found 20 diagnostics
+ Found 19 diagnostics

pybind11 (https://github.com/pybind/pybind11)
- dependency graph cycle querying try_metaclass_(Id(26c02)); set cycle_fn/cycle_initial to fixpoint iterate
+ dependency graph cycle querying try_metaclass_(Id(30c04)); set cycle_fn/cycle_initial to fixpoint iterate
- dependency graph cycle querying try_metaclass_(Id(2b012)); set cycle_fn/cycle_initial to fixpoint iterate
+ dependency graph cycle querying try_metaclass_(Id(1e018)); set cycle_fn/cycle_initial to fixpoint iterate
- dependency graph cycle querying member_lookup_with_policy_(Id(1c0aa)); set cycle_fn/cycle_initial to fixpoint iterate
+ dependency graph cycle querying member_lookup_with_policy_(Id(19cf5)); set cycle_fn/cycle_initial to fixpoint iterate

werkzeug (https://github.com/pallets/werkzeug)
- error[lint:unresolved-attribute] /tmp/mypy_primer/projects/werkzeug/src/werkzeug/_reloader.py:176:34: Type `&lt;module 'sys'&gt;` has no attribute `orig_argv`
- error[lint:unresolved-attribute] /tmp/mypy_primer/projects/werkzeug/src/werkzeug/debug/__init__.py:106:22: Type `&lt;module 'winreg'&gt;` has no attribute `OpenKey`
- error[lint:unresolved-attribute] /tmp/mypy_primer/projects/werkzeug/src/werkzeug/debug/__init__.py:107:21: Type `&lt;module 'winreg'&gt;` has no attribute `HKEY_LOCAL_MACHINE`
- error[lint:unresolved-attribute] /tmp/mypy_primer/projects/werkzeug/src/werkzeug/debug/__init__.py:110:21: Type `&lt;module 'winreg'&gt;` has no attribute `KEY_READ`
- error[lint:unresolved-attribute] /tmp/mypy_primer/projects/werkzeug/src/werkzeug/debug/__init__.py:110:39: Type `&lt;module 'winreg'&gt;` has no attribute `KEY_WOW64_64KEY`
- error[lint:unresolved-attribute] /tmp/mypy_primer/projects/werkzeug/src/werkzeug/debug/__init__.py:114:39: Type `&lt;module 'winreg'&gt;` has no attribute `QueryValueEx`
- error[lint:unresolved-attribute] /tmp/mypy_primer/projects/werkzeug/src/werkzeug/debug/__init__.py:114:39: Type `&lt;module 'winreg'&gt;` has no attribute `QueryValueEx`
- error[lint:unresolved-attribute] /tmp/mypy_primer/projects/werkzeug/src/werkzeug/debug/__init__.py:114:39: Type `&lt;module 'winreg'&gt;` has no attribute `QueryValueEx`
- error[lint:unresolved-attribute] /tmp/mypy_primer/projects/werkzeug/src/werkzeug/debug/__init__.py:116:37: Type `&lt;module 'winreg'&gt;` has no attribute `REG_SZ`
- Found 768 diagnostics
+ Found 759 diagnostics

rich (https://github.com/Textualize/rich)
- error[lint:unresolved-attribute] /tmp/mypy_primer/projects/rich/rich/_win32_console.py:12:35: Type `&lt;module 'ctypes'&gt;` has no attribute `WinDLL`
- error[lint:unresolved-attribute] /tmp/mypy_primer/projects/rich/rich/_windows.py:20:32: Type `&lt;module 'ctypes'&gt;` has no attribute `WinDLL`
- error[lint:unresolved-attribute] /tmp/mypy_primer/projects/rich/rich/_windows.py:56:27: Type `&lt;module 'sys'&gt;` has no attribute `getwindowsversion`
- error[lint:unresolved-attribute] /tmp/mypy_primer/projects/rich/rich/traceback.py:464:38: Type `BaseException` has no attribute `exceptions`
- Found 793 diagnostics
+ Found 789 diagnostics

scrapy (https://github.com/scrapy/scrapy)
- error[lint:unresolved-attribute] /tmp/mypy_primer/projects/scrapy/tests/CrawlerProcess/asyncio_enabled_reactor_same_loop.py:8:35: Type `&lt;module 'asyncio'&gt;` has no attribute `WindowsSelectorEventLoopPolicy`
- error[lint:unresolved-attribute] /tmp/mypy_primer/projects/scrapy/tests/CrawlerProcess/asyncio_enabled_reactor_different_loop.py:8:35: Type `&lt;module 'asyncio'&gt;` has no attribute `WindowsSelectorEventLoopPolicy`
- error[lint:unresolved-attribute] /tmp/mypy_primer/projects/scrapy/scrapy/utils/reactor.py:84:17: Type `&lt;module 'asyncio'&gt;` has no attribute `WindowsSelectorEventLoopPolicy`
- error[lint:unresolved-attribute] /tmp/mypy_primer/projects/scrapy/scrapy/utils/reactor.py:86:18: Type `&lt;module 'asyncio'&gt;` has no attribute `WindowsSelectorEventLoopPolicy`
- error[lint:unresolved-attribute] /tmp/mypy_primer/projects/scrapy/tests/test_crawler.py:892:61: Type `&lt;module 'signal'&gt;` has no attribute `SIGBREAK`
- error[lint:unresolved-attribute] /tmp/mypy_primer/projects/scrapy/tests/test_crawler.py:906:61: Type `&lt;module 'signal'&gt;` has no attribute `SIGBREAK`
- Found 1570 diagnostics
+ Found 1564 diagnostics

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-09 08:59</div>
            <div class="timeline-body"><p>The new error in <code>zipp</code> is interesting... It raises questions whether we should raise unused ignore for <code>type: ignore</code> and in which cases</p>
<pre><code class="language-py">text_encoding = (
    io.text_encoding  # type: ignore[unused-ignore, attr-defined]
    if sys.version_info &gt; (3, 10)
    else _text_encoding
)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Silence unresolved-attribute diagnostics" to "[red-knot] Silence `unresolved-attribute` diagnostics in unreachable code" by @sharkdp on 2025-04-10 13:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Silence `unresolved-attribute` diagnostics in unreachable code" to "[red-knot] Silence `unresolved-attribute` in unreachable code" by @sharkdp on 2025-04-10 13:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @sharkdp on 2025-04-10 14:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2025-04-10 14:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2025-04-10 14:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @sharkdp on 2025-04-10 14:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-10 14:07</div>
            <div class="timeline-body"><blockquote>
<p>The new error in <code>zipp</code> is interesting... It raises questions whether we should raise unused ignore for <code>type: ignore</code> and in which cases</p>
</blockquote>
<p>@MichaReiser Is this something specific to this PR, or just a general thought? Anything that should be done about it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/semantic_index/use_def.rs</code>:364 on 2025-04-10 14:24</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    /// be unreachable. Use [`super::SemanticIndex::is_expression_reachable`] for the global
    /// analysis.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/semantic_index/use_def.rs</code>:379 on 2025-04-10 14:25</div>
            <div class="timeline-body"><pre><code class="language-suggestion">                    .expect(&quot;`is_expression_reachable` should only be called on expressions with recorded reachability&quot;),
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/semantic_index/use_def.rs</code>:937 on 2025-04-10 14:29</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        self.bindings_by_use.shrink_to_fit();
        self.expression_reachability.shrink_to_fit();
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:4536 on 2025-04-10 14:35</div>
            <div class="timeline-body"><p>it looks like computing <code>bound_on_instance</code> might be somewhat expensive, but we're doing it eagerly at the top of this branch whether or not <code>report_unresolved_attribute</code> resolves to <code>true</code>. Maybe turn that block of code into a lazy closure, so that we only evaluate it if we actually need to?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:7478 on 2025-04-10 14:36</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    /// stringified.
    ///
    /// This variant wraps a [`ScopedExpressionId`] that allows us to retrieve
    /// the original [`ast::ExprStringLiteral`] node which created the string annotation
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-04-10 14:37</div>
            <div class="timeline-body"><p>Nice, this LGTM</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:4536 on 2025-04-10 14:56</div>
            <div class="timeline-body"><p>Thanks. It's enough to just move that definition into the <code>if report_unresolved_attribute</code> branch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-04-10 14:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-10 15:15</div>
            <div class="timeline-body"><p>I manually checked that nothing changed in pybind11, so I'm ignoring the spurious cycle-panic-diff there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2025-04-10 15:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-04-10 15:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-10 15:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-10 16:32</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>The new error in <code>zipp</code> is interesting... It raises questions whether we should raise unused ignore for <code>type: ignore</code> and in which cases</p>
</blockquote>
<p>@MichaReiser Is this something specific to this PR, or just a general thought? Anything that should be done about it?</p>
</blockquote>
<p>I'll create a separate issue for it</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:41:06 UTC
    </footer>
</body>
</html>
