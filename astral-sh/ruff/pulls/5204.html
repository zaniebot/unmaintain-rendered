<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix ArgWithDefault comments handling - astral-sh/ruff #5204</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix ArgWithDefault comments handling</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5204">#5204</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-06-20 06:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>This PR fixes a few issues with formatting arguments that were introduced when upgrading to the latest RustPython parser (#5192).</p>
<ul>
<li>It upgrades RustPython again to pull in the fix that includes the range of the default argument in <code>ArgWithDefault</code> https://github.com/astral-sh/RustPython-Parser/pull/13</li>
<li>It overrides the <code>visit_arg_with_default</code> function in the <code>CommentsVisitor</code></li>
<li>It fixes a nasty issue where both the <code>ArgWithDefault</code> and <code>Arg</code> resolved to the same comments. My understanding of the issue is that Rust re-orders the fields in <code>ArgWithDefault</code> so that <code>Arg</code> becomes its first field. The result is that both the <code>ArgWithDefault</code> and <code>Arg</code> are stored at the same memory offset (but they don't end at the same memory offset). I wonder if we have the same problem with <code>RefEquality</code> (CC: @charliermarsh). The way I fixed the issue is by including the node kind in the equality check. This is safe because we only have this problem for nodes that don't box their children (which is why `BinaryExpression isn't affected by it) and recursive types need boxing (the only way that the parent and child have the same kind).</li>
</ul>
<h2>Test Plan</h2>
<p>I added a new test for formatting arguments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-20 06:32</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #5204</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5204" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5204?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @MichaReiser on 2023-06-20 06:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2023-06-20 06:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2023-06-20 06:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-06-20 06:58</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      6.4Â±0.01ms     6.4 MB/sec    1.00      6.3Â±0.01ms     6.4 MB/sec
formatter/numpy/ctypeslib.py               1.00   1343.8Â±1.72Âµs    12.4 MB/sec    1.00   1341.7Â±2.65Âµs    12.4 MB/sec
formatter/numpy/globals.py                 1.00    131.3Â±0.15Âµs    22.5 MB/sec    1.01    132.2Â±0.74Âµs    22.3 MB/sec
formatter/pydantic/types.py                1.00      2.6Â±0.00ms     9.7 MB/sec    1.00      2.6Â±0.01ms     9.7 MB/sec
linter/all-rules/large/dataset.py          1.00     12.9Â±0.02ms     3.1 MB/sec    1.00     12.9Â±0.01ms     3.1 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.3Â±0.00ms     5.1 MB/sec    1.00      3.3Â±0.01ms     5.1 MB/sec
linter/all-rules/numpy/globals.py          1.01    430.7Â±0.73Âµs     6.9 MB/sec    1.00    426.8Â±0.56Âµs     6.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.8Â±0.01ms     4.4 MB/sec    1.00      5.8Â±0.01ms     4.4 MB/sec
linter/default-rules/large/dataset.py      1.00      6.6Â±0.01ms     6.2 MB/sec    1.01      6.6Â±0.02ms     6.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1444.9Â±1.48Âµs    11.5 MB/sec    1.01   1461.0Â±1.71Âµs    11.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    164.1Â±0.22Âµs    18.0 MB/sec    1.03    168.9Â±0.26Âµs    17.5 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.0Â±0.00ms     8.5 MB/sec    1.01      3.0Â±0.00ms     8.4 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      7.5Â±0.08ms     5.4 MB/sec    1.00      7.6Â±0.05ms     5.4 MB/sec
formatter/numpy/ctypeslib.py               1.00  1551.8Â±18.30Âµs    10.7 MB/sec    1.01  1568.6Â±16.86Âµs    10.6 MB/sec
formatter/numpy/globals.py                 1.00    153.2Â±2.36Âµs    19.3 MB/sec    1.02    155.6Â±3.78Âµs    19.0 MB/sec
formatter/pydantic/types.py                1.00      3.1Â±0.06ms     8.2 MB/sec    1.03      3.2Â±0.09ms     7.9 MB/sec
linter/all-rules/large/dataset.py          1.00     15.3Â±0.17ms     2.7 MB/sec    1.01     15.5Â±0.17ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.0Â±0.07ms     4.1 MB/sec    1.01      4.1Â±0.05ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.00   499.3Â±23.35Âµs     5.9 MB/sec    1.00    497.3Â±6.41Âµs     5.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.8Â±0.14ms     3.7 MB/sec    1.00      6.8Â±0.08ms     3.7 MB/sec
linter/default-rules/large/dataset.py      1.00      7.9Â±0.07ms     5.1 MB/sec    1.01      8.0Â±0.08ms     5.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1704.4Â±17.27Âµs     9.8 MB/sec    1.00  1711.2Â±18.88Âµs     9.7 MB/sec
linter/default-rules/numpy/globals.py      1.00    198.0Â±3.97Âµs    14.9 MB/sec    1.01    199.7Â±3.42Âµs    14.8 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.6Â±0.03ms     7.1 MB/sec    1.00      3.6Â±0.03ms     7.1 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-06-20 14:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-20 14:56</div>
            <div class="timeline-body"><p>Is this upstream or downstream of the other RustPython upgrade PRs I have up?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-20 15:27</div>
            <div class="timeline-body"><blockquote>
<p>Is this upstream or downstream of the other RustPython upgrade PRs I have up?</p>
</blockquote>
<p>Depends on who merges first ;) The PR is https://github.com/astral-sh/RustPython-Parser/pull/13</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-20 15:29</div>
            <div class="timeline-body"><p>Looks like I win</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-06-20 20:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-06-20 20:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-06-20 20:48</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:58:13 UTC
    </footer>
</body>
</html>
