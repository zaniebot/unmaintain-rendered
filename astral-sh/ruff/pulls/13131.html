<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] support deferred evaluation of type expressions - astral-sh/ruff #13131</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] support deferred evaluation of type expressions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13131">#13131</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2024-08-28 00:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/carljm">@carljm</a> on 2024-08-28 00:52</div>
            <div class="timeline-body"><p>Prototype deferred evaluation of type expressions by deferring evaluation of class bases in a stub file. This allows self-referential class definitions, as occur with the definition of <code>str</code> in typeshed (which inherits <code>Sequence[str]</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @carljm on 2024-08-28 00:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-08-28 01:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:368 on 2024-08-28 01:09</div>
            <div class="timeline-body"><p>I don't love that this knowledge of whether the bases are deferred or not is spread across both type inference and here. But this explicit &quot;look in the right place first&quot; logic is more efficient than either an implicit &quot;first check one, then the other&quot; or merging/copying the two inferences. I'll think more tomorrow about whether there's a better way to consolidate this logic in one place.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-08-28 01:14</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/lazy-bases">CodSpeed Performance Report</a></h2>
<h3>Merging #13131 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>lazy-bases</code> (b9c1dd3) with <code>main</code> (c6023c0)</sub></p>
<h3>Summary</h3>
<p><code>✅ 32</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-08-28 01:22</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @carljm on 2024-08-28 01:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @carljm on 2024-08-28 01:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @carljm on 2024-08-28 01:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:368 on 2024-08-28 10:24</div>
            <div class="timeline-body"><p>Won't we also have to support deferred bases in <code>.py</code> files? Pyright and mypy both support recursive definitions like this in <code>.py</code> files:</p>
<pre><code class="language-py">class Foo(list[&quot;Foo | None&quot;]): pass
</code></pre>
<ul>
<li>https://mypy-play.net/?mypy=latest&amp;python=3.12&amp;gist=e9e1e5ebb6a0d34f80b190a395f19f7b</li>
<li>https://pyright-play.net/?pyrightVersion=1.1.368&amp;code=GYJw9gtgBALgngBwJYDsDmUkQWEMogCmAboQIYA2A%2BvAoQFCMDGFZAzm1AGJhgAUFJGxgBtAEQ8wUAD5QAcmBSExAXQCUALigJ2bRkVKUaiQn0l81IgAzr6QA</li>
</ul>
<p>Though I suppose we don't support stringified annotations of any kind yet. Worth a TODO comment, at least?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1 on 2024-08-28 10:27</div>
            <div class="timeline-body"><p>https://people.csail.mit.edu/paulfitz/spanish/t2.html</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1763 on 2024-08-28 10:33</div>
            <div class="timeline-body"><pre><code class="language-suggestion">            let symbol = symbols
                .symbol_id_by_name(id)
                .expect(&quot;Expected the symbol table to create a symbol for every Name node&quot;);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_db/src/files.rs</code>:432 on 2024-08-28 10:39</div>
            <div class="timeline-body"><p>I'd use <code>ruff_python_ast::PySourceType</code> here:</p>
<pre><code class="language-suggestion">            .is_some_and(|extension| PySourceType::from_extension(extension).is_stub())
</code></pre>
<p>if nothing else, for a bit more symmetry with the <code>is_notebook</code> function here:</p>
<p>https://github.com/astral-sh/ruff/blob/cfafaa7637ef3f568d62d39654e0498f52a07b77/crates/ruff_db/src/source.rs#L54-L66</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-28 10:40</div>
            <div class="timeline-body"><p>Overall this looks good!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-08-28 12:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:368 on 2024-08-28 12:42</div>
            <div class="timeline-body"><p>Ah yeah, good call. I did have a TODO about stringified annotations (and the future import) in an earlier draft here, but that method got removed and I forgot to re-add the TODO comment.</p>
<p>I'm tempted to add support for deferred partially-stringified bases in <code>.py</code> files in this PR, so as to clarify how it will impact logic like this. The awkward thing is just that stringified types in bases in <code>.py</code> are only valid as generic type parameters, so I'll need to see how much of the subscripting logic needs to be added along with that, and if that starts to feel like scope creep.</p>
<p>In any case, I think you're right that this means we can't know in advance whether the type of a particular base is deferred or not, so I will need to provide some facility for finding an expression type that's part of a definition without knowing that in advance.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-28 12:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:368 on 2024-08-28 12:46</div>
            <div class="timeline-body"><blockquote>
<p>I'm tempted to add support for deferred partially-stringified bases in <code>.py</code> files in this PR, so as to clarify how it will impact logic like this. The awkward thing is just that stringified types in bases in <code>.py</code> are only valid as generic type parameters, so I'll need to see how much of the subscripting logic needs to be added along with that, and if that starts to feel like scope creep.</p>
</blockquote>
<p>If it makes things easier -- in &quot;pyflakes-as-monkey-patched-by-<code>flake8-pyi</code>&quot;, we only allow forward references in class bases when they're inside generic type parameters. We run &quot;pyflakes-as-monkey-patched-by-<code>flake8-pyi</code>&quot; over the whole of typeshed with no false positives, so I think it would be fine if we decided in red-knot that we only wanted to permit forward references inside class bases if they're inside generic type parameters, even if the source file is a <code>.pyi</code> file. Since there's no known use case for forward references in class bases that are outside generic type parameters, this seems like it would make sense if it reduces complexity for our implementation by reducing the differences between <code>.py</code> files and <code>.pyi</code> files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-28 12:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:368 on 2024-08-28 12:50</div>
            <div class="timeline-body"><p>(I'm referring here to the <a href="https://github.com/PyCQA/flake8-pyi">original flake8-pyi plugin for flake8</a>, not Ruff's reimplementation of those lints. Ruff, I think, is slightly more permissive when it comes to the forward references it allows in <code>.pyi</code> files? I can't remember exactly where we landed on all of that... anyway, we're creating a semantic model &quot;from scratch&quot; here; there's no need to follow what Ruff does precisely.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-08-28 17:29</div>
            <div class="timeline-body"><p>I looked into the regression here, and it seems like it's increased Salsa overhead. This is consistent with the regression only showing up in the incremental benchmark, not the cold benchmark. I guess this is because we now double the number of tracked function memos for definitions, which are our highest-cardinality tracked struct.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-08-28 17:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:368 on 2024-08-28 17:54</div>
            <div class="timeline-body"><p>Adding support for stringified generic type params really felt like it would require adding generics support. Which I'd like to do, but not in this PR. So I didn't do that. But I did make the lookup generic in such a way that <code>ClassType::bases</code> no longer makes assumptions about whether a given base is deferred or not. And I added a TODO for the stringified generic type parameters.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-08-28 17:57</div>
            <div class="timeline-body"><p>I added tracking of whether a given definition has any deferred expressions, which allows us to avoid ever calling <code>infer_deferred_types</code> query on a definition that doesn't have any. Locally this seems to make the regression go away, will see if CodSpeed agrees.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-08-28 17:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-08-28 17:59</div>
            <div class="timeline-body"><p>Yay, CodSpeed agrees!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @carljm on 2024-08-28 18:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2024-08-28 18:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-08-28 18:41</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 21:39:02 UTC
    </footer>
</body>
</html>
