<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allow additional text following formatter pragma comments - astral-sh/ruff #8876</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Allow additional text following formatter pragma comments</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/8876">#8876</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2023-11-28 19:28
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/zanieb">@zanieb</a> on 2023-11-28 19:28</div>
            <div class="timeline-body"><p>I'm not sure if we should do this, but I was curious what it would look like to implement.</p>
<p>Closes https://github.com/astral-sh/ruff/issues/8874</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-11-28 19:42</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Allow additional text to folllow formatter pragma comments" to "Allow additional text to follow formatter pragma comments" by @zanieb on 2023-11-28 19:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Allow additional text to follow formatter pragma comments" to "Allow additional text following formatter pragma comments" by @zanieb on 2023-11-28 19:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @zanieb on 2023-11-28 20:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-11-28 23:58</div>
            <div class="timeline-body"><p>Seems reasonable. Can you double check if we the new implementation is flexible enough to cover Black's preview style https://github.com/astral-sh/ruff/issues/8892 (I don't see why we should gate this behind a preview flag)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-29 02:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/comments/mod.rs</code>:183 on 2023-11-29 02:35</div>
            <div class="timeline-body"><p>Could we just replace <code>match command.trim_whitespace_start()</code> with <code>match command.trim_whitespace_start(). split_whitespace().next()</code>? That is, could we just always split by whitespace and take the first token, rather than nesting the match expressions?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-11-29 03:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_python_formatter/src/comments/mod.rs</code>:183 on 2023-11-29 03:30</div>
            <div class="timeline-body"><p>Yes that's how I implemented it at first but then I was wondering if we should only allow comments on <code>fmt: off</code> and <code>fmt: skip</code> but not <code>fmt: on</code> which led me to this structure. I decided it'd be weird not to support <code>fmt: on - reason</code> though and I can see if being useful. I left it this way because I figured there may be a performance benefit and it's still easy to read. I'm happy to go back though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-11-29 03:46</div>
            <div class="timeline-body"><blockquote>
<p>Can you double check if we the new implementation is flexible enough to cover Black's preview style https://github.com/astral-sh/ruff/issues/8892</p>
</blockquote>
<p>While I agree we should allow pragma comments to follow other comments e.g. <code># foo # fmt: skip</code> or <code>#foo; fmt: skip</code>, I don't think this implementation will cover those cases and we'll need to do something a little more involved. Additionally, I don't think the semicolon separated format is supported by our linter pragmas e.g. <code># foo; noqa</code> and we should probably implement support for that in both at once?</p>
<p>Additionally, the syntax proposed here is actually <em>different</em> than Black's preview style. Black does not allow a reason unless it is separated by a <code>; </code> or <code># </code>:</p>
<pre><code class="language-python"># valid
foo   = 1  # fmt: skip; reason
foo   = 1  # noqa; fmt: skip; reason
foo   = 1  # fmt: skip; noqa
foo   = 1  # fmt: skip # reason
foo   = 1  # fmt: skip # reason # noqa
foo   = 1  # reason # fmt: skip

# invalid
foo   = 1  # fmt: skip - reason; noqa
foo   = 1  # fmt: skip - reason
foo   = 1  # fmt: skip reason
</code></pre>
<p>I'd be okay with requiring a <code>; </code> separator, I guess. Perhaps I should close this and we can focus on the Black syntax instead?</p>
<blockquote>
<p>I don't see why we should gate this behind a preview flag</p>
</blockquote>
<p>Agreed, unless we are unsure it is the right syntax to support.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-11-29 04:17</div>
            <div class="timeline-body"><p>In light of #8892 I think the goal here should be to determine if we want to allow trailing text after pragma directives. I think this question can be considered separately from multiple pragma directives e.g.</p>
<pre><code class="language-python">foo   =  1  # noqa - some reason; fmt: skip - other reason
</code></pre>
<p>This seems like a valid use-case?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-12-08 19:52</div>
            <div class="timeline-body"><p>I think I like this overall. It might be nice to start by sticking to Black's syntax here. It does look more conservative right? In that we could expand it something more liberal like you have here later?</p>
<blockquote>
<p>I think this question can be considered separately from multiple pragma directives e.g.</p>
</blockquote>
<p>My understanding here is that if this PR is merged as-is, then a comment like <code># noqa - some reason; fmt: skip - other reason</code> would today be allowed and be seen as just a <code>noqa</code> directive, right? But if you wanted to support that second <code>fmt: skip</code> directive, it would potentially change the meaning of what was once just free-form text to a pragma directive. I think a simple restriction on what's allowed in this PR would mitigate that concern? (If it's worth mitigating at all. It could be a non-issue.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-08 19:57</div>
            <div class="timeline-body"><p>I think it's correct to allow arbitrary contents after the <code># fmt: on</code> etc. It's also consistent with how we treat <code># noqa</code> in the linter.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-12-08 20:08</div>
            <div class="timeline-body"><p>I think we can close this pull request entirely, as the implementation of #8892 will make whatever happens here irrelevant.</p>
<p>It sounds like there's rough consensus to allow trailing text. We can either do that when implementing #8892 or after, depending on if it's more or less work :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2023-12-14 18:29</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 23:31:43 UTC
    </footer>
</body>
</html>
