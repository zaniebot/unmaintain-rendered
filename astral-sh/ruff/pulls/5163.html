<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Format StmtFor - astral-sh/ruff #5163</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Format StmtFor</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5163">#5163</a>
        opened by <a href="https://github.com/davidszotten">@davidszotten</a>
        on 2023-06-17 15:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a></div>
            <div class="timeline-body">

Summary
<p>format StmtFor</p>
<p>still trying to learn how to help out with the formatter. trying something slightly more advanced than <a href="#5158">break</a></p>
<p>mostly copied form StmtWhile</p>
Test Plan
<p>snapshots</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;basic impl copied from StmtWhile&quot; to &quot;StmtFor:  basic impl copied from StmtWhile&quot; by <a href="https://github.com/davidszotten">@davidszotten</a> on 2023-06-17 16:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-06-17 16:31</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>✅ ecosystem check detected no changes.</p>
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      6.9±0.02ms     5.9 MB/sec    1.01      6.9±0.01ms     5.9 MB/sec
formatter/numpy/ctypeslib.py               1.00   1378.2±2.69µs    12.1 MB/sec    1.04   1433.1±4.34µs    11.6 MB/sec
formatter/numpy/globals.py                 1.00    133.6±0.27µs    22.1 MB/sec    1.00    133.2±0.20µs    22.1 MB/sec
formatter/pydantic/types.py                1.00      2.9±0.01ms     8.9 MB/sec    1.01      2.9±0.00ms     8.9 MB/sec
linter/all-rules/large/dataset.py          1.00     13.7±0.04ms     3.0 MB/sec    1.02     13.9±0.05ms     2.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.4±0.00ms     4.9 MB/sec    1.01      3.5±0.01ms     4.8 MB/sec
linter/all-rules/numpy/globals.py          1.00    363.6±3.56µs     8.1 MB/sec    1.00    365.3±5.50µs     8.1 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.0±0.01ms     4.2 MB/sec    1.01      6.1±0.01ms     4.2 MB/sec
linter/default-rules/large/dataset.py      1.00      7.0±0.01ms     5.8 MB/sec    1.03      7.2±0.01ms     5.6 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1461.4±5.73µs    11.4 MB/sec    1.02   1497.3±3.42µs    11.1 MB/sec
linter/default-rules/numpy/globals.py      1.00    154.4±0.14µs    19.1 MB/sec    1.02    157.0±0.69µs    18.8 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.2±0.01ms     8.0 MB/sec    1.02      3.3±0.01ms     7.8 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01      9.8±0.34ms     4.2 MB/sec    1.00      9.6±0.37ms     4.2 MB/sec
formatter/numpy/ctypeslib.py               1.00  1997.8±75.16µs     8.3 MB/sec    1.01      2.0±0.12ms     8.3 MB/sec
formatter/numpy/globals.py                 1.03   199.0±13.21µs    14.8 MB/sec    1.00   192.7±12.89µs    15.3 MB/sec
formatter/pydantic/types.py                1.02      4.1±0.20ms     6.2 MB/sec    1.00      4.0±0.17ms     6.3 MB/sec
linter/all-rules/large/dataset.py          1.02     19.4±0.57ms     2.1 MB/sec    1.00     19.0±0.64ms     2.1 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.02      5.1±0.18ms     3.3 MB/sec    1.00      5.0±0.25ms     3.3 MB/sec
linter/all-rules/numpy/globals.py          1.00   621.7±30.06µs     4.7 MB/sec    1.01   625.6±33.97µs     4.7 MB/sec
linter/all-rules/pydantic/types.py         1.00      8.7±0.34ms     2.9 MB/sec    1.03      8.9±0.46ms     2.9 MB/sec
linter/default-rules/large/dataset.py      1.00      9.9±0.31ms     4.1 MB/sec    1.00      9.9±0.32ms     4.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00      2.2±0.10ms     7.7 MB/sec    1.00      2.2±0.13ms     7.7 MB/sec
linter/default-rules/numpy/globals.py      1.05   252.1±12.58µs    11.7 MB/sec    1.00   239.2±12.27µs    12.3 MB/sec
linter/default-rules/pydantic/types.py     1.02      4.5±0.17ms     5.6 MB/sec    1.00      4.4±0.19ms     5.7 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/snapshots/ruff_python_formatter__tests__ruff_test__statement__for_py.snap</code>:60 on 2023-06-18 11:10</div>
            <div class="timeline-body"><p>black doesn&#x27;t break this for statement, but i think this actually makes more sense</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/statement/stmt_for.rs</code>:38 on 2023-06-18 11:14</div>
            <div class="timeline-body"><p>We might need a new setting that actually removes expression parentheses if not used, i&#x27;ll experiment with this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-06-18 11:17</div>
            <div class="timeline-body"><p>You picked a tough node but this looks good barring ExprTuple always keeping its parentheses (because i missed that case in ExprTuple)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/snapshots/ruff_python_formatter__tests__ruff_test__statement__for_py.snap</code>:60 on 2023-06-18 12:28</div>
            <div class="timeline-body"><p>hm. interesting (how did you notice the difference?)</p>
<p>at this point, do we have a policy/guidelines for matching black (to help people migrate) vs improving formatting? maybe we raise an issue or otherwise to see if the black maintainers also prefer this formatting?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-06-18 12:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/davidszotten">@davidszotten</a> on 2023-06-18 12:29</div>
            <div class="timeline-body"><blockquote>
<p>You picked a though node</p>
</blockquote>
<p>Impl is mostly copied from <code>StmtWhile</code> which made it easier. Still trying to learn my way around</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-06-18 13:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/snapshots/ruff_python_formatter__tests__ruff_test__statement__for_py.snap</code>:60 on 2023-06-18 13:01</div>
            <div class="timeline-body"><p>Our goal is to match black except in edge cases, but we haven&#x27;t formalized what exactly this means. I&#x27;ll discuss with @MichaReiser tomorrow what we want do about this</p>
<blockquote>
<p>how did you notice the difference?</p>
</blockquote>
<p>copied the code and ran black over it ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/snapshots/ruff_python_formatter__tests__ruff_test__statement__for_py.snap</code>:60 on 2023-06-18 13:08</div>
            <div class="timeline-body"><blockquote>
<p>copied the code and ran black over it ;)</p>
</blockquote>
<p>is it only the tests from black&#x27;s test suite that automatically compare to black&#x27;s output?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-06-18 13:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/konstin">@konstin</a> on 2023-06-18 13:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/snapshots/ruff_python_formatter__tests__ruff_test__statement__for_py.snap</code>:60 on 2023-06-18 13:40</div>
            <div class="timeline-body"><p>at the moment, yes</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-06-18 13:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-06-18 16:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/statement/stmt_for.rs</code>:38 on 2023-06-18 16:47</div>
            <div class="timeline-body"><p>do we want to keep this open pending that or merge as is for now?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-06-21 18:34</div>
            <div class="timeline-body"><p>Finally got around to it: <a href="https://github.com/astral-sh/ruff/pull/5175">astral-sh/ruff#5175</a></p>
<p>This should hopefully unblock you, using</p>
<pre><code>#[derive(Debug)]
struct ExprTupleWithoutParentheses&lt;&#x27;a&gt;(&amp;&#x27;a Expr);

impl Format&lt;PyFormatContext&lt;&#x27;_&gt;&gt; for ExprTupleWithoutParentheses&lt;&#x27;_&gt; {
    fn fmt(&amp;self, f: &amp;mut Formatter&lt;PyFormatContext&lt;&#x27;_&gt;&gt;) -&gt; FormatResult&lt;()&gt; {
        match self.0 {
            Expr::Tuple(expr_tuple) =&gt; expr_tuple
                .format()
                .with_options(TupleParentheses::StripInsideForLoop)
                .fmt(f),
            other =&gt; other.format().with_options(Parenthesize::IfBreaks).fmt(f),
        }
    }
}
</code></pre>
<p>and <code>ExprTupleWithoutParentheses(target.as_ref()),</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/statement/stmt_for.rs</code>:82 on 2023-06-21 18:59</div>
            <div class="timeline-body"><p>Could you add a <code>debug_assert!</code> here that in the <code>orelse.is_empty()</code> case <code>or_else_comments</code> is also empty?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-06-21 19:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-06-21 20:59</div>
            <div class="timeline-body"><p>thanks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;StmtFor:  basic impl copied from StmtWhile&quot; to &quot;Fromat StmtFor&quot; by <a href="https://github.com/konstin">@konstin</a> on 2023-06-21 21:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Fromat StmtFor&quot; to &quot;Format StmtFor&quot; by <a href="https://github.com/konstin">@konstin</a> on 2023-06-21 21:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/konstin">@konstin</a> on 2023-06-21 21:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/konstin">@konstin</a> on 2023-06-21 21:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-07-07 20:48</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:54:35 UTC
    </footer>
</body>
</html>
