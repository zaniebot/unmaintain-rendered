<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Class literal `__new__` function callable subtyping - astral-sh/ruff #17533</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Class literal <code>__new__</code> function callable subtyping</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17533">#17533</a>
        opened by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a>
        on 2025-04-21 23:21
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>From https://typing.python.org/en/latest/spec/constructors.html#converting-a-constructor-to-callable</p>
<p>this covers step 2 and partially step 3 (always respecting the <code>__new__</code>)</p>
<h2>Test Plan</h2>
<p>Update is_subtype_of.md</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MatthewMckee4 on 2025-04-21 23:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MatthewMckee4 on 2025-04-21 23:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @MatthewMckee4 on 2025-04-21 23:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @MatthewMckee4 on 2025-04-21 23:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-21 23:23</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1169 on 2025-04-22 00:26</div>
            <div class="timeline-body"><pre><code class="language-suggestion">
// TODO handle `__init__` also
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:5949 on 2025-04-22 00:28</div>
            <div class="timeline-body"><p>nit: I don't think the <code>_type</code> suffix adds anything here, we can just call this <code>into_bound_method</code>.</p>
<p>If we are going to add this utility, it seems like there are quite a few other places we may as well use it -- basically everywhere we are currently calling <code>BoundMethodType::new</code>, I think?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_subtype_of.md</code>:1206 on 2025-04-22 00:30</div>
            <div class="timeline-body"><pre><code class="language-suggestion">```

#### Classes with `__call__` and `__new__`

If `__call__` and `__new__` are both present, `__call__` takes precedence.

```py
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-04-22 00:31</div>
            <div class="timeline-body"><p>Looks good, thank you! Just a couple comments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-04-22 00:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:5949 on 2025-04-22 00:37</div>
            <div class="timeline-body"><p>I added it to match the function above</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:5949 on 2025-04-22 00:46</div>
            <div class="timeline-body"><p>Ah ok. I don't think either of them needs it (the <code>_type</code> suffix), but it really doesn't matter either way, fine to leave it as is</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-04-22 00:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_subtype_of.md</code>:1203 on 2025-04-22 00:48</div>
            <div class="timeline-body"><pre><code class="language-suggestion">```py
from typing import Callable
from knot_extensions import TypeOf, static_assert, is_subtype_of

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1170 on 2025-04-22 00:49</div>
            <div class="timeline-body"><pre><code class="language-suggestion">            // TODO handle `__init__` also
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-04-22 00:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @MichaReiser on 2025-04-22 06:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-22 10:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>playground/shared/package-lock.json</code>:1 on 2025-04-22 10:47</div>
            <div class="timeline-body"><p>need to delete this file :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-04-22 11:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>playground/shared/package-lock.json</code>:1 on 2025-04-22 11:41</div>
            <div class="timeline-body"><p>Sorry, will do soon</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1167 on 2025-04-22 15:57</div>
            <div class="timeline-body"><p>nit:</p>
<pre><code class="language-suggestion">                    return new_function.into_bound_method_type(db, self).is_subtype_of(db, target);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:5952 on 2025-04-22 16:00</div>
            <div class="timeline-body"><p>The parameter name is a bit misleading because in this PR above where this is being called it's not an instance of the class but the class itself. This is also the case for the field name on <code>BoundMethodType</code> which is also called <code>self_instance</code>. I'm not sure what to name it, maybe <code>self_or_cls</code> (and remove the <code>_instance</code> suffix).</p>
<p>Regardless, this shouldn't block this PR and something that could be done in a follow-up instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-04-22 16:06</div>
            <div class="timeline-body"><p>Thank you.</p>
<p>I think it would be useful to create a <code>into_callable</code> method on <code>ClassLiteralType</code> to avoid expanding the <code>is_subtype_of</code> and to keep the match arms simple.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-22 16:12</div>
            <div class="timeline-body"><p>Sounds good</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-04-22 18:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:830 on 2025-04-22 18:02</div>
            <div class="timeline-body"><p>For some reason this wasnt working</p>
<pre><code class="language-rs">        let metaclass_call_function_symbol = self
            .class_member(
                db,
                &quot;__call__&quot;,
                MemberLookupPolicy::NO_INSTANCE_FALLBACK
                    | MemberLookupPolicy::META_CLASS_NO_TYPE_FALLBACK,
            )
            .symbol;
</code></pre>
<p>It couldn't find <code>__call__</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:830 on 2025-04-23 05:39</div>
            <div class="timeline-body"><p>I suspect it found it, but it wasn't a <code>BoundMethod</code>. That's because it's <code>Type::member_lookup_with_policy</code> that implements the descriptor protocol, which turns a <code>FunctionType</code> into a <code>BoundMethod</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-04-23 05:40</div>
            <div class="timeline-body"><p>Looks good, thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @carljm on 2025-04-23 05:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-04-23 05:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-25 20:55</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:11:46 UTC
    </footer>
</body>
</html>
