<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feat: detect changes also in configuration files - astral-sh/ruff #4169</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Feat: detect changes also in configuration files</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4169">#4169</a>
        opened by <a href="https://github.com/mikeleppane">@mikeleppane</a>
        on 2023-05-01 11:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mikeleppane">@mikeleppane</a></div>
            <div class="timeline-body"><p>Detect changes also in configuration files. Detected config files are: pyproject.toml, ruff.toml,.ruff.toml</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-05-01 12:04</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>✅ ecosystem check detected no changes.</p>
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.03     19.4±0.47ms     2.1 MB/sec    1.00     18.8±0.45ms     2.2 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.04      4.6±0.23ms     3.6 MB/sec    1.00      4.4±0.12ms     3.8 MB/sec
linter/all-rules/numpy/globals.py          1.02   552.8±19.44µs     5.3 MB/sec    1.00   543.8±13.65µs     5.4 MB/sec
linter/all-rules/pydantic/types.py         1.04      8.0±0.36ms     3.2 MB/sec    1.00      7.7±0.25ms     3.3 MB/sec
linter/default-rules/large/dataset.py      1.04      9.3±0.28ms     4.4 MB/sec    1.00      9.0±0.42ms     4.5 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.05  1992.2±70.52µs     8.4 MB/sec    1.00  1895.0±45.30µs     8.8 MB/sec
linter/default-rules/numpy/globals.py      1.00    224.4±9.69µs    13.1 MB/sec    1.02   228.8±17.89µs    12.9 MB/sec
linter/default-rules/pydantic/types.py     1.03      4.1±0.15ms     6.2 MB/sec    1.00      4.0±0.08ms     6.4 MB/sec
parser/large/dataset.py                    1.03      7.5±0.21ms     5.4 MB/sec    1.00      7.3±0.11ms     5.6 MB/sec
parser/numpy/ctypeslib.py                  1.04  1488.1±89.71µs    11.2 MB/sec    1.00  1427.0±73.31µs    11.7 MB/sec
parser/numpy/globals.py                    1.00    141.7±7.21µs    20.8 MB/sec    1.01   142.6±10.78µs    20.7 MB/sec
parser/pydantic/types.py                   1.02      3.2±0.10ms     8.0 MB/sec    1.00      3.1±0.09ms     8.2 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     16.1±0.11ms     2.5 MB/sec    1.00     16.0±0.09ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.1±0.04ms     4.1 MB/sec    1.00      4.1±0.05ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.00   485.0±10.56µs     6.1 MB/sec    1.00    484.6±6.42µs     6.1 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.8±0.05ms     3.7 MB/sec    1.00      6.8±0.05ms     3.8 MB/sec
linter/default-rules/large/dataset.py      1.00      8.2±0.05ms     5.0 MB/sec    1.00      8.2±0.04ms     5.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1726.5±14.93µs     9.6 MB/sec    1.00  1725.1±15.37µs     9.7 MB/sec
linter/default-rules/numpy/globals.py      1.00    191.6±2.89µs    15.4 MB/sec    1.02    196.3±8.04µs    15.0 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.7±0.03ms     7.0 MB/sec    1.01      3.7±0.09ms     6.9 MB/sec
parser/large/dataset.py                    1.00      6.7±0.06ms     6.1 MB/sec    1.01      6.7±0.05ms     6.1 MB/sec
parser/numpy/ctypeslib.py                  1.00  1265.3±15.28µs    13.2 MB/sec    1.01  1275.2±15.47µs    13.1 MB/sec
parser/numpy/globals.py                    1.00    128.9±2.00µs    22.9 MB/sec    1.00    129.5±1.82µs    22.8 MB/sec
parser/pydantic/types.py                   1.00      2.8±0.03ms     9.1 MB/sec    1.01      2.8±0.03ms     9.0 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_cli/src/lib.rs</code>:231 on 2023-05-01 12:06</div>
            <div class="timeline-body"><p>I think we have to recompute most of the variables defined above starting from line 115 whenever a <code>pyproject.toml</code> changes. For example, you can configure the output format in the settings and we should respect that change if we support reloading configuration files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-01 12:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-01 12:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_cli/src/lib.rs</code>:56 on 2023-05-01 12:08</div>
            <div class="timeline-body"><p>Nit: I recommend matching on the extension or file name explicitly. E.g. we don&#x27;t want to match a file named <code>py</code></p>
<pre><code>	if matches!(path.file_name(), Some(&quot;pyproject.toml&quot; | &quot;ruff.toml&quot; |&quot;.ruff.toml&quot;)) {
		true
	} else if matches!(path.extension(), Some(&quot;py&quot; | &quot;pyi&quot;)) { 
		true
	} else { false }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/mikeleppane">@mikeleppane</a> on <code>crates/ruff_cli/src/lib.rs</code>:56 on 2023-05-02 05:33</div>
            <div class="timeline-body"><p>Good catch!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mikeleppane">@mikeleppane</a> reviewed on 2023-05-02 05:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mikeleppane">@mikeleppane</a> reviewed on 2023-05-02 05:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/mikeleppane">@mikeleppane</a> on <code>crates/ruff_cli/src/lib.rs</code>:231 on 2023-05-02 05:46</div>
            <div class="timeline-body"><p>Absolutely! Is there now something more to be recalculated other than pyproject_strategy?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-02 07:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_cli/src/lib.rs</code>:231 on 2023-05-02 07:14</div>
            <div class="timeline-body"><p>I&#x27;m not too familiar with that code. A safe assumption would be to re-compute everything that is derived  from the <code>pyproject_strategy</code> (all settings that are supported in the configuration and aren&#x27;t CLI options only). I wonder if we even have to be clever about it or if we can simply call <code>check</code> again. The main challenge that I see with that approach is that we might mess up the printer output because watch uses <code>write_continuously</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_cli/src/lib.rs</code>:51 on 2023-05-03 09:59</div>
            <div class="timeline-body"><p>Making this configurable seems overkill for now. I would prefer matching statically on the file name and extension. That should also allow the compiler to optimize the code better (see my original comment on how to implement it with a match).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_cli/src/lib.rs</code>:53 on 2023-05-03 10:02</div>
            <div class="timeline-body"><p>We can keep this a standalone function and instead introduce a new tri-boolean type to signal whether to ignore the change, it&#x27;s a python file, or a configuration change</p>
<pre><code>#[derive(Copy, Clone, Debug, Eq, PartialEq)]
enum ChangeKind {
	Configuration,
	SourceFile,
	Ignore
}

fn detect_change(paths: &amp;[PathBuf]) -&gt; ChangeKind {
	...
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_cli/src/lib.rs</code>:260 on 2023-05-03 10:04</div>
            <div class="timeline-body"><p>Only re-computing the <code>pyproject_strategy</code>, is, unfortunately, not sufficient. There are multiple derived variables on line 107-185 that need to be recomputed too</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2023-05-03 10:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_cli/src/lib.rs</code>:260 on 2023-05-09 16:17</div>
            <div class="timeline-body"><p>I added a TODO for this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-09 16:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-09 16:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-09 16:22</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:53:27 UTC
    </footer>
</body>
</html>
