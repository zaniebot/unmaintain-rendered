<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attribute panics to the mdtests that cause them - astral-sh/ruff #15241</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Attribute panics to the mdtests that cause them</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15241">#15241</a>
        opened by <a href="https://github.com/dcreager">@dcreager</a>
        on 2025-01-03 16:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dcreager">@dcreager</a> on 2025-01-03 16:39</div>
            <div class="timeline-body"><p>This updates the mdtest harness to catch any panics that occur during type checking, and to display the panic message as an mdtest failure.  (We don't know which specific line causes the failure, so we attribute panics to the first line of the test case.)</p>
<p>Sample output (for an artificial panic):</p>
<pre><code>---- mdtest__unary_integers stdout ----

integers.md - Unary Operations - Unary Addition

  crates/red_knot_python_semantic/resources/mdtest/unary/integers.md:6 panicked at crates/red_knot_python_semantic/src/types/infer.rs:3264:66:
  crates/red_knot_python_semantic/resources/mdtest/unary/integers.md:6 bonk

To rerun this specific test, set the environment variable: MDTEST_TEST_FILTER=&quot;integers.md - Unary Operations - Unary Addition&quot;
MDTEST_TEST_FILTER=&quot;integers.md - Unary Operations - Unary Addition&quot; cargo test -p red_knot_python_semantic --test mdtest -- mdtest__unary_integers

integers.md - Unary Operations - Unary Subtraction

  crates/red_knot_python_semantic/resources/mdtest/unary/integers.md:14 panicked at crates/red_knot_python_semantic/src/types/infer.rs:3265:66:
  crates/red_knot_python_semantic/resources/mdtest/unary/integers.md:14 foobar

To rerun this specific test, set the environment variable: MDTEST_TEST_FILTER=&quot;integers.md - Unary Operations - Unary Subtraction&quot;
MDTEST_TEST_FILTER=&quot;integers.md - Unary Operations - Unary Subtraction&quot; cargo test -p red_knot_python_semantic --test mdtest -- mdtest__unary_integers
</code></pre>
<p>Closes #13899</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dcreager on 2025-01-03 16:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dcreager on 2025-01-03 16:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dcreager on 2025-01-03 16:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @dcreager on 2025-01-03 16:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ruff_db/src/panic.rs</code>:24 on 2025-01-03 16:41</div>
            <div class="timeline-body"><p>All of the chatter in this crate is just to publicize this existing helper function.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/red_knot_test/src/lib.rs</code>:151 on 2025-01-03 16:42</div>
            <div class="timeline-body"><p>This does not include the full backtrace of the panic, since that seemed to be more verbose than we need at this point.  If we want it, we just change <code>info.info</code> to <code>info</code> here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-01-03 16:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-03 16:51</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-01-03 16:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by @AlexWaygood on 2025-01-03 16:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-01-03 17:04</div>
            <div class="timeline-body"><p>Nice, this looks great! :D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-01-03 17:35</div>
            <div class="timeline-body"><p>Neat</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dcreager on 2025-01-03 18:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dcreager on 2025-01-03 18:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-03 18:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-01-05 19:43</div>
            <div class="timeline-body"><p>Hmm, this PR unfortunately now seems to be suppressing some of the internal error messages from <code>red_knot_test</code>, for example this one here:</p>
<p>https://github.com/astral-sh/ruff/blob/b26448926a8c2f61befa17b8ffa1dd0ac3232c9c/crates/red_knot_test/src/lib.rs#L32-L37</p>
<p>On a PR branch I'm working on, I got this (not very informative!) test failure:</p>
<p><img src="https://github.com/user-attachments/assets/b918b880-9ea9-41a7-9829-3e8b38a7c8cf" alt="image" /></p>
<p>If I revert this commit on that PR branch, I get this instead, which is much more helpful:</p>
<p><img src="https://github.com/user-attachments/assets/37d85078-dbba-42b3-a83d-7099b8e4cb4b" alt="image" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-01-07 14:14</div>
            <div class="timeline-body"><p>I opened https://github.com/astral-sh/ruff/issues/15317 so we don't forget about this üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-01-07 14:20</div>
            <div class="timeline-body"><p>Thanks Alex!  I'll take a look</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 20:34:29 UTC
    </footer>
</body>
</html>
