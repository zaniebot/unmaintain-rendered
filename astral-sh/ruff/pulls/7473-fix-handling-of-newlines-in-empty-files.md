```yaml
number: 7473
title: Fix handling of newlines in empty files
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: fix-empty-file-newlines
created_at: 2023-09-17T21:00:19Z
updated_at: 2023-09-18T06:08:11Z
url: https://github.com/astral-sh/ruff/pull/7473
synced_at: 2026-01-12T15:55:24Z
```

# Fix handling of newlines in empty files

---

_@MichaReiser_

## Summary

#7456 regressed our similarity index significantly because it enforced a trailing newline for all files, including files that only contain non-newline whitespace.

This diverges from Black that only inserts a trailing newline if the source isn't all empty and contains one or multiple newlines. The reason why this caused a big regression is because most 
`__init__.py` files are all-empty, not needing a trailing newline. .py`


## Test Plan

Newly added tests.

The similarity index is now back on track (with one fixed transformer test!)

| project      | similarity index  | total files       | changed files     |
|--------------|------------------:|------------------:|------------------:|
| cpython      |           0.76083 |              1789 |              1632 |
| django       |           0.99982 |              2760 |                37 |
| transformers |           0.99957 |              2587 |               398 |
| twine        |           1.00000 |                33 |                 0 |
| typeshed     |           0.99983 |              3496 |                18 |
| warehouse    |           0.99929 |               648 |                16 |
| zulip        |           0.99962 |              1437 |                22 |


---

_Comment by @MichaReiser on 2023-09-17 21:00_

Current dependencies on/for this PR:
* main
  * **PR #7473** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7473" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7473?utm_source=stack-comment).

---

_Label `formatter` added by @MichaReiser on 2023-09-17 21:01_

---

_@charliermarsh approved on 2023-09-17 21:01_

---

_Merged by @MichaReiser on 2023-09-18 06:08_

---

_Closed by @MichaReiser on 2023-09-18 06:08_

---

_Branch deleted on 2023-09-18 06:08_

---
