```yaml
number: 1279
title: Web playground with WASM
type: pull_request
state: merged
author: squiddy
labels: []
assignees: []
merged: true
base: main
head: wasm
created_at: 2022-12-18T16:13:03Z
updated_at: 2022-12-27T05:42:27Z
url: https://github.com/astral-sh/ruff/pull/1279
synced_at: 2026-01-12T05:36:31Z
```

# Web playground with WASM

---

_Pull request opened by @squiddy on 2022-12-18 16:13_

This MR provides a web playground for ruff. https://611ef32d.ruff-axw.pages.dev/

* on-the-fly linting of code
* configuration can be adjusted
* persists config & source code in the URL for sharing ([Example with code & config](https://611ef32d.ruff-axw.pages.dev/#N4Ig5gNg9gRghhAziAXKRBTCGDGAXVEAbQB0QBRMgGgAIyAxaukAVTIF0QqQIBLAOwwBabPzB4AFoQBsABhABfBQBJVAYhoBhKAAcAngCdeYCXhoAKHAEoaAWV44DURFABmZ7QZ1QDcPLyh+ADoaAEEICBojEzxEKIxMAwA3DAATIIAoDQAZBwx+TFSaAFd+VIwDGkkMOwBJABUaXJx8zEyQDpZ-Pjw9GldS-ACCmjgymhwIOERMONcfEswaAHdeSSjS-gEwKqgoJBooFMrsgGUABSCOkAyM1ycAWxoAfWeBvGKDDFeaXgfvAxmMb8KB4PzDRC3P4AszODLQnywxBBHR+CTw-6ImiINYYDEw7HFGA6JwtGb4rGIPSQhGAqoSL5wVLbO6PKp6HTbX6Yumhfh6WinDAAR2K+RatBYW0Ctw0pzgKXpNWWPgA1lzmV98D4+sVCisJPkaNAmVzJLw4g8oKlitgMqdyAAlABqTuemgA6gARGgAXkOyLAGDwOGWqXMVgynq9z2yAHlNABpP30xnMsRBbJQHCqiO3DLlVyjRDPPiIPCWQJ4fJ4FBhfk0AA+xoteCIfL07CbVWKOmw7f5tCCw-YNiEAD4W+WB52UBkaAuaNdyAVPgkVjUEMs4NSaEGgVOCB154veEWLQJy2MWpX+NW77RzGW8LQPn2MFYrHPFz-4h8DPwh63veeCRj+Xz-oBRA4FWNbsPmzw4tWzyopIcT+m+2DmCeC5EDhv7OCiaJBCCBgPDg0wYOYhGoRIJE+P8aLmDon74T+8yVDovyAeY0ylq25hIRgQT7kJqI5nAQaIBGNgANTFvx5aCbiInBnqFRiXAElSTJYGLvBka3IWvwlogcAPN8tHmK4vDYChaIAIx1uWBi0DZdm0QATM5eAGGOk4wHsEDfou1yOmpAFxL5Yq-EWeAqjQtFxHAXxKti5nCdc+EQZ8gE0cRpHkZR1HIrR9FkVZ7mWY5n5+v6+WSOVRWYNhv6Lg1dGFZVtnVZInl6QuhkFhg54ljgnxfHezwCNWXgQRU5gYAAHrgxRgjA2A+X5NATjQgX7CFC5hRFIzRTUZ5pctq3rdgiVoiZ6UWcWaXjQYk1mDNFQksGFRXMe4EnSZiEZfZkiLSt403RgtBUsiV2Q3AG0fvmxkWoheCpHwMBvD11k9aDEhbf5e1BYdS4dOFkE0PUBgxRd1T9D1e1YIEYBRVA2JgmUKVFFjvgGHof03ADVMdU1FEtWLXVMVVBOfkEV6Aogqxg4huIE4gQ3GYgji8DosTmJ9c0-QYRM7ZOLlk8dkFRYaowwC4EBrTUtG7KMgFG99s0AORxDrRj63Emq4HgOpC9lgOtW1hLEqSCTIjgho5s8UBrToa1R9Hi54VnWee-NrlsbnR1CDgXBF8XIC0mYsMwfwNlgAA3IlRh3oJ1J1w3ql4AT5i+7rgfe5+5fFwu8FZwNv5BOUMHlHmWcK75evz4uQ2TNMcSOqU4WILatb4dccYwAAViHbsSPsRRfLvEBmPcUBPLT-BbGIuz7OH+HGa8AhrK8glYK4GGGNU61k5q5Tm5Q3pEzJj+TAEBXCL1SCAraKZyxILWhXbEADEEVFNmA1BGNcEoxGhsfgvd8IpTAEkOsQpRTigwEQFy7AqD4XUujdMLCfyhlSJwxcLhPgtDrFKYYjDfK0AAHKBAwF2f0kjBAsOJlvfgO895WwpqUZKyVALwzWojbA4cfwXTYWggQMDFwqwkDHEk2Z45BHOLofImdc6UKSLw4u4prTbF9CANarghAAA4R6jzQSA30u9Y42JmHY2o5xyBuNzmg3BYSiTWLJMic4MS4mYNgRjAQySIlpOibE+JWduG+m4SU1ez1UnxzMW1HKAEaBKJUbfcwAAqGpUSYIPAeKUBwfgqICHTngMJqcDAtFYj+LAmA6nxBvmYf04TOnIifk4rOLjKltQ8emMA3jfEBKCcXEJa18nLKKVk0eECklLLjlEjJxTsmLkTrgVUvp6AIEwJs38ZSKmYMniLXKTTt4JD3uYa+e9EEgNoOC2+OC3qRiAA))

---

Technical details:

* Split lib/main into wasm and native

Not all dependencies compile under the wasm target (or make sense to even include). I thought it best to make that explicit by splitting up the lib.rs between native and wasm.
For main.rs I didn't find any other solution, apparantely one can not tell cargo to *not* build a binary under certain targets. The current main makes use of rayon and the current iterator wrapper breaks code check / clippy. I couldn't think of a good use case for WASM to have a direct entrypoint, so currently under wasm I provide a noop implementation.

* Add web playground

Similar to @charliermarsh's original implementation this is based on vite & monaco-editor. The checks currently fail because I included a step to deploy the final result to cloudflare pages. Which obviously doesn't work due to the lack of secrets, and it also needs to be moved to some other main-only workflow.

* Auto-generated options.ts

This powers the configuration in the playground. I'm keeping an eye on the current work on the JSON schema. Potentially that schema can replace the dev command I'm introducing here.

---

More can be done on the playground itself, but I'd appreciate some reviews, especially on the wasm side of things. Perhaps some of this can be merged and we iterate on the playground in future MRs.

---

_Comment by @charliermarsh on 2022-12-19 01:12_

Nice, this would be cool to have. I published https://ruff.pages.dev/ at some point based on that code, it'd be nice to have that continuously deployed, more prominent, officially part of the codebase with WASM support, etc. Very supportive of this!

---

_Comment by @squiddy on 2022-12-19 20:17_

Put together some configuration panel. Auto-generated from our options annotations. Not very user friendly, but wanted to see how easy passing in options from JS to rust is: very easy thanks to serde+wasm.

![image](https://user-images.githubusercontent.com/50333/208511837-54ed181d-7f04-43bc-9c4c-122a95708929.png)


---

_Comment by @didiercolens on 2022-12-20 08:22_

this is awesome, testing it in a web app with codemirror and works great! thanks a lot @squiddy and @charliermarsh 

---

_Marked ready for review by @squiddy on 2022-12-22 14:00_

---

_Comment by @squiddy on 2022-12-22 14:02_

Marking as ready. I updated the MR description with some more details.

Sharing config & code via URL works now: [Example](https://611ef32d.ruff-axw.pages.dev/#N4Ig5gNg9gRghhAziAXKRBTCGDGAXVEAbQB0QBRMgGgAIyAxaukAVTIF0QqQIBLAOwwBabPzB4AFoQBsABhABfBQBJVAYhoBhKAAcAngCdeYCXhoAKHAEoaAWV44DURFABmZ7QZ1QDcPLyh+ADoaAEEICBojEzxEKIxMAwA3DAATIIAoDQAZBwx+TFSaAFd+VIwDGkkMOwBJABUaXJx8zEyQDpZ-Pjw9GldS-ACCmjgymhwIOERMONcfEswaAHdeSSjS-gEwKqgoJBooFMrsgGUABSCOkAyM1ycAWxoAfWeBvGKDDFeaXgfvAxmMb8KB4PzDRC3P4AszODLQnywxBBHR+CTw-6ImiINYYDEw7HFGA6JwtGb4rGIPSQhGAqoSL5wVLbO6PKp6HTbX6Yumhfh6WinDAAR2K+RatBYW0Ctw0pzgKXpNWWPgA1lzmV98D4+sVCisJPkaNAmVzJLw4g8oKlitgMqdyAAlABqTuemgA6gARGgAXkOyLAGDwOGWqXMVgynq9z2yAHlNABpP30xnMsRBbJQHCqiO3DLlVyjRDPPiIPCWQJ4fJ4FBhfk0AA+xoteCIfL07CbVWKOmw7f5tCCw-YNiEAD4W+WB52UBkaAuaNdyAVPgkVjUEMs4NSaEGgVOCB154veEWLQJy2MWpX+NW77RzGW8LQPn2MFYrHPFz-4h8DPwh63veeCRj+Xz-oBRA4FWNbsPmzw4tWzyopIcT+m+2DmCeC5EDhv7OCiaJBCCBgPDg0wYOYhGoRIJE+P8aLmDon74T+8yVDovyAeY0ylq25hIRgQT7kJqI5nAQaIBGNgANTFvx5aCbiInBnqFRiXAElSTJYGLvBka3IWvwlogcAPN8tHmK4vDYChaIAIx1uWBi0DZdm0QATM5eAGGOk4wHsEDfou1yOmpAFxL5Yq-EWeAqjQtFxHAXxKti5nCdc+EQZ8gE0cRpHkZR1HIrR9FkVZ7mWY5n5+v6+WSOVRWYNhv6Lg1dGFZVtnVZInl6QuhkFhg54ljgnxfHezwCNWXgQRU5gYAAHrgxRgjA2A+X5NATjQgX7CFC5hRFIzRTUZ5pctq3rdgiVoiZ6UWcWaXjQYk1mDNFQksGFRXMe4EnSZiEZfZkiLSt403RgtBUsiV2Q3AG0fvmxkWoheCpHwMBvD11k9aDEhbf5e1BYdS4dOFkE0PUBgxRd1T9D1e1YIEYBRVA2JgmUKVFFjvgGHof03ADVMdU1FEtWLXVMVVBOfkEV6Aogqxg4huIE4gQ3GYgji8DosTmJ9c0-QYRM7ZOLlk8dkFRYaowwC4EBrTUtG7KMgFG99s0AORxDrRj63Emq4HgOpC9lgOtW1hLEqSCTIjgho5s8UBrToa1R9Hi54VnWee-NrlsbnR1CDgXBF8XIC0mYsMwfwNlgAA3IlRh3oJ1J1w3ql4AT5i+7rgfe5+5fFwu8FZwNv5BOUMHlHmWcK75evz4uQ2TNMcSOqU4WILatb4dccYwAAViHbsSPsRRfLvEBmPcUBPLT-BbGIuz7OH+HGa8AhrK8glYK4GGGNU61k5q5Tm5Q3pEzJj+TAEBXCL1SCAraKZyxILWhXbEADEEVFNmA1BGNcEoxGhsfgvd8IpTAEkOsQpRTigwEQFy7AqD4XUujdMLCfyhlSJwxcLhPgtDrFKYYjDfK0AAHKBAwF2f0kjBAsOJlvfgO895WwpqUZKyVALwzWojbA4cfwXTYWggQMDFwqwkDHEk2Z45BHOLofImdc6UKSLw4u4prTbF9CANarghAAA4R6jzQSA30u9Y42JmHY2o5xyBuNzmg3BYSiTWLJMic4MS4mYNgRjAQySIlpOibE+JWduG+m4SU1ez1UnxzMW1HKAEaBKJUbfcwAAqGpUSYIPAeKUBwfgqICHTngMJqcDAtFYj+LAmA6nxBvmYf04TOnIifk4rOLjKltQ8emMA3jfEBKCcXEJa18nLKKVk0eECklLLjlEjJxTsmLkTrgVUvp6AIEwJs38ZSKmYMniLXKTTt4JD3uYa+e9EEgNoOC2+OC3qRiAA)

I thought that's nice to have, as it can make sharing bug reports nicer? E.g. [for the false-positive RET504](https://611ef32d.ruff-axw.pages.dev/#N4Ig5gNg9gRghhAziAXKRBTCGDGAXVEAbQB0QAlAUQBUyBdEAX0YBI2ANFAAgEsA7PFwA+XAHJQ+GLgF4xEjACgFAEwwAzLmAx4A+gA8AFAEouAWgB8vASgVc7m6PAhd2t+zw3teiOZJv2AlxkuAEY3OwAnbQBXCL4XIA)

---

_Comment by @charliermarsh on 2022-12-22 14:09_

Awesome, pumped to review! Will try to get to it today but might be tomorrow.

(Permalinks is genius especially for bug reports.)

---

_@charliermarsh reviewed on 2022-12-24 04:17_

---

_Review comment by @charliermarsh on `.github/workflows/ci.yaml`:157 on 2022-12-24 04:17_

Perhaps this should be moved to its own workflow, that runs on `main` update, and continuously releases the playground?

The _ideal_ would probably be that we build and deploy a preview URL to Pages on every PR, and that URL gets linked back to the PR via a comment or as the hyperlink on the check completion. But, that doesn't have to happen here.


---

_@charliermarsh reviewed on 2022-12-24 04:18_

---

_Review comment by @charliermarsh on `playground/src/App.tsx`:15 on 2022-12-24 04:18_

Is this the default editor text? (If so, extract to a top-level constant?)

---

_@charliermarsh reviewed on 2022-12-24 04:18_

---

_Review comment by @charliermarsh on `playground/src/App.tsx`:67 on 2022-12-24 04:18_

Nit: can we move to its own component (`Options.tsx`)?

---

_@charliermarsh reviewed on 2022-12-24 04:20_

---

_Review comment by @charliermarsh on `playground/src/App.tsx`:116 on 2022-12-24 04:20_

I believe this needs to depend on `config` and `source`.

---

_@charliermarsh reviewed on 2022-12-24 04:22_

---

_Review comment by @charliermarsh on `ruff_dev/src/generate_playground_options.rs`:1 on 2022-12-24 04:22_

(Don't forget to clean this up please.)

---

_@charliermarsh reviewed on 2022-12-24 04:22_

---

_Review comment by @charliermarsh on `ruff_dev/src/main.rs`:37 on 2022-12-24 04:22_

Ditto.

---

_@charliermarsh reviewed on 2022-12-24 04:24_

---

_Review comment by @charliermarsh on `playground/src/App.tsx`:91 on 2022-12-24 04:24_

Any idea why these aren't spanning the entire range?

<img width="119" alt="Screen Shot 2022-12-23 at 11 23 55 PM" src="https://user-images.githubusercontent.com/1309177/209421068-cd2b5e92-6e74-4bf8-9a48-0902a0720b1f.png">


---

_@charliermarsh reviewed on 2022-12-24 04:26_

---

_Review comment by @charliermarsh on `playground/src/options.ts`:12 on 2022-12-24 04:26_

Can we omit the settings that don't make sense in a non-filesystem context? Like `src`, `exclude`, etc.

---

_@charliermarsh reviewed on 2022-12-24 04:28_

---

_Review comment by @charliermarsh on `playground/src/style.css`:24 on 2022-12-24 04:28_

I might spend some time re-styling this, to make the UI more cohesive between the settings pane and the editor. I think the settings should have some kind of show/hide UX too -- perhaps they should even be hidden by default.


---

_@charliermarsh reviewed on 2022-12-24 04:29_

---

_Review comment by @charliermarsh on `playground/src/style.css`:24 on 2022-12-24 04:29_

E.g., something like this would make sense.

<img width="1624" alt="Screen Shot 2022-12-23 at 11 29 04 PM" src="https://user-images.githubusercontent.com/1309177/209421206-05dcdf01-2436-4bf2-ab49-fc28493e292c.png">


---

_@charliermarsh reviewed on 2022-12-24 04:29_

---

_Review comment by @charliermarsh on `src/lib.rs`:85 on 2022-12-24 04:29_

I think what you have here makes sense.

---

_@charliermarsh reviewed on 2022-12-24 04:29_

---

_Review comment by @charliermarsh on `Cargo.toml`:62 on 2022-12-24 04:29_

Can this not be under `target_family = "wasm"`?

---

_Review comment by @squiddy on `playground/src/style.css`:24 on 2022-12-24 04:30_

Thank you, that sounds reasonable. Styling isn't my strong skill. 

Just let me know when you want to tackle that, I'll address your other comments for now.

---

_@squiddy reviewed on 2022-12-24 04:30_

---

_Comment by @charliermarsh on 2022-12-24 04:32_

It would also be cool to have permanent, versioned URLs somehow. I don't know exactly what that would look like, but for bug reports, it'd be nice if the URL that was shared was tied to a specific version of Ruff.

---

_@squiddy reviewed on 2022-12-24 06:10_

---

_Review comment by @squiddy on `playground/src/options.ts`:12 on 2022-12-24 06:10_

Yes, good idea. Done.

---

_@squiddy reviewed on 2022-12-24 06:32_

---

_Review comment by @squiddy on `playground/src/App.tsx`:91 on 2022-12-24 06:32_

Classic off-by-one error. Column indices needed to be adjusted for the 1-based index of the editor.

[Works now](https://611ef32d.ruff-axw.pages.dev/#N4XwJBCWC2AOD2AnALgAngZwHQHcAWAhsgKYBuxiQA)

---

_Comment by @squiddy on 2022-12-24 06:39_

> It would also be cool to have permanent, versioned URLs somehow. I don't know exactly what that would look like, but for bug reports, it'd be nice if the URL that was shared was tied to a specific version of Ruff.

I was wondering whether it makes sense to decouple the playground from ruff itself. Have it provide the UI and all of that, but load the WASM files from *somewhere* depending on the version requested. If we were to include the available options inside the WASM, they would be pretty self-contained.

A link such as https://611ef32d.ruff-axw.pages.dev/?version=0.0.119#N4XwJBCWC2AOD2AnALgAngZwHQHcAWAhsgKYBuxiQA would then load the proper WASM file for `0.0.119`.

---

_@squiddy reviewed on 2022-12-24 06:40_

---

_Review comment by @squiddy on `Cargo.toml`:62 on 2022-12-24 06:40_

It can, I moved it there.

---

_@squiddy reviewed on 2022-12-24 06:51_

---

_Review comment by @squiddy on `playground/src/App.tsx`:15 on 2022-12-24 06:51_

It's the default, yes. I extracted it out. We probably want to pick something more exciting though. :D

---

_@squiddy reviewed on 2022-12-24 06:52_

---

_Review comment by @squiddy on `playground/src/style.css`:24 on 2022-12-24 06:52_

There's also lots of potential in making the user input nicer, based on the type of the option. E.g. presenting checkboxes for booleans. I didn't go into that to keep the PR smallish.

---

_@squiddy reviewed on 2022-12-26 10:25_

---

_Review comment by @squiddy on `.github/workflows/ci.yaml`:157 on 2022-12-26 10:25_

Moved it to separate workflow.

I agree on the ideal, but I would prefer to get this into a merge-able state first.

---

_@charliermarsh reviewed on 2022-12-26 12:35_

---

_Review comment by @charliermarsh on `.github/workflows/ci.yaml`:157 on 2022-12-26 12:35_

(Sounds good, I know I'm a bit behind on this!)

---

_@squiddy reviewed on 2022-12-26 12:41_

---

_Review comment by @squiddy on `.github/workflows/ci.yaml`:157 on 2022-12-26 12:41_

Nah, it's all good. :) I will, from time to time, rebase this to resolve conflicts, but probably not daily 

---

_@charliermarsh reviewed on 2022-12-26 15:06_

---

_Review comment by @charliermarsh on `.github/workflows/ci.yaml`:157 on 2022-12-26 15:06_

I'm gonna go ahead and resolve conflicts, then merge. There are some things I want to tweak, but better to get this merged and run from there! I'll also setup the deployment keys.

---

_Merged by @charliermarsh on 2022-12-26 17:09_

---

_Closed by @charliermarsh on 2022-12-26 17:09_

---

_Branch deleted on 2022-12-27 05:42_

---
