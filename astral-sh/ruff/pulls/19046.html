<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bump CodSpeed to v3 - astral-sh/ruff #19046</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Bump CodSpeed to v3</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19046">#19046</a>
        opened by <a href="https://github.com/adriencaccia">@adriencaccia</a>
        on 2025-06-30 11:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/adriencaccia">@adriencaccia</a></div>
            <div class="timeline-body">Summary


<p>As discussed on Slack, there was an issue with the walltime metrics with <code>divan</code>. The issue was fixed with the latest version of <code>cargo-codspeed</code> and <code>codpseed-divan-compat</code>: https://github.com/CodSpeedHQ/codspeed-rust/releases/tag/v3.0.0.</p>
<p>This PR updates all crates related to CodSpeed. A performance increase of the following benchmarks is expected, as now the correct metric will be used.</p>
<pre><code>crates/ruff_benchmark/benches/ty_walltime.rs::multithreaded[pydantic]
crates/ruff_benchmark/benches/ty_walltime.rs::small[altair]
crates/ruff_benchmark/benches/ty_walltime.rs::small[freqtrade]
crates/ruff_benchmark/benches/ty_walltime.rs::small[pydantic]
crates/ruff_benchmark/benches/ty_walltime.rs::small[tanjun]
</code></pre>
<p>Once this is merged, we will update the historic data of the affected benchmark on the CodSpeed UI, so that no false positives will appear.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-30 12:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-30 12:01</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>attrs (https://github.com/python-attrs/attrs)
-     memo fields = ~66MB
+     memo fields = ~60MB

rich (https://github.com/Textualize/rich)
- TOTAL MEMORY USAGE: ~129MB
+ TOTAL MEMORY USAGE: ~142MB
-     memo fields = ~106MB
+     memo fields = ~117MB

mkosi (https://github.com/systemd/mkosi)
- TOTAL MEMORY USAGE: ~117MB
+ TOTAL MEMORY USAGE: ~129MB
-     memo fields = ~97MB
+     memo fields = ~106MB

vision (https://github.com/pytorch/vision)
-     memo fields = ~304MB
+     memo fields = ~276MB

paasta (https://github.com/yelp/paasta)
-     memo fields = ~156MB
+     memo fields = ~171MB

jinja (https://github.com/pallets/jinja)
- TOTAL MEMORY USAGE: ~97MB
+ TOTAL MEMORY USAGE: ~106MB

openlibrary (https://github.com/internetarchive/openlibrary)
-     memo fields = ~171MB
+     memo fields = ~189MB

scikit-learn (https://github.com/scikit-learn/scikit-learn)
- TOTAL MEMORY USAGE: ~652MB
+ TOTAL MEMORY USAGE: ~717MB

</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-30 12:06</div>
            <div class="timeline-body"><p>Thanks! It looks like this update is causing our build to fail on Windows? :-(</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-06-30 12:09</div>
            <div class="timeline-body">



<a href="https://codspeed.io/astral-sh/ruff/branches/adriencaccia%3Achore%2Fbump-codspeed?runnerMode=WallTime">CodSpeed WallTime Performance Report</a>
Merging #19046 will <strong>improve performances by ×3</strong>
<p>Comparing <code>adriencaccia:chore/bump-codspeed</code> (8772ea1) with <code>main</code> (db3dcd8)</p>
:tada: Hooray! <code>codspeed-rust</code> just leveled up to 3.0.1!
<blockquote>
<p>A heads-up, this is a <strong>breaking change</strong> and it might affect your current performance baseline a bit. But here&#x27;s the exciting part - it&#x27;s packed with new, cool features and promises improved result stability :partying_face:!
<em>Curious about what&#x27;s new? Visit our <a href="https://github.com/CodSpeedHQ/codspeed-rust/releases">releases</a> page to delve into all the awesome details about this new version.</em></p>
</blockquote>
Summary
<p><code>⚡ 5</code> improvements<br>
<code>✅ 3</code> untouched benchmarks</p>
Benchmarks breakdown
<p>|     | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ⚡ | <code>multithreaded[pydantic]</code> | 8.7 s | 2.9 s | ×3 |
| ⚡ | <code>small[altair]</code> | 6.1 s | 3 s | ×2 |
| ⚡ | <code>small[freqtrade]</code> | 9.2 s | 4.6 s | +99.51% |
| ⚡ | <code>small[pydantic]</code> | 5.7 s | 2.9 s | +99.42% |
| ⚡ | <code>small[tanjun]</code> | 4 s | 2 s | +99.73% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-30 12:09</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-06-30 12:36</div>
            <div class="timeline-body"><p>Thank you! This is good to go as soon as Windows CI is passing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>Cargo.lock</code>:1 on 2025-06-30 12:37</div>
            <div class="timeline-body"><p>I don&#x27;t think this should block merging since all previous versions of <code>divan</code> have been yanked, but would you be able to give some context on why this update adds so many new dependencies to our lockfile? It surprises me a bit given that we already have <code>default-features = false</code> for the <code>codspeed-criterion-compat</code> dependency :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-30 12:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/art049">@art049</a> reviewed on 2025-06-30 13:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/art049">@art049</a> on <code>Cargo.lock</code>:1 on 2025-06-30 13:44</div>
            <div class="timeline-body"><p>We&#x27;re adding walltime profiling (with perf) in the integration, so we had to install additional dependencies to communicate with the runner. We&#x27;ll probably put that behind a feature flag in the future, since we didn&#x27;t anticipate this could be an issue for you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-30 13:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>Cargo.lock</code>:1 on 2025-06-30 13:54</div>
            <div class="timeline-body"><p>I looked at this a bit, and I think the main surprising one for me was <code>nalgebra</code>, pulled in by <code>statrs</code>, but if y&#x27;all need <code>nalgebra</code> there&#x27;s probably not much to do!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-30 14:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-30 14:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-30 14:11</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-30 14:14</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:16:04 UTC
    </footer>
</body>
</html>
