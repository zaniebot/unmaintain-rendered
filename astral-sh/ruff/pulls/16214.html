<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update server to return the debug info as string - astral-sh/ruff #16214</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Update server to return the debug info as string</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16214">#16214</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2025-02-17 15:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR updates the <code>ruff.printDebugInformation</code> command to return the info as string in the response. Currently, we send a <code>window/logMessage</code> request with the info but that has the disadvantage that it's not visible to the user directly.</p>
<p>What <code>rust-analyzer</code> does with it's <code>rust-analyzer/status</code> request which returns it as a string which then the client can just display it in a separate window. This is what I'm thinking of doing as well.</p>
<p>Other editors can also benefit from it by directly opening a temporary file with this information that the user can see directly.</p>
<p>There are couple of options here:</p>
<ol>
<li>Keep using the command, keep the log request and return the string</li>
<li>Keep using the command, remove the log request and return the string</li>
<li>Create a new request similar to <code>rust-analyzer/status</code> which returns a string</li>
</ol>
<p>This PR implements (1) but I'd want to move towards (2) and remove the log request completely. We haven't advertised it as such so this would only require updating the VS Code extension to handle it by opening a new document with the debug content.</p>
<h2>Test plan</h2>
<p>For VS Code, refer to https://github.com/astral-sh/ruff-vscode/pull/694.</p>
<p>For Neovim, one could do:</p>
<pre><code class="language-lua">local function execute_ruff_command(command)
  local client = vim.lsp.get_clients({ 
    bufnr = vim.api.nvim_get_current_buf(), 
    name = name,
    method = 'workspace/executeCommand',
  })[1]
  if not client then
    return
  end
  client.request('workspace/executeCommand', {
    command = command,
    arguments = {
      { uri = vim.uri_from_bufnr(0) }
    },
    function(err, result)
      if err then
        -- log error
        return
      end
      vim.print(result)
      -- Or, open a new window with the `result` content
    end
  }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @dhruvmanila on 2025-02-17 15:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-02-17 15:48</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/server/api/requests/execute_command.rs</code>:43 on 2025-02-18 04:34</div>
            <div class="timeline-body"><p>I prefer to remove the logging part and I don't think it should break anything.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-02-18 04:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dhruvmanila on 2025-02-18 04:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2025-02-18 04:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-18 07:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/execute_command.rs</code>:43 on 2025-02-18 07:51</div>
            <div class="timeline-body"><p>I'm in favor of removing it, but wouldn't it break old VS code clients that don't have the required code to open the document on the client side?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-18 07:52</div>
            <div class="timeline-body"><p>Could you add a test plan showing how this works for clients without an editor extension (e.g. neovim)? How does the client know that it has to open a document? Is this the default behavior of a custom command?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-02-18 08:44</div>
            <div class="timeline-body"><blockquote>
<p>Could you add a test plan showing how this works for clients without an editor extension (e.g. neovim)? How does the client know that it has to open a document? Is this the default behavior of a custom command?</p>
</blockquote>
<p>We haven't documented the commands API anywhere nor is it easy to add the argument schema in the capabilities as the arguments are <code>[]LspAny</code> (https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#executeCommandParams).</p>
<p>No, this is not the default behavior for a custom command. The user or the plugin author needs to know the argument schema for each command to implement it. As to how to pass in the document URI, that will be dependent on each editor. For example, in VS Code, it's just a <code>vscode.window.activeTextEditor</code> while in Neovim it would be <a href="https://neovim.io/doc/user/lsp.html#vim.lsp.util.make_text_document_params("><code>vim.lsp.util.make_text_document_params</code></a>).</p>
<p>Hmm, that makes me wonder why weren't we using the existing types from <code>lsp_types</code> like <a href="https://docs.rs/lsp-types/0.95.1/lsp_types/struct.VersionedTextDocumentIdentifier.html"><code>VersionedTextDocumentIdentifier</code></a> instead of <code>Argument</code>. I'll make this as a follow-up change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-02-18 08:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/server/api/requests/execute_command.rs</code>:43 on 2025-02-18 08:47</div>
            <div class="timeline-body"><p>Hmm yeah. So, that would happen if the user is using a non-latest extension version with the latest ruff in which case I think we should recommend them to upgrade the extension version as it always include improvements and bug fixes. I'm fine keeping this here as well for the time being and we can remove it with 0.10.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2025-02-18 09:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/execute_command.rs</code>:43 on 2025-02-18 09:34</div>
            <div class="timeline-body"><p>Can we include a <code>TODO</code> or similar that it should be removed? Or do we want to keep it, considering that other clients can't easily call commands?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-02-18 09:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-02-18 09:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/server/api/requests/execute_command.rs</code>:43 on 2025-02-18 09:37</div>
            <div class="timeline-body"><p>I think we should remove it in a later version, I'll create an issue for 0.10.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2025-02-18 09:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2025-02-18 09:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-18 09:46</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:10:08 UTC
    </footer>
</body>
</html>
