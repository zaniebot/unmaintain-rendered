```yaml
number: 5946
title: "Don't format trailing comma for lambda arguments"
type: pull_request
state: merged
author: konstin
labels:
  - formatter
assignees: []
merged: true
base: main
head: no_magic_trailing_commas_for_lambdas
created_at: 2023-07-21T11:12:39Z
updated_at: 2023-07-27T10:32:11Z
url: https://github.com/astral-sh/ruff/pull/5946
synced_at: 2026-01-12T15:55:20Z
```

# Don't format trailing comma for lambda arguments

---

_@konstin_

**Summary** lambda arguments don't have parentheses, so they shouldn't get a magic trailing comma either. This fixes some unstable formatting

**Test Plan** Added a regression test.

89 (from previously 145) instances of unstable formatting remaining.

```
$ cargo run --bin ruff_dev --release -- format-dev --stability-check --error-file formatter-ecosystem-errors.txt --multi-project target/checkouts > formatter-ecosystem-progress.txt
$ rg "Unstable formatting" target/formatter-ecosystem-errors.txt | wc -l
89
```

Closes #5892


---

_Comment by @konstin on 2023-07-21 11:12_

Current dependencies on/for this PR:
* main
  * **PR #5944** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5944" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #5946** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5946" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/5946?utm_source=stack-comment).

---

_Comment by @github-actions[bot] on 2023-07-21 11:43_

## PR Check Results
### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      9.3Â±0.04ms     4.4 MB/sec    1.00      9.3Â±0.12ms     4.4 MB/sec
formatter/numpy/ctypeslib.py               1.00  1864.6Â±11.02Âµs     8.9 MB/sec    1.00   1855.5Â±4.07Âµs     9.0 MB/sec
formatter/numpy/globals.py                 1.04    210.1Â±1.16Âµs    14.0 MB/sec    1.00    202.7Â±0.23Âµs    14.6 MB/sec
formatter/pydantic/types.py                1.00      4.0Â±0.01ms     6.4 MB/sec    1.00      4.0Â±0.01ms     6.4 MB/sec
linter/all-rules/large/dataset.py          1.00     12.9Â±0.06ms     3.1 MB/sec    1.01     13.1Â±0.04ms     3.1 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.3Â±0.01ms     5.1 MB/sec    1.01      3.3Â±0.01ms     5.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    426.2Â±0.65Âµs     6.9 MB/sec    1.01    431.3Â±0.69Âµs     6.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.8Â±0.01ms     4.4 MB/sec    1.01      5.9Â±0.03ms     4.3 MB/sec
linter/default-rules/large/dataset.py      1.00      6.6Â±0.02ms     6.2 MB/sec    1.02      6.8Â±0.01ms     6.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1411.2Â±1.49Âµs    11.8 MB/sec    1.02   1442.4Â±1.42Âµs    11.5 MB/sec
linter/default-rules/numpy/globals.py      1.00    155.2Â±0.50Âµs    19.0 MB/sec    1.02    158.7Â±0.28Âµs    18.6 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.0Â±0.01ms     8.5 MB/sec    1.02      3.1Â±0.01ms     8.3 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     11.1Â±0.12ms     3.7 MB/sec    1.01     11.1Â±0.12ms     3.7 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.2Â±0.06ms     7.7 MB/sec    1.00      2.2Â±0.03ms     7.6 MB/sec
formatter/numpy/globals.py                 1.00    243.0Â±4.84Âµs    12.1 MB/sec    1.02   248.0Â±11.21Âµs    11.9 MB/sec
formatter/pydantic/types.py                1.00      4.8Â±0.07ms     5.3 MB/sec    1.00      4.8Â±0.07ms     5.3 MB/sec
linter/all-rules/large/dataset.py          1.00     15.5Â±0.21ms     2.6 MB/sec    1.00     15.5Â±0.13ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      4.1Â±0.06ms     4.1 MB/sec    1.00      4.0Â±0.05ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.00    484.8Â±7.64Âµs     6.1 MB/sec    1.01    487.4Â±6.31Âµs     6.1 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.1Â±0.08ms     3.6 MB/sec    1.01      7.2Â±0.51ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.00      8.1Â±0.08ms     5.0 MB/sec    1.01      8.2Â±0.08ms     5.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1696.4Â±20.86Âµs     9.8 MB/sec    1.00  1690.0Â±15.49Âµs     9.9 MB/sec
linter/default-rules/numpy/globals.py      1.00    190.1Â±2.87Âµs    15.5 MB/sec    1.00    190.0Â±3.05Âµs    15.5 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.6Â±0.05ms     7.0 MB/sec    1.00      3.6Â±0.04ms     7.0 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/other/arguments.rs`:154 on 2023-07-21 11:51_

Unrelated to this PR. Do we need to test if the magic trailing comma option is enabled?

---

_@MichaReiser approved on 2023-07-21 11:51_

---

_Converted to draft by @konstin on 2023-07-21 13:14_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/other/arguments.rs`:154 on 2023-07-21 13:16_

lambdas seem to have their own trailing comma rules that are different magic trailing comma

---

_@konstin reviewed on 2023-07-21 13:16_

---

_@MichaReiser reviewed on 2023-07-21 13:29_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/other/arguments.rs`:154 on 2023-07-21 13:29_

That makes sense. But do we need to respect the magic trailing comma option for regular arguments?

---

_Label `formatter` added by @konstin on 2023-07-21 13:46_

---

_Marked ready for review by @konstin on 2023-07-21 15:51_

---

_@konstin reviewed on 2023-07-21 15:51_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/other/arguments.rs`:154 on 2023-07-21 15:51_

We do,
```python
def f(a,): pass
```
gets formatted as
```python
def f(
    a,
):
    pass
```

---

_Review requested from @MichaReiser by @konstin on 2023-07-21 15:51_

---

_@MichaReiser reviewed on 2023-07-21 16:40_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/other/arguments.rs`:154 on 2023-07-21 16:40_

But do we need to respect `context.options.magic_trailing_comma()`?

---

_@MichaReiser approved on 2023-07-21 16:40_

---

_@konstin reviewed on 2023-07-23 11:32_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/other/arguments.rs`:154 on 2023-07-23 11:32_

sorry i misunderstand what you were aiming at, yes, for functions (but not lambdas) we need to respect the magic trailing comma setting and we previously didn't. I've added this now in this PR because separating these two aspects doesn't make sense

---

_@konstin reviewed on 2023-07-23 12:38_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/other/arguments.rs`:162 on 2023-07-23 12:38_

I hope those comments are sufficiently clear

---

_Merged by @konstin on 2023-07-27 10:32_

---

_Closed by @konstin on 2023-07-27 10:32_

---

_Branch deleted on 2023-07-27 10:32_

---
