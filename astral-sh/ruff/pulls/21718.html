<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] do nothing with `store_expression_type` if `inner_expression_inference_state` is `Get` - astral-sh/ruff #21718</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] do nothing with <code>store_expression_type</code> if <code>inner_expression_inference_state</code> is <code>Get</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21718">#21718</a>
        opened by <a href="https://github.com/mtshiba">@mtshiba</a>
        on 2025-12-01 03:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/mtshiba">@mtshiba</a> on 2025-12-01 03:20</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes https://github.com/astral-sh/ty/issues/1688</p>
<h2>Test Plan</h2>
<p>N/A</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-01 03:22</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-01 03:24</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">scikit-build-core (https://github.com/scikit-build/scikit-build-core)
+ src/scikit_build_core/_logging.py:153:13: warning[unsupported-base] Unsupported class base with type `&lt;class 'Mapping[str, Style]'&gt; | &lt;class 'Mapping[str, Divergent]'&gt;`
- Found 41 diagnostics
+ Found 42 diagnostics

pandas-stubs (https://github.com/pandas-dev/pandas-stubs)
+ pandas-stubs/_typing.pyi:1207:16: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 5806 diagnostics
+ Found 5807 diagnostics


</code></pre>
</details>

<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-12-01 06:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types/infer/builder.rs</code>:7097 on 2025-12-01 06:56</div>
            <div class="timeline-body"><p>Could we use <code>multi_inference_state::Ignore</code> instead of having two modes that represent &quot;read-only&quot; type inference?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-12-01 08:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-12-01 14:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/src/types/infer/builder.rs</code>:7097 on 2025-12-01 14:42</div>
            <div class="timeline-body"><p>drive-by context: I am likely to modify this check for <code>in_string_annotation</code> to do the &quot;store (Expr, Expr) for string annotation types&quot; thing we've been discussing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mtshiba">@mtshiba</a> reviewed on 2025-12-01 16:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/mtshiba">@mtshiba</a> on <code>crates/ty_python_semantic/src/types/infer/builder.rs</code>:7097 on 2025-12-01 16:20</div>
            <div class="timeline-body"><blockquote>
<p>Could we use <code>multi_inference_state::Ignore</code> instead of having two modes that represent &quot;read-only&quot; type inference?</p>
</blockquote>
<p>I understand that <code>MultiInferenceState::Ignore</code> is an option to perform the same calculation twice and discard the second result.
Since all type inference for expressions is skipped while in <code>InnerExpressionInferenceState::Get</code>, I think it should be used whenever possible (for example, when only diagnostics are needed, such as the handling in <code>infer_subscript_type_expression</code> for union types).
But I'm not sure whether this can be assumed in all cases where <code>MultiInferenceState::Ignore</code> is used.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @mtshiba on 2025-12-04 10:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @mtshiba on 2025-12-04 10:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @mtshiba on 2025-12-04 10:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @mtshiba on 2025-12-04 10:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @mtshiba on 2025-12-04 10:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @AlexWaygood on 2025-12-04 11:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-12-05 02:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/infer/builder.rs</code>:7097 on 2025-12-05 02:05</div>
            <div class="timeline-body"><p>I think it is necessary for <code>MultiInferenceState</code> to redo inference, since it is doing it with different type context. So I think we need both.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-12-05 02:05</div>
            <div class="timeline-body"><p>This looks correct, thank you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @carljm on 2025-12-05 02:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-12-05 02:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-12-05 02:07</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:42:35 UTC
    </footer>
</body>
</html>
