<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix relative import resolution in `site-packages` packages when the `site-packages` search path is a subdirectory of the first-party search path - astral-sh/ruff #17178</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix relative import resolution in <code>site-packages</code> packages when the <code>site-packages</code> search path is a subdirectory of the first-party search path</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17178">#17178</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-04-03 14:28
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body">Summary
<p>If a package in <code>site-packages</code> had this directory structure:</p>
<pre><code># bar/__init__.py
from .a import A

# bar/a.py
class A: ...
</code></pre>
<p>then we would fail to resolve the <code>from .a import A</code> import <em>if</em> (as is usually the case!) the <code>site-packages</code> search path was located inside a <code>.venv</code> directory that was a subdirectory of the project&#x27;s first-party search path. The reason for this is a bug in <code>file_to_module</code> in the module resolver. In this loop, we would identify that <code>/project_root/.venv/lib/python3.13/site-packages/foo/__init__.py</code> can be turned into a path relative to the first-party search path (<code>/project_root</code>):</p>
<p>https://github.com/astral-sh/ruff/blob/6e2b8f9696e87d786cfed6304dc3baa0f029d341/crates/red_knot_python_semantic/src/module_resolver/resolver.rs#L101-L110</p>
<p>but we&#x27;d then try to turn the relative path (<code>.venv/lib/python3.13/site-packages/foo/__init__.py</code>) into a module path, realise that it wasn&#x27;t a valid module path... and therefore immediately <code>break</code> out of the loop before trying any other search paths (such as the <code>site-packages</code> search path).</p>
<p>This bug was originally reported on Discord by @MatthewMckee4.</p>
Test Plan
<p>I added a unit test for <code>file_to_module</code> in <code>resolver.rs</code>, and an integration test that shows we can now resolve the import correctly in <code>infer.rs</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-03 14:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-03 14:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-03 14:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-03 14:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-03 14:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-03 14:30</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-03 14:33</div>
            <div class="timeline-body"><blockquote>
Test Plan
<p>I added a unit test for <code>file_to_module</code> in <code>resolver.rs</code>, and an integration test that shows we can now resolve the import correctly in <code>infer.rs</code>.</p>
</blockquote>
<p>I also manually checked that we are able to resolve the import <code>from pydantic import BaseModel</code> (when <code>pydantic</code> is installed into a virtual environment in a subdirectory of the project root), and we don&#x27;t manage to resolve that import on <code>main</code>.</p>
<p>I guess we don&#x27;t run mypy_primer on any projects that use pydantic right now!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-03 14:36</div>
            <div class="timeline-body"><p>I now get &quot;Module <code>pydantic</code> has no member <code>BaseModel</code>red-knot(lint:unresolved-import)&quot;</p>
<p>This error does not show up with <code>model_validator</code> for example</p>
<p>Edit: not on all files though, ill try to reproduce</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/db.rs</code>:143 on 2025-04-03 14:39</div>
            <div class="timeline-body"><p>You removed <code>custom_typeshed</code> because we aren&#x27;t using it anymore? (I guess mdtest now supports this so those tests have been able to move there.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-04-03 14:40</div>
            <div class="timeline-body"><p>Looks good!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-03 14:42</div>
            <div class="timeline-body"><blockquote>
<p>I now get &quot;Module <code>pydantic</code> has no member <code>BaseModel</code>red-knot(lint:unresolved-import)&quot;</p>
<p>This error does not show up with <code>model_validator</code> for example</p>
</blockquote>
<p>Huh. How are you running this branch?</p>
<p>If I run the following commands:</p>
<pre><code>mkdir experiment
cd experiment
uv venv
uv pip install pydantic
echo &quot;from pydantic import BaseModel; from typing_extensions import reveal_type; reveal_type(BaseModel)&quot; &gt; foo.py
cargo run --manifest-path ../ruff/Cargo.toml -p red_knot check foo.py
</code></pre>
<p>Where <code>../ruff</code> is a path to my local Ruff clone, and I have this branch of red-knot checked out, then red-knot now reports this for me:</p>
<pre><code>info: revealed-type
 --&gt; /Users/alexw/dev/experiment4/foo.py:1:76
  |
1 | from pydantic import BaseModel; from typing_extensions import reveal_type; reveal_type(BaseModel)
  |                                                                            ^^^^^^^^^^^^^^^^^^^^^^ Revealed type is `Literal[BaseModel]`
  |

Found 1 diagnostic
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-03 14:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/db.rs</code>:143 on 2025-04-03 14:42</div>
            <div class="timeline-body"><p>Yes, exactly</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-03 14:46</div>
            <div class="timeline-body"><p>That works perfectly fine for me, just in one of my codebases this import fails, ill keep trying to reproduce</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-03 14:47</div>
            <div class="timeline-body"><p>I think I&#x27;ll land this for now anyway since it definitely fixes <em>a</em> bug (both test cases added here fail on <code>main</code>), even if there are more bugs to fix as well as this. But please do report it if you find a repro for the remaining issues!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-03 14:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-03 14:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-03 14:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-03 14:51</div>
            <div class="timeline-body"><p>Ah sorry im being stupid, my ruff server was linked to my fork of ruff and my ide was showing the old errors, sorry about that</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-03 14:52</div>
            <div class="timeline-body"><p>No worries at all -- very easily done :-)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:12:55 UTC
    </footer>
</body>
</html>
