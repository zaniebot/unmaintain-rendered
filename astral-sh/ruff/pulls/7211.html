<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use narrow type for string parsing patterns - astral-sh/ruff #7211</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use narrow type for string parsing patterns</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7211">#7211</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2023-09-07 05:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body">Summary
<p>This PR adds a new enum type <code>StringType</code> which is either a string literal, byte literal or f-string. The motivation behind this is to have a narrow type which is accepted in <code>concatenate_strings</code> as that function is only applicable for the mentioned 3 types. This makes the code more readable and easy to reason about.</p>
<p>A future improvement (which was prototyped here and removed) is to split the current string literal pattern in LALRPOP definition into two parts:</p>
<ol>
<li>A single string literal or a f-string: This means no checking for bytes / non-bytes and other unnecessary compution</li>
<li>Two or more of string/byte/f-string: This will call the <code>concatenate_strings</code> function.</li>
</ol>
<p>The reason for removing the second change is because of how ranges work. The range for an individual string/byte is the entire range which includes the quotes as well but if the same string/byte is part of a f-string, then it only includes the range for the content (without the quotes / inner range). The current string parser returns with the former range.</p>
<p>To give an example, for <code>&quot;foo&quot;</code>, the range of the string would be <code>0..5</code>, but for <code>f&quot;foo&quot;</code> the range of the string would be <code>2..5</code> while the range for the f-string expression would be <code>0..6</code>. The ranges are correct but they differ in the context the string constant itself is being used for. Is it part of a f-string or is it a standalone string?</p>
Test Plan
<p><code>cargo test</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-07 05:30</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #7035</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7035"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a><ul>
<li><strong>PR #7013</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7013"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a><ul>
<li><strong>PR #6659</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6659"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a><ul>
<li><strong>PR #7041</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7041"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a><ul>
<li><strong>PR #7211</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7211"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a>  üëà
* <strong>PR #7263</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7263"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a>
* <strong>PR #7331</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7331"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a>
* <strong>PR #7325</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7325"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a>
* <strong>PR #7326</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7326"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a>
* <strong>PR #7327</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7327"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a>
* <strong>PR #7328</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7328"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a>
* <strong>PR #7329</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7329"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7211?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-07 07:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Use narrow types for string parsing patterns&quot; to &quot;Use narrow type for string parsing patterns&quot; by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-07 12:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-07 12:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-07 12:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/python.lalrpop</code>:672 on 2023-09-07 12:58</div>
            <div class="timeline-body"><p>Is using <code>@L</code> for the <code>end_location</code> intentional?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-09-07 12:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-09-07 13:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/python.lalrpop</code>:672 on 2023-09-07 13:26</div>
            <div class="timeline-body"><p>Oh, it must be a typo. Thanks for pointing it out. This reminds me that I should write some test cases around strings used in match cases and mapping keys.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-08 03:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">python312</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-12 11:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2023-09-14 01:49</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/dhruv/fstring-parser-2">CodSpeed Performance Report</a>
Merging #7211 will <strong>degrade performances by 9.7%</strong>
<p>:warning: No base runs were found</p>
<p>Falling back to comparing <code>dhruv/fstring-parser-2</code> (5f17468) with <code>main</code> (04183b0)</p>
Summary
<p><code>‚ùå 8</code> regressions
<code>‚úÖ 17</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/dhruv/fstring-parser-2">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
Benchmarks breakdown
<p>|     | Benchmark | <code>main</code> | <code>dhruv/fstring-parser-2</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ‚ùå | <code>lexer[numpy/globals.py]</code> | 233.2 ¬µs | 252.9 ¬µs | -7.8% |
| ‚ùå | <code>lexer[large/dataset.py]</code> | 9.8 ms | 10.7 ms | -8.4% |
| ‚ùå | <code>lexer[pydantic/types.py]</code> | 4.1 ms | 4.6 ms | -9.7% |
| ‚ùå | <code>parser[numpy/ctypeslib.py]</code> | 12.4 ms | 12.7 ms | -2.31% |
| ‚ùå | <code>parser[large/dataset.py]</code> | 68.4 ms | 70 ms | -2.29% |
| ‚ùå | <code>lexer[numpy/ctypeslib.py]</code> | 2 ms | 2.1 ms | -7.71% |
| ‚ùå | <code>lexer[unicode/pypinyin.py]</code> | 620.2 ¬µs | 673.4 ¬µs | -7.89% |
| ‚ùå | <code>parser[unicode/pypinyin.py]</code> | 4.3 ms | 4.4 ms | -2.53% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-14 02:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-14 02:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-09-14 02:07</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:57:01 UTC
    </footer>
</body>
</html>
