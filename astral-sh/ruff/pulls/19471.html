<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Implement non-stdlib stub mapping for classes and functions - astral-sh/ruff #19471</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Implement non-stdlib stub mapping for classes and functions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19471">#19471</a>
        opened by <a href="https://github.com/Gankra">@Gankra</a>
        on 2025-07-21 18:28
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a></div>
            <div class="timeline-body"><p>This implements mapping of definitions in stubs to definitions in the &quot;real&quot; implementation using the approach described in https://github.com/astral-sh/ty/issues/788#issuecomment-3097000287</p>
<p>I've tested this with goto-definition in vscode with code that uses <code>colorama</code> and <code>types-colorama</code> (will put up a screen recording and hopefully tests after lunch).</p>
<p>Notably this implementation does not add support for stub-mapping stdlib modules, which can be done as an essentially orthogonal followup in the implementation of <code>resolve_real_module</code>.</p>
<p>Partially fixes https://github.com/astral-sh/ty/issues/788</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @Gankra on 2025-07-21 18:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @Gankra on 2025-07-21 18:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @Gankra on 2025-07-21 18:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @Gankra on 2025-07-21 18:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @Gankra on 2025-07-21 18:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @Gankra on 2025-07-21 18:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @Gankra on 2025-07-21 18:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/src/module_resolver/resolver.rs</code>:89 on 2025-07-21 18:29</div>
            <div class="timeline-body"><p>I duplicated this in case I'd need to tweak the behaviour, but I never really did. I can/should just make resolve_module_query take two arguments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-21 18:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-21 18:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/src/types/ide_support.rs</code>:1155 on 2025-07-21 18:30</div>
            <div class="timeline-body"><p>I simply haven't even tried to think about these.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/src/types/ide_support.rs</code>:1197 on 2025-07-21 18:30</div>
            <div class="timeline-body"><p>Similarly, didn't even try to think about these.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-21 18:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-21 18:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/src/types/ide_support.rs</code>:1095 on 2025-07-21 18:32</div>
            <div class="timeline-body"><p>Weirdly this always seems to return two copies of the same result? It works out fine because the IDE deduplicates it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-21 18:32</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ‚úÖ
No memory usage changes detected ‚úÖ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-21 18:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/src/types/ide_support.rs</code>:1079 on 2025-07-21 18:33</div>
            <div class="timeline-body"><p>I believe this path is currently only used for going to a function keyword argument or something like that?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-07-21 18:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/module_resolver/resolver.rs</code>:136 on 2025-07-21 18:37</div>
            <div class="timeline-body"><p>this looks like it's still only used inside this crate, and I'm kinda leery about exposing it outside this crate</p>
<pre><code class="language-suggestion">pub(crate) fn file_to_module(db: &amp;dyn Db, file: File) -&gt; Option&lt;Module&gt; {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-21 18:38</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>‚ÑπÔ∏è ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<details><summary><a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)</summary>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to parse examples/mcp/databricks_mcp_cookbook.ipynb:12:1:8: Simple statements must be separated by newlines or semicolons
</code></pre>
</p>
</details>

<h3>Formatter (preview)</h3>
<p>‚ÑπÔ∏è ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<details><summary><a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)</summary>
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to parse examples/mcp/databricks_mcp_cookbook.ipynb:12:1:8: Simple statements must be separated by newlines or semicolons
</code></pre>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-21 18:46</div>
            <div class="timeline-body"><p>It looks like for something like this, where there isn't a separate <code>*-stubs</code> package but instead the stub lives alongside the runtime files in the same package, we still jump to the stub file in go-to definition on this branch:</p>
<p><code>main.py</code>:</p>
<pre><code class="language-py">from module import Foo
</code></pre>
<p><code>module.py</code>:</p>
<pre><code class="language-py">class Foo: ...
</code></pre>
<p><code>module.pyi</code>:</p>
<pre><code class="language-py">class Foo: ...
</code></pre>
<p>E.g. I ran the playground locally with ^those files on this branch, and used go-to definition on the <code>Foo</code> symbol in <code>main.py</code>, and it jumped to <code>module.pyi</code> rather than <code>module.py</code>.</p>
<p>That said, it's something of a distinct task from the &quot;separate <code>*-stubs</code> package&quot; task, so I don't think it should block this PR being merged!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-07-21 18:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/ide_support.rs</code>:1015 on 2025-07-21 18:48</div>
            <div class="timeline-body"><p>I'm choosing to take the insinuation that stubs are somehow &quot;fake&quot; or &quot;inauthentic&quot; as a personal affront, since I'm a typeshed maintainer üòÜ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-21 19:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/src/module_resolver/resolver.rs</code>:136 on 2025-07-21 19:29</div>
            <div class="timeline-body"><p>good catch, gunk from initial prototyping.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/src/module_resolver/resolver.rs</code>:89 on 2025-07-21 19:41</div>
            <div class="timeline-body"><p>Ah right, merging the two is annoying because our testing infra checks these queries and really can't deal with queries with &gt;1 arguments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-21 19:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-21 19:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/src/types/ide_support.rs</code>:1015 on 2025-07-21 19:43</div>
            <div class="timeline-body"><p>Only in the artifice can we find perfection</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-21 20:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_ide/src/goto_definition.rs</code>:168 on 2025-07-21 20:40</div>
            <div class="timeline-body"><p>Disappointed and annoyed that the stub mapper logic doesn't seem to work on the cursor tests? Debugging...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-07-21 21:01</div>
            <div class="timeline-body"><p>Tests added</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-21 21:32</div>
            <div class="timeline-body"><p>Here's a slightly pathological situation where this branch still has... questionable? behaviour (but it's an edge case, so maybe not hugely important):</p>
<hr />
<p><code>main.py</code>:</p>
<pre><code class="language-py">from module import Foo
</code></pre>
<p><code>module/__init__.py</code>:</p>
<pre><code class="language-py"># empty file
</code></pre>
<p><code>module/Foo.py</code>:</p>
<pre><code class="language-py"># empty file
</code></pre>
<p><code>module.pyi</code>:</p>
<pre><code class="language-py">class Foo: ...
</code></pre>
<hr />
<p>If you go-to-definition on <code>Foo</code> in <code>main.py</code>, we currently jump to the <code>class Foo: ...</code> definition in <code>module.pyi</code> on this branch. But arguably the &quot;runtime definition&quot; of <code>Foo</code> is the submodule <code>module/Foo.py</code> (that's what will actually be imported by the statement <code>from module import Foo</code> at runtime!).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_ide/src/stub_mapping.rs</code>:26 on 2025-07-21 21:40</div>
            <div class="timeline-body"><p>There are several <code>#[allow(...)]</code> annotations above (on this method and on <code>new()</code>) that can be removed now.</p>
<p>I'm still not convinced we're getting much value from having <code>StubMapper</code> as a struct (rather than just a pair of free functions), but I don't think it matters much either way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-07-21 21:57</div>
            <div class="timeline-body"><p>Not sure how you were testing that -- in the cursor tests it actually yields &quot;no goto (definition) target found&quot;. If you created this is an IDE and e.g. cmd+clicked, you may have just unknowingly triggered goto-declaration (if there's no results for goto-definition, goto-declaration is used by the IDE).</p>
<p>I've pushed up a commit adding a test for this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/ide_support.rs</code>:1079 on 2025-07-21 22:00</div>
            <div class="timeline-body"><p>Looks like it -- but those also have a <code>Definition</code>, so it should be possible to stop using <code>FileWithRange</code> for that case.</p>
<p>It seems like maybe <code>FileWithRange</code> should be more finely targeted to only the &quot;entire module&quot; case -- in every other case I'd think we should have a <code>Definition</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-07-21 22:02</div>
            <div class="timeline-body"><blockquote>
<p>It looks like for something like this, where there isn't a separate *-stubs package but instead the stub lives alongside the runtime files in the same package, we still jump to the stub file in go-to definition on this branch:</p>
</blockquote>
<p>I also just added a test for this case -- it's fixed now. In an earlier revision I just wasn't propagating ModuleResolveMode deep enough so simple cases still were grabbing .pyi results.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/ide_support.rs</code>:1095 on 2025-07-21 22:04</div>
            <div class="timeline-body"><p>It's because it returns both bindings and declarations (and pushes them onto the returned vector separately), and many definitions (including the ones you support here, class and function definitions) are both bindings and declarations.</p>
<p>This is fixable, but maybe not worth it if the IDE deduplicates anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_ide/src/goto_definition.rs</code>:328 on 2025-07-21 22:10</div>
            <div class="timeline-body"><p>IMO we should not support the case as shown here, because the stub is kind of just lying. There is no <code>MyClass</code> in the namespace of <code>mymodule</code> (by default -- there would be if someone else happened to have done an <code>import mymodule.MyClass</code> somewhere, but this is an unreliable side effect we intentionally don't model.) In other words, I don't think we should eagerly go fetch submodules and treat them as attributes of the parent module for this purpose.</p>
<p>If, on the other hand, there were a <code>from . import MyClass</code> line right here, then I think it would make sense to find that as the definition of <code>MyClass</code>.</p>
<p>If we are going to include this test, I would suggest adding that import to it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_ide/src/goto_definition.rs</code>:350 on 2025-07-21 22:13</div>
            <div class="timeline-body"><p>I find this test (and the wording describing it here) a bit confusing. In an informal sense, I guess you could call <code>class MyClass: ...</code> in a <code>.py</code> file a &quot;stub&quot; (in that the class has no body, and it uses an ellipsis, like stubs do), but it's not really a &quot;stub&quot; in any sense described by the typing spec, so I wouldn't call it one here. And I'm not sure what value this test adds, because I don't think we would ever treat <code>class MyClass: ...</code> any differently from a more complex class definition, for the purposes of goto-definition?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-07-21 22:14</div>
            <div class="timeline-body"><p>Fantastic! More to do here, but this is a great start and covers the cases people will care most about.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_ide/src/stub_mapping.rs</code>:26 on 2025-07-21 22:25</div>
            <div class="timeline-body"><p>I agree the StubMapper abstraction isn't really doing anything for us (and I had to put all the code outside of it to use all the features of <code>ty_python_semantic</code> that aren't <code>pub</code>). For now I'm leaving it here in case more advanced things (or perf concerns) give motivation to it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-21 22:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-21 22:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/src/types/ide_support.rs</code>:1095 on 2025-07-21 22:26</div>
            <div class="timeline-body"><p>Yeah especially given it's only called on the leaf node and not for the internal nodes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-21 22:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/src/types/ide_support.rs</code>:1079 on 2025-07-21 22:27</div>
            <div class="timeline-body"><p>It actually used to just be <code>Module(File)</code> but then i pulled main and it had turned into <code>FileWithRange</code> with that extra case. Not sure what's up with that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-21 22:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_ide/src/goto_definition.rs</code>:350 on 2025-07-21 22:30</div>
            <div class="timeline-body"><p>I think perhaps the nuance is in the distinction between goto-definition and goto-declaration? But if so I still agree this case is dubious -- if we're enforcing that kind of distinction then the goto-definition should be empty here! (In fact it's possible it <em>should</em> be empty but my stub_mapping implementation is too naive to notice that).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-07-21 22:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_ide/src/goto_definition.rs</code>:350 on 2025-07-21 22:37</div>
            <div class="timeline-body"><p>I think my comment is kind of driving in the opposite direction here? That is, I think that <code>class MyClass: ...</code> in a <code>.py</code> file is not in any meaningful sense a &quot;stub&quot;. It is a fully valid runtime implementation/definition of <code>MyClass</code> (just as much as <code>class MyClass:</code> followed by a three-hundred-line body would be), and we shouldn't treat it otherwise. Goto-definition should happily go to it (as it already does). So while I think the tested behavior here is fully correct, I don't really understand what is noteworthy or test-worthy about this case.</p>
<p>The only thing I see here that makes this test not totally redundant with <code>goto_definition_stub_map_class_ref</code> above, is that here the cursor is directly on the import name, not on a later reference. That does seem worth testing! But if that's the purpose of the test, then it should be named and commented differently. Name it eg <code>goto_definition_stub_map_class_import</code>, and just delete the comment about &quot;both define a stub&quot;. And don't use a <code>...</code> body in the <code>.py</code> file, because that's just confusing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_ide/src/goto_definition.rs</code>:45 on 2025-07-21 22:48</div>
            <div class="timeline-body"><p>nit: our usual practice in ty is TODO comments, not FIXME comments (assuming you aren't planning to fix this before landing this PR)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-21 22:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_ide/src/goto_definition.rs</code>:53 on 2025-07-21 22:49</div>
            <div class="timeline-body"><p>I'm pretty sure this is a pre-existing bug earlier in the goto-def pipeline where we just handle import statements a little bit different (notably the next test where we click on a reference to an imported module resolves fine..). Checking in this &quot;broken&quot; case seems worthwhile.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-21 22:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_ide/src/goto_definition.rs</code>:185 on 2025-07-21 22:50</div>
            <div class="timeline-body"><p>Genuinely unsure what's correct here but I can definitely say for certain this behaviour naturally falls out of the fairly naive logic in my implementation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_ide/src/goto_definition.rs</code>:183 on 2025-07-21 22:52</div>
            <div class="timeline-body"><p>It might be worth testing how other LSPs (e.g. pylance in VSCode) handle this. I think our handling for this case with both <code>.py</code> and <code>.pyi</code> should be the same as our handling if there's only the <code>.py</code> and no stub-mapping is involved. I believe currently in the latter case we would highlight all definitions, not just the latest one (and that this was an intentional design choice by @UnboundVariable). In general the design choice was that it's confusing for users to highlight different definitions of a symbol depending on location in control flow, and it's better to just highlight all the definitions we can find.</p>
<p>So I think this is probably not a FIXME</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-07-21 22:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-21 22:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_ide/src/goto_definition.rs</code>:350 on 2025-07-21 22:52</div>
            <div class="timeline-body"><p>I'm gonna leave it in the PR for now so others have a chance to chime in here (I'm fine with whatever).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/UnboundVariable">@UnboundVariable</a> reviewed on 2025-07-21 23:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/UnboundVariable">@UnboundVariable</a> on <code>crates/ty_python_semantic/src/types/ide_support.rs</code>:1079 on 2025-07-21 23:04</div>
            <div class="timeline-body"><p>I changed it to FileWithRange when I added support for keyword arguments. @carljm, are you sure those have definitions? I found definitions for keyword <em>parameters</em> but not for keyword <em>arguments</em>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/UnboundVariable">@UnboundVariable</a> reviewed on 2025-07-21 23:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/UnboundVariable">@UnboundVariable</a> on <code>crates/ty_python_semantic/src/types/ide_support.rs</code>:1095 on 2025-07-21 23:06</div>
            <div class="timeline-body"><p>We should probably deduplicate internally. Most clients deduplicate, but some of them don't like to receive duplicates. This will become even more important for follow-on features like &quot;find references&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/ide_support.rs</code>:1079 on 2025-07-21 23:11</div>
            <div class="timeline-body"><p>If I'm reading the code correctly in <code>definitions_for_keyword_argument</code>, the source is an argument, but the <code>ResolvedDefinition</code> resolves to the corresponding parameter in the callable's signature. That's what the doc comment says, and what the code appears to do.</p>
<p>It is correct that there's no Definition for the argument, but there is one for the parameter. Which seems like it should mean that we can return a <code>ResolvedDefinition::Definition</code> there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-07-21 23:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-21 23:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/src/types/ide_support.rs</code>:1095 on 2025-07-21 23:24</div>
            <div class="timeline-body"><p>Added an IndexSet to map_stub_definitions to do deduping at this point in the API.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-07-21 23:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/ide_support.rs</code>:1095 on 2025-07-21 23:36</div>
            <div class="timeline-body"><p>I think if we are going to dedupe, the deduping should happen at a different layer (perhaps inside <code>find_symbol_in_scope</code>?) so that it applies to both goto-declaration and stub-mapped goto-definition; the issue is not specific to stub-mapping.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-07-21 23:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_ide/src/goto_definition.rs</code>:350 on 2025-07-21 23:39</div>
            <div class="timeline-body"><p>That's fine, but looking into Alex's comment where I think this test came from, I'm pretty sure the fact that both definitions use <code>class Foo: ...</code> in that example is entirely incidental, not part of Alex's point at all. The point of that comment was simply that we were wrongly failing to prefer <code>module.py</code> over <code>module.pyi</code>. You already fixed that (by pushing <code>mode</code> deeper), and plenty of other tests here validate that fix already. So I'm pretty confident this test can be removed or reworked per my comment above, without contradicting anything Alex was suggesting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/module_resolver/resolver.rs</code>:669 on 2025-07-22 06:23</div>
            <div class="timeline-body"><p>You could add <code>mode</code> to <code>ResolverContext</code> instead of funnelying it through all calls (we already do this for <code>context</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types/ide_support.rs</code>:1012 on 2025-07-22 06:25</div>
            <div class="timeline-body"><p>This is something we discussed on Friday and I'm fine deferring this to another PR but <code>file_to_module</code> will fail for every resolved <em>real module</em>. That means that import resolution won't work for those files. We may want to change <code>file_to_module</code> to always return the module name if file matches the <code>real_module</code> (and not only the <code>resolved_module</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-22 06:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-22 11:17</div>
            <div class="timeline-body"><blockquote>
<p>Not sure how you were testing that -- in the cursor tests it actually yields &quot;no goto (definition) target found&quot;. If you created this is an IDE and e.g. cmd+clicked, you may have just unknowingly triggered goto-declaration (if there's no results for goto-definition, goto-declaration is used by the IDE).</p>
<p>I've pushed up a commit adding a test for this.</p>
</blockquote>
<p>Oh, yeah, I was interactively testing by running the playground locally using your branch. (You can do this by running <code>cd playground; npm start --workspace ty-playground</code> from the root of the Ruff repository, then opening http://localhost:5173/ in a browser window. It's a great way to experiment with IDE features!) So it might well have just fallen back to goto-declaration!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/goto_definition.rs</code>:328 on 2025-07-22 11:34</div>
            <div class="timeline-body"><blockquote>
<p>IMO we should not support the case as shown here, because the stub is kind of just lying.</p>
</blockquote>
<p>I can't see the full test that you were commenting on here, but note that there are many places where the stub will be &quot;kind of just lying&quot;, where it will be important for us to be able to figure out where the actual, truthful runtime definition of something is. For example, if you do &quot;goto declaration&quot; for <code>typing.Iterable</code> in Pylance, it takes you to https://github.com/python/typeshed/blob/ddd8434a42b83923b770450386ee12672ab3c604/stdlib/typing.pyi#L501-L504, but if you do &quot;goto definition&quot;, it takes you to https://github.com/python/cpython/blob/c933a6bb329bb97bc7e448388dad1b74f7ca4baa/Lib/typing.py#L2714. The definition is a class in the stub but a variable assignment at runtime -- but being able to jump to the runtime definition is very useful if you're trying to figure out why the runtime behaviour of these aliases is different for some reason!</p>
<p>Similarly, typeshed will usually pretend that <code>types.SimpleNamespace</code> instances are instances of custom classes rather than instances of <code>SimpleNamespace</code>, since attributes on <code>SimpleNamespace</code> instances are untypable</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-07-22 11:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-22 12:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/src/types/ide_support.rs</code>:1095 on 2025-07-22 12:36</div>
            <div class="timeline-body"><p>Done in find_symbol_in_scope</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-22 12:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_ide/src/goto_definition.rs</code>:328 on 2025-07-22 12:37</div>
            <div class="timeline-body"><p>I'm just gonna remove this test for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @Gankra on 2025-07-22 12:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Gankra on 2025-07-22 12:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-22 12:42</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:14:26 UTC
    </footer>
</body>
</html>
