<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Do not attach diagnostics to wrong file - astral-sh/ruff #14337</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Do not attach diagnostics to wrong file</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14337">#14337</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2024-11-14 12:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-14 12:43</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Avoid attaching diagnostics to the wrong file. See related issue for details.</p>
<p>Closes #14334</p>
<h2>Test Plan</h2>
<p>New regression test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @sharkdp on 2024-11-14 12:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2024-11-14 12:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @sharkdp on 2024-11-14 12:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2024-11-14 12:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/diagnostic.rs</code>:337 on 2024-11-14 12:44</div>
            <div class="timeline-body"><p>I can try to unify this with <code>add_if_expression_in_same_file</code> into a single <code>add_if_in_same_file</code> (using yet another trait?), but I first wanted to check if this approach goes in the right direction.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-11-14 12:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-11-14 12:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:482 on 2024-11-14 12:46</div>
            <div class="timeline-body"><p>Other diagnostics might need the same &quot;treatment&quot;. Again, I first wanted to see if this goes in the right direction. Maybe we want to store a reference to <code>SemanticIndexBuilder</code> in the <code>DiagnosticsBuilder</code> and check this for every diagnostic that we add?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-14 12:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/regression/14334_diagnostics_in_wrong_file.md</code>:1 on 2024-11-14 12:56</div>
            <div class="timeline-body"><p>I can also make this test pass just by applying this diff to <code>main</code>, without any of the other changes you make in this PR:</p>
<pre><code class="language-diff">--- a/crates/red_knot_python_semantic/src/types/infer.rs
+++ b/crates/red_knot_python_semantic/src/types/infer.rs
@@ -471,7 +471,8 @@ impl&lt;'db&gt; TypeInferenceBuilder&lt;'db&gt; {
             .declarations
             .values()
             .filter_map(|ty| ty.into_class_literal())
-            .map(|class_ty| class_ty.class);
+            .map(|class_ty| class_ty.class)
+            .filter(|class| class.file(self.db) == self.file);
</code></pre>
<p>...and I think that might be a better fix. For most of the diagnostics we emit, I think we can be confident that the diagnostic applies to the file we're currently in, because we emit the diagnostic while visiting a specific AST node from that file. The diagnostics emitted from <code>check_class_definitions()</code> are unusual, in that they're emitted after the AST of the whole module has been visited. (That's necessary because of the fact that inference of class bases is sometimes deferred.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-14 12:58</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-14 12:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/resources/mdtest/regression/14334_diagnostics_in_wrong_file.md</code>:1 on 2024-11-14 12:59</div>
            <div class="timeline-body"><p>I'm in favor of a more local fix, considering that class inheritance is the odd one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-14 13:00</div>
            <div class="timeline-body"><p>Great catch!! I think your idea in https://github.com/astral-sh/ruff/issues/14334#issue-2658241214 of adding some assertions (or making this kind of thing impossible to happen in the first place) would be a great improvement. It didn't even occur to me that this iterator would also iterate over class definitions that originated from other files as well here, though now it seems obvious.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:480 on 2024-11-14 13:00</div>
            <div class="timeline-body"><p>All diagnostics here should be guaranteed to be from the same file because <code>class.node</code> is from the current scope. If it's not, then we should not access the node in the first place. Accessing nodes across module boundaries in type-inference is bad because it results in larger invalidation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-14 13:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-11-14 13:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:480 on 2024-11-14 13:10</div>
            <div class="timeline-body"><p>Hm. You are probably right. I added it everywhere because the original error appeared with an example file without any class definitions at all:</p>
<pre><code>from subprocess import Popen
</code></pre>
<p>Or do we consider the import of <code>Popen</code> to be a class definition in this file?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-14 13:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:480 on 2024-11-14 13:12</div>
            <div class="timeline-body"><blockquote>
<p>Or do we consider the import of <code>Popen</code> to be a class definition in this file?</p>
</blockquote>
<p>The import of <code>Popen</code> constitutes a <code>Definition</code> and <code>Declaration</code> of the <code>Popen</code> symbol in this file, and the type of that <code>Declaration</code> is a <code>ClassLiteralType</code>...!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-14 13:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/regression/14334_diagnostics_in_wrong_file.md</code>:1 on 2024-11-14 13:14</div>
            <div class="timeline-body"><blockquote>
<p>I'm in favor of a more local fix, considering that class inheritance is the odd one.</p>
</blockquote>
<p>I'm not sure if you're agreeing with me or disagreeing with me ðŸ˜„ Do you mean &quot;more local than David's current PR&quot; or &quot;more local than my alternative fix&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-11-14 13:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:480 on 2024-11-14 13:19</div>
            <div class="timeline-body"><p>Ah, okay. Thanks! ~~I reverted the check for the local classes.~~ Wait, no. I need to think â€¦</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-14 13:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:480 on 2024-11-14 13:29</div>
            <div class="timeline-body"><p>I'm still not sure we should be looking at any classes that originate from other modules in this <code>class_definitions</code> iterator (https://github.com/astral-sh/ruff/pull/14337#discussion_r1842177196)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:480 on 2024-11-14 13:32</div>
            <div class="timeline-body"><p>No, I think we need that check here. I added an additional test to check for this. If we don't check this here, we will get an additional diagnostic at the line of the import (with a wrong <code>range</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-11-14 13:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-11-14 13:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/regression/14334_diagnostics_in_wrong_file.md</code>:1 on 2024-11-14 13:34</div>
            <div class="timeline-body"><blockquote>
<p>considering that class inheritance is the odd one</p>
</blockquote>
<p>No. It's not because of class inheritance. It also appears for the other error kinds. My regression test was maybe a bit misleading (that derived class is not even needed, the mistake happens at the import statement). I modified it the test now and added a new one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:480 on 2024-11-14 13:42</div>
            <div class="timeline-body"><p>I think the problem is the <code>self.types.declarations.values()</code>. We only want to iterate over classes that were declared in this file. Instead, it iterates over all declarations that have a class type, that includes imports and possibly others.</p>
<p>We should adopt the filter above to filter out classes from other scopes AND only collect unique literals.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-14 13:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:480 on 2024-11-14 13:45</div>
            <div class="timeline-body"><p>Or a better way might be to filter based on the <code>declaration</code>s key to assert that it is a class definition</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-14 13:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-14 13:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:480 on 2024-11-14 13:48</div>
            <div class="timeline-body"><p>Something like this</p>
<pre><code>let class_definitions = self
            .types
            .declarations
            .iter()
            .filter_map(|(definition, ty)| {
                if matches!(definition.kind(self.db), DefinitionKind::Class(_)) {
                    ty.into_class_literal()
                } else {
                    None
                }
            })
            .map(|class_ty| class_ty.class);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-14 13:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:480 on 2024-11-14 13:52</div>
            <div class="timeline-body"><p>Sorry for keeping commenting. A related improvement would be that the iterator also returns the <code>node</code> so that we can replace the <code>class.node</code> calls (they're not expensive but getting them directly from the definition makes it more explicit that they are guaranteed to be from the same scope)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-11-14 13:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/regression/14334_diagnostics_in_wrong_file.md</code>:1 on 2024-11-14 13:58</div>
            <div class="timeline-body"><p>Ok, the new approach is similar to what you proposed, @AlexWaygood. I removed all of my <code>if_same_file</code> functionality for now. Adding that assertion somewhere would probably still be a good idea.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:480 on 2024-11-14 14:04</div>
            <div class="timeline-body"><blockquote>
<p>Something like this</p>
</blockquote>
<p>Saw this too late, but came up with the exact same code. Except for a name difference (now changed to yours).</p>
<blockquote>
<p>A related improvement would be that the iterator also returns the <code>node</code></p>
</blockquote>
<p>Done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-11-14 14:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:481 on 2024-11-14 14:07</div>
            <div class="timeline-body"><p>Sorry, what I meant is this</p>
<pre><code class="language-suggestion">            .iter()
            .filter_map(|(definition, ty)| {
                // Filter out class literals that result from imports
                if let DefinitionKind::Class(class) = definition.kind(self.db) {
                    ty.into_class_literal().map(|ty| (class, ty.class))
                } else {
                    None
                }
            });
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:483 on 2024-11-14 14:08</div>
            <div class="timeline-body"><p>to me it felt cleaner when we only iterated over the <code>Class</code>es, and retrieved the AST node for the class only if there was actually an error associated with that class. But ðŸ¤· no strong opinion, if @MichaReiser prefers it this way</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-11-14 14:08</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-11-14 14:09</div>
            <div class="timeline-body"><p>Thanks, nice find!</p>
<p>It would be nice if we could add an assertion to the diagnostic builder that enforces this but it isn't clear to me how, at least if it should work for arbitrary nodes</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-14 14:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:483 on 2024-11-14 14:10</div>
            <div class="timeline-body"><p>I hope my latest suggestion makes it more obvious why I prefer it this way</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-14 14:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:483 on 2024-11-14 14:11</div>
            <div class="timeline-body"><p>it does, thanks!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-11-14 14:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:481 on 2024-11-14 14:25</div>
            <div class="timeline-body"><p>Ah, okay. Now it makes more sense. I assume you mean <code>class.node()</code> instead of <code>class</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2024-11-14 14:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2024-11-14 14:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-14 14:39</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 20:51:28 UTC
    </footer>
</body>
</html>
