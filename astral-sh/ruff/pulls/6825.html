<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Format all attribute dot comments manually - astral-sh/ruff #6825</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Format all attribute dot comments manually</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6825">#6825</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-08-23 20:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-23 20:57</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR modifies our formatting of comments around the <code>.</code> in an attribute. Specifically, the goal here is to avoid <em>reordering</em> comments, and the net effect is that we generally leave comments where-they-are when dealing with comments between around the dot (which you can also think of as comments between attributes).</p>
<p>All comments around the dot are now treated as dangling and formatted manually, with the exception of end-of-line or parenthesized comments on the value, like those marked as trailing here, which remain trailing:</p>
<pre><code class="language-python">(
    (
        a # trailing end-of-line
        # trailing own-line
    ) # dangling before dot end-of-line
    .b # trailing end-of-line
)
</code></pre>
<p>Closes https://github.com/astral-sh/ruff/issues/6823.</p>
<h2>Test Plan</h2>
<p><code>cargo test</code></p>
<p>Before:</p>
<p>| project      | similarity index |
|--------------|------------------|
| cpython      | 0.76050          |
| django       | 0.99820          |
| transformers | 0.99800          |
| twine        | 0.99876          |
| typeshed     | 0.99953          |
| warehouse    | 0.99615          |
| zulip        | 0.99729          |</p>
<p>After:</p>
<p>| project      | similarity index |
|--------------|------------------|
| cpython      | 0.76050          |
| django       | 0.99820   |
| transformers | 0.99800          |
| twine        | 0.99876          |
| typeshed     | 0.99953          |
| warehouse    | 0.99615          |
| zulip        | 0.99729          |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-23 20:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/expression/expr_attribute.rs</code>:187 on 2023-08-23 20:58</div>
            <div class="timeline-body"><p>This is the same as the method in placement, but it doesn't have a natural home. Any ideas?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/expression/expr_attribute.rs</code>:95 on 2023-08-23 20:59</div>
            <div class="timeline-body"><p>We get to unify these branches now which I see as a win.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/expression/expr_attribute.rs</code>:93 on 2023-08-23 20:59</div>
            <div class="timeline-body"><p>No longer necessary, since this is only possible if the node is parenthesized anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/expression/expr_attribute.rs</code>:166 on 2023-08-23 20:59</div>
            <div class="timeline-body"><p>This is much simpler now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-23 20:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-08-23 21:36</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>✅ ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.02      4.7±0.07ms     8.6 MB/sec    1.00      4.6±0.06ms     8.8 MB/sec
formatter/numpy/ctypeslib.py               1.01   983.8±10.42µs    16.9 MB/sec    1.00   973.0±12.27µs    17.1 MB/sec
formatter/numpy/globals.py                 1.02     94.3±1.40µs    31.3 MB/sec    1.00     92.4±1.37µs    31.9 MB/sec
formatter/pydantic/types.py                1.01  1933.3±25.17µs    13.2 MB/sec    1.00  1913.8±19.94µs    13.3 MB/sec
linter/all-rules/large/dataset.py          1.01     12.1±0.10ms     3.4 MB/sec    1.00     12.0±0.14ms     3.4 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.2±0.03ms     5.2 MB/sec    1.00      3.2±0.03ms     5.2 MB/sec
linter/all-rules/numpy/globals.py          1.00    455.0±5.60µs     6.5 MB/sec    1.00    454.6±4.97µs     6.5 MB/sec
linter/all-rules/pydantic/types.py         1.01      6.3±0.06ms     4.1 MB/sec    1.00      6.2±0.06ms     4.1 MB/sec
linter/default-rules/large/dataset.py      1.00      6.3±0.05ms     6.4 MB/sec    1.01      6.4±0.05ms     6.4 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1418.7±13.11µs    11.7 MB/sec    1.00  1419.4±17.06µs    11.7 MB/sec
linter/default-rules/numpy/globals.py      1.00    166.7±1.77µs    17.7 MB/sec    1.01    168.0±1.38µs    17.6 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.9±0.02ms     8.8 MB/sec    1.00      2.9±0.03ms     8.8 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.03      6.0±0.27ms     6.8 MB/sec    1.00      5.9±0.21ms     6.9 MB/sec
formatter/numpy/ctypeslib.py               1.02  1248.9±83.22µs    13.3 MB/sec    1.00  1221.9±83.85µs    13.6 MB/sec
formatter/numpy/globals.py                 1.03    114.6±7.56µs    25.7 MB/sec    1.00    111.0±8.45µs    26.6 MB/sec
formatter/pydantic/types.py                1.02      2.5±0.15ms    10.3 MB/sec    1.00      2.4±0.09ms    10.5 MB/sec
linter/all-rules/large/dataset.py          1.00     17.4±0.64ms     2.3 MB/sec    1.00     17.5±0.96ms     2.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.5±0.24ms     3.7 MB/sec    1.05      4.8±0.30ms     3.5 MB/sec
linter/all-rules/numpy/globals.py          1.01   601.1±45.59µs     4.9 MB/sec    1.00   595.1±31.99µs     5.0 MB/sec
linter/all-rules/pydantic/types.py         1.00      8.9±0.37ms     2.9 MB/sec    1.03      9.2±0.36ms     2.8 MB/sec
linter/default-rules/large/dataset.py      1.00      9.8±0.45ms     4.2 MB/sec    1.03     10.0±0.37ms     4.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00      2.1±0.10ms     8.1 MB/sec    1.01      2.1±0.09ms     8.0 MB/sec
linter/default-rules/numpy/globals.py      1.07   263.7±19.02µs    11.2 MB/sec    1.00   246.3±15.57µs    12.0 MB/sec
linter/default-rules/pydantic/types.py     1.02      4.5±0.22ms     5.7 MB/sec    1.00      4.4±0.25ms     5.8 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @charliermarsh on 2023-08-23 22:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2023-08-23 22:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @charliermarsh on 2023-08-23 22:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_attribute.rs</code>:126 on 2023-08-24 06:55</div>
            <div class="timeline-body"><p>Is the writing of the hard line break still necessary after your <code>dangling_comments</code> change?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_attribute.rs</code>:187 on 2023-08-24 06:56</div>
            <div class="timeline-body"><p>How about moving it next to <code>first_non_trivia_token</code>?</p>
<p>https://github.com/astral-sh/ruff/blob/86ccdcc9d99086b15e86f3d07b83d39a9422069d/crates/ruff_python_trivia/src/tokenizer.rs#L16</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-08-24 06:57</div>
            <div class="timeline-body"><p>Thank you so much for handling all these comments with so much care.</p>
<p>Nit: It would be helpful for reviewers if you could add a small summary above the similarity index table, e.g. no changes, or small improvements for a few projects. It removes the need for myself to scan through the two tables</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/expr_attribute.rs</code>:187 on 2023-08-24 10:27</div>
            <div class="timeline-body"><p>you could make it a <code>SimpleTokenizer</code> method</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-08-24 10:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-24 18:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/expression/expr_attribute.rs</code>:126 on 2023-08-24 18:20</div>
            <div class="timeline-body"><p>No, good eye! But that's downstream of this, it's removed in the next PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-08-25 03:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-08-25 03:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-08-25 03:50</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 02:46:15 UTC
    </footer>
</body>
</html>
