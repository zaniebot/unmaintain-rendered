<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add new &quot;constraint implication&quot; typing relation - astral-sh/ruff #21010</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add new &quot;constraint implication&quot; typing relation</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21010">#21010</a>
        opened by <a href="https://github.com/dcreager">@dcreager</a>
        on 2025-10-21 01:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a></div>
            <div class="timeline-body"><p>This PR adds the new <strong><em>constraint implication</em></strong> relationship between types, aka <code>is_subtype_of_given</code>, which tests whether one type is a subtype of another <em>assuming that the constraints in a particular constraint set hold</em>.</p>
<p>For concrete types, constraint implication is exactly the same as subtyping. (A concrete type is any fully static type that is not a typevar. It can <em>contain</em> a typevar, though — <code>list[T]</code> is considered concrete.)</p>
<p>The interesting case is typevars. The other typing relationships (TODO: will) all &quot;punt&quot; on the question when considering a typevar, by translating the desired relationship into a constraint set. At some point, though, we need to resolve a constraint set; at that point, we can no longer punt on the question. Unlike with concrete types, the answer will depend on the constraint set that we are considering.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/dcreager">@dcreager</a> on 2025-10-21 01:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/dcreager">@dcreager</a> on 2025-10-21 01:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-21 01:56</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-21 01:57</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types.rs</code>:1 on 2025-10-23 19:42</div>
            <div class="timeline-body"><p>I had originally written this as a new <code>TypeRelation</code> variant, but that was too heavy-handed, given that constraint implication is exactly the same as subtyping for everything except for typevars.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-10-23 19:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/resources/mdtest/type_properties/is_subtype_of_given.md</code>:50 on 2025-10-24 17:48</div>
            <div class="timeline-body"><p>This TODO is #20093</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/resources/mdtest/type_properties/is_subtype_of_given.md</code>:177 on 2025-10-24 17:50</div>
            <div class="timeline-body"><p>This will be involved enough that I&#x27;m tackling it separately, in #21068</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types.rs</code>:8537 on 2025-10-24 17:52</div>
            <div class="timeline-body"><p>We should always be comparing a typevar&#x27;s identity, and this makes it harder to accidentally compare specific instances of a typevar.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/type_ordering.rs</code>:144 on 2025-10-24 17:53</div>
            <div class="timeline-body"><p>but this is the one place where we do still want to compare typevar instances, not identities</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-10-24 17:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/dcreager">@dcreager</a> on 2025-10-24 18:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/dcreager">@dcreager</a> on 2025-10-24 18:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/dcreager">@dcreager</a> on 2025-10-24 18:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/dcreager">@dcreager</a> on 2025-10-24 18:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/dcreager">@dcreager</a> on 2025-10-24 18:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_vendored/ty_extensions/ty_extensions.pyi</code>:82 on 2025-10-27 09:33</div>
            <div class="timeline-body"><p>I just wanted to suggest making this a method on <code>ConstraintSet</code> but that doesn&#x27;t work because you also want to allow <code>bool</code> as <code>constraints</code>.</p>
<p>I&#x27;m not sure I fully understand the semantics here. Is this roughly if and only if <code>constraints</code> semantics? If that&#x27;s the case, I think I&#x27;d find <code>is_subtype_of_iff(ty, of, constraints)</code> easier to understand.</p>
<p>But I don&#x27;t think that&#x27;s what this API does after reading the mdtests. Hmm :)</p>
<p>I&#x27;m asking because I first assumed the relation between <code>is_subtype_of</code> and <code>is_subtype_of_given</code> is similar to <code>std::mem::size_of</code> and <code>std::mem::size_of_val</code> where the latter takes a value. I don&#x27;t think this is the case here because <code>constraints</code> would than have to be a subtype of <code>ty</code>, which the API doesn&#x27;t require.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/resources/mdtest/type_properties/is_subtype_of_given.md</code>:26 on 2025-10-27 09:35</div>
            <div class="timeline-body"><p>Is <code>is_subtype_of(T, V)</code> guaranteed to always be the same as <code>is_subtype_of(True, T, V)</code>. If so, maybe that&#x27;s something you could add to the documentation of <code>is_subtype_of_given</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types.rs</code>:4852 on 2025-10-27 09:40</div>
            <div class="timeline-body"><p>Is it intentional that the first two parameters have the same name? Should we use the same names as in the <code>pyi</code> files (it would allow me to easier match the parameters)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types/constraints.rs</code>:188 on 2025-10-27 09:41</div>
            <div class="timeline-body"><p>Is it? ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types/constraints.rs</code>:360 on 2025-10-27 09:44</div>
            <div class="timeline-body"><p>Should this use <code>is_same_typevar</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types/type_ordering.rs</code>:144 on 2025-10-27 09:47</div>
            <div class="timeline-body"><p>Should we add an inline comment explaining why that&#x27;s the case?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-10-27 09:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/resources/mdtest/type_properties/is_subtype_of_given.md</code>:26 on 2025-10-27 19:03</div>
            <div class="timeline-body"><p>This is a great catch! I was in the middle of writing that this would not be true when comparing typevars — but you&#x27;re right, and it <em>is</em> true even then:</p>
<pre><code>is_subtype_of(bool, int)               # yes
is_subtype_of_given(True, bool, int)   # yes
is_subtype_of_given(False, bool, int)  # yes

def f[T]():
    is_subtype_of(T, int)              # no (T could be anything!)
    is_subtype_of_given(True, T, int)  # also no (T could be anything!)
</code></pre>
<p>This also made me realize that I don&#x27;t need to (and shouldn&#x27;t) project away the other typevars like I was doing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/constraints.rs</code>:188 on 2025-10-27 19:07</div>
            <div class="timeline-body"><p>@AlexWaygood do you have thoughts here? I was thinking that we should treat redundancy the same as subtyping here. Adding more context, the question is, if you call <code>is_redundant_with(T, list[Any])</code>, what constraint should we turn that into? For <code>is_subtype_of(T, list[Any])</code>, we turn it into <code>T ≤ Bottom[list[Any]]</code>, since for subtyping, the relationship has to hold for <em>all</em> materializations. For <code>is_assignable_to(T, list[Any])</code>, we turn it into <code>T ≤ Top[list[Any]]</code>, since the relationship only has to hold for <em>some</em> materialization.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/constraints.rs</code>:360 on 2025-10-27 19:08</div>
            <div class="timeline-body"><p>Yes!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/type_ordering.rs</code>:144 on 2025-10-27 19:08</div>
            <div class="timeline-body"><p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types.rs</code>:4852 on 2025-10-27 19:10</div>
            <div class="timeline-body"><p>Nope, that was bad copy/pasta. Done</p>
<p>(And once we have support for <code>TypeForm</code>, all of these special cases can go away)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_vendored/ty_extensions/ty_extensions.pyi</code>:82 on 2025-10-27 19:12</div>
            <div class="timeline-body"><blockquote>
<p>I just wanted to suggest making this a method on <code>ConstraintSet</code> but that doesn&#x27;t work because you also want to allow <code>bool</code> as <code>constraints</code>.</p>
</blockquote>
<p>Yeah, I thought the same thing, but our <code>KnownFunction</code> machinery is focused on top-level functions in a module. I had considered adding support for &quot;known methods of a class&quot;, but that seemed like it would be out of scope for this PR. I can open an issue to track that.</p>
<blockquote>
<p>I&#x27;m not sure I fully understand the semantics here. Is this roughly if and only if <code>constraints</code> semantics? If that&#x27;s the case, I think I&#x27;d find <code>is_subtype_of_iff(ty, of, constraints)</code> easier to understand.</p>
</blockquote>
<p>I can copy over more of the commentary from the mdtest to explain the method better.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-10-27 19:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-27 19:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/constraints.rs</code>:188 on 2025-10-27 19:48</div>
            <div class="timeline-body"><p>Happy to take a look at this, but might not get to it until Wednesday as I&#x27;m busy travelling tomorrow. Don&#x27;t feel you have to wait for me before merging!</p>
<p>In general, if we&#x27;re in doubt about how redundancy should behave, the safe thing to do in that situation is always to treat it like subtyping</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-10-27 19:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_vendored/ty_extensions/ty_extensions.pyi</code>:82 on 2025-10-27 19:56</div>
            <div class="timeline-body"><p>Done. I put the expanded documentation on the Rust side, to be consistent with where we are documenting the other typing internals.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-10-27 20:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/constraints.rs</code>:188 on 2025-10-27 20:02</div>
            <div class="timeline-body"><p>Thanks! This isn&#x27;t hooked up to anything yet except isolated mdtests, so no urgency.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-10-27 20:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/constraints.rs</code>:188 on 2025-10-27 20:03</div>
            <div class="timeline-body"><p>(But I will still probably merge this and address anything you might find in a follow-on PR)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-10-27 20:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_vendored/ty_extensions/ty_extensions.pyi</code>:82 on 2025-10-27 20:09</div>
            <div class="timeline-body"><blockquote>
<p>Yeah, I thought the same thing, but our <code>KnownFunction</code> machinery is focused on top-level functions in a module. I had considered adding support for &quot;known methods of a class&quot;, but that seemed like it would be out of scope for this PR. I can open an issue to track that.</p>
</blockquote>
<p>https://github.com/astral-sh/ty/issues/1447</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dcreager">@dcreager</a> on 2025-10-28 02:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dcreager">@dcreager</a> on 2025-10-28 02:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-10-28 02:01</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:19:46 UTC
    </footer>
</body>
</html>
