<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pyupgrade`] Avoid PEP-604 unions with `typing.NamedTuple` (`UP007`, `UP045`) - astral-sh/ruff #18682</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pyupgrade</code>] Avoid PEP-604 unions with <code>typing.NamedTuple</code> (<code>UP007</code>, <code>UP045</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18682">#18682</a>
        opened by <a href="https://github.com/robsdedude">@robsdedude</a>
        on 2025-06-15 11:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff/ty! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title? (Please prefix with `[ty]` for ty pull
  requests.)
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>Make <code>UP045</code> ignore <code>Optional[NamedTuple]</code> as <code>NamedTuple</code> is a function (not a proper type). Rewriting it to <code>NamedTuple | None</code> breaks at runtime. While type checkers currently accept <code>NamedTuple</code> as a type, they arguably shouldn't. Therefore, we outright ignore it and don't touch or lint on it.</p>
<p>For a more detailed discussion, see the linked issue.</p>
<h2>Test Plan</h2>
<p>Added examples to the existing tests.</p>
<h2>Related Issues</h2>
<p>Fixes: https://github.com/astral-sh/ruff/issues/18619</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-15 11:16</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @robsdedude on 2025-06-15 11:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @ntBre on 2025-06-15 17:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @ntBre on 2025-06-15 17:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/resources/test/fixtures/pyupgrade/UP007.py</code>:1 on 2025-06-16 19:42</div>
            <div class="timeline-body"><p>This is getting very slightly ahead of ourselves, but we're stabilizing UP045 and the <a href="https://docs.astral.sh/ruff/rules/non-pep604-annotation-union/#preview">preview</a> behavior of UP007 in the upcoming release, which is taking place tomorrow. So could you update the tests in this file only to test the <code>Union</code> behavior? More generally,  do we need to add tests for <code>Union</code>? I'm assuming an error is raised for <code>NamedTuple | int</code>, for example, not just <code>NamedTuple | None</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/resources/test/fixtures/pyupgrade/UP007.py</code>:5 on 2025-06-16 19:44</div>
            <div class="timeline-body"><p>nit: I know it's not a good way to format real Python code, but I generally prefer adding new imports at the bottom of the file too, just to avoid shifting all of the existing snapshots and making the diff larger. Another option is moving the existing test file to a name like <code>UP007_0.py</code> and adding an entirely new fixture called <code>UP007_1.py</code> to accompany it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-16 19:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @robsdedude on 2025-06-24 19:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`pyupgrade`] Fix `UP007`: ignore `Optional[NamedTuple]`" to "[`pyupgrade`] Fix `UP045`: ignore `Optional[NamedTuple]`" by @robsdedude on 2025-06-24 19:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/use_pep604_annotation.rs</code>:138 on 2025-06-26 18:47</div>
            <div class="timeline-body"><p>nit: I think this might make sense as the docstring for <code>is_optional_named_tuple</code> instead of here in the middle of the code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-26 18:53</div>
            <div class="timeline-body"><p>Thanks, I think this looks good for UP045. However, we have the same problem for UP007, which is actually the rule from the initial report. Maybe my earlier comments were a bit confusing, but we need to handle both UP045, which replaces <code>Optional[NamedTuple]</code> with <code>NamedTuple | None</code> <em>and</em> UP007, which replaces <code>Union[NamedTuple, int]</code> (for example) with <code>NamedTuple | int</code>, which is also an error.</p>
<p>https://play.ruff.rs/d0e71fc1-5210-4eb0-a0a5-e37b01fb6b11</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @robsdedude on 2025-06-29 13:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-06-30 21:21</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`pyupgrade`] Fix `UP045`: ignore `Optional[NamedTuple]`" to "[`pyupgrade`] Avoid PEP-604 unions with `typing.NamedTuple` (`UP007`, `UP045`)" by @ntBre on 2025-06-30 21:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-06-30 21:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-06-30 21:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-30 22:18</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:13:24 UTC
    </footer>
</body>
</html>
