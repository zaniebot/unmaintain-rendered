<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update B027 to support autofixing - astral-sh/ruff #4178</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Update B027 to support autofixing</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4178">#4178</a>
        opened by <a href="https://github.com/aacunningham">@aacunningham</a>
        on 2023-05-02 06:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/aacunningham">@aacunningham</a></div>
            <div class="timeline-body"><p>Adding the ability to autofix B027 errors from bugbear by adding an <code>@abstractmethod</code> decorator above the offending function.</p>
<p>Resolves #4163</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/aacunningham">@aacunningham</a> reviewed on 2023-05-02 06:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/aacunningham">@aacunningham</a> on <code>crates/ruff/src/rules/flake8_bugbear/rules/abstract_base_class.rs</code>:142 on 2023-05-02 06:22</div>
            <div class="timeline-body"><p>The end result looks pretty alright, just from eyeballing the snapshots. But not sure the best way to handle this <code>.unwrap()</code>, or if there's a better way to match the indentation/newline stuff. Thoughts?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/aacunningham">@aacunningham</a> reviewed on 2023-05-02 06:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/aacunningham">@aacunningham</a> on <code>crates/ruff/src/rules/flake8_bugbear/rules/abstract_base_class.rs</code>:138 on 2023-05-02 06:23</div>
            <div class="timeline-body"><p>Do we need to be concerned about <em>also</em> importing the decorator if it's not in the file? Seems weird that fixing the offending code could actually break it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @aacunningham on 2023-05-02 06:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-05-02 06:32</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.01     14.2Â±0.07ms     2.9 MB/sec    1.00     14.0Â±0.04ms     2.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.4Â±0.02ms     4.9 MB/sec    1.00      3.4Â±0.01ms     4.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    421.0Â±0.91Âµs     7.0 MB/sec    1.00    419.2Â±2.32Âµs     7.0 MB/sec
linter/all-rules/pydantic/types.py         1.01      5.9Â±0.03ms     4.3 MB/sec    1.00      5.8Â±0.01ms     4.4 MB/sec
linter/default-rules/large/dataset.py      1.02      7.1Â±0.01ms     5.7 MB/sec    1.00      6.9Â±0.02ms     5.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.02   1516.2Â±1.48Âµs    11.0 MB/sec    1.00   1485.6Â±1.38Âµs    11.2 MB/sec
linter/default-rules/numpy/globals.py      1.02    169.2Â±0.26Âµs    17.4 MB/sec    1.00    166.2Â±0.45Âµs    17.8 MB/sec
linter/default-rules/pydantic/types.py     1.02      3.2Â±0.01ms     8.0 MB/sec    1.00      3.1Â±0.01ms     8.2 MB/sec
parser/large/dataset.py                    1.00      5.4Â±0.00ms     7.5 MB/sec    1.01      5.5Â±0.01ms     7.4 MB/sec
parser/numpy/ctypeslib.py                  1.00   1053.6Â±1.95Âµs    15.8 MB/sec    1.01   1067.6Â±0.47Âµs    15.6 MB/sec
parser/numpy/globals.py                    1.00    107.7Â±0.53Âµs    27.4 MB/sec    1.02    109.8Â±0.52Âµs    26.9 MB/sec
parser/pydantic/types.py                   1.00      2.3Â±0.00ms    11.1 MB/sec    1.01      2.3Â±0.00ms    11.0 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     20.7Â±0.38ms  2014.5 KB/sec    1.01     20.8Â±0.50ms  2002.1 KB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      5.2Â±0.20ms     3.2 MB/sec    1.00      5.2Â±0.15ms     3.2 MB/sec
linter/all-rules/numpy/globals.py          1.00   620.3Â±25.30Âµs     4.8 MB/sec    1.01   627.5Â±30.10Âµs     4.7 MB/sec
linter/all-rules/pydantic/types.py         1.00      8.8Â±0.35ms     2.9 MB/sec    1.00      8.8Â±0.27ms     2.9 MB/sec
linter/default-rules/large/dataset.py      1.01     10.5Â±0.51ms     3.9 MB/sec    1.00     10.5Â±0.23ms     3.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00      2.2Â±0.08ms     7.4 MB/sec    1.00      2.2Â±0.07ms     7.4 MB/sec
linter/default-rules/numpy/globals.py      1.00   253.5Â±13.48Âµs    11.6 MB/sec    1.04   262.5Â±21.54Âµs    11.2 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.8Â±0.22ms     5.4 MB/sec    1.00      4.7Â±0.18ms     5.4 MB/sec
parser/large/dataset.py                    1.01      8.6Â±0.15ms     4.7 MB/sec    1.00      8.5Â±0.23ms     4.8 MB/sec
parser/numpy/ctypeslib.py                  1.01  1648.0Â±61.93Âµs    10.1 MB/sec    1.00  1624.5Â±74.30Âµs    10.3 MB/sec
parser/numpy/globals.py                    1.00    167.3Â±7.88Âµs    17.6 MB/sec    1.00    166.5Â±7.98Âµs    17.7 MB/sec
parser/pydantic/types.py                   1.01      3.6Â±0.11ms     7.0 MB/sec    1.00      3.6Â±0.12ms     7.1 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-02 06:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_bugbear/rules/abstract_base_class.rs</code>:138 on 2023-05-02 06:37</div>
            <div class="timeline-body"><p>Yeah we do need to worry about this! If you take a look at <code>crates/ruff/src/rules/pyupgrade/rules/lru_cache_with_maxsize_none.rs</code>, we have this call to <code>get_or_import_symbol</code> which will either import the symbol if it's not already imported, or give you the correct reference (e.g., <code>import abc as foo; foo.abstractmethod</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-02 06:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_bugbear/rules/abstract_base_class.rs</code>:142 on 2023-05-02 06:38</div>
            <div class="timeline-body"><p>I think we should use an <code>if-let</code> here and only apply the fix if <code>indentation</code> returns <code>Some</code>. I'm trying to come up with a scenario in which <code>indentation</code> could be <code>None</code>... it may not be possible, but it's better to be defensive here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Skylion007">@Skylion007</a> on <code>crates/ruff/src/rules/flake8_bugbear/rules/abstract_base_class.rs</code>:138 on 2023-05-02 14:03</div>
            <div class="timeline-body"><p>@aacunningham Yep, the main reason this autofix wasn't implemented when B027 was added is because we did not have the <code>get_or_import_symbol</code> functionality implemented yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Skylion007">@Skylion007</a> reviewed on 2023-05-02 14:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/aacunningham">@aacunningham</a> reviewed on 2023-05-02 14:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/aacunningham">@aacunningham</a> on <code>crates/ruff/src/rules/flake8_bugbear/rules/abstract_base_class.rs</code>:138 on 2023-05-02 14:20</div>
            <div class="timeline-body"><p>Tbh that's a pretty good reason to pass on adding it ðŸ˜ƒ</p>
<p>Let me take a look at that and squeeze it in here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/aacunningham">@aacunningham</a> reviewed on 2023-05-02 21:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/aacunningham">@aacunningham</a> on <code>crates/ruff/src/rules/flake8_bugbear/snapshots/ruff__rules__flake8_bugbear__tests__B027_B027.py.snap</code>:20 on 2023-05-02 21:17</div>
            <div class="timeline-body"><p>In the fixture there's this at the top:</p>
<pre><code class="language-py">from abc import abstractmethod
from abc import abstractmethod as notabstract
</code></pre>
<p>So <code>get_or_import_symbol</code> seems to prefer <code>notabstract</code> over <code>abstractmethod</code>. It makes this snap look a little funny, but hopefully this code isn't a real life example, and most cases will just import <code>abstractmethod</code>.</p>
<p>Should I see about making a separate fixture to assert that we add an import when it's not there?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/aacunningham">@aacunningham</a> on <code>crates/ruff/src/rules/flake8_bugbear/rules/abstract_base_class.rs</code>:138 on 2023-05-02 21:22</div>
            <div class="timeline-body"><p>Aight, &quot;borrowed&quot; inspiration from <code>lru_cache_with_maxsize_none.rs</code> (wish I had found that one sooner). Looking good, plus it gave me a clean answer for handling that one <code>Option</code> value, converting it to a Result inside that <code>try_set_fix</code> closure.</p>
<p>Thanks y'all, that <code>get_or_import_symbol</code> really made that too easy.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/aacunningham">@aacunningham</a> reviewed on 2023-05-02 21:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_bugbear/snapshots/ruff__rules__flake8_bugbear__tests__B027_B027.py.snap</code>:20 on 2023-05-03 09:04</div>
            <div class="timeline-body"><p>Can we add a new test file specific to this rule without that import at the top to verify this is the case?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_bugbear/rules/abstract_base_class.rs</code>:80 on 2023-05-03 09:06</div>
            <div class="timeline-body"><p>Nit: We could also use <code>unwrap_or_default</code> because <code>indentation</code> returning <code>None</code> means that the <code>stmt</code> is at the beginning of the line.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-05-03 09:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/aacunningham">@aacunningham</a> on <code>crates/ruff/src/rules/flake8_bugbear/rules/abstract_base_class.rs</code>:80 on 2023-05-03 15:36</div>
            <div class="timeline-body"><p>Ooooh that makes a ton of sense, would explain the None. I guess that function only looks at the line of the Located, so it'd make sense if it failed for unindented lines.</p>
<p>I think end result will be the same regardless (this should never hit an unindented class method, so it should never be None), but unwrap_or_default feels like it'll read better anyways. Let me make that change real fast.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/aacunningham">@aacunningham</a> reviewed on 2023-05-03 15:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/aacunningham">@aacunningham</a> on <code>crates/ruff/src/rules/flake8_bugbear/snapshots/ruff__rules__flake8_bugbear__tests__B027_B027.py.snap</code>:20 on 2023-05-04 04:06</div>
            <div class="timeline-body"><p>Donezo, lemme know if that test is what we're thinking.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/aacunningham">@aacunningham</a> reviewed on 2023-05-04 04:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/aacunningham">@aacunningham</a> on <code>crates/ruff/src/rules/flake8_bugbear/rules/abstract_base_class.rs</code>:80 on 2023-05-04 04:07</div>
            <div class="timeline-body"><p>Updated, looks good!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/aacunningham">@aacunningham</a> reviewed on 2023-05-04 04:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-04 06:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_bugbear/snapshots/ruff__rules__flake8_bugbear__tests__B027_B027.py.snap</code>:20 on 2023-05-04 06:53</div>
            <div class="timeline-body"><p>It is, thank you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-04 16:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_bugbear/rules/abstract_base_class.rs</code>:80 on 2023-05-04 16:32</div>
            <div class="timeline-body"><p>I think the <code>ok_or</code> version might actually be more appropriate, since if <code>indentation</code> returns <code>None</code>, it means there's non-whitespace content before the <code>stmt</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">autofix</span> added by @charliermarsh on 2023-05-04 16:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-05-04 16:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-05-04 16:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/aacunningham">@aacunningham</a> on 2023-05-04 16:44</div>
            <div class="timeline-body"><p>Thanks for the feedback and updates! :100:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-04 16:49</div>
            <div class="timeline-body"><p>Thanks for the contribution!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-05-07 04:59</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:57:13 UTC
    </footer>
</body>
</html>
