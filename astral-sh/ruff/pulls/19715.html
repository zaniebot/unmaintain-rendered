<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add testing helper to compare stable vs preview snapshots - astral-sh/ruff #19715</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add testing helper to compare stable vs preview snapshots</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19715">#19715</a>
        opened by <a href="https://github.com/vivster7">@vivster7</a>
        on 2025-08-03 22:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/vivster7">@vivster7</a></div>
            <div class="timeline-body">

Summary
<p>This PR implements a diff test helper <code>assert_diagnostics_diff</code> as described in #19351. The diff file includes both the settings ( e.g. <code>+linter.preview = enabled</code>) and the snapshot data itself.</p>
<p>The current implementation looks for each old diagnostic in the new snapshot. This works when the preview behavior adds/removes a couple diagnostics. This implementation does not work well when every diagnostic is modified (e.g. a &quot;fix&quot; is added). <a href="https://github.com/astral-sh/ruff/pull/19715">astral-sh/ruff#19715</a>#discussion_r2259410763 has ideas for future improvements to this implementation.</p>
<p>The example usage in this PR writes the diff to <code>preview_diff</code> file instead of <code>preview</code> file, which might be a useful convention to keep.</p>
Test Plan
<ul>
<li>Included a unit test at: <a href="https://github.com/astral-sh/ruff/pull/19715">astral-sh/ruff#19715</a>/files#diff-d49487fe3e8a8585529f62c2df2a2b0a4c44267a1f93d1e859dff1d9f8771d36R523</li>
<li>Example usage of this new test helper: <a href="https://github.com/astral-sh/ruff/pull/19715">astral-sh/ruff#19715</a>/files#diff-2a33ac11146d1794c01a29549a6041d3af6fb6f9b423a31ade12a88d1951b0c2R1</li>
</ul>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/vivster7">@vivster7</a> reviewed on 2025-08-03 22:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/vivster7">@vivster7</a> on <code>crates/ruff_linter/src/test.rs</code>:64 on 2025-08-03 22:27</div>
            <div class="timeline-body"><p>I wanted to try and include a list of the settings that differed between before/after -- but couldn&#x27;t quite figure out a good way to only include the differences. Printing out all the settings was too verbose.</p>
<p>For now, assuming the name of the snapshot file <code>preview_diff__</code> might be enough to indicate what the difference in settings are.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/vivster7">@vivster7</a> on 2025-08-03 23:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dylwil3">@dylwil3</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-08-04 05:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/test.rs</code>:45 on 2025-08-04 13:41</div>
            <div class="timeline-body"><p>Do we need to keep track of this? I think we probably only want to display added/removed to the user. (One of the points of this helper is to reduce the size of some of our testing snapshots that we have to maintain)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/test.rs</code>:53 on 2025-08-04 13:42</div>
            <div class="timeline-body"><p>See previous comment</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/test.rs</code>:77 on 2025-08-04 13:51</div>
            <div class="timeline-body"><p>I wonder if a more naive algorithm would avoid some allocations at the cost of maybe more iterations - especially since we only care about added/removed. Something like:</p>
<pre><code>    let mut removed = Vec::new();

    for old_diag in before {
        let Some(pos) = after.iter().position(|diag| diag == &amp;old_diag) else {
            removed.push(old_diag);
            continue;
        };
        after.remove(pos);
    }

    Ok(DiagnosticsDiff {
        added: after,
        removed,
    })
</code></pre>
<p>(I haven&#x27;t verified this, but under the assumption that the diagnostics are roughly in order then most of the successful searches should be quick - and most of the time most of the diagnostics will be unchanged).</p>
<p>Of course another option is to use the functionality from the crate <code>similar</code> for diffing sequences. Probably all three will be fine, but maybe it&#x27;s worth a quick benchmark on a large snapshot file to see if it makes a difference.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/test.rs</code>:64 on 2025-08-04 13:56</div>
            <div class="timeline-body"><p>Have you tried something like displaying the text diff of the (pretty) debug printed settings?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> requested changes on 2025-08-04 14:01</div>
            <div class="timeline-body"><p>Thanks this looks great! A few suggestions for improvement. Also, could you include in the PR the use of this helper in a few existing snapshots? It would be helpful to see what effect it has on the size and readability/maintainability of the snapshots. Let me know if you want me to hunt for a good example.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-04 14:14</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/vivster7">@vivster7</a> on 2025-08-06 06:09</div>
            <div class="timeline-body"><p>Thanks for the feedback! Will get this back up for review again tomorrow</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-08-06 06:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/vivster7">@vivster7</a> reviewed on 2025-08-07 06:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/vivster7">@vivster7</a> on <code>crates/ruff_linter/src/test.rs</code>:77 on 2025-08-07 06:47</div>
            <div class="timeline-body"><p>I wasn&#x27;t totally sure how to benchmark this -- but running the test with either implementation runs in 0.03s, so I think more or less they are both performant enough. Happy to go with the simpler approach here.</p>
<pre><code>(ruff) ➜  ruff git:(feature/test-snapshot-diff) cargo test --package ruff_linter --lib -- rules::flake8_commas::tests::preview_rules
    Finished `test` profile [unoptimized + debuginfo] target(s) in 0.12s
     Running unittests src/lib.rs (target/debug/deps/ruff_linter-7958dd100e6e3896)

running 2 tests
test rules::flake8_commas::tests::preview_rules::path_new_com81_py_expects ... ok
test rules::flake8_commas::tests::preview_rules::path_new_com81_syntax_error_py_expects ... ok

test result: ok. 2 passed; 0 failed; 0 ignored; 0 measured; 2478 filtered out; finished in 0.03s
</code></pre>
<p>I did try to implement a third approach with <code>similar::capture_diff_slices</code> but <code>Diagnostics</code> doesn&#x27;t implement <code>std::cmp::Ord</code>.  We could maybe implement <code>std::cmp::Ord</code> based on <code>diagnostic.expect_range().start()</code>, but wasn&#x27;t confident enough to go down that route.</p>
<p>We could also serialize all the Diagnostics to Text and run <code>similar::TextDiff</code> -- see more on this idea at: <a href="https://github.com/astral-sh/ruff/pull/19715">astral-sh/ruff#19715</a>#discussion_r2259260904</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/vivster7">@vivster7</a> reviewed on 2025-08-07 06:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/vivster7">@vivster7</a> on <code>crates/ruff_linter/src/test.rs</code>:64 on 2025-08-07 06:47</div>
            <div class="timeline-body"><p>Ah, great idea! I think it works quite well: <a href="https://github.com/astral-sh/ruff/pull/19715">astral-sh/ruff#19715</a>/files#diff-2a33ac11146d1794c01a29549a6041d3af6fb6f9b423a31ade12a88d1951b0c2R4-R6</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/vivster7">@vivster7</a> reviewed on 2025-08-07 06:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/vivster7">@vivster7</a> on <code>crates/ruff_linter/src/rules/flake8_commas/snapshots/ruff_linter__rules__flake8_commas__tests__preview_diff__COM81.py.snap</code>:1 on 2025-08-07 06:49</div>
            <div class="timeline-body"><p>this file replaces crates/ruff_linter/src/rules/flake8_commas/snapshots/ruff_linter__rules__flake8_commas__tests__preview__COM81.py.snap and works quite well. replaces 1000 line snapshot with 130 lines. I think it&#x27;s much clearer what the preview rule is doing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/vivster7">@vivster7</a> on <code>crates/ruff_linter/src/rules/perflint/snapshots/ruff_linter__rules__perflint__tests__preview_diff__PERF401_PERF401.py.snap</code>:1 on 2025-08-07 06:51</div>
            <div class="timeline-body"><p>This snapshot did not work well and I didn&#x27;t delete the corresponding preview snapshot file. This might be a case where doing just a text diff would work better? Or maybe <code>assert_diagnostics_diff</code> is only useful for some preview snapshots, but not all of them?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/vivster7">@vivster7</a> reviewed on 2025-08-07 06:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dylwil3">@dylwil3</a> by <a href="https://github.com/vivster7">@vivster7</a> on 2025-08-07 06:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-07 07:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/perflint/snapshots/ruff_linter__rules__perflint__tests__preview_diff__PERF401_PERF401.py.snap</code>:1 on 2025-08-07 07:37</div>
            <div class="timeline-body"><p>If I understand it correctly, the difference here is only due to the rule having a fix in preview.</p>
<p>I&#x27;m not suggesting that we have to do this as part of this PR (but we can). The test utility could try to match up diagnostics by rule code, line, and column number. If they&#x27;re identical, put them into a <code>changed</code> section.</p>
<p>That raises the question of how we render changed diagnostics. A simple diffing of the output is probably the easiest to start. I suspect that reviewing the fixes might be a bit confusing because it becomes a diff of a diff.</p>
<p>We could try to be clever and try to determine for each matched diagnostic pair:</p>
<ul>
<li>Is it a new fix (if so, render the new fix with a comment saying that this is the case)</li>
<li>Was a fix removed</li>
<li>Did the fix change: Render both fixes separately</li>
<li>Did any other part of the diagnostic change</li>
</ul>
<p>The challenge here is that you also have to deal with combinations.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> requested changes on 2025-08-11 03:53</div>
            <div class="timeline-body"><p>Thanks this looks excellent! It&#x27;s up to you whether you&#x27;d like to implement Micha&#x27;s suggested improvements as part of this PR - I think what you have is already a big improvement in many cases.</p>
<p>I&#x27;m happy to approve once the merge conflicts are resolved.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/vivster7">@vivster7</a> on 2025-08-16 07:28</div>
            <div class="timeline-body"><p>I’ve spent some time thinking of ways to address Micha’s feedback, but I don’t have something concrete yet.</p>
<p>If this is useful in its current form, I’d be happy to get it merged as well.</p>
<p>Sorry for the slow turnaround, I’m out of town for a bit, but will have conflicts resolved on Sunday.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dylwil3">@dylwil3</a> by <a href="https://github.com/vivster7">@vivster7</a> on 2025-08-20 03:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> approved on 2025-08-22 17:49</div>
            <div class="timeline-body"><p>Thanks for your work on this, looks great!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-08-22 17:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-08-22 17:49</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:17:18 UTC
    </footer>
</body>
</html>
