<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enable `pycodestyle` rules under new &quot;nursery&quot; category - astral-sh/ruff #4407</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Enable <code>pycodestyle</code> rules under new &quot;nursery&quot; category</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4407">#4407</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-05-12 23:24
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>This PR introduces a &quot;nursery&quot; category, following Clippy&#x27;s convention, for rules that are under development, but that users can opt into explicitly.</p>
<p>In our case, if a rule is part of <code>RuleGroup::Nursery</code>, then it can&#x27;t be selected via any of the prefix selectors (e.g., <code>--select E</code> doesn&#x27;t enable <code>E225</code>, but <code>--select E225</code> <em>does</em>).</p>
<p>I&#x27;m not very happy with the implementation, but our current approach using proc macros makes this hard to do elegantly, in my opinion. The challenge is that we need access to the <code>RuleGroup</code> from within the proc macro (<code>crates/ruff_macros/src/map_codes.rs</code>), because we need to avoid adding any nursery rules to the statically-generated prefix selectors; but in that proc macro, we only have access to syntactic <code>Path</code> data, and not the structs themselves, so we end up with some brittle string matching.</p>
<p>Closes #4360.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-05-12 23:58</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>✅ ecosystem check detected no changes.</p>
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.05     15.6±0.02ms     2.6 MB/sec    1.00     14.9±0.04ms     2.7 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.04      3.8±0.00ms     4.4 MB/sec    1.00      3.7±0.00ms     4.5 MB/sec
linter/all-rules/numpy/globals.py          1.06    395.4±1.35µs     7.5 MB/sec    1.00    374.3±0.89µs     7.9 MB/sec
linter/all-rules/pydantic/types.py         1.05      6.6±0.01ms     3.9 MB/sec    1.00      6.3±0.03ms     4.1 MB/sec
linter/default-rules/large/dataset.py      1.07      8.0±0.01ms     5.1 MB/sec    1.00      7.5±0.01ms     5.5 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.10   1728.9±5.72µs     9.6 MB/sec    1.00   1565.1±6.71µs    10.6 MB/sec
linter/default-rules/numpy/globals.py      1.08    182.0±0.52µs    16.2 MB/sec    1.00    169.1±2.53µs    17.5 MB/sec
linter/default-rules/pydantic/types.py     1.08      3.6±0.00ms     7.0 MB/sec    1.00      3.4±0.01ms     7.6 MB/sec
parser/large/dataset.py                    1.00      5.9±0.01ms     6.9 MB/sec    1.00      5.9±0.01ms     6.9 MB/sec
parser/numpy/ctypeslib.py                  1.00   1152.8±1.01µs    14.4 MB/sec    1.01   1159.8±1.86µs    14.4 MB/sec
parser/numpy/globals.py                    1.00    119.6±0.92µs    24.7 MB/sec    1.00    119.6±0.27µs    24.7 MB/sec
parser/pydantic/types.py                   1.00      2.5±0.01ms    10.2 MB/sec    1.00      2.5±0.00ms    10.2 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.01     23.1±1.28ms  1807.3 KB/sec    1.00     22.7±0.66ms  1834.3 KB/sec
linter/all-rules/numpy/ctypeslib.py        1.03      5.9±0.26ms     2.8 MB/sec    1.00      5.8±0.23ms     2.9 MB/sec
linter/all-rules/numpy/globals.py          1.00   693.7±58.18µs     4.3 MB/sec    1.00   695.3±36.64µs     4.2 MB/sec
linter/all-rules/pydantic/types.py         1.02      9.7±0.37ms     2.6 MB/sec    1.00      9.6±0.24ms     2.7 MB/sec
linter/default-rules/large/dataset.py      1.03     11.8±0.41ms     3.5 MB/sec    1.00     11.4±0.39ms     3.6 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.06      2.5±0.09ms     6.7 MB/sec    1.00      2.4±0.11ms     7.1 MB/sec
linter/default-rules/numpy/globals.py      1.03   295.9±13.63µs    10.0 MB/sec    1.00   286.3±18.19µs    10.3 MB/sec
linter/default-rules/pydantic/types.py     1.08      5.4±0.26ms     4.7 MB/sec    1.00      5.0±0.21ms     5.1 MB/sec
parser/large/dataset.py                    1.00      9.4±0.45ms     4.3 MB/sec    1.00      9.4±0.61ms     4.3 MB/sec
parser/numpy/ctypeslib.py                  1.00  1719.1±93.10µs     9.7 MB/sec    1.01  1740.5±64.16µs     9.6 MB/sec
parser/numpy/globals.py                    1.00   171.9±10.55µs    17.2 MB/sec    1.05    180.2±8.90µs    16.4 MB/sec
parser/pydantic/types.py                   1.00      3.7±0.12ms     6.9 MB/sec    1.04      3.8±0.13ms     6.6 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-05-13 12:35</div>
            <div class="timeline-body"><p>Does this implementation exclude the nursery rules from <code>--ALL</code> selector?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/codes.rs</code>:45 on 2023-05-13 12:37</div>
            <div class="timeline-body"><p>From a conceptual point. How is a <code>RuleGroup</code> different from the &quot;Linter&quot; (?) Group?</p>
<p>E.g. <code>Pycodestyle</code> vs <code>Unspecified</code>. Could <code>Nursery</code> be another variant in the linter group?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-13 12:37</div>
            <div class="timeline-body"><p>Yeah -- those are the changes in <code>crates/ruff/src/rule_selector.rs</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rule_selector.rs</code>:157 on 2023-05-13 12:38</div>
            <div class="timeline-body"><p>Does this work?</p>
<pre><code>                RuleSelectorIter::All(Rule::into_iter().filter(select_all))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_macros/src/map_codes.rs</code>:28 on 2023-05-13 12:41</div>
            <div class="timeline-body"><p>I agree with clippy ;)</p>
<p>Can we define a struct for the value of the inner <code>BTreeMap</code>? Or a struct that hides the details of the outer <code>BTreeMap</code> value?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-05-13 12:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_macros/src/map_codes.rs</code>:28 on 2023-05-13 12:53</div>
            <div class="timeline-body"><p>Me too, but this whole thing should be refactored, in my opinion. I&#x27;ll correct this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-13 12:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-13 12:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/codes.rs</code>:45 on 2023-05-13 12:57</div>
            <div class="timeline-body"><p>I can try it. My initial thinking was that it wouldn&#x27;t be possible. The Linter encodes a prefix, so if you look at the bugbear rules as an example, they&#x27;re defined like:</p>
<pre><code>(Flake8Bugbear, &quot;002&quot;) =&gt; Rule::UnaryPrefixIncrement,
</code></pre>
<p>This rule is selectable as <code>B002</code>, despite <code>B</code> not appearing in the definition, because <code>B</code> is associated with <code>Flake8Bugbear</code> rather than the rule. So on the surface, there&#x27;d be no way to use a <code>Nursery</code> group and associate rules with (e.g.) <code>E225</code>.</p>
<p>However, maybe it does work somehow? Pycodestyle is associated with two prefixes:</p>
<pre><code>#[prefix = &quot;E&quot;]
#[prefix = &quot;W&quot;]
Pycodestyle,
</code></pre>
<p>I don&#x27;t really know how that works. I&#x27;ll look into it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-13 12:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/codes.rs</code>:45 on 2023-05-13 12:58</div>
            <div class="timeline-body"><p>Mmm, thinking on it more, there are other benefits to keeping these as separate concepts. For example, with the current setup, these rules will appear under the Pycodestyle section in the docs, which I think is good?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-13 12:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/codes.rs</code>:45 on 2023-05-13 12:58</div>
            <div class="timeline-body"><p>That makes sense. Don&#x27;t spend too much time on it. I now understand the reasoning behind it. Thank you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/codes.rs</code>:45 on 2023-05-13 13:02</div>
            <div class="timeline-body"><p>Do you think <code>RuleGroup</code> should instead be defined as part of the violation (ideally -- it&#x27;s actually not possible to do with the proc macro, but ideally)? Alternatively, should we nix <code>RuleGroup</code> and <em>just</em> do a nursery-oriented design for now?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-13 13:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-13 13:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/codes.rs</code>:45 on 2023-05-13 13:10</div>
            <div class="timeline-body"><p>I&#x27;m not very familiar with our setup yet. I would find it ideal if there&#x27;s a single place where I have to look for and define metadata for a rule. Whether this is on the rule or in the violation seems less important to me.</p>
<p>Can you explain what you mean by a nursery-oriented design?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-13 13:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/codes.rs</code>:45 on 2023-05-13 13:17</div>
            <div class="timeline-body"><p>By “nursery-oriented design”, I mean an approach that models the data as “nursery or not” (eg it could be a Boolean) rather than as a generic “rule group” concept and enumeration.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-15 07:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/codes.rs</code>:45 on 2023-05-15 07:50</div>
            <div class="timeline-body"><p>I don&#x27;t think I have a preference. A <code>bool</code> <code>RuleGroup</code> seems very similar to a two-variant enum <code>RuleGroup</code> to me. Let&#x27;s not overthink this now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-16 20:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rule_selector.rs</code>:157 on 2023-05-16 20:50</div>
            <div class="timeline-body"><p>Unfortunately not :/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-16 21:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-16 21:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-05-16 21:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:53:40 UTC
    </footer>
</body>
</html>
