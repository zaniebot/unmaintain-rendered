<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add dangling comment handling for `lambda` expressions - astral-sh/ruff #7493</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add dangling comment handling for <code>lambda</code> expressions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7493">#7493</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-09-18 15:17
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR adds dangling comment handling for <code>lambda</code> expressions. In short, comments around the <code>lambda</code> and the <code>:</code> are all considered dangling. Comments that come between the <code>lambda</code> and the <code>:</code> may be moved after the colon for simplicity (this is an odd position for a comment anyway), unless they also precede the lambda parameters, in which case they're formatted before the parameters.</p>
<p>Closes https://github.com/astral-sh/ruff/issues/7470.</p>
<h2>Test Plan</h2>
<p><code>cargo test</code></p>
<p>No change in similarity.</p>
<p>Before:</p>
<p>| project      | similarity index  | total files       | changed files     |
|--------------|------------------:|------------------:|------------------:|
| cpython      |           0.76083 |              1789 |              1632 |
| django       |           0.99982 |              2760 |                37 |
| transformers |           0.99957 |              2587 |               398 |
| twine        |           1.00000 |                33 |                 0 |
| typeshed     |           0.99983 |              3496 |                18 |
| warehouse    |           0.99929 |               648 |                16 |
| zulip        |           0.99962 |              1437 |                22 |</p>
<p>After:</p>
<p>| project      | similarity index  | total files       | changed files     |
|--------------|------------------:|------------------:|------------------:|
| cpython      |           0.76083 |              1789 |              1632 |
| django       |           0.99982 |              2760 |                37 |
| transformers |           0.99957 |              2587 |               398 |
| twine        |           1.00000 |                33 |                 0 |
| typeshed     |           0.99983 |              3496 |                18 |
| warehouse    |           0.99929 |               648 |                16 |
| zulip        |           0.99962 |              1437 |                22 |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @charliermarsh on 2023-09-18 15:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2023-09-18 15:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-09-18 15:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @charliermarsh on 2023-09-18 15:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @charliermarsh on 2023-09-18 17:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-18 19:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:1636 on 2023-09-18 19:37</div>
            <div class="timeline-body"><p>What's the reason for making all comments dangling vs forcing line breaks when formatting the lambda if the argument e.g. has leading comments?</p>
<p>I generally try to avoid using dangling comments and instead attach comments to nodes. It tends to work better, especially if we ever want to support node-level suppression comments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-18 19:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:1666 on 2023-09-18 19:38</div>
            <div class="timeline-body"><p>Can we consider own line comments as leading comments?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-18 19:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:1678 on 2023-09-18 19:39</div>
            <div class="timeline-body"><p>Same here, what about own line comments? Could they be leading comments of the body</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:1666 on 2023-09-18 19:47</div>
            <div class="timeline-body"><p>How would that work for this case?</p>
<pre><code class="language-python">(
  lambda  # 1
  # 2
  : # 3
  # 4
  x
)
</code></pre>
<p>We could make <code># 4</code> a leading comment, but I don't think any of the others can be treated as such.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-18 19:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-18 19:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:1636 on 2023-09-18 19:51</div>
            <div class="timeline-body"><p>Are you suggesting that <code># 1</code> here should be a leading comment? Would you expect it to be moved to an own-line comment, or rendered as-is in this snippet?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-18 20:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:1678 on 2023-09-18 20:04</div>
            <div class="timeline-body"><p>Yes the own-line comments could in this case. I found it simpler to have fewer cases but I can change that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-19 07:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:1636 on 2023-09-19 07:19</div>
            <div class="timeline-body"><p>we could do it similar to lists, where 1 is dangling and 2 is leading:</p>
<pre><code class="language-python">x = [  # 1
    # 2
    &quot;a&quot;,
    &quot;b&quot;,
    &quot;c&quot;,
]
</code></pre>
<pre><code>7..10, None, Some((ExprConstant, 23..26)), (ExprList, 4..47), &quot;# 1&quot;
15..18, None, Some((ExprConstant, 23..26)), (ExprList, 4..47), &quot;# 2&quot;
{
    Node {
        kind: ExprList,
        range: 4..47,
        source: `[  # 1‚èé`,
    }: {
        &quot;leading&quot;: [],
        &quot;dangling&quot;: [
            SourceComment {
                text: &quot;# 1&quot;,
                position: EndOfLine,
                formatted: true,
            },
        ],
        &quot;trailing&quot;: [],
    },
    Node {
        kind: ExprConstant,
        range: 23..26,
        source: `&quot;a&quot;`,
    }: {
        &quot;leading&quot;: [
            SourceComment {
                text: &quot;# 2&quot;,
                position: OwnLine,
                formatted: true,
            },
        ],
        &quot;dangling&quot;: [],
        &quot;trailing&quot;: [],
    },
}
x = [  # 1
    # 2
    &quot;a&quot;,
    &quot;b&quot;,
    &quot;c&quot;,
]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-09-19 07:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-19 19:23</div>
            <div class="timeline-body"><p>Okay, I played with this one too and I think the current solution is simpler than trying to make some of these leading comments. Part of the issue is that if we make any of these leading or trailing comments, it's hard to disambiguate between these cases:</p>
<pre><code class="language-python">(
    lambda:
    # comment
    x
)

(
    lambda:  (
        # comment
        x
    )
)
</code></pre>
<p>It's not <em>impossible</em>, but it requires more special-casing in placement, and then (more importantly) the <code>lambda</code> formatter becomes more complicated, since the logic for inserting a hard line break after the <code>:</code> has to take into account whether the body has leading own-line comments within or outside of parentheses.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-09-19 19:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-09-19 19:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-09-19 19:23</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:00:21 UTC
    </footer>
</body>
</html>
