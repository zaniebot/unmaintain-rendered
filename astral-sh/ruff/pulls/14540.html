<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] remove wrong typevar attribute implementations - astral-sh/ruff #14540</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] remove wrong typevar attribute implementations</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14540">#14540</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2024-11-22 20:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body">Summary
<p>In #14182 I added &quot;precise&quot; per-TypeVar type inference for attributes of a typevar (<code>__bound__</code>, <code>__constraints__</code>, <code>__default__</code>). This wasn&#x27;t motivated so much by the real-world need for this precise inference, as it was by wanting to test the correctness of our internal representation of the typevar, via an mdtest.</p>
<p>The implementation I added was unfortunately just wrong. The problem is that our internal representation cares about the bound/constraints/default inferred as a type expression, while the runtime attributes of the <code>TypeVar</code> object will return it as a value expression.</p>
<p>In the simplest case, this means that for a typevar <code>[T: A]</code>, while we might store the bound as the Instance type <code>A</code>, the value of the <code>__bound__</code> attribute should be typed as <code>type[A]</code>.</p>
<p>Beguiled by the simple case, I slapped on a <code>.to_meta_type()</code> and called it a day. But this is just wrong in more complex cases; the meta-type is not always the same thing as the &quot;type form&quot; type. For example, the meta-type of <code>A | B</code> is <code>type[A] | type[B]</code>, but the type-form type in this case would be an instance of <code>types.UnionType</code>.</p>
<p>In a future world with PEP 747 (<code>TypeForm</code>), where we have a typevar with a bound of <code>A | B</code> it would be correct for us to infer its <code>__bound__</code> attribute as <code>TypeForm[A | B]</code>, offering a nicer solution to this problem.</p>
<p>In the meantime, I think we should just follow the lead of other type checkers in falling back to the general typeshed types for these attributes, and I should bite the bullet and write a Rust test instead of an mdtest when I want to test internal representations of types that don&#x27;t (yet, since we haven&#x27;t implemented generics) have a visible effect in the type system.</p>
Test Plan
<p>Re-wrote an mdtest as a Rust test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/carljm">@carljm</a> on 2024-11-22 20:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/carljm">@carljm</a> on 2024-11-22 20:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/carljm">@carljm</a> on 2024-11-22 20:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/carljm">@carljm</a> on 2024-11-22 20:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-22 20:37</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-11-22 21:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/carljm">@carljm</a> on 2024-11-22 21:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2024-11-22 21:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-22 21:17</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:08:45 UTC
    </footer>
</body>
</html>
