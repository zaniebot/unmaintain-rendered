<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Make' Type::in_type_expression()' exhaustive for Type::KnownInstance - astral-sh/ruff #16836</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Make&#x27; Type::in_type_expression()&#x27; exhaustive for Type::KnownInstance</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16836">#16836</a>
        opened by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a>
        on 2025-03-18 18:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a></div>
            <div class="timeline-body">

Summary
<p>fixes #15048
We want to handle more types from Type::KnownInstance</p>
Test Plan
<p>Add tests for each type added explicitly in the match</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-03-18 18:17</div>
            <div class="timeline-body"><p>@AlexWaygood what do you think of this to start?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-18 18:22</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:3272 on 2025-03-18 22:35</div>
            <div class="timeline-body"><p><code>Protocol</code> doesn&#x27;t take arguments; it&#x27;s never usable directly in an annotation. It should only be inherited. So it probably needs its own <code>InvalidProtocol</code> error, it can&#x27;t fit into the general case of <code>InvalidBareType</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/protocols.md</code>:22 on 2025-03-18 22:39</div>
            <div class="timeline-body"><p>This error message should just say &quot;<code>typing.Protocol</code>&quot; cannot be used in a type expression&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-03-18 22:39</div>
            <div class="timeline-body"><p>This looks pretty good! Just <code>Protocol</code> needs attention.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:3567 on 2025-03-18 22:42</div>
            <div class="timeline-body"><p>I would call this <code>BareSpecialForm</code> instead. We don&#x27;t need the <code>Invalid</code> prefix here (neither of the other variants have it), and <code>SpecialForm</code> more precisely describes the category of thing we are dealing with here than <code>Type</code> does.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-03-18 22:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:3272 on 2025-03-18 22:50</div>
            <div class="timeline-body"><p>Sorry yeah I should&#x27;ve caught that</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-03-18 22:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-03-18 22:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:3567 on 2025-03-18 22:52</div>
            <div class="timeline-body"><p>I did it to match the InvalidType enum lower down. I can change it to that though</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-03-18 23:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/annotations/optional.md</code>:54 on 2025-03-18 23:05</div>
            <div class="timeline-body"><p>This should say &quot;exactly one argument&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-03-19 00:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_python_semantic/resources/mdtest/annotations/optional.md</code>:54 on 2025-03-19 00:14</div>
            <div class="timeline-body"><p>Should i create different enum types for different classes of errors here, like</p>
<ul>
<li>Exactly one argument</li>
<li>At least one argument</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-03-19 00:23</div>
            <div class="timeline-body"><p>I&#x27;m not fully sure about the names BareSpecialFormAtLeastOne and BareSpecialFormExactlyOne, @AlexWaygood @carljm  what do you think?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-03-19 00:37</div>
            <div class="timeline-body"><p>The split you&#x27;ve made looks good. I think the names you&#x27;ve chosen are clear and I wouldn&#x27;t argue with them, but it would probably also be ok to be a bit less verbose and go with <code>RequiresOneArgument</code> and <code>RequiresArguments</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-03-19 00:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-03-19 00:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-03-19 00:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-03-19 00:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-03-19 00:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/resources/mdtest/annotations/callable.md</code>:213 on 2025-03-19 05:10</div>
            <div class="timeline-body"><p>I think this should still be present as there are references to it in the document.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-19 05:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-03-19 05:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_api.md</code>:452 on 2025-03-19 05:14</div>
            <div class="timeline-body"><p>I think it might make sense to include these in their respective section as they already contains some invalid form:</p>
<ul>
<li><code>TypeOf</code>: https://github.com/MatthewMckee4/ruff/blob/make-in-type-expression-exhaustive/crates/red_knot_python_semantic/resources/mdtest/type_api.md#typeof</li>
<li><code>CallableTypeFromFunction</code>: https://github.com/MatthewMckee4/ruff/blob/make-in-type-expression-exhaustive/crates/red_knot_python_semantic/resources/mdtest/type_api.md#callabletypefromfunction</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/resources/mdtest/intersection_types.md</code>:865 on 2025-03-19 05:16</div>
            <div class="timeline-body"><p>I&#x27;d suggest to avoid breaking them up unless you need to add some prose in between the two code snippets.</p>
<pre><code>## Invalid

```py
from knot_extensions import Intersection, Not

# error: [invalid-type-form] &quot;`knot_extensions.Intersection` requires at least one argument when used in a type expression&quot;
def f(x: Intersection) -&gt; None:
    reveal_type(x)  # revealed: Unknown


# error: [invalid-type-form] &quot;`knot_extensions.Not` requires exactly one argument when used in a type expression&quot;
def f(x: Not) -&gt; None:
    reveal_type(x)  # revealed: Unknown
</code></pre>
<pre><code></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-03-19 05:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dhruvmanila">@dhruvmanila</a> by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-03-19 11:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:3583 on 2025-03-19 14:35</div>
            <div class="timeline-body"><p>Personally I feel like the <code>InTypeExpression</code> part of this is redundant with the enum name <code>InvalidTypeExpression</code>; I would just name this variant <code>Protocol</code>. But I see there is already precedent with <code>ClassVarInTypeExpression</code> and <code>FinalInTypeExpression</code>, so I&#x27;ll go ahead and merge it this way for consistency.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-03-19 14:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-03-19 14:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-03-19 14:36</div>
            <div class="timeline-body"><p>Thank you for the PR!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/carljm">@carljm</a> on 2025-03-19 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2025-03-19 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-03-19 14:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:3307 on 2025-03-19 14:36</div>
            <div class="timeline-body"><p>I think the only two of these that are valid in type expressions when they are not parameterized are <code>TypingSelf</code> and <code>TypeAlias</code>:</p>
<ul>
<li><code>ReadOnly</code>, <code>NotRequired</code>, <code>TypeIs</code>, <code>TypeGuard</code>, <code>Unpack</code> and <code>Required</code> all require exactly one argument</li>
<li><code>Concatenate</code> requires at least two arguments</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-03-19 14:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:3307 on 2025-03-19 14:37</div>
            <div class="timeline-body"><p><code>ReadOnly</code>, <code>NotRequired</code> and <code>Required</code> are also type qualifiers, so they are only valid in annotation expressions, not type expressions, even when they do have the necessary number of arguments</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-03-19 14:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:3307 on 2025-03-19 14:39</div>
            <div class="timeline-body"><p>arent ReadOnly, NotRequired, TypeIs, TypeGuard, Unpack and Required only allowed in certain places though? Like how ClassVar and Final are invalid here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-03-19 14:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:3307 on 2025-03-19 14:46</div>
            <div class="timeline-body"><p>That&#x27;s correct. But the <code>KnownInstance</code> branches of this method are essentially asking the question, &quot;Is this symbol valid in a type expression if it appears without any type arguments?&quot;. And the answer is definitely &quot;no&quot; for all of <code>ReadOnly</code>, <code>NotRequired</code>, <code>TypeIs</code>, <code>TypeGuard</code>, <code>Unpack</code> and <code>Required</code>. It&#x27;s true that these symbols wouldn&#x27;t even be allowed in a <em>all</em> type expressions even if they <em>did</em> have the correct number of type arguments. But that&#x27;s not the question that this method is asking ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-03-19 14:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:3307 on 2025-03-19 14:58</div>
            <div class="timeline-body"><p>In terms of the exact error messages we should emit, I think probably:</p>
<ul>
<li><code>ReadOnly</code>, <code>NotRequired</code>, <code>Required</code> =&gt; <code>&quot;Type qualifier `{}` is not allowed in type expressions (only in annotation expressions, and only with exactly one argument)&quot;</code></li>
<li><code>TypeIs</code>, <code>TypeGuard</code>, <code>Unpack</code> =&gt; <code>&quot;`{}` requires exactly one argument when used in a type expression&quot;</code><ul>
<li>you could reuse your existing <code>InvalidTypeExpression::RequiresOneArgument</code> variant for these</li>
</ul>
</li>
<li><code>Concatenate</code> =&gt; <code>&quot;`{}` requires at least two arguments when used in a type expression&quot;</code><ul>
<li>you could maybe rework the <code>InvalidTypeExpression::BareAnnotated</code> variant so that it can be used to report errors for <code>Concatenate</code> as well as <code>Annotated</code></li>
</ul>
</li>
</ul>
<p>Would you be interested in filing a followup PR? :-)</p>
<p>It could also be nice to have more precise <code>todo_type!()</code> messages for the <code>TypingSelf</code> and <code>TypeAlias</code> variants: <code>todo_type!(&quot;Support for `typing.Self`&quot;)</code> and <code>todo_type!(&quot;Support for `typing.TypeAlias`&quot;)</code>, respectively</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-03-19 15:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:3307 on 2025-03-19 15:00</div>
            <div class="timeline-body"><p>Yeah ill get started on that, thanks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-03-19 15:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:3307 on 2025-03-19 15:01</div>
            <div class="timeline-body"><blockquote>
<p>ReadOnly, NotRequired, Required =&gt; &quot;Type qualifier <code>{}</code> is not allowed in type expressions (only in annotation expressions, and only with exactly one argument)&quot;</p>
</blockquote>
<p>Am i right in saying that these should be the same message as FinalInTypeExpression and ClassVarInTypeExpression?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-03-19 15:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:3307 on 2025-03-19 15:01</div>
            <div class="timeline-body"><p>Amazing, thank you! You&#x27;re doing great work :D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-03-19 15:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-03-19 15:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:3307 on 2025-03-19 15:06</div>
            <div class="timeline-body"><blockquote>
<p>Am i right in saying that these should be the same message as FinalInTypeExpression and ClassVarInTypeExpression?</p>
</blockquote>
<p>Not <em>quite</em>. <code>ClassVar</code>, <code>Final</code>, <code>Required</code>, <code>NotRequired</code> and <code>ReadOnly</code> are all type qualifiers, so they&#x27;re all valid in annotation expressions but invalid in type expressions. Nonetheless, I think it would be nice to have different error messages because of the fact that they differ in the number of arguments they accept when they appear in annotation expressions:</p>
<ul>
<li><code>Final</code> can be used both with and without type arguments in an <em>annotation</em> expression</li>
<li><code>ClassVar</code> it&#x27;s... sort-of unclear whether it&#x27;s valid without type arguments or not (see discussion at https://discuss.python.org/t/bare-classvar-annotation/81705)</li>
<li>All the rest need exactly one argument when they appear in annotation expressions</li>
</ul>
<p>So that implies that for the error messages, <code>Final</code> and <code>ClassVar</code> should have this error message:</p>
<pre><code>&quot;Type qualifier `{}` is not allowed in type expressions (only in annotation expressions)&quot;
</code></pre>
<p>But for the other three, they should have this error message:</p>
<pre><code>&quot;Type qualifier `{}` is not allowed in type expressions (only in annotation expressions, and only with exactly one argument)&quot;
</code></pre>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:12:26 UTC
    </footer>
</body>
</html>
