<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Consistent ordering of constraint set specializations, take 2 - astral-sh/ruff #21983</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Consistent ordering of constraint set specializations, take 2</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21983">#21983</a>
        opened by <a href="https://github.com/dcreager">@dcreager</a>
        on 2025-12-15 03:04
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dcreager">@dcreager</a> on 2025-12-15 03:04</div>
            <div class="timeline-body"><p>In https://github.com/astral-sh/ruff/pull/21957, we tried to use <code>union_or_intersection_elements_ordering</code> to provide a stable ordering of the union and intersection elements that are created when determining which type a typevar should specialize to. @AlexWaygood <a href="https://github.com/astral-sh/ruff/pull/21551#discussion_r2616543762">pointed out</a> that this won't work, since that provides a consistent ordering within a single process run, but does not provide a stable ordering across runs.</p>
<p>This is an attempt to produce a proper stable ordering for constraint sets, so that we end up with consistent diagnostic and test output.</p>
<p>We do this by maintaining a new <code>source_order</code> field on each interior BDD node, which records when that node's constraint was added to the set. Several of the BDD operators (<code>and</code>, <code>or</code>, etc) now have <code>_with_offset</code> variants, which update each <code>source_order</code> in the rhs to be larger than any of the <code>source_order</code>s in the lhs. This is what causes that field to be in line with (a) when you add each constraint to the set, and (b) the order of the parameters you provide to <code>and</code>, <code>or</code>, etc. Then we sort by that new field before constructing the union/intersection types when creating a specialization.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @dcreager on 2025-12-15 03:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-15 03:06</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-15 03:08</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">pandas-stubs (https://github.com/pandas-dev/pandas-stubs)
+ pandas-stubs/_typing.pyi:1218:16: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 5123 diagnostics
+ Found 5124 diagnostics


</code></pre>
</details>

<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dcreager on 2025-12-15 15:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dcreager on 2025-12-15 15:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dcreager on 2025-12-15 15:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @dcreager on 2025-12-15 15:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @AlexWaygood on 2025-12-15 15:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-12-15 18:30</div>
            <div class="timeline-body"><p>Looks good! It's too bad how much extra work we have to do (rebuilding entire BDD subtrees) in order to preserve this ordering information, but at the moment I'm not seeing a better way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-12-15 18:47</div>
            <div class="timeline-body"><blockquote>
<p>Looks good! It's too bad how much extra work we have to do (rebuilding entire BDD subtrees) in order to preserve this ordering information, but at the moment I'm not seeing a better way.</p>
</blockquote>
<p>Hmm, that's a good thought. For expediency I'm just going to add a TODO, but I wonder if we can store the <code>other_offset</code> as another field on <code>InteriorNode</code> and apply it lazily whenever we walk a BDD tree.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dcreager on 2025-12-15 19:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dcreager on 2025-12-15 19:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-12-15 19:24</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:42:36 UTC
    </footer>
</body>
</html>
