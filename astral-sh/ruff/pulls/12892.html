<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Add definition for augmented assignment - astral-sh/ruff #12892</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Add definition for augmented assignment</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/12892">#12892</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-08-14 11:09
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body">Summary
<p>This PR adds definition for augmented assignment. This is similar to annotated assignment in terms of implementation.</p>
<p>~An augmented assignment should also record a use of the variable but that&#x27;s a TODO for now.~</p>
Test Plan
<p>Add test case to validate that a definition is added.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-14 11:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-08-14 11:24</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>âœ… ecosystem check detected no linter changes.</p>
Linter (preview)
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-16 10:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-16 10:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-16 10:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-16 10:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-08-16 11:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:783 on 2024-08-16 11:37</div>
            <div class="timeline-body"><p>I think we also need to insert the type into <code>types.expressions</code> to avoid a similar issue to what I fixed in  <a href="https://github.com/astral-sh/ruff/pull/12919">astral-sh/ruff#12919</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:783 on 2024-08-16 11:37</div>
            <div class="timeline-body"><p>ah never mind, I think that works because <code>infer_expression</code> is already called below</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-08-16 11:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:784 on 2024-08-16 11:39</div>
            <div class="timeline-body"><p>Is it intentional that we return the target type here and not the value type? Or is it guaranteed that the value and target type are always the same? Is it possible that the return type is different depending on the operator?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-08-16 11:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-08-16 11:39</div>
            <div class="timeline-body"><p>If this lands after <a href="https://github.com/astral-sh/ruff/pull/12919">astral-sh/ruff#12919</a>, then we need to add a <code>HasTy</code> implementation for <code>AugmentedAssign</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-08-16 12:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:783 on 2024-08-16 12:11</div>
            <div class="timeline-body"><p>Yes, this wouldn&#x27;t face the same issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:784 on 2024-08-16 12:18</div>
            <div class="timeline-body"><p>Not really, it requires additional logic which would be similar to a binary expression to determine the actual type. I&#x27;ll add a TODO instead and return <code>Type::Unknown</code> as is done for other nodes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-08-16 12:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:783 on 2024-08-16 13:10</div>
            <div class="timeline-body"><p>This isn&#x27;t really relevant to your PR @dhruvmanila but FWIW, I think this kind of thing is where @carljm&#x27;s approach of treating <code>Unbound</code> as a separate type falls down. If you have a module that just consists of the following, what is the type of <code>x</code> -- <code>int</code> or <code>Unbound</code>?</p>
<pre><code>x += 1
</code></pre>
<p>At runtime, this is going to fail with <code>NameError: name &#x27;x&#x27; is not defined</code>, which would imply that <code>x</code> should have <code>Type::Unbound</code> here. But in an LSP context, we surely want to infer <code>int</code> for <code>x</code>, since that&#x27;s obviously what the type of the <code>x</code> variable is <em>meant</em> to be, and it&#x27;ll give us much better results for autocompletion etc. This would be solved if we treated whether or not a variable is unbound as something that can be queried on a <code>Definition</code> (<code>x</code> would be inferred as an &quot;unbound variable with type <code>int</code>&quot; rather than a &quot;variable with type <code>Unbound</code>&quot;) rather than a separate <em>type</em> altogether.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-08-16 13:16</div>
            <div class="timeline-body"><p>LGTM.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-08-16 16:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:783 on 2024-08-16 16:19</div>
            <div class="timeline-body"><p>I think what you&#x27;re discussing here is orthogonal to representing Unbound as a type or not. In terms of the types that we use for type checking (the types we are confident in), there&#x27;s no question or issue here: if <code>x</code> was unbound before <code>x += 1</code>, its still unbound after it (or maybe we prefer switching to unknown in order to avoid more cascading errors, either way can work.) I think actually inferring a type of <code>int</code> for <code>x</code> in this case, for type checking purposes, is something we definitely don&#x27;t want to do; we don&#x27;t want to potentially issue a bunch of cascading downstream type errors because of a type that we just guessed in the face of broken code.</p>
<p>What you&#x27;re bringing up is a separate feature, which we discussed in planning this morning, which is that in some cases we may have unknown/any as the &quot;correct&quot; type, but we may also want to track a &quot;best guess&quot; type, so we can give &quot;better&quot; (well, hopefully better rather than just misleading) autocomplete etc downstream of incorrect code. That&#x27;s a feature that needs some design work and discussion, but I don&#x27;t think representing Unbound as a type makes it any more difficult to implement that feature, or really affects it at all.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-08-16 17:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:783 on 2024-08-16 17:00</div>
            <div class="timeline-body"><p>To be clear, I&#x27;m very open to considering alternate ways of handling Unbound; I think a good case can be made for other approaches. I just don&#x27;t think this situation exposes a good rationale for a different approach.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-16 17:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:783 on 2024-08-16 17:02</div>
            <div class="timeline-body"><p>I think I need to study this more and propose a concrete alternative. I think mypy&#x27;s approach to this problem is very different; but then, mypy is in general much worse at detecting unbound variables than either pyright or Ruff, so that doesn&#x27;t say much for mypy&#x27;s approach! I didn&#x27;t realise that pyright also treats <code>Unbound</code> as a distinct type to <code>Unknown</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:580 on 2024-08-16 17:05</div>
            <div class="timeline-body"><p>Is there a reason to leave this as a TODO rather than just doing it in this PR? It doesn&#x27;t seem like it should be too involved.</p>
<p>But I&#x27;m also fine with doing it as a separate follow-up PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-16 17:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:783 on 2024-08-16 17:06</div>
            <div class="timeline-body"><blockquote>
<p>think mypy&#x27;s approach to this problem is very different</p>
</blockquote>
<p>Ah, I&#x27;m wrong again! ðŸ˜„ <a href="https://github.com/python/mypy/blob/fe15ee69b9225f808f8ed735671b73c31ae1bed8/mypy/types.py#L903">https://github.com/python/mypy/blob/fe15ee69b9225f808f8ed735671b73c31ae1bed8/mypy/types.py#L903</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-08-16 17:07</div>
            <div class="timeline-body"><p>Looks good!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-08-20 04:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:580 on 2024-08-20 04:58</div>
            <div class="timeline-body"><p>Yeah, it isn&#x27;t that much involved. I&#x27;ve updated this PR to implement the TODO.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-20 05:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-20 05:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-08-20 05:03</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:06:03 UTC
    </footer>
</body>
</html>
