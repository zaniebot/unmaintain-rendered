<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pyupgrade`] Ensure we do not rename two type parameters to the same name (`UP049`) - astral-sh/ruff #16038</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pyupgrade</code>] Ensure we do not rename two type parameters to the same name (<code>UP049</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16038">#16038</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-02-08 12:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><p>Fixes #16024</p>
<h2>Summary</h2>
<p>This PR adds proper isolation for <code>UP049</code> fixes so that two type parameters are not renamed to the same name, which would introduce invalid syntax. E.g. for this:</p>
<pre><code class="language-py">class Foo[_T, __T]: ...
</code></pre>
<p>we cannot apply two autofixes to the class, as that would produce invalid syntax -- this:</p>
<pre><code class="language-py">class Foo[T, T]: ...
</code></pre>
<p>The &quot;isolation&quot; here means that Ruff won't apply more than one fix to the same type-parameter list in a single iteration of the loop it does to apply all autofixes. This means that after the first autofix has been done, the semantic model will have recalculated which variables are available in the scope, meaning that the diagnostic for the second parameter will be deemed unfixable since it collides with an existing name in the same scope (the name we autofixed the first parameter to in an earlier iteration of the autofix loop).</p>
<p>Cc. @ntBre, for interest!</p>
<h2>Test Plan</h2>
<p>I added an integration test that reproduces the bug on <code>main</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2025-02-08 12:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @AlexWaygood on 2025-02-08 12:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-02-08 12:11</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-02-08 15:40</div>
            <div class="timeline-body"><p>LGTM! And good to know about <code>isolation</code>, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-02-08 15:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-02-08 15:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-08 15:44</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:09:52 UTC
    </footer>
</body>
</html>
