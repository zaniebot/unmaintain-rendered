```yaml
number: 3906
title: "Pretty print `Diagnostic`s in snapshot tests"
type: pull_request
state: merged
author: MichaReiser
labels:
  - internal
assignees: []
merged: true
base: main
head: test-snapshots
created_at: 2023-04-07T17:34:30Z
updated_at: 2023-04-11T09:16:07Z
url: https://github.com/astral-sh/ruff/pull/3906
synced_at: 2026-01-12T15:55:14Z
```

# Pretty print `Diagnostic`s in snapshot tests

---

_@MichaReiser_

This PR extends the `TextEmitter` to print diffs for fixes (explicit opt-in) and changes the snapshot tests to use the `TextEmitter` instead of `assert_yaml_snapshot`. 

Pretty printing the diagnostics makes our linter tests more resilient to changes.  For example, changing the field ordering of `Diagnostic` or its representation no longer breaks the snapshot tests because it doesn't change the pretty printed output. 

The pretty printed output further has the advantage that it is easier to spot errors.  No more offset counting to verify that the diagnostic or edit points to the right locations. 





---

_Comment by @MichaReiser on 2023-04-07 17:34_

Current dependencies on/for this PR:
* main
  * **PR #3895** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3895" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #3896** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3896" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #3897** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3897" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #3901** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3901" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #3904** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3904" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
            * **PR #3905** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3905" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
              * **PR #3906** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3906" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/charliermarsh/ruff/3906?utm_source=stack-comment).

---

_@MichaReiser reviewed on 2023-04-07 17:45_

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/flake8_blind_except/snapshots/ruff__rules__flake8_blind_except__tests__BLE001_BLE.py.snap`:51 on 2023-04-07 17:45_

a blind exception... interesting :see_no_evil: 

---

_@charliermarsh reviewed on 2023-04-07 18:57_

---

_Review comment by @charliermarsh on `crates/ruff/src/message/diff.rs`:13 on 2023-04-07 18:57_

What do we do in production? Continue to show just the changed line?

---

_@charliermarsh reviewed on 2023-04-07 18:57_

---

_Review comment by @charliermarsh on `crates/ruff/src/message/diff.rs`:25 on 2023-04-07 18:57_

Should this be `try_from_message`? Or is `try_from_*` only used for `Result`?

---

_@charliermarsh reviewed on 2023-04-07 18:58_

---

_Review comment by @charliermarsh on `crates/ruff/src/message/diff.rs`:13 on 2023-04-07 18:58_

Oh right, sorry, in production we don't show suggested fixes at all, we only show the suggestion _message_, and highlight the relevant code.

---

_Review comment by @charliermarsh on `crates/ruff/src/message/diff.rs`:13 on 2023-04-07 18:59_

I do wonder if there's anything we can leverage from Clippy or rustc to facilitate printing diffs.

---

_@charliermarsh reviewed on 2023-04-07 18:59_

---

_@charliermarsh approved on 2023-04-07 18:59_

---

_@charliermarsh reviewed on 2023-04-07 19:01_

---

_Review comment by @charliermarsh on `crates/ruff/src/message/diff.rs`:182 on 2023-04-07 19:01_

Not sure if it was removed but we do have `num_digits` in `printer.rs`, maybe whatever was relying on that can leverage this now too.

---

_@MichaReiser reviewed on 2023-04-07 19:40_

---

_Review comment by @MichaReiser on `crates/ruff/src/message/diff.rs`:13 on 2023-04-07 19:40_

We can look into it when redoing Diagnostics. I would like to replace annotate snippet and colored. Ideally, the code frame and diff is something we build ourselves as it is an important core component of all our tools. This is something that we could inherit from Rome

---

_@MichaReiser reviewed on 2023-04-07 20:15_

---

_Review comment by @MichaReiser on `crates/ruff/src/message/diff.rs`:25 on 2023-04-07 20:15_

Not sure. `NonZeroUsize` returns `Option` from `new`. My reasoning is that it isn't failing, it's just that not all `Message`s can print a `diff`.

---

_Comment by @github-actions[bot] on 2023-04-07 20:30_

## PR Check Results
### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.01     14.3Â±0.02ms     2.9 MB/sec    1.00     14.1Â±0.03ms     2.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.6Â±0.01ms     4.7 MB/sec    1.00      3.6Â±0.00ms     4.7 MB/sec
linter/all-rules/numpy/globals.py          1.00    458.9Â±1.56Âµs     6.4 MB/sec    1.00    457.8Â±0.81Âµs     6.4 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.1Â±0.03ms     4.2 MB/sec    1.00      6.0Â±0.05ms     4.2 MB/sec
linter/default-rules/large/dataset.py      1.02      7.3Â±0.01ms     5.5 MB/sec    1.00      7.2Â±0.01ms     5.6 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01   1637.4Â±8.55Âµs    10.2 MB/sec    1.00   1623.1Â±3.21Âµs    10.3 MB/sec
linter/default-rules/numpy/globals.py      1.00    180.4Â±0.34Âµs    16.4 MB/sec    1.00    180.4Â±1.29Âµs    16.4 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.4Â±0.00ms     7.6 MB/sec    1.00      3.3Â±0.01ms     7.7 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.01     16.1Â±0.31ms     2.5 MB/sec    1.00     16.0Â±0.27ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      4.2Â±0.15ms     4.0 MB/sec    1.00      4.1Â±0.10ms     4.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    498.7Â±8.04Âµs     5.9 MB/sec    1.01   503.7Â±13.83Âµs     5.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.8Â±0.16ms     3.7 MB/sec    1.00      6.8Â±0.15ms     3.7 MB/sec
linter/default-rules/large/dataset.py      1.00      8.2Â±0.13ms     5.0 MB/sec    1.00      8.2Â±0.12ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1789.4Â±34.77Âµs     9.3 MB/sec    1.01  1815.9Â±37.32Âµs     9.2 MB/sec
linter/default-rules/numpy/globals.py      1.00    196.3Â±5.87Âµs    15.0 MB/sec    1.01    197.3Â±6.50Âµs    15.0 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.7Â±0.06ms     6.8 MB/sec    1.01      3.8Â±0.07ms     6.8 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Label `internal` added by @MichaReiser on 2023-04-11 07:57_

---

_Merged by @MichaReiser on 2023-04-11 09:03_

---

_Closed by @MichaReiser on 2023-04-11 09:03_

---

_Branch deleted on 2023-04-11 09:03_

---
