<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Fix a few more diagnostic differences from Ruff - astral-sh/ruff #19806</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Fix a few more diagnostic differences from Ruff</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19806">#19806</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-08-07 13:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes the remaining range reporting differences between the <code>ruff_db</code> diagnostic rendering and Ruff's existing rendering, as noted in https://github.com/astral-sh/ruff/pull/19415#issuecomment-3160525595.</p>
<p>This PR is structured as a series of three pairs. The first commit in each pair adds a test showing the previous behavior, followed by a fix and the updated snapshot. It's quite a small PR, but that might be helpful just for the contrast.</p>
<p>You can also look at <a href="https://github.com/astral-sh/ruff/pull/19415/files/052e656c6c1bd7586cbf97f049415d7ace08c631..c3ea51030d38d481aa10855ca1d2556e391ff4cb">this range</a> of commits from #19415 to see the impact on real Ruff diagnostics. I spun these commits out of that PR.</p>
<h2>Test Plan</h2>
<p>New <code>ruff_db</code> tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-07 13:32</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @ntBre on 2025-08-07 13:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @ntBre on 2025-08-07 13:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @ntBre on 2025-08-07 13:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @ntBre on 2025-08-07 13:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @ntBre on 2025-08-07 13:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @ntBre on 2025-08-07 13:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dcreager removed by @ntBre on 2025-08-07 13:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @ntBre on 2025-08-07 13:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @ntBre on 2025-08-07 13:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @MichaReiser on 2025-08-07 13:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by @MichaReiser on 2025-08-07 13:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_annotate_snippets/src/renderer/display_list.rs</code>:1279 on 2025-08-07 13:35</div>
            <div class="timeline-body"><p>I'd find a comment what's happening here useful :) Together with a comment that this is another upstream divergence</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Fix a few more diagnostic differences from Ruff" to "[ty] Fix a few more diagnostic differences from Ruff" by @ntBre on 2025-08-07 13:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_annotate_snippets/src/renderer/display_list.rs</code>:1288 on 2025-08-07 13:36</div>
            <div class="timeline-body"><p>Is the <code>+1</code> because the line is zero indexed or because we want to point to the next line.</p>
<p>I think it would also be okay to say <code>last_line:after_last_column</code> which would better align with how the snippet is rendered.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/diagnostic/render.rs</code>:1020 on 2025-08-07 13:41</div>
            <div class="timeline-body"><p>What I like doing here is <code>&amp;source[index + 1..].starts_width('\n')</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-08-07 13:42</div>
            <div class="timeline-body"><p>Nice!</p>
<p>My only suggestion is to use <code>last-line:last-column</code> for the eof case instead of <code>last_line+1:1</code> to more closely match the rendered snippet</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-08-07 13:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_annotate_snippets/src/renderer/display_list.rs</code>:1288 on 2025-08-07 13:53</div>
            <div class="timeline-body"><p>Yes, the +1 is to point to the next line to match Ruff's current behavior:</p>
<p>https://github.com/astral-sh/ruff/blob/c401a6d86e2102f10ae5dc933e3daf723536a6b3/crates/ruff_linter/src/rules/flake8_implicit_str_concat/snapshots/ruff_linter__rules__flake8_implicit_str_concat__tests__ISC001_ISC_syntax_error.py.snap#L173-L178</p>
<p>I agree with you that 29:2 would make sense and more closely align with the rendering, though.</p>
<p>One issue I ran into here was that (naively) computing the column breaks some other annotate-snippets tests. Maybe that's a sign that it's not the right fix.</p>
<p>I'll look at this a bit more.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_db/src/diagnostic/render.rs</code>:665 on 2025-08-07 13:54</div>
            <div class="timeline-body"><p>Very very minor, but it might be nice if we had a <code>TextSize::ZERO</code> constant or something. Using <code>default()</code> for this feels a little funny.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-08-07 13:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_annotate_snippets/src/renderer/display_list.rs</code>:1279 on 2025-08-07 13:54</div>
            <div class="timeline-body"><p>Yeah definitely makes sense to put the comment here, rather than on the test!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2025-08-07 13:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-07 14:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/diagnostic/render.rs</code>:665 on 2025-08-07 14:03</div>
            <div class="timeline-body"><p>You can do <code>TextSize::new(0)</code> but agree that <code>ZERO</code> would be nice`</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-08-07 14:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_db/src/diagnostic/render.rs</code>:665 on 2025-08-07 14:08</div>
            <div class="timeline-body"><p>Added! I think <code>ONE</code> might be helpful too, but not in this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-08-07 14:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_annotate_snippets/src/renderer/display_list.rs</code>:1288 on 2025-08-07 14:36</div>
            <div class="timeline-body"><p>I have a more robust fix working, but this will also be a mismatch from the <code>concise</code> rendering. Should I update that as well? It looks like those numbers come from our <code>LineIndex</code> code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-07 15:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_annotate_snippets/src/renderer/display_list.rs</code>:1288 on 2025-08-07 15:48</div>
            <div class="timeline-body"><p>Fixing <code>LineIndex</code> does sound reasonable if that's where the numbers are coming from. But I don't have a good sense of the blast radius. You might have to try to see what changes (Updating <code>concise</code> makes sense to me, we want the line numbers to match across formats)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_annotate_snippets/src/renderer/display_list.rs</code>:1288 on 2025-08-07 16:29</div>
            <div class="timeline-body"><p>Yeah I definitely want them to match, I was more wondering if you'd rather align on this new behavior or preserve the old behavior. I'll have to double check the other output formats too. Hopefully they all use the line index. I guess <code>full</code> is the only case where the output is noticeably questionable with the caret on a different line from what the range reports.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-08-07 16:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_annotate_snippets/src/renderer/display_list.rs</code>:1288 on 2025-08-07 16:40</div>
            <div class="timeline-body"><p>I'd prefer aligning on the new behavior. I think the existing behavior is even confusing in the context of the new newline at end of file because it suggests that there's a newline (which obviously there isn't)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-07 16:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-08-08 15:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_annotate_snippets/src/renderer/display_list.rs</code>:1288 on 2025-08-08 15:18</div>
            <div class="timeline-body"><p>For future reference, we discussed this on Discord and decided to move ahead with preserving the old behavior for now. This seems like the same, or a closely-related, issue as https://github.com/astral-sh/ruff/issues/15510, so we can follow-up on resolving the header-rendering mismatch separately. I added some notes there (https://github.com/astral-sh/ruff/issues/15510#issuecomment-3168270151) from looking into it today too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-08 15:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_annotate_snippets/src/renderer/display_list.rs</code>:1288 on 2025-08-08 15:19</div>
            <div class="timeline-body"><p>Perfect. Thank you for looking into it so carefully! Let's merge :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-08-08 15:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-08-08 15:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-08 15:31</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:14:54 UTC
    </footer>
</body>
</html>
