<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pyflakes`] Revert to stable behavior if imports for module lie in alternate branches for `F401` - astral-sh/ruff #20878</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pyflakes</code>] Revert to stable behavior if imports for module lie in alternate branches for <code>F401</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20878">#20878</a>
        opened by <a href="https://github.com/dylwil3">@dylwil3</a>
        on 2025-10-15 01:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a></div>
            <div class="timeline-body"><p>Closes #20839</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-10-15 01:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-10-15 01:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-10-15 01:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-15 01:33</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+0 -22 violations, +0 -0 fixes in 6 projects; 49 projects unchanged)</p>
<a href="https://github.com/RasaHQ/rasa">RasaHQ/rasa</a> (+0 -1 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
- <a href="https://github.com/RasaHQ/rasa/blob/b8de3b231126747ff74b2782cb25cb22d2d898d7/rasa/utils/plotting.py#L35">rasa/utils/plotting.py:35:20:</a> F401 `tkinter` imported but unused; consider using `importlib.util.find_spec` to test for availability
</pre>

</p>

<a href="https://github.com/apache/airflow">apache/airflow</a> (+0 -7 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
- <a href="https://github.com/apache/airflow/blob/3eac6805ade2e21d7ef7e4bab2abcacccc02905d/devel-common/src/tests_common/pytest_plugin.py#L2164">devel-common/src/tests_common/pytest_plugin.py:2164:16:</a> F401 `airflow.sdk._shared.logging` imported but unused; consider using `importlib.util.find_spec` to test for availability
- <a href="https://github.com/apache/airflow/blob/3eac6805ade2e21d7ef7e4bab2abcacccc02905d/devel-common/src/tests_common/pytest_plugin.py#L2167">devel-common/src/tests_common/pytest_plugin.py:2167:20:</a> F401 `airflow.sdk._shared.logging` imported but unused; consider using `importlib.util.find_spec` to test for availability
- <a href="https://github.com/apache/airflow/blob/3eac6805ade2e21d7ef7e4bab2abcacccc02905d/providers/celery/src/airflow/providers/celery/executors/celery_executor_utils.py#L120">providers/celery/src/airflow/providers/celery/executors/celery_executor_utils.py:120:16:</a> F401 [*] `airflow.jobs.local_task_job_runner` imported but unused
- <a href="https://github.com/apache/airflow/blob/3eac6805ade2e21d7ef7e4bab2abcacccc02905d/providers/celery/src/airflow/providers/celery/executors/celery_executor_utils.py#L121">providers/celery/src/airflow/providers/celery/executors/celery_executor_utils.py:121:16:</a> F401 [*] `airflow.macros` imported but unused
- <a href="https://github.com/apache/airflow/blob/3eac6805ade2e21d7ef7e4bab2abcacccc02905d/providers/celery/src/airflow/providers/celery/executors/celery_executor_utils.py#L124">providers/celery/src/airflow/providers/celery/executors/celery_executor_utils.py:124:16:</a> F401 `airflow.providers.standard.operators.bash` imported but unused; consider using `importlib.util.find_spec` to test for availability
- <a href="https://github.com/apache/airflow/blob/3eac6805ade2e21d7ef7e4bab2abcacccc02905d/providers/celery/src/airflow/providers/celery/executors/celery_executor_utils.py#L125">providers/celery/src/airflow/providers/celery/executors/celery_executor_utils.py:125:16:</a> F401 `airflow.providers.standard.operators.python` imported but unused; consider using `importlib.util.find_spec` to test for availability
- <a href="https://github.com/apache/airflow/blob/3eac6805ade2e21d7ef7e4bab2abcacccc02905d/providers/celery/src/airflow/providers/celery/executors/celery_executor_utils.py#L127">providers/celery/src/airflow/providers/celery/executors/celery_executor_utils.py:127:16:</a> F401 [*] `airflow.operators.bash` imported but unused
</pre>

</p>

<a href="https://github.com/binary-husky/gpt_academic">binary-husky/gpt_academic</a> (+0 -1 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
- <a href="https://github.com/binary-husky/gpt_academic/blob/0aa0472da44edc0a888c7f83b564c6d0d1089366/crazy_functions/Multi_Agent_Legacy.py#L57">crazy_functions/Multi_Agent_Legacy.py:57:16:</a> F401 [*] `autogen` imported but unused
</pre>

</p>

<a href="https://github.com/mlflow/mlflow">mlflow/mlflow</a> (+0 -10 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
- <a href="https://github.com/mlflow/mlflow/blob/7bbd8945a532053f7b5cecda8f8bbcc8a8d9c418/tests/utils/test_model_utils.py#L74">tests/utils/test_model_utils.py:74:20:</a> F401 [*] `dummy_module` imported but unused
- <a href="https://github.com/mlflow/mlflow/blob/7bbd8945a532053f7b5cecda8f8bbcc8a8d9c418/tests/utils/test_requirements_utils.py#L320">tests/utils/test_requirements_utils.py:320:16:</a> F401 [*] `databricks` imported but unused
- <a href="https://github.com/mlflow/mlflow/blob/7bbd8945a532053f7b5cecda8f8bbcc8a8d9c418/tests/utils/test_requirements_utils.py#L321">tests/utils/test_requirements_utils.py:321:16:</a> F401 [*] `databricks.automl` imported but unused
- <a href="https://github.com/mlflow/mlflow/blob/7bbd8945a532053f7b5cecda8f8bbcc8a8d9c418/tests/utils/test_requirements_utils.py#L322">tests/utils/test_requirements_utils.py:322:16:</a> F401 [*] `databricks.automl_foo` imported but unused
- <a href="https://github.com/mlflow/mlflow/blob/7bbd8945a532053f7b5cecda8f8bbcc8a8d9c418/tests/utils/test_requirements_utils.py#L323">tests/utils/test_requirements_utils.py:323:16:</a> F401 [*] `databricks.automl_runtime` imported but unused
- <a href="https://github.com/mlflow/mlflow/blob/7bbd8945a532053f7b5cecda8f8bbcc8a8d9c418/tests/utils/test_requirements_utils.py#L324">tests/utils/test_requirements_utils.py:324:16:</a> F401 [*] `databricks.model_monitoring` imported but unused
- <a href="https://github.com/mlflow/mlflow/blob/7bbd8945a532053f7b5cecda8f8bbcc8a8d9c418/tests/utils/test_requirements_utils.py#L332">tests/utils/test_requirements_utils.py:332:16:</a> F401 [*] `databricks.automl` imported but unused
- <a href="https://github.com/mlflow/mlflow/blob/7bbd8945a532053f7b5cecda8f8bbcc8a8d9c418/tests/utils/test_requirements_utils.py#L333">tests/utils/test_requirements_utils.py:333:16:</a> F401 [*] `databricks.automl_foo` imported but unused
- <a href="https://github.com/mlflow/mlflow/blob/7bbd8945a532053f7b5cecda8f8bbcc8a8d9c418/tests/utils/test_requirements_utils.py#L334">tests/utils/test_requirements_utils.py:334:16:</a> F401 [*] `databricks.automl_runtime` imported but unused
- <a href="https://github.com/mlflow/mlflow/blob/7bbd8945a532053f7b5cecda8f8bbcc8a8d9c418/tests/utils/test_requirements_utils.py#L335">tests/utils/test_requirements_utils.py:335:16:</a> F401 [*] `databricks.model_monitoring` imported but unused
</pre>

</p>

<a href="https://github.com/scikit-build/scikit-build">scikit-build/scikit-build</a> (+0 -2 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
- <a href="https://github.com/scikit-build/scikit-build/blob/a2afff25f98e0d1fe573f520b659e1ee1f427c38/skbuild/utils/__init__.py#L33">skbuild/utils/__init__.py:33:12:</a> F401 `setuptools.logging` imported but unused; consider using `importlib.util.find_spec` to test for availability
- <a href="https://github.com/scikit-build/scikit-build/blob/a2afff25f98e0d1fe573f520b659e1ee1f427c38/tests/__init__.py#L9">tests/__init__.py:9:12:</a> F401 `distutils` imported but unused
</pre>

</p>

<a href="https://github.com/mesonbuild/meson-python">mesonbuild/meson-python</a> (+0 -1 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
- <a href="https://github.com/mesonbuild/meson-python/blob/09e18fc87f52c67e341d34147532d23b324142c1/tests/test_editable.py#L281">tests/test_editable.py:281:24:</a> F401 [*] `pure` imported but unused
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| F401 | 22 | 0 | 22 | 0 | 0 |</p>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-10-17 17:47</div>
            <div class="timeline-body"><p>The ecosystem hits look correct - these two are debatable, but keeping the stable behavior seems fine for now:</p>
<ul>
<li><a href="https://github.com/apache/airflow/blob/7939692b266a20b340f133f998612f083c585b6c/providers/google/src/airflow/providers/google/common/utils/id_token_credentials.py#L43">providers/google/src/airflow/providers/google/common/utils/id_token_credentials.py:43:12:</a></li>
<li><a href="https://github.com/mlflow/mlflow/blob/2749d7690b0ed57e0a26af4475021a380e25fdb3/mlflow/pyfunc/loaders/__init__.py#L1">mlflow/pyfunc/loaders/<strong>init</strong>.py:1:8:</a></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-10-17 17:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pyflakes/rules/unused_import.rs</code>:947 on 2025-10-20 07:42</div>
            <div class="timeline-body"><p>Nit: Maybe add some spaces to make it clearer that these are separate checks (and the comment only applies to the first)</p>
<pre><code>        if i &gt; 0 &amp;&amp; shadowed_binding.is_used() {
            return false;
        }
        
        if shadowed_binding
            .source
            .is_none_or(|node_id| !semantic.same_branch(node_id, binding_node))
        {
            return false;
        }
        
        matches!(
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-20 07:45</div>
            <div class="timeline-body"><p>The examples with <code>if TYPE_CHECKING</code> are a bit unfortunate. Do you think it would be possible to instead test if the import is in an alternate branch than the other import?</p>
<p>E.g. the following should be flagged</p>
<pre><code>
if True:
	import a.b
	if other:
		import a.b
</code></pre>
<p>but not</p>
<pre><code>if True:
	import a.b
else:
	if other:
		import a.b
</code></pre>
<p>So, I guess, we&#x27;d have to check if the first import ancestor chain is a prefix of the second import&#x27;s ancestor chain</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[`pyflakes`] Revert to stable behavior if imports for module lie in different branches for `F401`&quot; to &quot;[`pyflakes`] Revert to stable behavior if imports for module lie in alternate branches for `F401`&quot; by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-10-24 19:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-10-27 07:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-27 07:52</div>
            <div class="timeline-body"><p>Did this new approach improve the ecosystem results?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-10-27 12:08</div>
            <div class="timeline-body"><blockquote>
<p>Did this new approach improve the ecosystem results?</p>
</blockquote>
<p>Yes! The things that remain are variations on the <code>try</code>/<code>except</code> pattern in the original issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-10-27 15:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-10-27 15:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-10-28 12:57</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:19:32 UTC
    </footer>
</body>
</html>
