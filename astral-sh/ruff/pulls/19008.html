<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add special-cased inference for `__import__(name)` and `importlib.import_module(name)` - astral-sh/ruff #19008</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add special-cased inference for <code>__import__(name)</code> and <code>importlib.import_module(name)</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19008">#19008</a>
        opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a>
        on 2025-06-28 05:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a></div>
            <div class="timeline-body">Summary
<p>Resolves <a href="https://github.com/astral-sh/ty/issues/718">#718</a>.</p>
<p>After this change, calls to <code>__import__()</code> and <code>importlib.import_module()</code> where the only argument is of a literal string type are resolved to literal module types instead of <code>types.ModuleType</code> (or whatever its <code>typeshed</code> signature says). The latter is also used as the fallback type when the module cannot be resolved.</p>
Test Plan
<p>Markdown tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-06-28 05:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-06-28 05:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-06-28 05:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-06-28 05:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-06-28 05:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-28 05:33</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>async-utils (https://github.com/mikeshardmind/async-utils)
+ error[invalid-argument-type] src/async_utils/corofunc_cache.py:50:26: Argument to class `type` is incorrect: Expected `tuple[type, ...]`, found `tuple[typing.Protocol]`
+ error[invalid-argument-type] src/async_utils/task_cache.py:51:26: Argument to class `type` is incorrect: Expected `tuple[type, ...]`, found `tuple[typing.Protocol]`
- Found 16 diagnostics
+ Found 18 diagnostics

paroxython (https://github.com/laowantong/paroxython)
- error[unresolved-attribute] paroxython/flatten_ast.py:591:12: Type `ModuleType` has no attribute `Path`
- error[unresolved-attribute] paroxython/list_programs.py:123:16: Type `ModuleType` has no attribute `datetime`
- error[unresolved-attribute] paroxython/recommend_programs.py:332:12: Type `ModuleType` has no attribute `loads`
- error[unresolved-attribute] paroxython/recommend_programs.py:335:22: Type `ModuleType` has no attribute `literal_eval`
- Found 11 diagnostics
+ Found 7 diagnostics

rich (https://github.com/Textualize/rich)
- error[unresolved-attribute] rich/pager.py:21:16: Type `ModuleType` has no attribute `pager`
- Found 327 diagnostics
+ Found 326 diagnostics
-     memo fields = ~117MB
+     memo fields = ~106MB

mkosi (https://github.com/systemd/mkosi)
- TOTAL MEMORY USAGE: ~117MB
+ TOTAL MEMORY USAGE: ~129MB
-     memo fields = ~97MB
+     memo fields = ~106MB

poetry (https://github.com/python-poetry/poetry)
- error[unresolved-attribute] tests/fixtures/git/github.com/demo/namespace-package-one/namespace_package/__init__.py:4:1: Type `ModuleType` has no attribute `declare_namespace`
- Found 949 diagnostics
+ Found 948 diagnostics

vision (https://github.com/pytorch/vision)
-     memo fields = ~304MB
+     memo fields = ~276MB

altair (https://github.com/vega/altair)
-     memo fields = ~228MB
+     memo fields = ~251MB

discord.py (https://github.com/Rapptz/discord.py)
- error[unresolved-attribute] discord/__init__.py:18:12: Type `ModuleType` has no attribute `extend_path`
- Found 549 diagnostics
+ Found 548 diagnostics

scrapy (https://github.com/scrapy/scrapy)
- error[unresolved-attribute] scrapy/settings/default_settings.py:358:24: Type `ModuleType` has no attribute `__version__`
- Found 1149 diagnostics
+ Found 1148 diagnostics

static-frame (https://github.com/static-frame/static-frame)
-     memo fields = ~304MB
+     memo fields = ~334MB

dd-trace-py (https://github.com/DataDog/dd-trace-py)
- error[unresolved-attribute] tests/appsec/iast/test_loader.py:37:13: Type `ModuleType` has no attribute `add`
- Found 6839 diagnostics
+ Found 6838 diagnostics

scikit-learn (https://github.com/scikit-learn/scikit-learn)
- TOTAL MEMORY USAGE: ~652MB
+ TOTAL MEMORY USAGE: ~717MB

</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-06-28 05:38</div>
            <div class="timeline-body"><p>The ecosystem changes are all as expected.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-28 07:47</div>
            <div class="timeline-body"><p>We may as well do <code>importlib.import_module</code> as well, no? It works in exactly the same way</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/completion.rs</code>:1 on 2025-06-28 07:50</div>
            <div class="timeline-body"><p>I don&#x27;t think this really needs a new autocompletions test. This PR doesn&#x27;t change any of the autocompletions machinery at all, it just changes type inference. It&#x27;s generally true that anything which improves type inference will also improve attribute-access autocompletions, and we already have lots of tests that demonstrate this; adding another just feels duplicative</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:5403 on 2025-06-28 07:51</div>
            <div class="timeline-body"><p>Can you add a comment explaining why we exclude dotted module names (because <code>__import__</code> returns a <code>ModuleType</code> instance representing the top-level module rather than one representing the submodule)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:5391 on 2025-06-28 09:14</div>
            <div class="timeline-body"><p>I feel like I&#x27;d prefer to add a branch to <code>KnownFunction::check_call()</code> , and have that function return an <code>Option&lt;Type&gt;</code> like <code>KnownClass::check_call</code>, rather than create a closure that&#x27;s just immediately called here.</p>
<p>Or even better might be to just add a branch here: https://github.com/astral-sh/ruff/blob/90cb0d3a7b0d1b9528854dad64dd17330bfd5f36/crates/ty_python_semantic/src/types/call/bind.rs#L569</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-28 09:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-28 13:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2025-06-28 17:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:5391 on 2025-06-28 17:10</div>
            <div class="timeline-body"><p><code>.evaluate_known_cases()</code> doesn&#x27;t have access to <code>File</code>. Its call tree is all over the place too, so adding a <code>file</code> parameter to every caller is probably not the best choice.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2025-06-28 17:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:5403 on 2025-06-28 17:25</div>
            <div class="timeline-body"><p>That wasn&#x27;t the intention. I just couldn&#x27;t figure out how to get <code>&lt;module &#x27;collections&#x27;&gt;</code> from <code>__import__(&#x27;collections.abc&#x27;)</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[ty] Special-case `__import__(single_name)`&quot; to &quot;[ty] Special-case `__import__(name)`&quot; by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-06-28 17:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/function.rs</code>:1201 on 2025-06-28 17:34</div>
            <div class="timeline-body"><p>this could fix your dotted-name issue:</p>
<pre><code>                let mut module_name = ModuleName::new(module_name)?;

                // `__import__(&quot;collections.abc&quot;)` returns the `collections` module;
                // `importlib.import_module(&quot;collections.abc&quot;)` returns the `collections.abc` module
                if known == KnownFunction::DunderImport {
                    module_name = ModuleName::new(module_name.components().next()?)?;
                }

                let module = resolve_module(db, &amp;module_name)?;

                Some(Type::module_literal(db, file, &amp;module))
</code></pre>
<p>But note that if you pass the <code>fromlist</code> parameter to <code>__import__</code>, it changes the behaviour of the function:</p>
<pre><code>&gt;&gt;&gt; __import__(&quot;collections.abc&quot;, fromlist=[&quot;abc&quot;])
&lt;module &#x27;_collections_abc&#x27; (frozen)&gt;
</code></pre>
<p>You also need to either account for the <code>level</code> parameter of <code>__import__</code>, or to avoid applying any special-casing when more than one argument is passed to the function. (The latter is obviously simpler.) The same goes for the optional <code>package</code> argument of <code>importlib.import_module</code>, which changes the behaviour of that function.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:5397 on 2025-06-28 17:34</div>
            <div class="timeline-body"><pre><code>                                overload.set_return_type(return_type);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/import/dunder_import.md</code>:1 on 2025-06-28 17:43</div>
            <div class="timeline-body"><p>I don&#x27;t think this test file should be in the <code>import/</code> subdirectory. It doesn&#x27;t have anything to do with our behaviour regarding import resolution; it demonstrates our special-casing of two standard-library functions. I think this folder would be a better fit; it&#x27;s where most of our tests for our other special-cased functions are (<code>getatt_static</code>, etc.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-28 17:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/MichaReiser">@MichaReiser</a> removed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-28 17:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-28 17:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/import/dunder_import.md</code>:1 on 2025-06-28 17:56</div>
            <div class="timeline-body"><p>er, sorry for the garbled review comment there. I meant to link to this folder as the one I think this test file should go in: https://github.com/astral-sh/ruff/tree/main/crates/ty_python_semantic/resources/mdtest/call</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2025-06-28 18:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ty_python_semantic/src/types/function.rs</code>:1201 on 2025-06-28 18:12</div>
            <div class="timeline-body"><p>Calls with <code>fromlist</code>, <code>level</code> and <code>package</code> are <a href="https://github.com/search?q=lang%3APython+%2F%28__import__%7Cimport_module%29%5C%28%5B%27%22%5D%5Cw%2B%5B%27%22%5D%2C%2F&amp;type=code">less common</a>, so I&#x27;d say it&#x27;s not worth supporting those unless there&#x27;s a feature request.</p>
<p>As for the suggested code, it imports the top level module but not the submodules (see <a href="https://play.ty.dev/2a70a4b1-1700-4b4c-b827-ec201b4d8e2e">this playground</a> for an example).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-28 18:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/call/dunder_import.md</code>:1 on 2025-06-28 18:21</div>
            <div class="timeline-body"><p>Can you add some tests that demonstrate that (and explain why) we do not apply the special-casing if <code>fromlist</code>/<code>level</code> are passed to <code>__import__</code>, or if <code>package</code> is passed to <code>importlib.import_module</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-28 18:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/function.rs</code>:1201 on 2025-06-28 18:23</div>
            <div class="timeline-body"><blockquote>
<p>As for the suggested code, it imports the top level module but not the submodules (see <a href="https://play.ty.dev/2a70a4b1-1700-4b4c-b827-ec201b4d8e2e">this playground</a> for an example).</p>
</blockquote>
<p>Right, we&#x27;d have to figure out a way of incorporating it into our model that the submodules are loaded onto the parent module if it&#x27;s been dynamically imported with <code>__import__</code>. Which is probably not worth the bother. For this reason, I&#x27;m okay with skipping the special-casing for <code>__import__</code> if the name is dotted, as long as we add a comment explaining that this is the reason why.</p>
<p>If the returned object is inferred as <code>ModuleType</code>, ideally the <code>ModuleType.__getattr__</code> method would prevent false positives if users accessed submodules on the top-level module (though I think we incorrectly ignore <code>ModuleType.__getattr__</code> in all cases right now, but that&#x27;s a separate bug)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-06-28 21:23</div>
            <div class="timeline-body">



<a href="https://codspeed.io/astral-sh/ruff/branches/InSyncWithFoo%3Aty-dunder-import?runnerMode=WallTime">CodSpeed WallTime Performance Report</a>
Merging #19008 will <strong>degrade performances by 4.17%</strong>
<p>Comparing <code>InSyncWithFoo:ty-dunder-import</code> (1548503) with <code>main</code> (9218bf7)</p>
Summary
<p><code>❌ 1</code> regressions<br>
<code>✅ 7</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/InSyncWithFoo%3Aty-dunder-import?runnerMode=WallTime">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
Benchmarks breakdown
<p>|     | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ❌ | <code>multithreaded[pydantic]</code> | 8.6 s | 9 s | -4.17% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-28 21:40</div>
            <div class="timeline-body"><p>That specific benchmark has been flaky, I wouldn&#x27;t worry about it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-06-29 10:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[ty] Special-case `__import__(name)`&quot; to &quot;[ty] Add special-cased inference for `__import__(name)` and `importlib.import_module(name)`&quot; by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-29 10:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-29 10:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-29 10:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-29 14:55</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:16:00 UTC
    </footer>
</body>
</html>
