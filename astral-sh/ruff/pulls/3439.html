<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>perf: Optimize UTF8/ASCII byte offset index - astral-sh/ruff #3439</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>perf: Optimize UTF8/ASCII byte offset index</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/3439">#3439</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-03-10 13:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-03-10 13:39</div>
            <div class="timeline-body"><p>This PR improves the memory consumption and performance of our line/column based <code>Location</code>s to byte offsets. The PR also introduces two new zero-cost wrappers so that the functionality can be implemented as methods rather than free floating functions.</p>
<p>The first improvement is that the implementation no longer performs two passes over the string:</p>
<ol>
<li>To determine if its ASCII</li>
<li>To build up the index</li>
</ol>
<p>The implementation now assumes ASCII and falls back (and converts the intermediate state) to UTF8 when it sees the first non-ascii character while building the index.</p>
<p>The second optimization is to use <code>u32</code> to store the offsets (has anyone ever tried running a 4GB+ source document with Python?)</p>
<p>The last optimization avoids the nested <code>Vec&lt;Vec&lt;usize&gt;&gt;</code> for the <code>Utf8Index</code>. I tried two different approaches</p>
<h2>Line -&gt; Char and Char -&gt; Byte Index</h2>
<p>The idea is to use two vectors instead of a nested vector:</p>
<ul>
<li>The first vector stores the <em>character</em> offset at which a new line starts</li>
<li>The second vector stores the <em>byte</em> offsets for each character</li>
</ul>
<p>You can then compute the [Location] offset by:</p>
<pre><code class="language-rust">// retrieving the start character on that line and add the column (character offset)
let char_offset = lines[location.row() - 1] + location.column();
let byte_offset = char_to_byte_offsets[char_offset]
</code></pre>
<p>0b39da539059d87301f7319a2575114d87363e49</p>
<h2>Lazy column computation</h2>
<p>This implementation makes the assumption that we're only querying a few locations and that computing the column offset for a single line is cheap (no minified documents where everything is on a single line).</p>
<p>Based on this assumption, it is sufficient to only store the byte offsets for every line and then lazily compute the column offset.</p>
<p>Computing the index lazily has the added benefit of reducing the memory footprint.</p>
<p>7527612fcd254a14fcba1fa6d34a7d15883802e9</p>
<h2>Benchmark</h2>
<pre><code>❯ hyperfine --ignore-failure --warmup 10 \
        &quot;./ruff_two ./crates/ruff/resources/test/cpython/ --no-cache&quot; \
        &quot;./ruff_main ./crates/ruff/resources/test/cpython/ --no-cache&quot; \
        &quot;./ruff_lazy ./crates/ruff/resources/test/cpython/ --no-cache&quot;
Benchmark 1: ./ruff_two ./crates/ruff/resources/test/cpython/ --no-cache
  Time (mean ± σ):     186.3 ms ±   3.5 ms    [User: 3177.1 ms, System: 91.2 ms]
  Range (min … max):   180.5 ms … 192.1 ms    15 runs
 
  Warning: Ignoring non-zero exit code.
 
Benchmark 2: ./ruff_main ./crates/ruff/resources/test/cpython/ --no-cache
  Time (mean ± σ):     187.8 ms ±   3.5 ms    [User: 3215.8 ms, System: 99.4 ms]
  Range (min … max):   183.9 ms … 195.6 ms    15 runs
 
  Warning: Ignoring non-zero exit code.
 
Benchmark 3: ./ruff_lazy ./crates/ruff/resources/test/cpython/ --no-cache
  Time (mean ± σ):     184.7 ms ±   4.1 ms    [User: 3188.5 ms, System: 97.6 ms]
  Range (min … max):   179.5 ms … 195.8 ms    16 runs
 
  Warning: Ignoring non-zero exit code.
 
Summary
  './ruff_lazy ./crates/ruff/resources/test/cpython/ --no-cache' ran
    1.01 ± 0.03 times faster than './ruff_two ./crates/ruff/resources/test/cpython/ --no-cache'
    1.02 ± 0.03 times faster than './ruff_main ./crates/ruff/resources/test/cpython/ --no-cache'

</code></pre>
<h2>Memory usage</h2>
<p>I used <code>/usr/bin/time</code> to get the max resident memory when linting cpython</p>
<ul>
<li><code>main</code>:  ~324MB</li>
<li><code>two</code>: ~298MB</li>
<li><code>lazy</code>: ~287MB</li>
</ul>
<h2>Verdict</h2>
<p>This PR implements the <code>lazy</code> computation as it has a similar performance as storing all character positions but requires significantly less memory (only stores line mappings, not also mappings for every line)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2023-03-10 16:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_ast/src/source_code/locator.rs</code>:68 on 2023-03-10 16:47</div>
            <div class="timeline-body"><p>Nit: there are a couple <code>[Location]</code> usages that may need to be wrapped in backticks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_ast/src/source_code/locator.rs</code>:99 on 2023-03-10 16:49</div>
            <div class="timeline-body"><p><code>Self::Utf8</code> for consistency with line 108?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_ast/src/source_code/locator.rs</code>:92 on 2023-03-10 16:50</div>
            <div class="timeline-body"><p>(For context, 48 was chosen based on some rough benchmarking of various constants, so it's sort of arbitrary but not totally arbitrary.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_ast/src/source_code/locator.rs</code>:129 on 2023-03-10 16:51</div>
            <div class="timeline-body"><p>Does this now properly handle CR line endings for UTF-8 files? (We don't support them right now which often leads to panics.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-03-10 16:52</div>
            <div class="timeline-body"><p>These are nice improvements!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-03-11 09:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/source_code/locator.rs</code>:129 on 2023-03-11 09:05</div>
            <div class="timeline-body"><p>It should. Let me add a test and verify that ASCII handles <code>\r</code> correctly too</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-03-11 10:47</div>
            <div class="timeline-body"><p>✅ ecosystem check detected no changes.</p>
<!-- thollander/actions-comment-pull-request "ecosystem-results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-03-11 12:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-03-11 12:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-03-11 12:12</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 04:41:43 UTC
    </footer>
</body>
</html>
