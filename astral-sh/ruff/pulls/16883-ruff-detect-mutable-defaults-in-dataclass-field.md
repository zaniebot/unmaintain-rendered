```yaml
number: 16883
title: "[ruff] Detect mutable defaults in dataclass `field` calls (`RUF008`)"
type: pull_request
state: closed
author: codex-maintainers
labels:
  - rule
assignees: []
draft: true
base: main
head: gopoto/16495
created_at: 2025-03-21T05:30:01Z
updated_at: 2025-06-20T06:43:28Z
url: https://github.com/astral-sh/ruff/pull/16883
synced_at: 2026-01-10T18:39:08Z
```

# [ruff] Detect mutable defaults in dataclass `field` calls (`RUF008`)

---

_Pull request opened by @codex-maintainers on 2025-03-21 05:30_

## Summary

Extend `RUF008` to catch mutable default values supplied via `dataclasses.field` and `attrs.field` calls. Previously, `RUF008` only flagged direct assignments like `mutable_default: list[int] = []`, and ignored cases such as `attrs.field(default=[])` within `attrs`-decorated classes. The rule now inspects calls to field helpers and emits a diagnostic if the `default` keyword is a mutable literal.

Test fixtures for both dataclasses and attrs classes were updated to include explicit `field(default=[])` cases, the attrs fixture now imports `attrs` so that these calls are resolvable, and snapshots were updated accordingly.

## Test Plan

Built the workspace (`cargo check`) and ran Ruff against the updated fixtures:

```
cargo run -p ruff -- check crates/ruff_linter/resources/test/fixtures/ruff/RUF008_attrs.py --select RUF008 --preview --no-cache
```

reports both direct mutable defaults and `attrs.field(default=[])` defaults. A minimal reproduction of the original issue:

```
import attrs
@attrs.define
class B:
    mutable_default: list[int] = []
    mutable_default2: list[int] = attrs.field(default=[])
```

now yields two `RUF008` diagnostics as expected.

Running the hooks (`cargo fmt`, `cargo clippy`, etc.) and pre-commit checks pass after formatting, and updated snapshot tests reflect the new diagnostics.

---

This PR was generated by an AI system in collaboration with maintainers: @carljm, @ntBre 

Fixes #16495

---

_Label `rule` added by @ntBre on 2025-03-21 16:01_

---

_@charliermarsh reviewed on 2025-03-21 22:42_

---

_Review comment by @charliermarsh on `crates/ruff_linter/src/rules/ruff/rules/mutable_dataclass_default.rs`:118 on 2025-03-21 22:42_

I think this needs to be gated behind preview.

---

_@codex-maintainers reviewed on 2025-03-25 08:23_

---

_Review comment by @codex-maintainers on `crates/ruff_linter/src/rules/ruff/rules/mutable_dataclass_default.rs`:118 on 2025-03-25 08:23_

Good call â€“ I've wrapped the new `field(default=[])` check behind `checker.settings.preview.is_enabled()` and added preview snapshots/tests.

---

_Comment by @codex-maintainers on 2025-03-25 08:23_

Added preview gating to the new `field(default=[])` detection in `RUF008` so the expanded behavior only triggers under `--preview`. Baseline `RUF008` snapshots were reverted to the pre-change expectation with updated line numbers, and new `preview__RUF008` snapshots were introduced to cover the field default cases under preview. The test harness was updated to exercise the rule in preview mode.

---

_Comment by @MichaReiser on 2025-06-20 06:43_

Closing because we never got to reviewing this PR.

---

_Closed by @MichaReiser on 2025-06-20 06:43_

---
