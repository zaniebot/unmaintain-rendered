<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Add inlay type hints - astral-sh/ruff #17214</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Add inlay type hints</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17214">#17214</a>
        opened by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a>
        on 2025-04-04 21:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-04 21:49</div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>Fixes #17205</p>
<h2>Test Plan</h2>
<p>Add tests to red_knot_ide/src/inlay_hints.rs</p>
<p>https://github.com/user-attachments/assets/f3e654c5-d95b-4de3-91ae-602843c160d1</p>
<p>https://github.com/user-attachments/assets/fcc1861a-aa34-49c3-ad6f-fb375dc546d8</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-04 21:52</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-04 21:53</div>
            <div class="timeline-body"><p>Currently this adds type hints to almost everything, need to work on that</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-04 21:59</div>
            <div class="timeline-body"><p>Also need to make sure we dont add type hints when there is already one there</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-04-04 22:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-05 15:10</div>
            <div class="timeline-body"><p>@MichaReiser suggested the following</p>
<p>I think I'd take an approach closer to rust analyzer:</p>
<ul>
<li>Write a custom <code>SourceOrderVisitor</code> that traverses the AST</li>
<li><code>enter_node</code> returns <code>TraverseSignal::Skip</code> if the node isn't in the queried range</li>
<li>Compute the hints in <code>visit_*</code> methods but only for the nodes you want by using <code>node.inferred_type</code> (because we never want to show declared types?)</li>
</ul>
<p>https://github.com/rust-lang/rust-analyzer/blob/15d87419f1a123d8f888d608129c3ce3ff8f13d4/crates/ide/src/inlay_hints.rs#L224-L283</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MatthewMckee4 on 2025-04-05 15:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MatthewMckee4 on 2025-04-05 15:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MatthewMckee4 on 2025-04-05 15:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @MatthewMckee4 on 2025-04-05 15:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @MatthewMckee4 on 2025-04-05 15:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @MatthewMckee4 on 2025-04-05 15:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-05 15:21</div>
            <div class="timeline-body"><p>Im not sure how to work with settings to be able to enable/disable this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-05 15:31</div>
            <div class="timeline-body"><p>Did you push your latest changes? The current approach doesn't use a custom visitor. Could you add a test plan so that I get a sense for how the feature works?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-05 15:37</div>
            <div class="timeline-body"><p>Ive not implemented a custom visitor yet, ill get on that. <code>red_knot_python_semantic/src/visitor.rs</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @MatthewMckee4 on 2025-04-05 15:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-05 22:44</div>
            <div class="timeline-body"><p><img src="https://github.com/user-attachments/assets/7c445a00-8cfc-42d9-a3a5-d49267156de6" alt="image" />
<img src="https://github.com/user-attachments/assets/f22a7b03-6011-4f71-9373-ccb982911fda" alt="image" /></p>
<p>Does the first option look good?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-04-05 22:59</div>
            <div class="timeline-body"><p>@MatthewMckee4 The second is more pleasing to the eyes, but I guess the hints won't be as nice for something like <code>(a1, *a2) = a</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-05 23:07</div>
            <div class="timeline-body"><p>@InSyncWithFoo Yeah the hints dont change from the second image with <code>(a1, *a2) = a</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-05 23:28</div>
            <div class="timeline-body"><p>Personally
<img src="https://github.com/user-attachments/assets/72e19518-fdcf-400a-b9ac-2e5e6a4404c5" alt="image" />
This does not look as nice or useful as
<img src="https://github.com/user-attachments/assets/bc712f0e-bd2a-4c3d-8db7-ea91864a47e8" alt="image" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-05 23:42</div>
            <div class="timeline-body"><p>I think theres lots more we can add to (or remove from) this:</p>
<pre><code class="language-py"># This is not very useful
a: Literal[&quot;abc&quot;] = &quot;abc&quot;
b: Literal[1] = 1
... more `Literal` values

c: int | float | complex = 1 + 2j
d: None = None
e: Literal[True] = True
</code></pre>
<p>And probably some more</p>
<p>edit: maybe im wrong here (i guess the point of using this is to provide these insights).</p>
<p>Any input is appreciated</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MatthewMckee4 on 2025-04-05 23:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @MatthewMckee4 on 2025-04-06 02:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-06 07:46</div>
            <div class="timeline-body"><p>I prefer the first. Maybe because it's also what r-a does. TypeScript doesn't show inlay hints for destructuring (unpacking). Most LSPs have very fine grained settings for in which positions inlay hints should be shown.</p>
<p>For now, I think we should just pick one and we can iterate based on user feedback</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-04-06 14:22</div>
            <div class="timeline-body"><blockquote>
<p>Personally</p>
<p><img src="https://github.com/user-attachments/assets/72e19518-fdcf-400a-b9ac-2e5e6a4404c5" alt="image" /></p>
<p>This does not look as nice or useful as</p>
<p><img src="https://github.com/user-attachments/assets/bc712f0e-bd2a-4c3d-8db7-ea91864a47e8" alt="image" /></p>
</blockquote>
<p>I think I'd prefer the latter as for the first one could get confused that the type hint belongs to the last variable if the tuple doesn't contain parentheses. This might also be a bit subjective.</p>
<p>Edit: I think that's what you meant now that I read it again?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MatthewMckee4 on 2025-04-06 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-06 14:49</div>
            <div class="timeline-body"><p>I think I'm making a similar point to @MatthewMckee4 in https://github.com/astral-sh/ruff/pull/17214#issuecomment-2781134667 here... I think we should maybe think about the <em>use cases</em> for inlay type hints.</p>
<p>I find rust-analyzer's inlay type hints useful in two situations:</p>
<ol>
<li><p>Telling me what type the compiler infers for &quot;intermediate steps&quot; in long/complex call chains, e.g.</p>
<details>
<summary>Screenshot</summary>

<p><img src="https://github.com/user-attachments/assets/276025ba-f4c8-4a66-8206-44bfcd70f058" alt="image" /></p>
</details>

</li>
<li><p>Providing me an easy way to add type annotations to my code if I want to be explicit and/or to be certain that the compiler is inferring the type I want: I can just double-click on the inlay.</p>
</li>
</ol>
<p>I think these two things are sort-of in conflict with each other a little bit for us? And possibly neither motivation is quite as strong as it is for rust-analyzer?</p>
<ol>
<li>Providing a way of telling me what each step in a long call chain is inferred as would still be useful in some situations. However, long call chains aren't nearly as common in Python as they are in Rust. (You find them a lot in code that uses some specific libraries like pandas, but not much outside of those use cases.) I think we're also less likely to infer complex generics as the Rust compiler is (though we do have intersections/unions, which may get complex in some situations).</li>
<li>When it comes to providing an easy way to add type annotations to your code: we infer extremely precise types for local variables -- but you'd almost never want to use those extremely precise types in explicit type annotations. <code>x: Literal[1] = 1</code> is an annotation you'd never see in idiomatic Python code: it would either be <code>x: Final = 1</code> (indicating that you should never assign to <code>x</code> again after the variable's first intialisation) or some broader type like <code>x: int = </code>, <code>x: typing.SupportsIndex = 1</code> or <code>x: int | None = 1</code> (which would allow you to assign a different value to <code>x</code> after its first initialisation). So I wouldn't find the <code>Literal[1]</code> inlay on something like <code>x = 1</code> very useful</li>
</ol>
<p>That said, if these are going to be opt-in only then I'm fine with landing an initial version of this and iterating on it! We can see whether people find it useful or not. I might also be missing some use cases for inlays?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-06 14:57</div>
            <div class="timeline-body"><p>I think one other useful thing that @InSyncWithFoo mentioned is inlay hints for inferred function return types, but im not sure we are at the stage right now where we can do that</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-04-06 15:25</div>
            <div class="timeline-body"><p>Should we provide inlays that are not valid Python syntax? Neither <code>a, b: tuple[...] = ...</code> nor <code>a: ..., b: ... = ...</code> is valid Python. Annotated assignments can't be unpacked, regular assignments can't take annotations.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-06 15:34</div>
            <div class="timeline-body"><p>That's a good point, but rust-analyzer also provides inlay hints for invalid annotations, for the unpacking here
<img src="https://github.com/user-attachments/assets/2b6a1782-163d-4464-9c66-8acb9834e8bc" alt="image" />
And because of that you cant double click on it (to insert the type)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-06 17:12</div>
            <div class="timeline-body"><blockquote>
<p>I find rust-analyzer's inlay type hints useful in two situations:</p>
</blockquote>
<p>I don't think this PR implements 2.</p>
<p>From the LSP specification</p>
<blockquote>
<p>/**
* Optional text edits that are performed when accepting this inlay hint.
*
* <em>Note</em> that edits are expected to change the document so that the inlay
* hint (or its nearest variant) is now part of the document and the inlay
* hint itself is now obsolete.
*
* Depending on the client capability <code>inlayHint.resolveSupport</code> clients
* might resolve this property late using the resolve request.
*/
textEdits?: <a href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#textEdit">TextEdit</a>[];</p>
</blockquote>
<p>That means, we could generalize the type. Although I'm not quiet sure what the rules would be ;) But I don't think this should block this PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_ide/src/inlay_hints.rs</code>:42 on 2025-04-07 07:33</div>
            <div class="timeline-body"><p>Nit: We tend to omit the <code>get</code> prefix.</p>
<pre><code class="language-suggestion">pub fn inlay_hints(db: &amp;dyn Db, file: File) -&gt; Vec&lt;RangedValue&lt;InlayHintContent&lt;'_&gt;&gt;&gt; {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-07 07:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_server/src/server/api/requests/inlay_hints.rs</code>:48 on 2025-04-07 07:34</div>
            <div class="timeline-body"><p>The <code>InlayHintRequestHandler</code> provide a <code>range</code> to avoid computing the inlay hints for the entire document. We should respect that parameter</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-07 07:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_ide/src/inlay_hints.rs</code>:52 on 2025-04-07 07:37</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    visitor.hints
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-07 07:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_ide/src/inlay_hints.rs</code>:64 on 2025-04-07 07:38</div>
            <div class="timeline-body"><p>I suggest not wrapping <code>InlayHintContent</code> in a <code>RangedValue</code> because, unlike goto type definition, the hints must always belong to <code>file</code> (the LSP doesn't allow you to return hints that belong to another file).</p>
<p>That's why I simply storing a <code>TextRange</code> for each hint should be simpler.</p>
<p>Looking at the usage in the LSP, it seems all we need is a <code>TextSize</code>, the position where the inlay hint should be shown.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-07 07:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-04-07 07:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_ide/src/inlay_hints.rs</code>:64 on 2025-04-07 07:43</div>
            <div class="timeline-body"><p>For the lsp we need line number and column number, inside the wasm there's an easy way to do this, with 'Range', but outside it's not so easy, what do you think we should do</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-07 07:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_ide/src/inlay_hints.rs</code>:64 on 2025-04-07 07:49</div>
            <div class="timeline-body"><p>Can you explain what isn't easy? We do similar conversions in goto type definition and on hover.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-04-07 07:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_ide/src/inlay_hints.rs</code>:64 on 2025-04-07 07:50</div>
            <div class="timeline-body"><p>I guess it just means I need to copy code from the wasm, to convert text range to line and column number</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_server/src/server/api/requests/inlay_hints.rs</code>:65 on 2025-04-07 07:52</div>
            <div class="timeline-body"><p>The conversion is a bit more involved because the column depends on the encoding used by the client. We already have helpers for this conversion but they are currently not exposed. Let's introduce <code>TextSizeExt</code> trait and add a <code>to_position</code> method</p>
<pre><code class="language-patch">Subject: [PATCH] [red-knot] Add 'Format document' to playground
---
Index: crates/red_knot_server/src/document/range.rs
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
&lt;+&gt;UTF-8
===================================================================
diff --git a/crates/red_knot_server/src/document/range.rs b/crates/red_knot_server/src/document/range.rs
--- a/crates/red_knot_server/src/document/range.rs	(revision c1c5434abe524b4e1ecb6e80a82f668cfcf27dcb)
+++ b/crates/red_knot_server/src/document/range.rs	(date 1744012168728)
@@ -27,6 +27,29 @@
     fn to_text_size(&amp;self, text: &amp;str, index: &amp;LineIndex, encoding: PositionEncoding) -&gt; TextSize;
 }
 
+pub(crate) trait TextSizeExt {
+    fn to_position(
+        self,
+        text: &amp;str,
+        index: &amp;LineIndex,
+        encoding: PositionEncoding,
+    ) -&gt; lsp_types::Position
+    where
+        Self: Sized;
+}
+
+impl TextSizeExt for TextSize {
+    fn to_position(
+        self,
+        text: &amp;str,
+        index: &amp;LineIndex,
+        encoding: PositionEncoding,
+    ) -&gt; lsp_types::Position {
+        let source_location = offset_to_source_location(self, text, index, encoding);
+        source_location_to_position(&amp;source_location)
+    }
+}
+
 pub(crate) trait ToRangeExt {
     fn to_lsp_range(
         &amp;self,
@@ -104,18 +127,8 @@
         encoding: PositionEncoding,
     ) -&gt; types::Range {
         types::Range {
-            start: source_location_to_position(&amp;offset_to_source_location(
-                self.start(),
-                text,
-                index,
-                encoding,
-            )),
-            end: source_location_to_position(&amp;offset_to_source_location(
-                self.end(),
-                text,
-                index,
-                encoding,
-            )),
+            start: self.start().to_position(text, index, encoding),
+            end: self.end().to_position(text, index, encoding),
         }
     }
 
Index: crates/red_knot_server/src/server/api/requests/inlay_hints.rs
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
&lt;+&gt;UTF-8
===================================================================
diff --git a/crates/red_knot_server/src/server/api/requests/inlay_hints.rs b/crates/red_knot_server/src/server/api/requests/inlay_hints.rs
--- a/crates/red_knot_server/src/server/api/requests/inlay_hints.rs	(revision c1c5434abe524b4e1ecb6e80a82f668cfcf27dcb)
+++ b/crates/red_knot_server/src/server/api/requests/inlay_hints.rs	(date 1744012202304)
@@ -1,5 +1,6 @@
 use std::borrow::Cow;
 
+use crate::document::{FileRangeExt, TextSizeExt, ToRangeExt};
 use crate::server::api::traits::{BackgroundDocumentRequestHandler, RequestHandler};
 use crate::server::client::Notifier;
 use crate::DocumentSnapshot;
@@ -52,24 +53,18 @@
 
         let inlay_hints = inlay_hints
             .into_iter()
-            .map(|hint| {
-                let end = index.source_location(hint.range.range().end(), &amp;source);
-
-                lsp_types::InlayHint {
-                    position: lsp_types::Position {
-                        line: u32::try_from(end.row.to_zero_indexed())
-                            .expect(&quot;row usize fits in u32&quot;),
-                        character: u32::try_from(end.column.to_zero_indexed())
-                            .expect(&quot;character usize fits in u32&quot;),
-                    },
-                    label: lsp_types::InlayHintLabel::String(hint.display(&amp;db).to_string()),
-                    kind: None,
-                    tooltip: None,
-                    padding_left: None,
-                    padding_right: None,
-                    data: None,
-                    text_edits: None,
-                }
+            .map(|hint| lsp_types::InlayHint {
+                position: hint
+                    .range
+                    .end()
+                    .to_position(&amp;source, &amp;index, snapshot.encoding()),
+                label: lsp_types::InlayHintLabel::String(hint.display(&amp;db).to_string()),
+                kind: None,
+                tooltip: None,
+                padding_left: None,
+                padding_right: None,
+                data: None,
+                text_edits: None,
             })
             .collect();
 
Index: crates/red_knot_server/src/document.rs
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
&lt;+&gt;UTF-8
===================================================================
diff --git a/crates/red_knot_server/src/document.rs b/crates/red_knot_server/src/document.rs
--- a/crates/red_knot_server/src/document.rs	(revision c1c5434abe524b4e1ecb6e80a82f668cfcf27dcb)
+++ b/crates/red_knot_server/src/document.rs	(date 1744012052127)
@@ -8,7 +8,7 @@
 pub(crate) use location::ToLink;
 use lsp_types::{PositionEncodingKind, Url};
 pub use notebook::NotebookDocument;
-pub(crate) use range::{FileRangeExt, PositionExt, RangeExt, ToRangeExt};
+pub(crate) use range::{FileRangeExt, PositionExt, RangeExt, TextSizeExt, ToRangeExt};
 pub(crate) use text_document::DocumentVersion;
 pub use text_document::TextDocument;
 

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_server/src/server/api/requests/inlay_hints.rs</code>:42 on 2025-04-07 07:54</div>
            <div class="timeline-body"><p>We don't want to store editor options in the project's metadata because these settings aren't project specific but user specific. Different users working on the same project will want to use different settings or even editors.
Let's always enable inlay hints for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_server/src/server/api/requests/inlay_hints.rs</code>:71 on 2025-04-07 07:55</div>
            <div class="timeline-body"><p>Nit: Not for this PR but we want to use the <code>InlayHintResolveRequest</code> to lazily resolve the tooltip and text edits. It may be worth adding a comment, see https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#inlayHint_resolve</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_server/src/server/api.rs</code>:41 on 2025-04-07 07:56</div>
            <div class="timeline-body"><p>I realised when reviewing your PR that we used the incorrect scheduling for almost all our request handlers. I already updated the other request handlers in a separate PR but we also need to change the priority for inlay hints: Inlay hints aren't latency sensitive (they aren't in the hot path of blocking the user from typing).</p>
<pre><code class="language-suggestion">            req, BackgroundSchedule::Worker
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_wasm/src/lib.rs</code>:279 on 2025-04-07 07:58</div>
            <div class="timeline-body"><p>I think we also want to pass the range here to avoid computing inlay hints for the entire document</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>playground/knot/src/Editor/Editor.tsx</code>:203 on 2025-04-07 08:01</div>
            <div class="timeline-body"><p>Annotations like these in a lambda are uncommon. It's more common to annotate the variable <code>inlayHints</code>. But my preference here is to rely on TypeScript's inference</p>
<pre><code class="language-suggestion">        hint =&gt; {
          return {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>playground/knot/src/Editor/Editor.tsx</code>:210 on 2025-04-07 08:02</div>
            <div class="timeline-body"><p>You can wrap the returned object in <code>(</code> to avoid the explicit return</p>
<pre><code class="language-suggestion">        }) =&gt; ({
        label: hint.markdown,
        position: {
            lineNumber: hint.position.line,
            column: hint.position.column,
        },
        })
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_ide/src/inlay_hints.rs</code>:64 on 2025-04-07 08:05</div>
            <div class="timeline-body"><p>I don't think that should be necessary. We already have plenty of helpers in https://github.com/astral-sh/ruff/blob/a4ba10ff0ae89d331422d50c87c0ac0691ee0161/crates/red_knot_server/src/document/range.rs#L14</p>
<p>Unless you talk about something else (I'm not sure what you find hard)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_server/src/server/api/requests/inlay_hints.rs</code>:66 on 2025-04-07 08:07</div>
            <div class="timeline-body"><p>We should set <code>kind</code> to <code>InlayHintKind::Type</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_ide/src/inlay_hints.rs</code>:93 on 2025-04-07 08:08</div>
            <div class="timeline-body"><p>Hmm, this is a bit unfortunate because it re-implements unpacking but I think it's fine for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_ide/src/inlay_hints.rs</code>:96 on 2025-04-07 08:08</div>
            <div class="timeline-body"><pre><code class="language-suggestion">                for target in &amp;assign.targets {
                    match target {
                        Expr::Tuple(tuple) =&gt; {
                            for element in &amp;tuple.elts {
                                let element_ty = element.inferred_type(&amp;self.model);
                                self.add_hint(element.range(), element_ty);
                            }
                        }
                        _ =&gt; {
                            let ty = assign.value.inferred_type(&amp;self.model);
                            self.add_hint(target.range(), ty);
                        }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_ide/src/inlay_hints.rs</code>:152 on 2025-04-07 08:09</div>
            <div class="timeline-body"><p>Could we use <code>Diagnostic</code> rendering with inline <code>insta</code> snapshots here similar to the goto type definition and on-hover tests? Tests with text ranges are always very hard to read and the diagnostic rendering can help because it visualizes the ranges (much easier to spot errors)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2025-04-07 08:10</div>
            <div class="timeline-body"><p>This is great. We should respect the range provided by the editor and I don't think the options approach is what we want, let's remove that for now and always enable inlay hints.</p>
<p>Could you update the test plan with a recording of the playground and LSP?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-04-07 08:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_server/src/server/api/requests/inlay_hints.rs</code>:42 on 2025-04-07 08:21</div>
            <div class="timeline-body"><p>Okay, ill just completely remove the options</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-07 08:51</div>
            <div class="timeline-body"><p>I might not be able to get to this for the rest of the day, if you want to have a go at updating the tests or the range then go for it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-07 09:19</div>
            <div class="timeline-body"><blockquote>
<p>I might not be able to get to this for the rest of the day, if you want to have a go at updating the tests or the range then go for it!</p>
</blockquote>
<p>There's no hurry and the chances for merge conflicts are very low. Take your time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Add (optional) inlay type hints" to "[red-knot] Add inlay type hints" by @MatthewMckee4 on 2025-04-07 12:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-04-08 14:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_ide/src/inlay_hints.rs</code>:93 on 2025-04-08 14:47</div>
            <div class="timeline-body"><p>I think this unpacking will only work for the top-level tuple and not for nested unpacking like <code>(a, (b, c)) = (1, (2, 3))</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-04-08 14:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_ide/src/inlay_hints.rs</code>:93 on 2025-04-08 14:51</div>
            <div class="timeline-body"><p>You might need to recursively call <code>visit_expr</code> and add the hint at <code>Expr::Name</code> node which should solve this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_ide/src/inlay_hints.rs</code>:93 on 2025-04-08 14:53</div>
            <div class="timeline-body"><p>thats true, ill look into this more</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-04-08 14:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_ide/src/inlay_hints.rs</code>:98 on 2025-04-09 06:52</div>
            <div class="timeline-body"><p>I wonder if we could use the same approach as in <code>SemanticIndexBuilder</code> where we have a state variable on <code>InlayHintVisitor</code> indicating if it is currently visiting an assignment.</p>
<p>Then, inside <code>visit_expr</code>, add an inlay hint for every <code>ExprName</code> in a <code>Store</code> context.</p>
<p>This has the benefit that the visitor doesn't traverse the assignment targets multiple times.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_ide/src/inlay_hints.rs</code>:79 on 2025-04-09 06:53</div>
            <div class="timeline-body"><p>NIt: <code>add_assign_statement_hint</code> or should we instead rename the <code>InlayHintContent</code> variant<code>to</code>Type<code>and</code>ReturnType<code>and rename this method</code>add_type_hint<code>and add another</code>add_return_type_hint`. I think I'd like those variant names better.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_ide/src/inlay_hints.rs</code>:104 on 2025-04-09 06:53</div>
            <div class="timeline-body"><p>You don't need this. <code>enter_node</code> gets called by <code>walk_stmt</code></p>
<pre><code class="language-suggestion"></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_ide/src/inlay_hints.rs</code>:197 on 2025-04-09 06:55</div>
            <div class="timeline-body"><p>Oh, I like how you render the &quot;hints&quot; inline!</p>
<p>I'm happy to go with this for now. An alternative would be to use the <code>Diagnostic</code> again and render an <code>annotation</code> at <code>hint.range.end</code> where the primary message is the hinted type.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_ide/src/inlay_hints.rs</code>:14 on 2025-04-09 06:56</div>
            <div class="timeline-body"><p>Could this just be a <code>TextSize</code>? It seems all usages use <code>range.end</code> always</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_ide/src/inlay_hints.rs</code>:207 on 2025-04-09 06:59</div>
            <div class="timeline-body"><p>Nit: You could use <code>&lt;START&gt;</code> and <code>&lt;END&gt;</code> end markers to indicate the range in the text file and default to the entire range if both the <code>SOURCE</code> and <code>END</code> markers are missing</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_server/src/server/api/requests/inlay_hints.rs</code>:49 on 2025-04-09 07:01</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        let range = params
            .range
            .to_text_range(&amp;source, &amp;index, snapshot.encoding());

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_wasm/src/lib.rs</code>:379 on 2025-04-09 07:02</div>
            <div class="timeline-body"><p>I don't think this is needed, unless you want the JS client to create <code>Range</code> instances.</p>
<p>For the rust code, using <code>Range { start, end }</code> should do it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_wasm/src/lib.rs</code>:428 on 2025-04-09 07:04</div>
            <div class="timeline-body"><p>We should make this return a <code>Result</code> instead of panicking if the line number is one indexed.</p>
<p>We can then also use it on line 261, and 219</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-09 07:05</div>
            <div class="timeline-body"><p>This looks good. I've a few smaller nit comments that would be great to address beforehand.</p>
<p>Please, also updated your PR summary with a test plan for both playground and the vs code extension (record a short video, similar to what I did with on hover)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-04-09 09:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_ide/src/inlay_hints.rs</code>:104 on 2025-04-09 09:06</div>
            <div class="timeline-body"><p>True, but walk_stmt is not called as we override visit_stmt. The last test fails if I remove this line</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_ide/src/inlay_hints.rs</code>:98 on 2025-04-09 09:19</div>
            <div class="timeline-body"><p>I believe we only traverse (and call inferred_type) on assignments like</p>
<pre><code class="language-py">a = b = 1
</code></pre>
<blockquote>
<p>Then, inside visit_expr, add an inlay hint for every ExprName in a Store context.</p>
</blockquote>
<p>How would we get the type in visit_expr?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-04-09 09:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_wasm/src/lib.rs</code>:379 on 2025-04-09 09:29</div>
            <div class="timeline-body"><p>i dont think it was working as it was doing some sort of instance check on range</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-04-09 09:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @carljm on 2025-04-09 15:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-04-09 16:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_ide/src/inlay_hints.rs</code>:197 on 2025-04-09 16:10</div>
            <div class="timeline-body"><p>I think I've a slight preference to using diagnostics but that doesn't need to block this PR and can be done as a follow-up. My main reasoning is that other developers would need to look at both the test and the implementation to understand that the test infra adds the brackets (<code>[]</code>) and the implementation adds the <code>:</code> and <code>-&gt;</code>. The diagnostics has the benefit to say that &quot;here is where this hint will be added&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @sharkdp on 2025-04-09 17:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-04-10 09:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-04-10 09:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-04-10 09:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-19 13:58</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:33:28 UTC
    </footer>
</body>
</html>
