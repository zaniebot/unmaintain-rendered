<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`refurb`] Preserve argument ordering in autofix (`FURB103`) - astral-sh/ruff #20790</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>refurb</code>] Preserve argument ordering in autofix (<code>FURB103</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20790">#20790</a>
        opened by <a href="https://github.com/chirizxc">@chirizxc</a>
        on 2025-10-09 15:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/chirizxc">@chirizxc</a> on 2025-10-09 15:47</div>
            <div class="timeline-body"><p>Fixes https://github.com/astral-sh/ruff/issues/20785</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-09 16:00</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>‚ÑπÔ∏è ecosystem check <strong>detected linter changes</strong>. (+9 -9 violations, +0 -0 fixes in 1 projects; 54 projects unchanged)</p>
<details><summary><a href="https://github.com/bokeh/bokeh">bokeh/bokeh</a> (+9 -9 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/models/buttons.py#L75'>examples/models/buttons.py:75:10:</a> FURB103 [*] `open` and `write` should be replaced by `Path(filename).write_text(file_html(doc, title="Button widgets"))`
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/models/buttons.py#L75'>examples/models/buttons.py:75:10:</a> FURB103 [*] `open` and `write` should be replaced by `Path(filename).write_text(file_html(title="Button widgets", doc))`
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/models/calendars.py#L104'>examples/models/calendars.py:104:10:</a> FURB103 [*] `open` and `write` should be replaced by `Path(filename).write_text(file_html(doc, title="Calendar 2014"))`
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/models/calendars.py#L104'>examples/models/calendars.py:104:10:</a> FURB103 [*] `open` and `write` should be replaced by `Path(filename).write_text(file_html(title="Calendar 2014", doc))`
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/models/daylight.py#L107'>examples/models/daylight.py:107:10:</a> FURB103 [*] `open` and `write` should be replaced by `Path(filename).write_text(file_html(doc, title="Daylight Plot"))`
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/models/daylight.py#L107'>examples/models/daylight.py:107:10:</a> FURB103 [*] `open` and `write` should be replaced by `Path(filename).write_text(file_html(title="Daylight Plot", doc))`
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/models/gauges.py#L110'>examples/models/gauges.py:110:10:</a> FURB103 [*] `open` and `write` should be replaced by `Path(filename).write_text(file_html(doc, title="Gauges"))`
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/models/gauges.py#L110'>examples/models/gauges.py:110:10:</a> FURB103 [*] `open` and `write` should be replaced by `Path(filename).write_text(file_html(title="Gauges", doc))`
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/models/glyphs.py#L115'>examples/models/glyphs.py:115:10:</a> FURB103 [*] `open` and `write` should be replaced by `Path(filename).write_text(file_html(doc, title="Glyphs"))`
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/models/glyphs.py#L115'>examples/models/glyphs.py:115:10:</a> FURB103 [*] `open` and `write` should be replaced by `Path(filename).write_text(file_html(title="Glyphs", doc))`
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/models/sliders.py#L74'>examples/models/sliders.py:74:10:</a> FURB103 [*] `open` and `write` should be replaced by `Path(filename).write_text(file_html(doc, title="sliders"))`
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/models/sliders.py#L74'>examples/models/sliders.py:74:10:</a> FURB103 [*] `open` and `write` should be replaced by `Path(filename).write_text(file_html(title="sliders", doc))`
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/models/twin_axis.py#L57'>examples/models/twin_axis.py:57:10:</a> FURB103 [*] `open` and `write` should be replaced by `Path(filename).write_text(file_html(doc, title="Twin Axis Plot"))`
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/models/twin_axis.py#L57'>examples/models/twin_axis.py:57:10:</a> FURB103 [*] `open` and `write` should be replaced by `Path(filename).write_text(file_html(title="Twin Axis Plot", doc))`
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/models/widgets.py#L299'>examples/models/widgets.py:299:10:</a> FURB103 [*] `open` and `write` should be replaced by `Path(filename).write_text(file_html(doc, title="Widgets"))`
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/models/widgets.py#L299'>examples/models/widgets.py:299:10:</a> FURB103 [*] `open` and `write` should be replaced by `Path(filename).write_text(file_html(title="Widgets", doc))`
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/output/apis/file_html.py#L122'>examples/output/apis/file_html.py:122:10:</a> FURB103 [*] `open` and `write` should be replaced by `Path(filename).write_text(file_html(doc, title=plot.title.text))`
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/output/apis/file_html.py#L122'>examples/output/apis/file_html.py:122:10:</a> FURB103 [*] `open` and `write` should be replaced by `Path(filename).write_text(file_html(title=plot.title.text, doc))`
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| FURB103 | 18 | 9 | 9 | 0 | 0 |</p>
</p>
</details>

<h3>Formatter (stable)</h3>
<p>‚úÖ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>‚úÖ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ntBre on 2025-10-09 16:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @ntBre on 2025-10-09 16:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/refurb/rules/write_whole_file.rs</code>:176 on 2025-10-09 17:26</div>
            <div class="timeline-body"><p>If I'm following this correctly, the bug is that we're relocating the argument to a function call within the <code>f.write</code> call when we're supposed to be relocating the argument to <code>f.write</code> itself. Is that accurate?</p>
<p>If so, it seems like the root problem might actually be the <code>arg</code> we're passing here and extracting in <code>match_write_call</code>. It doesn't seem like we should be rewriting the arguments to <code>json.dumps</code> at all.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-10-09 17:27</div>
            <div class="timeline-body"><p>Wow, thank you! I should have noticed this in the ecosystem check from the previous PR. Thanks for following up!</p>
<p>This fix obviously works and even seems a bit simpler than the old code, but I'm a bit confused how we were ending up in this state.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/chirizxc">@chirizxc</a> reviewed on 2025-10-09 17:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/chirizxc">@chirizxc</a> on <code>crates/ruff_linter/src/rules/refurb/rules/write_whole_file.rs</code>:176 on 2025-10-09 17:49</div>
            <div class="timeline-body"><p>I didn't quite get it, but in <code>make_suggestion</code> we actually just cut the source code for the argument (locator.slice(arg.range())) and put it directly, condition with open.keywords is needed to keep all arguments with names that were passed to the original open(...)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @MichaReiser on 2025-10-12 06:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-13 08:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/refurb/rules/write_whole_file.rs</code>:176 on 2025-10-13 08:05</div>
            <div class="timeline-body"><p>The issue here is that the generator emits the arguments (and keyword arguments) in source order. See here</p>
<p>https://github.com/astral-sh/ruff/blob/48ada2d359b7c985454f4ac7ae7f23d1e980865a/crates/ruff_python_codegen/src/generator.rs#L1191-L1209</p>
<p>This is obviously very surprising and probably another reason why we should change <code>arguments</code> to be a single vec containing both keywoard and normal arguments, so that we don't have to do this guessing game inside generator.</p>
<p>For this rule, I think the fix is to use a more proper range for <code>arg</code> that isn't <code>TextRange::default</code> and ensures that the argument comes in the right order.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/chirizxc">@chirizxc</a> reviewed on 2025-10-13 12:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/chirizxc">@chirizxc</a> on <code>crates/ruff_linter/src/rules/refurb/rules/write_whole_file.rs</code>:176 on 2025-10-13 12:31</div>
            <div class="timeline-body"><blockquote>
<p>The issue here is that the generator emits the arguments (and keyword arguments) in source order. See here</p>
<p>https://github.com/astral-sh/ruff/blob/48ada2d359b7c985454f4ac7ae7f23d1e980865a/crates/ruff_python_codegen/src/generator.rs#L1191-L1209</p>
<p>This is obviously very surprising and probably another reason why we should change <code>arguments</code> to be a single vec containing both keywoard and normal arguments, so that we don't have to do this guessing game inside generator.</p>
<p>For this rule, I think the fix is to use a more proper range for <code>arg</code> that isn't <code>TextRange::default</code> and ensures that the argument comes in the right order.</p>
</blockquote>
<p>I think this solution should be optimal, since we get rid of AST transformations and <code>arg.clone()</code>, and we also preserve the original spaces, please correct if this is wrong</p>
<p><img width="1894" height="555" alt="–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" src="https://github.com/user-attachments/assets/b6f08af2-4423-48f8-b374-9e0b125e4908" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-20 08:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/refurb/rules/write_whole_file.rs</code>:176 on 2025-10-20 08:22</div>
            <div class="timeline-body"><p>I agree that it ensures that we preserve the formatting. My main concern is that switching from AST to text edits often leads to introducing different bugs (e.g. where precedence changes, the precense of comments or trailing commas or something else leads to invalid syntax). That's why I prefer to keep fixes as minimal as possible, to reduce the risk of breaking something else. In this case, this would mean to stick to AST based edits.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-10-20 16:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/refurb/rules/write_whole_file.rs</code>:176 on 2025-10-20 16:02</div>
            <div class="timeline-body"><p>I agree with Micha, I'd at least like to try improving the <code>arg</code> we're passing here before taking the current approach. It still feels like we're just addressing the symptom, but the underlying cause could still cause other problems and is confusing anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/chirizxc">@chirizxc</a> on <code>crates/ruff_linter/src/rules/refurb/rules/write_whole_file.rs</code>:176 on 2025-10-23 21:16</div>
            <div class="timeline-body"><blockquote>
<p>I agree with Micha, I'd at least like to try improving the <code>arg</code> we're passing here before taking the current approach. It still feels like we're just addressing the symptom, but the underlying cause could still cause other problems and is confusing anyway.</p>
</blockquote>
<p>I tried several times with the previous version, but nothing works.</p>
<p>When we call <code>relocate_expr(&amp;mut arg, ...)</code> on a complex nested expression like <code>json.dumps(data, indent=4).encode(&quot;utf-8&quot;)</code>, the function recursively updates ALL nested nodes while preserving their relative positions. This means:</p>
<ul>
<li>The outer .encode() call gets relocated to range [0, arg_len)</li>
<li>The inner <code>json.dumps(...)</code> call gets a range within [0, X) where X &lt; arg_len</li>
<li>Arguments inside <code>json.dumps</code>: data gets [Y, Z), indent=4 gets [A, B) - all within the relocated range.</li>
</ul>
<p><code>arguments_source_order()</code> sorts ALL arguments from ALL function calls in the entire AST tree by their TextRange::start() position . Since the nested indent=4 keyword has a smaller start offset than data in the original source, it remains before data even after relocation, producing invalid syntax: json.dumps(indent=4, data).</p>
<p>I understood it this way, maybe I'm wrongü§∑‚Äç‚ôÇÔ∏è</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/chirizxc">@chirizxc</a> reviewed on 2025-10-23 21:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-10-30 22:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/refurb/rules/write_whole_file.rs</code>:176 on 2025-10-30 22:20</div>
            <div class="timeline-body"><p>Thanks for writing this up! I took a look today, and I think you're right. <code>relocate_expr</code> doesn't just shift the <code>json.dumps</code> call, it recurses and relocates all of the child nodes, including all of its arguments. All of the inputs are correct here, but any range we pass to <code>relocate_expr</code> will have the same issue.</p>
<p>One thing that seems to help is to make the comparison in <code>arguments_source_order</code> <code>&lt;=</code> instead of just <code>&lt;</code>. I think that should avoid reordering equal elements, as we have here after <code>relocate_expr</code>. That worked locally for me with no other regressions after reverting the other non-test changes in this PR.</p>
<p>Other than that, I think we would need a non-recursive variant of <code>relocate_expr</code>. The only other use of <code>relocate_expr</code> is for relocating type expressions that we parse from strings, which seems a bit different and might actually need the recursion (https://github.com/astral-sh/ruff/pull/133).</p>
<details><summary>Patch (mostly revert + one character in nodes.rs)</summary>
<p>

<pre><code class="language-diff">diff --git a/crates/ruff_linter/src/rules/refurb/rules/write_whole_file.rs b/crates/ruff_linter/src/rules/refurb/rules/write_whole_file.rs
index b46008ff8c..bbee6dcb5a 100644
--- a/crates/ruff_linter/src/rules/refurb/rules/write_whole_file.rs
+++ b/crates/ruff_linter/src/rules/refurb/rules/write_whole_file.rs
@@ -2,15 +2,18 @@ use ruff_diagnostics::{Applicability, Edit, Fix};
 use ruff_macros::{ViolationMetadata, derive_message_formats};
 use ruff_python_ast::{
     self as ast, Expr, Stmt,
+    relocate::relocate_expr,
     visitor::{self, Visitor},
 };
-use ruff_text_size::Ranged;
+
+use ruff_python_codegen::Generator;
+use ruff_text_size::{Ranged, TextRange};
 
 use crate::checkers::ast::Checker;
 use crate::fix::snippet::SourceCodeSnippet;
 use crate::importer::ImportRequest;
 use crate::rules::refurb::helpers::{FileOpen, find_file_opens};
-use crate::{FixAvailability, Locator, Violation};
+use crate::{FixAvailability, Violation};
 
 /// ## What it does
 /// Checks for uses of `open` and `write` that can be replaced by `pathlib`
@@ -127,7 +130,7 @@ impl&lt;'a&gt; Visitor&lt;'a&gt; for WriteMatcher&lt;'a, '_&gt; {
                 let open = self.candidates.remove(open);
 
                 if self.loop_counter == 0 {
-                    let suggestion = make_suggestion(&amp;open, content, self.checker.locator());
+                    let suggestion = make_suggestion(&amp;open, content, self.checker.generator());
 
                     let mut diagnostic = self.checker.report_diagnostic(
                         WriteWholeFile {
@@ -163,6 +166,7 @@ fn match_write_call(expr: &amp;Expr) -&gt; Option&lt;(&amp;Expr, &amp;Expr)&gt; {
     let method_name = &amp;attr.attr;
 
     if method_name != &quot;write&quot;
+        || !attr.value.is_name_expr()
         || call.arguments.args.len() != 1
         || !call.arguments.keywords.is_empty()
     {
@@ -173,21 +177,27 @@ fn match_write_call(expr: &amp;Expr) -&gt; Option&lt;(&amp;Expr, &amp;Expr)&gt; {
     Some((&amp;*attr.value, call.arguments.args.first()?))
 }
 
-fn make_suggestion(open: &amp;FileOpen&lt;'_&gt;, arg: &amp;Expr, locator: &amp;Locator) -&gt; String {
-    let method_name = open.mode.pathlib_method();
-    let arg_code = locator.slice(arg.range());
-
-    if open.keywords.is_empty() {
-        format!(&quot;{method_name}({arg_code})&quot;)
-    } else {
-        format!(
-            &quot;{method_name}({arg_code}, {})&quot;,
-            itertools::join(
-                open.keywords.iter().map(|kw| locator.slice(kw.range())),
-                &quot;, &quot;
-            )
-        )
-    }
+fn make_suggestion(open: &amp;FileOpen&lt;'_&gt;, arg: &amp;Expr, generator: Generator) -&gt; String {
+    let name = ast::ExprName {
+        id: open.mode.pathlib_method(),
+        ctx: ast::ExprContext::Load,
+        range: TextRange::default(),
+        node_index: ruff_python_ast::AtomicNodeIndex::NONE,
+    };
+    let mut arg = arg.clone();
+    relocate_expr(&amp;mut arg, TextRange::default());
+    let call = ast::ExprCall {
+        func: Box::new(name.into()),
+        arguments: ast::Arguments {
+            args: Box::new([arg]),
+            keywords: open.keywords.iter().copied().cloned().collect(),
+            range: TextRange::default(),
+            node_index: ruff_python_ast::AtomicNodeIndex::NONE,
+        },
+        range: TextRange::default(),
+        node_index: ruff_python_ast::AtomicNodeIndex::NONE,
+    };
+    generator.expr(&amp;call.into())
 }
 
 fn generate_fix(
diff --git a/crates/ruff_python_ast/src/nodes.rs b/crates/ruff_python_ast/src/nodes.rs
index f71f420d09..5cb58e7f05 100644
--- a/crates/ruff_python_ast/src/nodes.rs
+++ b/crates/ruff_python_ast/src/nodes.rs
@@ -3372,7 +3372,7 @@ impl Arguments {
     pub fn arguments_source_order(&amp;self) -&gt; impl Iterator&lt;Item = ArgOrKeyword&lt;'_&gt;&gt; {
         let args = self.args.iter().map(ArgOrKeyword::Arg);
         let keywords = self.keywords.iter().map(ArgOrKeyword::Keyword);
-        args.merge_by(keywords, |left, right| left.start() &lt; right.start())
+        args.merge_by(keywords, |left, right| left.start() &lt;= right.start())
     }
 
     pub fn inner_range(&amp;self) -&gt; TextRange {
</code></pre>
</p>
</details> 

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-10-31 15:14</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @ntBre on 2025-10-31 15:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`refurb`] Fix `FURB103` fixes" to "[`refurb`] Preserve argument ordering in autofix (`FURB103`)" by @ntBre on 2025-10-31 15:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-10-31 15:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-10-31 15:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-10-31 15:35</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:00:12 UTC
    </footer>
</body>
</html>
