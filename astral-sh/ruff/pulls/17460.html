<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[syntax-errors] Make `async-comprehension-in-sync-comprehension` more specific - astral-sh/ruff #17460</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[syntax-errors] Make <code>async-comprehension-in-sync-comprehension</code> more specific</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17460">#17460</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-04-18 14:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-18 14:08</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>While adding semantic error support to red-knot, I noticed duplicate diagnostics for code like this:</p>
<pre><code class="language-py"># error: [invalid-syntax] &quot;cannot use an asynchronous comprehension outside of an asynchronous function on Python 3.9 (syntax was added in 3.11)&quot;
# error: [invalid-syntax] &quot;`asynchronous comprehension` outside of an asynchronous function&quot;
 [reveal_type(x) async for x in AsyncIterable()]
</code></pre>
<p>Beyond the duplication, the first error message doesn't make much sense because this syntax is <em>not</em> allowed on Python 3.11 either.</p>
<p>To fix this, this PR renames the <code>async-comprehension-outside-async-function</code> semantic syntax error to <code>async-comprehension-in-sync-comprehension</code> and fixes the rule to avoid applying outside of sync comprehensions at all.</p>
<h2>Test Plan</h2>
<p>New linter test demonstrating the false positive. The mdtests I'm updating in my red-knot PR will also reflect this change eventually.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ntBre on 2025-04-18 14:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-18 14:18</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @ntBre on 2025-04-18 14:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @ntBre on 2025-04-18 14:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @ntBre on 2025-04-18 14:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-04-21 19:02</div>
            <div class="timeline-body"><p>I think the error message is a bit misleading. It suggests that an asynchronous comprehension can be used in a synchronous comprehension from Python 3.11 but that's not actually true.</p>
<pre><code class="language-py">[[x async for x in foo(n)] for n in range(3)]
</code></pre>
<p>The following raises error for both &lt;3.11 and 3.11+</p>
<p>The user actually need to include it in an async function for it to be considered valid:</p>
<pre><code class="language-py">async def _():
	[[x async for x in foo(n)] for n in range(3)]
</code></pre>
<p>I'm running this via <code>python -m compileall</code>.</p>
<p>I might be misunderstanding what's being changed here so feel free to correct me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-21 19:27</div>
            <div class="timeline-body"><p>I see what you mean, but that case will lead to a separate <code>AwaitOutsideAsyncFunction</code> error, as shown in the PR summary. Do you think the error message for this variant also needs to be extended to mention the function, or will the second error clarify things enough?</p>
<p>If it needs to be extended, do you have any suggestions? I was afraid the message was quite long already.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-04-22 14:47</div>
            <div class="timeline-body"><blockquote>
<pre><code class="language-python"># error: [invalid-syntax] &quot;`asynchronous comprehension` outside of an asynchronous function&quot;
</code></pre>
</blockquote>
<p>Is this the error message that's removed in this PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-04-22 14:50</div>
            <div class="timeline-body"><p>Testing this out locally for a few snippets, it seems good but I think we can still improve this. I'm not sure how but multi-span diagnostics is one way to go to provide additional context.</p>
<p>I don't have a good suggestion for improving the error message, maybe something like:</p>
<pre><code>SyntaxError: cannot use an asynchronous comprehension inside of a synchronous scope created by the outer comprehension on Python 3.9 (syntax was added in 3.11)
</code></pre>
<p>Maybe @AlexWaygood has a better recommendation?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-22 14:59</div>
            <div class="timeline-body"><p>No, the top one (<code>cannot use an asynchronous comprehension outside of an asynchronous function on Python 3.9 (syntax was added in 3.11)</code>) is removed in this PR. The second message (<code>asynchronous comprehension outside of an asynchronous function</code>) is a separate <code>SemanticSyntaxError</code> entirely and will still be emitted in this example.</p>
<p>I don't think I explained this very well in the PR summary, looking back at it now. I'm doing two unrelated things in this PR:</p>
<ul>
<li>removing the false positive for <code>async</code> comprehensions <em>not</em> in sync comprehensions (a bug in the implementation)</li>
<li>updating the naming of the variant and error message to better reflect the error</li>
</ul>
<p>I only added a new test for the first of these, which probably made it even less clear what was changing in the code. Sorry!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @ntBre on 2025-04-24 16:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @ntBre on 2025-04-24 16:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @ntBre on 2025-04-24 16:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @ntBre on 2025-04-24 16:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-04-24 16:24</div>
            <div class="timeline-body"><p>I'm resolving the merge conflicts now. Just as one additional data point, the CPython error message for this is also quite poor:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; async def f(): [[x async for x in []] for x in []]
...
  File &quot;&lt;stdin&gt;&quot;, line 1
SyntaxError: asynchronous comprehension outside of an asynchronous function
</code></pre>
<p>That's not an excuse for ours to be bad too, but I do think</p>
<pre><code>SyntaxError: cannot use an asynchronous comprehension inside of a synchronous comprehension
</code></pre>
<p>is already a pretty good improvement over the current message in ruff and over Python's message.</p>
<p>I personally prefer this to the suggestion above too, but I don't feel strongly about it. If nobody else feels strongly, I'll just merge this for now, and we can tweak the message later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-24 16:27</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-04-24 19:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-04-24 19:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-24 19:45</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:33:28 UTC
    </footer>
</body>
</html>
