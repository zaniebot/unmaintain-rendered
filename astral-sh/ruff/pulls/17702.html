<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Fix control flow for `assert` statements - astral-sh/ruff #17702</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Fix control flow for <code>assert</code> statements</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17702">#17702</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-04-29 10:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>@sharkdp and I realised in our 1:1 this morning that our control flow for <code>assert</code> statements isn't quite accurate at the moment. Namely, for something like this:</p>
<pre><code class="language-py">def _(x: int | None):
    assert x is None, reveal_type(x)
</code></pre>
<p>we currently reveal <code>None</code> for <code>x</code> here, but this is incorrect. In actual fact, the <code>msg</code> expression of an <code>assert</code> statement (the expression after the comma) will only be evaluated if the test (<code>x is None</code>) evaluates to <code>False</code>. As such, we should be adding a constraint of <code>~None</code> to <code>x</code> in the <code>msg</code> expression, which should simplify the inferred type of <code>x</code> to <code>int</code> in that context (<code>(int | None) &amp; ~None</code> -&gt; <code>int</code>).</p>
<h2>Test Plan</h2>
<p>Mdtests added.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-04-29 10:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-04-29 10:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-04-29 10:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @AlexWaygood on 2025-04-29 10:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-29 10:58</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">PyWinCtl (https://github.com/Kalmat/PyWinCtl)
- error[lint:unresolved-import] src/pywinctl/_pywinctl_macos.py:21:8: Cannot resolve import `AppKit`
- error[lint:unresolved-import] src/pywinctl/_pywinctl_macos.py:22:8: Cannot resolve import `Quartz`
- error[lint:unresolved-import] src/pywinctl/_pywinctl_macos.py:25:6: Cannot resolve import `pywinbox`
- error[lint:unresolved-import] src/pywinctl/_pywinctl_macos.py:25:6: Cannot resolve import `pywinbox`
- error[lint:unresolved-import] src/pywinctl/_pywinctl_macos.py:25:6: Cannot resolve import `pywinbox`
- error[lint:unresolved-import] src/pywinctl/_pywinctl_macos.py:25:6: Cannot resolve import `pywinbox`
- error[lint:invalid-type-form] src/pywinctl/_pywinctl_macos.py:28:13: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] src/pywinctl/_pywinctl_macos.py:29:12: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] src/pywinctl/_pywinctl_macos.py:68:35: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] src/pywinctl/_pywinctl_macos.py:120:29: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] src/pywinctl/_pywinctl_macos.py:168:109: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] src/pywinctl/_pywinctl_macos.py:379:60: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] src/pywinctl/_pywinctl_macos.py:379:90: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] src/pywinctl/_pywinctl_macos.py:396:62: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] src/pywinctl/_pywinctl_macos.py:396:96: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] src/pywinctl/_pywinctl_macos.py:421:31: Variable of type `Never` is not allowed in a type expression
- warning[lint:possibly-unresolved-reference] src/pywinctl/_pywinctl_macos.py:1546:54: Name `hSubMenu` used when possibly not defined
- error[lint:unresolved-import] src/pywinctl/_pywinctl_win.py:28:6: Cannot resolve import `pywinbox`
- error[lint:unresolved-import] src/pywinctl/_pywinctl_win.py:28:6: Cannot resolve import `pywinbox`
- error[lint:unresolved-import] src/pywinctl/_pywinctl_win.py:28:6: Cannot resolve import `pywinbox`
- error[lint:unresolved-import] src/pywinctl/_pywinctl_win.py:28:6: Cannot resolve import `pywinbox`
- error[lint:invalid-type-form] src/pywinctl/_pywinctl_win.py:48:35: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] src/pywinctl/_pywinctl_win.py:74:29: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] src/pywinctl/_pywinctl_win.py:109:146: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] src/pywinctl/_pywinctl_win.py:286:42: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] src/pywinctl/_pywinctl_win.py:301:48: Variable of type `Never` is not allowed in a type expression
- error[lint:unresolved-attribute] src/pywinctl/_pywinctl_win.py:314:16: Type `&lt;module 'ctypes'&gt;` has no attribute `windll`
- error[lint:unresolved-attribute] src/pywinctl/_pywinctl_win.py:366:9: Type `&lt;module 'ctypes'&gt;` has no attribute `windll`
- error[lint:unresolved-attribute] src/pywinctl/_pywinctl_win.py:371:9: Type `&lt;module 'ctypes'&gt;` has no attribute `windll`
- error[lint:invalid-type-form] src/pywinctl/_pywinctl_win.py:453:69: Variable of type `Never` is not allowed in a type expression
- error[lint:unresolved-attribute] src/pywinctl/_pywinctl_win.py:461:9: Type `&lt;module 'ctypes'&gt;` has no attribute `windll`
- error[lint:unresolved-attribute] src/pywinctl/_pywinctl_win.py:521:27: Type `&lt;module 'ctypes'&gt;` has no attribute `windll`
- error[lint:unresolved-attribute] src/pywinctl/_pywinctl_win.py:522:27: Type `&lt;module 'ctypes'&gt;` has no attribute `windll`
- Found 83 diagnostics
+ Found 50 diagnostics

graphql-core (https://github.com/graphql-python/graphql-core)
- warning[lint:possibly-unresolved-reference] tests/execution/test_map_async_iterable.py:274:19: Name `anext` used when possibly not defined
- Found 734 diagnostics
+ Found 733 diagnostics

optuna (https://github.com/optuna/optuna)
- error[lint:invalid-type-form] tests/pruners_tests/test_successive_halving.py:116:26: Variable of type `Never` is not allowed in a type expression
- Found 2432 diagnostics
+ Found 2431 diagnostics

apprise (https://github.com/caronc/apprise)
- error[lint:unresolved-attribute] test/test_apprise_config.py:467:20: Type `Literal[ConfigBase]` has no attribute `parse_url`
- Found 3597 diagnostics
+ Found 3596 diagnostics

rotki (https://github.com/rotki/rotki)
- warning[lint:unresolved-reference] rotkehlchen/tests/unit/test_ethereum_inquirer.py:425:9: Name `etherscan_tx_or_tx_receipt_calls` used when not defined
- Found 3396 diagnostics
+ Found 3395 diagnostics

dd-trace-py (https://github.com/DataDog/dd-trace-py)
- error[lint:invalid-type-form] ddtrace/internal/bytecode_injection/core.py:30:20: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] ddtrace/internal/bytecode_injection/core.py:31:11: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] ddtrace/internal/bytecode_injection/core.py:34:30: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] ddtrace/internal/bytecode_injection/core.py:42:42: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] ddtrace/internal/bytecode_injection/core.py:156:24: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] ddtrace/internal/bytecode_injection/core.py:383:11: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] ddtrace/internal/bytecode_injection/core.py:399:11: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] ddtrace/internal/bytecode_injection/core.py:485:11: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] ddtrace/internal/bytecode_injection/core.py:590:11: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] ddtrace/internal/coverage/instrumentation_py3_10.py:15:32: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] ddtrace/internal/coverage/instrumentation_py3_10.py:15:48: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] ddtrace/internal/coverage/instrumentation_py3_11.py:37:57: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] ddtrace/internal/coverage/instrumentation_py3_11.py:55:31: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] ddtrace/internal/coverage/instrumentation_py3_11.py:55:49: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] ddtrace/internal/coverage/instrumentation_py3_11.py:68:53: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] ddtrace/internal/coverage/instrumentation_py3_11.py:122:11: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] ddtrace/internal/coverage/instrumentation_py3_11.py:193:33: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] ddtrace/internal/coverage/instrumentation_py3_11.py:207:47: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] ddtrace/internal/coverage/instrumentation_py3_11.py:251:32: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] ddtrace/internal/coverage/instrumentation_py3_11.py:251:48: Variable of type `Never` is not allowed in a type expression
- warning[lint:possibly-unresolved-reference] ddtrace/internal/coverage/instrumentation_py3_11.py:445:30: Name `ext_instr` used when possibly not defined
- error[lint:invalid-type-form] ddtrace/internal/coverage/instrumentation_py3_12.py:27:32: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] ddtrace/internal/coverage/instrumentation_py3_12.py:27:48: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] ddtrace/internal/coverage/instrumentation_py3_12.py:40:31: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] ddtrace/internal/coverage/instrumentation_py3_12.py:40:55: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] ddtrace/internal/coverage/instrumentation_py3_12.py:59:11: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] ddtrace/internal/coverage/instrumentation_py3_12.py:59:27: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] ddtrace/internal/coverage/instrumentation_py3_13.py:21:32: Variable of type `Never` is not allowed in a type expression
- error[lint:invalid-type-form] ddtrace/internal/coverage/instrumentation_py3_13.py:21:48: Variable of type `Never` is not allowed in a type expression
- Found 7030 diagnostics
+ Found 7001 diagnostics

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-04-29 13:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:1374 on 2025-04-29 13:11</div>
            <div class="timeline-body"><p>I'm trying to understand why it is correct to take this snapshot after visiting the expression? Should it also be renamed to <code>post_test</code> or <code>pre_msg</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-04-29 13:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/assert.md</code>:114 on 2025-04-29 13:11</div>
            <div class="timeline-body"><p>Can we also add a test for visibility constraint handling? For example:</p>
<pre><code class="language-py">assert True, (x := 1)

# error: [unresolved-reference]
x
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-29 13:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:1374 on 2025-04-29 13:27</div>
            <div class="timeline-body"><p>Ah, great point. Yes, this is a snapshot of the state after we've visited the <code>test</code> but before we've visited the <code>msg</code>. It's the state we need to return to after we've visited the <code>msg</code>, since all code following the <code>assert</code> statement can only be reached if <code>test</code> evaluated to <code>True</code> (which means that the <code>msg</code> expression would not have been evaluated). I'll rename the variable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/assert.md</code>:114 on 2025-04-29 13:28</div>
            <div class="timeline-body"><p>Isn't that what I test in the <code>one()</code> function in the <code>## Assertions with definitions inside the message</code> section?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-29 13:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-29 13:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/assert.md</code>:114 on 2025-04-29 13:28</div>
            <div class="timeline-body"><p>Oh, no, I see what you mean, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> approved on 2025-04-29 13:35</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-04-29 13:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/assert.md</code>:114 on 2025-04-29 13:38</div>
            <div class="timeline-body"><p>I should have explained that better... the idea would be to have a test that has a statically known test condition. Seeing that <code>unresolved-reference</code> error there gives us certainty that the <code>x := 1</code> binding has a visibility constraint on it that evaluates to <code>AlwaysFalse</code>. Improper handling would lead to &quot;possibly-unresolved-reference&quot; or no error at all.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-29 13:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/assert.md</code>:114 on 2025-04-29 13:50</div>
            <div class="timeline-body"><p>yes, it looks like we did indeed have some false-positive <code>unresolved-reference</code> diagnostics in unreachable code. Mind double-checking the reachability constraints I added in https://github.com/astral-sh/ruff/pull/17702/commits/c8e3145534e3dfd20ab987c92cafcb891d46fa8f to fix them? I'm not very familiar with the reachability-constraint handling we have</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-04-29 13:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @AlexWaygood on 2025-04-29 13:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @carljm on 2025-04-29 13:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-29 17:00</div>
            <div class="timeline-body"><p>Oh, it looks like https://github.com/astral-sh/ruff/pull/17702/commits/56fa086bfa0925fb42c92caec7b82403afd660da introduced lots of new mypy_primer hits @sharkdp</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-04-29 18:11</div>
            <div class="timeline-body"><p>Just spot-checking the very first error (from parso), it looks to me like this PR is now wrongly suggesting that there is a possible control flow path from the assertion message to the following code, where in fact, the assertion message control flow path is always terminal.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-29 18:48</div>
            <div class="timeline-body"><p>Should not have pushed just before leaving. I'll fix that, of course.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-04-29 19:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @sharkdp on 2025-04-29 19:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-29 19:50</div>
            <div class="timeline-body"><p>Ok, this looks much better. The three new diagnostics on <code>attrs</code> are extremely weird — looking into it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-04-29 20:58</div>
            <div class="timeline-body"><p>This looks great to me (pending investigation of the new <code>attrs</code> diagnostics.)</p>
<p>The new psycopg2 diagnostics look related at least in part to not understanding cyclic control flow, though it's not clear to me why this PR surfaces them.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-29 21:02</div>
            <div class="timeline-body"><blockquote>
<p>The new psycopg2 diagnostics look related at least in part to not understanding cyclic control flow, though it's not clear to me why this PR surfaces them.</p>
</blockquote>
<p>I think it's related to #17723. I will look into that tomorrow.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-30 07:51</div>
            <div class="timeline-body"><p>@AlexWaygood The new fuzz check claims it found a new panic on this branch. The following snippet panics indeed:</p>
<pre><code class="language-py">class name_3[name_2: name_0]:
    pass
name_3.name_4
assert name_3[name_0]
</code></pre>
<p>but it also panics on <code>main</code>. It's my understanding that we still detect a lot of panics with the fuzzer in general, so I'm going to ignore that &quot;additional&quot; failure — but let me know if you think that it should be reported separately.</p>
<p>If it's just the fuzzer test that's being flaky, maybe that's something to be aware of / to look into.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-30 07:57</div>
            <div class="timeline-body"><blockquote>
<p>Ok, this looks much better. The three new diagnostics on <code>attrs</code> are extremely weird — looking into it.</p>
</blockquote>
<p>Turns out this was also related to https://github.com/astral-sh/ruff/issues/17723. After fixing this, these new diagnostics are gone again.</p>
<blockquote>
<p>The new psycopg2 diagnostics look related at least in part to not understanding cyclic control flow, though it's not clear to me why this PR surfaces them.</p>
</blockquote>
<p>It's true that we don't completely understand that code. But in the absence of cyclic control flow, we should not emit an error, because the <code>else</code> branch is &quot;unreachable&quot;:</p>
<pre><code class="language-py">assert …  # some assertion that affected reachability constraints below (without the fix for #17723)

first = True
for params in params_seq:
    if first:  # always true, in the absence of cyclic control flow
        pgq = …
        first = False
    else:
        use(pgq)  # unreachable, in the absence of cyclic control flow
</code></pre>
<p>After fixing #17723, we now &quot;correctly&quot; identify that <code>else</code> branch as unreachable again, and no diagnostics are emitted.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2025-04-30 07:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-04-30 07:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-30 07:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch restored on 2025-04-30 11:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-30 11:21</div>
            <div class="timeline-body"><blockquote>
<p>@AlexWaygood The new fuzz check claims it found a new panic on this branch. The following snippet panics indeed:</p>
<pre><code class="language-python">class name_3[name_2: name_0]:
    pass
name_3.name_4
assert name_3[name_0]
</code></pre>
</blockquote>
<p>It's weird to me that it's highlighting this snippet specifically. It looks like something that <em>could</em> well be affected by this branch, since it includes an <code>assert</code> statement on the final line. But I agree with you -- it looks like it panics in exactly the same way on the commit prior to this one.</p>
<blockquote>
<p>but it also panics on <code>main</code>. It's my understanding that we still detect a lot of panics with the fuzzer in general, so I'm going to ignore that &quot;additional&quot; failure — but let me know if you think that it should be reported separately.</p>
<p>If it's just the fuzzer test that's being flaky, maybe that's something to be aware of / to look into.</p>
</blockquote>
<p>Yes, this seems to be flakiness in the fuzzer test. Passing the <code>--only-new-bugs</code> flag (which is what we're doing in the CI job) should mean that it ignores pre-existing panics, and only reports <em>new</em> panics relative to the <code>main</code>-branch baseline. I'm looking into it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-30 11:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-30 11:47</div>
            <div class="timeline-body"><p>@sharkdp there <em>is</em> a bug in the fuzzer script here... but it's not quite what it seemed.</p>
<p>There is indeed code that involves <code>assert</code>s which now panics following this PR, but did not panic prior to this PR. Try running red-knot on https://gist.github.com/AlexWaygood/0925516f7b39516cf02f5dac6fca541e for a repro.</p>
<p>What happened here is the following:</p>
<ol>
<li>The fuzzer script ran the new version of red-knot on a large file of randomly generated code (the gist I linked to above), and spotted that red-knot panicked.</li>
<li>The fuzzer script then ran the baseline version of red-knot on the same file, noticed that the old version of red-knot did not panic, and deduced that the panic constituted a &quot;new red-knot bug&quot;.</li>
<li>The fuzzer script then used a different Python library to minimize the large file of randomly generated code to a snippet of code that was as small as possible but still reproduced a panic from red-knot. It accidentally &quot;overly minimized&quot; the snippet: the minimal repro is now something that the baseline version of red-knot also panics on.</li>
</ol>
<p>I'll update the minimization logic in the fuzzer script to be more sophisticated about this in the future, so that it doesn't produce such confusing results. I don't know if it's worth looking into the panic from https://gist.github.com/AlexWaygood/0925516f7b39516cf02f5dac6fca541e right now or not. As you say, we have plenty of pre-existing cases involving <code>assert</code>s and/or PEP-695 classes that produce panics. I'll leave that decision to you :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-30 13:14</div>
            <div class="timeline-body"><blockquote>
<p>The fuzzer script then used a different Python library to minimize the large file of randomly generated code to a snippet of code that was as small as possible but still reproduced a panic from red-knot. It accidentally &quot;overly minimized&quot; the snippet: the minimal repro is now something that the baseline version of red-knot also panics on.</p>
</blockquote>
<p>Ahh — that makes sense. Thank you for the analysis. I think I'm going to skip analyzing this further for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-30 15:13</div>
            <div class="timeline-body"><p>Here is a minimized repro of something that did not panic prior to this PR, but does now (courtesy of a fixed version of the fuzzer script that I have locally):</p>
<pre><code class="language-py">class name_3[name_2: name_0]:
    pass
name_3.name_4
assert name_3[name_0]
import name_0
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-30 15:14</div>
            <div class="timeline-body"><p>I think it is probably still the case that this PR just exposed a pre-existing issue rather than actually introducing a new issue. So I think it's still okay to just leave this for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-30 15:17</div>
            <div class="timeline-body"><p>I also think so. The following snippet also panics (introduces the same reachability constraints than the <code>assert</code>ion).</p>
<pre><code class="language-py">class name_3[name_2: name_0]:
    pass
name_3.name_4
if name_3[name_0]:
    import name_0
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-30 15:28</div>
            <div class="timeline-body"><p>And here's a fix for the fuzzer issue: https://github.com/astral-sh/ruff/pull/17739</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:12:01 UTC
    </footer>
</body>
</html>
