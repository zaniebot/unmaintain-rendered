<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[refurb] Parse more exotic decimal strings in `verbose-decimal-constructor (FURB157)` - astral-sh/ruff #14098</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[refurb] Parse more exotic decimal strings in <code>verbose-decimal-constructor (FURB157)</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14098">#14098</a>
        opened by <a href="https://github.com/dylwil3">@dylwil3</a>
        on 2024-11-04 23:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-11-04 23:37</div>
            <div class="timeline-body"><p>FURB157 suggests replacing expressions like <code>Decimal(&quot;123&quot;)</code> with <code>Decimal(123)</code>. This PR extends the rule to cover cases where the input string to <code>Decimal</code> can be easily transformed into an integer literal.</p>
<p>For example:</p>
<pre><code class="language-python">Decimal(&quot;1__000&quot;)   # fix: `Decimal(1000)`
</code></pre>
<p>Note: we do not implement the full decimal parsing logic from CPython on the grounds that certain acceptable string inputs to the <code>Decimal</code> constructor may be presumed purposeful on the part of the developer. For example, as in the linked issue, <code>Decimal(&quot;١٢٣&quot;)</code> is valid and equal to <code>Decimal(123)</code>, but we do not suggest a replacement in this case.</p>
<p>Closes #13807</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-11-04 23:40</div>
            <div class="timeline-body"><p>Happy to hear any suggestions around the strange mix of mutability and shadowing in the implementation. I was attempting to avoid allocating a String if we didn't have to, and to not change too much from the implementation that already existed...</p>
<p>Also happy to delete some comments if they are contributing more to clutter than understanding.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-04 23:51</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/refurb/rules/verbose_decimal_constructor.rs</code>:86 on 2024-11-05 06:55</div>
            <div class="timeline-body"><p>Nit: I don't think <code>memchr</code> gives us much here, considering that most literals are very short. We also don't have to use <code>replace</code> and allcoate a <code>Cow::Owned</code>. Instead, I would use <code>Cow::from(trimmed.trim_start_matches('_'))</code> for better readability (with the added benefit that it doesn't allocate)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/refurb/rules/verbose_decimal_constructor.rs</code>:119 on 2024-11-05 07:05</div>
            <div class="timeline-body"><p><code>replace</code> is technically <code>O(n)</code>. Not that it matters much here but I think I would find it slightly more readable if we explicitly tested for the <code>+</code> sign and the expected position.</p>
<pre><code>if rest[index + 1] == b'+' {
    rest.into_owned().remove(index + 1)
}
</code></pre>
<p>The alternative is to use <code>remove_matches</code> which captures the semantic better than <code>repalce</code> with a empty string</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/refurb/rules/verbose_decimal_constructor.rs</code>:110 on 2024-11-05 07:06</div>
            <div class="timeline-body"><p>It seems that the exponential syntax also supports negative numbers:</p>
<p>https://github.com/astral-sh/ruff/blob/51a998306a10aab1254740f760efaecc25213d71/crates/ruff_python_parser/src/lexer.rs#L1088-L1100</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-11-05 07:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-05 07:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/refurb/rules/verbose_decimal_constructor.rs</code>:129 on 2024-11-05 07:14</div>
            <div class="timeline-body"><p>Does this support <code>1_2_3_4</code>? or <code>1.1_2_3_4</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-11-05 07:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ruff_linter/src/rules/refurb/rules/verbose_decimal_constructor.rs</code>:118 on 2024-11-05 07:41</div>
            <div class="timeline-body"><p>I don't think the positive sign in the exponent is a syntax error?</p>
<pre><code class="language-pycon">&gt;&gt;&gt; 2e+3
2000.0
&gt;&gt;&gt; Decimal(2e+3)
Decimal('2000')
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-11-05 07:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ruff_linter/src/rules/refurb/rules/verbose_decimal_constructor.rs</code>:129 on 2024-11-05 07:50</div>
            <div class="timeline-body"><p>I think the idea above was to replace all <code>_</code>s, not just leading ones.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-05 07:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/refurb/rules/verbose_decimal_constructor.rs</code>:129 on 2024-11-05 07:55</div>
            <div class="timeline-body"><p>Good catch. I don't think replacing all of them is correct because <code>_</code> are not permitted in the exponent part.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/UnknownPlatypus">@UnknownPlatypus</a> reviewed on 2024-11-05 07:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/UnknownPlatypus">@UnknownPlatypus</a> on <code>crates/ruff_linter/src/rules/refurb/snapshots/ruff_linter__rules__refurb__tests__FURB157_FURB157.py.snap</code>:177 on 2024-11-05 07:59</div>
            <div class="timeline-body"><p>Maybe it would be nice to preserve the thousand separator in that case and suggest <code>1_000</code> instead of <code>1000</code>. (If it's not too annoying to do)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-11-05 08:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ruff_linter/src/rules/refurb/rules/verbose_decimal_constructor.rs</code>:110 on 2024-11-05 08:06</div>
            <div class="timeline-body"><p>Yes, you can have negative exponents. But this lint should not suggest replacing <code>Decimal(&quot;1e-1&quot;)</code> with <code>Decimal(1e-1)</code>. They are not the same! <code>Decimal</code> offers a way to represent decimal numbers in an exact way, something that floating point representations do not support.</p>
<pre><code class="language-py">&gt;&gt;&gt;&gt; Decimal(&quot;1e-1&quot;) == Decimal(1e-1)  # 1e-1 = 0.1 can not be represented exactly as a float
False
&gt;&gt;&gt;&gt; Decimal(&quot;5e-1&quot;) == Decimal(5e-1)  # Okay, 5e-1 = 1/2 can be represented exactly
True
</code></pre>
<p>I think we need to be similarly careful with large numbers, even if they are integers:</p>
<pre><code class="language-py">&gt;&gt;&gt;&gt; Decimal(&quot;1e22&quot;) == Decimal(1e22)
True
&gt;&gt;&gt;&gt; Decimal(&quot;1e23&quot;) == Decimal(1e23)
False
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-11-05 08:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ruff_linter/src/rules/refurb/rules/verbose_decimal_constructor.rs</code>:129 on 2024-11-05 08:11</div>
            <div class="timeline-body"><p>I think they are:</p>
<p>https://github.com/python/cpython/blob/ac556a2ad1213b8bb81372fe6fb762f5fcb076de/Lib/_pydecimal.py#L463</p>
<pre><code class="language-py">&gt;&gt;&gt; Decimal(&quot;2e1_0&quot;) == Decimal(2e1_0)
True
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-05 08:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/refurb/rules/verbose_decimal_constructor.rs</code>:129 on 2024-11-05 08:23</div>
            <div class="timeline-body"><p>Understanding your own code is always the hardest. So what's not allowed is <code>Decimal(2._1)</code></p>
<p>https://github.com/astral-sh/ruff/blob/4323512a6569eb1a820f91141f5798ba015628e6/crates/ruff_python_parser/src/lexer.rs#L1072-L1078</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-11-05 08:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ruff_linter/src/rules/refurb/rules/verbose_decimal_constructor.rs</code>:129 on 2024-11-05 08:30</div>
            <div class="timeline-body"><p>Yes. Leading/trailing underscores are also not supported in &quot;plain&quot; Python syntax: <code>_10</code>. But they are supported in <code>Decimal</code>s syntax.</p>
<p>But I don't think there is a problem in this PR? All underscores are replaced. So if someone really has <code>Decimal(&quot;_1_0_0__&quot;)</code> in their codebase, we would suggest replacing that with <code>Decimal(100)</code>, which is fine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/refurb/rules/verbose_decimal_constructor.rs</code>:86 on 2024-11-05 11:44</div>
            <div class="timeline-body"><p>I'm fine not using memchr, but I do think we need to use <code>replace</code> because underscores may appear anywhere in the string. For example- <code>Decimal(&quot;1_____00&quot;)</code> is valid.</p>
<p>Edit: whoops, didn't see that was already addressed below</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2024-11-05 11:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2024-11-05 11:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/refurb/rules/verbose_decimal_constructor.rs</code>:110 on 2024-11-05 11:46</div>
            <div class="timeline-body"><p>Just as @sharkdp points out, the omission of negative exponents was intentional. I didn't think about large exponents though, good point!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2024-11-05 12:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/refurb/rules/verbose_decimal_constructor.rs</code>:119 on 2024-11-05 12:07</div>
            <div class="timeline-body"><p>I like <code>remove_matches</code> but isn't it nightly only? https://doc.rust-lang.org/std/string/struct.String.html#method.remove_matches</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2024-11-05 12:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/refurb/rules/verbose_decimal_constructor.rs</code>:118 on 2024-11-05 12:18</div>
            <div class="timeline-body"><p>You're absolutely right! Dunno why I thought it was...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sbrugman">@sbrugman</a> on <code>crates/ruff_linter/resources/test/fixtures/refurb/FURB157.py</code>:18 on 2024-11-05 12:48</div>
            <div class="timeline-body"><p>Could we please also include cases for <code>Decimal(&quot;-inf&quot;)</code> and <code>Decimal(&quot;inf&quot;)</code> (both should error).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sbrugman">@sbrugman</a> reviewed on 2024-11-05 12:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2024-11-05 14:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/refurb/rules/verbose_decimal_constructor.rs</code>:110 on 2024-11-05 14:01</div>
            <div class="timeline-body"><p>It's hard to figure out when this conversion is actually safe - parsing scientific notation is weird, and I can't seem to find a reference for the range where the representation is faithful. I think issues start to occur when numbers are larger than <code>1e16</code> but I'm having trouble finding a justification for that in code/documentation...</p>
<p>The smallest example I found so far was:</p>
<pre><code class="language-bash">&gt;&gt;&gt; Decimal(1801439850948199e1) == Decimal('1801439850948199e1')
False
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dscorbett">@dscorbett</a> reviewed on 2024-11-05 14:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dscorbett">@dscorbett</a> on <code>crates/ruff_linter/src/rules/refurb/rules/verbose_decimal_constructor.rs</code>:110 on 2024-11-05 14:20</div>
            <div class="timeline-body"><p>FURB157 should not rewrite strings to float literals. Literals with exponents are float literals, so they should not be passed to the <code>Decimal</code> constructor, or they will trigger <a href="https://docs.astral.sh/ruff/rules/decimal-from-float-literal/"><code>decimal-from-float-literal</code> (RUF032)</a>.</p>
<pre><code class="language-console">$ cat ruf032.py                                                   
from decimal import Decimal
Decimal(1e16)

$ ruff check --isolated --preview --select RUF032 ruf032.py 
ruf032.py:2:9: RUF032 `Decimal()` called with float literal argument
  |
1 | from decimal import Decimal
2 | Decimal(1e16)
  |         ^^^^ RUF032
  |
  = help: Use a string literal instead

Found 1 error.
No fixes available (1 hidden fix can be enabled with the `--unsafe-fixes` option).
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2024-11-05 14:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/refurb/rules/verbose_decimal_constructor.rs</code>:110 on 2024-11-05 14:36</div>
            <div class="timeline-body"><p>Well that makes life easier! Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-11-05 14:56</div>
            <div class="timeline-body"><p>Sorry for sending everyone down an exponential rabbit hole, and thanks @dscorbett for digging me out of it!</p>
<p>Exponent handling has been removed since it takes us out of the world of integer literals.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-05 18:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/refurb/rules/verbose_decimal_constructor.rs</code>:119 on 2024-11-05 18:06</div>
            <div class="timeline-body"><p>Ah dang. I guess replace is still the best option</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-05 18:07</div>
            <div class="timeline-body"><p>@dylwil3 feel free to merge at your own discretion</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2024-11-05 19:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/refurb/snapshots/ruff_linter__rules__refurb__tests__FURB157_FURB157.py.snap</code>:177 on 2024-11-05 19:13</div>
            <div class="timeline-body"><p>That's a good suggestion, and I think it would be a nice followup! I think one would want to trim leading/trailing underscores, and then replace every internal, contiguous sequence of underscores with a single underscore. At that point it may be worth a little refactoring to just walk through the string once and abort early as appropriate...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dylwil3 on 2024-11-05 19:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dylwil3 on 2024-11-05 19:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-05 19:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dhruvmanila on 2024-11-08 10:45</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 20:51:27 UTC
    </footer>
</body>
</html>
