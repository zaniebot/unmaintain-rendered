<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Add diagnostic for invalid unpacking - astral-sh/ruff #15086</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Add diagnostic for invalid unpacking</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15086">#15086</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-12-20 17:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Part of #13773</p>
<p>This PR adds diagnostics when there is a length mismatch during unpacking between the number of target expressions and the number of types for the unpack value expression.</p>
<p>There are 3 cases of diagnostics here where the first two occurs when there isn't a starred expression and the last one occurs when there's a starred expression:</p>
<ol>
<li>Number of target expressions is <strong>less</strong> than the number of types that needs to be unpacked</li>
<li>Number of target expressions is <strong>greater</strong> then the number of types that needs to be unpacked</li>
<li>When there's a starred expression as one of the target expression and the number of target expressions is greater than the number of types</li>
</ol>
<p>Examples for all each of the above cases:</p>
<pre><code class="language-py"># red-knot: Too many values to unpack (expected 2, got 3) [lint:invalid-assignment]
a, b = (1, 2, 3)

# red-knot: Not enough values to unpack (expected 2, got 1) [lint:invalid-assignment]
a, b = (1,)

# red-knot: Not enough values to unpack (expected 3 or more, got 2) [lint:invalid-assignment]
a, *b, c, d = (1, 2)
</code></pre>
<p>The (3) case is a bit special because it uses a distinct wording &quot;expected n or more&quot; instead of &quot;expected n&quot; because of the starred expression.</p>
<h3>Location</h3>
<p>The diagnostic location is the target expression that's being unpacked. For nested targets, the location will be the nested expression. For example:</p>
<pre><code class="language-py">(a, (b, c), d) = (1, (2, 3, 4), 5)
#   ^^^^^^
#   red-knot: Too many values to unpack (expected 2, got 3) [lint:invalid-assignment]
</code></pre>
<p>For future improvements, it would be useful to show the context for why this unpacking failed. For example, for why the expected number of targets is <code>n</code>, we can highlight the relevant elements for the value expression.</p>
<p>In the <strong>ecosystem</strong>, <strong>Pyright</strong> uses the target expressions for location while <strong>mypy</strong> uses the value expression for the location. For example:</p>
<pre><code class="language-py">if 1:
#          mypy: Too many values to unpack (2 expected, 3 provided)  [misc]
#          vvvvvvvvv
	a, b = (1, 2, 3)
#   ^^^^
#   Pyright: Expression with type &quot;tuple[Literal[1], Literal[2], Literal[3]]&quot; cannot be assigned to target tuple
#     Type &quot;tuple[Literal[1], Literal[2], Literal[3]]&quot; is incompatible with target tuple
#       Tuple size mismatch; expected 2 but received 3 [reportAssignmentType]
#   red-knot: Too many values to unpack (expected 2, got 3) [lint:invalid-assignment]
</code></pre>
<h2>Test Plan</h2>
<p>Update existing test cases TODO with the error directives.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @dhruvmanila on 2024-12-20 17:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-12-20 17:19</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dhruvmanila on 2024-12-24 09:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dhruvmanila on 2024-12-24 09:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2024-12-24 09:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dhruvmanila on 2024-12-24 09:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @dhruvmanila on 2024-12-24 09:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-12-24 10:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/types/unpacker.rs</code>:173 on 2024-12-24 10:00</div>
            <div class="timeline-body"><p>Additional changes:</p>
<ul>
<li>Expanded the comments in this method</li>
<li>Avoid <code>&amp;mut self</code> as it's not required (not sure why clippy didn't catch that)</li>
<li>Pass the <code>expr</code> which is required for the diagnostic location</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/T-256">@T-256</a> on <code>crates/red_knot_python_semantic/resources/mdtest/unpacking.md</code>:543 on 2024-12-24 16:19</div>
            <div class="timeline-body"><p>Re-commenttng here,
Since <code>&quot;c&quot;</code> doesn't have enough values to unpack, I think <code>LiteralString</code> will never put at here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/T-256">@T-256</a> reviewed on 2024-12-24 16:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/unpacking.md</code>:64 on 2024-12-24 17:13</div>
            <div class="timeline-body"><p>Can we include the error code here as well (and in all cases below)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/unpacking.md</code>:543 on 2024-12-24 17:17</div>
            <div class="timeline-body"><p>I agree it would be better if this were just <code>Unknown | Literal[3, 5]</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-12-24 17:20</div>
            <div class="timeline-body"><p>Very nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/unpacking.md</code>:543 on 2024-12-24 17:28</div>
            <div class="timeline-body"><p>I think to do this consistently would mean changing a bunch of other cases, though -- it would mean that e.g. for <code>(a, b, c) = (1, 2)</code> we would infer <code>Unknown</code> (or <code>Never</code> would also be reasonable) for all of <code>a</code>, <code>b</code>, <code>c</code>, rather than inferring <code>Literal[1]</code> for <code>a</code> and <code>Literal[2]</code> for <code>b</code>. That is, today we try to match up and infer as many types as we can, even if the overall unpacking is an error; this would mean changing that.</p>
<p>The advantage of the current approach is that it can catch more errors at once, assuming the parts that we are able to line up are actually lined up correctly. But that may not be a reasonable assumption; if you have a mis-alignment it could actually be early in the unpacking, in which case we are just inferring wrong types for many of the targets, potentially leading to false positives in subsequent code.</p>
<p>It looks like our current behavior is more like pyright; mypy always just infers <code>Any</code> for all targets in a mis-aligned unpacking.</p>
<p>I do think that the mypy behavior is more principled and we should probably switch to that, though I also don't think it's high priority to make that change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-12-24 17:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/resources/mdtest/unpacking.md</code>:543 on 2024-12-30 07:37</div>
            <div class="timeline-body"><p>Yes, I did that for the advantage that you've mentioned and I'm fine changing the behavior as it's an error case and should be less often in practice. I'll expand the original issue with this task.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-12-30 07:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2024-12-30 07:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-12-30 07:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-12-30 07:40</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:08:38 UTC
    </footer>
</body>
</html>
