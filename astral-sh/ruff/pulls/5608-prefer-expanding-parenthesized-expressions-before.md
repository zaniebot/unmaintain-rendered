```yaml
number: 5608
title: Prefer expanding parenthesized expressions before operands
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: expand-by-parentheses-first
created_at: 2023-07-08T09:23:02Z
updated_at: 2023-07-11T12:33:39Z
url: https://github.com/astral-sh/ruff/pull/5608
synced_at: 2026-01-12T03:36:55Z
```

# Prefer expanding parenthesized expressions before operands

---

_Pull request opened by @MichaReiser on 2023-07-08 09:23_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This PR implements Black's behavior where it first splits off parenthesized expressions before splitting before operands to avoid unnecessary parentheses:

```python
# We want 
if a + [ 
	b,
	c
]: 
	pass

# Rather than
if (
    a
    + [b, c]
): 
	pass
```

This is implemented by using the new IR elements introduced in #5596. 

* We give the group wrapping the optional parentheses an ID (`parentheses_id`)
* We use `conditional_group` for the lower priority groups  (all non-parenthesized expressions) with the condition that the `parentheses_id` group breaks (we want to split before operands only if the parentheses are necessary)
* We use `fits_expanded` to wrap all other parenthesized expressions (lists, dicts, sets), to prevent that expanding e.g. a list expands the `parentheses_id` group. We gate the `fits_expand` to only apply if the `parentheses_id` group fits (because we  prefer `a\n+[b, c]` over expanding `[b, c]` if the whole expression gets parenthesized).

We limit using `fits_expanded` and `conditional_group` only to expressions that themselves are not in parentheses (checking the conditions isn't free)

## Test Plan

It increases the Jaccard index for Django from 0.915 to 0.917

## Incompatibilites

There are two incompatibilities left that I'm aware of (there may be more, I didn't go through all snapshot differences). 

### Long string literals
I  commented on the regression. The issue is that a very long string (or any content without a split point) may not fit when only breaking the right side. The formatter than inserts the optional parentheses. But this is kind of useless because the overlong string will still not fit, because there are no new split points. 

I think we should ignore this incompatibility for now


### Expressions on statement level

I don't fully understand the logic behind this yet, but black doesn't break before the operators for the following example even though the expression exceeds the configured line width

```python
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa < bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb > ccccccccccccccccccccccccccccc == ddddddddddddddddddddd
```

But it would if the expression is used inside of a condition. 

What I understand so far is that Black doesn't insert optional parentheses on the expression statement level (and a few other places) and, therefore, only breaks after opening parentheses. I propose to keep this deviation for now to avoid overlong-lines and use the compatibility report to make a decision if we should implement the same behavior. 

---

_Comment by @MichaReiser on 2023-07-08 09:23_

Current dependencies on/for this PR:
* main
  * **PR #5596** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5596" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #5608** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5608" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
      * **PR #5609** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5609" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #5643** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5643" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #5644** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5644" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #5615** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5615" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/5608?utm_source=stack-comment).

---

_Converted to draft by @MichaReiser on 2023-07-08 09:23_

---

_Comment by @github-actions[bot] on 2023-07-08 10:14_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      8.4Â±0.04ms     4.8 MB/sec    1.00      8.4Â±0.02ms     4.8 MB/sec
formatter/numpy/ctypeslib.py               1.00  1861.6Â±10.12Âµs     8.9 MB/sec    1.01   1876.6Â±6.75Âµs     8.9 MB/sec
formatter/numpy/globals.py                 1.00    199.4Â±0.35Âµs    14.8 MB/sec    1.02    204.1Â±1.24Âµs    14.5 MB/sec
formatter/pydantic/types.py                1.02      4.2Â±0.07ms     6.1 MB/sec    1.00      4.1Â±0.00ms     6.2 MB/sec
linter/all-rules/large/dataset.py          1.00     14.1Â±0.03ms     2.9 MB/sec    1.00     14.1Â±0.06ms     2.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.5Â±0.01ms     4.7 MB/sec    1.00      3.5Â±0.00ms     4.7 MB/sec
linter/all-rules/numpy/globals.py          1.00    365.9Â±1.30Âµs     8.1 MB/sec    1.00    367.1Â±1.43Âµs     8.0 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.3Â±0.05ms     4.1 MB/sec    1.00      6.3Â±0.06ms     4.1 MB/sec
linter/default-rules/large/dataset.py      1.00      7.2Â±0.01ms     5.6 MB/sec    1.00      7.2Â±0.15ms     5.6 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1484.3Â±4.68Âµs    11.2 MB/sec    1.00   1489.4Â±2.32Âµs    11.2 MB/sec
linter/default-rules/numpy/globals.py      1.00    161.1Â±0.73Âµs    18.3 MB/sec    1.00    161.4Â±1.51Âµs    18.3 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.2Â±0.01ms     7.9 MB/sec    1.00      3.2Â±0.01ms     8.0 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     11.7Â±0.44ms     3.5 MB/sec    1.00     11.7Â±0.37ms     3.5 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.6Â±0.12ms     6.4 MB/sec    1.05      2.7Â±0.13ms     6.1 MB/sec
formatter/numpy/globals.py                 1.00   286.1Â±14.85Âµs    10.3 MB/sec    1.04   298.0Â±18.83Âµs     9.9 MB/sec
formatter/pydantic/types.py                1.00      5.6Â±0.23ms     4.5 MB/sec    1.04      5.9Â±0.33ms     4.3 MB/sec
linter/all-rules/large/dataset.py          1.00     19.5Â±0.61ms     2.1 MB/sec    1.00     19.6Â±0.65ms     2.1 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.02      5.1Â±0.20ms     3.3 MB/sec    1.00      5.0Â±0.21ms     3.3 MB/sec
linter/all-rules/numpy/globals.py          1.01   629.4Â±21.41Âµs     4.7 MB/sec    1.00   622.7Â±80.29Âµs     4.7 MB/sec
linter/all-rules/pydantic/types.py         1.00      8.7Â±0.33ms     2.9 MB/sec    1.00      8.7Â±0.34ms     2.9 MB/sec
linter/default-rules/large/dataset.py      1.02     10.1Â±0.33ms     4.0 MB/sec    1.00      9.9Â±0.37ms     4.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00      2.1Â±0.07ms     7.9 MB/sec    1.00      2.1Â±0.08ms     7.9 MB/sec
linter/default-rules/numpy/globals.py      1.02   258.7Â±15.88Âµs    11.4 MB/sec    1.00   254.2Â±19.29Âµs    11.6 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.5Â±0.20ms     5.6 MB/sec    1.01      4.6Â±0.31ms     5.6 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/tests/snapshots/black_compatibility@simple_cases__trailing_comma_optional_parens3.py.snap`:8 on 2023-07-09 11:16_

This is a regression

Ruff tests if all lines fit. This is usless in the given case because strings have no further split point. Meaning, changing the layout to fully expanded doesn't really fix the *does not fit* problem, because we would need to split the srings, which we cannot. Splitting the last line doesn't really help either. 
Should the `FitsExpanded` measure mode be `FitsEnd` rather than `StartAndEnd`? Meaning, we measure if everything up to the first separator fits, then everything coming after the last line break?

---

_Renamed from "Prefer parenthesized expressions before operands" to "Prefer expanding parenthesized expressions before operands" by @MichaReiser on 2023-07-09 12:03_

---

_Review requested from @konstin by @MichaReiser on 2023-07-10 11:36_

---

_Label `formatter` added by @MichaReiser on 2023-07-10 11:36_

---

_Marked ready for review by @MichaReiser on 2023-07-10 11:37_

---

_@MichaReiser reviewed on 2023-07-10 11:42_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/mod.rs`:131 on 2023-07-11 10:27_

why is the line break inside the indent?

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/mod.rs`:228 on 2023-07-11 10:27_

i think this should mention black

---

_Review comment by @konstin on `crates/ruff_python_formatter/tests/snapshots/black_compatibility@simple_cases__trailing_comma_optional_parens3.py.snap`:8 on 2023-07-11 10:36_

i think we do need to measure after the line break here

---

_@konstin approved on 2023-07-11 10:36_

---

_@MichaReiser reviewed on 2023-07-11 11:17_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/tests/snapshots/black_compatibility@simple_cases__trailing_comma_optional_parens3.py.snap`:8 on 2023-07-11 11:17_

I'll leave this for now to fix later. This is a general problem when using `groups` that contain no further split points. 

---

_@MichaReiser reviewed on 2023-07-11 11:20_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/mod.rs`:131 on 2023-07-11 11:20_

`Indent` is a bit counter-intuitive. Luckily, this is hidden a way by `soft_block_indent` and `block_indent`. `indent` only increments the indentation level, it doesn't insert any line breaks itself. The `soft_line_break` is necessary to then start a new line, with the new, incremented indent. 

This is why the *closing* newline is outside of the indent. We first need to decrement the indent counter, and only then start the new line.

---

_Merged by @MichaReiser on 2023-07-11 12:07_

---

_Closed by @MichaReiser on 2023-07-11 12:07_

---

_Branch deleted on 2023-07-11 12:07_

---

_Comment by @MichaReiser on 2023-07-11 12:07_

@MichaReiser merged this pull request with [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/5608).

---
