<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Improve debuggability of protocol types - astral-sh/ruff #19662</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Improve debuggability of protocol types</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19662">#19662</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-07-31 13:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-31 13:03</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>As our protocol implementation continues to progress, it's increasingly important for debuggability to know what types are being captured for each member in a protocol's interface and what kind of a member each member is treated as. One way of obtaining this information is to use a <code>dbg!()</code> call, but this means that you have to recompile ty (which takes a while), and also prints out a lot of detail that you don't need, making it hard to see the information that you do need.</p>
<p>This PR adds a <code>ty_extensions.reveal_protocol_interface</code> function to solve this issue. If you pass a protocol to this function, ty emits a diagnostic that prints a formatted representation of the underlying interface.</p>
<h2>Test Plan</h2>
<p>mdtests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-07-31 13:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-07-31 13:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @AlexWaygood on 2025-07-31 13:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2025-07-31 13:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-07-31 13:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @AlexWaygood on 2025-07-31 13:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-31 13:05</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on typing conformance tests</h2>
<details>
<summary>Changes were detected when running ty on typing conformance tests</summary>

<pre><code class="language-diff">--- old-output.txt	2025-08-01 14:10:34.764459119 +0000
+++ new-output.txt	2025-08-01 14:10:34.827459530 +0000
@@ -368,8 +368,8 @@
 generics_basic.py:34:12: error[unsupported-operator] Operator `+` is unsupported between objects of type `AnyStr` and `AnyStr`
 generics_basic.py:139:5: error[type-assertion-failure] Argument does not have asserted type `int`
 generics_basic.py:140:5: error[type-assertion-failure] Argument does not have asserted type `int`
-generics_basic.py:157:5: error[invalid-argument-type] Method `__getitem__` of type `bound method MyMap1[str, int].__getitem__(key: str, /) -&gt; int` cannot be called with key of type `Literal[0]` on object of type `MyMap1[str, int]`
-generics_basic.py:158:5: error[invalid-argument-type] Method `__getitem__` of type `bound method MyMap2[int, str].__getitem__(key: str, /) -&gt; int` cannot be called with key of type `Literal[0]` on object of type `MyMap2[int, str]`
+generics_basic.py:157:5: error[call-non-callable] Method `__getitem__` of type `bound method MyMap1[str, int].__getitem__(key: str, /) -&gt; int` is not callable on object of type `MyMap1[str, int]`
+generics_basic.py:158:5: error[call-non-callable] Method `__getitem__` of type `bound method MyMap2[int, str].__getitem__(key: str, /) -&gt; int` is not callable on object of type `MyMap2[int, str]`
 generics_basic.py:162:12: error[invalid-argument-type] `&lt;class 'int'&gt;` is not a valid argument to `Generic`
 generics_basic.py:163:12: error[invalid-argument-type] `&lt;class 'int'&gt;` is not a valid argument to `Protocol`
 generics_basic.py:171:1: error[invalid-generic-class] `Generic` base class must include all type variables used in other base classes
@@ -704,7 +704,6 @@
 namedtuples_usage.py:30:1: error[type-assertion-failure] Argument does not have asserted type `str`
 namedtuples_usage.py:31:1: error[type-assertion-failure] Argument does not have asserted type `int`
 namedtuples_usage.py:32:1: error[type-assertion-failure] Argument does not have asserted type `int`
-namedtuples_usage.py:41:1: error[invalid-assignment] Cannot assign to object of type `Point` with no `__setitem__` method
 namedtuples_usage.py:49:1: error[type-assertion-failure] Argument does not have asserted type `int`
 namedtuples_usage.py:50:1: error[type-assertion-failure] Argument does not have asserted type `str`
 narrowing_typeguard.py:17:9: error[type-assertion-failure] Argument does not have asserted type `tuple[str, str]`
@@ -725,7 +724,7 @@
 narrowing_typeis.py:96:9: error[type-assertion-failure] Argument does not have asserted type `B`
 narrowing_typeis.py:132:20: error[invalid-argument-type] Argument to function `takes_callable_str` is incorrect: Expected `(object, /) -&gt; str`, found `def simple_typeguard(val: object) -&gt; TypeIs[int]`
 narrowing_typeis.py:191:18: error[invalid-argument-type] Argument to function `takes_int_typeis` is incorrect: Expected `(object, /) -&gt; TypeIs[int]`, found `def bool_typeis(val: object) -&gt; TypeIs[bool]`
-overloads_basic.py:39:1: error[invalid-argument-type] Method `__getitem__` of type `Overload[(__i: int) -&gt; int, (__s: slice[Any, Any, Any]) -&gt; bytes]` cannot be called with key of type `Literal[&quot;&quot;]` on object of type `Bytes`
+overloads_basic.py:39:1: error[call-non-callable] Method `__getitem__` of type `Overload[(__i: int) -&gt; int, (__s: slice[Any, Any, Any]) -&gt; bytes]` is not callable on object of type `Bytes`
 overloads_definitions.py:20:5: error[invalid-overload] Overloaded function `func1` requires at least two overloads
 overloads_definitions.py:33:5: error[invalid-overload] Overloaded non-stub function `func2` must have an implementation
 overloads_definitions.py:63:9: error[invalid-overload] Overloaded non-stub function `not_abstract` must have an implementation
@@ -889,4 +888,4 @@
 tuples_type_form.py:36:1: error[invalid-assignment] Object of type `tuple[Literal[1], Literal[2], Literal[3], Literal[&quot;&quot;]]` is not assignable to `tuple[int, ...]`
 typeddicts_operations.py:60:1: error[type-assertion-failure] Argument does not have asserted type `str | None`
 typeddicts_type_consistency.py:101:1: error[invalid-assignment] Object of type `Unknown | None` is not assignable to `str`
-Found 890 diagnostics
+Found 889 diagnostics
</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-31 13:07</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/diagnostic.rs</code>:2286 on 2025-08-01 06:37</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    diagnostic.info(&quot;See https://typing.python.org/en/latest/spec/protocol.html&quot;);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> approved on 2025-08-01 06:40</div>
            <div class="timeline-body"><p>Cool. I can see how this can be very helpful. I like that you are constructing the &quot;debug&quot; representation manually instead of relying on <code>{:?}</code>.</p>
<p>Still, I'm a little worried that we should maybe be splitting <code>ty_extensions</code> into &quot;public&quot; and &quot;definitely internal&quot; parts (see my comment <a href="https://github.com/astral-sh/ty/issues/902#issuecomment-3131244850">here</a>), because this definitely belongs in the latter category. But this is also true for other functions in <code>ty_extensions</code>, so not only related to this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-08-01 06:42</div>
            <div class="timeline-body"><p>Thinking a bit more about this... if we do want to eventually add something like <code>ty_extensions.reveal_type_debug</code>, couldn't this be part of the functionality? Whenever you call <code>reveal_type_debug</code> on a protocol, it would not just clearly state that it's a <code>Type::ProtocolInstance</code>, but also give information about the inner structure?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-08-01 07:15</div>
            <div class="timeline-body"><blockquote>
<p>Still, I'm a little worried that we should maybe be splitting ty_extensions into &quot;public&quot; and &quot;definitely internal&quot; parts (see my comment https://github.com/astral-sh/ty/issues/902#issuecomment-3131244850), because this definitely belongs in the latter category. But this is also true for other functions in ty_extensions, so not only related to this PR.</p>
</blockquote>
<p>I think this is a fair concern, although I'm not sure if we should indeed communicate that anything about <code>ty_extension</code> is public in the first place or falls under our versioning policy.</p>
<p>Either way. I guess the pythonic solution to this problem could be to mark the &quot;more internal&quot; functions as private: <code>ty_extension.__reveal_debug_tupe</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-08-01 07:22</div>
            <div class="timeline-body"><blockquote>
<p>Either way. I guess the pythonic solution to this problem could be to mark the &quot;more internal&quot; functions as private: <code>ty_extension.__reveal_debug_tupe</code>?</p>
</blockquote>
<p>I think I'd prefer <code>from ty_extensions.internal import reveal_type_debug</code>, but no strong opinion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-01 14:11</div>
            <div class="timeline-body"><p>Yes, it would be nice to expose some parts of <code>ty_extensions</code> to the public at some point, but we'd need to think through quite a few things:</p>
<ul>
<li>How would we publish it to PyPI? Or would we skip that, and document that you can only import these in an <code>if TYPE_CHECKING</code> block?</li>
<li>We'd need to switch from PEP-695 syntax to legacy generics if we want it to be valid syntax on Python &lt;3.12</li>
<li>There are a number of internal functions in there that we might not want to commit to maintaining as public API</li>
</ul>
<p>So I agree that we have a number of internal functions in <code>ty_extensions</code> right now, that we shouldn't expose as public API. But to me this seems like a pre-existing problem; for now, I'd prefer to think of the whole module as private until we actively think through these issues and decide to commit to making some of them public API.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-01 14:16</div>
            <div class="timeline-body"><blockquote>
<p>Thinking a bit more about this... if we do want to eventually add something like <code>ty_extensions.reveal_type_debug</code>, couldn't this be part of the functionality? Whenever you call <code>reveal_type_debug</code> on a protocol, it would not just clearly state that it's a <code>Type::ProtocolInstance</code>, but also give information about the inner structure?</p>
</blockquote>
<p>It <em>could</em> be. But I think I'd want more information from <code>reveal_type_debug</code>? There's a lot of information about the types of members that the diagnostic being added here is deliberately leaving out (for brevity), but I think for <code>reveal_type_debug</code> I'd want something similar to a <code>dbg!()</code> invocation. Just give me all the information I could possibly need, maybe something in there will tell me what's going on!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-08-01 14:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-08-01 14:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-01 14:16</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:52:43 UTC
    </footer>
</body>
</html>
