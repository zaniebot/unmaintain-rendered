<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support classes that implement `__call__` - astral-sh/ruff #13580</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Support classes that implement <code>__call__</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13580">#13580</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-10-01 04:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-01 04:08</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This looked straightforward and removes some TODOs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @charliermarsh on 2024-10-01 04:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @charliermarsh on 2024-10-01 04:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @charliermarsh on 2024-10-01 04:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @charliermarsh on 2024-10-01 04:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:618 on 2024-10-01 04:09</div>
            <div class="timeline-body"><p>This is just <code>Type::Class(_instance_ty)</code>. Should I do that directly, or do we prefer to go through <code>to_meta_type</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-10-01 04:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-10-01 04:22</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-01 14:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:618 on 2024-10-01 14:19</div>
            <div class="timeline-body"><p>I think here you can just do it directly! Maybe add a comment saying that because it's a dunder it's important to access it as an attribute on the class rather than the instance, though (matching the runtime semantics)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:623 on 2024-10-01 14:25</div>
            <div class="timeline-body"><p>there are some existing bugs where we don't do this elsewhere (that we should fix), but it's actually somewhat important: because we're accessing <code>__call__</code> as an attribute on the class rather than the instance, <code>__call__</code> is actually a &quot;pure function&quot; here rather than a method. That means that we need to manually insert <code>self</code> into the <code>arg_types</code> we're passing into the <code>.call()</code> method here.</p>
<p>It doesn't make a difference right now, but it will when we start validating the types of arguments passed into typed functions.</p>
<p>I guess something like this?</p>
<pre><code class="language-suggestion">                    &amp;dunder_call_method.call(db, std::iter::once(self).chain(arg_types).collect::&lt;Vec&lt;_&gt;&gt;())
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-10-01 14:25</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-01 14:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:623 on 2024-10-01 14:37</div>
            <div class="timeline-body"><p>We may want to better optimize the way we pass around call args in the future to avoid this re-allocation (the runtime has the same issue!) but I think for now it's fine to just get the args right, it'll be easier to see how to optimize it once we have more cases in place, and are actually validating args.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-10-01 14:38</div>
            <div class="timeline-body"><p>Looks great!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-01 16:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:623 on 2024-10-01 16:50</div>
            <div class="timeline-body"><blockquote>
<p>there are some existing bugs where we don't do this elsewhere (that we should fix)</p>
</blockquote>
<p>(I fixed the other bugs in #13593!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-10-01 17:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:623 on 2024-10-01 17:06</div>
            <div class="timeline-body"><p>Makes sense, sounds good.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-10-01 17:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:623 on 2024-10-01 17:06</div>
            <div class="timeline-body"><p>Easy to avoid the allocation here later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-10-01 17:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-10-01 17:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-10-01 17:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-01 17:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:616 on 2024-10-01 17:19</div>
            <div class="timeline-body"><p>Ah I was actually thinking you could get rid of yet another layer of indirection here, i.e.</p>
<pre><code class="language-suggestion">                let dunder_call_method = class.class_member(db, &quot;__call__&quot;);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:616 on 2024-10-01 17:57</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/13595</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-10-01 17:57</div>
            <div class="timeline-body"></div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 21:00:07 UTC
    </footer>
</body>
</html>
