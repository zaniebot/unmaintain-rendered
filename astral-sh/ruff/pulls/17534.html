<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] fix unions of literals, again - astral-sh/ruff #17534</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] fix unions of literals, again</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17534">#17534</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2025-04-22 00:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/carljm">@carljm</a> on 2025-04-22 00:16</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>#17451 was incomplete. <code>AlwaysFalsy</code> and <code>AlwaysTruthy</code> are not the only two types that are super-types of some literals (of a given kind) and not others. That set also includes intersections containing <code>AlwaysTruthy</code> or <code>AlwaysFalsy</code>, and intersections containing literal types of the same kind. Cover these cases as well.</p>
<p>Fixes #17478.</p>
<h2>Test Plan</h2>
<p>Added mdtests.</p>
<p><code>QUICKCHECK_TESTS=1000000 cargo test -p red_knot_python_semantic -- --ignored types::property_tests::stable</code> failed on both <code>all_fully_static_type_pairs_are_subtypes_of_their_union</code> and <code>all_type_pairs_are_assignable_to_their_union</code> prior to this PR, passes after it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @carljm on 2025-04-22 00:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @carljm on 2025-04-22 00:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @carljm on 2025-04-22 00:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @carljm on 2025-04-22 00:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-22 00:18</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/builder.rs</code>:58 on 2025-04-22 10:00</div>
            <div class="timeline-body"><p>I'm slightly concerned about how much special-casing we're adding for <code>Type::AlwaysTruthy</code> and <code>Type::AlwaysFalsy</code>, given that conceptually these are really just two protocol types, and we'll be adding a lot more protocol types to our model very soon... but I guess we (I) can cross that bridge when we (I) come to it :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/builder.rs</code>:78 on 2025-04-22 10:12</div>
            <div class="timeline-body"><p>nit: I find this slightly cleaner (fewer guards in the <code>match</code> statement)</p>
<pre><code class="language-suggestion">    fn splits_literals(self, db: &amp;'db dyn Db, kind: LiteralKind) -&gt; bool {
        match (self, kind) {
            (Type::AlwaysFalsy | Type::AlwaysTruthy, _) =&gt; true,
            (Type::StringLiteral(_), LiteralKind::String) =&gt; true,
            (Type::BytesLiteral(_), LiteralKind::Bytes) =&gt; true,
            (Type::IntLiteral(_), LiteralKind::Int) =&gt; true,
            (Type::Intersection(intersection), _) =&gt; {
                intersection
                    .positive(db)
                    .iter()
                    .any(|ty| ty.splits_literals(db, kind))
                    || intersection
                        .negative(db)
                        .iter()
                        .any(|ty| ty.splits_literals(db, kind))
            }
            (Type::Union(union), _) =&gt; union
                .elements(db)
                .iter()
                .any(|ty| ty.splits_literals(db, kind)),
            _ =&gt; false,
        }
    }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/call/union.md</code>:187 on 2025-04-22 10:14</div>
            <div class="timeline-body"><p>shouldn't this simplify to <code>object</code>? Doesn't need to be done in this PR of course, but could add a TODO?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-04-22 10:24</div>
            <div class="timeline-body"><p>Nice! I also confirmed locally that the property tests are no longer flaky (ran them with 2,000,000 iterations ðŸ˜„)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-04-22 14:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/builder.rs</code>:58 on 2025-04-22 14:58</div>
            <div class="timeline-body"><p>I think even with the addition of general protocol types, <code>AlwaysTruthy</code> and <code>AlwaysFalsy</code> will remain &quot;special&quot; in that I don't think any other protocol type can &quot;distinguish&quot; between literals of the same kind?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-22 15:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/builder.rs</code>:58 on 2025-04-22 15:03</div>
            <div class="timeline-body"><p>let's hope so!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-04-22 16:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/call/union.md</code>:187 on 2025-04-22 16:01</div>
            <div class="timeline-body"><p>Looks like this is also a regression from the unions-of-literals optimization; I won't fix it in this PR but I will fix it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @carljm on 2025-04-22 16:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-04-22 16:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-22 16:12</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:33:29 UTC
    </footer>
</body>
</html>
