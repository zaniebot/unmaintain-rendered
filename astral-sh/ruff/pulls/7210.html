<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add warnings for nursery and preview rule selection - astral-sh/ruff #7210</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add warnings for nursery and preview rule selection</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7210">#7210</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2023-09-06 21:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/zanieb">@zanieb</a> on 2023-09-06 21:08</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Adds warnings for cases where:</p>
<ul>
<li>A selector does not include any rules because preview is disabled</li>
<li>A nursery rule is selected without the preview flag</li>
</ul>
<h2>Test plan</h2>
<p>Add integration tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "zanie/rule warning" to "Add warnings for nursery and preview rule selection" by @zanieb on 2023-09-06 21:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-09-06 21:59</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>‚úÖ ecosystem check detected no changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_workspace/src/configuration.rs</code>:634 on 2023-09-06 22:30</div>
            <div class="timeline-body"><p>The redirect warning code has a comment that says this should be in the <code>ruff_cli</code> crate ‚Äî how would we go about that? I'd like to create a tracking issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-09-06 22:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_cli/tests/integration_test.rs</code>:350 on 2023-09-07 08:38</div>
            <div class="timeline-body"><p>What will happen to this test when E225 gets promoted to stable? (i don't have good answer for testing this)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-07 08:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-09-07 15:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_cli/tests/integration_test.rs</code>:350 on 2023-09-07 15:12</div>
            <div class="timeline-body"><p>Great question, do we choose a new code? Should we have a couple of rules in a &quot;TEST&quot; category that do nothing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-09-07 18:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_cli/tests/integration_test.rs</code>:350 on 2023-09-07 18:25</div>
            <div class="timeline-body"><p>I'm looking into this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-09-07 18:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_cli/tests/integration_test.rs</code>:350 on 2023-09-07 18:40</div>
            <div class="timeline-body"><p>Not working... but an idea https://github.com/astral-sh/ruff/compare/zanie/rule-warning...zanie/rule-tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-08 06:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_cli/tests/integration_test.rs</code>:350 on 2023-09-08 06:32</div>
            <div class="timeline-body"><p>I'm a bit hesitant about adding test-only rules. We would need to filter them out in documentation, schema generation and prevent they can be selected in production (but then, we want them to be selectable in tests).</p>
<p>We could add the category behind a rust feature and make this an integration test (integration tests can require features), but this still suffers from the above-mentioned problems, although it has some more safeguards around it.</p>
<p>To me this is an inherent downside of our statically generated rule schema (instead of deriving a <code>Rule</code> array that has somewhat weaker keys which would allow you to mock out the rules).</p>
<p>I don't have a good solution to propose that doesn't require changing our rule structure or abstracting some of the logic by a trait that then allows overriding whether a rule is preview or not.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @zanieb on 2023-09-11 17:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @zanieb on 2023-09-11 18:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_cli/tests/integration_test.rs</code>:350 on 2023-09-11 23:09</div>
            <div class="timeline-body"><p>Doesn't the <code>#[cfg(test)]</code> approach address most of those concerns?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-09-11 23:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-09-11 23:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_cli/tests/integration_test.rs</code>:350 on 2023-09-11 23:09</div>
            <div class="timeline-body"><p>We can also wait and see how much of a burden it is to maintain the tests as-is. I don't like it though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-12 07:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_cli/tests/integration_test.rs</code>:350 on 2023-09-12 07:12</div>
            <div class="timeline-body"><p>iirc <code>#[cfg(test)]</code> is only available in the same crate and not across crates (https://users.rust-lang.org/t/what-are-the-rules-for-cfg-test/54122/2), so e.g. <code>ruff</code> <code>cfg(test)</code> rules would not be available in <code>ruff_cli</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-09-12 19:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_cli/tests/integration_test.rs</code>:350 on 2023-09-12 19:04</div>
            <div class="timeline-body"><p>Resources:</p>
<ul>
<li>https://nrxus.github.io/faux/guide/exporting-mocks.html</li>
<li>https://github.com/rust-lang/cargo/issues/8379</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_workspace/src/configuration.rs</code>:634 on 2023-09-12 19:42</div>
            <div class="timeline-body"><p>I'd vote to just remove that TODO -- I can't remember why it's there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_workspace/src/configuration.rs</code>:633 on 2023-09-12 19:43</div>
            <div class="timeline-body"><p>Because this doesn't use <code>warn_user_once_by_id</code>, the warnings will probably show up multiple times if we run this configuration resolution multiple times (which we might in a given invocation -- I can't remember exactly). Is it possible to use <code>warn_user_once_by_id</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_workspace/src/configuration.rs</code>:608 on 2023-09-12 19:44</div>
            <div class="timeline-body"><p>Cool so this is like -- you selected <code>CPY</code>, but preview is disabled?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_workspace/src/configuration.rs</code>:608 on 2023-09-12 19:44</div>
            <div class="timeline-body"><p>And this is like -- you selected <code>CPY</code>, but preview is disabled?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_workspace/src/configuration.rs</code>:603 on 2023-09-12 19:44</div>
            <div class="timeline-body"><p>So this like: you selected <code>CPY001</code>, but preview is disabled.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_workspace/src/configuration.rs</code>:608 on 2023-09-12 19:45</div>
            <div class="timeline-body"><p>Do both warnings show if you select <code>CPY001</code>? (Should they?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-12 19:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-09-12 19:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_workspace/src/configuration.rs</code>:633 on 2023-09-12 19:47</div>
            <div class="timeline-body"><p>Yeah but I'd have to construct an id string like &quot;nursery-{prefix}{code}&quot;, is that okay? I was thinking of adding a <code>warn_user_once_by_message</code> utility as an alternative? ü§∑‚Äç‚ôÄÔ∏è</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-09-12 19:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_workspace/src/configuration.rs</code>:608 on 2023-09-12 19:48</div>
            <div class="timeline-body"><p>Yep! I think the exact code would warn too. We could make this &quot;safer&quot; by adding <code>&amp;&amp; selector.rules(PreviewMode::Enabled).next().is_some()</code> but I think it's equivalent for now?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-12 19:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_workspace/src/configuration.rs</code>:633 on 2023-09-12 19:56</div>
            <div class="timeline-body"><p>I think that's okay (to add an ID like that)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-09-12 19:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_workspace/src/configuration.rs</code>:608 on 2023-09-12 19:57</div>
            <div class="timeline-body"><p>I can't write an integration test for exact codes yet since we don't have any preview rules.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-12 19:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_workspace/src/configuration.rs</code>:633 on 2023-09-12 19:57</div>
            <div class="timeline-body"><p>But I think the ID has to be a static string so that may not work...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-12 19:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_workspace/src/configuration.rs</code>:595 on 2023-09-12 19:58</div>
            <div class="timeline-body"><p>Does <code>warn_user_once!(&quot;The </code>NURSERY<code> selector has been deprecated. {suggestion}&quot;)</code> work?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-09-12 19:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_workspace/src/configuration.rs</code>:608 on 2023-09-12 19:59</div>
            <div class="timeline-body"><p>Do you mean like https://github.com/astral-sh/ruff/pull/7210/files#diff-92738d4e248765a1e48e3c930a03e20ed306f9b0c23dd67ad72912133dbb10f2R289-R306? Or if you select CPY <em>and</em> CPY001?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_workspace/src/configuration.rs</code>:595 on 2023-09-12 19:59</div>
            <div class="timeline-body"><p>Probably yeah I didn't realize it supported that at first and then did later :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-09-12 19:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_workspace/src/configuration.rs</code>:595 on 2023-09-12 20:00</div>
            <div class="timeline-body"><pre><code class="language-suggestion">                    warn_user_once!(&quot;The `NURSERY` selector has been deprecated. {suggestion}&quot;);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-09-12 20:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-12 20:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_workspace/src/configuration.rs</code>:608 on 2023-09-12 20:00</div>
            <div class="timeline-body"><p>I meant the former</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-09-12 20:01</div>
            <div class="timeline-body"><p>The warnings look reasonable to me.</p>
<p>One issue we may run into (which we've discussed before and I know you're aware of) is that users may want to enable a small number of preview rules, but don't want to enable (e.g.) the logical line rules, which will get enabled by default if they add <code>--preview</code>. Not sure how to resolve... Maybe being able to <code>--ignore PREVIEW</code> like you suggested. Anyway, not a block here, just coming to mind as I look at these deprecations.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2023-09-12 20:11</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/zanie/rule-warning">CodSpeed Performance Report</a></h2>
<h3>Merging #7210 will <strong>degrade performances by 4.8%</strong></h3>
<p><sub>Comparing <code>zanie/rule-warning</code> (0a067cc) with <code>main</code> (6566d00)</sub></p>
<h3>Summary</h3>
<p><code>‚ùå 5</code> regressions
<code>‚úÖ 20</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/zanie/rule-warning">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>main</code> | <code>zanie/rule-warning</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ‚ùå | <code>linter/all-rules[large/dataset.py]</code> | 154.5 ms | 161.9 ms | -4.57% |
| ‚ùå | <code>linter/all-rules[numpy/globals.py]</code> | 4 ms | 4.1 ms | -2.6% |
| ‚ùå | <code>linter/all-rules[numpy/ctypeslib.py]</code> | 33.2 ms | 34.3 ms | -3.2% |
| ‚ùå | <code>linter/all-rules[unicode/pypinyin.py]</code> | 15.4 ms | 15.7 ms | -2.29% |
| ‚ùå | <code>linter/all-rules[pydantic/types.py]</code> | 69.1 ms | 72.6 ms | -4.8% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-09-12 20:34</div>
            <div class="timeline-body"><blockquote>
<p>Not sure how to resolve... Maybe being able to --ignore PREVIEW like you suggested. Anyway, not a block here, just coming to mind as I look at these deprecations.</p>
</blockquote>
<p>Yeah I'm not sure what the proper solution for is either. We can hold off on merging the deprecations until we have a path forward? I don't have strong feelings, but we should find a decent migration story this week.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2023-09-13 20:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2023-09-13 20:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-09-13 20:30</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 02:39:46 UTC
    </footer>
</body>
</html>
