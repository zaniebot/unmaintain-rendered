<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] add initial Type::is_equivalent_to and Type::is_assignable_to - astral-sh/ruff #13332</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] add initial Type::is_equivalent_to and Type::is_assignable_to</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13332">#13332</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2024-09-12 02:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body"><p>These are quite incomplete, but I needed to start stubbing them out in order to build and test declared-types.</p>
<p>Allowing unused for now, until they are used later in the declared-types PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/carljm">@carljm</a> on 2024-09-12 02:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-09-12 02:39</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/carljm">@carljm</a> on 2024-09-12 02:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/carljm">@carljm</a> on 2024-09-12 02:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/carljm">@carljm</a> on 2024-09-12 02:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:328 on 2024-09-12 09:07</div>
            <div class="timeline-body"><p>nit: I know it can be tedious to list out all the missing branches here, but it means that it&#x27;s guaranteed that we won&#x27;t forget to update the method when we add new <code>Type</code> variants, so I&#x27;d prefer it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:636 on 2024-09-12 09:09</div>
            <div class="timeline-body"><p>is it worth special-casing <code>builtins</code> specifically? We&#x27;ll also need a more general-purpose way of querying if a module <code>X</code> has name <code>Y</code> and search-path <code>Z</code> for e.g. symbols from the <code>typing</code> modules -- and the <code>typing</code> module is <em>not</em> special-cased by the module resolver</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:755 on 2024-09-12 09:10</div>
            <div class="timeline-body"><p>what&#x27;s the reason for the clippy ignore here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-09-12 09:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:300 on 2024-09-12 11:40</div>
            <div class="timeline-body"><p>I would remove the comment because it doesn&#x27;t provide more information than the function signature or expand it to explain what assignability means.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:302 on 2024-09-12 11:42</div>
            <div class="timeline-body"><p>Is there a name that makes it more specific name than <code>other</code> that helps clarify the order of assignment (self is assigned to <code>other</code>?. Maybe <code>target</code>?</p>
<pre><code>    pub(crate) fn is_assignable_to(self, db: &amp;&#x27;db dyn Db, target: Type&lt;&#x27;db&gt;) -&gt; bool {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:305 on 2024-09-12 11:43</div>
            <div class="timeline-body"><p>I would move the <code>is_equivalent</code> into the default branch on line 324 so that we can get a full exhaustiveness check. Except if calling <code>is_equivalent</code> first is good for perf</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:635 on 2024-09-12 11:45</div>
            <div class="timeline-body"><p>Doesn&#x27;t <code>name</code> have a <code>PartialEq&lt;str&gt;</code> implementation</p>
<pre><code>                .is_some_and(|module| module.name() == &quot;builtins&quot;)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:755 on 2024-09-12 11:46</div>
            <div class="timeline-body"><p>It&#x27;s probably because <code>Ty</code> is passed by value to test-functions that don&#x27;t consume it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:841 on 2024-09-12 11:47</div>
            <div class="timeline-body"><p>Can you try if this works</p>
<pre><code>    #[test_case(&amp;Ty::BuiltinInstance(&quot;int&quot;), &amp;Ty::IntLiteral(1))]
    fn is_not_assignable_to(from: &amp;Ty, to: &amp;Ty) {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-09-12 11:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-09-12 12:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:300 on 2024-09-12 12:08</div>
            <div class="timeline-body"><p>Maybe a better comment would link to the typing spec section on assignability</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-09-12 12:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:302 on 2024-09-12 12:58</div>
            <div class="timeline-body"><p>I thought the method name <code>is_assignable_to</code> already made the directionality quite clear? But I don&#x27;t mind renaming the argument to <code>target</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-09-12 13:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:305 on 2024-09-12 13:00</div>
            <div class="timeline-body"><p>I did it for performance reasons, so that the first thing we check is simple Eq of the types, before doing any more unnecessary work. (But I haven&#x27;t done any benchmarking to verify that this makes a real difference.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-09-12 13:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:328 on 2024-09-12 13:06</div>
            <div class="timeline-body"><p>I don&#x27;t think this idea works when we&#x27;re talking about a double-match like this one. I definitely don&#x27;t think we want to list out every possible pair of Type variants; we&#x27;d end up with a match statement of n^2 size, with most arms just returning false.</p>
<p>The inherent nature of assignability is that the default case for two unrelated type variants is &quot;not assignable&quot;. I think it makes sense for the match statement to reflect this, and handle only the cases where they are or might be assignable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-09-12 13:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:755 on 2024-09-12 13:08</div>
            <div class="timeline-body"><p>Yeah; the alternative is sprinkling a bunch of annoying extra <code>&amp;</code> in front of every Ty in every test case, which IMO harms readability for no actual gain. I can add a comment here explaining why this is here, I thought about doing that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-09-12 13:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:841 on 2024-09-12 13:09</div>
            <div class="timeline-body"><p>It does work (I already tried it when writing the PR) but I don&#x27;t like it, it&#x27;s just useless noise when writing or reading the test cases. I would rather suppress the lint. There&#x27;s no actual problem with the current code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-09-12 13:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:636 on 2024-09-12 13:13</div>
            <div class="timeline-body"><p>Eh, probably not :) I was just doing the minimal needed for this PR. I can look at upgrading this to be able to identify any name from any stdlib module.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-09-12 13:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:328 on 2024-09-12 13:22</div>
            <div class="timeline-body"><p>Okay, fair enough!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-09-12 13:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:841 on 2024-09-12 13:24</div>
            <div class="timeline-body"><p>I&#x27;m fine with suppressing the clippy lint personally as long we add a comment saying why we&#x27;re doing it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-09-12 13:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:755 on 2024-09-12 13:51</div>
            <div class="timeline-body"><p>I figured out how to remove the clippy suppression by changing the <code>to_type</code> method to a consuming <code>into_type</code> method instead (with some help from @MichaReiser to realize that in order to make this work I had to have <code>Ty::Union</code> keep a vec instead of a boxed array).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-09-12 13:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:841 on 2024-09-12 13:55</div>
            <div class="timeline-body"><p>Got rid of the clippy suppression without all the extra <code>&amp;</code>!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:303 on 2024-09-12 14:02</div>
            <div class="timeline-body"><pre><code>    /// Return true if this type is [assignable to] type `target`.
    ///
    /// [assignable to]: https://typing.readthedocs.io/en/latest/spec/concepts.html#the-assignable-to-or-consistent-subtyping-relation
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-09-12 14:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/carljm">@carljm</a> on 2024-09-12 18:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2024-09-12 18:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-09-12 18:15</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:06:43 UTC
    </footer>
</body>
</html>
