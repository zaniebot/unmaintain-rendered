```yaml
number: 4751
title: Place comments of left and right binary expression operands
type: pull_request
state: merged
author: MichaReiser
labels:
  - internal
  - formatter
assignees: []
merged: true
base: main
head: binary-expression-comment-placement
created_at: 2023-05-31T09:40:41Z
updated_at: 2023-06-01T07:22:36Z
url: https://github.com/astral-sh/ruff/pull/4751
synced_at: 2026-01-12T15:55:16Z
```

# Place comments of left and right binary expression operands

---

_@MichaReiser_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This PR implements the custom logic that associates comments between the left binary expression operand and the oprator as trailing comments to the `left` AND trailing end of line comments that are on the same line as the operator as dangling comments of the binary expression. 

```python
a = (
    5 # trailing left comment
    + # trailing operator comment
    # leading right comment
    3
)
```

<!-- What's the purpose of the change? What does it do, and why? -->

## Test Plan

I added a few new snapshot tests


---

_Comment by @MichaReiser on 2023-05-31 09:40_

Current dependencies on/for this PR:
* main
  * **PR #4639** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4639" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #4641** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4641" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #4642** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4642" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #4671** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4671" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #4748** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4748" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
            * **PR #4751** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4751" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/charliermarsh/ruff/4751?utm_source=stack-comment).

---

_Label `internal` added by @MichaReiser on 2023-05-31 09:45_

---

_Label `autoformatter` added by @MichaReiser on 2023-05-31 09:45_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/trivia.rs`:12 on 2023-05-31 09:55_

I extracted this utility because we can re-use it when e.g. searching for a trailing `,`. 

We probably want another utility that searches backwards. This is going to be more expensive if the range contains line breaks, because we need to run to the start of the line to verify that the non-trivia character isn't a comment. However, we only need to do this for the second line:

```python
(a) # Cheap, because no line break between `(` and `a`
(
	# this is a comment
	a
) # Needs to process all characters, including the comment. 

(b + 
	a
) # Must process all of `(b +` only to return `+` the plus when searching from the `a` because it must test if `(b + ` is a comment
```

---

_@MichaReiser reviewed on 2023-05-31 09:55_

---

_Comment by @github-actions[bot] on 2023-05-31 09:56_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.01     15.3Â±0.08ms     2.7 MB/sec    1.00     15.2Â±0.11ms     2.7 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.6Â±0.01ms     4.6 MB/sec    1.00      3.6Â±0.02ms     4.6 MB/sec
linter/all-rules/numpy/globals.py          1.01    374.2Â±0.65Âµs     7.9 MB/sec    1.00    371.7Â±1.09Âµs     7.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.3Â±0.01ms     4.0 MB/sec    1.00      6.3Â±0.02ms     4.1 MB/sec
linter/default-rules/large/dataset.py      1.00      7.5Â±0.01ms     5.4 MB/sec    1.00      7.5Â±0.02ms     5.4 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1594.7Â±3.54Âµs    10.4 MB/sec    1.00   1589.7Â±9.11Âµs    10.5 MB/sec
linter/default-rules/numpy/globals.py      1.00    175.0Â±0.54Âµs    16.9 MB/sec    1.00    175.0Â±1.95Âµs    16.9 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.4Â±0.01ms     7.5 MB/sec    1.00      3.4Â±0.01ms     7.6 MB/sec
parser/large/dataset.py                    1.00      5.7Â±0.00ms     7.1 MB/sec    1.01      5.8Â±0.00ms     7.1 MB/sec
parser/numpy/ctypeslib.py                  1.00   1118.6Â±0.98Âµs    14.9 MB/sec    1.01   1132.3Â±2.10Âµs    14.7 MB/sec
parser/numpy/globals.py                    1.00    115.0Â±0.32Âµs    25.7 MB/sec    1.02    116.9Â±0.50Âµs    25.2 MB/sec
parser/pydantic/types.py                   1.00      2.4Â±0.00ms    10.4 MB/sec    1.01      2.5Â±0.00ms    10.3 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     17.0Â±0.21ms     2.4 MB/sec    1.03     17.5Â±0.28ms     2.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.3Â±0.06ms     3.9 MB/sec    1.04      4.4Â±0.08ms     3.8 MB/sec
linter/all-rules/numpy/globals.py          1.00   506.4Â±15.70Âµs     5.8 MB/sec    1.03    522.1Â±9.48Âµs     5.7 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.2Â±0.14ms     3.5 MB/sec    1.05      7.5Â±0.09ms     3.4 MB/sec
linter/default-rules/large/dataset.py      1.00      8.4Â±0.09ms     4.8 MB/sec    1.01      8.5Â±0.23ms     4.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1784.7Â±19.60Âµs     9.3 MB/sec    1.00  1787.1Â±21.69Âµs     9.3 MB/sec
linter/default-rules/numpy/globals.py      1.00    204.8Â±3.31Âµs    14.4 MB/sec    1.02   208.6Â±10.66Âµs    14.1 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.8Â±0.04ms     6.7 MB/sec    1.00      3.8Â±0.04ms     6.7 MB/sec
parser/large/dataset.py                    1.00      6.5Â±0.08ms     6.3 MB/sec    1.00      6.5Â±0.12ms     6.3 MB/sec
parser/numpy/ctypeslib.py                  1.00  1217.5Â±22.00Âµs    13.7 MB/sec    1.00  1212.0Â±19.85Âµs    13.7 MB/sec
parser/numpy/globals.py                    1.00    125.1Â±2.90Âµs    23.6 MB/sec    1.00    125.1Â±1.94Âµs    23.6 MB/sec
parser/pydantic/types.py                   1.00      2.8Â±0.04ms     9.2 MB/sec    1.00      2.8Â±0.04ms     9.3 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_@charliermarsh reviewed on 2023-05-31 15:06_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/comments/placement.rs`:478 on 2023-05-31 15:06_

Where should this be placed, in the formatted output?

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/comments/snapshots/ruff_python_formatter__comments__tests__nested_binary_expression.snap`:5 on 2023-05-31 15:58_

I continue to find these very very useful.

---

_@charliermarsh reviewed on 2023-05-31 15:58_

---

_@charliermarsh approved on 2023-05-31 15:58_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/comments/placement.rs`:478 on 2023-06-01 06:52_

The same as shown in this code snippet at the end of the operator line. 

---

_@MichaReiser reviewed on 2023-06-01 06:52_

---

_Merged by @MichaReiser on 2023-06-01 07:01_

---

_Closed by @MichaReiser on 2023-06-01 07:01_

---

_Branch deleted on 2023-06-01 07:01_

---
