<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>intern names in the symbol table - astral-sh/ruff #11675</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>intern names in the symbol table</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11675">#11675</a>
        opened by <a href="https://github.com/plredmond">@plredmond</a>
        on 2024-06-01 06:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/plredmond">@plredmond</a></div>
            <div class="timeline-body">intern all the names used in a module in its SymbolTable
background
<p>To implement kind-analysis for names, we must do a recursive traversal over the scopes in a module. This recursive traversal accumulates sets of names in a scope and its subscopes, and does some set operations on them. Therefore we either need to do set operations on sets of strings (possibly resulting in many allocations) or <em>intern all the names in the module</em> so that we may do set operations on sets of IDs. This PR implements the interning of names, in case we choose the italicized option.</p>
implementation
<ul>
<li>Add a <code>NameId</code> type</li>
<li>Replace <code>Name</code> field on <code>Symbol</code> with <code>NameId</code> field</li>
<li>Add an string-interning data structure <code>Names</code> to the symbol table</li>
<li>Add a method to <code>Symbol</code> and <code>NameId</code> with signature <code>fn(Self, Names) -&gt; Name</code></li>
<li>Update existing tests</li>
</ul>
note
<ul>
<li>~~Not ready for review b/c I have to rebase past conflicts~~</li>
<li>Currently interning takes place in <code>SymbolTable::add_or_update_symbol</code> but it should be pushed upstream to the callers in a subsequent PR</li>
<li>[ ] resolve most TODO/FIXME/NOTE before merging</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/plredmond">@plredmond</a> on 2024-06-01 06:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/plredmond">@plredmond</a> on 2024-06-01 06:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/plredmond">@plredmond</a> on 2024-06-01 06:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-06-01 06:54</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/lib.rs</code>:127 on 2024-06-01 07:45</div>
            <div class="timeline-body"><p>I think I would move this to the symbol table since it is the only place where this is used (and may also not require to be public)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-06-01 07:47</div>
            <div class="timeline-body"><p>Could you extend the PR summary with the motivation for this change?</p>
<p>I do like the idea of interning names because hashing names is something that shows up in Ruff benchmarks. However, I think this would have to happen earlier to be beneficial, e.g. as early as in the Lexer/Parser/AST (CC: @dhruvmanila not a priority, just floating an idea). The reason I&#x27;m saying this is because we already intern <code>Symbol</code> and I don&#x27;t think the case where the same name exists in multiple scopes justifies the cost of maintaining this mapping. But maybe there&#x27;s another reason why you&#x27;re adding the interning that I don&#x27;t see which justifies the cost of an extra hash map lookup..</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-01 08:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/src/lib.rs</code>:127 on 2024-06-01 16:06</div>
            <div class="timeline-body"><p>I agree, I&#x27;d just put this in <code>symbols.rs</code> for now. If we do want to split it out, I&#x27;d rather have it in its own module than directly in <code>lib.rs</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/src/lib.rs</code>:125 on 2024-06-01 16:06</div>
            <div class="timeline-body"><p>Can probably remove this comment</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/src/symbols.rs</code>:424 on 2024-06-01 16:10</div>
            <div class="timeline-body"><p>Is it clear this would be an improvement?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/src/symbols.rs</code>:448 on 2024-06-01 16:10</div>
            <div class="timeline-body"><p>If we only do this once, does it need encapsulating?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-06-01 16:15</div>
            <div class="timeline-body"><p>@MichaReiser, the motivation for this was the symbol table analysis pass to set symbol kinds (local, cellvar, freevar, global, etc). The nature of this analysis is that it&#x27;s a recursive-descent walk of the scopes, carrying along sets of names that are bound in enclosing scopes and free in enclosed scopes. This analysis is really all about names that are the same in different scopes; detecting when a name <code>x</code> in an inner scope is free and thus referencing a bound name <code>x</code> in an enclosing scope.</p>
<p>Either we intern names and perform this analysis using sets of <code>NameId</code>, or we have to do this analysis using sets of actual Names, and doing lots of equality comparisons on Names.</p>
<p>I think either way is doable; definitely open to your thoughts on whether the name interning is worth it.</p>
<p>Another side benefit of the name interning is that it provides an easy path to make <code>Definition</code> <code>Copy</code> :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-02 13:02</div>
            <div class="timeline-body"><p>Thanks for the explanation. It helping to make <code>Definition</code> <code>Copy</code> is a nice added benefit, although I think definition needs to change when migrating to <code>Salsa</code>.</p>
<p>I&#x27;m still hesitant because the performance implications are not clear. We&#x27;re trading memory usage and faster building of symbol tables with additional overhead when querying the symbol table by name. Unfortunately, we don&#x27;t have any way of measuring the performance impact (end to end) today to know if this is an overall improvement.</p>
<p>It&#x27;s also unclear to me how interning would work with Salsa where queries get invalidated if a returned value no longer compares equal. This is problematic if any query results use a <code>NameId</code> and we use a simple interning where we assign <code>Id</code>s by the order names are resolved (adding a new name at the top of the file would invalidate all subsequent names).</p>
<p>I would recommend that we first implement the logic without interning. I suspect that adopting the implementation to use <code>NameId</code> instead of <code>Name</code> should be trivial.  A concrete implementation will help exploring if there are alternative optimisations. For example, the symbol table already uses the <code>raw_entry().from_hash()</code> methods internally. We could hash the symbol&#x27;s name once and then reuse the has to lookup the same name in the child scopes. Or we could even add the precomputed hash to <code>Symbol</code> to avoid having to rehash when growing the hash map.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/plredmond">@plredmond</a> reviewed on 2024-06-03 04:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/plredmond">@plredmond</a> on <code>crates/red_knot/src/lib.rs</code>:127 on 2024-06-03 04:21</div>
            <div class="timeline-body"><p>I put the implementation in <code>lib.rs</code> because that&#x27;s where <code>Name</code> is defined. Following the example of <code>FileId</code> and <code>Files</code>, it might make sense for <code>Names</code> to get its own <code>.rs</code> module. If we follow @MichaReiser&#x27;s suggestion to intern earlier than at the level of a module&#x27;s symbol table, then it definitely wouldn&#x27;t belong in <code>symbols.rs</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/plredmond">@plredmond</a> reviewed on 2024-06-03 04:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/plredmond">@plredmond</a> on <code>crates/red_knot/src/symbols.rs</code>:424 on 2024-06-03 04:24</div>
            <div class="timeline-body"><p>Yes, I think this current implementation will copy the name every time a symbol with that name is found. Whereas, pushing it up into the caller might save an intern here or there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/plredmond">@plredmond</a> reviewed on 2024-06-03 04:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/plredmond">@plredmond</a> on <code>crates/red_knot/src/symbols.rs</code>:448 on 2024-06-03 04:25</div>
            <div class="timeline-body"><p>I think it&#x27;s an internal detail of the hash table that shouldn&#x27;t be in this module. It&#x27;s coupled to the implementation of <code>Names</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/plredmond">@plredmond</a> on 2024-06-03 04:29</div>
            <div class="timeline-body"><p>I agree with @MichaReiser&#x27;s suggestion that I should complete kind-analysis first and we can switch it to use intern&#x27;d names later if we want. Interning introduces some difficult questions about caching of interned names.</p>
<ul>
<li>Although interning here at the module level seems safe, because we can evict interned names when the module is invalidated, <strong>it will be annoying to talk about names <em>across</em> modules</strong>.</li>
<li>Interning at an earlier stage is even worse: We&#x27;d end up with <strong>a cache of interned names that we can never fully invalidate</strong> because we don&#x27;t know which interned names are in use and which aren&#x27;t.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/plredmond">@plredmond</a> on 2024-06-03 19:08</div>
            <div class="timeline-body"><p>We don&#x27;t need this at this point.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/plredmond">@plredmond</a> on 2024-06-03 19:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-20 09:00</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:04:21 UTC
    </footer>
</body>
</html>
