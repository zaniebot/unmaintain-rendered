<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Switch to a handwritten parser for mdtest error assertions - astral-sh/ruff #16422</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Switch to a handwritten parser for mdtest error assertions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16422">#16422</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-02-27 20:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body">Summary
<p>I keep on making mistakes when writing mdtests that the framework makes hard to debug. The latest iteration here was when I added a test that looked like this while working on <a href="https://github.com/astral-sh/ruff/pull/16321">astral-sh/ruff#16321</a>:</p>
<pre><code>```py
class TestIter:
    def __next__(self) -&gt; int:
        return 42

class Test:
    def __iter__(self) -&gt; TestIter | int:
        return TestIter()

# error: [not-iterable] &quot;Object of type `Test` may not be iterable because its `__iter__` method returns an object of type `TestIter | int`, which may not have a `__next__` method
for x in Test():
    reveal_type(x)  # revealed: int
```
</code></pre>
<p>Notice the mistake there? It took me an annoying amount of time to figure it out. The error in the test is that the asserted error message is missing its closing <code>&quot;</code> character. But mdtest doesn&#x27;t tell you that if you apply this diff to <code>main</code>:</p>
<pre><code>diff --git a/crates/red_knot_python_semantic/resources/mdtest/loops/for.md b/crates/red_knot_python_semantic/resources/mdtest/loops/for.md
index 394c104b9..c32cbda7e 100644
--- a/crates/red_knot_python_semantic/resources/mdtest/loops/for.md
+++ b/crates/red_knot_python_semantic/resources/mdtest/loops/for.md
@@ -286,7 +286,7 @@ class Test:
     def __iter__(self) -&gt; TestIter | int:
         return TestIter()
 
-# error: [not-iterable] &quot;Object of type `Test` may not be iterable because its `__iter__` method returns an object of type `TestIter | int`, which may not have a `__next__` method&quot;
+# error: [not-iterable] &quot;Object of type `Test` may not be iterable because its `__iter__` method returns an object of type `TestIter | int`, which may not have a `__next__` method
 for x in Test():
     reveal_type(x)  # revealed: int
</code></pre>
<p>Instead it says:</p>
<pre><code>failures:

---- mdtest__loops_for stdout ----

for.md - For loops - Union type as iterator where one union element has no `__next__` method

  crates/red_knot_python_semantic/resources/mdtest/loops/for.md:290 unexpected error: [not-iterable] &quot;Object of type `Test` may not be iterable because its `__iter__` method returns an object of type `TestIter | int`, which may not have a `__next__` method&quot;

To rerun this specific test, set the environment variable: MDTEST_TEST_FILTER=&quot;for.md - For loops - Union type as iterator where one union element has no `__next__` method&quot;
MDTEST_TEST_FILTER=&quot;for.md - For loops - Union type as iterator where one union element has no `__next__` method&quot; cargo test -p red_knot_python_semantic --test mdtest -- mdtest__loops_for
</code></pre>
<p>This PR switches our parsing of <code># error:</code> assertion comments from regexes to a custom parser. This allows us to explicitly reject malformed assertion messages like this rather than misinterpreting them. Helpful messages are now given to the user in this and many other cases when a malformed assertion message is identified. Assertion messages are also now parsed lazily when matching assertion messages to the diagnostics that are emitted: this allows us to print tailored error messages to the terminal about the malformed assertion messages and recover from them, which would be harder if they were parsed eagerly.</p>
Test Plan
<p>I added many unit tests to the <code>red_knot_test</code> crate. I also manually checked that if you apply the diff given above, mdtest now produces this error message:</p>
<pre><code>failures:

---- mdtest__loops_for stdout ----

for.md - For loops - Union type as iterator where one union element has no `__next__` method

  crates/red_knot_python_semantic/resources/mdtest/loops/for.md:290 invalid assertion: expected &#x27;&quot;&#x27; to be the final character in an assertion with an error message
  crates/red_knot_python_semantic/resources/mdtest/loops/for.md:290 unexpected error: 10 [not-iterable] &quot;Object of type `Test` may not be iterable because its `__iter__` method returns an object of type `TestIter | int`, which may not have a `__next__` method&quot;

To rerun this specific test, set the environment variable: MDTEST_TEST_FILTER=&quot;for.md - For loops - Union type as iterator where one union element has no `__next__` method&quot;
MDTEST_TEST_FILTER=&quot;for.md - For loops - Union type as iterator where one union element has no `__next__` method&quot; cargo test -p red_knot_python_semantic --test mdtest -- mdtest__loops_for
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-27 20:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-27 20:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-27 20:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-27 20:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-27 20:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-02-27 20:41</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>‚úÖ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>‚úÖ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>‚úÖ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>‚úÖ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/src/matcher.rs</code>:141 on 2025-02-28 00:47</div>
            <div class="timeline-body"><p>Seems a little odd that you only get assertion-parsing errors if there is at least one diagnostic that could match the assertion, but I think in practice it&#x27;s fine?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-02-28 00:49</div>
            <div class="timeline-body"><p>üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-02-28 06:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_test/src/assertion.rs</code>:328 on 2025-02-28 06:28</div>
            <div class="timeline-body"><p>nit: you could implement <a href="https://doc.rust-lang.org/stable/std/str/trait.FromStr.html"><code>FromStr</code></a> instead</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/assertion.rs</code>:260 on 2025-02-28 08:15</div>
            <div class="timeline-body"><p>Not necessarily something for this PR but two common errors that I made in the past:</p>
<ul>
<li>I wrote <code>error[code]:</code> which is wrong</li>
<li>I misspelled <code>error</code> or <code>revealed</code></li>
<li>Too much or not enough whitespace between <code>#</code> and the pragma keyword`</li>
</ul>
<p>The second one is probably easy to detect (error on any comment of the form <code>&lt;pragma&gt;:</code> and allowlist legit pragmas (<code>fmt</code>, <code>type</code>, <code>knot</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/assertion.rs</code>:260 on 2025-02-28 08:18</div>
            <div class="timeline-body"><p>I think it would be good to make this method be less strict about the amount of whitespace between <code>#</code> and the keyword and colon</p>
<pre><code>let comment = comment.strip_prefix(&#x27;#&#x27;)?;
let (code, rest) = comment.split_once(&#x27;:&#x27;)?;

match code.trim():
	&quot;revealed&quot; =&gt; Some(Self::Revealed(rest.trim()))
	&quot;error&quot; =&gt; Some(Self::Error(rest.trim())),
	_ =&gt; None
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/assertion.rs</code>:423 on 2025-02-28 08:22</div>
            <div class="timeline-body"><p>I&#x27;m not sure if <code>memmem</code> is worth using here, considering that this reads through like 20 bytes. It might just be easier to use <code>self.eat_while(|c| c != &#x27;]&#x27;)</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/assertion.rs</code>:432 on 2025-02-28 08:23</div>
            <div class="timeline-body"><pre><code>                        [self.offset().to_usize()..self.comment_source.trim_end().len() - 1];
</code></pre>
<p>This could panic if the string doesn&#x27;t end with a <code>&quot;</code> but the last character is a multi bytes character. Why not <code>self.eath_while(|c| c != &#x27;&quot;&#x27;)</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/assertion.rs</code>:400 on 2025-02-28 08:26</div>
            <div class="timeline-body"><p>Nit: I prefer to use <code>bump</code> over <code>first</code> because it guarantees that each iteration progresses. It&#x27;s otherwise very easy to forget bumping the current character or checking if the cursor isn&#x27;t eof.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/matcher.rs</code>:141 on 2025-02-28 08:27</div>
            <div class="timeline-body"><p>Would it be hard to force-parse unmatched assertions?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-02-28 08:27</div>
            <div class="timeline-body"><p>Nice</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-28 10:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/src/assertion.rs</code>:328 on 2025-02-28 10:11</div>
            <div class="timeline-body"><p>This was my first thought too, but unfortunately I don&#x27;t think it works because of the fact that <code>ErrorAssertion</code> is generic over a lifetime :-( Or at least, I can&#x27;t seem to make it work</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-28 11:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/src/assertion.rs</code>:260 on 2025-02-28 11:01</div>
            <div class="timeline-body"><blockquote>
<p>The second one is probably easy to detect (error on any comment of the form <code>&lt;pragma&gt;:</code> and allowlist legit pragmas (<code>fmt</code>, <code>type</code>, <code>knot</code>)</p>
</blockquote>
<p>Hah, you would <em>think</em> so... I&#x27;ve just spent a bit of time playing around with it, and it seems surprisingly hard to shoehorn into our current architecture :-(</p>
<p>I&#x27;m making the whitespace handling more lenientm though; that&#x27;s easy to fix</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-28 11:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/src/assertion.rs</code>:432 on 2025-02-28 11:10</div>
            <div class="timeline-body"><blockquote>
<p>This could panic if the string doesn&#x27;t end with a <code>&quot;</code> but the last character is a multi bytes character.</p>
</blockquote>
<p>good point, thanks!</p>
<blockquote>
<p>Why not <code>self.eath_while(|c| c != &#x27;&quot;&#x27;)</code>?</p>
</blockquote>
<p>that doesn&#x27;t work because some of our revealed types and error messages include <code>&quot;</code> characters (e.g. <code>Literal[&quot;foo&quot;]</code>). But I can do something else.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-28 11:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/src/matcher.rs</code>:141 on 2025-02-28 11:26</div>
            <div class="timeline-body"><p>I don&#x27;t think it fits neatly into the current architecture. I&#x27;m going to defer it for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-28 11:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/src/matcher.rs</code>:141 on 2025-02-28 11:26</div>
            <div class="timeline-body"><p>I&#x27;ll add a TODO</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-28 11:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/src/matcher.rs</code>:141 on 2025-02-28 11:28</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/16422/commits/5203341f8d1e261e657cb4591348756e4d1a08fc</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-28 11:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-28 11:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-28 11:33</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:11:52 UTC
    </footer>
</body>
</html>
