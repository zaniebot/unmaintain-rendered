<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memoize text width - astral-sh/ruff #6552</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Memoize text width</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6552">#6552</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-08-14 08:21
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>The formatter processes strings a couple of times:</p>
<ul>
<li><code>propagate_expands</code>: Test if the string contains a newline and, if so, set <code>mode: Propagated</code> on all enclosing groups</li>
<li><code>print_text</code>: Measures the width of the text to compute the <code>line_width</code></li>
<li><code>fits_text</code> (only if the text is inside of a group): Measures the width of the text to determine if the content fits. Runs <code>n</code> times where <code>n</code> is the number of parent groups.</li>
</ul>
<p>This PR adds a <code>TextWidth</code> field to all text <code>FormatElement</code>s that either stores the computed width or that it is a multiline string.
This reduces the traversal for non-multiline strings to exactly once. Multiline strings still get traversed multiple times and you could argue this PR makes it worse because the implementation now computes the text width only to throw it away when realizing it is a multiline string. However, multiline strings are rare.</p>
<p>Memoizing the text width improves performance by 2-12%.</p>
<p>The downsides of this change are:</p>
<ul>
<li>It will make it harder to add more fields to <code>Text</code> <code>FormatElement</code>s because we are now very close to the 24 bytes</li>
<li>The same logic is now spread in multiple places, increasing the risk of one-off bugs</li>
</ul>
<!-- What's the purpose of the change? What does it do, and why? -->

<h2>Test Plan</h2>
<p>The tests are currently failing because I need to update them to pass <code>TextWidth</code></p>
<!-- How was it tested? -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-14 08:22</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #7048</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7048" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #6552</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6552" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ<ul>
<li><strong>PR #7037</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7037" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6552?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @MichaReiser on 2023-08-14 08:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-08-14 08:57</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01      3.8Â±0.03ms    10.8 MB/sec    1.00      3.7Â±0.03ms    10.9 MB/sec
formatter/numpy/ctypeslib.py               1.02   731.3Â±14.42Âµs    22.8 MB/sec    1.00    716.8Â±8.55Âµs    23.2 MB/sec
formatter/numpy/globals.py                 1.03     74.5Â±0.44Âµs    39.6 MB/sec    1.00     72.2Â±0.28Âµs    40.9 MB/sec
formatter/pydantic/types.py                1.02  1476.4Â±34.21Âµs    17.3 MB/sec    1.00  1443.0Â±24.24Âµs    17.7 MB/sec
linter/all-rules/large/dataset.py          1.00     10.6Â±0.03ms     3.8 MB/sec    1.00     10.6Â±0.04ms     3.8 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      2.9Â±0.00ms     5.7 MB/sec    1.00      2.9Â±0.01ms     5.8 MB/sec
linter/all-rules/numpy/globals.py          1.01    329.9Â±1.06Âµs     8.9 MB/sec    1.00    328.1Â±0.99Âµs     9.0 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.5Â±0.04ms     4.6 MB/sec    1.00      5.5Â±0.04ms     4.6 MB/sec
linter/default-rules/large/dataset.py      1.01      5.6Â±0.01ms     7.2 MB/sec    1.00      5.6Â±0.02ms     7.2 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1195.3Â±2.96Âµs    13.9 MB/sec    1.00   1197.6Â±3.37Âµs    13.9 MB/sec
linter/default-rules/numpy/globals.py      1.00    123.7Â±0.44Âµs    23.8 MB/sec    1.00    123.6Â±1.59Âµs    23.9 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.5Â±0.01ms    10.1 MB/sec    1.00      2.5Â±0.02ms    10.1 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                    pr
-----                                      ----                                    --
formatter/large/dataset.py                 1.01      4.5Â±0.31ms     9.0 MB/sec     1.00      4.5Â±0.25ms     9.0 MB/sec
formatter/numpy/ctypeslib.py               1.01   894.6Â±45.91Âµs    18.6 MB/sec     1.00   882.4Â±42.19Âµs    18.9 MB/sec
formatter/numpy/globals.py                 1.00     92.0Â±7.05Âµs    32.1 MB/sec     1.02     93.5Â±7.71Âµs    31.6 MB/sec
formatter/pydantic/types.py                1.00  1797.1Â±115.03Âµs    14.2 MB/sec    1.03  1851.1Â±111.61Âµs    13.8 MB/sec
linter/all-rules/large/dataset.py          1.00     15.1Â±0.48ms     2.7 MB/sec     1.02     15.4Â±0.67ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.2Â±0.16ms     4.0 MB/sec     1.04      4.3Â±0.23ms     3.9 MB/sec
linter/all-rules/numpy/globals.py          1.00   537.8Â±25.25Âµs     5.5 MB/sec     1.02   546.9Â±26.88Âµs     5.4 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.8Â±0.29ms     3.3 MB/sec     1.05      8.2Â±0.52ms     3.1 MB/sec
linter/default-rules/large/dataset.py      1.00      8.4Â±0.28ms     4.8 MB/sec     1.00      8.4Â±0.30ms     4.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1794.2Â±76.48Âµs     9.3 MB/sec     1.01  1803.3Â±92.73Âµs     9.2 MB/sec
linter/default-rules/numpy/globals.py      1.01   220.2Â±12.23Âµs    13.4 MB/sec     1.00    218.0Â±8.44Âµs    13.5 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.7Â±0.14ms     6.9 MB/sec     1.01      3.8Â±0.16ms     6.8 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @konstin on 2023-08-14 18:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2023-09-02 07:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @MichaReiser on 2023-09-02 08:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @MichaReiser on 2023-09-05 08:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_formatter/src/format_element.rs</code>:429 on 2023-09-05 10:38</div>
            <div class="timeline-body"><p>can you add a static assert for its (or the entire text elements) size?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_formatter/src/format_element.rs</code>:412 on 2023-09-05 10:43</div>
            <div class="timeline-body"><p>What about <code>NonZeroU32::MIN.saturating_add(width)</code> or <code>NonZerou32::new(1).unwrap().saturating_add(width)</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_formatter/src/format_element.rs</code>:412 on 2023-09-05 10:44</div>
            <div class="timeline-body"><p>please add a comment about the +1/-1 trickery in general</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_formatter/src/format_element.rs</code>:443 on 2023-09-05 10:45</div>
            <div class="timeline-body"><p>When does <code>c</code> not have a width and why would we go with 0 instead, is this about control characters?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_formatter/src/printer/mod.rs</code>:1111 on 2023-09-05 10:47</div>
            <div class="timeline-body"><p>it's inconsistent that it's once <code>width</code> and once <code>text_width</code>, both in a <code>Text</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_formatter/src/printer/mod.rs</code>:1343 on 2023-09-05 10:50</div>
            <div class="timeline-body"><p>nit: i think i'd use a match here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/comments/format.rs</code>:375 on 2023-09-05 10:52</div>
            <div class="timeline-body"><pre><code class="language-suggestion">            let width = 2 + TextWidth::from_text(&amp;normalized_comment, f.options().tab_width())
                .width()
                .expect(&quot;Expected comment not to contain any newlines&quot;);
</code></pre>
<p>more intuitive for me because it's first the two spaces and then the comment. maybe even <code>&quot;  &quot;.text_len()</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-09-05 10:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-09-05 10:53</div>
            <div class="timeline-body"><p>Sorry i had missed this PR.</p>
<p>I'll try to trigger codspeed for perf numbers.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2023-09-05 10:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @konstin on 2023-09-05 10:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-05 10:56</div>
            <div class="timeline-body"><blockquote>
<p>Sorry i had missed this PR.</p>
<p>I'll try to trigger codspeed for perf numbers.</p>
</blockquote>
<p>Code speed only comments on regressions but you can see the results in the run summary https://github.com/astral-sh/ruff/pull/6552/checks?check_run_id=16438240046</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-09-05 10:56</div>
            <div class="timeline-body"><p><img src="https://github.com/astral-sh/ruff/assets/6826232/1d300b39-f5f8-4be6-a43a-f9540c984910" alt="image" />
3-12%, that's huge!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-06 06:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_formatter/src/printer/mod.rs</code>:1343 on 2023-09-06 06:59</div>
            <div class="timeline-body"><p>Me too but our pedantic clippy rule doesn't allow me to</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-06 07:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_formatter/src/format_element.rs</code>:443 on 2023-09-06 07:01</div>
            <div class="timeline-body"><p>From the unicode width documentation</p>
<blockquote>
<p>Returns the character's displayed width in columns, or None if the character is a control character other than '\x00'.</p>
</blockquote>
<p>So yes, this is about control characters and using 0 seems reasonable to me (this is the same logic as applied by the printer today)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-06 07:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_formatter/src/format_element.rs</code>:414 on 2023-09-06 07:02</div>
            <div class="timeline-body"><p>I added this newtype wrapper to lock down the access to the inner <code>NonZeroU32</code>. Not that someone uses it and then gets values that are off by one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-06 07:05</div>
            <div class="timeline-body"><blockquote>
<p><img src="https://user-images.githubusercontent.com/6826232/265675563-1d300b39-f5f8-4be6-a43a-f9540c984910.png" alt="image" /> 3-12%, that's huge!</p>
</blockquote>
<p>The win is bigger for formats that</p>
<p>a) Use more groups or best fitting elements because the printer has to measure <code>fits</code> for every group (there's some optimisation but the worst case scenario is that it computes it for every group)
b) Code that has many lines exceeding the line width (with nested groups), because the printer than has to measure fits for every inner group</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-09-06 07:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-09-06 07:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-09-06 07:10</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:59:32 UTC
    </footer>
</body>
</html>
