```yaml
number: 6561
title: "Support `fmt: skip` for simple-statements and decorators"
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: fmt-skip-statement-and-decorators
created_at: 2023-08-14T13:51:04Z
updated_at: 2023-08-17T06:14:15Z
url: https://github.com/astral-sh/ruff/pull/6561
synced_at: 2026-01-12T15:55:21Z
```

# Support `fmt: skip` for simple-statements and decorators

---

_@MichaReiser_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This PR implements support for trailing `fmt: skip` and `fmt: off` comments on statement and decorator level. 

This PR does not yet implement `fmt: skip` support at the end of a case header, e.g. at the end of an `if` statement

<!-- What's the purpose of the change? What does it do, and why? -->

## Test Plan

Matching black tests, added new tests

<!-- How was it tested? -->


---

_Comment by @MichaReiser on 2023-08-14 13:51_

Current dependencies on/for this PR:
* main
  * **PR #6589** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6589" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #6561** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6561" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
      * **PR #6593** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6593" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6561?utm_source=stack-comment).

---

_Comment by @github-actions[bot] on 2023-08-14 14:19_

## PR Check Results
### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      3.4Â±0.03ms    11.9 MB/sec    1.00      3.4Â±0.04ms    12.0 MB/sec
formatter/numpy/ctypeslib.py               1.00    710.6Â±2.65Âµs    23.4 MB/sec    1.01   714.3Â±10.55Âµs    23.3 MB/sec
formatter/numpy/globals.py                 1.00     75.7Â±0.31Âµs    39.0 MB/sec    1.00     75.8Â±0.34Âµs    38.9 MB/sec
formatter/pydantic/types.py                1.00  1393.2Â±23.61Âµs    18.3 MB/sec    1.00  1391.0Â±25.38Âµs    18.3 MB/sec
linter/all-rules/large/dataset.py          1.00     10.6Â±0.25ms     3.9 MB/sec    1.01     10.6Â±0.29ms     3.8 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      2.8Â±0.07ms     5.9 MB/sec    1.00      2.8Â±0.07ms     5.9 MB/sec
linter/all-rules/numpy/globals.py          1.01    397.9Â±1.60Âµs     7.4 MB/sec    1.00    394.9Â±1.71Âµs     7.5 MB/sec
linter/all-rules/pydantic/types.py         1.03      5.6Â±0.21ms     4.6 MB/sec    1.00      5.4Â±0.10ms     4.7 MB/sec
linter/default-rules/large/dataset.py      1.01      5.5Â±0.09ms     7.4 MB/sec    1.00      5.5Â±0.07ms     7.4 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1209.6Â±6.54Âµs    13.8 MB/sec    1.00   1212.7Â±6.77Âµs    13.7 MB/sec
linter/default-rules/numpy/globals.py      1.00    143.8Â±3.91Âµs    20.5 MB/sec    1.00    143.8Â±5.33Âµs    20.5 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.5Â±0.02ms    10.3 MB/sec    1.00      2.5Â±0.04ms    10.3 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      3.7Â±0.04ms    10.9 MB/sec    1.01      3.8Â±0.24ms    10.8 MB/sec
formatter/numpy/ctypeslib.py               1.00   772.2Â±14.12Âµs    21.6 MB/sec    1.00   769.0Â±15.21Âµs    21.7 MB/sec
formatter/numpy/globals.py                 1.00     80.5Â±1.37Âµs    36.6 MB/sec    1.02     81.9Â±3.27Âµs    36.0 MB/sec
formatter/pydantic/types.py                1.00  1550.2Â±34.30Âµs    16.5 MB/sec    1.00  1555.0Â±37.94Âµs    16.4 MB/sec
linter/all-rules/large/dataset.py          1.00     12.8Â±0.19ms     3.2 MB/sec    1.00     12.8Â±0.21ms     3.2 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.5Â±0.04ms     4.7 MB/sec    1.00      3.5Â±0.05ms     4.7 MB/sec
linter/all-rules/numpy/globals.py          1.01    445.7Â±7.51Âµs     6.6 MB/sec    1.00    440.5Â±7.69Âµs     6.7 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.6Â±0.10ms     3.8 MB/sec    1.00      6.6Â±0.19ms     3.8 MB/sec
linter/default-rules/large/dataset.py      1.01      7.1Â±0.10ms     5.8 MB/sec    1.00      7.0Â±0.06ms     5.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.02  1505.6Â±29.53Âµs    11.1 MB/sec    1.00  1482.6Â±21.01Âµs    11.2 MB/sec
linter/default-rules/numpy/globals.py      1.00    175.6Â±3.39Âµs    16.8 MB/sec    1.00    175.9Â±4.73Âµs    16.8 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.2Â±0.04ms     8.1 MB/sec    1.00      3.1Â±0.03ms     8.1 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_@MichaReiser reviewed on 2023-08-14 16:12_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/statement/stmt_class_def.rs`:126 on 2023-08-14 16:12_

For tomorrow: Should we instead add a `is_suppressed` method to `FormatNodeRule` and pass the `trailing_comments`. It would prevent the extra lookup of the trailing comments only to test whether the statement is suppressed or not. 

The downside of this is that we need to override the function for every single statement but that could be justified to safe on 2-3% formatting performance

---

_Marked ready for review by @MichaReiser on 2023-08-15 06:12_

---

_Label `formatter` added by @MichaReiser on 2023-08-15 06:12_

---

_@MichaReiser reviewed on 2023-08-15 06:34_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/lib.rs`:54 on 2023-08-15 06:34_

I considered handling the suppression in the `FormatStmt` so that it isn't necessary to override `is_suppressed` for all statements. However, it requires that `FormatStmt` resolves the trailing comments to test for a suppression comment, just for the `FormatNodeRule` to lookup the very same comments again.

---

_Renamed from "Support `fmt: skip` on statement and decorator level" to "Support `fmt: skip` for simple-statements and decorator level" by @MichaReiser on 2023-08-15 11:53_

---

_Renamed from "Support `fmt: skip` for simple-statements and decorator level" to "Support `fmt: skip` for simple-statements and decorators" by @MichaReiser on 2023-08-15 11:53_

---

_Review requested from @charliermarsh by @MichaReiser on 2023-08-15 11:55_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/comments/placement.rs`:908 on 2023-08-16 13:48_

End-of-line comments are already correctly associated, I'm guessing, since they're associated with the preceding rather than the following node?

---

_@charliermarsh approved on 2023-08-16 13:54_

---

_@MichaReiser reviewed on 2023-08-17 05:51_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/comments/placement.rs`:908 on 2023-08-17 05:51_

Yes. The default placement correctly associates them with the decorator (preceding) node. 

---

_Merged by @MichaReiser on 2023-08-17 05:58_

---

_Closed by @MichaReiser on 2023-08-17 05:58_

---

_Branch deleted on 2023-08-17 05:58_

---
