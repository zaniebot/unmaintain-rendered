<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upgrade zizmor to the latest version in CI - astral-sh/ruff #15649</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Upgrade zizmor to the latest version in CI</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15649">#15649</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-01-21 15:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-01-21 15:59</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>The latest version of zizmor points out that we have the default permissions set in several of our GitHub workflows that don't really need any permissions at all. These can be made more secure by restricting the permissions for these workflows.</p>
<h2>Test Plan</h2>
<p>CI on this PR. All workflows being modified here are fully run as part of normal PR CI.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-01-21 15:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> removed by @AlexWaygood on 2025-01-21 15:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ci</span> added by @AlexWaygood on 2025-01-21 16:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-21 16:08</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @AlexWaygood on 2025-01-21 18:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-21 18:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>.github/zizmor.yml</code>:17 on 2025-01-21 18:03</div>
            <div class="timeline-body"><p>I didn't make modifications to these files because they don't run as part of normal PR CI (only during releases, usually) and it wasn't obvious to me how to figure out what permissions each workflow needs. I didn't want to break the release workflow, and it didn't seem worth investing a large amount of time into trying to investigate exactly what permissions each workflow needed, so I left it for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @AlexWaygood on 2025-01-21 18:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>.github/zizmor.yml</code>:17 on 2025-01-22 05:05</div>
            <div class="timeline-body"><p>The permissions related to jobs in the release workflow are in <code>Cargo.toml</code> here:</p>
<p>https://github.com/astral-sh/ruff/blob/4cfa3555199f9377b29c490cbb703beb6b1eb3b4/Cargo.toml#L309-L310</p>
<p>And, can also be referred in the <code>release.yml</code>.</p>
<p>So, I think it's just <code>build-docker.yml</code> that requires specific permission while the other two jobs don't require any.</p>
<p>But, I'm fine leaving it as it is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-01-22 05:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-01-22 07:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>.github/zizmor.yml</code>:16 on 2025-01-22 07:13</div>
            <div class="timeline-body"><p>It might be helpful to add a short comment explaining why they ignored. Ideally, this wouldn't be necessary (maybe add a todo?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-01-22 07:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-22 11:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>.github/zizmor.yml</code>:17 on 2025-01-22 11:24</div>
            <div class="timeline-body"><p>Aah, thank you for pointing that out!</p>
<blockquote>
<p>So, I think it's just <code>build-docker.yml</code> that requires specific permission while the other two jobs don't require any.</p>
</blockquote>
<p>I think if we put <code>permissions: {}</code> in e.g. <code>publish-wasm.yml</code>, it would override the permissions passed to the workflow by <code>release.yml</code> -- the <a href="https://docs.github.com/en/actions/sharing-automations/reusing-workflows#supported-keywords-for-jobs-that-call-a-reusable-workflow">docs here</a> state:</p>
<blockquote>
<p>The <code>GITHUB_TOKEN</code> permissions passed from the caller workflow can be only downgraded (not elevated) by the called workflow.</p>
</blockquote>
<p>And the called workflow here would be <code>publish-wasm.yml</code>, so that would mean that <code>publish-wasm.yml</code>'s more restricted permissions would downgrade the permissions passed to it by <code>release.yml</code>, breaking the release workflow.</p>
<p>I think that means that each of these workflows needs to have exactly the same permissions in their individual workflow files as they have passed to them by <code>release.yml</code> -- does that sound right to you?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-01-22 13:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>.github/zizmor.yml</code>:17 on 2025-01-22 13:33</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>The <code>GITHUB_TOKEN</code> permissions passed from the caller workflow can be only downgraded (not elevated) by the called workflow.</p>
</blockquote>
<p>And the called workflow here would be <code>publish-wasm.yml</code>, so that would mean that <code>publish-wasm.yml</code>'s more restricted permissions would downgrade the permissions passed to it by <code>release.yml</code>, breaking the release workflow.</p>
<p>I think that means that each of these workflows needs to have exactly the same permissions in their individual workflow files as they have passed to them by <code>release.yml</code> -- does that sound right to you?</p>
</blockquote>
<p>Interesting, doesn't this mean that the nested workflow (e.g., <code>publish-wasm.yml</code>) <em>can</em> have <code>permissions: {}</code> because that's more restrictive as compared to the parent workflow (<code>release.yml</code>) ?</p>
<p>Otherwise, we'll need to revert the <code>build-binaries.yml</code> update in this PR as that's also a nested workflow called by <code>release.yml</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-22 16:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>.github/zizmor.yml</code>:16 on 2025-01-22 16:56</div>
            <div class="timeline-body"><p>there was already a TODO on line 4, but I added a comment closer to these lines explaining exactly why they are ignored :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>.github/zizmor.yml</code>:17 on 2025-01-22 16:57</div>
            <div class="timeline-body"><blockquote>
<p>Otherwise, we'll need to revert the <code>build-binaries.yml</code> update in this PR as that's also a nested workflow called by <code>release.yml</code>.</p>
</blockquote>
<p>I'm <em>pretty</em> confident that the <code>build-binaries.yml</code> change is okay because, unlike the other workflows, that workflow is run exactly the same way as part of PR CI as it is when it's called from <code>release.yml</code>. (And the CI on this PR is green.)</p>
<p>I'm just going to leave this as-is for now, but I'm very happy if somebody else wants to experiment with removing these ignores and actually fixing the issues zizmor is complaining about!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-22 16:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-01-22 17:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-01-22 17:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-22 17:00</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 20:06:11 UTC
    </footer>
</body>
</html>
