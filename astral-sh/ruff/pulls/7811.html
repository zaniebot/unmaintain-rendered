<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[pylint] Implement consider-using-ternary (R1706) - astral-sh/ruff #7811</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[pylint] Implement consider-using-ternary (R1706)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7811">#7811</a>
        opened by <a href="https://github.com/danbi2990">@danbi2990</a>
        on 2023-10-04 12:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danbi2990">@danbi2990</a></div>
            <div class="timeline-body"><p>This is my first PR. Please feel free to give me any feedback for even small drawbacks.</p>
Summary
<p>Checks if pre-python 2.5 ternary syntax is used.</p>
<p>Before</p>
<pre><code>x, y = 1, 2
maximum = x &gt;= y and x or y  # [consider-using-ternary]
</code></pre>
<p>After</p>
<pre><code>x, y = 1, 2
maximum = x if x &gt;= y else y
</code></pre>
<p>References:
<a href="https://pylint.pycqa.org/en/latest/user_guide/messages/refactor/consider-using-ternary.html">pylint</a>
#970
<a href="https://github.com/pylint-dev/pylint/blob/main/pylint/checkers/refactoring/refactoring_checker.py#L1813">and_or_ternary distinction logic</a></p>
Test Plan
<p>Unit test, python file, snapshot added.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2023-10-04 13:26</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/danbi2990:consider-using-ternary">CodSpeed Performance Report</a>
Merging #7811 will <strong>not alter performance</strong>
<p>Comparing <code>danbi2990:consider-using-ternary</code> (2551cca) with <code>main</code> (6f9c317)</p>
Summary
<p><code>‚úÖ 25</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-10-04 14:05</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>‚ÑπÔ∏è ecosystem check <strong>detected changes</strong>. (+2, -1, 0 error(s))</p>
rotki (+2, -1)
<p>

<pre>
- [*] 11 fixable with the `--fix` option (20 hidden fixes can be enabled with the `--unsafe-fixes` option).
+ [*] 11 fixable with the `--fix` option (21 hidden fixes can be enabled with the `--unsafe-fixes` option).
+ <a href="https://github.com/rotki/rotki/blob/462f4965c8ab2a73a42a0312816eabf5e31b604c/rotkehlchen/tests/fixtures/accounting.py#L56">rotkehlchen/tests/fixtures/accounting.py:56:13:</a> PLR1706 Consider using if-else expression
</pre>

</p>

Rules changed: 1

<p>| Rule | Changes | Additions | Removals |
| ---- | ------- | --------- | -------- |
| PLR1706 | 1 | 1 | 0 |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/danbi2990">@danbi2990</a> on 2023-10-05 00:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/danbi2990">@danbi2990</a> on 2023-10-05 07:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_linter/src/rules/pylint/helpers.rs</code>:94 on 2023-10-06 12:46</div>
            <div class="timeline-body"><p>You can avoid the <code>.unwrap()</code> using let-else:</p>
<pre><code>    if let Some(and_op) = and_op.and_op.as_bool_op_expr() else {
        return false;
    }
    let and_values = and_op.values;
    let false_value = &amp;bool_op.values[1];
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_linter/src/rules/pylint/helpers.rs</code>:97 on 2023-10-06 12:49</div>
            <div class="timeline-body"><p>Similarly, you can avoid this check with let-else:</p>
<pre><code>let [and_op, false_value] = bool_op.values.as_slice() == 2 else {
    return false;
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_linter/src/rules/pylint/helpers.rs</code>:104 on 2023-10-06 12:50</div>
            <div class="timeline-body"><pre><code>#[cfg(test)]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_linter/src/rules/pylint/helpers.rs</code>:113 on 2023-10-06 12:50</div>
            <div class="timeline-body"><pre><code>#[cfg(test)]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_linter/src/rules/pylint/helpers.rs</code>:123 on 2023-10-06 12:53</div>
            <div class="timeline-body"><p>From a general rust perspective, having unit tests in a file is good practice, but for the ruff linter specifically we generally only use the python test file because it makes more sense for us (mostly because we would test the same thing in the unit tests that we also test in the python files, so we&#x27;d only get code we have to keep in sync without additional test coverage)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_linter/src/rules/pylint/rules/and_or_ternary.rs</code>:14 on 2023-10-06 12:54</div>
            <div class="timeline-body"><pre><code>/// If-expressions are more readable than logical ternary expressions.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_linter/src/rules/pylint/rules/and_or_ternary.rs</code>:19 on 2023-10-06 12:54</div>
            <div class="timeline-body"><pre><code>/// maximum = x &gt;= y and x or y
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_linter/src/rules/pylint/rules/and_or_ternary.rs</code>:38 on 2023-10-06 12:58</div>
            <div class="timeline-body"><pre><code>        format!(&quot;Pre-python 2.5 ternary syntax used&quot;)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_linter/src/rules/pylint/rules/and_or_ternary.rs</code>:56 on 2023-10-09 10:11</div>
            <div class="timeline-body"><p>you could return an option from <code>is_and_or_ternary</code> which contains the test, body and orelse so you can avoid the unwrapping.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-10-09 10:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/danbi2990">@danbi2990</a> on 2023-10-10 10:47</div>
            <div class="timeline-body"><p>@konstin
All comments applied. Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/danbi2990">@danbi2990</a> on 2023-10-10 10:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_linter/src/rules/pylint/helpers.rs</code>:88 on 2023-10-10 15:00</div>
            <div class="timeline-body"><p>Here i&#x27;d return <code>Option&lt;(Expr, Expr, Expr)&gt;</code>. It&#x27;s the same from the perspective of the compiler, but it makes it clearer that these are different parts of the code that only incidentally have the same type.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_linter/src/rules/pylint/helpers.rs</code>:105 on 2023-10-10 15:07</div>
            <div class="timeline-body"><p>Personal style preference:</p>
<pre><code>    let Some(and_op) = expr.as_bool_op_expr() else {
        return None;
    }
    if and_op.op != BoolOp::And {
        return None;
    }   
    let [condition, true_value] = and_op.values.as_slice() else {
        return None;
    };
    if !false_value.is_bool_op_expr() &amp;&amp; !true_value.is_bool_op_expr() {
        return Some([condition.clone(), true_value.clone(), false_value.clone()]);
    }
}
</code></pre>
<p>With a different reviewer you would likely get a slightly different structure, but we normally prefer some kind of flatter structure.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_linter/src/rules/pylint/helpers.rs</code>:86 on 2023-10-10 15:09</div>
            <div class="timeline-body"><p>I&#x27;d move this function to <code>and_or_ternary.rs</code> (and make it private) since it&#x27;s not used anywhere else.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-10-10 15:24</div>
            <div class="timeline-body"><p>Thanks for the fixes, i have added some more notes for the next iteration.</p>
<p>I&#x27;ve also looked through the ecosystem checks; I think we shouldn&#x27;t warn when the parent is an if statement (e.g. https://github.com/apache/airflow/blob/609eed90698aa7abeb5bae9ae156062d32baae86/airflow/models/dag.py#L2639 or https://github.com/rotki/rotki/blob/7e88ac61f98e21e231b43186a6fbee2e090b1be5/package.py#L1070) or when the parent is a binary expression (e.g. https://github.com/bokeh/bokeh/blob/cf57b9ae0073ecf0434a8c10002a70f6bf2079cd/src/bokeh/core/property/dataspec.py#L588).</p>
<p><a href="https://github.com/rotki/rotki/blob/7e88ac61f98e21e231b43186a6fbee2e090b1be5/rotkehlchen/tests/fixtures/accounting.py#L56">This line</a> is also not a case of R1706, but the original code looks wrong, i&#x27;m pretty sure they meant</p>
<pre><code>x.is_dir() and ((x / &#x27;rotkehlchen.db&#x27;).exists() or (x / &#x27;rotkehlchen_transient.db&#x27;).exists())
</code></pre>
<p>instead of</p>
<pre><code>x.is_dir() and (x / &#x27;rotkehlchen.db&#x27;).exists() or (x / &#x27;rotkehlchen_transient.db&#x27;).exists()
</code></pre>
<p>, so imo that&#x27;s fine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/danbi2990">@danbi2990</a> on 2023-10-11 05:06</div>
            <div class="timeline-body"><p>@konstin
All comments applied. Thank you. üôá‚Äç‚ôÇÔ∏è</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/danbi2990">@danbi2990</a> on 2023-10-11 05:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-10-11 12:55</div>
            <div class="timeline-body"><p>I found a case where the fix doesn&#x27;t work (https://github.com/apache/airflow/blob/8fdf3582c2967161dd794f7efb53691d092f0ce6/airflow/utils/setup_teardown.py#L199):</p>
<pre><code>new_list = [
    x
    for sublist in all_lists
    for x in sublist
    if (isinstance(operator, list) and x in operator) or x != operator
]
</code></pre>
<p>is fixed to</p>
<pre><code>new_list = [
    x
    for sublist in all_lists
    for x in sublist
    if x in operator if isinstance(operator, list) else x != operator
]
</code></pre>
<p>which is invalid syntax, the expression needs parentheses here. @charliermarsh Do we have a util to detect whether we need to add parentheses when converting a bool op to a ternary expression?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/danbi2990">@danbi2990</a> on 2023-10-12 15:32</div>
            <div class="timeline-body"><p>@konstin
How about this version? ü§î</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_linter/src/rules/pylint/rules/and_or_ternary.rs</code>:118 on 2023-10-12 16:36</div>
            <div class="timeline-body"><pre><code>        diagnostic.set_fix(Fix::unsafe_edit(Edit::range_replacement(
</code></pre>
<p>I&#x27;m not certain that we have captured all cases where this could leads to invalid syntax but i also couldn&#x27;t enumerate which cases they are and also the fix is new, so i&#x27;d go with an unsafe fix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-10-12 16:36</div>
            <div class="timeline-body"><p>Looks good!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/konstin">@konstin</a> on 2023-10-12 16:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danbi2990">@danbi2990</a> reviewed on 2023-10-13 00:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/danbi2990">@danbi2990</a> on <code>crates/ruff_linter/src/rules/pylint/rules/and_or_ternary.rs</code>:118 on 2023-10-13 00:18</div>
            <div class="timeline-body"><p>That makes sense. Applied. üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-13 01:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-10-13 01:19</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-13 01:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-13 01:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-10-13 05:44</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:58:02 UTC
    </footer>
</body>
</html>
