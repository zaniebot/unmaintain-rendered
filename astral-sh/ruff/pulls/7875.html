<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remove min and max range on `line-length` JSON schema - astral-sh/ruff #7875</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Remove min and max range on <code>line-length</code> JSON schema</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7875">#7875</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-10-09 18:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>This was introduced in <a href="https://github.com/astral-sh/ruff/pull/7412">astral-sh/ruff#7412</a>, but SchemaStore doesn&#x27;t accept it. I manually edited the JSON schema last time, then tried to fix this, then gave up -- so removing for now.</p>
<p>(See, e.g., <a href="https://github.com/SchemaStore/schemastore/pull/3278">SchemaStore/schemastore#3278</a>, which failed prior to removing the min and max.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/zanieb">@zanieb</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-09 18:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-09 18:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-10-09 18:57</div>
            <div class="timeline-body"><p>Can we not just add exceptions in the schema store schema validator similar to what I did at <a href="https://github.com/SchemaStore/schemastore/pull/3221">SchemaStore/schemastore#3221</a>/files#diff-5b41cf0105f054a82fd2932cf8e4af10ec697a315a9fe61d3f1956c0a47cdafc? We&#x27;re already not producing a schema that passes their strict validation.</p>
<p>I don&#x27;t think we should remove correct validation on our end if avoidable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-09 19:06</div>
            <div class="timeline-body"><p>I&#x27;ll give it a quick try on SchemaStore! If it doesn&#x27;t work, we should merge this and revisit later. From a procedural perspective, this is a clean revert of a change that broke the release. (Users already aren&#x27;t benefiting from the change because we can&#x27;t release the updated schema anyway.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-10-09 19:12</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>‚úÖ ecosystem check detected no changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-09 19:21</div>
            <div class="timeline-body"><p>This is the change we need in the schema file: <a href="https://github.com/SchemaStore/schemastore/pull/3278">SchemaStore/schemastore#3278</a>/commits/75d4ec66a64dd36b176e24d6193ecb25e8f85414 (I made it manually). I believe I&#x27;ve tried to get schemars to output this in the past and failed. (I couldn&#x27;t get our current schema to pass by adding exclusions on the SchemaStore side.) I believe we should merge this in the absence of an owner that wants to prioritize fixing the root cause.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2023-10-09 19:23</div>
            <div class="timeline-body"><p>Sounds good to me. My main concern is that the range is relatively restricted and I worry users will encounter invalid values.</p>
<p>It&#x27;d be great to open an issue somewhere to track restoring this if we merge without resolving or to explore what happens if users set the length above the support range and how we show errors for this.</p>
<p>My naive test with</p>
<pre><code>‚ùØ ruff check example.py --show-settings | grep line_length -A 2
        line_length: LineLength(
            2000,
        ),
</code></pre>
<p>didn&#x27;t error which surprises me?</p>
<p>edit: okay I did succeed with a larger value</p>
<pre><code>  Cause: Failed to parse `/Users/mz/eng/src/astral-sh/ruff/ruff.toml`: TOML parse error at line 2, column 15
  |
2 | line-length = 1000000
  |               ^^^^^^^
invalid value: integer `1000000`, expected a nonzero u16
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-09 19:31</div>
            <div class="timeline-body"><p>Maybe I can try post-processing the JSON. Sounds like a pain in Rust though üò¨</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-09 19:36</div>
            <div class="timeline-body"><p>Tracking in <a href="https://github.com/astral-sh/ruff/issues/7877">astral-sh/ruff#7877</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-09 19:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-09 19:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-10-09 19:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2023-10-09 21:02</div>
            <div class="timeline-body"><p>For posterity, this is not SchemaStore being overly strict, it&#x27;s invalid JSONSchema. This following is invalid:</p>
<pre><code>    &quot;line-length&quot;: {
      &quot;description&quot;: &quot;The line length to use when enforcing long-lines violations (like `E501`). Must be greater than `0` and less than or equal to `320`.&quot;,
      &quot;anyOf&quot;: [
        {
          &quot;$ref&quot;: &quot;#/definitions/LineLength&quot;
        },
        {
          &quot;type&quot;: &quot;null&quot;
        }
      ],
      &quot;maximum&quot;: 320.0,
      &quot;minimum&quot;: 1.0
    }
</code></pre>
<p>An anyOf can&#x27;t have a minimum/maximum length. Only a <code>&quot;type&quot;: &quot;number&quot;</code> has those properties. So it has to go inside the definition at <code>&quot;#/definitions/LineLength&quot;</code>.</p>
<p>If schemars is making the definitions directly then I&#x27;d guess it&#x27;s a schemars bug?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-09 21:03</div>
            <div class="timeline-body"><p>Thanks @henryiii, much appreciated!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/henryiii">@henryiii</a> reviewed on 2023-10-09 21:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/henryiii">@henryiii</a> on <code>crates/ruff_workspace/src/options.rs</code>:365 on 2023-10-09 21:06</div>
            <div class="timeline-body"><p>FWICT, it looks like this is applying to the <code>Option&lt;LineLength&gt;</code>, rather than the <code>LineLength</code> inside the <code>Option</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/henryiii">@henryiii</a> reviewed on 2023-10-09 23:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/henryiii">@henryiii</a> on <code>crates/ruff_workspace/src/options.rs</code>:365 on 2023-10-09 23:46</div>
            <div class="timeline-body"><p>FWIW, I can replicate it with a MWE:</p>
<pre><code>use schemars::{schema_for, JsonSchema};

#[derive(JsonSchema)]
pub struct MyStruct {
    pub my_int: i32,
}

#[derive(JsonSchema)]
pub struct MyConfig {
    #[schemars(range(min = 1, max = 320))]
    my_struct: Option&lt;MyStruct&gt;,
}

fn main() {
    let schema = schema_for!(MyConfig);
    println!(&quot;{}&quot;, serde_json::to_string_pretty(&amp;schema).unwrap());
}
</code></pre>
<p>And one fix is to move the location of the attribute:</p>
<pre><code>use schemars::{schema_for, JsonSchema};

#[derive(JsonSchema)]
pub struct MyStruct {
    #[schemars(range(min = 1, max = 320))]
    pub my_int: i32,
}

#[derive(JsonSchema)]
pub struct MyConfig {
    my_struct: Option&lt;MyStruct&gt;,
}

fn main() {
    let schema = schema_for!(MyConfig);
    println!(&quot;{}&quot;, serde_json::to_string_pretty(&amp;schema).unwrap());
}

</code></pre>
<p>But not sure how that works from the outer location, ~~and not sure what <code>cfg_attrs</code> is~~ (nevermind, I do). I see an <code>inner()</code>, but it seems to only apply to things like Vector, not to Enums.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/henryiii">@henryiii</a> reviewed on 2023-10-09 23:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/henryiii">@henryiii</a> on <code>crates/ruff_workspace/src/options.rs</code>:365 on 2023-10-09 23:51</div>
            <div class="timeline-body"><p>Ahh, I know what that is, and how to fix it (I think).</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:58:09 UTC
    </footer>
</body>
</html>
