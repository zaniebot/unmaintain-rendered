<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Replace `parents` statement stack with a `Nodes` abstraction - astral-sh/ruff #4233</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Replace <code>parents</code> statement stack with a <code>Nodes</code> abstraction</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4233">#4233</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-05-05 00:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Similar to #4138, this PR refactors our tracking of the &quot;stack of current statements&quot; to use a <code>Nodes</code> abstraction, whereby we track the ID of the current node, and every node stores the ID of its parent. This lets us avoid a bunch of clones (namely, cloning <code>self.ctx.parents</code> whenever we need to defer a context) and move some complexity behind a more well-defined API (e.g., <code>self.ctx.depths</code>, <code>self.ctx.child_to_parent</code>).</p>
<h2>Test Plan</h2>
<p>Automated tests.</p>
<p>In the micro-benchmarks, performance improved by a few percentage points:</p>
<pre><code>linter/default-rules/numpy/globals.py
                        time:   [72.388 Âµs 72.543 Âµs 72.705 Âµs]
                        thrpt:  [40.584 MiB/s 40.675 MiB/s 40.762 MiB/s]
                 change:
                        time:   [-1.1189% -0.8630% -0.6114%] (p = 0.00 &lt; 0.05)
                        thrpt:  [+0.6151% +0.8705% +1.1316%]
                        Change within noise threshold.
Found 2 outliers among 100 measurements (2.00%)
  2 (2.00%) high mild
linter/default-rules/pydantic/types.py
                        time:   [1.4599 ms 1.4623 ms 1.4650 ms]
                        thrpt:  [17.408 MiB/s 17.440 MiB/s 17.469 MiB/s]
                 change:
                        time:   [-2.1689% -1.9893% -1.8088%] (p = 0.00 &lt; 0.05)
                        thrpt:  [+1.8421% +2.0296% +2.2170%]
                        Performance has improved.
linter/default-rules/numpy/ctypeslib.py
                        time:   [674.25 Âµs 675.15 Âµs 676.15 Âµs]
                        thrpt:  [24.626 MiB/s 24.663 MiB/s 24.696 MiB/s]
                 change:
                        time:   [-1.7584% -1.5019% -1.2492%] (p = 0.00 &lt; 0.05)
                        thrpt:  [+1.2650% +1.5248% +1.7899%]
                        Performance has improved.
Found 1 outliers among 100 measurements (1.00%)
  1 (1.00%) high severe
linter/default-rules/large/dataset.py
                        time:   [3.3299 ms 3.3340 ms 3.3385 ms]
                        thrpt:  [12.186 MiB/s 12.202 MiB/s 12.218 MiB/s]
                 change:
                        time:   [-2.5060% -2.2051% -1.9172%] (p = 0.00 &lt; 0.05)
                        thrpt:  [+1.9547% +2.2549% +2.5704%]
                        Performance has improved.

linter/all-rules/numpy/globals.py
                        time:   [143.50 Âµs 143.60 Âµs 143.73 Âµs]
                        thrpt:  [20.529 MiB/s 20.547 MiB/s 20.562 MiB/s]
                 change:
                        time:   [-1.7304% -1.3775% -0.9696%] (p = 0.00 &lt; 0.05)
                        thrpt:  [+0.9791% +1.3967% +1.7608%]
                        Change within noise threshold.
Found 7 outliers among 100 measurements (7.00%)
  4 (4.00%) high mild
  3 (3.00%) high severe
linter/all-rules/pydantic/types.py
                        time:   [2.8682 ms 2.8702 ms 2.8722 ms]
                        thrpt:  [8.8792 MiB/s 8.8855 MiB/s 8.8916 MiB/s]
                 change:
                        time:   [-1.4567% -1.2851% -1.1150%] (p = 0.00 &lt; 0.05)
                        thrpt:  [+1.1275% +1.3019% +1.4782%]
                        Performance has improved.
Found 12 outliers among 100 measurements (12.00%)
  6 (6.00%) high mild
  6 (6.00%) high severe
linter/all-rules/numpy/ctypeslib.py
                        time:   [1.6182 ms 1.6188 ms 1.6196 ms]
                        thrpt:  [10.281 MiB/s 10.286 MiB/s 10.290 MiB/s]
                 change:
                        time:   [-1.8875% -1.6560% -1.4401%] (p = 0.00 &lt; 0.05)
                        thrpt:  [+1.4611% +1.6839% +1.9238%]
                        Performance has improved.
Found 7 outliers among 100 measurements (7.00%)
  3 (3.00%) high mild
  4 (4.00%) high severe
linter/all-rules/large/dataset.py
                        time:   [6.8538 ms 6.8566 ms 6.8596 ms]
                        thrpt:  [5.9308 MiB/s 5.9334 MiB/s 5.9358 MiB/s]
                 change:
                        time:   [-1.7648% -1.4304% -1.2235%] (p = 0.00 &lt; 0.05)
                        thrpt:  [+1.2386% +1.4511% +1.7965%]
                        Performance has improved.
Found 12 outliers among 100 measurements (12.00%)
  7 (7.00%) high mild
  5 (5.00%) high severe
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @charliermarsh on 2023-05-05 00:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-05 00:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_ast/src/branch_detection.rs</code>:113 on 2023-05-05 00:54</div>
            <div class="timeline-body"><p>(This got moved into <code>ruff_python_semantic</code>, since it now depends on <code>Nodes</code>.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-05-05 01:05</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     14.6Â±0.06ms     2.8 MB/sec    1.01     14.8Â±0.04ms     2.8 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.6Â±0.01ms     4.7 MB/sec    1.01      3.6Â±0.03ms     4.6 MB/sec
linter/all-rules/numpy/globals.py          1.00    360.3Â±0.86Âµs     8.2 MB/sec    1.03    372.8Â±1.88Âµs     7.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.1Â±0.01ms     4.2 MB/sec    1.02      6.2Â±0.01ms     4.1 MB/sec
linter/default-rules/large/dataset.py      1.00      7.4Â±0.03ms     5.5 MB/sec    1.04      7.7Â±0.01ms     5.3 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1534.8Â±4.02Âµs    10.8 MB/sec    1.03  1578.4Â±21.87Âµs    10.5 MB/sec
linter/default-rules/numpy/globals.py      1.00    164.1Â±0.93Âµs    18.0 MB/sec    1.04    171.4Â±0.24Âµs    17.2 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.3Â±0.01ms     7.8 MB/sec    1.02      3.3Â±0.01ms     7.6 MB/sec
parser/large/dataset.py                    1.00      6.0Â±0.01ms     6.8 MB/sec    1.00      6.0Â±0.00ms     6.8 MB/sec
parser/numpy/ctypeslib.py                  1.00   1161.0Â±1.34Âµs    14.3 MB/sec    1.00   1160.4Â±2.26Âµs    14.3 MB/sec
parser/numpy/globals.py                    1.01    118.9Â±0.36Âµs    24.8 MB/sec    1.00    118.2Â±0.54Âµs    25.0 MB/sec
parser/pydantic/types.py                   1.00      2.5Â±0.00ms    10.1 MB/sec    1.00      2.5Â±0.01ms    10.1 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.01     16.5Â±0.36ms     2.5 MB/sec    1.00     16.3Â±0.18ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      4.2Â±0.08ms     4.0 MB/sec    1.00      4.1Â±0.05ms     4.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    489.2Â±8.90Âµs     6.0 MB/sec    1.00    487.5Â±7.93Âµs     6.1 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.9Â±0.12ms     3.7 MB/sec    1.00      7.0Â±0.19ms     3.7 MB/sec
linter/default-rules/large/dataset.py      1.01      8.4Â±0.12ms     4.9 MB/sec    1.00      8.3Â±0.10ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01  1772.7Â±27.78Âµs     9.4 MB/sec    1.00  1759.3Â±24.40Âµs     9.5 MB/sec
linter/default-rules/numpy/globals.py      1.00    197.8Â±5.28Âµs    14.9 MB/sec    1.01    199.0Â±7.95Âµs    14.8 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.7Â±0.05ms     6.8 MB/sec    1.00      3.7Â±0.07ms     6.8 MB/sec
parser/large/dataset.py                    1.00      6.7Â±0.07ms     6.1 MB/sec    1.00      6.7Â±0.08ms     6.0 MB/sec
parser/numpy/ctypeslib.py                  1.00  1279.4Â±22.05Âµs    13.0 MB/sec    1.00  1277.6Â±22.12Âµs    13.0 MB/sec
parser/numpy/globals.py                    1.00    131.8Â±2.93Âµs    22.4 MB/sec    1.00    131.5Â±2.13Âµs    22.4 MB/sec
parser/pydantic/types.py                   1.00      2.8Â±0.04ms     9.0 MB/sec    1.00      2.9Â±0.04ms     8.9 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/checkers/ast/mod.rs</code>:3622 on 2023-05-05 06:31</div>
            <div class="timeline-body"><p>Does <code>node_id</code> match the id of the current stmt? If so, how about <code>self.ctx.current_stmt_id()</code>? It would clarify the relationship to <code>current_stmt</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/checkers/ast/deferred.rs</code>:13 on 2023-05-05 06:32</div>
            <div class="timeline-body"><p>Nit: Can we add some documentation to the type. To what node does the  <code>NodeId</code> point to?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/types.rs</code>:84 on 2023-05-05 06:36</div>
            <div class="timeline-body"><p>Nit: Is it possible to use a wildcard implementation here or do we intentionally restrict the type to <code>Stmt</code> and <code>Expr</code>?</p>
<pre><code class="language-suggestion">impl&lt;'a, T&gt; From&lt;RefEquality&lt;'a, T&gt;&gt; for &amp;'a T {
    fn from(r: RefEquality&lt;'a, T&gt;) -&gt; Self {
        r.0
    }
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_semantic/src/node.rs</code>:51 on 2023-05-05 06:43</div>
            <div class="timeline-body"><p>I think we should either panic if the <code>node</code> was already present in the map OR return the existing id (use the <code>entry</code> API)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_semantic/src/node.rs</code>:49 on 2023-05-05 06:44</div>
            <div class="timeline-body"><p>Nit: <code>Nodes</code> acts more like a <code>Map</code> than a <code>Vec</code> or <code>Stack</code>. Should we rename the method to <code>insert</code> or <code>add</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_semantic/src/node.rs</code>:14 on 2023-05-05 06:47</div>
            <div class="timeline-body"><p>I wonder if we should use <code>NonZeroU32</code> here (and either offset the <code>indices</code> when accessing the <code>nodes</code> vec or add a dummy node to the vec). The benefit of doing so is that it would shrink the <code>Option&lt;NodeId&gt;</code> from 8 bytes to 4 bytes.</p>
<p>Or we introduce a new, module internal, <code>ParentId</code> that uses <code>NonZeroU32</code> internally that can be converted from/to a <code>NodeId</code>. This requires some more boilerplate but may be easier to implement (but limits the benefits of this optimization to this module only).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_semantic/src/node.rs</code>:45 on 2023-05-05 06:50</div>
            <div class="timeline-body"><p>I wonder if we should rename <code>NodeId</code> to <code>StmtId</code> and <code>Nodes</code> to <code>Statements</code> since the API only accepts <code>Stmt</code>s as <code>node</code> parameters.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-05-05 06:51</div>
            <div class="timeline-body"><p>ðŸŽ¸ðŸŽ¸ðŸŽ¸</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-05 19:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_semantic/src/node.rs</code>:45 on 2023-05-05 19:34</div>
            <div class="timeline-body"><p>I'm considering making this generic and using the same abstraction for expression-tracking.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-06 15:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_ast/src/types.rs</code>:84 on 2023-05-06 15:48</div>
            <div class="timeline-body"><p>Apparently not:</p>
<pre><code>error[E0210]: type parameter `T` must be covered by another type when it appears before the first local type (`RefEquality&lt;'a, T&gt;`)
  --&gt; crates/ruff_python_ast/src/types.rs:74:10
   |
74 | impl&lt;'a, T&gt; From&lt;RefEquality&lt;'a, T&gt;&gt; for &amp;'a T {
   |          ^ type parameter `T` must be covered by another type when it appears before the first local type (`RefEquality&lt;'a, T&gt;`)
   |
   = note: implementing a foreign trait is only possible if at least one of the types for which it is implemented is local, and no uncovered type parameters appear before that first local type
   = note: in this case, 'before' refers to the following order: `impl&lt;..&gt; ForeignTrait&lt;T1, ..., Tn&gt; for T0`, where `T0` is the first and `Tn` is the last

For more information about this error, try `rustc --explain E0210`.
error: could not compile `ruff_python_ast` due to previous error
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-06 16:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_semantic/src/node.rs</code>:14 on 2023-05-06 16:07</div>
            <div class="timeline-body"><p>Gave it a shot!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-05-06 16:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-05-06 16:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-05-06 16:12</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:57:15 UTC
    </footer>
</body>
</html>
