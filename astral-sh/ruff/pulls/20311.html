<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] infer `name` and `value` for enum members - astral-sh/ruff #20311</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] infer <code>name</code> and <code>value</code> for enum members</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20311">#20311</a>
        opened by <a href="https://github.com/thejchap">@thejchap</a>
        on 2025-09-09 02:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/thejchap">@thejchap</a></div>
            <div class="timeline-body">summary
<ul>
<li>this pr implements the following attributes for <code>Enum</code> members:<ul>
<li><code>name</code></li>
<li><code>_name_</code></li>
<li><code>value</code></li>
<li><code>_value_</code></li>
</ul>
</li>
<li>adds a TODO test for <code>my_enum_class_instance.name</code></li>
<li>only implements if the instance is a subclass of <code>Enum</code> re: this <a href="https://github.com/astral-sh/ruff/pull/19481#issuecomment-3103460307">comment</a> and existing <a href="https://github.com/thejchap/ruff/blob/c34449ed7ca4b043d514240e212335a2554d0fb1/crates/ty_python_semantic/resources/mdtest/enums.md?plain=1#L625">test</a></li>
</ul>
pointers
<ul>
<li>https://github.com/astral-sh/ty/issues/876</li>
<li>https://typing.python.org/en/latest/spec/enums.html#enum-definition</li>
<li>https://github.com/astral-sh/ruff/pull/19481#issuecomment-3103460307</li>
</ul>
test plan
<ul>
<li>mdtests</li>
<li>triaged conformance diffs here: https://diffswarm.dev/d-01k531ag4nee3xmdeq4f3j66pb</li>
<li>triaged mypy primer diffs here for django-stubs: https://diffswarm.dev/d-01k5331n13k9yx8tvnxnkeawp3<ul>
<li>added a TODO test for overriding <code>.value</code></li>
</ul>
</li>
<li>discord diff seems reasonable</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-09-09 07:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-10 01:45</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a>

Changes were detected when running ty on typing conformance tests

<pre><code>--- old-output.txt	2025-09-17 07:23:56.516264569 +0000
+++ new-output.txt	2025-09-17 07:23:59.584286258 +0000
@@ -316,16 +316,9 @@
 enums_behaviors.py:32:1: error[type-assertion-failure] Argument does not have asserted type `Literal[Color.BLUE]`
 enums_behaviors.py:44:21: error[subclass-of-final-class] Class `ExtendedShape` cannot inherit from final class `Shape`
 enums_expansion.py:52:9: error[type-assertion-failure] Argument does not have asserted type `CustomFlags`
-enums_member_names.py:21:1: error[type-assertion-failure] Argument does not have asserted type `Literal[&quot;RED&quot;]`
-enums_member_names.py:22:1: error[type-assertion-failure] Argument does not have asserted type `Literal[&quot;RED&quot;]`
-enums_member_names.py:26:5: error[type-assertion-failure] Argument does not have asserted type `Literal[&quot;RED&quot;, &quot;BLUE&quot;]`
 enums_member_names.py:30:5: error[type-assertion-failure] Argument does not have asserted type `Literal[&quot;RED&quot;, &quot;BLUE&quot;, &quot;GREEN&quot;]`
-enums_member_values.py:21:1: error[type-assertion-failure] Argument does not have asserted type `Literal[1]`
-enums_member_values.py:22:1: error[type-assertion-failure] Argument does not have asserted type `Literal[1]`
-enums_member_values.py:26:5: error[type-assertion-failure] Argument does not have asserted type `Literal[1, 3]`
 enums_member_values.py:30:5: error[type-assertion-failure] Argument does not have asserted type `Literal[1, 2, 3]`
 enums_member_values.py:54:1: error[type-assertion-failure] Argument does not have asserted type `Literal[1]`
-enums_member_values.py:68:1: error[type-assertion-failure] Argument does not have asserted type `Literal[1]`
 enums_member_values.py:96:1: error[type-assertion-failure] Argument does not have asserted type `int`
 enums_members.py:128:21: info[revealed-type] Revealed type: `Unknown | Literal[2]`
 enums_members.py:129:9: error[type-assertion-failure] Argument does not have asserted type `Unknown`
@@ -869,5 +862,5 @@
 typeddicts_usage.py:28:1: error[missing-typed-dict-key] Missing required key &#x27;name&#x27; in TypedDict `Movie` constructor
 typeddicts_usage.py:28:18: error[invalid-key] Invalid key access on TypedDict `Movie`: Unknown key &quot;title&quot;
 typeddicts_usage.py:40:24: error[invalid-type-form] The special form `typing.TypedDict` is not allowed in type expressions. Did you mean to use a concrete TypedDict or `collections.abc.Mapping[str, object]` instead?
-Found 870 diagnostics
+Found 863 diagnostics
 WARN A fatal error occurred while checking some files. Not all project files were analyzed. See the diagnostics list above for details.
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-10 01:48</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>django-stubs (https://github.com/typeddjango/django-stubs)
- tests/assert_type/db/models/_enums.py:20:1: error[type-assertion-failure] Argument does not have asserted type `Literal[&quot;NORTH&quot;]`
- tests/assert_type/db/models/test_enums.py:144:1: error[type-assertion-failure] Argument does not have asserted type `Literal[&quot;CLUB&quot;]`
- tests/assert_type/db/models/test_enums.py:155:1: error[type-assertion-failure] Argument does not have asserted type `Literal[&quot;SENIOR&quot;]`
- tests/assert_type/db/models/test_enums.py:167:1: error[type-assertion-failure] Argument does not have asserted type `Literal[&quot;CAR&quot;]`
- tests/assert_type/db/models/test_enums.py:181:1: error[type-assertion-failure] Argument does not have asserted type `Literal[&quot;MALE&quot;]`
- tests/assert_type/db/models/test_enums.py:194:1: error[type-assertion-failure] Argument does not have asserted type `Literal[&quot;GOLD&quot;]`
- tests/assert_type/db/models/test_enums.py:207:1: error[type-assertion-failure] Argument does not have asserted type `Literal[&quot;FS&quot;]`
- tests/assert_type/db/models/test_enums.py:221:1: error[type-assertion-failure] Argument does not have asserted type `Literal[&quot;PI&quot;]`
- tests/assert_type/db/models/test_enums.py:235:1: error[type-assertion-failure] Argument does not have asserted type `Literal[&quot;ABYSS&quot;]`
+ tests/assert_type/db/models/test_enums.py:237:1: error[type-assertion-failure] Argument does not have asserted type `Any`
- tests/assert_type/db/models/test_enums.py:248:1: error[type-assertion-failure] Argument does not have asserted type `Literal[&quot;NORTH&quot;]`
- tests/assert_type/db/models/test_enums.py:260:1: error[type-assertion-failure] Argument does not have asserted type `Literal[&quot;NORTH&quot;]`
- Found 476 diagnostics
+ Found 466 diagnostics

discord.py (https://github.com/Rapptz/discord.py)
- discord/audit_logs.py:550:56: error[invalid-argument-type] Argument to bound method `from_data` is incorrect: Expected `int`, found `None | Unknown | (Unknown &amp; ~None) | Literal[-1]`
+ discord/audit_logs.py:550:56: error[invalid-argument-type] Argument to bound method `from_data` is incorrect: Expected `int`, found `None | Unknown | (Unknown &amp; ~None) | Literal[3, 4, 1, 5, -1]`
- discord/audit_logs.py:551:55: error[invalid-argument-type] Argument to bound method `from_data` is incorrect: Expected `int`, found `None | Unknown | (Unknown &amp; ~None) | Literal[-1]`
+ discord/audit_logs.py:551:55: error[invalid-argument-type] Argument to bound method `from_data` is incorrect: Expected `int`, found `None | Unknown | (Unknown &amp; ~None) | Literal[3, 4, 1, 5, -1]`

</code></pre>

No memory usage changes detected ✅

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thejchap">@thejchap</a> on 2025-09-12 00:50</div>
            <div class="timeline-body"><p>@sharkdp could use some feedback on approach for <code>_value_</code>/<code>value</code> before i get further in</p>
<p>i am thinking to add a <code>value_ty</code> field to <a href="https://github.com/thejchap/ruff/blob/64c8a66390b14c6b3778a94dafa1a52eed82afc9/crates/ty_python_semantic/src/types.rs#L10209">EnumLiteralType</a> that stores <a href="https://github.com/thejchap/ruff/blob/64c8a66390b14c6b3778a94dafa1a52eed82afc9/crates/ty_python_semantic/src/types/enums.rs#L123">this value</a>, which i think would require giving <code>EnumMetadata</code> the <code>&#x27;db</code> lifetime</p>
<p>anything im missing there or other recommendations?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-12 07:26</div>
            <div class="timeline-body"><blockquote>
<p>i am thinking to add a <code>value_ty</code> field to <a href="https://github.com/thejchap/ruff/blob/64c8a66390b14c6b3778a94dafa1a52eed82afc9/crates/ty_python_semantic/src/types.rs#L10209">EnumLiteralType</a> that stores <a href="https://github.com/thejchap/ruff/blob/64c8a66390b14c6b3778a94dafa1a52eed82afc9/crates/ty_python_semantic/src/types/enums.rs#L123">this value</a></p>
</blockquote>
<p>I would rather expect that we add the value <code>Type</code> for enum members to <code>members</code> on <code>EnumMetadata</code>? Maybe by turning it to a <code>Name =&gt; Type</code> <code>HashMap</code>? Is that what you meant?</p>
<blockquote>
<p>which i think would require giving <code>EnumMetadata</code> the <code>&#x27;db</code> lifetime</p>
</blockquote>
<p>Yes, it looks like that would require adding a lifetime parameter to <code>EnumMetadata</code>.</p>
<blockquote>
<p>anything im missing there</p>
</blockquote>
<p>I don&#x27;t think so</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-09-13 03:14</div>
            <div class="timeline-body">



<a href="https://codspeed.io/astral-sh/ruff/branches/thejchap%3Athejchap%2Fenum-members?runnerMode=Instrumentation">CodSpeed Instrumentation Performance Report</a>
Merging #20311 will <strong>not alter performance</strong>
<p>Comparing <code>thejchap:thejchap/enum-members</code> (78528f6) with <code>main</code> (d121a76)</p>
Summary
<p><code>✅ 43</code> untouched</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/thejchap">@thejchap</a> reviewed on 2025-09-13 12:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/thejchap">@thejchap</a> on <code>crates/ty_python_semantic/src/types/enums.rs</code>:21 on 2025-09-13 12:35</div>
            <div class="timeline-body"><p>changed from <code>FxHashMap</code> to <code>BTreeMap</code> because <code>FxHashMap</code> doesn&#x27;t implement <code>HashEqLike</code>, which it looks like is required for salsa to intern the struct</p>
<p>admittedly i am not 100% sure that interning the struct is necessary - i went down this road due to this error after adding the <code>&#x27;db</code> parameter to <code>EnumMetadata</code>, and it was the pattern i saw in other areas where structs with fields tied to the <code>&#x27;db</code> lifetime were getting returned from a tracked function (for example <a href="https://github.com/thejchap/ruff/blob/1c247f9130837bf52fdc873479222be92523d6c3/crates/ty_python_semantic/src/types/generics.rs#L103">GenericContext</a>)</p>
<pre><code>62 | pub(crate) fn enum_metadata&lt;&#x27;db&gt;(
   |                             --- lifetime `&#x27;db` defined here
...
65 | ) -&gt; Option&lt;EnumMetadata&lt;&#x27;db&gt;&gt; {
   |      ^^^^^^ requires that `&#x27;db` must outlive `&#x27;static`
</code></pre>
<p>for my own learning i&#x27;d appreciate a nudge in the right direction if this is the wrong approach, or a quick explanation as to why it was the right approach :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-13 13:00</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[ty] infer type for enum members&quot; to &quot;[ty] infer `name` and `value` for enum members&quot; by <a href="https://github.com/thejchap">@thejchap</a> on 2025-09-13 13:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/thejchap">@thejchap</a> on 2025-09-14 03:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/thejchap">@thejchap</a> on 2025-09-14 03:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/thejchap">@thejchap</a> on 2025-09-14 03:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/thejchap">@thejchap</a> on 2025-09-14 03:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/thejchap">@thejchap</a> on 2025-09-14 03:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/thejchap">@thejchap</a> reviewed on 2025-09-14 03:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/thejchap">@thejchap</a> on <code>crates/ty_python_semantic/resources/mdtest/enums.md</code>:186 on 2025-09-14 03:47</div>
            <div class="timeline-body"><p>https://diffswarm.dev/d-01k5331n13k9yx8tvnxnkeawp3?search=c-01k533qx21fstdzy6ys15rnjza</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-15 08:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-15 08:47</div>
            <div class="timeline-body">

<code>ecosystem-analyzer</code> results
<p>| Lint rule | Added | Removed | Changed |
|-----------|------:|--------:|--------:|
| <code>type-assertion-failure</code> | 1 | 11 | 0 |
| <code>invalid-argument-type</code> | 0 | 0 | 2 |
| <strong>Total</strong> | <strong>1</strong> | <strong>11</strong> | <strong>2</strong> |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/resources/mdtest/enums.md</code>:186 on 2025-09-15 09:07</div>
            <div class="timeline-body"><p>Thank you for adding this test. Can we separate it from the one above (let it have it&#x27;s own fenced code block) and add a small prose description above?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/resources/mdtest/enums.md</code>:37 on 2025-09-15 09:09</div>
            <div class="timeline-body"><p>Can we move these tests out of the &quot;Basic&quot; test, into a separate new section somewhere down below with a new section header?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/resources/mdtest/enums.md</code>:22 on 2025-09-15 09:10</div>
            <div class="timeline-body"><p>Similar to the comment below, let&#x27;s maybe only keep <code>.value</code> and <code>.name</code> here and move the <code>_value_</code>/<code>_name_</code> tests to a dedicated test section below that deals with these attributes on enum members?</p>
<pre><code>reveal_type(Color.RED.value)  # revealed: Literal[1]
reveal_type(Color.RED.name)  # revealed: Literal[&quot;RED&quot;]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types.rs</code>:3534 on 2025-09-15 09:11</div>
            <div class="timeline-body"><p>Is this necessary? (similar below)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/builder.rs</code>:433 on 2025-09-15 09:13</div>
            <div class="timeline-body"><p>This might be the cause for the performance regression? Is there any way we can prevent cloning and <code>collect</code>ing here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/enums.rs</code>:21 on 2025-09-15 09:15</div>
            <div class="timeline-body"><p>The alternative would be to derive <code>salsa::Update</code> for <code>EnumMetadata</code>. I think that should also get rid of this (very confusing and unhelpful) error message. That might be worth exploring to keep the diff in this PR smaller?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-09-15 09:15</div>
            <div class="timeline-body"><p>Thank you very much. This looks great.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/thejchap">@thejchap</a> reviewed on 2025-09-16 18:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/thejchap">@thejchap</a> on <code>crates/ty_python_semantic/src/types.rs</code>:3534 on 2025-09-16 18:26</div>
            <div class="timeline-body"><p>without this, <a href="https://github.com/astral-sh/ruff/pull/20311/files#diff-4ec0135eb3494415ddc8cee7f713314fcfcbc2b9d2722fa2292d75348791bd81R661">these tests</a> fail - i added this after reading through this <a href="https://github.com/astral-sh/ruff/pull/19481#issuecomment-3103460307">thread</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/carljm">@carljm</a> removed by <a href="https://github.com/carljm">@carljm</a> on 2025-09-16 18:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/thejchap">@thejchap</a> reviewed on 2025-09-16 20:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/thejchap">@thejchap</a> on <code>crates/ty_python_semantic/src/types/enums.rs</code>:21 on 2025-09-16 20:12</div>
            <div class="timeline-body"><p>required switching <code>FxOrderMap</code> to <code>FxIndexMap</code> because salsa <a href="https://github.com/salsa-rs/salsa/blob/master/src/update.rs#L322">does not provide</a> an <code>Update</code> impl for <code>FxOrderMap</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/dcreager">@dcreager</a> removed by <a href="https://github.com/dcreager">@dcreager</a> on 2025-09-17 01:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> approved on 2025-09-17 07:22</div>
            <div class="timeline-body"><p>Thank you!</p>
<p>Glad we could get rid of the performance regression.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-17 07:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-17 07:36</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:18:27 UTC
    </footer>
</body>
</html>
