<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] document test framework - astral-sh/ruff #13695</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] document test framework</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13695">#13695</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2024-10-09 23:04
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body"><p>This adds documentation for the new test framework.</p>
<p>I also added documentation for the planned design of features we haven't built yet (clearly marked as such), so that this doc can become the sole source of truth for the test framework design (we don't need to refer back to the original internal design document.)</p>
<p>Also fixes a few issues in the test framework implementation that were discovered in writing up the docs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @carljm on 2024-10-09 23:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @carljm on 2024-10-09 23:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @carljm on 2024-10-09 23:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-10-09 23:17</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/T-256">@T-256</a> on <code>crates/red_knot_test/README.md</code>:151 on 2024-10-10 00:01</div>
            <div class="timeline-body"><pre><code class="language-suggestion">x: int = y  # error: [invalid-assignment]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/T-256">@T-256</a> on <code>crates/red_knot_test/README.md</code>:168 on 2024-10-10 00:03</div>
            <div class="timeline-body"><p>it's not clarified that will there any plan for future to bypass this limitation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/T-256">@T-256</a> on <code>crates/red_knot_test/README.md</code>:253 on 2024-10-10 00:22</div>
            <div class="timeline-body"><p>I think mdtest used to improve readability of tests, I don't think embedding json content of Jupyter Notebook could help to keep it readable. how about make a link feature to external file?</p>
<pre><code class="language-markdown">````markdown
# test jpyter notebook
```ipynb
&lt;attach&gt;path=&quot;./embeddeds/test1.ipynb&quot;&lt;/attach&gt;
```
````
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/T-256">@T-256</a> reviewed on 2024-10-10 00:29</div>
            <div class="timeline-body"><p>There is circular imports concept in Python, do you plan support it into mdtests?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_test/README.md</code>:70 on 2024-10-10 04:20</div>
            <div class="timeline-body"><p>Assuming that the quotes are required, can we clarify that part somewhere here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_test/README.md</code>:91 on 2024-10-10 04:21</div>
            <div class="timeline-body"><p>I find &quot;non-assertion-comment&quot; a bit confusing because at first I thought it meant a non-assertion <em>comment</em>, so maybe the next statement / code line?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_test/README.md</code>:113 on 2024-10-10 04:23</div>
            <div class="timeline-body"><p>Should it be &quot;only one file can use...&quot; instead of &quot;only zero or one files can use...&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_test/README.md</code>:119 on 2024-10-10 04:24</div>
            <div class="timeline-body"><p>Did you mean?</p>
<pre><code class="language-suggestion">reveal_type(C)  # revealed: Literal[C]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_test/README.md</code>:253 on 2024-10-10 04:30</div>
            <div class="timeline-body"><p>Or, maybe some kind of start and end indicator that signals that any code blocks between them should be in a single Jupyter Notebook file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_test/README.md</code>:269 on 2024-10-10 04:32</div>
            <div class="timeline-body"><pre><code class="language-suggestion">```toml
[tool.knot]
warn-on-any = true
```

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_test/README.md</code>:326 on 2024-10-10 04:33</div>
            <div class="timeline-body"><pre><code class="language-suggestion">```py
reveal_type(I_AM_THE_ONLY_BUILTIN)  # revealed: Literal[1]
```

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-10-10 04:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-10-10 04:37</div>
            <div class="timeline-body"><blockquote>
<p>There is circular imports concept in Python, do you plan support it into mdtests?</p>
</blockquote>
<p>I'm not sure what extra support mdtests would need for circular imports? It allows you to create whatever Python files you like with whatever contents you like, so you can create and test any circular import scenario you would want.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-10 04:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/README.md</code>:168 on 2024-10-10 04:42</div>
            <div class="timeline-body"><p>It's an inherent limitation of <code>cargo test</code> that there is no way to dynamically create tests. I think to directly address this limitation we'd have to either write our own test runner, or use a build script to code-generate tests. Neither of those are planned.</p>
<p>What I think is more likely to indirectly address this problem is that we could add some kind of &quot;focus&quot; indicator that's easy to add and remove from a test file that will cause it to only run that test from that file. Or we could do something similar that works via env var.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-10 04:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/README.md</code>:253 on 2024-10-10 04:57</div>
            <div class="timeline-body"><p>I guess it depends what we need to test about notebooks. If all we care about is the Python contents of cells, then something like @dhruvmanila suggests makes sense. If we want to write tests in this format that actually test other characteristics of the JSON structure of a notebook, then I think we should embed the JSON directly. It doesn't help readability to have key aspects of the test hidden in a different file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-10-10 05:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_test/README.md</code>:253 on 2024-10-10 05:04</div>
            <div class="timeline-body"><blockquote>
<p>If we want to write tests in this format that actually test other characteristics of the JSON structure of a notebook</p>
</blockquote>
<p>I'm not sure if Red Knot should be testing the notebook JSON structure, I think it should be done as an integration tests which currently there are :)</p>
<p>But yeah, what you said makes sense and we can think about it when it's required.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:30 on 2024-10-10 08:16</div>
            <div class="timeline-body"><pre><code class="language-suggestion">Two kinds of assertions are supported: `# revealed:` (shown above) and `# error:`.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:43 on 2024-10-10 09:30</div>
            <div class="timeline-body"><p>I'd move everything after the em-dash here into a footnote. It's a useful clarification for what you mean by &quot;pseudo-standard-library module&quot;, but it's also not directly relevant to the thing you're explaining.</p>
<p>Should we open this paragraph by talking about <code>typing_extensions</code>, and then after that discuss that it can also be imported from <code>typing</code> on newer versions of Python? If it's being imported in tests, I'd wager that 99% of the time you'll want to import it from <code>typing_extensions</code> rather than <code>typing</code>, since most tests are not going to be Python-version-specific.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:45 on 2024-10-10 09:46</div>
            <div class="timeline-body"><pre><code class="language-suggestion">from typing_extensions import reveal_type
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:58 on 2024-10-10 09:47</div>
            <div class="timeline-body"><p>Is this documentation for people writing tests using the test framework, or for people developing the test framework? I assumed the former, in which case I think this delves too far into implementation details of exactly how the <code>unimported-reveal</code> diagnostics are suppressed by the test framework. (Well, in our current implementation, they're not exactly &quot;suppressed&quot; at all, but they're never visible to people writing or running the tests, so it comes to the same thing!)</p>
<pre><code class="language-suggestion">For convenience, type checkers also pretend that `reveal_type` is a built-in, so that this import is
not required. Style preference is to usually not import it in tests, unless specifically testing
something about the behavior of importing it.

(Using `reveal_type` without importing it generally causes red-knot to issue a diagnostic warning
that it was used without importing it, to guard against errors at runtime. However, in the specific
context of tests using mdtest, this diagnostic is never emitted.)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:63 on 2024-10-10 09:50</div>
            <div class="timeline-body"><p>(not sure I love this. I feel like we could easily end up with tests silently and incorrectly passing because an unintended kind of error is being matched.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:74 on 2024-10-10 10:00</div>
            <div class="timeline-body"><pre><code class="language-suggestion">Any combination of some or all of these can be used in a single assertion, but they must come in
order: first column, if present; then rule code, if present; then contains-text, if present. For
example, an assertion using all three would look like
`# error: 8 [invalid-assignment] &quot;Some text&quot;`.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:76 on 2024-10-10 10:04</div>
            <div class="timeline-body"><pre><code class="language-suggestion">Error assertions in tests intended to test type checker semantics should primarily use rule-code
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:81 on 2024-10-10 10:05</div>
            <div class="timeline-body"><p>this feels sorta tautological, and kind of obvious. I think I'd remove it.</p>
<pre><code class="language-suggestion"></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:91 on 2024-10-10 10:24</div>
            <div class="timeline-body"><p>Or &quot;applies to the next line that does not contain an assertion comment&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:108 on 2024-10-10 10:25</div>
            <div class="timeline-body"><pre><code class="language-suggestion">assertion as the line of source code on which the matched diagnostics are emitted.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:112 on 2024-10-10 10:26</div>
            <div class="timeline-body"><pre><code class="language-suggestion">Some tests require multiple files, with imports from one file into another. Multiple fenced code
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:113 on 2024-10-10 10:26</div>
            <div class="timeline-body"><p>or &quot;at most one file can use...&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:119 on 2024-10-10 10:27</div>
            <div class="timeline-body"><p>maybe we should doctest our documentation for mdtest üòÜ</p>
<p>(This is a joke, I don't know how we'd actually do that.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:127 on 2024-10-10 10:30</div>
            <div class="timeline-body"><p>I don't know that new contributors will necessarily know what &quot;import root&quot; means here, though I don't immediately have a better suggestion</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:137 on 2024-10-10 10:37</div>
            <div class="timeline-body"><p>&quot;Markdown&quot;, &quot;markdown&quot; or &quot;MarkDown&quot;? You have two spellings in the same sentence here ;)</p>
<p>I don't mind too much, but we should at least be consistent!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:163 on 2024-10-10 10:38</div>
            <div class="timeline-body"><pre><code class="language-suggestion">The tests are run independently, in independent in-memory file systems and with new red-knot [Salsa](https://github.com/salsa-rs/salsa)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:165 on 2024-10-10 10:38</div>
            <div class="timeline-body"><pre><code class="language-suggestion">databases. This means that each is a from-scratch run of the type checker, with no data persisting from any
previous test.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:167 on 2024-10-10 10:39</div>
            <div class="timeline-body"><pre><code class="language-suggestion">Due to limitations of Rust's leading test runners, an entire test suite (Markdown file) is run as a single Rust
</code></pre>
<p>Or &quot;commonly used&quot;, etc. I doubt it's an inherent limitation of all test runners written in Rust :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:201 on 2024-10-10 10:41</div>
            <div class="timeline-body"><p>Beware the comma splice!</p>
<pre><code class="language-suggestion">A header-demarcated section must either be a test or a grouping header; it cannot be both. That is,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:208 on 2024-10-10 10:43</div>
            <div class="timeline-body"><pre><code class="language-suggestion">the test framework) between fenced code blocks. This permits natural documentation of
why a test exists, and what it intends to assert:
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:225 on 2024-10-10 10:45</div>
            <div class="timeline-body"><pre><code class="language-suggestion">We may want to be able to assert that a diagnostic spans multiple lines, and to assert the columns it
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:226 on 2024-10-10 10:45</div>
            <div class="timeline-body"><pre><code class="language-suggestion">begins and/or ends on. The planned syntax for this will use `&lt;&lt;&lt;` and `&gt;&gt;&gt;` to mark the start and end lines for
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:237 on 2024-10-10 10:48</div>
            <div class="timeline-body"><p>maybe this?</p>
<pre><code class="language-suggestion">In cases of overlapping such assertions, resolve ambiguity using more chevrons: `&lt;&lt;&lt;&lt;` begins an
</code></pre>
<p>strictly speaking <code>&lt;</code> is an &quot;angle bracket&quot;, but in the realm of software I'd generally think of &quot;bracket&quot; as referring to one of the <code>()[]{}</code> characters.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:258 on 2024-10-10 10:49</div>
            <div class="timeline-body"><pre><code class="language-suggestion">A fenced code block with no language will always be an error.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:255 on 2024-10-10 10:51</div>
            <div class="timeline-body"><pre><code class="language-suggestion">Of course, red-knot is only run directly on `py` and `pyi` files, and assertion comments are only
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:245 on 2024-10-10 10:51</div>
            <div class="timeline-body"><pre><code class="language-suggestion">We will allow specifying any of these using the `text` language in the code block tag string:
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:263 on 2024-10-10 10:52</div>
            <div class="timeline-body"><pre><code class="language-suggestion">We will add the ability to specify non-default red-knot configurations to use in tests, 
by including a TOML-fenced code block:
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:278 on 2024-10-10 10:55</div>
            <div class="timeline-body"><pre><code class="language-suggestion">It should be possible to include a TOML-fenced code block in a single test (as shown), or in a
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:281 on 2024-10-10 10:56</div>
            <div class="timeline-body"><p>I'd prefer &quot;configurations&quot; rather than &quot;configs&quot;... but you use &quot;configs&quot; pretty consistently, so I won't comment all instances of this üòõ</p>
<pre><code class="language-suggestion">grouping section, in which case it applies to all nested tests within that grouping section.
Configurations at multiple level are allowed and merged, with the most-nested (closest to the test)
taking precedence.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:288 on 2024-10-10 10:59</div>
            <div class="timeline-body"><pre><code class="language-suggestion">of these can be replaced by real red-knot config options; some or all may also be kept long-term
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:296 on 2024-10-10 11:00</div>
            <div class="timeline-body"><pre><code class="language-suggestion">Other future planned changes to configuration include:

- We should be able to configure the default workspace root to something other than `/src/` using a
`workspace-root` config option.

- We should be able to add a third-party root using the `third-party-root` config option.

- We may want to add additional config options for setting additional search path kinds.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:303 on 2024-10-10 11:01</div>
            <div class="timeline-body"><pre><code class="language-suggestion">### Specifying a custom typeshed
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:331 on 2024-10-10 11:01</div>
            <div class="timeline-body"><p>scary</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:342 on 2024-10-10 11:03</div>
            <div class="timeline-body"><pre><code class="language-suggestion">output of a tested Python snippet. Or sometimes (see ‚Äúincremental tests‚Äù below) we will want to assert on diagnostics
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:345 on 2024-10-10 11:03</div>
            <div class="timeline-body"><pre><code class="language-suggestion">`output`; this would contain the full diagnostic output for the preceding test file:
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:355 on 2024-10-10 11:04</div>
            <div class="timeline-body"><pre><code class="language-suggestion">This is just an example, not a proposal that red-knot would ever actually output diagnostics in
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:364 on 2024-10-10 11:04</div>
            <div class="timeline-body"><pre><code class="language-suggestion">blocks, when tests are run in an update-output mode (probably specified by an environment variable.)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:366 on 2024-10-10 11:05</div>
            <div class="timeline-body"><pre><code class="language-suggestion">By default, an `output` block will specify diagnostic output for the file `&lt;workspace-root&gt;/test.py`.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:422 on 2024-10-10 11:06</div>
            <div class="timeline-body"><pre><code class="language-suggestion">It will be possible to provide any number of stages in an incremental test. If a stage re-specifies a filename that
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:423 on 2024-10-10 11:06</div>
            <div class="timeline-body"><pre><code class="language-suggestion">was specified in a previous stage (or the initial stage), that file is modified. A new filename
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:424 on 2024-10-10 11:06</div>
            <div class="timeline-body"><pre><code class="language-suggestion">appearing for the first time in a new stage will create a new file. To delete a previously created
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:426 on 2024-10-10 11:07</div>
            <div class="timeline-body"><p>Closing parens should come before the period unless it's a full sentence inside the parens:</p>
<pre><code class="language-suggestion">provide non-empty contents). Any previously-created files that are not re-specified in a later stage
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-10 11:09</div>
            <div class="timeline-body"><p>Thank you!! This is extremely valuable.</p>
<p>Despite having previously reviewed your proposal for this framework in Notion, and the actual implementation, it actually made me realise there were several aspects I wasn't aware of before reading this :-)</p>
<p>Some comments below, none huge:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-10 14:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/README.md</code>:43 on 2024-10-10 14:30</div>
            <div class="timeline-body"><p>Using a footnote for the digression is a good idea, I'll do that.</p>
<blockquote>
<p>I'd wager that 99% of the time you'll want to import it from <code>typing_extensions</code> rather than <code>typign</code></p>
</blockquote>
<p>I don't think this is true; I think rather that 99% of tests will not import it at all, and the only ones that do will be a few tests that are explicitly testing the handling of imported vs pseudo-builtin <code>reveal_type</code>, and of those few tests probably roughly half (i.e. just one or two tests each) will import it each way.</p>
<p>I think the more important consideration here is that the preferred and modern thing to do, if on a Python version where it's possible, is to import from <code>typing</code>, so that's what should be featured, and the legacy approach should be a parenthetical.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-10 14:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/README.md</code>:58 on 2024-10-10 14:59</div>
            <div class="timeline-body"><p>I think the current text accurately and precisely describes how they are handled, and this information is relevant to authors/readers of tests, because the details of how they are handled can be visible to authors of tests. For example, if you do <code>rt = return_type</code> and then <code>rt(foo) # revealed: ...</code> on another line, you will see unimported-reveal diagnostic on the <code>rt = return_type</code> line, and it won't be matched by the <code># revealed: ...</code> assertion. And we will certainly have at least some tests that depend on these distinctions: the tests of the undefined-reveal diagnostic itself.</p>
<p>The proposed new text isn't noticeably shorter, and it has the disadvantage of being wrong :) It's simply not true that &quot;this diagnostic is never emitted&quot; in tests using mdtest. It is emitted as normal, but then matched, if present, by the <code># revealed</code> assertion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-10 15:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/README.md</code>:58 on 2024-10-10 15:12</div>
            <div class="timeline-body"><p>Reading this again, I do think the text could be re-ordered a bit to emphasize the most important thing (<code># revealed: </code> matches a revealed type from <code>reveal_type</code>) and then follow up with the stuff about undefined-reveal separately; I'll look at an edit along those lines.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-10 15:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/README.md</code>:63 on 2024-10-10 15:14</div>
            <div class="timeline-body"><p>I agree that we should probably never use this, it's just the most natural implementation to allow it. But it wouldn't be hard to issue an error if it's used. Personally I think it's OK to allow such assertions but just avoid using them. If we want to prohibit them, we have to decide what the precise rule should be. Is an assertion that only asserts the column OK? Or should the error code always be required? Or should it be &quot;either error code or message-contains&quot; that is required?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:63 on 2024-10-10 15:16</div>
            <div class="timeline-body"><blockquote>
<p>Personally I think it's OK to allow such assertions but just avoid using them.</p>
</blockquote>
<p>I think it's inevitable that either one of us or a contributor adds one (either deliberately or accidentally) at some point, if we allow it!</p>
<blockquote>
<p>Or should it be &quot;either error code or message-contains&quot; that is required?</p>
</blockquote>
<p>I would say this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-10 15:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-10 15:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/README.md</code>:119 on 2024-10-10 15:17</div>
            <div class="timeline-body"><p>I would love to do that! But probably not a priority :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-10 15:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/README.md</code>:127 on 2024-10-10 15:18</div>
            <div class="timeline-body"><p>I can try to make it more clear, maybe with reference to <code>sys.path</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-10 15:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/README.md</code>:137 on 2024-10-10 15:18</div>
            <div class="timeline-body"><p>Agreed, I prefer &quot;Markdown&quot; and will aim to be consistent with that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/README.md</code>:167 on 2024-10-10 15:19</div>
            <div class="timeline-body"><p>I'll probably be more specific here and just say due to <code>cargo test</code> limitations</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-10 15:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-10 15:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/README.md</code>:237 on 2024-10-10 15:21</div>
            <div class="timeline-body"><p>I think &quot;chevron&quot; (at least in the US context) is not an improvement in clarity; I've rarely seen that word used to describe <code>&lt;</code> or <code>&gt;</code> characters. I'll replace &quot;brackets&quot; with &quot;angle brackets&quot;; that seems clearest.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-10 15:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/README.md</code>:245 on 2024-10-10 15:22</div>
            <div class="timeline-body"><p>I was trying to steer away from language that suggests an ironclad commitment to do any of these things precisely as described...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-10 15:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/README.md</code>:263 on 2024-10-10 15:24</div>
            <div class="timeline-body"><p>Same comment as above; I was preferring to avoid definitive &quot;will&quot; language.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-10 15:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/README.md</code>:342 on 2024-10-10 15:26</div>
            <div class="timeline-body"><p>I'll probably use &quot;embedded Python file&quot; here for consistency</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-10 15:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/README.md</code>:63 on 2024-10-10 15:29</div>
            <div class="timeline-body"><p>Ok, that seems reasonable, I'll look at making that behavior change in this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-10 15:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:245 on 2024-10-10 15:42</div>
            <div class="timeline-body"><p>Hmm... maybe &quot;might&quot; in that case? &quot;Should&quot; doesn't feel sufficiently future-tense-y to me</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-10 16:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/README.md</code>:168 on 2024-10-10 16:25</div>
            <div class="timeline-body"><p>Added some discussion of this in the &quot;future features&quot; section.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-10 16:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/README.md</code>:245 on 2024-10-10 16:26</div>
            <div class="timeline-body"><p>But I guess this one we definitely will need, so sure, I'll use &quot;will&quot; :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-10 16:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/README.md</code>:253 on 2024-10-10 16:27</div>
            <div class="timeline-body"><p>Updated the text here to not mention using <code>json</code> language and just say exact syntax is TBD.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/README.md</code>:263 on 2024-10-10 16:28</div>
            <div class="timeline-body"><p>Ok, looking at it again, I think this is another case where we are pretty committed to doing this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-10 16:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-10 16:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/README.md</code>:263 on 2024-10-10 16:29</div>
            <div class="timeline-body"><p>I don't think &quot;TOML-fenced&quot; is correct here. The code block is fenced by triple back ticks, it is not fenced by TOML. It is a &quot;fenced code block&quot; whose language is TOML.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-10-10 16:33</div>
            <div class="timeline-body"><p>Ok, pushed an updated that I think addresses all comments.</p>
<p>I also realized in working on the change to require either rule or message-contains, that when a diagnostic doesn't match any assertion we should include its actual column in the &quot;unexpected error&quot; output, otherwise it's hard to debug a failure to match on the column, so I made this change as well. And in the course of making that change, I realized that some tests were not using <code>dedent</code> when they should, resulting in silly column numbers, so I fixed that as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:263 on 2024-10-10 16:33</div>
            <div class="timeline-body"><p>Ah I see! In that case I think maybe the adjective order is incorrect/confusing; that's certainly not how I read it. Possibly &quot;fenced TOML code block&quot; would be better?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-10 16:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:68 on 2024-10-10 18:19</div>
            <div class="timeline-body"><p>nit: some very long lines here!</p>
<pre><code class="language-suggestion">- `# error: &quot;Some text&quot;` requires that the matched diagnostic's full message contain the text
    `Some text`. (The double quotes are required in the assertion comment; they are not 
    part of the matched text.)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:74 on 2024-10-10 18:19</div>
            <div class="timeline-body"><pre><code class="language-suggestion">then contains-text, if present. For example, an assertion using all three would look like
`# error: 8 [invalid-assignment] &quot;Some text&quot;`.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:163 on 2024-10-10 18:20</div>
            <div class="timeline-body"><pre><code class="language-suggestion">The tests are run independently, in independent in-memory file systems and with new red-knot
[Salsa](https://github.com/salsa-rs/salsa) databases. This means that each is a
from-scratch run of the type checker, with no data persisting from any previous test.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:279 on 2024-10-10 18:20</div>
            <div class="timeline-body"><pre><code class="language-suggestion">It should be possible to include a TOML code block in a single test (as shown), or in a
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-10-10 18:21</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-10 18:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/README.md</code>:68 on 2024-10-10 18:26</div>
            <div class="timeline-body"><p>Oops, thanks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-10-10 18:44</div>
            <div class="timeline-body"><p>Thanks for the thorough review!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @carljm on 2024-10-10 19:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2024-10-10 19:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-10-10 19:02</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:06:55 UTC
    </footer>
</body>
</html>
