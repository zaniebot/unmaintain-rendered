<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] No boundness analysis for implicit instance attributes - astral-sh/ruff #20128</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] No boundness analysis for implicit instance attributes</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20128">#20128</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-08-28 09:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>With this PR, we stop performing boundness analysis for implicit instance attributes:</p>
<pre><code class="language-py">class C:
    def __init__(self):
        if False:   
            self.x = 1

C().x  # would previously show an error, with this PR we pretend the attribute exists
</code></pre>
<p>This PR is potentially just a temporary measure until we find a better fix. But I have already invested a lot of time trying to find the root cause of https://github.com/astral-sh/ty/issues/758 (and <a href="https://github.com/astral-sh/ty/issues/758#issuecomment-3206108262">this example</a>, which I'm not entirely sure is related) and I still don't understand what is going on. This PR fixes the performance problems in both of these problems (in a rather crude way).</p>
<p>The impact of the proposed change on the ecosystem is small, and the three new diagnostics are arguably true positives (previously hidden because we considered the code unreachable, based on e.g. <code>assert</code>ions that depended on implicit instance attributes). So this seems like a reasonable fix for now.</p>
<p>Note that we still support cases like these:</p>
<pre><code class="language-py">class D:
    if False:  # or any other expression that statically evaluates to `False`
        x: int = 1

D().x  # still an error


class E:
    if False:  # or any other expression that statically evaluates to `False`
        def f(self):
            self.x = 1

E().x  # still an error
</code></pre>
<p>closes https://github.com/astral-sh/ty/issues/758</p>
<h2>Test Plan</h2>
<p>Updated tests, benchmark results</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @sharkdp on 2025-08-28 09:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-28 09:10</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-28 09:12</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">trio (https://github.com/python-trio/trio)
+ src/trio/_tests/test_ssl.py:932:15: error[call-non-callable] Object of type `None` is not callable
- Found 675 diagnostics
+ Found 676 diagnostics

ignite (https://github.com/pytorch/ignite)
+ tests/ignite/metrics/test_precision.py:377:17: warning[possibly-unbound-attribute] Attribute `cpu` on type `Unknown | int | float | list[int | float] | list[str] | list[Any]` is possibly unbound
+ tests/ignite/metrics/test_recall.py:380:17: warning[possibly-unbound-attribute] Attribute `cpu` on type `Unknown | int | float | list[int | float] | list[str] | list[Any]` is possibly unbound
- Found 2107 diagnostics
+ Found 2109 diagnostics

</code></pre>
</details>
No memory usage changes detected âœ…

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[ty] No reachability analysis for implicit instance attributes" to "[ty] No boundness analysis for implicit instance attributes" by @sharkdp on 2025-08-28 13:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-08-28 13:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/semantic_index/reachability_constraints.rs</code>:823 on 2025-08-28 13:28</div>
            <div class="timeline-body"><p>I have added and removed this so many times... it's obviously useful, so I guess there's no harm in leaving it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-08-28 13:52</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_INSTRUMENTATION_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/david%2Fno-reachability-for-implicit-attributes?runnerMode=Instrumentation">CodSpeed Instrumentation Performance Report</a></h2>
<h3>Merging #20128 will <strong>improve performances by Ã—3.9</strong></h3>
<p><sub>Comparing <code>david/no-reachability-for-implicit-attributes</code> (ceab895) with <code>main</code> (e586f6d)</sub></p>
<h3>Summary</h3>
<p><code>âš¡ 2</code> improvements<br />
<code>âœ… 41</code> untouched benchmarks</p>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| âš¡ | <code>ty_micro[complex_constrained_attributes_2]</code> | 96.3 ms | 63 ms | +52.86% |
| âš¡ | <code>ty_micro[complex_constrained_attributes_3]</code> | 261 ms | 66.8 ms | Ã—3.9 |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @sharkdp on 2025-08-28 13:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2025-08-28 13:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2025-08-28 13:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @sharkdp on 2025-08-28 13:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-08-28 14:19</div>
            <div class="timeline-body"><p>Branch-dependent attributes are much more common in stub files than in runtime code. I wonder if it would make sense to add a diagnostic that <em>enforces</em> that you should never have any implicit instance attributes in a stub file. I.e., since we will now have different behaviour for the two different snippets, we could add a diagnostic that says that in a stub file you should never do this:</p>
<pre><code class="language-py">import sys

class F:
    def __init__(self) -&gt; None:
        if sys.version_info &gt;= (3, 13):
            self.x: int
</code></pre>
<p>and that instead you should always do this:</p>
<pre><code class="language-py">import sys

class Foo:
    if sys.version_info &gt;= (3, 13):
        x: int
</code></pre>
<p>(but the new diagnostic could probably trigger for any implicit instance attribute in a stub file, not just ones inside branches -- it'll be simpler to implement that way, and there's no real reason to ever have any implicit instance attributes in a stub file)</p>
<p>Then again, now that I think about it, that's all already covered by https://docs.astral.sh/ruff/rules/non-empty-stub-body/, so maybe we should just recommend that users should enable that Ruff rule on their stub files</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-08-28 14:24</div>
            <div class="timeline-body"><blockquote>
<p>Branch-dependent attributes are much more common in stub files than in runtime code. I wonder if it would make sense to add a diagnostic that <em>enforces</em> that you should never have any implicit instance attributes in a stub file. I.e., since we will now have different behaviour for the two different snippets [â€¦]</p>
</blockquote>
<p>I don't see any reason why someone would declare the type of instance attributes the complicated way <em>in a stub</em>, if there is a much easier way to just declare it on the body of the class. The implicit syntax wouldn't enable any use cases that wouldn't be covered by a simple <code>attribute: type</code> declaration on the body, I think? So I would argue that this inconsistency is nothing we need to immediately worry about, especially if there is a Ruff lint that would &quot;catch&quot; it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2025-08-28 14:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-08-28 14:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-28 14:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-28 14:49</div>
            <div class="timeline-body"><blockquote>
<p>I don't see any reason why someone would declare the type of instance attributes the complicated way <em>in a stub</em>, if there is a much easier way to just declare it on the body of the class.</p>
</blockquote>
<p>there's no reason, no! But, folks do strange things sometimes -- I'd wager money that there's <em>a</em> stub file out there <em>somewhere</em> that does something like that ðŸ˜†</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:15:22 UTC
    </footer>
</body>
</html>
