<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Fix disjointness checks with type-of `@final` classes - astral-sh/ruff #21770</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Fix disjointness checks with type-of <code>@final</code> classes</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21770">#21770</a>
        opened by <a href="https://github.com/ibraheemdev">@ibraheemdev</a>
        on 2025-12-03 06:19
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-12-03 06:19</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>We currently perform a subtyping check, similar to what we were doing for <code>@final</code> instances before https://github.com/astral-sh/ruff/pull/21167, which is incorrect, e.g. we currently consider <code>type[X[Any]]</code> and <code>type[X[T]]]</code> disjoint (where <code>X</code> is <code>@final</code>).</p>
<p>Stacked on https://github.com/astral-sh/ruff/pull/21769.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @ibraheemdev on 2025-12-03 06:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-03 06:21</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-03 06:25</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">beartype (https://github.com/beartype/beartype)
- beartype/claw/_package/clawpkgtrie.py:66:29: warning[unsupported-base] Unsupported class base with type `&lt;class 'dict[str, PackagesTrieBlacklist]'&gt; | &lt;class 'dict[str, Divergent]'&gt;`
- beartype/claw/_package/clawpkgtrie.py:247:29: warning[unsupported-base] Unsupported class base with type `&lt;class 'dict[str, PackagesTrieWhitelist]'&gt; | &lt;class 'dict[str, Divergent]'&gt;`
- Found 491 diagnostics
+ Found 489 diagnostics

static-frame (https://github.com/static-frame/static-frame)
- static_frame/core/display.py:483:66: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/display.py:486:57: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/display.py:517:85: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/frame.py:5335:57: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/frame.py:5346:64: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/frame.py:7157:74: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/index.py:251:49: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/index.py:689:66: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/index.py:1117:80: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/index_hierarchy.py:556:41: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/index_hierarchy.py:557:37: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/index_hierarchy.py:558:30: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/pivot.py:248:76: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/pivot.py:249:48: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/pivot.py:250:55: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/pivot.py:252:47: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/pivot.py:253:44: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/pivot.py:260:44: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/reduce.py:462:48: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/reduce.py:463:39: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/reduce.py:486:48: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/reduce.py:487:39: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/series.py:2106:64: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/type_blocks.py:1881:72: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/type_blocks.py:1883:70: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/util.py:444:48: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/util.py:445:34: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/util.py:446:40: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/util.py:448:52: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/util.py:449:28: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/util.py:452:34: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/util.py:453:89: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/util.py:455:69: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/util.py:457:67: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/util.py:459:49: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/util.py:2094:34: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/util.py:2095:32: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- static_frame/core/util.py:2096:32: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 1833 diagnostics
+ Found 1795 diagnostics

pandas-stubs (https://github.com/pandas-dev/pandas-stubs)
- pandas-stubs/_typing.pyi:1217:16: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 5259 diagnostics
+ Found 5258 diagnostics


</code></pre>
</details>

<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-12-03 06:41</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/ibraheem%2Ftype-of-final-class-disjointness?utm_source=github&amp;utm_medium=comment&amp;utm_content=header">CodSpeed Performance Report</a></h2>
<h3>Merging #21770 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>ibraheem/type-of-final-class-disjointness</code> (e4e1ff2) with <code>main</code> (5dc0079)</sub></p>
<h3>Summary</h3>
<p><code>✅ 22</code> untouched<br />
<code>⏩ 30</code> skipped[^skipped]</p>
<p>[^skipped]: 30 benchmarks were skipped, so the baseline results were used instead. If they were deleted from the codebase, <a href="https://codspeed.io/astral-sh/ruff/branches/ibraheem%2Ftype-of-final-class-disjointness?sectionId=benchmark-comparison-section-baseline-result-skipped&amp;utm_source=github&amp;utm_medium=comment&amp;utm_content=archive">click here and archive them to remove them from the performance reports</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-12-03 11:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_python_semantic/resources/mdtest/type_of/basic.md</code>:257 on 2025-12-03 11:27</div>
            <div class="timeline-body"><p>There are a couple false negatives here, including this one (see https://github.com/astral-sh/ruff/pull/21769#discussion_r2584496310).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @ibraheemdev on 2025-12-03 11:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @ibraheemdev on 2025-12-03 11:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @ibraheemdev on 2025-12-03 11:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @ibraheemdev on 2025-12-03 11:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @ibraheemdev on 2025-12-03 11:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/type_of/basic.md</code>:276 on 2025-12-04 00:40</div>
            <div class="timeline-body"><p>This comment seems too weak, at least if it's meant to be apply to the next two lines specifically? It doesn't matter what <code>T</code> and <code>U</code> specialize to; <code>BivSub</code> is bivariant in <code>T</code>, so <code>BivSub[T]</code> and <code>BivSub[U]</code> are equivalent, and thus so are <code>type[BivSub[T]]</code> and <code>type[BivSub[U]]</code>.</p>
<p>But maybe it's meant to apply in general to all the tests in this function, in which case it makes sense for the non-bivariant cases; maybe should just be moved down.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-12-09 23:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-12-10 19:37</div>
            <div class="timeline-body"><p>Oh, it looks like you're solving some some tests with TODOs that I added earlier today (https://github.com/astral-sh/ty/issues/1842)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-12-10 19:52</div>
            <div class="timeline-body"><p>@sharkdp I think I've fixed those by delegating to the default specialization, now that we have an implementation for disjointness between generic aliases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ibraheemdev on 2025-12-10 20:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ibraheemdev on 2025-12-10 20:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-12-10 20:15</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:42:35 UTC
    </footer>
</body>
</html>
