<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avoid allocations in comments - astral-sh/ruff #7689</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Avoid allocations in comments</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7689">#7689</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-09-28 03:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-28 03:53</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR avoids all allocations when normalizing comments. Previously, we used <code>Cow</code> for this, as we had two cases:</p>
<ol>
<li>The comment is included verbatim (use <code>Cow</code>; then, when formatting, we already know the start of the range, and we use the length of the string to find the end of it -- the string itself was never used, only its length).</li>
<li>The comment is normalized (use <code>Borrow</code>).</li>
</ol>
<p>It turns out that in the normalized case, we're <em>always</em> printing a <code>#</code>, followed by a space, followed by some substring that already exists in the source code. (Computing this substring is a little messy due to the non-breaking-space special cases... but, in any event, it's always a substring, with some stuff trimmed from the start or end.)</p>
<p>Instead of using <code>Cow</code> and allocating for the normalization case, this PR adds an enum that represents the ranges of a verbatim case (Case 1) or a comment body (Case 2). When printing the former, we use the range directly; when printing the latter, we manually print the <code># </code>, followed by the source code slice:</p>
<pre><code class="language-rust">#[derive(Debug)]
enum NormalizedComment {
    /// A complete comment, including the leading `#`.
    Verbatim(TextRange),

    /// A comment body, exclusive of the leading `#` and a leading space.
    Body(TextRange),
}
</code></pre>
<h2>Test Plan</h2>
<p><code>cargo test</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @charliermarsh on 2023-09-28 03:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2023-09-28 03:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @charliermarsh on 2023-09-28 03:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-28 03:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/comments/format.rs</code>:436 on 2023-09-28 03:54</div>
            <div class="timeline-body"><p>It'd be nice if this returned <code>Width</code>, but there's no way to add <code>2u32</code> to a <code>Width</code>. (<code>Width</code> doesn't even expose a public constructor, which I assumed was intentional.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/comments/format.rs</code>:469 on 2023-09-28 03:56</div>
            <div class="timeline-body"><p>I think this code became a little bit less clear due to the use of <code>Cursor</code>. It would be much clearer if we didn't have the <code>&amp;nbsp</code> special-casing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-28 03:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-28 03:57</div>
            <div class="timeline-body"><p>I got nerd sniped on this, but it's probably not a huge win since comment normalization isn't that common.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/format.rs</code>:414 on 2023-09-28 06:26</div>
            <div class="timeline-body"><p>You can implement <code>Format</code> directly on <code>NormalizedComment</code>. The orphan rule doesn't apply here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/format.rs</code>:499 on 2023-09-28 06:30</div>
            <div class="timeline-body"><p>You could use <code>cursor.start_token()</code> and then <code>cursor.token_len</code> to get the length instead of doing the math manually (same in other places)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/format.rs</code>:504 on 2023-09-28 06:31</div>
            <div class="timeline-body"><p>Use <code>eat_char</code>? We seem to be skipping it in all branches</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/format.rs</code>:512 on 2023-09-28 06:33</div>
            <div class="timeline-body"><p>I find the position calculation difficult to understand.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/format.rs</code>:376 on 2023-09-28 06:33</div>
            <div class="timeline-body"><p>Why do we need to add 2 here again when <code>nomalized_comment</code> already adds 2?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-09-28 06:36</div>
            <div class="timeline-body"><p>That's an interesting optimisation. Nevertheless, I would stick with the current solution because it is less code (easier to understand), probably easier to extend in the future, and not really in the hot path. This is also shown by the neutral benchmark results: +- 1%.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/comments/format.rs</code>:436 on 2023-09-28 09:29</div>
            <div class="timeline-body"><p>Could you impl Add for TextWidth and add <code>TextWidth::from_text(&quot;# &quot;)</code> instead?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-09-28 09:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-28 09:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/format.rs</code>:436 on 2023-09-28 09:37</div>
            <div class="timeline-body"><p>We may want to consider that <code>TextWidth::from_text</code> probably leads to significantly more complicated code because I doubt that the compiler can see past the <code>unicode_width</code> crate. I think <code>2</code> is fine with a comment</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-10-14 18:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-14 18:56</div>
            <div class="timeline-body"><p>Closing based on above feedback, though I still think it's neat.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-10-14 18:56</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 02:33:16 UTC
    </footer>
</body>
</html>
