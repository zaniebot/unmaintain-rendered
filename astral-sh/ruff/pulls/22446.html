<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skip walking all tokens when loading range suppressions - astral-sh/ruff #22446</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Skip walking all tokens when loading range suppressions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22446">#22446</a>
        opened by <a href="https://github.com/amyreese">@amyreese</a>
        on 2026-01-07 22:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a></div>
            <div class="timeline-body"><ul>
<li>Adds <code>Tokens::split_at()</code> to get tokens before/after an offset.</li>
<li>Updates <code>Suppressions::load_from_tokens</code> to take an <code>Indexer</code> and use comment ranges to minimize the need for walking tokens looking for indent/dedent.</li>
</ul>
<p>Adapted from <a href="https://github.com/astral-sh/ruff/pull/21441">astral-sh/ruff#21441</a>#pullrequestreview-3503773083</p>
<p>Fixes #22087</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-07 22:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-07 22:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-07 22:49</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-08 01:20</div>
            <div class="timeline-body"><p>The original codspeed run I think showed a 1% perf <em>regression</em> on a few benchmarks, but I also don&#x27;t think we have any codspeed jobs that would actually exercise this functionality yet since the range suppressions aren&#x27;t likely to be found in the wild yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-08 08:04</div>
            <div class="timeline-body"><p>We&#x27;ll probably need to temporarily remove the preview gating to see if we mitigated the perf regression that we&#x27;ve seen on your first PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-08 18:09</div>
            <div class="timeline-body"><blockquote>
<p>We&#x27;ll probably need to temporarily remove the preview gating to see if we mitigated the perf regression that we&#x27;ve seen on your first PR.</p>
</blockquote>
<p>Looks like a <a href="https://codspeed.io/astral-sh/ruff/branches/amy%2Fsuppression-perf-2?uri=crates%2Fruff_benchmark%2Fbenches%2Flinter.rs%3A%3Adefault_rules%3A%3Abenchmark_default_rules%3A%3Alinter%2Fdefault-rules%255Blarge%2Fdataset.py%255D&amp;runnerMode=Instrumentation&amp;sectionId=benchmark-comparison-section-comparison-passed">1% perf hit</a> when ungated on <code>large/dataset.py</code>, compared to <a href="https://codspeed.io/astral-sh/ruff/branches/amy%2Fperf-enable-suppressions?uri=crates%2Fruff_benchmark%2Fbenches%2Flinter.rs%3A%3Adefault_rules%3A%3Abenchmark_default_rules%3A%3Alinter%2Fdefault-rules%255Blarge%2Fdataset.py%255D&amp;runnerMode=Instrumentation&amp;sectionId=benchmark-comparison-section-comparison-passed">2% perf hit</a> without this PR when ungated on the same benchmark in #22461.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-09 19:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-09 19:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/suppression.rs</code>:402 on 2026-01-10 09:16</div>
            <div class="timeline-body"><p>We could avoid doing two binary search by introducing a <code>tokens.split_at(offset)</code> method:</p>
<pre><code>let (before_tokens, after_tokens) = tokens.split_at(suppression.range.start());

let last_indent = before_tokens.iter().rfind(...);
let tokens = after_tokens
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/suppression.rs</code>:399 on 2026-01-10 09:18</div>
            <div class="timeline-body"><p>I think we should clear indents after each iteration. We use it more as a scratch pad and we only use the same instance to avoid allocating multiple vecs`</p>
<pre><code>        &#x27;comments: while let Some(suppression) = suppressions.peek() {
        		indents.clear();
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/suppression.rs</code>:454 on 2026-01-10 09:39</div>
            <div class="timeline-body"><p>Nit: You could use let chains here</p>
<p>Change the tokens loop to:</p>
<pre><code>let mut tokens = tokens.after(suppression.range.start()).iter();
while let Some(token) = tokens.next() {
	...
</code></pre>
<pre><code>                        if indent == current_indent
                            &amp;&amp; let Some(non_trivia) = tokens.clone().find(|t| !t.kind().is_trivia())
                            &amp;&amp; matches!(non_trivia.kind(), TokenKind::Dedent | TokenKind::Indent)
</code></pre>
<p>Cloning <code>tokens</code> here is fine because cloning a slice iterator is cheap (it&#x27;s only two pointers, one pointing to the start and one to the end of the slice)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/preview.rs</code>:298 on 2026-01-10 09:39</div>
            <div class="timeline-body"><p>TODO: Revert</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2026-01-10 09:40</div>
            <div class="timeline-body"><p>Nice, thank you.</p>
<p>I think it&#x27;s worthwhile to introduce a <code>tokens.split_at</code> method to avoid repeating the same binary search twice only to get after and before</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-10 09:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-10 09:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> reviewed on 2026-01-13 23:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/suppression.rs</code>:402 on 2026-01-13 23:28</div>
            <div class="timeline-body"><p>I tried building <code>split_at</code> and using it when loading tokens, but somehow it changes the logic, and I&#x27;m not seeing why. Running the tests results in snapshot changes that implies leading comments before indents are no longer getting loaded/matched correct. But I also don&#x27;t fully understand how your logic here is working in this implementation, so I&#x27;m hoping I&#x27;m missing something. Any suggestion would be appreciated.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/suppression.rs</code>:425 on 2026-01-14 08:20</div>
            <div class="timeline-body"><p>Can we resolve this comment?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/suppression.rs</code>:449 on 2026-01-14 08:41</div>
            <div class="timeline-body"><p>You need to change this to <code>after</code>. The tests then pass</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2026-01-14 08:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2026-01-14 08:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/token/tokens.rs</code>:203 on 2026-01-14 08:42</div>
            <div class="timeline-body"><pre><code>        let (before, after) = self.raw.split_at(partition_point);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2026-01-14 08:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/token/tokens.rs</code>:195 on 2026-01-14 08:48</div>
            <div class="timeline-body"><p>I think it&#x27;s worth pointing out that <code>after</code> is different than calling <code>.after</code> (at least I think so).</p>
<p><strong><code>.after</code></strong></p>
<p>Finds the first token that ends after <code>offset</code></p>
<pre><code>           
| 1 |  | 2 |     | 3|
           - offset
                 ^^^^ .after
^^^^^ split_at before
       ^^^^^^^^^^^^^^ split_at after        
</code></pre>
<p>This is because <code>.after</code> finds the first token that ends after <code>offset</code> whereas <code>split_at</code> finds the first token that starts at or before <code>offset</code></p>
<p>We could change <code>split_at</code> to skip over tokens that fall directly on <code>offset</code> (e.g. a <code>Dedent</code> token with zero width). For now, I think it&#x27;s fine to call this difference out in the comment</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2026-01-14 11:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/suppression.rs</code>:402 on 2026-01-14 11:15</div>
            <div class="timeline-body"><blockquote>
<p>But I also don&#x27;t fully understand how your logic here is working in this implementation, so I&#x27;m hoping I&#x27;m missing something</p>
</blockquote>
<p>It&#x27;s not really any different from what you had in your implementation. The only difference is that it doesn&#x27;t start from the start of the file. Instead, it starts from the first comment and then looks back to find the last indent. After this, the behavior is the same to what you had. Process the remaining indents</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2026-01-14 11:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/suppression.rs</code>:472 on 2026-01-14 11:16</div>
            <div class="timeline-body"><p>I&#x27;m not sure if we should/could move this out of the loop</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> reviewed on 2026-01-14 23:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_python_ast/src/token/tokens.rs</code>:195 on 2026-01-14 23:56</div>
            <div class="timeline-body"><p>I don&#x27;t think that&#x27;s actually the case. I even added a test case that checks that the results from <code>split_at()</code> match what is returned from individual calls to both <code>before()</code> and <code>after()</code>.  <a href="https://github.com/astral-sh/ruff/pull/22446">astral-sh/ruff#22446</a>/changes/a457967e8f6f6ddf6907aba010fb5cbdaad0aa64#diff-22afd6bf6e8c02b1e9b264bd5f64b8937b237f2b34128576f559f2d70246b04eR574</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> reviewed on 2026-01-15 00:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/suppression.rs</code>:454 on 2026-01-15 00:48</div>
            <div class="timeline-body"><p>Switched to using <code>matches!()</code>, but I don&#x27;t think I can use the <code>if foo &amp;&amp; let ... &amp;&amp; matches!()</code> here because it actually needs to be <code>||</code> with the previous condition, and the compiler is complaining if I use <code>||</code> instead of <code>&amp;&amp;</code>, even with grouping parens.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/token/tokens.rs</code>:195 on 2026-01-15 09:44</div>
            <div class="timeline-body"><p>The issue are zero-length tokens like a dedent</p>
<pre><code>if A:
	pass

a
</code></pre>
<pre><code>    #[test]
    fn tokens_split_at_matches_before_and_after_zero_length() {
        let offset = TextSize::new(13);
        let tokens = new_tokens(
            [
                (TokenKind::If, 0..2),
                (TokenKind::Name, 3..4),
                (TokenKind::Colon, 4..5),
                (TokenKind::Newline, 5..6),
                (TokenKind::Indent, 6..7),
                (TokenKind::Pass, 7..11),
                (TokenKind::Newline, 11..12),
                (TokenKind::NonLogicalNewline, 12..13),
                (TokenKind::Dedent, 13..13),
                (TokenKind::Name, 13..14),
                (TokenKind::Newline, 14..14),
            ]
            .into_iter(),
        );
        let (before, after) = tokens.split_at(offset);
        assert_eq!(before, tokens.before(offset));
        assert_eq!(after, tokens.after(offset));
    }
</code></pre>
<p>This panics because <code>after</code> is different</p>
<pre><code>assertion `left == right` failed
  left: [Dedent 13..13, Name 13..14, Newline 14..14]
 right: [Name 13..14, Newline 14..14]
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
test token::tokens::tests::tokens_split_at_matches_before_and_after_zero_length ... FAILED
</code></pre>
<p>Note how <code>after</code> skips over the <code>Dedent</code> but <code>split_at</code> does not</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2026-01-15 09:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-15 20:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-15 20:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2026-01-15 20:35</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:22:47 UTC
    </footer>
</body>
</html>
