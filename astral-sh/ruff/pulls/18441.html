<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Fix missing registration of identifiers during semantic index construction - astral-sh/ruff #18441</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Fix missing registration of identifiers during semantic index construction</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18441">#18441</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2025-06-03 13:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-06-03 13:48</div>
            <div class="timeline-body"><p>Fixes astral-sh/ty#572</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @BurntSushi on 2025-06-03 13:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @BurntSushi on 2025-06-03 13:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @BurntSushi on 2025-06-03 13:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @BurntSushi on 2025-06-03 13:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @BurntSushi on 2025-06-03 13:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-06-03 13:48</div>
            <div class="timeline-body"><p>(This is kind of a wild guess on my part.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-03 13:51</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-06-03 13:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-03 14:07</div>
            <div class="timeline-body"><p>Could you say a bit more about what the cause of the panic is? Where are you using the <code>scopes_by_expression</code> map in the autocompletion logic?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-06-03 14:22</div>
            <div class="timeline-body"><p>It's this:</p>
<p>https://github.com/astral-sh/ruff/blob/f23d2c9b9e600cef08d6ed797cba4d335fe7772b/crates/ty_python_semantic/src/semantic_model.rs#L48-L67</p>
<p>Where the node given to that function is identified via:</p>
<p>https://github.com/astral-sh/ruff/blob/f23d2c9b9e600cef08d6ed797cba4d335fe7772b/crates/ty_ide/src/completion.rs#L31-L46</p>
<p>Basically, we're looking for the most constraining AST node, looking up that node's scope and then listing out the identifiers in that scope (and its parent scopes).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-03 14:36</div>
            <div class="timeline-body"><p>You also need to recurse into <code>match</code> statements -- this also causes the playground to panic for me:</p>
<pre><code class="language-py">match object():
    case fo&lt;CURSOR&gt;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-03 14:41</div>
            <div class="timeline-body"><p>This still causes a panic on your branch if I run the playground locally:</p>
<pre><code class="language-py">def f(x):&lt;CURSOR&gt;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-03 14:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/semantic_index/builder.rs</code>:1046 on 2025-06-03 14:50</div>
            <div class="timeline-body"><p>It feels a bit weird to be inserting <code>Identifier</code>s into this map, since <code>Identifier</code>s aren't really expressions. I wondered if we should be using a separate map entirely for completions logic, but that would probably be overkill. It could be worth adding a comment about why we do this, though.</p>
<p>I'm also slightly concerned that it's easy to forget to insert into this map if we're just manually adding the <code>self.record_scope_for_identifier()</code> calls into various branches. But I don't necessarily have a better suggestion</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-06-03 14:54</div>
            <div class="timeline-body"><blockquote>
<p>This still causes a panic on your branch if I run the playground locally:</p>
<pre><code class="language-python">def f(x):&lt;CURSOR&gt;
</code></pre>
</blockquote>
<p>Interesting! I can't reproduce this locally on this branch. It doesn't seem to panic on <code>main</code> either (when I run the LSP in vim).</p>
<blockquote>
<pre><code class="language-python">match object():
    case fo&lt;CURSOR&gt;
</code></pre>
</blockquote>
<p>Ah yeah I see the problem. There are some identifiers I missed in the match cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-03 14:56</div>
            <div class="timeline-body"><p>I've to think this through a bit more. The initial design of <code>ScopedExpressionId</code> was that they're indeed only for expressions and not for any other node. I need to look back at why we allowed some identifiers (that was probably me) and if it makes sense to allow all identifiers or if we need a different approach here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-06-03 14:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_python_semantic/src/semantic_index/builder.rs</code>:1046 on 2025-06-03 14:56</div>
            <div class="timeline-body"><p>Yeah I don't have a good sense of what is &quot;right&quot; to do here. I went this direction because it seems like the surrounding code already acknowledges an <code>Identifier</code> as something that can be addressed like an expression because of the <code>impl From&lt;&amp;ast::Identifier&gt; for ExpressionNodeKey</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-03 15:00</div>
            <div class="timeline-body"><blockquote>
<p>Interesting! I can't reproduce this locally on this branch. It doesn't seem to panic on <code>main</code> either (when I run the LSP in vim).</p>
</blockquote>
<p>This reproduces it very consistently for me on your branch:</p>
<p>https://github.com/user-attachments/assets/11fba3ac-ee3e-44dc-bd75-179e983236f3</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-03 15:17</div>
            <div class="timeline-body"><blockquote>
<p>This reproduces it very consistently for me on your branch</p>
</blockquote>
<p>Do parameter nodes have identifier nodes inside them? It only repros for me if it's a function with parameters</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-03 15:24</div>
            <div class="timeline-body"><p>Looking at the change history, enabling <code>scoped_expression_id</code> for <code>Identifier</code> was probably an unintentional change. It was made 2 months ago to allow recording uses on Identifiers.</p>
<p>Recording the scopes for more nodes does seem reasonable to me if we have use cases beyond just expressions. But we should then rename <code>ExpressionNodeKey</code>, <code>ScopedExpressionId</code>, and the relevant methods. Although it's not clear ot me what a good name would be for this.</p>
<p>The alternative is that we change the <code>completions</code> code to use a different mechanism to get the scope. E.g. to walk further up the tree until it finds an <code>ExprName</code> or <code>ClassDef</code> or <code>FunctionDef</code>, similar to what's done in hover. This is more work but has the advantage that we don't need to track more data (especially because most identifiers are redundant to <code>ExprName</code>). https://github.com/astral-sh/ruff/blob/67d94d9ec8f3d369af2e2acd8942978ea5c869d1/crates/ty_ide/src/goto.rs#L205-L251</p>
<p>Related: https://github.com/astral-sh/ty/issues/144</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-06-03 15:44</div>
            <div class="timeline-body"><blockquote>
<p>The alternative is that we change the <code>completions</code> code to use a different mechanism to get the scope. E.g. to walk further up the tree until it finds an <code>ExprName</code> or <code>ClassDef</code> or <code>FunctionDef</code>, similar to what's done in hover. This is more work but has the advantage that we don't need to track more data (especially because most identifiers are redundant to <code>ExprName</code>).</p>
</blockquote>
<p>All righty. I'll put in a pin in this PR for now until I have a chance to work on improving target detection. I guess if we can side-step this issue entirely, then it probably makes sense to avoid storing identifiers.</p>
<p>If we end up abdicating this PR, then I can submit another one beefing up the docs on the existing methods. Particularly their panic conditions. :-) When I used this method, I falsely assumed that <em>any</em> expression in the <code>File</code> given to build the semantic index would be a valid key.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-06-03 15:54</div>
            <div class="timeline-body"><blockquote>
<p>Looking at the change history, enabling <code>scoped_expression_id</code> for <code>Identifier</code> was probably an unintentional change. It was made 2 months ago to allow recording uses on Identifiers.</p>
</blockquote>
<p>Yes, this was done by me (in https://github.com/astral-sh/ruff/pull/17366) to allow recording a use on identifiers which is how the overload implementation is being done. The main reason is that the function name is stored as <code>Identifier</code> and that is used to find the previous definition of the same function to create the overload &quot;link&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-03 16:15</div>
            <div class="timeline-body"><p>Sounds good to me and thanks for jumping on this. It might be good to have a &quot;fix&quot; for now because it seems very easy to trigger this bug in the LSP (which results in a crash).</p>
<p>A short term fix could be to add a <code>try_scoped_expression_id</code> method that returns <code>Option</code>. That gives us some time to explore the next steps without regressing the completion feature.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @AlexWaygood on 2025-06-03 22:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2026-01-05 14:24</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:30:52 UTC
    </footer>
</body>
</html>
