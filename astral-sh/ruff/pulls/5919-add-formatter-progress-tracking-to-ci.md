```yaml
number: 5919
title: Add formatter progress tracking to CI
type: pull_request
state: merged
author: konstin
labels: []
assignees: []
merged: true
base: main
head: add_format_testing_script
created_at: 2023-07-20T13:28:13Z
updated_at: 2023-07-24T09:34:34Z
url: https://github.com/astral-sh/ruff/pull/5919
synced_at: 2026-01-12T15:55:19Z
```

# Add formatter progress tracking to CI

---

_@konstin_

**Summary** Add a formatter progress testing script to CI. This script will 1) print the black compability on each run 2) catch regressions wrt to formatter stability, emitting invalid syntax and other kinds of bugs (e.g. #5917) before they land on main 3) have an additional layer of real world tests when implementing new nodes or other new formatter code.

This is currently a bash script, i'm not sure if we want to keep it that way, or switch to e.g. the regular ecosystem scripts. The output separation of `format_dev` could also use some polishing. We should also consider pinning commits so we don't get spurious regression when they change their code.

**Test Plan** The script extends CI.


---

_Comment by @konstin on 2023-07-20 13:28_

Current dependencies on/for this PR:
* main
  * **PR #5919** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5919" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/5919?utm_source=stack-comment).

---

_Comment by @github-actions[bot] on 2023-07-20 13:53_

## PR Check Results
### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     10.8Â±0.24ms     3.8 MB/sec    1.03     11.2Â±0.49ms     3.6 MB/sec
formatter/numpy/ctypeslib.py               1.02      2.2Â±0.15ms     7.5 MB/sec    1.00      2.2Â±0.08ms     7.6 MB/sec
formatter/numpy/globals.py                 1.00   255.2Â±14.15Âµs    11.6 MB/sec    1.00   255.2Â±15.23Âµs    11.6 MB/sec
formatter/pydantic/types.py                1.00      4.7Â±0.12ms     5.4 MB/sec    1.04      4.9Â±0.23ms     5.2 MB/sec
linter/all-rules/large/dataset.py          1.00     16.0Â±0.30ms     2.5 MB/sec    1.00     16.0Â±0.32ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      4.0Â±0.11ms     4.1 MB/sec    1.00      4.0Â±0.10ms     4.2 MB/sec
linter/all-rules/numpy/globals.py          1.01   540.5Â±20.84Âµs     5.5 MB/sec    1.00   537.3Â±23.58Âµs     5.5 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.3Â±0.25ms     3.5 MB/sec    1.00      7.3Â±0.26ms     3.5 MB/sec
linter/default-rules/large/dataset.py      1.03      8.3Â±0.25ms     4.9 MB/sec    1.00      8.1Â±0.14ms     5.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.02  1756.3Â±48.37Âµs     9.5 MB/sec    1.00  1724.1Â±46.89Âµs     9.7 MB/sec
linter/default-rules/numpy/globals.py      1.03    207.2Â±7.33Âµs    14.2 MB/sec    1.00    200.5Â±8.05Âµs    14.7 MB/sec
linter/default-rules/pydantic/types.py     1.02      3.7Â±0.16ms     6.9 MB/sec    1.00      3.7Â±0.06ms     7.0 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.03     13.6Â±0.45ms     3.0 MB/sec    1.00     13.2Â±0.41ms     3.1 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.6Â±0.10ms     6.3 MB/sec    1.06      2.8Â±0.25ms     6.0 MB/sec
formatter/numpy/globals.py                 1.02   296.8Â±12.56Âµs     9.9 MB/sec    1.00   289.9Â±16.22Âµs    10.2 MB/sec
formatter/pydantic/types.py                1.00      5.9Â±0.29ms     4.3 MB/sec    1.03      6.1Â±0.55ms     4.2 MB/sec
linter/all-rules/large/dataset.py          1.01     18.8Â±0.49ms     2.2 MB/sec    1.00     18.6Â±0.62ms     2.2 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      5.0Â±0.19ms     3.3 MB/sec    1.00      5.0Â±0.21ms     3.3 MB/sec
linter/all-rules/numpy/globals.py          1.00   583.6Â±26.43Âµs     5.1 MB/sec    1.02   597.0Â±51.20Âµs     4.9 MB/sec
linter/all-rules/pydantic/types.py         1.01      8.6Â±0.25ms     3.0 MB/sec    1.00      8.5Â±0.27ms     3.0 MB/sec
linter/default-rules/large/dataset.py      1.00      9.8Â±0.29ms     4.2 MB/sec    1.00      9.8Â±0.26ms     4.2 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01      2.0Â±0.09ms     8.2 MB/sec    1.00      2.0Â±0.07ms     8.3 MB/sec
linter/default-rules/numpy/globals.py      1.02   238.2Â±13.29Âµs    12.4 MB/sec    1.00   233.8Â±10.81Âµs    12.6 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.4Â±0.23ms     5.8 MB/sec    1.00      4.4Â±0.14ms     5.9 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_@zanieb reviewed on 2023-07-20 16:43_

---

_Review comment by @zanieb on `scripts/formatter_progress.sh`:22 on 2023-07-20 16:43_

```suggestion
for i in "$dir"/*/; do echo "# $(basename "$i") $(git -C "$i" rev-parse HEAD)"; done
```

---

_@zanieb reviewed on 2023-07-20 16:44_

---

_Review comment by @zanieb on `scripts/formatter_progress.sh`:1 on 2023-07-20 16:44_

```suggestion
#!/usr/bin/env bash
```

---

_Comment by @konstin on 2023-07-23 13:57_

I think the main question remaining for me is: Should we pin the repos to a specific commit?

pro: the score may otherwise change due to downstream changes unrelated to out ours
pro: correct PRs may break if they add changes that break our formatter
con: we won't see any new python syntax with an old commit pinned
con: we won't see any black updates with an old commit pinned 

Effectively, i want lockfiles and dependabot for this, but that doesn't exist, so we'll have to go with either option

---

_Comment by @konstin on 2023-07-23 13:59_

the result is now posted as github step summary (https://github.com/astral-sh/ruff/actions/runs/5636816309?pr=5919#summary-15269270283):

![image](https://github.com/astral-sh/ruff/assets/6826232/d7be595c-5cc7-49d8-b99c-33ca3c4cce0f)

i wish i could show that without switching to the CI tab and scrolling down, but it's still good to have this in CI either way

---

_Marked ready for review by @konstin on 2023-07-23 13:59_

---

_Comment by @MichaReiser on 2023-07-24 07:36_

> I think the main question remaining for me is: Should we pin the repos to a specific commit?


I'm leaning toward pinning:

* Updating is low effort. We can do this every week
* It is otherwise unclear if the similarity index improve because of my changes or because of changes in the tested repositories
* Having all formatter PRs blocked by a new stability issue would be unfortunate. It also reduces trust in the check because there's always the chance that your change didn't introduce the instability.

> the result is now posted as github step summary ([astral-sh/ruff/actions/runs/5636816309?pr=5919#summary-15269270283](https://github.com/astral-sh/ruff/actions/runs/5636816309?pr=5919#summary-15269270283)):

Nice: A future improvement could be integrating it into the same job that also posts the benchmark and ecosystem results

---

_Review comment by @MichaReiser on `.github/workflows/ci.yaml`:326 on 2023-07-24 07:37_

Before merge: Revert

---

_Review comment by @MichaReiser on `.github/workflows/ci.yaml`:323 on 2023-07-24 07:37_

Nit: Rename, considering that it now checks more than just the progress.

---

_Review comment by @MichaReiser on `scripts/formatter_progress.sh`:28 on 2023-07-24 07:38_

What's this?

---

_Review comment by @MichaReiser on `scripts/formatter_progress.sh`:47 on 2023-07-24 07:39_

Nit: An alternative to grepping could have been to add a `--markdown` flag to the CLI that enables a markdown rendered summary

---

_@MichaReiser approved on 2023-07-24 07:39_

---

_Merged by @konstin on 2023-07-24 09:12_

---

_Closed by @konstin on 2023-07-24 09:12_

---

_Branch deleted on 2023-07-24 09:12_

---
