<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Formatter: Show preceding, following and enclosing nodes of comments, Attempt 2 - astral-sh/ruff #6813</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Formatter: Show preceding, following and enclosing nodes of comments, Attempt 2</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6813">#6813</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2023-08-23 11:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/konstin">@konstin</a> on 2023-08-23 11:54</div>
            <div class="timeline-body"><p>This is a new attempt after https://github.com/astral-sh/ruff/pull/6337.</p>
<p><strong>Summary</strong> I used to always add <code>dbg!</code> for the preceding, following and enclosing node. With this change <code>--print-comments</code> can do this instead.</p>
<pre><code class="language-python">match foo: # a
    # b
    case [1, 2, * # c
    rest]:
        pass
    # d
    case [1, 2, * #e
    _]:
        pass
    case [
        1,
        2,
        *rest,
    ]:
        pass
</code></pre>
<p>Additional <code>--print-comments</code> Output:</p>
<pre><code>11..14 Some((ExprName, 6..9)) Some((MatchCase, 27..68)) (StmtMatch, 0..186) &quot;# a&quot;
19..22 Some((ExprName, 6..9)) Some((MatchCase, 27..68)) (StmtMatch, 0..186) &quot;# b&quot;
41..44 None None (PatternMatchStar, 39..53) &quot;# c&quot;
73..76 Some((MatchCase, 27..68)) Some((MatchCase, 81..118)) (StmtMatch, 0..186) &quot;# d&quot;
95..97 None None (PatternMatchStar, 93..103) &quot;#e&quot;
</code></pre>
<p><strong>Test Plan</strong> n/a</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @konstin on 2023-08-23 11:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @konstin on 2023-08-23 11:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/comments/visitor.rs</code>:546 on 2023-08-23 11:54</div>
            <div class="timeline-body"><p>i didn't find a better location for this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-08-23 11:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-08-23 11:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/comments/visitor.rs</code>:46 on 2023-08-23 11:55</div>
            <div class="timeline-body"><p>side effect: the visitor is now private</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-08-23 12:24</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      3.5±0.03ms    11.7 MB/sec    1.04      3.6±0.08ms    11.3 MB/sec
formatter/numpy/ctypeslib.py               1.00   709.8±12.54µs    23.5 MB/sec    1.02    724.8±6.08µs    23.0 MB/sec
formatter/numpy/globals.py                 1.00     73.2±0.35µs    40.3 MB/sec    1.02     75.0±0.31µs    39.3 MB/sec
formatter/pydantic/types.py                1.00  1411.3±12.13µs    18.1 MB/sec    1.02  1445.5±31.14µs    17.6 MB/sec
linter/all-rules/large/dataset.py          1.00     10.4±0.05ms     3.9 MB/sec    1.01     10.5±0.05ms     3.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      2.8±0.01ms     5.9 MB/sec    1.01      2.8±0.01ms     5.8 MB/sec
linter/all-rules/numpy/globals.py          1.00    316.4±2.06µs     9.3 MB/sec    1.01    319.9±1.74µs     9.2 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.4±0.01ms     4.7 MB/sec    1.01      5.4±0.03ms     4.7 MB/sec
linter/default-rules/large/dataset.py      1.00      5.5±0.01ms     7.4 MB/sec    1.01      5.6±0.03ms     7.3 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1178.4±5.08µs    14.1 MB/sec    1.00   1180.5±5.85µs    14.1 MB/sec
linter/default-rules/numpy/globals.py      1.00    122.9±0.26µs    24.0 MB/sec    1.01    124.3±0.68µs    23.7 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.5±0.01ms    10.2 MB/sec    1.01      2.5±0.01ms    10.1 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      4.1±0.05ms     9.9 MB/sec    1.04      4.3±0.06ms     9.6 MB/sec
formatter/numpy/ctypeslib.py               1.00   820.5±11.22µs    20.3 MB/sec    1.04   850.1±13.68µs    19.6 MB/sec
formatter/numpy/globals.py                 1.00     84.5±2.55µs    34.9 MB/sec    1.06     89.5±2.10µs    33.0 MB/sec
formatter/pydantic/types.py                1.00  1654.3±23.05µs    15.4 MB/sec    1.04  1716.0±30.96µs    14.9 MB/sec
linter/all-rules/large/dataset.py          1.00     12.4±0.11ms     3.3 MB/sec    1.03     12.7±0.17ms     3.2 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.4±0.03ms     4.9 MB/sec    1.01      3.5±0.03ms     4.8 MB/sec
linter/all-rules/numpy/globals.py          1.00   431.5±14.23µs     6.8 MB/sec    1.00    432.2±6.59µs     6.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.5±0.12ms     3.9 MB/sec    1.01      6.6±0.08ms     3.9 MB/sec
linter/default-rules/large/dataset.py      1.00      6.9±0.06ms     5.9 MB/sec    1.02      7.0±0.06ms     5.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1474.9±18.64µs    11.3 MB/sec    1.01  1495.5±20.41µs    11.1 MB/sec
linter/default-rules/numpy/globals.py      1.00    172.5±2.74µs    17.1 MB/sec    1.01    175.0±2.65µs    16.9 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.1±0.03ms     8.2 MB/sec    1.02      3.2±0.04ms     8.0 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-23 12:45</div>
            <div class="timeline-body"><p>Can you run some local benchmarks to confirm/deny the performance regression?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-26 16:07</div>
            <div class="timeline-body"><p>Should we just use <code>debug!</code> or something similar to print out the comments during debugging? We could even gate it with <code>cfg(debug_assertions)</code> to make sure it doesn't make it into production builds.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-08-26 16:08</div>
            <div class="timeline-body"><p>you mean through tracing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2023-08-26 16:12</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/collect_decorated_comments2">CodSpeed Performance Report</a></h2>
<h3>Merging #6813 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>collect_decorated_comments2</code> (b153208) with <code>main</code> (15b73bd)</sub></p>
<h3>Summary</h3>
<p><code>✅ 16</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/mod.rs</code>:346 on 2023-09-06 07:38</div>
            <div class="timeline-body"><p>This method feels misplaced because it doesn't involve <code>Comments</code> at all. Why not expose <code>collect_comments</code> directly?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/visitor.rs</code>:29 on 2023-09-06 07:41</div>
            <div class="timeline-body"><p>Nit: I'm leaning towards inlining this function into <code>Comments::from_ast</code> because <code>get_comments_map</code> sounds like your getting a value rather than computing it. Maybe rename it to <code>build_comments_map</code>? IMO, <code>CommentsVisitor</code> and <code>CommentsBuilder</code> being visible to the comments module seems reasonable to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/visitor.rs</code>:532 on 2023-09-06 07:48</div>
            <div class="timeline-body"><p>It's uncommon to include the type-kind in the name, especially because only the <code>CommentsBuilder</code> is building <code>Comments</code>.</p>
<p>A rusty name could be <code>AddComment</code>, or we use <code>Add&lt;DecoratedComment&gt;</code> and make <code>locator</code> a field on <code>CommentsBuilder</code>.</p>
<p>Or another idea is to accept any type that implements <code>Extend</code>. The downside is that we'll have to pass <code>[comment]</code> because <code>extend_one</code> isn't stable. But I think that resembles the idea the closest. You get a comment and can append it to some data structure. Which also removes the need for <code>CommentsCollector</code> because you can simply pass a <code>&amp;mut Vec</code>.</p>
<p>I think I'm then leaning to making <code>collect_comments</code> public and make it accept any <code>&amp;dyn Extend&lt;DecoratedComment&lt;'a&gt;&gt;</code> and to make  <code>CommentsBuilder</code> pub(super)`.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-09-06 07:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-06 09:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/comments/visitor.rs</code>:532 on 2023-09-06 09:27</div>
            <div class="timeline-body"><p>I went with <code>PushComment::push_comment</code>, mirroring <code>Vec</code>. A possible improvement could be implementing <code>PushComment</code> directly on <code>CommentsMap&lt;'a&gt;</code> and <code>Vec&lt;DecoratedComment&lt;'a&gt;&gt;</code>. I think we do need a dedicated trait though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-06 09:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/visitor.rs</code>:532 on 2023-09-06 09:46</div>
            <div class="timeline-body"><p>I don't mind implementing it directly on <code>Vec&lt;DecoratedComment&gt;</code> but I think I would keep the builder around since we don't want adding the <code>Locator</code> to <code>CommentsMap</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @konstin on 2023-09-06 10:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2023-09-06 10:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-09-06 10:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-06 10:55</div>
            <div class="timeline-body"><p>One thing I forgot to mention before. I struggle reading the output of the new comment because it isn't clear to me which node is the enclosing, trailing, or leading node. I think it would help to have labels and/or use Rust's expanded struct display</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 02:46:15 UTC
    </footer>
</body>
</html>
