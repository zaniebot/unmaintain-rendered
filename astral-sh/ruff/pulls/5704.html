<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use permalinks in ecosystem diff references - astral-sh/ruff #5704</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use permalinks in ecosystem diff references</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5704">#5704</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2023-07-12 05:02
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body">Summary


<p>Closes <a href="https://github.com/astral-sh/ruff/issues/5702">astral-sh/ruff#5702</a></p>
<p>cc @dhruvmanila as I see you assigned yourself to the issue</p>
Test Plan


<p>Ran locally e.g.</p>
<p><code>&lt;a href=&#x27;https://github.com/zulip/zulip/blob/fcede324202ac5bc3de0691d2d6e168d0f18c120/zproject/prod_settings_template.py#L144&#x27;&gt;zproject/prod_settings_template.py:144:26:&lt;/a&gt;</code></p>
<p>Should succeed in CI as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>scripts/check_ecosystem.py</code>:95 on 2023-07-12 05:06</div>
            <div class="timeline-body"><p>nit</p>
<pre><code>            *[&quot;git&quot;, &quot;rev-parse&quot;, &quot;HEAD&quot;],
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-12 05:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>scripts/check_ecosystem.py</code>:48 on 2023-07-12 05:06</div>
            <div class="timeline-body"><p>So... because <code>Repository</code> is immutable (and I liked that it was immutable) we can&#x27;t just get the commit SHA on clone and stash it on the <code>Repository</code> object. Instead, we yield it and it&#x27;s attached to the <code>Diff</code> object for later display. It also turns out that the previously yielded <code>Path</code> was identical to the input argument so I removed that.</p>
<p>We probably ought to just have the ecosystem checks pinned to a specific SHA that&#x27;s updated on a schedule by a bot and then we can skip the retrieval and just assign it to the <code>Repository</code> at creation time. That seems pretty low priority though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-12 05:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>scripts/check_ecosystem.py</code>:73 on 2023-07-12 05:07</div>
            <div class="timeline-body"><p>I renamed these before extracting <code>_get_commit</code> into a separate function. I don&#x27;t think the extra clarity hurts though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/zanieb">@zanieb</a> on 2023-07-12 05:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dhruvmanila">@dhruvmanila</a> by <a href="https://github.com/zanieb">@zanieb</a> on 2023-07-12 05:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-12 05:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>scripts/check_ecosystem.py</code>:48 on 2023-07-12 05:11</div>
            <div class="timeline-body"><p>Also happy to hear alternative approaches if anyone has ideas! This seemed liked the simplest way to retain immutability but this was my first time looking at this script.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>scripts/check_ecosystem.py</code>:48 on 2023-07-12 05:11</div>
            <div class="timeline-body"><p>Can we add the commit SHA to the <code>Repository</code> object as that&#x27;s where I think it should be logically? I think adding it to <code>ref</code> should be the same meaning as branches are just pointers to specific commits.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-07-12 05:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>scripts/check_ecosystem.py</code>:48 on 2023-07-12 05:13</div>
            <div class="timeline-body"><p>This will also mean that the <code>repo.url_for</code> function/call need not be changed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-07-12 05:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-12 05:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>scripts/check_ecosystem.py</code>:48 on 2023-07-12 05:15</div>
            <div class="timeline-body"><p>I tried that first but we cannot because it&#x27;s immutable. We definitely could decide to make it <em>mutable</em>, but I liked the immutable design. More commentary at <a href="https://github.com/astral-sh/ruff/pull/5704">astral-sh/ruff#5704</a>#discussion_r1260592025</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>scripts/check_ecosystem.py</code>:95 on 2023-07-12 05:16</div>
            <div class="timeline-body"><p>Interestingly this worked locally but failed with <code>ambiguous argument &#x27;head&#x27;: unknown revision or path not in the working tree</code> in CI â€” curious to see if this changes anything but I doubt it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-12 05:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-07-12 05:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>scripts/check_ecosystem.py</code>:48 on 2023-07-12 05:16</div>
            <div class="timeline-body"><p>Oh, I missed that comment. Give me a minute.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-12 05:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>scripts/check_ecosystem.py</code>:87 on 2023-07-12 05:19</div>
            <div class="timeline-body"><p>idk how this got formatted like this but will fix -.-</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-12 05:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>scripts/check_ecosystem.py</code>:95 on 2023-07-12 05:21</div>
            <div class="timeline-body"><p>Failure at https://github.com/astral-sh/ruff/actions/runs/5527736701/jobs/10083885033</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-07-12 05:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>scripts/check_ecosystem.py</code>:48 on 2023-07-12 05:24</div>
            <div class="timeline-body"><p>We could <a href="https://docs.python.org/3/library/collections.html#collections.somenamedtuple._replace">replace</a> the value:</p>
<pre><code>self._replace(ref=await self._get_commit(checkout_dir))
</code></pre>
<p>But, otherwise I think this is fine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2023-07-12 05:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-07-12 05:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>scripts/check_ecosystem.py</code>:95 on 2023-07-12 05:29</div>
            <div class="timeline-body"><p>Interesting! https://stackoverflow.com/a/56346962</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>scripts/check_ecosystem.py</code>:48 on 2023-07-12 05:29</div>
            <div class="timeline-body"><p>I&#x27;m not sure how we&#x27;d get the new <code>Repository</code> object back to the relevant owner without a bunch of changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-12 05:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-07-12 05:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>scripts/check_ecosystem.py</code>:48 on 2023-07-12 05:32</div>
            <div class="timeline-body"><p>Ah yeah, didn&#x27;t think about that (<code>_replace</code> returns a new object). I think this is fine then. We can iterate it later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>scripts/check_ecosystem.py</code>:89 on 2023-07-12 05:33</div>
            <div class="timeline-body"><pre><code>        url = (
            f&quot;https://github.com/{self.org}/{self.repo}&quot;
            f&quot;/blob/{commit_sha}/{path}&quot;
        )
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-07-12 05:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>scripts/check_ecosystem.py</code>:95 on 2023-07-12 05:36</div>
            <div class="timeline-body"><p>That resolved it :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-12 05:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-07-12 05:38</div>
            <div class="timeline-body"><p>Oh shoot! Sorry, I fixed the wrong long line :p</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-07-12 05:39</div>
            <div class="timeline-body"><p>No problem :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>scripts/check_ecosystem.py</code>:96 on 2023-07-12 05:49</div>
            <div class="timeline-body"><p>you can use <code>subprocess.check_output</code> with <code>text=True</code> here, it will also check the output status automatically</p>
<p>https://github.com/astral-sh/ruff/blob/0666added9902990b6ea22d1a48f6fa1ae5ea605/scripts/update_schemastore.py#L18</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-07-12 05:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-07-12 05:49</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>âœ… ecosystem check detected no changes.</p>
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.02      8.0Â±0.04ms     5.1 MB/sec    1.00      7.9Â±0.01ms     5.2 MB/sec
formatter/numpy/ctypeslib.py               1.01   1874.2Â±4.39Âµs     8.9 MB/sec    1.00   1857.7Â±3.28Âµs     9.0 MB/sec
formatter/numpy/globals.py                 1.01    208.7Â±0.42Âµs    14.1 MB/sec    1.00    207.3Â±0.52Âµs    14.2 MB/sec
formatter/pydantic/types.py                1.03      4.1Â±0.02ms     6.3 MB/sec    1.00      4.0Â±0.03ms     6.4 MB/sec
linter/all-rules/large/dataset.py          1.01     13.7Â±0.17ms     3.0 MB/sec    1.00     13.6Â±0.24ms     3.0 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.4Â±0.02ms     4.9 MB/sec    1.00      3.4Â±0.04ms     4.9 MB/sec
linter/all-rules/numpy/globals.py          1.01    433.1Â±0.94Âµs     6.8 MB/sec    1.00    429.4Â±3.15Âµs     6.9 MB/sec
linter/all-rules/pydantic/types.py         1.01      6.1Â±0.08ms     4.2 MB/sec    1.00      6.0Â±0.09ms     4.2 MB/sec
linter/default-rules/large/dataset.py      1.01      6.8Â±0.04ms     6.0 MB/sec    1.00      6.7Â±0.07ms     6.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01   1473.1Â±2.64Âµs    11.3 MB/sec    1.00   1457.8Â±2.44Âµs    11.4 MB/sec
linter/default-rules/numpy/globals.py      1.02    168.6Â±0.25Âµs    17.5 MB/sec    1.00    164.7Â±0.26Âµs    17.9 MB/sec
linter/default-rules/pydantic/types.py     1.02      3.1Â±0.04ms     8.3 MB/sec    1.00      3.0Â±0.01ms     8.4 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     12.5Â±0.74ms     3.2 MB/sec    1.01     12.7Â±0.56ms     3.2 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.8Â±0.16ms     5.8 MB/sec    1.00      2.8Â±0.19ms     5.9 MB/sec
formatter/numpy/globals.py                 1.00   322.7Â±27.64Âµs     9.1 MB/sec    1.02   328.1Â±25.67Âµs     9.0 MB/sec
formatter/pydantic/types.py                1.00      6.4Â±0.42ms     4.0 MB/sec    1.00      6.3Â±0.40ms     4.0 MB/sec
linter/all-rules/large/dataset.py          1.00     21.7Â±1.01ms  1918.4 KB/sec    1.03     22.3Â±0.91ms  1865.5 KB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      5.7Â±0.28ms     2.9 MB/sec    1.00      5.6Â±0.32ms     3.0 MB/sec
linter/all-rules/numpy/globals.py          1.00   672.7Â±51.92Âµs     4.4 MB/sec    1.01   679.1Â±42.70Âµs     4.3 MB/sec
linter/all-rules/pydantic/types.py         1.03     10.0Â±0.57ms     2.6 MB/sec    1.00      9.7Â±0.46ms     2.6 MB/sec
linter/default-rules/large/dataset.py      1.00     10.9Â±0.57ms     3.7 MB/sec    1.00     10.9Â±0.62ms     3.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.02      2.4Â±0.27ms     7.1 MB/sec    1.00      2.3Â±0.34ms     7.2 MB/sec
linter/default-rules/numpy/globals.py      1.00   270.8Â±19.50Âµs    10.9 MB/sec    1.01   274.8Â±20.89Âµs    10.7 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.9Â±0.29ms     5.2 MB/sec    1.02      5.0Â±0.28ms     5.1 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>scripts/check_ecosystem.py</code>:96 on 2023-07-12 05:54</div>
            <div class="timeline-body"><p>Hm I&#x27;d rather not make a blocking call in an async function though ðŸ‘¿</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-12 05:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/zanieb">@zanieb</a> on 2023-07-12 06:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/zanieb">@zanieb</a> on 2023-07-12 06:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-07-12 06:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>scripts/check_ecosystem.py</code>:96 on 2023-07-12 07:04</div>
            <div class="timeline-body"><p>fair</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-07-12 07:05</div>
            <div class="timeline-body"></div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:55:15 UTC
    </footer>
</body>
</html>
