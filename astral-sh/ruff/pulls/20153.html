<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Retry parameter matching for argument type expansion - astral-sh/ruff #20153</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Retry parameter matching for argument type expansion</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20153">#20153</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2025-08-29 14:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR addresses an issue for a variadic argument when involved in argument type expansion of overload call evaluation.</p>
<p>The issue is that the expansion of the variadic argument could result in argument list of different arity. For example, in <code>*args: tuple[int] | tuple[int, str]</code>, the expansion would lead to the variadic argument being unpacked into 1 and 2 element respectively. This means that the parameter matching that was performed initially isn't sufficient and each expanded argument list would need to redo the parameter matching again.</p>
<p>This is currently done by redoing the parameter matching directly, maintaining the state of argument forms (and the conflicting forms), and updating the <code>Bindings</code> values if it changes.</p>
<p>Closes: astral-sh/ty#735</p>
<h2>Test Plan</h2>
<p>Update existing mdtest.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @dhruvmanila on 2025-08-29 14:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-01 09:47</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-01 09:50</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[ty] [WIP] Retry parameter matching for argument type expansion" to "[ty] Retry parameter matching for argument type expansion" by @dhruvmanila on 2025-09-02 16:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dhruvmanila on 2025-09-02 16:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dhruvmanila on 2025-09-02 16:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dhruvmanila on 2025-09-02 16:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @dhruvmanila on 2025-09-02 16:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @dhruvmanila on 2025-09-02 16:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-09-02 16:13</div>
            <div class="timeline-body"><p>(This isn't completely ready but I'd appreciate some initial feedback on the approach.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/call/arguments.rs</code>:218 on 2025-09-03 02:08</div>
            <div class="timeline-body"><p>:+1: Yep this looks like a good approach! It should pull out the more precise length of each union element during expansion</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/call/bind.rs</code>:1915 on 2025-09-03 02:08</div>
            <div class="timeline-body"><p>I like the cleanup from introducing this new type, too</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/call/bind.rs</code>:1412 on 2025-09-03 02:09</div>
            <div class="timeline-body"><p>:100:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-09-03 02:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-09-03 02:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/call/bind.rs</code>:1412 on 2025-09-03 02:28</div>
            <div class="timeline-body"><p>I don't know if we need to reflect this in our comments, but I think the spec is not wrong here -- the difference is that in the spec &quot;step 1&quot; means only &quot;eliminate impossible overloads due to arity mismatch&quot; whereas our step 1 is bigger than that, it also includes &quot;match arguments to parameters&quot;, which in the spec is implicitly part of step 2, not part of step 1. This is why we need to &quot;repeat step 1&quot; and the spec does not. It may be clearer to say that we don't separate step 1 and 2 in the same way the spec does.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-09-03 03:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_python_semantic/src/types/call/bind.rs</code>:1412 on 2025-09-03 03:27</div>
            <div class="timeline-body"><p>That's a good point, I didn't realize this subtle difference, I'll update the comment to reflect this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-09-04 07:47</div>
            <div class="timeline-body"><blockquote>
<pre><code class="language-diff">openlibrary (https://github.com/internetarchive/openlibrary)
+ openlibrary/coverstore/archive.py:422:13: error[no-matching-overload] No overload of function `__new__` matches arguments
- Found 711 diagnostics
+ Found 712 diagnostics
</code></pre>
</blockquote>
<p>I'm not exactly sure what's wrong here. I've created a playground snippet which breaks the union into it's elements which is what the type expansion would retry with (https://play.ty.dev/1990e010-195f-4800-9e31-b77894e37dd3). It's only the <code>c</code> variable which has a fixed length of 2 because the outermost type is a <code>tuple</code> containing two elements.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @dhruvmanila on 2025-09-04 15:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-09-08 21:10</div>
            <div class="timeline-body"><p>@dcreager I'm assuming this is in your review queue unless you request review from me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @carljm on 2025-09-08 21:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @sharkdp on 2025-09-10 07:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/call/bind.rs</code>:2313 on 2025-09-11 13:50</div>
            <div class="timeline-body"><p>:heart: Love that we can get rid of this workaround!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/tuple.rs</code>:1019 on 2025-09-11 13:53</div>
            <div class="timeline-body"><p>I don't think there's anything we're using this for anymore, now that we're no longer special-casing <code>__add__</code> for tuples (#19636). So I'd say we can go ahead and remove it; we can always resurrect it from the git history if we need to.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/call/bind.rs</code>:112 on 2025-09-11 13:56</div>
            <div class="timeline-body"><p>You might consider storing the new <code>ArgumentForms</code> in <code>Bindings</code> instead of separating it out into two separate slices. That way it would be stored consistently throughout this file. That might require adding an accessor method for external callers to get access to the <code>argument_forms</code>. And you'd replace <code>ArgumentForms::into_boxed_slice</code> with <code>ArgumentForms::shrink_to_fit</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> approved on 2025-09-11 13:57</div>
            <div class="timeline-body"><p>This is great, thank you for tackling this!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_python_semantic/src/types/call/bind.rs</code>:112 on 2025-09-12 08:31</div>
            <div class="timeline-body"><p>That sounds reasonable, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-09-12 08:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2025-09-12 08:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2025-09-12 08:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-09-12 08:40</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:15:24 UTC
    </footer>
</body>
</html>
