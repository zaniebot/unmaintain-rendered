<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-type-checking`] Skip quoting annotation if it becomes invalid syntax (`TCH001`) - astral-sh/ruff #14285</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-type-checking</code>] Skip quoting annotation if it becomes invalid syntax (<code>TCH001</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14285">#14285</a>
        opened by <a href="https://github.com/Glyphack">@Glyphack</a>
        on 2024-11-11 18:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Glyphack">@Glyphack</a></div>
            <div class="timeline-body"><p>Fix: #13934</p>
<h2>Summary</h2>
<p>Current implementation has a bug when the current annotation contains a string with single and double quotes.</p>
<p>TL;DR: I think these cases happen less than other use cases of Literal. So instead of fixing them we skip the fix in those cases.</p>
<p>One of the problematic cases:</p>
<pre><code>from typing import Literal
from third_party import Type

def error(self, type1: Type[Literal[&quot;'&quot;]]):
    pass
</code></pre>
<p>The outcome is:</p>
<pre><code>- def error(self, type1: Type[Literal[&quot;'&quot;]]):
+ def error(self, type1: &quot;Type[Literal[''']]&quot;):
</code></pre>
<p>While it should be:</p>
<pre><code>&quot;Type[Literal['\'']&quot;
</code></pre>
<p>The solution in this case is that we check if there’s any quotes same as the quote style we want to use for this Literal parameter then escape that same quote used in the string.</p>
<p>Also this case is not uncommon to have: <a href="https://grep.app/search?current=2&amp;q=Literal%5B%22%27">https://grep.app/search?current=2&amp;q=Literal[&quot;'</a></p>
<p>But this can get more complicated for example in case of:</p>
<pre><code>- def error(self, type1: Type[Literal[&quot;\'&quot;]]):
+ def error(self, type1: &quot;Type[Literal[''']]&quot;):
</code></pre>
<p>Here we escaped the inner quote but in the generated annotation it gets removed. Then we flip the quote style of the Literal paramter and the formatting is wrong.</p>
<p>In this case the solution is more complicated.</p>
<ol>
<li>When generating the string of the source code preserve the backslash.</li>
<li>After we have the annotation check if there isn’t any escaped quote of the same type we want to use for the Literal parameter. In this case check if we have any <code>’</code> without <code>\</code> before them. This can get more complicated since there can be multiple backslashes so checking for only <code>\’</code> won’t be enough.</li>
</ol>
<p>Another problem is when the string contains <code>\n</code>. In case of <code>Type[Literal[&quot;\n&quot;]]</code> we generate <code>'Type[Literal[&quot;\n&quot;]]'</code> and both pyright and mypy reject this annotation.
https://pyright-play.net/?code=GYJw9gtgBALgngBwJYDsDmUkQWEMoAySMApiAIYA2AUAMaXkDOjUAKoiQNqsC6AXFAB0w6tQAmJYLBKMYAfQCOAVzCk5tMChjlUjOQCNytANaMGjABYAKRiUrAANLA4BGAQHJ2CLkVIVKnABEADoogTw87gCUfNRQ8VAITIyiElKksooqahpaOih6hiZmTNa29k7w3m5sHJy%2BZFRBoeE8MXEJScxAA</p>
<h2>Test Plan</h2>
<p>I added test cases for the original code in the reported issue and two more cases for backslash and new line.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @Glyphack on 2024-11-11 18:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-11 19:01</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Glyphack">@Glyphack</a> on 2024-11-12 20:54</div>
            <div class="timeline-body"><p>Hi @dhruvmanila I spent some time on finding the issue and the fix and wrote it down below. I'm not sure if it's okay to skip fixing these tricky cases
but would be happy to find a better one with your guidance.
Let me know what you think.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-11-14 05:32</div>
            <div class="timeline-body"><p>Hey, thanks for looking into this and opening this PR.</p>
<p>I think the solution for now would be to avoid providing a fix if the annotation contains the preferred quote (the one used in to surround the annotation in the fix) or if it contains any escape characters like a newline character. Although Pyright supports them, the initial implementation for string annotations in red knot will reject them (https://github.com/astral-sh/ruff/pull/14151). There's also this discussion about the different string kinds <a href="https://discuss.python.org/t/exotic-kinds-of-string-annotations/50527">here</a>.</p>
<p>I think that's what this PR is doing right now based on looking at the snapshot changes, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Glyphack">@Glyphack</a> on 2024-11-14 17:03</div>
            <div class="timeline-body"><p>Yes @dhruvmanila this will skip the fix for those scenarios. sorry the point was not clear in the description.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @Glyphack on 2024-11-14 17:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-11-15 05:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/flake8_type_checking/helpers.rs</code>:403 on 2024-11-15 05:43</div>
            <div class="timeline-body"><p>Should we avoid traversing if we know that this is not possible? We could use <code>enter_node</code>:</p>
<p>https://github.com/astral-sh/ruff/blob/3210f1a23bfe42c5d58c609b602861062eeed2ad/crates/ruff_python_ast/src/visitor/source_order.rs#L14-L17</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-11-15 05:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/flake8_type_checking/helpers.rs</code>:279 on 2024-11-15 05:45</div>
            <div class="timeline-body"><p>Can we update the function docs to state that this will return an <code>Err</code> in this case?</p>
<p>Additionally, it seems that the function docs is out of date with your previous PR adding support for the cases where it says &quot;(This is currently unsupported.)&quot;. We can update that as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-11-15 05:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_type_checking/quote3.py</code>:64 on 2024-11-15 05:46</div>
            <div class="timeline-body"><p>nit: we don't enforce formatting on the test fixtures but it's still useful to have consistency</p>
<pre><code class="language-suggestion">    def test_string_contains_opposite_quote_do_not_fix(self, type1: Type[Literal[&quot;'&quot;]], type2: Type[Literal[&quot;\'&quot;]]):
        pass


def f():
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2024-11-15 05:47</div>
            <div class="timeline-body"><p>Thanks for looking into this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dhruvmanila on 2024-11-15 05:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Skip auto quoting when result is invalid" to "[`flake8-type-checking`] Skip quoting annotation if it becomes invalid syntax (`TCH001`)" by @dhruvmanila on 2024-11-15 11:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-11-15 11:09</div>
            <div class="timeline-body"><p>(I updated the PR to get it into the next release.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2024-11-15 11:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-11-15 11:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-15 13:28</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:07:39 UTC
    </footer>
</body>
</html>
