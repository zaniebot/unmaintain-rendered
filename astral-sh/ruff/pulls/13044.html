<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Support untitled files in the server - astral-sh/ruff #13044</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Support untitled files in the server</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13044">#13044</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-08-22 06:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body">Summary
<p>This PR adds support for untitled files in the red knot server.</p>
Test Plan
<p>https://github.com/user-attachments/assets/57fa5db6-e1ad-4694-ae5f-c47a21eaa82b</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-22 06:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-08-22 11:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_server/src/server/api/requests/diagnostic.rs</code>:76 on 2024-08-22 11:43</div>
            <div class="timeline-body"><p>I think this should be temporary. This is because the virtual path would contain the entire URL (<code>untitled:Untitled-1</code>) which means the message would have an extra <code>:</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-08-22 11:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_server/src/session.rs</code>:278 on 2024-08-22 11:44</div>
            <div class="timeline-body"><p>I thought about adding <code>File</code> to the <code>DocumentController</code> but my concern is about notebook cells which also uses <code>TextDocument</code> to represent them. I&#x27;m not exactly sure how to represent them. I do want to follow-up on this when adding support for notebooks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-08-22 11:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_workspace/src/db/changes.rs</code>:143 on 2024-08-22 11:45</div>
            <div class="timeline-body"><p>Or, should we expose a <code>close_virtual_file</code> on <code>Files</code> instead?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-22 11:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-22 11:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-22 11:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-22 11:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-08-22 11:55</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_server/src/system.rs</code>:30 on 2024-08-22 12:10</div>
            <div class="timeline-body"><p>What are the cases where <code>url.to_file_path()</code> can fail if the schema is <code>file</code>?</p>
<p>It would be nice if this method wouldn&#x27;t have to return a <code>Result</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/watch.rs</code>:81 on 2024-08-22 12:11</div>
            <div class="timeline-body"><p>Nit: Rename the method to <code>system_path</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_server/src/server/api.rs</code>:90 on 2024-08-22 12:15</div>
            <div class="timeline-body"><p>I think my preferred solution would be for <code>Index</code> to directly store a reference to <code>VirtualFile</code> or <code>File</code>. But I think you had the valid concern that the <code>Index</code> is independent of the <code>Workspace</code> and closing the workspace would result in having <code>File</code> pointers that point to a collected database. Although we could consider this a bug because the LSP should send a close event for all files when closing a workspace?</p>
<p>The benefit of storing the <code>File</code> on the <code>DocumentController</code> is that we can remove the need to convert between URLs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_server/src/server/api/notifications/did_change.rs</code>:47 on 2024-08-22 12:17</div>
            <div class="timeline-body"><p>This is more a note to myself. It&#x27;s unfortunate that we need to go through <code>apply_changes</code> here which requires going from <code>file -&gt; path</code> but this seems necessary when they e.g. open a <code>pyproject.toml</code> (and we support linting it in the future)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_server/src/session.rs</code>:278 on 2024-08-22 12:19</div>
            <div class="timeline-body"><p>Ah okay :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/db/changes.rs</code>:143 on 2024-08-22 12:19</div>
            <div class="timeline-body"><p>I think this is fine for now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-08-22 12:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-08-22 12:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_server/src/server/api.rs</code>:90 on 2024-08-22 12:19</div>
            <div class="timeline-body"><p>I saw your comment below.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-08-23 07:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_server/src/system.rs</code>:30 on 2024-08-23 07:02</div>
            <div class="timeline-body"><p>From the docs (https://docs.rs/url/2.5.2/url/struct.Url.html#method.to_file_path):</p>
<blockquote>
<p>Returns <code>Err</code> if the host is neither empty nor <code>&quot;localhost&quot;</code> (except on Windows, where <code>file:</code> URLs may have a non-local host), or if <code>Path::new_opt()</code> returns <code>None</code>. (That is, if the percent-decoded path contains a NUL byte or, for a Windows path, is not UTF-8.)</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-08-23 07:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_server/src/system.rs</code>:30 on 2024-08-23 07:14</div>
            <div class="timeline-body"><p>Not sure what <code>Path::new_opt</code> is but the code doesn&#x27;t seem to be doing that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_server/src/system.rs</code>:30 on 2024-08-23 07:16</div>
            <div class="timeline-body"><p>Going to merge the PR, will look at this in a follow-up.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-08-23 07:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-23 07:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-23 07:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-08-23 07:17</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:06:16 UTC
    </footer>
</body>
</html>
