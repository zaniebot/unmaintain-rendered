<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Format Function definitions - astral-sh/ruff #4951</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Format Function definitions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4951">#4951</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-06-08 05:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-08 05:57</div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>This PR implements formatting for function definitions and async function definitions. The formatting should be fairly complete.</p>
<h2>Test Plan</h2>
<p>I added a few of my own test cases and reviewed the black differences.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-08 05:58</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #4954</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4954" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #4921</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4921" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #4922</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4922" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #4951</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4951" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ<ul>
<li><strong>PR #4961</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4961" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>
* <strong>PR #4964</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4964" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>
* <strong>PR #4979</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4979" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>
* <strong>PR #4978</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4978" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4951?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-06-08 06:40</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      7.2Â±0.19ms     5.7 MB/sec    1.02      7.3Â±0.11ms     5.6 MB/sec
formatter/numpy/ctypeslib.py               1.00  1294.9Â±26.02Âµs    12.9 MB/sec    1.00  1297.4Â±26.58Âµs    12.8 MB/sec
formatter/numpy/globals.py                 1.00    146.5Â±3.94Âµs    20.1 MB/sec    1.02    149.2Â±1.42Âµs    19.8 MB/sec
formatter/pydantic/types.py                1.00      3.0Â±0.05ms     8.6 MB/sec    1.02      3.0Â±0.05ms     8.5 MB/sec
linter/all-rules/large/dataset.py          1.00     16.3Â±0.23ms     2.5 MB/sec    1.00     16.3Â±0.29ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.9Â±0.05ms     4.3 MB/sec    1.00      3.9Â±0.07ms     4.3 MB/sec
linter/all-rules/numpy/globals.py          1.00   469.2Â±13.01Âµs     6.3 MB/sec    1.03    484.2Â±4.42Âµs     6.1 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.7Â±0.11ms     3.8 MB/sec    1.02      6.8Â±0.10ms     3.7 MB/sec
linter/default-rules/large/dataset.py      1.00      7.7Â±0.18ms     5.3 MB/sec    1.03      7.9Â±0.07ms     5.2 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1628.2Â±44.42Âµs    10.2 MB/sec    1.04  1688.6Â±23.05Âµs     9.9 MB/sec
linter/default-rules/numpy/globals.py      1.02    186.4Â±2.03Âµs    15.8 MB/sec    1.00    183.4Â±3.77Âµs    16.1 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.5Â±0.08ms     7.3 MB/sec    1.02      3.5Â±0.04ms     7.2 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      9.1Â±0.29ms     4.5 MB/sec    1.01      9.3Â±0.23ms     4.4 MB/sec
formatter/numpy/ctypeslib.py               1.00  1581.2Â±59.49Âµs    10.5 MB/sec    1.03  1627.8Â±50.84Âµs    10.2 MB/sec
formatter/numpy/globals.py                 1.00   174.8Â±10.52Âµs    16.9 MB/sec    1.02    178.9Â±8.62Âµs    16.5 MB/sec
formatter/pydantic/types.py                1.00      3.7Â±0.11ms     6.9 MB/sec    1.04      3.8Â±0.13ms     6.7 MB/sec
linter/all-rules/large/dataset.py          1.00     18.6Â±0.44ms     2.2 MB/sec    1.11     20.7Â±0.51ms  2010.3 KB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.8Â±0.16ms     3.5 MB/sec    1.10      5.2Â±0.14ms     3.2 MB/sec
linter/all-rules/numpy/globals.py          1.00   561.3Â±27.93Âµs     5.3 MB/sec    1.06   597.6Â±18.10Âµs     4.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      8.0Â±0.25ms     3.2 MB/sec    1.09      8.8Â±0.25ms     2.9 MB/sec
linter/default-rules/large/dataset.py      1.00      9.4Â±0.25ms     4.3 MB/sec    1.13     10.6Â±0.22ms     3.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00      2.1Â±0.09ms     8.0 MB/sec    1.08      2.3Â±0.09ms     7.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    237.5Â±9.24Âµs    12.4 MB/sec    1.05   249.3Â±17.36Âµs    11.8 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.5Â±0.13ms     5.7 MB/sec    1.07      4.8Â±0.18ms     5.3 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2023-06-08 10:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">autoformatter</span> added by @MichaReiser on 2023-06-08 10:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/generate.py</code>:82 on 2023-06-08 10:16</div>
            <div class="timeline-body"><p>This was a bit unexpected haha...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:108 on 2023-06-08 10:17</div>
            <div class="timeline-body"><p>using <code>default</code> here yields an incorrect result if the body is on the same line as the case header. Using <code>usize::MAX</code> should be fairly safe ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/lib.rs</code>:42 on 2023-06-08 10:18</div>
            <div class="timeline-body"><p>The leading and trailing comments normally appear before the node and have lower source positions. That's why we should move the node's source position to just cover the node itself.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/snapshots/ruff_python_formatter__tests__black_test__docstring_py.snap</code>:238 on 2023-06-08 10:20</div>
            <div class="timeline-body"><p>This PR does not implement any special handling for docstrings yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-08 11:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2023-06-08 11:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @MichaReiser on 2023-06-08 11:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/other/arg.rs</code>:34 on 2023-06-08 12:12</div>
            <div class="timeline-body"><pre><code class="language-suggestion">            // The name of the argument
            [source_text_slice(
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/other/arguments.rs</code>:36 on 2023-06-08 12:26</div>
            <div class="timeline-body"><p>strange decision on the grammar or parser side to emit the default separate from the argument</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/other/arguments.rs</code>:51 on 2023-06-08 12:29</div>
            <div class="timeline-body"><p>so confusing that pos only arguments are in front of the slash, but keyword arguments are after the star (your code is correct)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/other/arguments.rs</code>:103 on 2023-06-08 12:41</div>
            <div class="timeline-body"><pre><code class="language-suggestion">            // Break group if there is a trailing comma
            if let Some(last_node) = last_node {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/other/arguments.rs</code>:103 on 2023-06-08 12:42</div>
            <div class="timeline-body"><p>Does this also need to read the magic trailing comma setting?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-06-08 12:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-08 13:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/other/arguments.rs</code>:103 on 2023-06-08 13:02</div>
            <div class="timeline-body"><p>If we introduce a setting for this, then yes</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-08 13:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/other/arg.rs</code>:34 on 2023-06-08 13:19</div>
            <div class="timeline-body"><p>Good point!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-08 13:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/other/arguments.rs</code>:36 on 2023-06-08 13:19</div>
            <div class="timeline-body"><p>Haha yeah. I got it wrong so many times. The most recent version of <code>RustPython</code> now tracks the <code>default</code> on the argument but I haven't had time to upgrade yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-06-08 13:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/other/arguments.rs</code>:103 on 2023-06-08 13:25</div>
            <div class="timeline-body"><p>i forgot this isn't merged: https://github.com/astral-sh/ruff/pull/4878/files#diff-c1f1071e384c9f14936cad67780f301345744791e34afd93cada2cf43af8dcb5R18</p>
<p>I haven't looked into how to pass settings, but i think it makes sense to introduce the boolean for that now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-08 13:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/other/arguments.rs</code>:103 on 2023-06-08 13:35</div>
            <div class="timeline-body"><p>The intended way for settings is that Ruff defines a <code>PyFormatOption</code> struct that implements <code>FormatOptions</code> and is passed to the <code>PyFormatContext</code> (instead of using the generic <code>SimpleFormatOptions</code>). You can then access it with <code>f.context().options()....</code></p>
<p>https://github.com/charliermarsh/ruff/blob/dc7cdb04e17cd9aae7ab63976424b01bf040f8d3/crates/ruff_formatter/src/lib.rs#L257-L277</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-06-08 15:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @MichaReiser on 2023-06-08 15:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-06-08 16:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-06-08 16:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-06-08 16:07</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 03:44:08 UTC
    </footer>
</body>
</html>
