<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Add list of failing/slow ecosystem projects - astral-sh/ruff #17474</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Add list of failing/slow ecosystem projects</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17474">#17474</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2025-04-18 22:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body">Summary
<p>I ran red-knot on every project in mypy-primer. I moved every project where red-knot ran to completion (fast enough, and mypy-primer could handle its output) into <code>good.txt</code>, so it will run in our CI.</p>
<p>The remaining projects I left listed in <code>bad.txt</code>, with a comment summarizing the failure mode (a few don&#x27;t fail, they are just slow -- on a debug build, at least -- or output too many diagnostics for mypy-primer to handle.)</p>
<p>We will now run CI on 109 projects; 34 are left in <code>bad.txt</code>.</p>
<p>The main question about this PR is whether running mypy-primer on 111 projects is too much for CI: does it take too long? does it make the mypy-primer output overwhelming? If it is too much, I can split <code>good.txt</code> into <code>run-in-ci.txt</code> and <code>good.txt</code>, and we can pick some subset to run in CI.</p>
Test Plan
<p>CI on this PR!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-18 22:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-18 22:38</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-18 22:41</div>
            <div class="timeline-body"><p>I&#x27;m pretty strongly in favour of running (a lot) more mypy_primer projects in CI. Apart from anything else, we&#x27;ve already had several cases where the mypy_primer workflow has caught new panics for us, which seem very important for us to know about.</p>
<p>It looks like the changes here mean that it now runs in six minutes, which <em>is</em> quite a lot slower than the two minutes it took previously. We could consider sharding the mypy_primer workflow between several CI jobs and joining the artifacts afterwards, which is what both mypy and typeshed do in their mypy_primer workflows.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ci</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-18 22:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/carljm">@carljm</a> on 2025-04-18 23:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/carljm">@carljm</a> on 2025-04-18 23:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/carljm">@carljm</a> on 2025-04-18 23:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/carljm">@carljm</a> on 2025-04-18 23:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-04-18 23:52</div>
            <div class="timeline-body"><p>6 minutes is reasonable enough that I&#x27;m tempted to just land this as-is and move on; I don&#x27;t want to spend a lot of time wrangling GitHub Actions. But maybe if it&#x27;s easy to borrow the mypy/typeshed sharding setup, I could look at that. This does make mypy-primer the long pole in our CI (replacing windows and release-mode tests at 4 minutes.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2025-04-19 00:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by <a href="https://github.com/carljm">@carljm</a> on 2025-04-19 00:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-04-19 13:43</div>
            <div class="timeline-body"><p>I tried to do some work towards sharding in <a href="https://github.com/astral-sh/ruff/pull/17475">astral-sh/ruff#17475</a>, but I feel like I&#x27;ve reached my timebox on that. I have the sharded runs working fine and uploading artifacts, but the &quot;comment&quot; workflow needs significant changes in order to download all the diff artifacts and combine them, and our current comment workflow is quite different from the typeshed/mypy ones. Compounding the difficulty, it appears that a workflow that is triggered on completion of another workflow (like the mypy primer comment one) only runs if it exists on the main branch of the repo, so it seems like debugging it would have to occur on main branch.</p>
<p>So at this point my proposal would be to merge this and accept that ecosystem checks take 6-8 minutes. Open to alternative proposals, including &quot;put more work into sharding&quot; or &quot;reduce the project set.&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-04-19 14:00</div>
            <div class="timeline-body"><p>Hmm, scratch that; something caused the last run to take 20min and time out. Will need to dig into that before we can consider merging this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/carljm">@carljm</a> on 2025-04-19 14:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[red-knot] update mypy-primer projects list&quot; to &quot;[red-knot] Add list of failing/slow ecosystem projects&quot; by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-22 11:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-22 12:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> approved on 2025-04-22 12:08</div>
            <div class="timeline-body"><p>@carljm Thank you for this. After updating mypy_primer to run from upstream (which also includes a lot of recent changes to project dependencies), I re-analyzed all projects here. See the commit history for a log of the changes that I did. I moved five projects to <code>bad.txt</code> (all <code>try_metaclass_</code> panics) which were recently part of <code>good.txt</code> (merged <a href="https://github.com/astral-sh/ruff/pull/17544">separately</a>). I also moved four projects to <code>good.txt</code>. The hang on Tanjun is probably related to #17537, I reclassified it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-22 12:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-22 12:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-22 12:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-22 12:25</div>
            <div class="timeline-body"><p>I don&#x27;t know if performance is still a concern and if it is mainly red knot or mypy primer being slow. If it still is a concern and it&#x27;s mainly red knot, then consider creating a new build profile which performs a release build but disables LTO (you could even experiment with less aggressive optimizations). LTO tends to be the slowest step and this could be a good trade between a faster red-knot without spending too much time on compiling.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-22 12:31</div>
            <div class="timeline-body"><blockquote>
<p>I don&#x27;t know if performance is still a concern and if it is mainly red knot or mypy primer being slow.</p>
</blockquote>
<p>The red knot compilation used to be the bottleneck (when we ran on a few projects only), which is why I made it a debug build. Now it&#x27;s the setup (clone + dependency installation) + the actual execution of red knot, which is the bottleneck. So we could consider switching back to a release build, with the disadvantage that we would have worse backtraces and no debug-assertions.</p>
<blockquote>
<p>If it still is a concern and it&#x27;s mainly red knot, then consider creating a new build profile which performs a release build but disables LTO (you could even experiment with less aggressive optimizations). LTO tends to be the slowest step and this could be a good trade between a faster red-knot without spending too much time on compiling.</p>
</blockquote>
<p>:+1:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-22 12:32</div>
            <div class="timeline-body"><blockquote>
<p>with the disadvantage that we would have worse backtraces and no debug-assertions.</p>
</blockquote>
<p>We could enable debug assertions, similar to the <code>profiling</code> profile</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:13:27 UTC
    </footer>
</body>
</html>
