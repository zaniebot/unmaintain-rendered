<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Diagnostic for conflicting declared attribute types - astral-sh/ruff #18953</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Diagnostic for conflicting declared attribute types</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18953">#18953</a>
        opened by <a href="https://github.com/lipefree">@lipefree</a>
        on 2025-06-26 08:09
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/lipefree">@lipefree</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff/ty! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title? (Please prefix with `[ty]` for ty pull
  requests.)
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>Implements https://github.com/astral-sh/ty/issues/206.</p>
<pre><code class="language-py">flag: bool

# error: [conflicting-declarations] &quot;Conflicting declared types for attribute `v`: `int` and `str`&quot;
# error: [conflicting-declarations] &quot;Conflicting declared types for attribute `w`: `int` and `str`&quot;
# error: [conflicting-declarations] &quot;Conflicting declared types for attribute `u`: `int` and `str`&quot;
# error: [conflicting-declarations] &quot;Conflicting declared types for attribute `y`: `str` and `int`&quot;
# error: [conflicting-declarations] &quot;Conflicting declared types for attribute `z`: `int` and `str`&quot;
class C:
   global flag
    if flag:
        w: int = 1
        u: int
    else:
        w: str = &quot;&quot;
        u: str

    z: int
    v: int = 1
     def __init__(self) -&gt; None:
        self.y: int = 1
        self.z: str = &quot;a&quot;
        self.v: str = &quot;a&quot;

    def other_method(self):
        self.y: str = &quot;a&quot;
        self.z: str = &quot;a&quot;
        self.z: str = &quot;a&quot;

    def another_method(self):
        self.z: str = &quot;a&quot; # to check that we don't have duplicated types in the diagnostic

c_instance = C()

reveal_type(c_instance.y)  # revealed: int
reveal_type(c_instance.z)  # revealed: int
</code></pre>
<p>The diagnostic is <strong>not</strong> done lazily. Because I had some troubles with speed regressions, the diagnostic is only checking on attributes of the current class and <strong>not</strong> on its superclasses.</p>
<h2>Test Plan</h2>
<!-- How was it tested? -->

<p>I will use existing mdtests and add more tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @MichaReiser on 2025-06-26 08:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @MichaReiser on 2025-06-26 08:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-26 08:12</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">black (https://github.com/psf/black)
+ src/blib2to3/pytree.py:368:1: error[conflicting-declarations] Conflicting declared types for attribute `fixers_applied`: `list[Any]` and `list[Any] | None`
- Found 56 diagnostics
+ Found 57 diagnostics

trio (https://github.com/python-trio/trio)
+ src/trio/_sync.py:167:1: error[conflicting-declarations] Conflicting declared types for attribute `total_tokens`: `property` and `int | float`
- Found 739 diagnostics
+ Found 740 diagnostics

PyGithub (https://github.com/PyGithub/PyGithub)
+ github/Requester.py:1293:1: error[conflicting-declarations] Conflicting declared types for attribute `__requester`: `Requester` and `Requester | None`
- Found 305 diagnostics
+ Found 306 diagnostics

meson (https://github.com/mesonbuild/meson)
+ mesonbuild/build.py:1890:1: error[conflicting-declarations] Conflicting declared types for attribute `env`: `EnvironmentVariables | None` and `EnvironmentVariables`
- Found 757 diagnostics
+ Found 758 diagnostics

dd-trace-py (https://github.com/DataDog/dd-trace-py)
+ ddtrace/internal/ci_visibility/api/_base.py:123:1: error[conflicting-declarations] Conflicting declared types for attribute `_session_settings`: `property` and `TestVisibilitySessionSettings`
+ ddtrace/internal/ci_visibility/api/_base.py:123:1: error[conflicting-declarations] Conflicting declared types for attribute `_source_file_info`: `property` and `TestSourceFileInfo | None`
+ ddtrace/internal/ci_visibility/api/_base.py:546:1: error[conflicting-declarations] Conflicting declared types for attribute `_session_settings`: `property` and `TestVisibilitySessionSettings`
+ ddtrace/internal/ci_visibility/api/_module.py:26:1: error[conflicting-declarations] Conflicting declared types for attribute `_session_settings`: `property` and `TestVisibilitySessionSettings`
+ ddtrace/internal/ci_visibility/api/_session.py:29:1: error[conflicting-declarations] Conflicting declared types for attribute `_session_settings`: `property` and `TestVisibilitySessionSettings`
+ ddtrace/internal/ci_visibility/api/_suite.py:29:1: error[conflicting-declarations] Conflicting declared types for attribute `_session_settings`: `property` and `TestVisibilitySessionSettings`
+ ddtrace/internal/ci_visibility/api/_test.py:46:1: error[conflicting-declarations] Conflicting declared types for attribute `_session_settings`: `property` and `TestVisibilitySessionSettings`
- Found 6473 diagnostics
+ Found 6480 diagnostics

</code></pre>
</details>
<details>
<summary>Memory usage changes were detected when running on open source projects</summary>

<pre><code class="language-diff">sphinx (https://github.com/sphinx-doc/sphinx)
- TOTAL MEMORY USAGE: ~260MB
+ TOTAL MEMORY USAGE: ~273MB
-     memo fields = ~194MB
+     memo fields = ~204MB

prefect (https://github.com/PrefectHQ/prefect)
- TOTAL MEMORY USAGE: ~541MB
+ TOTAL MEMORY USAGE: ~568MB
-     memo metadata = ~73MB
+     memo metadata = ~76MB
-     memo fields = ~424MB
+     memo fields = ~445MB

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @lipefree on 2025-06-30 18:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @lipefree on 2025-06-30 18:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @lipefree on 2025-06-30 18:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @lipefree on 2025-06-30 18:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @lipefree on 2025-06-30 18:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lipefree">@lipefree</a> on 2025-06-30 18:47</div>
            <div class="timeline-body"><p>I just have some questions about the linting :</p>
<ol>
<li>according to clippy, in the file <code>ty_python_semantic/src/types.rs</code> for the code :</li>
</ol>
<pre><code class="language-rust">fn member_lookup_cycle_initial&lt;'db&gt;(
    _db: &amp;'db dyn Db,
    _self: Type&lt;'db&gt;,
    _name: Name,
    _policy: MemberLookupPolicy,
) -&gt; PlaceFromOwnInstanceMemberResult&lt;'db&gt; {
    Ok(Place::bound(Type::Never).into())
}
</code></pre>
<p>We could get rid of the <code>Result</code> wrapper, but I was not able to compile my code without it.</p>
<ol start="2">
<li>I don't understand the second linting error where it says
<code>error: this function has a `#[must_use]` attribute with no message, but returns a type already marked as `#[must_use]` </code>
for the following code :</li>
</ol>
<pre><code class="language-rust">    /// Access an attribute of this type, potentially invoking the descriptor protocol.
    /// Corresponds to `getattr(&lt;object of type 'self'&gt;, name)`.
    ///
    /// See also: [`Type::static_member`]
    ///
    /// TODO: We should return a `Result` here to handle errors that can appear during attribute
    /// lookup, like a failed `__get__` call on a descriptor.
    #[must_use]
    pub(crate) fn member(
        self,
        db: &amp;'db dyn Db,
        name: &amp;str,
    ) -&gt; PlaceFromOwnInstanceMemberResult&lt;'db&gt; {
        self.member_lookup_with_policy(db, name.into(), MemberLookupPolicy::default())
    }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/attributes.md</code>:240 on 2025-07-03 01:41</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    def another_method(self):
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/attributes.md</code>:245 on 2025-07-03 01:47</div>
            <div class="timeline-body"><p>I think it would be better if these diagnostics were emitted on (one of) the conflicting declarations, rather than on each usage site, and would be emitted regardless of whether the attribute is later accessed.</p>
<p>I realize this will likely require significant changes to the way this is implemented, because it means that in <code>TypeInferenceBuilder::check_class_definition</code> we would need to query for all declarations on the class and in methods, and error on the conflicting ones, rather than doing it lazily when looking up an attribute.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-07-03 01:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @lipefree on 2025-07-03 06:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-07-10 14:37</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/lipefree%3Aconflicting-declaration-attribute?utm_source=github&amp;utm_medium=comment&amp;utm_content=header">CodSpeed Performance Report</a></h2>
<h3>Merging #18953 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>lipefree:conflicting-declaration-attribute</code> (9a35400) with <code>main</code> (1d21816)</sub></p>
<h3>Summary</h3>
<p><code>âœ… 8</code> untouched</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @lipefree on 2025-07-10 15:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @lipefree on 2025-07-10 16:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/resources/mdtest/attributes.md</code>:245 on 2025-07-16 07:57</div>
            <div class="timeline-body"><p>@lipefree You marked this as resolved, but I don't think your current implementation emits the diagnostic on one of the conflicting declarations? Instead, it looks like the diagnostics are now emitted on the whole class declaration? A class declaration can be arbitrarily large, so it would be nice to attach it to one of the problematic declarations only.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-07-16 07:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @lipefree on 2025-07-17 13:38</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:13:42 UTC
    </footer>
</body>
</html>
