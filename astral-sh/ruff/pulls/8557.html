<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pycodestyle`] Add E12 rules (continuation lines indentation rules) - astral-sh/ruff #8557</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pycodestyle</code>] Add E12 rules (continuation lines indentation rules)</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/8557">#8557</a>
        opened by <a href="https://github.com/hoel-bagard">@hoel-bagard</a>
        on 2023-11-08 13:09
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/hoel-bagard">@hoel-bagard</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR is part of https://github.com/charliermarsh/ruff/issues/2402, it adds the <code>E12</code> rules (continuation lines indentation rules).</p>
<h2>Test Plan</h2>
<p>The test fixture uses <a href="https://github.com/PyCQA/pycodestyle/blob/main/testing/data/E12.py">the one from pycodestyle</a>, except for <code>E133</code> for which there is no fixture since it is an opt-in config option (same as pycodestyle) and I do not know how to handle it.</p>
<h2>Discussion</h2>
<p>This PR replaces the <a href="https://github.com/astral-sh/ruff/pull/7655">add E122</a> PR.</p>
<h3>Performance issue</h3>
<p>The changes from the PR seem to slow down ruff quite a bit, I'm guessing that the <code>get_token_infos</code> function is the slow part, but it was needed to follow the pycodestyle implementation.  Is there a way to implement it that would be faster ?</p>
<h3>Extra rules</h3>
<p>The PR is essentially a port of the <a href="https://github.com/PyCQA/pycodestyle/blob/main/pycodestyle.py#L545">pycodestyle implementation</a> from python to rust. I implemented all the errors present in that function before realizing that <a href="https://www.flake8rules.com/rules/E121.html">E121</a>, <a href="https://www.flake8rules.com/rules/E123.html">E123</a>, <a href="https://www.flake8rules.com/rules/E126.html">E126</a> and <a href="https://www.flake8rules.com/rules/E133.html">E133</a> are not in the #2402 list. Should I remove them from the PR ?</p>
<h3>Test error</h3>
<p>When running the tests, the following deserialization test fails:</p>
<pre><code class="language-rust">        assert!(toml::from_str::&lt;Pyproject&gt;(
            r#&quot;
[tool.black]
[tool.ruff.lint]
select = [&quot;E123&quot;]
&quot;#,
        )
        .is_err());
</code></pre>
<p>I'm not sure what to do about it, although I suppose the issue would disappear if <code>E123</code> is removed from the PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2023-11-08 13:19</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/hoel-bagard:hoel/add_E12_rules">CodSpeed Performance Report</a></h2>
<h3>Merging #8557 will <strong>degrade performances by 7.6%</strong></h3>
<p><sub>Comparing <code>hoel-bagard:hoel/add_E12_rules</code> (382429c) with <code>main</code> (7391f74)</sub></p>
<h3>Summary</h3>
<p><code>❌ 5</code> regressions
<code>✅ 20</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/hoel-bagard:hoel/add_E12_rules">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>main</code> | <code>hoel-bagard:hoel/add_E12_rules</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ❌ | <code>linter/all-rules[pydantic/types.py]</code> | 74.5 ms | 80.6 ms | -7.6% |
| ❌ | <code>linter/all-rules[large/dataset.py]</code> | 174 ms | 187.2 ms | -7.03% |
| ❌ | <code>linter/all-rules[unicode/pypinyin.py]</code> | 16.3 ms | 17.2 ms | -5.15% |
| ❌ | <code>linter/all-rules[numpy/ctypeslib.py]</code> | 34.8 ms | 37.3 ms | -6.83% |
| ❌ | <code>linter/all-rules[numpy/globals.py]</code> | 3.9 ms | 4.2 ms | -5.59% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Avasam">@Avasam</a> on 2023-12-14 07:50</div>
            <div class="timeline-body"><p>As a note, fixes for these would bring Ruff closer to parity with autopep8 https://github.com/astral-sh/ruff/discussions/9057#discussioncomment-7850584</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/spaceone">@spaceone</a> on 2024-02-18 19:21</div>
            <div class="timeline-body"><p>This is nearly the last missing pycodestyle check. Having it would allow use to throw away the slow <code>pycodestyle</code>, <code>flake8</code> and  <code>autopep8</code> pre-commit hooks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hoel-bagard">@hoel-bagard</a> on 2024-02-25 11:00</div>
            <div class="timeline-body"><p>@MichaReiser sorry to ping you here, but I would appreciate some feedback/advice on this PR.</p>
<p>I had implemented the E12 rules for completeness (to get closer to having all the boxes checked in #2402), but I went at it lazily and used the same logic as pycodesyle, which resulted in the PR not even passing the CI.</p>
<p>Do you think it would be worth it to spend time trying to fix/rework it, or should this PR be closed and forgotten ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-25 12:11</div>
            <div class="timeline-body"><p>@hoel-bagard I try to take a look on Monday. I've a lot of catch up to do on PRs and I'm, unfortunately, not as fast as @charliermarsh</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @MichaReiser on 2024-02-25 12:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @MichaReiser on 2024-02-25 12:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pycodestyle/rules/logical_lines/continuation_lines.rs</code>:202 on 2024-02-26 08:39</div>
            <div class="timeline-body"><p>The difference between this and <code>ContinuationLineOverIndentedForHangingIndent</code> and <code>ContinuationLineUnderIndentedForVisualIndent</code> isn't clear to me from reading the documentation. Are these different styles and users should only enable one of those rules?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pycodestyle/rules/logical_lines/continuation_lines.rs</code>:459 on 2024-02-26 08:41</div>
            <div class="timeline-body"><p>This would need to support the new <code>indent_width</code> setting</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-02-26 08:46</div>
            <div class="timeline-body"><p>Hey @hoel-bagard</p>
<p>I haven't reviewed the code yet but I read through the rules.</p>
<p>My main concern is that not all rules are formatter-compatible. For example, <code>ClosingBracketNotMatchingOpeningBracketVisualIndentation</code> is guaranteed to conflict with all formatted code. This is problematic because many users use <code>--select ALL</code>, which enables these new rules, and they then get a lot of errors if they use our formatter (and see an incompatibility warning when running format). That's why we want to hold off from adding new formatting-related lint rules that are formatter incompatible until we're done with the rules re-categorization where we are likely to have a <code>format</code> (or similar) related category that we only recommend for users that <strong>do not</strong> use our formatter.</p>
<p>I'm having a hard time judging if other rules conflict with the formatter, too, from just reading their documentation. E.g. I'm unsure about <code>ContinuationLineOverIndentedForHangingIndent</code>, <code>ContinuationLineOverIndentedForVisualIndent</code>,</p>
<p>I believe <code>VisuallyIndentedLineWithSameIndentAsNextLogicalLine</code> and <code>ContinuationLineUnalignedForHangingIndent</code> are incompatible, too (at least today, we are considering changing that).</p>
<p>I'm sorry that this means we can't move forward with the rules as they are now. We could explore limiting the rules to the formatter-compatible ones or finding a way to make them formatter-compatible.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Corentin-pro">@Corentin-pro</a> on 2024-02-26 15:41</div>
            <div class="timeline-body"><p>Hello, I want to emphasize that this addition would be very welcome. I had many instances where I would have liked ruff to tell me about over-indentation (E127) when I refactored my code (removing arguments from a function that changed the indentation).</p>
<p>I am interested in this PR. If I have the time and the code is not yet OK to be merge I'll look into this in the next month.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/hoel-bagard">@hoel-bagard</a> reviewed on 2024-02-27 00:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/hoel-bagard">@hoel-bagard</a> on <code>crates/ruff_linter/src/rules/pycodestyle/rules/logical_lines/continuation_lines.rs</code>:202 on 2024-02-27 00:23</div>
            <div class="timeline-body"><p>It seems to me like they could both apply in one codebase, although that would not be a very consistent codebase.</p>
<p>Looking at the <a href="https://github.com/PyCQA/pycodestyle/blob/main/testing/data/E12.py">fixtures from pycodestyle</a>,  <code>E126</code> (<code>ContinuationLineOverIndentedForHangingIndent</code>) seems to apply when there is a newline after the symbol causing the continuation line (<code>(</code>, <code>\</code>, etc...) whereas <code>E128</code> (<code>ContinuationLineUnderIndentedForVisualIndent</code>) applies when there is at least one value after the start of the continuation line.</p>
<p>For example this is a <code>E126</code> error</p>
<pre><code class="language-python">print(&quot;E126&quot;, (
                &quot;1&quot;,
    &quot;2&quot;,
))
</code></pre>
<p>Whereas this is a <code>E128</code> error:</p>
<pre><code class="language-python">print(&quot;E128&quot;, (&quot;1&quot;,
    &quot;2&quot;,
))
</code></pre>
<p>See also the unofficial rules explanation for <a href="https://www.flake8rules.com/rules/E126.html">E126</a> and <a href="https://www.flake8rules.com/rules/E128.html">E128</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hoel-bagard">@hoel-bagard</a> on 2024-02-27 00:40</div>
            <div class="timeline-body"><p>Having rules that conflict with the formatter would be quite annoying indeed (I already noticed the formatter disagreeing with flake8, and that meant having to add an exception to the flake8 config).</p>
<p>I tried running ruff with the <code>E12</code> rules on one (small) codebase that has been formatted with the ruff formatter, and got no error.</p>
<p>I tried to make an example that would cause the formatter and the <code>E129</code> (<code>VisuallyIndentedLineWithSameIndentAsNextLogicalLine</code>) to disagree, but without success.</p>
<p>The following triggers <code>E129</code>:</p>
<pre><code class="language-python">if (var in &quot;one_looooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooong_string&quot;
    and var not in &quot;another_looooooooooooooooooooooooooooooooooooooooooooooooooooong_string&quot;):
    ...
</code></pre>
<p>But it get formatted into the <code>E12</code> compliant code:</p>
<pre><code class="language-python">if (
    var
    in &quot;one_looooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooong_string&quot;
    and var
    not in &quot;another_looooooooooooooooooooooooooooooooooooooooooooooooooooong_string&quot;
):
    ...
</code></pre>
<p>The docstring examples and fixtures would definitely need to be simplified, I'll try to do that today/tomorrow. I wanted to run the formatter on the <code>E12</code> fixtures, but it uses python2 style code, which prevents the formatter from formatting the code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hoel-bagard">@hoel-bagard</a> on 2024-02-27 02:53</div>
            <div class="timeline-body"><p>@MichaReiser I ran ruff format on the <code>E12.py</code> fixtures file, and it fixed all but two of the errors.</p>
<p>The errors that did not get fixed automatically are both <code>E125</code> errors:</p>
<pre><code class="language-python">if &quot;&quot;&quot;
    &quot;&quot;&quot;:
    pass

for foo in &quot;&quot;&quot;
    abc
    def
    &quot;&quot;&quot;.strip().split():
    print(foo)
</code></pre>
<p>They can be fixed by manually formatting them to:</p>
<pre><code class="language-python">if &quot;&quot;&quot;&quot;&quot;&quot;:
    pass

for foo in &quot;&quot;&quot;
    abc
    def
&quot;&quot;&quot;.strip().split():
    print(foo)
</code></pre>
<p>(this changes the content of the string, but that's not really the point here)</p>
<p>At which point the formatter does not attempt to change the file anymore, and both pycodestyle and the rules added in this PR do not detect any <code>E12</code> violation.</p>
<p>So it seems like the <code>E12</code> rules are not incompatible with the formatter.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-03-04 13:01</div>
            <div class="timeline-body"><p>I haven't forgotton about this PR but we first need to decide internally if we want to add more formatting lint rules and my priority for now is to fix incompatibilities with existing rules.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">incompatibility</span> added by @zanieb on 2024-03-12 18:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-03-28 17:10</div>
            <div class="timeline-body"><p>Thank you @hoel-bagard for your patience and sorry that it took me so long.</p>
<p>I started reviewing the rules but stopped after E125 because discovering all possible formatter incompatibilities took a very long time, and I generally struggled to understand the rules or how they differ (this isn't a critique, it's just me struggling and not being familiar with the rules).</p>
<p>For <code>E121</code>: I see how the rule is useful, but the rule is in conflict with some possible expression formatting that I want to try out in the formatter.  That's why I want to hold off adding this specific rule, at least until #1774 is complete. I heard @AlexWaygood has ideas on how to support formatter incompatible rules ;)</p>
<pre><code class="language-python">a = (
    a 
    + b
    + len([
        1, 
        2, 
      ]) # NOK
    + more([
        a, 
      ]) # NOK
)
</code></pre>
<p>I'm generally open to accepting the rules <code>E122</code> and <code>E125</code> (I still have to review the other rules), but I would prefer if we could tackle one rule at a time in separate PRs. I'm aware that this asks for extra work on your side and I'm sorry for this, but I don't think I can prioritize reviewing all the additions in a single PR right now. Adding the rules one by one also has the benefit that it reducing the risk of regressions because we can ship them independently (we would still have the regression, but we would receive the feedback across multiple releases)</p>
<p>The other thing we need to consider is that the rule seems to regress performance somewhat significantly. I think we need to figure out a design that reduces the performance less. This could involve refactoring existing pycodestye rules to see if performance can be improved.</p>
<p>What do you think? Do you want to pursue the rules in individual PRs (please don't open all PRs at once, let's do one at a time)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hoel-bagard">@hoel-bagard</a> on 2024-03-31 02:01</div>
            <div class="timeline-body"><p>@MichaReiser</p>
<p>Thanks for taking time to look into it.
While I use the formatter, I never looked too much into its rules, so I don't know about the incompatibilities with the <code>E12</code> rules. I'll try to check for incompatibilities while working on it.</p>
<p>Implementing the rules one by one sounds good to me, that would also likely make understanding what each rule does easier.</p>
<blockquote>
<p>The other thing we need to consider is that the rule seems to regress performance somewhat significantly. I think we need to figure out a design that reduces the performance less. This could involve refactoring existing pycodestye rules to see if performance can be improved.</p>
</blockquote>
<p>I suspect that working directly on tokens would help with the performance issue. I used logical lines because that's what pycodestyle does, but I don't think that was a good idea.</p>
<blockquote>
<p>What do you think? Do you want to pursue the rules in individual PRs (please don't open all PRs at once, let's do one at a time)?</p>
</blockquote>
<p>I can try to start working on <code>E122</code> and see how it goes. I won't spend time on the other rules before that one gets merged (there's no point working on the other rules before solving the formatter incompatibilities / performance issues).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-04-02 14:03</div>
            <div class="timeline-body"><blockquote>
<p>I suspect that working directly on tokens would help with the performance issue. I used logical lines because that's what pycodestyle does, but I don't think that was a good idea.</p>
</blockquote>
<p>Logical lines might be fine, I'm not sure. One problem I noticed while skimming over the code is that we allocate multiple vectors and hash sets for each line. I think we should look into how we can avoid that. It can mean that we should use something other than logical line, reuse the allocations across check calls etc.</p>
<blockquote>
<p>I can try to start working on E122 and see how it goes. I won't spend time on the other rules before that one gets merged (there's no point working on the other rules before solving the formatter incompatibilities / performance issues).</p>
</blockquote>
<p>Thanks a lot! I'll close this PR. We can still use it as a reference. I hope that's okay with you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-04-02 14:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hoel-bagard">@hoel-bagard</a> on 2024-04-03 13:04</div>
            <div class="timeline-body"><p>I think the main issue with logical lines is that they have to be sliced to look for new lines (like <a href="https://github.com/astral-sh/ruff/pull/8557/files#diff-035fb3ef6174f555db00ce0f906fece3167eb58572c9389ffe98d1608d49b491R397">here</a> for example). This currently happens for every token, which I assume is the slow part.</p>
<blockquote>
<p>One problem I noticed while skimming over the code is that we allocate multiple vectors and hash sets for each line. I think we should look into how we can avoid that.</p>
</blockquote>
<p>If you're referring to <a href="https://github.com/astral-sh/ruff/pull/8557/files#diff-035fb3ef6174f555db00ce0f906fece3167eb58572c9389ffe98d1608d49b491R418">this</a>, then it's being done for every token, which is most likely more than needed indeed.</p>
<blockquote>
<p>I'll close this PR. We can still use it as a reference. I hope that's okay with you.</p>
</blockquote>
<p>No issue at all. I'd like to keep using this PR as a reference / discussion point to avoid going into a wrong direction.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:01:20 UTC
    </footer>
</body>
</html>
