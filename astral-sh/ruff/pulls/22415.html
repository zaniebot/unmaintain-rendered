<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Recognize string-literal types as subtypes of `Sequence[Literal[chars]]` - astral-sh/ruff #22415</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Recognize string-literal types as subtypes of <code>Sequence[Literal[chars]]</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22415">#22415</a>
        opened by <a href="https://github.com/jhartum">@jhartum</a>
        on 2026-01-06 09:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jhartum">@jhartum</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Implements https://github.com/astral-sh/ty/issues/2128: <code>Literal[&quot;abba&quot;]</code> is now recognized as a subtype of <code>Sequence[Literal[&quot;a&quot;, &quot;b&quot;]]</code>.</p>
<h2>Changes</h2>
<ul>
<li><strong>Add <code>KnownClass::Sequence</code></strong> - New known class for <code>typing.Sequence</code> (an ABC, not a protocol)</li>
<li><strong>Extend <code>has_relation_to_impl</code></strong> - When checking if a string literal is a subtype of <code>Sequence[X]</code>, verify that each unique character in the string is a subtype of <code>X</code></li>
<li><strong>Add mdtests</strong> - Cover positive cases, negative cases, and edge cases</li>
</ul>
<h2>Example</h2>
<pre><code class="language-python">from collections.abc import Sequence
from typing import Literal

def func(tags: Sequence[Literal[&quot;a&quot;, &quot;b&quot;]]) -&gt; None:
    pass

func(&quot;abba&quot;)  # Now OK - was incorrectly flagged as error
</code></pre>
<h2>Implementation Details</h2>
<p>The implementation in <code>has_relation_to_impl</code>:</p>
<ol>
<li>First tries the standard <code>str</code> fallback (for cases like <code>Sequence[str]</code>)</li>
<li>If that fails and the target is <code>Sequence[X]</code>, extracts unique characters from the string literal</li>
<li>Verifies each character is a subtype of <code>X</code> using <code>when_all</code> to properly accumulate constraints</li>
<li>Returns the combined constraint set</li>
</ol>
<p>Edge cases handled:</p>
<ul>
<li>Empty strings (always valid)</li>
<li>Unicode characters</li>
<li>Multi-char literals in element type (correctly rejected - <code>Literal[&quot;ab&quot;]</code> ≠ <code>Literal[&quot;a&quot;, &quot;b&quot;]</code>)</li>
</ul>
<h2>Test Plan</h2>
<ul>
<li>Added mdtests in <code>is_subtype_of.md</code></li>
<li>All existing mdtests pass</li>
</ul>
<p>Closes https://github.com/astral-sh/ty/issues/2128</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @jhartum on 2026-01-06 09:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @jhartum on 2026-01-06 09:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @jhartum on 2026-01-06 09:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @jhartum on 2026-01-06 09:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @MichaReiser on 2026-01-06 09:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-06 09:37</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2><a href="https://github.com/python/typing/blob/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance/">Typing conformance results</a></h2>
<p>No changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-06 09:38</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">tornado (https://github.com/tornadoweb/tornado)
- tornado/gen.py:255:62: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `None | Awaitable[Unknown] | list[Awaitable[Unknown]] | dict[Any, Awaitable[Unknown]] | Future[Unknown]`, found `_T@next | _VT@next | _T@next`
+ tornado/gen.py:255:62: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `None | Awaitable[Unknown] | list[Awaitable[Unknown]] | dict[Any, Awaitable[Unknown]] | Future[Unknown]`, found `_T@next | _T@next | _VT@next`

static-frame (https://github.com/static-frame/static-frame)
- static_frame/core/bus.py:671:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[Bus[Any], object_]`, found `InterGetItemLocReduces[Bus[Any] | Bottom[Index[Any]] | TypeBlocks | ... omitted 6 union elements, object_]`
+ static_frame/core/bus.py:671:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[Bus[Any], object_]`, found `InterGetItemLocReduces[Bus[Any] | Bottom[Index[Any]] | Bottom[Series[Any, Any]] | ... omitted 6 union elements, object_]`
- static_frame/core/node_selector.py:526:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[TVContainer_co@InterfaceSelectQuartet, Any]`, found `InterGetItemLocReduces[Unknown | Bottom[Series[Any, Any]], Any]`
+ static_frame/core/node_selector.py:526:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[TVContainer_co@InterfaceSelectQuartet, Any]`, found `InterGetItemLocReduces[Bottom[Series[Any, Any]] | Unknown, Any]`
- static_frame/core/series.py:4072:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[SeriesHE[Any, Any], TVDtype@SeriesHE]`, found `InterGetItemILocReduces[Bottom[Series[Any, Any]] | Bottom[Index[Any]] | TypeBlocks | ... omitted 7 union elements, TVDtype@SeriesHE]`
+ static_frame/core/series.py:4072:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[SeriesHE[Any, Any], TVDtype@SeriesHE]`, found `InterGetItemILocReduces[Bottom[Series[Any, Any]] | ndarray[Never, Never] | TypeBlocks | ... omitted 7 union elements, TVDtype@SeriesHE]`
- static_frame/core/yarn.py:418:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Yarn[Any], object_]`, found `InterGetItemILocReduces[Yarn[Any] | Bottom[Index[Any]] | TypeBlocks | ... omitted 6 union elements, object_]`
+ static_frame/core/yarn.py:418:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Yarn[Any], object_]`, found `InterGetItemILocReduces[Yarn[Any] | ndarray[Never, Never] | TypeBlocks | ... omitted 6 union elements, object_]`

core (https://github.com/home-assistant/core)
+ homeassistant/util/variance.py:47:12: error[invalid-return-type] Return type does not match returned value: expected `(**_P@ignore_variance) -&gt; _R@ignore_variance`, found `_Wrapped[_P@ignore_variance, _R@ignore_variance | int | float | datetime, _P@ignore_variance, _R@ignore_variance | int | float | datetime]`
- Found 14496 diagnostics
+ Found 14497 diagnostics


</code></pre>
</details>

<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/class.rs</code>:4840 on 2026-01-06 09:42</div>
            <div class="timeline-body"><p>This isn't correct — <code>Sequence</code> is an ABC, not a protocol. Among other things, that means that you can use it as the second argument to isinstance() or issubclass(). (You can see lots of new diagnostics in the ecosystem caused by this currently.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2026-01-06 09:43</div>
            <div class="timeline-body"><p>Thanks! I haven't looked in depth yet, just one thing I spotted</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by @MichaReiser on 2026-01-06 09:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-06 10:18</div>
            <div class="timeline-body"><!-- generated-comment ty ecosystem-analyzer -->

<h2><code>ecosystem-analyzer</code> results</h2>
<p>| Lint rule | Added | Removed | Changed |
|-----------|------:|--------:|--------:|
| <code>invalid-parameter-default</code> | 0 | 0 | 7 |
| <code>invalid-return-type</code> | 2 | 0 | 4 |
| <code>invalid-argument-type</code> | 2 | 1 | 2 |
| <code>unused-ignore-comment</code> | 0 | 2 | 0 |
| <strong>Total</strong> | <strong>4</strong> | <strong>3</strong> | <strong>13</strong> |</p>
<p><strong><a href="https://26b7efd1.ty-ecosystem-ext.pages.dev/diff">Full report with detailed diff</a></strong> (<a href="https://26b7efd1.ty-ecosystem-ext.pages.dev/timing">timing results</a>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jhartum">@jhartum</a> reviewed on 2026-01-06 10:40</div>
            <div class="timeline-body"><p>Thanks for catching this! Fixed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jhartum">@jhartum</a> on 2026-01-06 10:40</div>
            <div class="timeline-body"><blockquote>
<p>Thanks! I haven't looked in depth yet, just one thing I spotted</p>
</blockquote>
<p>Thanks for catching this! Fixed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "feat(ty): Recognize string literals as subtypes of Sequence[Literal[chars]]" to "[ty] Recognize string-literal types as subtypes of `Sequence[Literal[chars]]`" by @AlexWaygood on 2026-01-06 14:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2026-01-06 14:48</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2026-01-06 14:56</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<h2>Merging this PR will <strong>not alter performance</strong></h2>
<p><code>✅ 23</code> untouched benchmarks<br />
<code>⏩ 30</code> skipped benchmarks[^skipped]</p>
<hr />
<p><sub>Comparing <code>jhartum:feat/string-literal-sequence-subtype-v2</code> (528ded0) with <code>main</code> (57c98a1)</sub></p>
<a href="https://codspeed.io/astral-sh/ruff/branches/jhartum%3Afeat%2Fstring-literal-sequence-subtype-v2?utm_source=github&utm_medium=comment-v2&utm_content=button">
  <picture>
    <source media="(prefers-color-scheme: dark)" srcset="https://codspeed.io/pr-report/open-in-codspeed-dark.svg">
    <source media="(prefers-color-scheme: light)" srcset="https://codspeed.io/pr-report/open-in-codspeed-light.svg">
    <img alt="Open in CodSpeed" src="https://codspeed.io/pr-report/open-in-codspeed-light.svg" width="169" height="32">
  </picture>
</a>

<p>[^skipped]: 30 benchmarks were skipped, so the baseline results were used instead. If they were deleted from the codebase, <a href="https://codspeed.io/astral-sh/ruff/branches/jhartum%3Afeat%2Fstring-literal-sequence-subtype-v2?sectionId=benchmark-comparison-section-baseline-result-skipped&amp;utm_source=github&amp;utm_medium=comment-v2&amp;utm_content=archive">click here and archive them to remove them from the performance reports</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-06 14:59</div>
            <div class="timeline-body"><p>Uff. I think I know what I screwed up there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2026-01-06 15:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types/relation.rs</code>:986 on 2026-01-06 15:31</div>
            <div class="timeline-body"><p>Can we use <code>to_compact_string</code> here to avoid allocations?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2026-01-06 15:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/relation.rs</code>:986 on 2026-01-06 15:35</div>
            <div class="timeline-body"><p>thanks. I thought I tried that previously, but apparently not.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-06 17:09</div>
            <div class="timeline-body"><p>We may have to do a profiling run on Altair to see where we spend more time now. I suspect we run into lock contention because we keep re-interning the same characters over and over again (as string literals). It might be worth adding some debug logging to count how many <code>StringLiteral</code> types we created by character to see if there are any that stand out</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-06 17:23</div>
            <div class="timeline-body"><p>The optimisations I pushed got the time on the multithreaded benchmark down from 2.3s to 1.8s, so it's much better than it <em>was</em>... but a 23% performance regression is <em>obviously</em> far from ideal...</p>
<p>I have the same suspicion you do about the cause of the regression, but if that is the cause, what do we do about it? Can you think of any ways to avoid reinterning the same characters over and over here? I already pushed a change to only call <code>StringLiteralType::new()</code> on the characters after they've been deduplicated, to try to avoid the lock contention issues (and it did lead to a big speedup, but there's still an overall regression).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2026-01-06 17:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/relation.rs</code>:973 on 2026-01-06 17:24</div>
            <div class="timeline-body"><p>I suspect that by far the most effective optimization for this PR would be if we could find ways to narrow down the <code>_</code> in this match. Right now we are doing all this work to construct a new sequence-of-characters type anytime we compare a string literal type with anything other than <code>LiteralString</code> or <code>NominalInstance(str)</code> -- and this could happen quite often e.g. with construction of unions, not necessarily with explicit assignment attempts.</p>
<p>Using <code>_</code> here is nice and simple and tempting because it should always be correct to try this delegation -- but can we narrow it down further without losing any correct results? Like for instance, is the new sequence type ever going to be a subtype of anything that isn't a nominal instance type or a protocol?</p>
<p>Or another approach: what if we want this subtype relationship for assignability, but we actually don't care about simplifying a union of <code>Literal[&quot;abba&quot;] | Sequence[&quot;a&quot;, &quot;b&quot;]</code>? We could skip this branch if <code>relation</code> is redundant-with, and I suspect that would eliminate most of the regression.</p>
<p>Ultimately I think understanding this subtype relationship is pretty low priority (no other type checker does it), so if we can't do it without regression, we should consider not doing it at all.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2026-01-06 17:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/relation.rs</code>:973 on 2026-01-06 17:28</div>
            <div class="timeline-body"><blockquote>
<p>no other type checker does it</p>
</blockquote>
<p>Ah, I wasn't aware of that! I believed that they did, but you're right.</p>
<blockquote>
<p>if we can't do it without regression, we should consider not doing it at all.</p>
</blockquote>
<p>yeah, agreed</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2026-01-06 17:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/relation.rs</code>:973 on 2026-01-06 17:58</div>
            <div class="timeline-body"><p>Restricting the branch so that it was only <code>(Type::StringLiteral(value), Type::NominalInstance(...))</code> did not have any impact from my local measurements (though I applied it anyway; it makes sense).</p>
<p>Switching it so that the relation only applies for assignability had a huge difference, however.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/relation.rs</code>:1045 on 2026-01-06 18:05</div>
            <div class="timeline-body"><p>I think if we do it for assignability we should probably do it for subtyping as well? For fully static types I think it's important that assignability and subtyping stay equivalent.</p>
<p>I expect that specifically excluding is-redundant-with here would have the same impact, since subtyping is rarely used.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2026-01-06 18:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2026-01-06 18:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/relation.rs</code>:1045 on 2026-01-06 18:11</div>
            <div class="timeline-body"><blockquote>
<p>For fully static types I think it's important that assignability and subtyping stay equivalent.</p>
</blockquote>
<p>Why is assignability/subtyping consistency more important than assignability/redundancy consistency for fully static types? Because we use the subtyping relation in the generics solver, whereas we only use redundancy for simplifying unions?</p>
<p>Making the change you suggest here would introduce the first instance where the redundancy type relation would be less forgiving than the subtyping relation. I think it makes it much harder to reason about if we go there. And I'd have to go and rewrite a lot of this docstring: https://github.com/astral-sh/ruff/blob/ab1ac254d9750d23e489331e2a5c6ea08172632b/crates/ty_python_semantic/src/types/relation.rs#L87-L141</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2026-01-06 18:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/relation.rs</code>:1045 on 2026-01-06 18:15</div>
            <div class="timeline-body"><p>The latest version of this PR has no performance regression, so this is the last remaining question to resolve before it can be landed: https://codspeed.io/astral-sh/ruff/branches/jhartum%3Afeat%2Fstring-literal-sequence-subtype-v2?utm_source=github&amp;utm_medium=comment-v2&amp;utm_content=button</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2026-01-06 18:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2026-01-07 18:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/relation.rs</code>:1045 on 2026-01-07 18:52</div>
            <div class="timeline-body"><blockquote>
<p>Why is assignability/subtyping consistency more important than assignability/redundancy consistency for fully static types? Because we use the subtyping relation in the generics solver, whereas we only use redundancy for simplifying unions?</p>
</blockquote>
<p>Yes, because we use subtyping in various places where we need a definitive and theoretically consistent answer whether one type subsumes another, whereas redundancy is used only in union simplification. There is no correctness requirement that union simplification always remove types that could potentially be safely removed. In fact we have open issues already suggesting other cases where we might want union simplification to avoid removing some technically-redundant types. So I don't think the invariant that redundancy be &quot;more forgiving&quot; than subtyping is important for any particular reason, and I don't expect that invariant to last long anyway.</p>
<p>Maybe in the future this will demand a larger rewrite of that doc-comment (that doesn't say things like &quot;sits between&quot;), but I don't think the specific change here would demand a rewrite, just a brief aside about one particular pragmatic special-case exception.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-08 15:15</div>
            <div class="timeline-body"><p>The 5-10% memory usage increase is a bit concerning</p>
<p>Maybe a feature we should get back to in the future and drop for now?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bxff">@bxff</a> on 2026-01-09 17:44</div>
            <div class="timeline-body"><p>I think this should help with the memory regression. The issue is we're doing expensive character processing for <em>every</em> <code>StringLiteral</code> vs <code>NominalInstance</code> comparison, even when it's clearly not a sequence type.</p>
<p>Here's a quick fix that adds a cheap MRO check before any allocations:</p>
<pre><code class="language-diff">diff --git a/crates/ty_python_semantic/src/types/relation.rs b/crates/ty_python_semantic/src/types/relation.rs
index ab84708b65..e832ae59bf 100644
--- a/crates/ty_python_semantic/src/types/relation.rs
+++ b/crates/ty_python_semantic/src/types/relation.rs
@@ -3,6 +3,7 @@ use rustc_hash::FxHashSet;
 
 use crate::place::{DefinedPlace, Place};
 use crate::types::builder::RecursivelyDefined;
+use crate::types::class_base::ClassBase;
 use crate::types::constraints::{IteratorConstraintsExtension, OptionConstraintsExtension};
 use crate::types::enums::is_single_member_enum;
 use crate::types::{
@@ -1047,6 +1048,22 @@ impl&lt;'db&gt; Type&lt;'db&gt; {
                     return ConstraintSet::from(true);
                 }
 
+                if let Some(sequence_class) = KnownClass::Sequence.try_to_class_literal(db) {
+                    let is_sequence_subclass =
+                        sequence_class.iter_mro(db, None).any(|base| match base {
+                            ClassBase::Class(base_class) =&gt; {
+                                base_class.class_literal(db).0 == other_class.class_literal(db).0
+                            }
+                            _ =&gt; false,
+                        });
+
+                    if !is_sequence_subclass {
+                        return ConstraintSet::from(false);
+                    }
+                } else {
+                    return ConstraintSet::from(false);
+                }
+
                 let chars: FxHashSet&lt;char&gt; = value.value(db).chars().collect();
</code></pre>
<p>This cuts the memory overhead dramatically by only doing character interning when the target class is actually in the Sequence hierarchy. On the <code>attrs</code> benchmark: <strong>+61 MB → +10 MB</strong> (down to ~2.5% overhead from 16%). All 308 mdtests pass.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @AlexWaygood on 2026-01-18 16:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @AlexWaygood on 2026-01-18 17:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-18 17:42</div>
            <div class="timeline-body"><p>Thanks @bxff! I applied a variant of that and it did indeed solve the memory-usage regression.</p>
<p>This PR now applies consistent rules for assignability/subtyping/redundancy, does not add any new Salsa caching, does not have any reported memory-usage regressions, and does not have any reported performance regressions. So I think it's good to go.</p>
<p>Thanks @jhartum!! Sorry that this one turned out to be a bit more complicated than we initially expected.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2026-01-18 17:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2026-01-18 17:43</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-18 18:18:33 UTC
    </footer>
</body>
</html>
