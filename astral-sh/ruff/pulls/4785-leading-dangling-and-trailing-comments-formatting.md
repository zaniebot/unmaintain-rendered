```yaml
number: 4785
title: Leading, Dangling, and Trailing comments formatting
type: pull_request
state: merged
author: MichaReiser
labels:
  - internal
  - formatter
assignees: []
merged: true
base: main
head: format-leading-comments
created_at: 2023-06-01T14:21:42Z
updated_at: 2023-06-03T13:16:05Z
url: https://github.com/astral-sh/ruff/pull/4785
synced_at: 2026-01-12T03:50:03Z
```

# Leading, Dangling, and Trailing comments formatting

---

_Pull request opened by @MichaReiser on 2023-06-01 14:21_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This PR implements the basic leading, dangling, and trailing comments formatting and adds it to the `FormatNodeRule`. 

This PR does not yet formatt the content of the comment. This will be implemented in the next PR. 

<!-- What's the purpose of the change? What does it do, and why? -->

## Test Plan

The comments are now included in the formatted output, which is good. I wasn't able to really verify if they are all placed correctly because we only format top-level statements. 

I recommend that we fine tune the formatting when we have better coverage and know which comments are formatted incorrectly.

<!-- How was it tested? -->


---

_Comment by @MichaReiser on 2023-06-01 14:21_

Current dependencies on/for this PR:
* main
  * **PR #4783** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4783" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #4785** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4785" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
      * **PR #4786** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4786" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #4788** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4788" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #4803** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4803" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/charliermarsh/ruff/4785?utm_source=stack-comment).

---

_Review requested from @konstin by @MichaReiser on 2023-06-01 14:21_

---

_Label `internal` added by @MichaReiser on 2023-06-01 14:22_

---

_Label `autoformatter` added by @MichaReiser on 2023-06-01 14:22_

---

_@MichaReiser reviewed on 2023-06-01 14:23_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/context.rs`:78 on 2023-06-01 14:23_

I'm not super happy with this because it will require that any code that formats an indented block needs to set the level to `NodeLevel::Statement`. 

The reason why I introduced it is because the formatting logic needs to know whether two empty lines are acceptable or not (or any, in the case of parenthesized expressions)

---

_Comment by @github-actions[bot] on 2023-06-01 14:40_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     14.0Â±0.04ms     2.9 MB/sec    1.00     14.0Â±0.03ms     2.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.4Â±0.01ms     4.9 MB/sec    1.00      3.4Â±0.01ms     4.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    426.9Â±0.46Âµs     6.9 MB/sec    1.00    427.4Â±4.48Âµs     6.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.9Â±0.02ms     4.3 MB/sec    1.00      5.9Â±0.01ms     4.4 MB/sec
linter/default-rules/large/dataset.py      1.01      6.8Â±0.01ms     6.0 MB/sec    1.00      6.8Â±0.01ms     6.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1507.1Â±1.48Âµs    11.0 MB/sec    1.00   1501.4Â±4.32Âµs    11.1 MB/sec
linter/default-rules/numpy/globals.py      1.00    170.0Â±1.04Âµs    17.4 MB/sec    1.01    170.9Â±4.06Âµs    17.3 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.1Â±0.01ms     8.2 MB/sec    1.00      3.1Â±0.01ms     8.2 MB/sec
parser/large/dataset.py                    1.01      5.2Â±0.00ms     7.8 MB/sec    1.00      5.1Â±0.01ms     7.9 MB/sec
parser/numpy/ctypeslib.py                  1.01   1019.0Â±0.51Âµs    16.3 MB/sec    1.00   1009.1Â±1.20Âµs    16.5 MB/sec
parser/numpy/globals.py                    1.01    105.5Â±0.25Âµs    28.0 MB/sec    1.00    104.3Â±0.20Âµs    28.3 MB/sec
parser/pydantic/types.py                   1.01      2.2Â±0.00ms    11.4 MB/sec    1.00      2.2Â±0.00ms    11.5 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.01     23.0Â±0.98ms  1810.0 KB/sec    1.00     22.7Â±0.90ms  1834.4 KB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      5.7Â±0.27ms     2.9 MB/sec    1.00      5.7Â±0.28ms     2.9 MB/sec
linter/all-rules/numpy/globals.py          1.03   682.6Â±37.30Âµs     4.3 MB/sec    1.00   663.5Â±36.93Âµs     4.4 MB/sec
linter/all-rules/pydantic/types.py         1.01      9.6Â±0.43ms     2.7 MB/sec    1.00      9.5Â±0.41ms     2.7 MB/sec
linter/default-rules/large/dataset.py      1.00     11.0Â±0.38ms     3.7 MB/sec    1.00     11.0Â±0.42ms     3.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00      2.3Â±0.10ms     7.2 MB/sec    1.01      2.3Â±0.08ms     7.1 MB/sec
linter/default-rules/numpy/globals.py      1.02   278.9Â±17.23Âµs    10.6 MB/sec    1.00   273.9Â±15.02Âµs    10.8 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.9Â±0.20ms     5.2 MB/sec    1.02      5.0Â±0.22ms     5.1 MB/sec
parser/large/dataset.py                    1.03      8.6Â±0.25ms     4.7 MB/sec    1.00      8.4Â±0.30ms     4.8 MB/sec
parser/numpy/ctypeslib.py                  1.01  1650.0Â±74.84Âµs    10.1 MB/sec    1.00  1626.0Â±68.17Âµs    10.2 MB/sec
parser/numpy/globals.py                    1.01   167.8Â±11.29Âµs    17.6 MB/sec    1.00    165.6Â±8.74Âµs    17.8 MB/sec
parser/pydantic/types.py                   1.02      3.7Â±0.14ms     6.9 MB/sec    1.00      3.6Â±0.21ms     7.0 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/comments/format.rs`:170 on 2023-06-01 22:16_

My personal style is that I'd probably make `TopLevel` and `Statement` entirely separate branches, but again, it's personal...

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/comments/format.rs`:30 on 2023-06-01 22:16_

Why `.max(1)`? Should `empty_lines` not handle the truncation, etc.?

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/context.rs`:78 on 2023-06-01 22:22_

Will we need even more granular states here? E.g., Black has different rules for docstrings within classes vs. docstrings within functions (requires one newline for the former, _allows_ one newline for the latter):

```py
def f():
    """foo"""
    x = 1


class F:
    """foo"""

    x = 1
```

---

_@charliermarsh approved on 2023-06-01 22:23_

---

_@MichaReiser reviewed on 2023-06-02 06:16_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/context.rs`:78 on 2023-06-02 06:16_

Possibly, but I would prefer adding global state when possible (it comes at a cost that we need to snapshot the state and restore it if we ever add error handling support to the formatter). 

Away we could do docstring formatting without adding any additional global state is to:

* Get the first statement
* Test if it is a docstring
* If so, format it, and insert the appropriate number of newlines after
* Otherwise format it as usual



---

_Merged by @MichaReiser on 2023-06-02 07:26_

---

_Closed by @MichaReiser on 2023-06-02 07:26_

---

_Branch deleted on 2023-06-02 07:26_

---
