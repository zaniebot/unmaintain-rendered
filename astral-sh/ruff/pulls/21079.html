<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ruff] Implement union-with-annotated-type (RUF066) - astral-sh/ruff #21079</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ruff] Implement union-with-annotated-type (RUF066)</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21079">#21079</a>
        opened by <a href="https://github.com/wilt00">@wilt00</a>
        on 2025-10-26 03:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/wilt00">@wilt00</a></div>
            <div class="timeline-body">

Summary
<p>This PR implements a new rule, nested-annotated-type, as discussed in #21037 . This rule fails for type definitions including <code>Annotated</code> nested within some other type.</p>
Test Plan
<p>New snapshosts in <code>RUF066.py</code> with <code>cargo insta test</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-27 16:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-27 16:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-30 13:50</div>
            <div class="timeline-body"><p>I think this rule makes sense to me (catching <code>Annotated[...] | ...</code>) and I&#x27;d be in favor adding it because it catches a very likely mistake. But I&#x27;d be curious to hear @amyreese&#x27;s opinion, too, just to ensure I&#x27;m not overlooking any valid use cases for this.</p>
<p>I do think we should come up with a less cryptic name :). We certainly can&#x27;t use the nested terminology because the annotated documentation uses that to refer to <code>Annotated[Annotated]</code> nesting</p>
<blockquote>
<p>Nested Annotated types are flattened. The order of the metadata elements starts with the innermost annotation:
https://docs.python.org/3/library/typing.html#typing.Annotated</p>
</blockquote>
<p>Maybe something like <code>type-operation-with-annotated</code> or <code>mixed-annotated-regular-type</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amyreese">@amyreese</a> on 2025-10-30 22:26</div>
            <div class="timeline-body"><p>I agree that it&#x27;s a useful rule â€”Â I&#x27;m not aware of any case where you would want to use an <code>Annotated</code> type with anything, let alone nest <code>Annotated</code> inside of anything other than another <code>Annotated</code> type.</p>
<p>For names I prefer <code>mixed-annotated-regular-type</code> over the other suggestion, but I might instead name it <code>union-with-annotated-type</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-30 22:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF066.py</code>:6 on 2025-10-30 22:32</div>
            <div class="timeline-body"><p>What&#x27;s the reason why this is an error?</p>
<p>I&#x27;m asking because I like the name <code>union-with-annotated-type</code> but the name requires that it only detects usages of <code>Annotated</code> with <code>Union</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF066.py</code>:6 on 2025-10-30 22:43</div>
            <div class="timeline-body"><blockquote>
<p>What&#x27;s the reason why this is an error?</p>
<p>I&#x27;m asking because I like the name <code>union-with-annotated-type</code> but the name requires that it only detects usages of <code>Annotated</code> with <code>Union</code></p>
</blockquote>
<p>Assuming you&#x27;re asking about the <code>Optional</code> example, that&#x27;s functionally equivalent to <code>Union[Annotated[...], None]</code>, and it&#x27;s still treated as a union in Python types. It&#x27;s just a convenience because <code>Optional[X]</code> is more readable than <code>Union[X, None]</code>, though once <code>|</code> was allowed, everything converged on <code>X | None</code> rather than a dedicated syntax for optionals.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> reviewed on 2025-10-30 22:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/wilt00">@wilt00</a> reviewed on 2025-10-30 22:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/wilt00">@wilt00</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF066.py</code>:6 on 2025-10-30 22:52</div>
            <div class="timeline-body"><p>Exactly, yes. <code>union-with-annotated-type</code> is my favorite of the suggested names as well - do you think it&#x27;s common enough knowledge that optional is a subtype of union for that name to work? I can also clarify that in the diagnostic text.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> reviewed on 2025-10-30 22:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF066.py</code>:6 on 2025-10-30 22:55</div>
            <div class="timeline-body"><p>I do think it&#x27;s common enough knowledgeÂ â€”Â and the context of the lint rule IMO helps bridge the gap for anyone unfamiliar â€” and as more projects move from <code>Optional[X]</code> to <code>X | None</code>, it becomes less and less of a concern.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/wilt00">@wilt00</a> reviewed on 2025-10-30 23:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/wilt00">@wilt00</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF066.py</code>:6 on 2025-10-30 23:18</div>
            <div class="timeline-body"><p>Sounds good. Are there other generic types that don&#x27;t derive from Union that it makes sense to flag in this rule? Looking down the list of members of typing, Final is the only one that I feel could possibly fit and that&#x27;s a stretch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-30 23:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF066.py</code>:6 on 2025-10-30 23:19</div>
            <div class="timeline-body"><p>Ah right, thanks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-30 23:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> reviewed on 2025-10-30 23:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF066.py</code>:6 on 2025-10-30 23:33</div>
            <div class="timeline-body"><p>I think it&#x27;s reasonable to keep the rule relatively small in scope. I also think it&#x27;s unlikely that someone would add <code>Final</code> or other type composition &quot;by accident&quot; the way they might with unions/optionals, not to mention being harder to reason about whether that&#x27;s intended behavior or a potential bug.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[ruff] Implement nested-annotated-type (RUF066)&quot; to &quot;[ruff] Implement union-with-annotated-type (RUF066)&quot; by <a href="https://github.com/wilt00">@wilt00</a> on 2025-11-01 21:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/amyreese">@amyreese</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-04 21:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-11-05 22:25</div>
            <div class="timeline-body"><p>I&#x27;ll leave the main review to @amyreese, but this looks reasonable overall to me. Would you mind re-numbering the rule to RUF068? We have existing PRs for <a href="https://github.com/astral-sh/ruff/pull/9911">RUF066</a> and <a href="https://github.com/astral-sh/ruff/pull/20585">RUF067</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-11-05 22:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF066.py</code>:18 on 2025-11-13 22:39</div>
            <div class="timeline-body"><p>This being an error implies that <code>list[Annotated[...]]</code> or similar would also produce an error. That part seems fine to me, but I wonder if it would be worth having a separate error message for these cases since the mention of union/optional doesn&#x27;t make sense here? Would also like to have test cases showing that behavior one way or the other.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/rules/ruff/rules/union_with_annotated_type.rs</code>:49 on 2025-11-13 22:39</div>
            <div class="timeline-body"><p>Needs a bump as well ðŸ˜…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> requested changes on 2025-11-13 22:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CoderJoshDK">@CoderJoshDK</a> on 2025-12-16 16:43</div>
            <div class="timeline-body"><p>Hey, I see this PR has not had any movement in the last month. If you don&#x27;t mind, I think I am going to pick it up. I will include the original commits (rebased with main) and update based on the included comments. I hope I am not stepping on your toes with this.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:19:53 UTC
    </footer>
</body>
</html>
