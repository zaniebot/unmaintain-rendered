<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add check for W292 - astral-sh/ruff #339</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add check for W292</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/339">#339</a>
        opened by <a href="https://github.com/cnpryer">@cnpryer</a>
        on 2022-10-07 05:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cnpryer">@cnpryer</a></div>
            <div class="timeline-body"><p>This adds <code>W292 No newline at end of file</code>.</p>
<p>It's real late where I am, so I'm opening as a draft to come back to this tomorrow with a fresh mind. First time I'm interacting with the codebase.</p>
<p>A few notes:</p>
<ul>
<li>~~I wasn't sure where to start adding these <em>additional</em> style checks. So I just kind of referred to them as &quot;More style&quot;.~~</li>
<li>~~I also added this as a default. Not sure if that's what you're expecting.~~</li>
<li>~~I didn't think it made sense to add as an AST check.~~</li>
<li>~~This will add a bunch of noise to <code>cargo run resources/test/fixtures --no-cache</code> since a bunch of other fixtures may not contain a new line at the end.~~</li>
<li>~~I may have incomplete <code>noqa</code> handling (part of why I need to go to sleep lol).~~</li>
<li>~~I <em>think</em> there's a combo of anyhow and .expect for error handling here. I tried using .expect for the .last, but it was failing when running the fixtures in resources/. I just let it not eval if it fails to collect &quot;last&quot; from <code>lines</code>.~~</li>
<li>~~Clippy was yelling at me for unrelated .or_insert usage.~~</li>
</ul>
<p>Notes have been resolved. Ty!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cnpryer">@cnpryer</a> on 2022-10-07 05:40</div>
            <div class="timeline-body"><p>For posterity.. tag #170</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-10-07 12:25</div>
            <div class="timeline-body"><p>Awesome, thanks for putting this together, will review today!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cnpryer">@cnpryer</a> on 2022-10-07 18:45</div>
            <div class="timeline-body"><p>No rush! I want to reduce the amount of time you spend reviewing this, so I can mark it ready for review after I feel like it's worth your time to look at.</p>
<p>I intentionally chose to start with an easy one to get familiar with the codebase lol</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/check_lines.rs</code>:205 on 2022-10-07 18:50</div>
            <div class="timeline-body"><p>Mind moving this into <code>if !line.is_empty() { ... }</code> below? No need to instantiate it unless we're going to push it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/check_lines.rs</code>:197 on 2022-10-07 18:50</div>
            <div class="timeline-body"><p>Alternatively, you could do:</p>
<pre><code class="language-rust">if let Some(line) = lines.last() {
  ...
}
</code></pre>
<p>(Since we're never gonna trigger the rule if we have no lines.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/check_lines.rs</code>:194 on 2022-10-07 18:53</div>
            <div class="timeline-body"><p>You can remove <code>!enforce_noqa</code>, which is used for something else. You <em>do</em> need to check if the last line has a <code>noqa</code> for W292. I'm also happy to add that in a second pass since the logic can be a little tricky. But the gist of it is:</p>
<pre><code class="language-rust">let lineno = lines.len() - 1;
let 
let noqa_lineno = noqa_line_for
    .get(lineno)
    .map(|lineno| lineno - 1)
    .unwrap_or(lineno);
let check = Check::new(
    CheckKind::NoNewLineAtEndOfFile,
    Range {
        location: Location::new(lines.len(), line.len() + 1),
        end_location: Location::new(lines.len(), line.len() + 1),
    },
);
match noqa {
    (Directive::All(_, _), matches) =&gt; {
        matches.push(check.kind.code().as_str());
    }
    (Directive::Codes(_, _, codes), matches) =&gt; {
        if codes.contains(&amp;check.kind.code().as_str()) {
            matches.push(check.kind.code().as_str());
        } else {
            line_checks.push(check);
        }
    }
    (Directive::None, _) =&gt; line_checks.push(check),
}
</code></pre>
<p>(Or something like that...)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-10-07 18:53</div>
            <div class="timeline-body"><blockquote>
<p>I wasn't sure where to start adding these additional style checks. So I just kind of referred to them as &quot;More style&quot;.</p>
</blockquote>
<p>Let's put them just after the <code>E***</code> rules. They're still style rules, it's just that <code>pycodestyle</code> considers them to be warnings rather than errors.</p>
<blockquote>
<p>I also added this as a default. Not sure if that's what you're expecting.</p>
</blockquote>
<p>That sounds fine to me.</p>
<blockquote>
<p>I didn't think it made sense to add as an AST check.</p>
</blockquote>
<p>Correct, this should be enforced in <code>check_lines</code> like you've done above.</p>
<blockquote>
<p>This will add a bunch of noise to cargo run resources/test/fixtures --no-cache since a bunch of other fixtures may not contain a new line at the end.</p>
</blockquote>
<p>That's ok. There's already a lot of noise when running <code>cargo run resources/test/fixtures</code>. Each of those fixtures is meant to be run with <code>--select</code>, like <code>cargo run resources/test/fixtures/F401.py --select F401</code>.</p>
<blockquote>
<p>I may have incomplete noqa handling (part of why I need to go to sleep lol).</p>
</blockquote>
<p>Yeah it looks like the <code>noqa</code> for this rule should be on the last line -- so the file would be, like:</p>
<pre><code class="language-py">x = 1  # noqa
</code></pre>
<blockquote>
<p>Clippy was yelling at me for unrelated .or_insert usage.</p>
</blockquote>
<p>Hmm, maybe we have different versions. What you have seems good, so I'll upstream that real quick.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-10-07 18:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-10-07 18:54</div>
            <div class="timeline-body"><p>Oh heh, too late, I just reviewed it! :) Let me know if you have any questions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/cnpryer">@cnpryer</a> on <code>src/check_lines.rs</code>:197 on 2022-10-07 22:45</div>
            <div class="timeline-body"><p>It's funny. This is what I had originally. Will do.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cnpryer">@cnpryer</a> reviewed on 2022-10-07 22:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cnpryer">@cnpryer</a> reviewed on 2022-10-07 22:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/cnpryer">@cnpryer</a> on <code>src/check_lines.rs</code>:194 on 2022-10-07 22:47</div>
            <div class="timeline-body"><p>Yea i noticed this from a check above. I think I was thinking of how I could do something similar without slapping in redundant code, and I didn't feel confident introducing a refactor. So I must of misunderstood <code>enforce_noqa</code>. I'll see if I can wrap my head around this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cnpryer">@cnpryer</a> on 2022-10-07 22:48</div>
            <div class="timeline-body"><blockquote>
<p>Oh heh, too late, I just reviewed it! :) Let me know if you have any questions.</p>
</blockquote>
<p>Well I'm happy you did. Very helpful.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cnpryer">@cnpryer</a> reviewed on 2022-10-07 23:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/cnpryer">@cnpryer</a> on <code>src/check_lines.rs</code>:194 on 2022-10-07 23:16</div>
            <div class="timeline-body"><p>So that was pretty much it. Only a couple things seemed to be needed in addition:</p>
<ol>
<li>Adding</li>
</ol>
<pre><code class="language-rs">let noqa = noqa_directives
    .entry(noqa_lineno)
    .or_insert_with(|| (noqa::extract_noqa_directive(lines[noqa_lineno]), vec![]));
</code></pre>
<p>which if I understand is noqa indicators potentially used and/or related to the check that we need to attempt to match on? It does feels a little black-magic-like at the moment, but I think at a high level I understand what's going on here. I think if I understand the Directives better it'll clear up.</p>
<ol start="2">
<li><code>noqa_directives</code> was moved in the &quot;Enforce that the noqa directive was actually used&quot; piece. So I needed to move the check above it.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @cnpryer on 2022-10-07 23:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/check_lines.rs</code>:194 on 2022-10-08 01:08</div>
            <div class="timeline-body"><p>Yeah the noqa stuff is a little confusing. There are two main pieces to it:</p>
<ol>
<li>It's not always the case that a <code>noqa</code> for a given line of code comes at the end of that line. For example, with multi-line strings, we want the <code>noqa</code> to come after the string, but to apply to the <em>entire</em> string. So we have to do some bookkeeping, to map &quot;line in the code&quot; to &quot;line at which the noqa for that line should appear&quot;. (This is the <code>noqa_line_for</code> vector, which is really a map.)</li>
<li>We have to extract the <code>noqa</code> directive from each line, and we do that lazily, hence the <code>noqa_directives</code> map.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-10-08 01:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-10-08 01:08</div>
            <div class="timeline-body"><p>Thank you for this! Great PR, much appreciated.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-10-08 01:09</div>
            <div class="timeline-body"><p>I tried to add autofix but I think the <code>fixer</code> has an issue with empty newlines or something (some kind of edge case). It'll have to come later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2022-10-08 01:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2022-10-08 01:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2022-10-08 01:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:54:40 UTC
    </footer>
</body>
</html>
