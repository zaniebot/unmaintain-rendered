<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-bugbear`] Flag mutable defaults passed via named variables, excluding UPPER_CASE (`B006`) - astral-sh/ruff #21189</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-bugbear</code>] Flag mutable defaults passed via named variables, excluding UPPER_CASE (<code>B006</code>)</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21189">#21189</a>
        opened by <a href="https://github.com/danparizher">@danparizher</a>
        on 2025-11-01 19:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/danparizher">@danparizher</a> on 2025-11-01 19:16</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes #21142</p>
<p>B006 now flags mutable defaults passed via module-level named constants. Previously, it only flagged inline mutable defaults (e.g., <code>{}</code>, <code>[]</code>, <code>set()</code>), missing cases where the default references a module-level constant bound to a mutable object (e.g., <code>MY_SET = {&quot;ABC&quot;, &quot;DEF&quot;}</code>).</p>
<h2>Problem Analysis</h2>
<p>B006’s detection was syntax-local and didn’t resolve identifiers to check mutability. When a default used a name like <code>MY_SET</code>, it wasn’t resolved to the bound mutable object, causing false negatives.</p>
<p><strong>Example:</strong></p>
<pre><code class="language-python">MY_SET = {&quot;ABC&quot;, &quot;DEF&quot;}  # module-level mutable constant

def func_A(s: set[str] = MY_SET):  # Not flagged (should be flagged)
    return s

def func_B(s: set[str] = {&quot;ABC&quot;, &quot;DEF&quot;}):  # Correctly flagged
    return s
</code></pre>
<p>This is a false negative because <code>func_A</code> and <code>func_B</code> share the same mutable default object.</p>
<h2>Approach</h2>
<p>Extended <code>is_guaranteed_mutable_expr</code> (used in preview mode) to handle <code>Expr::Name</code>:</p>
<ol>
<li>Resolve the identifier using <code>semantic.only_binding()</code> to get the binding.</li>
<li>Require an assignment binding (not imports, parameters, etc.).</li>
<li>Extract the assigned value via <code>find_binding_value()</code>.</li>
<li>Recursively check if that value is mutable using <code>is_guaranteed_mutable_expr()</code>.</li>
</ol>
<p>This enables detecting cases like:</p>
<ul>
<li><code>MY_SET = {&quot;ABC&quot;, &quot;DEF&quot;}</code> → flagged when used as a default</li>
<li><code>MY_LIST = [1, 2, 3]</code> → flagged when used as a default</li>
<li><code>MY_DICT = {&quot;key&quot;: &quot;value&quot;}</code> → flagged when used as a default</li>
</ul>
<p>The fix is enabled only in preview mode. Non-preview mode preserves existing behavior (only flags inline mutable defaults).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-11-01 19:27</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+1 -0 violations, +0 -0 fixes in 1 projects; 54 projects unchanged)</p>
<details><summary><a href="https://github.com/mlflow/mlflow">mlflow/mlflow</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ docs/docs/genai/flavors/dspy/notebooks/dspy_quickstart.ipynb:cell 23:1:58: B006 Do not use mutable data structures for argument defaults
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| B006 | 1 | 1 | 0 | 0 | 0 |</p>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BlindChickens">@BlindChickens</a> on 2025-11-04 13:56</div>
            <div class="timeline-body"><p>This brings the rule more in line with the pylint rule it is supposed to represent/replace. <code>dangerous-default-value (W0102)</code>
Lets get it merged.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-10 13:10</div>
            <div class="timeline-body"><p>Hmm, I'm not sure I agree with this change. The <code>UPPER_CASE</code> indicates a constant:</p>
<blockquote>
<p>Constants are usually defined on a module level and written in all capital letters with underscores separating words. Examples include MAX_OVERFLOW and TOTAL.
https://peps.python.org/pep-0008/#constants</p>
</blockquote>
<p>I think it makes sense to assume that those variables are read-only by default.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @MichaReiser on 2025-11-10 13:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-11-10 13:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_bugbear/rules/mutable_argument_default.rs</code>:159 on 2025-11-10 13:15</div>
            <div class="timeline-body"><p>This is interesting. That means using <code>a = imported.MY_LIST</code> is fine but using <code>MY_LIST</code> in the module itself isn't.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-10 13:26</div>
            <div class="timeline-body"><p>I'm not sure if I agree with this change. Especially because the proposed fix doesn't really help.</p>
<p><code>ALL_UPPERCASE</code> names in Python are considered constants. That's why I think using them in a default value position is fine. The only risk really is that the function body might change the value, which in turn changes the constant.</p>
<pre><code class="language-py">A = [1, 2, 3]

def test(a = A): a.append(3) # changes `A`
</code></pre>
<p>But this is still the case even when applying the proposed fix:</p>
<pre><code class="language-py">&gt;&gt;&gt; def test(a):
...     if a is None:
...         a = A
...     a.append(4) # changes `A`
...
</code></pre>
<p>We should at least update the fix to something that actually fixes the underlying problem, e.g. by changing the type annotation to <code>typing.Sequence</code> or making a deep copy (but that also seems undesired). Overall, this seems to require more design</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2025-11-10 13:26</div>
            <div class="timeline-body"><p>See my other comment</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/danparizher">@danparizher</a> on 2025-11-10 21:27</div>
            <div class="timeline-body"><p>Thanks for the feedback, I've updated the implementation to exclude <code>UPPER_CASE</code> constants from being flagged,</p>
<p>Since we're no longer flagging that, no fix is suggested for them, which avoids the underlying mutation problem. For inline mutable defaults, the current fix works because it creates a new object per call.</p>
<p>Maybe what we can do is when flagging a constant like <code>MY_LIST</code>, we could suggest using <code>MY_LIST.copy()</code> or <code>copy.deepcopy(MY_LIST)</code> to create a new instance, or suggest changing the type annotation to <code>Sequence[int]</code> to indicate immutability.</p>
<p>We could also analyze the function body to detect if the argument is mutated and suggest appropriate fixes—if it's only read, suggest <code>Sequence</code>/<code>Mapping</code> types; if it's mutated, suggest copies or immutable alternatives like <code>tuple</code> or <code>frozenset</code>.</p>
<p>This would require more design work as you noted, but could be a good follow-up. For now, I think excluding <code>UPPER_CASE</code> constants seems like the right pragmatic approach.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @amyreese on 2025-11-26 01:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @amyreese on 2025-11-26 01:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_bugbear/rules/mutable_argument_default.rs</code>:153 on 2025-11-26 08:38</div>
            <div class="timeline-body"><p>I think this comment here is inaccurate as it doesn't just resolve module level constants:</p>
<ul>
<li>It resolves constants and non constants</li>
<li>It resolves any name in the current scope</li>
</ul>
<p>We should add at least one test demonstrating the behavior with a nested function that reads a value from the outer scope.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_bugbear/rules/mutable_argument_default.rs</code>:159 on 2025-11-26 08:39</div>
            <div class="timeline-body"><p>Can you explain the motivation for this restriction?</p>
<p>We should also add tests that demonstrate this behavior</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_bugbear/B006_10.py</code>:6 on 2025-11-26 08:40</div>
            <div class="timeline-body"><p>The comment here is a bit misleading. PEP8 doesn't specify that this rule should exclude constants. Instead, PEP8 specifies that UPPER_CASE variables are considered constants.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-11-26 08:40</div>
            <div class="timeline-body"><p>I've a few more inline comments. Could you also update the PR title and summary to reflect your most recent changes?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/danparizher">@danparizher</a> on 2025-11-29 05:07</div>
            <div class="timeline-body"><p>The assignment restriction ensures we only flag cases where mutable objects are explicitly assigned at definition time (which are then shared across calls), avoiding false positives from imports (external dependencies) and function parameters (runtime values evaluated per call).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`flake8-bugbear`] Flag mutable defaults passed via named constants (`B006`)" to "[`flake8-bugbear`] Flag mutable defaults passed via named variables, excluding UPPER_CASE (`B006`)" by @danparizher on 2025-11-29 05:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @danparizher on 2025-11-29 05:31</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:48:27 UTC
    </footer>
</body>
</html>
