<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply formatting to markdown code blocks - astral-sh/ruff #22470</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Apply formatting to markdown code blocks</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22470">#22470</a>
        opened by <a href="https://github.com/amyreese">@amyreese</a>
        on 2026-01-09 01:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a></div>
            <div class="timeline-body"><p>Adds initial support for formatting Python code blocks inside Markdown files.</p>
<ul>
<li>Adds <code>Markdown</code> source types/kinds</li>
<li>Maps <code>.md</code> file extension to <code>Markdown</code> by default</li>
<li>Uses simple regex adapted from blacken-docs to find and format fenced python code blocks</li>
<li>Dedents contents before formatting, and reapplies indent from fenced <code>```py</code> header</li>
<li>Selects <code>Python</code> vs <code>Stub</code> options based on language label on code block</li>
<li>Silently skips formatting for any code block with syntax errors or that produce formatting errors.</li>
<li>CLI tests formatting via both stdin and from filesystem</li>
<li>Requires running with <code>--preview</code>, and otherwise warns user and skips formatting when given a markdown file</li>
<li>Requires a user to <code>extend-include = [&quot;**/*.md&quot;]</code> if they want to format markdown files by default</li>
</ul>
<p>Limitations:</p>
<ul>
<li>Raises <code>unimplemented!()</code> if run with a range of any sort</li>
<li>Ignores unlabeled code blocks or implicit code blocks (no code fence)</li>
<li>Doesn&#x27;t yet support <code>~~~</code> fences, arbitrary fence lengths, or code blocks inside blockquotes</li>
</ul>
<p>Issue #3792</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-09 01:39</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Ruffen docs prototype&quot; to &quot;WIP: Ruffen docs prototype&quot; by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-09 16:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-13 02:21</div>
            <div class="timeline-body"><p>minimal working prototype using regex adapted from blacken-docs:</p>
<pre><code>amethyst@lunatone ~/workspace/ruff amy/ruffen-docs » cat ~/scratch/test.md
Hello, this is a *markdown* document.

This is a rust code block:

```rust
fn main() {
    for x in 0..10 {
        println!(&quot;x = {x}&quot;);
    }
}
```

This is a poorly formatted python code block:

```py
def foo(arg1,
           arg2):
    print( &quot;hello world&quot;)



foo(1 , 2)
```

This is another python code block, also poorly formatted, but now in a list:

1. List item 1
2. List item 2

    ```python
    dataset = [1, 2, 3,
        4, 5, 6]
    if 1+2==3:
        print(&#x27;yes&#x27;)
    ```

And here&#x27;s an unlabeled code block that happens to have valid python code — what do we do?

```
print(&quot;hello&quot;)
```

amethyst@lunatone ~/workspace/ruff amy/ruffen-docs » cargo run -p ruff -- format --no-cache --diff ~/scratch/test.md
   Compiling ruff v0.14.11 (/Users/amethyst/workspace/ruff/crates/ruff)
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 1.66s
     Running `target/debug/ruff format --no-cache --diff /Users/amethyst/scratch/test.md`
--- /Users/amethyst/scratch/test.md
+++ /Users/amethyst/scratch/test.md
@@ -13,13 +13,11 @@
 This is a poorly formatted python code block:

 ```py
-def foo(arg1,
-           arg2):
-    print( &quot;hello world&quot;)
+def foo(arg1, arg2):
+    print(&quot;hello world&quot;)


-
-foo(1 , 2)
+foo(1, 2)
 ```

 This is another python code block, also poorly formatted, but now in a list:
@@ -28,10 +26,9 @@
 2. List item 2

     ```python
-    dataset = [1, 2, 3,
-        4, 5, 6]
-    if 1+2==3:
-        print(&#x27;yes&#x27;)
+    dataset = [1, 2, 3, 4, 5, 6]
+    if 1 + 2 == 3:
+        print(&quot;yes&quot;)
     ```

 And here&#x27;s an unlabeled code block that happens to have valid python code — what do we do?

1 file would be reformatted
&gt; [1]

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-13 02:25</div>
            <div class="timeline-body"><p>Some notes on the regex adapted from blacken-docs:</p>
<ul>
<li>it does not support <code>~~~</code> delimited code blocks</li>
<li>it does not support code blocks delimited by more than three backticks/tildes</li>
<li>it does verify that indentation and the end delimiter matches the starting delimiter</li>
</ul>
<p>Prototype also silently discards any formatting error, and those should either be warnings or get tracked somehow to re-raise them outside of the closure.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-13 02:25</div>
            <div class="timeline-body"><p>Also need to decide on if/how to gate this behind <code>--preview</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-20 21:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/ntBre">@ntBre</a> by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-20 21:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;WIP: Ruffen docs prototype&quot; to &quot;Apply formatting to markdown code blocks&quot; by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-20 21:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-20 22:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-20 22:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-20 22:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-20 22:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-20 22:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dhruvmanila">@dhruvmanila</a> by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-20 22:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amyreese">@amyreese</a> on 2026-01-20 22:58</div>
            <div class="timeline-body"><p>Not familiar enough with ty to know why this changed what files ty looks at, or how to make ty ignore the md files when loading the project.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 23:54:08 UTC
    </footer>
</body>
</html>
