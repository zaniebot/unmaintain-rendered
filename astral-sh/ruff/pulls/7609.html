<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avoid reordering mixed-indent-level comments after branches - astral-sh/ruff #7609</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Avoid reordering mixed-indent-level comments after branches</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7609">#7609</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-09-22 19:09
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-22 19:09</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Given:</p>
<pre><code class="language-python">if True:
    if True:
        if True:
            pass

        #a
            #b
        #c
else:
    pass
</code></pre>
<p>When determining the placement of the various comments, we compute the indentation depth of each comment, and then compare it to the depth of the previous statement. It turns out this can lead to reordering comments, e.g., above, <code>#b</code> is assigned as a trailing comment of <code>pass</code>, and so gets reordered above <code>#a</code>.</p>
<p>This PR modifies the logic such that when we compute the indentation depth of <code>#b</code>, we limit it to at most the indentation depth of <code>#a</code>. In other words, when analyzing comments at the end of branches, we don't let successive comments go any <em>deeper</em> than their preceding comments.</p>
<p>Closes https://github.com/astral-sh/ruff/issues/7602.</p>
<h2>Test Plan</h2>
<p><code>cargo test</code></p>
<p>No change in similarity.</p>
<p>Before:</p>
<p>| project      | similarity index  | total files       | changed files     |
|--------------|------------------:|------------------:|------------------:|
| cpython      |           0.76083 |              1789 |              1631 |
| django       |           0.99983 |              2760 |                36 |
| transformers |           0.99963 |              2587 |               319 |
| twine        |           1.00000 |                33 |                 0 |
| typeshed     |           0.99979 |              3496 |                22 |
| warehouse    |           0.99967 |               648 |                15 |
| zulip        |           0.99972 |              1437 |                21 |</p>
<p>After:</p>
<p>| project      | similarity index  | total files       | changed files     |
|--------------|------------------:|------------------:|------------------:|
| cpython      |           0.76083 |              1789 |              1631 |
| django       |           0.99983 |              2760 |                36 |
| transformers |           0.99963 |              2587 |               319 |
| twine        |           1.00000 |                33 |                 0 |
| typeshed     |           0.99979 |              3496 |                22 |
| warehouse    |           0.99967 |               648 |                15 |
| zulip        |           0.99972 |              1437 |                21 |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @charliermarsh on 2023-09-22 19:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2023-09-22 19:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-09-22 19:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @charliermarsh on 2023-09-22 19:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-22 19:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:821 on 2023-09-22 19:09</div>
            <div class="timeline-body"><p>Hmm, is there an easier way to access the comments that we care about here, rather than re-lexing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-22 19:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/tests/snapshots/format@statement__if.py.snap</code>:558 on 2023-09-22 19:09</div>
            <div class="timeline-body"><p>This is a good change, IMO -- the previous result was reordering comments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-22 19:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:821 on 2023-09-22 19:14</div>
            <div class="timeline-body"><p>We could pass in the in-building comment map, but that would break isolation quite a bit</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-22 19:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:821 on 2023-09-22 19:17</div>
            <div class="timeline-body"><p>we wouldn't even the lexer here, just the first non-whitespace position, i'm not sure though if manual is better here than the simple tokenizer</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-09-22 19:18</div>
            <div class="timeline-body"><p>i can't come up with a better solution</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-09-22 22:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-09-22 22:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-09-22 22:12</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 02:39:47 UTC
    </footer>
</body>
</html>
