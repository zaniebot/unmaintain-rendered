<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add background request task support - astral-sh/ruff #19041</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add background request task support</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19041">#19041</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2025-06-30 05:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-06-30 05:43</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR adds a new trait to support running a request in the background.</p>
<p>Currently, there exists a <code>BackgroundDocumentRequestHandler</code> trait which is similar but is scoped to a specific document (file in an editor context). The new trait <code>BackgroundRequestHandler</code> is not tied to a specific document nor a specific project but it's for the entire workspace.</p>
<p>This is added to support running workspace wide requests like computing the <a href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#workspace_diagnostic">workspace diagnostics</a> or <a href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#workspace_symbol">workspace symbols</a>.</p>
<p><strong>Note:</strong> There's a slight difference with what a &quot;workspace&quot; means between the server and ty. Currently, there's a 1-1 relationship between a workspace in an editor and the project database corresponding to that workspace in ty but this could change in the future when Micha adds support for multiple workspaces or multi-root workspaces.</p>
<p>The data that would be required by the request handler (based on implementing workspace diagnostics) is the list of databases (<code>ProjectDatabse</code>) corresponding to the projects in the workspace and the index (<code>Index</code>) that contains the open documents. The <code>WorkspaceSnapshot</code> represents this and is passed to the handler similar to <code>DocumentSnapshot</code>.</p>
<h2>Test Plan</h2>
<p>This is used in implementing the workspace diagnostics which is where this is tested.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dhruvmanila on 2025-06-30 05:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2025-06-30 05:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dhruvmanila on 2025-06-30 05:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @dhruvmanila on 2025-06-30 05:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @dhruvmanila on 2025-06-30 05:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @dhruvmanila on 2025-06-30 05:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @dhruvmanila on 2025-06-30 05:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-30 05:46</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">operator (https://github.com/canonical/operator)
- TOTAL MEMORY USAGE: ~106MB
+ TOTAL MEMORY USAGE: ~97MB

trio (https://github.com/python-trio/trio)
-     memo fields = ~156MB
+     memo fields = ~142MB

isort (https://github.com/pycqa/isort)
- TOTAL MEMORY USAGE: ~80MB
+ TOTAL MEMORY USAGE: ~88MB

vision (https://github.com/pytorch/vision)
- TOTAL MEMORY USAGE: ~334MB
+ TOTAL MEMORY USAGE: ~368MB

mkdocs (https://github.com/mkdocs/mkdocs)
-     memo fields = ~106MB
+     memo fields = ~97MB

tornado (https://github.com/tornadoweb/tornado)
- TOTAL MEMORY USAGE: ~156MB
+ TOTAL MEMORY USAGE: ~171MB

bandersnatch (https://github.com/pypa/bandersnatch)
-     memo fields = ~72MB
+     memo fields = ~66MB

paasta (https://github.com/yelp/paasta)
-     memo fields = ~156MB
+     memo fields = ~171MB

django-stubs (https://github.com/typeddjango/django-stubs)
- TOTAL MEMORY USAGE: ~171MB
+ TOTAL MEMORY USAGE: ~189MB

meson (https://github.com/mesonbuild/meson)
-     memo fields = ~334MB
+     memo fields = ~304MB

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dcreager removed by @dhruvmanila on 2025-06-30 13:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @dhruvmanila on 2025-06-30 13:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @dhruvmanila on 2025-06-30 13:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @dhruvmanila on 2025-06-30 13:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @dhruvmanila on 2025-06-30 13:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_server/src/server/api.rs</code>:138 on 2025-07-02 16:17</div>
            <div class="timeline-body"><p>Could you add a comment saying why this code is kept around even though it isn't used?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_server/src/server/api/traits.rs</code>:64 on 2025-07-02 16:22</div>
            <div class="timeline-body"><p>One thing I'd find helpful here is some prose (perhaps on the module doc) that briefly explains the traits here and how they're connected.</p>
<p>If you think this code is going to be heavily refactored soon, then it might not make sense to add docs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2025-07-02 16:23</div>
            <div class="timeline-body"><p>Nice! My only comments are requesting docs, probably because I'm somewhat unfamiliar with this part of the LSP. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-03 05:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api.rs</code>:138 on 2025-07-03 05:26</div>
            <div class="timeline-body"><p>I split the workspace diagnostics work into two PRs to ease up the review process. This is going to be used in the follow-up PR (#18939). Sorry, I should've highlighted this as a review comment!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/traits.rs</code>:64 on 2025-07-03 05:28</div>
            <div class="timeline-body"><p>Definitely! Most of this stuff is currently in my and Micha's mind but it would be useful to have it written down. I'll prioritize it soon as there are now more people who'll be working on the server.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-03 05:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2025-07-03 11:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2025-07-03 11:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-03 11:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-07-03 11:07</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_WALLTIME_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/dhruv%2Fbackground-request-handler?runnerMode=WallTime">CodSpeed WallTime Performance Report</a></h2>
<h3>Merging #19041 will <strong>degrade performances by 4.82%</strong></h3>
<p><sub>Comparing <code>dhruv/background-request-handler</code> (1252436) with <code>main</code> (e212dc2)</sub></p>
<h3>Summary</h3>
<p><code>❌ 1</code> regressions<br />
<code>✅ 7</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/dhruv%2Fbackground-request-handler?runnerMode=WallTime">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ❌ | <code>multithreaded[pydantic]</code> | 321 ms | 337.3 ms | -4.82% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-07 09:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api/traits.rs</code>:61 on 2025-07-07 09:26</div>
            <div class="timeline-body"><p>I wonder if we should call this <code>SessionSnapshot</code> instead. It's unfortunate that the LSP specification made such a mess of the term workspace (which can refer to an open folder, or all open foldlers).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-07 09:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/session.rs</code>:229 on 2025-07-07 09:30</div>
            <div class="timeline-body"><p>I'd suggest removing the <code>AssertUnwindSafe</code> here and insteaed wrap the entire snapshot in <code>crates/ty_server/src/server/api.rs</code> in an <code>AssertUnwindSafe</code> and add a comment saying that it's safe to move it across unwind boundaries because the value isn't used after unwinding.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-07 09:30</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-07 13:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/session.rs</code>:229 on 2025-07-07 13:55</div>
            <div class="timeline-body"><p>That would mean that the <code>snapshot</code> parameter type of <code>BackgroundRequestHandler::run</code> would need to be <code>AssertUnwindSafe&lt;SessionSnapshot&gt;</code>. Or, are you suggesting to wrap the <code>AssertUnwindSafe</code> on the entire closure that is the first argument to <code>catch_unwind</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-07 13:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/session.rs</code>:229 on 2025-07-07 13:59</div>
            <div class="timeline-body"><p>~~The former doesn't seems to work as the compiler still errors stating that some reference may not be safe to be transferred across the catch_unwind boundary.~~</p>
<p>Edit: Nevermind, it works.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-07 14:03</div>
            <div class="timeline-body"><p>Addressed these review comments in https://github.com/astral-sh/ruff/pull/19177.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 18:33:37 UTC
    </footer>
</body>
</html>
