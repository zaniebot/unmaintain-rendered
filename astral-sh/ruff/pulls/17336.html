<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Silence `unresolved-import` in unreachable code - astral-sh/ruff #17336</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Silence <code>unresolved-import</code> in unreachable code</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17336">#17336</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-04-10 15:44
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-10 15:44</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Similar to what we did for <code>unresolved-reference</code> and <code>unresolved-attribute</code>, we now also silence <code>unresolved-import</code> diagnostics if the corresponding <code>import</code> statement is unreachable.</p>
<p>This addresses the (already closed) issue #17049.</p>
<h2>Test Plan</h2>
<p>Adapted Markdown tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @sharkdp on 2025-04-10 15:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Silence unresolved-import in unreachable code" to "[red-knot] Silence `unresolved-import` in unreachable code" by @sharkdp on 2025-04-10 15:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-10 15:46</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">isort (https://github.com/pycqa/isort)
- error[lint:unresolved-import] /tmp/mypy_primer/projects/isort/isort/settings.py:52:16: Cannot resolve import `tomllib`
- error[lint:unresolved-import] /tmp/mypy_primer/projects/isort/isort/settings.py:54:15: Cannot resolve import `._vendored`
- Found 59 diagnostics
+ Found 57 diagnostics

async-utils (https://github.com/mikeshardmind/async-utils)
- error[lint:unresolved-import] /tmp/mypy_primer/projects/async-utils/_misc/_ensure_annotations.py:57:16: Cannot resolve import `annotationlib`
- Found 31 diagnostics
+ Found 30 diagnostics

black (https://github.com/psf/black)
- error[lint:unresolved-import] /tmp/mypy_primer/projects/black/src/black/handle_ipynb_magics.py:14:24: Module `typing` has no member `TypeGuard`
- error[lint:unresolved-import] /tmp/mypy_primer/projects/black/src/black/cache.py:20:24: Module `typing` has no member `Self`
- error[lint:unresolved-import] /tmp/mypy_primer/projects/black/src/black/files.py:18:16: Cannot resolve import `tomllib`
- error[lint:unresolved-import] /tmp/mypy_primer/projects/black/src/black/nodes.py:10:24: Module `typing` has no member `TypeGuard`
- Found 258 diagnostics
+ Found 254 diagnostics

rich (https://github.com/Textualize/rich)
- error[lint:unresolved-import] /tmp/mypy_primer/projects/rich/tests/test_syntax.py:26:10: Cannot resolve import `importlib_metadata`
- error[lint:unresolved-import] /tmp/mypy_primer/projects/rich/docs/source/conf.py:27:10: Cannot resolve import `importlib_metadata`
- error[lint:unresolved-import] /tmp/mypy_primer/projects/rich/rich/progress.py:43:24: Module `typing` has no member `Self`
- Found 794 diagnostics
+ Found 791 diagnostics

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @sharkdp on 2025-04-10 15:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2025-04-10 15:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2025-04-10 15:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @sharkdp on 2025-04-10 15:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-04-10 15:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3300 on 2025-04-10 15:50</div>
            <div class="timeline-body"><p>We could also move the <code>is_import_reachable</code> check inside <code>report_unresolved_module</code>, but that would require passing many parameters (or the closure). Not sure what's better.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-10 16:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3300 on 2025-04-10 16:03</div>
            <div class="timeline-body"><p>Or we could get rid of the <code>report_unresolved_module</code> function and replace it with a method on the <code>TypeInferenceBuilder</code>? Something like this?</p>
<pre><code class="language-rs">impl TypeInferenceBuilder {
    fn report_unresolved_module&lt;'a&gt;(
        &amp;self,
        node: impl Into&lt;AnyNodeRef&lt;'a&gt;&gt;,
        range: impl Ranged,
        level: u32,
        module: Option&lt;&amp;str&gt;
    ) {
        let file_scope_id = self.scope().file_scope_id(self.db());

        if !self.index
            .is_node_reachable(self.db(), file_scope_id, NodeKey::from_node(node))
        {
            return;
        }

        self.context.report_lint(
            &amp;UNRESOLVED_IMPORT,
            range,
            format_args!(
                &quot;Cannot resolve import `{}{}`&quot;,
                &quot;.&quot;.repeat(level as usize),
                module.unwrap_or_default()
            ),
        );
    }
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-04-10 16:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-10 16:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3300 on 2025-04-10 16:11</div>
            <div class="timeline-body"><p>(could also just have the method accept <code>NodeKey</code> and <code>TextRange</code> to avoid monomorphisation)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-04-10 16:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-04-10 19:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3300 on 2025-04-10 19:04</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2025-04-10 19:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-04-10 19:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-10 19:13</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:41:06 UTC
    </footer>
</body>
</html>
