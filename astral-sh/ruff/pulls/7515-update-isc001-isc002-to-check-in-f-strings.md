```yaml
number: 7515
title: "Update `ISC001`, `ISC002` to check in f-strings"
type: pull_request
state: merged
author: dhruvmanila
labels:
  - rule
  - python312
assignees: []
merged: true
base: dhruv/pep-701
head: dhruv/issue-7298
created_at: 2023-09-19T12:29:46Z
updated_at: 2023-09-28T03:58:56Z
url: https://github.com/astral-sh/ruff/pull/7515
synced_at: 2026-01-12T15:55:24Z
```

# Update `ISC001`, `ISC002` to check in f-strings

---

_@dhruvmanila_

## Summary

This PR updates the implicit string concatenation rules, specifically `ISC001`
and `ISC002` to account for the new f-string tokens. `ISC003` checks for
explicit string concatenation and is not affected by PEP 701 because it is based
on AST.

### Implementation

The implementation is based on the boundary tokens of the f-string which are
`FStringStart` and `FStringEnd`. There are 4 cases to look for:
1. `String` followed by `FStringStart`
2. `FStringEnd` followed by `String`
3. `FStringEnd` followed by `FStringStart`
4. `String` followed by `String`

For f-string tokens, we use the `Indexer` to get the entire range of the f-string.
This is the range of the innermost f-string.

## Test Plan

Add new test cases for nested f-strings.


---

_Comment by @dhruvmanila on 2023-09-19 12:30_

Current dependencies on/for this PR:
* main
  * **PR #7376** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7376" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7690** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7690" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7667** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7667" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7597** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7597" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7588** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7588" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #7589** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7589" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7586** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7586" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7515** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7515" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #7477** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7477" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7387** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7387" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7378** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7378" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7329** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7329" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7328** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7328" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7327** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7327" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7326** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7326" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7325** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7325" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7515?utm_source=stack-comment).

---

_Label `rule` added by @dhruvmanila on 2023-09-19 12:30_

---

_Label `python312` added by @dhruvmanila on 2023-09-19 12:30_

---

_@dhruvmanila reviewed on 2023-09-19 12:31_

---

_Review comment by @dhruvmanila on `crates/ruff/resources/test/fixtures/flake8_implicit_str_concat/ISC.py`:69 on 2023-09-19 12:31_

We didn't detect this in earlier version but with the granularity of the tokens, we can detect this as well.

---

_Review requested from @MichaReiser by @dhruvmanila on 2023-09-19 12:32_

---

_Review requested from @charliermarsh by @dhruvmanila on 2023-09-19 12:32_

---

_Comment by @codspeed-hq[bot] on 2023-09-19 12:39_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/dhruv/issue-7298)

### Merging #7515 will **not alter performance**

<sub>Comparing <code>dhruv/issue-7298</code> (fe3eced) with <code>dhruv/pep-701</code> (db4992a)</sub>



### Summary

`âœ… 25` untouched benchmarks






---

_Review comment by @MichaReiser on `crates/ruff/src/rules/flake8_implicit_str_concat/rules/implicit.rs`:113 on 2023-09-20 06:33_

I find the use of `fstring_ranges` here a bit unfortunate because:

* Looking up the range is at least: `O(log(n))`
* So many unwraps

But I guess it's fine, considering that implicit concatenated strings are somewhat rare

---

_@MichaReiser approved on 2023-09-20 06:33_

---

_@dhruvmanila reviewed on 2023-09-20 11:55_

---

_Review comment by @dhruvmanila on `crates/ruff/src/rules/flake8_implicit_str_concat/rules/implicit.rs`:113 on 2023-09-20 11:55_

Yes, I agree. This could be solved with the introduction of a new `StringList` node though as the AST would contain the range, so no lookups and no unwraps ðŸ˜‰ 

---

_Merged by @dhruvmanila on 2023-09-20 11:58_

---

_Closed by @dhruvmanila on 2023-09-20 11:58_

---

_Branch deleted on 2023-09-20 11:58_

---
