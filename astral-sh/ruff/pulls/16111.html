<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Implement support for attributes implicitly declared via their parameter types - astral-sh/ruff #16111</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Implement support for attributes implicitly declared via their parameter types</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16111">#16111</a>
        opened by <a href="https://github.com/mishamsk">@mishamsk</a>
        on 2025-02-12 03:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/mishamsk">@mishamsk</a> on 2025-02-12 03:14</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>As per discussion in #15960 - implemented a concrete special case of implicit declaration.</p>
<h2>Test Plan</h2>
<p>cargo nextest run -p red_knot_python_semantic --no-fail-fast</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @mishamsk on 2025-02-12 03:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @mishamsk on 2025-02-12 03:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @mishamsk on 2025-02-12 03:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @mishamsk on 2025-02-12 03:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-02-12 07:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-12 08:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:49 on 2025-02-12 08:01</div>
            <div class="timeline-body"><p>Thank you for adding this test case. I think we could probably move it directly below the <code>reveal_type(c_instance.inferred_from_param)</code> above (and similarly move the definition in <code>__init__</code> upwards). And add a small comment that explains why we union with <code>Unknown</code> in that case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-12 08:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:26 on 2025-02-12 08:02</div>
            <div class="timeline-body"><p>Minor:</p>
<p>Maybe something like this for a shorter and more realistic example?</p>
<pre><code class="language-suggestion">        param = param if param is not None else 0
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-12 08:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:51 on 2025-02-12 08:10</div>
            <div class="timeline-body"><p>This test case also makes sense, but we already have that below in the &quot;Variable defined in non-<code>__init__</code> method&quot; section. Notice that it comes with a TODO that shows that we want to infer the declared parameter type for these cases as well. I think it would be surprising to special-case <code>__init__</code> in the way you have done here in this PR, although I understand the intention.</p>
<p>So to summarize: I think we can remove this test case here; remove the <code>if name.as_str() == &quot;__init__&quot;</code> check in your implementation, and then resolve the TODO in the test case below.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:4251 on 2025-02-12 08:14</div>
            <div class="timeline-body"><p>Maybe</p>
<pre><code class="language-suggestion">                    // If we see that a *declared* parameter of a method is directly assigned
                    // to an instance attribute, we treat that as if the attribute assignment had
                    // been annotated with that same parameter type. For example, we treat
                    // the following attribute assignment, as if it had been annotated with
                    // `self.name: str = name`:
                    // ```python
                    // class A:
                    //     def __init__(self, name: str):
                    //         self.name = name
                    // ```
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-12 08:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-12 08:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:4279 on 2025-02-12 08:39</div>
            <div class="timeline-body"><p>We'll need to wrap this in a salsa query because it access both <code>kind</code> and <code>node</code>, which both are AST nodes from other modules.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-12 08:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:4277 on 2025-02-12 08:40</div>
            <div class="timeline-body"><p>Unfortunately, I don't think that this is sufficient.</p>
<p>In the attribute assignment <code>self.name = value</code>, the inferred type for <code>value</code> might be different than the declared type (e.g. due to narrowing). For example, consider:</p>
<pre><code class="language-py">class C:
    def __init__(self, x: str | None = None) -&gt; None:
        if x is not None:
            self.x = x

reveal_type(C().x)
</code></pre>
<p>On this branch, we would get the answer <code>str</code>. This seems fine for the given example, but if we extend that a bit:</p>
<pre><code class="language-py">class C:
    def __init__(self, x: str | None = None) -&gt; None:
        if x is not None:
            self.x = x
        else:
            self.x = 0

reveal_type(C().x)
</code></pre>
<p>we would <em>still</em> get <code>str</code> due to the early return just below, but this is now wrong (too narrow).</p>
<p>I think we should introduce a new section in the <code>attributes.md</code> test suite with a few test cases like the ones above.</p>
<p>To fix this, we might want to retrieve the declared type for the parameter, compare it with the inferred type of the RHS of the assignment, and only trigger this special case if both are equal? This would lead to the answers <code>Unknown | str</code> and <code>Unknown | str | Literal[0]</code> for these examples, which seems good to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-12 08:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:4277 on 2025-02-12 08:44</div>
            <div class="timeline-body"><p>Another test case that we should probably add is the following, to make sure that we infer <code>str</code> and not <code>Literal[&quot;&quot;]</code>:</p>
<pre><code class="language-py">class C:
    def __init__(self, param: str = &quot;&quot;) -&gt; None:
        self.x = param

reveal_type(C().x)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-02-12 16:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:4277 on 2025-02-12 16:28</div>
            <div class="timeline-body"><p>For the latter case, the inferred and declared type of <code>param</code> will both be <code>str</code> anyway. Defaults do not narrow the inferred type, since we can't assume the default is used for any given call.</p>
<p>(Not that it's a problem to add that test, but I don't think that one would fail even if we looked only at inferred type.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-02-13 12:15</div>
            <div class="timeline-body"><p>As discussed privately, we decided to postpone this feature for now. Thank you very much for your contribution. It's possible that we pick this up again if we eventually decide that we need this after all.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-02-13 12:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-03-30 20:46</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:41:04 UTC
    </footer>
</body>
</html>
