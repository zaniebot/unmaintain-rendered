<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Factor out shared unpacking logic - astral-sh/ruff #16595</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Factor out shared unpacking logic</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16595">#16595</a>
        opened by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a>
        on 2025-03-10 06:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ericmarkmartin">@ericmarkmartin</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<!-- What's the purpose of the change? What does it do, and why? -->

<p>The logic for unpacking in assignment, for loops, and with items are very similar. Let's factor it out into some shared logic.</p>
<h2>Test Plan</h2>
<!-- How was it tested? -->

<p>existing tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-03-10 09:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Factor out shared unpacking logic" to "[red-knot] Factor out shared unpacking logic" by @ericmarkmartin on 2025-03-18 19:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-24 23:34</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @ericmarkmartin on 2025-03-25 04:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @ericmarkmartin on 2025-03-25 04:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @ericmarkmartin on 2025-03-25 04:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @ericmarkmartin on 2025-03-25 04:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @ericmarkmartin on 2025-03-25 04:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-27 12:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:961 on 2025-03-27 12:20</div>
            <div class="timeline-body"><p>I think I'd prefer the use of an <code>enum</code> here over a trait because it doesn't need to be open to extensions -- we know all instances.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @MichaReiser on 2025-03-27 12:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> reviewed on 2025-03-27 21:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:961 on 2025-03-27 21:44</div>
            <div class="timeline-body"><p>Doesn't the trait buy us static dispatch here? Also given that the trait is private to the module, it's only as extensible as an enum, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-27 21:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:961 on 2025-03-27 21:55</div>
            <div class="timeline-body"><p>It gives you inline for the specific variant by monomorphizing the code but a call to an enum also uses static dispatch without the cost of monomorphization.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @sharkdp on 2025-03-28 12:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:916 on 2025-03-28 15:21</div>
            <div class="timeline-body"><p>The use of a <code>OnceCell</code> to avoid the inference of the expression seems unnecessarily complicated compared to testing if <code>targets</code> is empty</p>
<pre><code class="language-suggestion">        let targets = unpackable.targets();

        if targets.is_empty() {
            return;
        }

        let value = self.add_standalone_expression(unpackable.expression());
            let current_assignment = match target {
</code></pre>
<p>But I don't think skipping the creation of a standalone expression for the <code>value</code> is correct even if we have no targets because <code>infer_assignment_definition</code> always expects the standalone expression to exist. I don't think this is something we can test today because the parser only creates an assignment statement if there's at least one target, but that could change in the future.</p>
<p>What was your reason for adding the optimization in the first place? Was it to avoid adding a standalone expression for the match case?</p>
<p>I'm leaning towards simplifying this method to</p>
<pre><code>fn add_unpackable_assignment(
        &amp;mut self,
        unpackable: &amp;Unpackable&lt;'db&gt;,
        target: &amp;'db ast::Expr,
        value: Expression&lt;'db&gt;,
    ) {
</code></pre>
<p>and let the caller deal with multiple targets or how when to add the value.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-28 15:37</div>
            <div class="timeline-body"><p>This is looking good, thanks for working on this! I hope you don't mind but I'm going to push some changes to this PR to move around a couple of things and simply a bit. I don't want to waste your time in more follow-ups as this is mainly a refactor PR. I'll put up a comment listing down the changes I made in case you are interested and then merge it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-28 15:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-03-28 17:58</div>
            <div class="timeline-body"><p>Thank you!</p>
<p>I've made the following changes:</p>
<ul>
<li>Address Micha's review feedback and removed the <code>OnceCell</code>, update the function to accept the target and value expression, let caller handle multiple targets and adding the standalone expression</li>
<li>Inlined the <code>unpack</code> method as it's only being used in a single place. We can create a common method if it's going to be used in multiple places but I don't think it will be now that we have a common method to handle unpackable assignments</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @dhruvmanila on 2025-03-28 17:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> reviewed on 2025-03-28 18:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:916 on 2025-03-28 18:10</div>
            <div class="timeline-body"><p>I had intended it for the case where you don't have a target in the with case. When <code>Unpackable</code> was a trait, I only had an iterator over the targets, hence why I didn't check length</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2025-03-28 18:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2025-03-28 18:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-03-31 03:47</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:10:35 UTC
    </footer>
</body>
</html>
