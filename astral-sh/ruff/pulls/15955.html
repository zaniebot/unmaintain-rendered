<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-comprehensions`] Detect overshadowed `list`/`set`/`dict`, ignore variadics and named expressions (`C417`) - astral-sh/ruff #15955</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-comprehensions</code>] Detect overshadowed <code>list</code>/<code>set</code>/<code>dict</code>, ignore variadics and named expressions (<code>C417</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15955">#15955</a>
        opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a>
        on 2025-02-05 01:01
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-02-05 01:01</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Part of #15809 and #15876.</p>
<p>This change brings several bugfixes:</p>
<ul>
<li>The nested <code>map()</code> call in <code>list(map(lambda x: x, []))</code> where <code>list</code> is overshadowed is now correctly reported.</li>
<li>The call will no longer reported if:<ul>
<li>Any arguments given to <code>map()</code> are variadic.</li>
<li>Any of the iterables contain a named expression.</li>
</ul>
</li>
</ul>
<h2>Test Plan</h2>
<p><code>cargo nextest run</code> and <code>cargo insta test</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-02-05 01:08</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2025-02-05 08:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @MichaReiser on 2025-02-05 08:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_comprehensions/fixes.rs</code>:652 on 2025-02-05 09:37</div>
            <div class="timeline-body"><p>I'd prefer to keep passing <code>expr</code> here (or even <code>CallExpr</code>) because it is more meaningful than just <code>range</code>. <code>range</code> itself doesn't convey any information to reader. What is it the range of? Or is</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_comprehensions/rules/unnecessary_map.rs</code>:102 on 2025-02-05 09:42</div>
            <div class="timeline-body"><p>This check is now redundant with the check on line 71 or was it unintentional to move the check to line 71 because it wasn't applied for the <code>Generator</code> case before</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_comprehensions/rules/unnecessary_map.rs</code>:138 on 2025-02-05 09:45</div>
            <div class="timeline-body"><p>Nit: We could do this in a single iteration</p>
<pre><code class="language-suggestion">    // For example, (x+1 for x in (c:=a)) is invalid syntax
    // so we can't suggest it.
    for iterable in &amp;iterables {
        if iterable.is_starred_expr() {
            return;
        }

        if any_over_expr(iterable, &amp;|expr| expr.is_named_expr()) {
            return
        }
    }
</code></pre>
<p>or</p>
<pre><code class="language-suggestion">    // For example, (x+1 for x in (c:=a)) is invalid syntax
    // so we can't suggest it.
    if iterables
        .iter()
        .any(|iterable| iterable.is_starred_expr() || any_over_expr(iterable, &amp;|expr| expr.is_named_expr()))
    {
        return;
    }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_comprehensions/rules/unnecessary_map.rs</code>:184 on 2025-02-05 09:49</div>
            <div class="timeline-body"><p>Nit</p>
<pre><code class="language-suggestion">    let Some((Expr::Lambda(lambda), iterables)) = arguments.args.split_first() else {
        return None;
    };
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_comprehensions/rules/unnecessary_map.rs</code>:175 on 2025-02-05 09:50</div>
            <div class="timeline-body"><p>I suggest to remove the lambda here, it reduces the tuple arity and makes it clearer what the second expression is</p>
<pre><code class="language-suggestion">fn map_lambda_and_iterables&lt;'a&gt;(
    call: &amp;'a ast::ExprCall,
    semantic: &amp;'a SemanticModel,
) -&gt; Option&lt;(&amp;'a ExprLambda, &amp;'a [Expr])&gt; {
</code></pre>
<p>It also allows to simplify <code>lambda_has_expected_arity</code> to <code>lambda_has_expected_arity(lambda)</code> and you can move the check if <code>parameters</code> is <code>Some</code> into <code>lambda_has_expected_arity</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-05 09:56</div>
            <div class="timeline-body"><p>Thank you. It's sort of difficult to see the actual fixes in between the refactors you did. Would you mind commenting on the diff to highlight the fixes for each bullet point?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2025-02-06 19:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/src/rules/flake8_comprehensions/rules/unnecessary_map.rs</code>:175 on 2025-02-06 19:06</div>
            <div class="timeline-body"><p>I think I intentionally left it this way so that #15876's <code>fix_unnecessary_map_preview()</code> could make use of <code>parameters</code> directly (i.e., avoid destructuring <code>parameters</code> twice).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-02-07 00:49</div>
            <div class="timeline-body"><blockquote>
<p>Would you mind commenting on the diff to highlight the fixes for each bullet point?</p>
</blockquote>
<p>The diff is a tad too big to reason about, so here's something else to the same effect.</p>
<hr />
<blockquote>
<p>The nested <code>map()</code> call in <code>list(map(lambda x: x, []))</code> where <code>list</code> is overshadowed is now correctly reported.</p>
</blockquote>
<p><a href="https://github.com/astral-sh/ruff/blob/10d3e64ccdf69d90c3252a15b3408a4238427792/crates/ruff_linter/src/rules/flake8_comprehensions/rules/unnecessary_map.rs#L92-L98">Before</a>:</p>
<pre><code class="language-rust">if parent
    .and_then(Expr::as_call_expr)
    .and_then(|call| call.func.as_name_expr())
    .is_some_and(|name| matches!(name.id.as_str(), &quot;list&quot; | &quot;set&quot; | &quot;dict&quot;))
{
    return;
}
</code></pre>
<p><a href="https://github.com/InSyncWithFoo/ruff/blob/e14b8664043339a34c8450ceb136a3dd1123d5c1/crates/ruff_linter/src/rules/flake8_comprehensions/rules/unnecessary_map.rs#L89-L91">After</a>:</p>
<pre><code class="language-rust">if parent_call_func.is_some_and(|func| is_list_set_or_dict(func, semantic)) {
    return;
}

// ...

fn is_list_set_or_dict(func: &amp;Expr, semantic: &amp;SemanticModel) -&gt; bool {
    semantic
        .resolve_qualified_name(func)
        .is_some_and(|qualified_name| {
            matches!(
                qualified_name.segments(),
                [&quot;&quot; | &quot;builtins&quot;, &quot;list&quot; | &quot;set&quot; | &quot;dict&quot;]
            )
        })
}
</code></pre>
<blockquote>
<ul>
<li>The call will no longer reported if:<ul>
<li>Any arguments given to <code>map()</code> are variadic.</li>
<li>Any of the iterables contain a named expression.</li>
</ul>
</li>
</ul>
</blockquote>
<p>This check <a href="https://github.com/astral-sh/ruff/blob/10d3e64ccdf69d90c3252a15b3408a4238427792/crates/ruff_linter/src/rules/flake8_comprehensions/rules/unnecessary_map.rs#L108-L112">was present</a>, but only for the <code>::Generator</code> branch:</p>
<pre><code class="language-rust">// For example, (x+1 for x in (c:=a)) is invalid syntax
// so we can't suggest it.
if any_over_expr(iterable, &amp;|expr| expr.is_named_expr()) {
    return;
}
</code></pre>
<p>Now, it is placed <a href="https://github.com/InSyncWithFoo/ruff/blob/e14b8664043339a34c8450ceb136a3dd1123d5c1/crates/ruff_linter/src/rules/flake8_comprehensions/rules/unnecessary_map.rs#L127-L137">outside of the branches</a>, along with a new check for starred expressions:</p>
<pre><code class="language-rust">for iterable in iterables {
    // For example, (x+1 for x in (c:=a)) is invalid syntax
    // so we can't suggest it.
    if any_over_expr(iterable, &amp;|expr| expr.is_named_expr()) {
        return;
    }

    if iterable.is_starred_expr() {
        return;
    }
}
</code></pre>
<p>Similarly, other pieces that are applicable to all branches have also been moved into <a href="https://github.com/InSyncWithFoo/ruff/blob/e14b8664043339a34c8450ceb136a3dd1123d5c1/crates/ruff_linter/src/rules/flake8_comprehensions/rules/unnecessary_map.rs#L168-L187"><code>map_lambda_and_iterables()</code></a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-02-07 08:55</div>
            <div class="timeline-body"><p>Perfect and thanks for the explanations. They were very helpful when reviewing the PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-02-07 08:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-02-07 08:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-07 15:12</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:57:52 UTC
    </footer>
</body>
</html>
