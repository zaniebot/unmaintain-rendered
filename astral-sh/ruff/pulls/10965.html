<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resolve classes and functions relative to script name - astral-sh/ruff #10965</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Resolve classes and functions relative to script name</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10965">#10965</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-04-16 02:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">

Summary
<p>If the user is analyzing a script (i.e., we have no module path), it seems reasonable to use the script name when trying to identify paths to objects defined <em>within</em> the script.</p>
<p>Closes <a href="https://github.com/astral-sh/ruff/issues/10960">astral-sh/ruff#10960</a>.</p>
Test Plan
<p>Ran:</p>
<pre><code>check --isolated --select=B008 \
    --config &#x27;lint.flake8-bugbear.extend-immutable-calls=[&quot;test.A&quot;]&#x27; \
    test.py
</code></pre>
<p>On:</p>
<pre><code>class A: pass

def f(a=A()):
    pass
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-16 02:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-16 02:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-16 02:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-16 02:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-16 03:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_semantic/src/model.rs</code>:771 on 2024-04-16 03:00</div>
            <div class="timeline-body"><p>I consider changing <code>Module</code> to return <code>&amp;[script_name]</code> in the script case, but the path is typically used for resolving relative imports, and I&#x27;m not sure it makes as much sense for us to resolve relative imports relative to the script name given that it&#x27;s definitionally a standalone script.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2024-04-16 03:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-16 03:01</div>
            <div class="timeline-body"><p>Not worth unit test coverage?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-16 03:02</div>
            <div class="timeline-body"><p>Will try.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-04-16 03:17</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>‚ÑπÔ∏è ecosystem check <strong>detected linter changes</strong>. (+1 -0 violations, +0 -0 fixes in 1 projects; 43 projects unchanged)</p>
<a href="https://github.com/python/typeshed">python/typeshed</a> (+1 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --no-preview --select E,F,FA,I,PYI,RUF,UP,W</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/python/typeshed/blob/12b9e48324df292379db3eca4e3c54175e5f374e/stdlib/typing.pyi#L330">stdlib/typing.pyi:330:10:</a> PYI001 Name of private `TypeVar` must start with `_`
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PYI001 | 1 | 1 | 0 | 0 | 0 |</p>
</p>


Linter (preview)
<p>‚ÑπÔ∏è ecosystem check <strong>detected linter changes</strong>. (+1 -0 violations, +0 -0 fixes in 1 projects; 43 projects unchanged)</p>
<a href="https://github.com/python/typeshed">python/typeshed</a> (+1 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select E,F,FA,I,PYI,RUF,UP,W</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/python/typeshed/blob/12b9e48324df292379db3eca4e3c54175e5f374e/stdlib/typing.pyi#L330">stdlib/typing.pyi:330:10:</a> PYI001 Name of private `TypeVar` must start with `_`
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PYI001 | 1 | 1 | 0 | 0 | 0 |</p>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-16 03:29</div>
            <div class="timeline-body"><p>I think those typeshed changes are arguably good but I&#x27;ll let @AlexWaygood review.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-04-16 06:28</div>
            <div class="timeline-body"><blockquote>
<p>I think those typeshed changes are arguably good but I&#x27;ll let @AlexWaygood review.</p>
</blockquote>
<p>The <code>typing.pyi</code> change is definitely correct ‚Äî we already flag that in flake8-pyi, and I&#x27;d expect it to be flagged.</p>
<p>The builtins hit seems like a false positive though ‚Äî the existing annotation looks correct there. Something now isn&#x27;t being inferred as being a builtin symbol because we&#x27;re actually in builtins.pyi itself?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_semantic/src/definition.rs</code>:49 on 2024-04-16 09:28</div>
            <div class="timeline-body"><p>Nit: Unrelated to this PR. It&#x27;s a bit surprising that <code>ModuleSource</code> is defined in <code>visibility</code> when it is used for much more.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_semantic/src/model.rs</code>:838 on 2024-04-16 09:30</div>
            <div class="timeline-body"><p>I think the terminology is inconsistent which makes this change difficult to understand. For example, I don&#x27;t understand when a file is a script? Sould we rename one of the variants in <code>ModuleSource</code> to script? or are the concepts independent from each other?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_semantic/src/definition.rs</code>:45 on 2024-04-16 09:31</div>
            <div class="timeline-body"><p>Nit: I wonder if we should name this <code>qualified_name</code> instead. <code>Path</code> is ambigious because it could either be a file path or a module path.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-04-16 09:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-04-16 10:21</div>
            <div class="timeline-body"><blockquote>
<p>The builtins hit seems like a false positive though ‚Äî the existing annotation looks correct there. Something now isn&#x27;t being inferred as being a builtin symbol because we&#x27;re actually in builtins.pyi itself?</p>
</blockquote>
<p>Oh! I missed that the error was <em>going away</em> rather than being introduced! The typeshed hits both look like clear improvements, then üòÉ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-04-16 10:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-16 17:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_semantic/src/definition.rs</code>:49 on 2024-04-16 17:43</div>
            <div class="timeline-body"><p>Good call, I moved it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-16 17:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_semantic/src/definition.rs</code>:45 on 2024-04-16 17:43</div>
            <div class="timeline-body"><p>Good call.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-16 17:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_semantic/src/model.rs</code>:838 on 2024-04-16 17:44</div>
            <div class="timeline-body"><p>Good call.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-16 17:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_semantic/src/model.rs</code>:838 on 2024-04-16 17:45</div>
            <div class="timeline-body"><p>Actually, they&#x27;re somewhat independent (like <code>Script</code> and <code>Path</code> are odd as variants because they&#x27;re not in the same category of concepts).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-04-16 17:50</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/charlie/script">CodSpeed Performance Report</a>
Merging #10965 will <strong>not alter performance</strong>
<p>Comparing <code>charlie/script</code> (df60061) with <code>main</code> (06b3e37)</p>
Summary
<p><code>‚úÖ 30</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-18 01:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-18 01:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-04-18 01:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/fofoni">@fofoni</a> on 2024-04-18 04:54</div>
            <div class="timeline-body"><p>Thank you all for handling this so quickly!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-18 04:55</div>
            <div class="timeline-body"><p>No problem, sorry that it took a few days to merge -- I had to debug a performance regression :joy:</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:03:28 UTC
    </footer>
</body>
</html>
