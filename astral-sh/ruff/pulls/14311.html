<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-type-checking`] Fix false positives for `typing.Annotated` - astral-sh/ruff #14311</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-type-checking</code>] Fix false positives for <code>typing.Annotated</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14311">#14311</a>
        opened by <a href="https://github.com/Daverball">@Daverball</a>
        on 2024-11-13 09:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Daverball">@Daverball</a></div>
            <div class="timeline-body"><p>This partially addresses #13713</p>
Summary
<p>Ruff properly clears  the <code>TYPE_DEFINITION</code> flag when visiting special parts of an annotation like <code>typing.Literal</code> and <code>typing.Annotated</code>. However there are other typing related semantic flags which aren&#x27;t cleared. This is fine, however <code>is_typing_reference</code> only check for those higher level flags and completely ignores <code>TYPE_DEFINITION</code>, which can lead to false positives for TCH001-003.</p>
Test Plan
<p><code>cargo nextest run</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-13 09:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-13 09:08</div>
            <div class="timeline-body"><p>@AlexWaygood would you mind taking a look at this PR? I think you have a better understanding of our type checking flags</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-13 09:26</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+3 -0 violations, +0 -0 fixes in 1 projects; 53 projects unchanged)</p>
<a href="https://github.com/ibis-project/ibis">ibis-project/ibis</a> (+3 -0 violations, +0 -0 fixes)
<p>

<pre>
+ <a href="https://github.com/ibis-project/ibis/blob/3a1bb36441149282a305967ff810784099ec9a6a/ibis/expr/operations/generic.py#L16">ibis/expr/operations/generic.py:16:44:</a> RUF100 Unused `noqa` directive (unused: `TCH001`)
+ <a href="https://github.com/ibis-project/ibis/blob/3a1bb36441149282a305967ff810784099ec9a6a/ibis/expr/operations/generic.py#L18">ibis/expr/operations/generic.py:18:54:</a> RUF100 Unused `noqa` directive (unused: `TCH001`)
+ <a href="https://github.com/ibis-project/ibis/blob/3a1bb36441149282a305967ff810784099ec9a6a/ibis/expr/types/groupby.py#L28">ibis/expr/types/groupby.py:28:42:</a> RUF100 Unused `noqa` directive (unused: `TCH001`)
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| RUF100 | 3 | 3 | 0 | 0 | 0 |</p>
</p>


Linter (preview)
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+3 -0 violations, +0 -0 fixes in 1 projects; 53 projects unchanged)</p>
<a href="https://github.com/ibis-project/ibis">ibis-project/ibis</a> (+3 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/ibis-project/ibis/blob/3a1bb36441149282a305967ff810784099ec9a6a/ibis/expr/operations/generic.py#L16">ibis/expr/operations/generic.py:16:44:</a> RUF100 Unused `noqa` directive (unused: `TCH001`)
+ <a href="https://github.com/ibis-project/ibis/blob/3a1bb36441149282a305967ff810784099ec9a6a/ibis/expr/operations/generic.py#L18">ibis/expr/operations/generic.py:18:54:</a> RUF100 Unused `noqa` directive (unused: `TCH001`)
+ <a href="https://github.com/ibis-project/ibis/blob/3a1bb36441149282a305967ff810784099ec9a6a/ibis/expr/types/groupby.py#L28">ibis/expr/types/groupby.py:28:42:</a> RUF100 Unused `noqa` directive (unused: `TCH001`)
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| RUF100 | 3 | 3 | 0 | 0 | 0 |</p>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Daverball">@Daverball</a> on 2024-11-13 09:35</div>
            <div class="timeline-body"><p>Not quite sure what the new LOG015 violations are about and how they are related to this change, but they look correct to me.</p>
<p>The RUF100 violations are encouraging, since these are all due to previous false positives.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-13 10:43</div>
            <div class="timeline-body"><p>@Daverball can you try rebasing/merging main. I suspect that will help with the <code>LOG015</code> ecosystem changes</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-11-13 12:17</div>
            <div class="timeline-body"><p>Thank you! This LGTM.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[flake8-type-checking] Fixes a false positive for `typing.Annotated`&quot; to &quot;[flake8-type-checking] Fix false positives for `typing.Annotated`&quot; by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-13 12:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-13 12:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-13 12:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-13 12:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-11-14 04:47</div>
            <div class="timeline-body"><p>@AlexWaygood I&#x27;m assuming this is a bugfix based on the PR title but feel free to update the label if you think it&#x27;s a rule change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-11-14 04:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[flake8-type-checking] Fix false positives for `typing.Annotated`&quot; to &quot;[`flake8-type-checking`] Fix false positives for `typing.Annotated`&quot; by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-11-14 04:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-14 10:12</div>
            <div class="timeline-body"><blockquote>
<p>@AlexWaygood I&#x27;m assuming this is a bugfix based on the PR title but feel free to update the label if you think it&#x27;s a rule change.</p>
</blockquote>
<p>Yes, I think that&#x27;s right! Sorry, I should have added the label.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:08:26 UTC
    </footer>
</body>
</html>
