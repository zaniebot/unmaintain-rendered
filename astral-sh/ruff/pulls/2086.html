<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update RustPython to fix `Dict.keys` type - astral-sh/ruff #2086</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Update RustPython to fix <code>Dict.keys</code> type</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/2086">#2086</a>
        opened by <a href="https://github.com/harupy">@harupy</a>
        on 2023-01-22 14:31
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/harupy">@harupy</a> on 2023-01-22 14:31</div>
            <div class="timeline-body"><p>This PR upgrades RustPython to fix the type of <code>Dict.keys</code> to <code>Vec&lt;Option&lt;Expr&gt;&gt;</code> (see https://github.com/RustPython/RustPython/pull/4449 for why this change was needed) and unblock #1884.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/harupy">@harupy</a> on <code>src/rules/pyupgrade/rules/convert_typed_dict_functional_to_class.rs</code>:83 on 2023-01-22 14:32</div>
            <div class="timeline-body"><pre><code class="language-suggestion"></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harupy">@harupy</a> reviewed on 2023-01-22 14:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harupy">@harupy</a> reviewed on 2023-01-22 14:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/harupy">@harupy</a> on <code>src/rules/pyflakes/rules/repeated_keys.rs</code>:35 on 2023-01-22 14:40</div>
            <div class="timeline-body"><p>Ah we can't use flatten here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harupy">@harupy</a> on 2023-01-22 15:06</div>
            <div class="timeline-body"><p>Prior to https://github.com/RustPython/RustPython/pull/4449,</p>
<pre><code class="language-python">{&quot;a&quot;: 0, **b, &quot;c&quot;: 1}
</code></pre>
<p>is parsed as:</p>
<pre><code>[
    Located {
        location: Location {
            row: 1,
            column: 0,
        },
        end_location: Some(
            Location {
                row: 1,
                column: 21,
            },
        ),
        custom: (),
        node: Expr {
            value: Located {
                location: Location {
                    row: 1,
                    column: 0,
                },
                end_location: Some(
                    Location {
                        row: 1,
                        column: 21,
                    },
                ),
                custom: (),
                node: Dict {
                    ðŸ‘‡ contains a single key
                    keys: [
                        Located {
                            location: Location {
                                row: 1,
                                column: 1,
                            },
                            end_location: Some(
                                Location {
                                    row: 1,
                                    column: 4,
                                },
                            ),
                            custom: (),
                            node: Constant {
                                value: Str(
                                    &quot;a&quot;,
                                ),
                                kind: None,
                            },
                        },
                    ],
                    values: [
                        Located {
                            location: Location {
                                row: 1,
                                column: 6,
                            },
                            end_location: Some(
                                Location {
                                    row: 1,
                                    column: 7,
                                },
                            ),
                            custom: (),
                            node: Constant {
                                value: Int(
                                    0,
                                ),
                                kind: None,
                            },
                        },
                        Located {
                            location: Location {
                                row: 1,
                                column: 11,
                            },
                            end_location: Some(
                                Location {
                                    row: 1,
                                    column: 12,
                                },
                            ),
                            custom: (),
                            node: Name {
                                id: &quot;b&quot;,
                                ctx: Load,
                            },
                        },
                        Located {
                            location: Location {
                                row: 1,
                                column: 14,
                            },
                            end_location: Some(
                                Location {
                                    row: 1,
                                    column: 17,
                                },
                            ),
                            custom: (),
                            ðŸ‘‡ `&quot;c&quot;: 1` is parsed as dict!
                            node: Dict {
                                keys: [
                                    Located {
                                        location: Location {
                                            row: 1,
                                            column: 14,
                                        },
                                        end_location: Some(
                                            Location {
                                                row: 1,
                                                column: 17,
                                            },
                                        ),
                                        custom: (),
                                        node: Constant {
                                            value: Str(
                                                &quot;c&quot;,
                                            ),
                                            kind: None,
                                        },
                                    },
                                ],
                                values: [
                                    Located {
                                        location: Location {
                                            row: 1,
                                            column: 19,
                                        },
                                        end_location: Some(
                                            Location {
                                                row: 1,
                                                column: 20,
                                            },
                                        ),
                                        custom: (),
                                        node: Constant {
                                            value: Int(
                                                1,
                                            ),
                                            kind: None,
                                        },
                                    },
                                ],
                            },
                        },
                    ],
                },
            },
        },
    },
]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-22 16:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/ast/comparable.rs</code>:430 on 2023-01-22 16:31</div>
            <div class="timeline-body"><p>I think this may need to preserve the <code>None</code>, to be truly comparable, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-22 16:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/rules/pyupgrade/rules/unpack_list_comprehension.rs</code>:25 on 2023-01-22 16:33</div>
            <div class="timeline-body"><p>Oh, we should rewrite this to use <code>any_over_expr</code>. Can be a separate PR, or included here...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-22 16:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/ast/comparable.rs</code>:430 on 2023-01-22 16:42</div>
            <div class="timeline-body"><p>(So we'd need to update the definition of <code>ComparableExpr</code>.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-22 18:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/ast/comparable.rs</code>:430 on 2023-01-22 18:19</div>
            <div class="timeline-body"><p>(I'll go ahead and do this, then merge.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-01-22 18:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-01-22 18:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harupy">@harupy</a> reviewed on 2023-01-22 20:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/harupy">@harupy</a> on <code>src/ast/comparable.rs</code>:430 on 2023-01-22 20:21</div>
            <div class="timeline-body"><p>@charliermarsh Thanks for the update!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 04:54:12 UTC
    </footer>
</body>
</html>
