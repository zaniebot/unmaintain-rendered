<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`refurb`] Do not add `abc.ABC` if already present (`FURB180`) - astral-sh/ruff #22234</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>refurb</code>] Do not add <code>abc.ABC</code> if already present (<code>FURB180</code>)</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22234">#22234</a>
        opened by <a href="https://github.com/akawd">@akawd</a>
        on 2025-12-28 11:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/akawd">@akawd</a></div>
            <div class="timeline-body">

Summary
<p>According to the <code>FURB180</code> rule, <code>abc.ABC</code> should be used instead of <code>metaclass=abc.ABCMeta</code>. This issue can be fixed automatically, but if the class being checked already contains <code>abc.ABC</code>, it would be added a second time.</p>
<p>Fixes: #17162</p>
Test Plan
<p>I ran <code>cargo test refurb</code>.<br>
For checking the &quot;fix&quot; I used this python file:</p>


Python file (input)

<pre><code>import abc
from abc import abstractmethod, ABCMeta, ABC
from abc import ABC as ABCAnotherName

class ParentClass:
    ...

from abc import ABC, ABCMeta

class Foo(metaclass=ABCMeta):
    ...
    
class Foo2(abc.ABC, ParentClass, metaclass=ABCMeta):
    ...
    
class Foo3(ParentClass, ABC, metaclass=ABCMeta):
    ...
    
class Foo4(ABCAnotherName, metaclass=ABCMeta):
    ...
</code></pre>


<p>The output after applying the fix is so:</p>

Python file (output)

<pre><code>import abc
from abc import abstractmethod, ABCMeta, ABC
from abc import ABC as ABCAnotherName

class ParentClass:
    ...

from abc import ABC, ABCMeta

class Foo(ABC):
    ...
    
class Foo2(abc.ABC, ParentClass, ):
    ...
    
class Foo3(ParentClass, ABC, ):
    ...
    
class Foo4(ABCAnotherName, ):
    ...
</code></pre>


<p>Note: Trailing commas may remain after the automatic fix. It is unclear whether this is an issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/ntBre">@ntBre</a> by <a href="https://github.com/ntBre">@ntBre</a> on 2025-12-29 14:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2026-01-01 14:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/refurb/rules/metaclass_abcmeta.rs</code>:136 on 2026-01-01 14:26</div>
            <div class="timeline-body"><p>nit: is there an <code>Edit::range_deletion</code>? It looks like we could use that with <code>keyword.range()</code> here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/refurb/rules/metaclass_abcmeta.rs</code>:100 on 2026-01-01 14:27</div>
            <div class="timeline-body"><p>We have an <a href="https://github.com/astral-sh/ruff/blob/b2b9d91859f2abc017e35d22f01696f141f6f5b1/crates/ruff_python_semantic/src/analyze/class.rs#L16"><code>any_qualified_base_class</code></a> helper function that I think we could use here.</p>
<p><code>is_has_abc</code> also reads a bit strangely to me, maybe just <code>has_abc</code> would be better.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/refurb/rules/metaclass_abcmeta.rs</code>:120 on 2026-01-01 14:29</div>
            <div class="timeline-body"><p>I think we should be able to use a slice here to avoid allocating vecs:</p>
<pre><code>            let rest = if is_has_abc {
                &amp;[]
            } else {
                &amp;[
                    Edit::insertion(format!(&quot;{binding}, &quot;), class_def.keywords()[0].start()),
                    import_edit,
                ]
            };
</code></pre>
<p>You might have to annotate <code>rest</code> as <code>&amp;[Edit]</code>, though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> requested changes on 2026-01-01 14:34</div>
            <div class="timeline-body"><p>Thanks! This looks good to me overall, I just had a couple of small suggestions. We should also add your manual tests from the PR summary as regression tests. At the bottom of this file would be a good place for them:</p>
<p>https://github.com/astral-sh/ruff/blob/b2b9d91859f2abc017e35d22f01696f141f6f5b1/crates/ruff_linter/resources/test/fixtures/refurb/FURB180.py#L58</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[refurb] Do not add abc.ABC if already present&quot; to &quot;[`refurb`] Do not add `abc.ABC` if already present (`FURB180`)&quot; by <a href="https://github.com/ntBre">@ntBre</a> on 2026-01-01 14:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-01 14:35</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+0 -7 violations, +0 -0 fixes in 4 projects; 51 projects unchanged)</p>
<a href="https://github.com/bokeh/bokeh">bokeh/bokeh</a> (+0 -1 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --no-fix --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
- <a href="https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/core/query.py#L53">src/bokeh/core/query.py:53:5:</a> RUF068 [*] `__all__` contains duplicate entries: `find` duplicated here
</pre>

</p>

<a href="https://github.com/langchain-ai/langchain">langchain-ai/langchain</a> (+0 -2 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
- <a href="https://github.com/langchain-ai/langchain/blob/a84722e2d768a3029a632d0ab3515b897ebba63b/libs/langchain/langchain_classic/document_loaders/__init__.py#L373">libs/langchain/langchain_classic/document_loaders/__init__.py:373:5:</a> RUF068 [*] `__all__` contains duplicate entries: `AcreomLoader` duplicated here
- <a href="https://github.com/langchain-ai/langchain/blob/a84722e2d768a3029a632d0ab3515b897ebba63b/libs/langchain/langchain_classic/document_loaders/__init__.py#L391">libs/langchain/langchain_classic/document_loaders/__init__.py:391:5:</a> RUF068 [*] `__all__` contains duplicate entries: `AsyncHtmlLoader` duplicated here
</pre>

</p>

<a href="https://github.com/python/typeshed">python/typeshed</a> (+0 -3 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --no-fix --output-format concise --preview --select E,F,FA,I,PYI,RUF,UP,W</pre>
</p>
<p>

<pre>
- <a href="https://github.com/python/typeshed/blob/b94c9e8e48f552b2f2b979b69937b0e4848675cf/stubs/convertdate/convertdate/__init__.pyi#L45">stubs/convertdate/convertdate/__init__.pyi:45:5:</a> RUF068 [*] `__all__` contains duplicate entries: `mayan` duplicated here
- <a href="https://github.com/python/typeshed/blob/b94c9e8e48f552b2f2b979b69937b0e4848675cf/stubs/reportlab/reportlab/lib/rltempfile.pyi#L4">stubs/reportlab/reportlab/lib/rltempfile.pyi:4:30:</a> RUF068 [*] `__all__` contains duplicate entries: `get_rl_tempdir` duplicated here
- <a href="https://github.com/python/typeshed/blob/b94c9e8e48f552b2f2b979b69937b0e4848675cf/stubs/workalendar/workalendar/europe/__init__.pyi#L252">stubs/workalendar/workalendar/europe/__init__.pyi:252:5:</a> RUF068 [*] `__all__` contains duplicate entries: `Switzerland` duplicated here
</pre>

</p>

<a href="https://github.com/astropy/astropy">astropy/astropy</a> (+0 -1 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
- <a href="https://github.com/astropy/astropy/blob/b5754a667932b7c39b5f425abb2de77a7962fa9c/astropy/table/__init__.py#L32">astropy/table/__init__.py:32:5:</a> RUF068 [*] `__all__` contains duplicate entries: `conf` duplicated here
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| RUF068 | 7 | 0 | 7 | 0 | 0 |</p>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/akawd">@akawd</a> reviewed on 2026-01-02 08:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/akawd">@akawd</a> on <code>crates/ruff_linter/src/rules/refurb/rules/metaclass_abcmeta.rs</code>:136 on 2026-01-02 08:51</div>
            <div class="timeline-body"><p>Changed to <code>Edit::range_deletion</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/akawd">@akawd</a> reviewed on 2026-01-02 08:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/akawd">@akawd</a> on <code>crates/ruff_linter/src/rules/refurb/rules/metaclass_abcmeta.rs</code>:100 on 2026-01-02 08:52</div>
            <div class="timeline-body"><p>Switched to using <a href="https://github.com/astral-sh/ruff/blob/b2b9d91859f2abc017e35d22f01696f141f6f5b1/crates/ruff_python_semantic/src/analyze/class.rs#L16">any_qualified_base_class</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/akawd">@akawd</a> reviewed on 2026-01-02 08:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/akawd">@akawd</a> on <code>crates/ruff_linter/src/rules/refurb/rules/metaclass_abcmeta.rs</code>:120 on 2026-01-02 08:54</div>
            <div class="timeline-body"><p>Thank you for this advice, done.
P.S.: I had to use <code>iter().cloned()</code> because of https://github.com/akawd/ruff/blob/issue/17162/do-not-add-abc-if-already-added/crates/ruff_diagnostics/src/fix.rs#L130</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/akawd">@akawd</a> on 2026-01-02 09:00</div>
            <div class="timeline-body"><p>According to @&quot;... add your manual tests from the PR summary as regression tests.&quot; - I added the following changes to <code>FURB180.py</code>:</p>
<pre><code>
from abc import abstractmethod, ABCMeta, ABC
from abc import ABC as ABCAlternativeName

...
class A7(ABC):
    @abstractmethod
    def foo(self): pass

class A8(ABCAlternativeName):
    @abstractmethod
    def foo(self): pass  
...
</code></pre>
<p>I hope this is what was expected.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/ntBre">@ntBre</a> by <a href="https://github.com/akawd">@akawd</a> on 2026-01-02 09:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2026-01-02 14:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/refurb/rules/metaclass_abcmeta.rs</code>:120 on 2026-01-02 14:57</div>
            <div class="timeline-body"><p>Ah right, my mistake. Let&#x27;s just go back to the vecs. I forgot the slices would change the type of the iterator.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2026-01-02 14:58</div>
            <div class="timeline-body"><p>Thank you! That was close to what I had in mind, but I think your tests in the summary were a bit more helpful than the ones added to FURB180.py. I just pushed two commits updating the tests. A couple of things I tried to fix:</p>
<ul>
<li>I avoided changing any lines earlier in the file, this is nice for review because it doesn&#x27;t shift the line numbers in the existing snapshots</li>
<li>I added <code>metaclass=ABCMeta</code> to the new test cases so that FURB180 triggers</li>
<li>I added <code>class A11</code> showing off the parent class traversal that <code>any_qualified_base_class</code> gets us</li>
</ul>
<p>After making these changes, it showed that there&#x27;s an issue with the fix:</p>
<pre><code>- class A11(MyMetaClass, metaclass=ABCMeta):  # FURB180
+ class A11(MyMetaClass, ):  # FURB180
</code></pre>
<p>We&#x27;re leaving a trailing comma after removing the metaclass argument. I think we might want to try the <a href="https://github.com/astral-sh/ruff/blob/3cbe1e613c2dfc4b536130e635cb714bc7c0b375/crates/ruff_linter/src/fix/edits.rs#L206"><code>remove_argument</code></a> helper function here. Sorry, I should have recommended that sooner!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/akawd">@akawd</a> reviewed on 2026-01-02 18:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/akawd">@akawd</a> on <code>crates/ruff_linter/src/rules/refurb/rules/metaclass_abcmeta.rs</code>:120 on 2026-01-02 18:54</div>
            <div class="timeline-body"><p>Anyway it was an interesting idea (but not for this particular case, looks like). Reverted.
<a href="https://github.com/astral-sh/ruff/pull/22234">astral-sh/ruff#22234</a>/commits/aa524c82a18e12d890726554031b65745019679b
P.S.: And sorry for the mess with tests, I did not think the line numbers are important.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/akawd">@akawd</a> on 2026-01-02 19:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/akawd">@akawd</a> on 2026-01-02 19:26</div>
            <div class="timeline-body"><p>According to: &quot;We&#x27;re leaving a trailing comma after removing the metaclass argument&quot;.
Marked as draft to cover this issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/refurb/rules/metaclass_abcmeta.rs</code>:120 on 2026-01-02 20:02</div>
            <div class="timeline-body"><p>Thank you! And no worries, the line numbers aren&#x27;t a huge deal, just a little nicer for review :) Otherwise the formatting you had would be much nicer in normal circumstances.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2026-01-02 20:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/akawd">@akawd</a> on 2026-01-03 07:23</div>
            <div class="timeline-body"><blockquote>
<p>We&#x27;re leaving a trailing comma after removing the metaclass argument. I think we might want to try the <a href="https://github.com/astral-sh/ruff/blob/3cbe1e613c2dfc4b536130e635cb714bc7c0b375/crates/ruff_linter/src/fix/edits.rs#L206"><code>remove_argument</code></a> helper function here.</p>
</blockquote>
<p>Fixed the issue above here: <a href="https://github.com/astral-sh/ruff/pull/22234">astral-sh/ruff#22234</a>/commits/740da9e2808d8fda3616f8467dd706cca42ff7c0</p>
<p>Example.</p>


Before fix:

<pre><code>import abc
from abc import abstractmethod, ABCMeta, ABC
from abc import ABC as ABCAnotherName

class ParentClass:
    ...

class Foo(metaclass=ABCMeta):
    ...
    
class Foo2(abc.ABC, ParentClass, metaclass=ABCMeta):
    ...
    
class Foo3(ParentClass, ABC, metaclass=ABCMeta):
    ...
    
class Foo4(ABCAnotherName, metaclass=ABCMeta):
    ...
</code></pre>




After fix:

<pre><code>import abc
from abc import abstractmethod, ABCMeta, ABC
from abc import ABC as ABCAnotherName

class ParentClass:
    ...

class Foo(ABCAnotherName):
    ...
    
class Foo2(abc.ABC, ParentClass):
    ...
    
class Foo3(ParentClass, ABC):
    ...
    
class Foo4(ABCAnotherName):
    ...
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/akawd">@akawd</a> on 2026-01-03 07:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/akawd">@akawd</a> on 2026-01-03 07:27</div>
            <div class="timeline-body"><p>And since there are several commits here, do I need to squash them?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/akawd">@akawd</a> on 2026-01-13 18:43</div>
            <div class="timeline-body"><p>Hello, @ntBre . Just a friendly reminder and request to take a look at this if possible.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2026-01-13 20:08</div>
            <div class="timeline-body"><p>Thank you! I was on PTO last week, but I&#x27;m back now :) I&#x27;ll take a look soon.</p>
<blockquote>
<p>And since there are several commits here, do I need to squash them?</p>
</blockquote>
<p>Don&#x27;t worry about squashing, we&#x27;ll squash-merge at the end, so it&#x27;s easier to keep all the commits for review in the meantime.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/refurb/rules/metaclass_abcmeta.rs</code>:68 on 2026-01-13 20:12</div>
            <div class="timeline-body"><pre><code>    // Determine whether the class definition contains at least one argument.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/refurb/rules/metaclass_abcmeta.rs</code>:155 on 2026-01-13 20:25</div>
            <div class="timeline-body"><p>What do you think about something like this:</p>
<pre><code>        let delete_keyword = remove_argument(
            keyword,
            arguments,
            Parentheses::Remove,
            checker.source(),
            checker.tokens(),
        )?;

        Ok(if position &gt; 0 {
            // When the `abc.ABCMeta` is not the first keyword and `abc.ABC` is not
            // in base classes put `abc.ABC` before the first keyword argument.
            if has_abc {
                Fix::applicable_edit(delete_keyword, applicability)
            } else {
                Fix::applicable_edits(
                    delete_keyword,
                    [
                        Edit::insertion(format!(&quot;{binding}, &quot;), class_def.keywords()[0].start()),
                        import_edit,
                    ],
                    applicability,
                )
            }
        } else {
            let edit_action = if has_abc {
                // Class already inherits the `abc.ABC`, delete the `metaclass` keyword only.
                delete_keyword
            } else {
                // Replace `metaclass` keyword by `abc.ABC`.
                Edit::range_replacement(binding, keyword.range)
            };

            Fix::applicable_edits(edit_action, [import_edit], applicability)
        })
</code></pre>
<p>I factored out the <code>delete_keyword</code> edit and got rid of the <code>Vec</code>s by using two different <code>Fix</code> constructors. I don&#x27;t feel too strongly about the second part, but I think factoring out the shared deletion edit definitely makes sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/refurb/rules/metaclass_abcmeta.rs</code>:92 on 2026-01-13 20:32</div>
            <div class="timeline-body"><p>I think this is a pre-existing issue, but I&#x27;m pretty sure the fix should also be unsafe if there are comments in the range of the deletion. For example,</p>
<pre><code>import abc


class C(
    other_kwarg=1,
    # comment
    metaclass=abc.ABCMeta,
):
    pass
</code></pre>
<p>This comment gets <a href="https://play.ruff.rs/f64dfdc1-811d-466f-8e49-0f400e1859d0">deleted</a> but wouldn&#x27;t make the fix unsafe on main as far as I can tell.</p>
<p>Feel free to fix that here if you want, or I can open an issue for follow-up. We usually use a pattern like this:</p>
<p>https://github.com/astral-sh/ruff/blob/55a335165ab126d50edb89e775c0c5c340cb8ae3/crates/ruff_linter/src/rules/flake8_return/rules/function.rs#L406-L410</p>
<p>We&#x27;d also need to update the docs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2026-01-13 20:34</div>
            <div class="timeline-body"><p>Thank you! This looks great, I just had a couple of minor suggestions. I also noticed a potential issue with the fix safety, but I can turn that into a separate issue if you&#x27;d rather not update it here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/akawd">@akawd</a> on <code>crates/ruff_linter/src/rules/refurb/rules/metaclass_abcmeta.rs</code>:155 on 2026-01-16 19:59</div>
            <div class="timeline-body"><p>In my humble opinion, avoiding the heap is worth a few extra lines of code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/akawd">@akawd</a> reviewed on 2026-01-16 19:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/akawd">@akawd</a> reviewed on 2026-01-16 20:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/akawd">@akawd</a> on <code>crates/ruff_linter/src/rules/refurb/rules/metaclass_abcmeta.rs</code>:92 on 2026-01-16 20:07</div>
            <div class="timeline-body"><p>As far as I can see, the root cause of the comment deletion is (somewhere) here:
https://github.com/akawd/ruff/blob/d08e41417971f1d05b9daa75f794536a1dd4bedf/crates/ruff_linter/src/fix/edits.rs#L248</p>
<p>If this is a real issue, it may be better to be addressed in a separate issue?
Here, I simply added the unsafe marker to the class containing the comment:
<a href="https://github.com/astral-sh/ruff/pull/22234">astral-sh/ruff#22234</a>/changes/a2091751f553191f7af42777def94d5e522c423b</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/akawd">@akawd</a> on 2026-01-16 20:14</div>
            <div class="timeline-body"><p>@ntBre , sorry for delay with the answer.
Thank you for your suggestions, I added them.</p>
<p>Could you please clarify what docs you meant here?</p>
<blockquote>
<p>We&#x27;d also need to update the docs.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/ntBre">@ntBre</a> by <a href="https://github.com/akawd">@akawd</a> on 2026-01-16 20:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/refurb/rules/metaclass_abcmeta.rs</code>:92 on 2026-01-16 20:49</div>
            <div class="timeline-body"><p>Sorry, I think my comment here may have been a bit confusing! I&#x27;ll open a separate issue for this and try to explain the problem better.</p>
<p>Edit: <a href="https://github.com/astral-sh/ruff/issues/22631">astral-sh/ruff#22631</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2026-01-16 20:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/refurb/rules/metaclass_abcmeta.rs</code>:92 on 2026-01-16 20:57</div>
            <div class="timeline-body"><p>Oh oops, you took care of this, nice work! I should have looked at the code first. We just need to update the fix safety documentation on line 42 of this file to say that the fix can also be unsafe if it would remove comments in the base class list.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2026-01-16 20:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/refurb/rules/metaclass_abcmeta.rs</code>:97 on 2026-01-16 20:59</div>
            <div class="timeline-body"><p>I think we could narrow this to <code>keyword.range</code> instead of the whole <code>arguments.range()</code>, but I&#x27;m not totally sure:</p>
<pre><code>    } else if checker.comment_ranges().intersects(keyword.range()) {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/resources/test/fixtures/refurb/FURB180.py</code>:92 on 2026-01-16 21:02</div>
            <div class="timeline-body"><p>Could you add a test case for the unsafe comment deletion? I think something like this example would work well:</p>
<pre><code>class C(
    other_kwarg=1,
    # comment
    metaclass=abc.ABCMeta,
):
    pass
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2026-01-16 21:04</div>
            <div class="timeline-body"><p>Thank you! I had one suggestion about narrowing the comment range check and a test for that. Then we just need to update the <code>## Fix safety</code> section of the rule docs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/akawd">@akawd</a> reviewed on 2026-01-17 05:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/akawd">@akawd</a> on <code>crates/ruff_linter/src/rules/refurb/rules/metaclass_abcmeta.rs</code>:97 on 2026-01-17 05:00</div>
            <div class="timeline-body"><p>Thank you, but I have some comments about this...</p>
<p>At first, I implemented it like you said:</p>
<pre><code>} else if checker.comment_ranges().intersects(keyword.range()) {
</code></pre>
<p>and I used the following test to check this particular change:</p>
main.py
<pre><code>import abc

class Foo(
    other_kwarg=1,
    # comment
    metaclass=abc.ABCMeta,
):
    ...
</code></pre>
<p>I also added some debug messages in advance:</p>
<pre><code>    println!(&quot;Keyword range: {:?}&quot;, keyword.range());
    println!(&quot;Arguments range: {:?}&quot;, arguments.range());
    let applicability = if !class_def.bases().is_empty() {
</code></pre>
<p>When I run the <code>ruff</code>, it fixes the file:</p>
<pre><code>import abc

class Foo(
    abc.ABC, other_kwarg=1,
):
    ...
</code></pre>
<p>but <strong>without</strong> the notion about the unsafe-fix. The output:</p>
<pre><code>$ cargo run -p ruff -- check ../py --no-cache --fix
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.63s
     Running `target\debug\ruff.exe check ../py --no-cache --fix`
Keyword range: 65..86
Arguments range: 23..90
Found 1 error (1 fixed, 0 remaining).
</code></pre>
<p>In other words, the comment was removed but the fix was not considered as unsafe.</p>
<p>When I use the</p>
<pre><code>} else if checker.comment_ranges().intersects(arguments.range()) {
</code></pre>
<p>I have a proper message as I can see:</p>
<pre><code>$ cargo run -p ruff -- check ../py --no-cache --fix
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.66s
     Running `target\debug\ruff.exe check ../py --no-cache --fix`
Keyword range: 65..86
Arguments range: 23..90
FURB180 Use of `metaclass=abc.ABCMeta` to define abstract base class
 --&gt; C:\AK\Rust\py\main.py:6:5
  |
4 |     other_kwarg=1,
5 |     # comment
6 |     metaclass=abc.ABCMeta,
  |     ^^^^^^^^^^^^^^^^^^^^^
7 | ):
8 |     ...
  |
help: Replace with `abc.ABC`

Found 1 error.
No fixes available (1 hidden fix can be enabled with the `--unsafe-fixes` option).
</code></pre>
<p>Please let me know if I&#x27;m missing something. Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/akawd">@akawd</a> reviewed on 2026-01-17 05:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/akawd">@akawd</a> on <code>crates/ruff_linter/resources/test/fixtures/refurb/FURB180.py</code>:92 on 2026-01-17 05:03</div>
            <div class="timeline-body"><p>Sure, the test case was added: <a href="https://github.com/astral-sh/ruff/pull/22234">astral-sh/ruff#22234</a>/changes/9c429186ed3eb060415d1b67f4c5ae96ad64722b</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/akawd">@akawd</a> on 2026-01-17 05:05</div>
            <div class="timeline-body"><blockquote>
<p>Thank you! I had one suggestion about narrowing the comment range check and a test for that. Then we just need to update the <code>## Fix safety</code> section of the rule docs.</p>
</blockquote>
<p>Yep, updated the doc too: <a href="https://github.com/astral-sh/ruff/pull/22234">astral-sh/ruff#22234</a>/changes/0292c8776af8d87cfc3688e69a7a088184aad3d7</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/ntBre">@ntBre</a> by <a href="https://github.com/akawd">@akawd</a> on 2026-01-17 05:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:22:17 UTC
    </footer>
</body>
</html>
