<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add version hint for failed stdlib accesses - astral-sh/ruff #20909</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add version hint for failed stdlib accesses</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20909">#20909</a>
        opened by <a href="https://github.com/Gankra">@Gankra</a>
        on 2025-10-16 03:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/Gankra">@Gankra</a> on 2025-10-16 03:00</div>
            <div class="timeline-body"><p>This is the ultra-minimal implementation of</p>
<ul>
<li>https://github.com/astral-sh/ty/issues/296</li>
</ul>
<p>that was previously discussed as a good starting point. In particular we don't actually bother trying to figure out the exact python versions, but we still mention &quot;hey btw for No Reason At All... you're on python 3.10&quot; when you try to access something that has a definition rooted in the stdlib that we believe exists sometimes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @Gankra on 2025-10-16 03:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @Gankra on 2025-10-16 03:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @Gankra on 2025-10-16 03:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @Gankra on 2025-10-16 03:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @Gankra on 2025-10-16 03:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by @Gankra on 2025-10-16 03:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-16 03:02</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-16 03:04</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">scikit-build-core (https://github.com/scikit-build/scikit-build-core)
+ src/scikit_build_core/build/_wheelfile.py:51:22: error[no-matching-overload] No overload of function `field` matches arguments
- Found 51 diagnostics
+ Found 52 diagnostics

</code></pre>
</details>
No memory usage changes detected ✅

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @Gankra on 2025-10-16 03:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-10-16 03:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty/tests/cli/python_environment.rs</code>:980 on 2025-10-16 03:10</div>
            <div class="timeline-body"><p>Oh boy these are really verbose when it's not &quot;from the CLI&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-10-16 03:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/resources/mdtest/snapshots/super.md_-_Super_-_Basic_Usage_-_Explicit_Super_Objec…_(b753048091f275c0).snap</code>:132 on 2025-10-16 03:11</div>
            <div class="timeline-body"><p>These firing on <code>super</code> is so sad, I'm not sure if there's a good General rule that would exclude this and similar types.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types/diagnostic.rs</code>:3149 on 2025-10-16 06:43</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// stsnfstf library and `foo.bar` *does* exist as an attribute on *other*
</code></pre>
<p>The what library? <code>stsnfstf</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty/tests/cli/python_environment.rs</code>:980 on 2025-10-16 07:22</div>
            <div class="timeline-body"><p>Yeah. Rustc hides very verbose diagnostic details unless ran with <code>-v</code>. I added the infrastructure for it in https://github.com/astral-sh/ruff/pull/20912 but I also think it's sort of fine here since those diagnostics should be rare</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-10-16 07:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-16 07:24</div>
            <div class="timeline-body"><p>To be honest, I'm not sure if this initial step is a strict improvement. Sure, it seems helpful in the rare case where you are accessing an attribute that is not available on the Python version that you have configured, <em>but is available under the exact name on a higher version</em>.</p>
<p>But in the vast majority of <code>unresolved-attribute</code> cases (e.g. a misspelled attribute name, or an incomplete attribute name, because I'm still typing it), it just adds additional noise?</p>
<pre><code class="language-py">&quot;test.exe&quot;.trimsuffix(&quot;.exe&quot;)  # no, it's called &quot;replacesuffix&quot;
</code></pre>
<pre><code>error[unresolved-attribute]: Type `Literal[&quot;test.exe&quot;]` has no attribute `trimsuffix`
 --&gt; /home/shark/playground/test.py:4:1
  |
4 | &quot;test.exe&quot;.trimsuffix(&quot;.exe&quot;)
  | ^^^^^^^^^^^^^^^^^^^^^
  |
info: Python 3.14 was assumed when accessing `trimsuffix` because it was specified on the command line
info: rule `unresolved-attribute` is enabled by default
</code></pre>
<p>Note that the diagnostic change here does not show up in the ecosystem diff because <code>info</code> hints are not part of the concise message, but we have thousands of <code>unresolved-attribute</code> diagnostics <a href="https://ecosystem.ty.dev/">across the ecosystem</a>, most of which will be more verbose with this change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-16 10:52</div>
            <div class="timeline-body"><p>Yeah, I agree with @sharkdp that in its current state this could just add a lot of noise and not be that helpful :-(</p>
<p>But I think it's pretty easy to make a few adjustments to this so that it's less noisy, but still pretty useful. Something like this, where we do actually check that the exact symbol exists in the symbol table <em>somewhere</em> (the definition just isn't visible on this Python version), could work pretty well:</p>
<pre><code class="language-diff">diff --git a/crates/ty_python_semantic/src/semantic_index/place.rs b/crates/ty_python_semantic/src/semantic_index/place.rs
index 38e3d92816..75d3eaac65 100644
--- a/crates/ty_python_semantic/src/semantic_index/place.rs
+++ b/crates/ty_python_semantic/src/semantic_index/place.rs
@@ -181,7 +181,6 @@ impl PlaceTable {
     }
 
     /// Looks up a symbol by its name and returns a reference to it, if it exists.
-    #[cfg(test)]
     pub(crate) fn symbol_by_name(&amp;self, name: &amp;str) -&gt; Option&lt;&amp;Symbol&gt; {
         self.symbols.symbol_id(name).map(|id| self.symbol(id))
     }
diff --git a/crates/ty_python_semantic/src/types/diagnostic.rs b/crates/ty_python_semantic/src/types/diagnostic.rs
index f07d934dad..cb6bf8c4e7 100644
--- a/crates/ty_python_semantic/src/types/diagnostic.rs
+++ b/crates/ty_python_semantic/src/types/diagnostic.rs
@@ -9,6 +9,7 @@ use crate::lint::{Level, LintRegistryBuilder, LintStatus};
 use crate::module_resolver::file_to_module;
 use crate::semantic_index::definition::{Definition, DefinitionKind};
 use crate::semantic_index::place::{PlaceTable, ScopedPlaceId};
+use crate::semantic_index::{global_scope, place_table};
 use crate::suppression::FileSuppressionId;
 use crate::types::call::CallError;
 use crate::types::class::{DisjointBase, DisjointBaseKind, Field};
@@ -3155,6 +3156,16 @@ pub(super) fn hint_if_stdlib_attribute_exists_on_other_versions(
     value_type: &amp;Type,
     attr: &amp;Identifier,
 ) {
+    let Type::ModuleLiteral(module) = *value_type else {
+        return;
+    };
+    let Some(file) = module.module(db).file(db) else {
+        return;
+    };
+    let symbol_table = place_table(db, global_scope(db, file));
+    if symbol_table.symbol_by_name(attr).is_none() {
+        return;
+    }
     let Some(definition) = value_type.definition(db) else {
         return;
     };
</code></pre>
<p>This edit would mean that the suggestions would only fire on <code>unresolved-attribute</code> errors involving module-literal types. But I think probably most &quot;oops, I tried to access this attribute that only exists on a new Python version&quot; errors involve module-literal objects. So I think even this limited hint would help a lot of users and be a great first step.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-10-16 13:22</div>
            <div class="timeline-body"><p>Heh, I considered that implementation originally and was like &quot;wait I can do better, and modules are their own definitions so this handles those too!&quot;</p>
<p>Having seen the results, I agree it's a safer minimum.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-10-16 13:46</div>
            <div class="timeline-body"><p>Pushed up the new implementation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/diagnostic.rs</code>:3168 on 2025-10-16 13:52</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    // Version-dependent definitions are much more common in the stdlib
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/diagnostic.rs</code>:3175 on 2025-10-16 13:53</div>
            <div class="timeline-body"><p>it could also be in the symbol table for the global scope, but without a visible definition, if it's a platform-specific definition (the definition only exists in amn <code>if sys.platform == &quot;linux&quot;</code> branch, but their configured platform is <code>&quot;win32&quot;</code>). We could consider also highlighting the user's configured platform as well as their configured Python version. Doesn't need to be done in this PR, though</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-10-16 13:54</div>
            <div class="timeline-body"><p>Thank you, this is great!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @Gankra on 2025-10-16 14:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Gankra on 2025-10-16 14:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-10-16 14:07</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:35:00 UTC
    </footer>
</body>
</html>
