```yaml
number: 7663
title: "Compute `NotebookIndex` for `Diagnostics` on stdin"
type: pull_request
state: merged
author: dhruvmanila
labels:
  - bug
assignees: []
merged: true
base: main
head: dhruv/notebook-index-stdin
created_at: 2023-09-26T06:25:43Z
updated_at: 2023-09-29T20:44:54Z
url: https://github.com/astral-sh/ruff/pull/7663
synced_at: 2026-01-12T15:55:24Z
```

# Compute `NotebookIndex` for `Diagnostics` on stdin

---

_@dhruvmanila_

## Summary

This PR fixes the bug where the `NotebookIndex` was not being computed when
using stdin as the input source.

## Test Plan

On `main`, the diagnostic output won't include the cell number when using stdin
while it'll be included after this fix.

### `main`

```console
$ cat ~/playground/ruff/notebooks/test.ipynb | cargo run --bin ruff -- check --isolated --no-cache - --stdin-filename ~/playground/ruff/notebooks/test.ipynb
/Users/dhruv/playground/ruff/notebooks/test.ipynb:2:8: F401 [*] `math` imported but unused
/Users/dhruv/playground/ruff/notebooks/test.ipynb:7:8: F811 Redefinition of unused `random` from line 1
/Users/dhruv/playground/ruff/notebooks/test.ipynb:8:8: F401 [*] `pprint` imported but unused
/Users/dhruv/playground/ruff/notebooks/test.ipynb:12:4: F632 [*] Use `==` to compare constant literals
/Users/dhruv/playground/ruff/notebooks/test.ipynb:13:38: F632 [*] Use `==` to compare constant literals
Found 5 errors.
[*] 4 potentially fixable with the --fix option.
```

### `dhruv/notebook-index-stdin`

```console
$ cat ~/playground/ruff/notebooks/test.ipynb | cargo run --bin ruff -- check --isolated --no-cache - --stdin-filename ~/playground/ruff/notebooks/test.ipynb       
/Users/dhruv/playground/ruff/notebooks/test.ipynb:cell 3:2:8: F401 [*] `math` imported but unused
/Users/dhruv/playground/ruff/notebooks/test.ipynb:cell 5:1:8: F811 Redefinition of unused `random` from line 1
/Users/dhruv/playground/ruff/notebooks/test.ipynb:cell 5:2:8: F401 [*] `pprint` imported but unused
/Users/dhruv/playground/ruff/notebooks/test.ipynb:cell 6:2:4: F632 [*] Use `==` to compare constant literals
/Users/dhruv/playground/ruff/notebooks/test.ipynb:cell 6:3:38: F632 [*] Use `==` to compare constant literals
Found 5 errors.
[*] 4 potentially fixable with the --fix option.
```


---

_Comment by @dhruvmanila on 2023-09-26 06:25_

Current dependencies on/for this PR:
* main
  * **PR #7662** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7662" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7663** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7663" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
      * **PR #7664** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7664" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7663?utm_source=stack-comment).

---

_@dhruvmanila reviewed on 2023-09-26 06:33_

---

_Review comment by @dhruvmanila on `crates/ruff_cli/src/diagnostics.rs`:346 on 2023-09-26 06:33_

This change is to keep the value consistent. We use `.to_string_lossy` everywhere.

---

_Renamed from "Compute `NotebookIndex` to `Diagnostics` on stdin" to "Compute `NotebookIndex` for `Diagnostics` on stdin" by @dhruvmanila on 2023-09-26 06:33_

---

_Label `bug` added by @dhruvmanila on 2023-09-26 06:35_

---

_Review requested from @konstin by @dhruvmanila on 2023-09-26 06:46_

---

_Review requested from @MichaReiser by @dhruvmanila on 2023-09-26 06:46_

---

_Comment by @github-actions[bot] on 2023-09-26 06:50_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.



---

_@konstin approved on 2023-09-26 09:06_

---

_Review comment by @MichaReiser on `crates/ruff_cli/src/diagnostics.rs`:479 on 2023-09-26 11:09_

Nit: Add an `into_index()` method to avoid cloning the notebook

---

_Review comment by @MichaReiser on `crates/ruff_cli/src/diagnostics.rs`:478 on 2023-09-26 11:11_

My understanding is that we don't perform any caching when using stdin. 

---

_@MichaReiser reviewed on 2023-09-26 11:11_

---

_Review comment by @charliermarsh on `crates/ruff_cli/src/diagnostics.rs`:478 on 2023-09-28 23:42_

I think this is copied over from `lint_path`, but I don't fully understand it in the context of `lint_path`. Don't we need to compute the index to report diagnostics, not just store in the cache?

---

_@charliermarsh reviewed on 2023-09-28 23:42_

---

_@charliermarsh reviewed on 2023-09-29 20:27_

---

_Review comment by @charliermarsh on `crates/ruff_cli/src/diagnostics.rs`:479 on 2023-09-29 20:27_

Added.

---

_@charliermarsh reviewed on 2023-09-29 20:27_

---

_Review comment by @charliermarsh on `crates/ruff_cli/src/diagnostics.rs`:478 on 2023-09-29 20:27_

I removed these comments as I found them sorta unhelpful.

---

_@charliermarsh reviewed on 2023-09-29 20:31_

---

_Review comment by @charliermarsh on `crates/ruff_cli/src/diagnostics.rs`:478 on 2023-09-29 20:31_

(I think this comment made sense in the PR in which it was introduced because it was a change, but it's less helpful in isolation.)

---

_@charliermarsh approved on 2023-09-29 20:31_

---

_Merged by @charliermarsh on 2023-09-29 20:37_

---

_Closed by @charliermarsh on 2023-09-29 20:37_

---

_Branch deleted on 2023-09-29 20:37_

---

_Comment by @codspeed-hq[bot] on 2023-09-29 20:38_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/dhruv/notebook-index-stdin)

### Merging #7663 will **improve performances by 3.95%**

<sub>Comparing <code>dhruv/notebook-index-stdin</code> (089c7fa) with <code>main</code> (b528006)</sub>



### Summary

`âš¡ 1` improvements
`âœ… 24` untouched benchmarks




### Benchmarks breakdown

|     | Benchmark | `main` | `dhruv/notebook-index-stdin` | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| âš¡ | `linter/default-rules[large/dataset.py]` | 95.7 ms | 92.1 ms | +3.95% |


---
