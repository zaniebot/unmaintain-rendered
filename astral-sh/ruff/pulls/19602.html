<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Don't panic with argument that doesn't actually implement Iterable - astral-sh/ruff #19602</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Don&#x27;t panic with argument that doesn&#x27;t actually implement Iterable</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19602">#19602</a>
        opened by <a href="https://github.com/dcreager">@dcreager</a>
        on 2025-07-28 14:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a></div>
            <div class="timeline-body"><p>This eliminates the panic reported in <a href="https://github.com/astral-sh/ty/issues/909">astral-sh/ty#909</a>, though it doesn&#x27;t address the underlying cause, which is that we aren&#x27;t yet checking the types of the fields of a protocol when checking whether a class implements the protocol. And in particular, if a class explictly opts out of iteration via</p>
<pre><code>class NotIterable:
    __iter__ = None
</code></pre>
<p>we currently treat that as &quot;having an <code>__iter__</code>&quot; member, and therefore implementing <code>Iterable</code>.</p>
<p>Note that the assumption that was in the comment before is still correct: call binding will have already checked that the argument satisfies <code>Iterable</code>, and so it shouldn&#x27;t be an error to iterate over said argument. But arguably, the new logic in this PR is a better way to discharge that assumption â€” instead of panicking if we happen to be wrong, fall back on an unknown iteration result.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/dcreager">@dcreager</a> on 2025-07-28 14:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/dcreager">@dcreager</a> on 2025-07-28 14:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/dcreager">@dcreager</a> on 2025-07-28 14:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-28 14:39</div>
            <div class="timeline-body">

Diagnostic diff on typing conformance tests
<p>No changes detected when running ty on typing conformance tests âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-07-28 14:40</div>
            <div class="timeline-body"><p>I&#x27;d prefer it if we could emit a tracing warning to say that the invariant has been broken before falling back to <code>Unknown</code> here. But I agree that we should get rid of the <code>.expect()</code> for now, until our <code>Protocol</code> implementation is more robust</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-28 14:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-28 14:42</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected âœ…
No memory usage changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-28 14:42</div>
            <div class="timeline-body"><blockquote>
<p>I&#x27;d prefer it if we could emit a tracing warning to say that the invariant has been broken before falling back to Unknown here. But I agree that we should get rid of the .expect() for now, until our Protocol implementation is more robust</p>
</blockquote>
<p>Not sure if you implied a tracing message with severity <code>warning</code>. But this message should only use <code>debug</code> because there isn&#x27;t anything a user can do about it. As I understand it, it&#x27;s more a warning for us devs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-07-28 14:43</div>
            <div class="timeline-body"><blockquote>
<p>As I understand it, it&#x27;s more a warning for us devs.</p>
</blockquote>
<p>That&#x27;s correct, it&#x27;s for us. If we want something noisy to indicate to us that our semantics are broken, arguably that&#x27;s exactly what the panic was for. Would it be better to just leave that in place?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-28 14:45</div>
            <div class="timeline-body"><blockquote>
<p>If we want something noisy to indicate to us that our semantics are broken, arguably that&#x27;s exactly what the panic was for.</p>
</blockquote>
<p>yes, that&#x27;s why I added the <code>.expect()</code> call in the first place! But given that this is the second crash report we&#x27;ve received about it (the first one was <a href="https://github.com/astral-sh/ty/issues/764">astral-sh/ty#764</a>), I think we should get rid of it for now.</p>
<p>A <code>debug</code>-level trace sounds good to me</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-28 14:48</div>
            <div class="timeline-body"><p>Essentially my opinion is: ideally we will at some point add this <code>.expect()</code> call back (it&#x27;s obviously been pretty good so far at pointing out places where our invariants have not held ðŸ˜†) but right now it seems too early to have it there. It&#x27;s just failing too often right now, due to known missing features.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-07-28 14:51</div>
            <div class="timeline-body"><blockquote>
<p>A <code>debug</code>-level trace sounds good to me</p>
</blockquote>
<p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-07-28 14:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dcreager">@dcreager</a> on 2025-07-28 16:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dcreager">@dcreager</a> on 2025-07-28 16:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-28 16:09</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:17:06 UTC
    </footer>
</body>
</html>
