<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Don't panic with argument that doesn't actually implement Iterable - astral-sh/ruff #19602</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Don't panic with argument that doesn't actually implement Iterable</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19602">#19602</a>
        opened by <a href="https://github.com/dcreager">@dcreager</a>
        on 2025-07-28 14:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a></div>
            <div class="timeline-body"><p>This eliminates the panic reported in https://github.com/astral-sh/ty/issues/909, though it doesn't address the underlying cause, which is that we aren't yet checking the types of the fields of a protocol when checking whether a class implements the protocol. And in particular, if a class explictly opts out of iteration via</p>
<pre><code class="language-py">class NotIterable:
    __iter__ = None
</code></pre>
<p>we currently treat that as &quot;having an <code>__iter__</code>&quot; member, and therefore implementing <code>Iterable</code>.</p>
<p>Note that the assumption that was in the comment before is still correct: call binding will have already checked that the argument satisfies <code>Iterable</code>, and so it shouldn't be an error to iterate over said argument. But arguably, the new logic in this PR is a better way to discharge that assumption â€” instead of panicking if we happen to be wrong, fall back on an unknown iteration result.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dcreager on 2025-07-28 14:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dcreager on 2025-07-28 14:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @dcreager on 2025-07-28 14:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-28 14:39</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on typing conformance tests</h2>
<p>No changes detected when running ty on typing conformance tests âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-07-28 14:40</div>
            <div class="timeline-body"><p>I'd prefer it if we could emit a tracing warning to say that the invariant has been broken before falling back to <code>Unknown</code> here. But I agree that we should get rid of the <code>.expect()</code> for now, until our <code>Protocol</code> implementation is more robust</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-07-28 14:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-28 14:42</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…
No memory usage changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-28 14:42</div>
            <div class="timeline-body"><blockquote>
<p>I'd prefer it if we could emit a tracing warning to say that the invariant has been broken before falling back to Unknown here. But I agree that we should get rid of the .expect() for now, until our Protocol implementation is more robust</p>
</blockquote>
<p>Not sure if you implied a tracing message with severity <code>warning</code>. But this message should only use <code>debug</code> because there isn't anything a user can do about it. As I understand it, it's more a warning for us devs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-07-28 14:43</div>
            <div class="timeline-body"><blockquote>
<p>As I understand it, it's more a warning for us devs.</p>
</blockquote>
<p>That's correct, it's for us. If we want something noisy to indicate to us that our semantics are broken, arguably that's exactly what the panic was for. Would it be better to just leave that in place?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-28 14:45</div>
            <div class="timeline-body"><blockquote>
<p>If we want something noisy to indicate to us that our semantics are broken, arguably that's exactly what the panic was for.</p>
</blockquote>
<p>yes, that's why I added the <code>.expect()</code> call in the first place! But given that this is the second crash report we've received about it (the first one was https://github.com/astral-sh/ty/issues/764), I think we should get rid of it for now.</p>
<p>A <code>debug</code>-level trace sounds good to me</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-28 14:48</div>
            <div class="timeline-body"><p>Essentially my opinion is: ideally we will at some point add this <code>.expect()</code> call back (it's obviously been pretty good so far at pointing out places where our invariants have not held ðŸ˜†) but right now it seems too early to have it there. It's just failing too often right now, due to known missing features.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-07-28 14:51</div>
            <div class="timeline-body"><blockquote>
<p>A <code>debug</code>-level trace sounds good to me</p>
</blockquote>
<p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-07-28 14:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dcreager on 2025-07-28 16:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dcreager on 2025-07-28 16:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-28 16:09</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:14:37 UTC
    </footer>
</body>
</html>
