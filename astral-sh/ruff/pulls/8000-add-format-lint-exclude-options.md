```yaml
number: 8000
title: "Add `[format|lint].exclude` options"
type: pull_request
state: merged
author: MichaReiser
labels:
  - configuration
  - formatter
assignees: []
merged: true
base: main
head: format-lint-exclude-option
created_at: 2023-10-17T03:01:00Z
updated_at: 2024-01-16T10:03:22Z
url: https://github.com/astral-sh/ruff/pull/8000
synced_at: 2026-01-10T22:57:09Z
```

# Add `[format|lint].exclude` options

---

_Pull request opened by @MichaReiser on 2023-10-17 03:01_

## Summary

This PR introduces the new options `lint.exclude` and `format.exclude` that allow excluding files from linting or formatting only. 

Being able to exclude entire files is useful when:

* you have generated code that you only want to format but not lint (or the other way round)
* you have sub modules that you only want to lint because the code isn't using a formatter yet (but the rest of the project is)
 

Closes https://github.com/astral-sh/ruff/issues/7645

## Considerations

The `check` command (and now the format command) exposes the `exclude` option. This is the global `exclude` and not the `lint.exclude` or `format.exclude`. Only exposing the global `exclude` option should be sufficient and make little difference except if the user wants to clear out the `lint|format.exclude` option via the CLI. 

Only exposing the global `exclude` option makes sense for me, considering that we plan to unify linting and formatting under the `check` command in the future. Whether this is the right design for `format` is less clear to me but I think it's in line with `check` and we can still decide to add a `format-exclude` CLI option if it proves necessary.

## Test Plan

I added new integration tests that test the tool specific exclusion. 

I played around with the `airflow` repository and excluded files for linting or formatting only and verified that they are only excluded for the specific tool (and the result is the same as when excluding the files globally). Verified that a file passed directly gets linted/formated regardless if it is excluded or not.


---

_Comment by @MichaReiser on 2023-10-17 03:01_

Current dependencies on/for this PR:
* main
  * **PR #8000** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8000" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #8002** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8002" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #8032** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8032" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #8006** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8006" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #8035** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8035" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #8010** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8010" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
            * **PR #8082** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8082" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
              * **PR #8088** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8088" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
            * **PR #8039** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8039" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #8031** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8031" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/8000?utm_source=stack-comment).

---

_Review comment by @MichaReiser on `crates/ruff_cli/src/commands/check_stdin.rs`:26 on 2023-10-17 03:06_

It's a bit annoying that we have to duplicate this check everywhere. It would be nice to have a single CLI logic that handles the traversal of all files and decides if a file is eligible for a specific tool... Another day

---

_Review comment by @MichaReiser on `crates/ruff_workspace/src/options.rs`:380 on 2023-10-17 03:09_

The `LintCommonOptions` is necessary because we don't want to flatten the `exclude` option into the top-level settings (would  conflict with the global `exclude` setting)

---

_Review comment by @MichaReiser on `crates/ruff_workspace/src/resolver.rs`:281 on 2023-10-17 03:10_

I had to introduce a new `ResolvedFile` type to know whether the file was explicitly passed to the CLI or not. I could have used `DirEntry::depth` but I found that it leaks internal details about `python_files_in_path`

---

_@MichaReiser reviewed on 2023-10-17 03:11_

---

_Label `formatter` added by @MichaReiser on 2023-10-17 03:29_

---

_Label `configuration` added by @MichaReiser on 2023-10-17 03:29_

---

_Comment by @github-actions[bot] on 2023-10-17 03:45_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.



---

_Marked ready for review by @MichaReiser on 2023-10-17 06:29_

---

_Review requested from @charliermarsh by @MichaReiser on 2023-10-17 06:30_

---

_Review requested from @konstin by @MichaReiser on 2023-10-17 06:30_

---

_Comment by @MichaReiser on 2023-10-17 06:54_

@charliermarsh what's your preferred way to incorporate these extensions to the documentation? Should I open a PR to your documentation PR or do you want to write the documentation yourself?

---

_Review comment by @konstin on `crates/ruff_cli/src/commands/check.rs`:115 on 2023-10-17 09:00_

nit: the `.is_empty()` check should be inside `match_exclusion`

---

_Review comment by @konstin on `crates/ruff_cli/src/commands/check.rs`:208 on 2023-10-17 09:09_

This needs a comment what it does 

---

_Review comment by @konstin on `crates/ruff_cli/tests/format.rs`:16 on 2023-10-17 09:14_

What's the reason for removing the isolated here?

---

_Review comment by @konstin on `crates/ruff_workspace/src/options.rs`:2505 on 2023-10-17 09:24_

I dislike that we have effectively three copies of this but i don't have a good solution either unfortunately

---

_Review comment by @konstin on `crates/ruff_workspace/src/resolver.rs`:311 on 2023-10-17 09:26_

```suggestion
    // How to avoid filtering out files that have been explicitly passed.
```

Good question, intuitively i'd say force exclude applies to a subcommand overall so it applies to all excludes

---

_@konstin approved on 2023-10-17 09:28_

---

_@charliermarsh reviewed on 2023-10-17 15:11_

---

_Review comment by @charliermarsh on `crates/ruff_workspace/src/options.rs`:380 on 2023-10-17 15:11_

Can this be removed when we remove the top-level lint options support?

---

_@zanieb reviewed on 2023-10-17 16:15_

---

_Review comment by @zanieb on `crates/ruff_workspace/src/options.rs`:380 on 2023-10-17 16:15_

I think that's the plan!

---

_Review comment by @zanieb on `crates/ruff_workspace/src/options.rs`:380 on 2023-10-17 16:15_

I think we should probably wait a while to drop support for top-level lint options though, maybe 0.3? maybe later? We should open a tracking issue we can add todos to

---

_@zanieb reviewed on 2023-10-17 16:15_

---

_@MichaReiser reviewed on 2023-10-17 23:40_

---

_Review comment by @MichaReiser on `crates/ruff_workspace/src/options.rs`:380 on 2023-10-17 23:40_

> Can this be removed when we remove the top-level lint options support?
Yes

> I think we should probably wait a while to drop support for top-level lint options though, maybe 0.3? maybe later? We should open a tracking issue we can add todos to

I don't know the timeline yet but my thinking is:

* Not before we ship the stable formatter (the main goal of the beta is to get feedback on the configuration)
* Promote the `lint` section over the `formatter` section (by changing the documentation)
* Deprecate the top-level settings
* Eventually, remove support for top-level lint settings

I expect this to be 0.3+, maybe even 1.0

---

_@MichaReiser reviewed on 2023-10-18 00:59_

---

_Review comment by @MichaReiser on `crates/ruff_cli/src/commands/check.rs`:115 on 2023-10-18 00:59_

I ended up removing it. `Globset.matches` has an early `is_empty` check. 

---

_Merged by @MichaReiser on 2023-10-18 01:15_

---

_Closed by @MichaReiser on 2023-10-18 01:15_

---

_Branch deleted on 2023-10-18 01:15_

---

_Branch restored on 2023-10-18 01:16_

---

_Branch deleted on 2024-01-16 10:03_

---
