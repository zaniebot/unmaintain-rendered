```yaml
number: 4247
title: Fix jemalloc page size on aarch64
type: pull_request
state: merged
author: MichaReiser
labels: []
assignees: []
merged: true
base: main
head: fix-aarch64-build
created_at: 2023-05-05T15:51:37Z
updated_at: 2023-05-08T06:10:05Z
url: https://github.com/astral-sh/ruff/pull/4247
synced_at: 2026-01-12T15:55:15Z
```

# Fix jemalloc page size on aarch64

---

_@MichaReiser_

This pr sets the jemalloc large page size on aarch64 to fix a panic during start.

I changed the `Install wheel` step to a `Test wheel` step that installs the wheel and runs `ruff --help`. Just to make sure we never publish something that's installable but doesn't run at all.

## Test Plan

* I triggered a [run](https://github.com/charliermarsh/ruff/actions/runs/4895523055/jobs/8741206236) that uses a page size of three and verified that it fails (ensures that it uses the environment variable)
* I triggered a [run](https://github.com/charliermarsh/ruff/actions/runs/4895642681/jobs/8741465153) that uses the correct page size of 16


@v1c77 Would you mind downloading the [binaries](https://github.com/charliermarsh/ruff/suites/12705945862/artifacts/682048513) from the GitHub Action run, try to run the aarch64 (musl or non musl) binary, and let me know if it runs on your machine?



---

_Comment by @MichaReiser on 2023-05-05 15:51_

Current dependencies on/for this PR:
* main
  * **PR #4247** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4247" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/charliermarsh/ruff/4247?utm_source=stack-comment).

---

_@MichaReiser reviewed on 2023-05-05 15:51_

---

_Review comment by @MichaReiser on `.github/workflows/release.yaml`:353 on 2023-05-05 15:51_

Just for safety reasons :D

---

_Comment by @github-actions[bot] on 2023-05-05 16:03_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     17.1Â±0.45ms     2.4 MB/sec    1.01     17.3Â±0.35ms     2.4 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.1Â±0.12ms     4.1 MB/sec    1.02      4.1Â±0.13ms     4.0 MB/sec
linter/all-rules/numpy/globals.py          1.00   519.4Â±14.94Âµs     5.7 MB/sec    1.02   530.2Â±21.94Âµs     5.6 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.1Â±0.26ms     3.6 MB/sec    1.01      7.2Â±0.16ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.00      8.3Â±0.19ms     4.9 MB/sec    1.01      8.4Â±0.19ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1790.7Â±56.92Âµs     9.3 MB/sec    1.01  1803.4Â±49.25Âµs     9.2 MB/sec
linter/default-rules/numpy/globals.py      1.00    209.9Â±7.67Âµs    14.1 MB/sec    1.04    219.1Â±8.66Âµs    13.5 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.7Â±0.09ms     6.8 MB/sec    1.01      3.8Â±0.11ms     6.8 MB/sec
parser/large/dataset.py                    1.00      6.6Â±0.15ms     6.2 MB/sec    1.02      6.7Â±0.22ms     6.0 MB/sec
parser/numpy/ctypeslib.py                  1.00  1295.0Â±55.75Âµs    12.9 MB/sec    1.01  1304.0Â±32.66Âµs    12.8 MB/sec
parser/numpy/globals.py                    1.00    129.6Â±4.17Âµs    22.8 MB/sec    1.03    133.4Â±5.31Âµs    22.1 MB/sec
parser/pydantic/types.py                   1.00      2.8Â±0.07ms     9.0 MB/sec    1.02      2.9Â±0.09ms     8.8 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     16.3Â±0.16ms     2.5 MB/sec    1.02     16.6Â±0.21ms     2.4 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.02      4.2Â±0.05ms     4.0 MB/sec    1.00      4.1Â±0.04ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.02    490.8Â±6.28Âµs     6.0 MB/sec    1.00    483.3Â±6.79Âµs     6.1 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.9Â±0.08ms     3.7 MB/sec    1.01      7.0Â±0.10ms     3.7 MB/sec
linter/default-rules/large/dataset.py      1.00      8.3Â±0.08ms     4.9 MB/sec    1.02      8.5Â±0.10ms     4.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1764.3Â±19.75Âµs     9.4 MB/sec    1.01  1780.5Â±20.47Âµs     9.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    197.3Â±4.89Âµs    15.0 MB/sec    1.00    196.8Â±4.58Âµs    15.0 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.7Â±0.04ms     6.8 MB/sec    1.00      3.7Â±0.06ms     6.8 MB/sec
parser/large/dataset.py                    1.00      6.7Â±0.04ms     6.0 MB/sec    1.01      6.8Â±0.07ms     6.0 MB/sec
parser/numpy/ctypeslib.py                  1.00  1286.9Â±15.83Âµs    12.9 MB/sec    1.01  1305.2Â±17.55Âµs    12.8 MB/sec
parser/numpy/globals.py                    1.00    131.8Â±2.12Âµs    22.4 MB/sec    1.01    132.5Â±1.88Âµs    22.3 MB/sec
parser/pydantic/types.py                   1.00      2.9Â±0.02ms     8.9 MB/sec    1.01      2.9Â±0.03ms     8.8 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Marked ready for review by @MichaReiser on 2023-05-05 17:10_

---

_Review requested from @konstin by @MichaReiser on 2023-05-05 17:10_

---

_Comment by @v1c77 on 2023-05-06 03:26_

â€‹Looks like the issue has been fixed and these bin files work fine in my aarch64 env with no matter inside or outside the container.â€‹

```
[root@dev-aarch64 ruff]# tar -zxvf ruff-aarch64-unknown-linux-gnu.tar.gz
ruff
[root@dev-aarch64 ruff]# ./ruff --help
Ruff: An extremely fast Python linter.

Usage: ruff [OPTIONS] <COMMAND>

Commands:
  check   Run Ruff on the given files or directories (default)
  rule    Explain a rule
  config  List or describe the available configuration options
  linter  List all supported upstream linters
  clean   Clear any caches in the current directory and any subdirectories
  help    Print this message or the help of the given subcommand(s)

Options:
  -h, --help     Print help
  -V, --version  Print version

Log levels:
  -v, --verbose  Enable verbose logging
  -q, --quiet    Print lint violations, but nothing else
  -s, --silent   Disable all logging (but still exit with status code "1" upon detecting lint violations)

For help with a specific command, see: `ruff help <command>`.

[root@dev-aarch64 ruff]# ./ruff check ../
/root/proj/src/lib/zk.py:250:29: F841 [*] Local variable `e` is assigned to but never used
/root/proj/src/meta/mock_server.py:7:12: F401 [*] `proto.common_pb2.PExtent` imported but unused
/root/proj/tests/client/meta/mock_server.py:70:43: E712 [*] Comparison to `True` should be `cond is True` or `if cond:`
/root/proj/tests/client/meta/test_client.py:197:9: F841 [*] Local variable `ret3` is assigned to but never used
/root/proj/tests/common/events_test.py:5:8: F401 [*] `pytest` imported but unused

----
As well as the ruff-aarch64-unknown-linux-musl.tar.gz 
```

---

_Comment by @MichaReiser on 2023-05-06 10:46_

> â€‹Looks like the issue has been fixed and these bin files work fine in my aarch64 env with no matter inside or outside the container.â€‹

Awesome. Thank you for testing this so quickly and I'm sorry that I didn't had the time to fix this sooner. I hope this will be part of our next release. 

---

_Review comment by @konstin on `.github/workflows/release.yaml`:196 on 2023-05-06 11:27_

```suggestion
            # see https://github.com/charliermarsh/ruff/issues/3791
            # and https://github.com/gnzlbg/jemallocator/issues/170#issuecomment-1503228963
            maturin_docker_options: -e JEMALLOC_SYS_WITH_LG_PAGE=16
```

---

_@konstin approved on 2023-05-06 11:27_

---

_@charliermarsh approved on 2023-05-06 18:12_

---

_Renamed from "Fix jemalloc page size on aarch64" to "Fix jemalloc page size on aarch64" by @MichaReiser on 2023-05-08 06:10_

---

_Merged by @MichaReiser on 2023-05-08 06:10_

---

_Closed by @MichaReiser on 2023-05-08 06:10_

---

_Branch deleted on 2023-05-08 06:10_

---
