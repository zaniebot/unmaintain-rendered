<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Make `Definition` a salsa-ingredient - astral-sh/ruff #12151</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Make <code>Definition</code> a salsa-ingredient</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/12151">#12151</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-07-02 13:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR largely replaces https://github.com/astral-sh/ruff/pull/11971 and is a first step towards definition-level type inference.</p>
<p>The main change is that this PR makes <code>Definition</code> a Salsa ingredient. This will allow us to create queries that take a <code>Definition</code> as an argument.</p>
<p>Other changes:</p>
<ul>
<li>I removed <code>scopes_map</code> and instead store the mapping from file-local to the salsa-ingredient <code>ScopeId</code> directly on the <code>SemanticIndex</code>. The main motivation for the change is that <code>ScopeId</code> now stores the <code>AstNodeRef</code> of the node that created this scope. We need the node in <code>infer_types(db, scope)</code></li>
<li>I removed a lot of unused code from <code>ast_ids</code>. We might be able to simplify it further but I prefer to do this as a separate PR (maybe once we have a better understanding for definition-level inference)</li>
</ul>
<h2>Performance</h2>
<p>My main concern is performance. The new proposed Salsa design should mitigate most of it. The only thing that's unclear to me is if creating many Salsa ingredients can lead to congestion  because all of them need to pick the next slot from the ingredient's free-list.</p>
<h2>Test Plan</h2>
<p><code>cargo test</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index.rs</code>:94 on 2024-07-02 13:21</div>
            <div class="timeline-body"><p>This replaces the <code>scopes_map</code>. I don't think it gives us much when we have more fine-grained queries in general</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index.rs</code>:88 on 2024-07-02 13:22</div>
            <div class="timeline-body"><p>This is new. We now need to track an extra map from <code>node</code> to <code>Definition</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index.rs</code>:172 on 2024-07-02 13:24</div>
            <div class="timeline-body"><p>This is now replaced by <code>Definition::scope</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/ast_ids.rs</code>:40 on 2024-07-02 13:26</div>
            <div class="timeline-body"><p>We don't really need this anymore. Just storing them on the <code>Definition</code> and <code>NodeWithScope</code> is easier. It has the downside that we now create two <code>AstNodeRef</code> nodes for <code>Function</code>s and <code>Class</code>es. I think that's fine but we'll see. We can always go back to something more complicated if needed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/ast_ids.rs</code>:29 on 2024-07-02 13:30</div>
            <div class="timeline-body"><p>We never lookup the expression node by an id. All we need is a unique ID. We may want to reconsider this more holistically, but I would rather not do it as part of this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @MichaReiser on 2024-07-02 13:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MichaReiser on 2024-07-02 13:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2024-07-02 13:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-02 13:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-07-02 14:00</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/semantic_index/definition.rs</code>:23 on 2024-07-03 21:12</div>
            <div class="timeline-body"><p>What are the implications of using <code>no_eq</code> here?</p>
<p>I'm not totally clear on how this all works, but it's important that two different definitions of the same symbol in the same scope are still considered different definitions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/semantic_index/definition.rs</code>:132 on 2024-07-03 21:15</div>
            <div class="timeline-body"><p>Is this <code>From</code> impl used? Why implement <code>From</code> just for <code>ExprName</code> and not other exprs?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/semantic_index/definition.rs</code>:34 on 2024-07-03 21:18</div>
            <div class="timeline-body"><p>Both the <code>Alias</code> and <code>Target</code> variants here will require walking up the AST to parents of the referenced node in order to get the necessary context to understand/resolve the definition. For <code>Alias</code> because we need info from the enclosing import node, and for <code>Target</code> because we also need to look at the targets of the assignment statement, not just the assigned (RHS) expression.</p>
<p>Is this going to be a problem? Do we have an efficient way of walking up the AST?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/semantic_index/symbol.rs</code>:26 on 2024-07-03 21:25</div>
            <div class="timeline-body"><p>FWIW, ultimately with CFG I'm not sure we'll even need this, because what will matter are reachable definitions from a given use, not all definitions of a symbol. This might be relevant because it would remove the db lifetime from the symbol table again.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-07-03 21:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/semantic_index/definition.rs</code>:34 on 2024-07-03 21:54</div>
            <div class="timeline-body"><p>I think this is not currently a problem because in the current code we are still only doing per-scope inference, so we always reach the alias in the context of visiting the import statement. But I think it will be a problem when we actually try to do inference on a Definition in isolation, and the ability to do that is the whole point of Definition being an ingredient.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-07-03 21:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-04 06:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/symbol.rs</code>:26 on 2024-07-04 06:13</div>
            <div class="timeline-body"><p>Won't this be necessary when inferring the public type of a symbol where we unify the type of all definitions?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-04 06:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/definition.rs</code>:34 on 2024-07-04 06:16</div>
            <div class="timeline-body"><p>Yeah, I think we may want to change the representation. The good thing is, we very easily can. There's no constraint that a variant can only contain a single node. We can go back to storing the <code>ModuleName</code> and <code>Identifier</code> of the import or store the <code>Import</code> stmt with the alias's index. For now, what we have here is sufficient and is why I designed it this way.</p>
<p>Note: There might be some complication in how we build the map from <code>node</code> to <code>definition</code> because today <code>node</code> and the <code>definition</code> are kind of the same. Changing the granularity would e.g. mean that we map from <code>alias</code> to a definition storing a statement. But again, I don't think this breaks the design, it just complicates things a little more.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-04 06:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/definition.rs</code>:23 on 2024-07-04 06:18</div>
            <div class="timeline-body"><p>The <code>no_eq</code> doesn't influence the definition's identity.</p>
<p>You can think of each field of a salsa-tracked as a salsa query. A query depending on the <code>symbol_id</code> field only gets re-executed if the <code>symbol_id</code> at <code>t1</code> is not equal to the <code>symbol_id</code> at <code>t2</code>.</p>
<p>The <code>no_eq</code> removes that optimization, and any query depending on the <code>Definition</code> will re-execute whenever the definition changes. Which is whenever the AST changes and that seems correct.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/definition.rs</code>:132 on 2024-07-04 06:41</div>
            <div class="timeline-body"><p>You're an observant reviewer! No, it isn't.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-04 06:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2024-07-04 06:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-07-04 06:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-07-04 06:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-07-05 22:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/semantic_index/symbol.rs</code>:26 on 2024-07-05 22:22</div>
            <div class="timeline-body"><p>I think public type should be &quot;reachable from end of scope&quot; not &quot;all definitions&quot; -- but either way, if we associate uses with a list of definitions, &quot;public type&quot; is just one more &quot;use&quot; -- we don't have to embed all definitions directly in the symbol itself.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:05:09 UTC
    </footer>
</body>
</html>
