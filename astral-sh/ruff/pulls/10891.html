<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pylint`] Re-implement `unreachable` (`PLW0101`) - astral-sh/ruff #10891</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pylint</code>] Re-implement <code>unreachable</code> (<code>PLW0101</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10891">#10891</a>
        opened by <a href="https://github.com/augustelalande">@augustelalande</a>
        on 2024-04-11 22:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/augustelalande">@augustelalande</a> on 2024-04-11 22:36</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR re-introduces the control-flow graph implementation which was first introduced in #5384, and then removed in #9463 due to not being feature complete. Mainly, it lacked the ability to process <code>try</code>-<code>except</code> blocks, along with some more minor bugs.</p>
<p>Closes #8958 and #8959 and #14881.</p>
<h2>Overview of Changes</h2>
<p>I will now highlight the major changes implemented in this PR, in order of implementation.</p>
<ol>
<li>Introduced a post-processing step in loop handling to find any <code>continue</code> or <code>break</code> statements within the loop body and redirect them appropriately.</li>
<li>Introduced a loop-continue block which is always placed at the end of loop blocks, and ensures proper looping regardless of the internal logic of the block. This resolves #8958.</li>
<li>Implemented <code>try</code> processing with the following logic (resolves #8959):<ol>
<li>In the example below the cfg first encounters a conditional <code>ExceptionRaised</code> forking if an exception was (or will be) raised in the try block. This is not possible to know (except for trivial cases) so we assume both paths can be taken unconditionally.</li>
<li>Going down the <code>try</code> path the cfg goes <code>try</code>-&gt;<code>else</code>-&gt;<code>finally</code> unconditionally.</li>
<li>Going down the <code>except</code> path the cfg will meet several conditional <code>ExceptionCaught</code> which fork depending on the nature of the exception caught. Again there's no way to know which exceptions may be raised so both paths are assumed to be taken unconditionally.</li>
<li>If none of the exception blocks catch the exception then the cfg terminates by raising a new exception.</li>
<li>A post-processing step is also implemented to redirect any <code>raises</code> or <code>returns</code> within the blocks appropriately.</li>
</ol>
</li>
</ol>
<pre><code class="language-python">def func():
    try:
        print(&quot;try&quot;)
    except Exception:
        print(&quot;Exception&quot;)
    except OtherException as e:
        print(&quot;OtherException&quot;)
    else:
        print(&quot;else&quot;)
    finally:
        print(&quot;finally&quot;)
</code></pre>
<pre><code class="language-mermaid">flowchart TD
  start((&quot;Start&quot;))
  return((&quot;End&quot;))
  block0[[&quot;`*(empty)*`&quot;]]
  block1[&quot;print(#quot;finally#quot;)\n&quot;]
  block2[&quot;print(#quot;else#quot;)\n&quot;]
  block3[&quot;print(#quot;try#quot;)\n&quot;]
  block4[[&quot;Exception raised&quot;]]
  block5[&quot;print(#quot;OtherException#quot;)\n&quot;]
  block6[&quot;try:
        print(#quot;try#quot;)
    except Exception:
        print(#quot;Exception#quot;)
    except OtherException as e:
        print(#quot;OtherException#quot;)
    else:
        print(#quot;else#quot;)
    finally:
        print(#quot;finally#quot;)\n&quot;]
  block7[&quot;print(#quot;Exception#quot;)\n&quot;]
  block8[&quot;try:
        print(#quot;try#quot;)
    except Exception:
        print(#quot;Exception#quot;)
    except OtherException as e:
        print(#quot;OtherException#quot;)
    else:
        print(#quot;else#quot;)
    finally:
        print(#quot;finally#quot;)\n&quot;]
  block9[&quot;try:
        print(#quot;try#quot;)
    except Exception:
        print(#quot;Exception#quot;)
    except OtherException as e:
        print(#quot;OtherException#quot;)
    else:
        print(#quot;else#quot;)
    finally:
        print(#quot;finally#quot;)\n&quot;]

  start --&gt; block9
  block9 -- &quot;Exception raised&quot; --&gt; block8
  block9 -- &quot;else&quot; --&gt; block3
  block8 -- &quot;Exception&quot; --&gt; block7
  block8 -- &quot;else&quot; --&gt; block6
  block7 --&gt; block1
  block6 -- &quot;OtherException&quot; --&gt; block5
  block6 -- &quot;else&quot; --&gt; block4
  block5 --&gt; block1
  block4 --&gt; return
  block3 --&gt; block2
  block2 --&gt; block1
  block1 --&gt; block0
  block0 --&gt; return
</code></pre>
<ol start="6">
<li>Implemented <code>with</code> processing with the following logic:<ol>
<li><code>with</code> statements have no conditional execution (apart from the hidden logic handling the enter and exit), so the block is assumed to execute unconditionally.</li>
<li>The one exception is that exceptions raised within the block may result in control flow resuming at the end of the block. Since it is not possible know if an exception will be raised, or if it will be handled by the context manager, we assume that execution always continues after <code>with</code> blocks even if the blocks contain <code>raise</code> or <code>return</code> statements. This is handled in a post-processing step.</li>
</ol>
</li>
</ol>
<h2>Test Plan</h2>
<p>Additional test fixtures and control-flow fixtures were added.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-04-11 22:56</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+21 -0 violations, +0 -0 fixes in 6 projects; 49 projects unchanged)</p>
<details><summary><a href="https://github.com/apache/airflow">apache/airflow</a> (+14 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/apache/airflow/blob/83604a0c7b7762dff97076554c7dc35ee4e8cf85/airflow/triggers/base.py#L102'>airflow/triggers/base.py:102:9:</a> PLW0101 Unreachable code in `run`
+ <a href='https://github.com/apache/airflow/blob/83604a0c7b7762dff97076554c7dc35ee4e8cf85/airflow/triggers/testing.py#L52'>airflow/triggers/testing.py:52:13:</a> PLW0101 Unreachable code in `run`
+ <a href='https://github.com/apache/airflow/blob/83604a0c7b7762dff97076554c7dc35ee4e8cf85/dev/example_dags/update_example_dags_paths.py#L50'>dev/example_dags/update_example_dags_paths.py:50:5:</a> PLW0101 Unreachable code in `check_if_url_exists`
+ <a href='https://github.com/apache/airflow/blob/83604a0c7b7762dff97076554c7dc35ee4e8cf85/tests/models/test_baseoperator.py#L754'>tests/models/test_baseoperator.py:754:21:</a> PLW0101 Unreachable code in `my_work`
+ <a href='https://github.com/apache/airflow/blob/83604a0c7b7762dff97076554c7dc35ee4e8cf85/tests/models/test_mappedoperator.py#L1065'>tests/models/test_mappedoperator.py:1065:21:</a> PLW0101 Unreachable code in `other_setup`
+ <a href='https://github.com/apache/airflow/blob/83604a0c7b7762dff97076554c7dc35ee4e8cf85/tests/models/test_mappedoperator.py#L1081'>tests/models/test_mappedoperator.py:1081:21:</a> PLW0101 Unreachable code in `my_setup`
+ <a href='https://github.com/apache/airflow/blob/83604a0c7b7762dff97076554c7dc35ee4e8cf85/tests/models/test_mappedoperator.py#L1107'>tests/models/test_mappedoperator.py:1107:21:</a> PLW0101 Unreachable code in `other_setup`
+ <a href='https://github.com/apache/airflow/blob/83604a0c7b7762dff97076554c7dc35ee4e8cf85/tests/models/test_mappedoperator.py#L1280'>tests/models/test_mappedoperator.py:1280:21:</a> PLW0101 Unreachable code in `my_work`
+ <a href='https://github.com/apache/airflow/blob/83604a0c7b7762dff97076554c7dc35ee4e8cf85/tests/models/test_mappedoperator.py#L1297'>tests/models/test_mappedoperator.py:1297:21:</a> PLW0101 Unreachable code in `my_work`
+ <a href='https://github.com/apache/airflow/blob/83604a0c7b7762dff97076554c7dc35ee4e8cf85/tests/models/test_mappedoperator.py#L1599'>tests/models/test_mappedoperator.py:1599:17:</a> PLW0101 Unreachable code in `my_work`
+ <a href='https://github.com/apache/airflow/blob/83604a0c7b7762dff97076554c7dc35ee4e8cf85/tests/models/test_mappedoperator.py#L1637'>tests/models/test_mappedoperator.py:1637:25:</a> PLW0101 Unreachable code in `my_work`
+ <a href='https://github.com/apache/airflow/blob/83604a0c7b7762dff97076554c7dc35ee4e8cf85/tests/models/test_mappedoperator.py#L1684'>tests/models/test_mappedoperator.py:1684:25:</a> PLW0101 Unreachable code in `my_work`
+ <a href='https://github.com/apache/airflow/blob/83604a0c7b7762dff97076554c7dc35ee4e8cf85/tests/models/test_mappedoperator.py#L994'>tests/models/test_mappedoperator.py:994:21:</a> PLW0101 Unreachable code in `my_setup`
+ <a href='https://github.com/apache/airflow/blob/83604a0c7b7762dff97076554c7dc35ee4e8cf85/tests/models/test_taskinstance.py#L3454'>tests/models/test_taskinstance.py:3454:13:</a> PLW0101 Unreachable code in `on_finish_callable`
</pre>

</p>
</details>
<details><summary><a href="https://github.com/freedomofpress/securedrop">freedomofpress/securedrop</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/freedomofpress/securedrop/blob/760148440271d4b9bdca5ce97ab0e511f9c8d8f2/admin/securedrop_admin/__init__.py#L78'>admin/securedrop_admin/__init__.py:78:5:</a> PLW0101 Unreachable code in `openssh_version`
</pre>

</p>
</details>
<details><summary><a href="https://github.com/latchbio/latch">latchbio/latch</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/latchbio/latch/blob/f986b146bce5cd9d915721edaf608d84c53d8648/src/latch_cli/snakemake/single_task_snakemake.py#L236'>src/latch_cli/snakemake/single_task_snakemake.py:236:5:</a> PLW0101 Unreachable code in `empty_generator`
</pre>

</p>
</details>
<details><summary><a href="https://github.com/pandas-dev/pandas">pandas-dev/pandas</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/pandas-dev/pandas/blob/5e50d3f3d2b0ee65f0d5bfda0c6da47ffd39dcfe/pandas/io/parsers/python_parser.py#L1316'>pandas/io/parsers/python_parser.py:1316:25:</a> PLW0101 Unreachable code in `_get_lines`
</pre>

</p>
</details>
<details><summary><a href="https://github.com/pytest-dev/pytest">pytest-dev/pytest</a> (+3 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/pytest-dev/pytest/blob/e8c2082d751999fa0ebf1ba335cfec3b022f0a88/src/_pytest/config/__init__.py#L1842'>src/_pytest/config/__init__.py:1842:9:</a> PLW0101 Unreachable code in `_assertion_supported`
+ <a href='https://github.com/pytest-dev/pytest/blob/e8c2082d751999fa0ebf1ba335cfec3b022f0a88/testing/code/test_code.py#L151'>testing/code/test_code.py:151:17:</a> PLW0101 Unreachable code in `test_bad_getsource`
+ <a href='https://github.com/pytest-dev/pytest/blob/e8c2082d751999fa0ebf1ba335cfec3b022f0a88/testing/code/test_code.py#L167'>testing/code/test_code.py:167:17:</a> PLW0101 Unreachable code in `test_getsource`
</pre>

</p>
</details>
<details><summary><a href="https://github.com/astropy/astropy">astropy/astropy</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/astropy/astropy/blob/80aa67d2cc7ddb41a63d00d231b2792aafca77fa/astropy/table/tests/test_bst.py#L18'>astropy/table/tests/test_bst.py:18:5:</a> PLW0101 Unreachable code in `tree`
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PLW0101 | 21 | 21 | 0 | 0 | 0 |</p>
</p>
</details>

<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-11 23:05</div>
            <div class="timeline-body"><p>Nice, I'm a fan of this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/augustelalande">@augustelalande</a> on 2024-04-11 23:25</div>
            <div class="timeline-body"><p>No promises, just started taking a look at it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/augustelalande">@augustelalande</a> on 2024-04-11 23:26</div>
            <div class="timeline-body"><p>Can you give me some background on why this was never activated? Was there just too many false positives?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-12 00:34</div>
            <div class="timeline-body"><p>No, I think it's fairly reliable, but I believe <code>try</code>-<code>except</code> handling wasn't quite finished: https://github.com/astral-sh/ruff/issues/8959. There's also at least one bug to fix: https://github.com/astral-sh/ruff/issues/8958.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-04-16 00:06</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/augustelalande%3Aunreachable">CodSpeed Performance Report</a></h2>
<h3>Merging #10891 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>augustelalande:unreachable</code> (d13ff6a) with <code>main</code> (2355472)</sub></p>
<h3>Summary</h3>
<p><code>✅ 32</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @augustelalande on 2024-04-27 21:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/augustelalande">@augustelalande</a> on 2024-04-27 21:30</div>
            <div class="timeline-body"><p>This is probably not completely ready for merging, but considering the size it's probably worth getting some feedback now. All the ecosystem checks seem like true positives, there might still be some false negatives, but those will be harder to find.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/augustelalande">@augustelalande</a> on 2024-05-09 04:52</div>
            <div class="timeline-body"><p>@charliermarsh when you get the time please have a look at this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @MichaReiser by @MichaReiser on 2024-08-01 20:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-01 20:51</div>
            <div class="timeline-body"><p>Sorry for the emberassing long wait. I make this a priority for next week.</p>
<p>The best way to review this change is probably to compare all changes starting <em>after</em> the &quot;Revert&quot; commit. If you have any other review recommendations, let me know :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @MichaReiser on 2024-08-01 20:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/augustelalande">@augustelalande</a> on 2024-08-01 21:29</div>
            <div class="timeline-body"><p>@MichaReiser no worries. Ya that's a good strategy, but also take a look at my PR summary at the top, I tried to give an outline of the changes I made.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-05 10:27</div>
            <div class="timeline-body"><p>I rebased the commit onto main</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/checkers/ast/analyze/statement.rs</code>:373 on 2024-08-05 10:28</div>
            <div class="timeline-body"><p>Definitely something that we can do as its PR, but are there any inherent constraints that prevent the rule from running on the module body or lambda body?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/snapshots/ruff_linter__rules__ruff__tests__RUF014_RUF014.py.snap</code>:24 on 2024-08-05 10:29</div>
            <div class="timeline-body"><p>I would find the message easier to read if we put the function name into quotes or backticks</p>
<pre><code class="language-suggestion">RUF014.py:12:5: RUF014 Unreachable code in `if_always_true`
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unreachable.rs</code>:84 on 2024-08-05 10:34</div>
            <div class="timeline-body"><p>It would be great if the rule only emitted a single diagnostic if they are all entered by the same block (only) and that <em>entry</em> block is unreachable. There's an example in the ecosytem check results for this</p>
<ul>
<li><a href='https://github.com/apache/airflow/blob/aa5581e30dd38a90855ec6c4671d6ae0086b57af/dev/example_dags/update_example_dags_paths.py#L50'>dev/example_dags/update_example_dags_paths.py:50:5:</a> RUF014 Unreachable code in check_if_url_exists</li>
<li><a href='https://github.com/apache/airflow/blob/aa5581e30dd38a90855ec6c4671d6ae0086b57af/dev/example_dags/update_example_dags_paths.py#L52'>dev/example_dags/update_example_dags_paths.py:52:9:</a> RUF014 Unreachable code in check_if_url_exists</li>
<li><a href='https://github.com/apache/airflow/blob/aa5581e30dd38a90855ec6c4671d6ae0086b57af/dev/example_dags/update_example_dags_paths.py#L53'>dev/example_dags/update_example_dags_paths.py:53:5:</a> RUF014 Unreachable code in check_if_url_exists</li>
<li><a href='https://github.com/apache/airflow/blob/aa5581e30dd38a90855ec6c4671d6ae0086b57af/dev/example_dags/update_example_dags_paths.py#L54'>dev/example_dags/update_example_dags_paths.py:54:9:</a> RUF014 Unreachable code in check_if_url_exists</li>
<li><a href='https://github.com/apache/airflow/blob/aa5581e30dd38a90855ec6c4671d6ae0086b57af/dev/example_dags/update_example_dags_paths.py#L55'>dev/example_dags/update_example_dags_paths.py:55:5:</a> RUF014 Unreachable code in check_if_url_exists</li>
</ul>
<p>E.g. BiomeJS creates a single diagnostic that spans the entire unreachable code <a href="https://biomejs.dev/playground/?code=CgBmAHUAbgBjAHQAaQBvAG4AIABjAGgAZQBjAGsAXwBpAGYAXwB1AHIAbABfAGUAeABpAHMAdABzACgAdQByAGwAOgAgAHMAdAByACkAOgAgAGIAbwBvAGwAIAB7AAoAIAAgACAAIAByAGUAdAB1AHIAbgAgAFQAcgB1AGUAIAAgAC8ALwAgAHUAbgBjAG8AbQBtAGUAbgB0ACAAdABvACAAYwBoAGUAYwBrACAAVQBSAEwAcwAKACAAIAAgACAAcgBlAHMAcABvAG4AcwBlACAAPQAgAHIAZQBxAHUAZQBzAHQAcwAuAGgAZQBhAGQAKAB1AHIAbAAsACAAYQBsAGwAbwB3AF8AcgBlAGQAaQByAGUAYwB0AHMAPQBUAHIAdQBlACkACgAgACAAIAAgAGkAZgAgACgAcgBlAHMAcABvAG4AcwBlAC4AcwB0AGEAdAB1AHMAXwBjAG8AZABlACAAPQA9ACAAMgAwADAAKQAgAHsACgAgACAAIAAgACAAIAAgACAAcgBlAHQAdQByAG4AIABUAHIAdQBlAAoAIAAgACAAIAB9AAoAIAAgACAAIABpAGYAIAAoAHIAZQBzAHAAbwBuAHMAZQAuAHMAdABhAHQAdQBzAF8AYwBvAGQAZQAgAD0APQAgADQAMAA0ACkAIAB7AAoAIAAgACAAIAAgACAAIAAgAHIAZQB0AHUAcgBuACAARgBhAGwAcwBlAAoAIAAgACAAIAB9AAoAIAAgACAAIABjAG8AbgBzAG8AbABlAC4AcAByAGkAbgB0ACgAYABbAHIAZQBkAF0AVQBuAGUAeABwAGUAYwB0AGUAZAAgAGUAcgByAG8AcgAgAHIAZQBjAGUAaQB2AGUAZAA6ACAAewByAGUAcwBwAG8AbgBzAGUALgBzAHQAYQB0AHUAcwBfAGMAbwBkAGUAfQBbAC8AXQBgACkACgAgACAAIAAgAHIAZQBzAHAAbwBuAHMAZQAuAHIAYQBpAHMAZQBfAGYAbwByAF8AcwB0AGEAdAB1AHMAKAApAAoAfQA%3D">playground</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unreachable.rs</code>:100 on 2024-08-05 10:38</div>
            <div class="timeline-body"><p>I think we can use <code>div_ceil</code> instead</p>
<pre><code class="language-suggestion">        let size = capacity.div_ceil(usize::BITS as usize);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unreachable.rs</code>:135 on 2024-08-05 10:46</div>
            <div class="timeline-body"><p>Nit: It took me quiet some time to understand this condition because <code>index</code> is once on the left and the other time on the right side of the condition.</p>
<pre><code class="language-suggestion">            if index &gt;= self.bits.len() {
                return None;
            }

            if index == self.bits.len() - 1 &amp;&amp; shift &gt;= last_max_shift {
                return None;
            }

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unreachable.rs</code>:89 on 2024-08-05 10:48</div>
            <div class="timeline-body"><p>Nit: I would move the <code>Bitmap</code> and its impl block to the end of the file (before tests). It's mostly implementation detail.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unreachable.rs</code>:156 on 2024-08-05 10:53</div>
            <div class="timeline-body"><p>I assume that improving the inference here is something you plan to do over time?</p>
<p>I think it would be nice to support some more constructs like equality and inequality, <code>is</code> <code>is not</code> etc. @charliermarsh does Ruff already have some infrastructure to evalute an expression?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-05 11:00</div>
            <div class="timeline-body"><blockquote>
<p><a href="https://github.com/ibis-project/ibis">ibis-project/ibis</a> (error)</p>
</blockquote>
<p>I did attach a debugger and it seems that it overflows in <code>post_process_try</code> when analysing <code>&quot;ibis/ibis/backends/pyspark/__init__.py&quot;</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unreachable.rs</code>:271 on 2024-08-05 12:13</div>
            <div class="timeline-body"><p>Can you tell me more what the meaning of <code>exit</code> is in the context of a condition?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unreachable.rs</code>:313 on 2024-08-05 12:14</div>
            <div class="timeline-body"><p>It's not immediately clear what the expression is. Is it the expected exception? I would find a comment specifiying what the expression is helpful.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unreachable.rs</code>:272 on 2024-08-05 12:17</div>
            <div class="timeline-body"><pre><code class="language-rust">    /// To keep `NextBlock` simple(r) `NextBlock::If`'s `next` and `orelse`
    /// fields only use `BlockIndex`, which means that they can't terminate
    /// themselves. To support this we insert *empty*/fake blocks before the end
    /// of the function that we can link to.
</code></pre>
<p>Could we use the same &quot;trick&quot; for exit or is there a specific reason why we deviate from this for <code>exit</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unreachable.rs</code>:315 on 2024-08-05 12:18</div>
            <div class="timeline-body"><p>Nit: I'm leaning towards naming the exception variants <code>Raise</code> and <code>Except</code>. It's shorter and is closer to the Python syntax (unless there are other cases where they are used)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unreachable.rs</code>:397 on 2024-08-05 12:22</div>
            <div class="timeline-body"><p>I think I would prefer a <code>kind</code> field on <code>BasicBlock</code> than asserting on the statements. Mainly because I'm worried that it's very easy to access <code>stmts</code> and then being confused where those statements come from. The other reason is that the current implementation compares the <code>stmts</code> by value instead of by identity (<code>str::ptr::eq</code> compares by identity). It is, in theory, possible that a &quot;real&quot; block could compare equal to <code>EXCEPTION</code>, e.g. when it is a manual-built tree.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unreachable.rs</code>:391 on 2024-08-05 12:28</div>
            <div class="timeline-body"><pre><code class="language-rust">/// For loop blocks, and similar recurring control flows, the end of the
/// body will point to the loop block again (to create the loop). However an
/// oddity here is that this block might contain statements before the loop
/// itself which, of course, won't be executed again.
///
/// For example:
/// ```python
/// i = 0          # block 0
/// while True:    #
///     continue   # block 1
/// ```
/// Will create a connection between block 1 (loop body) and block 0, which
/// includes the `i = 0` statement.
</code></pre>
<p>Assuming this comment is still correct. What's the reason that <code>continue</code> can't link to <code>block 0</code>? Should we instead insert a <em>fake</em> empty block before every loop (not specific to <code>continue</code>) and use it for when reaching the end of the loop or when hitting a <code>continue</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unreachable.rs</code>:412 on 2024-08-05 12:32</div>
            <div class="timeline-body"><p>This condition isn't strictly true, at least not when the parser recovers <a href="https://play.ruff.rs/939deecb-6ac6-4b99-a60b-7199e600b23b">playground</a>. We currently aren't running any lint rules if the AST has any syntax errors but we may consider doing it in the future.</p>
<p>if there's an easy way to correctly recover in case of an empty block, then that would be great (e.g. create an empty block when stmts is empty)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unreachable.rs</code>:433 on 2024-08-05 12:33</div>
            <div class="timeline-body"><p>I think it would be helpful for readers to have a short comment here explaining what this method does and why it is needed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unreachable.rs</code>:1007 on 2024-08-05 12:56</div>
            <div class="timeline-body"><p>We now have the different post processing steps and this method. What's the difference between the two?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/snapshots/ruff_linter__rules__ruff__rules__unreachable__tests__try.py.md.snap</code>:473 on 2024-08-05 13:06</div>
            <div class="timeline-body"><p>We should add some tests where we raise exceptions inside blocks other than <code>try</code>. E.g.</p>
<pre><code class="language-python">try:
    assert False
except ex:
    raise ex

finally:
    raise Exception(&quot;other&quot;)
</code></pre>
<p>Ideally we combine this with a nested <code>try</code> block.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/snapshots/ruff_linter__rules__ruff__rules__unreachable__tests__for.py.md.snap</code>:369 on 2024-08-05 13:07</div>
            <div class="timeline-body"><p>Let's add an example with a nested loop where both the outer and inner loop use break/continue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-08-05 13:09</div>
            <div class="timeline-body"><p>Nice work and I'm impressed how little this affects performance.</p>
<p>I started reviewing the PR but I get the impression that I don't fully understand why the post processing is necessary and why we need the two new sentinel nodes. Could you expand a bit on what the problem is that they solve?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/augustelalande">@augustelalande</a> reviewed on 2024-08-26 00:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/augustelalande">@augustelalande</a> on <code>crates/ruff_linter/src/checkers/ast/analyze/statement.rs</code>:373 on 2024-08-26 00:43</div>
            <div class="timeline-body"><p>Well lambda body doesn't make sense since it can only be a single statement. But module body can definitely be added.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/augustelalande">@augustelalande</a> reviewed on 2024-09-05 02:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/augustelalande">@augustelalande</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unreachable.rs</code>:156 on 2024-09-05 02:39</div>
            <div class="timeline-body"><p>Certainly</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/augustelalande">@augustelalande</a> reviewed on 2024-09-05 02:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/augustelalande">@augustelalande</a> on <code>crates/ruff_linter/src/rules/ruff/rules/snapshots/ruff_linter__rules__ruff__rules__unreachable__tests__try.py.md.snap</code>:473 on 2024-09-05 02:42</div>
            <div class="timeline-body"><p>I added a big one, and there were issues, so good catch</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/augustelalande">@augustelalande</a> reviewed on 2024-09-05 03:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/augustelalande">@augustelalande</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unreachable.rs</code>:1007 on 2024-09-05 03:17</div>
            <div class="timeline-body"><p>removed</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/augustelalande">@augustelalande</a> reviewed on 2024-09-05 03:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/augustelalande">@augustelalande</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unreachable.rs</code>:315 on 2024-09-05 03:21</div>
            <div class="timeline-body"><p>Changed to <code>Except</code> and <code>MaybeRaised</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/augustelalande">@augustelalande</a> reviewed on 2024-09-05 03:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/augustelalande">@augustelalande</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unreachable.rs</code>:391 on 2024-09-05 03:33</div>
            <div class="timeline-body"><p><code>continue</code> can and does link to <code>block 0</code>, the point of the comment is that this is &quot;odd&quot; since it implies that both <code>i = 0</code> and <code>while True</code> are executed after each loop, which isn't true but isn't important for the purpose of determining reachability. This behaviour can be changed easily if desired so that <code>i = 0</code> and <code>while True</code> are seperate blocks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/augustelalande">@augustelalande</a> reviewed on 2024-09-05 03:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/augustelalande">@augustelalande</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unreachable.rs</code>:272 on 2024-09-05 03:35</div>
            <div class="timeline-body"><p>I will improve the documentation, but exit serves a different purpose, not for determining control flow, but rather to facilitate the post_processing steps.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/augustelalande">@augustelalande</a> on 2024-09-05 05:33</div>
            <div class="timeline-body"><p>@MichaReiser Ok I think I've addressed all your comments, time for second round of review.</p>
<p>I did have one issue I couldn't resolve. You can see it in one of the test fixtures, but essentially in the following</p>
<pre><code class="language-python">def if_elif_always_false():
    if False:
        return &quot;unreachable&quot;
    elif False:
        return &quot;also unreachable&quot;
    return &quot;reachable&quot;
</code></pre>
<p>the two unreachable lines get combined as a single violation</p>
<pre><code>RUF014.py:21:9: RUF014 Unreachable code in `if_elif_always_false`
   |
19 |   def if_elif_always_false():
20 |       if False:
21 |           return &quot;unreachable&quot;
   |  _________^
22 | |     elif False:
23 | |         return &quot;also unreachable&quot;
   | |_________________________________^ RUF014
24 |       return &quot;reachable&quot;
</code></pre>
<p>this is because I combine blocks which follow each other if there are no reachable blocks in between, and since the elif doesn't make its own block, I couldn't figure out how to split them.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-18 07:27</div>
            <div class="timeline-body"><p>I plan to look at this PR again but I don't know yet when I have the time to do so.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/augustelalande">@augustelalande</a> on 2024-11-25 19:22</div>
            <div class="timeline-body"><p>@MichaReiser I feel this PR and rule will be obsoleted by red-knot. If you agree I will close it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-26 08:45</div>
            <div class="timeline-body"><p>There's a good chance that this rule will become obsolete with Re Knot, but integrating Red Knot back into Ruff is also still far out. I don't mind keeping this PR open for now in the hope that I'll soon have time to review it (I'm so sorry).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-12-17 16:07</div>
            <div class="timeline-body"><p>@augustelalande I'm a big fan of this PR! I think it's a great jumping off point for Ruff to begin learning control flow more generally. I'd love to help get this merged, so I'm gonna help with the review process.</p>
<p>Before I dive in to the specifics, two more general questions regarding the implementation:</p>
<ol>
<li>I would think that the beginning of a loop (both for and while) would be its own block, so that the body of the loop can point back to it. As you indicate in a comment, that's not the current behavior. I'm curious what the downside is of adopting what feels like the more intuitive approach?</li>
<li>You build the control flow graph starting from the bottom, which is nice because <code>NextBlock</code> always knows where to point, but it adds this post-processing step and it is reversed (I think) from the direction of the &quot;unreachable&quot; analysis. An alternative approach would be to build the graph in the forward direction, pointing to empty blocks that are later populated, and performing <code>mark_unreachable</code> as you go. Is there a hidden downside to that approach?</li>
</ol>
<p>Thanks again for all your hard work, and sorry for the long, drawn out review!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/augustelalande">@augustelalande</a> on 2024-12-17 16:24</div>
            <div class="timeline-body"><p>@dylwil3 so as I stated in the opening summary, the starting point for this PR is #5384 which already did the bulk of the implementation, and had already been merged into main and then later removed. As such a lot of the design decisions were made by the original author, and I only made changes where I felt they were necessary.</p>
<p>Secondly, even if some of those decisions seem incorrect in retrospect, I'm not prepared at the moment to dedicate much more work to this PR, especially since I think red-knot will eventually implement its own CFG which will supersede this. Of course if someone else wants to take on that work I won't object. So please keep that in mind.</p>
<ol>
<li><p>I fully agree with this. Having a dedicated block for a loop start is a much better approach. So if this becomes the sticking point preventing a merge I'll be happy to change it.</p>
</li>
<li><p>As you stated the main benefit here is to always have the NextBlock available. I don't think the various post-processing steps add much cost in terms of performance, although they may be undesirable in terms of readability. In any case, switching to a forward approach would essentially require a full rewrite so I'm unlikely to commit to it.</p>
</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-12-17 17:11</div>
            <div class="timeline-body"><blockquote>
<p>As such a lot of the design decisions were made by the original author, and I only made changes where I felt they were necessary.</p>
</blockquote>
<p>I suspected that might be the case - makes sense!</p>
<blockquote>
<p>Having a dedicated block for a loop start is a much better approach.</p>
</blockquote>
<p>If this is not too big of a change, let's do this then</p>
<blockquote>
<p>In any case, switching to a forward approach would essentially require a full rewrite so I'm unlikely to commit to it.</p>
</blockquote>
<p>I don't think we need to do this - I was just curious if I was missing anything here.</p>
<blockquote>
<p>Secondly, even if some of those decisions seem incorrect in retrospect, I'm not prepared at the moment to dedicate much more work to this PR</p>
</blockquote>
<p>I totally understand! I don't want to let the perfect be the enemy of the good here. I'm hoping we can get this merged in without too much extra work, but please let me know if you'd like me to finish it off or if I can help in any way!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`ruff`] Re-implement `unreachable`" to "[`pylint`] Re-implement `unreachable` (`PLW0101`)" by @dylwil3 on 2025-01-03 03:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-01-03 03:54</div>
            <div class="timeline-body"><p>@augustelalande Upon further reflection, I've decided to merge this in as-is. The various remaining tweaks do not really affect the core functionality of this rule, and could be tackled in follow-up PRs.</p>
<p>This is an outstanding contribution to Ruff, and your hard work deserves to be part of the codebase!</p>
<p>Thank you once again for your patience and persistence!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dylwil3 on 2025-01-03 03:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dylwil3 on 2025-01-03 03:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/augustelalande">@augustelalande</a> on 2025-01-03 04:52</div>
            <div class="timeline-body"><p>Thanks @dylwil3</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-03 04:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @dylwil3 on 2025-01-03 05:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @dylwil3 on 2025-01-03 05:20</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 20:34:29 UTC
    </footer>
</body>
</html>
