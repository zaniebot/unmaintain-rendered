<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Avoid inferring types for invalid binary expressions in string annotations - astral-sh/ruff #21911</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Avoid inferring types for invalid binary expressions in string annotations</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21911">#21911</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2025-12-11 00:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>Closes <a href="https://github.com/astral-sh/ty/issues/1847">astral-sh/ty#1847</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-12-11 00:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-12-11 00:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-12-11 00:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-12-11 00:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-12-11 00:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-11 00:57</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-11 00:59</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>beartype (https://github.com/beartype/beartype)
- beartype/claw/_package/clawpkgtrie.py:66:29: warning[unsupported-base] Unsupported class base with type `&lt;class &#x27;dict[str, PackagesTrieBlacklist]&#x27;&gt; | &lt;class &#x27;dict[str, Divergent]&#x27;&gt;`
- beartype/claw/_package/clawpkgtrie.py:247:29: warning[unsupported-base] Unsupported class base with type `&lt;class &#x27;dict[str, PackagesTrieWhitelist]&#x27;&gt; | &lt;class &#x27;dict[str, Divergent]&#x27;&gt;`
- Found 494 diagnostics
+ Found 492 diagnostics

scikit-build-core (https://github.com/scikit-build/scikit-build-core)
- src/scikit_build_core/_logging.py:153:13: warning[unsupported-base] Unsupported class base with type `&lt;class &#x27;Mapping[str, Style]&#x27;&gt; | &lt;class &#x27;Mapping[str, Divergent]&#x27;&gt;`
- src/scikit_build_core/build/wheel.py:98:20: error[no-matching-overload] No overload of bound method `__init__` matches arguments
- Found 43 diagnostics
+ Found 41 diagnostics


</code></pre>


<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-11 02:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Avoid inferring types for invalid binary expressions in string annotations&quot; to &quot;[ty] Avoid inferring types for invalid binary expressions in string annotations&quot; by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-11 02:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/infer/builder/type_expression.rs</code>:163 on 2025-12-11 07:57</div>
            <div class="timeline-body"><p>We used to have the requirement that inference had to run for every expression in the AST, or otherwise we might panic when requesting a type for that expression. We have changed that and now fall back to <code>Unknown</code> in case no type has been inferred.</p>
<p>Since we&#x27;re not going to infer useful types here anyway, I think we can also just remove this entirely.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> approved on 2025-12-11 08:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-12-11 08:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-12-11 08:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-12-11 08:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-12-11 10:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/infer/builder/type_expression.rs</code>:163 on 2025-12-11 10:34</div>
            <div class="timeline-body"><p>That leads to a worse experience for server users when they hover over sub-expressions in the invalid type expression, no? I think we should still aim to store a type for each sub-expression wherever possible</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-12-11 10:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/infer/builder/type_expression.rs</code>:163 on 2025-12-11 10:53</div>
            <div class="timeline-body"><blockquote>
<p>That leads to a worse experience for server users when they hover over sub-expressions in the invalid type expression, no?</p>
</blockquote>
<p>I mean... maybe? But the whole thing will be red-squiggly underlined anyway. It&#x27;s completely wrong. Why is it helpful that they see <code>Literal[4]</code> if they hover over the <code>4</code> in <code>x: &quot;3+4&quot;</code>? Is <code>Literal[4]</code> even more correct than <code>Unknown</code> here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-12-11 11:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/infer/builder/type_expression.rs</code>:163 on 2025-12-11 11:04</div>
            <div class="timeline-body"><p>I don&#x27;t think that&#x27;s really a realistic example of an invalid type expression that someone is likely to use. If somebody is using the appeal library, for example, they might be making use of that library&#x27;s <a href="https://github.com/larryhastings/appeal?tab=readme-ov-file#annotations-and-introspection">special DSL</a> for annotations (which is incompatible with type checkers, and so is going to result in lots of <code>invalid-type-form</code> violations). Who knows if this user even has <code>invalid-type-form</code> enabled in their ty config; maybe they&#x27;re only interested in our server functionality. I don&#x27;t see why the invalid type expression should mean that we don&#x27;t offer any on-hover information or go-to-definition support for any symbols in this user&#x27;s annotations.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/infer/builder/type_expression.rs</code>:163 on 2025-12-11 11:07</div>
            <div class="timeline-body"><p>To be clear I&#x27;m specifically objecting to <a href="https://github.com/astral-sh/ruff/pull/21911">astral-sh/ruff#21911</a>/commits/f2e50c4f83045fe6f5c2d433260ba97a66df6370. I&#x27;m fine with not attempting to infer the sub-expressions of invalid stringized annotations if it makes us crash. That seems like a pretty rare edge case. It&#x27;s the extension of that to &quot;all invalid binary expressions in type expressions&quot; that I&#x27;m uncomfortable with.</p>
<p>I just feel that as a general principle, we should continue to attempt to infer types for all sub-expressions wherever possible (on a best-effort basis)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-12-11 11:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-12-11 11:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/infer/builder/type_expression.rs</code>:163 on 2025-12-11 11:56</div>
            <div class="timeline-body"><p>I&#x27;m still not convinced that it&#x27;s better to run <code>infer_binary_expression</code> here just for the sake of having &quot;some&quot; type (because we&#x27;re very explicitly in a type expression, and not in a value expression here).</p>
<p>But I certainly don&#x27;t feel as strongly as you do, so let&#x27;s just revert: <a href="https://github.com/astral-sh/ruff/pull/21914">astral-sh/ruff#21914</a></p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:21:37 UTC
    </footer>
</body>
</html>
