<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ensure that B006 autofixes are inserted after imports - astral-sh/ruff #7629</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Ensure that B006 autofixes are inserted after imports</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7629">#7629</a>
        opened by <a href="https://github.com/hoxbro">@hoxbro</a>
        on 2023-09-24 11:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/hoxbro">@hoxbro</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>Fixes #7616 by ensuring that <a href="https://docs.astral.sh/ruff/rules/mutable-argument-default/#mutable-argument-default-b006">B006</a> fixes are inserted after module imports.</p>
<p>I have created a new test file, <code>B006_5.py</code>. This is mainly because I have been working on this on and off, and the merge conflicts were easier to handle in a separate file. If needed, I can move it into another file.</p>
<!-- What's the purpose of the change? What does it do, and why? -->

<h2>Test Plan</h2>
<p><code>cargo test</code></p>
<!-- How was it tested? -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2023-09-24 12:03</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/Hoxbro:fix_b006_import">CodSpeed Performance Report</a></h2>
<h3>Merging #7629 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>Hoxbro:fix_b006_import</code> (7d27160) with <code>main</code> (2aef46c)</sub></p>
<h3>Summary</h3>
<p><code>✅ 25</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-09-24 12:10</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>✅ ecosystem check detected no changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_linter/src/rules/flake8_bugbear/rules/mutable_argument_default.rs</code>:193 on 2023-09-25 08:40</div>
            <div class="timeline-body"><p>Do you also need to handle the <code>locator.full_line_end(statement.end()) == locator.text_len()</code> case from above here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_bugbear/B006_5.py</code>:37 on 2023-09-25 08:43</div>
            <div class="timeline-body"><p>please add a test case with a statement after the imports, e.g.</p>
<pre><code class="language-python">def f(x={}):
    import sys

    print(sys.version, x)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-09-25 08:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/hoxbro">@hoxbro</a> reviewed on 2023-09-25 08:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/hoxbro">@hoxbro</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_bugbear/B006_5.py</code>:37 on 2023-09-25 08:58</div>
            <div class="timeline-body"><p>Do you want with both docstring and import? This example you shown is already there:</p>
<pre><code class="language-python">def import_module_with_values_wrong(value: dict[str, str] = {}):
    import os

    return 2
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/hoxbro">@hoxbro</a> reviewed on 2023-09-25 08:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/hoxbro">@hoxbro</a> on <code>crates/ruff_linter/src/rules/flake8_bugbear/rules/mutable_argument_default.rs</code>:193 on 2023-09-25 08:59</div>
            <div class="timeline-body"><p>I will take a look at it later today.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-25 09:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_bugbear/B006_5.py</code>:37 on 2023-09-25 09:38</div>
            <div class="timeline-body"><p>oh sorry i missed that, please disregard my comment</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/hoxbro">@hoxbro</a> on <code>crates/ruff_linter/src/rules/flake8_bugbear/snapshots/ruff_linter__rules__flake8_bugbear__tests__B006_B006_5.py.snap</code>:154 on 2023-09-25 18:43</div>
            <div class="timeline-body"><p>This line was added when implementing the <code>locator.full_line_end(statement.end()) == locator.text_len()</code> case.</p>
<p>I can see something similar happens when doing it with docstrings on <code>0.0.291</code>.</p>
<p>This will:</p>
<pre><code class="language-python">def t(foo=[]):
    &quot;&quot;&quot;Docstring&quot;&quot;&quot;

a = 2
</code></pre>
<p>will be fixed to</p>
<pre><code class="language-python">def t(foo=None):
    &quot;&quot;&quot;Docstring&quot;&quot;&quot;
    if foo is None:
        foo = []

a = 2
</code></pre>
<p>Whereas</p>
<pre><code class="language-python">def t(foo=[]):
    &quot;&quot;&quot;Docstring&quot;&quot;&quot;
</code></pre>
<p>will be fixed to</p>
<pre><code class="language-python">def t(foo=None):
    &quot;&quot;&quot;Docstring&quot;&quot;&quot;

    if foo is None:
        foo = []
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/hoxbro">@hoxbro</a> reviewed on 2023-09-25 18:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/hoxbro">@hoxbro</a> reviewed on 2023-09-25 18:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/hoxbro">@hoxbro</a> on <code>crates/ruff_linter/src/rules/flake8_bugbear/rules/mutable_argument_default.rs</code>:193 on 2023-09-25 18:57</div>
            <div class="timeline-body"><p>This should now be handled.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-27 01:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/flake8_bugbear/rules/mutable_argument_default.rs</code>:177 on 2023-09-27 01:11</div>
            <div class="timeline-body"><p>@Hoxbro - I collapsed these two cases -- I think semantically they're the same? We want to skip docstrings and imports, and find the first opportunity to insert after them. (If there's no such opportunity, we insert at the start of the function.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-09-27 01:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-27 01:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/flake8_bugbear/rules/mutable_argument_default.rs</code>:177 on 2023-09-27 01:14</div>
            <div class="timeline-body"><p>Of course, please let me know if I've misunderstood or messed something up -- happy to fix in a follow-up.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-09-27 01:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-09-27 01:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/hoxbro">@hoxbro</a> reviewed on 2023-09-27 08:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/hoxbro">@hoxbro</a> on <code>crates/ruff_linter/src/rules/flake8_bugbear/rules/mutable_argument_default.rs</code>:177 on 2023-09-27 08:27</div>
            <div class="timeline-body"><p>No, that sounds right to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-09-27 08:27</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:00:31 UTC
    </footer>
</body>
</html>
