<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] narrow right comparison op - astral-sh/ruff #22511</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] narrow right comparison op</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22511">#22511</a>
        opened by <a href="https://github.com/drbh">@drbh</a>
        on 2026-01-11 23:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/drbh">@drbh</a> on 2026-01-11 23:56</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR narrows the rhs operand similar to the existing functionality on lhs operands seen <a href="https://github.com/astral-sh/ruff/blob/main/crates/ty_python_semantic/resources/mdtest/narrow/conditionals/eq.md#bool">here</a></p>
<h2>Test Plan</h2>
<p><code>repro.py</code></p>
<pre><code class="language-python">from typing import reveal_type

def _(flag: bool):
    x = None if flag else 1

    if None != x:
        reveal_type(x)  # revealed: Literal[1]
    else:
        reveal_type(x)  # revealed: None

def _(flag: bool):
    x = None if flag else 1

    if None == x:
        reveal_type(x)  # revealed: None
    else:
        reveal_type(x)  # revealed: Literal[1]
</code></pre>
<p>run with</p>
<pre><code class="language-bash">cargo run --bin ty -- check --python-version 3.12 repro.py
</code></pre>
<p>output</p>
<pre><code class="language-bash">info[revealed-type]: Revealed type
 --&gt; repro.py:7:21
  |
6 |     if None != x:
7 |         reveal_type(x)  # revealed: Literal[1]
  |                     ^ `Literal[1]`
8 |     else:
9 |         reveal_type(x)  # revealed: None
  |

info[revealed-type]: Revealed type
  --&gt; repro.py:9:21
   |
 7 |         reveal_type(x)  # revealed: Literal[1]
 8 |     else:
 9 |         reveal_type(x)  # revealed: None
   |                     ^ `None`
10 |
11 | def _(flag: bool):
   |

info[revealed-type]: Revealed type
  --&gt; repro.py:15:21
   |
14 |     if None == x:
15 |         reveal_type(x)  # revealed: None
   |                     ^ `None`
16 |     else:
17 |         reveal_type(x)  # revealed: Literal[1]
   |

info[revealed-type]: Revealed type
  --&gt; repro.py:17:21
   |
15 |         reveal_type(x)  # revealed: None
16 |     else:
17 |         reveal_type(x)  # revealed: Literal[1]
   |                     ^ `Literal[1]`
   |

Found 4 diagnostics
</code></pre>
<h2>Compared with</h2>
<p>this output is an improvement over both <code>mypy</code> and <code>pyright</code> which incorrectly narrow the type</p>
<pre><code class="language-bash">uvx mypy repro.py
repro.py:7: note: Revealed type is &quot;builtins.int&quot;
repro.py:9: note: Revealed type is &quot;None | builtins.int&quot;
repro.py:15: note: Revealed type is &quot;None | builtins.int&quot;
repro.py:17: note: Revealed type is &quot;builtins.int&quot;
Success: no issues found in 1 source file
</code></pre>
<pre><code>uvx pyright repro.py
/Users/drbh/Projects/ruff/repro.py
  /Users/drbh/Projects/ruff/repro.py:7:21 - information: Type of &quot;x&quot; is &quot;Literal[1] | None&quot;
  /Users/drbh/Projects/ruff/repro.py:9:21 - information: Type of &quot;x&quot; is &quot;Literal[1] | None&quot;
  /Users/drbh/Projects/ruff/repro.py:15:21 - information: Type of &quot;x&quot; is &quot;Literal[1] | None&quot;
  /Users/drbh/Projects/ruff/repro.py:17:21 - information: Type of &quot;x&quot; is &quot;Literal[1] | None&quot;
0 errors, 0 warnings, 4 informations
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @drbh on 2026-01-11 23:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @drbh on 2026-01-11 23:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @drbh on 2026-01-11 23:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @drbh on 2026-01-11 23:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2026-01-11 23:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-12 00:00</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-12 00:03</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">scikit-build-core (https://github.com/scikit-build/scikit-build-core)
+ src/scikit_build_core/build/wheel.py:99:20: error[no-matching-overload] No overload of bound method `__init__` matches arguments
- Found 47 diagnostics
+ Found 48 diagnostics

prefect (https://github.com/PrefectHQ/prefect)
- src/prefect/deployments/runner.py:795:70: warning[possibly-missing-attribute] Attribute `__name__` may be missing on object of type `Unknown | (((...) -&gt; Any) &amp; ((*args: object, **kwargs: object) -&gt; object))`
+ src/prefect/deployments/runner.py:795:70: warning[possibly-missing-attribute] Attribute `__name__` may be missing on object of type `Unknown | ((...) -&gt; Any)`
+ src/prefect/flow_engine.py:812:32: error[invalid-await] `Unknown | R@FlowRunEngine | Coroutine[Any, Any, R@FlowRunEngine]` is not awaitable
+ src/prefect/flow_engine.py:1401:24: error[invalid-await] `Unknown | R@AsyncFlowRunEngine | Coroutine[Any, Any, R@AsyncFlowRunEngine]` is not awaitable
+ src/prefect/flow_engine.py:1482:43: error[invalid-argument-type] Argument to function `next` is incorrect: Expected `SupportsNext[Unknown]`, found `Unknown | R@run_generator_flow_sync`
+ src/prefect/flow_engine.py:1490:21: warning[possibly-missing-attribute] Attribute `throw` may be missing on object of type `Unknown | R@run_generator_flow_sync`
+ src/prefect/flow_engine.py:1524:44: warning[possibly-missing-attribute] Attribute `__anext__` may be missing on object of type `Unknown | R@run_generator_flow_async`
+ src/prefect/flow_engine.py:1531:25: warning[possibly-missing-attribute] Attribute `throw` may be missing on object of type `Unknown | R@run_generator_flow_async`
- src/prefect/flows.py:286:34: error[unresolved-attribute] Object of type `((**P@Flow) -&gt; R@Flow) &amp; ((*args: object, **kwargs: object) -&gt; object)` has no attribute `__name__`
+ src/prefect/flows.py:286:34: error[unresolved-attribute] Object of type `(**P@Flow) -&gt; R@Flow` has no attribute `__name__`
- src/prefect/flows.py:404:68: error[unresolved-attribute] Object of type `((**P@Flow) -&gt; R@Flow) &amp; ((*args: object, **kwargs: object) -&gt; object)` has no attribute `__name__`
+ src/prefect/flows.py:404:68: error[unresolved-attribute] Object of type `(**P@Flow) -&gt; R@Flow` has no attribute `__name__`
- src/prefect/flows.py:1750:53: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 5363 diagnostics
+ Found 5368 diagnostics

static-frame (https://github.com/static-frame/static-frame)
- static_frame/core/bus.py:671:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[Bus[Any], object_]`, found `InterGetItemLocReduces[Bus[Any] | Bottom[Series[Any, Any]] | ndarray[Never, Never] | ... omitted 6 union elements, object_]`
+ static_frame/core/bus.py:671:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[Bus[Any], object_]`, found `InterGetItemLocReduces[Bus[Any] | Bottom[Index[Any]] | Bottom[Series[Any, Any]] | ... omitted 6 union elements, object_]`
- static_frame/core/index.py:580:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[TVContainer_co@loc, TVDtype@Index]`, found `InterGetItemLocReduces[Bottom[Series[Any, Any]] | Any, TVDtype@Index]`
+ static_frame/core/index.py:580:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[TVContainer_co@loc, TVDtype@Index]`, found `InterGetItemLocReduces[Any | Bottom[Series[Any, Any]], TVDtype@Index]`
- static_frame/core/node_selector.py:526:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[TVContainer_co@InterfaceSelectQuartet, Any]`, found `InterGetItemLocReduces[Unknown | Bottom[Series[Any, Any]], Any]`
+ static_frame/core/node_selector.py:526:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[TVContainer_co@InterfaceSelectQuartet, Any]`, found `InterGetItemLocReduces[Bottom[Series[Any, Any]] | Unknown, Any]`
+ static_frame/core/series.py:772:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Series[Any, Any], TVDtype@Series]`, found `InterGetItemILocReduces[Series[Any, Any] | ndarray[Never, Never] | TypeBlocks | ... omitted 6 union elements, TVDtype@Series]`
- static_frame/core/series.py:4072:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[SeriesHE[Any, Any], TVDtype@SeriesHE]`, found `InterGetItemILocReduces[Bottom[Series[Any, Any]] | Bottom[Index[Any]] | TypeBlocks | ... omitted 7 union elements, TVDtype@SeriesHE]`
+ static_frame/core/series.py:4072:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[SeriesHE[Any, Any], TVDtype@SeriesHE]`, found `InterGetItemILocReduces[Bottom[Series[Any, Any]] | ndarray[Never, Never] | TypeBlocks | ... omitted 7 union elements, TVDtype@SeriesHE]`
- static_frame/core/yarn.py:418:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Yarn[Any], object_]`, found `InterGetItemILocReduces[Yarn[Any] | Bottom[Index[Any]] | TypeBlocks | ... omitted 6 union elements, object_]`
+ static_frame/core/yarn.py:418:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Yarn[Any], object_]`, found `InterGetItemILocReduces[Yarn[Any] | ndarray[Never, Never] | TypeBlocks | ... omitted 6 union elements, object_]`
- Found 1826 diagnostics
+ Found 1827 diagnostics

pandas (https://github.com/pandas-dev/pandas)
- pandas/tests/scalar/test_na_scalar.py:158:12: error[unsupported-operator] Unary operator `-` is not supported for object of type `NAType`
- pandas/tests/scalar/test_na_scalar.py:159:16: error[invalid-argument-type] Argument to function `abs` is incorrect: Expected `SupportsAbs[Unknown]`, found `NAType`
- pandas/tests/scalar/test_na_scalar.py:160:12: error[unsupported-operator] Unary operator `~` is not supported for object of type `NAType`
- pandas/tests/scalar/test_na_scalar.py:165:12: error[unsupported-operator] Operator `&amp;` is not supported between objects of type `Literal[True]` and `NAType`
- pandas/tests/scalar/test_na_scalar.py:166:12: error[unsupported-operator] Operator `&amp;` is not supported between objects of type `NAType` and `Literal[False]`
- pandas/tests/scalar/test_na_scalar.py:167:12: error[unsupported-operator] Operator `&amp;` is not supported between objects of type `Literal[False]` and `NAType`
- pandas/tests/scalar/test_na_scalar.py:168:12: error[unsupported-operator] Operator `&amp;` is not supported between two objects of type `NAType`
- pandas/tests/scalar/test_na_scalar.py:171:12: error[unsupported-operator] Operator `&amp;` is not supported between objects of type `NAType` and `numpy.bool[builtins.bool]`
- pandas/tests/scalar/test_na_scalar.py:172:12: error[unsupported-operator] Operator `&amp;` is not supported between objects of type `numpy.bool[builtins.bool]` and `NAType`
- pandas/tests/scalar/test_na_scalar.py:173:12: error[unsupported-operator] Operator `&amp;` is not supported between objects of type `NAType` and `numpy.bool[builtins.bool]`
- pandas/tests/scalar/test_na_scalar.py:174:12: error[unsupported-operator] Operator `&amp;` is not supported between objects of type `numpy.bool[builtins.bool]` and `NAType`
- pandas/tests/scalar/test_na_scalar.py:178:9: error[unsupported-operator] Operator `&amp;` is not supported between objects of type `NAType` and `Literal[5]`
- pandas/tests/scalar/test_na_scalar.py:185:12: error[unsupported-operator] Operator `|` is not supported between objects of type `Literal[False]` and `NAType`
- pandas/tests/scalar/test_na_scalar.py:186:12: error[unsupported-operator] Operator `|` is not supported between two objects of type `NAType`
- pandas/tests/scalar/test_na_scalar.py:189:12: error[unsupported-operator] Operator `|` is not supported between objects of type `NAType` and `numpy.bool[builtins.bool]`
- pandas/tests/scalar/test_na_scalar.py:190:12: error[unsupported-operator] Operator `|` is not supported between objects of type `numpy.bool[builtins.bool]` and `NAType`
- pandas/tests/scalar/test_na_scalar.py:191:12: error[unsupported-operator] Operator `|` is not supported between objects of type `NAType` and `numpy.bool[builtins.bool]`
- pandas/tests/scalar/test_na_scalar.py:192:12: error[unsupported-operator] Operator `|` is not supported between objects of type `numpy.bool[builtins.bool]` and `NAType`
- pandas/tests/scalar/test_na_scalar.py:196:9: error[unsupported-operator] Operator `|` is not supported between objects of type `NAType` and `Literal[5]`
- pandas/tests/scalar/test_na_scalar.py:201:12: error[unsupported-operator] Operator `^` is not supported between objects of type `Literal[True]` and `NAType`
- pandas/tests/scalar/test_na_scalar.py:202:12: error[unsupported-operator] Operator `^` is not supported between objects of type `NAType` and `Literal[False]`
- pandas/tests/scalar/test_na_scalar.py:203:12: error[unsupported-operator] Operator `^` is not supported between objects of type `Literal[False]` and `NAType`
- pandas/tests/scalar/test_na_scalar.py:204:12: error[unsupported-operator] Operator `^` is not supported between two objects of type `NAType`
- pandas/tests/scalar/test_na_scalar.py:207:12: error[unsupported-operator] Operator `^` is not supported between objects of type `NAType` and `numpy.bool[builtins.bool]`
- pandas/tests/scalar/test_na_scalar.py:208:12: error[unsupported-operator] Operator `^` is not supported between objects of type `numpy.bool[builtins.bool]` and `NAType`
- pandas/tests/scalar/test_na_scalar.py:209:12: error[unsupported-operator] Operator `^` is not supported between objects of type `NAType` and `numpy.bool[builtins.bool]`
- pandas/tests/scalar/test_na_scalar.py:210:12: error[unsupported-operator] Operator `^` is not supported between objects of type `numpy.bool[builtins.bool]` and `NAType`
- pandas/tests/scalar/test_na_scalar.py:214:9: error[unsupported-operator] Operator `^` is not supported between objects of type `NAType` and `Literal[5]`
- pandas/tests/scalar/timedelta/test_arithmetic.py:627:25: error[unsupported-operator] Operator `//` is not supported between objects of type `Timedelta` and `NaTType`
- Found 3792 diagnostics
+ Found 3763 diagnostics

pandas-stubs (https://github.com/pandas-dev/pandas-stubs)
+ pandas-stubs/_typing.pyi:1232:16: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 5169 diagnostics
+ Found 5170 diagnostics


</code></pre>
</details>

<p>No memory usage changes detected ✅</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 02:26:54 UTC
    </footer>
</body>
</html>
