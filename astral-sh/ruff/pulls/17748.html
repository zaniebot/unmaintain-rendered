<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[semantic-syntax-tests] `IrrefutableCasePattern`, `SingleStarredAssignment`, `WriteToDebug`, `InvalidExpression` - astral-sh/ruff #17748</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[semantic-syntax-tests] <code>IrrefutableCasePattern</code>, <code>SingleStarredAssignment</code>, <code>WriteToDebug</code>, <code>InvalidExpression</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17748">#17748</a>
        opened by <a href="https://github.com/maxmynter">@maxmynter</a>
        on 2025-04-30 21:04
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/maxmynter">@maxmynter</a> on 2025-04-30 21:04</div>
            <div class="timeline-body"><p>Re: #17526</p>
<h2>Summary</h2>
<p>Add integration test for semantic syntax for <code>IrrefutableCasePattern</code>, <code>SingleStarredAssignment</code>, <code>WriteToDebug</code>, and <code>InvalidExpression</code>.</p>
<h2>Notes</h2>
<ul>
<li><p>Following @ntBre's suggestion, I will keep the test coming in batches like this over the next few days in separate PRs to keep the review load per PR manageable while also not spamming too many.</p>
</li>
<li><p>I did not add a test for <code>del __debug__</code> which is one of the examples in <code>crates/ruff_python_parser/src/semantic_errors.rs:1051</code>.
For python version <code>&lt;= 3.8</code> there is no error and for <code>&gt;=3.9</code> the error is not <code>WriteToDebug</code> but <code>SyntaxError: cannot delete __debug__ on Python 3.9 (syntax was removed in 3.9)</code>.</p>
</li>
<li><p>The <code>blacken-docs</code> bypass is necessary because otherwise the test does not pass pre-commit checks; but we want to check for this faulty syntax.</p>
</li>
</ul>
<!-- What's the purpose of the change? What does it do, and why? -->

<h2>Test Plan</h2>
<p>This is a test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @maxmynter on 2025-04-30 21:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @maxmynter on 2025-04-30 21:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @maxmynter on 2025-04-30 21:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @maxmynter on 2025-04-30 21:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-30 21:07</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "(tests) Add linter.rs and red knot integration tests" to "[semantic-syntax-tests] Integration tests in linter and red knot for `IrrefutableCasePattern`, `SingleStarredAssignment`, `WriteToDebug`, and `InvalidExpression`" by @maxmynter on 2025-04-30 21:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[semantic-syntax-tests] Integration tests in linter and red knot for `IrrefutableCasePattern`, `SingleStarredAssignment`, `WriteToDebug`, and `InvalidExpression`" to "[semantic-syntax-tests] `IrrefutableCasePattern`, `SingleStarredAssignment`, `WriteToDebug`, `InvalidExpression`" by @maxmynter on 2025-04-30 21:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-04-30 21:19</div>
            <div class="timeline-body"><p>red-knot tests look good</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by @ntBre on 2025-04-30 21:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-30 21:28</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/red_knot_python_semantic/resources/mdtest/diagnostics/semantic_syntax_errors.md</code>:274 on 2025-05-01 15:43</div>
            <div class="timeline-body"><p>I think if you parenthesize the <code>yield from</code> you can get by without the <code>blacken-docs:off</code>:</p>
<pre><code class="language-suggestion">class C((yield from [object])):
</code></pre>
<p>Without the parens, it's actually a parse error in CPython, rather than a semantic/compiler error. I'm surprised we don't emit an error from the parser too.</p>
<pre><code class="language-pycon">&gt;&gt;&gt; import ast
&gt;&gt;&gt; ast.parse(&quot;class C(yield from [object]): ...&quot;)
Traceback (most recent call last):
  File &quot;&lt;python-input-3&gt;&quot;, line 1, in &lt;module&gt;
    ast.parse(&quot;class C(yield from [object]): ...&quot;)
    ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/usr/lib/python3.13/ast.py&quot;, line 54, in parse
    return compile(source, filename, mode, flags,
                   _feature_version=feature_version, optimize=optimize)
  File &quot;&lt;unknown&gt;&quot;, line 1
    class C(yield from [object]): ...
            ^^^^^
SyntaxError: invalid syntax
&gt;&gt;&gt; ast.parse(&quot;class C((yield from [object])): ...&quot;)
&lt;ast.Module object at 0x70a940be1c90&gt;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/linter.rs</code>:1095 on 2025-05-01 15:44</div>
            <div class="timeline-body"><p>nit: I'd probably put these on one line if they fit, but it's not a big deal either way.</p>
<pre><code class="language-suggestion">        &quot;*a = [1, 2, 3, 4]&quot;,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/snapshots/ruff_linter__linter__tests__semantic_syntax_error_InvalidExpression_invalid_expression_yield_from_in_base_class_3.10.snap</code>:8 on 2025-05-01 15:46</div>
            <div class="timeline-body"><p>Ah okay, we do emit a parse error for this. This one needs parens too to get the semantic error instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-01 15:47</div>
            <div class="timeline-body"><p>Thanks! I had one suggestion about the <code>yield from</code> cases and a nit you can ignore if you prefer it this way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/maxmynter">@maxmynter</a> on <code>crates/ruff_linter/src/snapshots/ruff_linter__linter__tests__semantic_syntax_error_InvalidExpression_invalid_expression_yield_from_in_base_class_3.10.snap</code>:8 on 2025-05-02 19:08</div>
            <div class="timeline-body"><p>with</p>
<pre><code class="language-py">class C((yield from [object])):
    pass
</code></pre>
<p>results in an empty snapshot for the associated test.</p>
<p>Am I doing something wrong, is there an issue with the implementation, or is this desired?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/maxmynter">@maxmynter</a> reviewed on 2025-05-02 19:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-05 15:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/snapshots/ruff_linter__linter__tests__semantic_syntax_error_InvalidExpression_invalid_expression_yield_from_in_base_class_3.10.snap</code>:8 on 2025-05-05 15:00</div>
            <div class="timeline-body"><p>Oh, this is actually allowed in CPython with the parens (at least if you enclose it in a function to avoid <em>that</em> error):</p>
<pre><code class="language-pycon">&gt;&gt;&gt; class C((yield from [object])):
...     pass
...
  File &quot;&lt;python-input-2&gt;&quot;, line 1
    class C((yield from [object])):
             ^^^^^^^^^^^^^^^^^^^
SyntaxError: 'yield from' outside function
&gt;&gt;&gt; class C((yield from [object])):
...     pass
KeyboardInterrupt
&gt;&gt;&gt; def f():
...     class C((yield from [object])): ...
...
&gt;&gt;&gt;
</code></pre>
<p>So I guess I would say just remove this test case, or make it generic, which <em>should</em> cause an error:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; def f():
...     class C[T]((yield from [object])): ...
...
  File &quot;&lt;python-input-4&gt;&quot;, line 2
    class C[T]((yield from [object])): ...
                ^^^^^^^^^^^^^^^^^^^
SyntaxError: yield expression cannot be used within the definition of a generic
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/maxmynter">@maxmynter</a> on 2025-05-06 22:01</div>
            <div class="timeline-body"><p>I went with the generic type parameter and pinned the necessary Python version, <code>3.12</code>. Also rebased on top of main and resolved merge conflicts that came from the other PRs adding tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @AlexWaygood on 2025-05-06 22:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @maxmynter on 2025-05-06 22:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/maxmynter">@maxmynter</a> on 2025-05-06 22:23</div>
            <div class="timeline-body"><p>If this is good, it also closes #17526,  I guess.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/linter.rs</code>:1202 on 2025-05-07 18:48</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        class C[T]((yield from [object])):
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ty_python_semantic/resources/mdtest/diagnostics/semantic_syntax_errors.md</code>:314 on 2025-05-07 18:51</div>
            <div class="timeline-body"><p>Sorry for not noticing this before, but these need to be <code>py</code> not <code>python</code> blocks or the mdtests don't actually run. The same is true for the <code>await</code> outside async function block below. I think those are the only 3 places, though. I was alerted to this because the error message should be <code>yield expression cannot be used within a generic definition</code>. I didn't explicitly handle <code>yield from</code> for the message, although I probably should have!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-07 18:52</div>
            <div class="timeline-body"><p>Thanks! I was just going to push the small tweak to the parens in the ruff case, but then I noticed the mdtest code block issue. Could you update those? Then this should be ready to go.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/maxmynter">@maxmynter</a> reviewed on 2025-05-07 22:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/maxmynter">@maxmynter</a> on <code>crates/ruff_linter/src/linter.rs</code>:1202 on 2025-05-07 22:41</div>
            <div class="timeline-body"><p>Damn, I must have undone this somehow during rebasing; because I remember having added these. Re-added in <a href="https://github.com/astral-sh/ruff/pull/17748/commits/94d6aee4ddd515320befb8e855b954ee1c4a17c9">94d6aee</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/maxmynter">@maxmynter</a> reviewed on 2025-05-07 22:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/maxmynter">@maxmynter</a> on <code>crates/ty_python_semantic/resources/mdtest/diagnostics/semantic_syntax_errors.md</code>:248 on 2025-05-07 22:45</div>
            <div class="timeline-body"><p>This one was not thrown after the <code>python</code> -&gt; <code>py</code> change. Is that a reason for concern @ntBre? Line was added in <a href="https://github.com/astral-sh/ruff/commit/e7f38fe74ba642cbd4cf286d8524f4172cbe30e2">e7f38fe</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @maxmynter on 2025-05-07 22:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/maxmynter">@maxmynter</a> reviewed on 2025-05-07 22:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/maxmynter">@maxmynter</a> on <code>crates/ty_python_semantic/resources/mdtest/diagnostics/semantic_syntax_errors.md</code>:248 on 2025-05-07 22:54</div>
            <div class="timeline-body"><p>A couple other errors were thrown due to this change. I adapted the test cases because they seem reasonanle. Let me know if you disagree.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-08 14:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ty_python_semantic/resources/mdtest/diagnostics/semantic_syntax_errors.md</code>:248 on 2025-05-08 14:05</div>
            <div class="timeline-body"><p>Wow one of the <code>python</code> blocks was mine! Thanks for the fix.</p>
<p>And yes, that error should not be thrown. I fixed it in a different PR and mentioned it on the PR adding this case <a href="https://github.com/astral-sh/ruff/pull/17463#discussion_r2050785521">here</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ty_python_semantic/resources/mdtest/diagnostics/semantic_syntax_errors.md</code>:303 on 2025-05-08 14:09</div>
            <div class="timeline-body"><p>nit: I'd probably just wrap this in an outer function to suppress these <code>outside of a function</code> errors since we only intend to test the other errors here. I think a lot of other mdtests use a function named <code>_</code> to indicate this:</p>
<pre><code class="language-py">def _():
    type X[T: (yield 1)] = int
</code></pre>
<p>but it's not a huge deal.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ty_python_semantic/resources/mdtest/diagnostics/semantic_syntax_errors.md</code>:307 on 2025-05-08 14:10</div>
            <div class="timeline-body"><p>This doesn't necessarily need to block this PR since you're just reporting the current state of things, but we might need to open a follow-up issue here to avoid duplicate diagnostics. @AlexWaygood do you know if the type error is separate from the syntax error here, or should we only pick one of these to emit?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-05-08 14:14</div>
            <div class="timeline-body"><p>Thanks again! The new errors prompted one question, mostly for Alex or someone else on the ty team. I also had one suggestion about the &quot;outside of a function&quot; errors, but this is just about ready to go.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/maxmynter">@maxmynter</a> reviewed on 2025-05-09 16:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/maxmynter">@maxmynter</a> on <code>crates/ty_python_semantic/resources/mdtest/diagnostics/semantic_syntax_errors.md</code>:303 on 2025-05-09 16:40</div>
            <div class="timeline-body"><p>I think there is still something here. With</p>
<pre><code class="language-py">def _():
# error: [invalid-type-form] &quot;`yield` expressions are not allowed in type expressions&quot;
# error: [invalid-syntax] &quot;yield expression cannot be used within a TypeVar bound&quot;
    type X[T: (yield 1)] = int

def _():
# error: [invalid-type-form] &quot;`yield` expressions are not allowed in type expressions&quot;
# error: [invalid-syntax] &quot;yield expression cannot be used within a type alias&quot;
    type Y = (yield 1)
</code></pre>
<p>I still get the outside of a function errors</p>
<pre><code class="language-bash">semantic_syntax_errors.md - Semantic syntax error diagnostics - Invalid expression

  crates/ty_python_semantic/resources/mdtest/diagnostics/semantic_syntax_errors.md:304 unexpected error: 16 [invalid-syntax] &quot;`yield` statement outside of a function&quot;
  crates/ty_python_semantic/resources/mdtest/diagnostics/semantic_syntax_errors.md:309 unexpected error: 15 [invalid-syntax] &quot;`yield` statement outside of a function&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/maxmynter">@maxmynter</a> on 2025-05-09 16:41</div>
            <div class="timeline-body"><p>One duplicate test case had slipped in, which i removed in <a href="https://github.com/astral-sh/ruff/pull/17748/commits/96aeedc4b442acc632aa69c39f3403559d2516ed">96aeedc</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @maxmynter on 2025-05-09 16:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ty_python_semantic/resources/mdtest/diagnostics/semantic_syntax_errors.md</code>:303 on 2025-05-09 17:22</div>
            <div class="timeline-body"><p>Ah, that's a bug, thank you! We can merge this as is, and I'll tackle it in a follow-up.</p>
<p>If you're curious, ty has separate scope kinds for type aliases and annotations, so the check for function scope needs to skip those instead of just checking that the immediate scope is a function. At least that looks like the easy fix to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-09 17:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ty_python_semantic/resources/mdtest/diagnostics/semantic_syntax_errors.md</code>:307 on 2025-05-09 17:45</div>
            <div class="timeline-body"><p>I talked to Alex, and this is a symptom of a more general need to suppress type-checking errors when there are syntax errors present. I'll spin off an issue for this too, so no worries here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-09 17:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-05-09 17:48</div>
            <div class="timeline-body"><p>Thanks! And thanks for all of your help on #17526, I'll close that now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-09 18:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ty_python_semantic/resources/mdtest/diagnostics/semantic_syntax_errors.md</code>:307 on 2025-05-09 18:00</div>
            <div class="timeline-body"><p>The issue already exists in the ty repo! https://github.com/astral-sh/ty/issues/119</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-05-09 18:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-05-09 18:54</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 18:57:30 UTC
    </footer>
</body>
</html>
