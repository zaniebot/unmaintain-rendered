<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add `parenthesized` flag to `ExprTuple` and `ExprGenerator` - astral-sh/ruff #9614</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add <code>parenthesized</code> flag to <code>ExprTuple</code> and <code>ExprGenerator</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/9614">#9614</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-01-22 13:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-01-22 13:14</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR adds an <code>parenthesized</code> prop to <code>ExprTuple</code> and <code>ExprGenerator</code> that expose if the tuple/genrator is parenthesized in the source.</p>
<p>The information is useful during linting and formatting, and dedecting if a tuple is parenthesized is somewhat involved.</p>
<p>Should this information be present in the AST: IMO, properties that are needed more than once are worth tracking in the AST, even if they don't have any semantical meaning.
It also simplifies implementing the new parser where it otherwise would need to be necessary to track the information separately.</p>
<h2>Test Plan</h2>
<p>I added new tests and reviewed the snapshot changes</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @MichaReiser on 2024-01-22 13:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2024-01-22 13:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by @MichaReiser on 2024-01-22 13:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/unnecessary_literal_union.rs</code>:75 on 2024-01-22 13:16</div>
            <div class="timeline-body"><p>What's the benefit of doing this over</p>
<pre><code class="language-suggestion">                    ..,
</code></pre>
<p>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-01-22 13:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/unnecessary_literal_union.rs</code>:75 on 2024-01-22 13:43</div>
            <div class="timeline-body"><p>It seems the author intended to handle each property explicitly. I didn't want to change that decision.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-01-22 13:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-01-22 14:00</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<details><summary><a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)</summary>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to read examples/How_to_handle_rate_limits.ipynb: Expected a Jupyter Notebook, which must be internally stored as JSON, but this file isn't valid JSON: trailing comma at line 47 column 4
</code></pre>
</p>
</details>

<h3>Formatter (preview)</h3>
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<details><summary><a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)</summary>
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to read examples/How_to_handle_rate_limits.ipynb: Expected a Jupyter Notebook, which must be internally stored as JSON, but this file isn't valid JSON: trailing comma at line 47 column 4
</code></pre>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-22 14:19</div>
            <div class="timeline-body"><p>If we track this for tuples, should we also track it for generators, where it's also optional?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-22 14:19</div>
            <div class="timeline-body"><p>I def support this. I think I tried to pitch it at one point but there wasn't enough interest :joy:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Add `is_parenthesized` flag to `ExprTuple`" to "Add `is_parenthesized` flag to `ExprTuple` and `ExprGenerator`" by @MichaReiser on 2024-02-26 13:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Add `is_parenthesized` flag to `ExprTuple` and `ExprGenerator`" to "Add `parenthesized` flag to `ExprTuple` and `ExprGenerator`" by @MichaReiser on 2024-02-26 13:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2024-02-26 13:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-02-26 15:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-02-26 15:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/ruff/rules/sequence_sorting.rs</code>:156 on 2024-02-26 15:10</div>
            <div class="timeline-body"><p>The code for RUF022 and RUF023 can be further simplified -- the only reason we were previously keeping a reference to the <code>ExprTuple</code> node around here was so that we could lazily query later whether the original tuple was parenthesized or not. With your refactor here, we can just store that directly by doing something like this:</p>
<pre><code class="language-diff">--- a/crates/ruff_linter/src/rules/ruff/rules/sequence_sorting.rs
+++ b/crates/ruff_linter/src/rules/ruff/rules/sequence_sorting.rs
@@ -135,13 +135,13 @@ impl InferredMemberType {
 /// We keep the original AST node around for the
 /// Tuple variant so that this can be queried later.
 #[derive(Debug)]
-pub(super) enum SequenceKind&lt;'a&gt; {
+pub(super) enum SequenceKind {
     List,
     Set,
-    Tuple(&amp;'a ast::ExprTuple),
+    Tuple { parenthesized: bool },
 }
 
-impl SequenceKind&lt;'_&gt; {
+impl SequenceKind {
     // N.B. We only need the source code for the Tuple variant here,
     // but if you already have a `Locator` instance handy,
     // getting the source code is very cheap.
@@ -149,11 +149,8 @@ impl SequenceKind&lt;'_&gt; {
         match self {
             Self::List =&gt; (&quot;[&quot;, &quot;]&quot;),
             Self::Set =&gt; (&quot;{&quot;, &quot;}&quot;),
-            Self::Tuple(ast::ExprTuple {
-                parenthesized: is_parenthesized,
-                ..
-            }) =&gt; {
-                if *is_parenthesized {
+            Self::Tuple { parenthesized } =&gt; {
+                if *parenthesized {
                     (&quot;(&quot;, &quot;)&quot;)
                 } else {
                     (&quot;&quot;, &quot;&quot;)
@@ -166,7 +163,7 @@ impl SequenceKind&lt;'_&gt; {
         match self {
             Self::List =&gt; TokenKind::Lsqb,
             Self::Set =&gt; TokenKind::Lbrace,
-            Self::Tuple(_) =&gt; TokenKind::Lpar,
+            Self::Tuple { .. } =&gt; TokenKind::Lpar,
         }
     }
 
@@ -174,7 +171,7 @@ impl SequenceKind&lt;'_&gt; {
         match self {
             Self::List =&gt; TokenKind::Rsqb,
             Self::Set =&gt; TokenKind::Rbrace,
-            Self::Tuple(_) =&gt; TokenKind::Rpar,
+            Self::Tuple { .. } =&gt; TokenKind::Rpar,
         }
     }
 }
diff --git a/crates/ruff_linter/src/rules/ruff/rules/sort_dunder_all.rs b/crates/ruff_linter/src/rules/ruff/rules/sort_dunder_all.rs
index 6df5646f6..d1a0ce79a 100644
--- a/crates/ruff_linter/src/rules/ruff/rules/sort_dunder_all.rs
+++ b/crates/ruff_linter/src/rules/ruff/rules/sort_dunder_all.rs
@@ -153,7 +153,7 @@ fn sort_dunder_all(checker: &amp;mut Checker, target: &amp;ast::Expr, node: &amp;ast::Expr)
     let (elts, range, kind) = match node {
         ast::Expr::List(ast::ExprList { elts, range, .. }) =&gt; (elts, *range, SequenceKind::List),
         ast::Expr::Tuple(tuple_node @ ast::ExprTuple { elts, range, .. }) =&gt; {
-            (elts, *range, SequenceKind::Tuple(tuple_node))
+            (elts, *range, SequenceKind::Tuple{ parenthesized: tuple_node.parenthesized })
         }
         _ =&gt; return,
     };
diff --git a/crates/ruff_linter/src/rules/ruff/rules/sort_dunder_slots.rs b/crates/ruff_linter/src/rules/ruff/rules/sort_dunder_slots.rs
index 83248ac9d..64c34879b 100644
--- a/crates/ruff_linter/src/rules/ruff/rules/sort_dunder_slots.rs
+++ b/crates/ruff_linter/src/rules/ruff/rules/sort_dunder_slots.rs
@@ -157,7 +157,9 @@ impl&lt;'a&gt; StringLiteralDisplay&lt;'a&gt; {
                 }
             }
             ast::Expr::Tuple(tuple_node @ ast::ExprTuple { elts, range, .. }) =&gt; {
-                let display_kind = DisplayKind::Sequence(SequenceKind::Tuple(tuple_node));
+                let display_kind = DisplayKind::Sequence(SequenceKind::Tuple {
+                    parenthesized: tuple_node.parenthesized,
+                });
                 Self {
                     elts: Cow::Borrowed(elts),
                     range: *range,
@@ -242,7 +244,7 @@ impl&lt;'a&gt; StringLiteralDisplay&lt;'a&gt; {
 /// Python provides for builtin containers.
 #[derive(Debug)]
 enum DisplayKind&lt;'a&gt; {
-    Sequence(SequenceKind&lt;'a&gt;),
+    Sequence(SequenceKind),
     Dict { values: &amp;'a [ast::Expr] },
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-02-26 15:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/sequence_sorting.rs</code>:156 on 2024-02-26 15:28</div>
            <div class="timeline-body"><p>Ahh nice catch!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2024-02-26 15:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-02-26 15:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-02-26 15:35</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 22:47:48 UTC
    </footer>
</body>
</html>
