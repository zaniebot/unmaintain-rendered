<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Consolidate detection of cyclically defined classes - astral-sh/ruff #14207</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Consolidate detection of cyclically defined classes</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14207">#14207</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-11-08 17:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-08 17:49</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes #14141.</p>
<p>Attempting to infer the MRO or metaclass of a cyclically defined class must be avoided, or we'll end up in an infinite loop. As such, our logic for determining metaclasses and our logic for determining MROs both have logic included to detect if a class is cyclically defined and abort if so.</p>
<p>This PR moves the cycle-detection logic from <code>mro.rs</code> into a single method on <code>ClassType</code> that is queried by both the MRO-inference and metaclass-inference methods. This has several advantages:</p>
<ul>
<li>It means that for cyclically defined classes, we don't even need to call the <code>try_mro</code> and <code>try_metaclass</code> Salsa queries in <code>check_class_definitions</code>. We know that we won't be able to calculate either, so there's no need to do so. It doesn't cost us anything to eagerly check whether the class is cyclically defined in the <code>check_class_definitions</code> method, because we would need to do this check anyway before even attempting to check that the class's MRO or metaclass was resolvable.</li>
<li>It gets rid of this awkward patch of code here, where we have to just ignore the error and move on, because we know it'll have already been handled by the MRO-checking logic immediately above: https://github.com/astral-sh/ruff/blob/953e862aca1449651d96036fcd35f7fab4ccda51/crates/red_knot_python_semantic/src/types/infer.rs#L567-L570</li>
<li>It's a reasonably significant reduction in code quantity. It's also a reasonably significant reduction in code complexity: there's now no need for a recursive inner function in <code>try_metaclass</code>, for example.</li>
</ul>
<p>The diff in the metaclass-inference logic is a bit hard to read -- sorry! -- but there's really not much changed overall. It's just all been dedented because there's no longer any need for the large recursive inner function.</p>
<h2>Can we use the <code>specify</code> Salsa functionality?</h2>
<p>@carljm suggested in https://github.com/astral-sh/ruff/issues/14141 that we could use Salsa's <code>specify</code> functionality to let Salsa know that it didn't even need to call <code>try_mro</code> or <code>try_metaclass</code> if there was a cyclic class definition, since if there's a cyclic class definition we know we'll just return an error variant from these queries. I tried this, and it doesn't seem to work: Salsa complains that <code>Class</code> doesn't implement the <code>salsa::plumbing::TrackedStructInDb</code> trait if I make this change:</p>
<pre><code class="language-diff">diff --git a/crates/red_knot_python_semantic/src/types.rs b/crates/red_knot_python_semantic/src/types.rs
index 2af8f1d9b..107305860 100644
--- a/crates/red_knot_python_semantic/src/types.rs
+++ b/crates/red_knot_python_semantic/src/types.rs
@@ -2322,7 +2322,7 @@ impl&lt;'db&gt; Class&lt;'db&gt; {
     }
 
     /// Return the metaclass of this class, or an error if the metaclass cannot be inferred.
-    #[salsa::tracked]
+    #[salsa::tracked(specify)]
     pub(crate) fn try_metaclass(self, db: &amp;'db dyn Db) -&gt; Result&lt;Type&lt;'db&gt;, MetaclassError&lt;'db&gt;&gt; {
</code></pre>
<p>I looked into this a little bit and I don't think it would be correct (and maybe not possible?) for <code>Class</code> to implement that trait, so I don't think we can use <code>specify</code> for Salsa-tracked methods on <code>Class</code>.</p>
<h2>Test Plan</h2>
<p>Existing tests all pass.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2024-11-08 17:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2024-11-08 17:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2024-11-08 17:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2024-11-08 17:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-08 18:05</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2333 on 2024-11-08 21:33</div>
            <div class="timeline-body"><p>nit: obviously it's not impossible, we did it prior to this diff :) might be clearer to just say &quot;we'd enter an infinite loop.&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2447 on 2024-11-08 21:35</div>
            <div class="timeline-body"><p>I guess the main cost of this diff (due to the fact that we can't use <code>specify</code>) is an additional tracked function for each class. But I think this is a reasonable tradeoff; there are relatively few classes (compared to the number of, say, definitions), so I don't think this will make a huge difference to our total tracked-functions count.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-11-08 21:36</div>
            <div class="timeline-body"><p>Looks good to me, thanks for this cleanup!</p>
<p>Interesting that no mdtests had to change here. Does that mean that this didn't actually regress the MRO we infer for cases where only a sub-graph of our MRO is cyclic?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-08 21:44</div>
            <div class="timeline-body"><blockquote>
<p>Interesting that no mdtests had to change here. Does that mean that this didn't actually regress the MRO we infer for cases where only a sub-graph of our MRO is cyclic?</p>
</blockquote>
<p>That's correct. At one point in my MRO PR I had a very weak form of partial recovery for cyclic classes. But it was pretty ad-hoc/unprincipled, and I didn't think it was particularly useful (given how cyclic classes inherently don't make any sense, and always fail at runtime anyway). So I ripped it out before landing the MRO PR; even though it wasn't <em>much</em> additional complexity, it didn't seem worth it considering how tiny the benefits were.</p>
<p>For any class with a cycle in its MRO, we infer the MRO as being <code>[&lt;the class in question&gt;, &lt;Unknown&gt;, &lt;object&gt;]</code>. That was true before this PR, and it's true with this PR as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-08 21:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2333 on 2024-11-08 21:48</div>
            <div class="timeline-body"><p>I mean... kinda? We would <em>try</em> to infer the metaclass prior to this diff, but we would immediately throw up our hands and bail out of it as soon as we detected a cycle. That feels like kind of the same thing to me ðŸ˜„ but, I'll rewrite the comment :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2447 on 2024-11-08 21:56</div>
            <div class="timeline-body"><p>Yes. I suppose we could also try not caching this, and just recomputing it everywhere. I don't really have any idea how much the caching helps or hurts us here.</p>
<p>Codspeed's entirely neutral on this PR, so it at least doesn't seem to be leading to a significant regression when checking tomllib. But then tomllib doesn't really have any deep inheritance hierarchies (I don't think!). So it might not be the best benchmark for this specific issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-08 21:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-11-08 22:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2333 on 2024-11-08 22:16</div>
            <div class="timeline-body"><p>Ok, fair enough!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-11-08 22:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2447 on 2024-11-08 22:17</div>
            <div class="timeline-body"><p>I think it's fine as is until/unless we have evidence it's an issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2024-11-08 22:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-11-08 22:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-08 22:17</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 20:51:27 UTC
    </footer>
</body>
</html>
