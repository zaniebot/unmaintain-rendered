<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add separate type for typevar &quot;identity&quot; - astral-sh/ruff #20813</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add separate type for typevar &quot;identity&quot;</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20813">#20813</a>
        opened by <a href="https://github.com/dcreager">@dcreager</a>
        on 2025-10-11 19:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dcreager">@dcreager</a> on 2025-10-11 19:54</div>
            <div class="timeline-body"><p>As part of #20598, we added <code>is_identical_to</code> methods to <code>TypeVarInstance</code> and <code>BoundTypeVarInstance</code>, which compare when two typevar instances refer to &quot;the same&quot; underlying typevar, even if we have forced their lazy bounds/constraints as part of marking typevars as inferable. (Doing so results in a different salsa interned struct ID, since we've changed the contents of the <code>bounds_or_constraints</code> field.)</p>
<p>It turns out that marking typevars as inferable is not the only way that we might force lazy bounds/constraints; it also happens when we materialize a type containing a typevar. This surfaced as ecosystem report failures on #20677.</p>
<p>That means that we need a more long-term fix to this problem. (<code>is_identical_to</code>, and its underlying <code>original</code> field, were meant to be a temporary fix until we removed the <code>MarkTypeVarsInferable</code> type mapping.)</p>
<p>This PR extracts out a separate type (<code>TypeVarIdentity</code>) that only includes the fields that actually inform whether two typevars are &quot;the same&quot;. All other properties of the typevar (default, bounds/constraints, etc) still live in <code>TypeVarInstance</code>. Call sites that care about typevar identity can now either store just <code>TypeVarIdentity</code> (if they never need access to those other properties), or continue to store <code>TypeVarInstance</code> but pull out its <code>identity</code> when performing those &quot;are they the same typevar&quot; comparisons. (All of this also applies respectively to <code>BoundTypeVar{Identity,Instance}</code>.) In particular, constraint sets now work on <code>BoundTypeVarIdentity</code>, and generic contexts still <em>store</em> a <code>BoundTypeVarInstance</code> (since we might need access to defaults when specializing), but are keyed on <code>BoundTypeVarIdentity</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dcreager on 2025-10-11 19:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dcreager on 2025-10-11 19:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @dcreager on 2025-10-11 19:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @dcreager on 2025-10-11 19:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @dcreager on 2025-10-11 19:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-11 19:56</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<details>
<summary>Changes were detected when running ty on typing conformance tests</summary>

<pre><code class="language-diff">--- old-output.txt	2025-10-13 23:49:17.110848042 +0000
+++ new-output.txt	2025-10-13 23:49:20.423865224 +0000
@@ -1,5 +1,5 @@
-fatal[panic] Panicked at /home/runner/.cargo/git/checkouts/salsa-e6f3bb7c2a062968/29ab321/src/function/execute.rs:217:25 when checking `/home/runner/work/ruff/ruff/typing/conformance/tests/aliases_type_statement.py`: `PEP695TypeAliasType &lt; 'db &gt;::value_type_(Id(cc17)): execute: too many cycle iterations`
-fatal[panic] Panicked at /home/runner/.cargo/git/checkouts/salsa-e6f3bb7c2a062968/29ab321/src/function/execute.rs:217:25 when checking `/home/runner/work/ruff/ruff/typing/conformance/tests/aliases_typealiastype.py`: `infer_definition_types(Id(1603f)): execute: too many cycle iterations`
+fatal[panic] Panicked at /home/runner/.cargo/git/checkouts/salsa-e6f3bb7c2a062968/29ab321/src/function/execute.rs:217:25 when checking `/home/runner/work/ruff/ruff/typing/conformance/tests/aliases_type_statement.py`: `PEP695TypeAliasType &lt; 'db &gt;::value_type_(Id(d017)): execute: too many cycle iterations`
+fatal[panic] Panicked at /home/runner/.cargo/git/checkouts/salsa-e6f3bb7c2a062968/29ab321/src/function/execute.rs:217:25 when checking `/home/runner/work/ruff/ruff/typing/conformance/tests/aliases_typealiastype.py`: `infer_definition_types(Id(1643f)): execute: too many cycle iterations`
 _directives_deprecated_library.py:15:31: error[invalid-return-type] Function always implicitly returns `None`, which is not assignable to return type `int`
 _directives_deprecated_library.py:30:26: error[invalid-return-type] Function always implicitly returns `None`, which is not assignable to return type `str`
 _directives_deprecated_library.py:36:41: error[invalid-return-type] Function always implicitly returns `None`, which is not assignable to return type `Self@__add__`
</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-11 19:57</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">sympy (https://github.com/sympy/sympy)
- sympy/polys/polyclasses.py:1289:31: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 11030 diagnostics
+ Found 11029 diagnostics

</code></pre>
</details>
No memory usage changes detected âœ…

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by @dcreager on 2025-10-11 20:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-11 20:12</div>
            <div class="timeline-body"><!-- generated-comment ty ecosystem-analyzer -->

<h2><code>ecosystem-analyzer</code> results</h2>
<p>| Lint rule | Added | Removed | Changed |
|-----------|------:|--------:|--------:|
| <code>unused-ignore-comment</code> | 0 | 1 | 0 |
| <strong>Total</strong> | <strong>0</strong> | <strong>1</strong> | <strong>0</strong> |</p>
<p><strong><a href="https://dcreager-typevar-identity.ecosystem-663.pages.dev/diff">Full report with detailed diff</a></strong> (<a href="https://dcreager-typevar-identity.ecosystem-663.pages.dev/timing">timing results</a>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> approved on 2025-10-13 08:03</div>
            <div class="timeline-body"><p>This looks great, thank you!</p>
<p>It looks like we can now revert @carljm's change in <code>signatures.rs</code> and potentially reclaim some performance?</p>
<pre><code class="language-diff">diff --git a/crates/ty_python_semantic/src/types/signatures.rs b/crates/ty_python_semantic/src/types/signatures.rs
index 039b89a6eb..108df8cb00 100644
--- a/crates/ty_python_semantic/src/types/signatures.rs
+++ b/crates/ty_python_semantic/src/types/signatures.rs
@@ -1292,19 +1292,8 @@ impl&lt;'db&gt; Parameters&lt;'db&gt; {
                     let class = nearest_enclosing_class(db, index, scope_id).unwrap();
 
                     Some(
-                        // It looks like unnecessary work here that we create the implicit Self
-                        // annotation using non-inferable typevars and then immediately apply
-                        // `MarkTypeVarsInferable` to it. However, this is currently necessary to
-                        // ensure that implicit-Self and explicit Self annotations are both treated
-                        // the same. Marking type vars inferable will cause reification of lazy
-                        // typevar defaults/bounds/constraints; this needs to happen for both
-                        // implicit and explicit Self so they remain the &quot;same&quot; typevar.
-                        typing_self(db, scope_id, typevar_binding_context, class, &amp;Type::NonInferableTypeVar)
-                            .expect(&quot;We should always find the surrounding class for an implicit self: Self annotation&quot;).apply_type_mapping(
-                                db,
-                                &amp;TypeMapping::MarkTypeVarsInferable(None),
-                                TypeContext::default()
-                            )
+                        typing_self(db, scope_id, typevar_binding_context, class, &amp;Type::TypeVar)
+                            .expect(&quot;We should always find the surrounding class for an implicit self: Self annotation&quot;)
                     )
                 } else {
                     // For methods of non-generic classes that are not otherwise generic (e.g. return `Self` or
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @AlexWaygood on 2025-10-13 08:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-10-13 20:58</div>
            <div class="timeline-body"><blockquote>
<p>It looks like we can now revert @carljm's change in <code>signatures.rs</code> and potentially reclaim some performance?</p>
</blockquote>
<p>I currently have that being removed in #20677, where we remove the separate enum variants for inferable vs non-inferable. But I can try it here too and see if everything still passes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> removed by @dcreager on 2025-10-13 21:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by @dcreager on 2025-10-13 21:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-10-13 23:47</div>
            <div class="timeline-body"><blockquote>
<p>But I can try it here too and see if everything still passes.</p>
</blockquote>
<p>Removing this here added back a <code>no-matching-overload</code> ecosystem diagnostic that had been removed. I'm going to keep this removal on #20677, where I think it will be fully redundant.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dcreager on 2025-10-14 00:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dcreager on 2025-10-14 00:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-10-14 00:09</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:35:00 UTC
    </footer>
</body>
</html>
