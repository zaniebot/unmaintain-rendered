<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`ruff`] Implement post-init-default (`RUF033`) - astral-sh/ruff #13192</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>ruff</code>] Implement post-init-default (<code>RUF033</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13192">#13192</a>
        opened by <a href="https://github.com/tjkuson">@tjkuson</a>
        on 2024-09-01 11:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tjkuson">@tjkuson</a></div>
            <div class="timeline-body">Summary
<p>Implements the post-init-default (<code>RUF033</code>) rule, which reports a diagnostic upon any <code>__post_init__</code> method with argument default. Has a sometimes available unsafe autofix. For example,</p>
<pre><code> from dataclasses import InitVar, dataclass


 @dataclass
 class Foo:
     &quot;&quot;&quot;A very helpful docstring.&quot;&quot;&quot;

+    baz: InitVar[str] = &quot;something&quot;
     bar: InitVar[int] = 1

-    def __post_init__(self, bar: int, baz: str = &quot;something&quot;) -&gt; None: ...
+    def __post_init__(self, bar: int, baz: str) -&gt; None: ...
</code></pre>
<p>Closes #13128</p>
Test Plan
<p><code>cargo nextest run</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/ruff/rules/post_init_default.rs</code>:90 on 2024-09-01 11:40</div>
            <div class="timeline-body"><p>Before emitting the diagnostic, could we also check:</p>
<ol>
<li>That we&#x27;re inside a class scope (we shouldn&#x27;t emit for <code>__post_init__</code> functions in the global scope)</li>
<li>That the class is decorated with <code>@dataclasses.dataclass</code> (since <code>__post_init__</code> has no special meaning for other classes)</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/ruff/rules/post_init_default.rs</code>:14 on 2024-09-01 11:40</div>
            <div class="timeline-body"><pre><code>/// [documentation]:
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/ruff/rules/post_init_default.rs</code>:20 on 2024-09-01 11:40</div>
            <div class="timeline-body"><pre><code>/// Default values for `__post_init__` arguments that exist as init-only fields
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/ruff/rules/post_init_default.rs</code>:49 on 2024-09-01 11:41</div>
            <div class="timeline-body"><p>We may as well keep the type annotations! Otherwise type checkers won&#x27;t analyze the body of the function :-)</p>
<pre><code>///     def __post_init__(self, bar: int, baz: int) -&gt; None:
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/ruff/rules/post_init_default.rs</code>:68 on 2024-09-01 11:44</div>
            <div class="timeline-body"><p>Even though there isn&#x27;t actually a fix yet, I&#x27;d use <code>fix_title()</code> here for this information, as it keeps the violation message nice and concise, and clearly separates what the problem is from how to fix it.</p>
<pre><code>    #[derive_message_formats]
    fn message(&amp;self) -&gt; String {
        format!(&quot;`__post_init__` method with argument defaults&quot;)
    }
    
    fn fix_title(&amp;self) -&gt; String {
        format!(&quot;Use `dataclasses.InitVar` instead&quot;&quot;)
    }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-09-01 11:48</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-09-01 11:48</div>
            <div class="timeline-body"><p>Sorry for reviewing a draft PR... couldn&#x27;t resist! Looks great.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tjkuson">@tjkuson</a> reviewed on 2024-09-01 18:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/tjkuson">@tjkuson</a> on <code>crates/ruff_linter/src/rules/ruff/rules/post_init_default.rs</code>:90 on 2024-09-01 18:09</div>
            <div class="timeline-body"><p>Done in <a href="https://github.com/astral-sh/ruff/pull/13192">astral-sh/ruff#13192</a>/commits/6ca05468a85d7a9266d986205b2ccb57ae3f3301</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-09-01 18:15</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/tjkuson:post-init-defaults">CodSpeed Performance Report</a>
Merging #13192 will <strong>improve performances by 5.89%</strong>
<p>Comparing <code>tjkuson:post-init-defaults</code> (7b21ade) with <code>main</code> (0f85769)</p>
Summary
<p><code>⚡ 1</code> improvements
<code>✅ 31</code> untouched benchmarks</p>
Benchmarks breakdown
<p>|     | Benchmark | <code>main</code> | <code>tjkuson:post-init-defaults</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ⚡ | <code>linter/all-with-preview-rules[numpy/globals.py]</code> | 866.2 µs | 818 µs | +5.89% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/tjkuson">@tjkuson</a> on 2024-09-01 18:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Implement post-init-default (`RUF033`)&quot; to &quot;[`ruff`] Implement post-init-default (`RUF033`)&quot; by <a href="https://github.com/tjkuson">@tjkuson</a> on 2024-09-01 18:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-02 08:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-09-02 11:52</div>
            <div class="timeline-body"><p>Thanks! I pushed a couple of simplifications, but this was overall an excellent PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/ruff/rules/post_init_default.rs</code>:85 on 2024-09-02 11:54</div>
            <div class="timeline-body"><p>I made this run on <code>StmtFunctionDef</code> nodes rather than <code>StmtClassDef</code> nodes, as this allows us to access <code>checker.semantic().current_scope()</code> to see what other symbols have been bound in the class. This enables us to see much more simply and more accurately whether it&#x27;s safe to add a new <code>InitVar</code> field to the class body in the fix</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/ruff/rules/post_init_default.rs</code>:185 on 2024-09-02 11:56</div>
            <div class="timeline-body"><p>Rather than iterate through all statements in the class body until we get the first non-docstring statement, I changed it so that we just insert the <code>InitVar</code> symbol in the line before the <code>__post_init__</code> definition. It seems much simpler and less error-prone as we already know that we&#x27;re past the docstring in this case</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-09-02 11:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-02 11:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-02 11:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-09-02 12:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-09-02 12:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-09-02 12:28</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:06:28 UTC
    </footer>
</body>
</html>
