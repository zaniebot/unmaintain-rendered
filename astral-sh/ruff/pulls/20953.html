<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refactor format tests to use CliTest helper - astral-sh/ruff #20953</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Refactor format tests to use CliTest helper</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20953">#20953</a>
        opened by <a href="https://github.com/Renkai">@Renkai</a>
        on 2025-10-18 03:44
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Renkai">@Renkai</a></div>
            <div class="timeline-body"><p>Part of <a href="https://github.com/astral-sh/ruff/issues/19016">astral-sh/ruff#19016</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-18 04:16</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>âœ… ecosystem check detected no linter changes.</p>
Linter (preview)
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-18 08:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/tests/cli/format.rs</code>:737 on 2025-10-18 08:22</div>
            <div class="timeline-body"><p>Nit: You could avoid some repetition by adding a <code>format_command</code> method to <code>test</code> that always sets <code>format --no-cache</code> and maybe <code>--isolated</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/tests/cli/main.rs</code>:45 on 2025-10-18 08:28</div>
            <div class="timeline-body"><p>Can you tell me why this is now necessary? Is it because of the output format tests? If so, could we use the same approach as in linter tests https://github.com/astral-sh/ruff/blob/15af4c0a34dd6d86d9aa98115ae1e1e9392c7eef/crates/ruff/tests/cli/lint.rs#L3293-L3298</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/tests/cli/snapshots/cli__format__output_format_grouped.snap</code>:10 on 2025-10-18 08:28</div>
            <div class="timeline-body"><p>Is using <code>--preview</code> here intentional?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/tests/cli/format.rs</code>:46 on 2025-10-18 08:29</div>
            <div class="timeline-body"><p>I suggest that we use <code>CliTest</code> for all tests, including tests that don&#x27;t use <code>with_files</code> or <code>write_file</code>. Using <code>CliTest</code> has the benefit that it e.g. clears all environment variables, ensuring better test isolation</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-18 08:29</div>
            <div class="timeline-body"><p>Thank you. i&#x27;ve a few questions</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Renkai">@Renkai</a> reviewed on 2025-10-18 08:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Renkai">@Renkai</a> on <code>crates/ruff/tests/cli/main.rs</code>:45 on 2025-10-18 08:32</div>
            <div class="timeline-body"><p>Yes it&#x27;s for  output format tests. I&#x27;m not successful yet, windows is too weird ðŸ˜¢. Will take a look at your suggested approach soon.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Renkai">@Renkai</a> reviewed on 2025-10-18 08:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Renkai">@Renkai</a> on <code>crates/ruff/tests/cli/main.rs</code>:45 on 2025-10-18 08:33</div>
            <div class="timeline-body"><p>Why should we add a different filter in a test, but not the common class?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-18 08:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/tests/cli/main.rs</code>:45 on 2025-10-18 08:40</div>
            <div class="timeline-body"><p>I decided to use a specific filter for that test because the criteria aren&#x27;t very specific, risking that we accidentally filter out unrelated content.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Renkai">@Renkai</a> reviewed on 2025-10-18 11:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Renkai">@Renkai</a> on <code>crates/ruff/tests/cli/snapshots/cli__format__output_format_grouped.snap</code>:10 on 2025-10-18 11:53</div>
            <div class="timeline-body"><p>The diff is from <a href="https://github.com/astral-sh/ruff/pull/20443">astral-sh/ruff#20443</a> I think, not sure why the snapshot is not change on his PR but mine</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/Renkai">@Renkai</a> on 2025-10-18 12:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/tests/cli/format.rs</code>:231 on 2025-10-18 14:30</div>
            <div class="timeline-body"><p>We can just pass &quot;ruff.toml&quot; now, because <code>CliTest::command</code> ensures that the current working directory is the test root.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/tests/cli/format.rs</code>:636 on 2025-10-18 14:31</div>
            <div class="timeline-body"><p>What&#x27;s the reason what we need those new escapes that weren&#x27;t needed before? Are they also needed when using <code>CliTest::with_settings</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-18 14:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-10-19 10:10</div>
            <div class="timeline-body"><p>Thank you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-19 10:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-19 10:25</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:19:40 UTC
    </footer>
</body>
</html>
