<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] feat: introduce a new `[Type::Todo]` variant - astral-sh/ruff #13548</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] feat: introduce a new <code>[Type::Todo]</code> variant</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13548">#13548</a>
        opened by <a href="https://github.com/Slyces">@Slyces</a>
        on 2024-09-28 20:17
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Slyces">@Slyces</a></div>
            <div class="timeline-body"><p>This variant shows inference that is not yet implemented..</p>


Summary
<p>PR #13500 reopened the idea of adding a new type variant to keep track of not-implemented features in Red Knot.</p>
<p>It was based off of #12986 with a more generic approach of keeping track of different kind of unknowns. Discussion in #13500 agreed that keeping track of different <code>Unknown</code> is complicated for now, and this feature is better achieved through a new variant of <code>Type</code>.</p>
Requirements
<p>Requirements for this implementation can be summed up with some extracts of comment from @carljm on the previous PR</p>
<blockquote>
<p>So at the moment we are leaning towards simplifying this PR to just use a new top-level variant, which behaves like Any and Unknown but represents inference that is not yet implemented in red-knot.</p>
</blockquote>
<blockquote>
<p>I think the general rule should be that Todo should propagate only when the presence of the input Todo caused the output to be unknown.</p>
<p>To take a specific example, the inferred result of addition must be Unknown if either operand is Unknown. That is, Unknown + X will always be Unknown regardless of what X is. (Same for X + Unknown.) In this case, I believe that Unknown + Todo (or Todo + Unknown) should result in Unknown, not result in Todo. If we fix the upstream source of the Todo, the result would still be Unknown, so it&#x27;s not useful to propagate the Todo in this case: it wrongly suggests that the output is unknown because of a todo item.</p>
</blockquote>
Test Plan
<p>This PR does not introduce new tests, but it did required to edit some tests with the display of <code>[Type::Todo]</code> (currently <code>@Todo</code>), which suggests that those test are placeholders requirements for features we don&#x27;t support yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/Slyces">@Slyces</a> on 2024-09-28 20:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/Slyces">@Slyces</a> on 2024-09-28 20:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/Slyces">@Slyces</a> on 2024-09-28 20:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-09-28 20:31</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>âœ… ecosystem check detected no linter changes.</p>
Linter (preview)
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:241 on 2024-09-28 23:02</div>
            <div class="timeline-body"><p>If you want the second line to be a second sentence, you need a period at the end of the first line ;)</p>
<pre><code>    /// Unknown type (either no annotation, or some kind of type error).
    /// Equivalent to Any, or possibly to object in strict mode
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:244 on 2024-09-28 23:03</div>
            <div class="timeline-body"><p>this change isn&#x27;t correct: this line is part of the same sentence as the previous line</p>
<pre><code>    /// leniency options it could be silently resolved to Unknown in some cases)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:249 on 2024-09-28 23:04</div>
            <div class="timeline-body"><pre><code>    /// This variant should eventually be removed once red-knot is spec-compliant.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:254 on 2024-09-28 23:04</div>
            <div class="timeline-body"><pre><code>    /// General rule: `Todo` should only propagate when the presence of the input `Todo` caused the
    /// output to be unknown. An output should only be `Todo` if fixing the input to be correctly
    /// inferred would cause the output to be known - this is not the case with `[Type::Any]` or
    /// `[Type::Unknown]`.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/display.rs</code>:70 on 2024-09-28 23:06</div>
            <div class="timeline-body"><pre><code>            // `[Type::Todo]`&#x27;s display should be explicit that is not a valid display of
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2236 on 2024-09-28 23:07</div>
            <div class="timeline-body"><p>Best not to use <code>&amp;</code> here as it could be misinterpreted as meaning &quot;the intersection type of <code>Any</code> and <code>Unknown</code> ðŸ˜„</p>
<pre><code>            // When interacting with Todo, Any and Unknown should propagate (as if we fix this Todo
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:5264 on 2024-09-28 23:07</div>
            <div class="timeline-body"><pre><code>        // We currently return `Todo` for all `async for` loops,
        // including loops that have invalid syntax
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:5827 on 2024-09-28 23:08</div>
            <div class="timeline-body"><pre><code>        // We currently return `Todo` for all async comprehensions,
        // including loops that have invalid syntax
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-09-28 23:09</div>
            <div class="timeline-body"><p>Nice! This looks pretty good to me. Here&#x27;s a few nitpicks about comments</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Slyces">@Slyces</a> reviewed on 2024-09-29 08:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Slyces">@Slyces</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:241 on 2024-09-29 08:05</div>
            <div class="timeline-body"><p>Ah sorry I just noticed that some comments started with a capital and some didn&#x27;t, maybe didn&#x27;t entirely pay attention</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/Slyces">@Slyces</a> on 2024-09-29 08:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> requested changes on 2024-09-29 14:47</div>
            <div class="timeline-body"><p>Thank you! I think there are a few other places where we could use this new variant:</p>
(1) Both of these branches here:
<p>https://github.com/astral-sh/ruff/blob/bee498d6359dd7ce9aa8bff685ca821ab1bbfe31/crates/red_knot_python_semantic/src/types.rs#L502-L506</p>
<p>Objects that have literal-<code>int</code> or literal-<code>bool</code> types do have attributes and methods; we shouldn&#x27;t just infer <code>Unknown</code> for all member accesses in these branches. For all attribute lookups in these branches, we&#x27;ll either need to special-case the specific attribute or defer to the typeshed stubs for <code>bool</code> / <code>int</code>; <code>Type::TODO</code> seems better than <code>Type::Unknown</code> to indicate that.</p>
(2) These two branches here:
<p>https://github.com/astral-sh/ruff/blob/bee498d6359dd7ce9aa8bff685ca821ab1bbfe31/crates/red_knot_python_semantic/src/types.rs#L732-L735</p>
<p>Once we support <code>type[T]</code>, we can infer <code>type[Any]</code> and <code>type[Unknown]</code> for these branches, which is more precise than <code>Any</code> and <code>Unknown</code>. For example, whereas <code>&lt;instance_of_Any&gt;.__module__</code> is <code>Any</code>, <code>&lt;instance_of_type_Any&gt;.__module__</code> is a <code>str</code>. So <code>Type::TODO</code> is appropriate here, I think.</p>
(3) These branches:
<p>https://github.com/astral-sh/ruff/blob/bee498d6359dd7ce9aa8bff685ca821ab1bbfe31/crates/red_knot_python_semantic/src/types/infer.rs#L783-L785</p>
<p>https://github.com/astral-sh/ruff/blob/bee498d6359dd7ce9aa8bff685ca821ab1bbfe31/crates/red_knot_python_semantic/src/types/infer.rs#L1027-L1031</p>
<p>As the comments say, we should be able to infer much more precise types for these once we&#x27;ve implemented some currently-missing features</p>
(4) The <code>Unknown</code> branch here:
<p>https://github.com/astral-sh/ruff/blob/bee498d6359dd7ce9aa8bff685ca821ab1bbfe31/crates/red_knot_python_semantic/src/types/infer.rs#L980-L986</p>
<p>We should be able to infer better types for bindings in situations such as <code>except (OSError, TypeError) as e</code> -- we currently infer the type of <code>e</code> as <code>Unknown</code>, but it should really be <code>OSError | TypeError</code>. Similarly for <code>except EXCEPTIONS as f</code> where <code>EXCEPTIONS</code> is a variable that has type <code>tuple[type[OSError], type[TypeError]]</code> -- we&#x27;ll currently just infer <code>Unknown</code> for <code>f</code>, but the type of <code>f</code> should also be <code>OSError | TypeError</code>.</p>
<hr>
<p>There&#x27;s also one place where I think we should add a comment, because <code>Unknown</code> is correct but it&#x27;s not obvious why it&#x27;s correct:</p>
<pre><code>--- a/crates/red_knot_python_semantic/src/types/infer.rs
+++ b/crates/red_knot_python_semantic/src/types/infer.rs
@@ -968,6 +968,8 @@ impl&lt;&#x27;db&gt; TypeInferenceBuilder&lt;&#x27;db&gt; {
         let node_ty = except_handler_definition
             .handled_exceptions()
             .map(|ty| self.infer_expression(ty))
+            // If there is no handled exception, it&#x27;s invalid syntax;
+            // a diagnostic will have already been emitted
             .unwrap_or(Type::Unknown);
 
         let symbol_ty = if except_handler_definition.is_star() {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Slyces">@Slyces</a> on 2024-09-29 15:44</div>
            <div class="timeline-body"><p>Thank you so much for looking into this with so much detail, and sorry for missing some cases. Branches 1, 3, 4 lead to no issues with existing tests.</p>
<p>Branch 2 however requires additional code for invalid syntax in comprehensions as:</p>
<ul>
<li>Invalid comprehensions can have <code>Type::Unknown</code> as the target iterator</li>
<li><code>Type::Unknown</code>&#x27;s metaclass being <code>Unknown</code>, the method <code>Type::iterate</code> end up yielding <code>Unknown</code></li>
<li>When <code>Type::Unknown</code>&#x27;s metaclass becomes <code>Type::Todo</code>, this does not work anymore</li>
</ul>
<p>I fixed this by introducing an explicit handling of <code>Unknown</code> (and we might need one for <code>Any</code> as well, but I didn&#x27;t find a way to reliably create an <code>Any</code> var to test it)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/Slyces">@Slyces</a> on 2024-09-29 15:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-09-29 15:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:514 on 2024-09-29 15:49</div>
            <div class="timeline-body"><pre><code>            Type::BooleanLiteral(_) =&gt; Type::Todo,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/Slyces">@Slyces</a> on 2024-09-29 15:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1281 on 2024-09-29 16:27</div>
            <div class="timeline-body"><p>I think having all three of these would lead to very noisy tracing output. We should be able to easily figure out the inferred type of a <code>for</code> loop variable using <code>reveal_type</code>, so I&#x27;m not sure we really need any of them for debugging issues from users; I think I&#x27;d remove all three</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1611 on 2024-09-29 16:27</div>
            <div class="timeline-body"><p>not sure we need this in the default tracing output</p>
<pre><code></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2242 on 2024-09-29 16:30</div>
            <div class="timeline-body"><p>the comment here is useful, but I think these cases here are fully covered by the branch immediately following this; I don&#x27;t think you need to add any code to this method. All tests pass if I make this change:</p>
<pre><code>            // When interacting with Todo, Any and Unknown should propagate (as if we fix this
            // `Todo` in the future, the result would then become Any or Unknown, respectively.)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-09-29 16:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Slyces">@Slyces</a> reviewed on 2024-09-29 16:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Slyces">@Slyces</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1611 on 2024-09-29 16:34</div>
            <div class="timeline-body"><p>That was temporary code that I missed removing</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Slyces">@Slyces</a> reviewed on 2024-09-29 16:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Slyces">@Slyces</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1281 on 2024-09-29 16:58</div>
            <div class="timeline-body"><p>Sorry! That was also a temporary code I used to isolate the bug - not meant to be commited!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-09-29 16:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:666 on 2024-09-29 16:59</div>
            <div class="timeline-body"><pre><code></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-09-29 17:02</div>
            <div class="timeline-body"><p>LGTM! I&#x27;ll wait before merging in case Micha or Carl have any concerns, though.</p>
<p>Possibly we could change the variant so that it is instead <code>Type::Todo(&amp;&#x27;static str)</code> -- and we could store the <code>TODO</code> message in the variant itself, including it as part of the variant&#x27;s display. That would mean we wouldn&#x27;t have to have a separate <code>// TODO</code> comment for every time where we use this variant. However, I think that that could/should be implemented as a followup, since it adds more complexity to the current code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-09-30 11:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:254 on 2024-09-30 20:47</div>
            <div class="timeline-body"><p>I&#x27;d use a simpler wording here. The exact interaction with Any or Unknown depends on the specific case.</p>
<pre><code>    /// output to be unknown. An output should only be `Todo` if fixing all `Todo` inputs to be not `Todo` would change the output type.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:248 on 2024-09-30 20:48</div>
            <div class="timeline-body"><p>This is an important clarification:</p>
<pre><code>    /// Temporary type for symbols that can&#x27;t be inferred yet because of missing implementations. Behaves equivalently to `Any`.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:582 on 2024-09-30 20:49</div>
            <div class="timeline-body"><p>This could go up above in the same case with <code>Any</code>, <code>Unknown</code>, etc.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:636 on 2024-09-30 20:50</div>
            <div class="timeline-body"><p>Let&#x27;s move this up next to the similar <code>Any</code> and <code>Unknown</code> cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:729 on 2024-09-30 20:53</div>
            <div class="timeline-body"><p>Again, I&#x27;d prefer if we keep <code>Todo</code> close to <code>Any</code> and <code>Unknown</code> cases in matches, since they are closely related.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/builder.rs</code>:228 on 2024-09-30 20:56</div>
            <div class="timeline-body"><p>The correct behavior is for Todo to not cancel itself in an intersection, same as Any and Unknown.</p>
<p>I would not add this comment, here or in <code>add_negative</code>; rather, we have an existing TODO comment in <code>add_negative</code> to stop self-cancelling Any and Unknown; let&#x27;s just mention Todo in that comment also (and maybe add the same comment here in <code>add_positive</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-09-30 20:58</div>
            <div class="timeline-body"><p>This is great, thank you!! I think this will really improve debuggability. Just a few small nits before we merge.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/carljm">@carljm</a> on 2024-09-30 21:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2024-09-30 21:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-09-30 21:30</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:07:03 UTC
    </footer>
</body>
</html>
