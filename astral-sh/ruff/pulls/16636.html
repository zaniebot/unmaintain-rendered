<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Improve is_disjoint for two intersections - astral-sh/ruff #16636</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Improve is_disjoint for two intersections</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16636">#16636</a>
        opened by <a href="https://github.com/jgeralnik">@jgeralnik</a>
        on 2025-03-11 16:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jgeralnik">@jgeralnik</a></div>
            <div class="timeline-body">Summary
<p>Background - as a follow up to #16611 I noticed that there&#x27;s a lot of code duplicated between the <code>is_assignable_to</code> and <code>is_subtype_of</code> functions and considered trying to merge them.</p>
<p><a href="https://typing.python.org/en/latest/spec/concepts.html#the-assignable-to-or-consistent-subtyping-relation">A subtype and an assignable type are pretty much the same</a>, except that subtypes are by definition fully static, so I think we can replace the whole of <code>is_subtype_of</code> with:</p>
<pre><code>if !self.is_fully_static(db) || !target.is_fully_static(db) {
    return false;
}
return self.is_assignable_to(target)
</code></pre>
<p>if we move all of the logic to is_assignable_to and delete duplicate code. Then we can discuss if it even makes sense to have a separate is_subtype_of function (I think the answer is yes since it&#x27;s used by a bunch of other places, but we may be able to basically rip out the concept).</p>
<p>Anyways while playing with combining the functions I noticed is that the handling of Intersections in <code>is_subtype_of</code> has a special case for two intersections, which I didn&#x27;t include in the last PR - rather I first handled right hand intersections before left hand, which should properly handle double intersections (hand-wavy explanation I can justify if needed - (A &amp; B &amp; C) is assignable to (A &amp; B) because the left is assignable to both A and B, but none of A, B, or C is assignable to (A &amp; B)).</p>
<p>I took a look at what breaks if I remove the handling for double intersections, and the reason it is needed is because is_disjoint does not properly handle intersections with negative conditions (so instead <code>is_subtype_of</code> basically implements the check correctly).</p>
<p>This PR adds support to is_disjoint for properly checking negative branches, which also lets us simplify <code>is_subtype_of</code>, bringing it in line with <code>is_assignable_to</code></p>
Test Plan
<p>Added a bunch of tests, most of which failed before this fix</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/jgeralnik">@jgeralnik</a> on 2025-03-11 16:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/jgeralnik">@jgeralnik</a> on 2025-03-11 16:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/jgeralnik">@jgeralnik</a> on 2025-03-11 16:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/jgeralnik">@jgeralnik</a> on 2025-03-11 16:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-11 16:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Improve is_disjoint for two intersections&quot; to &quot;[red-knot] Improve is_disjoint for two intersections&quot; by <a href="https://github.com/jgeralnik">@jgeralnik</a> on 2025-03-11 16:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-11 16:48</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jgeralnik">@jgeralnik</a> on 2025-03-11 17:04</div>
            <div class="timeline-body"><p>~~This doesn&#x27;t work with gradual types :(~~</p>
<p>~~This assert will fail with the current implementation:~~</p>
<p>~~<code>static_assert(not is_disjoint_from(Any, Not[X]))</code>~~</p>
<p>~~Will think it over, in the meanwhile this PR can be marked as a draft~~</p>
<p>(Never mind, it works perfectly fine - I made a mistake running the test)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/jgeralnik">@jgeralnik</a> on 2025-03-11 17:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/jgeralnik">@jgeralnik</a> on 2025-03-11 17:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_disjoint_from.md</code>:134 on 2025-03-11 20:36</div>
            <div class="timeline-body"><p>This is only true for fully-static types, since if we have dynamic types involved, <code>Any</code> on each side can represent an arbitrarily different type. In the simplest case, <code>Any</code> is not disjoint from <code>Not[Any]</code>: <code>Not[Any]</code> is indistinguishable from <code>Any</code>, and clearly <code>Any</code> is not disjoint from <code>Any</code>. Maybe we should add some more tests for this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:984 on 2025-03-11 20:39</div>
            <div class="timeline-body"><p>I think using <code>is_assignable_to</code> here is not right, but using <code>is_subtype_of</code> might be right? (See my comment above that <code>Any</code> and <code>Not[Any]</code> are not disjoint.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-03-11 20:47</div>
            <div class="timeline-body"><p>Thank you!</p>
<p>So something I failed to mention (or remember to do myself) on your previous PR: we have a set of quickcheck property tests, which check a bunch of invariants that should apply to type relations, using randomly-generated types. These don&#x27;t run in CI (because they are inherently slow and non-deterministic), but they can be very helpful in catching gaps in our understanding of type relations. To run them, I use <code>QUICKCHECK_TESTS=100000 cargo test -p red_knot_python_semantic -- --ignored types::property_tests::stable</code>. (You can adjust the <code>QUICKCHECK_TESTS</code> number to tradeoff test running time with confidence that any failure cases should be caught.)</p>
<p>Your previous PR actually broke a couple of these (<code>all_type_pairs_are_assignable_to_their_union</code> and <code>subtype_of_implies_assignable_to</code>), but this PR seems to fix those! This PR, however, does break <code>disjoint_from_is_irreflexive</code> and <code>disjoint_from_is_symmetric</code>:</p>
<pre><code>---- types::property_tests::stable::disjoint_from_is_irreflexive stdout ----

thread &#x27;types::property_tests::stable::disjoint_from_is_irreflexive&#x27; panicked at /Users/carlmeyer/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/quickcheck-1.0.3/src/tester.rs:165:28:
[quickcheck] TEST FAILED. Arguments: (Intersection { pos: [], neg: [Union([BuiltinClassLiteral(&quot;bool&quot;), KnownClassInstance(TypeAliasType)])] })
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace

---- types::property_tests::stable::disjoint_from_is_symmetric stdout ----

thread &#x27;types::property_tests::stable::disjoint_from_is_symmetric&#x27; panicked at /Users/carlmeyer/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/quickcheck-1.0.3/src/tester.rs:165:28:
[quickcheck] TEST FAILED. Arguments: (Intersection { pos: [], neg: [KnownClassInstance(NoDefaultType)] }, Intersection { pos: [LiteralString], neg: [KnownClassInstance(TypeAliasType)] })
</code></pre>
<p>Also, we have some parallel work going on here accidentally, another contributor just submitted <a href="https://github.com/astral-sh/ruff/pull/16641">astral-sh/ruff#16641</a>, which also fixes the two property tests currently failing on main, and stabilizes a couple other property tests that are currently flaky. It looks like there is some overlap between that PR and this one, but that one does some additional stuff around understanding literal integer and string types and their relationship to <code>AlwaysTruthy</code> and <code>AlwaysFalsy</code>.</p>
<p>Ultimately I&#x27;ll merge whichever of these reaches &quot;all green&quot; (including all stable property tests) first (and passes review otherwise), and the other one can rebase on top and add whatever is left.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:608 on 2025-03-11 20:49</div>
            <div class="timeline-body"><p>Pretty cool that this whole case can be eliminated by improving <code>is_disjoint_from</code>! Really nice find.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-03-11 20:53</div>
            <div class="timeline-body"><blockquote>
<p>I think we can replace the whole of <code>is_subtype_of</code></p>
</blockquote>
<p>Yes, I think that should be true. The main question would be whether this has any negative impact on performance, since <code>is_subtype_of</code> is used heavily in union type simplification. (It is valid to elide type A from <code>A | B</code> if <code>A</code> is a subtype of <code>B</code>, but not if <code>A</code> is just assignable to <code>B</code>; the latter would wrongly simplify every <code>Any | T</code> to just <code>Any</code> (or just <code>T</code>! It would be arbitrary which one; the non-transitivity of <code>is_assignable_to</code> with dynamic types is a problem here.) I suspect maybe there won&#x27;t be any performance issue, though, it&#x27;s certainly worth trying.</p>
<p>I don&#x27;t think we can (or should) eliminate the <em>concept</em> of <code>is_subtype_of</code>; I think it is necessary to have the concept (and the method). But totally open to simplifying the <em>implementation</em> if we can do that without behavior or performance regression.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jgeralnik">@jgeralnik</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_disjoint_from.md</code>:134 on 2025-03-11 21:17</div>
            <div class="timeline-body"><p>Yeah I suspected in the comment I left above that Any was broken but then I couldn&#x27;t construct a case to assert it. Found one now that I&#x27;ll add, and replacing is_assignable_to with is_subtype_of fixes it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jgeralnik">@jgeralnik</a> reviewed on 2025-03-11 21:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jgeralnik">@jgeralnik</a> reviewed on 2025-03-11 22:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jgeralnik">@jgeralnik</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_disjoint_from.md</code>:134 on 2025-03-11 22:41</div>
            <div class="timeline-body"><p>is_subtype_of is also not a clean fix - regardless of which direction I choose one of these tests fails:</p>
<pre><code>static_assert(not is_disjoint_from(Intersection[Any, X], Intersection[Any, Not[Y]]))
static_assert(not is_disjoint_from(Intersection[Any, Not[Y]], Intersection[Any, X]))

static_assert(is_disjoint_from(Intersection[int, Any], Not[int]))
static_assert(is_disjoint_from(Not[int], Intersection[int, Any]))
</code></pre>
<p>Need to think about this some more tomorrow</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jgeralnik">@jgeralnik</a> on 2025-03-11 22:48</div>
            <div class="timeline-body"><p>Need to think this over a bit more, will keep an eye on the other PR and just add my nasty test cases to it if it succeeds before me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jgeralnik">@jgeralnik</a> on 2025-03-12 10:06</div>
            <div class="timeline-body"><p>I came up with two solutions for this, both of which work and pass all quickcheck tests, but I&#x27;m not necessarily satisified with either. Both cases require special handling of two intersections in <code>is_disjoint</code>:</p>
<p>Option 1:</p>
<pre><code>            (Type::Intersection(self_intersection), Type::Intersection(other_intersection)) =&gt; {
                self_intersection.
                self_intersection
                    .positive(db)
                    .iter()
                    .any(|p| p.is_disjoint_from(db, other))
                    || other_intersection
                        .positive(db)
                        .iter()
                        .any(|p: &amp;Type&lt;&#x27;_&gt;| p.is_disjoint_from(db, self))
        }
</code></pre>
<p>I&#x27;m pretty sure we can&#x27;t have disjoint intersections with only negative elements - a negative element needs a positive element on the other side in order to become disjoint. This does rely on the builder simplifying things - obviously <code>Not[Not]</code>s, but also replacing <code>Not[Any]</code> with <code>Any</code>. This matches the logic that happens in the builder today, where new elements are only compared (with is_disjoint) to other positive elements to check if the resulting intersection is empty.</p>
<p>The other option is to go all in on relying on the builder - to test if two intersections are disjoint we can just combine them into a single intersection and see if the result is never:</p>
<pre><code>            (Type::Intersection(_), Type::Intersection(_)) =&gt; {
                IntersectionBuilder::new(db)
                    .add_positive(self)
                    .add_positive(other)
                    .build()
                    .is_never()
            }
</code></pre>
<p>This feels more clever, but is much less efficient - IntersectionBuilder will add items one by one and check them against all current items so is actually O(n**2), and the fact that <code>IntersectionBuilder</code> and <code>is_disjoint</code> both call into each other makes me squeamish even if it is probably ok since is_disjoint is always called there with a single element.</p>
<p>The first options is actually also O(n**2), but probably we won&#x27;t have ever intersections with more than a couple dozen elements?</p>
<p>I feel like option 1 is the better choice, will update code shortly</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_disjoint_from.md</code>:156 on 2025-03-12 11:23</div>
            <div class="timeline-body"><p>Is this just a leftover comment that should be removed? I&#x27;m not seeing any failing quickcheck tests on the current version of the PR, and when I add this example as an mdtest, it passes (in both permutations). (It looks like the tests immediately above here are the same scenario, just using <code>int</code> in place of <code>abc.ABC</code>.)</p>
<pre><code></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-03-12 11:40</div>
            <div class="timeline-body"><p>Great work! I&#x27;m seeing all stable quickcheck tests passing, even at a million runs.</p>
<p>This PR is the best kind of PR: net negative non-test LOC and improves correctness.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-03-12 11:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_disjoint_from.md</code>:156 on 2025-03-12 11:41</div>
            <div class="timeline-body"><p>Going to go ahead and remove this comment, then merge the PR. Let me know if I&#x27;ve missed something that was still TODO represented by this comment!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jgeralnik">@jgeralnik</a> reviewed on 2025-03-12 12:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jgeralnik">@jgeralnik</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_disjoint_from.md</code>:156 on 2025-03-12 12:04</div>
            <div class="timeline-body"><p>Oh yeah, whoops. Was left over from debugging of quickcheck failures.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/carljm">@carljm</a> on 2025-03-12 12:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2025-03-12 12:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-03-14 17:56</div>
            <div class="timeline-body"><p>This is very elegantly done. Nice work!!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:12:12 UTC
    </footer>
</body>
</html>
