```yaml
number: 4724
title: Generate FormatRule definitions
type: pull_request
state: merged
author: konstin
labels:
  - internal
  - formatter
assignees: []
merged: true
base: main
head: generate_definitions
created_at: 2023-05-30T12:53:40Z
updated_at: 2023-06-01T06:38:55Z
url: https://github.com/astral-sh/ruff/pull/4724
synced_at: 2026-01-12T15:55:16Z
```

# Generate FormatRule definitions

---

_@konstin_

This is a first stab at generating a newtype for each AST node with implementations of `FormatNodeRule`, `FormatRule`, `AsFormat` and `IntoFormat` on it to circumvent the orphan rules, copying the strategy from rome. See Docs.md for more details.

This replaces the associated type `Context` from `FormatRule` with a type parameter because our context is `ASTFormatContext` which has a lifetime. Handling lifetimes is a lot easier with type parameter than with associated types.

This is ready in the sense that the definitions are generated and compile without warnings, but we don't yet have any downstream code (and its tests) building on it to validate the approach.


---

_Comment by @konstin on 2023-05-30 12:53_

Current dependencies on/for this PR:
* main
  * **PR #4724** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4724" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #4755** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4755" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #4767** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4767" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/charliermarsh/ruff/4724?utm_source=stack-comment).

---

_Review requested from @MichaReiser by @MichaReiser on 2023-05-30 12:54_

---

_Review comment by @MichaReiser on `crates/ruff_formatter/src/lib.rs`:522 on 2023-05-30 12:55_

Nit: I think it is worth adding a note to the PR summary why we change from an associated type to a type argument.

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/generate.py`:3 on 2023-05-30 12:56_

Are the `%%` some python convention?

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/auxiliary/excepthandlerexcepthandler.rs`:8 on 2023-05-30 12:57_

Nit: I think it would be nice if the format rules would be grouped by their kind. E.g. `StmtIf` is in the `statement` directory.

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/auxiliary/exprconstant.rs`:9 on 2023-05-30 12:58_

Using the fields (by e.g. using `format_verbatim`) will generate a large diff. I do think that's fine, but thought it worth pointing it out.

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/auxiliary/stmtif.rs`:8 on 2023-05-30 12:59_

For another PR: We need `FormatRule` implementations for all union types (`Stmt`, `Expr`, ...). 

They don't need to implement `FormatNodeRule` because they are not a node on their own. 

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/lib.rs`:72 on 2023-05-30 13:00_

I don't think we need parentheses handling

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/lib.rs`:77 on 2023-05-30 13:00_

Let's add this when adding support for suppression comments.

---

_@MichaReiser approved on 2023-05-30 13:00_

This looks good overall. I think it would be great if we could split the nodes by their kind.

---

_Review comment by @konstin on `crates/ruff_python_formatter/generate.py`:3 on 2023-05-30 13:22_

they are from ipython, pycharm recognizes them if you turn on scientific mode. I normally remove them when polishing but for that script i don't think it's ready

---

_@konstin reviewed on 2023-05-30 13:22_

---

_@konstin reviewed on 2023-05-30 13:25_

---

_Review comment by @konstin on `crates/ruff_formatter/src/lib.rs`:522 on 2023-05-30 13:25_

good point, done

---

_@MichaReiser reviewed on 2023-05-30 14:04_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/lib.rs`:74 on 2023-05-30 14:04_

Nit: Maybe return `Ok(())` for now so that it simply drops all comments for now (instead of throwing). 

---

_@konstin reviewed on 2023-05-30 14:39_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/auxiliary/excepthandlerexcepthandler.rs`:8 on 2023-05-30 14:39_

good idea

---

_Comment by @github-actions[bot] on 2023-05-30 15:19_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     15.1Â±0.07ms     2.7 MB/sec    1.05     15.8Â±0.10ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.7Â±0.00ms     4.5 MB/sec    1.03      3.8Â±0.01ms     4.4 MB/sec
linter/all-rules/numpy/globals.py          1.00    379.4Â±0.94Âµs     7.8 MB/sec    1.01    382.9Â±1.35Âµs     7.7 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.3Â±0.01ms     4.1 MB/sec    1.04      6.5Â±0.02ms     3.9 MB/sec
linter/default-rules/large/dataset.py      1.00      7.5Â±0.02ms     5.4 MB/sec    1.08      8.1Â±0.02ms     5.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1622.1Â±2.85Âµs    10.3 MB/sec    1.04   1687.3Â±5.62Âµs     9.9 MB/sec
linter/default-rules/numpy/globals.py      1.00    179.1Â±0.60Âµs    16.5 MB/sec    1.02    182.0Â±0.41Âµs    16.2 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.4Â±0.01ms     7.4 MB/sec    1.04      3.6Â±0.01ms     7.1 MB/sec
parser/large/dataset.py                    1.00      5.7Â±0.01ms     7.1 MB/sec    1.01      5.8Â±0.00ms     7.1 MB/sec
parser/numpy/ctypeslib.py                  1.00   1121.9Â±0.96Âµs    14.8 MB/sec    1.01   1129.8Â±0.63Âµs    14.7 MB/sec
parser/numpy/globals.py                    1.00    115.2Â±0.95Âµs    25.6 MB/sec    1.02    117.2Â±0.44Âµs    25.2 MB/sec
parser/pydantic/types.py                   1.00      2.4Â±0.00ms    10.4 MB/sec    1.01      2.5Â±0.00ms    10.3 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     22.1Â±0.75ms  1887.9 KB/sec    1.01     22.4Â±0.73ms  1862.4 KB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      5.5Â±0.41ms     3.0 MB/sec    1.02      5.6Â±0.48ms     3.0 MB/sec
linter/all-rules/numpy/globals.py          1.00   650.6Â±34.85Âµs     4.5 MB/sec    1.00   651.0Â±34.71Âµs     4.5 MB/sec
linter/all-rules/pydantic/types.py         1.00      9.2Â±0.37ms     2.8 MB/sec    1.01      9.3Â±0.37ms     2.7 MB/sec
linter/default-rules/large/dataset.py      1.00     10.8Â±0.42ms     3.8 MB/sec    1.02     11.0Â±0.33ms     3.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00      2.3Â±0.11ms     7.2 MB/sec    1.01      2.3Â±0.11ms     7.1 MB/sec
linter/default-rules/numpy/globals.py      1.00   262.5Â±15.42Âµs    11.2 MB/sec    1.05   276.5Â±14.70Âµs    10.7 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.8Â±0.20ms     5.3 MB/sec    1.03      5.0Â±0.24ms     5.1 MB/sec
parser/large/dataset.py                    1.00      8.4Â±0.27ms     4.8 MB/sec    1.00      8.4Â±0.25ms     4.8 MB/sec
parser/numpy/ctypeslib.py                  1.00  1560.0Â±67.10Âµs    10.7 MB/sec    1.01  1576.8Â±68.34Âµs    10.6 MB/sec
parser/numpy/globals.py                    1.01   163.6Â±10.41Âµs    18.0 MB/sec    1.00   161.8Â±10.58Âµs    18.2 MB/sec
parser/pydantic/types.py                   1.00      3.6Â±0.13ms     7.2 MB/sec    1.02      3.6Â±0.13ms     7.0 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_@MichaReiser reviewed on 2023-05-30 16:13_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/auxiliary/mod.rs`:1 on 2023-05-30 16:13_

What's your motivation for putting all formatting logic into the `auxiliary` module?

---

_@konstin reviewed on 2023-05-30 16:38_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/auxiliary/mod.rs`:1 on 2023-05-30 16:38_

no specific one, should i unpack the auxiliary module at the top level instead?

---

_@MichaReiser reviewed on 2023-05-30 16:54_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/auxiliary/mod.rs`:1 on 2023-05-30 16:54_

I would be in favour of removing, or renaming the folder to format if you prefer to have all of them in a single folder (I'm okay with manually adding the group modules to lib)

---

_@MichaReiser reviewed on 2023-05-30 19:25_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/auxiliary/statement/stmtimport.rs`:1 on 2023-05-30 19:25_

Nit: Can we name the module `stmt_if` to match the node name? It can otherwise be hard to read some of the names (`typeignoretypeignore`)

---

_Label `internal` added by @MichaReiser on 2023-05-31 11:15_

---

_Label `autoformatter` added by @MichaReiser on 2023-05-31 11:15_

---

_@konstin reviewed on 2023-05-31 12:19_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/auxiliary/mod.rs`:1 on 2023-05-31 12:19_

done

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/auxiliary/statement/stmtimport.rs`:1 on 2023-05-31 12:19_

done

---

_@konstin reviewed on 2023-05-31 12:19_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/context.rs`:32 on 2023-05-31 13:06_

Revert?

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_attribute.rs`:22 on 2023-05-31 13:09_

I would prefer to generate a `todo!` for now and then follow up in two separate PRs (or change the order in which you land the PRs). 

* Create a new `verbatim_text` builder that formats some text in verbatim: `fn verbatim_node(range: TextRange) -> VerbatimText` and `VerbatimText` implements `Format`
* Use the `verbatim_node` helper in the `FormatNodeRule` implementations

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_attribute.rs`:12 on 2023-05-31 13:09_

We should write the `source_position`s inside of `FormatNodeRule`

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/lib.rs`:57 on 2023-05-31 13:10_

Let's delete the unused code
```suggestion
        self.fmt_fields(node, f)?;
```

We can probably even inline the method into `fmt`

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/lib.rs`:42 on 2023-05-31 13:11_

Let's write the start and end position here
```suggestion
		write!(f, [source_position(node.start())])?;
        self.fmt_leading_comments(node, f)?;
        self.fmt_node(node, f)?;
        self.fmt_dangling_comments(node, f)?;
        self.fmt_trailing_comments(node, f)?;
        write!(f, [source_position(node.start())])
```

---

_@MichaReiser reviewed on 2023-05-31 13:11_

---

_@MichaReiser reviewed on 2023-05-31 13:12_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_attribute.rs`:22 on 2023-05-31 13:12_

We can leave it as is for now, but hiding this implementation behind a builder would be good (builder's exist to increase code-reuse)

---

_@konstin reviewed on 2023-05-31 13:14_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/context.rs`:32 on 2023-05-31 13:14_

the are unused so clippy complains. `#[allow(unused)]` would be an alternative

---

_@MichaReiser reviewed on 2023-05-31 13:22_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/context.rs`:32 on 2023-05-31 13:22_

You can make `format_range` `pub` :D (it should really be `pub`)

---

_@konstin reviewed on 2023-05-31 13:56_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/context.rs`:32 on 2023-05-31 13:56_

i don't see any `format_range` function, i now switched to `#[allow(unused)]`

---

_@MichaReiser reviewed on 2023-05-31 15:35_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/lib.rs`:57 on 2023-05-31 15:35_

Nit: This link won't work. You can point to the `crate::comments` instead
```suggestion
    /// Formats the [leading comments](crate::comments#leading-comments) of the node.
```

---

_@MichaReiser approved on 2023-06-01 05:44_

Let's merge this :)

---

_Merged by @konstin on 2023-06-01 06:38_

---

_Closed by @konstin on 2023-06-01 06:38_

---

_Branch deleted on 2023-06-01 06:38_

---
