<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-bugbear`]: Implement rule `B031` - astral-sh/ruff #3680</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-bugbear</code>]: Implement rule <code>B031</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/3680">#3680</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2023-03-23 09:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-03-23 09:07</div>
            <div class="timeline-body"><p>Implement rule <code>B031</code> for <code>flake8-bugbear</code>:</p>
<blockquote>
<p>Using the generator returned from <code>itertools.groupby()</code> more than once will do nothing on the second usage. Save the result to a list if the result is needed multiple times.</p>
</blockquote>
<p>resolves: #2954</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_bugbear/rules/reuse_of_groupby_generator.rs</code>:132 on 2023-03-23 09:23</div>
            <div class="timeline-body"><p>Do we need similar handling to <code>for</code> loops for other loops (while, list comprehension...)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_bugbear/rules/reuse_of_groupby_generator.rs</code>:85 on 2023-03-23 09:28</div>
            <div class="timeline-body"><p>Not sure how to handle it but this analysis will yield false-positives if <code>id</code> is re-bound`. For example, because a new value is assigned, the visitor enters a function that has an argument with the same name, etc.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-03-23 09:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-03-23 09:34</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>✅ ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.01     14.3±0.05ms     2.8 MB/sec    1.00     14.1±0.05ms     2.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.8±0.01ms     4.4 MB/sec    1.00      3.8±0.01ms     4.4 MB/sec
linter/all-rules/numpy/globals.py          1.01    439.3±1.23µs     6.7 MB/sec    1.00    435.9±2.84µs     6.8 MB/sec
linter/all-rules/pydantic/types.py         1.01      6.4±0.02ms     4.0 MB/sec    1.00      6.3±0.01ms     4.1 MB/sec
linter/default-rules/large/dataset.py      1.02      7.9±0.01ms     5.2 MB/sec    1.00      7.7±0.01ms     5.3 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.02   1713.9±3.13µs     9.7 MB/sec    1.00   1675.8±2.93µs     9.9 MB/sec
linter/default-rules/numpy/globals.py      1.01    176.0±0.31µs    16.8 MB/sec    1.00    174.8±0.37µs    16.9 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.7±0.01ms     7.0 MB/sec    1.00      3.6±0.00ms     7.0 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     15.2±0.20ms     2.7 MB/sec    1.01     15.4±1.16ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.1±0.02ms     4.0 MB/sec    1.00      4.1±0.05ms     4.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    458.9±8.68µs     6.4 MB/sec    1.00    457.3±8.46µs     6.5 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.7±0.12ms     3.8 MB/sec    1.00      6.8±0.14ms     3.8 MB/sec
linter/default-rules/large/dataset.py      1.00      8.3±0.12ms     4.9 MB/sec    1.00      8.3±0.06ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1770.7±17.35µs     9.4 MB/sec    1.00  1763.0±22.67µs     9.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    181.6±1.21µs    16.3 MB/sec    1.01    183.8±4.10µs    16.1 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.9±0.06ms     6.6 MB/sec    1.01      3.9±0.09ms     6.6 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-03-23 09:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/rules/flake8_bugbear/rules/reuse_of_groupby_generator.rs</code>:132 on 2023-03-23 09:54</div>
            <div class="timeline-body"><p>Good point!</p>
<p>Right now the implementation is mainly based on the original one. But yes, I think we should also include it for other loop constructs: <code>while</code>, comprehensions.</p>
<pre><code class="language-python"># using list comprehension
for k, g in it.groupby(a):
    val = [list(g) for _ in range(3)]
    print(val)

# using `while` loop
for k, g in it.groupby(a):
    i = 3
    while i &gt; 0:
        print(list(g))
        i -= 1
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-03-23 09:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/rules/flake8_bugbear/rules/reuse_of_groupby_generator.rs</code>:85 on 2023-03-23 09:58</div>
            <div class="timeline-body"><p>Right! Variable re-assignment inside the loop might yield false-positives. From the top of my mind, I'm thinking of skipping the checks during the scope of the variable assignment. I'm not sure about the scope determination part but something along the lines of <code>self.nested</code> should work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-03-23 09:58</div>
            <div class="timeline-body"><p>@MichaReiser Thanks for the review! I'll look at your points and the ecosystem checks later in the evening.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/rules/flake8_bugbear/rules/reuse_of_groupby_generator.rs</code>:132 on 2023-03-23 10:32</div>
            <div class="timeline-body"><p>I just thought of a case where it would give false negative - when using multiple <em>separate</em> nested loops looping over the <em>same</em> group:</p>
<pre><code class="language-python">for name, group in itertools.groupby(data):
	for item in group:
		pass

	for item in group:
		pass
</code></pre>
<p>The reason it will give false negative, and this is after the latest <a href="https://github.com/charliermarsh/ruff/pull/3680/commits/8955e3c9828d4bf89a2a30f0ec257340923c525f">fix commit</a>, the implementation skips checking the <code>iter</code> and <code>target</code> node of the <code>for</code> loop and goes directly to the <code>body</code>. This will need to be handled as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-03-23 10:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-03-23 10:39</div>
            <div class="timeline-body"><p>These ecosystem checks are really helpful! Thank you to whoever implemented them! ❤️</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2023-03-23 14:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-03-23 19:07</div>
            <div class="timeline-body"><p>LGTM, I'll let @MichaReiser approve and merge.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-24 21:26</div>
            <div class="timeline-body"><p>(Gonna merge to keep things chugging along, but @MichaReiser let me know if you have any follow-ups.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-03-24 21:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-03-24 21:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @charliermarsh on 2023-03-24 21:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-03-25 01:48</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 04:41:48 UTC
    </footer>
</body>
</html>
