<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Infer unary not operation for instances - astral-sh/ruff #13827</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Infer unary not operation for instances</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13827">#13827</a>
        opened by <a href="https://github.com/Glyphack">@Glyphack</a>
        on 2024-10-19 21:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Glyphack">@Glyphack</a></div>
            <div class="timeline-body"><p>My attempt at resolving not op for instances.</p>
<p>The type is true unless one of the following happens:</p>
<ol>
<li>We call the <code>__bool__</code> and if it is false then the result is false.</li>
</ol>
<h2>Test Plan</h2>
<p>I added a new test case with some examples from these resources:</p>
<ul>
<li>https://docs.python.org/3/library/stdtypes.html#truth-value-testing</li>
<li><a href="https://docs.python.org/3/reference/datamodel.html#object.__len__">https://docs.python.org/3/reference/datamodel.html#object.__len__</a></li>
<li><a href="https://docs.python.org/3/reference/datamodel.html#object.__bool__">https://docs.python.org/3/reference/datamodel.html#object.__bool__</a></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] WIP Handle class and instance cases for bool value" to "[red-knot] Handle class and instance cases for bool value" by @Glyphack on 2024-10-20 13:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-10-20 13:19</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Glyphack">@Glyphack</a> reviewed on 2024-10-20 13:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Glyphack">@Glyphack</a> on <code>crates/red_knot_python_semantic/resources/mdtest/unary/instance.md</code>:62 on 2024-10-20 13:23</div>
            <div class="timeline-body"><p>Because everything is considered to be True in conditions unless specified by the <strong>bool</strong> or <strong>len</strong> method this will be false. The previous behavior was to say this is <code>bool</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Glyphack">@Glyphack</a> reviewed on 2024-10-20 13:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Glyphack">@Glyphack</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2837 on 2024-10-20 13:23</div>
            <div class="timeline-body"><p>Moving this code to https://github.com/astral-sh/ruff/pull/13827/files#diff-42314c006689490bbdfbeeb973de64046b3e069e3d88f67520aeba375f20e655R757 will cause stack overflow.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Handle class and instance cases for bool value" to "[red-knot] Infer bool for class literal and instances" by @Glyphack on 2024-11-09 18:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Glyphack">@Glyphack</a> reviewed on 2024-11-10 17:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Glyphack">@Glyphack</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2838 on 2024-11-10 17:43</div>
            <div class="timeline-body"><p>Should I refactor the bool method so we can call <code>return_ty_result</code> there and move this piece of code there?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Infer bool for class literal and instances" to "[red-knot] Infer bool for instances" by @Glyphack on 2024-11-10 18:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Glyphack">@Glyphack</a> reviewed on 2024-11-10 18:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Glyphack">@Glyphack</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2862 on 2024-11-10 18:30</div>
            <div class="timeline-body"><p>same as https://pyright-play.net/?code=GYJw9gtgBALgngBwJYDsDmUkQWEMoAySMApiAIYA2AUNQMaXkDOTUAggFzVQ9QAmJYFAD6wgEZgwlUQAomJSsACUAWgB8mFDC69dUECRgBXECigAGWgYBuJKsPgISMlGHxsZSpUA</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Glyphack">@Glyphack</a> reviewed on 2024-11-10 18:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Glyphack">@Glyphack</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2899 on 2024-11-10 18:32</div>
            <div class="timeline-body"><p>Pyright is okay with this:
https://pyright-play.net/?code=GYJw9gtgBALgngBwJYDsDmUkQWEMoAySMApiAIYA2AUNQMaXkDOTUAggFzVQ9QAmJYFAD6wyiRSiAFExKVgASgC0APijBKYcjC689UECRgBXECigAGAHQXahgG4kqw%2BAhJSUYfGykKFQA</p>
<p>But python itself is not:</p>
<pre><code>    not A()
TypeError: 'float' object cannot be interpreted as an integer
</code></pre>
<p>So I decided to add this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Infer bool for instances" to "[red-knot] Infer unary not operation for instances" by @Glyphack on 2024-11-10 18:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2024-11-11 12:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/red_knot_python_semantic/resources/mdtest/unary/instance.md</code>:114 on 2024-11-11 12:34</div>
            <div class="timeline-body"><p>Consider adding these two weird testcases:</p>
<pre><code class="language-python">class LenReturnsTrue:
	def __len__(self) -&gt; Literal[True]: ...

# revealed: Literal[False]
reveal_type(not LenReturnsTrue())
</code></pre>
<pre><code class="language-python">class LenReturnsFalse:
	def __len__(self) -&gt; Literal[False]: ...

# revealed: Literal[True]
reveal_type(not LenReturnsFalse())
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/unary/instance.md</code>:62 on 2024-11-11 18:24</div>
            <div class="timeline-body"><p>Because it is permitted for a subclass to add a <code>__bool__</code> method when the base class doesn't have one, and <code>Type::Instance</code> types include subclasses, we cannot safely rely on this behavior. (When we do find a <code>__bool__</code> method, we can rely on this because it would be an invalid override for a subclass to override <code>__bool__</code> with a return type that isn't a subtype of the base class' return type.)</p>
<p>So we need to infer <code>bool</code> here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/unary/instance.md</code>:77 on 2024-11-11 18:28</div>
            <div class="timeline-body"><p>Because a subclass could add a <code>__bool__</code> method, and the <code>__bool__</code> method takes priority over <code>__len__</code> for determining boolean value of an instance, I think we cannot conclude anything from the <code>__len__</code> method, and we need to just infer <code>bool</code> in both of these cases.</p>
<p>If a class has <code>__len__</code> but no <code>__bool__</code>, we cannot trust <code>__len__</code> because a subclass could add a <code>__bool__</code>, which would then take precedence. If a class has both <code>__bool__</code> and <code>__len__</code>, then <code>__len__</code> is always irrelevant, <code>__bool__</code> determines our answer.</p>
<p>I think this means we can (and must) totally ignore <code>__len__</code> when it comes to determining boolean value of a <code>Type::Instance</code>, which should simplify the implementation.</p>
<p>(I realize our TODO comment mentioned <code>__len__</code>, which just means we didn't think through this carefully enough when we wrote that comment :/ sorry that comment led to extra work.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/unary/instance.md</code>:96 on 2024-11-11 18:30</div>
            <div class="timeline-body"><p>This looks wrong. <code>__bool__</code> takes priority over <code>__len__</code>, and <code>WithBothLenAndBool2</code> has a <code>__bool__</code> returning <code>Literal[True]</code>, so this must be <code>Literal[False]</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/unary/instance.md</code>:100 on 2024-11-11 18:32</div>
            <div class="timeline-body"><p>Ideally I think we would raise a diagnostic <em>here</em> for the wrong return type for <code>__bool__</code>, so the error is caught at the class definition, rather than just in the usage. (Doesn't need to be done in this PR, but let's at least add a TODO comment here.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/unary/instance.md</code>:104 on 2024-11-11 18:33</div>
            <div class="timeline-body"><p>And I think here we don't need the diagnostic, we can just infer <code>bool</code> if the return type of <code>__bool__</code> isn't valid.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/unary/instance.md</code>:113 on 2024-11-11 18:33</div>
            <div class="timeline-body"><p>This test can probably just be eliminated, since as I mentioned above I don't think <code>__len__</code> can be considered at all.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/unary/instance.md</code>:114 on 2024-11-11 18:34</div>
            <div class="timeline-body"><p>These would be good test cases for another PR, but I don't think <code>__len__</code> can actually be considered at all as part of type inference for <code>not x</code>, as mentioned above</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1166 on 2024-11-11 18:34</div>
            <div class="timeline-body"><p>I don't see any need to make this change in this PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2838 on 2024-11-11 18:55</div>
            <div class="timeline-body"><p>I think with the adjustments the semantics that I outlined above in comments on the tests, this becomes much simpler and at least some of these problems disappear.</p>
<ol>
<li><p>We don't need to emit diagnostics here, because invalid <code>__bool__</code> and <code>__len__</code> methods should cause diagnostics in the class definition, not here.</p>
</li>
<li><p>I think this case doesn't even require any special logic for <code>Type::Instance</code> here; we should just call <code>.bool()</code> on the type and negate it.</p>
</li>
<li><p>Within <code>Type::bool</code>, in the case for <code>Type::Instance</code>, I think we should be able to do <code>instance_ty.call_dunder(&quot;__bool__&quot;)</code> and check the return value to see if it is <code>Literal[True]</code> or <code>Literal[False]</code> -- for anything else, we return <code>Truthiness::Ambiguous</code>.</p>
</li>
</ol>
<p>The only point I'm unsure of is the cycle you mentioned. It seems to me that once we simplify this code, the cycle should not be possible; <code>Type::call</code> only calls <code>Type::bool</code> if the thing being called is the <code>bool</code> builtin itself, and the <code>__bool__</code> method on a type should generally not be <code>builtins.bool</code>. It would be worth adding a test for the very weird edge case where someone does <code>__bool__ = bool</code> on a type; maybe we do need to add a special case to avoid panic here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2862 on 2024-11-11 18:56</div>
            <div class="timeline-body"><p>Yes, I see the pyright precedent, but I think pyright is wrong (or at least sub-optimal) in issuing this diagnostic at the call site rather than at the definition of the class.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2899 on 2024-11-11 18:58</div>
            <div class="timeline-body"><p>I agree that we should have this diagnostic, but I think it should not happen in this PR for two different reasons:</p>
<ol>
<li>I don't think this PR actually should involve <code>__len__</code> at all.</li>
<li>I think the diagnostic should be on the class definition, not at the usage site.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-11-11 18:59</div>
            <div class="timeline-body"><p>Thanks for working on this! Left a few comments. The good news is I think the comments should make the implementation much simpler.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Glyphack">@Glyphack</a> reviewed on 2024-11-13 16:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Glyphack">@Glyphack</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2838 on 2024-11-13 16:55</div>
            <div class="timeline-body"><p>With your suggestion the cycle is gone. I initially was calling <code>bool</code> on the return type of the <code>__bool__</code> and that was the reason of cycle but now I am checking the output for <code>Literal[False]</code> and <code>Literal[True]</code>.</p>
<p>The overflow happens for <code>__bool__ = bool</code> So I'm checking the result of <code>member</code>. Is it a huge problem if we call this twice? since call_dunder also calls this but I guessed it's better to check it in the bool function.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @Glyphack on 2024-11-13 22:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @Glyphack on 2024-11-13 22:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @Glyphack on 2024-11-13 22:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @Glyphack on 2024-11-13 22:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/unary/instance.md</code>:42 on 2024-11-13 22:34</div>
            <div class="timeline-body"><pre><code class="language-suggestion">
At runtime, the `__len__` method is a fallback for `__bool__`, but we can't make use of that.
If we have a class that defines `__len__` but not `__bool__`, it is possible that any subclass
could add a `__bool__` method that would invalidate whatever conclusion we drew from `__len__`.
So classes without a `__bool__` method, with or without `__len__`, must be inferred as unknown
truthiness.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/unary/instance.md</code>:59 on 2024-11-13 22:35</div>
            <div class="timeline-body"><pre><code class="language-suggestion">
# We don't get into a cycle if someone sets their `__bool__` method to the `bool` builtin:
class BoolIsBool:
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/unary/instance.md</code>:65 on 2024-11-13 22:36</div>
            <div class="timeline-body"><pre><code class="language-suggestion"># At runtime, no `__bool__` and no `__len__` means truthy, but we can't rely on that, because
# a subclass could add a `__bool__` method.
class NoBoolMethod: ...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/unary/instance.md</code>:70 on 2024-11-13 22:37</div>
            <div class="timeline-body"><pre><code class="language-suggestion"># And we can't rely on `__len__` for the same reason: a subclass could add `__bool__`.
class LenZero:
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1183 on 2024-11-13 22:40</div>
            <div class="timeline-body"><pre><code class="language-suggestion">                    // We only check the `__bool__` method for truth testing, even though at
                    // runtime there is a fallback to `__len__`, since `__bool__` takes precedence
                    // and a subclass could add a `__bool__` method.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1225 on 2024-11-13 22:45</div>
            <div class="timeline-body"><p>I wonder if we could do this inside <code>call_dunder</code> instead, so as to avoid the duplicated <code>to_meta_type...member</code> calls, which <code>call_dunder</code> will end up doing again.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-11-13 22:46</div>
            <div class="timeline-body"><p>Looks great, thank you!!</p>
<p>Only minor wording nits and one other comment; I'll just apply these and look into the <code>call_dunder</code> question briefly, and then land this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-11-13 23:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1225 on 2024-11-13 23:03</div>
            <div class="timeline-body"><p>After looking at it, I decided that's no better; this special case is a bit ugly no matter where it goes, and this is probably the best place for it.</p>
<p>I did rework the condition slightly to ensure that we really do have the <code>bool</code> built-in and not some random other class named <code>bool</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-11-13 23:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2838 on 2024-11-13 23:08</div>
            <div class="timeline-body"><p>Yes after looking at it, I think you're right that <code>Type::bool</code> is the best place to handle this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Glyphack">@Glyphack</a> on 2024-11-13 23:15</div>
            <div class="timeline-body"><p>Thanks for helping me why my initial approach was wrong. I will try to make it less work for you next time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-11-13 23:27</div>
            <div class="timeline-body"><blockquote>
<p>Thanks for helping me why my initial approach was wrong. I will try to make it less work for you next time.</p>
</blockquote>
<p>No problem, thank you for the contributions!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @carljm on 2024-11-13 23:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2024-11-13 23:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-11-13 23:38</div>
            <div class="timeline-body"><p>Also, to be clear, your initial approach was wrong mostly because we had a TODO comment in the source code specifically suggesting the wrong approach ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-13 23:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @carljm on 2024-11-14 05:44</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:07:05 UTC
    </footer>
</body>
</html>
