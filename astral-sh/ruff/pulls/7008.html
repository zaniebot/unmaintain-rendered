<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exclude pragma comments from measured line width - astral-sh/ruff #7008</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Exclude pragma comments from measured line width</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7008">#7008</a>
        opened by <a href="https://github.com/cnpryer">@cnpryer</a>
        on 2023-08-30 12:02
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cnpryer">@cnpryer</a></div>
            <div class="timeline-body"><p>Closes #6772</p>
Summary
<p>~~If the comment doesn&#x27;t include a NBSP and starts with <code>noqa</code>, <code>type:</code>, <code>pyright:</code>, or <code>pylint:</code> then we assign it <code>0</code> reserved width for its line suffix. Otherwise measure width.~~</p>
<p>See <a href="https://github.com/astral-sh/ruff/issues/6772">astral-sh/ruff#6772</a>#issuecomment-1699899884</p>
<p>This PR aligns with <code>ruff</code> linting behavior in that it will disregard the <em>kind</em> of white-space in order to identify pragmas to exclude from measured line width.</p>
Test Plan
<p>Current fixtures and new trailing comments fixtures.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/cnpryer">@cnpryer</a> on 2023-08-30 22:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/format.rs</code>:364 on 2023-08-31 06:37</div>
            <div class="timeline-body"><pre><code>        let reserved_width = if [&quot;noqa:&quot;, &quot;type:&quot;, &quot;pyright:&quot;, &quot;pylint:&quot;]
</code></pre>
<p>This logic also iterates over every string 4 times. We can do slightly better by using:</p>
<pre><code>let is_pragma = trimmed.split_once(&#x27;:&#x27;).is_some_and(|(maybe_pragma, _)| {
    matches!(maybe_pragma, &quot;noqa&quot; | &quot;type&quot; | &quot;pyright&quot; | &quot;pylint&quot;)
});
</code></pre>
<p>and rely on rust to generate an efficient string matching (e.g. skip if the pragma part is only 2 characters long)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-31 06:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-08-31 07:00</div>
            <div class="timeline-body"><p>Looking good. I&#x27;ve one small nit and would like to ask you to add a few pragma comment-specific tests that test the behavior outside of black&#x27;s test suite (you may want to include some of your interesting NBSP cases too!)</p>
<p><strong>This PR</strong></p>
<p>| project      | similarity index  | total files       | changed files     |
|--------------|------------------:|------------------:|------------------:|
| cpython      |           0.76079 |              1789 |              1634 |
| django       |           0.99948 |              2760 |                85 |
| transformers |           0.99925 |              2587 |               495 |
| <strong>twine</strong>        |           0.99982 |                33 |                 2 |
| <strong>typeshed</strong>     |           0.99978 |              3496 |              2172 |
| <strong>warehouse</strong>    |           0.99661 |               648 |                39 |
| <strong>zulip</strong>        |           0.99942 |              1437 |                42 |</p>
<p><strong>Base</strong></p>
<p>| project      | similarity index  | total files       | changed files     |
|--------------|------------------:|------------------:|------------------:|
| cpython      |           0.76079 |              1789 |              1635 |
| django       |           0.99948 |              2760 |                85 |
| transformers |           0.99925 |              2587 |               495 |
|twine        |           0.99965 |                33 |                 3 | &lt;== improved
| typeshed     |           0.99947 |              3496 |              2173 | &lt;== improved
| warehouse    |           0.99659 |               648 |                41 | &lt;== improved
| zulip        |           0.99938 |              1437 |                47 | &lt;== improved</p>
<p>Funny how typeshed is close to a similarity index of 1 but every other file gets reformatted :see_no_evil:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cnpryer">@cnpryer</a> reviewed on 2023-08-31 10:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/cnpryer">@cnpryer</a> on <code>crates/ruff_python_formatter/src/comments/format.rs</code>:364 on 2023-08-31 10:18</div>
            <div class="timeline-body"><p>üòç</p>
<p>I also put them in that order intentionally lol. Used download stats for pyright and pylint :).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/cnpryer">@cnpryer</a> on <code>crates/ruff_python_formatter/src/comments/format.rs</code>:364 on 2023-08-31 12:58</div>
            <div class="timeline-body"><p>To make sure I&#x27;m clear, your solution works since we&#x27;re intentionally disregarding the <em>bare</em> <code># noqa</code> lints <code>ruff</code> no longer expects to support?</p>
<pre><code>warning: Invalid `# noqa` directive on scratch.py:16: expected `:` followed by a comma-separated list of codes (e.g., `# noqa: F401, F841`).
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cnpryer">@cnpryer</a> reviewed on 2023-08-31 12:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/format.rs</code>:364 on 2023-08-31 13:04</div>
            <div class="timeline-body"><p>Hmm good point, we may need the <code>starts_width</code> in the case the colon is missing to cover ruff&#x27;s <code>noqa</code> :(</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-31 13:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cnpryer">@cnpryer</a> on 2023-08-31 13:19</div>
            <div class="timeline-body"><p>NBSP is such a niche thing to focus on, so I&#x27;ll move on soon, but while adding these fixtures I noticed the following isn&#x27;t aligned between the formatter and <code>black</code>:</p>
<pre><code># Input: \u{a0}\u{a0}type
i = &quot;&quot;  #¬†¬†type: Add space before two leading NBSP

# Ruff: \u{a0}type
i = &quot;&quot;  # ¬†type: Add space before two leading NBSP

# Black: \u{a0}\u{a0}type
i = &quot;&quot;  # ¬†¬†type: Add space before two leading NBSP
</code></pre>
<p>Should be simple, so I&#x27;ll submit it in a follow up PR and correct any snapshots.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/cnpryer">@cnpryer</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/trailing_comments.py</code>:25 on 2023-08-31 13:26</div>
            <div class="timeline-body"><p>Note I&#x27;ll address this in a follow up PR. See <a href="https://github.com/astral-sh/ruff/pull/7008">astral-sh/ruff#7008</a>#issuecomment-1701026971</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cnpryer">@cnpryer</a> reviewed on 2023-08-31 13:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cnpryer">@cnpryer</a> reviewed on 2023-08-31 13:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/cnpryer">@cnpryer</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/trailing_comments.py</code>:29 on 2023-08-31 13:27</div>
            <div class="timeline-body"><p>Same comment about aligning with black for NBSP edge cases</p>
<pre><code># Input: #\u{a0}\u{a0}noqa
i = &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;  #¬†¬†noqa

# Black: # \u{a0}noqa
i = &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;  # ¬†noqa

# Ruff: # noqa
i = &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;  # noqa
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cnpryer">@cnpryer</a> on 2023-08-31 13:31</div>
            <div class="timeline-body"><p>I&#x27;m going to mark as a draft and do another review of this during lunch today (~3 hours from now; would review my fixtures and the resolved merge conflict again).</p>
<p>If you decide to merge anyway I&#x27;m cool with that too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/cnpryer">@cnpryer</a> on 2023-08-31 13:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2023-08-31 13:38</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/cnpryer:exclude-pragmas">CodSpeed Performance Report</a>
Merging #7008 will <strong>degrade performances by 1.52%</strong>
<p>Comparing <code>cnpryer:exclude-pragmas</code> (a8c1f55) with <code>main</code> (f4ba0ea)</p>
Summary
<p><code>‚ùå 1</code> regressions
<code>‚úÖ 19</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/cnpryer:exclude-pragmas">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
Benchmarks breakdown
<p>|     | Benchmark | <code>main</code> | <code>cnpryer:exclude-pragmas</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ‚ùå | <code>linter/all-rules[pydantic/types.py]</code> | 71.8 ms | 72.9 ms | -1.52% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/cnpryer">@cnpryer</a> on 2023-08-31 16:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cnpryer">@cnpryer</a> reviewed on 2023-08-31 16:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/cnpryer">@cnpryer</a> on <code>crates/ruff_python_formatter/src/comments/format.rs</code>:364 on 2023-08-31 16:48</div>
            <div class="timeline-body"><p>fccdcfe2550c3fdb40bc73bb3e974ae3d1b8958f</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Exclude pragma comments from measured width&quot; to &quot;Exclude pragma comments from measured line width&quot; by <a href="https://github.com/cnpryer">@cnpryer</a> on 2023-08-31 23:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-09-01 06:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-01 06:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-01 06:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-09-01 16:32</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:56:48 UTC
    </footer>
</body>
</html>
