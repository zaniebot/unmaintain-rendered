<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Store starred-expression annotation types - astral-sh/ruff #14106</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Store starred-expression annotation types</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14106">#14106</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2024-11-05 12:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body">Summary
<ul>
<li>Store the expression type for annotations that are starred expressions (see <a href="https://github.com/astral-sh/ruff/pull/14091#discussion_r1828332857">discussion here</a>)</li>
<li>Use <code>self.store_expression_type(…)</code> consistently throughout, as it makes sure that no double-insertion errors occur.</li>
</ul>
<p>closes #14115</p>
Test Plan
<p>Added an invalid-syntax example to the corpus which leads to a panic on <code>main</code>. Also added a Markdown test with a valid-syntax example that would lead to a panic once we implement function parameter inference.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-05 12:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-05 12:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-05 12:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-05 12:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-11-05 12:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/annotations/starred_expressions.md</code>:10 on 2024-11-05 12:33</div>
            <div class="timeline-body"><p>As far as I understand, vararg annotations are the only place where starred expressions can appear in annotations at the &quot;outermost&quot; level (we can have things like <code>tuple[*Ts]</code>, but not a &quot;naked&quot; <code>*Ts</code>).</p>
<p>Please note that this is not a proper regression test so far, but hopefully once we have function parameter type inference. This test &quot;succeeds&quot; (does not panic) on <code>main</code> as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-05 12:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/annotations/starred_expressions.md</code>:10 on 2024-11-05 12:34</div>
            <div class="timeline-body"><p>Yes, I <em>think</em> that&#x27;s correct!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-11-05 12:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3780 on 2024-11-05 12:41</div>
            <div class="timeline-body"><p>This is probably the easiest solution to the <em>&quot;we don&#x27;t want to risk forgetting to store the annotation type in any of the non-<code>infer_type_expression</code> branches above&quot;</em> problem that I could think of. The way this works is by having a new function <em>infer_<strong>and_store</strong>_type_expression</em>, while the previous <em>infer_type_expression</em> only returns the type. If you feel that this introduces other risks (calling the wrong function elsewhere), let me know.</p>
<p>Another solution (also not very elegant) would be to explicitly state whether or not the expression type should be stored, as a kind of <code>mode</code> parameter to the <code>infer_type_expression</code> function (which would either be <code>InferOnly</code> or <code>InferAndStore</code>, or similar).</p>
<p>A third option would be to simply ignore double-insertions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-05 12:44</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/annotations/starred_expressions.md</code>:6 on 2024-11-05 13:52</div>
            <div class="timeline-body"><p>nit: this should future-proof the test a little bit. Strictly speaking we should complain about an import of <code>typing.TypeVarTuple</code> with our default Python version, since <code>typing.TypeVarTuple</code> was added in Python 3.11. <code>typing_extensions.TypeVarTuple</code>, on the other hand, is available on all Python versions.</p>
<pre><code>from typing_extensions import TypeVarTuple
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-11-05 13:56</div>
            <div class="timeline-body"><p>This LGTM, but I&#x27;d feel more confident if Micha or Carl could also take a look here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-05 17:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3780 on 2024-11-05 17:01</div>
            <div class="timeline-body"><blockquote>
<p>A third option would be to simply ignore double-insertions.</p>
</blockquote>
<p>We could disable this in release build but the assertion is intentional to catch double-inference early.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-11-05 17:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/annotations/starred_expressions.md</code>:10 on 2024-11-05 17:31</div>
            <div class="timeline-body"><p>I also think it&#x27;s correct, but (as I mentioned in Discord) we can&#x27;t restrict our test cases to valid syntax, because we also need to support error recovery. So when we are adding tests for something that currently causes us to panic, it&#x27;s fine (even good!) to write a test that is semantically nonsense, or even emits syntax errors, but demonstrates that we don&#x27;t panic.</p>
<p>It would be helpful if mdtest gained the feature to assert on syntax errors, instead of just immediately failing if there are any.</p>
<p>(To be clear, I think this test is a good addition regardless, and I don&#x27;t even feel strongly about adding the invalid-syntax test in this PR. Just observing that it is possible, and useful, to do so.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3780 on 2024-11-05 17:35</div>
            <div class="timeline-body"><p>I like the option you&#x27;ve chosen here, but I think we should flip the naming, so that <code>infer_type_expression</code> and <code>infer_expression</code> (the &quot;default&quot; options someone is likely to reach for, and whose naming strongly suggests parallel behavior) both <em>do</em> store the expression type.</p>
<p>I realize the current naming you have here is sensible because storing is doing an extra thing, so it makes sense for that to be reflected in the name. But I think the need that <code>infer_annotation_expression</code> has to infer a type expression without storing it is the unusual case, and it&#x27;s important that the method we should almost always prefer be the one with the shorter/simpler name.</p>
<p>So I would suggest that <code>infer_expression_type</code> does store, and we have <code>infer_expression_type_impl</code> or <code>infer_expression_type_no_store</code> (or perhaps you have a better idea for the awkward naming here) for the unusual case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-11-05 17:36</div>
            <div class="timeline-body"><p>Thank you!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-11-05 19:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3780 on 2024-11-05 19:03</div>
            <div class="timeline-body"><blockquote>
<p>So I would suggest that <code>infer_expression_type</code> does store, and we have <code>infer_expression_type_impl</code> or <code>infer_expression_type_no_store</code></p>
</blockquote>
<p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-11-05 19:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/annotations/starred_expressions.md</code>:10 on 2024-11-05 19:04</div>
            <div class="timeline-body"><blockquote>
<p>I also think it&#x27;s correct, but (as I mentioned in Discord) we can&#x27;t restrict our test cases to valid syntax, because we also need to support error recovery. So when we are adding tests for something that currently causes us to panic, it&#x27;s fine (even good!) to write a test that is semantically nonsense, or even emits syntax errors, but demonstrates that we don&#x27;t panic.</p>
</blockquote>
<p>That makes sense. I added an invalid-syntax example to the corpus that currently leads to a panic on main.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3786 on 2024-11-05 19:08</div>
            <div class="timeline-body"><p>Ugh I&#x27;m sorry, this was my carelessness in my review comment, but this should really be <code>infer_type_expression_no_store</code>, not <code>infer_expression_type_no_store</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-11-05 19:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-11-05 19:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3786 on 2024-11-05 19:09</div>
            <div class="timeline-body"><p>I was careless — sorry. Didn&#x27;t even look at the diff again :see_no_evil:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-05 19:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-05 19:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-05 19:25</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:08:07 UTC
    </footer>
</body>
</html>
