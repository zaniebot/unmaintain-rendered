```yaml
number: 4422
title: "Refactor range from `Attributed` to `Node`s"
type: pull_request
state: merged
author: MichaReiser
labels:
  - internal
assignees: []
merged: true
base: main
head: refactor-range-on-node
created_at: 2023-05-13T21:19:57Z
updated_at: 2023-05-16T06:56:38Z
url: https://github.com/astral-sh/ruff/pull/4422
synced_at: 2026-01-12T03:50:02Z
```

# Refactor range from `Attributed` to `Node`s

---

_Pull request opened by @MichaReiser on 2023-05-13 21:19_

Updates RustPython to https://github.com/RustPython/Parser/pull/22

The main changes are:

* `Attributed` has been removed
* The source code range is now stored on the node directly 
* New `Identifier` and `Constant` types have been introduced (not part of https://github.com/RustPython/Parser/pull/22 but have been changed upstream)
* All node types now have source information attached. 

## Motivation

Adding the range to the node directly will ease passing nodes as a whole to rules rather than destructuring all fields and passing them individually (this was possible before but required using `Located<&ast::IfStmt>` which is a bit more cumbersome to write). 

## Disadvantage

Having the `range` on the nodes has one disadvantage: It now shows up in all match patterns and constructing a new node e.g. for `unparse` requires specifying a range. I think that's an okay compromise. 

---

_Comment by @MichaReiser on 2023-05-13 21:20_

Current dependencies on/for this PR:
* main
  * **PR #4422** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4422" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #4435** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4435" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/charliermarsh/ruff/4422?utm_source=stack-comment).

---

_Review comment by @charliermarsh on `crates/ruff/src/autofix/actions.rs`:66 on 2023-05-13 21:38_

I tend to bias towards `..`, do you prefer targeted ignores for a specific reason?

---

_@charliermarsh reviewed on 2023-05-13 21:38_

---

_@MichaReiser reviewed on 2023-05-13 21:43_

---

_Review comment by @MichaReiser on `crates/ruff/src/autofix/actions.rs`:66 on 2023-05-13 21:43_

It depends. Targeted ignores are useful in code paths where we want to handle all fields (and get errors, if a new field has been added). Now, reading all the code to know if we should handle all fields was too much work, so I opted for targeted ignores (safer). 

---

_Comment by @MichaReiser on 2023-05-13 21:43_

@youknowone any idea why it is now pulling in `ruff_source_location`? 

---

_Comment by @github-actions[bot] on 2023-05-13 22:24_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                    pr
-----                                      ----                                    --
linter/all-rules/large/dataset.py          1.00     15.5Â±0.76ms     2.6 MB/sec     1.00     15.5Â±1.00ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.7Â±0.22ms     4.5 MB/sec     1.00      3.7Â±0.19ms     4.4 MB/sec
linter/all-rules/numpy/globals.py          1.01   468.1Â±27.90Âµs     6.3 MB/sec     1.00   464.6Â±32.86Âµs     6.4 MB/sec
linter/all-rules/pydantic/types.py         1.01      6.3Â±0.29ms     4.0 MB/sec     1.00      6.3Â±0.29ms     4.1 MB/sec
linter/default-rules/large/dataset.py      1.02      7.5Â±0.40ms     5.4 MB/sec     1.00      7.3Â±0.35ms     5.6 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01  1607.8Â±106.47Âµs    10.4 MB/sec    1.00  1594.3Â±110.32Âµs    10.4 MB/sec
linter/default-rules/numpy/globals.py      1.00   183.9Â±12.63Âµs    16.0 MB/sec     1.03   189.0Â±16.97Âµs    15.6 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.3Â±0.17ms     7.7 MB/sec     1.00      3.3Â±0.19ms     7.7 MB/sec
parser/large/dataset.py                    1.01      5.8Â±0.27ms     7.0 MB/sec     1.00      5.8Â±0.26ms     7.0 MB/sec
parser/numpy/ctypeslib.py                  1.02  1174.5Â±69.52Âµs    14.2 MB/sec     1.00  1154.8Â±65.47Âµs    14.4 MB/sec
parser/numpy/globals.py                    1.05    114.8Â±7.88Âµs    25.7 MB/sec     1.00    109.8Â±7.18Âµs    26.9 MB/sec
parser/pydantic/types.py                   1.02      2.6Â±0.17ms     9.9 MB/sec     1.00      2.5Â±0.12ms    10.1 MB/sec
```

#### Windows
```
group                                      main                                    pr
-----                                      ----                                    --
linter/all-rules/large/dataset.py          1.00     18.8Â±1.15ms     2.2 MB/sec     1.03     19.4Â±1.65ms     2.1 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.04      5.2Â±0.45ms     3.2 MB/sec     1.00      5.0Â±0.40ms     3.4 MB/sec
linter/all-rules/numpy/globals.py          1.00   580.9Â±43.79Âµs     5.1 MB/sec     1.03   599.9Â±44.46Âµs     4.9 MB/sec
linter/all-rules/pydantic/types.py         1.01      8.1Â±0.87ms     3.1 MB/sec     1.00      8.1Â±0.64ms     3.2 MB/sec
linter/default-rules/large/dataset.py      1.00      9.1Â±0.52ms     4.5 MB/sec     1.03      9.3Â±0.69ms     4.4 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1938.8Â±161.03Âµs     8.6 MB/sec    1.02  1967.9Â±158.18Âµs     8.5 MB/sec
linter/default-rules/numpy/globals.py      1.00   227.8Â±13.43Âµs    13.0 MB/sec     1.04   236.7Â±20.11Âµs    12.5 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.1Â±0.30ms     6.2 MB/sec     1.03      4.3Â±0.33ms     6.0 MB/sec
parser/large/dataset.py                    1.00      7.5Â±0.43ms     5.4 MB/sec     1.05      7.8Â±0.64ms     5.2 MB/sec
parser/numpy/ctypeslib.py                  1.00  1509.0Â±122.98Âµs    11.0 MB/sec    1.02  1541.5Â±122.27Âµs    10.8 MB/sec
parser/numpy/globals.py                    1.05   157.0Â±14.25Âµs    18.8 MB/sec     1.00    149.4Â±8.71Âµs    19.7 MB/sec
parser/pydantic/types.py                   1.00      3.2Â±0.20ms     7.9 MB/sec     1.05      3.4Â±0.31ms     7.5 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Comment by @youknowone on 2023-05-13 23:56_

No idea what's happened. I tried clone of this PR and Parser one, and source_location had gone

---

_Label `internal` added by @MichaReiser on 2023-05-15 08:04_

---

_Marked ready for review by @MichaReiser on 2023-05-15 08:31_

---

_Comment by @youknowone on 2023-05-15 08:45_

> New Identifier and Constant types have been introduced 

Nothing important but just for information. Identifier and Int are added. Constant internal type is also changed to using Idenfier and Int, but Constant itself already existed.

---

_@MichaReiser reviewed on 2023-05-15 09:10_

---

_Review comment by @MichaReiser on `crates/ruff/src/checkers/ast/mod.rs`:3678 on 2023-05-15 09:10_

We can now pass specific nodes to avoid the `panic!` in the rule implementations.

---

_@charliermarsh approved on 2023-05-15 13:17_

LGTM. Just a skim since I'm familiar with the ideas and motivations, and assume that as long as it compiles + tests pass, then it's done well :)

---

_Review comment by @charliermarsh on `crates/ruff/src/checkers/ast/mod.rs`:3678 on 2023-05-15 13:18_

Yeah these are great.

---

_@charliermarsh reviewed on 2023-05-15 13:18_

---

_Comment by @MichaReiser on 2023-05-15 13:19_

> as long as it compiles + tests pass, then it's done well :)

I hope that's true :D. Trust in Rust

---

_Comment by @charliermarsh on 2023-05-15 13:19_

Trust in Rust

---

_Comment by @youknowone on 2023-05-15 17:28_

Oh, this is not done yet. #4442 

---

_Comment by @MichaReiser on 2023-05-15 17:33_

> Oh, this is not done yet. #4442 

Unfortunately not. It was a busy afternoon. I plan to merge this pr tomorrow 

---

_Merged by @MichaReiser on 2023-05-16 06:36_

---

_Closed by @MichaReiser on 2023-05-16 06:36_

---

_Branch deleted on 2023-05-16 06:36_

---
