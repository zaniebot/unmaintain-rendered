<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Improve typevar solving when encountering unions of generic types - astral-sh/ruff #21818</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Improve typevar solving when encountering unions of generic types</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21818">#21818</a>
        opened by <a href="https://github.com/suleymanozkeskin">@suleymanozkeskin</a>
        on 2025-12-05 20:19
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/suleymanozkeskin">@suleymanozkeskin</a> on 2025-12-05 20:19</div>
            <div class="timeline-body"><p>Improves type inference for union types with multiple generic parameters like
Ok[T] | Err[E] by adding union-pairing logic to the constraint solver.</p>
<p>Changes:</p>
<ul>
<li>Added union element pairing with typevar confinement checks in generics.rs</li>
<li>Added 3 tests to type_guards.md</li>
</ul>
<h2>Summary</h2>
<p>Following the explanatory <a href="https://github.com/astral-sh/ruff/pull/21739#issuecomment-3615023976">comment</a>, made by @carljm, I made some refactoring which I hope addresses the issue on the correct place.</p>
<p>I am not sure if this is still a <strong>right</strong> or <strong>suitable</strong> fix that matches the further plans of the maintainers on this topic.</p>
<p>Fixes https://github.com/astral-sh/ty/issues/1703</p>
<h2>Test Plan</h2>
<p>I used the existing markdown test suite with additional test cases to cover the issue I opened + the case mentioned <a href="https://github.com/astral-sh/ty/issues/1703#issuecomment-3599797957">here</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @suleymanozkeskin on 2025-12-05 20:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @suleymanozkeskin on 2025-12-05 20:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @suleymanozkeskin on 2025-12-05 20:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @suleymanozkeskin on 2025-12-05 20:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-12-05 20:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "  Fixes https://github.com/astral-sh/ty/issues/1703" to "[ty] Improve typevar solving when encountering unions of generic types" by @AlexWaygood on 2025-12-05 20:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-05 20:24</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-05 20:26</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">beartype (https://github.com/beartype/beartype)
- beartype/claw/_package/clawpkgtrie.py:66:29: warning[unsupported-base] Unsupported class base with type `&lt;class 'dict[str, PackagesTrieBlacklist]'&gt; | &lt;class 'dict[str, Divergent]'&gt;`
- beartype/claw/_package/clawpkgtrie.py:247:29: warning[unsupported-base] Unsupported class base with type `&lt;class 'dict[str, PackagesTrieWhitelist]'&gt; | &lt;class 'dict[str, Divergent]'&gt;`
- Found 494 diagnostics
+ Found 492 diagnostics

scikit-build-core (https://github.com/scikit-build/scikit-build-core)
+ src/scikit_build_core/build/_pathutil.py:25:38: error[invalid-argument-type] Argument to function `__new__` is incorrect: Expected `str | PathLike[str]`, found `DirEntry[Path]`
+ src/scikit_build_core/build/_pathutil.py:27:24: error[invalid-argument-type] Argument to function `__new__` is incorrect: Expected `str | PathLike[str]`, found `DirEntry[Path]`
+ src/scikit_build_core/build/wheel.py:98:20: error[no-matching-overload] No overload of bound method `__init__` matches arguments
- Found 39 diagnostics
+ Found 42 diagnostics

pandas-stubs (https://github.com/pandas-dev/pandas-stubs)
- pandas-stubs/_typing.pyi:1217:16: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 5519 diagnostics
+ Found 5518 diagnostics


</code></pre>
</details>

<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @sharkdp by @sharkdp on 2025-12-08 15:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-12-10 19:39</div>
            <div class="timeline-body"><p>Thank you for your contribution. I'm planning to review this soon.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/resources/mdtest/narrow/type_guards.md</code>:473 on 2025-12-11 09:50</div>
            <div class="timeline-body"><p>Can you go into details why this would be unsound? It seems like this should be supported in some scenarios? If <code>A</code> and <code>B</code> are covariant (or bivariant, like here) in <code>T</code>, <code>int | str</code> seems like a valid solution?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/resources/mdtest/narrow/type_guards.md</code>:478 on 2025-12-11 09:51</div>
            <div class="timeline-body"><p>Why?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/resources/mdtest/narrow/type_guards.md</code>:488 on 2025-12-11 09:51</div>
            <div class="timeline-body"><p>Ok, but there is a valid solution here (<code>T = int</code>). This test makes it sound like we should never handle this case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/generics.rs</code>:1606 on 2025-12-11 09:52</div>
            <div class="timeline-body"><p>If this is handled by the code below, we should add tests for it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/generics.rs</code>:1520 on 2025-12-11 09:59</div>
            <div class="timeline-body"><p>This (together with even more assumptions below) looks like the code here is tailored for <em>exactly</em> the one use case of the <code>Ok[Something] | Error[SomethingElse]</code> vs. <code>Ok[T] | Error[E]</code> matching described in the issue. The ecosystem report also shows that this change doesn't seem to have a broader impact. This makes me wonder if it is worth adding this, given that we'll soon want to replace this with a much more general solution based on constraint sets.</p>
<p>I think I might be in favor of implementing something like this now (without constraint sets), <em>if</em> we can generalize it to more cases, i.e. without explicitly matching on <code>Type::NominalInstance</code> below, for example. But in its current form, I'm not sure if it's worth the additional complexity and review+maintenance effort.</p>
<p>I would also value @dcreager's opinion here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-12-11 10:02</div>
            <div class="timeline-body"><p>Thank you for your contribution. As laid out in one of the inline comments, I'm not sure if it's worth integrating this in its current form, given that it's rather limited in applicability(?).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @AlexWaygood on 2025-12-18 16:31</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:42:35 UTC
    </footer>
</body>
</html>
