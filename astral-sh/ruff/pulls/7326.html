<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detect `noqa` directives for multi-line f-strings - astral-sh/ruff #7326</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Detect <code>noqa</code> directives for multi-line f-strings</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7326">#7326</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2023-09-13 04:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR updates the NoQA directive detection to consider the new f-string tokens.</p>
<p>The reason being that now there can be multi-line f-strings without triple-quotes:</p>
<pre><code class="language-python">f&quot;{
x
	*
		y
}&quot;
</code></pre>
<p>Here, the <code>noqa</code> directive should go at the end of the last line.</p>
<h2>Test Plan</h2>
<ul>
<li><p>Add new test cases for f-strings</p>
</li>
<li><p>Tested with <code>--add-noqa</code> using the following command with the above code snippet:</p>
<pre><code class="language-console">$ cargo run --bin ruff -- check --select=F821 --no-cache --isolated ~/playground/ruff/fstring.py --add-noqa
Added 1 noqa directive.
</code></pre>
<p>Output:</p>
<pre><code class="language-python">f&quot;{
x
    *
    	y
}&quot;  # noqa: F821
</code></pre>
<p>Running the same command again doesn't add <code>noqa</code> directive and without the <code>--add-noqa</code> flag, the violation isn't reported.</p>
</li>
</ul>
<p>fixes: #7291</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-13 04:41</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #7376</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7376" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #7690</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7690" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
<li><strong>PR #7667</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7667" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
<li><strong>PR #7597</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7597" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
<li><strong>PR #7588</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7588" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #7589</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7589" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
</ul>
</li>
<li><strong>PR #7586</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7586" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
<li><strong>PR #7515</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7515" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
<li><strong>PR #7477</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7477" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
<li><strong>PR #7387</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7387" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
<li><strong>PR #7378</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7378" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
<li><strong>PR #7329</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7329" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
<li><strong>PR #7328</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7328" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
<li><strong>PR #7327</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7327" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
<li><strong>PR #7326</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7326" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  üëà</li>
<li><strong>PR #7325</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7325" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7326?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">python312</span> added by @dhruvmanila on 2023-09-13 05:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">noqa</span> added by @dhruvmanila on 2023-09-13 05:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/directives.rs</code>:112 on 2023-09-14 03:06</div>
            <div class="timeline-body"><p>There's a slight performance penalty here as not many single quoted f-strings are going to be multi-line but we can't really know that until we get the entire f-string range.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-09-14 03:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dhruvmanila on 2023-09-14 03:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @dhruvmanila on 2023-09-14 03:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2023-09-14 03:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-14 06:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/directives.rs</code>:108 on 2023-09-14 06:55</div>
            <div class="timeline-body"><p>I would expect the noqa directive to be added on the line of <code>x</code> if x has a violation</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2023-09-14 06:56</div>
            <div class="timeline-body"><p>Please add a few tests for nested f-strings. We may also need to align on where the noqa directive should be added for expressions inside of f-strings (inside the string or outside the strings)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-09-15 05:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/directives.rs</code>:108 on 2023-09-15 05:30</div>
            <div class="timeline-body"><p>But then it doesn't align with how it gets added with triple-quoted f-strings. In that the directive gets added on the last line of the string:</p>
<pre><code class="language-python">f&quot;&quot;&quot;test{
    a
        *
            b
}test&quot;&quot;&quot;  # noqa: F821
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-15 06:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/directives.rs</code>:108 on 2023-09-15 06:20</div>
            <div class="timeline-body"><p>I would also expect this noqa to be added to the expression because it is a multiline string.</p>
<p>I think there are multiple questions here that we haven't talked about</p>
<ol>
<li>How should noqa comments in fstrings work in Python 3.12 forward, now that comments are allowed inside f-strings</li>
<li>Whether we want to implement the new layout now or defer to later</li>
<li>How to implement the change</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2023-09-18 17:20</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/dhruv/issue-7291">CodSpeed Performance Report</a></h2>
<h3>Merging #7326 will <strong>degrade performances by 2.57%</strong></h3>
<p><sub>Comparing <code>dhruv/issue-7291</code> (cd374e8) with <code>dhruv/pep-701</code> (1aa2390)</sub></p>
<h3>Summary</h3>
<p><code>‚ö° 1</code> improvements
<code>‚ùå 1</code> regressions
<code>‚úÖ 23</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/dhruv/issue-7291">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>dhruv/pep-701</code> | <code>dhruv/issue-7291</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ‚ùå | <code>linter/default-rules[pydantic/types.py]</code> | 38.2 ms | 39.2 ms | -2.57% |
| ‚ö° | <code>linter/default-rules[numpy/ctypeslib.py]</code> | 19.1 ms | 18.5 ms | +3.11% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-09-18 19:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @MichaReiser on 2023-09-18 19:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/directives.rs</code>:121 on 2023-09-18 19:13</div>
            <div class="timeline-body"><p>I wonder if we could build the fstring ranges directly from using the <code>fstring_ranges</code> instead by e.g. using <code>values</code> and filtering out overlapping ranges (should be adjacent)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/directives.rs</code>:492 on 2023-09-18 19:13</div>
            <div class="timeline-body"><p>Can you add an example for nested f-strings</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-09-18 19:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-09-20 03:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/directives.rs</code>:121 on 2023-09-20 03:09</div>
            <div class="timeline-body"><p>Good point. This is actually how it should be done as otherwise the nested f-strings weren't handled properly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-09-20 03:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/directives.rs</code>:492 on 2023-09-20 03:10</div>
            <div class="timeline-body"><p>Added a test case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2023-09-21 02:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2023-09-21 02:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-09-21 02:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:00:11 UTC
    </footer>
</body>
</html>
