<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add diagnostics for `isinstance()` and `issubclass()` calls that use invalid PEP-604 unions for their second argument - astral-sh/ruff #21343</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add diagnostics for <code>isinstance()</code> and <code>issubclass()</code> calls that use invalid PEP-604 unions for their second argument</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21343">#21343</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-11-08 20:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR adds extra validation for <code>isinstance()</code> and <code>issubclass()</code> calls that use <code>UnionType</code> instances for their second argument. According to typeshed's annotations, any <code>UnionType</code> is accepted for the second argument, but this isn't true at runtime: at runtime, all elements in the <code>UnionType</code> must either be class objects or be <code>None</code> in order for the <code>isinstance()</code> or <code>issubclass()</code> call to reliably succeed:</p>
<pre><code class="language-pycon">% uvx python3.14                            
Python 3.14.0 (main, Oct 10 2025, 12:54:13) [Clang 20.1.4 ] on darwin
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; from typing import LiteralString
&gt;&gt;&gt; import types
&gt;&gt;&gt; type(LiteralString | int) is types.UnionType
True
&gt;&gt;&gt; isinstance(42, LiteralString | int)
Traceback (most recent call last):
  File &quot;&lt;python-input-5&gt;&quot;, line 1, in &lt;module&gt;
    isinstance(42, LiteralString | int)
    ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/Users/alexw/Library/Application Support/uv/python/cpython-3.14.0-macos-aarch64-none/lib/python3.14/typing.py&quot;, line 559, in __instancecheck__
    raise TypeError(f&quot;{self} cannot be used with isinstance()&quot;)
TypeError: typing.LiteralString cannot be used with isinstance()
</code></pre>
<h2>Test Plan</h2>
<p>Added mdtests/snapshots</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-11-08 20:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-08 20:05</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-08 20:06</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅</p>
<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @AlexWaygood on 2025-11-08 20:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-11-08 20:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-11-08 20:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @AlexWaygood on 2025-11-08 20:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> approved on 2025-11-10 08:44</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-11-10 08:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-11-10 08:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-11-10 08:46</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:17:03 UTC
    </footer>
</body>
</html>
