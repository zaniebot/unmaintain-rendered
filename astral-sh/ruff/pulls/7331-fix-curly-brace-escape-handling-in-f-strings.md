```yaml
number: 7331
title: Fix curly brace escape handling in f-strings
type: pull_request
state: merged
author: dhruvmanila
labels:
  - parser
  - python312
assignees: []
merged: true
base: dhruv/pep-701
head: dhruv/fstring-parser-4
created_at: 2023-09-13T09:45:55Z
updated_at: 2023-09-14T02:26:17Z
url: https://github.com/astral-sh/ruff/pull/7331
synced_at: 2026-01-12T02:39:09Z
```

# Fix curly brace escape handling in f-strings

---

_Pull request opened by @dhruvmanila on 2023-09-13 09:45_

## Summary

This PR fixes the escape handling of curly braces inside a f-string. There are 2
main changes:

### Lexer

The lexer change was actually a bug. Instead of breaking as soon as we find a
curly brace after the `\` character, we'll continue and let the next iteration
handle it in the curly brace branch. This fixes the following case:

```python
f"\{{foo}}"
#  ^ use the curly brace branch to handle this character instead of breaking
```

### Parser

We can encounter a `\` as the last character in a `FStringMiddle` token which is
valid in this context[^1]. For example,

```python
f"\{foo} \{bar:\}"
# ^     ^^     ^
# The marked characters are part of 3 different `FStringMiddle` token
```

Here, the `FStringMiddle` token content will be `"\"` and `" \"` which is invalid in
a regular string literal. However, it's valid here because it's a substring of a
f-string. Even though curly braces cannot be escaped, it's a valid syntax.

[^1]: Refer to point 3 in https://peps.python.org/pep-0701/#rejected-ideas

## Test Plan

Verified that existing test cases are passing and add new test cases for the lexer and parser.


---

_Comment by @dhruvmanila on 2023-09-13 09:46_

Current dependencies on/for this PR:
* main
  * **PR #7035** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7035" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7013** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7013" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #6659** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6659" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #7041** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7041" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #7211** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7211" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
            * **PR #7263** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7263" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
              * **PR #7331** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7331" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  üëà
                * **PR #7325** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7325" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
                  * **PR #7326** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7326" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
                    * **PR #7327** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7327" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
                      * **PR #7328** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7328" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
                        * **PR #7329** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7329" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7331?utm_source=stack-comment).

---

_Review requested from @MichaReiser by @dhruvmanila on 2023-09-13 09:47_

---

_Label `parser` added by @dhruvmanila on 2023-09-13 09:47_

---

_Label `python312` added by @dhruvmanila on 2023-09-13 09:47_

---

_Review requested from @charliermarsh by @MichaReiser on 2023-09-13 11:40_

---

_Review comment by @MichaReiser on `crates/ruff_python_parser/src/lexer.rs`:575 on 2023-09-13 11:44_

Nit: Update the comment to explain that these are handled in the next iteration?

---

_Review comment by @MichaReiser on `crates/ruff_python_parser/src/string.rs`:219 on 2023-09-13 11:46_

This section doesn't explain why it is valid. It only explains why it isn't an escape sequence. I assume it is valid because allows invalid escape sequences in general (Do we have a lint rule for that, does it need updating?)

---

_@MichaReiser approved on 2023-09-13 11:46_

---

_@dhruvmanila reviewed on 2023-09-13 12:33_

---

_Review comment by @dhruvmanila on `crates/ruff_python_parser/src/string.rs`:219 on 2023-09-13 12:33_

I actually noticed this while I was working on https://github.com/astral-sh/ruff/pull/7327/files#diff-739ef20efc60adce8f2acfaeda1005a932c58536433cbb895b323d335fffdd63 where at the end of the test file, the following was mentioned:

```python
# To be fixed
# Error: f-string: single '}' is not allowed at line 41 column 8
# f"\{{x}}"
```

So, then I started looking into it and realize that we don't parse this as a valid syntax. Python parses it as a valid syntax pre 3.12 as well although with 3.12 it produces a syntax warning:

```console
$ python3.12-dev fstring.py
/Users/dhruv/playground/ruff/fstring.py:2: SyntaxWarning: invalid escape sequence '\{'
  f"\{foo}"
```

> (Do we have a lint rule for that, does it need updating?)

We do have `W605` ([tracking issue](https://github.com/astral-sh/ruff/issues/7295)) but as we didn't parse the syntax before, we didn't raise any warning. Now, we have the ability to raise that warning and I think we should do it.

---

_Merged by @dhruvmanila on 2023-09-14 02:18_

---

_Closed by @dhruvmanila on 2023-09-14 02:18_

---

_Branch deleted on 2023-09-14 02:18_

---

_Comment by @codspeed-hq[bot] on 2023-09-14 02:26_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/dhruv/fstring-parser-4)

### Merging #7331 will **degrade performances by 9.55%**

<sub>:warning: No base runs were found</sub>

<sub>Falling back to comparing <code>dhruv/fstring-parser-4</code> (a8e4218) with <code>main</code> (04183b0)</sub>



### Summary

`‚ùå 8` regressions
`‚úÖ 17` untouched benchmarks



> :warning: _Please fix the performance issues or [acknowledge them on CodSpeed](https://codspeed.io/astral-sh/ruff/branches/dhruv/fstring-parser-4)._

### Benchmarks breakdown

|     | Benchmark | `main` | `dhruv/fstring-parser-4` | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ‚ùå | `lexer[unicode/pypinyin.py]` | 620.2 ¬µs | 672.2 ¬µs | -7.73% |
| ‚ùå | `lexer[large/dataset.py]` | 9.8 ms | 10.7 ms | -8.22% |
| ‚ùå | `lexer[numpy/globals.py]` | 233.2 ¬µs | 252.8 ¬µs | -7.74% |
| ‚ùå | `lexer[numpy/ctypeslib.py]` | 2 ms | 2.1 ms | -7.55% |
| ‚ùå | `parser[large/dataset.py]` | 68.4 ms | 70.2 ms | -2.56% |
| ‚ùå | `parser[numpy/ctypeslib.py]` | 12.4 ms | 12.7 ms | -2.57% |
| ‚ùå | `parser[unicode/pypinyin.py]` | 4.3 ms | 4.4 ms | -2.78% |
| ‚ùå | `lexer[pydantic/types.py]` | 4.1 ms | 4.5 ms | -9.55% |


---
