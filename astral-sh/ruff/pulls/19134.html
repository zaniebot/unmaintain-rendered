<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add separate CI job for memory usage stats - astral-sh/ruff #19134</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add separate CI job for memory usage stats</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19134">#19134</a>
        opened by <a href="https://github.com/ibraheemdev">@ibraheemdev</a>
        on 2025-07-03 23:44
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>As discussed in https://github.com/astral-sh/ruff/pull/19059.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ci</span> added by @ibraheemdev on 2025-07-03 23:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @ibraheemdev on 2025-07-03 23:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty/src/lib.rs</code>:301 on 2025-07-03 23:45</div>
            <div class="timeline-body"><p>This is a hack for now, we should have a way to silence diagnostics completely (but keep the memory usage report).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-07-03 23:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-07-03 23:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_python_semantic/resources/primer/memory.txt</code>:4 on 2025-07-03 23:45</div>
            <div class="timeline-body"><p>Somewhat arbitrarily chosen, open to suggestions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-07-03 23:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_project/src/db.rs</code>:337 on 2025-07-03 23:47</div>
            <div class="timeline-body"><p>I lowered the threshold because single-threaded runs should be completely deterministic, and the jump between buckets is currently quite high for large numbers.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-03 23:59</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-07-04 00:15</div>
            <div class="timeline-body"><p>We could also just run the memory usage report in the same job? If we choose smaller projects that shouldn't add significant time, and we avoid having to use another depot runner and duplicate the setup work. We could also avoid using mypy-primer for that run and get exact numbers.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @ibraheemdev on 2025-07-04 00:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @ibraheemdev on 2025-07-04 00:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @ibraheemdev on 2025-07-04 00:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @ibraheemdev on 2025-07-04 00:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @ibraheemdev on 2025-07-04 00:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @ibraheemdev on 2025-07-04 00:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>.github/workflows/mypy_primer.yaml</code>:102 on 2025-07-04 10:37</div>
            <div class="timeline-body"><p>could this be extracted as a standalone <code>.sh</code> script that's invoked from both jobs? I think the only differences between them are the environment variables <code>PRIMER_SELECTOR</code>, <code>TY_MAX_PARALLELISM</code> and <code>TY_MEMORY_REPORT</code>, if I'm reading it correctly?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-07-04 10:37</div>
            <div class="timeline-body"><p>thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-04 21:25</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/primer/memory.txt</code>:4 on 2025-07-05 16:44</div>
            <div class="timeline-body"><p>sympy might be a good addition here, I think -- we have very high memory usage on it already</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-07-05 16:47</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-07 08:42</div>
            <div class="timeline-body"><p>I'm a bit surprised that the memory usage results are non deterministic when running multi threaded (to such large degrees). The only two reasons I can think of are:</p>
<ul>
<li>AST GC</li>
<li>intermediate results from fixpoint cycles and the non-determinism comes from entering the cycles from different entry queries.</li>
</ul>
<p>Do we know which of the two is causing the flakes?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-07 08:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty/src/lib.rs</code>:299 on 2025-07-07 08:45</div>
            <div class="timeline-body"><p>I, at first, didn't understand what features is needed to replace this environment variable usage but I think I understand now. What we need is a <code>--quiet</code> or similar flag. Would you mind opening an issue in the ty repository for adding a flag to suppress diagnostic printing (and mention Ruff's <code>--quiet</code> and <code>--silent</code> flags)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-07-07 08:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ibraheemdev on 2025-07-07 16:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ibraheemdev on 2025-07-07 16:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-07 16:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-07-07 16:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty/src/lib.rs</code>:299 on 2025-07-07 16:19</div>
            <div class="timeline-body"><p>Created https://github.com/astral-sh/ty/issues/772</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-07-07 16:22</div>
            <div class="timeline-body"><blockquote>
<p>I'm a bit surprised that the memory usage results are non deterministic when running multi threaded (to such large degrees)</p>
</blockquote>
<p>This is partly due to our rounding strategy being affected by very small changes if we get unlucky with the numbers. Now that we have a separate job we could just get the exact numbers manually. That said, on my machine I was seeing variance of ~10MB on projects with total memory usage in the hundreds of MB. It's possible that AST garbage collection is the culprit.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:13:57 UTC
    </footer>
</body>
</html>
