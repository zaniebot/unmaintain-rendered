<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use `#[cold]` attribute on non-ASCII lexer path - astral-sh/ruff #9517</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use <code>#[cold]</code> attribute on non-ASCII lexer path</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/9517">#9517</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-01-15 01:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><p>Just curious if this shows up.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Use #[cold] attribute on non-ASCII lexer path&quot; to &quot;Use `#[cold]` attribute on non-ASCII lexer path&quot; by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-15 01:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-01-15 02:03</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-15 02:03</div>
            <div class="timeline-body"><p>Seems like a 1% improvement on all lexer benchmarks (but doesn&#x27;t meet the CodSpeed threshold to post): https://codspeed.io/astral-sh/ruff/branches/charlie/cold</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:1492 on 2024-01-15 14:43</div>
            <div class="timeline-body"><p>Can you try adding <code>#[inline(never)]</code> and to <code>is_unicode_identifier_continue</code> as well?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:1516 on 2024-01-15 14:46</div>
            <div class="timeline-body"><p>How come you&#x27;re forcing 64-bit alignment here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:1503 on 2024-01-15 14:48</div>
            <div class="timeline-body"><p>If you&#x27;re looking to speed things up here for the ASCII fast path, it might make sense to refactor the calling code to deal with this <code>&amp;str</code> chunks instead. That way, you can get entire identifiers all in one go if that&#x27;s the common path. (But if it&#x27;s not the overwhelmingly common path, and it might not be, then it may not be such a good idea.) This <em>could</em> also be a good &quot;started SIMD&quot; task.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-01-15 14:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-15 14:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:1503 on 2024-01-15 14:52</div>
            <div class="timeline-body"><p>This sounds interesting even just to learn. Can you say a bit more here? What&#x27;s the chunk?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-15 14:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:1516 on 2024-01-15 14:52</div>
            <div class="timeline-body"><p>(This is copied out from the <code>unicode_ident</code> crate just for quickly benchmarking.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-01-15 15:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:1503 on 2024-01-15 15:05</div>
            <div class="timeline-body"><p>To be clear, I don&#x27;t have any understanding of what the caller code looks like. So the idea may be bunk. But basically, if you&#x27;re calling this function over and over on each individual codepoint, then you&#x27;re paying a price for the latency of doing that check. If it&#x27;s a <em>necessary</em> payment, then there is not much to do. But if &quot;a starting identifier char followed by continuation chars&quot; is extremely common, then it may make more sense to have an API like this:</p>
<pre><code>fn get_ident_from_prefix(src: &amp;str) -&gt; Option&lt;Identifier&gt; { ... }
</code></pre>
<p>The idea is that if you&#x27;re <em>pretty</em> sure there&#x27;s an identifier there in most cases, then you make the uncommon cases a little slower in favor of making the common case a lot faster. The idea here is that you might be able to detect identifiers very quickly with bit tricks and/or SIMD. The specific details of what the bit tricks/SIMD are is left as an exercise to for the reader. :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-01-15 15:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:1503 on 2024-01-15 15:30</div>
            <div class="timeline-body"><p>The calling code is very simple. We call it for every character until the end of an identifier.</p>
<pre><code>        self.cursor.eat_while(is_identifier_continuation);

</code></pre>
<p>It eats the characters why <code>is_identifier_continuation</code> is true, and we expect most characters to be ascii. There are probably some SIMD tricks that we could apply but it never felt worthwhile considering that lexing used to be a very small fraction compared to parsing.</p>
<p>It could make sense to add an explicit branch for all python whitespace to avoid calling into the function when we reach any space character (the end of an identifier).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-01-15 15:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:1503 on 2024-01-15 15:33</div>
            <div class="timeline-body"><p>Oh yeah absolutely, if lexing is already a small slice of the pie, it may indeed not make sense to expend a lot of effort here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-01-15 15:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:1503 on 2024-01-15 15:36</div>
            <div class="timeline-body"><p>It might be worth it with the new parser ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-18 03:16</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:00:41 UTC
    </footer>
</body>
</html>
