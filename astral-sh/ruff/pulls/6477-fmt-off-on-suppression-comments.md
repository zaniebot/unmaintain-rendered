```yaml
number: 6477
title: "`fmt: off..on` suppression comments"
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: fmt-on-off
created_at: 2023-08-10T10:58:44Z
updated_at: 2023-08-14T16:14:03Z
url: https://github.com/astral-sh/ruff/pull/6477
synced_at: 2026-01-12T02:52:04Z
```

# `fmt: off..on` suppression comments

---

_Pull request opened by @MichaReiser on 2023-08-10 10:58_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

Implements support for `fmt: off` and `fmt: on` suppression comments on statement level. 

This seems trivial but quickly gets complicated because you can have:

```python
# fmt: off
# fmt: on
test
```

in which case we should not disable formatting (see test cases for more absurd usages of `fmt: off` and `fmt: on` combinations).



This PR does not address:
* warn if a suppression comment is used incorrectly
* Fixing indentation of suppressed ranges


## Test Plan

I added many test files and believe that I covered all branches. 

Small improvements in the similarity index:

**Before**

project | similarity index
-- | --
build | 0.75623
cpython | 0.75472
django | 0.99802
transformers | 0.99470
typeshed | 0.74233
warehouse | 0.99601
zulip | 0.99727


**After**

project | similarity index
-- | --
build | 0.75623
cpython | 0.75472
django | 0.99804
transformers | 0.99618
typeshed | 0.74233
warehouse | 0.99601
zulip | 0.99727



---

_Comment by @MichaReiser on 2023-08-10 10:58_

Current dependencies on/for this PR:
* main
  * **PR #6443** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6443" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #6452** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6452" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #6477** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6477" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
        * **PR #6507** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6507" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #6561** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6561" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6477?utm_source=stack-comment).

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/tests/snapshots/black_compatibility@simple_cases__fmtonoff.py.snap`:226 on 2023-08-10 11:13_

It does ;)

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/tests/snapshots/black_compatibility@simple_cases__fmtonoff.py.snap`:204 on 2023-08-10 11:13_

Ruff doesn't support expression level suppression comments.

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/tests/snapshots/black_compatibility@simple_cases__fmtonoff4.py.snap`:31 on 2023-08-10 11:14_

Suppression comments between decorators are not supported.

---

_@MichaReiser reviewed on 2023-08-10 12:29_

---

_Review requested from @charliermarsh by @MichaReiser on 2023-08-10 12:29_

---

_Label `formatter` added by @MichaReiser on 2023-08-10 12:30_

---

_Marked ready for review by @MichaReiser on 2023-08-10 12:31_

---

_Review requested from @konstin by @MichaReiser on 2023-08-10 12:32_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/statement/suite.rs`:76 on 2023-08-10 12:35_

I had to move the `first.format` out to avoid having to handle suppression comments in each branch.

---

_@MichaReiser reviewed on 2023-08-10 12:35_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/statement/suite.rs`:108 on 2023-08-10 12:36_

I had to move this into the `loop` to avoid having to handle the suppression comments on `second` 

---

_@MichaReiser reviewed on 2023-08-10 12:36_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/statement/suite.rs`:116 on 2023-08-10 12:36_

This is new

---

_@MichaReiser reviewed on 2023-08-10 12:36_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/statement/suite.rs`:185 on 2023-08-10 12:36_

This is new 

---

_@MichaReiser reviewed on 2023-08-10 12:36_

---

_@MichaReiser reviewed on 2023-08-10 12:37_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/statement/suite.rs`:277 on 2023-08-10 12:37_

This is new

---

_Comment by @github-actions[bot] on 2023-08-10 13:07_

## PR Check Results
### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.03      4.4Â±0.11ms     9.2 MB/sec    1.00      4.3Â±0.13ms     9.5 MB/sec
formatter/numpy/ctypeslib.py               1.00   821.4Â±22.03Âµs    20.3 MB/sec    1.03   843.9Â±21.86Âµs    19.7 MB/sec
formatter/numpy/globals.py                 1.00     84.0Â±2.83Âµs    35.1 MB/sec    1.04     87.7Â±1.74Âµs    33.6 MB/sec
formatter/pydantic/types.py                1.00  1695.1Â±38.16Âµs    15.0 MB/sec    1.01  1718.9Â±93.61Âµs    14.8 MB/sec
linter/all-rules/large/dataset.py          1.07     12.5Â±0.15ms     3.3 MB/sec    1.00     11.7Â±0.37ms     3.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.03      3.3Â±0.05ms     5.0 MB/sec    1.00      3.2Â±0.06ms     5.2 MB/sec
linter/all-rules/numpy/globals.py          1.06   471.6Â±10.18Âµs     6.3 MB/sec    1.00   444.3Â±10.05Âµs     6.6 MB/sec
linter/all-rules/pydantic/types.py         1.06      6.4Â±0.08ms     4.0 MB/sec    1.00      6.1Â±0.13ms     4.2 MB/sec
linter/default-rules/large/dataset.py      1.09      6.7Â±0.13ms     6.1 MB/sec    1.00      6.1Â±0.08ms     6.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.06  1436.6Â±14.27Âµs    11.6 MB/sec    1.00  1356.3Â±30.18Âµs    12.3 MB/sec
linter/default-rules/numpy/globals.py      1.03    167.4Â±2.01Âµs    17.6 MB/sec    1.00    162.4Â±4.26Âµs    18.2 MB/sec
linter/default-rules/pydantic/types.py     1.06      2.9Â±0.04ms     8.7 MB/sec    1.00      2.8Â±0.05ms     9.2 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.09      5.1Â±0.31ms     8.0 MB/sec    1.00      4.7Â±0.41ms     8.7 MB/sec
formatter/numpy/ctypeslib.py               1.05   927.6Â±35.41Âµs    18.0 MB/sec    1.00   882.6Â±50.07Âµs    18.9 MB/sec
formatter/numpy/globals.py                 1.00     89.5Â±4.45Âµs    33.0 MB/sec    1.00     89.4Â±4.89Âµs    33.0 MB/sec
formatter/pydantic/types.py                1.04  1861.9Â±71.24Âµs    13.7 MB/sec    1.00  1783.5Â±86.34Âµs    14.3 MB/sec
linter/all-rules/large/dataset.py          1.00     14.9Â±0.49ms     2.7 MB/sec    1.03     15.4Â±0.35ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.0Â±0.17ms     4.1 MB/sec    1.08      4.4Â±0.14ms     3.8 MB/sec
linter/all-rules/numpy/globals.py          1.00   531.2Â±21.23Âµs     5.6 MB/sec    1.04   554.7Â±20.82Âµs     5.3 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.7Â±0.32ms     3.3 MB/sec    1.05      8.1Â±0.28ms     3.1 MB/sec
linter/default-rules/large/dataset.py      1.02      8.1Â±0.40ms     5.0 MB/sec    1.00      8.0Â±0.39ms     5.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.04  1780.4Â±51.26Âµs     9.4 MB/sec    1.00  1716.0Â±61.20Âµs     9.7 MB/sec
linter/default-rules/numpy/globals.py      1.06   231.7Â±10.42Âµs    12.7 MB/sec    1.00    219.6Â±8.22Âµs    13.4 MB/sec
linter/default-rules/pydantic/types.py     1.03      3.8Â±0.11ms     6.8 MB/sec    1.00      3.7Â±0.13ms     7.0 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/verbatim.rs`:105 on 2023-08-11 12:15_

unfinished sentence

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/verbatim.rs`:138 on 2023-08-11 12:17_

`slice::from_ref` is neat, i could have used that :eyes:

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/verbatim.rs`:381 on 2023-08-11 12:22_

nit: 
```suggestion
                .map(Ranged::end)
                .unwrap_or(statement.end());
```

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/verbatim.rs`:411 on 2023-08-11 12:23_

nit: dedent the body

```suggestion
        if self.comments.is_empty() {
            return None;
        }
```

---

_@konstin approved on 2023-08-11 12:26_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/verbatim.rs`:41 on 2023-08-11 16:09_

Nit: include an example, showing comments before the `fmt off` that we'd want to handle here? (I follow what's going on, but it might be nice to show it visually.)

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/verbatim.rs`:181 on 2023-08-11 16:11_

Can you document each of these branches?

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/verbatim.rs`:139 on 2023-08-11 16:17_

Could it ever be the case that we're missing out on "special" formatting of some of these comments? I don't have a more precise idea of when that could happen, but just acknowledging that these are typically handled by children, and we're now intercepting and formatting them here.

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/verbatim.rs`:364 on 2023-08-11 16:22_

Nit: `if-let` for single-case match?

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/verbatim.rs`:445 on 2023-08-11 16:22_

Do you intentionally not `#[derive(Debug)]` here? (Asking for my own learning.)

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/verbatim.rs`:422 on 2023-08-11 16:31_

I wish there were a way to make this pattern clearer (find the index, split before and after, then split _at_ the index), but I'm struggling to come up with anything better.

---

_@charliermarsh approved on 2023-08-11 16:31_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/verbatim.rs`:364 on 2023-08-11 17:42_

I'll have a look. I love match because  I find it easier to reason about than `let...else` or `if let... else` and our pedantic rule annoys me a lot that forces me to rewrite the if else to a match

---

_@MichaReiser reviewed on 2023-08-11 17:42_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/verbatim.rs`:381 on 2023-08-14 10:05_

Clippy doesn't like that

```
warning: called `map(<f>).unwrap_or(<a>)` on an `Option` value. This can be done more directly by calling `map_or(<a>, <f>)` instead
   --> crates/ruff_python_formatter/src/verbatim.rs:327:23
    |
327 |               let end = comments
    |  _______________________^
328 | |                 .trailing_comments(statement)
329 | |                 .last()
330 | |                 .map(Ranged::end)
331 | |                 .unwrap_or(statement.end());
    | |___________________________________________^
    |
    = help: for further information visit https://rust-lang.github.io/rust-clippy/master/index.html#map_unwrap_or
    = note: `-W clippy::map-unwrap-or` implied by `-W clippy::pedantic`
help: use `map_or(<a>, <f>)` instead
    |
330 -                 .map(Ranged::end)
330 +                 .map_or(statement.end(), Ranged::end);
    |
```

---

_@MichaReiser reviewed on 2023-08-14 10:05_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/verbatim.rs`:445 on 2023-08-14 10:08_

Mainly because I didn't need it, it's a private type, and printing iterators is always a bit awkward. 

---

_@MichaReiser reviewed on 2023-08-14 10:08_

---

_@MichaReiser reviewed on 2023-08-14 10:11_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/verbatim.rs`:422 on 2023-08-14 10:11_

Yeah, it's a bit verbose, but that's why I introduced the iterator. I first had this code duplicated everywhere, :roll_eyes: 

---

_@MichaReiser reviewed on 2023-08-14 10:17_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/verbatim.rs`:139 on 2023-08-14 10:17_

Good catch. This could be a problem if a statement overrides `fmt_leading_comments` or `fmt_trailing_comments`. I checked, and no expression or statement overrides these methods on `FormatNodeRule`. I went ahead and inlined the functions to not give the impression that this behavior should be customized. 

Either way, I think it would be okay to format the comments with the default formatting. It may not be perfect but we're dealing with suppressed ranges anyway. 





---

_Comment by @MichaReiser on 2023-08-14 15:42_

The main reason why this PR regresses performance is because it is now necessary to look up the leading and trailing comments for every statement, and we do the same when formatting the statement. 

We could improve this by moving the leading/trailing comments formatting for statements into `suite.rs` to avoid the additional hash map lookup. We may want to do this in the future, but it isn't necessary doing right now.

---

_Merged by @MichaReiser on 2023-08-14 15:57_

---

_Closed by @MichaReiser on 2023-08-14 15:57_

---

_Branch deleted on 2023-08-14 15:57_

---
