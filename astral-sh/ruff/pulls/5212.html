<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add days-old flag to ruff clean - astral-sh/ruff #5212</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add days-old flag to ruff clean</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5212">#5212</a>
        opened by <a href="https://github.com/Thomasdezeeuw">@Thomasdezeeuw</a>
        on 2023-06-20 15:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/Thomasdezeeuw">@Thomasdezeeuw</a> on 2023-06-20 15:45</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Change the cleaning to only include files that are of a certain age.</p>
<p>Based on https://github.com/astral-sh/ruff/pull/5122.</p>
<h2>Test Plan</h2>
<p>Manually tested.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-20 16:13</div>
            <div class="timeline-body"><p>What's the use case for this flag? It seems that building the cache is pretty cheap. A user can, therefore, just clean the whole cache and rebuild it. I think what would be more useful (but probably still too rare to be useful) is to allow cleaning by package. However, that starts exposing implementation details.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-06-20 16:16</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>✅ ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      6.4±0.01ms     6.4 MB/sec    1.00      6.4±0.01ms     6.4 MB/sec
formatter/numpy/ctypeslib.py               1.01   1358.4±1.69µs    12.3 MB/sec    1.00   1340.1±7.19µs    12.4 MB/sec
formatter/numpy/globals.py                 1.01    133.5±0.18µs    22.1 MB/sec    1.00    132.4±0.42µs    22.3 MB/sec
formatter/pydantic/types.py                1.00      2.6±0.01ms     9.7 MB/sec    1.00      2.6±0.01ms     9.7 MB/sec
linter/all-rules/large/dataset.py          1.00     13.1±0.02ms     3.1 MB/sec    1.00     13.1±0.03ms     3.1 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.3±0.01ms     5.0 MB/sec    1.00      3.3±0.00ms     5.1 MB/sec
linter/all-rules/numpy/globals.py          1.01    435.2±0.30µs     6.8 MB/sec    1.00    429.3±0.42µs     6.9 MB/sec
linter/all-rules/pydantic/types.py         1.01      5.8±0.01ms     4.4 MB/sec    1.00      5.8±0.01ms     4.4 MB/sec
linter/default-rules/large/dataset.py      1.01      6.7±0.01ms     6.1 MB/sec    1.00      6.6±0.01ms     6.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01   1490.1±7.84µs    11.2 MB/sec    1.00   1472.1±2.21µs    11.3 MB/sec
linter/default-rules/numpy/globals.py      1.02    172.2±1.88µs    17.1 MB/sec    1.00   169.3±10.51µs    17.4 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.1±0.01ms     8.3 MB/sec    1.00      3.1±0.00ms     8.3 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.11      8.6±0.08ms     4.7 MB/sec    1.00      7.8±0.07ms     5.2 MB/sec
formatter/numpy/ctypeslib.py               1.08  1737.9±25.51µs     9.6 MB/sec    1.00  1602.1±21.56µs    10.4 MB/sec
formatter/numpy/globals.py                 1.07    168.5±3.03µs    17.5 MB/sec    1.00    158.0±4.92µs    18.7 MB/sec
formatter/pydantic/types.py                1.09      3.5±0.04ms     7.2 MB/sec    1.00      3.2±0.05ms     7.9 MB/sec
linter/all-rules/large/dataset.py          1.00     15.3±0.24ms     2.7 MB/sec    1.01     15.5±0.18ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.0±0.05ms     4.2 MB/sec    1.02      4.0±0.08ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.00    491.5±5.90µs     6.0 MB/sec    1.01    497.6±8.03µs     5.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.7±0.08ms     3.8 MB/sec    1.02      6.9±0.13ms     3.7 MB/sec
linter/default-rules/large/dataset.py      1.00      7.9±0.07ms     5.1 MB/sec    1.02      8.1±0.09ms     5.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1691.2±17.47µs     9.8 MB/sec    1.03  1741.8±29.70µs     9.6 MB/sec
linter/default-rules/numpy/globals.py      1.00    192.5±2.91µs    15.3 MB/sec    1.04   200.1±11.16µs    14.7 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.6±0.04ms     7.1 MB/sec    1.02      3.6±0.04ms     7.0 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Thomasdezeeuw">@Thomasdezeeuw</a> on 2023-06-21 08:10</div>
            <div class="timeline-body"><blockquote>
<p>What's the use case for this flag? It seems that building the cache is pretty cheap. A user can, therefore, just clean the whole cache and rebuild it. I think what would be more useful (but probably still too rare to be useful) is to allow cleaning by package. However, that starts exposing implementation details.</p>
</blockquote>
<p>This assumes that we switch to a global cache (https://github.com/astral-sh/ruff/pull/5122), which changes <code>ruff clean</code> to remove all caches (for all packages). For users working with multiple packages they might not want to clean the entire cache, only the unused cache file. This is to combat the general problem of the &quot;every growing cache&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-21 09:24</div>
            <div class="timeline-body"><p>I continue to be undecided whether we should move to a global cache. It seems to introduce more complexity. Anyway:</p>
<ul>
<li>I think we should change the documentation of <code>clean</code> to make it clear that, by default, removes <strong>all</strong> caches, globally. This should probably go into #5122</li>
<li>Would it make sense to instead add a flag (similar to <code>cargo -p</code>) to specify which packages to clean?</li>
</ul>
<blockquote>
<p>to combat the general problem of the &quot;every growing cache&quot;.</p>
</blockquote>
<p>My understanding was that your PR adding the <em>last seen</em> already removes old files. Does this PR address the case where a cache keeps growing after changing the settings?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Thomasdezeeuw">@Thomasdezeeuw</a> on 2023-06-23 09:26</div>
            <div class="timeline-body"><p>(I completely missed your comment)</p>
<blockquote>
<p>I continue to be undecided whether we should move to a global cache. It seems to introduce more complexity. Anyway:</p>
<pre><code>* I think we should change the documentation of `clean` to make it clear that, by default, removes **all** caches, globally. This should probably go into [Use global cache directory #5122](https://github.com/astral-sh/ruff/pull/5122)</code></pre>
</blockquote>
<p>:+1:</p>
<blockquote>
<pre><code>* Would it make sense to instead add a flag (similar to `cargo -p`) to specify which packages to clean?</code></pre>
<blockquote>
<p>to combat the general problem of the &quot;every growing cache&quot;.</p>
</blockquote>
<p>My understanding was that your PR adding the <em>last seen</em> already removes old files. Does this PR address the case where a cache keeps growing after changing the settings?</p>
</blockquote>
<p>Yes, for caches that are actually used. When/if we switch to a global cache dir removing a Python project will no longer remove Ruff's cache for it (as it's stored outside of the project's directory that is removed). This also true, to a lesser extend, for &quot;packages&quot; within the same repo, e.g. one-off files, examples and often tests. Using the current solver these are stored separately from the &quot;main&quot; source code. For example the FastAPI repo has 79 &quot;packages&quot; and thus 79 different cache files, moving the source file (e.g. an example or test) will cause the cache to be now longer used, but it won't be removed as we simple don't even look at the old cache files again.</p>
<p>A regular <code>cargo clean</code> will take of the above, but it will also wipe out still used caches. A <code>days-old</code> flag like this adding keep the useful caches, while removing only the unused cache files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Thomasdezeeuw">@Thomasdezeeuw</a> on 2023-07-04 15:17</div>
            <div class="timeline-body"><p>Since https://github.com/astral-sh/ruff/pull/5122 wasn't merged this still has some benefit, but less so. If &quot;packages&quot;, including tests, docs, scripts, etc., move within a repo this can remove the old cache where the current <code>clean</code> command simply removes everything (this assumes a single cache dir is used for the entire repo).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @MichaReiser by @MichaReiser on 2023-07-04 15:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-10 06:47</div>
            <div class="timeline-body"><blockquote>
<p>Since #5122 wasn't merged this still has some benefit, but less so. If &quot;packages&quot;, including tests, docs, scripts, etc., move within a repo this can remove the old cache where the current <code>clean</code> command simply removes everything (this assumes a single cache dir is used for the entire repo).</p>
</blockquote>
<p>I'll close this for now based on the decision of #5122. The new flag is less needed now that we keep the local cache and cleaning the whole cache of a single project and rebuilding it should only take a few seconds. Not having the flag keeps Ruff's complexity and API smaller.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-07-10 06:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-20 08:59</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:49:30 UTC
    </footer>
</body>
</html>
