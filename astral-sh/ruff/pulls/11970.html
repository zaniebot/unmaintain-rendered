<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Add more tests asserting that the VendoredFileSystem and the `VERSIONS` parser work with the vendored typeshed stubs - astral-sh/ruff #11970</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Add more tests asserting that the VendoredFileSystem and the <code>VERSIONS</code> parser work with the vendored typeshed stubs</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11970">#11970</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-06-21 14:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><ul>
<li>Assert that all modules found in the <code>vendor/typeshed</code> directory can be retrieved from the zipfile using the <code>VendoredFileSystem</code> struct.</li>
<li>Assert that all top-level modules found in <code>vendor/typeshed</code> are included in <code>VERSIONS</code></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2024-06-21 14:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2024-06-21 14:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2024-06-21 14:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/typeshed.rs</code>:40 on 2024-06-21 15:41</div>
            <div class="timeline-body"><p>We could now consider implementing <code>Default</code> where the default implementation uses the &quot;vendored&quot; files</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-06-21 15:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/typeshed.rs</code>:86 on 2024-06-21 15:42</div>
            <div class="timeline-body"><p>Nit: I think <code>Path</code> implements <code>PartialEq&lt;str&gt;</code></p>
<pre><code class="language-suggestion">            if relative_path == &quot;VERSIONS&quot; {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-06-21 15:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/typeshed.rs</code>:40 on 2024-06-21 15:44</div>
            <div class="timeline-body"><p>I think that would mean that <code>ruff_db</code> would have to depend on this crate, and I'd rather have it the other way around</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/typeshed.rs</code>:68 on 2024-06-21 15:46</div>
            <div class="timeline-body"><p>I don't mind the integration tests, but they are a bit hard to understand. For example, I'm still not a 100% if I understand the second test and I would feel terrified if the test starts failing.</p>
<p>What's nice about the test is that it is exhaustive, but the exhaustiveness adds a lot of complexity (and file iteration isn't guaranteed to always run in the same order).</p>
<p>I would probably take a shorter route and simply assert that a few selected files exist.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/typeshed.rs</code>:73 on 2024-06-21 15:46</div>
            <div class="timeline-body"><p>Nit: I would consider moving the tests closer to the implementation they're testing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-06-21 15:46</div>
            <div class="timeline-body"><p>LGTM: I would consider simplifying the tests. I don't think we need full exhaustiveness tests. Testing a few samples should be sufficient.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-06-21 15:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-06-21 15:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/typeshed.rs</code>:86 on 2024-06-21 15:51</div>
            <div class="timeline-body"><p>Compiler says no:</p>
<pre><code>error[E0277]: can't compare `std::path::Path` with `str`
  --&gt; crates/red_knot_module_resolver/src/typeshed.rs:86:30
   |
86 |             if relative_path == &quot;VERSIONS&quot; {
   |                              ^^ no implementation for `std::path::Path == str`
   |
   = help: the trait `std::cmp::PartialEq&lt;str&gt;` is not implemented for `std::path::Path`, which is required by `&amp;std::path::Path: std::cmp::PartialEq&lt;&amp;str&gt;`
   = help: the following other types implement trait `std::cmp::PartialEq&lt;Rhs&gt;`:
             &lt;&amp;'a std::path::Path as std::cmp::PartialEq&lt;camino::Utf8Path&gt;&gt;
             &lt;&amp;'a std::path::Path as std::cmp::PartialEq&lt;camino::Utf8PathBuf&gt;&gt;
             &lt;&amp;'a std::path::Path as std::cmp::PartialEq&lt;std::borrow::Cow&lt;'b, std::ffi::OsStr&gt;&gt;&gt;
             &lt;&amp;'a std::path::Path as std::cmp::PartialEq&lt;std::ffi::OsStr&gt;&gt;
             &lt;&amp;'a std::path::Path as std::cmp::PartialEq&lt;std::ffi::OsString&gt;&gt;
             &lt;&amp;'a std::path::Path as std::cmp::PartialEq&lt;std::path::PathBuf&gt;&gt;
             &lt;&amp;'b std::path::Path as std::cmp::PartialEq&lt;std::borrow::Cow&lt;'a, std::path::Path&gt;&gt;&gt;
             &lt;std::path::Path as std::cmp::PartialEq&lt;&amp;'a camino::Utf8Path&gt;&gt;
           and 9 others
   = note: required for `&amp;std::path::Path` to implement `std::cmp::PartialEq&lt;&amp;str&gt;`
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-06-21 16:08</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+1 -0 violations, +0 -0 fixes in 1 projects; 49 projects unchanged)</p>
<details><summary><a href="https://github.com/PlasmaPy/PlasmaPy">PlasmaPy/PlasmaPy</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>

<pre>
+ <a href='https://github.com/PlasmaPy/PlasmaPy/blob/5a8c3d5efd45b197601a88d7c27569b6c466a48b/src/plasmapy/diagnostics/langmuir.py#L1396'>src/plasmapy/diagnostics/langmuir.py:1396:23:</a> NPY201 `np.trapz` will be removed in NumPy 2.0. Use `numpy.trapezoid` on NumPy 2.0, or ignore this warning on earlier versions.
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| NPY201 | 1 | 1 | 0 | 0 | 0 |</p>
</p>
</details>

<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+1 -0 violations, +0 -0 fixes in 1 projects; 49 projects unchanged)</p>
<details><summary><a href="https://github.com/PlasmaPy/PlasmaPy">PlasmaPy/PlasmaPy</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/PlasmaPy/PlasmaPy/blob/5a8c3d5efd45b197601a88d7c27569b6c466a48b/src/plasmapy/diagnostics/langmuir.py#L1396'>src/plasmapy/diagnostics/langmuir.py:1396:23:</a> NPY201 `np.trapz` will be removed in NumPy 2.0. Use `numpy.trapezoid` on NumPy 2.0, or ignore this warning on earlier versions.
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| NPY201 | 1 | 1 | 0 | 0 | 0 |</p>
</p>
</details>

<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-06-21 16:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/typeshed.rs</code>:40 on 2024-06-21 16:13</div>
            <div class="timeline-body"><p>ah right that's true.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-06-21 16:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/typeshed.rs</code>:68 on 2024-06-21 16:31</div>
            <div class="timeline-body"><p>Thanks. I would much rather be exhaustive here, I think. I've gone through and added custom error messages to each <code>unwrap()</code> and <code>assert()</code> call, so that it's clear exactly which invariant is being asserted at each stage, and so that it should be less terrifying to debug a test if one of the assertions starts failing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2024-06-21 16:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-06-21 16:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-06-21 16:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-06-21 16:53</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/typeshed-validation">CodSpeed Performance Report</a></h2>
<h3>Merging #11970 will <strong>improve performances by 5.07%</strong></h3>
<p><sub>Comparing <code>typeshed-validation</code> (613a9bb) with <code>typeshed-validation</code> (8b3f05f)</sub></p>
<h3>Summary</h3>
<p><code>⚡ 1</code> improvements
<code>✅ 29</code> untouched benchmarks</p>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>typeshed-validation</code> | <code>typeshed-validation</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ⚡ | <code>linter/default-rules[pydantic/types.py]</code> | 1.9 ms | 1.8 ms | +5.07% |</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:04:56 UTC
    </footer>
</body>
</html>
