<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Make noqa parsing consistent and more robust - astral-sh/ruff #16483</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Make noqa parsing consistent and more robust</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16483">#16483</a>
        opened by <a href="https://github.com/dylwil3">@dylwil3</a>
        on 2025-03-03 21:31
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-03-03 21:31</div>
            <div class="timeline-body"><h1>Summary</h1>
<p>The goal of this PR is to address various issues around parsing suppression comments by</p>
<ol>
<li>Unifying the logic used to parse in-line (<code># noqa</code>) and file-level (<code># ruff: noqa</code>) noqa comments</li>
<li>Recovering from certain errors and surfacing warnings in these cases</li>
</ol>
<p>Closes #15682
Supersedes #12811
Addresses https://github.com/astral-sh/ruff/pull/14229#discussion_r1835481018
Related: #14229 , #12809</p>
<hr />
<h1>Current suppression behavior</h1>
<p>The implementations for parsing in-line and file-level noqa comments are entirely separate, so a number of discrepancies have arisen. You can unfurl some examples of this below.</p>
<details>
   <summary> Examples of discrepancies </summary>

<h2>Leading Hashes</h2>
<p>This works:</p>
<pre><code class="language-python">from typing import List ## noqa: UP035
</code></pre>
<p>This does not, and emits no warning:</p>
<pre><code class="language-python">from typing import List
## ruff: noqa: UP035
</code></pre>
<h2>Missing colon</h2>
<p>This silently ignores <em>all</em> rules on the line, even though
the user intended a single rule to be ignored:</p>
<pre><code class="language-python">from typing import List # noqa UP035
</code></pre>
<p>This prints a warning and does not suppress anything:</p>
<pre><code class="language-python">from typing import List 
# ruff: noqa UP035
</code></pre>
<h2>Missing Delimiter</h2>
<p>This works to suppress both violations:</p>
<pre><code class="language-python">from typing import List # noqa: UP035F401
</code></pre>
<p>This warns and suppresses neither:</p>
<pre><code class="language-python">from typing import List 
#ruff: noqa: UP035F401
</code></pre>
<h2>Multiple Commas</h2>
<p>This works to suppress both violations:</p>
<pre><code class="language-python">from typing import List #noqa: UP035,,,F401
</code></pre>
<p>This suppresses the first but not the second.
It does not emit a warning:</p>
<pre><code class="language-python">from typing import List 
#ruff:noqa: UP035,,,F401
</code></pre>
<h2>Missing whitespace before additional comments</h2>
<p>This works:</p>
<pre><code class="language-python">from typing import List #noqa: UP035abc
</code></pre>
<p>This warns and does nothing:</p>
<pre><code class="language-python">from typing import List 
#ruff:noqa: UP035abc
</code></pre>
<h2>Additional comments after noqa</h2>
<p>This works:</p>
<pre><code class="language-python">from typing import List #noqa: UP035 and more comments
</code></pre>
<p>And so does this:</p>
<pre><code class="language-python">from typing import List #noqa and more comments
</code></pre>
<p>And so does this:</p>
<pre><code class="language-python">from typing import List 
#ruff: noqa: UP035 and more comments
</code></pre>
<p>But this emits a warning and suppresses nothing:</p>
<pre><code class="language-python">from typing import List 
#ruff:noqa and more comments
</code></pre>
</details>

<h1>Design</h1>
<p>The specification for the unified parsing logic is as follows:</p>
<ol>
<li>A suppression comment must be contained in a comment range and begins with a prefix matching one of the following regexes:</li>
</ol>
<ul>
<li>(file level) <code>#\s*(?:ruff|flake8)\s*:\s*(?i)noqa</code></li>
<li>(inline) <code>#\s*(?i)noqa</code></li>
</ul>
<ol start="2">
<li>If the character following the <code>noqa</code> is <code>'#'</code>, whitespace, or if there are no characters following, then the suppression comment suppressed <em>all</em> rules. If the character following is <code>&quot;:&quot;</code>, proceed to (3). Otherwise, warn the user for <code>InvalidSuffix</code>.</li>
<li>We expect a list of rule codes, separated by commas or whitespace. After splitting first on commas, and then on whitespace, we attempt to parse each item in turn. If parsing a nonempty item returns no rule codes, we stop. If no codes were found at all we warn the user with <code>MissingCodes</code>.</li>
<li>A rule code is a match for the regex <code>[A-Z]+[0-9]+</code>. While it is expected that there is one rule code per item, parsing continues even if that is not true, (e.g., <code>F401F841</code> or <code>F401,,F841</code>), and the user is warned of a <code>MissingDelimiter</code> or <code>MissingItem</code>. If an item does not consist entirely of codes (e.g. <code>F401abc</code>), parsing aborts with an error and the user is warned of an <code>InvalidCodeSuffix</code> - the exception is if we encounter <code>#</code>, in which case parsing stops and returns all codes collected to that point (e.g. <code># noqa: F401#comment</code>).</li>
</ol>
<h1>Implementation</h1>
<p>After trimming the prefix for a file-level or inline noqa, the remaining text is passed to a lexer in the style of <code>SimpleTokenizer</code>. There is some small logic to &quot;recover&quot; in the case of missing delimiters or missing items.</p>
<h1>Other changes and affected rules/behavior</h1>
<p>The only rules that appear to be affected are <a href="https://docs.astral.sh/ruff/rules/blanket-noqa/#blanket-noqa-pgh004">blanket-noqa (PGH004)</a>) and <a href="https://docs.astral.sh/ruff/rules/unused-noqa/#unused-noqa-ruf100">unused-noqa (RUF100)</a> (but we'll see if others come up in the ecosystem check). For example, we no longer parse the first code in <code># noqa F401.F841</code> and instead emit a warning, which changes one of the snapshots for <code>RUF100</code>.</p>
<p>Internally, we no longer distinguish between a <code>Directive</code> and a <code>ParsedFileExemption</code> (keeping just the former), since these were used almost identically. They are carried around inside of <code>NoqaDirectiveLine</code> and <code>FileNoqaDirectedLine</code>, respectively, so there is little risk in misunderstanding the context if we just use <code>Directive</code> in both cases.</p>
<h1>Review</h1>
<p>After responding to comments it may no longer be helpful to proceed commit by commit. However, to see changes in behavior it may be best to view the diff against the first commit rather than main, since it contains a few additional snapshots.</p>
<h1>Miscellaneous comments</h1>
<ul>
<li>If folks think there are natural boundaries to do so, I'm happy to break this up into smaller PRs.</li>
<li>Maybe @InSyncWithFoo and @koxudaxi would be interested in looking over at least the design spec here, given https://github.com/astral-sh/ruff/pull/14229#discussion_r1835481018?</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">breaking</span> added by @dylwil3 on 2025-03-03 21:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">suppression</span> added by @dylwil3 on 2025-03-03 21:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">do-not-merge</span> added by @dylwil3 on 2025-03-03 21:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "v0.10" by @dylwil3 on 2025-03-03 21:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-03-03 21:36</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_INSTRUMENTATION_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/dylwil3%3Anoqa-parsing">CodSpeed Performance Report</a></h2>
<h3>Merging #16483 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>dylwil3:noqa-parsing</code> (ae39f61) with <code>micha/ruff-0.10</code> (41cd905)</sub></p>
<h3>Summary</h3>
<p><code>✅ 32</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-03-03 21:38</div>
            <div class="timeline-body"><p>Oh jeez! Well that performance regression is no good. I'd still welcome thoughts on the &quot;design spec&quot; and I'll work on improving the implementation in the meantime. Converting to draft for now...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @dylwil3 on 2025-03-03 21:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-03 21:42</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+0 -66 violations, +0 -0 fixes in 1 projects; 54 projects unchanged)</p>
<details><summary><a href="https://github.com/qdrant/qdrant-client">qdrant/qdrant-client</a> (+0 -66 violations, +0 -0 fixes)</summary>
<p>

<pre>
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/aliases_api.py#L52'>qdrant_client/http/api/aliases_api.py:52:54:</a> F405 `AsyncApiClient` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/aliases_api.py#L5'>qdrant_client/http/api/aliases_api.py:5:27:</a> F811 Redefinition of unused `BaseModel` from line 4
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/aliases_api.py#L7'>qdrant_client/http/api/aliases_api.py:7:1:</a> F403 `from qdrant_client.http.models import *` used; unable to detect undefined names
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/beta_api.py#L51'>qdrant_client/http/api/beta_api.py:51:54:</a> F405 `AsyncApiClient` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/beta_api.py#L5'>qdrant_client/http/api/beta_api.py:5:27:</a> F811 Redefinition of unused `BaseModel` from line 4
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/beta_api.py#L7'>qdrant_client/http/api/beta_api.py:7:1:</a> F403 `from qdrant_client.http.models import *` used; unable to detect undefined names
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/collections_api.py#L52'>qdrant_client/http/api/collections_api.py:52:54:</a> F405 `AsyncApiClient` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/collections_api.py#L5'>qdrant_client/http/api/collections_api.py:5:27:</a> F811 Redefinition of unused `BaseModel` from line 4
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/collections_api.py#L7'>qdrant_client/http/api/collections_api.py:7:1:</a> F403 `from qdrant_client.http.models import *` used; unable to detect undefined names
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/distributed_api.py#L52'>qdrant_client/http/api/distributed_api.py:52:54:</a> F405 `AsyncApiClient` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/distributed_api.py#L5'>qdrant_client/http/api/distributed_api.py:5:27:</a> F811 Redefinition of unused `BaseModel` from line 4
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/distributed_api.py#L7'>qdrant_client/http/api/distributed_api.py:7:1:</a> F403 `from qdrant_client.http.models import *` used; unable to detect undefined names
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/indexes_api.py#L126'>qdrant_client/http/api/indexes_api.py:126:19:</a> F405 `WriteOrdering` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/indexes_api.py#L144'>qdrant_client/http/api/indexes_api.py:144:19:</a> F405 `WriteOrdering` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/indexes_api.py#L162'>qdrant_client/http/api/indexes_api.py:162:19:</a> F405 `WriteOrdering` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/indexes_api.py#L180'>qdrant_client/http/api/indexes_api.py:180:19:</a> F405 `WriteOrdering` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/indexes_api.py#L52'>qdrant_client/http/api/indexes_api.py:52:54:</a> F405 `AsyncApiClient` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/indexes_api.py#L59'>qdrant_client/http/api/indexes_api.py:59:19:</a> F405 `WriteOrdering` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/indexes_api.py#L5'>qdrant_client/http/api/indexes_api.py:5:27:</a> F811 Redefinition of unused `BaseModel` from line 4
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/indexes_api.py#L7'>qdrant_client/http/api/indexes_api.py:7:1:</a> F403 `from qdrant_client.http.models import *` used; unable to detect undefined names
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/indexes_api.py#L94'>qdrant_client/http/api/indexes_api.py:94:19:</a> F405 `WriteOrdering` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/points_api.py#L158'>qdrant_client/http/api/points_api.py:158:19:</a> F405 `WriteOrdering` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/points_api.py#L192'>qdrant_client/http/api/points_api.py:192:19:</a> F405 `WriteOrdering` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/points_api.py#L226'>qdrant_client/http/api/points_api.py:226:19:</a> F405 `WriteOrdering` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/points_api.py#L356'>qdrant_client/http/api/points_api.py:356:19:</a> F405 `WriteOrdering` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/points_api.py#L424'>qdrant_client/http/api/points_api.py:424:19:</a> F405 `WriteOrdering` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/points_api.py#L458'>qdrant_client/http/api/points_api.py:458:19:</a> F405 `WriteOrdering` may be undefined, or defined from star imports
... 32 additional changes omitted for rule F405
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/points_api.py#L5'>qdrant_client/http/api/points_api.py:5:27:</a> F811 Redefinition of unused `BaseModel` from line 4
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/points_api.py#L7'>qdrant_client/http/api/points_api.py:7:1:</a> F403 `from qdrant_client.http.models import *` used; unable to detect undefined names
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/search_api.py#L5'>qdrant_client/http/api/search_api.py:5:27:</a> F811 Redefinition of unused `BaseModel` from line 4
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/search_api.py#L7'>qdrant_client/http/api/search_api.py:7:1:</a> F403 `from qdrant_client.http.models import *` used; unable to detect undefined names
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/service_api.py#L5'>qdrant_client/http/api/service_api.py:5:27:</a> F811 Redefinition of unused `BaseModel` from line 4
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/service_api.py#L7'>qdrant_client/http/api/service_api.py:7:1:</a> F403 `from qdrant_client.http.models import *` used; unable to detect undefined names
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/snapshots_api.py#L5'>qdrant_client/http/api/snapshots_api.py:5:27:</a> F811 Redefinition of unused `BaseModel` from line 4
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/snapshots_api.py#L7'>qdrant_client/http/api/snapshots_api.py:7:1:</a> F403 `from qdrant_client.http.models import *` used; unable to detect undefined names
... 31 additional changes omitted for project
</pre>

</p>
</details>
<details><summary>Changes by rule (3 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| F405 | 48 | 0 | 48 | 0 | 0 |
| F811 | 9 | 0 | 9 | 0 | 0 |
| F403 | 9 | 0 | 9 | 0 | 0 |</p>
</p>
</details>

<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+0 -66 violations, +0 -0 fixes in 1 projects; 54 projects unchanged)</p>
<details><summary><a href="https://github.com/qdrant/qdrant-client">qdrant/qdrant-client</a> (+0 -66 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/aliases_api.py#L52'>qdrant_client/http/api/aliases_api.py:52:54:</a> F405 `AsyncApiClient` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/aliases_api.py#L5'>qdrant_client/http/api/aliases_api.py:5:27:</a> F811 Redefinition of unused `BaseModel` from line 4
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/aliases_api.py#L7'>qdrant_client/http/api/aliases_api.py:7:1:</a> F403 `from qdrant_client.http.models import *` used; unable to detect undefined names
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/beta_api.py#L51'>qdrant_client/http/api/beta_api.py:51:54:</a> F405 `AsyncApiClient` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/beta_api.py#L5'>qdrant_client/http/api/beta_api.py:5:27:</a> F811 Redefinition of unused `BaseModel` from line 4
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/beta_api.py#L7'>qdrant_client/http/api/beta_api.py:7:1:</a> F403 `from qdrant_client.http.models import *` used; unable to detect undefined names
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/collections_api.py#L52'>qdrant_client/http/api/collections_api.py:52:54:</a> F405 `AsyncApiClient` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/collections_api.py#L5'>qdrant_client/http/api/collections_api.py:5:27:</a> F811 Redefinition of unused `BaseModel` from line 4
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/collections_api.py#L7'>qdrant_client/http/api/collections_api.py:7:1:</a> F403 `from qdrant_client.http.models import *` used; unable to detect undefined names
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/distributed_api.py#L52'>qdrant_client/http/api/distributed_api.py:52:54:</a> F405 `AsyncApiClient` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/distributed_api.py#L5'>qdrant_client/http/api/distributed_api.py:5:27:</a> F811 Redefinition of unused `BaseModel` from line 4
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/distributed_api.py#L7'>qdrant_client/http/api/distributed_api.py:7:1:</a> F403 `from qdrant_client.http.models import *` used; unable to detect undefined names
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/indexes_api.py#L126'>qdrant_client/http/api/indexes_api.py:126:19:</a> F405 `WriteOrdering` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/indexes_api.py#L144'>qdrant_client/http/api/indexes_api.py:144:19:</a> F405 `WriteOrdering` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/indexes_api.py#L162'>qdrant_client/http/api/indexes_api.py:162:19:</a> F405 `WriteOrdering` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/indexes_api.py#L180'>qdrant_client/http/api/indexes_api.py:180:19:</a> F405 `WriteOrdering` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/indexes_api.py#L52'>qdrant_client/http/api/indexes_api.py:52:54:</a> F405 `AsyncApiClient` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/indexes_api.py#L59'>qdrant_client/http/api/indexes_api.py:59:19:</a> F405 `WriteOrdering` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/indexes_api.py#L5'>qdrant_client/http/api/indexes_api.py:5:27:</a> F811 Redefinition of unused `BaseModel` from line 4
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/indexes_api.py#L7'>qdrant_client/http/api/indexes_api.py:7:1:</a> F403 `from qdrant_client.http.models import *` used; unable to detect undefined names
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/indexes_api.py#L94'>qdrant_client/http/api/indexes_api.py:94:19:</a> F405 `WriteOrdering` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/points_api.py#L158'>qdrant_client/http/api/points_api.py:158:19:</a> F405 `WriteOrdering` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/points_api.py#L192'>qdrant_client/http/api/points_api.py:192:19:</a> F405 `WriteOrdering` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/points_api.py#L226'>qdrant_client/http/api/points_api.py:226:19:</a> F405 `WriteOrdering` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/points_api.py#L356'>qdrant_client/http/api/points_api.py:356:19:</a> F405 `WriteOrdering` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/points_api.py#L424'>qdrant_client/http/api/points_api.py:424:19:</a> F405 `WriteOrdering` may be undefined, or defined from star imports
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/points_api.py#L458'>qdrant_client/http/api/points_api.py:458:19:</a> F405 `WriteOrdering` may be undefined, or defined from star imports
... 32 additional changes omitted for rule F405
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/points_api.py#L5'>qdrant_client/http/api/points_api.py:5:27:</a> F811 Redefinition of unused `BaseModel` from line 4
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/points_api.py#L7'>qdrant_client/http/api/points_api.py:7:1:</a> F403 `from qdrant_client.http.models import *` used; unable to detect undefined names
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/search_api.py#L5'>qdrant_client/http/api/search_api.py:5:27:</a> F811 Redefinition of unused `BaseModel` from line 4
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/search_api.py#L7'>qdrant_client/http/api/search_api.py:7:1:</a> F403 `from qdrant_client.http.models import *` used; unable to detect undefined names
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/service_api.py#L5'>qdrant_client/http/api/service_api.py:5:27:</a> F811 Redefinition of unused `BaseModel` from line 4
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/service_api.py#L7'>qdrant_client/http/api/service_api.py:7:1:</a> F403 `from qdrant_client.http.models import *` used; unable to detect undefined names
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/snapshots_api.py#L5'>qdrant_client/http/api/snapshots_api.py:5:27:</a> F811 Redefinition of unused `BaseModel` from line 4
- <a href='https://github.com/qdrant/qdrant-client/blob/eaee466fca445acff9b54e555b4fce3ef2a0f108/qdrant_client/http/api/snapshots_api.py#L7'>qdrant_client/http/api/snapshots_api.py:7:1:</a> F403 `from qdrant_client.http.models import *` used; unable to detect undefined names
... 31 additional changes omitted for project
</pre>

</p>
</details>
<details><summary>Changes by rule (3 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| F405 | 48 | 0 | 48 | 0 | 0 |
| F811 | 9 | 0 | 9 | 0 | 0 |
| F403 | 9 | 0 | 9 | 0 | 0 |</p>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-03-03 23:25</div>
            <div class="timeline-body"><p>@dylwil3 <code>\r</code> is actually not allowed in a comment, since it signifies the end of that physical line (same as <code>\n</code> and <code>\r\n</code>) and thus also the end of the comment.</p>
<p>Additionally, the original implementation uses <a href="https://doc.rust-lang.org/std/primitive.char.html#method.is_whitespace"><code>char.is_whitespace()</code></a>, which allows non-ASCII whitespace characters as well. In #12809, I argued that only tabs and spaces should be allowed (and I would do so again), but Charlie thought Ruff should be more permissive in that regard.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-03-03 23:45</div>
            <div class="timeline-body"><blockquote>
<p>@dylwil3 <code>\r</code> is actually not allowed in a comment, since it signifies the end of that physical line (same as <code>\n</code> and <code>\r\n</code>) and thus also the end of the comment.</p>
<p>Additionally, the original implementation uses <a href="https://doc.rust-lang.org/std/primitive.char.html#method.is_whitespace"><code>char.is_whitespace()</code></a>, which allows non-ASCII whitespace characters as well. In #12809, I argued that only tabs and spaces should be allowed (and I would do so again), but Charlie thought Ruff should be more permissive in that regard.</p>
</blockquote>
<p>Yeah, I tried removing disallowed whitespace as well and I don't think it makes a difference. I think the regex is too heavy to compete with the manual approach for this simple of a pattern.</p>
<p>I sort of agree regarding ascii whitespace, and I do like that the regex is a little more self documenting... I'm torn.</p>
<p>I'll try re-implementing the manual approach tomorrow and see if it's worth it - I can always mention the regex we're implementing in the doc-comment even if it's not used directly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-03-04 14:05</div>
            <div class="timeline-body"><p>Okay, performance fixed by reverting to manually implementing regex (now at least the file exemption and in-line cases are handled in visibly the same way).</p>
<p>I think the ecosystem check is actually correct, and is one of the changes in behavior consistent with the design: We are now allowing comments <em>after</em> a file-level exemption like: <code># ruff: noqa This is a bad file don't lint it</code>. Therefore, in the same way that <code># noqa F401</code> is a probable typo that suppresses <em>all</em> rules, so too does <code># ruff: noqa F401</code> suppress <em>all</em> rules. This mistake is caught by <a href="https://docs.astral.sh/ruff/rules/blanket-noqa/#blanket-noqa-pgh004">blanket-noqa (PGH004)</a> (in preview).</p>
<p>As an aside: It'd be nice if there were a not-too-complex way to alert users to the footgun <code># noqa F401</code> without them turning on <code>PGH004</code> (since it's not a default rule). Maybe <code>RUF100</code> could handle this (not a default but I think somewhat more popular)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dylwil3 on 2025-03-04 14:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-04 14:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:346 on 2025-03-04 14:32</div>
            <div class="timeline-body"><p>Before I review this in detail. Have you considered using <code>Cursor</code>. I find that it can help simplify a lot of those basic <em>if it's this character, eat it</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-03-04 15:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/noqa.rs</code>:346 on 2025-03-04 15:18</div>
            <div class="timeline-body"><p>Sounds like a good idea! I'll check it out. Feel free to review the design (e.g. the tests and snapshots) independently of the implementation, since the former may result in changes in the latter anyway. You can also hold off on both while I look into <code>Cursor</code> - whatever is most convenient!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-04 15:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:346 on 2025-03-04 15:20</div>
            <div class="timeline-body"><p>I think I'll wait. Reviewing PRs of this size take a lot of time</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-04 15:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:346 on 2025-03-04 15:21</div>
            <div class="timeline-body"><p>But I can do specific parts if you have something that you'd like to get early feedback</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-03-07 00:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/noqa.rs</code>:346 on 2025-03-07 00:40</div>
            <div class="timeline-body"><p>Thanks so much for the suggestion to use <code>Cursor</code>! The implementation is now much simpler and hopefully easier to read/review.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-03-07 01:03</div>
            <div class="timeline-body"><p>Looks like ecosystem check revealed a few small issues - again reverting to draft briefly</p>
<p>Update: Fixed!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @dylwil3 on 2025-03-07 01:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dylwil3 on 2025-03-07 01:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-07 10:30</div>
            <div class="timeline-body"><p>Hmm, I don't understand the ecosystem results. Are we now ignoring the code for file level suppressions?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-07 10:36</div>
            <div class="timeline-body"><p>For reference, the related PRs in Red Knot are https://github.com/astral-sh/ruff/pull/15046, https://github.com/astral-sh/ruff/pull/15078, and https://github.com/astral-sh/ruff/pull/15081</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:126 on 2025-03-07 10:41</div>
            <div class="timeline-body"><p>I wasn't aware that Ruff sometimes tests if a rule is ignored at a specific location similar to how it is done in Red Knot. I assumed it only filters out diagnostics at the very end.</p>
<p>I don't know if this would be a large change but it seems we now have multiple places where we lex noqa comments. Would it make more sense to analyze all comments once and extract all suppression comments (see linked Red Knot issues). Looking up if a rule is ignored would then be simplified to searching for a suppression comment for that line (or range), which should require fewer binary search steps than searching all comments. Emitting errors should then be as simple as iterating over all suppression comments and emitting errors for the incorrect once.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:245 on 2025-03-07 10:44</div>
            <div class="timeline-body"><p>I'm leaning towards moving the message into <code>LexicalWarning</code>. It's otherwise very easy to forget changing the message here when adding a new variant.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:331 on 2025-03-07 10:47</div>
            <div class="timeline-body"><p>And everywhere else where you used <code>TextSize::try_from</code> on a <code>&amp;str</code> or <code>char</code></p>
<pre><code class="language-suggestion">        let comment_start = before_noqa.text_len() - '#'.text_len();
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:329 on 2025-03-07 10:51</div>
            <div class="timeline-body"><p>I find this code hard to read because we first search for <code>n</code> or <code>N</code> and then go back to the <code>#</code>. This complicates the offset calculations by a fair amount. For example, what I'm not a 100% sure is if the offset calculations correctly account for any whitespace that was removed by <code>trim_end</code>. It probably does but I find it hard to tell.</p>
<p>Would it be easier to find all <code>#</code> tokens, trim the start after the <code>#</code> and then test if what comes after is a noqa comment? This has the advantage that all operations are from left to right.
Not that it will make a significant performance difference, but jumping forward and backwards when doing memory lookups is bad for performance because it makes it harder for the CPU to predict which memory address you'll lookup next and is worth loading into the L1 or L2 cache.</p>
<p>For example, we could rewrite this to (using <code>Cursor</code>) and remove all manual offset calculations</p>
<pre><code class="language-rust">    let line = &amp;source[comment_range];
    let offset = comment_range.start();

    let mut cursor = Cursor::new(line);

    while !cursor.is_eof() {
        // Skip over any leading content.
        cursor.eat_while(|c| c != '#');

        let comment_start = cursor.token_len();

        if !cursor.eat_char('#') {
            continue;
        }

        // Skip over any whitespace
        cursor.eat_while(|c| c.is_whitespace());

        if !is_noqa_at_position(cursor.as_str(), 0) {
            continue;
        }

        for _ in 0..&quot;noqa&quot;.len() {
            cursor.bump();
        }

        let noqa_end = cursor.token_len();

        let lexer = NoqaLexer::new(
            source,
            TextRange::new(offset + noqa_end, comment_range.end()),
        );

        return Ok(Some(lexer.lex(offset + comment_start)?));
    }

    Ok(None)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:344 on 2025-03-07 10:54</div>
            <div class="timeline-body"><p>Is this spelling correct?</p>
<pre><code class="language-suggestion">/// Lexes file-level exemption comment, e.g. `# ruff: noqa: F401`
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:345 on 2025-03-07 10:55</div>
            <div class="timeline-body"><p>Can you verify whether <code>pub(crate)</code> is needed or if we can reduce the visiblity to private?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:355 on 2025-03-07 10:56</div>
            <div class="timeline-body"><p>Same as for the other lexing function: I'd find it easier to reason about if the entire lexing only went from left to right and doesn't navigate both left and right.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-03-07 11:10</div>
            <div class="timeline-body"><blockquote>
<p>Hmm, I don't understand the ecosystem results. Are we now ignoring the code for file level suppressions?</p>
</blockquote>
<p>There is a missing colon, it should be</p>
<pre><code class="language-diff">- # flake8: noqa E501
+ # flake8: noqa: E501
</code></pre>
<p>See the comment above https://github.com/astral-sh/ruff/pull/16483#issuecomment-2697739241</p>
<p>Note this is now consistent with what we have always done for inline <code>noqa</code> comments, i.e. <code># noqa E501</code> suppresses all rules on the line while <code># noqa: E501</code> just suppresses <code>E501</code>.</p>
<p>We could instead allow this &quot;syntax error&quot; and merge in the logic used in the rule <a href="https://docs.astral.sh/ruff/rules/blanket-noqa/#blanket-noqa-pgh004">blanket-noqa (PGH004)</a>, but that seemed like a larger change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:338 on 2025-03-07 11:13</div>
            <div class="timeline-body"><p>What's the reason that we return the first code here instead of collecting all? Do we not support <code># noqa: RUF100 # noqa: RUF101</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:466 on 2025-03-07 11:14</div>
            <div class="timeline-body"><p>It's not clear to me why we'd return <code>All</code> if the lexer is at a whitespace. What if we have <code># noqa:        RUF100</code>? Would that return <code>All</code>?</p>
<p>Should this use <code>is_whitespace</code> similar to how you use <code>trim_end</code> in other places?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:482 on 2025-03-07 11:15</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        if !self.cursor.eat(':') {
            return Err(LexicalError::InvalidSuffix);
        }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:483 on 2025-03-07 11:17</div>
            <div class="timeline-body"><p>Although I'd probably rewrite this entire section to</p>
<pre><code class="language-suggestion">        match self.cursor.bump() {
            Some('#') =&gt; {
                // We reached another nested `noqa` comment
                return Ok(NoqaLexerOutput {
                    warnings: self.warnings,
                    directive: Directive::All(All {
                        range: TextRange::new(comment_start, self.offset),
                    }),
                });
            }
            // Comment without a code
            None =&gt; {
                return Ok(NoqaLexerOutput {
                    warnings: self.warnings,
                    directive: Directive::All(All {
                        range: TextRange::new(comment_start, self.offset),
                    }),
                });
            }
            c if c.is_whitespace() =&gt; {
                // Unclear
            }
            ':' =&gt; {
                self.lex_codes()?;
            }
            _ =&gt; {
                return Err(LexicalError::InvaildSufix)
            }
        }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:465 on 2025-03-07 11:20</div>
            <div class="timeline-body"><p>It seems a bit strange to me that we pass the <code>comment_start</code> here.</p>
<p>Overall, I suspect that having a single lexing function that tries to lex a <code>noqa</code> or a file excemption and the codes might be simpler. It would also allow us to emit a specific error message if we find a file level excemption code as an inlien code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:508 on 2025-03-07 11:21</div>
            <div class="timeline-body"><p>Nit: I prefer to always use <code>bump</code> because it ensures that:</p>
<p>a) The lexer always progresses
b) It handles the EOF case</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:520 on 2025-03-07 11:22</div>
            <div class="timeline-body"><p>I would probably move this out of the match:</p>
<pre><code>// Skip over whitespace
let has_whitespace = self.cursor.eat_while(|c| c.is_whitespace());

if has_whitespace {
    if self.cursor.eat_char(',') {
        self.warnings.push(MissingItem...)
    }
}

match self.cursor.bump() {

}

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:533 on 2025-03-07 11:24</div>
            <div class="timeline-body"><pre><code class="language-suggestion">                if !self.cursor.eat_if(|c| c.is_ascii_digit()) {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:567 on 2025-03-07 11:24</div>
            <div class="timeline-body"><p>Nit: Use <code>bump</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:600 on 2025-03-07 11:27</div>
            <div class="timeline-body"><p>Should this push an error, considering that it isn't a valid code?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-07 11:30</div>
            <div class="timeline-body"><p>Thanks for looking into this.</p>
<p>I've some smaller nit comments that I think will improve readability (and fewer offset calculations!).</p>
<p>My main design question are:</p>
<ul>
<li>I find it hard to reason about the 3 different lexing methods and how they interact together. I wonder if we should have a single <code>NoqaLexer</code> that does the lexing for the entire comment instead. It may have helper methods similar to <code>lex_code</code> or <code>lex_codes</code> to split the logic but we avoid constructing multiple <code>Cursor</code>s.</li>
<li>whether it would make sense to parse all suppression comments eagerly and collect them into a <code>Vec&lt;SuppressionComment&gt;</code> similar to what we do in Red Knot.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-03-07 12:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/noqa.rs</code>:466 on 2025-03-07 12:43</div>
            <div class="timeline-body"><p>Here our cursor starts at the end of the <code>noqa</code>, so in your example it would be at the <code>':'</code> not the whitespace. The idea for the whitespace is to support having a trailing comment after an <code>All</code> suppresion, like: <code># noqa This line is so bad don't look at it</code></p>
<p>And I agree it should be <code>is_whitespace</code>, good catch!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-03-07 12:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/noqa.rs</code>:600 on 2025-03-07 12:52</div>
            <div class="timeline-body"><p>I don't think so - the first &quot;invalid code&quot; is usually the beginning of a comment, so we just abort. Like:</p>
<pre><code class="language-text"># noqa: F401 we import this for a reason
             ^ ---- this would hit that match arm 
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-03-07 12:59</div>
            <div class="timeline-body"><p>Thanks Micha, for the detailed review and correcting my rookie <code>Cursor</code> usage 😄 !</p>
<p>I agree that incorporating the prefix stripping into the lexer and keeping everything going from left to right would be easier to reason about - I hadn't done this because I thought there was some performance reason for the approach that was already present in the code. But I'll give it a try!</p>
<p>I like the idea of parsing the suppression comments eagerly, but I wonder if that should be a follow-up PR. I would have to think about when we parse them and where we store them; I'll have to check out what you've set up in Red Knot and see if the same thing works here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-07 13:30</div>
            <div class="timeline-body"><blockquote>
<p>I like the idea of parsing the suppression comments eagerly, but I wonder if that should be a follow-up PR. I would have to think about when we parse them and where we store them; I'll have to check out what you've set up in Red Knot and see if the same thing works here.</p>
</blockquote>
<p>I'm okay with that. Also considering that this should go into 0.10</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-03-07 15:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/noqa.rs</code>:338 on 2025-03-07 15:33</div>
            <div class="timeline-body"><p>We don't currently support that: <a href="https://play.ruff.rs/bb6dabe0-2d74-48af-a7f9-4a541ebb3d5b">Playground link</a></p>
<p>But I'm not opposed to it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-03-07 19:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/noqa.rs</code>:567 on 2025-03-07 19:02</div>
            <div class="timeline-body"><p>I don't think I can here - if the upcoming character is uppercase, then I want to leave it unconsumed until I lex the next code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/noqa.rs</code>:520 on 2025-03-07 19:04</div>
            <div class="timeline-body"><p>I don't think I can <code>eat_char(',')</code> in the <code>if</code> here because I want the range for the MissingItem to be inside the commas - that's why I had it after pushing the warning.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-03-07 19:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-07 20:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:520 on 2025-03-07 20:49</div>
            <div class="timeline-body"><p>Makes sense. You could store the range in a variable but I can see how this is &quot;not so nice&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-07 20:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:600 on 2025-03-07 20:50</div>
            <div class="timeline-body"><p>Let's add a few comments with examples to those match arms. I would find them useful :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-03-07 22:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/noqa.rs</code>:345 on 2025-03-07 22:28</div>
            <div class="timeline-body"><p>made private, good catch!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-03-07 22:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/noqa.rs</code>:465 on 2025-03-07 22:30</div>
            <div class="timeline-body"><p>you're absolutely right! hopefully cleaner now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/noqa.rs</code>:1251 on 2025-03-10 10:53</div>
            <div class="timeline-body"><p>nit: we could move the <code>if let ...</code> in <code>assert_codes_match_slices</code> (and rename the function accordingly) to reduce the diff</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/noqa.rs</code>:374 on 2025-03-10 11:02</div>
            <div class="timeline-body"><p>I'd find it useful to document what <code>source</code> means here. Looking at the implementation, I think it's only a subset of the entire file content.</p>
<p>For <a href="https://github.com/astral-sh/ruff/blob/7d8fdb04c240d5c4f9f72a0e6aae42d0739fc099/crates/ruff_python_parser/src/lib.rs#L222-L225"><code>parse_string_annotation</code></a> we consider <code>source</code> to be the entire file content and the implementation would extract out the relevant subslice.</p>
<p>I'm not asking you to change but it would be useful to make sure we pass the correct source here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/noqa.rs</code>:1361 on 2025-03-10 11:03</div>
            <div class="timeline-body"><p>What would happen if there are whitespaces between multiple hashes? i.e., <code># # # noqa: F401</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-03-10 11:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:318 on 2025-03-10 13:10</div>
            <div class="timeline-body"><p>Nit: Both <code>lex_inline_noqa</code> and <code>lex_file_exemption</code> need to do the slicing and range selection here. Should we add a <code>NoqaLexer::range(full_source, range)</code> or <code>NoqaLexer::in_range(full_source, range)</code> method instead?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:349 on 2025-03-10 13:13</div>
            <div class="timeline-body"><p>Is this comment still accurate or is it now the start of the comment?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:344 on 2025-03-10 13:13</div>
            <div class="timeline-body"><p>Is this comment still accurate or is it the beginning of a comment (<code>#</code>)? We also don't know if it is a noqa comment at this point.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:431 on 2025-03-10 13:18</div>
            <div class="timeline-body"><p>Nit: You could consider introducing a <code>skip_whitespace</code> method on <code>Cursor</code> or on your Lexer</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:450 on 2025-03-10 13:19</div>
            <div class="timeline-body"><p>Nit</p>
<pre><code class="language-suggestion">            if self.cursor.as_str().starts_with(&quot;ruff&quot;) {
                self.cursor.skip_bytes(&quot;ruff&quot;.len());
            } else if self.cursor.as_str().starts_with(&quot;flake8&quot;) {
                self.cursor.skip_bytes(&quot;flake8&quot;.len());
            } else {
                continue;
            }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:498 on 2025-03-10 13:23</div>
            <div class="timeline-body"><p>Okay, I think I now see what I find confusing about this. It means we e.g. will assume that <code>noqa : RUF100</code> suppresses all rules and not only RUF100. It may be worth calling out that this isn't a leagal comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:505 on 2025-03-10 13:29</div>
            <div class="timeline-body"><p>I'm wondering if we should be more lenient. E.g. <code>noqa : F401</code> will pass without any error but a user clearly meant to write <code>noqa: F401</code>. Should we just skip any whitespace after <code>noqa</code> and then decide on the next character?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:572 on 2025-03-10 13:34</div>
            <div class="timeline-body"><p>I think we could remove the need to store <code>line</code> by:</p>
<pre><code class="language-suggestion">                let before_code = self.cursor.as_str();

                self.cursor.eat_while(|chr| chr.is_ascii_uppercase());
                if !self.cursor.eat_if(|c| c.is_ascii_digit()) {
                    // Fail hard if we're already attempting
                    // to lex squashed codes, e.g. `F401Fabc`
                    if self.missing_delimiter {
                        return Err(LexicalError::InvalidCodeSuffix);
                    }
                    // Otherwise we've reached the first invalid code,
                    // so it could be a comment and we just stop parsing.
                    // Ex) #noqa: F401 A comment
                    //       we're here^
                    self.cursor.skip_bytes(self.cursor.as_str().len());
                    return Ok(());
                }
                self.cursor.eat_while(|chr| chr.is_ascii_digit());
                // I believe `cursor` has a helper for this calculation
                let code = &amp;before_code[..(before_code.len() - self.cursor.as_str().len())];
                self.push_code(code);

                if self.cursor.is_eof() {
                    return Ok(());
                }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:581 on 2025-03-10 13:36</div>
            <div class="timeline-body"><p>Can we add an example here? E.g. what about <code>noqa: RUF100 RUF200</code>? It's also not clear to me what you mean by non-ascii whitespace</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/noqa.rs</code>:636 on 2025-03-10 13:38</div>
            <div class="timeline-body"><p>Nit: I'd rename this to <code>position</code> or <code>offset</code>. It's unclear if <code>current</code> refers to the current offset or current character or something else.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-03-10 13:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-10 14:10</div>
            <div class="timeline-body"><p>For the changelog: Could you write a short summary detailing which comments are no longer accepted that previously were and how the difference will manifest for users?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">do-not-merge</span> removed by @MichaReiser on 2025-03-10 14:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-10 14:26</div>
            <div class="timeline-body"><p>Same here. Feel free to merge this PR into the ruff-0.10 feature branch once it's ready</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/noqa.rs</code>:374 on 2025-03-10 21:37</div>
            <div class="timeline-body"><p>changed to <code>in_range</code> which <em>does</em> take the entire source as the argument</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-03-10 21:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/noqa.rs</code>:1361 on 2025-03-10 21:37</div>
            <div class="timeline-body"><p>added test (spoiler: we grab the <code>F401</code> correctly)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-03-10 21:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-03-10 21:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/noqa.rs</code>:349 on 2025-03-10 21:38</div>
            <div class="timeline-body"><p>updated (it's the start of the comment containing the noqa - and may be updated during lexing if there are multiple comments in the range)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-03-10 21:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/noqa.rs</code>:344 on 2025-03-10 21:38</div>
            <div class="timeline-body"><p>updated (now <code>line_length</code> anyway)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-03-10 21:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/noqa.rs</code>:431 on 2025-03-10 21:38</div>
            <div class="timeline-body"><p>added (as <code>eat_whitespace</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-03-10 21:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/noqa.rs</code>:572 on 2025-03-10 21:38</div>
            <div class="timeline-body"><p>nice! still needed to store the length of the original line to compute ranges, but got rid of <code>line</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-03-10 21:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/noqa.rs</code>:636 on 2025-03-10 21:38</div>
            <div class="timeline-body"><p>renamed to position</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-03-10 21:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/noqa.rs</code>:581 on 2025-03-10 21:38</div>
            <div class="timeline-body"><p>example added. and, since everything else has been allowed to be arbitrary whitespace, I just decided to allow all unicode whitespace as a delimiter (anything that starts a new line is automatically prohibited since we started with a comment range)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-03-10 21:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/noqa.rs</code>:505 on 2025-03-10 21:38</div>
            <div class="timeline-body"><p>agreed, see above</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/noqa.rs</code>:498 on 2025-03-10 21:38</div>
            <div class="timeline-body"><p>made this more flexible - we now allow whitespace before the colon</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-03-10 21:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-03-10 22:26</div>
            <div class="timeline-body"><p>For the changelog (let me know if you want me to actually put it in, say, <code>BREAKING_CHANGES.md</code> as part of this PR @MichaReiser):</p>
<ul>
<li><p><strong>Suppression comments</strong></p>
<p>The syntax rules governing inline (<code># noqa</code>) and file-level (<code># ruff: noqa</code>) suppression comments have been unified and overall made more flexible.</p>
<p>In the following situations, a comment will suppress <em>more</em> rules than it used to:</p>
<ul>
<li>Leading comments are now allowed for file-level suppression comments, e.g. <code># Some context # ruff: noqa</code>. Previously, this <code>noqa</code> was silently ignored.</li>
<li>Trailing comments are now allowed for file-level suppression comments, e.g. <code># ruff: noqa  This file is rough!</code> and  are both allowed, whereas previously this resulted in an error and the suppression did not take effect.</li>
<li>To support the previous change, mistaken syntax like <code>ruff: noqa UP035</code> will now suppress <em>all</em> rules (it is missing a colon after <code>noqa</code>). This is consistent with the already established in-line behavior, and is guarded against by the preview behavior of <code>PGH004</code>.</li>
<li>Missing items in lists of rules are now read with a warning, e.g. <code>#noqa: F401,,F841</code> will suppress <code>F401</code> and <code>F841</code> and emit <code>MissingItem</code> warning.</li>
<li>Skipped delimiters in lists of rules are now read in both the in-line and file-level comments and a warning is emitted, e.g. <code># ruff: noqa: F401F841</code> will suppress both <code>F401</code> and <code>F841</code> and a <code>MissingDelimiter</code> warning is emitted.</li>
</ul>
<p>In the following situations, a comment may suppress <em>fewer</em> rules than it used to:</p>
<ul>
<li>It is now <em>disallowed</em> to have an invalid rule suffix in inline suppression comments, e.g. <code># noqa: UP035abc</code>. This will log an error to the user and suppress no rules. This matches the current behavior for file-level suppression comments.</li>
<li>Whitespace is allowed between the colon and rule list, e.g. <code>#noqa : F401</code> previously suppressed <em>all</em> rules, and will now only suppress <code>F401</code>. This used to be guarded against through <code>PGH004</code>, but that is now no longer needed.</li>
</ul>
<p>The full specification is as follows:</p>
<ul>
<li>An <em>in-line blanket noqa</em> comment is given by a case-insensitive match for <code>#noqa</code> with optional whitespace after the <code>#</code> symbol, followed by either: the end of the comment, the beginning of a new comment (<code>'#'</code>), or whitespace followed by any character other than <code>':'</code>.</li>
<li>An <em>in-line rule suppression</em> is given by first finding a case-insensitive match for <code>#noqa</code> with optional whitespace after the <code>#</code> symbol, optional whitespace after <code>noqa</code>, and followed by the symbol <code>':'</code>. After this we are expected to have a <em>list of rule codes</em> which is given by sequences of uppercase ascii characters followed by ascii digits, separated by whitespace or commas. The list ends at the last valid code. We will attempt to interpret rules with a missing delimiter (e.g. <code>F401F841</code>), though a warning will be emitted in this case.</li>
<li>A <em>file-level exemption</em> comment is given by a case-sensitive match for <code>#ruff:</code> or <code>#flake8:</code>, with optional whitespace after <code>'#'</code> and before <code>':'</code>, followed by optional whitespace and a case-insensitive match for <code>noqa</code>. After this, the specification is as in the in-line case.</li>
</ul>
</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dylwil3 on 2025-03-11 19:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dylwil3 on 2025-03-11 19:50</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:49:31 UTC
    </footer>
</body>
</html>
