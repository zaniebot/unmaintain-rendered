<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preserve trailing semicolon for Notebooks - astral-sh/ruff #8590</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Preserve trailing semicolon for Notebooks</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/8590">#8590</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2023-11-09 21:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body">Summary
<p>This PR updates the formatter to preserve trailing semicolon for Jupyter Notebooks.</p>
<p>The motivation behind the change is that semicolons in notebooks are typically used to hide the output, for example when plotting. This is highlighted in the linked issue.</p>
<p>The conditions required as to when the trailing semicolon should be preserved are:</p>
<ol>
<li>It should be a top-level statement which is last in the module.</li>
<li>For statement, it can be either assignment, annotated assignment, or augmented assignment. Here, the target should only be a single identifier i.e., multiple assignments or tuple unpacking isn&#x27;t considered.</li>
<li>For expression, it can be any.</li>
</ol>
Test Plan
<p>Add a new integration test in <code>ruff_cli</code>. The test notebook basically acts as a document as to which trailing semicolons are to be preserved.</p>
<p>fixes: #8254</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-11-09 21:05</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #8590</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8590?utm_source=stack-comment-icon"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
<p>This <a href="https://stacking.dev/?utm_source=stack-comment">stack of pull requests</a> is managed by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8590?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-11-09 21:22</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>âœ… ecosystem check detected no linter changes.</p>
Linter (preview)
<p>âœ… ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>âœ… ecosystem check detected no format changes.</p>
Formatter (preview)
<p>âœ… ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-11-10 09:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-11-10 09:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-11-10 09:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-11-10 09:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_cli/tests/format.rs</code>:821 on 2023-11-10 09:24</div>
            <div class="timeline-body"><p>I&#x27;m not sure if this is the correct place for this test case. We would need to refactor the formatter test suite to include notebook files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_formatter/src/statement/suite.rs</code>:64 on 2023-11-10 09:26</div>
            <div class="timeline-body"><p>We could avoid cloning the iterator by making it peekable but that involves updating the function signature wherever this iterator is being passed. This is because it expects <code>std::slice::Iter</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-11-10 09:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/statement/suite.rs</code>:64 on 2023-11-10 11:09</div>
            <div class="timeline-body"><p>This clone is effectively free (we just clone the slice reference), so this is fine. The peakable things with the function signatures is annoying though, i had also already hit that</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-11-10 11:12</div>
            <div class="timeline-body"><p>Would it simplify the implementation to insert the semicolon at</p>
<p>https://github.com/astral-sh/ruff/blob/3076d76b0ab7a4b221c3ec1f34a8b68ed07059b1/crates/ruff_python_formatter/src/statement/suite.rs#L399</p>
<p>instead? Then we shouldn&#x27;t need <code>TopLevelStatementPosition</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-11-10 12:12</div>
            <div class="timeline-body"><blockquote>
<p>Would it simplify the implementation to insert the semicolon at</p>
<p>https://github.com/astral-sh/ruff/blob/3076d76b0ab7a4b221c3ec1f34a8b68ed07059b1/crates/ruff_python_formatter/src/statement/suite.rs#L399</p>
<p>instead? Then we shouldn&#x27;t need <code>TopLevelStatementPosition</code></p>
</blockquote>
<p>I&#x27;m assuming what you&#x27;re recommending is to check at the linked position if this is the last statement and then preserve the semicolon, if any. Is this correct?</p>
<p>I think that&#x27;ll involve matching against the relevant nodes where the semicolon needs to be preserved as it&#x27;s only required for a subset of nodes - <code>StmtAssign</code>, <code>StmtAugAssign</code>, <code>StmtAnnAssign</code>, and <code>StmtExpr</code>. Additionally, certain conditions needs to be checked like is this a multiple assignment or not? I&#x27;d prefer to keep the logic in the respective node.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-11-10 13:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-11-10 16:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-11-10 16:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-11-10 16:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/suite.rs</code>:64 on 2023-11-29 08:08</div>
            <div class="timeline-body"><p>I think this can be simplified to</p>
<pre><code>SuiteKind::TopLevel =&gt; NodeLevel::TopLevel(if statements.len() &lt; 2 {
    TopLevelStatementPosition::Last
} else {
    TopLevelStatementPosition::Other
}),
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-11-29 08:10</div>
            <div class="timeline-body"><p>I prefer to avoid using the <code>context</code> whenever possible because it is harder to reason about where the context value is set/changed.</p>
<p>An alternative to the context would have been to parameterized <code>FormatStmt</code>, <code>FormatStmtAssign</code> etc (by implementing FormatWithOptions) and explicitly pass a value whether it is the last statement.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-11-29 17:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_formatter/src/statement/suite.rs</code>:64 on 2023-11-29 17:51</div>
            <div class="timeline-body"><p>Yes, that can be done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-11-29 17:52</div>
            <div class="timeline-body"><blockquote>
<p>An alternative to the context would have been to parameterized <code>FormatStmt</code>, <code>FormatStmtAssign</code> etc (by implementing FormatWithOptions) and explicitly pass a value whether it is the last statement.</p>
</blockquote>
<p>I thought about this but I felt like this kind of information is suited well for the context. And, it already provided the node level information.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:59:14 UTC
    </footer>
</body>
</html>
