```yaml
number: 5340
title: Fix attribute chain own line comments
type: pull_request
state: merged
author: konstin
labels: []
assignees: []
merged: true
base: main
head: fix_attribute_chain_own_line_comments_rebased
created_at: 2023-06-23T16:40:12Z
updated_at: 2023-06-26T09:32:15Z
url: https://github.com/astral-sh/ruff/pull/5340
synced_at: 2026-01-12T03:36:55Z
```

# Fix attribute chain own line comments

---

_Pull request opened by @konstin on 2023-06-23 16:40_

## Motation

Previously,
```python
x = (
    a1
    .a2
    # a
    .  # b
    # c
    a3
)
```
got formatted as
```python
x = a1.a2
# a
.  # b
# c
a3
```
which is invalid syntax. This fixes that.

## Summary

This implements a basic form of attribute chaining (<https://black.readthedocs.io/en/stable/the_black_code_style/current_style.html#call-chains>) by checking if any inner attribute access contains an own line comment, and if this is the case, adds parentheses around the outermost attribute access while disabling parentheses for all inner attribute expressions. We want to replace this with an implementation that uses recursion or a stack while formatting instead of in `needs_parentheses` and also includes calls rather sooner than later, but i'm fixing this now because i'm uncomfortable with having known invalid syntax generation in the formatter.

## Test Plan

I added new fixtures.


---

_Comment by @konstin on 2023-06-23 16:40_

Current dependencies on/for this PR:
* main
  * **PR #5339** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5339" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #5340** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5340" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
      * **PR #5341** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5341" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/5340?utm_source=stack-comment).

---

_Review requested from @MichaReiser by @konstin on 2023-06-23 16:40_

---

_Comment by @github-actions[bot] on 2023-06-23 17:12_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.02      8.1Â±0.05ms     5.0 MB/sec    1.00      8.0Â±0.05ms     5.1 MB/sec
formatter/numpy/ctypeslib.py               1.02   1879.6Â±2.98Âµs     8.9 MB/sec    1.00   1845.5Â±2.62Âµs     9.0 MB/sec
formatter/numpy/globals.py                 1.01    223.9Â±0.44Âµs    13.2 MB/sec    1.00    221.3Â±0.37Âµs    13.3 MB/sec
formatter/pydantic/types.py                1.03      4.2Â±0.01ms     6.0 MB/sec    1.00      4.1Â±0.00ms     6.2 MB/sec
linter/all-rules/large/dataset.py          1.01     15.9Â±0.07ms     2.6 MB/sec    1.00     15.8Â±0.07ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.0Â±0.01ms     4.2 MB/sec    1.00      4.0Â±0.01ms     4.2 MB/sec
linter/all-rules/numpy/globals.py          1.00    517.6Â±0.88Âµs     5.7 MB/sec    1.00    516.5Â±0.98Âµs     5.7 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.0Â±0.03ms     3.6 MB/sec    1.01      7.1Â±0.04ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.01      8.0Â±0.02ms     5.1 MB/sec    1.00      8.0Â±0.02ms     5.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1778.5Â±1.44Âµs     9.4 MB/sec    1.00   1772.9Â±9.98Âµs     9.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    204.6Â±1.52Âµs    14.4 MB/sec    1.00    204.4Â±0.98Âµs    14.4 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.7Â±0.01ms     6.9 MB/sec    1.00      3.7Â±0.01ms     7.0 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      7.8Â±0.03ms     5.2 MB/sec    1.11      8.7Â±0.19ms     4.7 MB/sec
formatter/numpy/ctypeslib.py               1.00  1741.7Â±10.47Âµs     9.6 MB/sec    1.09  1897.1Â±15.26Âµs     8.8 MB/sec
formatter/numpy/globals.py                 1.00    200.4Â±1.31Âµs    14.7 MB/sec    1.06    211.7Â±5.80Âµs    13.9 MB/sec
formatter/pydantic/types.py                1.00      4.0Â±0.02ms     6.4 MB/sec    1.09      4.4Â±0.03ms     5.8 MB/sec
linter/all-rules/large/dataset.py          1.01     15.2Â±0.12ms     2.7 MB/sec    1.00     15.1Â±0.08ms     2.7 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.1Â±0.03ms     4.1 MB/sec    1.00      4.1Â±0.02ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.00    426.0Â±4.54Âµs     6.9 MB/sec    1.00    426.0Â±5.04Âµs     6.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.8Â±0.03ms     3.7 MB/sec    1.00      6.8Â±0.09ms     3.7 MB/sec
linter/default-rules/large/dataset.py      1.01      7.9Â±0.04ms     5.1 MB/sec    1.00      7.9Â±0.02ms     5.2 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01  1669.5Â±29.04Âµs    10.0 MB/sec    1.00  1653.8Â±10.53Âµs    10.1 MB/sec
linter/default-rules/numpy/globals.py      1.00    179.0Â±1.11Âµs    16.5 MB/sec    1.00    179.2Â±1.46Âµs    16.5 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.6Â±0.02ms     7.1 MB/sec    1.00      3.6Â±0.03ms     7.0 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/resources/test/fixtures/ruff/expression/attribute.py`:57 on 2023-06-26 06:54_

Can you add one example where the outer most attribute chain has leading and trailing comments too?

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_attribute.rs`:44 on 2023-06-26 06:55_

Can you add a test case where an inner attribute change is parenthesized? I wonder if we need to preserve the parentheses.

---

_@MichaReiser approved on 2023-06-26 06:56_

---

_Merged by @konstin on 2023-06-26 09:13_

---

_Closed by @konstin on 2023-06-26 09:13_

---

_Branch deleted on 2023-06-26 09:13_

---
