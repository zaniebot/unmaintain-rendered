```yaml
number: 3572
title: Scope and Binding IDs
type: pull_request
state: merged
author: MichaReiser
labels:
  - internal
assignees: []
merged: true
base: main
head: scope-banding-id
created_at: 2023-03-17T10:41:55Z
updated_at: 2023-03-17T16:12:34Z
url: https://github.com/astral-sh/ruff/pull/3572
synced_at: 2026-01-12T04:39:45Z
```

# Scope and Binding IDs

---

_Pull request opened by @MichaReiser on 2023-03-17 10:41_

This PR introduces the new `ScopeId` and `BindingId` types instead of using the generic `usize` type. 

Using a specific type allows us to enforce that `bindings` and `scopes` can only be indexed with the corresponding id-types, reducing the risk that they get mixed up. To do this, I had to introduce new `Scopes`, `Bindings` and `ScopeStack` wrapper types. 

This PR removes the `AtomicUsize` that computes the next scope id and instead uses `scopes.len()` to compute the next id. 


---

_Comment by @MichaReiser on 2023-03-17 10:42_

Current dependencies on/for this PR:
* main
  * **PR #3572** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3572" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #3573** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3573" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #3575** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3575" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/charliermarsh/ruff/3572?utm_source=stack-comment).

---

_Marked ready for review by @MichaReiser on 2023-03-17 10:57_

---

_Review requested from @charliermarsh by @MichaReiser on 2023-03-17 10:57_

---

_Review requested from @konstin by @MichaReiser on 2023-03-17 10:57_

---

_Label `internal` added by @MichaReiser on 2023-03-17 10:57_

---

_Review comment by @MichaReiser on `crates/ruff_python_ast/src/context.rs`:323 on 2023-03-17 10:58_

I moved all these types to a `scope.rs` in the following PR

---

_@MichaReiser reviewed on 2023-03-17 10:58_

---

_Comment by @github-actions[bot] on 2023-03-17 11:10_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.
### Benchmark
#### Linux
```
group                        main                                   pr
-----                        ----                                   --
linter/large/dataset.py      1.01      8.6Â±0.06ms     4.7 MB/sec    1.00      8.5Â±0.07ms     4.8 MB/sec
linter/numpy/ctypeslib.py    1.03      2.3Â±0.01ms   152.3 MB/sec    1.00      2.2Â±0.01ms   157.5 MB/sec
linter/numpy/globals.py      1.03   1134.6Â±6.01Âµs   157.1 MB/sec    1.00   1104.3Â±3.29Âµs   161.4 MB/sec
linter/pydantic/types.py     1.01      3.9Â±0.02ms     6.5 MB/sec    1.00      3.9Â±0.01ms     6.6 MB/sec
```

#### Windows
```
group                        main                                   pr
-----                        ----                                   --
linter/large/dataset.py      1.00      8.8Â±0.09ms     4.6 MB/sec    1.01      8.9Â±0.20ms     4.6 MB/sec
linter/numpy/ctypeslib.py    1.00      2.3Â±0.03ms   149.0 MB/sec    1.03      2.4Â±0.03ms   145.4 MB/sec
linter/numpy/globals.py      1.00  1177.3Â±26.31Âµs   151.4 MB/sec    1.01  1193.0Â±23.48Âµs   149.4 MB/sec
linter/pydantic/types.py     1.00      4.1Â±0.08ms     6.2 MB/sec    1.01      4.1Â±0.09ms     6.2 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_@charliermarsh reviewed on 2023-03-17 15:39_

---

_Review comment by @charliermarsh on `crates/ruff_python_ast/src/types.rs`:86 on 2023-03-17 15:39_

Minor correction: `if 1:\n x` doesn't create a new scope in Ruff right now. We track scopes for function and class definitions, and comprehensions. Those scope-creating statements can also inline their bodies, like `def f(x): return x * x`.

---

_Review comment by @charliermarsh on `crates/ruff_python_ast/src/types.rs`:10 on 2023-03-17 16:05_

Trying to figure out... where did this behavior go?

---

_@charliermarsh reviewed on 2023-03-17 16:05_

---

_@charliermarsh approved on 2023-03-17 16:05_

Great change, big improvement.

---

_Review comment by @charliermarsh on `crates/ruff_python_ast/src/types.rs`:10 on 2023-03-17 16:05_

Oof, nevermind, it's in the summary!

---

_@charliermarsh reviewed on 2023-03-17 16:05_

---

_Merged by @MichaReiser on 2023-03-17 16:12_

---

_Closed by @MichaReiser on 2023-03-17 16:12_

---

_Branch deleted on 2023-03-17 16:12_

---
