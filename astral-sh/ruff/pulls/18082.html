<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Tell the user why we inferred the Python version we inferred - astral-sh/ruff #18082</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Tell the user why we inferred the Python version we inferred</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18082">#18082</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-05-14 01:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>I'm blaming @MichaReiser for this. He said it would be easy in https://github.com/astral-sh/ruff/pull/18068#discussion_r2086919985 and... it wasn't ðŸ˜†</p>
<p>This PR propagates the origin of the inferred Python version (CLI flag, <code>pyproject.toml</code>, <code>ty.toml</code>, etc.) from the <code>ty_project</code> crate to the <code>ty_python_semantic</code> crate. (Specifically, a new <code>python_version_source</code> field is added to the <code>ty_python_semantic::program::Program</code> struct.) Having the origin of the Python version available allows us to add subdiagnostics that annotate the specific part of the config file that led us to infer a certain Python version.</p>
<p>A screenshot to demonstrate this in action:</p>
<p><img src="https://github.com/user-attachments/assets/21919def-178c-407a-aa5a-2efa32511975" alt="image" /></p>
<h2>Test Plan</h2>
<p>I added integration tests to the <code>ty</code> crate.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-05-14 01:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-05-14 01:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @AlexWaygood on 2025-05-14 01:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2025-05-14 01:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-05-14 01:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by @AlexWaygood on 2025-05-14 01:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-05-14 01:33</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-05-14 01:49</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/metadata.rs</code>:242 on 2025-05-14 05:56</div>
            <div class="timeline-body"><p>I'm sorry, but we can't use <code>db</code> here. It will break our approach to persistent caching.</p>
<p>What's important for persistent caching is that we can resolve the <code>ProgramSettings</code> before constructing the db. We then hash the <code>ProgramSettings</code> and use the hash to lookup the cache file and load the database from it. This allows us to support different persistent caches when running ty with different python versions</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/metadata/value.rs</code>:143 on 2025-05-14 05:57</div>
            <div class="timeline-body"><p>Can't the call site write <code>value = *ranged</code> instead?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/program.rs</code>:19 on 2025-05-14 05:57</div>
            <div class="timeline-body"><p>I'd prefer to wrap <code>PythonVersion</code> in a struct that stores both the source and the version to reduce the top-level fields and make it harder to only update <code>python_version</code> but forget to update the source (which you didn't!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/db.rs</code>:62 on 2025-05-14 05:58</div>
            <div class="timeline-body"><p>See the comment above about persistent caching (refer to my other inline comment)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/metadata.rs</code>:20 on 2025-05-14 05:59</div>
            <div class="timeline-body"><p>I'd prefer if this doesn't have to be clone. It's a very heavy data structure. It's not clear to me where we have to clone it.</p>
<pre><code class="language-suggestion">#[derive(Debug, PartialEq, Eq)]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2025-05-14 06:00</div>
            <div class="timeline-body"><p>This looks great. Unfortunately, I expect this to break persistent caching where we'd use a different persistent cache for different python versions.</p>
<p>For now, I think the best we can do, without breaking persistent caching), is to say if the value comes from the CLI or configuration but without saying exactly from which configuration.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @sharkdp on 2025-05-14 06:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @carljm on 2025-05-15 02:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-15 14:40</div>
            <div class="timeline-body"><p>Another way to work around the <em>no db</em> problem is to store the <code>SystemPath</code> in the python-version's <code>RangedValue</code> and lazily converting the path to a file when emitting a diagnostic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-05-15 15:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_python_semantic/src/program.rs</code>:19 on 2025-05-15 15:29</div>
            <div class="timeline-body"><p>Does this also mean a program with the same Python version but defined at separate source would invalidate the entire program? This isn't that important issue as changing the source of a Python version is not going to be that frequent in practice (I think) and the benefit that it provides is more useful IMO.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-05-15 15:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/program.rs</code>:19 on 2025-05-15 15:39</div>
            <div class="timeline-body"><p>We could ignore the source when computing the cache key</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-19 17:23</div>
            <div class="timeline-body"><blockquote>
<p>Another way to work around the <em>no db</em> problem is to store the <code>SystemPath</code> in the python-version's <code>RangedValue</code> and lazily converting the path to a file when emitting a diagnostic.</p>
</blockquote>
<p>Yeah, I think I'll try this. Having an annotation showing the file where the setting comes from seems really useful to me, since it can already come from one of several possible sources (<code>pyproject.toml</code> file or <code>ty.toml</code> file -- and when <code>--config-file</code> is implemented those could possibly be in unexpected locations) and we intend to add more sources in the future (<code>pyvenv.cfg</code> files, maybe also <code>.python-version</code> files).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-05-20 21:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_project/src/metadata/value.rs</code>:143 on 2025-05-20 21:11</div>
            <div class="timeline-body"><p><code>RangedValue</code> is not itself <code>Copy</code>, and the only way to obtain the wrapped <code>T</code> data at the moment is the <code>into_inner</code> method. But I need to clone the whole <code>RangedValue</code> object to use that method, since it consumes <code>self</code>. For my callsite, that feels unnecessarily expensive?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-20 22:18</div>
            <div class="timeline-body"><p>Thanks @MichaReiser! I think I addressed all your concerns except for https://github.com/astral-sh/ruff/pull/18082#discussion_r2088101404 (I left a comment in response).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2025-05-20 22:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-05-21 06:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/metadata/value.rs</code>:143 on 2025-05-21 06:16</div>
            <div class="timeline-body"><p>I understand. The following works without addidng the new method:</p>
<pre><code class="language-patch">Index: crates/ty_project/src/metadata/value.rs
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
&lt;+&gt;UTF-8
===================================================================
diff --git a/crates/ty_project/src/metadata/value.rs b/crates/ty_project/src/metadata/value.rs
--- a/crates/ty_project/src/metadata/value.rs	(revision 181b122308b8918b284bf3e57a1565a4cb42891a)
+++ b/crates/ty_project/src/metadata/value.rs	(date 1747808036977)
@@ -133,15 +133,6 @@
     }
 }
 
-impl&lt;T&gt; RangedValue&lt;T&gt;
-where
-    T: Copy,
-{
-    pub fn inner_copied(&amp;self) -&gt; T {
-        self.value
-    }
-}
-
 impl&lt;T&gt; Combine for RangedValue&lt;T&gt; {
     fn combine(self, _other: Self) -&gt; Self
     where
Index: crates/ty_project/src/metadata/options.rs
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
&lt;+&gt;UTF-8
===================================================================
diff --git a/crates/ty_project/src/metadata/options.rs b/crates/ty_project/src/metadata/options.rs
--- a/crates/ty_project/src/metadata/options.rs	(revision 181b122308b8918b284bf3e57a1565a4cb42891a)
+++ b/crates/ty_project/src/metadata/options.rs	(date 1747808097048)
@@ -98,7 +98,7 @@
             .and_then(|env| env.python_version.as_ref())
             .map(|ranged_version| {
                 PythonVersionWithSource::new(
-                    ranged_version.inner_copied(),
+                    **ranged_version,
                     match ranged_version.source() {
                         ValueSource::Cli =&gt; ty_python_semantic::ValueSource::Cli,
                         ValueSource::File(path) =&gt; ty_python_semantic::ValueSource::File(
</code></pre>
<p><code>**ranged_version</code> dereferences the <code>&amp;ranged_version</code> to <code>ranged_version</code> and then calls <code>Deref</code> on <code>RangedValue</code>, which returns a <code>PythonVersion</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty/tests/file_watching.rs</code>:409 on 2025-05-21 06:18</div>
            <div class="timeline-body"><p>We should avoid accessing <code>options</code> in general because it doesn't fill in defaults. What's the reason for this change? Can we revert it now that <code>to_program_settings</code> only takes a <code>system</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/program.rs</code>:113 on 2025-05-21 06:21</div>
            <div class="timeline-body"><p>Nit: Maybe <code>PythonVersionSource</code> to make it less ambiguess (identically named structs can be annoying when you do: Go to symbol because they all show up)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/program.rs</code>:56 on 2025-05-21 06:24</div>
            <div class="timeline-body"><p>Nit: I would delete this method and directly use <code>python_version_with_source</code> (given that it is public too). It's only used in one place anyway which calls both <code>python_version</code> and <code>python_version_with_source</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/program.rs</code>:126 on 2025-05-21 06:25</div>
            <div class="timeline-body"><p>It seems that <code>ProgramSetting's</code> <code>Serialize</code> and <code>Deserialize</code> implementation are never used. Can we remove them instead of making this type serializable</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-05-21 06:25</div>
            <div class="timeline-body"><p>This is great. Thank you. I've a few smaller inline comments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-05-21 14:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty/tests/file_watching.rs</code>:409 on 2025-05-21 14:39</div>
            <div class="timeline-body"><p>thanks, you're right -- these changes are no longer necessary. I'll revert them!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-05-21 14:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/program.rs</code>:113 on 2025-05-21 14:40</div>
            <div class="timeline-body"><p>I wondered if we might start retaining the source for some other settings (e.g. search paths) so that we could also annotate them in diagnostics. But I'll make the renaming you suggest for now (it can easily be renamed in the future if we start using the enum in other contexts)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_project/src/metadata/value.rs</code>:143 on 2025-05-21 14:52</div>
            <div class="timeline-body"><p>Ahh, that's a neat trick. Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-05-21 14:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-05-21 15:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-05-21 15:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-05-21 15:06</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:12:33 UTC
    </footer>
</body>
</html>
