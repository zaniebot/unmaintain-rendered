<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remove AST-node dependency from `FunctionType` and `ClassType` - astral-sh/ruff #14087</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Remove AST-node dependency from <code>FunctionType</code> and <code>ClassType</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14087">#14087</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-11-04 08:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-04 08:58</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR improves Red Knot's incremental computation by:</p>
<ul>
<li>Making <code>FunctionType::return_type</code> and <code>ClassType::explicit_bases</code> salsa queries. I suspect this is where the main performance improvement comes from. Making these two functions salsa queries prevents that the class or function's node (accessed through <code>definition.node</code>) is marked as a dependency at the callee side. Instead, the callee only depends on whatever the return type or bases are.</li>
<li>Removing <code>FunctionType::definition</code> and <code>ClassType::definition</code> and instead use <code>semantic_index.definition(..)</code> to lookup the type's definition lazily. This ensures that deserializing a type doesn't require deserializing the AST as well.</li>
<li>Remove <code>ScopeId::node</code> and move it to <code>Scope::node</code>. Same as for <code>FunctionType::definition</code>. Moving the <code>Node</code> from the <code>ScopeId</code> to the definition allows deserializing the <code>ScopeId</code> without deserializing the AST node. This is important because both <code>FunctionType</code> and <code>ClassType</code> have a <code>ScopeId</code> field.</li>
</ul>
<p>Fixes https://github.com/astral-sh/ruff/issues/14054</p>
<h2>Test Plan</h2>
<p><code>cargo test</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Move `ScopeId::node` to `Scope` to avoid depending on AST node" to "Remove AST-node dependency from `Type`" by @MichaReiser on 2024-11-04 08:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @MichaReiser on 2024-11-04 08:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-04 09:16</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-11-04 14:35</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/micha/remove-ast-dependencies-from-type">CodSpeed Performance Report</a></h2>
<h3>Merging #14087 will <strong>improve performances by 12.36%</strong></h3>
<p><sub>Comparing <code>micha/remove-ast-dependencies-from-type</code> (eb97246) with <code>main</code> (9dddd73)</sub></p>
<h3>Summary</h3>
<p><code>⚡ 1</code> improvements
<code>✅ 31</code> untouched benchmarks</p>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>main</code> | <code>micha/remove-ast-dependencies-from-type</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ⚡ | <code>red_knot_check_file[incremental]</code> | 4.6 ms | 4.1 ms | +12.36% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-04 14:38</div>
            <div class="timeline-body"><p>Lol what</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Remove AST-node dependency from `Type`" to "Remove AST-node dependency from `FunctionType` and `ClassType`" by @MichaReiser on 2024-11-04 15:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-04 15:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1889 on 2024-11-04 15:20</div>
            <div class="timeline-body"><p>The issue without this being a salsa query is that the calling-query suddenly depends on the function's ast (and, therefore, the file).</p>
<p>In the case of our benchmark: <code>_parser.py</code> calls <code>match_to_datetime</code> which is defined in <code>_re.py</code>. Now, it shouldn't be necessary to recheck <code>_parser.py</code> because no type in <code>_re.py</code> changed. However, Salsa had to recheck every callsite because the <code>return_type</code> query accessed the <code>definition.kind(db)</code> which is the AST node of the <code>match_to_datetime</code> and its AST has changed (not really, but we use <code>no_eq</code>...)</p>
<p>I verified that making <code>return_ty</code> is the reason for the perf improvement by removing the <code>#[salsa::tracked]</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Skylion007">@Skylion007</a> reviewed on 2024-11-04 15:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Skylion007">@Skylion007</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:137 on 2024-11-04 15:22</div>
            <div class="timeline-body"><p>nit: move comment along with unsafe block</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2024-11-04 15:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MichaReiser on 2024-11-04 15:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MichaReiser on 2024-11-04 15:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @MichaReiser on 2024-11-04 15:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/semantic_index/definition.rs</code>:18 on 2024-11-04 15:35</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// ## Module-local type
/// This type should not be used as part of any cross-module API because
/// it holds a reference to the AST node. Range-offset changes
/// then propagate through all usages, and deserialization requires
/// reparsing the entire module.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/semantic_index/expression.rs</code>:16 on 2024-11-04 15:36</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// ## Module-local type
/// This type should not be used as part of any cross-module API because
/// it holds a reference to the AST node. Range-offset changes
/// then propagate through all usages, and deserialization requires
/// reparsing the entire module.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1849 on 2024-11-04 15:38</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    /// Were this not a salsa query, the calling query
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:447 on 2024-11-04 15:41</div>
            <div class="timeline-body"><p>oh, thanks! I meant to add this TODO before merging, but forgot.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/mro.rs</code>:281 on 2024-11-04 15:44</div>
            <div class="timeline-body"><p>I'd just do</p>
<pre><code class="language-suggestion">    /// in the bases list of the class's [`ruff_python_ast::StmtClassDef`] node.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/mro.rs</code>:296 on 2024-11-04 15:44</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    /// in the bases list of the class's [`ruff_python_ast::StmtClassDef`] node.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1856 on 2024-11-04 15:46</div>
            <div class="timeline-body"><p>nit: worth returning <code>Box&lt;[Type&lt;'db&gt;]&gt;</code> here rather than <code>Vec&lt;Type&lt;'db&gt;&gt;</code>? It might result in slightly less data being stored in the Salsa cache?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-04 15:46</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1976 on 2024-11-04 16:00</div>
            <div class="timeline-body"><p>FWIW I'm not sure I see the need for this wrapper method right now -- everything compiles for me with this diff applied to your branch. I also doubt that we'll start accessing the bases from more places in the future; in 99% of cases, you really want to iterate over the MRO rather than the bases. However, I don't feel strongly; I'm okay with keeping it for now.</p>
<pre><code class="language-diff">diff --git a/crates/red_knot_python_semantic/src/types.rs b/crates/red_knot_python_semantic/src/types.rs
index b33d0fe4f..7ce85fb19 100644
--- a/crates/red_knot_python_semantic/src/types.rs
+++ b/crates/red_knot_python_semantic/src/types.rs
@@ -1835,7 +1835,7 @@ impl&lt;'db&gt; ClassType&lt;'db&gt; {
             })
     }
 
-    /// Return an iterator over the inferred types of this class's *explicit* bases.
+    /// Return the inferred types of this class's *explicit* bases.
     ///
     /// Note that any class (except for `object`) that has no explicit
     /// bases will implicitly inherit from `object` at runtime. Nonetheless,
@@ -1848,12 +1848,8 @@ impl&lt;'db&gt; ClassType&lt;'db&gt; {
     ///
     /// Were this not a salsa query, then the calling query
     /// would depend on the class's AST and rerun for every change in that file.
-    fn explicit_bases(self, db: &amp;'db dyn Db) -&gt; &amp;[Type&lt;'db&gt;] {
-        self.explicit_bases_query(db)
-    }
-
     #[salsa::tracked(return_ref)]
-    fn explicit_bases_query(self, db: &amp;'db dyn Db) -&gt; Box&lt;[Type&lt;'db&gt;]&gt; {
+    fn explicit_bases(self, db: &amp;'db dyn Db) -&gt; Box&lt;[Type&lt;'db&gt;]&gt; {
         let class_stmt = self.node(db);
 
         if class_stmt.type_params.is_some() {
diff --git a/crates/red_knot_python_semantic/src/types/mro.rs b/crates/red_knot_python_semantic/src/types/mro.rs
index ea298478f..5af11eccd 100644
--- a/crates/red_knot_python_semantic/src/types/mro.rs
+++ b/crates/red_knot_python_semantic/src/types/mro.rs
@@ -40,7 +40,7 @@ impl&lt;'db&gt; Mro&lt;'db&gt; {
     }
 
     fn of_class_impl(db: &amp;'db dyn Db, class: ClassType&lt;'db&gt;) -&gt; Result&lt;Self, MroErrorKind&lt;'db&gt;&gt; {
-        let class_bases = class.explicit_bases(db);
+        let class_bases = &amp;**class.explicit_bases(db);
 
         match class_bases {
             // `builtins.object` is the special case:
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-11-04 16:00</div>
            <div class="timeline-body"><p>LGTM other than my remaining docs nits and one further optional comment:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-04 16:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1976 on 2024-11-04 16:11</div>
            <div class="timeline-body"><p>I want to keep the <code>explicit_bases</code> function so that the return type is <code>&amp;[Type]</code> over <code>&amp;Box&lt;[Type]&gt;</code>  (I prefer more code at the definition side over more code at the call site)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-04 16:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1976 on 2024-11-04 16:13</div>
            <div class="timeline-body"><p>I'm fine with that, but just so I understand fully: does that just give us better ergonomics? or is there also a perf/generated code benefit?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-04 16:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1976 on 2024-11-04 16:46</div>
            <div class="timeline-body"><p>It's just ergonomics. A slice return type is more ergonomic than a <code>Box&lt;[Type]&gt;</code> (whether we use a <code>Box</code> or <code>Vec</code> internally is an implementation detail)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-11-04 22:00</div>
            <div class="timeline-body"><p>Code changes here look great, thanks for sorting this out!</p>
<p>My main concern is that I think the guidance here is going to prove quite difficult to remember and follow manually and solely via code review; it's just very easy for these things to leak. It seems like it should be possible to write tests that are similar to what happen in our benchmark, just verifying that if you make a no-op change to one file, it doesn't cause re-execution of queries in another file that shouldn't need to re-execute. I think a few tests like that could go a really long way in helping us avoid regression here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-11-05 04:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/semantic_index/definition.rs</code>:24 on 2024-11-05 04:21</div>
            <div class="timeline-body"><p>I think this might need to be added in <code>Unpack</code> ingredient as well: https://github.com/astral-sh/ruff/blob/9dddd73c292b477fc96fbb6ff233cd46c7caa3ca/crates/red_knot_python_semantic/src/unpack.rs</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-05 07:50</div>
            <div class="timeline-body"><p>@carljm I agree that a test would be nice. I added one for call inference although I'm not sure how valuable it is because it is rather fragile (a slight change to inference will break the test itself).</p>
<p>I don't know how to write the ideal test that:</p>
<ul>
<li>Exercises most language features</li>
<li>Asserts that <code>infer_definition_types</code> or <code>infer_expression_types</code> is never called for any other file than the file to which the comment was added.</li>
</ul>
<p>The problem here is that salsa doesn't provide the necessary reflection API to answer the second question. We could log all events but that test is likely going to break with every inference test AND it's kind of impossible to tell from a <code>ExpressionId</code> to which file it belongs.</p>
<p>I don't mind adding more tests if you have suggestions on how to test this, but I'll leave it at what I have for now. I do think that our benchmarks do a decent job at this anyway. I would hope that we would investigate a 12% perf regression ;)</p>
<p>I don't think there's a way to test deserialization in a meaningful before salsa adds persistent caching support.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-05 07:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2669 on 2024-11-05 07:56</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    fn call_type_doesnt_rerun_when_only_callee_changed() -&gt; anyhow::Result&lt;()&gt; {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2024-11-05 08:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-11-05 08:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-05 08:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-11-05 15:54</div>
            <div class="timeline-body"><p>The added test looks good to me, thank you!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 20:51:27 UTC
    </footer>
</body>
</html>
