<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] [WIP] SSA-style use-def map (unoptimized) - astral-sh/ruff #12900</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] [WIP] SSA-style use-def map (unoptimized)</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/12900">#12900</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2024-08-15 02:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body"><p>This uses the algorithm in https://c9x.me/compile/bib/braun13cc.pdf to do our use-def map in an SSA style, where there&#x27;s always only one visible definition for a symbol, and we use Phi definitions at control-flow merge points to merge the visible definitions from each path.</p>
<p>In a sense this is a synthesis between the first version (where we built a CFG and traversed it lazily in type inference) and the current code. This still associates uses with definitions directly in semantic indexing rather than lazily traversing in type inference, but it does the use-def association using memoized lazy traversal of a CFG.</p>
<p>Significant advantages I see of this approach:</p>
<ul>
<li>In scopes where we don’t need inferred public types for all symbols, it can save tracking metadata for symbols after the point where they are no longer used.</li>
<li>The Phi definitions allow us to cache union and intersection building and simplification (which will get more expensive as we add more to the type system and do proper subtype based simplification); in the current system this work is redone for every use of a symbol with multiple definitions/constraints.</li>
<li>It doesn’t require tracking an MxN matrix of definitions bs constraints for all symbols in building the use def map.</li>
</ul>
<p>It&#x27;s a significant regression right now, but it&#x27;s also missing some needed optimizations to avoid creating lots of unnecessary trivial Phi nodes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/carljm">@carljm</a> on 2024-08-15 02:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/carljm">@carljm</a> on 2024-08-15 02:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-08-15 02:18</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/cjm/phis">CodSpeed Performance Report</a>
Merging #12900 will <strong>degrade performances by 61.43%</strong>
<p>Comparing <code>cjm/phis</code> (bccc33c) with <code>main</code> (ac7b177)</p>
Summary
<p><code>❌ 2</code> regressions
<code>✅ 30</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/cjm/phis">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
Benchmarks breakdown
<p>|     | Benchmark | <code>main</code> | <code>cjm/phis</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ❌ | <code>red_knot_check_file[cold]</code> | 39 ms | 60.3 ms | -35.39% |
| ❌ | <code>red_knot_check_file[incremental]</code> | 1.6 ms | 4.1 ms | -61.43% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/carljm">@carljm</a> on 2024-08-15 02:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-08-15 02:31</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/carljm">@carljm</a> on 2024-08-15 02:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[WIP] working version of SSA-style use-def map&quot; to &quot;[red-knot] [WIP] SSA-style use-def map (unoptimized)&quot; by <a href="https://github.com/carljm">@carljm</a> on 2024-08-15 03:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-18 06:48</div>
            <div class="timeline-body"><p>@carljm should we close this PR as we don&#x27;t plan on landing it as is. It wouldn&#x27;t be gone. We can still find it in the closed PRs</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2024-10-18 18:12</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:06:04 UTC
    </footer>
</body>
</html>
