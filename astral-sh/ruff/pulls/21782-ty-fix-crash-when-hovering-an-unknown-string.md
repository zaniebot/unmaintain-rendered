```yaml
number: 21782
title: "[ty] Fix crash when hovering an unknown string annotation"
type: pull_request
state: merged
author: Gankra
labels:
  - bug
  - server
  - ty
assignees: []
merged: true
base: main
head: gankra/hover-crash
created_at: 2025-12-03T22:20:14Z
updated_at: 2025-12-04T08:11:42Z
url: https://github.com/astral-sh/ruff/pull/21782
synced_at: 2026-01-10T16:48:02Z
```

# [ty] Fix crash when hovering an unknown string annotation

---

_Pull request opened by @Gankra on 2025-12-03 22:20_

## Summary

I have no idea what I'm doing with the fix (all the interesting stuff is in the second commit).

The basic problem is the compiler emits the diagnostic:

```
x: "foobar"
    ^^^^^^
```

Which the supression code-action hands the end of to `Tokens::after` which then panics because that function panics if handed an offset that is in the middle of a token.

Fixes https://github.com/astral-sh/ty/issues/1748

## Test Plan

Many tests added (only the e2e test matters).


---

_Review requested from @carljm by @Gankra on 2025-12-03 22:20_

---

_Review requested from @AlexWaygood by @Gankra on 2025-12-03 22:20_

---

_Review requested from @sharkdp by @Gankra on 2025-12-03 22:20_

---

_Review requested from @dcreager by @Gankra on 2025-12-03 22:20_

---

_Review requested from @MichaReiser by @Gankra on 2025-12-03 22:20_

---

_Label `bug` added by @Gankra on 2025-12-03 22:21_

---

_Label `ty` added by @Gankra on 2025-12-03 22:21_

---

_Label `server` added by @Gankra on 2025-12-03 22:21_

---

_Review request for @AlexWaygood removed by @AlexWaygood on 2025-12-03 22:22_

---

_Comment by @astral-sh-bot[bot] on 2025-12-03 22:22_


<!-- generated-comment typing_conformance_diagnostics_diff -->


## Diagnostic diff on [typing conformance tests](https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance)

No changes detected when running ty on typing conformance tests ✅



---

_Comment by @Gankra on 2025-12-03 22:24_

Note that, despite all expectations from even me, this crash has *nothing* to do with all my IDE string annotation work. This is just a pure code-action bug.

---

_Comment by @astral-sh-bot[bot] on 2025-12-03 22:24_


<!-- generated-comment mypy_primer -->


## `mypy_primer` results


<details>
<summary>Changes were detected when running on open source projects</summary>

```diff
beartype (https://github.com/beartype/beartype)
- beartype/claw/_package/clawpkgtrie.py:66:29: warning[unsupported-base] Unsupported class base with type `<class 'dict[str, PackagesTrieBlacklist]'> | <class 'dict[str, Divergent]'>`
- beartype/claw/_package/clawpkgtrie.py:247:29: warning[unsupported-base] Unsupported class base with type `<class 'dict[str, PackagesTrieWhitelist]'> | <class 'dict[str, Divergent]'>`
- Found 494 diagnostics
+ Found 492 diagnostics

scikit-build-core (https://github.com/scikit-build/scikit-build-core)
+ src/scikit_build_core/_logging.py:153:13: warning[unsupported-base] Unsupported class base with type `<class 'Mapping[str, Style]'> | <class 'Mapping[str, Divergent]'>`
- Found 38 diagnostics
+ Found 39 diagnostics


```

</details>


No memory usage changes detected ✅



---

_Review request for @carljm removed by @carljm on 2025-12-03 22:50_

---

_Review comment by @MichaReiser on `crates/ty_server/tests/e2e/code_actions.rs`:315 on 2025-12-04 07:24_

Can we make this an integration test instead of an e2e test (they're so verbose and the snapshots are somewhat hard to review). See https://github.com/astral-sh/ruff/blob/258b1fd7ebca0587454c22c50b897787e03d2739/crates/ty_ide/src/code_action.rs#L86

---

_Review comment by @MichaReiser on `crates/ty_python_semantic/src/suppression.rs`:424 on 2025-12-04 07:32_

This feels rather fragile if we have to do this for many fixes, and we should explore alternative ways to handle string annotations if this becomes a frequent problem, or consider as an alternative solution for how to store types for expressions in stringified type annotations. 

Something I had in mind for a long time and that can also become handy if we ever want to support checking Python embedded in other languages (e.g. Python in Markdown) is the concept of virtual files. r-a has something very similar, where code references actual code in a file OR code generated by a macro. The way they solve this is by having a `HIRFile`. In our case, `HIRFile` would be a `salsa::Supertype` enum over:

```rust
#[derive(salsa::Supertype)]
enum HIRFile {
	File(File),
	/// Stringified type annotation, 
	EmbeddedExpression(EmbeddedExpression), 
	/// Python in a markdown file
	EmbeddedBlock(EmbeddedBlock),
}

#[salsa::interned]
struct EmbeddedExpression {
	file: File, // Or HIRFile to support markdown docstring in a python code snippet in a python file?
	range: TextRange,
}

#[salsa::Interned]
struct EmbeddedBlock {
	file: File,
	range: TextRange
}
```


`parsed_module` and `TypeInferenceBuilder` would take a `HIRFile` as an argument and so would other queries. Obviously, this requires more design work to flesh out the details. E.g., how does this work with looking up the scope? But it expresses the concept of nested ASTs (or even documents) in a more explicit way



---

_@MichaReiser approved on 2025-12-04 07:33_

---

_Comment by @sharkdp on 2025-12-04 08:11_

I'm merging this to include it in a release (after checking in with Micha), since it looks like the review comments can be addressed post-merge. 

---

_Merged by @sharkdp on 2025-12-04 08:11_

---

_Closed by @sharkdp on 2025-12-04 08:11_

---

_Branch deleted on 2025-12-04 08:11_

---
