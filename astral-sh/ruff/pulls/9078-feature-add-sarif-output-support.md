```yaml
number: 9078
title: "Feature: Add SARIF output support"
type: pull_request
state: merged
author: C-Hipple
labels:
  - linter
assignees: []
merged: true
base: main
head: feature-add-sarif-output
created_at: 2023-12-10T02:03:22Z
updated_at: 2023-12-19T20:15:24Z
url: https://github.com/astral-sh/ruff/pull/9078
synced_at: 2026-01-10T23:31:11Z
```

# Feature: Add SARIF output support

---

_Pull request opened by @C-Hipple on 2023-12-10 02:03_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

Adds support for sarif v2.1.0 output to cli, usable via the output-format paramter.  

`ruff . --output-format=sarif` 

Includes a few changes I wasn't sure of, namely:
* Adds a few derives for Clone & Copy, which I think could be removed with a little extra work as well. 

## Test Plan

<!-- How was it tested? -->

I built and ran this against several large open source projects and verified that the output sarif was valid, using [Microsoft's SARIF validator tool](https://sarifweb.azurewebsites.net/Validation)

I've also attached an output of the sarif generated by this version of ruff on the main branch of django at commit: b287af5dc9
[django_main_b287af5dc9_sarif.json](https://github.com/astral-sh/ruff/files/13626222/django_main_b287af5dc9_sarif.json)

Note: this needs to be regenerated with the latest changes and confirmed. 


## Open Points
[ ] Convert to just using all Rules all the time
[ ] Fix the issue with getting the file URI when compiling for web assembly 


---

_Renamed from "add sarif output--update snapshots" to "Feature: Add SARIF output support" by @C-Hipple on 2023-12-10 02:06_

---

_@charliermarsh reviewed on 2023-12-10 02:11_

---

_Review comment by @charliermarsh on `crates/ruff_cli/src/lib.rs`:427 on 2023-12-10 02:11_

So one potential issue here is that `pyproject_config` isn't guaranteed to contain the correct set of enabled rules for all files. Ruff supports hierarchical configuration, so you can have different configuration files that apply to different subdirectories in your project. The `pyproject_config` here really just represents the settings in the current working directory.

Could we infer the set of rules from the diagnostic messages? (What is this used for on the SARIF side?)

---

_Review comment by @charliermarsh on `crates/ruff_linter/src/message/sarif.rs`:105 on 2023-12-10 02:12_

Nit: we tend to `derive(Debug)` for all structs that can support it.

---

_@charliermarsh reviewed on 2023-12-10 02:12_

---

_@charliermarsh reviewed on 2023-12-10 02:14_

---

_Review comment by @charliermarsh on `crates/ruff_linter/src/message/sarif.rs`:129 on 2023-12-10 02:14_

If `filename` is relative here, would this convert it to absolute? I do think `filename` will always be absolute here... we pass around absolute paths, and expect callers to call `relativize_path` when displaying user-facing relative paths... But we may want to be defensive (call `.canonicalize()` or `normalize_path` or similar).

---

_@C-Hipple reviewed on 2023-12-10 02:18_

---

_Review comment by @C-Hipple on `crates/ruff_linter/src/message/sarif.rs`:129 on 2023-12-10 02:18_

This is what I was referring to in the PR body.  It'll error if the path is relative, which is why I changed the path in the snapshot files.  I'll update to safely handle relative paths, should be straight forward.  

---

_Comment by @github-actions[bot] on 2023-12-10 02:21_

<!-- generated-comment ecosystem -->
## `ruff-ecosystem` results
### Linter (stable)
âœ… ecosystem check detected no linter changes.

### Linter (preview)
âœ… ecosystem check detected no linter changes.

### Formatter (stable)
âœ… ecosystem check detected no format changes.

### Formatter (preview)
âœ… ecosystem check detected no format changes.




---

_@C-Hipple reviewed on 2023-12-10 02:25_

---

_Review comment by @C-Hipple on `crates/ruff_cli/src/lib.rs`:427 on 2023-12-10 02:25_

Gotcha--thanks for that context.  SARIF lists the rules applied as part of the tool description so that you can be sure you're getting an apples to apples comparison, rather than just saying both times you checked with a particular rust version.  

While the field is not mandatory in the SARIF specification [Section 3.19.23 rules property](https://docs.oasis-open.org/sarif/sarif/v2.1.0/errata01/os/sarif-v2.1.0-errata01-os-complete.html#_Toc141790806) it is [required by Github](https://docs.github.com/en/code-security/code-scanning/integrating-with-code-scanning/sarif-support-for-code-scanning).   Also see: [Understand Rules and Results](https://docs.github.com/en/code-security/code-scanning/integrating-with-code-scanning/sarif-support-for-code-scanning#understanding-rules-and-results)

I'm not exactly sure how github would handle having the `rules` be supplied as only the ones for which diagnostics could be found as that's not documented.  

---

_@charliermarsh reviewed on 2023-12-10 02:45_

---

_Review comment by @charliermarsh on `crates/ruff_linter/src/message/sarif.rs`:129 on 2023-12-10 02:45_

ðŸ‘ I did see that, but wasn't sure how `Url::from_file_path` would behave if the path wasn't absolute.

---

_@charliermarsh reviewed on 2023-12-10 02:46_

---

_Review comment by @charliermarsh on `crates/ruff_cli/src/lib.rs`:427 on 2023-12-10 02:46_

Alternatively, could we just include _all_ rules?

---

_@C-Hipple reviewed on 2023-12-10 03:03_

---

_Review comment by @C-Hipple on `crates/ruff_linter/src/message/sarif.rs`:129 on 2023-12-10 03:03_

yeah, `normalize_path` seems like the right call here, as `.canonicalize()` will fail if the file doesn't actually exist (a la in test).  

---

_@C-Hipple reviewed on 2023-12-10 03:07_

---

_Review comment by @C-Hipple on `crates/ruff_cli/src/lib.rs`:427 on 2023-12-10 03:07_

Including all rules is probably the safest bet.  In my experience with code scanning on github, I've never looked at what checks were done, only the findings, so this is probably closest to the SARIF expectation.  My gut is that most people have most rules applied, and only turn off a handful, but I could be wrong, especially for older/larger projects. 

Only downsides are if someone complains and then we change it, if others are using it in their CI, the rules set will change, which again, not sure how bad that is and that the file size will be a bit larger. 

---

_@C-Hipple reviewed on 2023-12-10 04:11_

---

_Review comment by @C-Hipple on `crates/ruff_linter/src/message/sarif.rs`:147 on 2023-12-10 04:11_

probably buggy

---

_@charliermarsh reviewed on 2023-12-10 15:09_

---

_Review comment by @charliermarsh on `crates/ruff_cli/src/lib.rs`:427 on 2023-12-10 15:09_

Let's try all-rules for now. You can iterate over them with `Rule::iter()`.

---

_@charliermarsh reviewed on 2023-12-12 22:38_

I think this is probably good to merge once we change to enumerate all-rules. @C-Hipple do you plan to make that change, or would you like a hand?

---

_Comment by @C-Hipple on 2023-12-13 01:53_

I was planning on making this change tonight/tomorrow, but if that falls
through I'll let you know as I'll be leaving on a trip.  Seems simple
enough and also fix the issue to build for wasm seems straightforward.

On Tue, Dec 12, 2023, 5:38â€¯PM Charlie Marsh ***@***.***>
wrote:

> ***@***.**** commented on this pull request.
>
> I think this is probably good to merge once we change to enumerate
> all-rules. @C-Hipple <https://github.com/C-Hipple> do you plan to make
> that change, or would you like a hand?
>
> â€”
> Reply to this email directly, view it on GitHub
> <https://github.com/astral-sh/ruff/pull/9078#pullrequestreview-1778552548>,
> or unsubscribe
> <https://github.com/notifications/unsubscribe-auth/ACBKSYUSPPC5AYNRJ5PRJ33YJDMIFAVCNFSM6AAAAABAOGQWJWVHI2DSMVQWIX3LMV43YUDVNRWFEZLROVSXG5CSMV3GSZLXHMYTONZYGU2TENJUHA>
> .
> You are receiving this because you were mentioned.Message ID:
> ***@***.***>
>


---

_Comment by @charliermarsh on 2023-12-13 03:52_

Nice, thanks @C-Hipple!

---

_Comment by @C-Hipple on 2023-12-13 04:24_

please don't merge it yet--I'm adding a few more sarif fields

---

_Comment by @charliermarsh on 2023-12-13 04:25_

@C-Hipple -- Okay, sounds good. I just removed some of the copy and clone changes since the code seems to compile without them now. I'll wait for you to mark as ready for review.

---

_Comment by @C-Hipple on 2023-12-13 04:26_

Thanks--your changes look good.  Appreciate your input there as I"m relatively new to rust and was kinda using this issue as a way of getting a bit more familiar. 

---

_Comment by @charliermarsh on 2023-12-13 04:28_

Any questions let me know. Sorry if I stepped on your toes, didn't realize you were planning more changes!

---

_Comment by @C-Hipple on 2023-12-13 04:39_

> @C-Hipple -- Okay, sounds good. I just removed some of the copy and clone changes since the code seems to compile without them now. I'll wait for you to mark as ready for review.

Yeah, those were needed at one point with how SarifResults were copying rules into them, was also planning on backing them out but you beat me to it. 

> Any questions let me know. Sorry if I stepped on your toes, didn't realize you were planning more changes!

no worries! 

---

_Comment by @C-Hipple on 2023-12-13 05:03_

@charliermarsh I'm happy with the PR now, but I'm really unsure of the last commit--the `anyhow` import was failing lint due to being unused in wasm and it was also failing lint for unnecessary wrapping, so I just ignored the errors, but open to learning if there's a more appropriate/idiomatic way

---

_Marked ready for review by @C-Hipple on 2023-12-13 05:07_

---

_Comment by @charliermarsh on 2023-12-13 05:22_

@C-Hipple -- What you have there is reasonable! But I'll play around with it and see if it can be improved.

---

_Comment by @charliermarsh on 2023-12-13 05:31_

@C-Hipple -- The only change I made was to use absolute references for the imports that were unused in the Wasm path. It's not a material difference, but it is nice to avoid the unused import ignore.


---

_Comment by @charliermarsh on 2023-12-13 05:32_

Unfortunately, `#[allow(clippy::unnecessary_wraps)]` is hard to avoid since we need the function to have the same signature on all platforms -- so if _any_ of them return a `Result`, they _all_ need to return a `Result`. We run into this in other parts of Ruff too.

---

_@charliermarsh approved on 2023-12-13 05:32_

---

_Label `linter` added by @charliermarsh on 2023-12-13 05:33_

---

_Merged by @charliermarsh on 2023-12-13 05:33_

---

_Closed by @charliermarsh on 2023-12-13 05:33_

---

_Branch deleted on 2023-12-19 20:15_

---
