<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Infer the Python version from `--python=&lt;system installation&gt;` on Unix - astral-sh/ruff #18550</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Infer the Python version from <code>--python=&lt;system installation&gt;</code> on Unix</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18550">#18550</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-06-08 13:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-08 13:29</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>If a user passes <code>--python=&lt;virtual_environment&gt;</code> and doesn't specify a Python version on the CLI or in a configuration file, we currently use the metadata in that virtual environment's <code>pyvenv.cfg</code> file to infer the Python version we should use for resolving modules and types. We currently do not attempt to infer the Python version if a user passes <code>--python=&lt;system_installation&gt;</code>, but it's easy enough to do that as well, providing the user is not on a Windows machine. This PR implements that.</p>
<h2>Test Plan</h2>
<p>CLI integration tests, and manual testing.</p>
<p>Screenshot of what this looks like on the CLI:</p>
<p><img src="https://github.com/user-attachments/assets/3f15c5b7-f6d9-44cc-aae1-c0947c5f22d4" alt="image" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-06-08 13:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-06-08 13:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-06-08 13:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @AlexWaygood on 2025-06-08 13:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2025-06-08 13:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @AlexWaygood on 2025-06-08 13:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dcreager removed by @AlexWaygood on 2025-06-08 13:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @AlexWaygood on 2025-06-08 13:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @AlexWaygood on 2025-06-08 13:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-08 13:34</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-08 13:39</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>âœ… ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>âœ… ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-08 13:56</div>
            <div class="timeline-body"><p>What makes it hard if the user is on a windows machine? I'd prefer if the CLI has consistent behavior across platforms.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-08 14:04</div>
            <div class="timeline-body"><blockquote>
<p>What makes it hard if the user is on a windows machine?</p>
</blockquote>
<p>Apologies â€” I left several comments about this in the source code but forgot to mention it in my PR description.</p>
<p>On Unix, the <code>site-packages</code> directory is always located at <code>&lt;sys.prefix&gt;/lib/pythonX.Y/site-packages</code> (with minor variations if it's a PyPy installation or a free-threaded installation), so we can just look at the parent directory of the resolved <code>site-packages</code> directory to get the information we need. On Windows, the <code>site-packages</code> directory is always located at <code>&lt;sys.prefix&gt;/Lib/site-packages</code>, so we can't infer the information we need from the directory structure of the installation.</p>
<blockquote>
<p>I'd prefer if the CLI has consistent behavior across platforms.</p>
</blockquote>
<p>Yeah, I also wasn't totally sure if this was worth the inconsistency. I think being able to infer the Python version correctly from the minimum number of config options is very high-value, though, and chatting with @zanieb at PyCon they also thought that this was probably worth it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-06-09 14:59</div>
            <div class="timeline-body"><p>Yeah on Windows you'd need to query the interpreter to infer the version. Or.. maybe you could get away with reading the registry and matching paths (but that seems more complicated than it's worth here!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-09 15:05</div>
            <div class="timeline-body"><blockquote>
<p>Or.. maybe you could get away with reading the registry and matching paths (but that seems more complicated than it's worth here!)</p>
</blockquote>
<p>yeah I definitely don't want to do that ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/python_version.rs</code>:131 on 2025-06-09 16:11</div>
            <div class="timeline-body"><p>Nit: Not sure if it's worth it because it's so simple but this is somewhat duplicated now with the serde deserialization logic below.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty/src/args.rs</code>:92 on 2025-06-09 16:14</div>
            <div class="timeline-body"><p>We should also update the <code>EnvironmentOptions::python_version</code> documentation.</p>
<p>The sentence here is somewhat complicated and I don't really feel wiser after reading other than: Okay, ty does some magic but I don't have good suggestions on how to make it clearer (other than trying to split the sentence into multiple sentences to avoid the many and/or)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty/tests/cli/python_environment.rs</code>:193 on 2025-06-09 16:15</div>
            <div class="timeline-body"><p>The comment here confused me a bit because I assumed it documents the test (which it obviously doesn't).</p>
<p>I think it would be easier to understand if we document the test. What is it testing and then explaining on why we only do this for unix</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/module_resolver/resolver.rs</code>:163 on 2025-06-09 16:18</div>
            <div class="timeline-body"><p>What does <code>from_metadata</code> mean here? Is it that the information comes from the <code>ProjectMetadata</code>? Or is it something else? If it's something else, then I'd prefer to either use a different name or extend the documentation (which suggests that it is from <code>pyenv</code>, in which case I would name it <code>pyenv_python_version</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/module_resolver/resolver.rs</code>:335 on 2025-06-09 16:19</div>
            <div class="timeline-body"><p>Nit: Maybe <code>to_python_version</code> to signify that this operation is no longer &quot;free&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/module_resolver/resolver.rs</code>:366 on 2025-06-09 16:21</div>
            <div class="timeline-body"><p>This won't strictly be the parent component. E.g if you have <code>D:\</code>, then the second last component is the ROOT component (or dir?).</p>
<p>Should this be using <code>ancestor</code> instead of <code>components</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/program.rs</code>:204 on 2025-06-09 16:23</div>
            <div class="timeline-body"><p>I think I still prefer not to have the values assigned. It's so noisy when making updates ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/program.rs</code>:43 on 2025-06-09 16:24</div>
            <div class="timeline-body"><p>Should we pass the <code>search_paths</code> to <code>resolve_python_version</code> instead to avoid calling <code>to_python_version</code> when <code>python_version_with_source</code> isn't <code>None</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-06-09 16:24</div>
            <div class="timeline-body"><p>Ty</p>
<p>Mainly a few comments around terminology.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-09 16:51</div>
            <div class="timeline-body"><p>Apologies for the <em>terrible</em> image quality of this screenshot (taken on an ancient Windows machine I have hanging around that does not have -- and will never have -- Rust installed on it). But it does look like it is possible to query the metadata of a Python binary on Windows without actually invoking that binary in a subprocess. The &quot;File version&quot; and &quot;Product version&quot; fields here both contain the Python version in them (obtained here by right-clicking on the <code>.exe</code> file in Windows Explorer, clicking on &quot;properties&quot;, and then nagivating to the &quot;Details&quot; tab).</p>
<p><img src="https://github.com/user-attachments/assets/ba81ca57-c18f-4c16-8683-3c6531ed44ff" alt="FDF1B5F7-4BFE-408C-B0F3-4DF8645C621F_1_201_a" /></p>
<p>The metadata appears consistent regardless of whether the binary was installed using &quot;official&quot; python.org installers or using uv.</p>
<p>From what I can tell, though, querying these <code>.exe</code>-file properties from Rust might not be trivial. So I'll definitely pass on it for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-06-09 16:55</div>
            <div class="timeline-body"><p>Oh that's cool.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-06-09 16:57</div>
            <div class="timeline-body"><p>That is cool indeed. cc @konstin we could use this to filter Python binaries more aggressively on Windows without querying the interpreter!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-09 17:20</div>
            <div class="timeline-body"><p>Here's a somewhat higher-quality screenshot since that last one appears to have generated some excitement ðŸ˜†
<img src="https://github.com/user-attachments/assets/4c219c8f-1c9b-4e3d-b946-141b4c09ec48" alt="ABF429DA-81BD-40D2-8B3E-13AFB1AE90B4_1_201_a" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-11 10:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/program.rs</code>:204 on 2025-06-11 10:18</div>
            <div class="timeline-body"><p>alright, alright!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-11 11:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_ast/src/python_version.rs</code>:131 on 2025-06-11 11:01</div>
            <div class="timeline-body"><p>This was bothering me too, especially because we also had duplicated logic in this third place:</p>
<p>https://github.com/astral-sh/ruff/blob/3aae1cd59b6490c72af055d28add6cc2f983e545/crates/ty_python_semantic/src/module_resolver/typeshed.rs#L331-L346</p>
<p>I've unified the three implementations.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-11 11:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/module_resolver/resolver.rs</code>:366 on 2025-06-11 11:07</div>
            <div class="timeline-body"><blockquote>
<p>E.g if you have <code>D:\</code>, then the second last component is the ROOT component (or dir?).</p>
</blockquote>
<p>I think we can be confident that that won't be the case here. We wouldn't have succeeded in resolving the <code>site-packages</code> directory unless that directory was the grandchild of the <code>sys.prefix</code> path. Should I add a comment?</p>
<blockquote>
<p>Should this be using <code>ancestor</code> instead of <code>components</code>?</p>
</blockquote>
<p>Hmm, I think that would be more fiddly to deal with? <code>ancestors</code> iterates over the ancestor paths (<code>&lt;path/to/site-packages&gt;.ancestors()</code> -&gt; <code>[&lt;path/to/site-packages&gt;, &lt;path/to&gt;, &lt;path&gt;]</code>), so I'd have to call <code>.file_name()</code> on each path yielded by the method to be able to inspect the information I'm interested in</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2025-06-11 11:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-11 11:41</div>
            <div class="timeline-body"><p>Is there anything specific you want me to re-review?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-11 11:45</div>
            <div class="timeline-body"><blockquote>
<p>Is there anything specific you want me to re-review?</p>
</blockquote>
<p>Are you okay with my response in https://github.com/astral-sh/ruff/pull/18550#discussion_r2139856680?</p>
<p><code>crates/ruff_python_ast/src/python_version.rs</code> and <code>crates/ty_python_semantic/src/module_resolver/typeshed.rs</code> have also seen significant changes since you last reviewed, as a result of your comment at https://github.com/astral-sh/ruff/pull/18550#discussion_r2136014362!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-11 14:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/module_resolver/resolver.rs</code>:366 on 2025-06-11 14:06</div>
            <div class="timeline-body"><p>Oh right, you only want components. A short comment might be helpful althought it might also be fine the way it is. Up to you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-06-11 14:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-06-11 14:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-11 14:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-11 15:14</div>
            <div class="timeline-body"><p>Sorry, I was in meetings. Do you still want me to re-review or are you okay, considering that you merged the change ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-11 15:18</div>
            <div class="timeline-body"><p>Ohh sorry! Still might be good for you to give the changes in <code>crates/ruff_python_ast/src/python_version.rs</code> and <code>crates/ty_python_semantic/src/module_resolver/typeshed.rs</code> a quick once-over (unifying our various <code>PythonVersion</code> deserialization methods) -- happy to revert/modify any of those changes if you dislike them!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-11 16:00</div>
            <div class="timeline-body"><p>Okay, I'll do so tomorrow</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 18:45:32 UTC
    </footer>
</body>
</html>
