<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix curly bracket spacing around curly f-string expressions - astral-sh/ruff #15471</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix curly bracket spacing around curly f-string expressions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15471">#15471</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-01-14 10:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-14 10:16</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes https://github.com/astral-sh/ruff/issues/15459</p>
<p>F-string expression need to leave one space between the element's <code>{</code> or <code>}</code> and any curly braces inside the expression itself or it results in invalid syntax:</p>
<pre><code class="language-python">f&quot;{ {1, 2, 3} }&quot;  # valid
f&quot;{{ 1, 2, 3}}&quot;  # invalid
</code></pre>
<p>The existing implementation handles this correctly if the expression itself has curly braces, but it doesn't add the necessary space if the expression starts or ends with an expression with curly parentheses:</p>
<pre><code class="language-python">-print(f&quot;{ {1, 2, 3} - {2} }&quot;)
-print(f&quot;{ {1: 2}.keys() }&quot;)
+print(f&quot;{{1, 2, 3} - {2}}&quot;)
+print(f&quot;{{1: 2}.keys()}&quot;)
</code></pre>
<p>This PR changes the formatter to check if the left-most sub expression (if any) starts with curly parentheses instead of just checking the expression itself.</p>
<h2>Test Plan</h2>
<p>Added snapshot tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2025-01-14 10:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2025-01-14 10:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-14 10:22</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Formatter (stable)</h3>
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<details><summary><a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)</summary>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to read examples/Assistants_API_overview_python.ipynb: Expected a Jupyter Notebook, which must be internally stored as JSON, but this file isn't valid JSON: expected `,` or `]` at line 197 column 8
</code></pre>
</p>
</details>

<h3>Formatter (preview)</h3>
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<details><summary><a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)</summary>
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to read examples/Assistants_API_overview_python.ipynb: Expected a Jupyter Notebook, which must be internally stored as JSON, but this file isn't valid JSON: expected `,` or `]` at line 197 column 8
</code></pre>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2025-01-14 10:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @MichaReiser on 2025-01-14 10:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @MichaReiser on 2025-01-14 16:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-01-15 06:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_formatter/src/other/f_string_element.rs</code>:214 on 2025-01-15 06:02</div>
            <div class="timeline-body"><p>I wonder if we should just check whether the leftmost expression has curly braces otherwise the formatter will add spaces to the following even though it's not required:</p>
<pre><code class="language-py">f&quot;{foo or {}}&quot;

# From the test case
print(f&quot;{1, 2, {3}}&quot;)
</code></pre>
<p>I think I'd consider the argument about maintaining consistency on both sides to be valid only when one of the side needs to add the curly brace.</p>
<p>Currently, the above snippet will be formatted as:</p>
<pre><code class="language-py">f&quot;{ foo or {} }&quot;

# From the test case
print(f&quot; {1, 2, {3} }&quot;)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @MichaReiser on 2025-01-15 08:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-01-15 08:20</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-01-15 08:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-01-15 08:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-15 08:22</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 20:34:30 UTC
    </footer>
</body>
</html>
