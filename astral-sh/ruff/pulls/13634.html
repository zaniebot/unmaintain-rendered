<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] feat: add `StringLiteral` and `LiteralString` comparison - astral-sh/ruff #13634</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] feat: add <code>StringLiteral</code> and <code>LiteralString</code> comparison</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13634">#13634</a>
        opened by <a href="https://github.com/Slyces">@Slyces</a>
        on 2024-10-04 19:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Slyces">@Slyces</a></div>
            <div class="timeline-body">

Summary
<p>Implements string lietral comparisons and fallbacks to <code>str</code> instance for <code>LiteralString</code>.
Completes an item in #13618</p>
Test Plan
<ul>
<li>Adds a dedicated test with non exhaustive cases</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/Slyces">@Slyces</a> on 2024-10-04 19:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/Slyces">@Slyces</a> on 2024-10-04 19:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/Slyces">@Slyces</a> on 2024-10-04 19:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-10-04 20:02</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>âœ… ecosystem check detected no linter changes.</p>
Linter (preview)
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2614 on 2024-10-05 05:40</div>
            <div class="timeline-body"><p>I don&#x27;t think this is doing what you intend, since <code>s1</code> and <code>s2</code> are <code>StringLiteralType</code> salsa interned structs. So what you&#x27;re actually comparing here is just the Salsa u32 IDs. I suspect a few more string comparison tests (specifically, one where the string created earlier in the source file is &quot;greater&quot; than one created later in the source file) will reveal the problem. You&#x27;ll need to use <code>s1.value(db)</code> and <code>s2.value(db)</code> like you do below in the &quot;in&quot; branch to actually compare the strings.</p>
<p>Let&#x27;s not even worry about whether Rust and Python have any weird edge-case differences in their lexicographic string ordering ðŸ˜† Probably not, and if so I suspect nobody will ever care anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:4166 on 2024-10-05 05:42</div>
            <div class="timeline-body"><p>Let&#x27;s add a test showing that <code>is</code> returns <code>Literal[False]</code> with unequal strings, and also both variants of <code>is not</code> (equal and unequal strings).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-05 05:43</div>
            <div class="timeline-body"><p>Looks great! I think we need a few more tests, in one case to catch a bug that also needs fixing, and in the other just for completeness.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/Slyces">@Slyces</a> on 2024-10-05 16:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-05 17:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2616 on 2024-10-05 17:02</div>
            <div class="timeline-body"><p>should this be a TODO rather than a note? I think ideally I&#x27;d want to check this and get it right. sounds like I might care about this more than @carljm though ðŸ˜†</p>
<p>tbh I think somebody will inevitably come up with some unicode corner case that doesn&#x27;t matter that much and report it as a bug. Maybe we should just avoid the problem entirely by short-circuiting if it&#x27;s not an ASCII string?</p>
<pre><code>                // For anything non-ASCII, don&#x27;t even try to infer precise literal types.
                // It would be complicated, it&#x27;s an unimportant edge case,
                // and Rust and Python probably do subtly different things
                // in their string methods for non-ASCII characters.
                let s1 = salsa_s1.value(self.db);
                if !s1.is_ascii() {
                    return Some(builtins_symbol_ty(self.db, &quot;bool&quot;).to_instance(self.db));
                }
                let s2 = salsa_s2.value(self.db);
                if !s2.is_ascii() {
                    return Some(builtins_symbol_ty(self.db, &quot;bool&quot;).to_instance(self.db));
                }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Slyces">@Slyces</a> reviewed on 2024-10-05 17:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Slyces">@Slyces</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2616 on 2024-10-05 17:06</div>
            <div class="timeline-body"><p>I think that&#x27;s better, good call!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-05 17:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2620 on 2024-10-05 17:10</div>
            <div class="timeline-body"><p>heh, now that you&#x27;ve accepted my suggestion, maybe we should add some tests with some emojis or something ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2614 on 2024-10-05 17:39</div>
            <div class="timeline-body"><p>Sorry to get back to this only after the change was made, but I feel pretty strongly we should not do this. It&#x27;s discriminatory against people using non ASCII strings ðŸ˜† seriously, it will be surprising if your type inference changes just because you add a non ASCII character in a string literal. We should provide the same level of behavior for all string literals that we support at all. If there&#x27;s an operation we don&#x27;t believe we can reasonably support for all string literals, we should just support it for none of them.</p>
<p>At the very least I think it&#x27;s important that we do support equality and inequality here. Salsa already interns all our string types based on rust string equality, so if it differs from Python string equality we have an issue that goes beyond this code.</p>
<p>I feel less strongly about comparison. But my preference would be to just support them all, assuming rust/python equivalence, and leave a note or TODO comment to dig deeper for possible edge cases. I think there is a pretty reasonable chance that this is all sufficiently well specified in Unicode that there actually is no problem.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-05 17:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-05 17:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2614 on 2024-10-05 17:47</div>
            <div class="timeline-body"><p>Fair enough, I withdraw this suggestion! I, on the other hand, do feel pretty strongly that we should actually check for corner cases here where Rust and Python differ in their handling of strings ;) So I would like us to at least leave a TODO comment (rather than just a note) to check this properly. Otherwise, as I say, I feel like it&#x27;s inevitable that we&#x27;ll get bug reports around this. Obviously it doesn&#x27;t come up that much in real-world code, but people love to hunt for this kind of corner case in static-analysis tools and report them ðŸ˜† And, you know, accuracy is nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Slyces">@Slyces</a> reviewed on 2024-10-05 17:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Slyces">@Slyces</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2614 on 2024-10-05 17:54</div>
            <div class="timeline-body"><p>I&#x27;m completely for a <code>// TODO</code>, won&#x27;t look into this myself just yet though</p>
<ul>
<li>Reverted both commits</li>
<li>Fixup&#x27;d the <code>Note:</code> into <code>TODO</code></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-10-05 17:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2614 on 2024-10-05 17:57</div>
            <div class="timeline-body"><p>I did a bit of looking, and it seems like both Python and rust have a pretty simple algorithm for the default string comparison: it&#x27;s just a simple lexicographic sort by Unicode code points. (The complexities happen when you get into locale aware sorting, which requires special libraries in either language.) And we should have the same Unicode code points in our literal strings, since we&#x27;re literally reading the same source text. (If we don&#x27;t, that&#x27;s a bug elsewhere, not here.)</p>
<p>So my conclusion is that we can just go ahead and do this, and there&#x27;s no need for either a note or a todo comment! Sorry for even raising the question unnecessarily instead of doing the research the first time ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/Slyces">@Slyces</a> on 2024-10-05 17:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/Slyces">@Slyces</a> on 2024-10-05 17:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Slyces">@Slyces</a> reviewed on 2024-10-05 17:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Slyces">@Slyces</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2614 on 2024-10-05 17:59</div>
            <div class="timeline-body"><p>We could have done the research as well, so the blame is shared :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-05 18:00</div>
            <div class="timeline-body"><p>You need to switch to using the new APIs you introduced an hour ago in https://github.com/astral-sh/ruff/commit/1c2cafc1010ebfe59573c8dbaf57dc97db192f3c ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-05 18:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2653 on 2024-10-05 18:12</div>
            <div class="timeline-body"><pre><code>                self.infer_binary_type_comparison(KnownClass::Str.to_instance(self.db), op, right)
            }
            (_, Type::StringLiteral(_)) =&gt; {
                self.infer_binary_type_comparison(left, op, KnownClass::Str.to_instance(self.db))
            }

            (Type::LiteralString, _) =&gt; {
                self.infer_binary_type_comparison(KnownClass::Str.to_instance(self.db), op, right)
            }
            (_, Type::LiteralString) =&gt; {
                self.infer_binary_type_comparison(left, op, KnownClass::Str.to_instance(self.db))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Slyces">@Slyces</a> reviewed on 2024-10-05 18:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Slyces">@Slyces</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2653 on 2024-10-05 18:13</div>
            <div class="timeline-body"><p>Saw around the same time, a fixup&#x27;s already pushed</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-10-05 18:15</div>
            <div class="timeline-body"><p>LGTM</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-10-05 19:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/carljm">@carljm</a> on 2024-10-05 19:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2024-10-05 19:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-10-05 19:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-07 08:45</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:07:13 UTC
    </footer>
</body>
</html>
