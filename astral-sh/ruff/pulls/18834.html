<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply fix availability and applicability when adding to `DiagnosticGuard` and remove `NoqaCode::rule` - astral-sh/ruff #18834</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Apply fix availability and applicability when adding to <code>DiagnosticGuard</code> and remove <code>NoqaCode::rule</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18834">#18834</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-06-20 20:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a></div>
            <div class="timeline-body">Summary
<p>This PR removes the last two places we were using <code>NoqaCode::rule</code> in <code>linter.rs</code> (see <a href="https://github.com/astral-sh/ruff/pull/18391">astral-sh/ruff#18391</a>#discussion_r2154637329 and <a href="https://github.com/astral-sh/ruff/pull/18391">astral-sh/ruff#18391</a>#discussion_r2154649726) by  checking whether fixes are actually desired before adding them to a <code>DiagnosticGuard</code>. I implemented this by storing a <code>Violation</code>&#x27;s <code>Rule</code> on the <code>DiagnosticGuard</code> so that we could check if it was enabled in the embedded <code>LinterSettings</code> when trying to set a fix.</p>
<p>All of the corresponding <code>set_fix</code> methods on <code>OldDiagnostic</code> were now unused (except in tests where I just set <code>.fix</code> directly), so I moved these to the guard instead of keeping both sets.</p>
<p>The very last place where we were using <code>NoqaCode::rule</code> was in the cache. I just reverted this to parsing the <code>Rule</code> from the name. I had forgotten to update the comment there anyway. Hopefully this doesn&#x27;t cause too much of a perf hit.</p>
<p>In terms of binary size, we&#x27;re back down almost to where <code>main</code> was two days ago (<a href="https://github.com/astral-sh/ruff/pull/18391">astral-sh/ruff#18391</a>#discussion_r2155034320):</p>
<pre><code>41,559,344 bytes for main 2 days ago
41,669,840 bytes for #18391
41,653,760 bytes for main now (after #18391 merged)
41,602,224 bytes for this branch
</code></pre>
<p>Only 43 kb up, but that shouldn&#x27;t all be me this time :)</p>
Test Plan
<p>Existing tests and benchmarks on this PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-20 20:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-20 20:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-20 20:36</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-20 20:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-20 20:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-21 16:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/cache.rs</code>:445 on 2025-06-21 16:05</div>
            <div class="timeline-body"><p>This now seems to be the only reason why we need 	<code>::strum_macros::EnumString</code> which requires a fair amount of code just to make this work.</p>
<p>I think we can get something comparable without going through rule by building an ad-hoc interner by rule id:</p>
<pre><code>			// Create an index map that maps rule name to index
			let mut rules = indexmap::IndexMap::new();
			
			// ...

			// In filter map, retrieve the index or insert the rule with a new index

                let len = rules.len();
                let rule_index = rules.entry(msg.noqa_code()?).or_insert(len);

                Some((*rule_index, msg))

			// ...

			// Store the rule index on `LintCachedData
			let rules = rules.into_keys().map(|code| code.to_string()).collect();
		 
       Self {
            messages,
            source,
            rules,
            notebook_index,
        }
</code></pre>
<p>The deserialization can then lookup the rule in <code>rules</code> and clone the value.</p>
<p>This will also allow us to remove the <code>Serialize</code> and <code>Deserialize</code> derive from <code>Rule</code></p>
<p>(And I think we can remove <code>Ord</code>, <code>PartialOrd</code>, and <code>CacheKey</code> too</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:3252 on 2025-06-21 16:11</div>
            <div class="timeline-body"><p>Does this match Ruff&#x27;s current behavior? Does that mean, we won&#x27;t even <strong>show</strong> fixes when the fix is disabled. This seems wrong to me.</p>
<p>I&#x27;m not suggesting we should necessarily change this in this PR but we should at least open an issue for what I consider a bug. Instead, Ruff should keep the fix (but mark it in some way) and we then skip it when applying automatic fixes (and we don&#x27;t show it in the LSP although I think even that would be fine).</p>
<p>Which makes me wonder. Should <code>should_fix == False</code> resolve to manual applicability?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-06-21 16:14</div>
            <div class="timeline-body"><p>Nice, I think we can remove some more code by not using <code>Rule</code> in the cache.</p>
<p>We should also double check if this exactly captures today&#x27;s behavior. E.g. does the LSP not show fixes for rules with <code>should_fix = false</code>? Do we show the fixes in diagnostics?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-21 18:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:3252 on 2025-06-21 18:10</div>
            <div class="timeline-body"><p>Yes, this does seem to match the current behavior in both the <a href="https://play.ruff.rs/a5f9247e-5ada-4670-bd1a-f96eaeb790ab">playground</a> and in VS Code, with the caveat that I couldn&#x27;t get a <code>ruff.toml</code> like</p>
<pre><code>[lint]
unfixable = [&quot;F401&quot;]
</code></pre>
<p>to work in VS Code, only setting it in my <code>settings.json</code> actually applied. This might be a bug too, unless I was doing something wrong.</p>
<p>I think the LSP filters out fixes with display-only applicability here:</p>
<p>https://github.com/astral-sh/ruff/blob/b2b65e72eba8222f157fe3417ff7bf3ef034d122/crates/ruff_server/src/lint.rs#L247</p>
<p>But if we change that to <code>DisplayOnly</code> and change the code here to</p>
<pre><code>        if !self.context.rules.should_fix(self.rule) {
            self.fix = Some(fix.with_applicability(Applicability::DisplayOnly));
            return;
        }
</code></pre>
<p>we can show display-only fixes in the editor, even if they&#x27;re disabled. That definitely makes sense to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-21 19:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff/src/cache.rs</code>:445 on 2025-06-21 19:07</div>
            <div class="timeline-body"><p>What is the type of the <code>IndexMap</code> here? I think we still need to get back to the <code>Rule</code> because it&#x27;s needed to reconstruct the <code>OldDiagnostic</code> in <code>OldDiagnostic::lint</code>.</p>
<p>Another option here could be <code>Rule::from_code(&amp;msg.noqa_code()?.to_string()).ok()?)</code>. And then we could store the <code>Rule</code> as its <code>repr(u16)</code> in the cache. That should allow us to remove all of the same derives? (Although it does add back one derive: <code>strum_macros::FromRepr</code> for the conversion in the other direction)</p>
Patch

<pre><code>diff --git a/crates/ruff/src/cache.rs b/crates/ruff/src/cache.rs
index fdaf6b4a7..14710027a 100644
--- a/crates/ruff/src/cache.rs
+++ b/crates/ruff/src/cache.rs
@@ -356,7 +356,8 @@ impl FileCache {
                             msg.parent,
                             file.clone(),
                             msg.noqa_offset,
-                            msg.rule,
+                            Rule::from_repr(msg.rule)
+                                .expect(&quot;Expected a valid rule repr in the cache&quot;),
                         )
                     })
                     .collect()
@@ -442,7 +443,7 @@ impl LintCacheData {
             // Parse the kebab-case rule name into a `Rule`. This will fail for syntax errors, so
             // this also serves to filter them out, but we shouldn&#x27;t be caching files with syntax
             // errors anyway.
-            .filter_map(|msg| Some((msg.name().parse().ok()?, msg)))
+            .filter_map(|msg| Some((Rule::from_code(&amp;msg.noqa_code()?.to_string()).ok()?, msg)))
             .map(|(rule, msg)| {
                 // Make sure that all message use the same source file.
                 assert_eq!(
@@ -451,7 +452,7 @@ impl LintCacheData {
                     &quot;message uses a different source file&quot;
                 );
                 CacheMessage {
-                    rule,
+                    rule: rule as u16,
                     body: msg.body().to_string(),
                     suggestion: msg.suggestion().map(ToString::to_string),
                     range: msg.range(),
@@ -475,7 +476,7 @@ impl LintCacheData {
 pub(super) struct CacheMessage {
     /// The rule for the cached diagnostic.
     #[bincode(with_serde)]
-    rule: Rule,
+    rule: u16,
     /// The message body to display to the user, to explain the diagnostic.
     body: String,
     /// The message to display to the user, to explain the suggested fix.
diff --git a/crates/ruff_macros/src/map_codes.rs b/crates/ruff_macros/src/map_codes.rs
index 39993af6a..6f9b0d043 100644
--- a/crates/ruff_macros/src/map_codes.rs
+++ b/crates/ruff_macros/src/map_codes.rs
@@ -433,13 +433,8 @@ fn register_rules&lt;&#x27;a&gt;(input: impl Iterator&lt;Item = &amp;&#x27;a Rule&gt;) -&gt; TokenStream {
             Copy,
             Clone,
             Hash,
-            PartialOrd,
-            Ord,
-            ::ruff_macros::CacheKey,
             ::strum_macros::IntoStaticStr,
-            ::strum_macros::EnumString,
-            ::serde::Serialize,
-            ::serde::Deserialize,
+            ::strum_macros::FromRepr,
         )]
         #[repr(u16)]
         #[strum(serialize_all = &quot;kebab-case&quot;)]
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-21 19:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/cache.rs</code>:445 on 2025-06-21 19:27</div>
            <div class="timeline-body"><p>Hmm I see. It&#x27;s because of the <code>&amp;&#x27;static str</code> in <code>LintId</code>. I don&#x27;t think what I suggested then makes sense. But this does feel unfortunate. It particularly annoys me that <code>filter_map</code> seems a bit like a footgun. It&#x27;s very easy to filter out too many diagnostics (e.g. if Ruff ever starts using any other <code>DiagnosticId</code> other than syntax error). It even becomes more fragile when we make <code>noqa_code</code> (secondary code) an <code>Option</code> on <code>ruff_db::Diagnostic</code>.</p>
<p>I think the options are:</p>
<ul>
<li>Make <code>LintName</code> use a <code>String</code>. Which doesn&#x27;t feel great as well</li>
<li>implement a serialize and deserialize function (in ruff) for <code>LintId</code>. That&#x27;s probably the way to go but I&#x27;m okay to defer this to another PR.</li>
</ul>
<p>It&#x27;s unfortunate that we can&#x27;t remove all <code>FromRepr</code> calls or is there a way to get to the rule from the <code>LintName</code>? I think that would be better if possible</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff/src/cache.rs</code>:445 on 2025-06-23 14:35</div>
            <div class="timeline-body"><p>I think if we kept only <code>EnumString</code>, we could serialize the <code>LintName</code> as a <code>String</code> here and then parse back to a rule when deserializing. That should eliminate all of the derives except <code>EnumString</code>. Would that be any better?</p>
<p>Then we could also replace this <code>filter_map</code> with a <code>filter(|msg| !msg.is_syntax_error())</code>, I think. Although that still doesn&#x27;t really address using other <code>DiagnosticId</code>s since I don&#x27;t think those could be parsed back to <code>Rule</code>s either.</p>
<p>But yeah, we&#x27;re just using the <code>Rule</code> to retrieve the <code>&amp;&#x27;static str</code> lint name. Otherwise we could just (de)serialize the lint name and the <code>Option&lt;NoqaCode&gt;</code> (well, probably as an <code>Option&lt;String&gt;</code>) directly.</p>
<p>How are we planning to handle this caching in ty? It seems like there would be issues with the <code>&amp;&#x27;static str</code> there too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-23 14:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-23 14:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/cache.rs</code>:445 on 2025-06-23 14:38</div>
            <div class="timeline-body"><blockquote>
<p>I think if we kept only EnumString, we could serialize the LintName as a String here and then parse back to a rule when deserializing. That should eliminate all of the derives except EnumString. Would that be any better?</p>
</blockquote>
<p>I&#x27;m not sure what you mean by <code>EnumString</code>.</p>
<blockquote>
<p>How are we planning to handle this caching in ty? It seems like there would be issues with the &amp;&#x27;static str there too.</p>
</blockquote>
<p>Yes, I think we would have the same issue. I think going through <code>Rule</code>s here is probably fine (that&#x27;s what I would do in ty).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-23 14:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:3252 on 2025-06-23 14:39</div>
            <div class="timeline-body"><p>Let&#x27;s create a follow up issue for this. I think it requires some design work on how we want to handle them in the LSP.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-23 14:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff/src/cache.rs</code>:445 on 2025-06-23 14:46</div>
            <div class="timeline-body"><p>I mean <code>::strum_macros::EnumString</code>, which I thought spawned this thread. We&#x27;re currently using <code>EnumString</code> to parse a rule name to a <code>Rule</code> when <em>serializing</em>. But if the goal is to remove several derive macros, we could instead serialize the string and call <code>name.parse().unwrap()</code> when <em>deserializing</em>. That would remove the need for all of these macros[^1]:</p>
<p>https://github.com/astral-sh/ruff/blob/291413b126ad44adc60fe3374ab5020d5659b92c/crates/ruff_macros/src/map_codes.rs#L456-L462</p>
<p><em>except</em> <code>EnumString</code>, which was the original target. I may have lost the thread here, though, if you meant something else entirely.</p>
<p>[^1]: We also still need <code>IntoStaticStr</code>, which we use for the <code>Display</code> implementation, but that&#x27;s a bit beside the point.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-23 14:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/cache.rs</code>:445 on 2025-06-23 14:53</div>
            <div class="timeline-body"><p>Ahh, sorry. That&#x27;s on me. My main goal was to avoid needing to go back to <code>Rule</code>.</p>
<p>I don&#x27;t think I feel very strongly about this. Removing <code>EnumString </code> would definitely be nice and I could see other ways to avoid the <code>name.parse()</code> overhead (... bring back my interner ;)).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-23 14:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff/src/cache.rs</code>:445 on 2025-06-23 14:58</div>
            <div class="timeline-body"><p>Sounds good, I think I&#x27;ll merge this for now then. I think there will definitely be an interner in our future! :smile:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-24 14:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-24 14:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-24 14:08</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:15:45 UTC
    </footer>
</body>
</html>
