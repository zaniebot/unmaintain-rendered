<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix AST visitor traversal order - astral-sh/ruff #5221</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix AST visitor traversal order</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5221">#5221</a>
        opened by <a href="https://github.com/jgberry">@jgberry</a>
        on 2023-06-20 17:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jgberry">@jgberry</a></div>
            <div class="timeline-body">

Summary
<p>According to the AST visitor documentation, the AST visitor &quot;visits all nodes in the AST recursively in evaluation-order&quot;. However, the current traversal fails to meet this specification in a few places.</p>
Function traversal
<pre><code>order = []
@(order.append(&quot;decorator&quot;) or (lambda x: x))
def f(
    posonly: order.append(&quot;posonly annotation&quot;) = order.append(&quot;posonly default&quot;),
    /,
    arg: order.append(&quot;arg annotation&quot;) = order.append(&quot;arg default&quot;),
    *args: order.append(&quot;vararg annotation&quot;),
    kwarg: order.append(&quot;kwarg annotation&quot;) = order.append(&quot;kwarg default&quot;),
    **kwargs: order.append(&quot;kwarg annotation&quot;)
) -&gt; order.append(&quot;return annotation&quot;):
    pass
print(order)
</code></pre>
<p>Executing the above snippet using CPython 3.10.6 prints the following result (formatted for readability):</p>
<pre><code>[
    &#x27;decorator&#x27;,
    &#x27;posonly default&#x27;,
    &#x27;arg default&#x27;,
    &#x27;kwarg default&#x27;,
    &#x27;arg annotation&#x27;,
    &#x27;posonly annotation&#x27;,
    &#x27;vararg annotation&#x27;,
    &#x27;kwarg annotation&#x27;,
    &#x27;kwarg annotation&#x27;,
    &#x27;return annotation&#x27;,
]
</code></pre>
<p>Here we can see that decorators are evaluated first, followed by argument defaults, and annotations are last. The current traversal of a function&#x27;s AST does not align with this order.</p>
Annotated assignment traversal
<pre><code>order = []
x: order.append(&quot;annotation&quot;) = order.append(&quot;expression&quot;)
print(order)
</code></pre>
<p>Executing the above snippet using CPython 3.10.6 prints the following result:</p>
<pre><code>[&#x27;expression&#x27;, &#x27;annotation&#x27;]
</code></pre>
<p>Here we can see that an annotated assignments annotation gets evaluated after the assignment&#x27;s expression. The current traversal of an annotated assignment&#x27;s AST does not align with this order.</p>
Why?
<p>I&#x27;m slowly working on #3946 and porting over some of the logic and tests from ssort. ssort is very sensitive to AST traversal order, so ensuring the utmost correctness here is important.</p>
Test Plan
<p>There doesn&#x27;t seem to be existing tests for the AST visitor, so I didn&#x27;t bother adding tests for these very subtle changes. However, this behavior will be captured in the tests for the PR which addresses #3946.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-20 17:55</div>
            <div class="timeline-body"><p>Nice, thank you -- this makes sense.</p>
<p>We actually end up overriding this behavior in the core AST checker (which implements the <code>Visitor</code> trait), because we evaluate the defaults vs. the arguments in different scopes. The defaults are evaluated in the enclosing scope, while the arguments are evaluated within the function scope (since they inject new symbols into the scope). So, that&#x27;s at least one reason why we may not have noticed this (and it&#x27;s not a risky change).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_ast/src/visitor.rs</code>:639 on 2023-06-20 18:00</div>
            <div class="timeline-body"><p>I wonder if we instead need to change how we walk over these such that, in <code>walk_arguments</code>, we walk over the defaults, then the arguments... We may want to remove <code>visit_arg_with_default</code> from the interface entirely. ðŸ¤”</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-20 18:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-06-20 18:15</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>âœ… ecosystem check detected no changes.</p>
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      6.4Â±0.01ms     6.4 MB/sec    1.00      6.4Â±0.01ms     6.4 MB/sec
formatter/numpy/ctypeslib.py               1.01   1357.4Â±3.57Âµs    12.3 MB/sec    1.00   1347.1Â±3.96Âµs    12.4 MB/sec
formatter/numpy/globals.py                 1.00    132.6Â±0.16Âµs    22.3 MB/sec    1.00    133.1Â±0.16Âµs    22.2 MB/sec
formatter/pydantic/types.py                1.01      2.6Â±0.01ms     9.6 MB/sec    1.00      2.6Â±0.01ms     9.7 MB/sec
linter/all-rules/large/dataset.py          1.00     13.0Â±0.05ms     3.1 MB/sec    1.02     13.2Â±0.07ms     3.1 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.3Â±0.01ms     5.0 MB/sec    1.00      3.3Â±0.01ms     5.1 MB/sec
linter/all-rules/numpy/globals.py          1.00    423.9Â±0.80Âµs     7.0 MB/sec    1.01    427.9Â±0.64Âµs     6.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.8Â±0.01ms     4.4 MB/sec    1.01      5.8Â±0.02ms     4.4 MB/sec
linter/default-rules/large/dataset.py      1.00      6.6Â±0.01ms     6.2 MB/sec    1.01      6.6Â±0.02ms     6.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1451.8Â±2.15Âµs    11.5 MB/sec    1.03   1489.9Â±2.87Âµs    11.2 MB/sec
linter/default-rules/numpy/globals.py      1.00    167.2Â±0.29Âµs    17.6 MB/sec    1.02    171.0Â±0.39Âµs    17.3 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.0Â±0.01ms     8.5 MB/sec    1.02      3.1Â±0.01ms     8.4 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      7.8Â±0.10ms     5.2 MB/sec    1.00      7.8Â±0.11ms     5.2 MB/sec
formatter/numpy/ctypeslib.py               1.00  1584.0Â±18.99Âµs    10.5 MB/sec    1.01  1601.2Â±27.46Âµs    10.4 MB/sec
formatter/numpy/globals.py                 1.00    152.6Â±4.54Âµs    19.3 MB/sec    1.03    157.8Â±6.44Âµs    18.7 MB/sec
formatter/pydantic/types.py                1.01      3.2Â±0.07ms     8.0 MB/sec    1.00      3.2Â±0.04ms     8.0 MB/sec
linter/all-rules/large/dataset.py          1.02     16.1Â±0.22ms     2.5 MB/sec    1.00     15.8Â±0.23ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.05      4.3Â±0.11ms     3.9 MB/sec    1.00      4.1Â±0.06ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.00    498.5Â±7.59Âµs     5.9 MB/sec    1.00    500.5Â±8.64Âµs     5.9 MB/sec
linter/all-rules/pydantic/types.py         1.03      7.2Â±0.18ms     3.5 MB/sec    1.00      7.0Â±0.10ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.02      8.3Â±0.15ms     4.9 MB/sec    1.00      8.1Â±0.10ms     5.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1737.3Â±26.86Âµs     9.6 MB/sec    1.00  1738.1Â±23.87Âµs     9.6 MB/sec
linter/default-rules/numpy/globals.py      1.00    196.1Â±3.61Âµs    15.0 MB/sec    1.01    198.8Â±5.90Âµs    14.8 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.7Â±0.06ms     6.9 MB/sec    1.00      3.7Â±0.07ms     6.9 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jgberry">@jgberry</a> reviewed on 2023-06-20 18:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jgberry">@jgberry</a> on <code>crates/ruff_python_ast/src/visitor.rs</code>:639 on 2023-06-20 18:35</div>
            <div class="timeline-body"><p>Yeah, that&#x27;s the way I originally implemented it, but after resolving the conflicts from #5192, this seemed to be the simplest way to do things. I&#x27;m open to restructuring, but it would make this PR more involved.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;AST visitor: walk arguments in correct order&quot; to &quot;Fix AST visitor traversal order&quot; by <a href="https://github.com/jgberry">@jgberry</a> on 2023-06-20 21:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jgberry">@jgberry</a> on 2023-06-20 21:45</div>
            <div class="timeline-body"><p>I&#x27;ve updated this PR to be more a general &quot;fix-all&quot; for a few different traversal order issues I&#x27;ve run into while working on #3946. The PR summary has been updated to reflect these changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_ast/src/visitor.rs</code>:639 on 2023-06-21 16:57</div>
            <div class="timeline-body"><p>This won&#x27;t necessarily visit in the described order though. Given:</p>
<pre><code>def f(
  x: int = 1,
  y : float = 2.0,
):
  ...
</code></pre>
<p>This would visit <code>1</code>, then <code>int</code>, then <code>2.0</code>, then <code>float</code>. I thought you were looking to enforce <code>1</code>, then <code>2.0</code>, then <code>int</code>, then <code>float</code>. Is this change sufficient? I&#x27;m fine with either but the latter seems &quot;more correct&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-21 16:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jgberry">@jgberry</a> reviewed on 2023-06-21 17:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jgberry">@jgberry</a> on <code>crates/ruff_python_ast/src/visitor.rs</code>:639 on 2023-06-21 17:49</div>
            <div class="timeline-body"><p>Yes, you&#x27;re right. This doesn&#x27;t completely solve the issue. But, given as given as function arguments are now walked one by one, it wouldn&#x27;t be possible to traverse them in the correct order without removing or avoiding calling <code>visit_arg_with_default</code>. I think the simplest solution would be to have <code>walk_arguments</code> handle all argument traversal and never call <code>visit_arg_with_default</code>, but this isn&#x27;t the cleanest in my opinion. I&#x27;ll throw this change in though and you can let me know what you think.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jgberry">@jgberry</a> reviewed on 2023-06-21 18:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jgberry">@jgberry</a> on <code>crates/ruff_python_ast/src/visitor.rs</code>:639 on 2023-06-21 18:37</div>
            <div class="timeline-body"><p>Hmm, this became unbearably messy for my tastes. The problem is we need to call <code>visit_arg</code> with a <code>ArgWithDefault</code>, so we have to convert an <code>ArgWithDefault</code> to just a plain <code>Arg</code>... but then there are lifetime issues to resolve and the whole thing blows up. I&#x27;m inclined to leave this as is for now. Yes, it&#x27;s not completely correct, but it&#x27;s so subtle that I don&#x27;t anticipate it causing issues.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-21 18:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_ast/src/visitor.rs</code>:639 on 2023-06-21 18:40</div>
            <div class="timeline-body"><p>Hah, ok -- that&#x27;s fine, lets see how it goes, this is clearly an improvement.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-21 18:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-21 18:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-21 18:41</div>
            <div class="timeline-body"><p>Thanks! I love the PR summary too, very clear.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-06-21 20:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:54:41 UTC
    </footer>
</body>
</html>
