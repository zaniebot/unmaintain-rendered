<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] remove erroneous canonicalize - astral-sh/ruff #21405</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] remove erroneous canonicalize</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21405">#21405</a>
        opened by <a href="https://github.com/Gankra">@Gankra</a>
        on 2025-11-12 14:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a></div>
            <div class="timeline-body"><p>Alternative implementation to <a href="https://github.com/astral-sh/ruff/pull/21052">astral-sh/ruff#21052</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-12 14:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-12 14:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-12 14:14</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-12 14:15</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>scikit-build-core (https://github.com/scikit-build/scikit-build-core)
- src/scikit_build_core/build/wheel.py:98:20: error[no-matching-overload] No overload of bound method `__init__` matches arguments
- Found 45 diagnostics
+ Found 44 diagnostics


</code></pre>



Memory usage changes were detected when running on open source projects

<pre><code>flake8 (https://github.com/pycqa/flake8)
- TOTAL MEMORY USAGE: ~63MB
+ TOTAL MEMORY USAGE: ~66MB


</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-12 14:15</div>
            <div class="timeline-body"><p>I&#x27;m claiming this is erroneous based on the fact that this canonicalize appears from seemingly nowhere in this commit:</p>
<p>https://github.com/astral-sh/ruff/commit/ddd4bab67c6d94eea312e4951fcc2c7bc8299fa4</p>
<p>And removing it seems to fix the homebrew crasher without breaking anything else. I otherwise have no good intuition about it.</p>
<p>cc @BurntSushi</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-12 14:20</div>
            <div class="timeline-body"><p>(diagnostic change is the flake that&#x27;s going around... memory usage change might be Why burntsushi made this change)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-12 14:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-12 14:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-12 14:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-12 14:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-12 14:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-12 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-11-12 14:42</div>
            <div class="timeline-body"><p>Removing the <code>canonicalize</code> here looks correct to me. If it&#x27;s needed for correctness (for whatever reason), than it should be moved here instead:</p>
<p>https://github.com/astral-sh/ruff/blob/376571eed196e05f42e271fbe8357e96fafa5bd3/crates/ty_python_semantic/src/module_resolver/resolver.rs#L289-L292</p>
<p>But I&#x27;m inclined to just ship this as is</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-12 14:59</div>
            <div class="timeline-body"><p>Do we have any reasonable way to test this..?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-12 15:43</div>
            <div class="timeline-body"><p>You could add a CLI test. We also have some file watching tests exercising symlinks.</p>
<p>https://github.com/astral-sh/ruff/blob/376571eed196e05f42e271fbe8357e96fafa5bd3/crates/ty/tests/file_watching.rs#L1395</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-12 19:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-12 19:44</div>
            <div class="timeline-body"><p>Awesome thank you micha!</p>
<p>That was <em>frustratingly</em> hard to get the right minimal conditions for the thing to reproduce in tests but I got it working, and this fix indeed fixes it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-12 20:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-12 20:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-11-12 20:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-11-14 12:47</div>
            <div class="timeline-body"><p>Thanks! I don&#x27;t remember why I added this. I&#x27;m usually pretty skeptical of <code>canonicalize</code>.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:20:31 UTC
    </footer>
</body>
</html>
