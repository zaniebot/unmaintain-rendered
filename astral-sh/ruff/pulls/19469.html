<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Make tuple subclass constructors sound - astral-sh/ruff #19469</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Make tuple subclass constructors sound</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19469">#19469</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-07-21 17:35
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>https://github.com/astral-sh/ruff/pull/18987 only partly implemented the special-casing required to make tuple instantiations sound. While that PR made instantiations of <code>tuple</code> itself sound, it did not make instantiations of tuple subclasses sound, as the way in which that PR added the special casing did not mean that the synthesized constructor signatures would be automatically inherited by subclasses. This PR fixes that by moving the special casing to a lower level, inside <code>ClassType::own_class_member</code>.</p>
<h2>Test Plan</h2>
<p>Mdtests added. Some existing mdtests also had to be slightly modified because they were unsoundly constructing instances of tuple subclasses.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-07-21 17:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-21 17:39</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-21 17:48</div>
            <div class="timeline-body"><p>The primer hits seem to mostly be people doing <code>list(map(tuple, iterable_of_iterables))</code>:</p>
<ul>
<li>https://github.com/scipy/scipy/blob/8dd9d43e62f3f6401599ced3917835d4458cece4/scipy/sparse/_construct.py#L1286</li>
<li>https://github.com/scipy/scipy/blob/8dd9d43e62f3f6401599ced3917835d4458cece4/scipy/spatial/tests/test_qhull.py#L25</li>
<li>https://github.com/scipy/scipy/blob/8dd9d43e62f3f6401599ced3917835d4458cece4/scipy/spatial/tests/test_qhull.py#L27</li>
<li>https://github.com/more-itertools/more-itertools/blob/89172166167a5323c19ecb45fee49f191ea49bcd/more_itertools/more.py#L4164</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-07-21 17:52</div>
            <div class="timeline-body"><p>The new diagnostics look weird, though, because I would expect <code>&lt;class 'tuple'&gt;</code> to be assignable to <code>(Unknown, /) -&gt; Unknown</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-21 17:53</div>
            <div class="timeline-body"><blockquote>
<p>The new diagnostics look weird, though, because I would expect <code>&lt;class 'tuple'&gt;</code> to be assignable to <code>(Unknown, /) -&gt; Unknown</code>.</p>
</blockquote>
<p>yeah, that's why it's still in draft :P I'm looking into it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-21 18:59</div>
            <div class="timeline-body"><p>Minimal repro: this still passes on this branch:</p>
<pre><code class="language-py">from typing import Callable, Any

def f(x: Callable[..., Any]): ...

f(tuple)
</code></pre>
<p>but this no longer does:</p>
<pre><code class="language-py">from typing import Callable, Any

def f(x: Callable[[Any], Any]): ...

f(tuple)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-21 19:08</div>
            <div class="timeline-body"><p>The reason seems to be that this <code>.into_callable(db)</code> call is now returning <code>Callable[[], tuple[Unknown, ...]]</code> for <code>&lt;class 'tuple'&gt;</code>: https://github.com/astral-sh/ruff/blob/fcdffe4ac91daed9a227970aaf281119ce2c3007/crates/ty_python_semantic/src/types.rs#L1420-L1422</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-21 19:15</div>
            <div class="timeline-body"><p>Oh, I think the bug is just https://github.com/astral-sh/ty/issues/760 again, but for <code>__new__</code> this time rather than <code>__init__</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-21 19:34</div>
            <div class="timeline-body"><p>Great, https://github.com/astral-sh/ruff/pull/19469/commits/38382034eac96277ad251a3bbbf10c89eeab1a59 fixed it! This now has a clean primer report.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @AlexWaygood on 2025-07-21 19:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-07-21 19:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-07-21 19:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @AlexWaygood on 2025-07-21 19:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/class.rs</code>:589 on 2025-07-21 20:28</div>
            <div class="timeline-body"><p>nit: It might be worth moving this to be an instance method of <code>ClassLiteral</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> approved on 2025-07-21 20:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-07-21 21:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-07-21 21:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-21 21:25</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:14:26 UTC
    </footer>
</body>
</html>
