<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-pyi`] Implement PYI017 - astral-sh/ruff #5895</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-pyi</code>] Implement PYI017</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5895">#5895</a>
        opened by <a href="https://github.com/qdegraaf">@qdegraaf</a>
        on 2023-07-19 19:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/qdegraaf">@qdegraaf</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Implements <code>PYI017</code> or <code>Y017</code> from <code>flake8-pyi</code> plug-in. Mirrors <a href="https://github.com/PyCQA/flake8-pyi/blob/ceab86d16b822d12abae1d8087850d0bc66d2f52/pyi.py#L1039-L1048">upstream implementation</a>. It checks for any assignment with more than 1 target or an assignment to anything other than a name, and raises a violation for these in stub files.</p>
<p>Couldn't find a clear and concise explanation for why this is to be avoided and what is preferred for attribute cases like:</p>
<pre><code class="language-python">a.b = int
</code></pre>
<p>So welcome some input there, to learn and to finish up the docs.</p>
<h2>Test Plan</h2>
<p>Added test cases from upstream plug-in in a fixture (both <code>.py</code> and <code>.pyi</code>). Added a few more.</p>
<h2>Issue link</h2>
<p>Refers: https://github.com/astral-sh/ruff/issues/848</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-07-19 19:56</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>✅ ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01     12.2±0.66ms     3.3 MB/sec    1.00     12.1±0.49ms     3.4 MB/sec
formatter/numpy/ctypeslib.py               1.01      2.4±0.12ms     6.9 MB/sec    1.00      2.4±0.14ms     7.0 MB/sec
formatter/numpy/globals.py                 1.01   276.3±17.75µs    10.7 MB/sec    1.00   273.3±19.96µs    10.8 MB/sec
formatter/pydantic/types.py                1.00      5.2±0.30ms     4.9 MB/sec    1.01      5.2±0.27ms     4.9 MB/sec
linter/all-rules/large/dataset.py          1.02     17.8±0.57ms     2.3 MB/sec    1.00     17.5±0.65ms     2.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.4±0.25ms     3.8 MB/sec    1.02      4.5±0.24ms     3.7 MB/sec
linter/all-rules/numpy/globals.py          1.04   614.4±70.23µs     4.8 MB/sec    1.00   591.3±39.91µs     5.0 MB/sec
linter/all-rules/pydantic/types.py         1.02      8.1±0.31ms     3.2 MB/sec    1.00      7.9±0.30ms     3.2 MB/sec
linter/default-rules/large/dataset.py      1.02      9.1±0.31ms     4.5 MB/sec    1.00      9.0±0.38ms     4.5 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1866.4±87.37µs     8.9 MB/sec    1.01  1883.5±78.19µs     8.8 MB/sec
linter/default-rules/numpy/globals.py      1.00   217.4±12.15µs    13.6 MB/sec    1.03   223.6±15.41µs    13.2 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.9±0.16ms     6.5 MB/sec    1.02      4.0±0.17ms     6.3 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.06     11.9±0.16ms     3.4 MB/sec    1.00     11.2±0.15ms     3.6 MB/sec
formatter/numpy/ctypeslib.py               1.06      2.3±0.05ms     7.2 MB/sec    1.00      2.2±0.03ms     7.7 MB/sec
formatter/numpy/globals.py                 1.02    248.4±5.37µs    11.9 MB/sec    1.00    242.8±8.26µs    12.2 MB/sec
formatter/pydantic/types.py                1.05      5.1±0.06ms     5.0 MB/sec    1.00      4.8±0.10ms     5.3 MB/sec
linter/all-rules/large/dataset.py          1.00     15.8±0.19ms     2.6 MB/sec    1.00     15.7±0.17ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      4.1±0.07ms     4.1 MB/sec    1.00      4.1±0.05ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.00    493.1±8.33µs     6.0 MB/sec    1.00    491.2±6.81µs     6.0 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.1±0.09ms     3.6 MB/sec    1.00      7.1±0.08ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.00      8.2±0.08ms     4.9 MB/sec    1.00      8.2±0.19ms     5.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1707.6±18.65µs     9.8 MB/sec    1.00  1699.3±15.27µs     9.8 MB/sec
linter/default-rules/numpy/globals.py      1.00    191.9±3.27µs    15.4 MB/sec    1.00    191.9±3.06µs    15.4 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.7±0.04ms     7.0 MB/sec    1.00      3.6±0.03ms     7.0 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-19 21:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/complex_assignment.rs</code>:33 on 2023-07-19 21:31</div>
            <div class="timeline-body"><p>I agree this message is a little tricky. I'm not sure users will understand what &quot;non-name targets&quot; means but I'm struggling to find a better message. Perhaps?</p>
<pre><code class="language-suggestion">        format!(&quot;Stubs should not contain assignments to multiple targets or attributes.&quot;)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-19 21:31</div>
            <div class="timeline-body"><p>Thanks for working on this! It looks like a good start. Would you mind marking this as a draft until the documentation is done?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-07-19 21:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/src/rules/flake8_pyi/rules/complex_assignment.rs</code>:33 on 2023-07-19 21:32</div>
            <div class="timeline-body"><p>or perhaps clearer to say &quot;to attributes or multiple targets&quot; to avoid confusion about &quot;multiple attributes&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/qdegraaf">@qdegraaf</a> on 2023-07-19 21:58</div>
            <div class="timeline-body"><blockquote>
<p>Thanks for working on this! It looks like a good start. Would you mind marking this as a draft until the documentation is done?</p>
</blockquote>
<p>Sure! I'm probably going to need some help with that from someone who knows more about <code>flake8-pyi</code>or stub files though. Could you maybe mark it as such with a label of some sorts? Upstream plug-in does not have much more to say on it than:</p>
<pre><code>Stubs should not contain assignments with multiple targets or non-name targets. E.g. T, S = TypeVar(&quot;T&quot;), TypeVar(&quot;S&quot;) is disallowed, as is foo.bar = TypeVar(&quot;T&quot;).
</code></pre>
<p>And browsing through https://peps.python.org/pep-0484/#stub-files and https://typing.readthedocs.io/en/latest/source/stubs.html I can find no mention of it either</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @qdegraaf on 2023-07-19 21:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-07-19 23:01</div>
            <div class="timeline-body"><p>@AlexWaygood might have some more details on the intent of the rule.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-07-19 23:16</div>
            <div class="timeline-body"><p>I can do it when I’m back on my computer, but I’d recommend looking through the Git history upstream. There‘s often additional context in the PR summaries and release notes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/qdegraaf">@qdegraaf</a> on 2023-07-19 23:26</div>
            <div class="timeline-body"><p>Found this: https://github.com/PyCQA/flake8-pyi/pull/76 which links to https://github.com/python/typeshed/issues/4913 and then https://peps.python.org/pep-0613/ which seem to hint at</p>
<pre><code class="language-python">a.b = int
a = b = int
</code></pre>
<p>possibly not being valid explicit type aliases and therefore problematic but I'm not sure.</p>
<p>Maybe @hauntsaninja can clarify?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-07-20 10:10</div>
            <div class="timeline-body"><p>To me, <code>a.b = int</code> in a stub files looks like an anti-pattern, it's definitely more readable if you'd <code>b: int</code> inside the class or module <code>a</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2023-07-20 10:13</div>
            <div class="timeline-body"><p>In general, stub files should be thought of as &quot;data files&quot; for a type checker. They're not intended to ever be executed. As such, it's useful in general to enforce that only a subset of Python syntax is allowed in a stub file, to ensure that everything in the stub is 100% unambiguous when it comes to how the type checker is supposed to interpret it. (If it's not, there's not much point in having the stub files at all!)</p>
<p>So, without doing too much historical research into why we originally implemented this check at flake8-pyi, I feel like the rule it's enforcing is of a piece with this general principle.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2023-07-20 10:40</div>
            <div class="timeline-body"><p>In other words: there's basically no reason anybody should ever <em>need</em> to use multiple assignment, or assignments to non-<code>Name</code> targets, in a stub -- and if somebody's trying to do that for whatever reason, it likely indicates some kind of misunderstanding on their part.</p>
<p>We could probably improve the error message and docs over at flake8-pyi!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/qdegraaf">@qdegraaf</a> on 2023-07-20 13:40</div>
            <div class="timeline-body"><p>Thanks for the explanation! I'm happy with that as a <code>## Why is this bad?</code> snippet. Will add and open up for review again.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @qdegraaf on 2023-07-20 13:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff/resources/test/fixtures/flake8_pyi/PYI017.pyi</code>:1 on 2023-07-20 13:59</div>
            <div class="timeline-body"><p>This isn't a <em>great</em> example of something that's an okay assignment in a stub, since 99/100 times in a stub file this should <em>probably</em> be:</p>
<pre><code class="language-py">a: TypeAlias = int
</code></pre>
<p>Better examples of things that are okay in a stub file would be:</p>
<pre><code class="language-py">var: int
a = var
</code></pre>
<p>or</p>
<pre><code class="language-py">class Foo:
    def method(self) -&gt; list[int]: ...

foo: Foo
a = foo.method
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff/resources/test/fixtures/flake8_pyi/PYI017.pyi</code>:16 on 2023-07-20 13:59</div>
            <div class="timeline-body"><p>This would be flagged by ruff's existing PYI026 check (it should be <code>i: TypeAlias = int | str</code>), so again it's not a <em>great</em> example of an assignment that's okay in a stub file</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2023-07-20 14:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2023-07-20 14:12</div>
            <div class="timeline-body"><p>Tests and docs look good! (I'm not qualified to review rust code)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2023-07-20 15:43</div>
            <div class="timeline-body"><p>Thanks for looking it over @AlexWaygood !</p>
<p>This looks good to me. I'd like to include another maintainer to give it a once over but then it should be ready cc @charliermarsh</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @zanieb on 2023-07-20 15:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @charliermarsh on 2023-07-20 16:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-07-20 16:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-07-20 16:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-07-27 08:12</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:58:53 UTC
    </footer>
</body>
</html>
