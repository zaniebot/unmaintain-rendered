<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create fuzzers for testing correctness of parsing, linting and fixing - astral-sh/ruff #4822</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Create fuzzers for testing correctness of parsing, linting and fixing</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4822">#4822</a>
        opened by <a href="https://github.com/addisoncrump">@addisoncrump</a>
        on 2023-06-03 03:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/addisoncrump">@addisoncrump</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR introduces multiple fuzzers which test the correctness of Ruff. Namely:</p>
<ul>
<li><code>ruff_parse_simple</code>, which attempts to simply crash the parser (though is mainly useful as a utility for generating inputs)</li>
<li><code>ruff_parse_idempotency</code>, which searches for idempotency violations in the parse/unparse utilities of Ruff</li>
<li><code>ruff_fix_validity</code>, which checks that fixes applied by Ruff do not introduce syntax violations (using <code>ruff::test::test_snippet</code>)</li>
</ul>
<h2>Test Plan</h2>
<p>This introduces new tests. I will open PRs with a few of the bugs discovered by the fuzzer and link them to this PR to demonstrate some of the things it is able to find.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-06-03 04:54</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>✅ ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      6.2±0.02ms     6.6 MB/sec    1.19      7.3±0.02ms     5.5 MB/sec
formatter/numpy/ctypeslib.py               1.00   1257.7±9.70µs    13.2 MB/sec    1.14   1439.6±2.26µs    11.6 MB/sec
formatter/numpy/globals.py                 1.00    145.1±1.20µs    20.3 MB/sec    1.09    157.8±0.74µs    18.7 MB/sec
formatter/pydantic/types.py                1.00      2.7±0.01ms     9.4 MB/sec    1.16      3.1±0.03ms     8.1 MB/sec
linter/all-rules/large/dataset.py          1.02     15.0±0.12ms     2.7 MB/sec    1.00     14.7±0.07ms     2.8 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.02      3.6±0.01ms     4.6 MB/sec    1.00      3.6±0.00ms     4.7 MB/sec
linter/all-rules/numpy/globals.py          1.01    364.7±0.89µs     8.1 MB/sec    1.00    362.4±0.82µs     8.1 MB/sec
linter/all-rules/pydantic/types.py         1.01      6.2±0.01ms     4.1 MB/sec    1.00      6.1±0.01ms     4.1 MB/sec
linter/default-rules/large/dataset.py      1.01      7.4±0.03ms     5.5 MB/sec    1.00      7.3±0.09ms     5.5 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1535.2±3.31µs    10.8 MB/sec    1.01   1550.2±3.51µs    10.7 MB/sec
linter/default-rules/numpy/globals.py      1.00    164.5±0.16µs    17.9 MB/sec    1.01    165.6±0.61µs    17.8 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.3±0.01ms     7.7 MB/sec    1.01      3.3±0.00ms     7.7 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      6.1±0.18ms     6.6 MB/sec    1.00      6.1±0.08ms     6.6 MB/sec
formatter/numpy/ctypeslib.py               1.00  1232.2±44.55µs    13.5 MB/sec    1.01  1250.1±48.50µs    13.3 MB/sec
formatter/numpy/globals.py                 1.00    138.4±2.74µs    21.3 MB/sec    1.03    142.3±3.75µs    20.7 MB/sec
formatter/pydantic/types.py                1.00      2.7±0.05ms     9.5 MB/sec    1.01      2.7±0.07ms     9.4 MB/sec
linter/all-rules/large/dataset.py          1.01     14.6±0.15ms     2.8 MB/sec    1.00     14.5±0.12ms     2.8 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.7±0.04ms     4.5 MB/sec    1.00      3.7±0.04ms     4.5 MB/sec
linter/all-rules/numpy/globals.py          1.00   435.5±11.61µs     6.8 MB/sec    1.00    434.4±6.63µs     6.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.2±0.07ms     4.1 MB/sec    1.00      6.2±0.14ms     4.1 MB/sec
linter/default-rules/large/dataset.py      1.00      7.2±0.06ms     5.6 MB/sec    1.01      7.3±0.07ms     5.6 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1531.6±23.47µs    10.9 MB/sec    1.01  1542.7±25.13µs    10.8 MB/sec
linter/default-rules/numpy/globals.py      1.00    174.5±4.46µs    16.9 MB/sec    1.00    174.8±6.41µs    16.9 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.3±0.04ms     7.8 MB/sec    1.01      3.3±0.04ms     7.8 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-06-03 05:06</div>
            <div class="timeline-body"><p>This looks pretty cool! I'm looking forward to seeing this uncover more bugs — the two you linked already are nice finds.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on 2023-06-03 05:16</div>
            <div class="timeline-body"><blockquote>
<p>This looks pretty cool! I'm looking forward to seeing this uncover more bugs — the two you linked already are nice finds.</p>
</blockquote>
<p>Thanks! I hope it gets some good use -- manually sifting through the bugs right now to deduplicate, but hopefully once all the low-hanging fruit issues are out of the way we can integrate it into the standard testing process. :grin:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on 2023-06-03 05:19</div>
            <div class="timeline-body"><p>Also, it should be fairly straightforward to extend the idempotency ideas to #4798 for testing the formatter as well, when this is completed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>.github/workflows/ci.yaml</code>:98 on 2023-06-05 06:32</div>
            <div class="timeline-body"><p>Does <code>cargo-bininstall</code> support <code>cargo-fuzz</code>? It could help to speed up the CI step</p>
<p>https://github.com/charliermarsh/ruff/blob/466719247bc68c0b608bc85be341c5aa5e2a5ec2/.github/workflows/benchmark.yaml#L81-L85</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/airflow/mod.rs</code>:21 on 2023-06-05 06:36</div>
            <div class="timeline-body"><p>This seems a bit painfull. Should we extract the logic of <code>test_path</code> into a <code>TestRunner</code> struct that can be configured:</p>
<pre><code class="language-rust">pub struct TestRunner&lt;'a&gt; {
	path: &amp;'a Path
	settings: &amp;'a Settings,
	iterations: usize
}

impl&lt;'a&gt; TestRunner&lt;'a&gt; {
	pub fn new(path: &amp;'a Path, settings: &amp;'a Settings) -&gt; Self {
		Self { path, settings, iterations: DEFAULT_MAX_ITERATIONS }
	}

	pub fn with_iterations(mut self, iterations: usize) -&gt; Self {
		self.iterations = iterations;
		self
	}

	pub fn run(self) -&gt; Diagnostics {
		// All the test_path code
	}
}
</code></pre>
<p>Another option would be to create a <code>TestRunner</code> struct that accepts various options with a single <code>run</code> method.  <code>test_path</code> could use that struct internally and you could configure it.</p>
<p>Nit: For the future: It may even be worth to accept settings as an owned value so that it becomes possible to create a <code>for_rule</code> factory method that creates the settings using <code>settings::Settings::for_rule(rule_code)</code> internally. It seems silly, that we repeat this for every rule.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/test.rs</code>:54 on 2023-06-05 06:39</div>
            <div class="timeline-body"><p>Same as for <code>test_path</code>. We should extract the logic into a <code>TestContentsRunner</code> and use it inside of <code>test_contents</code>. This way, it becomes possible for you to use the advanced <code>runner</code> API without having to change all call sites (and reduces the number of arguments).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/test.rs</code>:146 on 2023-06-05 06:40</div>
            <div class="timeline-body"><p>Is this change intentional?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>fuzz/Cargo.toml</code>:9 on 2023-06-05 06:41</div>
            <div class="timeline-body"><p>Nit: You can inherit the edition from the workspace</p>
<pre><code class="language-suggestion">edition = { workspace = true }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>fuzz/Cargo.toml</code>:7 on 2023-06-05 06:42</div>
            <div class="timeline-body"><p>CC: @charliermarsh</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>fuzz/Cargo.toml</code>:23 on 2023-06-05 06:43</div>
            <div class="timeline-body"><p>I see. This is not part of the workspace. What's the motivation for not making this crate part of the Ruff workspace? It being its own workspace increases makes versioning harder (we now need to keep in mind to update rust python here and in the main ruff workspace)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>fuzz/Cargo.toml</code>:52 on 2023-06-05 06:44</div>
            <div class="timeline-body"><p>What's the motivation for opting in to opt-level 3 even for debug? Would a lower level like 1 or 2 suffice?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>fuzz/README.md</code>:3 on 2023-06-05 06:45</div>
            <div class="timeline-body"><p>This Readme is awesome.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>fuzz/README.md</code>:16 on 2023-06-05 06:47</div>
            <div class="timeline-body"><p>How can I skip the dataset download or does the script ask me whether to download the dataset?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>fuzz/fuzz_targets/ruff_fix_validity.rs</code>:9 on 2023-06-05 06:47</div>
            <div class="timeline-body"><p>You can use <code>OnceCell</code> for a lazy initialized static object without relying on unsafe code https://doc.rust-lang.org/std/cell/struct.OnceCell.html</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>fuzz/fuzz_targets/ruff_fix_validity.rs</code>:21 on 2023-06-05 06:48</div>
            <div class="timeline-body"><p>This could, potentially, result in an infinite loop if two ruff fixes don't play nicely together.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>fuzz/fuzz_targets/ruff_parse_idempotency.rs</code>:45 on 2023-06-05 06:49</div>
            <div class="timeline-body"><p>Idea: You could use similar to produce a diff</p>
<p>https://github.com/charliermarsh/ruff/blob/466719247bc68c0b608bc85be341c5aa5e2a5ec2/crates/ruff_python_formatter/src/lib.rs#L212-L215</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>fuzz/init-fuzzer.sh</code>:10 on 2023-06-05 06:50</div>
            <div class="timeline-body"><p>Should we ask users to install <code>cargo-fuzz</code> themselves?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>.github/workflows/ci.yaml</code>:101 on 2023-06-05 06:52</div>
            <div class="timeline-body"><p>Improvement (doesn't have to be part of this PR and we face the same problem with benchmarks). It would be great if we could run the fuzzer selectively</p>
<ul>
<li>parser tests: Only when the <code>Cargo.toml</code> changes (as an over approximation for RustPython changed)</li>
<li>linter: changes to any non-formatter or cli related crate?</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-05 06:53</div>
            <div class="timeline-body"><p>This is awesome and very well done. Thank you so much. Also thank you for filling some issues already.</p>
<p>I've a few comments but overall looking good.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/addisoncrump">@addisoncrump</a> reviewed on 2023-06-05 11:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on <code>crates/ruff/src/test.rs</code>:146 on 2023-06-05 11:22</div>
            <div class="timeline-body"><p>Nope! Sorry, must have had it in my clipboard :sweat:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on <code>fuzz/Cargo.toml</code>:9 on 2023-06-05 11:22</div>
            <div class="timeline-body"><p>Actually, not so. Fuzz needs to be in its own workspace and cannot import from the parent workspace, as the build uses separate RUSTFLAGS.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/addisoncrump">@addisoncrump</a> reviewed on 2023-06-05 11:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/addisoncrump">@addisoncrump</a> reviewed on 2023-06-05 11:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on <code>fuzz/README.md</code>:16 on 2023-06-05 11:23</div>
            <div class="timeline-body"><p>The script asks :slightly_smiling_face:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/addisoncrump">@addisoncrump</a> reviewed on 2023-06-05 11:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on <code>fuzz/Cargo.toml</code>:23 on 2023-06-05 11:23</div>
            <div class="timeline-body"><p>See previous answer :slightly_smiling_face:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/addisoncrump">@addisoncrump</a> reviewed on 2023-06-05 11:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on <code>fuzz/Cargo.toml</code>:52 on 2023-06-05 11:26</div>
            <div class="timeline-body"><p>Fuzzers rely on being able to execute quickly, and (if unsafe code is involved) some faults are not consistent between optimisation levels. Having these be as close as possible is important. Comparatively, you can build the fuzzers on their own (just <code>cargo run ...</code> instead of <code>cargo fuzz run ...</code>) if you want to analyse a crash without <a href="https://clang.llvm.org/docs/SanitizerCoverage.html">fuzzer instrumentation</a> (in some rare cases, the instrumentation can modify behaviour or optimisation). This is a rare use case but something I wanted to allow for.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/addisoncrump">@addisoncrump</a> reviewed on 2023-06-05 11:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on <code>fuzz/fuzz_targets/ruff_fix_validity.rs</code>:21 on 2023-06-05 11:27</div>
            <div class="timeline-body"><p>This would be detected as a timeout and the fuzzer would mark it as a crash, so this is actually okay :slightly_smiling_face:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/addisoncrump">@addisoncrump</a> reviewed on 2023-06-05 11:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on <code>fuzz/fuzz_targets/ruff_fix_validity.rs</code>:9 on 2023-06-05 11:28</div>
            <div class="timeline-body"><p>Ah, okay. Wasn't sure of the performance implications here, but I'll give it a try.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/addisoncrump">@addisoncrump</a> reviewed on 2023-06-05 11:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on <code>fuzz/init-fuzzer.sh</code>:10 on 2023-06-05 11:30</div>
            <div class="timeline-body"><p>Potentially; however, cargo fuzz recommends installing via <code>cargo install cargo-fuzz</code>, but their release cycle is very slow and the main branch is normally stable. For having all potential features available, it's better to install via the git and I figured it would be easier to do so in a script.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/addisoncrump">@addisoncrump</a> reviewed on 2023-06-05 11:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on <code>fuzz/Cargo.toml</code>:7 on 2023-06-05 11:30</div>
            <div class="timeline-body"><p>I leave authorship details to your discretion; this was autofilled by my IDE.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/addisoncrump">@addisoncrump</a> reviewed on 2023-06-05 11:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on <code>crates/ruff/src/rules/airflow/mod.rs</code>:21 on 2023-06-05 11:33</div>
            <div class="timeline-body"><p>I do notice that the <code>MAX_ITERATIONS</code> paradigm seems to be consistent throughout the code base, and normally set by a fixed global value. Perhaps this should just be configurable in general. I made the &quot;simplest&quot; changes for proof-of-concept, so I leave this to your discretion on how this should be implemented as it will dramatically affect all testing code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on <code>.github/workflows/ci.yaml</code>:101 on 2023-06-05 11:36</div>
            <div class="timeline-body"><p>Definitely would be cool to run the fuzzers for a short amount of time! To do so, we'd need the following in CI:</p>
<ul>
<li>caching of the fuzzer corpus</li>
<li>10 minute fuzz runs (maybe only on merges to main/release pre-checks? potentially would need a merge queue)</li>
</ul>
<p>That said, Ruff isn't quite resistant enough to fuzzing yet to justify adding it to the CI. Probably all your builds would &quot;break&quot; due to the fuzzer finding things that simply haven't been fixed yet. I haven't even properly confirmed that I've found &quot;all&quot; the potential issues yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/addisoncrump">@addisoncrump</a> reviewed on 2023-06-05 11:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/addisoncrump">@addisoncrump</a> reviewed on 2023-06-05 11:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on <code>.github/workflows/ci.yaml</code>:98 on 2023-06-05 11:37</div>
            <div class="timeline-body"><p>I am unfamiliar with bininstall. I will try this :slightly_smiling_face:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/addisoncrump">@addisoncrump</a> reviewed on 2023-06-05 13:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on <code>.github/workflows/ci.yaml</code>:98 on 2023-06-05 13:04</div>
            <div class="timeline-body"><p>Hm, looking at the CI, it seems that none of the other installations in <code>ci.yaml</code> use binstall. Perhaps we should make this a separate PR instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/addisoncrump">@addisoncrump</a> reviewed on 2023-06-05 13:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on <code>fuzz/fuzz_targets/ruff_parse_idempotency.rs</code>:45 on 2023-06-05 13:23</div>
            <div class="timeline-body"><p>I tried this, but the results were not good. A lot of the fuzz cases are very malformed before minimisation. Here's an example of the &quot;diff&quot; output:</p>
<pre><code class="language-diff">diff:
--- Parsed twice
+++ Parsed three times
@@ -1 +1 @@
-b % f&quot;{7:}{7::\\x00\\x00\\x00R\\x00:}{7:\\x00\\x00\\x00R\\x00R\\x00:}{7::\\x00\\x00\\x00:}{4:\\x00\\x00\\x00:\\x00\\x00\\x00\\x00\\x00R\\x00:}{7::\\x00\\x00\\x00R\\x00:}{7:\\x00\\x00\\x00R\\x00R\\x00:}{7::\\x00\\x00\\x00:}{4:\\x00\\x00\\x00R\\x00\\x00\\x00R\\x00:}8&quot;
\ No newline at end of file
+b % f&quot;{7:}{7::\\\\x00\\\\x00\\\\x00R\\\\x00:}{7:\\\\x00\\\\x00\\\\x00R\\\\x00R\\\\x00:}{7::\\\\x00\\\\x00\\\\x00:}{4:\\\\x00\\\\x00\\\\x00:\\\\x00\\\\x00\\\\x00\\\\x00\\\\x00R\\\\x00:}{7::\\\\x00\\\\x00\\\\x00R\\\\x00:}{7:\\\\x00\\\\x00\\\\x00R\\\\x00R\\\\x00:}{7::\\\\x00\\\\x00\\\\x00:}{4:\\\\x00\\\\x00\\\\x00R\\\\x00\\\\x00\\\\x00R\\\\x00:}8&quot;
\ No newline at end of file
</code></pre>
<p>~~Unfortunately, the diff is not nearly as helpful as viewing the samples individually <em>after</em> minimising the testcase.~~ Actually, it seems that the diff is actually okay after minimisation:</p>
<pre><code>thread '&lt;unnamed&gt;' panicked at 'assertion failed: `(left == right)`
  left: `&quot;f\&quot;{7:\\\\x00}\&quot;&quot;`,
 right: `&quot;f\&quot;{7:\\\\\\\\x00}\&quot;&quot;`: 
Potential unsteady state (orig =&gt; first =&gt; second =&gt; third); original: &quot;f\&quot;{7:\0}\&quot;&quot;
diff:
--- Parsed twice
+++ Parsed three times
@@ -1 +1 @@
-f&quot;{7:\\x00}&quot;
\ No newline at end of file
+f&quot;{7:\\\\x00}&quot;
\ No newline at end of file
', fuzz_targets/ruff_parse_idempotency.rs:34:17
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/addisoncrump">@addisoncrump</a> reviewed on 2023-06-05 15:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on <code>crates/ruff/src/rules/airflow/mod.rs</code>:21 on 2023-06-05 15:58</div>
            <div class="timeline-body"><p>Hm, yeah, potentially I'll need to shift away from the test runner code anyways, as I need to control for undesired testcases (see: https://github.com/charliermarsh/ruff/issues/4865).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>fuzz/Cargo.toml</code>:23 on 2023-06-05 17:21</div>
            <div class="timeline-body"><p>Oh I see. That makes sense. Would it be possible to use the re-exported nodes from <code>ruff_python_ast</code> (<code>prelude.rs</code>)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-05 17:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/addisoncrump">@addisoncrump</a> reviewed on 2023-06-05 17:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on <code>fuzz/Cargo.toml</code>:23 on 2023-06-05 17:23</div>
            <div class="timeline-body"><p>Should be able to, yes -- let me try this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/addisoncrump">@addisoncrump</a> reviewed on 2023-06-05 17:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on <code>fuzz/Cargo.toml</code>:23 on 2023-06-05 17:29</div>
            <div class="timeline-body"><p>Turns out I didn't even use these deps :upside_down_face:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-05 20:28</div>
            <div class="timeline-body"><p>This is impressive work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-05 20:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>fuzz/Cargo.toml</code>:7 on 2023-06-05 20:44</div>
            <div class="timeline-body"><p>The authors field is <a href="https://doc.rust-lang.org/cargo/reference/manifest.html#the-authors-field">&quot;open to interpretation&quot;</a> but I mostly see it as a mechanism through which users can contact maintainers. Can you add me as well here (<code>&quot;Charlie Marsh &lt;charlie.r.marsh@gmail.com&gt;&quot;</code>)? Since I'll be the primarily-responsible maintainer (or at least the point of contact) in the future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-05 20:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>fuzz/Cargo.toml</code>:7 on 2023-06-05 20:46</div>
            <div class="timeline-body"><p>(Feel free to include yourself here or remove as you prefer, I don't feel strongly, I'd just like to have myself listed in addition as the primary maintainer.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on 2023-06-06 10:10</div>
            <div class="timeline-body"><p>This last commit adds some sugar so I can fuzz locally with libafl (disclosure: this is a fuzzer I am a maintainer of), which is orders of magnitude faster than libfuzzer but has less support. It's not default and shouldn't affect normal users.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jvoisin">@jvoisin</a> on 2023-06-06 12:02</div>
            <div class="timeline-body"><p>It would be glorious to add this to <a href="https://github.com/google/oss-fuzz">OSS-Fuzz</a> &lt;3</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on 2023-06-06 12:04</div>
            <div class="timeline-body"><p>That's the plan :wink:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/addisoncrump">@addisoncrump</a> reviewed on 2023-06-06 12:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on <code>crates/ruff/src/rules/airflow/mod.rs</code>:21 on 2023-06-06 12:59</div>
            <div class="timeline-body"><p>Quick bump on this; what are the action items here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-06 15:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>.github/workflows/ci.yaml</code>:98 on 2023-06-06 15:33</div>
            <div class="timeline-body"><p>Good point. They probably should. But I understand we want to remove the CI step for now anyway because there would be too many false positives. I recommend either dropping the CI step or adding it in its own PR to resolve the conversation for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-06 15:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/airflow/mod.rs</code>:21 on 2023-06-06 15:34</div>
            <div class="timeline-body"><p>I think it depends on the direction you want to take. Do you plan to migrate away from the test runner code?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on <code>.github/workflows/ci.yaml</code>:98 on 2023-06-06 15:35</div>
            <div class="timeline-body"><p>We want to keep the build step. In the future, we should add the fuzz runs as another CI step as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/addisoncrump">@addisoncrump</a> reviewed on 2023-06-06 15:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/addisoncrump">@addisoncrump</a> reviewed on 2023-06-06 15:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on <code>crates/ruff/src/rules/airflow/mod.rs</code>:21 on 2023-06-06 15:36</div>
            <div class="timeline-body"><p>Not anymore -- realised the issue was actually resolvable without moving away from the test runner. In reality, we want fuzzing to stay as close to testing code as possible -- and allow you to update it as seen fit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/airflow/mod.rs</code>:21 on 2023-06-06 15:41</div>
            <div class="timeline-body"><p>An alternative (that doesn't require changing all tests) is to provide an API to configure the max iterations value:</p>
<pre><code class="language-rust">thread_local! {
    static MAX_ITERATIONS: std::cell::Cell&lt;u32&gt; = std::cell::Cell::new(1);
}

pub fn set_max_iterations(max: u32) {
    MAX_ITERATIONS.with(|iterations| iterations.set(max))
}

pub(crate) fn max_iterations() -&gt; u32 {
    MAX_ITERATIONS.with(|iterations| iterations.get())
}
</code></pre>
<p>I would, ultimately prefer a <code>TestRunner</code> API but I can see how this is out of scope for this PR. Would that thread local state work for you?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-06-06 15:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on 2023-06-06 15:44</div>
            <div class="timeline-body"><p>Potentially, yes :slightly_smiling_face: Though, this seems really roundabout. Why does this need to be a global/constant? Should this perhaps be a Setting entry? This pattern also appears here: https://github.com/charliermarsh/ruff/blob/1ed5d7e437a1dda0f4c2ddae09f5a7aa7d713bde/crates/ruff/src/linter.rs#L247</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-06 16:53</div>
            <div class="timeline-body"><blockquote>
<p>Potentially, yes slightly_smiling_face Though, this seems really roundabout. Why does this need to be a global/constant? Should this perhaps be a Setting entry? This pattern also appears here:</p>
<p>https://github.com/charliermarsh/ruff/blob/1ed5d7e437a1dda0f4c2ddae09f5a7aa7d713bde/crates/ruff/src/linter.rs#L247</p>
</blockquote>
<p>The settings is what we use in production. I would prefer to keep max iterations local to the testing infrastructure.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on 2023-06-06 16:56</div>
            <div class="timeline-body"><p>I see. This would work in my case, yes. Applying the change!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2023-06-07 12:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-06-07 12:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-06-07 12:57</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:57:50 UTC
    </footer>
</body>
</html>
