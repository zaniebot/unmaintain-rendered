```yaml
number: 11203
title: Add a daily workflow to fuzz the parser with randomly selected seeds
type: pull_request
state: merged
author: AlexWaygood
labels:
  - ci
assignees: []
merged: true
base: main
head: fuzz-workflow
created_at: 2024-04-29T13:27:44Z
updated_at: 2024-04-29T16:54:20Z
url: https://github.com/astral-sh/ruff/pull/11203
synced_at: 2026-01-12T15:55:37Z
```

# Add a daily workflow to fuzz the parser with randomly selected seeds

---

_@AlexWaygood_

## Summary

In https://github.com/astral-sh/ruff/commit/f5c7a62aa65decb9e286bd65ba17f1a3bd1f91e6, we added a new CI job to fuzz the parser. The job runs on all PRs touching the parser, and deliberately only runs the fuzzer with the same seeds each time, so that it can function as a regression test: any bugs surfaced by that job can be guaranteed to be *new* bugs that we know didn't exist on `main`. (A given seed is always guaranteed to lead to the same file being generated by `pysource-codegen`.)

This PR adds a second CI job that runs once a day and runs the fuzzer on a _randomly selected_ set of 1,000 seeds. This is less useful as a regression test, as any bugs surfaced by this CI job will not necessarily be _new_ bugs. Theoretically, however, randomly selecting the seeds could be a more successful way of discovering bugs in the parser.

If the daily job fails, a bot will automatically open an issue reporting the failure. Here's an example at typeshed of what the issue would look like (we use a similar daily job at typeshed): https://github.com/python/typeshed/issues/11837.

## Is this useful?

This PR is a proof-of-concept, but I'm not sure how useful this job would actually be. While this could theoretically help us find more bugs in the parser, I think it's likely that most bugs surfaced by this fuzzer would be encountered in the 500 seeds run as part of the CI job that we already run on PRs affecting the parser and pushes to `main`. If someone's working on a big parser change that they want to test to destruction, they can run the script with a larger set of random seeds locally. I'm putting this PR up in case it's helpful, but I'll fully defer to the parser experts on the team as to whether it's something we want to go ahead with or not; I'm pretty undecided.

## Test Plan

The new job should run as part of this PR.


---

_Assigned to @MichaReiser by @AlexWaygood on 2024-04-29 13:27_

---

_Assigned to @dhruvmanila by @AlexWaygood on 2024-04-29 13:27_

---

_@MichaReiser approved on 2024-04-29 13:54_

I don't mind some random fuzzing once a day. It allows us to cover a larger test set and may even reveal errors in the existing implementation

---

_@MichaReiser reviewed on 2024-04-29 13:56_

---

_Review comment by @MichaReiser on `.github/workflows/daily_fuzz.yaml`:52 on 2024-04-29 13:56_

Is this clamping the random numbers to a range between 1000000 is there a reason why not to go higher (or move the random number generation into the fuzzer script?

---

_@AlexWaygood reviewed on 2024-04-29 14:05_

---

_Review comment by @AlexWaygood on `.github/workflows/daily_fuzz.yaml`:52 on 2024-04-29 14:05_

> Is this clamping the random numbers to a range between 1000000

yes

> is there a reason why not to go higher

It looks like we can go as high as 9999999999999999999! Add any more digits to that number and the `shuf` shell utility fails (at least for me locally):

```
(ruff) % echo $(shuf -i0-99999999999999999991 -n 100)                                                                                                                     ~/dev/ruff
shuf: invalid input range: ‘0-99999999999999999991’: Value too large to be stored in data type
```

I'll bump the number to the maximum.

> move the random number generation into the fuzzer script?

The argparsing gets significantly more complex if we move the random generation into the fuzzer script (currently `seeds` is a required command-line argument), so I'd _prefer_ to simply pass a randomly selected set of seeds from the command line.

---

_Label `ci` added by @MichaReiser on 2024-04-29 14:38_

---

_@dhruvmanila approved on 2024-04-29 16:48_

Thank you. I think this could be useful.

---

_Merged by @AlexWaygood on 2024-04-29 16:54_

---

_Closed by @AlexWaygood on 2024-04-29 16:54_

---

_Branch deleted on 2024-04-29 16:54_

---
