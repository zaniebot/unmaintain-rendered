<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check .git in formatter progress checkouts for build - astral-sh/ruff #6387</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Check .git in formatter progress checkouts for build</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6387">#6387</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2023-08-07 11:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><p>From the formatter progress CI logs:</p>
<pre><code>2023-08-07T03:49:02.5178602Z + mkdir -p /home/runner/work/ruff/ruff/target/progress_projects
2023-08-07T03:49:02.5193474Z + &#x27;[&#x27; &#x27;!&#x27; -d /home/runner/work/ruff/ruff/target/progress_projects/build &#x27;]&#x27;
2023-08-07T03:49:02.5194228Z + &#x27;[&#x27; &#x27;!&#x27; -d /home/runner/work/ruff/ruff/target/progress_projects/django &#x27;]&#x27;
2023-08-07T03:49:02.5194966Z + git clone --filter=tree:0 https://github.com/django/django /home/runner/work/ruff/ruff/target/progress_projects/django
2023-08-07T03:49:02.5209260Z Cloning into &#x27;/home/runner/work/ruff/ruff/target/progress_projects/django&#x27;...
</code></pre>
<pre><code>2023-08-07T03:51:17.4726088Z [2m2023-08-07T03:51:17.472404Z[0m [31mERROR[0m Failed /home/runner/work/ruff/ruff/target/progress_projects/build: no python files in [&quot;/home/runner/work/ruff/ruff/target/progress_projects/build&quot;]
</code></pre>
<p>Seems that build exists but is an empty cached folder. These changes should fix this by a) checking for <code>.git</code> instead of just the folder existing b) running the commit checkout unconditionally. The latter is also important if we ever want to update the SHAs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-08-07 11:11</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #6387</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6387"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite"></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6387?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/konstin">@konstin</a> on 2023-08-07 11:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-08-07 11:52</div>
            <div class="timeline-body"><p>The CI failure is unrelated, this fixes the problem with build it was intended to fix</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-07 12:06</div>
            <div class="timeline-body"><p>Do we know what&#x27;s caching the folder in the first place? Because I didn&#x27;t see any caching configuration related to it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-08-07 12:26</div>
            <div class="timeline-body"><p>i don&#x27;t know what caused this initially</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-08-08 09:29</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>âœ… ecosystem check detected no changes.</p>
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      9.6Â±0.03ms     4.2 MB/sec    1.01      9.7Â±0.11ms     4.2 MB/sec
formatter/numpy/ctypeslib.py               1.00  1911.5Â±10.91Âµs     8.7 MB/sec    1.01  1925.8Â±15.82Âµs     8.6 MB/sec
formatter/numpy/globals.py                 1.00    217.1Â±4.16Âµs    13.6 MB/sec    1.00    217.8Â±4.35Âµs    13.5 MB/sec
formatter/pydantic/types.py                1.00      4.1Â±0.03ms     6.3 MB/sec    1.01      4.1Â±0.07ms     6.2 MB/sec
linter/all-rules/large/dataset.py          1.01     12.1Â±0.06ms     3.4 MB/sec    1.00     12.1Â±0.04ms     3.4 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.2Â±0.01ms     5.2 MB/sec    1.00      3.2Â±0.02ms     5.2 MB/sec
linter/all-rules/numpy/globals.py          1.00    450.7Â±1.70Âµs     6.5 MB/sec    1.00    451.9Â±3.76Âµs     6.5 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.5Â±0.02ms     4.6 MB/sec    1.00      5.5Â±0.03ms     4.6 MB/sec
linter/default-rules/large/dataset.py      1.00      6.3Â±0.04ms     6.5 MB/sec    1.00      6.3Â±0.02ms     6.5 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1344.9Â±4.83Âµs    12.4 MB/sec    1.01   1357.2Â±6.64Âµs    12.3 MB/sec
linter/default-rules/numpy/globals.py      1.00    153.3Â±0.48Âµs    19.2 MB/sec    1.00    153.0Â±0.97Âµs    19.3 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.8Â±0.01ms     9.1 MB/sec    1.00      2.8Â±0.01ms     9.1 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01     10.0Â±0.09ms     4.1 MB/sec    1.00      9.9Â±0.08ms     4.1 MB/sec
formatter/numpy/ctypeslib.py               1.00  1898.1Â±18.96Âµs     8.8 MB/sec    1.00  1889.8Â±19.60Âµs     8.8 MB/sec
formatter/numpy/globals.py                 1.00    207.3Â±3.43Âµs    14.2 MB/sec    1.01    208.5Â±5.58Âµs    14.2 MB/sec
formatter/pydantic/types.py                1.01      4.2Â±0.04ms     6.1 MB/sec    1.00      4.2Â±0.05ms     6.1 MB/sec
linter/all-rules/large/dataset.py          1.01     12.8Â±0.11ms     3.2 MB/sec    1.00     12.7Â±0.11ms     3.2 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.5Â±0.07ms     4.8 MB/sec    1.00      3.4Â±0.03ms     4.9 MB/sec
linter/all-rules/numpy/globals.py          1.01    428.9Â±5.66Âµs     6.9 MB/sec    1.00    423.9Â±5.59Âµs     7.0 MB/sec
linter/all-rules/pydantic/types.py         1.01      5.9Â±0.06ms     4.3 MB/sec    1.00      5.8Â±0.07ms     4.4 MB/sec
linter/default-rules/large/dataset.py      1.01      6.9Â±0.06ms     5.9 MB/sec    1.00      6.8Â±0.07ms     6.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01  1415.3Â±20.63Âµs    11.8 MB/sec    1.00  1401.4Â±23.87Âµs    11.9 MB/sec
linter/default-rules/numpy/globals.py      1.00    158.8Â±3.55Âµs    18.6 MB/sec    1.03   164.3Â±30.36Âµs    18.0 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.0Â±0.04ms     8.4 MB/sec    1.00      3.0Â±0.04ms     8.5 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/konstin">@konstin</a> on 2023-08-08 09:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2023-08-08 09:55</div>
            <div class="timeline-body"><p>Okay I think I know what the problem is. If I understand it correctly, the script clones into the <code>target</code> directory. However, the target directory gets cached by <a href="https://github.com/Swatinem/rust-cache"><code>rust-cache</code>. </a>.</p>
<p>I didn&#x27;t see an option to exclude a specific directory. One option could be to add a CLI command that removes the checked-out project directory to avoid including them in the rust cache.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-08-08 10:14</div>
            <div class="timeline-body"><p>I think it does clean &quot;Anything that is not a dependency.&quot;, it&#x27;s just that <code>build</code> looks like something that needs to be cached (https://github.com/Swatinem/rust-cache/blob/b919e1427f59422679cf2ed5fc6ddc010f753026/src/cleanup.ts#L37)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-08-08 15:44</div>
            <div class="timeline-body"><p>Yeah. You&#x27;re right. You can see how the repository isn&#x27;t restored in the <a href="https://github.com/astral-sh/ruff/actions/runs/5795617584/job/15718180198">job&#x27;s debug log</a>.</p>
<p>I&#x27;m a bit hesitant about adding workarounds for issues that we don&#x27;t understand (and it seems to be working fine now).  But I also don&#x27;t want to block this further.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/konstin">@konstin</a> on 2023-08-08 15:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/konstin">@konstin</a> on 2023-08-08 15:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-08-08 15:46</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:56:05 UTC
    </footer>
</body>
</html>
