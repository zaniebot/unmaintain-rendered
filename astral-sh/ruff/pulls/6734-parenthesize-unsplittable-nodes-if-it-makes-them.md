```yaml
number: 6734
title: Parenthesize unsplittable nodes if it makes them fit
type: pull_request
state: closed
author: MichaReiser
labels:
  - formatter
assignees: []
draft: true
base: main
head: parenthesize-unsplittable
created_at: 2023-08-21T15:22:48Z
updated_at: 2024-01-16T10:04:14Z
url: https://github.com/astral-sh/ruff/pull/6734
synced_at: 2026-01-12T15:55:22Z
```

# Parenthesize unsplittable nodes if it makes them fit

---

_@MichaReiser_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This PR implements black's logic where it parenthesizes unsplittable nodes like constants or identifiers
if it makes them fit the line

closes https://github.com/astral-sh/ruff/issues/6271

<!-- What's the purpose of the change? What does it do, and why? -->

## Test Plan

I added new test plans, diffed the output for `django` to ensure this PR introduces no regression, and verified that the similarity indices improve

**main**

| project      | similarity index |
|--------------|------------------|
| cpython      | 0.75473          |
| django       | 0.99805          |
| transformers | 0.99620          |
| twine        | 0.99876          |
| typeshed     | 0.99953          |
| warehouse    | 0.99601          |
| zulip        | 0.99727          |

**This PR**

| project      | similarity index |
|--------------|------------------|
| cpython      | 0.75475          |
| django       | 0.99880          |
| transformers | 0.99629          |
| twine        | 0.99929          |
| typeshed     | 0.99953          |
| warehouse    | 0.99613          |
| zulip        | 0.99852          |


<!-- How was it tested? -->


---

_Comment by @MichaReiser on 2023-08-21 15:22_

Current dependencies on/for this PR:
* main
  * **PR #6734** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6734" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6734?utm_source=stack-comment).

---

_Renamed from "Revert "Remove `mode` from `BestFitting`"" to "Parenthesize unsplittable nodes if it makes them fit" by @MichaReiser on 2023-08-21 15:23_

---

_Label `formatter` added by @MichaReiser on 2023-08-21 15:24_

---

_@MichaReiser reviewed on 2023-08-21 15:26_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/mod.rs`:226 on 2023-08-21 15:26_

I'm not very happy with this name. The branches are the same as for `Never` except for `IfBreaks`. 

---

_Review comment by @MichaReiser on `crates/ruff_formatter/src/builders.rs`:1 on 2023-08-21 15:27_

The formatter changes bring back the `BestFitting::print_mode`

---

_@MichaReiser reviewed on 2023-08-21 15:27_

---

_Review comment by @MichaReiser on `crates/ruff_formatter/src/printer/mod.rs`:319 on 2023-08-21 15:28_

This was a bug in the Printer where group modes set during a previous `fits` test stuck around. 

---

_@MichaReiser reviewed on 2023-08-21 15:28_

---

_Comment by @github-actions[bot] on 2023-08-21 16:35_

## PR Check Results
### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      3.3Â±0.01ms    12.3 MB/sec    1.01      3.3Â±0.01ms    12.2 MB/sec
formatter/numpy/ctypeslib.py               1.00    672.9Â±9.44Âµs    24.7 MB/sec    1.01   682.9Â±10.25Âµs    24.4 MB/sec
formatter/numpy/globals.py                 1.00     70.9Â±0.64Âµs    41.6 MB/sec    1.01     71.4Â±0.46Âµs    41.3 MB/sec
formatter/pydantic/types.py                1.00  1339.1Â±13.73Âµs    19.0 MB/sec    1.03  1385.0Â±18.36Âµs    18.4 MB/sec
linter/all-rules/large/dataset.py          1.00     10.4Â±0.03ms     3.9 MB/sec    1.00     10.4Â±0.03ms     3.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      2.9Â±0.00ms     5.8 MB/sec    1.00      2.8Â±0.01ms     5.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    319.8Â±1.09Âµs     9.2 MB/sec    1.02    325.5Â±1.31Âµs     9.1 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.4Â±0.01ms     4.7 MB/sec    1.00      5.4Â±0.02ms     4.7 MB/sec
linter/default-rules/large/dataset.py      1.00      5.6Â±0.01ms     7.3 MB/sec    1.00      5.6Â±0.01ms     7.3 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01   1188.7Â±2.86Âµs    14.0 MB/sec    1.00   1179.5Â±3.44Âµs    14.1 MB/sec
linter/default-rules/numpy/globals.py      1.00    123.3Â±0.48Âµs    23.9 MB/sec    1.01    125.2Â±1.79Âµs    23.6 MB/sec
linter/default-rules/pydantic/types.py     1.01      2.5Â±0.03ms    10.1 MB/sec    1.00      2.5Â±0.01ms    10.1 MB/sec
```

#### Windows
```
group                                      main                                    pr
-----                                      ----                                    --
formatter/large/dataset.py                 1.00      4.2Â±0.27ms     9.7 MB/sec     1.14      4.7Â±0.30ms     8.6 MB/sec
formatter/numpy/ctypeslib.py               1.00   859.5Â±44.50Âµs    19.4 MB/sec     1.14   980.8Â±74.39Âµs    17.0 MB/sec
formatter/numpy/globals.py                 1.00     91.6Â±9.00Âµs    32.2 MB/sec     1.04     95.2Â±6.78Âµs    31.0 MB/sec
formatter/pydantic/types.py                1.00  1810.5Â±124.71Âµs    14.1 MB/sec    1.08  1954.3Â±152.00Âµs    13.0 MB/sec
linter/all-rules/large/dataset.py          1.03     17.3Â±0.96ms     2.4 MB/sec     1.00     16.8Â±0.57ms     2.4 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.5Â±0.22ms     3.7 MB/sec     1.00      4.5Â±0.22ms     3.7 MB/sec
linter/all-rules/numpy/globals.py          1.04   606.3Â±44.76Âµs     4.9 MB/sec     1.00   584.6Â±72.40Âµs     5.0 MB/sec
linter/all-rules/pydantic/types.py         1.01      8.7Â±0.44ms     2.9 MB/sec     1.00      8.6Â±0.31ms     3.0 MB/sec
linter/default-rules/large/dataset.py      1.00      9.0Â±0.41ms     4.5 MB/sec     1.09      9.8Â±0.74ms     4.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1884.6Â±109.84Âµs     8.8 MB/sec    1.07      2.0Â±0.11ms     8.2 MB/sec
linter/default-rules/numpy/globals.py      1.00   224.4Â±14.22Âµs    13.1 MB/sec     1.10   246.2Â±12.56Âµs    12.0 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.9Â±0.15ms     6.5 MB/sec     1.06      4.1Â±0.19ms     6.2 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_@konstin reviewed on 2023-08-21 17:35_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/mod.rs`:226 on 2023-08-21 17:35_

`BetterFitOnly`?

---

_Comment by @MichaReiser on 2023-08-21 17:52_

Ouch, this is, not too surprisingly, not good for performance.

---

_Comment by @charliermarsh on 2023-08-21 18:01_

Is that mostly due to the `best_fitting!` or is there something else going on?

---

_Comment by @MichaReiser on 2023-08-21 18:27_

It's a combination of memoized and best fitting, both of them allocate, and best fitting requires a `fits` pass for every variant except the last.

The solution is to limit the condition of when to use this layout. It should only be necessary if the content length is close to the max line length (I have to do some math tomorrow)

---

_Comment by @MichaReiser on 2023-08-23 12:10_

Splitting the PR must have confused graphite. See https://github.com/astral-sh/ruff/pull/6816

---

_Closed by @MichaReiser on 2023-08-23 12:10_

---

_Branch deleted on 2024-01-16 10:04_

---
