<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Fix false positive for Final attribute assignment in __init__ - astral-sh/ruff #21158</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Fix false positive for Final attribute assignment in <strong>init</strong></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21158">#21158</a>
        opened by <a href="https://github.com/saada">@saada</a>
        on 2025-10-31 02:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/saada">@saada</a></div>
            <div class="timeline-body">Summary
<p>Fixes <a href="https://github.com/astral-sh/ty/issues/1409">astral-sh/ty#1409</a></p>
<p>This PR allows <code>Final</code> instance attributes to be initialized in <code>__init__</code> methods, as mandated by the Python typing specification (PEP 591). Previously, ty incorrectly prevented this initialization, causing false positive errors.</p>
<p>The fix checks if we&#x27;re inside an <code>__init__</code> method before rejecting Final attribute assignments, allowing the first assignment during instance initialization while still preventing reassignment elsewhere.</p>
Test Plan
<ul>
<li>Added new test coverage in <code>final.md</code> for the reported issue with <code>Self</code> annotations</li>
<li>Updated existing tests that were incorrectly expecting errors</li>
<li>All 278 mdtest tests pass</li>
<li>Manually tested with real-world code examples</li>
</ul>
<p>This is my first contribution to the project, so I&#x27;d appreciate any feedback or guidance!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/saada">@saada</a> on 2025-10-31 02:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/saada">@saada</a> on 2025-10-31 02:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/saada">@saada</a> on 2025-10-31 02:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/saada">@saada</a> on 2025-10-31 02:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-31 03:10</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a>

Changes were detected when running ty on typing conformance tests

<pre><code>--- old-output.txt	2025-11-11 20:42:52.251115074 +0000
+++ new-output.txt	2025-11-11 20:42:55.645138741 +0000
@@ -864,10 +864,7 @@
 qualifiers_annotated.py:87:1: error[call-non-callable] Object of type `GenericAlias` is not callable
 qualifiers_annotated.py:88:1: error[call-non-callable] Object of type `GenericAlias` is not callable
 qualifiers_final_annotation.py:18:7: error[invalid-type-form] Type qualifier `typing.Final` expected exactly 1 argument, got 2
-qualifiers_final_annotation.py:52:9: error[invalid-assignment] Cannot assign to final attribute `ID4` on type `Self@__init__`
-qualifiers_final_annotation.py:54:9: error[invalid-assignment] Cannot assign to final attribute `ID5` on type `Self@__init__`
-qualifiers_final_annotation.py:57:13: error[invalid-assignment] Cannot assign to final attribute `ID6` on type `Self@__init__`
-qualifiers_final_annotation.py:59:13: error[invalid-assignment] Cannot assign to final attribute `ID6` on type `Self@__init__`
+qualifiers_final_annotation.py:54:9: error[invalid-assignment] Cannot assign to final attribute `ID5` in `__init__` because it already has a value at class level
 qualifiers_final_annotation.py:65:9: error[invalid-assignment] Cannot assign to final attribute `ID7` on type `Self@method1`
 qualifiers_final_annotation.py:71:1: error[invalid-assignment] Reassignment of `Final` symbol `RATE` is not allowed: Symbol later reassigned here
 qualifiers_final_annotation.py:81:1: error[invalid-assignment] Cannot assign to final attribute `DEFAULT_ID` on type `&lt;class &#x27;ClassB&#x27;&gt;`
@@ -1006,5 +1003,5 @@
 typeddicts_usage.py:28:17: error[missing-typed-dict-key] Missing required key &#x27;name&#x27; in TypedDict `Movie` constructor
 typeddicts_usage.py:28:18: error[invalid-key] Invalid key for TypedDict `Movie`: Unknown key &quot;title&quot;
 typeddicts_usage.py:40:24: error[invalid-type-form] The special form `typing.TypedDict` is not allowed in type expressions. Did you mean to use a concrete TypedDict or `collections.abc.Mapping[str, object]` instead?
-Found 1008 diagnostics
+Found 1005 diagnostics
 WARN A fatal error occurred while checking some files. Not all project files were analyzed. See the diagnostics list above for details.

</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-31 03:12</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>schema_salad (https://github.com/common-workflow-language/schema_salad)
- schema_salad/metaschema.py:73:9: error[invalid-assignment] Cannot assign to final attribute `original_doc` on type `Self@__init__`
- schema_salad/metaschema.py:79:9: error[invalid-assignment] Cannot assign to final attribute `idx` on type `Self@__init__`
- schema_salad/metaschema.py:85:9: error[invalid-assignment] Cannot assign to final attribute `fileuri` on type `Self@__init__`
- schema_salad/metaschema.py:91:9: error[invalid-assignment] Cannot assign to final attribute `baseuri` on type `Self@__init__`
- schema_salad/metaschema.py:97:9: error[invalid-assignment] Cannot assign to final attribute `namespaces` on type `Self@__init__`
- schema_salad/metaschema.py:103:9: error[invalid-assignment] Cannot assign to final attribute `schemas` on type `Self@__init__`
- schema_salad/metaschema.py:109:9: error[invalid-assignment] Cannot assign to final attribute `addl_metadata` on type `Self@__init__`
- schema_salad/metaschema.py:115:9: error[invalid-assignment] Cannot assign to final attribute `imports` on type `Self@__init__`
- schema_salad/metaschema.py:121:9: error[invalid-assignment] Cannot assign to final attribute `includes` on type `Self@__init__`
- schema_salad/metaschema.py:127:9: error[invalid-assignment] Cannot assign to final attribute `no_link_check` on type `Self@__init__`
- schema_salad/metaschema.py:133:9: error[invalid-assignment] Cannot assign to final attribute `container` on type `Self@__init__`
- schema_salad/metaschema.py:150:9: error[invalid-assignment] Cannot assign to final attribute `fetcher` on type `Self@__init__`
- schema_salad/metaschema.py:152:9: error[invalid-assignment] Cannot assign to final attribute `cache` on type `Self@__init__`
- schema_salad/metaschema.py:163:9: error[invalid-assignment] Cannot assign to final attribute `vocab` on type `Self@__init__`
- schema_salad/metaschema.py:164:9: error[invalid-assignment] Cannot assign to final attribute `rvocab` on type `Self@__init__`
- schema_salad/python_codegen_support.py:70:9: error[invalid-assignment] Cannot assign to final attribute `original_doc` on type `Self@__init__`
- schema_salad/python_codegen_support.py:76:9: error[invalid-assignment] Cannot assign to final attribute `idx` on type `Self@__init__`
- schema_salad/python_codegen_support.py:82:9: error[invalid-assignment] Cannot assign to final attribute `fileuri` on type `Self@__init__`
- schema_salad/python_codegen_support.py:88:9: error[invalid-assignment] Cannot assign to final attribute `baseuri` on type `Self@__init__`
- schema_salad/python_codegen_support.py:94:9: error[invalid-assignment] Cannot assign to final attribute `namespaces` on type `Self@__init__`
- schema_salad/python_codegen_support.py:100:9: error[invalid-assignment] Cannot assign to final attribute `schemas` on type `Self@__init__`
- schema_salad/python_codegen_support.py:106:9: error[invalid-assignment] Cannot assign to final attribute `addl_metadata` on type `Self@__init__`
- schema_salad/python_codegen_support.py:112:9: error[invalid-assignment] Cannot assign to final attribute `imports` on type `Self@__init__`
- schema_salad/python_codegen_support.py:118:9: error[invalid-assignment] Cannot assign to final attribute `includes` on type `Self@__init__`
- schema_salad/python_codegen_support.py:124:9: error[invalid-assignment] Cannot assign to final attribute `no_link_check` on type `Self@__init__`
- schema_salad/python_codegen_support.py:130:9: error[invalid-assignment] Cannot assign to final attribute `container` on type `Self@__init__`
- schema_salad/python_codegen_support.py:147:9: error[invalid-assignment] Cannot assign to final attribute `fetcher` on type `Self@__init__`
- schema_salad/python_codegen_support.py:149:9: error[invalid-assignment] Cannot assign to final attribute `cache` on type `Self@__init__`
- schema_salad/python_codegen_support.py:160:9: error[invalid-assignment] Cannot assign to final attribute `vocab` on type `Self@__init__`
- schema_salad/python_codegen_support.py:161:9: error[invalid-assignment] Cannot assign to final attribute `rvocab` on type `Self@__init__`
- Found 195 diagnostics
+ Found 165 diagnostics

mypy (https://github.com/python/mypy)
- mypy/types.py:554:9: error[invalid-assignment] Cannot assign to final attribute `raw_id` on type `Self@__init__`
- mypy/typestate.py:106:9: error[invalid-assignment] Cannot assign to final attribute `_subtype_caches` on type `Self@__init__`
- mypy/typestate.py:107:9: error[invalid-assignment] Cannot assign to final attribute `_negative_subtype_caches` on type `Self@__init__`
- mypy/typestate.py:109:9: error[invalid-assignment] Cannot assign to final attribute `_attempted_protocols` on type `Self@__init__`
- mypy/typestate.py:110:9: error[invalid-assignment] Cannot assign to final attribute `_checked_against_members` on type `Self@__init__`
- mypy/typestate.py:111:9: error[invalid-assignment] Cannot assign to final attribute `_rechecked_types` on type `Self@__init__`
- mypy/typestate.py:112:9: error[invalid-assignment] Cannot assign to final attribute `_assuming` on type `Self@__init__`
- mypy/typestate.py:113:9: error[invalid-assignment] Cannot assign to final attribute `_assuming_proper` on type `Self@__init__`
- mypy/typestate.py:114:9: error[invalid-assignment] Cannot assign to final attribute `inferring` on type `Self@__init__`
- Found 1712 diagnostics
+ Found 1703 diagnostics

hydpy (https://github.com/hydpy-dev/hydpy)
- hydpy/core/threadingtools.py:214:9: error[invalid-assignment] Cannot assign to final attribute `upstream2downstream` on type `Self@__init__`
- hydpy/core/threadingtools.py:215:9: error[invalid-assignment] Cannot assign to final attribute `starters` on type `Self@__init__`
- hydpy/core/threadingtools.py:216:9: error[invalid-assignment] Cannot assign to final attribute `dependencies` on type `Self@__init__`
- Found 665 diagnostics
+ Found 662 diagnostics


</code></pre>


<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-10-31 10:52</div>
            <div class="timeline-body"><p>Thank you for working on this. I think we should probably just allow the <em>first</em> assignment to a <code>Final</code>-qualified attribute in <code>__init__</code>? It would also be good to add some tests that assignments to those attributes from other methods is not allowed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-31 10:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-31 13:42</div>
            <div class="timeline-body"><p>Thank you for the PR!!</p>
<p>Some other tests that I think we&#x27;re currently missing: this should probably be disallowed. It looks like we already <em>do</em> disallow it, but I can&#x27;t find any explicit tests for it (@sharkdp, please correct me if I&#x27;m wrong!):</p>
<pre><code>from typing import Final

class Foo:
    X: Final = 42

    def __init__(self):
        self.X = 56
</code></pre>
<p>This should probably be allowed, and it would be great to add a test for it:</p>
<pre><code>import sys
from typing import Final

```py
class Bar:
    X: Final[int]

    def __init__(self):
        if sys.version_info &gt;= (3, 11):
            self.X = 42
        else:
            self.X = 56
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/saada">@saada</a> on 2025-10-31 14:47</div>
            <div class="timeline-body"><p>Thanks for the feedback. After several iterations, I think this is the cleanest approach.</p>
<p>The Rust fix works by modifying the <code>invalid_assignment_to_final</code> closure to check whether we&#x27;re currently inside an <code>__init__</code> method before rejecting Final attribute assignments. Before the fix, ty was rejecting <em>all</em> assignments to Final attributes regardless of context, which caused false positives for valid Python code like <code>self.x: Final[int]</code> followed by <code>self.x = 1</code> in <code>__init__</code>. Per PEP 591, Final instance attributes must be initialized exactly once, and <code>__init__</code> is the designated place for that initialization. The fix adds an <code>is_in_init()</code> helper that checks <code>current_function_definition().name.id == &quot;__init__&quot;</code>, and only rejects Final assignments when this check is false.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-10-31 16:20</div>
            <div class="timeline-body"><p>We should confirm our assumptions about the desired behavior here against the <a href="https://github.com/python/typing/blob/main/conformance/tests/qualifiers_final_annotation.py">conformance tests</a> and the <a href="https://typing.python.org/en/latest/spec/qualifiers.html#uppercase-final">spec</a> and verify that the behavior we&#x27;re implementing matches them. It&#x27;s also useful to validate against other type checkers.</p>
<blockquote>
<p>I think we should probably just allow the <em>first</em> assignment to a <code>Final</code>-qualified attribute in <code>__init__</code>?</p>
</blockquote>
<p>The conformance suite does not require this. It does require that we allow multiple conditional assignments in <code>__init__</code> (and not only in cases where one of them is unreachable):</p>
<pre><code>class C:
    x: Final[int]

    def __init__(self, cond: bool):
        if cond:
            self.x = 1
        else:
            self.x = 2
</code></pre>
<p>It appears that both <a href="https://mypy-play.net/?mypy=latest&amp;python=3.12&amp;gist=8cc45115516c8cbea885131d730e413b">mypy</a> and <a href="https://pyright-play.net/?pyrightVersion=1.1.405&amp;strict=true&amp;code=GYJw9gtgBALgngBwJYDsDmUkQWEMoBiqAhgDYCwAUFQManEDODUAwgFxVRdQAebhJUgG1UMALpVO3ACYBTYFAD6i1EhjKAFA1mlgASg6VuxqNt0A6HlAC8UAIxSTpncEs2oAJipA">pyright</a> simply always allow multiple assignments in <code>__init__</code>. I think it&#x27;s fine if we do that, too.</p>
<p>The other thing highlighted by the conformance suite results is that we should still error on assignment in <code>__init__</code> if a value was already assigned at class level.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/saada">@saada</a> on 2025-10-31 16:32</div>
            <div class="timeline-body"><p>I checked the other type checkers and here&#x27;s a summary of what was found</p>
<p>Our implementation matches closer to pyright!</p>
<p>| Case | Description | ty | pyright | mypy | Winner |
|------|-------------|-------|---------|------|--------|
| <strong>Conditional assignments in __init__</strong> | <code>if cond: self.x=1</code> <code>else: self.x=2</code> | ✅ Allow | ✅ Allow | ❌ Error | ty &amp; pyright ✓ |
| <strong>Reassign class-level Final in __init__</strong> | Class has <code>x: Final = 10</code>, reassign in <code>__init__</code> | ❌ Error | ❌ Error | ✅ Allow | ty &amp; pyright ✓ |
| <strong>Assignment in helper method</strong> | Called from <code>__init__</code> but different method | ❌ Error | ❌ Error | ✅ Allow | ty &amp; pyright ✓ |
| <strong>Nested conditionals</strong> | Multiple if/else levels in <code>__init__</code> | ✅ Allow | ✅ Allow | ❌ Error | ty &amp; pyright ✓ |
| <strong>Try/except assignments</strong> | Assign in try and except blocks | ✅ Allow | ✅ Allow | ❌ Error | ty &amp; pyright ✓ |
| <strong>Uninitialized Final</strong> | <code>x: Final[int]</code> with no <code>__init__</code> or value | ✅ Allow | ❌ Error | ❌ Error | <strong>pyright &amp; mypy ✓</strong> |
| <strong>Assignment after super()</strong> | Assign before and after <code>super().__init__()</code> | ✅ Allow | ✅ Allow | ❌ Error | ty &amp; pyright ✓ |
| <strong>Bare Final with value</strong> | <code>x: Final = 1</code>, reassign in <code>__init__</code> | ❌ Error | ❌ Error | ✅ Allow | ty &amp; pyright ✓ |</p>
<p>We might have to take a stance here since there&#x27;s a gap in behavior between the tools</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-10-31 17:39</div>
            <div class="timeline-body"><p>@saada Thanks for generating the chart. I think the chart is not really accurate, though, so I&#x27;m wondering what method you used to generate it.</p>
<p>For example, I checked the first row, and <a href="https://mypy-play.net/?mypy=latest&amp;python=3.12&amp;gist=167ed2f02ccbc97b8c32cd8bb773f314">mypy does allow the two conditional assignments</a>, so I&#x27;m not sure why it&#x27;s marked with an X in that row on your chart. In fact, as I mentioned in my previous comment, <a href="https://mypy-play.net/?mypy=latest&amp;python=3.12&amp;gist=8cc45115516c8cbea885131d730e413b">mypy allows two subsequent assignments in <code>__init__</code> even if they are not conditional at all</a>.</p>
<p>And in the second row, you claim that pyright is OK with assignment in <code>__init__</code> if there is a class-level value assigned, but that <a href="https://pyright-play.net/?pyrightVersion=1.1.405&amp;strict=true&amp;code=GYJw9gtgBALgngBwJYDsDmUkQWEMoBiqAhgDYCwAUFQManEDODUAwgFxVRdQAebhJUgG1UMALpQAvFACMABiqduAEwCmwKAH1NqJDG0AKBqtLAAlB0rdrUY6YB0PKbKpA">doesn&#x27;t seem to be true either</a>.</p>
<p>In general I think the behavior of mypy and pyright is much more consistent with each other in this area than your chart suggests, and where they agree that&#x27;s a pretty strong signal that we should also agree, unless we have very good reason to do otherwise.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/saada">@saada</a> on 2025-10-31 23:12</div>
            <div class="timeline-body"><p>@carljm Thank you for the detailed review and pointing me to the conformance suite! After thorough investigation, I can confirm our implementation is correct.</p>
Key Finding: Mypy Playground Mystery Solved
<p>Your mypy playground link shows no error because it uses <strong>untyped parameters</strong>:</p>
<pre><code>def __init__(self, cond):  # ← No type annotation
</code></pre>
<p>When I test <a href="https://mypy-play.net/?mypy=latest&amp;python=3.12&amp;gist=8c198505b1775b2c1aa9fcb90e686c2f">with typed parameters</a>, mypy errors (as documented in the conformance suite):</p>
<pre><code>def __init__(self, cond: bool):  # ← With type annotation
# mypy ERROR: Cannot assign to final attribute
</code></pre>
Comprehensive Comparison
Case 1: Sequential Assignments in <code>__init__</code>
<pre><code>class C:
    x: Final[int]
    def __init__(self):
        self.x = 1
        self.x = 2
</code></pre>
<p><strong>Playground links</strong>: <a href="https://mypy-play.net/?mypy=latest&amp;python=3.12&amp;gist=8cc45115516c8cbea885131d730e413b">mypy ✅</a> | <a href="https://pyright-play.net/?pyrightVersion=1.1.405&amp;strict=true&amp;code=GYJw9gtgBALgngBwJYDsDmUkQWEMoBiqAhgDYCwAUFQManEDODUAwgFxVRdQAebhJUgG1UMALpVO3ACYBTYFAD6i1EhjKAFA1mlgASg6VuxqNt0A6HlAC8UAIxSTpncEs2oAJipA">pyright ✅</a></p>
<hr>
Case 2: Conditional Assignments (untyped)
<pre><code>class C:
    x: Final[int]
    def __init__(self, cond):  # ← NO type annotation
        if cond:
            self.x = 1
        else:
            self.x = 2
</code></pre>
<p><strong>Playground links</strong>: <a href="https://mypy-play.net/?mypy=latest&amp;python=3.12&amp;gist=167ed2f02ccbc97b8c32cd8bb773f314">mypy ✅</a> | <a href="https://pyright-play.net/?pyrightVersion=1.1.405&amp;strict=true&amp;code=GYJw9gtgBALgngBwJYDsDmUkQWEMoBiqAhgDYBQ5AxqcQM51QDCAXOVB1AB4uEmkBtVDAC67TgBMApsCgB9OaiQwFACjpTSwADRQqYFBICUvAMSxEU3kjQpcU8Z05JZ%2Bw2yefOGrQDouUAC8UACMjp6aGh5enj7A-kFQAExAA">pyright ✅</a></p>
<p><strong>Note</strong>: Mypy skips checking untyped function bodies by default. Pyright shows parameter type warnings but no Final assignment error.</p>
<hr>
Case 3: Conditional Assignments (typed)
<pre><code>class C:
    x: Final[int]
    def __init__(self, cond: bool):  # ← WITH type annotation
        if cond:
            self.x = 1
        else:
            self.x = 2
</code></pre>
<p><strong>Playground links</strong>: <a href="https://mypy-play.net/?mypy=latest&amp;python=3.12&amp;gist=8c198505b1775b2c1aa9fcb90e686c2f">mypy ❌</a> | <a href="https://pyright-play.net/?pyrightVersion=1.1.405&amp;strict=true&amp;code=GYJw9gtgBALgngBwJYDsDmUkQWEMoBiqAhgDYBQ5AxqcQM51QDCAXOVB1AB4uEmkBtVDAC67TgBMApsCgB9OaiQwFACjpTSwADRQqYFBN4AjMGFIBKNpxuZZ%2Bw9dvONWgHRcoAXigBGcc6aGk7ONq7AHt5QAExAA">pyright ✅</a></p>
<p><strong>Conformance</strong>: Lines 57-59 in <code>qualifiers_final_annotation.py</code> have NO <code># E</code> marker → must allow</p>
<hr>
Case 4: Class-Level Value Reassignment ⚠️
<pre><code>class C:
    x: Final[int] = 10  # ← Has value at class level
    def __init__(self):
        self.x = 20
</code></pre>
<p><strong>Playground links</strong>: <a href="https://mypy-play.net/?mypy=latest&amp;python=3.12&amp;gist=50554d824cfb6b4e1a6245f5f8ac13d7">mypy ✅ WRONG</a> | <a href="https://pyright-play.net/?pyrightVersion=1.1.405&amp;strict=true&amp;code=GYJw9gtgBALgngBwJYDsDmUkQWEMoBiqAhgDYBQ5AxqcQM51QDCAXOVB1AB4uEmkBtVDAC6UALxQAjAAZ2nACYBTYFAD6a1EhgaAFHSWlgASjadzUA0YB0XCVABMMoA">pyright ❌</a></p>
<p><strong>Conformance</strong>: Line 54 in <code>qualifiers_final_annotation.py</code> has <code># E: Already initialized</code> → must error</p>
<hr>
Summary Table
<p>| Test Case              | mypy    | pyright | ty  | Conformance |
|------------------------|---------|---------|-----|-------------|
| Sequential in <strong>init</strong> | ✅       | ✅       | ✅   | Must allow  |
| Conditional (untyped)  | ✅       | ✅       | ✅   | Must allow  |
| Conditional (typed)    | ❌ ERROR | ✅       | ✅   | Must allow  |
| Class-level value      | ✅ WRONG | ❌       | ❌   | Must error  |
| Outside <strong>init</strong>       | ❌       | ❌       | ❌   | Must error  |</p>
<p><strong>Result: ty matches pyright perfectly (5/5 conformant)</strong></p>
Official Conformance Results
<p>From the <code>python/typing</code> repository:</p>
<p><strong>pyright</strong>: <code>conformant = &quot;Pass&quot;</code> ✅</p>
<p><strong>mypy</strong>: <code>conformant = &quot;Partial&quot;</code> with note:</p>
<blockquote>
<p>&quot;Does not allow conditional assignment of Final instance variable in <strong>init</strong> method.&quot;</p>
</blockquote>
<p>Our implementation is correct as-is and matches the conformance suite requirements.</p>
<hr>
<p><strong>Note</strong>: Our test suite (<code>final.md</code>) has been updated to explicitly cover both typed and untyped conditional assignment cases to ensure comprehensive coverage of all scenarios discussed above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-11-04 20:37</div>
            <div class="timeline-body"><p>Aha! Thank you for pointing out that my mypy result was due to not having any type annotations on the <code>__init__</code> method. This always trips me up!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/type_qualifiers/final.md</code>:91 on 2025-11-04 20:39</div>
            <div class="timeline-body"><p>I don&#x27;t think we need to comment on every non-error, unless there&#x27;s something notable or unusual about it.</p>
<pre><code>        self.FINAL_E = 1
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/type_qualifiers/final.md</code>:187 on 2025-11-04 20:39</div>
            <div class="timeline-body"><pre><code>        self.INSTANCE_FINAL_C = 1
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/type_qualifiers/final.md</code>:282 on 2025-11-04 20:39</div>
            <div class="timeline-body"><pre><code>        self.LEGAL_I = 1
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/type_qualifiers/final.md</code>:394 on 2025-11-04 20:39</div>
            <div class="timeline-body"><pre><code>        self.DEFINED_IN_INIT = 1
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/infer/builder.rs</code>:3657 on 2025-11-04 21:02</div>
            <div class="timeline-body"><p>I think this logic currently leads to false negatives in cases like these:</p>
<pre><code>from typing import Final

class C:
    x: Final[int] = 100

def _(c: C):
    c.x = 1

def __init__(c: C):
    c.x = 1

class A:
    def __init__(self, c: C):
        c.x = 1
</code></pre>
<p>We should add these cases to the tests, and expand our checking here to validate that we are in the <code>__init__</code> method of the class on which we are trying to assign a final attribute. Even then, there is still this case to consider as well:</p>
<pre><code>from typing import Final, Self

class C:
    x: Final[int]

    def __init__(self, c: Self):
        c.x = 3
</code></pre>
<p>Ideally this should not be allowed either; <code>__init__</code> should only be allowed to mutate the <code>self</code> object (the first argument). I think this should be fairly easy to check, I believe we have some other cases where we already check this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-11-04 21:02</div>
            <div class="timeline-body"><p>Thanks for working on this! I agree with your conclusions above about the correct semantics.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/saada">@saada</a> on 2025-11-06 23:11</div>
            <div class="timeline-body"><p>Thank you for the thorough feedback! How does this look?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-11-11 20:42</div>
            <div class="timeline-body"><p>Looks good, thank you! I pushed a few simplifications, will merge once CI is green.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/carljm">@carljm</a> on 2025-11-11 20:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2025-11-11 20:54</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:20:02 UTC
    </footer>
</body>
</html>
