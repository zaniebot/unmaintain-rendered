<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`ruff`] Frozen Dataclass default should be valid (`RUF009`) - astral-sh/ruff #18735</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>ruff</code>] Frozen Dataclass default should be valid (<code>RUF009</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18735">#18735</a>
        opened by <a href="https://github.com/lubaskinc0de">@lubaskinc0de</a>
        on 2025-06-17 19:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/lubaskinc0de">@lubaskinc0de</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff/ty! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title? (Please prefix with `[ty]` for ty pull
  requests.)
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>/closes #17424</p>
<!-- What's the purpose of the change? What does it do, and why? -->

<h2>Test Plan</h2>
<!-- How was it tested? -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "RUF009 - Frozen Dataclass default should be valid #17424" to "[ruff] Frozen Dataclass default should be valid #17424" by @lubaskinc0de on 2025-06-17 20:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/src/rules/ruff/rules/function_call_in_dataclass_default.rs</code>:109 on 2025-06-18 18:33</div>
            <div class="timeline-body"><p>These lines could be simplified to:</p>
<pre><code class="language-rust">let Some(Stmt::ClassDef(class_def)) = binding.statement(semantic) else {
	return false;
};
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2025-06-18 18:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/lubaskinc0de">@lubaskinc0de</a> reviewed on 2025-06-18 21:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/lubaskinc0de">@lubaskinc0de</a> on <code>crates/ruff_linter/src/rules/ruff/rules/function_call_in_dataclass_default.rs</code>:109 on 2025-06-18 21:14</div>
            <div class="timeline-body"><p>done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @lubaskinc0de on 2025-06-18 21:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @lubaskinc0de on 2025-06-18 21:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @lubaskinc0de on 2025-06-18 21:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lubaskinc0de">@lubaskinc0de</a> on 2025-06-18 22:12</div>
            <div class="timeline-body"><p>ready for review</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lubaskinc0de">@lubaskinc0de</a> on 2025-06-19 09:48</div>
            <div class="timeline-body"><p>i am also fixed dataclass_kind helper more info here https://discord.com/channels/1039017663004942429/1039017663512449056/1385177991319126117</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[ruff] Frozen Dataclass default should be valid #17424" to "[ruff] Frozen Dataclass default should be valid" by @MichaReiser on 2025-06-19 11:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-20 07:09</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+1 -0 violations, +0 -0 fixes in 1 projects; 54 projects unchanged)</p>
<details><summary><a href="https://github.com/reflex-dev/reflex">reflex-dev/reflex</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>

<pre>
+ <a href='https://github.com/reflex-dev/reflex/blob/5ed8704525c03241eec93b19e3e65b0b691269e3/reflex/event.py#L573'>reflex/event.py:573:72:</a> RUF100 [*] Unused `noqa` directive (unused: `RUF009`)
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| RUF100 | 1 | 1 | 0 | 0 | 0 |</p>
</p>
</details>

<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+1 -0 violations, +0 -0 fixes in 1 projects; 54 projects unchanged)</p>
<details><summary><a href="https://github.com/reflex-dev/reflex">reflex-dev/reflex</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/reflex-dev/reflex/blob/5ed8704525c03241eec93b19e3e65b0b691269e3/reflex/event.py#L573'>reflex/event.py:573:72:</a> RUF100 [*] Unused `noqa` directive (unused: `RUF009`)
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| RUF100 | 1 | 1 | 0 | 0 | 0 |</p>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @ntBre on 2025-06-23 14:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @ntBre on 2025-06-23 14:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[ruff] Frozen Dataclass default should be valid" to "[`ruff`] Frozen Dataclass default should be valid (`RUF009`)" by @ntBre on 2025-06-23 14:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/helpers.rs</code>:168 on 2025-06-23 16:36</div>
            <div class="timeline-body"><p>nit: It looks like we only use this function with <code>is_some_and</code>. Would it make more sense just to return a <code>bool</code> directly? I see that we wouldn't be able to use <code>?</code>, but that could just become:</p>
<pre><code class="language-rust">let Some(qualified_name) = ... else { return false };
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/helpers.rs</code>:192 on 2025-06-23 16:39</div>
            <div class="timeline-body"><p>I think we could just use <code>arguments.find_keyword(&quot;frozen&quot;)</code> here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/helpers.rs</code>:198 on 2025-06-23 16:41</div>
            <div class="timeline-body"><p>I think you could use <code>Truthiness::into_bool</code> here, with <code>unwrap_or_default()</code> if we decide to make the function as a whole return a <code>bool</code> instead of an <code>Option</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/function_call_in_dataclass_default.rs</code>:90 on 2025-06-23 17:12</div>
            <div class="timeline-body"><p>We should already have access to the <code>class_def</code> and there's an existing call to <code>dataclass_kind</code> in <code>function_call_in_dataclass_default</code>. Could we use those instead of adding this helper? I think that would allow us to remove this function and just inline</p>
<pre><code class="language-rust">is_frozen_dataclass(dataclass_decorator, semantic)
</code></pre>
<p>where this function is called on line 161.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/function_call_in_dataclass_default.rs</code>:131 on 2025-06-23 17:16</div>
            <div class="timeline-body"><p>nit: I'd prefer just leaving these blank lines here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-23 17:16</div>
            <div class="timeline-body"><p>Thanks, this looks great overall! I just have a few suggestions for simplifying things a bit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/lubaskinc0de">@lubaskinc0de</a> reviewed on 2025-06-23 18:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/lubaskinc0de">@lubaskinc0de</a> on <code>crates/ruff_linter/src/rules/ruff/rules/function_call_in_dataclass_default.rs</code>:90 on 2025-06-23 18:20</div>
            <div class="timeline-body"><p>Sorry, I didn't understand a bit.
So we have</p>
<pre><code class="language-rust">pub(super) fn is_frozen_dataclass_instantiation(func: &amp;Expr, semantic: &amp;SemanticModel) -&gt; bool {
    semantic.lookup_attribute(func).is_some_and(|id| {
        let binding = &amp;semantic.binding(id);
        let Some(Stmt::ClassDef(class_def)) = binding.statement(semantic) else {
            return false;
        };

        let Some((_, dataclass_decorator)) = dataclass_kind(class_def, semantic) else {
            return false;
        };
        is_frozen_dataclass(dataclass_decorator, semantic)
    })
}
</code></pre>
<p>This function takes as input a func, which is actually something like (as far as I remember)</p>
<pre><code class="language-py">@dataclasses.dataclass(frozen=True)
class D:
    d: C = C()  # C() is a func
</code></pre>
<p>The whole point of the problem is to make it clear to ruff that if func is a call to the frozen dataclass constructor, then it should not be considered an error</p>
<p>As I understand it, you are suggesting to use <code>class_def</code> and <code>dataclass_decorator</code> from the <code>function_call_in_dataclass_default</code> function</p>
<p>But in this context, in the python example above, it will all belong to class D rather than class C, but we need to check that class C objects are immutable. <code>is_frozen_dataclass_instantiation</code> function does a lookup of the <code>func</code> attribute and checks that <code>func</code> (in the example above <code>C</code>) is a definition of frozen dataclass</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @lubaskinc0de on 2025-06-23 18:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-23 18:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/function_call_in_dataclass_default.rs</code>:90 on 2025-06-23 18:50</div>
            <div class="timeline-body"><p>Ohhh, I see what you mean. I was just confused. Thanks for clarifying! This makes sense then.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/function_call_in_dataclass_default.rs</code>:81 on 2025-06-23 18:54</div>
            <div class="timeline-body"><p>One last tiny nit here: could you move this below <code>function_call_in_dataclass_default</code>? We like to keep the main function for the rule implementation near the top of the file. I think you could also drop <code>pub(super)</code> here since it's only used in this file, as far as I could tell.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-06-23 18:55</div>
            <div class="timeline-body"><p>Thank you, this is great! Just one more tiny nit, and it looks like clippy also has a minor complaint, but this is otherwise good to go.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @lubaskinc0de on 2025-06-23 19:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/lubaskinc0de">@lubaskinc0de</a> reviewed on 2025-06-23 19:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/lubaskinc0de">@lubaskinc0de</a> on <code>crates/ruff_linter/src/rules/ruff/rules/function_call_in_dataclass_default.rs</code>:81 on 2025-06-23 19:06</div>
            <div class="timeline-body"><p>done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-06-23 19:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-06-23 19:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-06-23 19:10</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:13:28 UTC
    </footer>
</body>
</html>
