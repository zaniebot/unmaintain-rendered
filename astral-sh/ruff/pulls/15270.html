<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Minor simplifications and improvements to constraint narrowing logic - astral-sh/ruff #15270</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Minor simplifications and improvements to constraint narrowing logic</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15270">#15270</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-01-05 15:21
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-01-05 15:21</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>On its own this is a pretty minor refactor, but it makes some other improvements I'm working on easier to implement. It nonetheless seems worth doing on its own, however, and reduces the size of the diff on the other branch I have locally, so I'm submitting it as its own PR.</p>
<h2>Test Plan</h2>
<p>No new tests added; this is a pure refactor, which shouldn't change any functionality.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-01-05 15:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-01-05 15:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2025-01-05 15:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-01-05 15:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-05 15:31</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>‚ÑπÔ∏è ecosystem check <strong>detected linter changes</strong>. (+0 -0 violations, +0 -4 fixes in 2 projects; 53 projects unchanged)</p>
<details><summary><a href="https://github.com/zulip/zulip">zulip/zulip</a> (+0 -0 violations, +0 -4 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/zulip/zulip/blob/669a341b022a1ee13490ad857b0ea2e61950bfd0/tools/lib/template_parser.py#L637'>tools/lib/template_parser.py:637:29:</a> FURB171 Membership test against single-item container
- <a href='https://github.com/zulip/zulip/blob/669a341b022a1ee13490ad857b0ea2e61950bfd0/tools/lib/template_parser.py#L637'>tools/lib/template_parser.py:637:29:</a> FURB171 [*] Membership test against single-item container
+ <a href='https://github.com/zulip/zulip/blob/669a341b022a1ee13490ad857b0ea2e61950bfd0/tools/lib/template_parser.py#L645'>tools/lib/template_parser.py:645:29:</a> FURB171 Membership test against single-item container
- <a href='https://github.com/zulip/zulip/blob/669a341b022a1ee13490ad857b0ea2e61950bfd0/tools/lib/template_parser.py#L645'>tools/lib/template_parser.py:645:29:</a> FURB171 [*] Membership test against single-item container
</pre>

</p>
</details>
<details><summary><a href="https://github.com/python-trio/trio">python-trio/trio</a> (+0 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| FURB171 | 4 | 0 | 0 | 0 | 4 |</p>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @MichaReiser removed by @MichaReiser on 2025-01-05 16:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:3087 on 2025-01-05 19:05</div>
            <div class="timeline-body"><p>Nit: this method doesn't actually &quot;apply&quot; a constraint, it just returns a type. Maybe <code>constraint_ty</code>?</p>
<p>I also wonder if this might be even clearer if it accepts an <code>argument: Type</code> instead of <code>class: Class</code> and encapsulates all of the logic that is currently in <code>generate_classinfo_constraint</code> (that is, match tuples and class literals, recursively build a union for tuples)? Don't feel strongly, though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/narrow.rs</code>:103 on 2025-01-05 19:07</div>
            <div class="timeline-body"><p>Orthogonal to this PR, but I think we should probably also match <code>Type::SubclassOf</code> here? I would expect code like this to narrow:</p>
<pre><code class="language-py">def f(instance: A | None, ty: type[A]):
    if isinstance(instance, ty):
        reveal_type(instance)  # revealed: A
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-01-05 19:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-05 19:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/narrow.rs</code>:103 on 2025-01-05 19:24</div>
            <div class="timeline-body"><p>Nice catch -- yes, I think you're right! We probably added this logic before we had the <code>Type::SubclassOf</code> variant. I won't fix it in this PR, though, as it <em>is</em> orthogonal to what this PR is doing, and it'll probably complicate rebasing #15272 onto this branch</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-05 19:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/narrow.rs</code>:103 on 2025-01-05 19:25</div>
            <div class="timeline-body"><p>Oh, actually, addressing your other review comment already throws away any chance I have of a clean rebase of that PR branch onto this one, so I may as well fix it here üòÜ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/narrow.rs</code>:93 on 2025-01-05 19:46</div>
            <div class="timeline-body"><p>I moved this enum here from <code>types.rs</code> so that all the narrowing logic remained encapsulated in <code>narrow.rs</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-05 19:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Minor simplification to constraint narrowing logic" to "[red-knot] Minor simplifications and improvements to constraint narrowing logic" by @AlexWaygood on 2025-01-05 21:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-01-05 21:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-01-05 21:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-05 21:51</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 20:34:29 UTC
    </footer>
</body>
</html>
