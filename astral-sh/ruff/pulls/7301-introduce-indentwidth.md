```yaml
number: 7301
title: "Introduce `IndentWidth`"
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: indent-width
created_at: 2023-09-12T11:27:48Z
updated_at: 2023-09-13T12:52:25Z
url: https://github.com/astral-sh/ruff/pull/7301
synced_at: 2026-01-12T15:55:23Z
```

# Introduce `IndentWidth`

---

_@MichaReiser_


## Summary

This PR introduces the new configuration `IndentWidth` that specifies the visual width of a `\t` character or the number of spaces of an indent when using `IndentStyle::Space`. 
`IndentWidth` replaces `TabWidth` and the count on the `IndentStyle::Space(count)` setting. 

The motivation for this change is to reduce the configuration options and align it with Prettier and editor config that both use a single width for the tab width and number of spaces in an indent. 

Unifying the two settings makes sense in my view because both `\t` and the number of spaces in an indentation are about the width of an indentation and they should use consistent values. 
The only downside of the change is that we no longer support the configuration used by black's `docstring` test where it uses 4-space indentation but a tab width of 8. 

## Test Plan

`cargo test`. 



---

_Comment by @MichaReiser on 2023-09-12 11:27_

Current dependencies on/for this PR:
* main
  * **PR #7301** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7301" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7301?utm_source=stack-comment).

---

_Label `formatter` added by @MichaReiser on 2023-09-12 11:28_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/tests/snapshots/black_compatibility@simple_cases__docstring.py.snap`:1 on 2023-09-12 11:30_

This test uses an indentation of 4 spaces and tab width of 8. We can't support this anymore but I think that's fine. 

---

_@MichaReiser reviewed on 2023-09-12 11:30_

---

_@MichaReiser reviewed on 2023-09-12 11:37_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/tests/snapshots/format@tab_width.py.snap`:1 on 2023-09-12 11:37_

These tests were off, probably because we now use best fitting for strings now. I verified manually that they don't exceed the line width for the configured indent width. 

---

_Review requested from @konstin by @MichaReiser on 2023-09-12 11:37_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/tests/snapshots/black_compatibility@simple_cases__docstring.py.snap`:1 on 2023-09-12 11:59_

It seems reasonable though hopefully we're not overlooking some valid usage. This is all inferred, right, so there's no way to GitHub Code Search to find users that might rely on this?

---

_@charliermarsh approved on 2023-09-12 12:00_

---

_@MichaReiser reviewed on 2023-09-12 12:04_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/tests/snapshots/black_compatibility@simple_cases__docstring.py.snap`:1 on 2023-09-12 12:04_

Editorconfig doesn't support different visual width for tabs and indent. And I think that makes sense. You don't need a tab-width setting if you don't use tabs. 

This particular test case applies only to unformatted code where black assumes a tab size of 8 for tabs in docstrings before normalizing the docstring indentation. This is only a heuristic and I think it probably works best anyway if the space indentation and tab indentation sizes match, because that's probably how you aligned your docstring before even if you happened to have mixed tabs and spaces.

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/string.rs`:738 on 2023-09-12 15:55_

Both black and [cpython itself](https://github.com/python/cpython/blob/b303d3ad3e80e1d9b3befe6650f61f38b72179a4/Lib/inspect.py#L884) have this hardcoded to 8, e.g.
```python
print(inspect.cleandoc('''
def a():
    """doc line 1
    doc line 2
\tdoc line 3
    """
'''))
```
expands to
```python
def a():
    """doc line 1
    doc line 2
        doc line 3
    """
```
Given that this is a cpython choice, i don't think we should have an option to overwrite it.

---

_@konstin requested changes on 2023-09-12 15:57_

---

_Comment by @konstin on 2023-09-12 15:58_

I like the general improvement, but unfortunately cpython gives us hardcoded precedence about tabs handling in docstrings

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/string.rs`:738 on 2023-09-12 16:09_

Thanks for bringing this up. I wasn't aware of this (although this PR doesn't change the configurable nature of tab width).

I think the reason why Black hardcoded this is simply because black doesn't support tab indentation and choosing the default tab size used by cpython seems a good choice. 

Picking the configured `indent-width` still seems reasonable to me, except we foresee issues when using `indent-style: tab` with any `tab-width` value other than 8. For example, does it mean that the output of `inspect.cleancode` has incorrect indentation or is it okay for as long as all code uses tabs?  



---

_@MichaReiser reviewed on 2023-09-12 16:09_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/string.rs`:738 on 2023-09-13 09:36_

I've tested the semantics:

```python
source = '''
class A:
\tdef a():
\t\t"""doc line 1
\t\tdoc line 2
\t\t  doc line 3
\t\t"""

def a():
\t"""doc line 1
\tdoc line 2
\t  doc line 3
\t"""

class A2:
\tdef a():
\t\t"""doc line 1
\t\t\tdoc line 2
\t\t  doc line 3
\t\t"""

def a2():
\t"""doc line 1
\t\tdoc line 2
\t  doc line 3
\t"""
'''
exec(source)
docs = [A.a.__doc__, a.__doc__, A2.a.__doc__, a2.__doc__]
for doc in docs:
    print(f"---\n{inspect.cleandoc(doc)}")
```
prints
```
---
doc line 1
doc line 2
  doc line 3
---
doc line 1
doc line 2
  doc line 3
---
doc line 1
      doc line 2
doc line 3
---
doc line 1
      doc line 2
doc line 3
```

I've also checked that 
```python
source2 = '''
def f():
 \tprint()
 \tprint()

def f():
              \t          \t     print()
              \t          \t     print()
'''
exec(source2)
```
passes. Python seems to not care about how you mix tabs and spaces as long as you're consistent.

Inside of docstrings, `cleandoc` doesn't mind inconsistent indentation and will just pad to multiples of 8:
```python
source2 = '''
class A:
\tdef a():
\t\t"""doc line 1
 \t    \t doc line 2
\t \t  doc line 3
\t\t"""
'''
exec(source2)
print(f"---\n{inspect.cleandoc(A.a.__doc__)}")
```

My suggestion would be to special case `count_indentation_like_black` by hard code padding to 8 and converting to spaces in docstrings.

---

_@konstin reviewed on 2023-09-13 09:36_

---

_@MichaReiser reviewed on 2023-09-13 11:57_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/string.rs`:738 on 2023-09-13 11:57_

Thanks for taking a closer look at this. I updated the PR to hardcode 8 for the normalization.

---

_Review requested from @konstin by @MichaReiser on 2023-09-13 11:57_

---

_@konstin approved on 2023-09-13 12:29_

---

_Merged by @MichaReiser on 2023-09-13 12:52_

---

_Closed by @MichaReiser on 2023-09-13 12:52_

---

_Branch deleted on 2023-09-13 12:52_

---
