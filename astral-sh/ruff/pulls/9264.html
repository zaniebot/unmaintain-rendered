<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remove lexing and parsing from the linter benchmark - astral-sh/ruff #9264</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Remove lexing and parsing from the linter benchmark</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/9264">#9264</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-12-23 21:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>This PR adds some helper structs to the linter paths to enable passing in the pre-computed tokens and parsed source code during benchmarking, to remove lexing and parsing from the overall linter benchmark measurement. We already remove parsing for the formatter, and we have separate benchmarks for the lexer and the parser, so this should make it much easier to measure linter performance changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-23 21:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2023-12-23 21:36</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/charlie/benchmark">CodSpeed Performance Report</a>
Merging #9264 will <strong>improve performances by ×4.9</strong>
<p>Comparing <code>charlie/benchmark</code> (30c83ae) with <code>main</code> (20def33)</p>
Summary
<p><code>⚡ 15</code> improvements
<code>✅ 15</code> untouched benchmarks</p>
Benchmarks breakdown
<p>|     | Benchmark | <code>main</code> | <code>charlie/benchmark</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ⚡ | <code>linter/default-rules[unicode/pypinyin.py]</code> | 6 ms | 1.5 ms | ×4.1 |
| ⚡ | <code>linter/default-rules[large/dataset.py]</code> | 92.1 ms | 19 ms | ×4.9 |
| ⚡ | <code>linter/default-rules[numpy/globals.py]</code> | 1,799.9 µs | 634.8 µs | ×2.8 |
| ⚡ | <code>linter/all-rules[large/dataset.py]</code> | 178 ms | 101.9 ms | +74.62% |
| ⚡ | <code>linter/default-rules[pydantic/types.py]</code> | 36.4 ms | 8.4 ms | ×4.3 |
| ⚡ | <code>linter/all-with-preview-rules[numpy/globals.py]</code> | 4.5 ms | 3.4 ms | +31.16% |
| ⚡ | <code>linter/all-rules[pydantic/types.py]</code> | 77.1 ms | 48.2 ms | +60.21% |
| ⚡ | <code>linter/all-with-preview-rules[pydantic/types.py]</code> | 85.9 ms | 56.2 ms | +52.92% |
| ⚡ | <code>linter/all-with-preview-rules[unicode/pypinyin.py]</code> | 17.8 ms | 13.3 ms | +33.86% |
| ⚡ | <code>linter/all-with-preview-rules[numpy/ctypeslib.py]</code> | 39.4 ms | 26.3 ms | +49.92% |
| ⚡ | <code>linter/all-rules[numpy/ctypeslib.py]</code> | 36.1 ms | 23.2 ms | +55.54% |
| ⚡ | <code>linter/all-rules[numpy/globals.py]</code> | 4.2 ms | 3 ms | +39.02% |
| ⚡ | <code>linter/all-with-preview-rules[large/dataset.py]</code> | 197 ms | 122 ms | +61.46% |
| ⚡ | <code>linter/all-rules[unicode/pypinyin.py]</code> | 16.7 ms | 12.2 ms | +37.28% |
| ⚡ | <code>linter/default-rules[numpy/ctypeslib.py]</code> | 17.1 ms | 4 ms | ×4.3 |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-23 21:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-23 21:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-12-23 21:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-23 21:43</div>
            <div class="timeline-body"><p>Just gonna merge since folks are out, I&#x27;ll handle any feedback in follow-up PRs if it comes in.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-12-23 21:45</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>ℹ️ ecosystem check <strong>encountered linter errors</strong>. (no lint changes; 1 project error)</p>
<a href="https://github.com/pypa/setuptools">pypa/setuptools</a> (error)
<p>

<pre><code>ruff failed
  Cause: &#x27;quote-style = preserve&#x27; is a preview only feature. Run with &#x27;--preview&#x27; to enable it.
</code></pre>
</p>


Linter (preview)
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+1 -1 violations, +0 -0 fixes in 1 projects; 40 projects unchanged)</p>
<a href="https://github.com/python/mypy">python/mypy</a> (+1 -1 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --preview</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/python/mypy/blob/7d842e865331b3b6f44a116a886ea3c24eb67461/mypy/stubtest.py#L1396">mypy/stubtest.py:1396:27:</a> E999 SyntaxError: unexpected EOF while parsing
- <a href="https://github.com/python/mypy/blob/7d842e865331b3b6f44a116a886ea3c24eb67461/mypy/stubtest.py#L680">mypy/stubtest.py:680:21:</a> E721 Use `is` and `is not` for type comparisons, or `isinstance()` for isinstance checks
</pre>

</p>

Changes by rule (2 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| E999 | 1 | 1 | 0 | 0 | 0 |
| E721 | 1 | 0 | 1 | 0 | 0 |</p>
</p>


Formatter (stable)
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<a href="https://github.com/pypa/setuptools">pypa/setuptools</a> (error)
<p>

<pre><code>ruff failed
  Cause: &#x27;quote-style = preserve&#x27; is a preview only feature. Run with &#x27;--preview&#x27; to enable it.
</code></pre>
</p>


Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-23 21:54</div>
            <div class="timeline-body"><p>Not sure I understand the Mypy ecosystem change, hmm... (The <code>setuptools</code> error is already occurring on <code>main</code> and is unrelated.)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:00:12 UTC
    </footer>
</body>
</html>
