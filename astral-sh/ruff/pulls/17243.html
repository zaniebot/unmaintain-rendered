<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Allow ellipsis default params in stub functions - astral-sh/ruff #17243</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Allow ellipsis default params in stub functions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17243">#17243</a>
        opened by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a>
        on 2025-04-06 21:19
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-06 21:19</div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>Fixes #17234</p>
<h2>Test Plan</h2>
<p>Add tests to functions/paremeters.md</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-06 21:21</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">typeshed-stats (https://github.com/AlexWaygood/typeshed-stats)
- error[lint:invalid-parameter-default] /tmp/mypy_primer/projects/typeshed-stats/scripts/runtests.py:17:5: Default value of type `EllipsisType` is not assignable to annotated parameter type `Literal[False]`
- error[lint:invalid-parameter-default] /tmp/mypy_primer/projects/typeshed-stats/scripts/runtests.py:26:5: Default value of type `EllipsisType` is not assignable to annotated parameter type `None`
- error[lint:invalid-parameter-default] /tmp/mypy_primer/projects/typeshed-stats/scripts/runtests.py:34:5: Default value of type `EllipsisType` is not assignable to annotated parameter type `Literal[False]`
- error[lint:invalid-parameter-default] /tmp/mypy_primer/projects/typeshed-stats/scripts/runtests.py:35:5: Default value of type `EllipsisType` is not assignable to annotated parameter type `None`
- error[lint:invalid-parameter-default] /tmp/mypy_primer/projects/typeshed-stats/scripts/runtests.py:42:5: Default value of type `EllipsisType` is not assignable to annotated parameter type `bool`
- error[lint:invalid-parameter-default] /tmp/mypy_primer/projects/typeshed-stats/scripts/runtests.py:43:5: Default value of type `EllipsisType` is not assignable to annotated parameter type `Path | None`
- error[lint:invalid-parameter-default] /tmp/mypy_primer/projects/typeshed-stats/scripts/runtests.py:44:5: Default value of type `EllipsisType` is not assignable to annotated parameter type `bool`
- Found 33 diagnostics
+ Found 26 diagnostics

werkzeug (https://github.com/pallets/werkzeug)
- error[lint:invalid-parameter-default] /tmp/mypy_primer/projects/werkzeug/src/werkzeug/wrappers/request.py:387:9: Default value of type `ellipsis` is not assignable to annotated parameter type `Literal[True]`
- error[lint:invalid-parameter-default] /tmp/mypy_primer/projects/werkzeug/src/werkzeug/wrappers/request.py:568:15: Default value of type `ellipsis` is not assignable to annotated parameter type `bool`
- error[lint:invalid-parameter-default] /tmp/mypy_primer/projects/werkzeug/src/werkzeug/wrappers/request.py:568:34: Default value of type `ellipsis` is not assignable to annotated parameter type `Literal[False]`
- error[lint:invalid-parameter-default] /tmp/mypy_primer/projects/werkzeug/src/werkzeug/wrappers/request.py:568:66: Default value of type `ellipsis` is not assignable to annotated parameter type `bool`
- error[lint:invalid-parameter-default] /tmp/mypy_primer/projects/werkzeug/src/werkzeug/wrappers/request.py:573:15: Default value of type `ellipsis` is not assignable to annotated parameter type `bool`
- error[lint:invalid-parameter-default] /tmp/mypy_primer/projects/werkzeug/src/werkzeug/wrappers/request.py:573:34: Default value of type `ellipsis` is not assignable to annotated parameter type `bool`
- error[lint:invalid-parameter-default] /tmp/mypy_primer/projects/werkzeug/src/werkzeug/wrappers/request.py:573:54: Default value of type `ellipsis` is not assignable to annotated parameter type `bool`
- error[lint:invalid-parameter-default] /tmp/mypy_primer/projects/werkzeug/src/werkzeug/datastructures/accept.py:163:55: Default value of type `ellipsis` is not assignable to annotated parameter type `str`
- error[lint:invalid-parameter-default] /tmp/mypy_primer/projects/werkzeug/src/werkzeug/datastructures/accept.py:289:55: Default value of type `ellipsis` is not assignable to annotated parameter type `str`
- error[lint:invalid-parameter-default] /tmp/mypy_primer/projects/werkzeug/src/werkzeug/wrappers/response.py:596:24: Default value of type `ellipsis` is not assignable to annotated parameter type `bool`
- error[lint:invalid-parameter-default] /tmp/mypy_primer/projects/werkzeug/src/werkzeug/wrappers/response.py:596:43: Default value of type `ellipsis` is not assignable to annotated parameter type `Literal[False]`
- error[lint:invalid-parameter-default] /tmp/mypy_primer/projects/werkzeug/src/werkzeug/wrappers/response.py:599:24: Default value of type `ellipsis` is not assignable to annotated parameter type `bool`
- error[lint:invalid-parameter-default] /tmp/mypy_primer/projects/werkzeug/src/werkzeug/wrappers/response.py:599:43: Default value of type `ellipsis` is not assignable to annotated parameter type `bool`
- error[lint:invalid-parameter-default] /tmp/mypy_primer/projects/werkzeug/src/werkzeug/datastructures/headers.py:286:19: Default value of type `ellipsis` is not assignable to annotated parameter type `int | None`
- Found 697 diagnostics
+ Found 683 diagnostics

scrapy (https://github.com/scrapy/scrapy)
- error[lint:invalid-parameter-default] /tmp/mypy_primer/projects/scrapy/scrapy/utils/spider.py:70:5: Default value of type `ellipsis` is not assignable to annotated parameter type `bool`
- error[lint:invalid-parameter-default] /tmp/mypy_primer/projects/scrapy/scrapy/utils/spider.py:71:5: Default value of type `ellipsis` is not assignable to annotated parameter type `bool`
- error[lint:invalid-parameter-default] /tmp/mypy_primer/projects/scrapy/scrapy/utils/spider.py:80:5: Default value of type `ellipsis` is not assignable to annotated parameter type `bool`
- error[lint:invalid-parameter-default] /tmp/mypy_primer/projects/scrapy/scrapy/utils/spider.py:81:5: Default value of type `ellipsis` is not assignable to annotated parameter type `bool`
- error[lint:invalid-parameter-default] /tmp/mypy_primer/projects/scrapy/scrapy/utils/spider.py:90:5: Default value of type `ellipsis` is not assignable to annotated parameter type `bool`
- error[lint:invalid-parameter-default] /tmp/mypy_primer/projects/scrapy/scrapy/utils/spider.py:91:5: Default value of type `ellipsis` is not assignable to annotated parameter type `bool`
- Found 1502 diagnostics
+ Found 1496 diagnostics

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-04-06 21:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2025-04-06 21:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MatthewMckee4 on 2025-04-06 21:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MatthewMckee4 on 2025-04-06 21:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MatthewMckee4 on 2025-04-06 21:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @MatthewMckee4 on 2025-04-06 21:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @MatthewMckee4 on 2025-04-06 21:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Allow ellipsis default params in stub functions" to "[red-knot] Allow ellipsis default params in stub functions" by @MatthewMckee4 on 2025-04-06 21:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1220 on 2025-04-06 21:31</div>
            <div class="timeline-body"><p>nit: maybe call this <code>in_overloaded_or_abstract_function</code>?</p>
<pre><code class="language-suggestion">    fn in_overloaded_or_abstract_function(&amp;self) -&gt; bool {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-06 21:41</div>
            <div class="timeline-body"><p>Nice, that primer diff looks fantastic! And I confirmed that this gets rid of all <code>invalid-parameter-default</code> diagnostics when running red-knot on typeshed-stats</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-06 21:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/function/parameters.md</code>:1 on 2025-04-06 21:44</div>
            <div class="timeline-body"><p>could you also add a test (and check that it passes) for a <code>Protocol</code> class with PEP-695 type parameters. These can be tricky, because they introduce an extra scope:</p>
<pre><code class="language-py">class GenericFoo[T](Protocol):
    def x(self, y: bool = ...) -&gt; T: ...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1220 on 2025-04-06 21:54</div>
            <div class="timeline-body"><p>I'm not sure about this naming change, but I'm also not sure about the semantics of the function in the first place. I think being &quot;in an overloaded function&quot; suggests that it would include the main implementation (which is not decorated with @overload), but that <em>shouldn't</em> be included here. Have to go at the moment but would like to look at this a bit more.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-04-06 21:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-04-06 21:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1220 on 2025-04-06 21:58</div>
            <div class="timeline-body"><p>I'll test to see if this surprises an error of an ellipsis in the main overload</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-04-06 22:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1220 on 2025-04-06 22:07</div>
            <div class="timeline-body"><p>it doesn't, but i also see thats not really what you were referring to</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1220 on 2025-04-07 17:12</div>
            <div class="timeline-body"><p>Ok sorry for the cryptic note here, I was on a plane yesterday and the flight attendant was literally asking me to put away my computer as I was submitting that comment ðŸ˜†</p>
<p>There were three things I wanted to look at here:</p>
<ol>
<li><p>Do we handle generic <em>methods</em> correctly (not just methods of generic classes, which you already added a test for)? The answer is yes, we do, but I'll push a couple tests for that as well.</p>
</li>
<li><p>I wanted to clarify my understanding of how this same code works for both default values and for return statements inside the function, since default values are inferred in the outer scope, not the function body scope. But what I realized looking at it more closely is that function parameter <em>definitions</em> are handled when inferring the function body scope, so we are actually in the function body scope for all call sites of these functions. I think I might add doc comments to these methods clarifying their usage, but otherwise I think this looks good.</p>
</li>
<li><p>The question of how to name this function. I think the name (and doc comment) should be clear that it returns true for <em>overloads</em>, not for <em>overloaded functions</em>, since the latter could be read to mean the main implementation function. Thus I wouldn't favor the name change suggested above, and I'm not coming up with anything I like significantly better than the current name.</p>
</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-04-07 17:12</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-07 17:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1220 on 2025-04-07 17:18</div>
            <div class="timeline-body"><blockquote>
<p>3. The question of how to name this function. I think the name (and doc comment) should be clear that it returns true for <em>overloads</em>, not for <em>overloaded functions</em>, since the latter could be read to mean the main implementation function. Thus I wouldn't favor the name change suggested above, and I'm not coming up with anything I like significantly better than the current name.</p>
</blockquote>
<p>I do understand what you're saying here... <code>in_function_decorated_with_abstractmethod_or_overload</code>? But it's obviously awfully verbose.</p>
<p><code>in_stublike_function</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1220 on 2025-04-07 17:28</div>
            <div class="timeline-body"><p>I'm ok with the very verbose name if you like it better, we won't have tons of call sites. I think we could also go with just <code>in_function_overload_or_abstractmethod</code> if you like that better? Tbh I don't know what alternatives to suggest since I'm not clear on precisely what it is you dislike about the current name :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-04-07 17:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-07 17:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1220 on 2025-04-07 17:33</div>
            <div class="timeline-body"><p>I don't like the current name because it doesn't make grammatical sense -- you can have a &quot;function overload&quot;, sure, but you can't have a &quot;function abstract&quot; (it would be &quot;abstract function&quot;)</p>
<p><code>in_overload_or_abstractmethod</code> or similar would work fine for me!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @carljm on 2025-04-07 17:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-04-07 17:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-04-07 17:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1220 on 2025-04-07 17:42</div>
            <div class="timeline-body"><p>But I think the current name is perfectly grammatical, it just needs to be read with different grouping :) It's &quot;in (function overload) or (abstractmethod)&quot;, not &quot;in function (overload or abstractmethod)&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-07 17:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1220 on 2025-04-07 17:47</div>
            <div class="timeline-body"><p>Ah sorry, I think we were talking at cross purposes here? I didn't realise the name had already changed. The original name of this function in the first version of this PR was <code>in_function_overload_or_abstract()</code>, and that's the version of this PR that my original comment here was attached to. The name of the function in the merged version of the PR is <code>in_function_overload_or_abstractmethod()</code>, which, yes, I agree is perfectly grammatical and much better!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-07 18:04</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:41:06 UTC
    </footer>
</body>
</html>
