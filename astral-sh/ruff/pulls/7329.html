<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update `W605` to check in f-strings - astral-sh/ruff #7329</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Update <code>W605</code> to check in f-strings</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7329">#7329</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2023-09-13 05:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body">Summary
<p>This PR updates the <code>W605</code> (invalid-escape-sequence) to check inside f-strings. It also adds support to report violation on invalid escape sequence within f-strings w.r.t. the curly braces. So, the following cases will be identified:</p>
<pre><code>f&quot;\{1}&quot;
f&quot;\{{1}}&quot;
f&quot;{1:\}&quot;
</code></pre>
<p>The new CPython parser also gives out a syntax warning for such cases:</p>
<pre><code>fstring.py:1: SyntaxWarning: invalid escape sequence &#x27;\{&#x27;
  f&quot;\{1}&quot;
fstring.py:2: SyntaxWarning: invalid escape sequence &#x27;\{&#x27;
  f&quot;\{{1}}&quot;
fstring.py:3: SyntaxWarning: invalid escape sequence &#x27;\}&#x27;
  f&quot;{1:\}&quot;
</code></pre>
<p>Nested f-strings are supported here, so the generated fix is aware of that and will create an edit for the proper f-string.</p>
Test Plan
<p>Add new test cases for f-strings.</p>
<p>fixes: #7295</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-13 05:37</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #7376</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7376"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a><ul>
<li><strong>PR #7690</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7690"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a></li>
<li><strong>PR #7667</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7667"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a></li>
<li><strong>PR #7597</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7597"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a></li>
<li><strong>PR #7588</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7588"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a><ul>
<li><strong>PR #7589</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7589"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a></li>
</ul>
</li>
<li><strong>PR #7586</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7586"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a></li>
<li><strong>PR #7515</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7515"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a></li>
<li><strong>PR #7477</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7477"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a></li>
<li><strong>PR #7387</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7387"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a></li>
<li><strong>PR #7378</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7378"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a></li>
<li><strong>PR #7329</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7329"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a>  ðŸ‘ˆ</li>
<li><strong>PR #7328</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7328"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a></li>
<li><strong>PR #7327</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7327"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a></li>
<li><strong>PR #7326</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7326"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a></li>
<li><strong>PR #7325</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7325"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7329?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-13 05:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">python312</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-13 05:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-14 06:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-14 06:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-14 06:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/pycodestyle/rules/invalid_escape_sequence.rs</code>:123 on 2023-09-14 07:15</div>
            <div class="timeline-body"><p>Nit: The <code>let</code> else is a bit more complicated to read because I first read the exceptional case before the &quot;normal&quot; flow</p>
<p>What we want to express here is, take the <code>next_char</code> if any and otherwise return</p>
<pre><code>if let Some(next_char) locator.after(tok_range.end()).chars().next() {
    next_char
} else {
    continue;
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/pycodestyle/rules/invalid_escape_sequence.rs</code>:119 on 2023-09-14 07:19</div>
            <div class="timeline-body"><p>I&#x27;m a bit confused by this comment. It says that there won&#x27;t be any <code>FStringMiddle</code> token but this branch handles f-string middle tokens. How is this related?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/resources/test/fixtures/pycodestyle/W605_2.py</code>:53 on 2023-09-14 07:20</div>
            <div class="timeline-body"><p>Can we add some tests for nested fstrings?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-14 07:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-09-14 08:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/rules/pycodestyle/rules/invalid_escape_sequence.rs</code>:119 on 2023-09-14 08:32</div>
            <div class="timeline-body"><p>That is for the code snippet mentioned above. I&#x27;m making a case to prove that the next character is always going to be inside the f-string as a whole. The code snippet is:</p>
<pre><code>f&quot;foo\&quot;
</code></pre>
<p>Here, the <code>FStringMiddle</code> token won&#x27;t be emitted because it&#x27;s an unterminated string literal as the end quote is being escaped. So, the character coming after a <code>\</code> is always going to be part of the f-string.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2023-09-18 16:48</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/dhruv/issue-7295">CodSpeed Performance Report</a>
Merging #7329 will <strong>improve performances by 2.38%</strong>
<p>:warning: No base runs were found</p>
<p>Falling back to comparing <code>dhruv/issue-7295</code> (b88d5a0) with <code>dhruv/pep-701</code> (c496d9c)</p>
Summary
<p><code>âš¡ 1</code> improvements
<code>âœ… 24</code> untouched benchmarks</p>
Benchmarks breakdown
<p>|     | Benchmark | <code>dhruv/pep-701</code> | <code>dhruv/issue-7295</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| âš¡ | <code>linter/all-rules[unicode/pypinyin.py]</code> | 16.1 ms | 15.7 ms | +2.38% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-09-18 19:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-19 06:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-19 06:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-09-19 06:38</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:57:09 UTC
    </footer>
</body>
</html>
