<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ignore the open parentheses when measuring `BestFitsParenthesize` - astral-sh/ruff #8940</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Ignore the open parentheses when measuring <code>BestFitsParenthesize</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/8940">#8940</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-12-01 04:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-12-01 04:00</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR changes the definition of <code>BestFitParenthesize</code> to only consider whether its content fits when parenthesizing and not whether the whole parenthesized expression fits.</p>
<p>The difference is subtle but relevant when what comes before <code>BestFitParenthesize</code> already exceeds the configured line width:</p>
<pre><code class="language-python">this_is_a_ridiculously_long_name_and_nobody_in_their_right_mind_would_use_one_like_it = aaaaaa
</code></pre>
<p>The <code>this_is_a...</code> exceeds the configured line width. The existing implementation doesn't parenthesize <code>aaaaa</code> because the opening <code>(</code> doesn't fit on the line. This is unfortunate, because parenthesizing would make <code>aaaaa</code> fit in the configured line width and is what Black does:</p>
<pre><code class="language-python">this_is_a_ridiculously_long_name_and_nobody_in_their_right_mind_would_use_one_like_it = (
    aaaaaa
)
</code></pre>
<p>This PR implements Black's behavior by ignoring whether there's sufficient space to place the <code>(</code> and instead only measures whether its content (<code>aaaaaa</code>) fits when indenting.</p>
<!-- What's the purpose of the change? What does it do, and why? -->

<h2>Test Plan</h2>
<p>The similarity index remains unchanged.</p>
<p>| project        | similarity index  | total files       | changed files     |
|----------------|------------------:|------------------:|------------------:|
| cpython        |           0.75804 |              1799 |              1648 |
| django         |           0.99984 |              2772 |                34 |
| home-assistant |           0.99955 |             10596 |               213 |
| poetry         |           0.96208 |               317 |                35 |
| transformers   |           0.99967 |              2657 |               324 |
| twine          |           1.00000 |                33 |                 0 |
| typeshed       |           0.99980 |              3669 |                18 |
| warehouse      |           0.99976 |               654 |                14 |
| zulip          |           0.99957 |              1459 |                36 |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-12-01 04:00</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #8920</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8920?utm_source=stack-comment-icon" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #8943</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8943?utm_source=stack-comment-icon" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #9102</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/9102?utm_source=stack-comment-icon" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
</ul>
</li>
<li><strong>PR #8941</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8941?utm_source=stack-comment-icon" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #8940</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8940?utm_source=stack-comment-icon" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  üëà</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This <a href="https://stacking.dev/?utm_source=stack-comment">stack of pull requests</a> is managed by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8940?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2023-12-01 04:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/snapshots/black_compatibility@cases__comments6.py.snap</code>:139 on 2023-12-01 04:05</div>
            <div class="timeline-body"><p>The style here is different because black doesn't inline the <code>type: </code> comment. Changing the comment to e.g. <code>ctype</code> matches Ruff's formatting</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/snapshots/black_compatibility@cases__pep604_union_types_line_breaks.py.snap</code>:126 on 2023-12-01 04:05</div>
            <div class="timeline-body"><p>Requires other preview styles to match black</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/snapshots/black_compatibility@cases__preview_cantfit.py.snap</code>:58 on 2023-12-01 04:06</div>
            <div class="timeline-body"><p>Requires other preview styles to match Black</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/snapshots/format@expression__yield.py.snap</code>:168 on 2023-12-01 04:08</div>
            <div class="timeline-body"><p>This doesn't match black although black's formatting here is very peculiar</p>
<pre><code class="language-python">for ridiculouslylongelementnameeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee in (l):
    pass

</code></pre>
<p>It ends parenthesizing <code>l</code> but without splitting the line. IMO, both styles are not ideal but I prefer ours for consistency.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/snapshots/format@statement__type_alias.py.snap</code>:122 on 2023-12-01 04:09</div>
            <div class="timeline-body"><p>This is a divergence from Black. Black doesn't parenthesize the right side. I don't see why and recommend keeping it because I don't see why type aliases should be different from other assignments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-12-01 04:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-12-01 04:11</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Formatter (stable)</h3>
<p>‚ÑπÔ∏è ecosystem check <strong>detected format changes</strong>. (+4 -2 lines in 1 file in 41 projects)</p>
<details><summary><a href="https://github.com/latchbio/latch">latchbio/latch</a> (+4 -2 lines across 1 file)</summary>
<p>

<p><a href='https://github.com/latchbio/latch/blob/965a74f9c4aaefc1f8cb33b7113e429535f5fb8a/latch/idl/core/interface.py#L58'>latch/idl/core/interface.py~L58</a></p>
<pre><code class="language-diff">     var: Variable
     &quot;&quot;&quot;+required Variable. Defines the type of the variable backing this parameter.&quot;&quot;&quot;
 
-    behavior: &quot;Optional[typing.Union[ParameterBehaviorDefault, ParameterBehaviorRequired]]&quot; = None
+    behavior: &quot;Optional[typing.Union[ParameterBehaviorDefault, ParameterBehaviorRequired]]&quot; = (
+        None
+    )
 
     def to_idl(self) -&gt; pb.Parameter:
         return merged_pb(pb.Parameter(var=self.var.to_idl()), self.behavior)
</code></pre>
</p>
</details>

<h3>Formatter (preview)</h3>
<p>‚ÑπÔ∏è ecosystem check <strong>detected format changes</strong>. (+4 -2 lines in 1 file in 41 projects)</p>
<details><summary><a href="https://github.com/latchbio/latch">latchbio/latch</a> (+4 -2 lines across 1 file)</summary>
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<p><a href='https://github.com/latchbio/latch/blob/965a74f9c4aaefc1f8cb33b7113e429535f5fb8a/latch/idl/core/interface.py#L58'>latch/idl/core/interface.py~L58</a></p>
<pre><code class="language-diff">     var: Variable
     &quot;&quot;&quot;+required Variable. Defines the type of the variable backing this parameter.&quot;&quot;&quot;
 
-    behavior: &quot;Optional[typing.Union[ParameterBehaviorDefault, ParameterBehaviorRequired]]&quot; = None
+    behavior: &quot;Optional[typing.Union[ParameterBehaviorDefault, ParameterBehaviorRequired]]&quot; = (
+        None
+    )
 
     def to_idl(self) -&gt; pb.Parameter:
         return merged_pb(pb.Parameter(var=self.var.to_idl()), self.behavior)
</code></pre>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @MichaReiser on 2023-12-01 04:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2023-12-01 04:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-12-01 04:56</div>
            <div class="timeline-body"><p>Hmm, obviously, it is more complicated than this ü§Ø</p>
<p>Black does not parenthesize the right side here (for reasons?)</p>
<pre><code class="language-python">this_is_a_ridiculously_long_name_and_nobody_in_their_right_mind_would_use_one_like_it = (
    function(arg1, arg2, arg3)
)
</code></pre>
<p>Although <code>function</code> is clearly over the configured width and parenthesizing helps make it fit. Instead, black picks</p>
<pre><code class="language-python">this_is_a_ridiculously_long_name_and_nobody_in_their_right_mind_would_use_one_like_it = function(
    arg1, arg2, arg3
)
</code></pre>
<p>Ultimately, the vertical spacing is about the same, although Black's layout requires considerably more vertical spacing. However, it avoids one pair of parentheses, which is something Black generally optimizes for.</p>
<p>Which makes me wonder what their rule is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-12-01 06:54</div>
            <div class="timeline-body"><p>Okay this is interesting. Black does the exact opposite if the right hand side is a function</p>
<pre><code class="language-python">this_is_a_ridiculously_long_name_and_nobody_in_their_right_mind_would_use_one_like_i = (
    function([1, 2, 3], arg1, [1, 2, 3], arg2, [1, 2, 3], arg3)
)

this_is_a_ridiculously_long_name_and_nobody_in_their_right_mind_would_use_one_like_it = function(
    [1, 2, 3], arg1, [1, 2, 3], arg2, [1, 2, 3], arg3
)
</code></pre>
<p>The <code>(</code> fits for the first example, which is why Black parenthesizes the entire function (at least it seems). The <code>(</code> doesn't fit for the second example, which is why Black avoids parenthesizing the function.</p>
<p>I compared the similarity index for Poetry using either layout, and it remained unchanged. This feels edge-casey enough that I feel it isn't worth spending too much time on. However, I'm undecided which version I prefer:</p>
<ul>
<li><p>Always parenthesizing if it makes the content fit gets the result closer to the ultimate goal of fitting code into the configured line width. It's also closer to how our formatter works overall, which generally eagerly parenthesizes expressions. For example, this gets always parenthesized <code>this_is_a_ridiculously_long_name_and_nobody_in_their_right_mind_would_use_one_like_it = a + b</code></p>
</li>
<li><p>Avoiding the parentheses if even the <code>(</code> doesn't fit results in fewer parentheses overall, which is a secondary goal. It can be slightly more readable if you e.g. have</p>
<pre><code class="language-python">this_is_a_ridiculously_long_name_and_nobody_in_their_right_mind_would_use_one_like_it = function(
    [1, 2, 3],
    arg1,
    [1, 2, 3],
    arg2,
    [1, 2, 3],
    arg3,
    dddddddddddddddddddd,
    eeeeeeeeeeeeee,
)
# instead of
this_is_a_ridiculously_long_name_and_nobody_in_their_right_mind_would_use_one_like_it = (
    function(
        [1, 2, 3],
        arg1,
        [1, 2, 3],
        arg2,
        [1, 2, 3],
        arg3,
        dddddddddddddddddddd,
        eeeeeeeeeeeeee,
    )
)
</code></pre>
</li>
</ul>
<p>Would love to hear some more opinions on this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-12-01 18:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-12-14 03:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-01-16 10:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch restored on 2024-06-10 08:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-20 09:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch restored on 2025-02-20 09:00</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:49:30 UTC
    </footer>
</body>
</html>
