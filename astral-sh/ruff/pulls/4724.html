<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate FormatRule definitions - astral-sh/ruff #4724</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Generate FormatRule definitions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4724">#4724</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2023-05-30 12:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><p>This is a first stab at generating a newtype for each AST node with implementations of <code>FormatNodeRule</code>, <code>FormatRule</code>, <code>AsFormat</code> and <code>IntoFormat</code> on it to circumvent the orphan rules, copying the strategy from rome. See Docs.md for more details.</p>
<p>This replaces the associated type <code>Context</code> from <code>FormatRule</code> with a type parameter because our context is <code>ASTFormatContext</code> which has a lifetime. Handling lifetimes is a lot easier with type parameter than with associated types.</p>
<p>This is ready in the sense that the definitions are generated and compile without warnings, but we don't yet have any downstream code (and its tests) building on it to validate the approach.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-05-30 12:53</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #4724</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4724" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ<ul>
<li><strong>PR #4755</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4755" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #4767</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4767" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4724?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @MichaReiser on 2023-05-30 12:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_formatter/src/lib.rs</code>:522 on 2023-05-30 12:55</div>
            <div class="timeline-body"><p>Nit: I think it is worth adding a note to the PR summary why we change from an associated type to a type argument.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/generate.py</code>:3 on 2023-05-30 12:56</div>
            <div class="timeline-body"><p>Are the <code>%%</code> some python convention?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/auxiliary/excepthandlerexcepthandler.rs</code>:8 on 2023-05-30 12:57</div>
            <div class="timeline-body"><p>Nit: I think it would be nice if the format rules would be grouped by their kind. E.g. <code>StmtIf</code> is in the <code>statement</code> directory.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/auxiliary/exprconstant.rs</code>:9 on 2023-05-30 12:58</div>
            <div class="timeline-body"><p>Using the fields (by e.g. using <code>format_verbatim</code>) will generate a large diff. I do think that's fine, but thought it worth pointing it out.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/auxiliary/stmtif.rs</code>:8 on 2023-05-30 12:59</div>
            <div class="timeline-body"><p>For another PR: We need <code>FormatRule</code> implementations for all union types (<code>Stmt</code>, <code>Expr</code>, ...).</p>
<p>They don't need to implement <code>FormatNodeRule</code> because they are not a node on their own.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/lib.rs</code>:72 on 2023-05-30 13:00</div>
            <div class="timeline-body"><p>I don't think we need parentheses handling</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/lib.rs</code>:77 on 2023-05-30 13:00</div>
            <div class="timeline-body"><p>Let's add this when adding support for suppression comments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-05-30 13:00</div>
            <div class="timeline-body"><p>This looks good overall. I think it would be great if we could split the nodes by their kind.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/generate.py</code>:3 on 2023-05-30 13:22</div>
            <div class="timeline-body"><p>they are from ipython, pycharm recognizes them if you turn on scientific mode. I normally remove them when polishing but for that script i don't think it's ready</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-05-30 13:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-05-30 13:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_formatter/src/lib.rs</code>:522 on 2023-05-30 13:25</div>
            <div class="timeline-body"><p>good point, done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-30 14:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/lib.rs</code>:74 on 2023-05-30 14:04</div>
            <div class="timeline-body"><p>Nit: Maybe return <code>Ok(())</code> for now so that it simply drops all comments for now (instead of throwing).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-05-30 14:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/auxiliary/excepthandlerexcepthandler.rs</code>:8 on 2023-05-30 14:39</div>
            <div class="timeline-body"><p>good idea</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-05-30 15:19</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     15.1Â±0.07ms     2.7 MB/sec    1.05     15.8Â±0.10ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.7Â±0.00ms     4.5 MB/sec    1.03      3.8Â±0.01ms     4.4 MB/sec
linter/all-rules/numpy/globals.py          1.00    379.4Â±0.94Âµs     7.8 MB/sec    1.01    382.9Â±1.35Âµs     7.7 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.3Â±0.01ms     4.1 MB/sec    1.04      6.5Â±0.02ms     3.9 MB/sec
linter/default-rules/large/dataset.py      1.00      7.5Â±0.02ms     5.4 MB/sec    1.08      8.1Â±0.02ms     5.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1622.1Â±2.85Âµs    10.3 MB/sec    1.04   1687.3Â±5.62Âµs     9.9 MB/sec
linter/default-rules/numpy/globals.py      1.00    179.1Â±0.60Âµs    16.5 MB/sec    1.02    182.0Â±0.41Âµs    16.2 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.4Â±0.01ms     7.4 MB/sec    1.04      3.6Â±0.01ms     7.1 MB/sec
parser/large/dataset.py                    1.00      5.7Â±0.01ms     7.1 MB/sec    1.01      5.8Â±0.00ms     7.1 MB/sec
parser/numpy/ctypeslib.py                  1.00   1121.9Â±0.96Âµs    14.8 MB/sec    1.01   1129.8Â±0.63Âµs    14.7 MB/sec
parser/numpy/globals.py                    1.00    115.2Â±0.95Âµs    25.6 MB/sec    1.02    117.2Â±0.44Âµs    25.2 MB/sec
parser/pydantic/types.py                   1.00      2.4Â±0.00ms    10.4 MB/sec    1.01      2.5Â±0.00ms    10.3 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     22.1Â±0.75ms  1887.9 KB/sec    1.01     22.4Â±0.73ms  1862.4 KB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      5.5Â±0.41ms     3.0 MB/sec    1.02      5.6Â±0.48ms     3.0 MB/sec
linter/all-rules/numpy/globals.py          1.00   650.6Â±34.85Âµs     4.5 MB/sec    1.00   651.0Â±34.71Âµs     4.5 MB/sec
linter/all-rules/pydantic/types.py         1.00      9.2Â±0.37ms     2.8 MB/sec    1.01      9.3Â±0.37ms     2.7 MB/sec
linter/default-rules/large/dataset.py      1.00     10.8Â±0.42ms     3.8 MB/sec    1.02     11.0Â±0.33ms     3.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00      2.3Â±0.11ms     7.2 MB/sec    1.01      2.3Â±0.11ms     7.1 MB/sec
linter/default-rules/numpy/globals.py      1.00   262.5Â±15.42Âµs    11.2 MB/sec    1.05   276.5Â±14.70Âµs    10.7 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.8Â±0.20ms     5.3 MB/sec    1.03      5.0Â±0.24ms     5.1 MB/sec
parser/large/dataset.py                    1.00      8.4Â±0.27ms     4.8 MB/sec    1.00      8.4Â±0.25ms     4.8 MB/sec
parser/numpy/ctypeslib.py                  1.00  1560.0Â±67.10Âµs    10.7 MB/sec    1.01  1576.8Â±68.34Âµs    10.6 MB/sec
parser/numpy/globals.py                    1.01   163.6Â±10.41Âµs    18.0 MB/sec    1.00   161.8Â±10.58Âµs    18.2 MB/sec
parser/pydantic/types.py                   1.00      3.6Â±0.13ms     7.2 MB/sec    1.02      3.6Â±0.13ms     7.0 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-30 16:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/auxiliary/mod.rs</code>:1 on 2023-05-30 16:13</div>
            <div class="timeline-body"><p>What's your motivation for putting all formatting logic into the <code>auxiliary</code> module?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-05-30 16:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/auxiliary/mod.rs</code>:1 on 2023-05-30 16:38</div>
            <div class="timeline-body"><p>no specific one, should i unpack the auxiliary module at the top level instead?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-30 16:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/auxiliary/mod.rs</code>:1 on 2023-05-30 16:54</div>
            <div class="timeline-body"><p>I would be in favour of removing, or renaming the folder to format if you prefer to have all of them in a single folder (I'm okay with manually adding the group modules to lib)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-30 19:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/auxiliary/statement/stmtimport.rs</code>:1 on 2023-05-30 19:25</div>
            <div class="timeline-body"><p>Nit: Can we name the module <code>stmt_if</code> to match the node name? It can otherwise be hard to read some of the names (<code>typeignoretypeignore</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2023-05-31 11:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">autoformatter</span> added by @MichaReiser on 2023-05-31 11:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-05-31 12:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/auxiliary/mod.rs</code>:1 on 2023-05-31 12:19</div>
            <div class="timeline-body"><p>done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/auxiliary/statement/stmtimport.rs</code>:1 on 2023-05-31 12:19</div>
            <div class="timeline-body"><p>done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-05-31 12:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/context.rs</code>:32 on 2023-05-31 13:06</div>
            <div class="timeline-body"><p>Revert?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_attribute.rs</code>:22 on 2023-05-31 13:09</div>
            <div class="timeline-body"><p>I would prefer to generate a <code>todo!</code> for now and then follow up in two separate PRs (or change the order in which you land the PRs).</p>
<ul>
<li>Create a new <code>verbatim_text</code> builder that formats some text in verbatim: <code>fn verbatim_node(range: TextRange) -&gt; VerbatimText</code> and <code>VerbatimText</code> implements <code>Format</code></li>
<li>Use the <code>verbatim_node</code> helper in the <code>FormatNodeRule</code> implementations</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_attribute.rs</code>:12 on 2023-05-31 13:09</div>
            <div class="timeline-body"><p>We should write the <code>source_position</code>s inside of <code>FormatNodeRule</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/lib.rs</code>:57 on 2023-05-31 13:10</div>
            <div class="timeline-body"><p>Let's delete the unused code</p>
<pre><code class="language-suggestion">        self.fmt_fields(node, f)?;
</code></pre>
<p>We can probably even inline the method into <code>fmt</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/lib.rs</code>:42 on 2023-05-31 13:11</div>
            <div class="timeline-body"><p>Let's write the start and end position here</p>
<pre><code class="language-suggestion">		write!(f, [source_position(node.start())])?;
        self.fmt_leading_comments(node, f)?;
        self.fmt_node(node, f)?;
        self.fmt_dangling_comments(node, f)?;
        self.fmt_trailing_comments(node, f)?;
        write!(f, [source_position(node.start())])
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-31 13:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-31 13:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_attribute.rs</code>:22 on 2023-05-31 13:12</div>
            <div class="timeline-body"><p>We can leave it as is for now, but hiding this implementation behind a builder would be good (builder's exist to increase code-reuse)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-05-31 13:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/context.rs</code>:32 on 2023-05-31 13:14</div>
            <div class="timeline-body"><p>the are unused so clippy complains. <code>#[allow(unused)]</code> would be an alternative</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-31 13:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/context.rs</code>:32 on 2023-05-31 13:22</div>
            <div class="timeline-body"><p>You can make <code>format_range</code> <code>pub</code> :D (it should really be <code>pub</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-05-31 13:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/context.rs</code>:32 on 2023-05-31 13:56</div>
            <div class="timeline-body"><p>i don't see any <code>format_range</code> function, i now switched to <code>#[allow(unused)]</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-31 15:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/lib.rs</code>:57 on 2023-05-31 15:35</div>
            <div class="timeline-body"><p>Nit: This link won't work. You can point to the <code>crate::comments</code> instead</p>
<pre><code class="language-suggestion">    /// Formats the [leading comments](crate::comments#leading-comments) of the node.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-06-01 05:44</div>
            <div class="timeline-body"><p>Let's merge this :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @konstin on 2023-06-01 06:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2023-06-01 06:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-06-01 06:38</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:57:43 UTC
    </footer>
</body>
</html>
