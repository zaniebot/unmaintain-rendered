<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Eagerly evaluate `types.UnionType` elements as type expressions - astral-sh/ruff #21531</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Eagerly evaluate <code>types.UnionType</code> elements as type expressions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21531">#21531</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-11-19 20:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Eagerly evaluate the elements of a PEP 604 union in value position (e.g. <code>IntOrStr = int | str</code>) as type expressions and store the result (the corresponding <code>Type::Union</code> if all elements are valid type expressions, or the first encountered <code>InvalidTypeExpressionError</code>) on the <code>UnionTypeInstance</code>, such that the <code>Type::Union(…)</code> does not need to be recomputed every time the implicit type alias is used in a type annotation.</p>
<p>This might lead to performance improvements for large unions, but is also necessary for correctness, because the elements of the union might refer to type variables that need to be looked up in the scope of the type alias, not at the usage site.</p>
<h2>Test Plan</h2>
<p>New Markdown tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @sharkdp on 2025-11-19 20:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-11-19 21:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types.rs</code>:6748 on 2025-11-19 21:00</div>
            <div class="timeline-body"><p>The previous version was also only able to surface the first error. I'm not sure if this is a problem, or something that we can live with.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-11-19 21:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types.rs</code>:6745 on 2025-11-19 21:03</div>
            <div class="timeline-body"><p>@carljm In the end, this didn't require a new salsa query. Instead, we're now eagerly building that <code>Type::Union</code> in case there were no errors, and interning the result. And then we only need to copy the result here when we see a use of this implicit type alias in a type expression.</p>
<p>This means that we do some extra work if someone defines <code>IntOrStr = int | str</code> and then never uses it as a type. But that feels okay to me?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-11-19 21:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/narrow.rs</code>:217 on 2025-11-19 21:05</div>
            <div class="timeline-body"><p>Will look into this tomorrow, but I guess a legacy <code>Union[int, str]</code> is not allowed in <code>isinstance</code>/<code>issubclass</code>. If so, we were definitely not handling it correctly before.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-19 21:08</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-11-19 21:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/narrow.rs</code>:217 on 2025-11-19 21:24</div>
            <div class="timeline-body"><p>It actually <em>is</em> allowed in isinstance/issubclass, but only on Python 3.10+. And I wouldn't worry too much about older versions than that since they're now end-of-life.</p>
<p>We should probably add some tests for this; it's an edge case but it has come up a couple of times on the mypy issue tracker.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-11-19 22:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types.rs</code>:6745 on 2025-11-19 22:10</div>
            <div class="timeline-body"><p>Yeah, that seems reasonable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-11-20 08:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types.rs</code>:6745 on 2025-11-20 08:06</div>
            <div class="timeline-body"><p>What's potentially more problematic is the fact that when we have a <code>LargeUnion = C1 | C2 | … | Cn</code>, we would build $n - 1$ union types eagerly, instead of just one. But if that turns out to be a problem, we can turn the <code>union_type</code> field into a salsa query.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-20 12:54</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">scikit-build-core (https://github.com/scikit-build/scikit-build-core)
+ src/scikit_build_core/build/wheel.py:98:20: error[no-matching-overload] No overload of bound method `__init__` matches arguments
- Found 43 diagnostics
+ Found 44 diagnostics


</code></pre>
</details>

<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-11-20 14:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/narrow/isinstance.md</code>:297 on 2025-11-20 14:19</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    # TODO: Ideally, this would be an error (requires https://github.com/astral-sh/ty/issues/116)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @sharkdp on 2025-11-20 14:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @sharkdp on 2025-11-20 14:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-11-20 14:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/resources/mdtest/implicit_type_aliases.md</code>:194 on 2025-11-20 14:20</div>
            <div class="timeline-body"><p>We still don't support generic implicit type aliases, but this is a step in the right direction. <code>T@_</code> is just wrong.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-11-20 14:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/narrow.rs</code>:878 on 2025-11-20 14:21</div>
            <div class="timeline-body"><p>This was recently added</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/narrow/isinstance.md</code>:173 on 2025-11-20 14:21</div>
            <div class="timeline-body"><p>I guess you could also add a test with <code>Optional</code>, for completeness?</p>
<pre><code class="language-pycon">&gt;&gt;&gt; from typing import *
&gt;&gt;&gt; if isinstance(42, Optional[int]):
...     print('hooray')
...     
hooray
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types.rs</code>:9406 on 2025-11-20 14:23</div>
            <div class="timeline-body"><p>seems like we could add this note to the new struct as well?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/narrow/isinstance.md</code>:330 on 2025-11-20 14:27</div>
            <div class="timeline-body"><p>could we also add an examples like:</p>
<pre><code class="language-py">ListStrOrInt = Union[list[str], int]

def _(x: dict[int, str] | ListStrOrInt):
    if isinstance(x, ListStrOrInt):
        reveal_type(x)

    if isinstance(x, Union[list[str], int]):
        reveal_type(x)
</code></pre>
<p>Both fail at runtime, so ideally we wouldn't do any narrowing (or we'd intersect with <code>Unknown</code> rather than <code>list[str] | int</code>), and ideally we'd flag the error with a diagnostic.</p>
<p>But this very rarely comes up, so it's obviously fine if this fails right now and we just add TODOs to the test</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-11-20 14:31</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-11-20 15:12</div>
            <div class="timeline-body"><p>Looks like there are minor performance improvements</p>
<p><img width="1197" height="439" alt="image" src="https://github.com/user-attachments/assets/2783167f-800f-4d27-8b51-8c0b44c40f84" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2025-11-20 16:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-11-20 16:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-11-20 16:28</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:17:23 UTC
    </footer>
</body>
</html>
