<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Move `Configuration` to `ruff_workspace` crate - astral-sh/ruff #6920</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Move <code>Configuration</code> to <code>ruff_workspace</code> crate</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6920">#6920</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-08-27 16:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>This PR introduces a new <code>ruff_workspace</code> crate and moves <code>Configuration</code> and the project file discovery to the newly created crate.</p>
<p>The motivation for this change is to</p>
<p>a) Speed up the ruff library compile time to enable faster development cycles
b) Prepare for the formatter where it becomes necessary to add formatter specific configurations to <code>Configuration</code>. This wouldn't be possible today without adding <code>ruff_python_formatter</code> as a dependency to <code>ruff</code>, which we want to avoid (even slower compile times).</p>
<p>Some consequences of the refactor:</p>
<ul>
<li>It was possible to move the whole <code>flake8</code> converter module from ruff to the flake8 crate.</li>
<li>All plugin options are no longer defined alongside their rule code but had to be moved to <code>ruff_workspace</code>. I think that's how it is intended.</li>
</ul>
<h2>Results</h2>
<p>This reduces the release llvm lines from 1801126 -&gt; 1451732 (~20% reduction) and building the ruff library in release mode drops from 43s to 33s on my machine, which is a lot!</p>
<p>It also reduces the ruff binary release build time from 156 to 137s, mainly because <code>ruff_workspace</code> can compile in parallel to <code>ruff</code> (at least part of the time)</p>
<h2>Test Plan</h2>
<p><code>cargo build</code> and <code>cargo test</code></p>
<!-- How was it tested? -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-27 16:45</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #6920</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6920" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6920?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2023-08-27 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-27 16:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_import_conventions/mod.rs</code>:38 on 2023-08-27 16:55</div>
            <div class="timeline-body"><p>Use settings instead of options</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-27 16:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_wasm/src/lib.rs</code>:158 on 2023-08-27 16:57</div>
            <div class="timeline-body"><p>@charliermarsh is this the same? Not using <code>From&lt;Settings&gt; for Options</code> here allows us to remove a ton of code (and going from settings to options is rather odd)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @MichaReiser on 2023-08-27 16:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-08-27 17:12</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/flake8_to_ruff/src/main.rs</code>:2 on 2023-08-27 18:56</div>
            <div class="timeline-body"><p>Nit: trailing thing</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/packaging.rs</code>:49 on 2023-08-27 18:57</div>
            <div class="timeline-body"><p>Why did the above two functions stick around? Can we move them too?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_import_conventions/mod.rs</code>:38 on 2023-08-27 18:57</div>
            <div class="timeline-body"><p>Much better.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_wasm/src/lib.rs</code>:158 on 2023-08-27 19:02</div>
            <div class="timeline-body"><p>Hmm... I <em>think</em> this change will have the effect that all of these settings will be hidden in the Settings pane by default, rather than showing their defaults (since they will default to <code>None</code> rather than <code>Some(pyupgrade::settings::Options::default())</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_wasm/src/lib.rs</code>:158 on 2023-08-27 19:02</div>
            <div class="timeline-body"><p>I did not verify this myself, and that might be worth it anyway to be honest.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-08-27 19:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_wasm/src/lib.rs</code>:158 on 2023-08-28 06:05</div>
            <div class="timeline-body"><p>I cleared my local storage and ran the playground locally. It is giving me the same configuration as on production</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-28 06:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-28 06:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/packaging.rs</code>:49 on 2023-08-28 06:07</div>
            <div class="timeline-body"><p><code>detect_package_root</code> is used by <code>test_path</code>... I didn't find a way to remove it easily.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-08-28 06:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-08-28 06:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-08-28 06:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:59:52 UTC
    </footer>
</body>
</html>
