```yaml
number: 7435
title: "Refactor `tab-indentation` as a token-based rule"
type: pull_request
state: merged
author: dhruvmanila
labels:
  - internal
assignees: []
merged: true
base: main
head: dhruv/tab-indentation-using-tok
created_at: 2023-09-16T13:09:18Z
updated_at: 2023-09-16T20:31:20Z
url: https://github.com/astral-sh/ruff/pull/7435
synced_at: 2026-01-12T02:39:10Z
```

# Refactor `tab-indentation` as a token-based rule

---

_Pull request opened by @dhruvmanila on 2023-09-16 13:09_

## Summary

This PR updates the `W191` (`tab-indentation`) rule from a line-based to a
token-based rule.

Earlier, the rule used the `triple_quoted_string_ranges` from the indexer to
skip over any lines _inside_ a triple-quoted string. This was the only use of
the ranges. These ranges were extracted through the tokens, so instead we can
directly use the newline tokens to perform the check.

This would also mean that we can remove the `triple_quoted_string_ranges` from
the indexer but I'll hold that off until we have a better idea on #7326 but I
don't think it would be a problem to remove it.

This will also fix #7379 once PEP 701 changes are merged.

## Test Plan

`cargo test`


---

_Comment by @dhruvmanila on 2023-09-16 13:09_

Current dependencies on/for this PR:
* main
  * **PR #7435** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7435" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7435?utm_source=stack-comment).

---

_Label `internal` added by @dhruvmanila on 2023-09-16 13:10_

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/pycodestyle/rules/tab_indentation.rs`:77 on 2023-09-16 13:26_

We could probably do the leading_indentation and tab find in one pass, via `take_while` and `find`?

---

_@charliermarsh approved on 2023-09-16 13:26_

---

_Comment by @github-actions[bot] on 2023-09-16 13:27_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.



---

_Review comment by @MichaReiser on `crates/ruff/src/rules/pycodestyle/rules/tab_indentation.rs`:66 on 2023-09-16 14:16_

Can we add a comment why this is necessary? I understand is that the lexer emits a `Newline` or `NonLogicalNewline` token for every `\n`. Is this to capture tab indentation inside multiline strings?

---

_@MichaReiser approved on 2023-09-16 14:16_

Nice

---

_@dhruvmanila reviewed on 2023-09-16 19:33_

---

_Review comment by @dhruvmanila on `crates/ruff/src/rules/pycodestyle/rules/tab_indentation.rs`:66 on 2023-09-16 19:33_

The lexer doesn't emit `Newline` / `NonLogicalNewline` for a line continuation. So, for the following code snippet where there's a tab indentation before the `or` token:

```python
x \
	or y
```

The lexer will emit:
```
Name { name: "x" }
Or
Name { name: "y" }
Newline
```

This is to capture tab indentation for multi-line expression separated using a line continuation character.

---

_@charliermarsh reviewed on 2023-09-16 19:38_

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/pycodestyle/rules/tab_indentation.rs`:66 on 2023-09-16 19:38_

What happens if you have a continuation within a single-quoted or triple-quoted string?

---

_@dhruvmanila reviewed on 2023-09-16 19:48_

---

_Review comment by @dhruvmanila on `crates/ruff/src/rules/pycodestyle/rules/tab_indentation.rs`:77 on 2023-09-16 19:48_

I tried this but we need the indent length for the diagnostic range:
```rust
TextRange::at(line_start, indent.text_len())
```

---

_@dhruvmanila reviewed on 2023-09-16 19:50_

---

_Review comment by @dhruvmanila on `crates/ruff/src/rules/pycodestyle/rules/tab_indentation.rs`:66 on 2023-09-16 19:50_

We don't check for tab indentation inside a string and the lexer captures the entire string as a single token.

This was the use-case of `triple_quoted_string_ranges` earlier where if the offset is part of a triple-quoted string, then we would skip it

---

_@dhruvmanila reviewed on 2023-09-16 19:54_

---

_Review comment by @dhruvmanila on `crates/ruff/src/rules/pycodestyle/rules/tab_indentation.rs`:66 on 2023-09-16 19:54_

So, I guess an example like:
```python
	"""first line (tab indented start quoted)
	<-- tab indentation
"""
```

would only emit a diagnostic for the first line and not the second line as that's part of the string.

Oh, wait the new logic wouldn't detect the first line as there's no newline before that.

---

_@dhruvmanila reviewed on 2023-09-16 19:55_

---

_Review comment by @dhruvmanila on `crates/ruff/src/rules/pycodestyle/rules/tab_indentation.rs`:66 on 2023-09-16 19:55_

We'll have to special case the first line to be checked every single time.

---

_Comment by @codspeed-hq[bot] on 2023-09-16 20:00_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/dhruv/tab-indentation-using-tok)

### Merging #7435 will **not alter performance**

<sub>Comparing <code>dhruv/tab-indentation-using-tok</code> (c025c41) with <code>main</code> (422ff82)</sub>



### Summary

`âœ… 25` untouched benchmarks






---

_@dhruvmanila reviewed on 2023-09-16 20:04_

---

_Review comment by @dhruvmanila on `crates/ruff/src/rules/pycodestyle/rules/tab_indentation.rs`:66 on 2023-09-16 20:04_

Ok, I've updated to always check for the first line and added a test case for it.

---

_Closed by @dhruvmanila on 2023-09-16 20:16_

---

_Reopened by @dhruvmanila on 2023-09-16 20:16_

---

_Merged by @dhruvmanila on 2023-09-16 20:25_

---

_Closed by @dhruvmanila on 2023-09-16 20:25_

---

_Branch deleted on 2023-09-16 20:25_

---
