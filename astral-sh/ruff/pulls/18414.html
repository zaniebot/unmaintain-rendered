<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Fix server hang after shutdown request - astral-sh/ruff #18414</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Fix server hang after shutdown request</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18414">#18414</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-06-01 17:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">Summary
<p>This fixes an error where the ty server didn&#x27;t exit after receiving the shutdown request.</p>
<p>The root cause was the panic handler which hold on to a client sender channel, preventing the io thread from exiting (because there was still the chance that we would send a message).</p>
<p>I tested that the server now correctly exits with VS code. However, I never see an exit notification when closing VS code, only when restarting the server with the restart command. This is consistent with ruff.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-01 17:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-01 17:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-01 17:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-01 17:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-01 17:20</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-01 17:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api.rs</code>:52 on 2025-06-01 17:26</div>
            <div class="timeline-body"><p>I ended up rewriting the shutdown handling during my investigation and I sort of like this more.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-01 17:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-01 17:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-01 17:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-01 17:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-01 17:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[ty] Fix server doesn&#x27;t exit after shutdown&quot; to &quot;[ty] Fix server hang after shutdown request&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-01 17:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/AlexWaygood">@AlexWaygood</a> removed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-01 17:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-01 19:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server.rs</code>:148 on 2025-06-01 19:02</div>
            <div class="timeline-body"><p>This is the main fix. Values assigned to <code>_</code> are dropped immediately. That means, the panic hook was always restored immediately (and then overridden again).</p>
<blockquote>
<p>Statements which assign an expression to an underscore causes the expression to immediately drop instead of extending the expression’s lifetime to the end of the scope. This is usually unintended, especially for types like MutexGuard, which are typically used to lock a mutex for the duration of an entire scope.</p>
</blockquote>
<p>It looks like Rust 1.88 will add a lint for this <a href="https://doc.rust-lang.org/beta/nightly-rustc/rustc_lint/let_underscore/static.LET_UNDERSCORE_DROP.html">source</a></p>
<p>The fix here is to assign the panic hook to a variable other than <code>_</code>. The <code>Drop</code> handler then restores the original panic hook, which in turn, drops our custom panic hook handler that holds on to the client</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-01 19:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server.rs</code>:203 on 2025-06-01 19:43</div>
            <div class="timeline-body"><pre><code>        // Use a weak reference to the client because it must be dropped when exiting or the
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:56 on 2025-06-02 02:15</div>
            <div class="timeline-body"><p>Should we avoid adding the request in the queue if the server is responding right away?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:49 on 2025-06-02 02:19</div>
            <div class="timeline-body"><p>I think we should avoid adding periods to messages which is in line with how we format other messages throughout Ruff</p>
<pre><code>                                        message: &quot;Shutdown already requested&quot;.to_owned(),
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:65 on 2025-06-02 02:23</div>
            <div class="timeline-body"><p>I&#x27;d consider these two messages to be mutually exclusive, so maybe something like the following (appended &quot;exiting&quot; to both as the server would exit in both scenario):</p>
<pre><code>                                if self.session.is_shutdown_requested() {
                                	tracing::debug!(&quot;Received exit notification, exiting&quot;);
                                } else {
                                    tracing::warn!(
                                        &quot;Received exit notification before shutdown request, exiting&quot;
                                    );
                                }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:143 on 2025-06-02 02:26</div>
            <div class="timeline-body"><p>The variable assignment seems unnecessary as the <code>next.map(Some)</code> is only for a single branch, maybe we can simplify it:</p>
<pre><code>        select!(
            recv(self.connection.receiver) -&gt; msg =&gt; Ok(msg.ok().map(Event::Message)),
            recv(self.main_loop_receiver) -&gt; event =&gt; event.map(Some),
        )
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:144 on 2025-06-02 02:29</div>
            <div class="timeline-body"><p>Why are we ignoring the error when receiving the client messages (via <code>connection</code>) but not for the main loop receiver?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:144 on 2025-06-02 02:33</div>
            <div class="timeline-body"><p>Oh, is it to explicit that the connection got closed without a proper shutdown sequence which is how it&#x27;s being handled in the main loop?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:75 on 2025-06-02 02:36</div>
            <div class="timeline-body"><p>I&#x27;m assuming we don&#x27;t need to modify anything in this branch mainly because the server would stop handling any request / notification from the client when shutdown has been initiated and so the server wouldn&#x27;t try to send any request to the client which means there shouldn&#x27;t be any client responses to handle during the shutdown process.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api.rs</code>:53 on 2025-06-02 02:37</div>
            <div class="timeline-body"><pre><code>            tracing::debug!(&quot;Received shutdown request, waiting for shutdown notification&quot;);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api.rs</code>:52 on 2025-06-02 02:37</div>
            <div class="timeline-body"><p>Thank you! I like this a lot, I was wondering myself whether the custom <code>Connection</code> struct could be removed with your recent changes around cancellation / retry.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-06-02 02:51</div>
            <div class="timeline-body"><p>Thank you for the quick fix! The issue seems very subtle, I think we should enable the lint rule when we can at least for the server code.</p>
<p>I&#x27;ve been also wondering whether it would make sense to invest some time to having code sharing between the Ruff and ty language server where we can. It might be possible to share the the infrastructure code i.e., the ones that involves creating the event loop.</p>
<p>I tested this in Neovim, the server exists successfully:</p>
<pre><code>   0.454553583s DEBUG     ty:main ty_server::server::api: Received shutdown request, waiting for shutdown notification.
   0.471809916s DEBUG     ty:main ty_server::server::main_loop: Received exit notification, exiting
   0.481823416s  INFO        main ty_server: Server shut down
</code></pre>
<p>I also looked at the running processes and it now only contains the server process from <code>main</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-02 06:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:144 on 2025-06-02 06:26</div>
            <div class="timeline-body"><p>Yes, we ignore the connection closed errors for the IO channel because that means the server exited in a non-graceful way.</p>
<p>We should never see those for the main loop because we always have at least our own sender.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-02 06:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:75 on 2025-06-02 06:28</div>
            <div class="timeline-body"><p>We could add the handling to notifications, because they&#x27;re explicitly listed in the LSP specification. It&#x27;s less clear to me if client responses are excluded too and it&#x27;s quiet possible that the server might send a request from a background task when the shutdown was already initialized.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-02 06:29</div>
            <div class="timeline-body"><blockquote>
<p>I&#x27;ve been also wondering whether it would make sense to invest some time to having code sharing between the Ruff and ty language server where we can. It might be possible to share the the infrastructure code i.e., the ones that involves creating the event loop.</p>
</blockquote>
<p>It might be more work than it&#x27;s worth it. The request handlers, session, etc look very different between ruff and ty</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-02 06:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:56 on 2025-06-02 06:40</div>
            <div class="timeline-body"><p>Actually, we need to register the request when using <code>client.respond</code> because it checks if the request is registered before responding. We could use <code>client_sender</code> directly to avoid the registration but I rather use the &quot;proven&quot; way and it&#x27;s an edge case anyway, so that performance isn&#x27;t that relevant.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-02 06:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:65 on 2025-06-02 06:42</div>
            <div class="timeline-body"><p>I don&#x27;t think they&#x27;re exlusive to each other. We always exit, but we want a warning when we do so before we receive a shutdown request. We could probably return with an <code>Err</code> in that case, similar to how we error when we didn&#x27;t receive an <code>ExitNotification</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:65 on 2025-06-02 06:46</div>
            <div class="timeline-body"><p>Returning with an error is more conform with the LSP specification</p>
<blockquote>
<p>A notification to ask the server to exit its process. The server should exit with success code 0 if the shutdown request has been received before; otherwise with error code 1.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-02 06:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-02 06:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:75 on 2025-06-02 06:47</div>
            <div class="timeline-body"><p>I&#x27;ll leave it as is. The LSP specification only mentions:</p>
<blockquote>
<p>If a server receives requests after a shutdown request those requests should error with InvalidRequest.</p>
</blockquote>
<p>Processing notifications and responses is a bit wastefull but shouldn&#x27;t harm too much (they are all very short)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-02 06:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:144 on 2025-06-02 06:48</div>
            <div class="timeline-body"><p>I added a comment</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-02 06:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-02 06:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-02 06:57</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:15:06 UTC
    </footer>
</body>
</html>
