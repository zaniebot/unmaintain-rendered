<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Track argument variance for literal promotion without relying on `SpecializationBuilder` internals - astral-sh/ruff #21905</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Track argument variance for literal promotion without relying on <code>SpecializationBuilder</code> internals</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21905">#21905</a>
        opened by <a href="https://github.com/dcreager">@dcreager</a>
        on 2025-12-10 20:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dcreager">@dcreager</a> on 2025-12-10 20:05</div>
            <div class="timeline-body"><p>When inferring a specialization for a generic function call, we might want to promote <code>Literal</code> types that appear in the inferred specialization. Whether we do so depends (among other things) on the variance of those typevars in the parameter types that each argument is matched to. That means we need to track the variance of each typevar as we process the arguments during inference.</p>
<p>Before, we were piggy-backing on how <code>SpecializationBuilder</code> walks through the formal and actual types. Its <code>infer_map</code> method takes in a callback that is invoked each time we record a new type mapping for a typevar. Before, this method was provided with the variance of that typevar, according to the formal/actual pair that we just checked.</p>
<p>We are in the process of changing the internals of <code>SpecializationBuilder</code> so that this approach is no longer tenable. This PR updates the call inference logic to calculate the typevar variance separately, without making any assumptions about how <code>SpecializationBuilder</code> does its work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dcreager on 2025-12-10 20:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dcreager on 2025-12-10 20:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @dcreager on 2025-12-10 20:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @dcreager on 2025-12-10 20:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @dcreager on 2025-12-10 20:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-10 20:07</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-10 20:09</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">beartype (https://github.com/beartype/beartype)
- beartype/claw/_package/clawpkgtrie.py:66:29: warning[unsupported-base] Unsupported class base with type `&lt;class 'dict[str, PackagesTrieBlacklist]'&gt; | &lt;class 'dict[str, Divergent]'&gt;`
- beartype/claw/_package/clawpkgtrie.py:247:29: warning[unsupported-base] Unsupported class base with type `&lt;class 'dict[str, PackagesTrieWhitelist]'&gt; | &lt;class 'dict[str, Divergent]'&gt;`
- Found 491 diagnostics
+ Found 489 diagnostics

scikit-build-core (https://github.com/scikit-build/scikit-build-core)
- src/scikit_build_core/build/wheel.py:98:20: error[no-matching-overload] No overload of bound method `__init__` matches arguments
- Found 43 diagnostics
+ Found 42 diagnostics

bokeh (https://github.com/bokeh/bokeh)
- src/bokeh/models/annotations/geometry.py:222:29: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `type[Property[int]] | Property[int]`, found `&lt;class 'Float'&gt;`
+ src/bokeh/models/annotations/geometry.py:222:29: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `type[Property[Literal[0]]] | Property[Literal[0]]`, found `&lt;class 'Float'&gt;`
- src/bokeh/models/annotations/geometry.py:229:30: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `type[Property[int]] | Property[int]`, found `&lt;class 'Float'&gt;`
+ src/bokeh/models/annotations/geometry.py:229:30: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `type[Property[Literal[0]]] | Property[Literal[0]]`, found `&lt;class 'Float'&gt;`
+ src/bokeh/models/plots.py:779:27: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `type[Property[Literal[5]]] | Property[Literal[5]]`, found `&lt;class 'Int'&gt;`
+ src/bokeh/models/plots.py:801:30: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `type[Property[Literal[2000]]] | Property[Literal[2000]]`, found `&lt;class 'Int'&gt;`
- src/bokeh/models/ranges.py:403:22: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `type[Property[int]] | Property[int]`, found `&lt;class 'Float'&gt;`
+ src/bokeh/models/ranges.py:403:22: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `type[Property[Literal[0]]] | Property[Literal[0]]`, found `&lt;class 'Float'&gt;`
- src/bokeh/models/ranges.py:413:20: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `type[Property[int]] | Property[int]`, found `&lt;class 'Float'&gt;`
+ src/bokeh/models/ranges.py:413:20: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `type[Property[Literal[0]]] | Property[Literal[0]]`, found `&lt;class 'Float'&gt;`
+ src/bokeh/models/tools.py:685:25: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `type[Property[Literal[0]]] | Property[Literal[0]]`, found `&lt;class 'Int'&gt;`
+ src/bokeh/models/tools.py:1182:25: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `type[Property[Literal[0]]] | Property[Literal[0]]`, found `&lt;class 'Int'&gt;`
+ src/bokeh/models/widgets/inputs.py:441:34: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `type[Property[Literal[2]]] | Property[Literal[2]]`, found `&lt;class 'Int'&gt;`
+ src/bokeh/models/widgets/inputs.py:592:32: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `type[Property[Literal[100]]] | Property[Literal[100]]`, found `&lt;class 'Int'&gt;`
+ src/bokeh/models/widgets/inputs.py:601:22: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `type[Property[Literal[1]]] | Property[Literal[1]]`, found `&lt;class 'Int'&gt;`
+ src/bokeh/models/widgets/sliders.py:102:22: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `type[Property[Literal[&quot;&quot;]]] | Property[Literal[&quot;&quot;]]`, found `&lt;class 'String'&gt;`
+ src/bokeh/models/widgets/tables.py:848:31: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `type[Property[Literal[0]]] | Property[Literal[0]]`, found `&lt;class 'Int'&gt;`
- src/bokeh/plotting/_figure.py:201:97: error[invalid-argument-type] Argument to function `process_axis_and_grid` is incorrect: Expected `str | BaseText | None`, found `Unknown | Nullable[str]`
+ src/bokeh/plotting/_figure.py:201:97: error[invalid-argument-type] Argument to function `process_axis_and_grid` is incorrect: Expected `str | BaseText | None`, found `Unknown | Nullable[Literal[&quot;&quot;]]`
- src/bokeh/plotting/_figure.py:202:97: error[invalid-argument-type] Argument to function `process_axis_and_grid` is incorrect: Expected `str | BaseText | None`, found `Unknown | Nullable[str]`
+ src/bokeh/plotting/_figure.py:202:97: error[invalid-argument-type] Argument to function `process_axis_and_grid` is incorrect: Expected `str | BaseText | None`, found `Unknown | Nullable[Literal[&quot;&quot;]]`
- src/bokeh/settings.py:747:46: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `((int | None | str, /) -&gt; int | None | str) | None`, found `def convert_logging(value: str | int) -&gt; int | None`
+ src/bokeh/settings.py:747:46: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `((int | None | str, /) -&gt; int | None | Literal[&quot;none&quot;, &quot;debug&quot;]) | None`, found `def convert_logging(value: str | int) -&gt; int | None`
- Found 867 diagnostics
+ Found 876 diagnostics

zulip (https://github.com/zulip/zulip)
+ zerver/tests/test_users.py:259:25: error[invalid-argument-type] Method `__getitem__` of type `bound method dict[Literal[&quot;email&quot;], Unknown].__getitem__(key: Literal[&quot;email&quot;], /) -&gt; Unknown` cannot be called with key of type `Literal[&quot;is_owner&quot;]` on object of type `dict[Literal[&quot;email&quot;], Unknown]`
+ zerver/tests/test_users.py:261:26: error[invalid-argument-type] Method `__getitem__` of type `bound method dict[Literal[&quot;email&quot;], Unknown].__getitem__(key: Literal[&quot;email&quot;], /) -&gt; Unknown` cannot be called with key of type `Literal[&quot;is_owner&quot;]` on object of type `dict[Literal[&quot;email&quot;], Unknown]`
+ zerver/tests/test_users.py:318:25: error[invalid-argument-type] Method `__getitem__` of type `bound method dict[Literal[&quot;email&quot;], Unknown].__getitem__(key: Literal[&quot;email&quot;], /) -&gt; Unknown` cannot be called with key of type `Literal[&quot;is_admin&quot;]` on object of type `dict[Literal[&quot;email&quot;], Unknown]`
+ zerver/tests/test_users.py:320:26: error[invalid-argument-type] Method `__getitem__` of type `bound method dict[Literal[&quot;email&quot;], Unknown].__getitem__(key: Literal[&quot;email&quot;], /) -&gt; Unknown` cannot be called with key of type `Literal[&quot;is_admin&quot;]` on object of type `dict[Literal[&quot;email&quot;], Unknown]`
+ zerver/tests/test_users.py:361:26: error[invalid-argument-type] Method `__getitem__` of type `bound method dict[Literal[&quot;user_id&quot;], Unknown].__getitem__(key: Literal[&quot;user_id&quot;], /) -&gt; Unknown` cannot be called with key of type `Literal[&quot;email&quot;]` on object of type `dict[Literal[&quot;user_id&quot;], Unknown]`
+ zerver/tests/test_users.py:362:27: error[invalid-argument-type] Method `__getitem__` of type `bound method dict[Literal[&quot;user_id&quot;], Unknown].__getitem__(key: Literal[&quot;user_id&quot;], /) -&gt; Unknown` cannot be called with key of type `Literal[&quot;avatar_url&quot;]` on object of type `dict[Literal[&quot;user_id&quot;], Unknown]`
+ zerver/tests/test_users.py:363:26: error[invalid-argument-type] Method `__getitem__` of type `bound method dict[Literal[&quot;user_id&quot;], Unknown].__getitem__(key: Literal[&quot;user_id&quot;], /) -&gt; Unknown` cannot be called with key of type `Literal[&quot;delivery_email&quot;]` on object of type `dict[Literal[&quot;user_id&quot;], Unknown]`
+ zerver/tests/test_users.py:387:26: error[invalid-argument-type] Method `__getitem__` of type `bound method dict[Literal[&quot;user_id&quot;], Unknown].__getitem__(key: Literal[&quot;user_id&quot;], /) -&gt; Unknown` cannot be called with key of type `Literal[&quot;email&quot;]` on object of type `dict[Literal[&quot;user_id&quot;], Unknown]`
+ zerver/tests/test_users.py:389:13: error[invalid-argument-type] Method `__getitem__` of type `bound method dict[Literal[&quot;user_id&quot;], Unknown].__getitem__(key: Literal[&quot;user_id&quot;], /) -&gt; Unknown` cannot be called with key of type `Literal[&quot;avatar_url&quot;]` on object of type `dict[Literal[&quot;user_id&quot;], Unknown]`
+ zerver/tests/test_users.py:402:26: error[invalid-argument-type] Method `__getitem__` of type `bound method dict[Literal[&quot;user_id&quot;], Unknown].__getitem__(key: Literal[&quot;user_id&quot;], /) -&gt; Unknown` cannot be called with key of type `Literal[&quot;email&quot;]` on object of type `dict[Literal[&quot;user_id&quot;], Unknown]`
+ zerver/tests/test_users.py:404:13: error[invalid-argument-type] Method `__getitem__` of type `bound method dict[Literal[&quot;user_id&quot;], Unknown].__getitem__(key: Literal[&quot;user_id&quot;], /) -&gt; Unknown` cannot be called with key of type `Literal[&quot;avatar_url&quot;]` on object of type `dict[Literal[&quot;user_id&quot;], Unknown]`
+ zerver/tests/test_users.py:406:26: error[invalid-argument-type] Method `__getitem__` of type `bound method dict[Literal[&quot;user_id&quot;], Unknown].__getitem__(key: Literal[&quot;user_id&quot;], /) -&gt; Unknown` cannot be called with key of type `Literal[&quot;delivery_email&quot;]` on object of type `dict[Literal[&quot;user_id&quot;], Unknown]`
- Found 3631 diagnostics
+ Found 3643 diagnostics


</code></pre>
</details>

<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by @carljm on 2025-12-10 20:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-10 20:23</div>
            <div class="timeline-body"><p>Code looks fine. Ecosystem changes on zulip suggest that there's an unintentional behavior change here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-10 20:32</div>
            <div class="timeline-body"><!-- generated-comment ty ecosystem-analyzer -->

<h2><code>ecosystem-analyzer</code> results</h2>
<p>| Lint rule | Added | Removed | Changed |
|-----------|------:|--------:|--------:|
| <code>invalid-argument-type</code> | 21 | 0 | 7 |
| <code>unused-ignore-comment</code> | 0 | 3 | 0 |
| <strong>Total</strong> | <strong>21</strong> | <strong>3</strong> | <strong>7</strong> |</p>
<p><strong><a href="https://dcreager-param-variance.ecosystem-663.pages.dev/diff">Full report with detailed diff</a></strong> (<a href="https://dcreager-param-variance.ecosystem-663.pages.dev/timing">timing results</a>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-10 20:58</div>
            <div class="timeline-body"><p>It seems like in the zulip cases we are failing to do literal promotion in a case where previously we did promote.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-12-11 16:32</div>
            <div class="timeline-body"><blockquote>
<p>It seems like in the zulip cases we are failing to do literal promotion in a case where previously we did promote.</p>
</blockquote>
<p>Fixed the zulip case and added an mdtest regression for it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> removed by @dcreager on 2025-12-11 16:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by @dcreager on 2025-12-11 16:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-12-11 16:44</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/dcreager%2Fparam-variance?utm_source=github&amp;utm_medium=comment&amp;utm_content=header">CodSpeed Performance Report</a></h2>
<h3>Merging #21905 will <strong>degrade performances by 4.25%</strong></h3>
<p><sub>Comparing <code>dcreager/param-variance</code> (fe25ee2) with <code>main</code> (c8851ec)</sub></p>
<h3>Summary</h3>
<p><code>❌ 1</code> regression<br />
<code>✅ 12</code> untouched<br />
<code>⏩ 39</code> skipped[^skipped]</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/dcreager%2Fparam-variance?utm_source=github&amp;utm_medium=comment&amp;utm_content=acknowledge">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
<h3>Benchmarks breakdown</h3>
<p>|     | Mode | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | ---- | --------- | ------ | ------ | ------ |
| ❌ | Simulation | <a href="https://codspeed.io/astral-sh/ruff/branches/dcreager%2Fparam-variance?uri=crates%2Fruff_benchmark%2Fbenches%2Fty.rs%3A%3Aproject%3A%3Ahydra%3A%3Aproject%3A%3Ahydra-zen&amp;runnerMode=Instrumentation&amp;utm_source=github&amp;utm_medium=comment&amp;utm_content=benchmark"><code>hydra-zen</code></a> | 1.3 s | 1.4 s | -4.25% |
[^skipped]: 39 benchmarks were skipped, so the baseline results were used instead. If they were deleted from the codebase, <a href="https://codspeed.io/astral-sh/ruff/branches/dcreager%2Fparam-variance?sectionId=benchmark-comparison-section-baseline-result-skipped&amp;utm_source=github&amp;utm_medium=comment&amp;utm_content=archive">click here and archive them to remove them from the performance reports</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-11 18:05</div>
            <div class="timeline-body"><p>Looks like both the ecosystem CI jobs timed out, which I think is probably <em>not</em> related to the github outage?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-12-11 18:08</div>
            <div class="timeline-body"><blockquote>
<p>Looks like both the ecosystem CI jobs timed out, which I think is probably <em>not</em> related to the github outage?</p>
</blockquote>
<p>Yep, I've got a mypy_primer run going locally to confirm</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-12-11 20:26</div>
            <div class="timeline-body"><blockquote>
<p>Looks like both the ecosystem CI jobs timed out</p>
</blockquote>
<p>Cherry-picked several of performance optimizations commits from #21551 and that seems to have fixed the timeouts. Locally, at least! Waiting for CI to confirm</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-12-11 21:12</div>
            <div class="timeline-body"><blockquote>
<p>Locally, at least! Waiting for CI to confirm</p>
</blockquote>
<p>Welp, famous last words! Instead of pushing this forward more, I'm going to see if I can update the generic protocol PR to not require this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-12-15 20:56</div>
            <div class="timeline-body"><blockquote>
<p>I'm going to see if I can update the generic protocol PR to not require this.</p>
</blockquote>
<p>This happened, so I'm closing this for now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dcreager on 2025-12-15 20:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-12-15 20:56</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:42:36 UTC
    </footer>
</body>
</html>
