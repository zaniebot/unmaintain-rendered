<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-comprehensions`] Fix false positive for `C420` with attribute, subscript, or slice assignment targets - astral-sh/ruff #19513</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-comprehensions</code>] Fix false positive for <code>C420</code> with attribute, subscript, or slice assignment targets</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19513">#19513</a>
        opened by <a href="https://github.com/danparizher">@danparizher</a>
        on 2025-07-23 17:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/danparizher">@danparizher</a> on 2025-07-23 17:10</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes #19511</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-23 17:21</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @ntBre on 2025-07-24 13:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ntBre on 2025-07-25 22:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @ntBre on 2025-07-25 22:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_comprehensions/C420_3.py</code>:15 on 2025-07-28 20:24</div>
            <div class="timeline-body"><p>These don't look like the test cases from the issue. I think these are the incorrect fixes we were generating before.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_comprehensions/rules/unnecessary_dict_comprehension_for_iterable.rs</code>:105 on 2025-07-28 20:26</div>
            <div class="timeline-body"><p>With only one <code>match</code> arm, I think it's slightly more idiomatic to use <code>matches!</code>:</p>
<pre><code class="language-suggestion">    if matches!(generator.target, Expr::Attribute(_) | Expr::Subscript(_) | Expr::Slice(_)) {
            return;
    }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> requested changes on 2025-07-28 20:28</div>
            <div class="timeline-body"><p>Thanks. I think the fix is correct here, but I don't think the new test cases actually trigger the rule.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @danparizher on 2025-07-30 01:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-07-31 19:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_comprehensions/rules/unnecessary_dict_comprehension_for_iterable.rs</code>:105 on 2025-07-31 19:52</div>
            <div class="timeline-body"><p>I didn't realize this initially, but we may need a simple <code>Visitor</code> here. This only checks the top-level expression, but the problem persists if the attribute, subscript, or slice is a sub-expression. As a simple example, we can embed the <code>C.a</code> case in a tuple:</p>
<pre><code class="language-py">class C: a = None
{(C.a,): None for (C.a,) in &quot;abc&quot;}
print(C.a)
</code></pre>
<p>and it still prints <code>c</code>, but the target expression itself is no longer an attribute.</p>
<p>I feel like top-level slices and attributes should already be pretty rare, so I could probably be convinced that the cost of a <code>Visitor</code> isn't worth it, but we should at least document our decision and add a known-false-positive test case if we decide not to go for it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danparizher">@danparizher</a> reviewed on 2025-08-01 00:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/danparizher">@danparizher</a> on <code>crates/ruff_linter/src/rules/flake8_comprehensions/rules/unnecessary_dict_comprehension_for_iterable.rs</code>:105 on 2025-08-01 00:16</div>
            <div class="timeline-body"><p>I'm curious to see how much it would cost. Going to commit to take a look at the performance, feel free to revert if you think it isn't worth it ðŸ™‚</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @danparizher on 2025-08-01 00:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_comprehensions/C420.py</code>:1 on 2025-08-01 17:12</div>
            <div class="timeline-body"><p>Should we move these to <code>C420_3.py</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-08-01 17:14</div>
            <div class="timeline-body"><p>Very nice! I was hoping we had a utility for this, but I didn't know about <code>any_over_expr</code> off the top of my head. Nice work!</p>
<p>I had one more tiny nit about test locations, but this is good to go otherwise.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-08-01 17:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_comprehensions/rules/unnecessary_dict_comprehension_for_iterable.rs</code>:105 on 2025-08-01 17:14</div>
            <div class="timeline-body"><p>Benchmarks look good, no change!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-08-01 17:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_comprehensions/rules/unnecessary_dict_comprehension_for_iterable.rs</code>:100 on 2025-08-01 17:16</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    // (attributes, subscripts, or slices).
</code></pre>
<p>One more nit, I guess :) I think &quot;at the top level&quot; was only true before</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`flake8_comprehensions`] Fix false positive for `C420` with attribute, subscript, or slice assignment targets" to "[`flake8-comprehensions`] Fix false positive for `C420` with attribute, subscript, or slice assignment targets" by @danparizher on 2025-08-01 21:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @danparizher on 2025-08-01 21:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-08-08 19:02</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-08-08 19:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-08-08 19:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-08 19:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:52:43 UTC
    </footer>
</body>
</html>
