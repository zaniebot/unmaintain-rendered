<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Add tests for untitled files - astral-sh/ruff #12526</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Add tests for untitled files</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/12526">#12526</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-07-26 10:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR addresses the review comments in https://github.com/astral-sh/ruff/pull/12492.</p>
<p>It's a separate PR to better facilitate the review process.</p>
<blockquote>
<p>[!NOTE]</p>
<p>This PR will be merged into the parent PR and then a single commit will be created on <code>main</code>.</p>
</blockquote>
<h2>Test Plan</h2>
<p><code>cargo test -p ruff_db</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @dhruvmanila on 2024-07-26 10:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dhruvmanila on 2024-07-26 10:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2024-07-26 10:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dhruvmanila on 2024-07-26 10:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/files.rs</code>:160 on 2024-07-26 10:59</div>
            <div class="timeline-body"><p>I would change this method to return an <code>Option</code>, so we don't need the <code>try</code> method.</p>
<p>It feels a bit funny that this operation can fail. I suspect that this will be somewhat awkward in the LSP, but let's see.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/files.rs</code>:160 on 2024-07-26 11:01</div>
            <div class="timeline-body"><p>I think it would be best to not override any existing file. Overriding an existing file would mean that we suddenly have multiple files mapping to the same path. This could be come awkward to debug.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/system/path.rs</code>:625 on 2024-07-26 11:02</div>
            <div class="timeline-body"><p>I think the full string that VS code uses is <code>untitled://Untitled-1</code>. Can we add a test for this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-26 11:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-07-26 11:07</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-07-26 11:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_db/src/system/path.rs</code>:625 on 2024-07-26 11:21</div>
            <div class="timeline-body"><p>I just checked in VS Code and it's</p>
<ul>
<li><code>untitled:Untitled-1</code></li>
<li><code>vscode-notebook-cell:Untitled-1.ipynb</code></li>
</ul>
<p>I'll update the test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-26 11:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/system/path.rs</code>:625 on 2024-07-26 11:24</div>
            <div class="timeline-body"><p>Interesting, https://github.com/neovim/neovim/issues/21276 suggests that it should be a URL with the format <code>untitled://</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-07-26 11:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_db/src/files.rs</code>:160 on 2024-07-26 11:31</div>
            <div class="timeline-body"><p>I think the <code>try</code> method would still be required to fetch the file when trying to sync it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-26 11:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/files.rs</code>:160 on 2024-07-26 11:42</div>
            <div class="timeline-body"><p>Hmm only  when going from <code>path</code> to <code>File</code>. Maybe we should remove that sync method for now and instead require calling <code>file.sync</code>.  That does mean that we can't offer a <code>write_virtual_system_file</code> test helper. I think that's fine for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-07-26 11:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_db/src/files.rs</code>:160 on 2024-07-26 11:54</div>
            <div class="timeline-body"><p>Ok, I've removed the sync logic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-07-26 11:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_db/src/system/path.rs</code>:625 on 2024-07-26 11:54</div>
            <div class="timeline-body"><p>I've added these test cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2024-07-26 11:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/files.rs</code>:314 on 2024-07-26 12:00</div>
            <div class="timeline-body"><p>Sorry. This sync function is okay where we already have a file (because it doesn't need looking up the file by path)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-07-26 12:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2024-07-26 12:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-07-26 12:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-07-26 12:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-07-26 12:12</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/dhruv/untitled-files-2">CodSpeed Performance Report</a></h2>
<h3>Merging #12526 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>dhruv/untitled-files-2</code> (d7b915e) with <code>main</code> (71f7aa4)</sub></p>
<h3>Summary</h3>
<p><code>‚úÖ 30</code> untouched benchmarks</p>
<p><code>üÜï 3</code> new benchmarks
<code>‚ÅâÔ∏è 3</code> dropped benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/dhruv/untitled-files-2">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>main</code> | <code>dhruv/untitled-files-2</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ‚ÅâÔ∏è | <code>red_knot_check_file[cold]</code> | 14 ms | N/A | N/A |
| ‚ÅâÔ∏è | <code>red_knot_check_file[incremental]</code> | 446.5 ¬µs | N/A | N/A |
| ‚ÅâÔ∏è | <code>red_knot_check_file[without_parse]</code> | 6.5 ms | N/A | N/A |
| üÜï | <code>red_knot_check_file[cold]</code> | N/A | 13.8 ms | N/A |
| üÜï | <code>red_knot_check_file[incremental]</code> | N/A | 438.8 ¬µs | N/A |
| üÜï | <code>red_knot_check_file[without_parse]</code> | N/A | 6.4 ms | N/A |</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:05:31 UTC
    </footer>
</body>
</html>
