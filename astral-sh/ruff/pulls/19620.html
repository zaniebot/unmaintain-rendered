<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add a flow diagram for Python's import resolution algorithm - astral-sh/ruff #19620</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add a flow diagram for Python&#x27;s import resolution algorithm</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19620">#19620</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2025-07-29 17:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a></div>
            <div class="timeline-body"><p>This PR includes a few other touch-ups that I split out into separate
commits. While the changes are pretty small, it probably makes sense
for reviewers to read this PR commit-by-commit.</p>
<p>The motivation for the flow diagram is to provide a source of truth
about our intended implementation for module resolution. In particular,
in addition to &quot;resolve this specific module name,&quot; we also want to add
support for &quot;list module names&quot; in service of completions. Code reuse
between these two is likely difficult, so I wanted to 1) carefully
understand how the former worked and 2) provide a source of truth that
both implementations can target.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-07-29 17:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-07-29 17:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-07-29 17:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-07-29 17:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-07-29 17:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/dcreager">@dcreager</a> removed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-07-29 17:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/carljm">@carljm</a> removed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-07-29 17:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/sharkdp">@sharkdp</a> removed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-07-29 17:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-07-29 17:27</div>
            <div class="timeline-body"><p>An SVG of the flow diagram should show up in the diff review, but here&#x27;s where you can see it directly:</p>
<p>https://github.com/astral-sh/ruff/blob/89ca1cc83b659eb6b6e43e944587954b4f7d0475/crates/ty_python_semantic/src/module_resolver/import-resolution-diagram.svg</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-29 17:28</div>
            <div class="timeline-body">

Diagnostic diff on typing conformance tests
<p>No changes detected when running ty on typing conformance tests âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-29 17:29</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected âœ…
No memory usage changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/module_resolver/import-resolution-diagram.dot</code>:85 on 2025-07-29 18:00</div>
            <div class="timeline-body"><p>one detail that the flowgraph doesn&#x27;t capture currently is that if it&#x27;s the standard-library search path then at every stage <em>only</em> <code>.pyi</code> files are considered (because something very strange is going on if typeshed has <code>.py</code> files in it!!). So here, if this was the standard-library search path, we&#x27;d only check to see if every parent package of <code>module_name</code> corresponds to a directory that contains an <code>__init__.pyi</code> file; we wouldn&#x27;t do the check for <code>__init__.py</code> files.</p>
<p>I&#x27;m not totally sure if it&#x27;s worth trying to add that detail to the flowgraph, because the flowgraph is already pretty complicated, but I thought I&#x27;d mention it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/module_resolver/import-resolution-diagram.dot</code>:1 on 2025-07-29 18:11</div>
            <div class="timeline-body"><p>This flowgraph is very nice, but I have some concerns about maintainability. There are significant features of the module resolver that we know we need to implement but have not yet:</p>
<ul>
<li>Currently we have no knowledge of C extensions, but ideally if a C extension was installed without any type stubs we wouldn&#x27;t say &quot;the module doesn&#x27;t exist&quot;, we&#x27;d say &quot;please go and install a stubs package so we can infer proper types when you import from this module&quot;. That&#x27;ll require refactoring <code>resolve_module</code> to return a <code>Result</code> rather than an <code>Option</code> so that we can distinguish between the different error cases</li>
<li>We don&#x27;t implement <code>py.typed</code> files with <code>partial</code> in them yet (if a stubs package is marked as <code>partial</code>, you&#x27;re meant to fallback to the runtime package if you can&#x27;t find a module in the stubs package)</li>
<li>@Gankra is adding another search path for the &quot;real&quot; (non-typeshed) standard library in <a href="https://github.com/astral-sh/ruff/pull/19529">astral-sh/ruff#19529</a>, so that we can implement go-to-definition jumping to the actual definition of a stdlib API rather than the type declaration in typeshed. That&#x27;s sort-of going to have the opposite semantics to the typeshed search path: whereas the typeshed search path is the one search path where we can guarantee that only <code>.pyi</code> files will ever exist, the &quot;real stdlib&quot; is the one search path where we can guarantee that only <code>.py</code> files will ever exist.</li>
</ul>
<p>This diagram could definitely help people adding these new features, but it also means they&#x27;ll have another task to complete as part of any one of those features: they&#x27;ll need to update the diagram! And I&#x27;m mostly worried that we&#x27;ll forget to keep it updated, leading to it growing stale</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/module_resolver/resolver.rs</code>:5 on 2025-07-29 18:13</div>
            <div class="timeline-body"><pre><code>usually want the former, unless you&#x27;re certain you want to forbid stubs,
in which case, use the latter.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/module_resolver/resolver.rs</code>:253 on 2025-07-29 18:15</div>
            <div class="timeline-body"><p>We&#x27;ve discussed this a few times since I originally added this TODO and I think we&#x27;re still on the fence as a team about whether this is something we actually want to do or not. Pyright does it, so language-server users may be expecting it; but vendoring these third-party stubs would increase the size of our binary, and possibly make it harder to reproduce type-checking results across machines. Mypy, and other type checkers that are not primarily designed to be good language servers, generally do not vendor these stubs.</p>
<p>TL;DR: let&#x27;s add some more doubt here ðŸ˜„</p>
<pre><code>        // TODO vendor typeshed&#x27;s third-party stubs as well as the stdlib and
        // fallback to them as a final step?
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/module_resolver/resolver.rs</code>:694 on 2025-07-29 18:17</div>
            <div class="timeline-body"><p>&quot;module path&quot; here would imply <code>foo/bar/baz</code> rather than <code>foo.bar.baz</code> to me</p>
<pre><code>/// `name` should be a complete non-empty module name e.g, `foo` or
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/module_resolver/resolver.rs</code>:699 on 2025-07-29 18:21</div>
            <div class="timeline-body"><p>Strictly speaking, all packages are modules (but not all modules are packages!)</p>
<pre><code>/// module: its kind (single-file module or package), the search path in which it was found
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-07-29 18:25</div>
            <div class="timeline-body"><p>Thank you!</p>
<p>I&#x27;m a little bit concerned that we&#x27;ll forget to update the flow diagram when making changes in the future. But I also might be overthinking it. I don&#x27;t want to block this from being landed if you think it will help future implementors of module-resolver features -- that&#x27;s definitely the most important aspect!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-07-29 18:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_python_semantic/src/module_resolver/import-resolution-diagram.dot</code>:85 on 2025-07-29 18:30</div>
            <div class="timeline-body"><p>Yeah I did actually notice that. But yeah it would make the flow graph much more complicated. <em>And</em> I interpreted this as a implementation detail for perf reasons. i.e., If you did check to <code>.py</code> in std paths, would the correctness change? I tried to leave optimizations out of the flow graph. Another one I left out was the std check here:</p>
<p>https://github.com/astral-sh/ruff/blob/656273bf3d51125911991dc15903606705acf269/crates/ty_python_semantic/src/module_resolver/resolver.rs#L712-L737</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-07-29 18:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_python_semantic/src/module_resolver/import-resolution-diagram.dot</code>:1 on 2025-07-29 18:33</div>
            <div class="timeline-body"><p>Yeah that&#x27;s definitely valid. That&#x27;s always the problem with docs. :-) I don&#x27;t think there is a feasible means of doing a machine check here, so this is just something we humans will have to maintain. If it ends up going unmaintained, then we can delete it under the reasoning that it has outlived its usefulness. But I still think it&#x27;s an important stepping stone to adding what is likely to be a distinct implementation of these semantics via a different access pattern.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-07-29 18:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_python_semantic/src/module_resolver/resolver.rs</code>:253 on 2025-07-29 18:36</div>
            <div class="timeline-body"><p>Haha fair enough, done. I also linked to this comment. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-07-29 18:49</div>
            <div class="timeline-body"><p>@MichaReiser Happy to address any follow-ups if you have them!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-07-29 18:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-07-29 18:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-29 18:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-29 18:57</div>
            <div class="timeline-body"><p>Oh, one significant detail not covered in the flow diagram is the fact that for the standard library, we will return <code>None</code> from <code>resolve_module</code> <em>even if</em> the module exists in the vendored zip file according to the normal rules if typeshed&#x27;s <code>VERSIONS</code> file indicates that the module doesn&#x27;t exist on the user&#x27;s configured Python version</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-07-29 19:04</div>
            <div class="timeline-body"><p>@AlexWaygood Ah I see, interesting. That&#x27;s something I legitimately missed. It looks like it&#x27;s primarily implemented in the <code>ModulePath</code> routines. I&#x27;ll work it into the flow diagram. (I also think I should be able to reuse <code>ModulePath</code> in the &quot;list modules&quot; implementation.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-29 20:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> removed by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-29 20:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-07-30 13:45</div>
            <div class="timeline-body"><p>I opened <a href="https://github.com/astral-sh/ruff/pull/19638">astral-sh/ruff#19638</a> to account for <code>VERSIONS</code> in typeshed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-30 13:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-30 13:57</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:17:09 UTC
    </footer>
</body>
</html>
