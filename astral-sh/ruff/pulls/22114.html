<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`ruff`] Detect duplicate entries in `__all__` (`RUF068`) - astral-sh/ruff #22114</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>ruff</code>] Detect duplicate entries in <code>__all__</code> (<code>RUF068</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22114">#22114</a>
        opened by <a href="https://github.com/leandrobbraga">@leandrobbraga</a>
        on 2025-12-20 15:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/leandrobbraga">@leandrobbraga</a></div>
            <div class="timeline-body"><p>Hello,</p>
<p>This MR adds a new rule and its fix, <code>RUF069</code>, <code>DuplicateEntryInDunderAll</code>. I&#x27;m using <code>RUF069</code> because we already have <a href="https://github.com/astral-sh/ruff/pull/20585">RUF068</a> and <a href="https://github.com/astral-sh/ruff/pull/21079#issuecomment-3493839453">RUF069</a> in the works.</p>
<p>The rule job is to prevent users from accidentally adding duplicate entries to <code>__all__</code>, which, for example, can result from copy-paste mistakes.</p>
<p>It deals with the following syntaxes:</p>
<pre><code>__all__: list[str] = [&quot;a&quot;, &quot;a&quot;]
__all__: typing.Any = (&quot;a&quot;, &quot;a&quot;)
__all__.extend([&quot;a&quot;, &quot;a&quot;])
__all__ += [&quot;a&quot;, &quot;a&quot;]
</code></pre>
<p>But it does not keep track of <code>__all__</code> contents, meaning the following code snippet is a false negative:</p>
<pre><code>class A: ...

__all__ = [&quot;A&quot;]
__all__.extend([&quot;A&quot;])
</code></pre>
Violation Example
<pre><code>RUF069 `__all__` contains duplicate entries
 --&gt; RUF069.py:2:17
  |
1 | __all__ = [&quot;A&quot;, &quot;A&quot;, &quot;B&quot;]
  |                 ^^^
help: Remove duplicate entries from `__all__`
1 | __all__ = [&quot;A&quot;, &quot;B&quot;]
  - __all__ = [&quot;A&quot;, &quot;A&quot;, &quot;B&quot;]
</code></pre>
Ecosystem Report
<p>The <code>ruff-ecosystem</code> results contain seven violations in four projects, all of them seem like true positives, with one instance appearing to be an actual bug.</p>
<p>This <a href="https://github.com/python/typeshed/blob/90d855985be5aae9bc76e77b0f3d4b6738c38347/stubs/reportlab/reportlab/lib/rltempfile.pyi#L4">code snippet</a> from <code>reportlab</code> contains the same entry twice instead of exporting both functions.</p>
<pre><code>def get_rl_tempdir(*subdirs: str) -&gt; str: ...
def get_rl_tempfile(fn: str | None = None) -&gt; str: ...

__all__ = (&quot;get_rl_tempdir&quot;, &quot;get_rl_tempdir&quot;)
</code></pre>
<p>Closes <a href="https://github.com/astral-sh/ruff/issues/21945">#21945</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-20 15:47</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>‚úÖ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>‚ÑπÔ∏è ecosystem check <strong>detected linter changes</strong>. (+7 -0 violations, +0 -0 fixes in 4 projects; 51 projects unchanged)</p>
<a href="https://github.com/bokeh/bokeh">bokeh/bokeh</a> (+1 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --no-fix --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/core/query.py#L53">src/bokeh/core/query.py:53:5:</a> RUF068 [*] `__all__` contains duplicate entries: `find` duplicated here
</pre>

</p>

<a href="https://github.com/langchain-ai/langchain">langchain-ai/langchain</a> (+2 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/langchain-ai/langchain/blob/a84722e2d768a3029a632d0ab3515b897ebba63b/libs/langchain/langchain_classic/document_loaders/__init__.py#L373">libs/langchain/langchain_classic/document_loaders/__init__.py:373:5:</a> RUF068 [*] `__all__` contains duplicate entries: `AcreomLoader` duplicated here
+ <a href="https://github.com/langchain-ai/langchain/blob/a84722e2d768a3029a632d0ab3515b897ebba63b/libs/langchain/langchain_classic/document_loaders/__init__.py#L391">libs/langchain/langchain_classic/document_loaders/__init__.py:391:5:</a> RUF068 [*] `__all__` contains duplicate entries: `AsyncHtmlLoader` duplicated here
</pre>

</p>

<a href="https://github.com/python/typeshed">python/typeshed</a> (+3 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --no-fix --output-format concise --preview --select E,F,FA,I,PYI,RUF,UP,W</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/python/typeshed/blob/b94c9e8e48f552b2f2b979b69937b0e4848675cf/stubs/convertdate/convertdate/__init__.pyi#L45">stubs/convertdate/convertdate/__init__.pyi:45:5:</a> RUF068 [*] `__all__` contains duplicate entries: `mayan` duplicated here
+ <a href="https://github.com/python/typeshed/blob/b94c9e8e48f552b2f2b979b69937b0e4848675cf/stubs/reportlab/reportlab/lib/rltempfile.pyi#L4">stubs/reportlab/reportlab/lib/rltempfile.pyi:4:30:</a> RUF068 [*] `__all__` contains duplicate entries: `get_rl_tempdir` duplicated here
+ <a href="https://github.com/python/typeshed/blob/b94c9e8e48f552b2f2b979b69937b0e4848675cf/stubs/workalendar/workalendar/europe/__init__.pyi#L252">stubs/workalendar/workalendar/europe/__init__.pyi:252:5:</a> RUF068 [*] `__all__` contains duplicate entries: `Switzerland` duplicated here
</pre>

</p>

<a href="https://github.com/astropy/astropy">astropy/astropy</a> (+1 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/astropy/astropy/blob/b5754a667932b7c39b5f425abb2de77a7962fa9c/astropy/table/__init__.py#L32">astropy/table/__init__.py:32:5:</a> RUF068 [*] `__all__` contains duplicate entries: `conf` duplicated here
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| RUF068 | 7 | 7 | 0 | 0 | 0 |</p>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/leandrobbraga">@leandrobbraga</a> on 2025-12-20 16:29</div>
            <div class="timeline-body"><p>It seems that those are all true positives.</p>
<p>This one might even be a bug.
https://github.com/python/typeshed/blob/06ecffccc72423711137c07be80c90522c084bbe/stubs/reportlab/reportlab/lib/rltempfile.pyi#L1-L4</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chirizxc">@chirizxc</a> on 2025-12-21 09:31</div>
            <div class="timeline-body"><p>What about these cases?</p>
<pre><code>import typing


class A: ...


class B: ...

__all__ = &quot;A&quot; + &quot;B&quot;
__all__: list[str] = [&quot;A&quot;, &quot;B&quot;]
__all__: typing.Any = (&quot;A&quot;, &quot;B&quot;)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/chirizxc">@chirizxc</a> reviewed on 2025-12-21 09:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/chirizxc">@chirizxc</a> on <code>crates/ruff_linter/src/rules/ruff/rules/duplicate_all_entry.rs</code>:1 on 2025-12-21 09:35</div>
            <div class="timeline-body"><p>maybe <code>use rustc_hash::FxHashSet;</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/leandrobbraga">@leandrobbraga</a> on 2025-12-21 09:44</div>
            <div class="timeline-body"><blockquote>
<p>What about these cases?</p>
<pre><code>import typing


class A: ...


class B: ...

__all__ = &quot;A&quot; + &quot;B&quot;
__all__: list[str] = [&quot;A&quot;, &quot;B&quot;]
__all__: typing.Any = (&quot;A&quot;, &quot;B&quot;)
</code></pre>
</blockquote>
<p>Do you want to test whether those situations produce false positives or whether it still catches duplicates when using tuples, concatenation and/or type annotations?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chirizxc">@chirizxc</a> on 2025-12-21 09:46</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>What about these cases?</p>
<pre><code>import typing


class A: ...


class B: ...

__all__ = &quot;A&quot; + &quot;B&quot;
__all__: list[str] = [&quot;A&quot;, &quot;B&quot;]
__all__: typing.Any = (&quot;A&quot;, &quot;B&quot;)
</code></pre>
</blockquote>
<p>Do you want to test whether those situations produce false positives or whether it still catches duplicates when using tuples, concatenation and/or type annotations?</p>
</blockquote>
<p>I think it makes sense to add them to the test cases</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/leandrobbraga">@leandrobbraga</a> reviewed on 2025-12-21 13:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/leandrobbraga">@leandrobbraga</a> on <code>crates/ruff_linter/src/rules/ruff/rules/duplicate_all_entry.rs</code>:1 on 2025-12-21 13:55</div>
            <div class="timeline-body"><p>Done as suggested</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/leandrobbraga">@leandrobbraga</a> on 2025-12-21 13:56</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<blockquote>
<p>What about these cases?</p>
<pre><code>import typing


class A: ...


class B: ...

__all__ = &quot;A&quot; + &quot;B&quot;
__all__: list[str] = [&quot;A&quot;, &quot;B&quot;]
__all__: typing.Any = (&quot;A&quot;, &quot;B&quot;)
</code></pre>
</blockquote>
<p>Do you want to test whether those situations produce false positives or whether it still catches duplicates when using tuples, concatenation and/or type annotations?</p>
</blockquote>
<p>I think it makes sense to add them to the test cases</p>
</blockquote>
<p>Added these cases as suggested</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/leandrobbraga">@leandrobbraga</a> on 2025-12-21 14:08</div>
            <div class="timeline-body"><p>I added some extra cases, based on RUF022:</p>
<pre><code>__all__: list[str] = [&quot;a&quot;, &quot;a&quot;]
__all__: typing.Any = (&quot;a&quot;, &quot;a&quot;)
__all__.extend([&quot;a&quot;, &quot;a&quot;])
__all__ += [&quot;a&quot;, &quot;a&quot;]
</code></pre>
<p>It still does not track mutable <code>__all__</code>, example:</p>
<pre><code>__all__ = [&quot;a&quot;]
__all__ += [&quot;a&quot;]
</code></pre>
<p>This will be a false negative.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/chirizxc">@chirizxc</a> by <a href="https://github.com/leandrobbraga">@leandrobbraga</a> on 2025-12-21 17:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chirizxc">@chirizxc</a> on 2025-12-21 17:33</div>
            <div class="timeline-body"><p>LGTM.</p>
<p>There may be other cases, but again, we cannot check dynamically created <code>__all__</code>, and we can only look at one file at a time, so if someone decides to add a duplicate in another file, we will not be able to detect it.</p>
<p>I also think it&#x27;s worth adding <code>RUF069.pyi</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/leandrobbraga">@leandrobbraga</a> on 2025-12-21 19:47</div>
            <div class="timeline-body"><blockquote>
<p>LGTM.</p>
<p>There may be other cases, but again, we cannot check dynamically created <code>__all__</code>, and we can only look at one file at a time, so if someone decides to add a duplicate in another file, we will not be able to detect it.</p>
<p>I also think it&#x27;s worth adding <code>RUF069.pyi</code>.</p>
</blockquote>
<p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/chirizxc">@chirizxc</a> removed by <a href="https://github.com/ntBre">@ntBre</a> on 2025-12-23 14:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/ntBre">@ntBre</a> by <a href="https://github.com/ntBre">@ntBre</a> on 2025-12-23 14:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2026-01-01 15:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2026-01-01 15:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">great writeup</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2026-01-01 15:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/duplicate_all_entry.rs</code>:89 on 2026-01-01 16:15</div>
            <div class="timeline-body"><p>I think if you use <code>&amp;**func</code> like in <code>args</code> and <code>keywords</code> above you can avoid the <code>ref</code>s here, but either way is fine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/duplicate_all_entry.rs</code>:157 on 2026-01-01 16:28</div>
            <div class="timeline-body"><p>I think we should try to inspect the tokens instead of doing this text manipulation. I think we could use something like <code>SimpleTokenizer::starts_at(range.end(), checker.source()).skip_trivia().next()</code> to find the trailing comma. That&#x27;s similar to what we do in this rule:</p>
<p>https://github.com/astral-sh/ruff/blob/b2b9d91859f2abc017e35d22f01696f141f6f5b1/crates/ruff_linter/src/rules/flake8_bugbear/rules/duplicate_value.rs#L82-L91</p>
<p>Actually that whole function would almost work here. It might be worth making that a helper function that just takes a <code>&amp;[Expr]</code> since it really only uses <code>set.elts</code> (even <code>set.len()</code> defers to the length of <code>elts</code>).</p>
<p>The helper could go in this file maybe:</p>
<p>https://github.com/astral-sh/ruff/blob/b2b9d91859f2abc017e35d22f01696f141f6f5b1/crates/ruff_linter/src/fix/edits.rs#L272</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/duplicate_all_entry.rs</code>:167 on 2026-01-01 16:29</div>
            <div class="timeline-body"><p>Small nit, but the usual pattern we use here is something like:</p>
<pre><code>            let applicability = if checker.comment_ranges().intersects(fix_range) {
                Applicability::Unsafe
            } else {
                Applicability::Safe
            };
            
            diagnostic.set_fix(Fix::applicable_edit(edit, applicability));
</code></pre>
<p>or you could inline the applicability too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/duplicate_entry_in_dunder_all.rs</code>:154 on 2026-01-01 16:33</div>
            <div class="timeline-body"><p>Do we need to check this before iterating over the elements and starting to emit diagnostics? Based on the comment, it sounds like we should, but it also seems like we could actually just <code>continue</code> here. It should be okay to emit diagnostics in this case right?</p>
<pre><code>__all__ = [
	foo,
	&quot;bar&quot;,
	&quot;bar&quot;,  # RUF069
]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/snapshots/ruff_linter__rules__ruff__tests__RUF069_RUF069.py.snap</code>:196 on 2026-01-01 16:35</div>
            <div class="timeline-body"><p>We shouldn&#x27;t append this comma to the comment. Hopefully the token approach will help with this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF069.pyi</code>:1 on 2026-01-01 16:36</div>
            <div class="timeline-body"><p>Just curious, what&#x27;s the benefit of including the <code>.pyi</code> version? I don&#x27;t think the rule has any stub-specific behavior right? Maybe it was just to check that it runs on stubs?</p>
<p>cc @chirizxc</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF068.py</code>:23 on 2026-01-01 16:38</div>
            <div class="timeline-body"><p>Let&#x27;s throw in one multi-line case without comments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/duplicate_entry_in_dunder_all.rs</code>:1 on 2026-01-01 16:39</div>
            <div class="timeline-body"><p>Small nit, and this might just be me, but I often expect the file name to match the struct name exactly, so could we rename the file to <code>duplicate_entry_in_dunder_all.rs</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/duplicate_entry_in_dunder_all.rs</code>:49 on 2026-01-01 16:48</div>
            <div class="timeline-body"><p>We should add a <code>## Fix safety</code> section explaining the unsafety around comments. We may also want to double-check the comment range check. I don&#x27;t think the existing test case actually deletes comments. I think the only way we could delete a comment is in a highly contrived case like:</p>
<pre><code>__all__ = [
	&quot;a&quot;,
	&quot;a&quot;
	# comment
	,
	&quot;b&quot;
]
</code></pre>
<p>since we need to delete both the second <code>&quot;a&quot;</code> and its trailing comma.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> requested changes on 2026-01-01 16:51</div>
            <div class="timeline-body"><p>Thank you! This looks great overall, and the summary was really helpful.</p>
<p>Thanks @chirizxc for the rule suggestion and the reviews, as well.</p>
<p>My main concern was with the fix, but all of my other comments are very minor.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/chirizxc">@chirizxc</a> reviewed on 2026-01-01 17:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/chirizxc">@chirizxc</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF069.pyi</code>:1 on 2026-01-01 17:23</div>
            <div class="timeline-body"><p>Yes, there will be nothing like that in <code>.pyi</code> if the duplicate remains, but I think it&#x27;s useful to check this, since duplicates were most likely added as a result of IDE autocompletion, or in large files where <code>__all__</code> can be 100-200 lines or more. In any case, it&#x27;s something like a typo check.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2026-01-01 17:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF069.pyi</code>:1 on 2026-01-01 17:28</div>
            <div class="timeline-body"><p>Oh sorry, I didn&#x27;t phrase my question very well. I think most of our rules apply to both <code>py</code> and <code>pyi</code> files, so I was thinking it might be okay to remove the duplicate tests in this <code>pyi</code> file (remove this file) since there&#x27;s no stub-specific functionality being tested.</p>
<p>I agree that the rule should apply to stubs, just wondering if we can reduce the number of identical tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/chirizxc">@chirizxc</a> reviewed on 2026-01-01 17:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/chirizxc">@chirizxc</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF069.pyi</code>:1 on 2026-01-01 17:31</div>
            <div class="timeline-body"><p>Yes, I think we can remove the tests for <code>.pyi</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2026-01-01 17:32</div>
            <div class="timeline-body"><blockquote>
<p>I also think it&#x27;s worth adding a check for <code>__all__.append()</code>. If we look at the <a href="https://github.com/search?q=__all__.append&amp;type=code">code search on GitHub</a>, there are 21,000 matches. ü§î</p>
<p>@ntBre what do you think about this?</p>
</blockquote>
<p>@chirizxc I think it&#x27;s tricky to check <code>.append</code> because we&#x27;d have to keep internal state on <code>__all__</code> values we&#x27;ve seen so far. There&#x27;s not really a good way to do that with the current structure of the rule, which only sees one statement/expression at a time. I&#x27;m okay with leaving it out of the rule, especially in a first version.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/leandrobbraga">@leandrobbraga</a> on <code>crates/ruff_linter/src/rules/ruff/rules/duplicate_all_entry.rs</code>:157 on 2026-01-11 14:34</div>
            <div class="timeline-body"><p>The <code>remove_member</code> implementation does not account for comments, removing them together with the element, which means that B033 also deletes them.</p>
<p>This changed the snapshot from:</p>
<pre><code>RUF069 [*] `__all__` contains duplicate entries
  --&gt; RUF069.py:33:5
   |
31 |     &quot;B&quot;,
32 |     # Comment
33 |     &quot;B&quot;,
   |     ^^^
34 | ]
   |
help: Remove duplicate entries from `__all__`
29 |     &quot;A&quot;,
30 |     &quot;A&quot;,
31 |     &quot;B&quot;,
   -     # Comment
   -     &quot;B&quot;,
32 +     # Comment,
33 | ]
note: This is an unsafe fix and may change runtime behavior
</code></pre>
<p>to</p>
<pre><code>RUF069 [*] `__all__` contains duplicate entries
  --&gt; RUF069.py:33:5
   |
31 |     &quot;B&quot;,
32 |     # Comment
33 |     &quot;B&quot;,
   |     ^^^
34 | ]
   |
help: Remove duplicate entries from `__all__`
29 |     &quot;A&quot;,
30 |     &quot;A&quot;,
31 |     &quot;B&quot;,
   -     # Comment
   -     &quot;B&quot;,
32 | ]
note: This is an unsafe fix and may change runtime behavior
</code></pre>
<p>Are you okay with that or should we strive to keep the comment, changing the behavior for B033 and RUF069?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/leandrobbraga">@leandrobbraga</a> reviewed on 2026-01-11 14:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/leandrobbraga">@leandrobbraga</a> reviewed on 2026-01-11 14:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/leandrobbraga">@leandrobbraga</a> on <code>crates/ruff_linter/src/rules/ruff/rules/duplicate_all_entry.rs</code>:157 on 2026-01-11 14:36</div>
            <div class="timeline-body"><p><strong>Out of scope</strong>: I&#x27;ve noticed a few other instances of text manipulation for deletion, from where I took initial inspiration:
https://github.com/astral-sh/ruff/blob/b2b9d91859f2abc017e35d22f01696f141f6f5b1/crates/ty_python_semantic/src/suppression/unused.rs#L135-L165</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/leandrobbraga">@leandrobbraga</a> on 2026-01-11 15:04</div>
            <div class="timeline-body"><p>I‚Äôve addressed all the remarks, improved the documentation and bumped the version.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/ntBre">@ntBre</a> by <a href="https://github.com/leandrobbraga">@leandrobbraga</a> on 2026-01-11 15:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/duplicate_entry_in_dunder_all.rs</code>:170 on 2026-01-12 21:22</div>
            <div class="timeline-body"><p>I think we should be able to use <a href="https://github.com/astral-sh/ruff/blob/e4ba29392bb768965ba16ba86aba7d482e4f2ea8/crates/ruff_linter/src/checkers/ast/mod.rs#L3538"><code>try_set_fix</code></a> here, which will automatically log this error if it fails.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/duplicate_entry_in_dunder_all.rs</code>:13 on 2026-01-12 21:24</div>
            <div class="timeline-body"><p>I think this was actually okay before the latest revision since the rule may be used without <code>--fix</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF069.py</code>:32 on 2026-01-12 21:31</div>
            <div class="timeline-body"><p>Can we add an end-of-line comment too? And maybe one after the deleted element, just to check which comments get deleted.</p>
<pre><code>    &quot;B&quot;,  # 2
    # 3
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/duplicate_entry_in_dunder_all.rs</code>:10 on 2026-01-12 21:32</div>
            <div class="timeline-body"><p>tiny nit:</p>
<pre><code>use rustc_hash::{FxBuildHasher, FxHashSet};

use ruff_diagnostics::{Applicability, Fix};
use ruff_macros::{ViolationMetadata, derive_message_formats};
use ruff_python_ast as ast;
use ruff_text_size::Ranged;

use crate::checkers::ast::Checker;
use crate::fix::edits;
use crate::{FixAvailability, Violation};
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/duplicate_entry_in_dunder_all.rs</code>:154 on 2026-01-12 21:36</div>
            <div class="timeline-body"><p>Let&#x27;s add a test for a case like this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/duplicate_entry_in_dunder_all.rs</code>:158 on 2026-01-12 21:38</div>
            <div class="timeline-body"><p>tiny nit:</p>
<pre><code>            let mut diagnostic = checker.report_diagnostic(DuplicateEntryInDunderAll, expr);
</code></pre>
<p><code>expr</code> implements <code>Ranged</code>, which should make it a valid argument on its own, as long as I&#x27;m not missing another reference to <code>range</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/duplicate_all_entry.rs</code>:157 on 2026-01-12 21:40</div>
            <div class="timeline-body"><p>Yes, removing that comment is okay. That&#x27;s what makes the fix unsafe, though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2026-01-12 21:45</div>
            <div class="timeline-body"><p>Thank you! This is looking great. I just had a few more very small nits, and a couple of suggestions about additional tests (but I think they&#x27;ll be handled well already).</p>
<p>I also think it might be worth manually testing the CLI to make sure cases with multiple deletions in the same assignment are fixed correctly. I think they should be, but we have a mechanism to <a href="https://github.com/astral-sh/ruff/blob/e4ba29392bb768965ba16ba86aba7d482e4f2ea8/crates/ruff_diagnostics/src/fix.rs#L168"><code>isolate</code></a> fixes if we need it. I think just testing something like:</p>
<pre><code>$ cargo run -p ruff -- check --preview --select RUF069 --fix - &lt;&lt;&lt;&#x27;__all__ = [&quot;A&quot;, &quot;A&quot;, &quot;B&quot;, &quot;B&quot;]&#x27;
</code></pre>
<p>should work. If it <em>doesn&#x27;t</em> work, we should add an actual CLI test, but I think it&#x27;s okay as long as the manual test works as expected.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2026-01-13 08:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/snapshots/ruff_linter__rules__ruff__tests__RUF069_RUF069.py.snap</code>:9 on 2026-01-13 08:31</div>
            <div class="timeline-body"><p>It would be nice if we highlighted all definitions here, so that users don&#x27;t need to scan the entire list to find the first definition, similar to what we do in ty</p>
<pre><code>error[duplicate-base]: Duplicate base class `int`
 --&gt; simple.py:1:7
  |
1 | class Test(int, str, int): ...
  |       ^^^^^^^^^^^^^^^^^^^
  |
info: The definition of class `Test` will raise `TypeError` at runtime
 --&gt; simple.py:1:12
  |
1 | class Test(int, str, int): ...
  |            ---       ^^^ Class `int` later repeated here
  |            |
  |            Class `int` first included in bases list here
  |
info: rule `duplicate-base` is enabled by default
</code></pre>
<p>(except that I wouldn&#x27;t highlight the entire definition)</p>
<p>You can accomplish this by adding a secondary diagnostic annotation</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2026-01-13 20:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/snapshots/ruff_linter__rules__ruff__tests__RUF069_RUF069.py.snap</code>:9 on 2026-01-13 20:48</div>
            <div class="timeline-body"><p>Link to the secondary annotation helper for reference:</p>
<p>https://github.com/astral-sh/ruff/blob/2245355931f66def488809a6b9b784f7c294bd49/crates/ruff_linter/src/checkers/ast/mod.rs#L3309-L3311</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/leandrobbraga">@leandrobbraga</a> on 2026-01-14 23:43</div>
            <div class="timeline-body"><blockquote>
<p>Thank you! This is looking great. I just had a few more very small nits, and a couple of suggestions about additional tests (but I think they&#x27;ll be handled well already).</p>
<p>I also think it might be worth manually testing the CLI to make sure cases with multiple deletions in the same assignment are fixed correctly. I think they should be, but we have a mechanism to <a href="https://github.com/astral-sh/ruff/blob/e4ba29392bb768965ba16ba86aba7d482e4f2ea8/crates/ruff_diagnostics/src/fix.rs#L168"><code>isolate</code></a> fixes if we need it. I think just testing something like:</p>
<pre><code>$ cargo run -p ruff -- check --preview --select RUF069 --fix - &lt;&lt;&lt;&#x27;__all__ = [&quot;A&quot;, &quot;A&quot;, &quot;B&quot;, &quot;B&quot;]&#x27;
</code></pre>
<p>should work. If it <em>doesn&#x27;t</em> work, we should add an actual CLI test, but I think it&#x27;s okay as long as the manual test works as expected.</p>
</blockquote>
<p>It does work:</p>
<pre><code>$ cargo run -p ruff -- check --preview --select RUF069 --fix - &lt;&lt;&lt;&#x27;__all__ = [&quot;A&quot;, &quot;A&quot;, &quot;B&quot;, &quot;B&quot;]&#x27;
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 8.98s
     Running `target/debug/ruff check --preview --select RUF069 --fix -`
warning: Detected debug build without --no-cache.
__all__ = [&quot;A&quot;, &quot;B&quot;]
Found 2 errors (2 fixed, 0 remaining).
</code></pre>
<p>I also have tested it in the <a href="https://github.com/astral-sh/ruff/pull/22114/changes#diff-c23d55609dc272d6a87875a04cb84bfcc9ee07964e1bbb101b2506c6318e48cf">crates/ruff_linter/resources/test/fixtures/ruff/RUF069.py</a> file and the fix works flawless.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/leandrobbraga">@leandrobbraga</a> on <code>crates/ruff_linter/src/rules/ruff/snapshots/ruff_linter__rules__ruff__tests__RUF069_RUF069.py.snap</code>:9 on 2026-01-15 00:28</div>
            <div class="timeline-body"><p>What do you think about this?</p>
<pre><code>$ cargo run -p ruff -- check --preview --select RUF069 - &lt;&lt;&lt;&#x27;__all__ = [&quot;A&quot;, &quot;A&quot;, &quot;B&quot;, &quot;B&quot;]&#x27;
RUF069 [*] `__all__` contains duplicate entries
 --&gt; -:1:12
  |
1 | __all__ = [&quot;A&quot;, &quot;A&quot;, &quot;B&quot;, &quot;B&quot;]
  |            ---  ^^^ `A` duplicated here
  |            |
  |            previous occurrence of `A` here
  |
help: Remove duplicate entries from `__all__`
  - __all__ = [&quot;A&quot;, &quot;A&quot;, &quot;B&quot;, &quot;B&quot;]
1 + __all__ = [&quot;A&quot;, &quot;B&quot;, &quot;B&quot;]

RUF069 [*] `__all__` contains duplicate entries
 --&gt; -:1:22
  |
1 | __all__ = [&quot;A&quot;, &quot;A&quot;, &quot;B&quot;, &quot;B&quot;]
  |                      ---  ^^^ `B` duplicated here
  |                      |
  |                      previous occurrence of `B` here
  |
help: Remove duplicate entries from `__all__`
  - __all__ = [&quot;A&quot;, &quot;A&quot;, &quot;B&quot;, &quot;B&quot;]
1 + __all__ = [&quot;A&quot;, &quot;A&quot;, &quot;B&quot;]

Found 2 errors.
[*] 2 fixable with the `--fix` option.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/leandrobbraga">@leandrobbraga</a> reviewed on 2026-01-15 00:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/leandrobbraga">@leandrobbraga</a> on 2026-01-15 00:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/ntBre">@ntBre</a> by <a href="https://github.com/leandrobbraga">@leandrobbraga</a> on 2026-01-15 00:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/leandrobbraga">@leandrobbraga</a> on 2026-01-15 00:38</div>
            <div class="timeline-body"><p>I should have addressed all concerns now, sorry for the delay</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/chirizxc">@chirizxc</a> by <a href="https://github.com/leandrobbraga">@leandrobbraga</a> on 2026-01-15 00:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chirizxc">@chirizxc</a> on 2026-01-15 14:10</div>
            <div class="timeline-body"><p>In general, it seems that we also have <a href="https://github.com/astral-sh/ruff/blob/main/crates/ruff_linter/src/rules/ruff/rules/sort_dunder_all.rs">code</a> that repeats in this rule. Should we move some functions to helpers and reuse them?</p>
<p>Do something like this:</p>
<pre><code>pub(crate) fn all_assignment&lt;F&gt;(
    checker: &amp;Checker,
    target: &amp;ast::Expr,
    value: &amp;ast::Expr,
    call: F,
) where
    F: FnOnce(&amp;Checker, &amp;[ast::Expr]),
{

    let ast::Expr::Name(ast::ExprName { id, .. }) = target else {
        return;
    };

    if id != &quot;__all__&quot; {
        return;
    }

    if !checker.semantic().current_scope().kind.is_module() {
        return
    }

    let elts = match value {
        ast::Expr::List(ast::ExprList { elts, .. }) =&gt; elts,
        ast::Expr::Tuple(ast::ExprTuple { elts, .. }) =&gt; elts,
        _ =&gt; return,
    };

    call(checker, elts);
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chirizxc">@chirizxc</a> on 2026-01-15 14:14</div>
            <div class="timeline-body"><p>It is possible to leave it as it is. However, if we decide to add more checks to the rule in the future, for example, to track <code>.append()</code>, we will have to change the code, and moving it to helpers may not be that useful.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/leandrobbraga">@leandrobbraga</a> on 2026-01-15 22:18</div>
            <div class="timeline-body"><blockquote>
<p>In general, it seems that we also have <a href="https://github.com/astral-sh/ruff/blob/main/crates/ruff_linter/src/rules/ruff/rules/sort_dunder_all.rs">code</a> that repeats in this rule. Should we move some functions to helpers and reuse them?</p>
<p>Do something like this:</p>
<pre><code>pub(crate) fn all_assignment&lt;F&gt;(
    checker: &amp;Checker,
    target: &amp;ast::Expr,
    value: &amp;ast::Expr,
    call: F,
) where
    F: FnOnce(&amp;Checker, &amp;[ast::Expr]),
{

    let ast::Expr::Name(ast::ExprName { id, .. }) = target else {
        return;
    };

    if id != &quot;__all__&quot; {
        return;
    }

    if !checker.semantic().current_scope().kind.is_module() {
        return
    }

    let elts = match value {
        ast::Expr::List(ast::ExprList { elts, .. }) =&gt; elts,
        ast::Expr::Tuple(ast::ExprTuple { elts, .. }) =&gt; elts,
        _ =&gt; return,
    };

    call(checker, elts);
}
</code></pre>
</blockquote>
<p>I guess we can defer this to later and have an specific MR for refactors.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2026-01-15 23:04</div>
            <div class="timeline-body"><p>Yeah I think this is probably okay. I&#x27;ll try to take another look tomorrow!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2026-01-16 08:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/snapshots/ruff_linter__rules__ruff__tests__RUF069_RUF069.py.snap</code>:9 on 2026-01-16 08:53</div>
            <div class="timeline-body"><p>This looks nice</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF069.py</code>:15 on 2026-01-16 19:01</div>
            <div class="timeline-body"><p>I think this is actually what I meant in <a href="https://github.com/astral-sh/ruff/pull/22114">astral-sh/ruff#22114</a>#discussion_r2656477043:</p>
<pre><code>__all__ = [A, &quot;B&quot;, &quot;B&quot;]
</code></pre>
<p>Sorry for being quite pedantic, I just want to have one test case for the <code>continue</code> vs <code>return</code> choice.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2026-01-16 19:49</div>
            <div class="timeline-body"><p>Very nice, thank you!</p>
<p>I pushed a couple of commits applying my last test suggestion and re-coding the rule to avoid a gap at <code>RUF068</code>, but this is great.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[ruff] Add RUF069 to detect duplicate entries in __all__&quot; to &quot;[`ruff`] Detect duplicate entries in `__all__` (`RUF068`)&quot; by <a href="https://github.com/ntBre">@ntBre</a> on 2026-01-16 19:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2026-01-16 19:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_bugbear/rules/duplicate_value.rs</code>:74 on 2026-01-16 19:54</div>
            <div class="timeline-body"><p>I&#x27;ll open a follow-up issue for this since it&#x27;s not related to your PR, but this shouldn&#x27;t always be a safe fix either:</p>
<pre><code>‚ùØ cat &lt;&lt;EOF | ruff check --diff --select B033 -
‚àô {1, 2, 3,
# comment
1}
‚àô EOF
@@ -1,3 +1 @@
-{1, 2, 3,
-# comment
-1}
+{1, 2, 3}

Would fix 1 error.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/ntBre">@ntBre</a> on 2026-01-16 19:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/ntBre">@ntBre</a> on 2026-01-16 19:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2026-01-16 20:14</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:22:02 UTC
    </footer>
</body>
</html>
