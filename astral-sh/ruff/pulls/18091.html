<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Deterministic ordering of types - astral-sh/ruff #18091</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Deterministic ordering of types</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18091">#18091</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-05-14 10:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-14 10:06</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Our type ordering/normalization previously relied on <code>PartialOrd</code>/<code>Ord</code> instances that were auto-generated for <code>salsa::interned</code> structs. These implementations compare by salsa ID, which is not necessarily deterministic (depends on <em>when</em> a particular type has been interned, and can therefore depend on file checking order).</p>
<p>Besides not being deterministic, it was also incorrect. When comparing two equal unions <code>A1 | B1</code> and <code>A2 | B2</code>, it was possible for one union to be ordered incorrectly (e.g. if both <code>A1</code> and <code>B1</code> were interned nominal instances), leading to incorrect type-relation results.</p>
<p>Writing these <code>ordering</code> functions by hand is exhausting and error-prone. This is why I only went so far as to fix the linked bug. Much more work would be involved to implement this for structs like <code>FunctionType</code> or <code>CallableType</code>. We should probably look into auto-generating these methods somehow?</p>
<p>Related <a href="https://salsa.zulipchat.com/#narrow/channel/333573-Contributing-to-Salsa/topic/Remove.20.60PartialOrd.60.20and.20.60Ord.60.20derives/with/518011061">salsa discussion</a></p>
<p>fixes https://github.com/astral-sh/ty/issues/369</p>
<h2>Test Plan</h2>
<p>Ran the following command for a while and saw no flaky behavior (on the MRE from the linked ticket):</p>
<pre><code class="language-bash">while true; do ~/.cargo-target/release/ty check --output-format concise 2&gt;&amp;1 | rg '(Found|checks)'; done
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @sharkdp on 2025-05-14 10:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-05-14 11:55</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">hydra-zen (https://github.com/mit-ll-responsible-ai/hydra-zen)
- error[invalid-return-type] src/hydra_zen/wrapper/_implementations.py:945:16: Return type does not match returned value: expected `DataClass_`, found `@Todo(unsupported type[X] special form) | (((...) -&gt; Any) &amp; dict[Unknown, Unknown]) | (DataClass_ &amp; dict[Unknown, Unknown]) | (list[Any] &amp; dict[Unknown, Unknown]) | dict[Any, Any] | (((...) -&gt; Any) &amp; list[Unknown]) | (DataClass_ &amp; list[Unknown]) | list[Any] | (dict[Any, Any] &amp; list[Unknown])`
+ error[invalid-return-type] src/hydra_zen/wrapper/_implementations.py:945:16: Return type does not match returned value: expected `DataClass_`, found `@Todo(unsupported type[X] special form) | (((...) -&gt; Any) &amp; dict[Unknown, Unknown]) | (DataClass_ &amp; dict[Unknown, Unknown]) | (list[Any] &amp; dict[Unknown, Unknown]) | dict[Any, Any] | (((...) -&gt; Any) &amp; list[Unknown]) | (DataClass_ &amp; list[Unknown]) | list[Any]`
- error[type-assertion-failure] tests/annotations/declarations.py:956:5: Argument does not have asserted type `PBuilds[@Todo(Support for `typing.TypeAlias`)] | StdBuilds[@Todo(Support for `typing.TypeAlias`)]`
- error[type-assertion-failure] tests/annotations/declarations.py:961:5: Argument does not have asserted type `PBuilds[@Todo(Support for `typing.TypeAlias`)] | StdBuilds[@Todo(Support for `typing.TypeAlias`)]`
- error[type-assertion-failure] tests/annotations/declarations.py:969:5: Argument does not have asserted type `FullBuilds[@Todo(Support for `typing.TypeAlias`)] | PBuilds[@Todo(Support for `typing.TypeAlias`)] | StdBuilds[@Todo(Support for `typing.TypeAlias`)]`
- error[type-assertion-failure] tests/annotations/declarations.py:980:5: Argument does not have asserted type `FullBuilds[@Todo(Support for `typing.TypeAlias`)] | PBuilds[@Todo(Support for `typing.TypeAlias`)] | StdBuilds[@Todo(Support for `typing.TypeAlias`)]`
- Found 649 diagnostics
+ Found 645 diagnostics

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @sharkdp on 2025-05-14 11:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2025-05-14 11:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2025-05-14 11:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @sharkdp on 2025-05-14 11:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-05-14 15:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types/generics.rs</code>:537 on 2025-05-14 15:24</div>
            <div class="timeline-body"><p>Is it guaranteed that <code>self</code> and <code>other</code> have the same length?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-05-14 15:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types/class.rs</code>:530 on 2025-05-14 15:26</div>
            <div class="timeline-body"><p>Nit: Doesn't this depend on a salsa id comparison?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-14 15:31</div>
            <div class="timeline-body"><p>Hmm, this is indeed painful and also increases the work necessary to normalize types (because it's now necessary to perform a deep comparison).</p>
<blockquote>
<p>Our type ordering/normalization previously relied on PartialOrd/Ord instances that were auto-generated for salsa::interned structs. These implementations compare by salsa ID, which is not necessarily deterministic (depends on when a particular type has been interned, and can therefore depend on file checking order).</p>
</blockquote>
<p>I wonder if this is actually a problem. I'm not sure if it will be when we start garbage collecting interned values but is it today?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-05-14 17:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/generics.rs</code>:537 on 2025-05-14 17:36</div>
            <div class="timeline-body"><p>No, thanks for catching that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-05-14 17:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/class.rs</code>:530 on 2025-05-14 17:39</div>
            <div class="timeline-body"><p>Not a nit! Thanks for catching that, I didn't realize <code>ScopeId</code> was interned as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-14 17:41</div>
            <div class="timeline-body"><blockquote>
<p>I wonder if this is actually a problem. I'm not sure if it will be when we start garbage collecting interned values but is it today?</p>
</blockquote>
<p>I don't understand? https://github.com/astral-sh/ty/issues/369#issuecomment-2879256482 definitely feels like an actual problem to me. It's not just non-deterministic, it's also incorrect (sometimes).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-14 19:00</div>
            <div class="timeline-body"><blockquote>
<p>also increases the work necessary to normalize types (because it's now necessary to perform a deep comparison).</p>
</blockquote>
<p>The benchmarks seem completely neutral: https://codspeed.io/astral-sh/ruff/branches/david%2Fstable-ordering</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_python_semantic/src/semantic_index/symbol.rs</code>:153 on 2025-05-14 19:43</div>
            <div class="timeline-body"><p>I guess this would be tricky to enforce unless salsa avoids adding <code>PartialOrd</code>, <code>Ord</code> to the interned structs as pointed out by Micha and in the linked salsa discussion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-14 19:49</div>
            <div class="timeline-body"><p>I'm not sure I fully understand yet whether the problem is:</p>
<ol>
<li>That the ordering isn't stable between runs or</li>
<li>That some part of ty incorrectly assumes that the ordering will be stable between runs</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-14 19:49</div>
            <div class="timeline-body"><blockquote>
<p>Besides not being deterministic, it was also incorrect. When comparing two equal unions <code>A1 | B1</code> and <code>A2 | B2</code>, it was possible for one union to be ordered incorrectly (e.g. if both <code>A1</code> and <code>B1</code> were interned nominal instances), leading to incorrect type-relation results.</p>
</blockquote>
<p>I don't fully understand this point. Could you possibly give an example?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_python_semantic/src/types/generics.rs</code>:237 on 2025-05-14 19:51</div>
            <div class="timeline-body"><p>Do we need to implement <code>.ordering</code> for <code>TypeVarInstance</code> as it's interned?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-05-14 19:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-14 20:01</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>I wonder if this is actually a problem. I'm not sure if it will be when we start garbage collecting interned values but is it today?</p>
</blockquote>
<p>I don't understand? https://github.com/astral-sh/ty/issues/369#issuecomment-2879256482 definitely feels like an actual problem to me. It's not just non-deterministic, it's also incorrect (sometimes).</p>
</blockquote>
<p>I'm mainly questioning whether we need to override everywhere. We definitely should override it if it otherwise leads to incorrect ordering. I don't think we have to override in cases where it's only about determinism because ids are then a very convenient and fast way to arbitrarily sort items (if the only goal is that they have a fixed ordering but don't require a specific semantic ordering)</p>
<p>It's not quite clear to me what you're fixing in this pr (at least one case seems semantic)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @sharkdp on 2025-05-14 20:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-05-15 02:28</div>
            <div class="timeline-body"><p>I think our prior assumption was that ordering of types need only be deterministic within a given run of <code>ty</code>, because we should always normalize types as needed to ensure that type ordering differences don't have semantic effects. So if we fix the specific bugs where we fail to normalize or allow type ordering differences to make a semantic difference, that should make it unnecessary to establish a universally consistent type ordering.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-15 10:29</div>
            <div class="timeline-body"><blockquote>
<p>that should make it unnecessary to establish a universally consistent type ordering.</p>
</blockquote>
<p>Until we implement persistent caching :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-15 10:33</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>that should make it unnecessary to establish a universally consistent type ordering.</p>
</blockquote>
<p>Until we implement persistent caching :-)</p>
</blockquote>
<p>Haha, fair. Although salsa might solve this if the rematerialized structs retain their relative order</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-05-15 19:01</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 18:51:29 UTC
    </footer>
</body>
</html>
