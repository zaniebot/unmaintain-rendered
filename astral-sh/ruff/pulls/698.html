<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Implement a `--show-source` setting - astral-sh/ruff #698</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Implement a <code>--show-source</code> setting</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/698">#698</a>
        opened by <a href="https://github.com/harupy">@harupy</a>
        on 2022-11-12 11:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harupy">@harupy</a></div>
            <div class="timeline-body"><p>See #525.</p>
<pre><code>cargo run -- --no-cache --select C resources/test/fixtures/ --show-source
</code></pre>
<img alt="image" src="https://user-images.githubusercontent.com/17039389/201511165-a0528f57-fbf8-4d72-b5dd-47068338d908.png">

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;POC of `--show`source`&quot; to &quot;POC of `--show-source`&quot; by <a href="https://github.com/harupy">@harupy</a> on 2022-11-12 11:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harupy">@harupy</a> reviewed on 2022-11-12 11:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/harupy">@harupy</a> on <code>Cargo.toml</code>:16 on 2022-11-12 11:43</div>
            <div class="timeline-body"><p>rustc also uses this crate: <a href="https://github.com/rust-lang/rust/issues/59346">rust-lang/rust#59346</a>#issuecomment-1279325650</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;POC of `--show-source`&quot; to &quot;Add `--show-source` flag&quot; by <a href="https://github.com/harupy">@harupy</a> on 2022-11-12 11:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harupy">@harupy</a> reviewed on 2022-11-12 11:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/harupy">@harupy</a> on <code>Cargo.toml</code>:16 on 2022-11-12 11:57</div>
            <div class="timeline-body"><p>Another option is https://github.com/zkat/miette. SWC uses this crate to show pretty reports.</p>
<ul>
<li>https://github.com/swc-project/swc/pull/3946</li>
<li>https://github.com/swc-project/swc/blob/27225a0eeb78f3c2975ec14ef51127b2b9532a84/crates/swc_error_reporters/Cargo.toml#L16</li>
</ul>
<p><img src="https://user-images.githubusercontent.com/17039389/201473776-532bc1b2-e3be-4587-bcd6-46a24c32956a.png" alt="image"></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Add `--show-source` flag&quot; to &quot;Add `--show-source` setting&quot; by <a href="https://github.com/harupy">@harupy</a> on 2022-11-12 12:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Add `--show-source` setting&quot; to &quot;Implement a `--show-source` setting&quot; by <a href="https://github.com/harupy">@harupy</a> on 2022-11-12 12:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-12 14:10</div>
            <div class="timeline-body"><p>\cc @squiddy</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-12 14:12</div>
            <div class="timeline-body"><p>Wow nice. Is it possible to include the fix annotations / suggestions here too, like Clippy does?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harupy">@harupy</a> on 2022-11-12 14:16</div>
            <div class="timeline-body"><p>That&#x27;s what I&#x27;m investigating now :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-11-12 14:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>Cargo.toml</code>:16 on 2022-11-12 14:18</div>
            <div class="timeline-body"><p>It looks like that uses https://crates.io/crates/ariadne under the hood.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-12 16:40</div>
            <div class="timeline-body"><p>I do like the look and feel! And I love not implementing this ourselves.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harupy">@harupy</a> on 2022-11-13 00:43</div>
            <div class="timeline-body"><p>@charliermarsh It looks like clippy relies on <code>rustc_errors</code> (rustc&#x27;s private crate) for creating an error report.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harupy">@harupy</a> reviewed on 2022-11-13 00:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/harupy">@harupy</a> on <code>src/message.rs</code>:116 on 2022-11-13 00:46</div>
            <div class="timeline-body"><p>This is where we can show notes or help messages:</p>
<pre><code>-            footer: vec![],
+            footer: vec![Annotation {
+                label: Some(&quot;Add --fix to automatically fix this error&quot;),
+                id: None,
+                annotation_type: AnnotationType::Help,
+            }],
</code></pre>
<img alt="image" src="https://user-images.githubusercontent.com/17039389/201500272-700df862-9541-4962-ad80-6ac4c09328bd.png">

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-13 03:30</div>
            <div class="timeline-body"><p>Could we vendor that crate? Or is it too closely coupled to Clippy / rustc to be extracted?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harupy">@harupy</a> on 2022-11-13 04:32</div>
            <div class="timeline-body"><p>This is <code>rustc_errors</code>&#x27; <code>Cargo.toml</code>:
https://github.com/rust-lang/rust/blob/fb6667a233fa677f6fbfa6067913ef3d32480317/compiler/rustc_errors/Cargo.toml</p>
<p>As you can see, it depends on other private crates:</p>
<pre><code>[package]
name = &quot;rustc_errors&quot;
version = &quot;0.0.0&quot;
edition = &quot;2021&quot;

[lib]

[dependencies]
tracing = &quot;0.1&quot;
rustc_ast = { path = &quot;../rustc_ast&quot; }
rustc_ast_pretty = { path = &quot;../rustc_ast_pretty&quot; }
rustc_error_messages = { path = &quot;../rustc_error_messages&quot; }
rustc_serialize = { path = &quot;../rustc_serialize&quot; }
rustc_span = { path = &quot;../rustc_span&quot; }
rustc_macros = { path = &quot;../rustc_macros&quot; }
rustc_data_structures = { path = &quot;../rustc_data_structures&quot; }
rustc_target = { path = &quot;../rustc_target&quot; }
rustc_hir = { path = &quot;../rustc_hir&quot; }
rustc_lint_defs = { path = &quot;../rustc_lint_defs&quot; }
unicode-width = &quot;0.1.4&quot;
atty = &quot;0.2&quot;
termcolor = &quot;1.0&quot;
annotate-snippets = &quot;0.9&quot;
termize = &quot;0.1.1&quot;
serde = { version = &quot;1.0.125&quot;, features = [ &quot;derive&quot; ] }
serde_json = &quot;1.0.59&quot;

[target.&#x27;cfg(windows)&#x27;.dependencies]
winapi = { version = &quot;0.3&quot;, features = [ &quot;handleapi&quot;, &quot;synchapi&quot;, &quot;winbase&quot; ] }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-11-13 05:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/message.rs</code>:67 on 2022-11-13 05:11</div>
            <div class="timeline-body"><p>Can we find a way to do all of the above through the cached <code>SourceCodeLocator</code> that we already create for each file? (Maybe it involves adding the body text to <code>message</code> or something?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-11-13 05:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/message.rs</code>:118 on 2022-11-13 05:12</div>
            <div class="timeline-body"><p>I think that if we&#x27;re going to use this crate for <code>--show-source</code>, we should probably use the same crate and style even when <code>--show-source</code> is false (and just omit the source code). What do you think?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/harupy">@harupy</a> on <code>src/message.rs</code>:67 on 2022-11-13 05:54</div>
            <div class="timeline-body"><blockquote>
<p>Maybe it involves adding the body text to message or something?</p>
</blockquote>
<p>I&#x27;ll try this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harupy">@harupy</a> reviewed on 2022-11-13 05:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harupy">@harupy</a> reviewed on 2022-11-13 05:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/harupy">@harupy</a> on <code>src/message.rs</code>:118 on 2022-11-13 05:55</div>
            <div class="timeline-body"><p>Sounds good. I think we can set <code>slices</code> to an empty vector when <code>--show-source</code> is false.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/harupy">@harupy</a> on 2022-11-13 07:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harupy">@harupy</a> on 2022-11-13 07:35</div>
            <div class="timeline-body"><p>Updated the screenshot.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/harupy">@harupy</a> on 2022-11-14 01:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-11-15 21:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/cli.rs</code>:99 on 2022-11-15 21:50</div>
            <div class="timeline-body"><p>I think we should add this to <code>pyproject.toml</code> too, wdyt?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/message.rs</code>:44 on 2022-11-15 21:51</div>
            <div class="timeline-body"><p>I think this needs to be <code>.chars().len()</code>, or we need to use the <code>Rope</code> in <code>locator</code> to get the start and end <em>character</em> positions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-11-15 21:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-11-15 21:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/message.rs</code>:92 on 2022-11-15 21:58</div>
            <div class="timeline-body"><p>Nit: maybe <code>if let</code> to avoid some of the unwraps?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harupy">@harupy</a> reviewed on 2022-11-16 02:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/harupy">@harupy</a> on <code>src/cli.rs</code>:99 on 2022-11-16 02:12</div>
            <div class="timeline-body"><p>Looks like I forgot to update <code>user.rs</code>. Updated it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harupy">@harupy</a> reviewed on 2022-11-16 02:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/harupy">@harupy</a> on <code>src/message.rs</code>:92 on 2022-11-16 02:17</div>
            <div class="timeline-body"><p>Sounds good. Will fix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harupy">@harupy</a> reviewed on 2022-11-16 02:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/harupy">@harupy</a> on <code>src/message.rs</code>:44 on 2022-11-16 02:18</div>
            <div class="timeline-body"><p>Fixed</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/harupy">@harupy</a> on 2022-11-16 04:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-16 04:40</div>
            <div class="timeline-body"><p>Sweet! Will try to merge this tomorrow (or maybe the next day -- I have to move apartments tomorrow so might be busy). I just want to do some performance testing before merging.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-17 19:53</div>
            <div class="timeline-body"><p>(Sorry, I&#x27;m a little behind, I haven&#x27;t had a chance to benchmark yet.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harupy">@harupy</a> on 2022-11-18 04:14</div>
            <div class="timeline-body"><p>@charliermarsh Not a problem at all :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-18 19:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-11-18 19:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harupy">@harupy</a> on 2022-11-19 01:29</div>
            <div class="timeline-body"><p>@charliermarsh Thanks for the clean-up and merge! This feature does help when verifying new lint rules.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2022-11-19 01:50</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:51:27 UTC
    </footer>
</body>
</html>
