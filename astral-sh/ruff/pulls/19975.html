<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Ask the LSP client to watch all project search paths - astral-sh/ruff #19975</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Ask the LSP client to watch all project search paths</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19975">#19975</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2025-08-18 18:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a></div>
            <div class="timeline-body"><p>This change rejiggers how we register globs for file watching with the
LSP client. Previously, we registered a few globs like <code>**/*.py</code>,
<code>**/pyproject.toml</code> and more. There were two problems with this
approach.</p>
<p>Firstly, it only watches files within the project root. Search paths may
be outside the project root. Such as virtualenv directory.</p>
<p>Secondly, there is variation on how tools interact with virtual
environments. In the case of uv, depending on its link mode, we might
not get any file change notifications after running <code>uv add foo</code> or
<code>uv remove foo</code>.</p>
<p>To remedy this, we instead just list for file change notifications on
all files for all search paths. This simplifies the globs we use, but
does potentially increase the number of notifications we&#x27;ll get.
However, given the somewhat simplistic interface supported by the LSP
protocol, I think this is unavoidable (unless we used our own file
watcher, which has its own considerably downsides). Moreover, this is
seemingly consistent with how <code>ty check --watch</code> works.</p>
<p>This also required moving file watcher registration to <em>after</em>
workspaces are initialized, or else we don&#x27;t know what the right search
paths are.</p>
<p>This change is in service of #19883, which in order for cache
invalidation to work right, the LSP client needs to send notifications
whenever a dependency is added or removed. This change should make that
possible.</p>
<p>I tried this patch with #19883 in addition to my work to activate Salsa
caching, and everything seems to work as I&#x27;d expect. That is,
completions no longer show stale results after a dependency is added or
removed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-08-18 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-08-18 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-08-18 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-08-18 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/dcreager">@dcreager</a> removed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-08-18 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/carljm">@carljm</a> removed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-08-18 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/sharkdp">@sharkdp</a> removed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-08-18 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dhruvmanila">@dhruvmanila</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-08-18 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-18 18:34</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-18 18:36</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-18 20:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-18 20:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:162 on 2025-08-19 04:47</div>
            <div class="timeline-body"><p>I think this needs to be moved inside <code>self.session.initialize_workspace</code> because we call that method directly (instead of taking this branch) for clients that doesn&#x27;t support <code>workspace/configuration</code>. Refer to the other reference call of <code>self.session.initialize_workspace</code>.</p>
<p>The <code>try_register_file_watcher</code> should also be moved on the <code>Session</code> then. At that point, I think it would be useful to use the <code>Session::register_dynamic_capabilities</code> method to include the logic from <code>try_register_file_watcher</code> by checking whether the client supports it and then adding the <code>Unregistration</code> and <code>Registration</code> accordingly to the vector.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:296 on 2025-08-19 04:54</div>
            <div class="timeline-body"><p>I think it would be useful to move this on <code>Session</code> and re-use the <code>register_dynamic_capabilities</code> method. Refer to my other comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:299 on 2025-08-19 04:56</div>
            <div class="timeline-body"><p>nit: this seems to only be used once, should we inline the logic unless I&#x27;ve missed any other usage?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:336 on 2025-08-19 04:57</div>
            <div class="timeline-body"><p>What&#x27;s the reason that this message is at the warning level? I think it should be fine at the info level because I don&#x27;t think the user is in control of this and they cannot act on this warning.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:366 on 2025-08-19 04:59</div>
            <div class="timeline-body"><p>Yeah, I forgot that we didn&#x27;t unregister the file watcher before registering it. I think we can re-use the <code>Session::register_dynamic_capabilities</code>. The spec doesn&#x27;t mention whether the server can unregister a capability which wasn&#x27;t registered before but I&#x27;ve avoided that in the above mentioned method. I think we should follow that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-08-19 05:02</div>
            <div class="timeline-body"><p>This looks great!</p>
<p>The only thing that would be required in this PR is to move the <code>try_register_file_watcher</code> to be called inside <code>initialize_workspaces</code> and optionally re-use the <code>register_dynamic_capabilities</code> for this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:326 on 2025-08-19 05:58</div>
            <div class="timeline-body"><p>Can you expand on what issues you ran into and what you used as base uri so that a future reader knows what to test if they want to fix file watching for clients not supporting relative paths (I&#x27;m not suggesting we should fix this now, I just wouldn&#x27;t know what I&#x27;d have to test)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-08-19 06:04</div>
            <div class="timeline-body"><p>Nice, thank you for fixing this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-08-19 11:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:162 on 2025-08-19 11:43</div>
            <div class="timeline-body"><p>Got it. That makes sense!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-08-19 11:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:336 on 2025-08-19 11:47</div>
            <div class="timeline-body"><p>Just copying what was already there. Specifically:</p>
<p>https://github.com/astral-sh/ruff/blob/e5c091b850a95601c86d7db718953a91de1e1b48/crates/ty_server/src/server/main_loop.rs#L290-L293</p>
<p>Should I change that to an info-level message as well?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-08-19 11:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:299 on 2025-08-19 11:49</div>
            <div class="timeline-body"><p>No, you&#x27;re right, it&#x27;s only used once. But I&#x27;d prefer to keep it. <code>make_relative_watcher</code> is only used once too. IMO it makes the code a touch easier to read as it pulls out some mildly tedious construction of LSP glob patterns and lets the reader focus on the surrounding logic. The &quot;legacy&quot; branch becomes straight-forwardly simple and the relative glob branch lets you focus on how the search paths are collected and deduplicated.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-19 11:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:336 on 2025-08-19 11:57</div>
            <div class="timeline-body"><p>My reasoning for using warn for <code>&quot;Client does not support file system watching&quot;</code> was that it can lead to a degraded experience. In hindsight, I think it would have been great to phrase the message like: <code>Your LSP client doesn&#x27;t support file watching: You may see stale results when files change outside the editor</code>.</p>
<p>I&#x27;d suggest that we keep the message at warning severity if it impacts the user experience and include a summary of what behavior they have to expect</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-08-19 12:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:336 on 2025-08-19 12:11</div>
            <div class="timeline-body"><p>Sounds good. Done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:326 on 2025-08-19 12:22</div>
            <div class="timeline-body"><p>I expanded on this a bit:</p>
<pre><code>        // We also want to watch everything in the search paths as
        // well. But this seems to require &quot;relative&quot; watcher support.
        // I had trouble getting this working without using a base uri.
        //
        // Specifically, I tried this for each search path:
        //
        //     make_watcher(&amp;format!(&quot;{path}/**&quot;))
        //
        // But while this seemed to work for the project root, it
        // simply wouldn&#x27;t result in any file notifications for changes
        // to files outside of the project root.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-08-19 12:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-08-19 14:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:162 on 2025-08-19 14:43</div>
            <div class="timeline-body"><p>This is done. Much cleaner!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-08-19 14:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-08-19 14:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-19 14:57</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:17:49 UTC
    </footer>
</body>
</html>
