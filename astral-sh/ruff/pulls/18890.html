<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Create `Definition` for all place expressions - astral-sh/ruff #18890</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Create <code>Definition</code> for all place expressions</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18890">#18890</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2025-06-23 10:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-06-23 10:27</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR was the first iteration on solving https://github.com/astral-sh/ty/issues/185 but later realized there's a simpler solution instead.</p>
<p>Regardless, this PR does seem useful but it's not a priority so I'm just noting down the things that I've changed and learned:</p>
<ul>
<li>Expands <code>PlaceExpr</code> so that it is constructed for every attribute / subscript expression and not only a subset of it. This allows us to create <code>Definition</code> for every attribute / subscript expression that's involved in an assignment.</li>
<li>Combine <code>infer_target</code> and <code>infer_target_impl</code> and remove the complexity of the closure parameter and streamline the logic so that it all boils down to calling <code>infer_definition</code> for the <code>Definition</code> that belongs to name / attribute / subscript expression.</li>
<li>Move the attribute assignment validation to <code>add_binding</code> since that's where the assignability check for name expressions are.</li>
</ul>
<p>This also simplifies handling the target inference so that it's only a single <code>infer_target</code> call although it does has it's own complexity specifically around the fact that the value expression of the first comprehension needs to be inferred from the outer scope and not the comprehension scope.</p>
<h2>Test Plan</h2>
<!-- How was it tested? -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @dhruvmanila on 2025-06-23 10:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-06-23 10:36</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_INSTRUMENTATION_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/dhruv%2Funpack-diagnostics-bug?runnerMode=Instrumentation">CodSpeed Instrumentation Performance Report</a></h2>
<h3>Merging #18890 will <strong>degrade performances by 7.8%</strong></h3>
<p><sub>Comparing <code>dhruv/unpack-diagnostics-bug</code> (ae4f960) with <code>main</code> (e474f36)</sub></p>
<h3>Summary</h3>
<p><code>❌ 4</code> regressions<br />
<code>✅ 33</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/dhruv%2Funpack-diagnostics-bug?runnerMode=Instrumentation">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ❌ | <code>ty_check_file[cold]</code> | 120.9 ms | 127.9 ms | -5.48% |
| ❌ | <code>ty_micro[many_string_assignments]</code> | 66.5 ms | 72.2 ms | -7.8% |
| ❌ | <code>anyio</code> | 868.5 ms | 912.8 ms | -4.86% |
| ❌ | <code>attrs</code> | 360.3 ms | 383.2 ms | -5.98% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-06-23 10:39</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_WALLTIME_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/dhruv%2Funpack-diagnostics-bug?runnerMode=WallTime">CodSpeed WallTime Performance Report</a></h2>
<h3>Merging #18890 will <strong>improve performances by 5.69%</strong></h3>
<p><sub>Comparing <code>dhruv/unpack-diagnostics-bug</code> (ae4f960) with <code>main</code> (e474f36)</sub></p>
<h3>Summary</h3>
<p><code>⚡ 1</code> improvements<br />
<code>✅ 7</code> untouched benchmarks</p>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ⚡ | <code>small[freqtrade]</code> | 9 s | 8.5 s | +5.69% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2025-06-24 05:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[ty] [WIP] Remove duplicate unpack diagnostics" to "[ty] Create `Definition` for all place expressions" by @dhruvmanila on 2025-06-24 05:53</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 18:39:36 UTC
    </footer>
</body>
</html>
