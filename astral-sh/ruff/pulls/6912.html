<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use dyn dispatch for `any_over_*` - astral-sh/ruff #6912</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use dyn dispatch for <code>any_over_*</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6912">#6912</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-08-27 09:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">

Summary
<p>This PR changes our <code>any_over_</code> functions to use dynamic dispatch over static dispatch because the use of <code>F: Fn(&amp;Expr) -&gt; bool</code> results in Rust monomorphizing the <code>any_over</code> function body for every passed closure. Resulting in <code>any_over_expr</code> being our 4th largest function in ruff:</p>
<pre><code>Lines                  Copies               Function name
  -----                  ------               -------------
  1801126                36446                (TOTAL)
    33699 (1.9%,  1.9%)    141 (0.4%,  0.4%)  alloc::raw_vec::RawVec&lt;T,A&gt;::grow_amortized
    30284 (1.7%,  3.6%)    383 (1.1%,  1.4%)  core::iter::traits::iterator::Iterator::try_fold
    23751 (1.3%,  4.9%)      3 (0.0%,  1.4%)  &lt;ruff::settings::options::_::&lt;impl serde::de::Deserialize for ruff::settings::options::Options&gt;::deserialize::__Visitor as serde::de::Visitor&gt;::visit_map
    19173 (1.1%,  5.9%)     21 (0.1%,  1.5%)  ruff_python_ast::helpers::any_over_expr
</code></pre>
<p>The ideal solution would be inverse control by having an <code>expression</code> iterator. However, I haven&#x27;t been able to come up with a fast implementation that doesn&#x27;t require writing the child expressions to a temporary vec.</p>
Test Plan
<p><code>cargo test</code>. This removes about 1% of llvm lines from the ruff crate.</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-27 09:40</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #6912</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6912"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite"></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6912?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2023-08-27 09:48</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/any-over-dyn-dispatch">CodSpeed Performance Report</a>
Merging #6912 will <strong>not alter performance</strong>
<p>Comparing <code>any-over-dyn-dispatch</code> (4925032) with <code>main</code> (f33277a)</p>
Summary
<p><code>âœ… 16</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-08-27 09:51</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>âœ… ecosystem check detected no changes.</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-27 09:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-27 12:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-27 12:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-08-27 13:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-27 13:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-27 13:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-08-27 13:54</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:56:43 UTC
    </footer>
</body>
</html>
