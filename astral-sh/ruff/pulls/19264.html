<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Track open files in the server - astral-sh/ruff #19264</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Track open files in the server</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19264">#19264</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2025-07-10 16:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body">Summary
<p>This PR updates the server to keep track of open files both system and virtual files.</p>
<p>This is done by updating the project by adding the file in the open file set in <code>didOpen</code> notification and removing it in <code>didClose</code> notification.</p>
<p>This does mean that for workspace diagnostics, ty will only check open files because the behavior of different diagnostic builder is to first check <code>is_file_open</code> and only add diagnostics for open files. So, this required updating the <code>is_file_open</code> model to be <code>should_check_file</code> model which validates whether the file needs to be checked based on the <code>CheckMode</code>. If the check mode is open files only then it will check whether the file is open. If it&#x27;s all files then it&#x27;ll return <code>true</code> by default.</p>
<p>Closes: astral-sh/ty#619</p>
Test Plan
Before
<p>There are two files in the project: <code>__init__.py</code> and <code>diagnostics.py</code>.</p>
<p>In the video, I&#x27;m demonstrating the old behavior where making changes to the (open) <code>diagnostics.py</code> file results in re-parsing the file:</p>
<p>https://github.com/user-attachments/assets/c2ac0ecd-9c77-42af-a924-c3744b146045</p>
After
<p>Same setup as above.</p>
<p>In the video, I&#x27;m demonstrating the new behavior where making changes to the (open) <code>diagnostics.py</code> file doesn&#x27;t result in re-parting the file:</p>
<p>https://github.com/user-attachments/assets/7b82fe92-f330-44c7-b527-c841c4545f8f</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-10 16:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-10 16:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-10 16:49</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-10 17:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/lib.rs</code>:417 on 2025-07-10 17:08</div>
            <div class="timeline-body"><p>It probably doesn&#x27;t matter in practice but a virtual file could exist that isn&#x27;t in <code>open_files</code>. That&#x27;s why I think it&#x27;s incorrect to move this check above <code>open_files</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-10 17:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api/notifications/did_open.rs</code>:57 on 2025-07-10 17:11</div>
            <div class="timeline-body"><p>I think we need it to bump the file revision. Before the event: the file&#x27;s revision is the timestamp on disk. After opening it, the revision is the document version.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-11 03:28</div>
            <div class="timeline-body"><p>It seems like the issue that I&#x27;m seeing where if I open the same virtual file the second time after closing it without saving for the first time already exists on <code>main</code>. So, it doesn&#x27;t seem to be related to this PR at all.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[ty] Consider virtual files for workspace diagnostics&quot; to &quot;[ty] Track open files in the server&quot; by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-14 09:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-14 10:05</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-14 10:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_project/src/lib.rs</code>:581 on 2025-07-14 10:09</div>
            <div class="timeline-body"><p>This does not seem useful at all because VS Code also sends us the <code>textDocument/diagnostic</code> request for open files and virtual files are always open. So, we could possibly just remove this field and all should still be fine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-15 05:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-15 05:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-15 05:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-15 05:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-15 05:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-15 05:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/AlexWaygood">@AlexWaygood</a> removed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-15 07:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/lib.rs</code>:310 on 2025-07-15 09:33</div>
            <div class="timeline-body"><p>I think we should remove this behavior and instead always check exactly what <code>CheckMode</code> configured. This also allows us to remove the <code>Option</code> from <code>open_files</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/lib.rs</code>:406 on 2025-07-15 09:34</div>
            <div class="timeline-body"><p>I don&#x27;t think using <code>true</code> here is correct because it would also return <code>true</code> for non project files (e.g. third party files!). We still need to test if the file is in <code>self.files(db)</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/lib.rs</code>:581 on 2025-07-15 09:36</div>
            <div class="timeline-body"><p>Hmm, that&#x27;s interesting. It would certainly simplify things a bit. Can you try if skipping over the virtual files still works as expected?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api/notifications/did_open.rs</code>:58 on 2025-07-15 09:38</div>
            <div class="timeline-body"><p>Let&#x27;s explain why it should exist in this branch -&gt; because it was added to the index, therefore the LSPSystem should return it when reading it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/lib.rs</code>:144 on 2025-07-15 09:40</div>
            <div class="timeline-body"><p>Having <code>check_mode</code> on <code>ProjectMetadata</code> feels a bit odd. I think I&#x27;d prefer to default to <code>All</code> (You can implement <code>Default</code> for <code>CheckMode</code> and add the <code>#[default]</code> attribute to the field) and have the LSP explicitly set the check mode after startup.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-15 09:42</div>
            <div class="timeline-body"><p>Thank you. I think the <code>should_check_file</code> implementation is currently incorrect as it also returns <code>true</code> for third party files, which we don&#x27;t want. It might be worth adding a CLI test for it.</p>
<p>I also think that we should remove the implicit behavior where setting <code>open_files</code> to <code>Some</code> changes the check mode. I think this is confusing now where we also have an explicit check mode.  Instead, <code>check</code> should always do whatever is configured by <code>CheckMode</code>. This may require updating the benchmarks and ty_wasm to explicitly set <code>CheckMode</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-16 04:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_project/src/lib.rs</code>:144 on 2025-07-16 04:51</div>
            <div class="timeline-body"><p>Why should it default to <code>AllFiles</code>? Currently, I&#x27;ve kept the default as <code>OpenFiles</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-16 04:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_project/src/lib.rs</code>:310 on 2025-07-16 04:53</div>
            <div class="timeline-body"><blockquote>
<p>This also allows us to remove the <code>Option</code> from <code>open_files</code></p>
</blockquote>
<p>Does this mean that the <code>take_open_files</code> would not be needed and we can mutate the open files directly? The open file set is behind an <code>Arc</code>, so might need some workaround to that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-16 06:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/lib.rs</code>:310 on 2025-07-16 06:06</div>
            <div class="timeline-body"><p>I think we still need the <code>take_open_files</code> internally to avoid cloning the entire hash set every time a file is opened or closed. This could be a reason for keep using an <code>Option&lt;Arc&lt;...&gt;</code> internally but we should change/remove the implicit behavior that the project checks all files if <code>open_file_set</code> is none even when check mode is <code>OpenFiles</code> (which is contradicting)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/sharkdp">@sharkdp</a> removed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-16 06:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-16 06:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/lib.rs</code>:144 on 2025-07-16 06:10</div>
            <div class="timeline-body"><p>It would match my expectation to <code>Project</code> more closely. By default, I want to check all files. It&#x27;s only the editor-like environments where we may want to deviate from this behavior (LSP, WASM). This also has the advantage that it doesn&#x27;t require any additional setup code in the CLI (it does in the LSP and WASM but they opt into that by setting check mode to open files)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-16 11:59</div>
            <div class="timeline-body">Post review changes
<ul>
<li>Update <code>should_check_file</code> to check whether the file exists in the indexed file set in <code>AllFiles</code> check mode. This will avoid any third party files to be checked in this mode</li>
<li>Remove the <code>check_mode</code> field from the <code>ProjectMetadata</code>, instead expose a method <code>set_check_mode</code> from <code>ProjectDatabase</code> that updates the <code>Project</code>&#x27;s check mode</li>
<li>Update the default check mode to be <code>AllFiles</code> and update the server code to set the check mode as per the diagnostic mode, update the wasm and benchmark code to always use the <code>OpenFiles</code> check mode</li>
<li>Update the logic to check if a file is open or not to only check whether it&#x27;s explicitly in the open file set and avoid checking the indexed file set</li>
<li>Remove virtual file handling in <code>ProjectFiles</code> as it isn&#x27;t required because editors send a <code>textDocument/diagnostic</code> request for open files and virtual files are always open</li>
<li>Use <code>ChangeEvent::Created</code> in the <code>didOpen</code> handler for system path to notify the <code>Project</code> that there might be a new file that&#x27;s added in the project so the <code>Indexed</code> file set should be updated accordingly</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-16 11:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_project/src/lib.rs</code>:144 on 2025-07-16 11:59</div>
            <div class="timeline-body"><p>Updated the default check mode and updated wasm, benchmark and the server to explicitly set the check mode.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-16 11:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/notifications/did_open.rs</code>:58 on 2025-07-16 11:59</div>
            <div class="timeline-body"><p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-16 12:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_project/src/lib.rs</code>:406 on 2025-07-16 12:00</div>
            <div class="timeline-body"><p>Updated to check <code>self.files(db)</code> and <code>path.is_system_virtual_path</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-16 12:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_project/src/lib.rs</code>:310 on 2025-07-16 12:00</div>
            <div class="timeline-body"><p>I&#x27;ve kept the <code>Option&lt;Arc&lt;...&gt;&gt;</code> and updated the logic to use the check mode explicitly and removed the implicit behavior of <code>None</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-16 12:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_project/src/lib.rs</code>:581 on 2025-07-16 12:13</div>
            <div class="timeline-body"><p>I&#x27;ve removed this special handling for virtual files.</p>
<p>I tested out Zed which also supports virtual files but it seems that it doesn&#x27;t send any notification to the client about it&#x27;s existence.</p>
<p>https://github.com/user-attachments/assets/14a8e76e-3ae9-4edd-a604-56f41b6087e0</p>
<p>Zed seems to be sending a <code>didClose</code> for the new <code>other.py</code> and then a <code>didOpen</code> which is what caused the error in the above video. I&#x27;m not sure why though. But, it does send a <code>FileChangeType::Created</code> which seems fine but then why is it sending a <code>didClose</code> event?</p>
<pre><code>// Send:
{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;workspace/didChangeWatchedFiles&quot;,&quot;params&quot;:{&quot;changes&quot;:[{&quot;uri&quot;:&quot;file:///Users/dhruv/playground/ty-server/src/ty_server/other.py&quot;,&quot;type&quot;:1}]}}

// Send:
{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;textDocument/didClose&quot;,&quot;params&quot;:{&quot;textDocument&quot;:{&quot;uri&quot;:&quot;file:///Users/dhruv/playground/ty-server/src/ty_server/other.py&quot;}}}

// Send:
{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;textDocument/didOpen&quot;,&quot;params&quot;:{&quot;textDocument&quot;:{&quot;uri&quot;:&quot;file:///Users/dhruv/playground/ty-server/src/ty_server/other.py&quot;,&quot;languageId&quot;:&quot;python&quot;,&quot;version&quot;:0,&quot;text&quot;:&quot;x&quot;}}}
</code></pre>
<p>Neovim also has virtual file support but it has it&#x27;s own issues: <a href="https://github.com/astral-sh/ruff/issues/15392">astral-sh/ruff#15392</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-16 12:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/lib.rs</code>:587 on 2025-07-17 06:26</div>
            <div class="timeline-body"><p>The <code>HashSet</code> iterator implements default. This allows us to simplify the type in <code>OpenFiles</code> to just <code>hash_set::Iter</code>.</p>
<pre><code>                ProjectFilesIter::OpenFiles(files.map(|files| files.iter()).unwrap_or_default())
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/lib.rs</code>:390 on 2025-07-17 06:31</div>
            <div class="timeline-body"><p>The <code>file_set</code> part of the comment no longer applies here. We also removed this optimization from <code>CheckMode::AllFiles</code>.</p>
<p>I suggest moving the <code>path.is_vendored_path</code> out of the match to avoid any unnecessary dependencies</p>
<p>I also suggest removing the <em>Virtual files are always considered open</em> from the <code>OpenFiles</code> branch.
I think this is confusing. We should really only consider files as open in <code>CheckMode::OpenFiles</code> that are open.</p>
<pre><code>        if path.is_vendored_path() {
            // Try to return early to avoid adding a dependency on `open_files` or
            // `file_set` which both have a durability of `LOW`.
            return false
        }

        match self.check_mode(db) {
            CheckMode::OpenFiles =&gt; {
                self.open_files(db).is_some_and(|files| files.contains(&amp;file))
            }
            CheckMode::AllFiles =&gt; {
                // Virtual files are always checked.
                path.is_system_virtual_path() || self.files(db).contains(&amp;file)
            }
        }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/lib.rs</code>:59 on 2025-07-17 06:42</div>
            <div class="timeline-body"><p>I think the <code>None</code> description here is not entirely accurate. The value can be <code>Some</code> with an empty hash set.</p>
<p>Instead, we should document that we use an <code>Option</code> here so that we can implement an in-place update mechanism that avoids cloning or allocating.</p>
<p>Hmm, actually. I don&#x27;t think this has to be an <code>Arc&lt;Option&lt;..&gt;&gt;</code> at all. This can just be an <code>FxHashSet&lt;File&gt;</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api/notifications/did_open.rs</code>:64 on 2025-07-17 06:49</div>
            <div class="timeline-body"><p>I don&#x27;t think it&#x27;s necessary to call <code>apply_changes</code> twice. Instead, what we should do here is to test if it is a new file and then adjust the event on line 73.</p>
<pre><code>    let path = key.path();

    let is_new_file = path.as_system().is_some_and(|path| !db.system().path_exists(path));

    let document = TextDocument::new(...);
    ...

    match path {
        AnySystemPath::System(system_path) =&gt; {
            let event = if is_new_file {
                ChangeEvent::Created { path: system_path.clone(), kind: CreateKind::File }
            } else {
                ChangeEvent::Opened(system_path.clone())
            };

            session.apply_changes(vec![event]);

            match system_path_to_file(db, system_path) {
                Ok(file) =&gt; db.project().open_file(db, file),
                Err(err) =&gt; {
                    // This can only fail when the path is a directory or it doesn&#x27;t exists but
                    // the file should exists for this handler in this branch because it was
                    // added to the `Index` (using `open_text_document` above) and the
                    // `LSPSystem` should return it when reading it from the index.
                    tracing::warn!(&quot;Failed to create a salsa file for {system_path}: {err}&quot;);
                }
            }
        }
    }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api/notifications/did_open.rs</code>:81 on 2025-07-17 06:52</div>
            <div class="timeline-body"><p>Can you explain me why it&#x27;s no longer necessary to trigger an <code>Opened</code> event.</p>
<p>I don&#x27;t remember the exact details (we should maybe document why it&#x27;s needed) but I suspect it is for when workspace diagnostics are disabled and you start VS code but some changes weren&#x27;t saved in the last session. That&#x27;s when the <code>Opened</code> event is important so that ty knows that there&#x27;s now updated content in the editor.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-17 06:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_project/src/lib.rs</code>:390 on 2025-07-17 08:43</div>
            <div class="timeline-body"><blockquote>
<p>The <code>file_set</code> part of the comment no longer applies here. We also removed this optimization from <code>CheckMode::AllFiles</code>.</p>
</blockquote>
<p>Right, thanks for pointing that out. But, once I apply your patch, the comment would still apply because of the <code>self.files</code> call that calls into <code>self.file_set</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-17 08:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-17 08:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_project/src/lib.rs</code>:59 on 2025-07-17 08:48</div>
            <div class="timeline-body"><blockquote>
<p>Hmm, actually. I don&#x27;t think this has to be an <code>Arc&lt;Option&lt;..&gt;&gt;</code> at all. This can just be an <code>FxHashSet&lt;File&gt;</code>.</p>
</blockquote>
<p>Yeah, actually, both <code>Option</code> and <code>Arc</code> isn&#x27;t required. But, just to confirm, that would mean that we&#x27;d need to update the <code>take_open_files</code> to reset it to an empty set, right? Or, did you have something else in mind?</p>
<pre><code>    /// Sets the open files in the project.
    #[tracing::instrument(level = &quot;debug&quot;, skip(self, db))]
    pub fn set_open_files(self, db: &amp;mut dyn Db, open_files: FxHashSet&lt;File&gt;) {
        tracing::debug!(&quot;Set open project files (count: {})&quot;, open_files.len());

        self.set_open_fileset(db).to(open_files);
    }

    /// This takes the open files from the project and returns them.
    fn take_open_files(self, db: &amp;mut dyn Db) -&gt; FxHashSet&lt;File&gt; {
        tracing::debug!(&quot;Take open project files&quot;);

        // Salsa will cancel any pending queries and remove its own reference to `open_files`
        // so that the reference counter to `open_files` now drops to 1.
        self.set_open_fileset(db).to(FxHashSet::default())
    }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-17 08:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/lib.rs</code>:59 on 2025-07-17 08:58</div>
            <div class="timeline-body"><blockquote>
<p>update the take_open_files to reset it to an empty set, right? Or, did you have something else in mind?</p>
</blockquote>
<p>Yes, that&#x27;s correct</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-17 09:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/notifications/did_open.rs</code>:81 on 2025-07-17 09:00</div>
            <div class="timeline-body"><blockquote>
<p>you start VS code but some changes weren&#x27;t saved in the last session.</p>
</blockquote>
<p>Why does this matter? When a user starts VS Code, it&#x27;ll be starting a new server instance. Or, are you looking at it from a caching perspective?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-17 09:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api/notifications/did_open.rs</code>:81 on 2025-07-17 09:57</div>
            <div class="timeline-body"><p>I would have to play with it again to see where/when it is needed but you added it ;)</p>
<p>https://github.com/astral-sh/ruff/pull/13041/commits/0a37fadb4c50e0c1a4bf59d1429087ce0a197b05</p>
<p>We should probably add the same handling to <code>didOpenNotebook</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-17 10:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api/notifications/did_open.rs</code>:81 on 2025-07-17 10:05</div>
            <div class="timeline-body"><p>I haven&#x27;t been able to reproduce a case where it is needed. It would have to be a case where the initial content is different from the content on disk (and VS code doesn&#x27;t send a change notification). In that case, it&#x27;s important that the <code>File::revision</code> gets updated to the VS code revision.</p>
<p>If you decide that it isn&#x27;t required: Then delete the event because it should now be unused.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-17 10:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/notifications/did_open.rs</code>:81 on 2025-07-17 10:06</div>
            <div class="timeline-body"><p>Sounds good, thanks for trying it out!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-17 14:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/notifications/did_open.rs</code>:64 on 2025-07-17 14:57</div>
            <div class="timeline-body"><p>Wait, isn&#x27;t it actually important that we call <code>apply_changes</code> before the document is added to the index so that the <code>Project</code> knows that new file has been added?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-17 15:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/notifications/did_open.rs</code>:81 on 2025-07-17 15:01</div>
            <div class="timeline-body"><blockquote>
<p>I haven&#x27;t been able to reproduce a case where it is needed. It would have to be a case where the initial content is different from the content on disk (and VS code doesn&#x27;t send a change notification). In that case, it&#x27;s important that the <code>File::revision</code> gets updated to the VS code revision.</p>
</blockquote>
<p>Even in this case, I think the client would send us the <code>didOpen</code> request with the file content that&#x27;s in the editor and not the one on disk. And, the fact that we need to add this file to the open file set, we&#x27;re using <code>system_path_to_file</code> which then creates and interns the <code>File</code> with the revision from the index.</p>
<p>So, I think <code>ChangeEvent::Opened</code> isn&#x27;t required.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-17 16:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api/notifications/did_open.rs</code>:81 on 2025-07-17 16:25</div>
            <div class="timeline-body"><blockquote>
<p>Even in this case, I think the client would send us the didOpen request with the file content that&#x27;s in the editor and not the one on disk. And, the fact that we need to add this file to the open file set, we&#x27;re using system_path_to_file which then creates and interns the File with the revision from the index.</p>
</blockquote>
<p>I don&#x27;t think this reasoning is sound. The file might already been interned before. E.g. because workspace diagnostics are on and the file was checked. Opening the file with different content then on disk then absolutely <strong>has to</strong> bump the revision to ensure ty re-reads the source</p>
<p>I think the &quot;safest&quot; is to just trigger the event. It might invalidate some internal state unnecessarily. Or we try and remove it and wait for a user report telling us what breaks :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-18 04:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/notifications/did_open.rs</code>:81 on 2025-07-18 04:01</div>
            <div class="timeline-body"><blockquote>
<p>I think the &quot;safest&quot; is to just trigger the event. It might invalidate some internal state unnecessarily. Or we try and remove it and wait for a user report telling us what breaks :)</p>
</blockquote>
<p>Yeah, make sense. Although what you&#x27;ve suggested in an earlier comment doesn&#x27;t work -- the part where the <code>apply_changes</code> is being called after the document has been added in the index. It doesn&#x27;t work in the case when a virtual file is being saved as a system file.</p>
<p>I&#x27;ve pushed a change where it splits the <code>apply_changes</code> call as per &quot;is this a new system file?&quot; boolean where if it&#x27;s a new file, we <code>apply_changes</code> with <code>ChangeEvent::Created</code> before the document is added to the index so that the <code>Project</code> is notified of this change and it updates it accordingly and <code>apply_changes</code> with <code>ChangeEvent::Opened</code> after the document has been added to the index.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-18 05:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api/notifications/did_open.rs</code>:50 on 2025-07-18 05:47</div>
            <div class="timeline-body"><p>The check here is incorrect. <code>path_exists</code> will return <code>true</code> for existing and new files.</p>
<p>Thinking this through more. I suspect that doing the check before <code>open_text_document</code> doesn&#x27;t work in the virtual -&gt; regular file case because the file does exist on disk at the moment <code>didOpen</code> is called.</p>
<p>So I think we need to move the check after <code>open_text_document</code> and it needs to combine the state of the db with the state of <code>system</code>:</p>
<pre><code>	match system_path_to_file(db, system_path) {
		Ok(file) =&gt; {
			session.apply_changes(path, vec![ChangeEvent::Opened(system_path.clone())]);
		}
		Err(FileError::NotFound) =&gt; {
			if db.system().path_exists(system_path) {
				// trigger create event
			}
			system_path_to_file(db, system_path).unwrap()
		}
</code></pre>
<p>or, after opening the document</p>
<pre><code>match path {
	AnySystemPath::System(system_path) =&gt; {
		if db.files().system(db, path).status() == FileStatus::NotFound &amp;&amp; db.system().path_exists(path) {
	db.apply_changes(vec![ChangeEvent::Created { ... });
} else {
		db.apply_changes(vec![ChangeEvent::Opened();
	}

	let file = match system_path_to_file {...}

	}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-18 05:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/notifications/did_open.rs</code>:50 on 2025-07-18 05:51</div>
            <div class="timeline-body"><blockquote>
<p>Thinking this through more. I suspect that doing the check before <code>open_text_document</code> doesn&#x27;t work in the virtual -&gt; regular file case because the file does exist on disk at the moment <code>didOpen</code> is called.</p>
</blockquote>
<p>It does work:</p>
<p>https://github.com/user-attachments/assets/5c219c7b-6333-456a-adab-cc0e5aa05d67</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-18 06:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api/notifications/did_open.rs</code>:50 on 2025-07-18 06:13</div>
            <div class="timeline-body"><blockquote>
<p>It does work:</p>
</blockquote>
<p>Sorry, what I meant by this is that the check now is overly aggressive. We now always re-index the project because every change is a &quot;new file&quot;. And what doesn&#x27;t work is using <code>path_exists</code> on its own to determine if the file exists (because it will when changing from virtual -&gt; real file)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-18 09:56</div>
            <div class="timeline-body">Test cases
<ul>
<li>Open a virtual file, save it as system file</li>
<li>Delete the system file while it&#x27;s open</li>
<li>Delete the system file while it&#x27;s open but the editor focus is in a different file</li>
<li>Add an import that references a non-existant file, create a virtual file and save it with the same name as the import references</li>
</ul>
<p>https://github.com/user-attachments/assets/8bf966e0-33b8-45a8-978b-33063f409e53</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-18 10:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-07-18 11:10</div>
            <div class="timeline-body"><p>Uff, that was tricky. Thank you for seeing this through!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-18 14:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-18 14:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-18 14:03</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:16:29 UTC
    </footer>
</body>
</html>
