<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Baseline for subscript assignment diagnostics - astral-sh/ruff #21404</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Baseline for subscript assignment diagnostics</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21404">#21404</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-11-12 13:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body">Summary
<p>Add (snapshot) tests for subscript assignment diagnostics. This is mainly intended to establish a baseline before I hope to improve some of these messages.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-11-12 13:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-11-12 13:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-11-12 13:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-11-12 13:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-11-12 13:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-11-12 13:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/resources/mdtest/typed_dict.md</code>:622 on 2025-11-12 13:52</div>
            <div class="timeline-body"><p>I will fix this in a follow-up PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/resources/mdtest/typed_dict.md</code>:615 on 2025-11-12 13:52</div>
            <div class="timeline-body"><p>Those are pretty horrible. I am going to improve them soon.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-11-12 13:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-12 13:53</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests ‚úÖ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-12 13:53</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected ‚úÖ</p>
<p>No memory usage changes detected ‚úÖ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-11-12 13:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/resources/mdtest/snapshots/assignment_diagnosti‚Ä¶_-_Subscript_assignment‚Ä¶_-_Basic_(25b3e0346f673d80).snap</code>:23 on 2025-11-12 13:54</div>
            <div class="timeline-body"><p>I think we may want to add a special diagnostic for subscript assignments to <code>dict</code> that doesn&#x27;t mention <code>__setitem__</code>, which feels like a distraction here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-11-12 13:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/resources/mdtest/snapshots/assignment_diagnosti‚Ä¶_-_Subscript_assignment‚Ä¶_-_No_`__setitem__`_met‚Ä¶_(468f62a3bdd1d60c).snap</code>:26 on 2025-11-12 13:57</div>
            <div class="timeline-body"><p>This should also be improved. It should say something like &quot;Cannot assign <strong>to subscript on</strong> object of type ‚Ä¶&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-11-12 13:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/resources/mdtest/snapshots/assignment_diagnosti‚Ä¶_-_Subscript_assignment‚Ä¶_-_Possibly_missing_`__‚Ä¶_(efd3f0c02e9b89e9).snap</code>:22 on 2025-11-12 13:58</div>
            <div class="timeline-body"><p>This will probably also improve with my next PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-11-12 14:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/snapshots/assignment_diagnosti‚Ä¶_-_Subscript_assignment‚Ä¶_-_Basic_(25b3e0346f673d80).snap</code>:23 on 2025-11-12 14:04</div>
            <div class="timeline-body"><p>IMO the top-level summary for any subscript assignment error shouldn&#x27;t mention <code>__setitem__</code>. It feels like we&#x27;re immediately jumping into the implementation details of how subscript assignments are desugared by the interpreter at runtime. Even for non-dicts, I&#x27;d prefer something like</p>
<pre><code>error[invalid-assignment]: Cannot assign a value of type `Literal[&quot;three&quot;]` to a subscript key of type `Literal[&quot;retries&quot;]` on an object of type `dict[str, int]`
note: Assigning to a subscript key implicitly calls `__setitem__`
note: `__setitem__` defined here &lt;show source-code annotation&gt;
</code></pre>
<p>For something like this case, where the type of the key (<code>Literal[&quot;retries&quot;]</code> is assignable to the expected key type (<code>str</code>), we could go with something even shorter:</p>
<pre><code>error[invalid-assignment]: Cannot assign a value of type `Literal[&quot;three&quot;]` to a subscript key on an object of type `dict[str, int]`
note: A subscript assignment implicitly calls `__setitem__`
note: `__setitem__` defined here &lt;show source-code annotation&gt;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/snapshots/assignment_diagnosti‚Ä¶_-_Subscript_assignment‚Ä¶_-_Invalid_key_type_(d3d47de65fb3bad).snap</code>:27 on 2025-11-12 14:19</div>
            <div class="timeline-body"><p>the highlighted range here looks off. Shouldn&#x27;t this be</p>
<pre><code>2 | config[0] = 3  # error: [invalid-assignment]
  | ^^^^^^^^^^^^^
</code></pre>
<p>?</p>
<p>But maybe that&#x27;s one of the things you hope to address in a followup üòÑ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/snapshots/assignment_diagnosti‚Ä¶_-_Subscript_assignment‚Ä¶_-_Invalid_key_type_for‚Ä¶_(815dae276e2fd2b7).snap</code>:27 on 2025-11-12 14:21</div>
            <div class="timeline-body"><p>I&#x27;d prefer something like</p>
<pre><code>error[invalid-key]: Cannot assign a key of type `Literal[0]` on an object of type `Config`.
note: Only string literals are allowed as keys on TypedDicts.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/snapshots/assignment_diagnosti‚Ä¶_-_Subscript_assignment‚Ä¶_-_Invalid_value_type_f‚Ä¶_(155d53762388f9ad).snap</code>:46 on 2025-11-12 14:22</div>
            <div class="timeline-body"><p>love this one already, so good</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/snapshots/assignment_diagnosti‚Ä¶_-_Subscript_assignment‚Ä¶_-_Misspelled_key_for_`‚Ä¶_(7cf0fa634e2a2d59).snap</code>:32 on 2025-11-12 14:26</div>
            <div class="timeline-body"><p>‚ù§Ô∏è</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/snapshots/assignment_diagnosti‚Ä¶_-_Subscript_assignment‚Ä¶_-_No_`__setitem__`_met‚Ä¶_(468f62a3bdd1d60c).snap</code>:26 on 2025-11-12 14:27</div>
            <div class="timeline-body"><p>I&#x27;d prefer</p>
<pre><code>error[invalid-assignment]: Cannot assign to a subscript on an object of type `ReadOnlyDict`
note: assigning to a subscript impliictly calls `__setitem__`
note: `ReadOnlyDict` has no `__setitem__` method
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/snapshots/assignment_diagnosti‚Ä¶_-_Subscript_assignment‚Ä¶_-_Possibly_missing_`__‚Ä¶_(efd3f0c02e9b89e9).snap</code>:22 on 2025-11-12 14:28</div>
            <div class="timeline-body"><p>I&#x27;d prefer</p>
<pre><code>error[invalid-assignment]: Subscript assignment may fail on object of type `dict[str, int] | None`
note: Method `__setitem__` of type `dict[str, int] | None` may be missing
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-11-12 14:29</div>
            <div class="timeline-body"><p>Merging this, we can still discuss it on my next PR. As we all know, diffs on snapshots are more valuable than snapshots themselves.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-11-12 14:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-11-12 14:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-11-12 14:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-11-12 14:29</div>
            <div class="timeline-body"><p>These are great. I left some ideas on what I&#x27;d personally prefer the diagnostic to be in a few places -- obviously not expecting you to fix any of them in this PR üòÑ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-11-12 14:32</div>
            <div class="timeline-body"><p>Thanks @AlexWaygood. I will not fix all of these in the next PR, but I will keep the comments here as a note for a time after I have fixed some higher-priority issues.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:20:31 UTC
    </footer>
</body>
</html>
