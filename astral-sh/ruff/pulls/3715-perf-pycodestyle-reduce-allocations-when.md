```yaml
number: 3715
title: "perf(pycodestyle): Reduce allocations when computing logical lines"
type: pull_request
state: merged
author: MichaReiser
labels: []
assignees: []
merged: true
base: main
head: logical-lines-perf-improvements
created_at: 2023-03-24T17:35:06Z
updated_at: 2023-03-28T07:17:35Z
url: https://github.com/astral-sh/ruff/pull/3715
synced_at: 2026-01-12T15:55:13Z
```

# perf(pycodestyle): Reduce allocations when computing logical lines

---

_@MichaReiser_

This PR refactors the logical lines computation that the pycodestyle rules use from using `O(lines)` allocations to `O(1)`.

The current implementation allocates for every line:
* a `String` for the line's text
* a `Vec` for the logical-line text `offset` to `Location` mappings
* a `Vec` for the line's token

This PR reduces the allocations by allocating a single `String` for the text, two Vec's for the mappings and tokens, and one `Vec` for storing the line-metadata. The implementation slices into the shared text, mappings, and tokens structures to get the *view* for a single line. 

Allocating the data structures for all lines has the advantage of reserving the containers with the right capacity because we know the number of tokens. This avoids the *guessing* of the old implementation that used some more-or-less arbitrary numbers for the tokens-capacity. 

## Performance

* `no-logical`: Logical lines feature disabled
* `base-logical`: Logical lines feature enabled on main
* `pr3715`: This branch

```
group                                      base-logical                           no-logical                             pr3715
-----                                      ------------                           ----------                             ------
linter/all-rules/large/dataset.py          1.15      9.8Â±0.02ms     4.2 MB/sec    1.00      8.5Â±0.01ms     4.8 MB/sec    1.10      9.4Â±0.15ms     4.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.14      2.4Â±0.04ms     6.8 MB/sec    1.00      2.1Â±0.01ms     7.8 MB/sec    1.15      2.5Â±0.00ms     6.8 MB/sec
linter/all-rules/numpy/globals.py          1.21    301.1Â±1.97Âµs     9.8 MB/sec    1.00    247.9Â±3.25Âµs    11.9 MB/sec    1.16    286.9Â±3.46Âµs    10.3 MB/sec
linter/all-rules/pydantic/types.py         1.19      4.4Â±0.03ms     5.8 MB/sec    1.00      3.7Â±0.04ms     7.0 MB/sec    1.19      4.4Â±0.02ms     5.9 MB/sec
linter/default-rules/large/dataset.py      1.28      6.0Â±0.08ms     6.8 MB/sec    1.00      4.7Â±0.01ms     8.7 MB/sec    1.24      5.8Â±0.08ms     7.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.32   1317.7Â±3.83Âµs    12.6 MB/sec    1.00    999.5Â±5.57Âµs    16.7 MB/sec    1.31  1304.4Â±16.73Âµs    12.8 MB/sec
linter/default-rules/numpy/globals.py      1.44    145.7Â±1.14Âµs    20.3 MB/sec    1.00    101.0Â±0.41Âµs    29.2 MB/sec    1.44    145.7Â±1.31Âµs    20.2 MB/sec
linter/default-rules/pydantic/types.py     1.32      2.8Â±0.04ms     9.0 MB/sec    1.00      2.1Â±0.01ms    11.9 MB/sec    1.26      2.7Â±0.03ms     9.5 MB/sec
```

This change improves performance overall but the pycodestyle still add a significant overhead.

---

_Comment by @MichaReiser on 2023-03-24 17:35_

Current dependencies on/for this PR:
* main
  * **PR #3714** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3714" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #3715** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3715" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
      * **PR #3735** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3735" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #3736** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3736" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #3745** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3745" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
            * **PR #3757** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3757" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #3737** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3737" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/charliermarsh/ruff/3715?utm_source=stack-comment).

---

_Comment by @github-actions[bot] on 2023-03-24 18:04_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.05     19.9Â±0.89ms     2.0 MB/sec    1.00     18.9Â±0.51ms     2.1 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      5.0Â±0.28ms     3.3 MB/sec    1.00      4.9Â±0.25ms     3.4 MB/sec
linter/all-rules/numpy/globals.py          1.05   661.1Â±28.12Âµs     4.5 MB/sec    1.00   631.3Â±34.91Âµs     4.7 MB/sec
linter/all-rules/pydantic/types.py         1.05      8.8Â±0.45ms     2.9 MB/sec    1.00      8.3Â±0.44ms     3.1 MB/sec
linter/default-rules/large/dataset.py      1.02     10.2Â±0.32ms     4.0 MB/sec    1.00      9.9Â±0.28ms     4.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.03      2.2Â±0.08ms     7.7 MB/sec    1.00      2.1Â±0.12ms     7.9 MB/sec
linter/default-rules/numpy/globals.py      1.00    257.8Â±8.21Âµs    11.4 MB/sec    1.02   262.7Â±13.87Âµs    11.2 MB/sec
linter/default-rules/pydantic/types.py     1.02      4.7Â±0.12ms     5.4 MB/sec    1.00      4.6Â±0.23ms     5.6 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.01     15.7Â±0.22ms     2.6 MB/sec    1.00     15.6Â±0.22ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      4.2Â±0.05ms     4.0 MB/sec    1.00      4.2Â±0.05ms     4.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    535.8Â±7.10Âµs     5.5 MB/sec    1.01    538.5Â±5.45Âµs     5.5 MB/sec
linter/all-rules/pydantic/types.py         1.01      6.9Â±0.19ms     3.7 MB/sec    1.00      6.8Â±0.13ms     3.8 MB/sec
linter/default-rules/large/dataset.py      1.00      8.3Â±0.09ms     4.9 MB/sec    1.00      8.3Â±0.10ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1842.1Â±29.10Âµs     9.0 MB/sec    1.01  1851.6Â±17.13Âµs     9.0 MB/sec
linter/default-rules/numpy/globals.py      1.00    201.5Â±2.79Âµs    14.6 MB/sec    1.00    201.3Â±5.35Âµs    14.7 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.9Â±0.05ms     6.6 MB/sec    1.00      3.9Â±0.05ms     6.6 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Renamed from "Logical lines performance improvements" to "perf(pycodestyle): Reduce allocations when computing logical lines" by @MichaReiser on 2023-03-26 10:25_

---

_@MichaReiser reviewed on 2023-03-26 10:39_

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/pycodestyle/logical_lines.rs`:110 on 2023-03-26 10:39_

We can use `text.len()` to compute the offsets.

---

_Marked ready for review by @MichaReiser on 2023-03-26 18:35_

---

_Review requested from @charliermarsh by @MichaReiser on 2023-03-27 12:31_

---

_Review requested from @konstin by @konstin on 2023-03-27 12:44_

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/pycodestyle/logical_lines.rs`:341 on 2023-03-27 15:03_

I don't know if this TODO is still relevant, it looks like we _are_ "muting" strings.

---

_@charliermarsh approved on 2023-03-27 15:04_

This is stellar, I feel like I'm learning a lot even just from reading through your code here.

---

_@MichaReiser reviewed on 2023-03-27 15:47_

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/pycodestyle/logical_lines.rs`:341 on 2023-03-27 15:47_

It is necessary until we remove the regex handling (I think I commented the reason why it exists in one of the upper PRs)

---

_Review comment by @konstin on `crates/ruff/src/rules/pycodestyle/logical_lines.rs`:61 on 2023-03-27 16:16_

for my own understanding, does this mean that the comment consumes the newline after it?

---

_@konstin approved on 2023-03-27 16:16_

---

_@charliermarsh reviewed on 2023-03-27 17:04_

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/pycodestyle/logical_lines.rs`:341 on 2023-03-27 17:04_

But, is this comment still relevant? We already do "mute" strings. So isn't the TODO resolved?

---

_@MichaReiser reviewed on 2023-03-27 21:17_

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/pycodestyle/logical_lines.rs`:341 on 2023-03-27 21:17_

It is still necessary (at least for this PR). I understood this is a TODO to avoid the muting :D. I'll leave it there because it will be gone soon

---

_@MichaReiser reviewed on 2023-03-27 21:20_

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/pycodestyle/logical_lines.rs`:61 on 2023-03-27 21:20_

I think so... I don't really know to be honest. I only moved this code around. 

I remember that I tried removing the comment branch because I assumed that it isn't needed because there should be a new line token after, finishing the line. But some tests started failing. It may be worth looking into this again on the top branch.

Yep, it seems to be the case that there's no `newline` token after `Comment` token:

```python
def f():
  """Docstring goes here."""
  # Comment goes here.
  x = 1
f()"#;
```

Generates the following lines without the `Tok::Comment`

```
[
	"def f():",
	""""Docstring goes here."""", 
	"x = 1", 
	"f()"
]
```

Where the comment is missing (because comments don't get written to the text string)

---

_Merged by @MichaReiser on 2023-03-28 07:09_

---

_Closed by @MichaReiser on 2023-03-28 07:09_

---

_Branch deleted on 2023-03-28 07:09_

---
