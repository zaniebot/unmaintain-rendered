<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] equality narrowing on enums that don't override `__eq__` or `__ne__` - astral-sh/ruff #20285</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] equality narrowing on enums that don't override <code>__eq__</code> or <code>__ne__</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20285">#20285</a>
        opened by <a href="https://github.com/Renkai">@Renkai</a>
        on 2025-09-07 13:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/Renkai">@Renkai</a> on 2025-09-07 13:25</div>
            <div class="timeline-body"><p>It's a TODO clean of PR https://github.com/astral-sh/ruff/pull/20164 that solved issue https://github.com/astral-sh/ty/issues/939</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-08 07:23</div>
            <div class="timeline-body"><p>Thank you for your contribution. It looks like a better format here would be a GitHub issue on the https://github.com/astral-sh/ty repo? Or is there a particular reason that you are opening a PR at this stage?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Renkai">@Renkai</a> on 2025-09-08 07:34</div>
            <div class="timeline-body"><p>Hi, @sharkdp I want to clean some todos added in this PR:https://github.com/astral-sh/ruff/pull/20164
It's not finished yet so I mark this as <code>draft</code> in github. do you think we shall create an issue first? I'm not quite familiar with the best practice yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-08 07:49</div>
            <div class="timeline-body"><p>If you plan to do more changes in this draft PR, that's totally fine. I just thought you were looking for feedback on that document you added here. In that case, I'll assume that we wait for this to move to in-review.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-08 11:25</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @Renkai on 2025-09-08 11:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @Renkai on 2025-09-08 11:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @Renkai on 2025-09-08 11:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @Renkai on 2025-09-08 11:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @Renkai on 2025-09-08 11:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[ty][WIP]Create narrow_enum_pan.md" to "[ty]reate narrow_enum_pan.md" by @Renkai on 2025-09-08 11:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-08 11:33</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">isort (https://github.com/pycqa/isort)
- isort/api.py:573:12: warning[possibly-unresolved-reference] Name `key` used when possibly not defined
- isort/api.py:573:20: warning[possibly-unresolved-reference] Name `key` used when possibly not defined
- isort/api.py:574:22: warning[possibly-unresolved-reference] Name `key` used when possibly not defined
- Found 37 diagnostics
+ Found 34 diagnostics

rotki (https://github.com/rotki/rotki)
+ rotkehlchen/exchanges/kraken.py:960:57: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- rotkehlchen/exchanges/utils.py:201:37: warning[possibly-unresolved-reference] Name `url` used when possibly not defined
+ rotkehlchen/history/events/structures/swap.py:170:43: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 1589 diagnostics
+ Found 1590 diagnostics

</code></pre>
</details>
No memory usage changes detected ✅

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-09-08 11:37</div>
            <div class="timeline-body"><p>Thanks! Could you possibly update your PR description to describe this change a little better?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types.rs</code>:774 on 2025-09-08 21:14</div>
            <div class="timeline-body"><p>We shouldn't duplicate all this code from <code>is_single_valued</code>; we should extract it as a separate method, e.g. <code>Type::overrides_equality</code>. (It doesn't even have to be specific to enums, even if we only call it for enums currently.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types.rs</code>:746 on 2025-09-08 21:18</div>
            <div class="timeline-body"><p>No mdtests fail if we remove this arm. I think that's because we only use this method as an additional check beyond <code>is_single_valued</code>, and enum literals are already always single-valued.</p>
<p>I think we can probably remove this <code>is_simple_enum</code> method altogether in favor of an <code>is_enum</code> method, and use <code>ty.is_enum() &amp;&amp; !ty.overrides_equality()</code> everywhere the PR currently uses <code>ty.is_simple_enum()</code>. This isn't quite as concise but I think it's clearer, as its meaning is more self-evident, where the meaning of &quot;simple enum&quot; is not.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-09-08 21:19</div>
            <div class="timeline-body"><p>This is looking really good! I think it gets the correct semantics. A few comments on the implementation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[ty]reate narrow_enum_pan.md" to "[ty] equality narrowing on enums that don't override `__eq__` or `__ne__`" by @carljm on 2025-09-08 21:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Renkai">@Renkai</a> reviewed on 2025-09-08 23:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Renkai">@Renkai</a> on <code>crates/ty_python_semantic/src/types.rs</code>:746 on 2025-09-08 23:33</div>
            <div class="timeline-body"><p>Thanks for the review! I fixed it followed by your instruction, but cargo clippy forced me to use <code>!element.is_enum(self.db) || element.overrides_equality(self.db)</code> instead, hope it's still good to you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @Renkai on 2025-09-08 23:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-09-08 23:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @carljm on 2025-09-08 23:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-09-08 23:56</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:46:48 UTC
    </footer>
</body>
</html>
