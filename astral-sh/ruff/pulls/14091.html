<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Do not panic when encountering string annotations - astral-sh/ruff #14091</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Do not panic when encountering string annotations</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14091">#14091</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2024-11-04 13:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body">Summary
<p>Encountered this while running red-knot benchmarks on the <code>black</code> codebase.</p>
<p>Fixes two of the issues in #13478.</p>
Test Plan
<p>Added a regression test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-04 13:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-04 13:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-04 13:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-04 13:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-04 13:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:201 on 2024-11-04 13:16</div>
            <div class="timeline-body"><p>I&#x27;m a bit concerned that will forget to remove this after adding support for stringified type annotations.</p>
<p>Should we instead insert the type TODO here</p>
<p>https://github.com/astral-sh/ruff/blob/985f21168f516c42a269defca0e6151c87835076/crates/red_knot_python_semantic/src/types/infer.rs#L3748-L3749</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-04 13:26</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>âœ… ecosystem check detected no linter changes.</p>
Linter (preview)
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-04 13:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:201 on 2024-11-04 13:30</div>
            <div class="timeline-body"><blockquote>
<p>Should we instead insert the type TODO here</p>
<p><a href="https://github.com/astral-sh/ruff/blob/985f21168f516c42a269defca0e6151c87835076/crates/red_knot_python_semantic/src/types/infer.rs#L3748-L3749"><code>985f211</code>/crates/red_knot_python_semantic/src/types/infer.rs#L3748-L3749</a></p>
</blockquote>
<p><img src="https://github.com/user-attachments/assets/07c3dfd8-c924-48c0-ba80-d70f92d4d000" alt="image"></p>
<p>ðŸ˜¶</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-11-04 13:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:201 on 2024-11-04 13:34</div>
            <div class="timeline-body"><blockquote>
<p>Should we instead insert the type TODO here</p>
</blockquote>
<p>We already have this branch:</p>
<pre><code>// TODO: parse the expression and check whether it is a string annotation.
// https://typing.readthedocs.io/en/latest/spec/annotations.html#string-annotations
ast::Expr::StringLiteral(_literal) =&gt; Type::Todo,
</code></pre>
<p>It does not prevent the panic.</p>
<p>But I think I know what&#x27;s wrong. Will push a better fix (hopefully).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-11-04 13:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3661 on 2024-11-04 13:38</div>
            <div class="timeline-body"><p>If we do not add the expression type into <code>self.types.expressions</code> here (like we do for the other branches), it will later lead to a panic here:</p>
<p>https://github.com/astral-sh/ruff/blob/df45a0e3f966dd24feb0fece101dfa469ff24d1b/crates/red_knot_python_semantic/src/types.rs#L199</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-11-04 13:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/annotations/string_annotations.md</code>:1 on 2024-11-04 13:49</div>
            <div class="timeline-body"><p>nit: If all we&#x27;re asserting is &quot;make sure we don&#x27;t panic&quot;, then an mdtest is arguably overkill here: this could be better as a snippet added to the <a href="https://github.com/astral-sh/ruff/tree/main/crates/red_knot_workspace/resources/test/corpus">corpus directory</a> (we have a test that runs over all the snippets in that directory and checks that we can at least run red-knot over them without panicking)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-11-04 13:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/annotations/string_annotations.md</code>:1 on 2024-11-04 13:53</div>
            <div class="timeline-body"><p>I thought we would eventually have a Markdown-based test for string annotations anyway, and this test (with a non-<code>@Todo</code>-assertion) could very well be a basic initial test. I agree, so far it does little except document the fact that we don&#x27;t understand string annotations yet.</p>
<p>But I&#x27;m happy to turn it into a snippet, if you prefer that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-11-04 13:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-04 14:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/annotations/string_annotations.md</code>:1 on 2024-11-04 14:00</div>
            <div class="timeline-body"><p>Yeah, fair enough. I suppose the corpus directory becomes less and less useful as we expand our ambitions beyond &quot;do not panic when checking Python&quot; to &quot;infer the correct types consistently everywhere when checking Python&quot; ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-04 14:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-04 14:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-04 14:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-11-04 20:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3664 on 2024-11-04 20:21</div>
            <div class="timeline-body"><p>I suspect we have the same bug here, for starred expressions in an annotation.</p>
<p>In general the contract is supposed to be that <code>infer_expression</code> takes care of storing the expression type, so we don&#x27;t have to do it separately for every kind of expression.</p>
<p>For annotations, the tricky thing is the split between annotation expressions (what is valid in an annotation) and type expressions (which is a subset of annotation expressions). Currently <code>infer_type_expression</code> stores the type, but <code>infer_annotation_expression</code> does not, because most of the time it just defers to <code>infer_type_expression</code>, and we don&#x27;t want to double-store. But we should come up with some general way to ensure annotation expression types are always stored, without having to do it separately in each branch that we add here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-11-04 20:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3664 on 2024-11-04 20:27</div>
            <div class="timeline-body"><p>Oh, I <em>did</em> look at <code>infer_starred_expression</code> and saw that it uses <code>infer_expression</code> (which stores the expression type), but that&#x27;s probably not enoughâ€¦ I&#x27;ll look into it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-11-04 20:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3664 on 2024-11-04 20:29</div>
            <div class="timeline-body"><p>It uses <code>infer_expression</code> on a sub-part of the starred expression (the <code>value</code>), but never on the starred expression itself. This is the usual pattern for <code>infer_*</code> methods for particular node types, since the assumption is they are called from <code>infer_expression</code> which will store the type they return.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:08:05 UTC
    </footer>
</body>
</html>
