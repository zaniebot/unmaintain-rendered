<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Handled dict and set inside f-string (#4249) - astral-sh/ruff #4563</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Handled dict and set inside f-string (#4249)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4563">#4563</a>
        opened by <a href="https://github.com/DavideCanton">@DavideCanton</a>
        on 2023-05-21 18:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/DavideCanton">@DavideCanton</a></div>
            <div class="timeline-body"><p>This fixes some C40* rules by adding spaces around dict and set literals inside f-string, and quotes correctly string literals inside f-string, since dict kwargs must be converted into string literals.</p>
<p>Closes #4249.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-05-21 18:44</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>✅ ecosystem check detected no changes.</p>
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      7.5±0.03ms     5.4 MB/sec    1.00      7.6±0.04ms     5.4 MB/sec
formatter/numpy/ctypeslib.py               1.00   1333.7±8.52µs    12.5 MB/sec    1.01   1345.6±2.43µs    12.4 MB/sec
formatter/numpy/globals.py                 1.00    149.9±1.22µs    19.7 MB/sec    1.01    151.6±3.62µs    19.5 MB/sec
formatter/pydantic/types.py                1.00      3.1±0.02ms     8.4 MB/sec    1.01      3.1±0.02ms     8.3 MB/sec
linter/all-rules/large/dataset.py          1.00     16.5±0.17ms     2.5 MB/sec    1.00     16.6±0.12ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.9±0.02ms     4.2 MB/sec    1.01      4.0±0.02ms     4.2 MB/sec
linter/all-rules/numpy/globals.py          1.00    486.4±2.14µs     6.1 MB/sec    1.01    491.2±3.28µs     6.0 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.9±0.05ms     3.7 MB/sec    1.01      6.9±0.07ms     3.7 MB/sec
linter/default-rules/large/dataset.py      1.00      8.0±0.04ms     5.1 MB/sec    1.00      8.0±0.04ms     5.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1708.5±9.82µs     9.7 MB/sec    1.01   1719.1±7.35µs     9.7 MB/sec
linter/default-rules/numpy/globals.py      1.00    188.6±0.87µs    15.6 MB/sec    1.01    190.5±1.74µs    15.5 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.6±0.02ms     7.1 MB/sec    1.00      3.6±0.02ms     7.1 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01      9.4±0.32ms     4.3 MB/sec    1.00      9.3±0.28ms     4.4 MB/sec
formatter/numpy/ctypeslib.py               1.00  1637.6±54.61µs    10.2 MB/sec    1.00  1641.5±58.33µs    10.1 MB/sec
formatter/numpy/globals.py                 1.00    179.5±8.38µs    16.4 MB/sec    1.01   181.3±13.14µs    16.3 MB/sec
formatter/pydantic/types.py                1.00      3.9±0.16ms     6.6 MB/sec    1.00      3.8±0.24ms     6.6 MB/sec
linter/all-rules/large/dataset.py          1.01     20.4±0.54ms  2037.2 KB/sec    1.00     20.3±0.52ms     2.0 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.03      5.2±0.16ms     3.2 MB/sec    1.00      5.1±0.16ms     3.3 MB/sec
linter/all-rules/numpy/globals.py          1.00   602.4±25.63µs     4.9 MB/sec    1.01   607.7±35.92µs     4.9 MB/sec
linter/all-rules/pydantic/types.py         1.01      8.6±0.27ms     3.0 MB/sec    1.00      8.5±0.25ms     3.0 MB/sec
linter/default-rules/large/dataset.py      1.01     10.1±0.29ms     4.0 MB/sec    1.00     10.1±0.25ms     4.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01      2.2±0.10ms     7.7 MB/sec    1.00      2.1±0.09ms     7.8 MB/sec
linter/default-rules/numpy/globals.py      1.00   241.5±13.01µs    12.2 MB/sec    1.00   242.2±13.11µs    12.2 MB/sec
linter/default-rules/pydantic/types.py     1.01      4.6±0.14ms     5.6 MB/sec    1.00      4.5±0.17ms     5.6 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-21 19:27</div>
            <div class="timeline-body"><p>How would this handle a case like <code>f&quot;{set([&#x27;a&#x27;, &#x27;b&#x27;]) - set([&#x27;a&#x27;])}&quot;</code>, where the second <code>set</code> needs to be converted, but doesn&#x27;t require any padding?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/DavideCanton">@DavideCanton</a> on 2023-05-21 23:18</div>
            <div class="timeline-body"><blockquote>
<p>How would this handle a case like <code>f&quot;{set([&#x27;a&#x27;, &#x27;b&#x27;]) - set([&#x27;a&#x27;])}&quot;</code>, where the second <code>set</code> needs to be converted, but doesn&#x27;t require any padding?</p>
</blockquote>
<p>You are right, I missed that case.</p>
<p>I reworked a bit the fix part by checking where the current expression is related to the f-string boundaries</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-22 14:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_comprehensions/fixes.rs</code>:585 on 2023-05-22 14:35</div>
            <div class="timeline-body"><p>Nit: I&#x27;d probably rather parenthesize than add whitespace.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-22 14:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_comprehensions/fixes.rs</code>:596 on 2023-05-22 14:37</div>
            <div class="timeline-body"><p>I&#x27;m not sure that this will be sufficient -- I think we have to do something more advanced here. The <code>{</code> could be part of a different formatted expression within the same f-string, or it could be part of a curly parentheses literal:</p>
<pre><code>f&quot;{{this is a literal, not an expression}}&quot;
f&quot;{1 + 2} and then {dict()}&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-22 14:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_comprehensions/fixes.rs</code>:596 on 2023-05-22 14:38</div>
            <div class="timeline-body"><p>(I&#x27;m being a bit vague because I don&#x27;t know how exactly to solve this problem. We need to track additional state to detect the parent formatted expression.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/DavideCanton">@DavideCanton</a> reviewed on 2023-05-22 23:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/DavideCanton">@DavideCanton</a> on <code>crates/ruff/src/rules/flake8_comprehensions/fixes.rs</code>:596 on 2023-05-22 23:07</div>
            <div class="timeline-body"><p>oh, ok, guess I&#x27;ll have to study the f-string literal syntax a bit more</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/DavideCanton">@DavideCanton</a> reviewed on 2023-05-22 23:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/DavideCanton">@DavideCanton</a> on <code>crates/ruff/src/rules/flake8_comprehensions/fixes.rs</code>:585 on 2023-05-22 23:18</div>
            <div class="timeline-body"><p>probably it&#x27;s more robust, but I think it renders uglier expressions in many simple cases, what do you think?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_comprehensions/fixes.rs</code>:598 on 2023-05-23 06:36</div>
            <div class="timeline-body"><p>Nit: Can we directly push to the string instead of building a vec and then joining at the end?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-23 06:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/DavideCanton">@DavideCanton</a> reviewed on 2023-05-23 07:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/DavideCanton">@DavideCanton</a> on <code>crates/ruff/src/rules/flake8_comprehensions/fixes.rs</code>:598 on 2023-05-23 07:43</div>
            <div class="timeline-body"><p>right, I always think in python and forget strings are mutable in rust. Thanks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/DavideCanton">@DavideCanton</a> reviewed on 2023-05-23 10:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/DavideCanton">@DavideCanton</a> on <code>crates/ruff/src/rules/flake8_comprehensions/fixes.rs</code>:596 on 2023-05-23 10:04</div>
            <div class="timeline-body"><p>Ok, I see.</p>
<p>It seems I assumed (wrongly) that an expression wrapped in braces is always being formatted, but that&#x27;s not the case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-23 12:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_comprehensions/fixes.rs</code>:596 on 2023-05-23 12:56</div>
            <div class="timeline-body"><p>The other assumption here is that the expression is the first such expression in the f-string. But <code>f_string</code> here is just the start of the string, so above, we&#x27;d match on the <code>{1 + 2}</code> rather than the <code>{dict()}</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/DavideCanton">@DavideCanton</a> reviewed on 2023-05-23 12:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/DavideCanton">@DavideCanton</a> on <code>crates/ruff/src/rules/flake8_comprehensions/fixes.rs</code>:596 on 2023-05-23 12:58</div>
            <div class="timeline-body"><p>No, they would be two separate matches. That code finds the first brace in the whole fstring, in order to detect if between the start of the f-string and the start of the matched expression there are only whitespaces. If there are just whitespaces then a left padding is not required.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/DavideCanton">@DavideCanton</a> reviewed on 2023-05-24 18:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/DavideCanton">@DavideCanton</a> on <code>crates/ruff/src/rules/flake8_comprehensions/fixes.rs</code>:596 on 2023-05-24 18:17</div>
            <div class="timeline-body"><p>ok now I see your point, the code is wrong</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/DavideCanton">@DavideCanton</a> reviewed on 2023-05-25 07:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/DavideCanton">@DavideCanton</a> on <code>crates/ruff/src/rules/flake8_comprehensions/fixes.rs</code>:596 on 2023-05-25 07:31</div>
            <div class="timeline-body"><blockquote>
<p>(I&#x27;m being a bit vague because I don&#x27;t know how exactly to solve this problem. We need to track additional state to detect the parent formatted expression.)</p>
</blockquote>
<p>the problem here is that in <code>f&quot;{1 + 2} and then {dict()} else {{foo}}&quot;</code> the parent of the <code>dict()</code> expression is the whole string, so I cannot use it to detect the boundaries of the formatted token.</p>
<p>I&#x27;ve resorted to seeking the first <code>{</code> by iterating from the start of the matched token to the left and the first <code>}</code> from the end of the matched token to the right, so in the above case I match the two correct braces:</p>
<pre><code>f&quot;{1 + 2} and then {dict()} else {{foo}}&quot;
                   ^      ^
</code></pre>
<p>The <code>{1 + 2}</code> node should not be a problem since it is not the target of these set of rules, as well as the <code>{{foo}}</code> one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/DavideCanton">@DavideCanton</a> on 2023-06-08 20:42</div>
            <div class="timeline-body"><p>Hi, it&#x27;s quite a while this is around, I&#x27;m still keeping it updated with the main branch. Is there any interest in merging this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-08 20:59</div>
            <div class="timeline-body"><p>Apologies and thank you for the ping. I&#x27;ll re-review this tonight.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-08 20:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-09 02:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_comprehensions/fixes.rs</code>:496 on 2023-06-09 02:33</div>
            <div class="timeline-body"><p>Would this not detect the wrong braces given that the expression is <code>a</code> in: <code>f&quot;{ {a} }&quot;</code>?</p>
<p>That would be: an f-string with a single expression, which is a set literal that contains the element <code>a</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_comprehensions/fixes.rs</code>:496 on 2023-06-09 02:39</div>
            <div class="timeline-body"><p>Hmm, yeah it does get this wrong:</p>
<pre><code>        249 │+23    |-print(f&quot;{ {set(a for a in &#x27;abc&#x27;)} }&quot;)
        250 │+   23 |+print(f&quot;{ { {a for a in &#x27;abc&#x27;} } }&quot;)
</code></pre>
<p>But, it might be solvable. Will play around with it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-09 02:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-09 04:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_comprehensions/fixes.rs</code>:496 on 2023-06-09 04:09</div>
            <div class="timeline-body"><p>Hmm, it&#x27;s probably not solvable without a better f-string parser and representation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-09 04:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-09 04:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-09 04:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-06-09 06:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/DavideCanton">@DavideCanton</a> on 2023-06-09 06:59</div>
            <div class="timeline-body"><p>thanks for the update!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:53:51 UTC
    </footer>
</body>
</html>
