<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Apply narrowing to `len` calls based on argument size - astral-sh/ruff #22026</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Apply narrowing to <code>len</code> calls based on argument size</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22026">#22026</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2025-12-17 14:02
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-12-17 14:02</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Closes https://github.com/astral-sh/ty/issues/1983.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-17 14:03</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-17 14:05</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">Tanjun (https://github.com/FasterSpeeding/Tanjun)
- tanjun/dependencies/data.py:347:12: error[invalid-return-type] Return type does not match returned value: expected `_T@cached_inject`, found `Coroutine[Any, Any, _T@cached_inject | Coroutine[Any, Any, _T@cached_inject]] | _T@cached_inject`
+ tanjun/dependencies/data.py:347:12: error[invalid-return-type] Return type does not match returned value: expected `_T@cached_inject`, found `_T@cached_inject | Coroutine[Any, Any, _T@cached_inject | Coroutine[Any, Any, _T@cached_inject]]`

xarray (https://github.com/pydata/xarray)
- xarray/core/dataarray.py:5737:16: error[invalid-return-type] Return type does not match returned value: expected `T_Xarray@map_blocks`, found `T_Xarray@map_blocks | DataArray | Dataset`
+ xarray/core/dataarray.py:5737:16: error[invalid-return-type] Return type does not match returned value: expected `T_Xarray@map_blocks`, found `DataArray | Dataset`
- xarray/core/dataset.py:8866:16: error[invalid-return-type] Return type does not match returned value: expected `T_Xarray@map_blocks`, found `T_Xarray@map_blocks | DataArray | Dataset`
+ xarray/core/dataset.py:8866:16: error[invalid-return-type] Return type does not match returned value: expected `T_Xarray@map_blocks`, found `DataArray | Dataset`

jax (https://github.com/google/jax)
- jax/_src/tree_util.py:295:31: error[invalid-argument-type] Argument to bound method `register_node` is incorrect: Expected `(Hashable, Iterable[object], /) -&gt; T@register_pytree_node`, found `(_AuxData@register_pytree_node, _Children@register_pytree_node, /) -&gt; T@register_pytree_node`
- jax/_src/tree_util.py:298:31: error[invalid-argument-type] Argument to bound method `register_node` is incorrect: Expected `(Hashable, Iterable[object], /) -&gt; T@register_pytree_node`, found `(_AuxData@register_pytree_node, _Children@register_pytree_node, /) -&gt; T@register_pytree_node`
- jax/_src/tree_util.py:301:31: error[invalid-argument-type] Argument to bound method `register_node` is incorrect: Expected `(Hashable, Iterable[object], /) -&gt; T@register_pytree_node`, found `(_AuxData@register_pytree_node, _Children@register_pytree_node, /) -&gt; T@register_pytree_node`
- Found 2792 diagnostics
+ Found 2789 diagnostics

rotki (https://github.com/rotki/rotki)
- rotkehlchen/chain/decoding/tools.py:97:13: error[invalid-argument-type] Argument to function `decode_transfer_direction` is incorrect: Expected `(A@BaseDecoderTools &amp; BTCAddress) | (A@BaseDecoderTools &amp; ChecksumAddress) | (A@BaseDecoderTools &amp; SubstrateAddress) | (A@BaseDecoderTools &amp; SolanaAddress)`, found `A@BaseDecoderTools`
+ rotkehlchen/chain/decoding/tools.py:99:13: error[invalid-argument-type] Argument to function `decode_transfer_direction` is incorrect: Expected `Sequence[A@BaseDecoderTools]`, found `Unknown | tuple[BTCAddress, ...] | tuple[ChecksumAddress, ...] | tuple[SubstrateAddress, ...] | tuple[SolanaAddress, ...]`
- rotkehlchen/chain/decoding/tools.py:98:13: error[invalid-argument-type] Argument to function `decode_transfer_direction` is incorrect: Expected `(A@BaseDecoderTools &amp; BTCAddress) | (A@BaseDecoderTools &amp; ChecksumAddress) | (A@BaseDecoderTools &amp; SubstrateAddress) | (A@BaseDecoderTools &amp; SolanaAddress) | None`, found `A@BaseDecoderTools | None`
- rotkehlchen/chain/decoding/tools.py:99:13: error[invalid-argument-type] Argument to function `decode_transfer_direction` is incorrect: Expected `Sequence[(A@BaseDecoderTools &amp; BTCAddress) | (A@BaseDecoderTools &amp; ChecksumAddress) | (A@BaseDecoderTools &amp; SubstrateAddress) | (A@BaseDecoderTools &amp; SolanaAddress)]`, found `Unknown | tuple[BTCAddress, ...] | tuple[ChecksumAddress, ...] | tuple[SubstrateAddress, ...] | tuple[SolanaAddress, ...]`
- Found 2082 diagnostics
+ Found 2080 diagnostics

pandas-stubs (https://github.com/pandas-dev/pandas-stubs)
- tests/test_groupby.py:439:11: error[type-assertion-failure] Type `Series[Any]` does not match asserted type `Series[(str &amp; Any) | (bytes &amp; Any) | (int &amp; Any) | ... omitted 12 union elements]`
+ tests/test_groupby.py:439:11: error[type-assertion-failure] Type `Series[Any]` does not match asserted type `Series[(Any &amp; str) | (Any &amp; bytes) | (Any &amp; int) | ... omitted 12 union elements]`
- tests/test_resampler.py:402:11: error[type-assertion-failure] Type `Series[Any]` does not match asserted type `Series[(str &amp; Any) | (bytes &amp; Any) | (int &amp; Any) | ... omitted 12 union elements]`
+ tests/test_resampler.py:402:11: error[type-assertion-failure] Type `Series[Any]` does not match asserted type `Series[(Any &amp; str) | (Any &amp; bytes) | (Any &amp; int) | ... omitted 12 union elements]`

core (https://github.com/home-assistant/core)
- homeassistant/util/variance.py:47:12: error[invalid-return-type] Return type does not match returned value: expected `(**_P@ignore_variance) -&gt; _R@ignore_variance`, found `_Wrapped[_P@ignore_variance, _R@ignore_variance | int | float | datetime, _P@ignore_variance, _R@ignore_variance | int | float | datetime]`
- Found 14392 diagnostics
+ Found 14391 diagnostics

scipy (https://github.com/scipy/scipy)
- scipy/stats/_continuous_distns.py:2853:45: error[unsupported-operator] Operator `/` is not supported between objects of type `Literal[2]` and `None | Unknown`
+ scipy/stats/_continuous_distns.py:2853:45: error[unsupported-operator] Operator `/` is not supported between objects of type `Literal[2]` and `None | @Todo`
- scipy/stats/_continuous_distns.py:2853:63: error[unsupported-operator] Operator `/` is not supported between objects of type `Literal[1]` and `None | Unknown`
+ scipy/stats/_continuous_distns.py:2853:63: error[unsupported-operator] Operator `/` is not supported between objects of type `Literal[1]` and `None | @Todo`
- scipy/stats/_continuous_distns.py:2859:42: error[unsupported-operator] Operator `/` is not supported between objects of type `Literal[1]` and `None | Unknown`
+ scipy/stats/_continuous_distns.py:2859:42: error[unsupported-operator] Operator `/` is not supported between objects of type `Literal[1]` and `None | @Todo`
- scipy/stats/_continuous_distns.py:9883:33: error[unsupported-operator] Operator `**` is not supported between objects of type `Unknown | None` and `Literal[2]`
+ scipy/stats/_continuous_distns.py:9883:33: error[unsupported-operator] Operator `**` is not supported between objects of type `@Todo | None` and `Literal[2]`

pydantic (https://github.com/pydantic/pydantic)
- pydantic/fields.py:943:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
+ pydantic/fields.py:943:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
- pydantic/fields.py:983:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
+ pydantic/fields.py:983:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
- pydantic/fields.py:1026:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
+ pydantic/fields.py:1026:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
- pydantic/fields.py:1066:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
+ pydantic/fields.py:1066:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
- pydantic/fields.py:1109:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
+ pydantic/fields.py:1109:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
- pydantic/fields.py:1148:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
+ pydantic/fields.py:1148:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
- pydantic/fields.py:1188:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
+ pydantic/fields.py:1188:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
- pydantic/fields.py:1567:13: error[invalid-argument-type] Argument is incorrect: Expected `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`, found `Top[dict[Unknown, Unknown]] | (((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) &amp; ~Top[dict[Unknown, Unknown]]) | None`
+ pydantic/fields.py:1567:13: error[invalid-argument-type] Argument is incorrect: Expected `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`, found `Top[dict[Unknown, Unknown]] | (((dict[str, Divergent], /) -&gt; None) &amp; ~Top[dict[Unknown, Unknown]]) | None`


</code></pre>
</details>

<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @ntBre on 2025-12-17 14:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Apply narrowing to `len` calls based on argument size" to "[ty] Apply narrowing to `len` calls based on argument size" by @charliermarsh on 2025-12-17 14:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2025-12-17 14:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @charliermarsh on 2025-12-17 14:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @charliermarsh on 2025-12-17 14:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @charliermarsh on 2025-12-17 14:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @charliermarsh on 2025-12-17 14:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by @AlexWaygood on 2025-12-17 14:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-17 14:21</div>
            <div class="timeline-body"><!-- generated-comment ty ecosystem-analyzer -->

<h2><code>ecosystem-analyzer</code> results</h2>
<p>| Lint rule | Added | Removed | Changed |
|-----------|------:|--------:|--------:|
| <code>invalid-argument-type</code> | 0 | 2 | 45 |
| <code>invalid-return-type</code> | 0 | 2 | 3 |
| <code>unsupported-operator</code> | 0 | 1 | 4 |
| <code>unused-ignore-comment</code> | 4 | 0 | 0 |
| <code>possibly-missing-attribute</code> | 0 | 0 | 2 |
| <code>type-assertion-failure</code> | 0 | 0 | 2 |
| <code>non-subscriptable</code> | 0 | 1 | 0 |
| <strong>Total</strong> | <strong>4</strong> | <strong>6</strong> | <strong>56</strong> |</p>
<p><strong><a href="https://charlie-len.ecosystem-663.pages.dev/diff">Full report with detailed diff</a></strong> (<a href="https://charlie-len.ecosystem-663.pages.dev/timing">timing results</a>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-12-17 14:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/narrow.rs</code>:912 on 2025-12-17 14:22</div>
            <div class="timeline-body"><p>this introduces an unsoundness: it's possible that a user class could have a <code>__bool__</code> method that &quot;disagrees&quot; with its <code>__len__</code> method, which would mean that we would apply incorrect narrowing here. For example:</p>
<pre><code class="language-py">from typing import Literal

class Tricksy:
    def __bool__(self) -&gt; Literal[True]:
        return True

    def __len__(self):
        return 0

def f(x: Tricksy | Literal[&quot;&quot;]):
    if len(x):
        reveal_type(x)  # `Tricksy` on your PR, but unreachable at runtime
    else:
        reveal_type(x)  # `Literal[&quot;&quot;]` on your PR, but reachable at runtime
                        # even if an instance of `Tricksy` was passed in
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-12-17 14:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/narrow.rs</code>:912 on 2025-12-17 14:25</div>
            <div class="timeline-body"><p>To address the unsoundness, I think we should <em>only</em> apply this narrowing if the pre-existing type is one of the following types, or a union of the following types. We know that there can be no subtypes of these types, and we know that their <code>__bool__</code>/<code>__len__</code> methods are well-behaved:</p>
<ul>
<li><p>String-literal types</p>
</li>
<li><p>Bytes-literal types</p>
</li>
<li><p><code>LiteralString</code></p>
</li>
<li><p>nominal-instance types with tuple specs.</p>
<p>These <em>can</em> be subtyped, but we already have plans to emit a diagnostic if a user creates a subclass of <code>tuple</code> where the <code>__bool__</code> method &quot;disagrees&quot; with the <code>__len__</code> method.</p>
</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-12-17 14:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ty_python_semantic/src/types/narrow.rs</code>:912 on 2025-12-17 14:29</div>
            <div class="timeline-body"><p>Are there any examples elsewhere of how we handle this? (Is it a blocking concern?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-12-17 14:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/narrow.rs</code>:912 on 2025-12-17 14:32</div>
            <div class="timeline-body"><blockquote>
<p>Is it a blocking concern?</p>
</blockquote>
<p>I think so? We've tried very hard to respect this kind of soundness in our narrowing so far</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-12-17 14:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/narrow.rs</code>:912 on 2025-12-17 14:33</div>
            <div class="timeline-body"><blockquote>
<p>Are there any examples elsewhere of how we handle this?</p>
</blockquote>
<p>we do something similar for <code>==</code> narrowing here: https://github.com/astral-sh/ruff/blob/421f88bb327c8d4685a5e5cf4ca92533d30ef698/crates/ty_python_semantic/src/types/narrow.rs#L488-L603</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ty_python_semantic/src/types/narrow.rs</code>:912 on 2025-12-17 14:35</div>
            <div class="timeline-body"><p>(Sorry I wrote my comment before seeing your reply. Thank you!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-12-17 14:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-12-17 14:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ty_python_semantic/src/types/narrow.rs</code>:912 on 2025-12-17 14:45</div>
            <div class="timeline-body"><p>So does that mean we can't narrow <code>str</code> or <code>list</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-12-17 15:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/narrow.rs</code>:912 on 2025-12-17 15:01</div>
            <div class="timeline-body"><p>I think so -- you might have a user subclass of either of those that overrides <code>__len__</code> or <code>__bool__</code> in a naughty way.</p>
<p>Like, it might be that we're being way too pedantic about this at the moment. I think that's a very valid concern. There are some issues open asking if our current behaviour for <code>==</code> narrowing is way too pedantic, because we currently only narrow in situations where we can prove it's sound (where we can prove it's impossible to have a subtype with a naughty <code>__eq__</code> or <code>__ne__</code> method).</p>
<p>But I think our narrowing here should, at the moment, be consistent with our <code>==</code> narrowing. If we want to change our behaviour for this kind of thing, we should change it all together for our various forms of narrowing. Inconsistent behaviour for this kind of thing would be really confusing</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-12-17 15:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ty_python_semantic/src/types/narrow.rs</code>:912 on 2025-12-17 15:28</div>
            <div class="timeline-body"><p>In the case from the linked issue though:</p>
<pre><code class="language-python">lines: list[str] = [&quot;foo&quot;, &quot;bar&quot;, &quot;baz&quot;]
for line in lines:
    if not line:
        continue

    value = line if len(line) &lt; 3 else &quot;&quot;
    if len(value) and value[0] == &quot; &quot;:
        value = value[1:]
</code></pre>
<p>Am I right that we actually <em>could</em> support this (even ignoring the fact that it's defined with string literals) because we have <code>if not line:</code> within the loop? So we actually <em>do</em> know that <code>__bool__</code> will not return <code>False</code> in this case?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-12-17 15:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/narrow.rs</code>:912 on 2025-12-17 15:35</div>
            <div class="timeline-body"><p>you have to keep track of exactly how many items are in the list in order to know whether <code>bool(x)</code> is going to continue returning <code>True</code> or <code>False</code> in a consistent way across a function, if <code>x</code> has type <code>list[str]</code>. If the list becomes empty, it's now falsy. That's quite a hard analysis to pull off.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-12-17 15:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ty_python_semantic/src/types/narrow.rs</code>:912 on 2025-12-17 15:43</div>
            <div class="timeline-body"><p>I'm referring to <code>line</code> here, not <code>lines</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-12-17 15:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/narrow.rs</code>:912 on 2025-12-17 15:45</div>
            <div class="timeline-body"><p>ah, sorry. But an object of type <code>list[str]</code> could have mutable user subclasses of <code>str</code> in it, and those user subclasses of <code>str</code> could have <code>__bool__</code> methods that are inconsistent about their truthiness in a similar way to how <code>list</code> is...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-12-17 15:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ty_python_semantic/src/types/narrow.rs</code>:912 on 2025-12-17 15:48</div>
            <div class="timeline-body"><p>But by the time we get to <code>value = value[1:]</code>, we have checked <em>both</em> <code>if line</code> and <code>len(line)</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/narrow/len.md</code>:63 on 2025-12-17 17:31</div>
            <div class="timeline-body"><p>you could <em>possibly</em> add TODOs here that ideally we'd narrow these types further, e.g. to</p>
<pre><code class="language-suggestion">    if len(x):
        reveal_type(x)  # revealed: tuple[int, ...] &amp; ~tuple[()]
    else:
        reveal_type(x)  # revealed: tuple[()]
</code></pre>
<p>(which is related to https://github.com/astral-sh/ty/issues/560)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/narrow/len.md</code>:91 on 2025-12-17 17:35</div>
            <div class="timeline-body"><p>and even if it couldn't: the <code>__bool__</code> of <code>list</code> can anyway give inconsistent results throughout the course of a function. E.g. if you have this, say we know for sure that <code>x</code> is <em>exactly</em> <code>list[int]</code>, not a subclass thereof:</p>
<pre><code class="language-py">def f(x: list[int]):
    if len(x):
        reveal_type(x)  # say we infer it as `list[int] &amp; AlwaysTruthy` now
        x.clear()
        reveal_type(x)  # what's the type now? Still `list[int] &amp; AlwaysTruthy`?
                        # how do we detect that the `.clear()` call invalidates the previous narrowing?

        do_something_with_x(x)  # does _this_ function call invalidate the narrowing?
                                # it's a black box to us: we don't know what happens inside it
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/narrow/len.md</code>:121 on 2025-12-17 17:36</div>
            <div class="timeline-body"><p>you could assert these with <code>reveal_type</code> calls, to make sure that the comments don't go out of date</p>
<pre><code class="language-suggestion">        reveal_type(line) # revealed: str &amp; ~AlwaysFalsy
        value = line if len(line) &lt; 3 else &quot;&quot;
        reveal_type(value)  # revealed: (str &amp; ~AlwaysFalsy) | Literal[&quot;&quot;]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-12-17 17:43</div>
            <div class="timeline-body"><p>Thank you. This looks great</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2025-12-17 18:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-12-17 18:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-12-17 18:16</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:42:36 UTC
    </footer>
</body>
</html>
