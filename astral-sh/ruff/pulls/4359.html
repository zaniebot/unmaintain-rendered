<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Re-integrate RustPython parser repository - astral-sh/ruff #4359</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Re-integrate RustPython parser repository</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4359">#4359</a>
        opened by <a href="https://github.com/youknowone">@youknowone</a>
        on 2023-05-10 19:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/youknowone">@youknowone</a></div>
            <div class="timeline-body"><p><em>No description provided.</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/youknowone">@youknowone</a> on <code>crates/ruff/src/rules/flake8_bandit/helpers.rs</code>:16 on 2023-05-10 19:54</div>
            <div class="timeline-body"><p>You may worry about this patterns by looking more verbose than before. Enum definition is changed to be using struct of enums. This is transitional state and it can be written like this later:</p>
<pre><code class="language-suggestion">        ExprKind::Constant(constant) =&gt; Some(constant.value)
</code></pre>
<p>By allowing adding methods to <code>ast::ExprConstant</code> structs unlike before, it will be even better in the future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/youknowone">@youknowone</a> reviewed on 2023-05-10 19:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/youknowone">@youknowone</a> on <code>crates/ruff/src/rules/flake8_2020/rules.rs</code>:188 on 2023-05-10 19:55</div>
            <div class="timeline-body"><p>The name is changed not to be confusing with types using <code>SourceLocation</code>. This is also fitting better to CPython definition. (with_attributes)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @charliermarsh on 2023-05-10 19:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/youknowone">@youknowone</a> reviewed on 2023-05-10 20:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/youknowone">@youknowone</a> on 2023-05-10 20:16</div>
            <div class="timeline-body"><p>The failing tests seems not related and looks like github actions problem.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-05-10 20:51</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.01     13.8Â±0.06ms     2.9 MB/sec    1.00     13.7Â±0.08ms     3.0 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.4Â±0.02ms     4.9 MB/sec    1.00      3.4Â±0.01ms     4.9 MB/sec
linter/all-rules/numpy/globals.py          1.01    417.6Â±3.02Âµs     7.1 MB/sec    1.00    415.2Â±2.72Âµs     7.1 MB/sec
linter/all-rules/pydantic/types.py         1.01      5.8Â±0.04ms     4.4 MB/sec    1.00      5.7Â±0.02ms     4.5 MB/sec
linter/default-rules/large/dataset.py      1.01      6.8Â±0.02ms     6.0 MB/sec    1.00      6.7Â±0.02ms     6.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01   1468.7Â±5.42Âµs    11.3 MB/sec    1.00   1447.7Â±5.39Âµs    11.5 MB/sec
linter/default-rules/numpy/globals.py      1.01    163.2Â±0.45Âµs    18.1 MB/sec    1.00    161.8Â±0.64Âµs    18.2 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.1Â±0.01ms     8.3 MB/sec    1.00      3.0Â±0.01ms     8.4 MB/sec
parser/large/dataset.py                    1.00      5.4Â±0.02ms     7.6 MB/sec    1.10      5.9Â±0.01ms     6.9 MB/sec
parser/numpy/ctypeslib.py                  1.00   1043.4Â±0.96Âµs    16.0 MB/sec    1.08   1123.4Â±0.93Âµs    14.8 MB/sec
parser/numpy/globals.py                    1.00    106.4Â±0.36Âµs    27.7 MB/sec    1.06    113.1Â±0.24Âµs    26.1 MB/sec
parser/pydantic/types.py                   1.00      2.3Â±0.00ms    11.2 MB/sec    1.08      2.5Â±0.01ms    10.3 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.03     16.9Â±0.43ms     2.4 MB/sec    1.00     16.4Â±0.19ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.2Â±0.07ms     4.0 MB/sec    1.00      4.2Â±0.06ms     4.0 MB/sec
linter/all-rules/numpy/globals.py          1.00   494.5Â±11.36Âµs     6.0 MB/sec    1.00    492.1Â±8.58Âµs     6.0 MB/sec
linter/all-rules/pydantic/types.py         1.01      7.0Â±0.18ms     3.6 MB/sec    1.00      6.9Â±0.08ms     3.7 MB/sec
linter/default-rules/large/dataset.py      1.02      8.4Â±0.12ms     4.9 MB/sec    1.00      8.2Â±0.10ms     5.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1741.8Â±28.59Âµs     9.6 MB/sec    1.00  1737.9Â±19.68Âµs     9.6 MB/sec
linter/default-rules/numpy/globals.py      1.00    196.5Â±4.64Âµs    15.0 MB/sec    1.01    198.9Â±4.72Âµs    14.8 MB/sec
linter/default-rules/pydantic/types.py     1.02      3.7Â±0.07ms     6.8 MB/sec    1.00      3.7Â±0.04ms     6.9 MB/sec
parser/large/dataset.py                    1.01      6.7Â±0.12ms     6.1 MB/sec    1.00      6.6Â±0.07ms     6.1 MB/sec
parser/numpy/ctypeslib.py                  1.00  1259.1Â±20.16Âµs    13.2 MB/sec    1.00  1253.8Â±16.40Âµs    13.3 MB/sec
parser/numpy/globals.py                    1.01    127.8Â±2.50Âµs    23.1 MB/sec    1.00    126.7Â±1.66Âµs    23.3 MB/sec
parser/pydantic/types.py                   1.01      2.8Â±0.07ms     9.0 MB/sec    1.00      2.8Â±0.03ms     9.1 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-10 21:06</div>
            <div class="timeline-body"><p>Oh very interesting, we now have separate structs for each variant. I'd love to get @MichaReiser's review.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/youknowone">@youknowone</a> on 2023-05-11 05:14</div>
            <div class="timeline-body"><p>Does udeps error related to this change? Not sure i have to fix it or not</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/youknowone">@youknowone</a> on 2023-05-11 06:14</div>
            <div class="timeline-body"><p>The struct BestFitting is actually same named in 2 modules and used as public.
Renaming one seems better. Not sure why it is only triggered on this patch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_2020/rules.rs</code>:188 on 2023-05-11 06:16</div>
            <div class="timeline-body"><p>I personally find <code>Attributed</code> somewhat more difficult to understand than <code>Located</code> because it's very generic. Attributed with what. But I don't feel strongly about it.</p>
<p>A term that is used by many other compilers for a wrapper that adds source locations is <a href="https://www.google.com/search?client=firefox-b-d&amp;q=rust+spanned"><code>Spanned</code></a> or (since we don't have a span type), could also name it <code>Ranged</code>. But again, I'm okay with keeping it. Just my two cents ;)</p>
<p>Note: I'm exploring how we can have location information on every node. We'll probably need this to correctly associate comments with nodes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-11 06:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-11 06:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_bandit/helpers.rs</code>:16 on 2023-05-11 06:17</div>
            <div class="timeline-body"><p>I like it! The possibility for adding methods to <code>ExprConstant</code>, and that we can now pass specific <code>Stmt</code> instead of passing <code>Stmt</code> and than unwrapping a specific kind makes the API much more ergonomic</p>
<p>The methods that I found very useful (besides methods that are specific to the node kind) to have on the union types when working at Rome were</p>
<ul>
<li><code>as_&lt;node&gt;</code>: Returns an <code>Option&lt;&amp;&lt;Node&gt;&gt;</code> if the variant is <code>&lt;Node&gt;</code> or <code>None</code> otherwise</li>
<li><code>into_&lt;node&gt;</code>: The same as <code>as_node</code> but consumes <code>self</code> and returns an owned version</li>
<li><code>is_&lt;node&gt;</code>: Tests if it holds the variant <code>&lt;node&gt;</code></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>Cargo.lock</code>:147 on 2023-05-11 06:19</div>
            <div class="timeline-body"><p>Oh nice, so many removed dependencies. This removes our total dependencies from 354 to 335!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_bugbear/rules/assignment_to_os_environ.rs</code>:26 on 2023-05-11 06:32</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    if attr != &quot;environ&quot; {
</code></pre>
<p>This change isn't necessary because <code>Identifier</code> implements <code>PartialEq&lt;str&gt;</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_comprehensions/rules/unnecessary_list_call.rs</code>:48 on 2023-05-11 06:34</div>
            <div class="timeline-body"><p>Idea: It would be nice to have <code>argument.is_&lt;node&gt;()</code> methods on unions so that we could simplify this to</p>
<pre><code class="language-rust">if !argument.is_list_comp() {
	...
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_django/rules/model_without_dunder_str.rs</code>:100 on 2023-05-11 06:36</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        if name  != &quot;Meta&quot; {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/pep8_naming/rules/invalid_first_argument_name_for_class_method.rs</code>:79 on 2023-05-11 06:48</div>
            <div class="timeline-body"><p>Would it make sense to also implement <code>PartialEq&lt;str&gt; for String</code> and <code>PartialEq&lt;String&gt; for &amp;str</code> and (the same for <code>std::String</code>)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-05-11 06:52</div>
            <div class="timeline-body"><p>This is awesome. I was just thinking yesterday that I should look into how we can change our fork to fork the <code>Parser</code> repository instead and if we should introduce named variants for enums... and a few hours later, there's this PR!</p>
<p>There are so many good things in here. I plan to merge this today, and we can discuss and solve some of the smaller nits later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-05-11 06:53</div>
            <div class="timeline-body"><p>Should <code>String</code> and <code>Identifier</code> implement <code>Deref&lt;str&gt;</code>. It could simplify some of the code (e.g <code>option.as_deref()</code> would give you a <code>Option&lt;&amp;str&gt;</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/youknowone">@youknowone</a> reviewed on 2023-05-11 06:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/youknowone">@youknowone</a> on <code>crates/ruff/src/rules/flake8_comprehensions/rules/unnecessary_list_call.rs</code>:48 on 2023-05-11 06:54</div>
            <div class="timeline-body"><p>Yes, definitely. Actually that's also done in my local repository a few hours ago xD</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/youknowone">@youknowone</a> on 2023-05-11 07:26</div>
            <div class="timeline-body"><p>I removed unnecessary <code>.as_str()</code> and made <code>Deref&lt;str&gt; for Identifier</code>. I wish I reverted them correctly.
@MichaReiser what should I do for udeps error?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-05-11 07:30</div>
            <div class="timeline-body"><p>Build-time:</p>
<ul>
<li>Reduces the Total units for release builds from 345 to 309</li>
<li>Reduces build time from 113 to 107s</li>
</ul>
<p>Binary:</p>
<ul>
<li>Increases by ~100Kb</li>
</ul>
<p>Enum Sizes:
The size of <code>StmtKind</code> and <code>ExprKind</code> hasn't changed (They're still huge with 128 and 64 bytes, maybe we can reduce some of them by using <code>ThinVec</code>?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-05-11 07:34</div>
            <div class="timeline-body"><blockquote>
<p>I removed unnecessary <code>.as_str()</code> and made <code>Deref&lt;str&gt; for Identifier</code>. I wish I reverted them correctly. @MichaReiser what should I do for udeps error?</p>
</blockquote>
<p>Running <code>udeps</code> locally gives me:</p>
<pre><code class="language-bash">cargo +nightly udeps
...
unused dependencies:
`ruff_python_ast v0.0.0 (/home/micha/astral/ruff/crates/ruff_python_ast)`
â””â”€â”€â”€ dependencies
     â””â”€â”€â”€ &quot;ruff_rustpython&quot;
`ruff_python_formatter v0.0.0 (/home/micha/astral/ruff/crates/ruff_python_formatter)`
â””â”€â”€â”€ dependencies
     â””â”€â”€â”€ &quot;rustpython-common&quot;
`ruff_rustpython v0.0.0 (/home/micha/astral/ruff/crates/ruff_rustpython)`
â””â”€â”€â”€ dependencies
     â”œâ”€â”€â”€ &quot;once_cell&quot;
     â””â”€â”€â”€ &quot;rustpython-common&quot;
Note: These dependencies might be used by other targets.
      To find dependencies that are not used by any target, enable `--all-targets`.
Note: They might be false-positive.
      For example, `cargo-udeps` cannot detect usage of crates that are only used in doc-tests.
      To ignore some dependencies, write `package.metadata.cargo-udeps.ignore` in Cargo.toml.
</code></pre>
<p>I'll look into it and push the changes so that we can then merge this right away</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/youknowone">@youknowone</a> on 2023-05-11 07:35</div>
            <div class="timeline-body"><p>Ah, i had to see that parts, not the warning parts. That's because common is replaced by literal in a few places. I will do it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/youknowone">@youknowone</a> reviewed on 2023-05-11 07:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/youknowone">@youknowone</a> on <code>crates/ruff/src/rules/flake8_2020/rules.rs</code>:188 on 2023-05-11 07:42</div>
            <div class="timeline-body"><p><code>Ranged</code> sounds good. Do you want it on this PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-11 07:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_2020/rules.rs</code>:188 on 2023-05-11 07:44</div>
            <div class="timeline-body"><p>We can do it in another PR to avoid unnecessary rebasing</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-05-11 07:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-05-11 07:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-05-11 07:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/youknowone">@youknowone</a> on 2023-05-11 07:49</div>
            <div class="timeline-body"><p>Thank you for quickly merging it! It literally was making conflict for every a few hours ðŸ¤£</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/youknowone">@youknowone</a> on 2023-05-11 07:53</div>
            <div class="timeline-body"><p>About the enum size, I think moving boxing point will be good.</p>
<p>e.g. <code>StmtFunctionDef</code> wraps <code>args</code> with box. But StmtKind actually can box every variant. Otherwise any variant that contains Box field inside.</p>
<pre><code>#[derive(Clone, Debug, PartialEq)]
pub struct StmtFunctionDef&lt;U = ()&gt; {
    pub name: Identifier,
    pub args: Box&lt;Arguments&lt;U&gt;&gt;,
    pub body: Vec&lt;Stmt&lt;U&gt;&gt;,
    pub decorator_list: Vec&lt;Expr&lt;U&gt;&gt;,
    pub returns: Option&lt;Box&lt;Expr&lt;U&gt;&gt;&gt;,
    pub type_comment: Option&lt;String&gt;,
}
</code></pre>
<p>Does it make sense?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2023-05-11 08:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-05-11 08:08</div>
            <div class="timeline-body"><p>Boxing every variant is what https://github.com/Boshen/oxc/blob/main/crates/oxc_ast/src/ast/js.rs does</p>
<p>The downside is that pattern matching can become somewhat annoying without using nightly features (at least, that's what I remember to have heard).</p>
<p>We may get away by only boxing the largest variants?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/youknowone">@youknowone</a> on 2023-05-11 08:22</div>
            <div class="timeline-body"><p>Do you have suggestions? The last option will be manually maintaining tables.
If we can do decide it from asdl data, it will be better.</p>
<p>currently <code>boxed</code> is related in https://github.com/RustPython/Parser/blob/main/ast/asdl_rs.py</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-05-11 09:06</div>
            <div class="timeline-body"><blockquote>
<p>Do you have suggestions? The last option will be manually maintaining tables. If we can do decide it from asdl data, it will be better.</p>
<p>currently <code>boxed</code> is related in <a href="https://github.com/RustPython/Parser/blob/main/ast/asdl_rs.py?rgh-link-date=2023-05-11T08%3A22%3A54Z">RustPython/Parser@<code>main</code>/ast/asdl_rs.py</a></p>
</blockquote>
<p>We can try boxing all of them to get a feel for the API's convenience.</p>
<p>I'm considering to inline <code>range</code> into every node and add a <code>Ranged</code> trait instead that each node and all unions implement:</p>
<pre><code class="language-rust">trait Ranged {
	fn range(&amp;self) -&gt; TextRange;

	fn start(&amp;self) -&gt; TextSize { self.range().start() }

	fn end(&amp;self) -&gt; TextSize { self.range().end() }
}
</code></pre>
<p>That removes the need for <code>Attributed</code> except for where someone wants to store a <code>custom</code> value with the node. For that use case I think it's best if a new struct is introduced per-use case (or we can keep <code>Attributed</code> around just for that use-case)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/youknowone">@youknowone</a> on 2023-05-11 09:11</div>
            <div class="timeline-body"><p>custom field also can be inlined to every node with <code>trait Custom</code>.
It will be easier to keep <code>Fold</code> working.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:57:21 UTC
    </footer>
</body>
</html>
