<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add initial implementation of goto definition for loads of local names - astral-sh/ruff #19123</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add initial implementation of goto definition for loads of local names</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19123">#19123</a>
        opened by <a href="https://github.com/Gankra">@Gankra</a>
        on 2025-07-03 15:15
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a></div>
            <div class="timeline-body"><p><em>No description provided.</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/Gankra">@Gankra</a> on 2025-07-03 15:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/Gankra">@Gankra</a> on 2025-07-03 15:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-03 18:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/src/semantic_model.rs</code>:175 on 2025-07-03 18:37</div>
            <div class="timeline-body"><p>This is basically the happy path of <code>TypeInferenceBuilder::infer_place_load</code>. It&#x27;s extremely limited because it can&#x27;t walk into parent scopes, and because it never engages type inference, it can&#x27;t reason about &quot;oh this is <code>MyClass.myfield</code>&quot;.</p>
<p>I feel like the more Correct solution we want here is to augment <code>infer_place_load</code> to also yield Definition info, and then run the whole TypeInferenceBuilder machinery just like <code>inferred_type</code> does.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-03 18:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/src/types/call/bind.rs</code>:2670 on 2025-07-03 18:37</div>
            <div class="timeline-body"><p>Oops.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-03 18:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_server/src/server/api/requests/goto_definition.rs</code>:21 on 2025-07-03 18:38</div>
            <div class="timeline-body"><p>Everything in this file is a copy of goto_type_definition but changed to goto_definition</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-03 18:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_ide/src/goto.rs</code>:947 on 2025-07-03 18:41</div>
            <div class="timeline-body"><p>This is the first non-trivial property of the current implementation: the &quot;definitions&quot; we yield are the bindings that dominate the load. This is a <em>useful</em> answer but obviously not the only possible one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-03 18:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_ide/src/goto.rs</code>:996 on 2025-07-03 18:42</div>
            <div class="timeline-body"><p>(in this case we point to both <code>ab = 1</code> (above) and <code>ab = 2</code> as both bindings can affect the load)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-03 18:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_ide/src/goto.rs</code>:1069 on 2025-07-03 18:43</div>
            <div class="timeline-body"><p>In this case there&#x27;s no bindings for <code>ab</code> so we fail to yield anything (suboptimal).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-03 18:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_ide/src/goto.rs</code>:1192 on 2025-07-03 18:46</div>
            <div class="timeline-body"><p>Any kind of Store completely falls over right now -- it seems like most of the code gives up when it sees Store, even if it&#x27;s also a Load, but maybe it&#x27;s handled by different paths? (in the playground <code>ab += 2</code> does seem to support getting the type of <code>ab</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-03 18:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_ide/src/goto.rs</code>:1221 on 2025-07-03 18:48</div>
            <div class="timeline-body"><p>Note that this is only working because the class is defined in the same scope. If <code>x = AB(5)</code> was in a function it would fail to resolve, because we don&#x27;t look into parent scopes. yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-03 18:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_ide/src/goto.rs</code>:1257 on 2025-07-03 18:48</div>
            <div class="timeline-body"><p>This one is hopeless without type info.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-03 18:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_ide/src/goto.rs</code>:1301 on 2025-07-03 18:49</div>
            <div class="timeline-body"><p>Similarly hopeless without type info</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_ide/src/goto.rs</code>:1364 on 2025-07-03 18:50</div>
            <div class="timeline-body"><p>Globals of course fail here without processing of parent scopes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-03 18:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-03 23:24</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/requests/goto_definition.rs</code>:57 on 2025-07-08 11:33</div>
            <div class="timeline-body"><p>This should use the <code>linkSupport</code> value from the <code>DefinitionClientCapabilities</code> instead: https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#textDocument_definition</p>
<p>You&#x27;ll need to add a new <code>definition_link_support</code> field in <code>ResolvedClientCapabilities</code> which takes it&#x27;s value from <code>document.definition.link_support</code>. Refer to how <code>type_definition_link_support</code> is being computed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_python_semantic/src/semantic_model.rs</code>:207 on 2025-07-08 11:38</div>
            <div class="timeline-body"><p>I think we can include <code>ExprContext::Del</code> here as the following should go to the definition of <code>x</code>:</p>
<pre><code>def _():
    x = 1
    del x&lt;CURSOR&gt;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_python_semantic/src/semantic_model.rs</code>:206 on 2025-07-08 11:39</div>
            <div class="timeline-body"><p>This might a bit tricky because the definition that corresponds to this expression itself should also be included in the list of definitions. For example, here both definitions should be included:</p>
<pre><code>def _():
    x = 1
    x&lt;CURSOR&gt; = 2
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_ide/src/goto.rs</code>:1192 on 2025-07-08 11:51</div>
            <div class="timeline-body"><p>Yeah, augmented assignments are both <code>LOAD</code> and <code>STORE</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_python_semantic/src/semantic_model.rs</code>:205 on 2025-07-08 11:52</div>
            <div class="timeline-body"><p>Oh hmm, I see what you mean based on what you mentioned on Discord. So, this implementation would be limited to only provide definitions if they&#x27;re defined in the current scope, right? The following doesn&#x27;t work:</p>
<pre><code>x = 1


def _():
    x&lt;CURSOR&gt;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_ide/src/goto.rs</code>:58 on 2025-07-08 11:55</div>
            <div class="timeline-body"><p>Why do we require to call <code>unique</code> here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-08 12:15</div>
            <div class="timeline-body"><p>Thanks for taking this on! This seems like a good start but I&#x27;m a bit hesitant on shipping this based on the limitation that this only works if both the definition and usage are in the same scope.</p>
<p>The reason this limitation exists for goto definition and not goto type definition is because the former is only looking at the scope of the expression where it&#x27;s being used while the latter is performing the type inference and fetching the list of definitions from <code>Type</code> instead (<code>Type::definition</code>). I think you&#x27;re most likely aware of this already.</p>
<p>The reason it&#x27;s fine for goto type definition is because we actually need the type definition which would either be in the stub file (if present) or the runtime file. This is the behavior of type inference in ty so it falls out naturally in the LSP.</p>
<p>For goto definition, I think we&#x27;ll need something else. One way to solve this would be the following which is a bit high level:</p>
<ol>
<li>This is something that Eric mentioned -- create a source mapping between the definitions in runtime and stub file</li>
<li>Use the same path as goto type definition but use the above mapping to get the corresponding runtime definition instead of the type definition</li>
</ol>
<p>But to decrease the scope, we could probably ship a limited version which performs the same steps as goto type definition but filters out all the targets that would lead to a stub file and only return the ones that are present in the runtime files. This does mean that goto definition on any builtin symbols or the ones originating in the standard library wouldn&#x27;t work because they all go to the stub files present in typeshed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-08 12:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_ide/src/goto.rs</code>:1069 on 2025-07-08 12:16</div>
            <div class="timeline-body"><p>This would be part of goto declarations instead :)</p>
<p>https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#textDocument_declaration</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_ide/src/goto.rs</code>:33 on 2025-07-08 12:18</div>
            <div class="timeline-body"><p>I think we should split this into two files: <code>goto_type_definition.rs</code> and <code>goto_definition.rs</code> to isolate the logic and the tests. I&#x27;m not exactly sure where should the shared logic reside in, maybe the <code>goto.rs</code> could be used for that but that sounds a bit confusing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_ide/src/goto.rs</code>:1416 on 2025-07-08 12:20</div>
            <div class="timeline-body"><p>We might want to create a generic <code>GotoDiagnostic</code> which takes in an enum that specifies which kind it is: <code>GotoKind::Definition</code>, <code>GotoKind::TypeDefinition</code>, <code>GotoKind::Declaration</code>, etc.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-08 12:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-08 13:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_ide/src/goto.rs</code>:58 on 2025-07-08 13:43</div>
            <div class="timeline-body"><p>For whatever reason it&#x27;s the constructor that takes a list (the name was concerning, but, it works?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-08 13:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/src/semantic_model.rs</code>:205 on 2025-07-08 13:44</div>
            <div class="timeline-body"><p>Yes correct.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-08 13:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_server/src/server/api/requests/goto_definition.rs</code>:57 on 2025-07-08 13:45</div>
            <div class="timeline-body"><p>Hmm what distinguishes this from goto_type_definition, which has the same impl? (or is this a &quot;also fix goto_type_definition&quot;?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-08 14:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/goto.rs</code>:58 on 2025-07-08 14:15</div>
            <div class="timeline-body"><p>The idea behind using unique here is that, at least for go to type definition, we want to avoid showing the same definition twice. E.g. if you have a <code>Class&lt;str&gt; | Class&lt;int&gt;</code> type. We only want to list one target because both those type point to the generic <code>Class&lt;T&gt;</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-08 14:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/requests/goto_definition.rs</code>:57 on 2025-07-08 14:39</div>
            <div class="timeline-body"><p>These are the client capabilities, so if a client has link support for goto type definition but not for goto definition (for whatever reason), the server needs to respect that. These capabilities are provided to the server during initialization where we make note of all the things that the client supports through which the server needs to make certain decisions. This is one of them.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-08 14:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_ide/src/goto.rs</code>:58 on 2025-07-08 14:42</div>
            <div class="timeline-body"><p>Thanks, I think this makes sense for goto definitions as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-18 13:45</div>
            <div class="timeline-body"><p>I&#x27;ll close this, given that ty now supports basic go to definition (which I think was based on this PR)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-18 13:45</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:16:13 UTC
    </footer>
</body>
</html>
