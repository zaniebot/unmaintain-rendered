<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Speedup the `known_class_doesnt_fallback_to_unknown_unexpectedly_on_low_python_version` test - astral-sh/ruff #19760</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Speedup the <code>known_class_doesnt_fallback_to_unknown_unexpectedly_on_low_python_version</code> test</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19760">#19760</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-08-05 11:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-05 11:51</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This test takes &gt;5s locally for me on <code>main</code>, which makes it our slowest unit test by far:</p>
<pre><code>~/dev/ruff (main)⚡ % cargo test -p ty_python_semantic --lib -- known_class_doesnt_fallback_to_unknown_unexpectedly_on_low_python_version
    Finished `test` profile [unoptimized + debuginfo] target(s) in 0.09s
     Running unittests src/lib.rs (target/debug/deps/ty_python_semantic-346dd082aa08053a)

running 1 test
test types::class::tests::known_class_doesnt_fallback_to_unknown_unexpectedly_on_low_python_version ... ok

test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 242 filtered out; finished in 5.30s
</code></pre>
<p>The slowness appears to be due to the fact that we're repeatedly changing the target Python version in a hot loop. This PR changes the test so that we only change the target Python version when it's actually necessary to do so, which brings the execution time of the test down to 0.39s for me locally:</p>
<pre><code>~/dev/ruff (alex/speedup-test)⚡ % cargo test -p ty_python_semantic --lib -- known_class_doesnt_fallback_to_unknown_unexpectedly_on_low_python_version
    Finished `test` profile [unoptimized + debuginfo] target(s) in 0.12s
     Running unittests src/lib.rs (target/debug/deps/ty_python_semantic-346dd082aa08053a)

running 1 test
test types::class::tests::known_class_doesnt_fallback_to_unknown_unexpectedly_on_low_python_version ... ok

test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 242 filtered out; finished in 0.39s
</code></pre>
<p>In turn, this brings the total execution time of <code>cargo test -p ty_python_semantic --lib</code> down from 6.67s to 0.54s.</p>
<h2>Test Plan</h2>
<p>^See above</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-08-05 11:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-08-05 11:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @AlexWaygood on 2025-08-05 11:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by @AlexWaygood on 2025-08-05 11:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-08-05 11:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-05 11:53</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-08-05 11:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-08-05 11:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-05 11:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-05 11:55</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:52:43 UTC
    </footer>
</body>
</html>
