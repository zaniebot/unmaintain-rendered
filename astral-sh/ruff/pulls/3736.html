<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>perf(pycodestyle): Refactor checks to iterate over tokens insteadof text - astral-sh/ruff #3736</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>perf(pycodestyle): Refactor checks to iterate over tokens insteadof text</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/3736">#3736</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-03-26 00:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-03-26 00:29</div>
            <div class="timeline-body"><p>This PR refactors the pycodestyle checks to iterate over the tokens instead of the text. The main motivation is that using <code>Regex</code> to match keywords and operators seems overkill because this has already been done when tokenizing the input. Besides avoiding Regex, the main benefit of this is that it allows removing the creation of the logical-line String and the mapping table from offset to Location (and calling into the mapping logic). This also reduces the overall memory consumption.</p>
<h2>Notes</h2>
<p>The constructed <em>logical-lines</em> <code>String</code> omitted any <code>Dedent</code>, <code>Indent</code>, <code>Newline</code> tokens and it inserted a <code> </code> to join two lines in an expression spawning multiple physical lines.</p>
<pre><code class="language-python">a = [
  1,
  2,
]
</code></pre>
<p>The normalized string for this example is <code>a = [1, 2]</code></p>
<p>I don't think we need to rely on the normalized string representation for this and instead can implement the same behavior lazily in <code>Whitespace::trailing</code> and <code>Whitespace::leading</code> to stop counting if we see a newline character.</p>
<h2>Performance</h2>
<ul>
<li><code>no-logical</code>: Main with logical lines disabled</li>
<li><code>pr3735</code>: Base ref with logical lines enabled</li>
<li><code>pr3736</code>: This branch with logical lines enabled</li>
</ul>
<pre><code>group                                      no-logical                             pr3735                                  pr3736
-----                                      ----------                             -----                                  ------
linter/all-rules/large/dataset.py          1.00      8.5Â±0.01ms     4.8 MB/sec    1.10      9.4Â±0.05ms     4.3 MB/sec    1.03      8.8Â±0.06ms     4.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      2.1Â±0.01ms     7.8 MB/sec    1.09      2.3Â±0.00ms     7.1 MB/sec    1.03      2.2Â±0.02ms     7.6 MB/sec
linter/all-rules/numpy/globals.py          1.00    247.9Â±3.25Âµs    11.9 MB/sec    1.10    272.6Â±1.25Âµs    10.8 MB/sec    1.06    262.9Â±2.80Âµs    11.2 MB/sec
linter/all-rules/pydantic/types.py         1.00      3.7Â±0.04ms     7.0 MB/sec    1.11      4.1Â±0.07ms     6.3 MB/sec    1.05      3.8Â±0.03ms     6.6 MB/sec
linter/default-rules/large/dataset.py      1.00      4.7Â±0.01ms     8.7 MB/sec    1.19      5.6Â±0.11ms     7.3 MB/sec    1.10      5.1Â±0.01ms     7.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00    999.5Â±5.57Âµs    16.7 MB/sec    1.22   1216.5Â±2.35Âµs    13.7 MB/sec    1.09  1094.1Â±21.26Âµs    15.2 MB/sec
linter/default-rules/numpy/globals.py      1.00    101.0Â±0.41Âµs    29.2 MB/sec    1.36    137.5Â±1.36Âµs    21.5 MB/sec    1.21    122.7Â±0.41Âµs    24.0 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.1Â±0.01ms    11.9 MB/sec    1.19      2.5Â±0.06ms    10.0 MB/sec    1.09      2.3Â±0.01ms    10.9 MB/sec

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-03-26 00:29</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #3714</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3714" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #3715</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3715" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #3735</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3735" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #3736</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3736" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ<ul>
<li><strong>PR #3745</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3745" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>
* <strong>PR #3757</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3757" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a></li>
<li><strong>PR #3737</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3737" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/3736?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "logical-lines: Iterate over tokens" to "perf(pycodestyle): Refactor checks to iterate over tokens insteadof text" by @MichaReiser on 2023-03-26 11:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-03-26 11:50</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     14.1Â±0.09ms     2.9 MB/sec    1.00     14.2Â±0.10ms     2.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.6Â±0.01ms     4.6 MB/sec    1.00      3.6Â±0.02ms     4.6 MB/sec
linter/all-rules/numpy/globals.py          1.00    498.2Â±0.99Âµs     5.9 MB/sec    1.00    498.1Â±0.99Âµs     5.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.1Â±0.04ms     4.2 MB/sec    1.01      6.2Â±0.06ms     4.1 MB/sec
linter/default-rules/large/dataset.py      1.01      7.5Â±0.05ms     5.4 MB/sec    1.00      7.4Â±0.05ms     5.5 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01   1665.7Â±3.43Âµs    10.0 MB/sec    1.00   1651.5Â±3.69Âµs    10.1 MB/sec
linter/default-rules/numpy/globals.py      1.00    183.3Â±0.41Âµs    16.1 MB/sec    1.00    183.4Â±0.48Âµs    16.1 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.5Â±0.01ms     7.3 MB/sec    1.00      3.5Â±0.01ms     7.4 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     15.4Â±0.24ms     2.6 MB/sec    1.04     16.0Â±0.19ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.1Â±0.06ms     4.0 MB/sec    1.02      4.2Â±0.06ms     3.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    525.2Â±9.05Âµs     5.6 MB/sec    1.04    545.3Â±5.55Âµs     5.4 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.8Â±0.11ms     3.8 MB/sec    1.05      7.1Â±0.10ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.00      8.2Â±0.09ms     5.0 MB/sec    1.08      8.8Â±0.09ms     4.6 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1817.4Â±28.76Âµs     9.2 MB/sec    1.06  1932.1Â±24.61Âµs     8.6 MB/sec
linter/default-rules/numpy/globals.py      1.00    198.4Â±3.15Âµs    14.9 MB/sec    1.08    215.0Â±8.83Âµs    13.7 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.8Â±0.05ms     6.7 MB/sec    1.07      4.1Â±0.07ms     6.2 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/pycodestyle/rules/whitespace_before_parameters.rs</code>:41 on 2023-03-26 18:44</div>
            <div class="timeline-body"><p>I starred at this code for a long time and have come to the conclusion that checking <code>is_op_token(tok)</code> isn't necessary because we narrow down the token to <code>Lpar</code> or <code>Lsqb</code> on the very next line...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-03-26 18:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2023-03-27 06:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @MichaReiser on 2023-03-27 12:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-03-27 18:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-03-28 08:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-03-28 08:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-03-28 08:37</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 04:29:42 UTC
    </footer>
</body>
</html>
