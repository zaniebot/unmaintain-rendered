<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add more benchmarks - astral-sh/ruff #18714</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add more benchmarks</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18714">#18714</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-06-17 07:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR adds some larger mypy primer projects to our benchmarks. Smaller projects run on codespeed's instrumented runners. Larger projects run on codespeed's walltime runner because they take too long on the instrumented runner.</p>
<p>I had to use divan instead of criterion for the walltime runner because criterion requires at least 10 iterations for each benchmark, which is too long for our use case. Divan allows us to use arbitrarily few iterations (okay, at least one). I picked a sample of 3x1 (3 iterations), which completes in a reasonable time and hopefully is stable enough not to be noisy. One added advantage of using the walltime runner is that we can measure the end-to-end performance, including file discovery.</p>
<p>Leaving the smaller projects run on instrumented runners has the advantage that the results will be more precise (and we're charged less).</p>
<p>The smaller projects are picked arbitrarily. I'm happy to change them if someone has other suggestions.</p>
<p>I picked the larger projects mainly on @AlexWaygood suggestions (thank you!)</p>
<ul>
<li>altair: That's one I picked. It was pointed out in https://github.com/astral-sh/ty/issues/240 that it makes heavy use of typed dict</li>
<li>colour-science: very large unions</li>
<li>Pydantic: Pydantic creates large unions of TypedDicts, which can often be slow to type-check</li>
<li>Hydra-zen and sympy: Extensive use of generics.</li>
<li>Pandas: A lot of very, very large classes with a lot of implicit instance attributes.</li>
</ul>
<p>Both benchmark jobs now complete after roughly 10 minutes (compared to 6min before).</p>
<p>For the new wall-time benchmarks, see https://codspeed.io/astral-sh/ruff/branches/micha%2Freal-world-benchmarks</p>
<p>Part of https://github.com/astral-sh/ty/issues/240</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @MichaReiser on 2025-06-17 07:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-17 07:16</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-17 07:27</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Add real world benchmarks" to "[tuAdd real world benchmarks" by @MichaReiser on 2025-06-17 11:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[tuAdd real world benchmarks" to "[ty] Add larger benchmarks" by @MichaReiser on 2025-06-17 11:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by @MichaReiser on 2025-06-17 11:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[ty] Add larger benchmarks" to "[ty] Add more benchmarks" by @MichaReiser on 2025-06-17 11:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2025-06-17 16:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MichaReiser on 2025-06-17 16:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MichaReiser on 2025-06-17 16:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @MichaReiser on 2025-06-17 16:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @MichaReiser on 2025-06-17 16:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-17 16:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_benchmark/Cargo.toml</code>:79 on 2025-06-17 16:58</div>
            <div class="timeline-body"><pre><code class="language-suggestion"># Enables the benchmark that should only run with codspeed's instrumented runner
instrumented = [
    &quot;criterion&quot;,
    &quot;ruff_linter&quot;,
    &quot;ruff_python_formatter&quot;,
    &quot;ruff_python_parser&quot;,
    &quot;ruff_python_trivia&quot;,
    &quot;ty_project&quot;,
]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-17 16:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_benchmark/benches/ty.rs</code>:371 on 2025-06-17 16:59</div>
            <div class="timeline-body"><pre><code class="language-suggestion"></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-17 17:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_benchmark/benches/ty.rs</code>:415 on 2025-06-17 17:00</div>
            <div class="timeline-body"><pre><code class="language-suggestion"></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-17 17:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_benchmark/benches/ty.rs</code>:430 on 2025-06-17 17:00</div>
            <div class="timeline-body"><pre><code class="language-suggestion"></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-17 17:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_benchmark/benches/ty.rs</code>:445 on 2025-06-17 17:00</div>
            <div class="timeline-body"><pre><code class="language-suggestion"></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_benchmark/benches/ty_walltime.rs</code>:19 on 2025-06-17 17:00</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    // ╰─ colour_science 153.7 ms       │ 2.177 s       │ 2.106 s       │ 1.921 s       │ 10      │ 10
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-17 17:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-17 17:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_benchmark/benches/ty_walltime.rs</code>:38 on 2025-06-17 17:01</div>
            <div class="timeline-body"><pre><code class="language-suggestion"></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-17 17:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_benchmark/benches/ty.rs</code>:358 on 2025-06-17 17:01</div>
            <div class="timeline-body"><pre><code class="language-suggestion"></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-17 17:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_benchmark/benches/ty_walltime.rs</code>:54 on 2025-06-17 17:01</div>
            <div class="timeline-body"><pre><code class="language-suggestion"></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_benchmark/benches/ty_walltime.rs</code>:19 on 2025-06-17 17:05</div>
            <div class="timeline-body"><p>unclosed code fence :-)</p>
<pre><code class="language-suggestion">    // if we run the benchmarks multi-threaded:
    // ```
    // ty_walltime        fastest       │ slowest       │ median        │ mean          │ samples │ iters
    // ╰─ colour_science 153.7 ms       │ 2.177 s       │ 2.106 s       │ 1.921 s       │ 10      │ 10
    // ```
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-17 17:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ruff_benchmark/benches/ty.rs</code>:414 on 2025-06-18 09:30</div>
            <div class="timeline-body"><p>Why do we have this? As some kind of low-fidelity filter that we do &quot;actual type checking work&quot; on the project? I'm not opposed to it, but it might require updating the thresholds from time to time?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ruff_benchmark/src/real_world_projects.rs</code>:205 on 2025-06-18 09:34</div>
            <div class="timeline-body"><p>Does this save time? Or could it maybe be omitted entirely, assuming that the subsequent checkout will be fast anyway?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ruff_benchmark/src/real_world_projects.rs</code>:220 on 2025-06-18 09:37</div>
            <div class="timeline-body"><p>Minor stylistic suggestion: I think you could write these kinds of tests using the <code>ensure!</code> macro:</p>
<pre><code class="language-suggestion">    anyhow::ensure!(output.status.success(),
        &quot;Git checkout of commit {} failed: {}&quot;,
        commit,
        String::from_utf8_lossy(&amp;output.stderr)
    );
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ruff_benchmark/src/real_world_projects.rs</code>:296 on 2025-06-18 09:40</div>
            <div class="timeline-body"><p>Minor: I think I find this more distracting than helpful?</p>
<pre><code class="language-suggestion">    // Create an isolated virtual environment for installing the project's dependencies
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ruff_benchmark/src/real_world_projects.rs</code>:301 on 2025-06-18 09:42</div>
            <div class="timeline-body"><p>I think you could also call <code>uv venv</code> with the <code>--allow-existing</code> option instead of checking the existence</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ruff_benchmark/src/real_world_projects.rs</code>:117 on 2025-06-18 09:48</div>
            <div class="timeline-body"><p>Minor naming suggestion: I used <code>InstalledProject</code> for the same concept in a related tool. &quot;setup&quot; has the drawback that the past-tense form is the same, so it's not clear if that project has already been set up, or if it's referring to the actual project setup.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> approved on 2025-06-18 09:49</div>
            <div class="timeline-body"><p>Very much looking forward to this — thank you!</p>
<p>I didn't really review the project selection as such. Having this in place is the important part. Iterating on which projects we want to use is probably a continuous process.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_benchmark/benches/ty.rs</code>:414 on 2025-06-18 09:56</div>
            <div class="timeline-body"><p>Yeah, it's more a gap-stop to ensure the dependencies are correctly installed and we actually check any files (although that would probably visible now :))</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-18 09:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-18 10:06</div>
            <div class="timeline-body"><blockquote>
<p>I picked the larger projects mainly on @AlexWaygood suggestions (thank you!)</p>
</blockquote>
<p>I was quite confused for a while because I couldn't see where these larger projects were being reported on codspeed, but I eventually figured out that you need to click the &quot;wall time&quot; tab here:</p>
<p><img width="1189" alt="Screenshot 2025-06-18 at 11 02 40" src="https://github.com/user-attachments/assets/31313492-11bf-4037-9715-cf9379ec4784" /></p>
<p>I assume if we significantly regress one of the walltime benchmarks, codspeed will post a comment on the PR to tell us off about it, the same as it does with the instrumented benchmarks?</p>
<p>I don't feel like I have a good understanding of what the practical difference is between using a walltime runner and using an instrumented runner, but I trust you that this is the correct choice for the larger projects :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-18 10:14</div>
            <div class="timeline-body"><blockquote>
<p>The smaller projects are picked arbitrarily. I'm happy to change them if someone has other suggestions.</p>
</blockquote>
<p>They seem reasonable to me (definitely good enough to land now). anyio and attrs are both very popular projects, and I'm pretty sure hydra-zen has caused performance issues for type checkers in the past!</p>
<p>@hauntsaninja or @erictraut -- I don't suppose either of you have suggestions for smaller projects that have caused performance issues for mypy or pyright, which would be good for us to include in our benchmark suite?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-06-18 10:33</div>
            <div class="timeline-body"><blockquote>
<p>I don't feel like I have a good understanding of what the practical difference is between using a walltime runner and using an instrumented runner, but I trust you that this is the correct choice for the larger projects :-)</p>
</blockquote>
<p>My understanding is the following. The benchmarks that we ran on codspeed so far were &quot;instrumented&quot;. What this means is that codspeed runs the executable using valgrind (i.e. on a virtual CPU). Instead of measuring actual time, valgrind counts CPU instructions and then converts them to a time (using some arbitrary but fixed clock speed). This approach has the benefit that it's noise-free, and the benchmark only needs to run once (but on a virtual CPU, which is much much slower than on an actual CPU). The big disadvantage is that you don't see the real impact of IO operations. I believe codspeed makes some assumptions about the time it takes for various syscalls to complete (how long does a <code>read</code> operation take if it reads x bytes, …), but this is just guesswork.</p>
<p>Walltime runners use much less magic. They execute the benchmark on an actual CPU and really measure wall clock time. This process is inherently noisy, even if they certainly have measures to reduce noise. That's why the benchmark should ideally run multiple times to gather some statistics. The disadvantage here is that this is harder to measure accurately and reliably. The advantage is that it includes IO operations and reflects the actual runtime that a user would see more directly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-18 11:14</div>
            <div class="timeline-body"><p>Thank's @sharkdp for the very detailed comparison. In this case, the only reason for using walltime is because the instrumented runners are simply too slow. At the other hand, having some wall-time runners is nice (and e.g revealed a salsa performance issue when using multiple dbs).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-18 11:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_benchmark/benches/ty.rs</code>:414 on 2025-06-18 11:15</div>
            <div class="timeline-body"><p>I also think that it will be useful when bumping the commit. A sudden increase could indicate that the dependencies need to be updated.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_benchmark/src/real_world_projects.rs</code>:205 on 2025-06-18 11:15</div>
            <div class="timeline-body"><p>Probably not. I suspect that Claude tried to be fancy here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-18 11:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-18 11:28</div>
            <div class="timeline-body"><p>I'll go ahead and merge this. We can easily change the projects in folllow up PRs and I'm also curious to see how stable/flaky the benchmarks are (which practice will show)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-06-18 11:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-06-18 11:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-18 11:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-18 11:41</div>
            <div class="timeline-body"><p>The CI error seems unrelated to this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hauntsaninja">@hauntsaninja</a> on 2025-06-20 18:01</div>
            <div class="timeline-body"><p>I don't know about smaller, but you could try some of:</p>
<p>colour-science/colour
home-assistant/core
pandas-dev/pandas
sympy/sympy
pydantic/pydantic
Rapptz/discord.py
FasterSpeeding/Tanjun
python/mypy</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-20 18:06</div>
            <div class="timeline-body"><blockquote>
<p>FasterSpeeding/Tanjun</p>
</blockquote>
<p>Ah yeah, this one in particular might add some coverage that we don't currently have IIRC @MichaReiser -- they do a lot of stuff with <code>ParamSpec</code>s IIRC</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:13:27 UTC
    </footer>
</body>
</html>
