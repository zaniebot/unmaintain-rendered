<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix codeblock dynamic line length calculation for indented examples - astral-sh/ruff #13523</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix codeblock dynamic line length calculation for indented examples</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13523">#13523</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-09-26 13:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-26 13:20</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR fixes the <code>line-length</code> calculation for the mode <code>dynamic</code> for docstring code blocks.</p>
<pre><code class="language-python">def length(numbers: list[int]) -&gt; int:
    &quot;&quot;&quot;Get the length of the given list of numbers.

    Example:
        &gt;&gt;&gt; length([1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20])
        20
    &quot;&quot;&quot;
    return len(numbers)
</code></pre>
<p>The current implementation only accounted for the docstring's indent and the space taken by the <code>&gt;&gt;&gt; </code> but it didn't account for the indent <em>inside</em> the docstring (for spaces relative to <code>Example</code>). This PR changes the line length calculation to consider the relative indent.</p>
<p>Fixes https://github.com/astral-sh/ruff/issues/13358</p>
<h2>Test Plan</h2>
<p>I added a few new tests that and they demonstrate that the lines remain collapsed but expand in preview mode (with the fix).</p>
<p>I reviewed all ecosystem changes and they look correct. Many of those docstrings also have <code>E501</code> suppressions that won't be needed with the fix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2024-09-26 13:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @MichaReiser on 2024-09-26 13:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-09-26 13:31</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected format changes</strong>. (+20 -6 lines in 4 files in 3 projects; 51 projects unchanged)</p>
<details><summary><a href="https://github.com/apache/airflow">apache/airflow</a> (+3 -1 lines across 1 file)</summary>
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<p><a href='https://github.com/apache/airflow/blob/3de9e1481d2aa7e737ba98526570d5e339e1eebd/airflow/models/baseoperator.py#L1264'>airflow/models/baseoperator.py~L1264</a></p>
<pre><code class="language-diff">             # This is equivalent to
             with DAG(...):
                 generate_content = GenerateContentOperator(task_id=&quot;generate_content&quot;)
-                send_email = EmailOperator(..., html_content=&quot;{{ task_instance.xcom_pull('generate_content') }}&quot;)
+                send_email = EmailOperator(
+                    ..., html_content=&quot;{{ task_instance.xcom_pull('generate_content') }}&quot;
+                )
                 generate_content &gt;&gt; send_email
 
         &quot;&quot;&quot;
</code></pre>
</p>
</details>
<details><summary><a href="https://github.com/pandas-dev/pandas">pandas-dev/pandas</a> (+14 -4 lines across 2 files)</summary>
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<p><a href='https://github.com/pandas-dev/pandas/blob/b9488218ae27b70d1669a932ab16e8ce5a257cf0/pandas/core/arrays/base.py#L1793'>pandas/core/arrays/base.py~L1793</a></p>
<pre><code class="language-diff">                # type for the array, to the physical storage type for
                # the data, before passing to take.
 
-               result = take(data, indices, fill_value=fill_value, allow_fill=allow_fill)
+               result = take(
+                   data, indices, fill_value=fill_value, allow_fill=allow_fill
+               )
                return self._from_sequence(result, dtype=self.dtype)
         &quot;&quot;&quot;  # noqa: E501
         # Implementer note: The `fill_value` parameter should be a user-facing
</code></pre>
<p><a href='https://github.com/pandas-dev/pandas/blob/b9488218ae27b70d1669a932ab16e8ce5a257cf0/pandas/plotting/_core.py#L247'>pandas/plotting/_core.py~L247</a></p>
<pre><code class="language-diff">     .. plot::
         :context: close-figs
 
-        &gt;&gt;&gt; data = {&quot;length&quot;: [1.5, 0.5, 1.2, 0.9, 3], &quot;width&quot;: [0.7, 0.2, 0.15, 0.2, 1.1]}
+        &gt;&gt;&gt; data = {
+        ...     &quot;length&quot;: [1.5, 0.5, 1.2, 0.9, 3],
+        ...     &quot;width&quot;: [0.7, 0.2, 0.15, 0.2, 1.1],
+        ... }
         &gt;&gt;&gt; index = [&quot;pig&quot;, &quot;rabbit&quot;, &quot;duck&quot;, &quot;chicken&quot;, &quot;horse&quot;]
         &gt;&gt;&gt; df = pd.DataFrame(data, index=index)
         &gt;&gt;&gt; hist = df.hist(bins=3)
</code></pre>
<p><a href='https://github.com/pandas-dev/pandas/blob/b9488218ae27b70d1669a932ab16e8ce5a257cf0/pandas/plotting/_core.py#L833'>pandas/plotting/_core.py~L833</a></p>
<pre><code class="language-diff">         :context: close-figs
 
         &gt;&gt;&gt; df = pd.DataFrame(
-        ...     {&quot;length&quot;: [1.5, 0.5, 1.2, 0.9, 3], &quot;width&quot;: [0.7, 0.2, 0.15, 0.2, 1.1]},
+        ...     {
+        ...         &quot;length&quot;: [1.5, 0.5, 1.2, 0.9, 3],
+        ...         &quot;width&quot;: [0.7, 0.2, 0.15, 0.2, 1.1],
+        ...     },
         ...     index=[&quot;pig&quot;, &quot;rabbit&quot;, &quot;duck&quot;, &quot;chicken&quot;, &quot;horse&quot;],
         ... )
         &gt;&gt;&gt; plot = df.plot(title=&quot;DataFrame Plot&quot;)
</code></pre>
<p><a href='https://github.com/pandas-dev/pandas/blob/b9488218ae27b70d1669a932ab16e8ce5a257cf0/pandas/plotting/_core.py#L1614'>pandas/plotting/_core.py~L1614</a></p>
<pre><code class="language-diff">             ...         &quot;signups&quot;: [5, 5, 6, 12, 14, 13],
             ...         &quot;visits&quot;: [20, 42, 28, 62, 81, 50],
             ...     },
-            ...     index=pd.date_range(start=&quot;2018/01/01&quot;, end=&quot;2018/07/01&quot;, freq=&quot;ME&quot;),
+            ...     index=pd.date_range(
+            ...         start=&quot;2018/01/01&quot;, end=&quot;2018/07/01&quot;, freq=&quot;ME&quot;
+            ...     ),
             ... )
             &gt;&gt;&gt; ax = df.plot.area()
 
</code></pre>
</p>
</details>
<details><summary><a href="https://github.com/pytest-dev/pytest">pytest-dev/pytest</a> (+3 -1 lines across 1 file)</summary>
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<p><a href='https://github.com/pytest-dev/pytest/blob/6486c3f3a858a0c8043f5c3f7c24297b82a0abe4/src/_pytest/python_api.py#L858'>src/_pytest/python_api.py~L858</a></p>
<pre><code class="language-diff"> 
        Given that ``pytest.raises`` matches subclasses, be wary of using it to match :class:`Exception` like this::
 
-           with pytest.raises(Exception):  # Careful, this will catch ANY exception raised.
+           with pytest.raises(
+               Exception
+           ):  # Careful, this will catch ANY exception raised.
                some_function()
 
        Because :class:`Exception` is the base class of almost all exceptions, it is easy for this to hide
</code></pre>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2024-09-26 14:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @MichaReiser on 2024-09-26 14:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/src/preview.rs</code>:55 on 2024-09-26 17:34</div>
            <div class="timeline-body"><p>How come this is treated as a new style instead of a bug fix? (Sorry, I'm probably out of step with what our policy is here.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2024-09-26 17:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-09-26 18:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/preview.rs</code>:55 on 2024-09-26 18:35</div>
            <div class="timeline-body"><p>The formatter versioning policy is rather strict:</p>
<blockquote>
<p>The stable style changed to prevent invalid syntax, changes to the program's semantics, or removal of comments</p>
</blockquote>
<p>It only allows hard correctness errors. The only other permitted changes are bug fixes that don't change any already formatted code. For example, we can fix a bug where the formatter incorrectly collapses two blank lines to one instead of preserving one or two.</p>
<p>The motivation for this strict rule is that a <code>ruff format --check</code> command shouldn't start failing between patch versions for already formatted code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2024-09-27 07:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-09-27 07:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-09-27 07:09</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 21:00:07 UTC
    </footer>
</body>
</html>
