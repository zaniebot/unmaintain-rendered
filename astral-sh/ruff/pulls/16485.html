<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[syntax-errors] Tuple unpacking in `return` and `yield` before Python 3.8 - astral-sh/ruff #16485</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[syntax-errors] Tuple unpacking in <code>return</code> and <code>yield</code> before Python 3.8</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16485">#16485</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-03-03 23:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Checks for tuple unpacking in <code>return</code> and <code>yield</code> statements before Python 3.8, as described <a href="https://github.com/python/cpython/issues/76298">here</a>.</p>
<h2>Test Plan</h2>
<p>Inline tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by @ntBre on 2025-03-03 23:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @ntBre on 2025-03-03 23:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @ntBre on 2025-03-03 23:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @ntBre on 2025-03-03 23:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-03 23:57</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/error.rs</code>:471 on 2025-03-04 07:56</div>
            <div class="timeline-body"><p>Python also knows yield expressions. Is this something we have to distinguish / consider in this PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:303 on 2025-03-04 07:57</div>
            <div class="timeline-body"><p>Does this also handle nested yield expressions <code>a = yield x</code>
Could this code be moved into <code>parse_yield_expression</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:405 on 2025-03-04 08:01</div>
            <div class="timeline-body"><p>Are the <code>yield</code> examples relevant to this code? It seems to me that this parse rule is only used for <code>return x</code> or <code>return yield</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-04 08:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:395 on 2025-03-04 11:31</div>
            <div class="timeline-body"><p>Can we add test cases using single unpack element like <code>return *rest</code> or <code>yield *rest</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:395 on 2025-03-04 11:36</div>
            <div class="timeline-body"><p>What about <code>yield 1, (*rest)</code>, <code>yield 1, (yield 2, *rest), 3</code> (yield can be used as an expression)? I'm just throwing out random examples :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-03-04 11:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-03-04 14:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:405 on 2025-03-04 14:45</div>
            <div class="timeline-body"><p>No, you're right. I was getting alarmed at the size of the diffs in these PRs and saw that grouping tests together made them smaller, but conceptually they are separate tests. I'll move those to the <code>yield</code> section.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-03-04 22:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/error.rs</code>:471 on 2025-03-04 22:16</div>
            <div class="timeline-body"><p>I'll have to test this out. The CPython PR said statements, but maybe I took it too literally.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-03-05 14:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/error.rs</code>:471 on 2025-03-05 14:10</div>
            <div class="timeline-body"><p>It looks like this also applies to expressions:</p>
<p>Python 3.7:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; def i(): yield 1, (yield 2, *rest), 3
  File &quot;&lt;stdin&gt;&quot;, line 1
    def i(): yield 1, (yield 2, *rest), 3
                                ^
SyntaxError: invalid syntax
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-03-05 14:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:395 on 2025-03-05 14:34</div>
            <div class="timeline-body"><p>Thanks for these! The single cases are actually still invalid on my system Python (3.13):</p>
<pre><code class="language-pycon">&gt;&gt;&gt; def foo(): return *rest
  File &quot;&lt;python-input-0&gt;&quot;, line 1
    def foo(): return *rest
                      ^^^^^
SyntaxError: can't use starred expression here
&gt;&gt;&gt; def foo(): yield *rest
  File &quot;&lt;python-input-1&gt;&quot;, line 1
    def foo(): yield *rest
                     ^^^^^
SyntaxError: can't use starred expression here
</code></pre>
<p>But these aren't flagged as <code>ParseError</code>s by ruff.</p>
<p>The second case is very interesting. It's actually accepted on both 3.7 <em>and</em> 3.8, but not on my 3.13 system Python (<code>SyntaxError: cannot use starred expression here</code>). That might be another change not currently tracked in #6591.</p>
<p>I added your third case as an example of a yield expression and moved the check into <code>parse_yield_expression</code> as @MichaReiser suggested.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-03-05 14:56</div>
            <div class="timeline-body"><p>I added more test cases (thanks for the suggestions!). Two of them became TODOs because I think they aren't exactly related to this PR:</p>
<ul>
<li><code>return|yield *rest</code> is invalid on every Python version I tried and should be flagged as a <em>parse</em> error, in my opinion</li>
<li><code>return|yield 1, (*rest)</code> is valid on 3.7 and 3.8 but not 3.13, so I think this is a separate change from the 3.8 unpacking (and a second <code>Change::Removed</code> case to use the enum from the other PR)</li>
</ul>
<p>I also checked on <code>yield from</code> and it looks like our <a href="https://github.com/astral-sh/ruff/blob/d0623888b3231fdda09bfa7079d67f8162faa10c/crates/ruff_python_parser/src/parser/expression.rs#L2110"><code>parse_yield_from</code></a> method already reports an error for any unparenthesized tuple expression, so I think that should be covered.</p>
<p>Finally, I changed the message for the <code>yield statement</code> to <code>yield expression</code>. I think in an ideal case we'd have a third variant of <code>StarTupleKind</code> and differentiate <code>YieldExpr</code> from <code>YieldStmt</code> but I didn't see an easy way to do that with the new detection in <code>parse_yield_expression</code>. Since I had to pick one, I thought &quot;expression&quot; was slightly preferable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-05 16:15</div>
            <div class="timeline-body"><blockquote>
<p>return|yield *rest is invalid on every Python version I tried and should be flagged as a parse error, in my opinion</p>
</blockquote>
<p>Yes, that seems correct. Can you create an issue for it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/error.rs</code>:509 on 2025-03-06 07:53</div>
            <div class="timeline-body"><p>Nit: I'd add an empty line above comments this long to make it easier to see the different variants.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/error.rs</code>:460 on 2025-03-06 07:54</div>
            <div class="timeline-body"><p>These comments are very helpful! Thanks for taking the time to write them</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:2118 on 2025-03-06 07:59</div>
            <div class="timeline-body"><p>I'd remove this, considering that it's not a parse error</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:2123 on 2025-03-06 08:02</div>
            <div class="timeline-body"><p>If you haven't done so. Can you add it to the syntax check issue?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:415 on 2025-03-06 08:03</div>
            <div class="timeline-body"><p>Same: Let's remove this as it is a semantic error and not a parse error</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-03-06 08:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-03-06 09:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:395 on 2025-03-06 09:38</div>
            <div class="timeline-body"><blockquote>
<p>But these aren't flagged as <code>ParseError</code>s by ruff.</p>
</blockquote>
<p>That's because the grammar says it's allowed.</p>
<pre><code>return_stmt:
    | 'return' [star_expressions] 

star_expressions:
    | star_expression (',' star_expression )+ [','] 
    | star_expression ',' 
    | star_expression

star_expression:
    | '*' bitwise_or 
    | expression
</code></pre>
<p>I think it's caught by the CPython compiler and not the parser. You can see that <code>python -m ast test.py</code> wouldn't raise a syntax error here.</p>
<pre><code class="language-console">$ python -m ast _.py       
Module(
   body=[
      FunctionDef(
         name='foo',
         args=arguments(
            posonlyargs=[],
            args=[
               arg(arg='args')],
            kwonlyargs=[],
            kw_defaults=[],
            defaults=[]),
         body=[
            Return(
               value=Starred(
                  value=Name(id='args', ctx=Load()),
                  ctx=Load()))],
         decorator_list=[],
         type_params=[])],
   type_ignores=[])
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-03-06 09:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:395 on 2025-03-06 09:40</div>
            <div class="timeline-body"><p>Oops, missed the issue https://github.com/astral-sh/ruff/issues/16520</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/resources/inline/err/iter_unpack_return_todo.py</code>:3 on 2025-03-06 09:45</div>
            <div class="timeline-body"><p>Oh, interesting!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-03-06 09:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-03-06 13:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:2118 on 2025-03-06 13:38</div>
            <div class="timeline-body"><p>Oh oops, I'll clean up all of these TODOs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:2123 on 2025-03-06 14:08</div>
            <div class="timeline-body"><p>Added to #6591! It looks like this stopped parsing in 3.9</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-03-06 14:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-03-06 16:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-03-06 16:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-03-06 16:57</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:10:29 UTC
    </footer>
</body>
</html>
