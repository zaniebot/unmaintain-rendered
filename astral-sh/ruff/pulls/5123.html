<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[Markdown Parser] Add `CodeExtractor` trait for extracting source code from a file - astral-sh/ruff #5123</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[Markdown Parser] Add <code>CodeExtractor</code> trait for extracting source code from a file</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5123">#5123</a>
        opened by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a>
        on 2023-06-15 17:19
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a></div>
            <div class="timeline-body">

Summary
<p>Will be used when implementing #3792.</p>
<p>This PR adds a <code>CodeExtractor</code> trait (and a Jupyter notebook implementation). This trait will be used to extract source code (language-agnostic, potentially range-agnostic once Open Question 1 is answered) from files. It will be used in a <code>MarkdownParser</code> to extract Python code blocks.</p>


Open Questions
<ol>
<li>To support embedded languages (e.g. SQL in Python), we can add an <code>extract_code_from_range</code> method, or change the signature of the existing function to take a <code>str</code> and pass the in Path contents that way. I&#x27;m open to either one, though the latter would obviously require a change in the existing implementation. I think the latter option (changing signature to <code>str</code> vs. <code>Path</code>) would be better.</li>
<li>Do we want to move the <code>CodeExtractor</code> trait onto the <code>SourceKind</code> enum? I thought about it, but am not sure how that enum can be extended for embedded language support down the road. I think we&#x27;d have to change it to work at a &quot;code block&quot; level instead of a <code>Path</code> level. My local branch contains the concept of a <code>BoundedCodeBlock</code>, but I wonder if that&#x27;s going to be too much change for now. If there&#x27;s interest, I can submit the Markdown parser PR with that struct incorporated.</li>
</ol>
Test Plan
<p><code>cargo t</code></p>
Note
<p>I had a Markdown language parser PR earlier, but there&#x27;ve been a bunch of changes in main (specifically around Jupyter notebooks) that will prove helpful for the Markdown parser, so I&#x27;m essentially restarting the branch. Further development on Markdown parsing will be paused until this gets looked at (I think it&#x27;s currently deprioritized, but just wanted to let it be known :) ).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dhruvmanila">@dhruvmanila</a> by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on 2023-06-15 17:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Add CodeExtractor trait&quot; to &quot;Add `CodeExtractor` trait&quot; by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on 2023-06-15 17:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on 2023-06-15 17:26</div>
            <div class="timeline-body"><p>@charliermarsh would also like your thoughts on this, if you get the time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-06-15 17:38</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>✅ ecosystem check detected no changes.</p>
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      6.8±0.01ms     6.0 MB/sec    1.00      6.8±0.01ms     6.0 MB/sec
formatter/numpy/ctypeslib.py               1.00  1397.8±14.74µs    11.9 MB/sec    1.00   1401.3±2.92µs    11.9 MB/sec
formatter/numpy/globals.py                 1.00    137.5±0.25µs    21.5 MB/sec    1.00    137.7±0.40µs    21.4 MB/sec
formatter/pydantic/types.py                1.00      2.8±0.01ms     9.1 MB/sec    1.00      2.8±0.02ms     9.1 MB/sec
linter/all-rules/large/dataset.py          1.02     14.5±0.10ms     2.8 MB/sec    1.00     14.1±0.04ms     2.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.5±0.00ms     4.7 MB/sec    1.00      3.5±0.03ms     4.8 MB/sec
linter/all-rules/numpy/globals.py          1.01    369.9±3.79µs     8.0 MB/sec    1.00    367.0±0.71µs     8.0 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.2±0.03ms     4.1 MB/sec    1.00      6.2±0.04ms     4.1 MB/sec
linter/default-rules/large/dataset.py      1.04      7.4±0.03ms     5.5 MB/sec    1.00      7.1±0.02ms     5.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.02   1547.9±4.52µs    10.8 MB/sec    1.00   1512.3±4.36µs    11.0 MB/sec
linter/default-rules/numpy/globals.py      1.01    167.4±0.13µs    17.6 MB/sec    1.00    165.8±0.71µs    17.8 MB/sec
linter/default-rules/pydantic/types.py     1.03      3.4±0.02ms     7.6 MB/sec    1.00      3.3±0.01ms     7.8 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      6.8±0.12ms     6.0 MB/sec    1.01      6.9±0.14ms     5.9 MB/sec
formatter/numpy/ctypeslib.py               1.02  1431.7±58.10µs    11.6 MB/sec    1.00  1406.6±28.53µs    11.8 MB/sec
formatter/numpy/globals.py                 1.00    134.0±3.64µs    22.0 MB/sec    1.04    138.7±9.41µs    21.3 MB/sec
formatter/pydantic/types.py                1.00      2.8±0.06ms     9.1 MB/sec    1.00      2.8±0.07ms     9.1 MB/sec
linter/all-rules/large/dataset.py          1.00     14.8±0.28ms     2.8 MB/sec    1.01     14.9±0.37ms     2.7 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.8±0.06ms     4.4 MB/sec    1.00      3.8±0.09ms     4.4 MB/sec
linter/all-rules/numpy/globals.py          1.00    442.0±9.40µs     6.7 MB/sec    1.02   450.7±12.31µs     6.5 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.5±0.17ms     3.9 MB/sec    1.00      6.5±0.15ms     3.9 MB/sec
linter/default-rules/large/dataset.py      1.00      7.5±0.12ms     5.4 MB/sec    1.00      7.5±0.13ms     5.4 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1573.7±32.39µs    10.6 MB/sec    1.01  1593.4±39.03µs    10.5 MB/sec
linter/default-rules/numpy/globals.py      1.00    178.3±4.85µs    16.5 MB/sec    1.02    182.1±5.42µs    16.2 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.4±0.06ms     7.5 MB/sec    1.00      3.4±0.07ms     7.5 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Add `CodeExtractor` trait&quot; to &quot;Add `CodeExtractor` trait for extracting source code from a file&quot; by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on 2023-06-15 20:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Add `CodeExtractor` trait for extracting source code from a file&quot; to &quot;[Markdown] Add `CodeExtractor` trait for extracting source code from a file&quot; by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on 2023-06-17 23:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[Markdown] Add `CodeExtractor` trait for extracting source code from a file&quot; to &quot;[Markdown Parser] Add `CodeExtractor` trait for extracting source code from a file&quot; by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on 2023-06-17 23:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-18 15:51</div>
            <div class="timeline-body"><p>Thanks, I&#x27;ll try to take a look later today!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/source_kind.rs</code>:34 on 2023-06-19 03:23</div>
            <div class="timeline-body"><p>I think the generic can be omitted entirely here with:</p>
<pre><code>pub trait CodeExtractor: Sized {
    fn extract_code(path: &amp;Path) -&gt; Result&lt;Self, Box&lt;Diagnostic&gt;&gt;;
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-19 03:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-19 03:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/source_kind.rs</code>:32 on 2023-06-19 03:32</div>
            <div class="timeline-body"><p>Maybe I&#x27;m unable to see ahead to future usages, but I don&#x27;t quite see the value in introducing this trait as-is, since it&#x27;s really just defining a constructor for the implementing class -- there aren&#x27;t any shared methods across trait implementors (e.g., nothing that takes <code>&amp;self</code>), and so implementing the trait doesn&#x27;t help us very much. How do you see it evolving?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> reviewed on 2023-06-19 04:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on <code>crates/ruff/src/source_kind.rs</code>:32 on 2023-06-19 04:01</div>
            <div class="timeline-body"><p>I was planning on storing the various mapping functions here as well (like mapping the initial/terminal offsets of Markdown code cells to the underlying document or Jupyter cells vs its JSON). I&#x27;m finding a lot of similarities between the Markdown parser and the existing Jupyter one, so wanted to consolidate some functionality.</p>
<p>Additionally, a lot of these functions will be applicable for embedded language support (mapping initial and terminal offsets of SQL code in Python, for example).</p>
<p>I felt that there was an opportunity to unify a lot of the stuff between the Markdown and Jupyter parsers which will also extend to other use cases in the larger &quot;multi-language&quot; use case. If you don&#x27;t think this trait is worth it, though, I&#x27;m happy to remove it and just continue on the Markdown parser itself.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> reviewed on 2023-06-20 15:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on <code>crates/ruff/src/source_kind.rs</code>:32 on 2023-06-20 15:23</div>
            <div class="timeline-body"><p>@charliermarsh I think I&#x27;m going to close this for now - you&#x27;re right. I&#x27;ll keep working on the Markdown parser and then we can look for opportunities to unify stuff down the road. I&#x27;ll try to design it in such a way that we can easily implement multi-language support for it down the road.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/evanrittenhouse">@evanrittenhouse</a> on 2023-06-20 15:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-20 15:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/source_kind.rs</code>:32 on 2023-06-20 15:28</div>
            <div class="timeline-body"><p>Sounds good, sorry for not getting back to your previous comment. I just want to avoid introducing abstractions before they&#x27;re needed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-06-20 17:52</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:54:33 UTC
    </footer>
</body>
</html>
