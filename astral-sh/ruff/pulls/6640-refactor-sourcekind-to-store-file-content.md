```yaml
number: 6640
title: "Refactor `SourceKind` to store file content"
type: pull_request
state: merged
author: MichaReiser
labels:
  - internal
assignees: []
merged: true
base: main
head: store-notebooks-in-diagnostics
created_at: 2023-08-17T07:51:46Z
updated_at: 2023-08-18T14:05:18Z
url: https://github.com/astral-sh/ruff/pull/6640
synced_at: 2026-01-12T15:55:22Z
```

# Refactor `SourceKind` to store file content

---

_@MichaReiser_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This PR changes two things. You may want to take a look at the individual commits. I'm not entirely convinced whether we should land this change and it certainly needs more testing:

1. It changes `Diagnostics` to store the notebooks rather than the `SourceKind`. The sole reason is that we don't need the kind. We only need the notebook index to resolve cells. Ideally, this would be handled by a custom diagnostic kind, but we aren't there yet
2. I changed `SourceKind` to store the content for both `Notebooks` and regular Python files. This allows us to align `lint_fix` to never return the input in place, and instead return the updated result as a `Cow<'a, SourceKind>`. I find this easier to reason about than having to remember that notebooks are updated in place, but regular source code is not. However, this has the downside that we now need to clone the Notebooks, which may be rather expensive (multiple large vecs). 

I'm looking for general feedback. Also happy if someone with more understanding on jupyter notebooks wants to take this over.

## Test Plan

<!-- How was it tested? -->


---

_Comment by @MichaReiser on 2023-08-17 07:51_

Current dependencies on/for this PR:
* main
  * **PR #6629** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6629" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #6640** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6640" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6640?utm_source=stack-comment).

---

_Comment by @github-actions[bot] on 2023-08-17 08:26_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01      3.3Â±0.01ms    12.2 MB/sec    1.00      3.3Â±0.01ms    12.3 MB/sec
formatter/numpy/ctypeslib.py               1.01    677.9Â±9.42Âµs    24.6 MB/sec    1.00    673.6Â±8.83Âµs    24.7 MB/sec
formatter/numpy/globals.py                 1.00     70.4Â±0.33Âµs    41.9 MB/sec    1.00     70.2Â±0.66Âµs    42.0 MB/sec
formatter/pydantic/types.py                1.02  1360.9Â±14.58Âµs    18.7 MB/sec    1.00  1335.4Â±18.96Âµs    19.1 MB/sec
linter/all-rules/large/dataset.py          1.00     10.7Â±0.05ms     3.8 MB/sec    1.00     10.7Â±0.04ms     3.8 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      2.9Â±0.01ms     5.8 MB/sec    1.00      2.9Â±0.01ms     5.7 MB/sec
linter/all-rules/numpy/globals.py          1.00    323.2Â±2.29Âµs     9.1 MB/sec    1.00    324.4Â±1.02Âµs     9.1 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.5Â±0.02ms     4.6 MB/sec    1.01      5.5Â±0.02ms     4.6 MB/sec
linter/default-rules/large/dataset.py      1.01      5.6Â±0.02ms     7.3 MB/sec    1.00      5.5Â±0.02ms     7.3 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1195.4Â±7.92Âµs    13.9 MB/sec    1.00   1194.8Â±6.09Âµs    13.9 MB/sec
linter/default-rules/numpy/globals.py      1.00    125.5Â±0.52Âµs    23.5 MB/sec    1.00    125.5Â±0.76Âµs    23.5 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.5Â±0.01ms    10.1 MB/sec    1.00      2.5Â±0.02ms    10.1 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      4.8Â±0.22ms     8.5 MB/sec    1.05      5.0Â±0.29ms     8.2 MB/sec
formatter/numpy/ctypeslib.py               1.00   969.8Â±39.07Âµs    17.2 MB/sec    1.00   970.1Â±38.45Âµs    17.2 MB/sec
formatter/numpy/globals.py                 1.00     95.0Â±4.15Âµs    31.1 MB/sec    1.04     99.1Â±7.46Âµs    29.8 MB/sec
formatter/pydantic/types.py                1.00  1967.0Â±88.09Âµs    13.0 MB/sec    1.02  1997.4Â±114.85Âµs    12.8 MB/sec
linter/all-rules/large/dataset.py          1.00     17.8Â±0.48ms     2.3 MB/sec    1.03     18.4Â±0.59ms     2.2 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      5.0Â±0.18ms     3.3 MB/sec    1.00      5.0Â±0.32ms     3.3 MB/sec
linter/all-rules/numpy/globals.py          1.02   624.8Â±48.44Âµs     4.7 MB/sec    1.00   614.5Â±29.54Âµs     4.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      9.2Â±0.30ms     2.8 MB/sec    1.05      9.7Â±0.37ms     2.6 MB/sec
linter/default-rules/large/dataset.py      1.00      9.9Â±0.33ms     4.1 MB/sec    1.05     10.4Â±0.33ms     3.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00      2.1Â±0.08ms     7.9 MB/sec    1.02      2.1Â±0.13ms     7.8 MB/sec
linter/default-rules/numpy/globals.py      1.00   254.0Â±15.06Âµs    11.6 MB/sec    1.04   263.9Â±13.66Âµs    11.2 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.4Â±0.20ms     5.8 MB/sec    1.04      4.6Â±0.21ms     5.6 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Review comment by @MichaReiser on `crates/ruff/src/source_kind.rs`:6 on 2023-08-17 08:48_

It would be nice to store the `PySourceType` on the `SourceKind` as well (making it a `Program` or `SourceFile` entity). However, it is a bit awkward because `PySourceType` has a `Jupyter` variant, but that variant should only be used to `Jupyter`... 

---

_Review comment by @MichaReiser on `crates/ruff/src/linter.rs`:66 on 2023-08-17 08:49_

The change here is that the linter now returns the transformed `SourceKind` which aligns the handling of Notebooks with regular python files in the sense that it doesn't mutate the source file in place.

---

_Review comment by @MichaReiser on `crates/ruff/src/linter.rs`:377 on 2023-08-17 08:50_

Not sure why this is optional, but wanted to avoid increasing the scope of this even more.

---

_Review comment by @MichaReiser on `crates/ruff/src/source_kind.rs`:24 on 2023-08-17 08:51_

This for sure is more expensive than the old "update in place". 

---

_@MichaReiser reviewed on 2023-08-17 08:52_

---

_Review requested from @charliermarsh by @MichaReiser on 2023-08-17 08:53_

---

_Review requested from @dhruvmanila by @MichaReiser on 2023-08-17 08:53_

---

_Marked ready for review by @MichaReiser on 2023-08-17 08:58_

---

_@charliermarsh reviewed on 2023-08-17 14:38_

---

_Review comment by @charliermarsh on `crates/ruff_cli/src/diagnostics.rs`:67 on 2023-08-17 14:38_

This looks reasonable. So this allows us to keep the string content on `SourceKind::Python`, since we no longer store the Python source kind on here anyway.

---

_@charliermarsh approved on 2023-08-17 14:38_

I think I'm supportive of this. It's really nice to avoid the `&mut` on the source kind.

---

_Label `internal` added by @MichaReiser on 2023-08-17 14:48_

---

_Comment by @MichaReiser on 2023-08-17 18:57_

@dhruvmanila any opinion on this? Any recommendations on how to test the changes?

---

_Review comment by @dhruvmanila on `crates/ruff/src/linter.rs`:377 on 2023-08-17 19:50_

The reason this is optional is because there's no `--add-noqa` support for Jupyter Notebooks yet. The logic for `add_noqa_to_path` basically calls into `check_path` and as far as I recall there were some circular dependency problems. Maybe it could be solved now with the recent changes.

---

_@dhruvmanila reviewed on 2023-08-17 19:50_

---

_Review comment by @dhruvmanila on `crates/ruff/src/message/mod.rs`:140 on 2023-08-17 19:53_

nit:
```suggestion
    pub fn new(notebooks: &'a FxHashMap<String, Notebook>) -> Self {
        Self { notebooks }
```

---

_Review comment by @dhruvmanila on `crates/ruff/src/source_kind.rs`:24 on 2023-08-18 04:48_

Yeah, my main reason to update in place was to avoid cloning the entire notebook. Actually, the only thing we need to update with each linting cycle are the cell markers and the transformed source code can be looped over to the next iteration cycle. The cell content can be updated at the end before we actually update the Notebook that too only when `--fix` is passed.

Using the above idea, we could create a `NotebookView` which would only contain the necessary fields (for now I think it's cell markers only and the concatenated source code?) and should be much cheaper to clone. We would not even clone it and use an `updated` method on the view with the `SourceMap` and transformed source code and create a new view with the updated source code and cell markers. Once the linter iteration is complete, we can _apply_ the view onto the Notebook, update the cell content then and write the Notebook back to the disk.

I think the abstraction would be to have a view into the source code be it Python or Jupyter and the view would have `updated` method to update the view. At the end the view will be applied to the concrete type and saved onto the disk.

This is just a rough idea based on my morning walk :)

---

_Review comment by @dhruvmanila on `crates/ruff/src/test.rs`:58 on 2023-08-18 04:48_

This is good. Thanks for doing this :)

---

_@dhruvmanila approved on 2023-08-18 04:52_

Thanks for making these changes :)

In the near future we should move towards finalizing an abstraction layer between different sources and the engines (linter, formatter, etc.).

---

_Comment by @dhruvmanila on 2023-08-18 05:11_

> Any recommendations on how to test the changes?

My main concern would be to test the linter loop (> 2 iterations) with `--fix`. The way we could do this is to use a source code where some fixes overlap so that then the other fixes gets applied in the next iteration allowing us to make sure the updates are taking place correctly. I gave a quick test and it's good. There are 4 iteration loops in the following test case. I'll add this test case in another PR.

### Cells

1.
```python
import random
import math
```

2.
```python
try:
    print()
except ValueError:
    pass
```

3.
```python
import random
import pprint

random.randint(10, 20)
```

4.
```python
foo = 1
if foo is 2:
    raise ValueError(f"Invalid foo: {foo is 1}")
```

Command:
```
cargo run --bin ruff --package ruff_cli -- check --no-cache --isolated --select=I,F,SIM /path/to/test.ipynb --fix --diff
```

---

_@MichaReiser reviewed on 2023-08-18 06:21_

---

_Review comment by @MichaReiser on `crates/ruff/src/source_kind.rs`:24 on 2023-08-18 06:21_

I don't think I'm able to follow. Do you want to take a stab at this together with performing the renaming that you suggested? Or is this something that needs changing before landing this PR?

I tried to change `raw` to an `Rc` to get cheap cloning. However, it turns out that `update_cell_content` mutates the raw cells. The only larger structure that doesn't seem to get updated is `valid_code_cells`. 


I think we could also move out `index` from the `Notebook` because it is only used in `Diagnostics` and instead have a `JupyterIndex` that is either `Lazy(Notebook)` or `Built(Index)`. 

---

_Comment by @MichaReiser on 2023-08-18 08:31_

Thanks @dhruvmanila for the extensive test plan. I played through the commands (showing diagnostics, diff, and fixing) and it works as expected

---

_@MichaReiser reviewed on 2023-08-18 08:32_

---

_Review comment by @MichaReiser on `crates/ruff/src/linter.rs`:377 on 2023-08-18 08:32_

Could `add_noqa_to_path` detect the `PySourceType` and exit early (with a warning) if it is a Jupyter notebook to avoid that all downstream code has to handle optional source kinds?

---

_Renamed from "Store notebooks on Diagnostics" to "Refactor `SourceKind` to store file content" by @MichaReiser on 2023-08-18 08:35_

---

_Review comment by @dhruvmanila on `crates/ruff/src/source_kind.rs`:24 on 2023-08-18 10:42_

> Do you want to take a stab at this together with performing the renaming that you suggested?

Yeah, I can give it a go next week.

> Or is this something that needs changing before landing this PR?

No

> The only larger structure that doesn't seem to get updated is `valid_code_cells`.

What do you mean here by "larger structure"? As `valid_code_cells` is just a vector of `u32`.


> However, it turns out that `update_cell_content` mutates the raw cells.

Yeah, this update isn't really required for every linter loop. We can avoid doing that and only update it at the end. This basically uses the concatenated source code and cell markers to update the cell content.

> I think we could also move out `index` from the `Notebook` because it is only used in `Diagnostics` and instead have a `JupyterIndex` that is either `Lazy(Notebook)` or `Built(Index)`.

Yeah, this is a good idea.


---

_@dhruvmanila reviewed on 2023-08-18 10:42_

---

_Review comment by @MichaReiser on `crates/ruff/src/source_kind.rs`:24 on 2023-08-18 11:02_

> What do you mean here by "larger structure"? As valid_code_cells is just a vector of u32.

With large, I mean any non-fixed size heap allocated data structure that requires a deep clone. 

---

_@MichaReiser reviewed on 2023-08-18 11:02_

---

_Merged by @MichaReiser on 2023-08-18 13:45_

---

_Closed by @MichaReiser on 2023-08-18 13:45_

---

_Branch deleted on 2023-08-18 13:45_

---
