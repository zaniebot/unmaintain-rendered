```yaml
number: 4862
title: Format binary expressions
type: pull_request
state: merged
author: MichaReiser
labels:
  - internal
  - formatter
assignees: []
merged: true
base: main
head: format-binary-expression
created_at: 2023-06-05T09:27:40Z
updated_at: 2023-06-07T10:45:49Z
url: https://github.com/astral-sh/ruff/pull/4862
synced_at: 2026-01-12T15:55:16Z
```

# Format binary expressions

---

_@MichaReiser_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This PR implements basic formatting for binary expressions. It does not yet handle the special case where black breaks the right side first for call expressions, tuples, lists, ... 

This PR also adds the infrastructure to preserve parentheses around expressions (depending on the context)

<!-- What's the purpose of the change? What does it do, and why? -->

## Test Plan

`cargo test`


---

_Comment by @MichaReiser on 2023-06-05 09:27_

Current dependencies on/for this PR:
* main
  * **PR #4862** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4862" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #4895** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4895" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #4904** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4904" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #4921** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4921" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #4922** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4922" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/charliermarsh/ruff/4862?utm_source=stack-comment).

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/resources/test/fixtures/ruff/expression/binary_expression.py`:14 on 2023-06-05 09:28_

Not all of these are handled correctly yet because the format implementation of the right hand side is missing

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_bin_op.rs`:36 on 2023-06-05 09:29_

This implementation heavily relies on recursion. We may want to explore to manually unroll left-balanced binary expressions because this could stack-overflow for very deep binary expressions (but so could any of our analyzer infrastructure).

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/mod.rs`:177 on 2023-06-05 09:30_

This is unfortunate. We now have to inspect the source code for every expression that we format but I haven't been able to come up with a better approach. Let's see what the benchmark says to this.

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/snapshots/ruff_python_formatter__tests__black_test__comments_py.snap`:117 on 2023-06-05 09:31_

We'll need to handle docstrings manually in the `Suite` formatting but that's not part of this PR

---

_@MichaReiser reviewed on 2023-06-05 09:32_

---

_Marked ready for review by @MichaReiser on 2023-06-05 09:35_

---

_Label `internal` added by @MichaReiser on 2023-06-05 09:35_

---

_Label `autoformatter` added by @MichaReiser on 2023-06-05 09:35_

---

_Comment by @github-actions[bot] on 2023-06-05 09:48_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      5.6Â±0.01ms     7.3 MB/sec    1.00      5.6Â±0.03ms     7.3 MB/sec
formatter/numpy/ctypeslib.py               1.00   1153.7Â±1.66Âµs    14.4 MB/sec    1.00   1158.9Â±1.54Âµs    14.4 MB/sec
formatter/numpy/globals.py                 1.00    133.2Â±1.86Âµs    22.2 MB/sec    1.00    132.7Â±0.46Âµs    22.2 MB/sec
formatter/pydantic/types.py                1.00      2.5Â±0.01ms    10.2 MB/sec    1.01      2.5Â±0.01ms    10.2 MB/sec
linter/all-rules/large/dataset.py          1.04     14.3Â±0.04ms     2.8 MB/sec    1.00     13.8Â±0.05ms     3.0 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.02      3.4Â±0.01ms     4.9 MB/sec    1.00      3.4Â±0.01ms     5.0 MB/sec
linter/all-rules/numpy/globals.py          1.02    418.9Â±2.08Âµs     7.0 MB/sec    1.00    411.9Â±0.68Âµs     7.2 MB/sec
linter/all-rules/pydantic/types.py         1.03      6.0Â±0.01ms     4.3 MB/sec    1.00      5.8Â±0.02ms     4.4 MB/sec
linter/default-rules/large/dataset.py      1.08      7.3Â±0.01ms     5.6 MB/sec    1.00      6.8Â±0.01ms     6.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.06   1549.7Â±2.59Âµs    10.7 MB/sec    1.00   1466.7Â±1.80Âµs    11.4 MB/sec
linter/default-rules/numpy/globals.py      1.04    169.4Â±0.25Âµs    17.4 MB/sec    1.00    162.3Â±0.27Âµs    18.2 MB/sec
linter/default-rules/pydantic/types.py     1.07      3.2Â±0.00ms     7.9 MB/sec    1.00      3.0Â±0.00ms     8.4 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.07      6.4Â±0.02ms     6.3 MB/sec    1.00      6.0Â±0.06ms     6.8 MB/sec
formatter/numpy/ctypeslib.py               1.07  1242.4Â±62.38Âµs    13.4 MB/sec    1.00  1160.6Â±11.13Âµs    14.3 MB/sec
formatter/numpy/globals.py                 1.03    134.3Â±2.62Âµs    22.0 MB/sec    1.00    130.9Â±4.85Âµs    22.5 MB/sec
formatter/pydantic/types.py                1.06      2.7Â±0.02ms     9.4 MB/sec    1.00      2.6Â±0.02ms     9.9 MB/sec
linter/all-rules/large/dataset.py          1.00     13.2Â±0.06ms     3.1 MB/sec    1.00     13.2Â±0.14ms     3.1 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.3Â±0.01ms     5.1 MB/sec    1.00      3.3Â±0.01ms     5.1 MB/sec
linter/all-rules/numpy/globals.py          1.00    337.0Â±2.57Âµs     8.8 MB/sec    1.00    337.0Â±3.31Âµs     8.8 MB/sec
linter/all-rules/pydantic/types.py         1.01      5.6Â±0.01ms     4.6 MB/sec    1.00      5.5Â±0.02ms     4.6 MB/sec
linter/default-rules/large/dataset.py      1.00      6.8Â±0.02ms     6.0 MB/sec    1.01      6.9Â±0.07ms     5.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1376.9Â±7.79Âµs    12.1 MB/sec    1.00   1380.5Â±9.83Âµs    12.1 MB/sec
linter/default-rules/numpy/globals.py      1.00    147.5Â±0.77Âµs    20.0 MB/sec    1.01    148.6Â±1.48Âµs    19.9 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.0Â±0.01ms     8.5 MB/sec    1.01      3.0Â±0.01ms     8.4 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_@MichaReiser reviewed on 2023-06-05 15:56_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_list.rs`:15 on 2023-06-05 15:56_

This is not a full implementation, but it is good enough to test the right side breaking of binary expressions

---

_@MichaReiser reviewed on 2023-06-05 15:57_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/snapshots/ruff_python_formatter__tests__ruff_test__expression__binary_expression_py.snap`:103 on 2023-06-05 15:57_

The new lines before the comment get removed. I'll look into this tomorrow as a separate PR

---

_Review requested from @charliermarsh by @MichaReiser on 2023-06-05 15:57_

---

_Review requested from @konstin by @MichaReiser on 2023-06-05 15:57_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/expression/mod.rs`:177 on 2023-06-05 20:06_

What are the alternatives? In the initial prototype, I think I handled these similarly to comments -- so, for every parenthesis, I associated it with the child it contains.

---

_@charliermarsh reviewed on 2023-06-05 20:06_

---

_@charliermarsh approved on 2023-06-05 20:06_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/mod.rs`:177 on 2023-06-05 20:18_

I considered extracting the tokenized ranges from the token stream and either:

* Store them in a vec and perform a binary search: I don't think this is faster because it trades the few character iterations with a binary search for every expression (except maybe if there are None). 
* Storing the `parenthesized` in a `Trivia` struct and look it up by node. Again, I don't think this would be faster because we trade the iterating over a few characters vs performing a hash map lookup (while fast, iterating over 1- characters is super fast too)



---

_@MichaReiser reviewed on 2023-06-05 20:18_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/expr_bin_op.rs`:53 on 2023-06-06 07:18_

why is it `text(" ")` here and `space()` below?

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/expr_bin_op.rs`:93 on 2023-06-06 07:24_

that sentence seems mangled

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/expr_bin_op.rs`:94 on 2023-06-06 07:26_

nit: you can treat this similar to `before_operator_space` so it becomes one write statement

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/expr_list.rs`:24 on 2023-06-06 07:35_

nit: reads strange when the normal case is in the conditional

---

_@konstin approved on 2023-06-06 07:39_

---

_@MichaReiser reviewed on 2023-06-06 07:49_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_bin_op.rs`:53 on 2023-06-06 07:49_

Oh good catch. I wasn't sure if there's a bug in the `Printer` with handling of `space` but it was just me not understanding how groups work 

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_bin_op.rs`:94 on 2023-06-06 07:50_

Unfortunately not, because `hard_line_break` returns a `Line` whereas `space` returns a `Space` struct. 

---

_@MichaReiser reviewed on 2023-06-06 07:50_

---

_Closed by @konstin on 2023-06-06 08:27_

---

_Reopened by @konstin on 2023-06-06 08:27_

---

_Merged by @konstin on 2023-06-06 08:34_

---

_Closed by @konstin on 2023-06-06 08:34_

---

_Branch deleted on 2023-06-06 08:34_

---
