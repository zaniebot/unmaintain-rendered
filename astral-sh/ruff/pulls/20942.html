<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`ruff`] Update schemars to v1 - astral-sh/ruff #20942</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>ruff</code>] Update schemars to v1</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20942">#20942</a>
        opened by <a href="https://github.com/TaKO8Ki">@TaKO8Ki</a>
        on 2025-10-17 15:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/TaKO8Ki">@TaKO8Ki</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff/ty! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title? (Please prefix with `[
  requests.)
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<!-- What's the purpose of the change? What does it do, and why? -->

<p>FIxes #19173</p>
<p>Update schemars to v1</p>
<p><strong>I’ve verified that the fundamentals of ruff.schema.json and ty.schema.json remain unchanged following the Schemars upgrade.</strong></p>
<p>The migration is based on https://graham.cool/schemars/migrating.</p>
<h3>Shared Changes</h3>
<ul>
<li>~~Upgraded both schemas to <strong>JSON Schema draft 2020-12</strong> andmigrated shared types into <strong><code>$defs</code></strong>, with all <code>$ref</code> paths now using <code>#/$defs/...</code>.~~</li>
<li>Added reusable helpers such as <code>$defs/string</code> (and array helpers like <code>Array_of_string</code>) to avoid duplicating scalar/collection shapes.</li>
<li>Reformatted descriptions with consistent newline breaks. <strong>[Schemars 1.0]</strong> — since <strong>v1.0.0-alpha.3</strong>, Schemars stops collapsing doc-comment whitespace; multi-line Rust docs flow through to <code>description</code> verbatim. ref: https://github.com/GREsau/schemars/issues/120</li>
<li>Kept existing <strong>deprecated</strong> flags but moved them earlier within each property object to match the new formatting.</li>
</ul>
<h3>ty.schema.json</h3>
<ul>
<li>Introduced <code>$defs</code> entries for path-related types (<code>RelativePathBuf</code>, <code>SystemPathBuf</code>) and updated path properties to reference them.</li>
<li>Redirected overrides to a new <code>OverridesOptions</code> array definition with expanded multi-line documentation and examples, while maintaining the original rule descriptions under the updated formatting.</li>
</ul>
<h2>Test Plan</h2>
<!-- How was it tested? -->

<p>Check if existing tests pass.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-17 15:47</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-17 15:48</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-17 16:11</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/TaKO8Ki">@TaKO8Ki</a> reviewed on 2025-10-17 18:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/TaKO8Ki">@TaKO8Ki</a> on <code>ruff.schema.json</code>:1408 on 2025-10-17 18:10</div>
            <div class="timeline-body"><p>These changes looks weird, but they refer to <code>Name</code> struct, which means String in schemars. That is why they use <code>defs/string</code> instead of <code>string</code>.</p>
<p>https://github.com/astral-sh/ruff/blob/c4240076459bc9128fee6f83cbf0f51d134b663b/crates/ruff_workspace/src/options.rs#L1970-L1977</p>
<p>https://github.com/astral-sh/ruff/blob/c4240076459bc9128fee6f83cbf0f51d134b663b/crates/ruff_workspace/src/options.rs#L1960-L1968</p>
<p>https://github.com/astral-sh/ruff/blob/c4240076459bc9128fee6f83cbf0f51d134b663b/crates/ruff_python_ast/src/name.rs#L204-L227</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/TaKO8Ki">@TaKO8Ki</a> reviewed on 2025-10-17 18:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/TaKO8Ki">@TaKO8Ki</a> on <code>ruff.schema.json</code>:1178 on 2025-10-17 18:11</div>
            <div class="timeline-body"><p>Same as below.</p>
<p>https://github.com/astral-sh/ruff/pull/20942#discussion_r2440788641</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/TaKO8Ki">@TaKO8Ki</a> reviewed on 2025-10-17 18:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/TaKO8Ki">@TaKO8Ki</a> on <code>ty.schema.json</code>:1137 on 2025-10-17 18:12</div>
            <div class="timeline-body"><p>This is related to https://github.com/astral-sh/ruff/pull/20942#discussion_r2440788641</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/TaKO8Ki">@TaKO8Ki</a> reviewed on 2025-10-17 18:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/TaKO8Ki">@TaKO8Ki</a> on <code>ruff.schema.json</code>:4353 on 2025-10-17 18:13</div>
            <div class="timeline-body"><p>This is related to https://github.com/astral-sh/ruff/pull/20942#discussion_r2440788641.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/TaKO8Ki">@TaKO8Ki</a> reviewed on 2025-10-17 18:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/TaKO8Ki">@TaKO8Ki</a> on <code>ty.schema.json</code>:1093 on 2025-10-17 18:25</div>
            <div class="timeline-body"><p>With <strong>Schemars 1.0</strong> (defaulting to JSON Schema <strong>2020-12</strong>), named newtypes are <strong>emitted as reusable <code>$ref</code>s in <code>#/$defs</code> by default</strong>, even when <code>#[serde(transparent)]</code> makes their schema equal to the inner field. This preserves <strong>type identity</strong> and <strong>deduplicates</strong> shared shapes.</p>
<p>https://github.com/astral-sh/ruff/blob/c4240076459bc9128fee6f83cbf0f51d134b663b/crates/ty_project/src/metadata/value.rs#L330-L332</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/TaKO8Ki">@TaKO8Ki</a> reviewed on 2025-10-17 18:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/TaKO8Ki">@TaKO8Ki</a> on <code>ty.schema.json</code>:1111 on 2025-10-17 18:26</div>
            <div class="timeline-body"><p>This is related to https://github.com/astral-sh/ruff/pull/20942#discussion_r2440836378.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @TaKO8Ki on 2025-10-17 18:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @TaKO8Ki on 2025-10-17 18:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @TaKO8Ki on 2025-10-17 18:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @TaKO8Ki on 2025-10-17 18:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @TaKO8Ki on 2025-10-17 18:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @TaKO8Ki on 2025-10-17 18:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @AlexWaygood on 2025-10-17 18:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>ty.schema.json</code>:259 on 2025-10-19 10:25</div>
            <div class="timeline-body"><p>The escaping here looks incorrect to me</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-19 10:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-19 10:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/name.rs</code>:206 on 2025-10-19 10:34</div>
            <div class="timeline-body"><p>I think we could replace this with</p>
<pre><code class="language-rust">#[cfg_attr(
    feature = &quot;serde&quot;,
    derive(serde::Serialize, serde::Deserialize),
    serde(transparent)
)]
#[cfg_attr(feature = &quot;cache&quot;, derive(ruff_macros::CacheKey))]
#[cfg_attr(feature = &quot;salsa&quot;, derive(salsa::Update))]
#[cfg_attr(feature = &quot;get-size&quot;, derive(get_size2::GetSize))]
#[cfg_attr(
    feature = &quot;schemars&quot;,
    derive(schemars::JsonSchema),
    schemars(with = &quot;String&quot;)
)]
</code></pre>
<p>(serde(transparent) and <code>schemars(with=&quot;String&quot;)</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-19 10:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/python_version.rs</code>:206 on 2025-10-19 10:35</div>
            <div class="timeline-body"><p>Nit</p>
<pre><code class="language-suggestion">            let mut any_of: Vec&lt;Value&gt; = vec![
            	schemars::json_schema!({
	                &quot;type&quot;: &quot;string&quot;,
	                &quot;pattern&quot;: r&quot;^\\d+\\.\\d+$&quot;,
	            })
            ];
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-19 10:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/options.rs</code>:3942 on 2025-10-19 10:37</div>
            <div class="timeline-body"><p>What's the reason for changing those fields to a <code>BTreeMap</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-19 10:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/metadata/options.rs</code>:802 on 2025-10-19 10:38</div>
            <div class="timeline-body"><p>Nit: I'd prefer to keep this in its own <code>mod</code> (and in the same position, it makes attributing changes with git easier)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-19 10:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/python_platform.rs</code>:81 on 2025-10-19 10:39</div>
            <div class="timeline-body"><p>Can we preserve this comment</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-19 10:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>ruff.schema.json</code>:2 on 2025-10-19 10:41</div>
            <div class="timeline-body"><p>SchemaStore's recommendation is to still use draft-07 because many editors lack support for newer drafts, see</p>
<blockquote>
<p>We recommend using the draft-07 JSON schema version. Later versions of JSON Schema are not yet recommended for use in SchemaStore until IDE and language support improves for those versions.</p>
</blockquote>
<p>https://github.com/SchemaStore/schemastore/blob/master/CONTRIBUTING.md#best-practices</p>
<p>That's why I think we should not change the schema version as part of this PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-19 10:47</div>
            <div class="timeline-body"><p>Thank you. This looks great overall. My only concern is the bump of the schema version. SchemaStore recommends draft-07 for best editor compatibility. I suggest we defer the schema version bump as it requires extensive testing across editors.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2025-10-19 10:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/TaKO8Ki">@TaKO8Ki</a> reviewed on 2025-10-19 11:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/TaKO8Ki">@TaKO8Ki</a> on <code>ruff.schema.json</code>:2 on 2025-10-19 11:42</div>
            <div class="timeline-body"><p>Ok. It's also possible to continue to use draft-07. I will replace the schema version.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/TaKO8Ki">@TaKO8Ki</a> reviewed on 2025-10-19 11:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/TaKO8Ki">@TaKO8Ki</a> on <code>crates/ty_project/src/metadata/options.rs</code>:802 on 2025-10-19 11:53</div>
            <div class="timeline-body"><p>What I want to do is implementing JsonSchema for Rules instead of <code>schemars(with = &quot;schema::Rules&quot;)</code>, so I will keep the mod and implement it inside the module.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TaKO8Ki">@TaKO8Ki</a> on 2025-10-20 06:54</div>
            <div class="timeline-body"><p>@MichaReiser Thank you for the review. I have addressed your comments!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-20 06:58</div>
            <div class="timeline-body"><p>This is great. Thank you so much!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-10-20 06:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-10-20 06:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-10-20 07:00</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:16:30 UTC
    </footer>
</body>
</html>
