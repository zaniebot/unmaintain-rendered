```yaml
number: 7409
title: "fix: Use BestFit layout for subscript"
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: subscript-best-fit-layout
created_at: 2023-09-15T15:59:15Z
updated_at: 2023-09-16T14:21:46Z
url: https://github.com/astral-sh/ruff/pull/7409
synced_at: 2026-01-12T15:55:23Z
```

# fix: Use BestFit layout for subscript

---

_@MichaReiser_

## Summary


Ruff never parenthesized long attribute chains followed by a subscript:

```python
def main() -> None:
    if True:
        some_very_long_variable_name_abcdefghijk = Foo()
        some_very_long_variable_name_abcdefghijk = some_very_long_variable_name_abcdefghijk[
            some_very_long_variable_name_abcdefghijk.some_very_long_attribute_name
            == "This is a very long string abcdefghijk"
        ]
```

Whereas Black formats this as 

```python
def main() -> None:
    if True:
        some_very_long_variable_name_abcdefghijk = Foo()
        some_very_long_variable_name_abcdefghijk = (
            some_very_long_variable_name_abcdefghijk[
                some_very_long_variable_name_abcdefghijk.some_very_long_attribute_name
                == "This is a very long string abcdefghijk"
            ]
        )
```

This PR changes the `needs_parentheses` function of `ExprSubscript` to use the `BestFit` layout if its value proposes the `BestFit` layout (except when in return type annotations, see inline comments)

Making this change revealed an instability because the formatter incorrectly removed the parentheses from callees or objects. I changed the call chain formatting to preserve parentheses.

Closes #7407.

Closes #7422.

## Test Plan

I added new tests

**Base**

| project      | similarity index  | total files       | changed files     |
|--------------|------------------:|------------------:|------------------:|
| cpython      |           0.76083 |              1789 |              1632 |
| django       |           0.99982 |              2760 |                37 |
| transformers |           0.99957 |              2587 |               399 |
| twine        |           1.00000 |                33 |                 0 |
| typeshed     |           0.99983 |              3496 |                18 |
| warehouse    |           0.99923 |               648 |                18 |
| zulip        |           0.99962 |              1437 |                22 |

**This PR**

| project      | similarity index  | total files       | changed files     |
|--------------|------------------:|------------------:|------------------:|
| cpython      |           0.76083 |              1789 |              1632 |
| django       |           0.99982 |              2760 |                37 |
| transformers |           0.99957 |              2587 |               399 |
| twine        |           1.00000 |                33 |                 0 |
| typeshed     |           0.99983 |              3496 |                18 |
| **warehouse**    |           0.99929 |               648 |                16 | <--
| zulip        |           0.99962 |              1437 |                22 |



---

_Comment by @MichaReiser on 2023-09-15 15:59_

Current dependencies on/for this PR:
* main
  * **PR #7409** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7409" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  üëà

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7409?utm_source=stack-comment).

---

_Label `formatter` added by @MichaReiser on 2023-09-15 16:00_

---

_Review requested from @charliermarsh by @MichaReiser on 2023-09-15 16:00_

---

_Review requested from @konstin by @MichaReiser on 2023-09-15 16:00_

---

_Added to milestone `Formatter: Beta` by @MichaReiser on 2023-09-15 16:12_

---

_Removed from milestone `Formatter: Beta` by @MichaReiser on 2023-09-15 16:13_

---

_Comment by @codspeed-hq[bot] on 2023-09-15 16:16_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/subscript-best-fit-layout)

### Merging #7409 will **degrade performances by 7.48%**

<sub>Comparing <code>subscript-best-fit-layout</code> (84107e8) with <code>main</code> (f936d31)</sub>



### Summary

`‚ùå 4 (üëÅ 4)` regressions
`‚úÖ 21` untouched benchmarks




### Benchmarks breakdown

|     | Benchmark | `main` | `subscript-best-fit-layout` | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| üëÅ | `formatter[pydantic/types.py]` | 19.7 ms | 21.2 ms | -7.48% |
| üëÅ | `formatter[numpy/ctypeslib.py]` | 10.7 ms | 11 ms | -2.71% |
| üëÅ | `formatter[large/dataset.py]` | 57.6 ms | 60.9 ms | -5.5% |
| üëÅ | `formatter[unicode/pypinyin.py]` | 3.6 ms | 3.7 ms | -2.55% |


---

_Renamed from "fix: Use BestFit layout for subscribt" to "fix: Use BestFit layout for subscript" by @MichaReiser on 2023-09-15 16:43_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/expression/expr_subscript.rs`:110 on 2023-09-16 02:19_

Can you use `is_some_and` here?

---

_@charliermarsh approved on 2023-09-16 02:19_

---

_@MichaReiser reviewed on 2023-09-16 14:21_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_subscript.rs`:110 on 2023-09-16 14:21_

I already use `is_some_and` on line 105. Do you mean for the equality comparison? I prefer avoiding lambdas when possible because it leads to very nested code. 

---

_Merged by @MichaReiser on 2023-09-16 14:21_

---

_Closed by @MichaReiser on 2023-09-16 14:21_

---

_Branch deleted on 2023-09-16 14:21_

---
