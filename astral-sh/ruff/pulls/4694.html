<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pycodestyle`] Add blank line(s) rules (`E301`, `E302`, `E303`, `E304`, `E305`, `E306`) - astral-sh/ruff #4694</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pycodestyle</code>] Add blank line(s) rules (<code>E301</code>, <code>E302</code>, <code>E303</code>, <code>E304</code>, <code>E305</code>, <code>E306</code>)</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4694">#4694</a>
        opened by <a href="https://github.com/hoel-bagard">@hoel-bagard</a>
        on 2023-05-28 17:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/hoel-bagard">@hoel-bagard</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR is part of https://github.com/charliermarsh/ruff/issues/2402, it adds the <code>E301</code>, <code>E302</code>, <code>E303</code>, <code>E304</code>, <code>E305</code>, <code>E306</code> error rules along with their fixes.</p>
<p>A first attempt at implementing <code>E305</code> using physical lines was done <a href="https://github.com/charliermarsh/ruff/pull/4635">here</a>, however since some operations are expensive when using physical lines, this implementation uses logical lines.</p>
<p>To be able to use <code>NonLogicalNewline</code> to detect blank lines, I have removed the check explicitly skipping them. I have modified the existing rules so that their behavior remains unchanged.</p>
<h2>Test Plan</h2>
<p>The test fixture uses <a href="https://github.com/PyCQA/pycodestyle/blob/main/testsuite/E30.py">the one from pycodestyle</a> as is, but the notes in the file about which line should generate which error do not fully match the rules nor the implementation. I therefore did my best to manually check that what I did matches the rules/implementation in a way that makes sense.</p>
<p>For example, the rule <a href="https://www.flake8rules.com/rules/E306.html">E306</a>'s example is not detected by pycodestyle, but this <a href="https://github.com/PyCQA/pycodestyle/issues/1011">false positive</a> is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-05-28 17:43</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>✅ ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.22      8.4±0.05ms     4.9 MB/sec    1.00      6.8±0.02ms     6.0 MB/sec
formatter/numpy/ctypeslib.py               1.28   1790.5±4.21µs     9.3 MB/sec    1.00   1401.5±3.59µs    11.9 MB/sec
formatter/numpy/globals.py                 1.40    195.5±2.26µs    15.1 MB/sec    1.00    139.4±1.83µs    21.2 MB/sec
formatter/pydantic/types.py                1.44      4.0±0.01ms     6.4 MB/sec    1.00      2.8±0.01ms     9.2 MB/sec
linter/all-rules/large/dataset.py          1.00     14.2±0.15ms     2.9 MB/sec    1.02     14.5±0.05ms     2.8 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.5±0.01ms     4.7 MB/sec    1.01      3.5±0.01ms     4.7 MB/sec
linter/all-rules/numpy/globals.py          1.00    363.5±1.66µs     8.1 MB/sec    1.01    366.6±1.78µs     8.0 MB/sec
linter/all-rules/pydantic/types.py         1.02      6.3±0.06ms     4.1 MB/sec    1.00      6.2±0.01ms     4.1 MB/sec
linter/default-rules/large/dataset.py      1.00      7.2±0.02ms     5.7 MB/sec    1.02      7.3±0.01ms     5.6 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1467.8±3.55µs    11.3 MB/sec    1.05   1545.3±3.13µs    10.8 MB/sec
linter/default-rules/numpy/globals.py      1.00    158.0±0.26µs    18.7 MB/sec    1.04    164.4±0.12µs    18.0 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.2±0.01ms     8.0 MB/sec    1.04      3.3±0.01ms     7.7 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.20     12.1±0.54ms     3.4 MB/sec    1.00     10.1±0.39ms     4.0 MB/sec
formatter/numpy/ctypeslib.py               1.29      2.6±0.12ms     6.4 MB/sec    1.00      2.0±0.09ms     8.2 MB/sec
formatter/numpy/globals.py                 1.41   287.3±16.46µs    10.3 MB/sec    1.00   203.7±11.31µs    14.5 MB/sec
formatter/pydantic/types.py                1.38      5.6±0.24ms     4.5 MB/sec    1.00      4.1±0.17ms     6.3 MB/sec
linter/all-rules/large/dataset.py          1.00     19.2±0.64ms     2.1 MB/sec    1.03     19.8±0.64ms     2.1 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      5.1±0.24ms     3.3 MB/sec    1.01      5.1±0.23ms     3.3 MB/sec
linter/all-rules/numpy/globals.py          1.02   618.3±32.51µs     4.8 MB/sec    1.00   608.2±27.85µs     4.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      8.5±0.34ms     3.0 MB/sec    1.00      8.5±0.30ms     3.0 MB/sec
linter/default-rules/large/dataset.py      1.00     10.4±0.67ms     3.9 MB/sec    1.06     11.0±0.58ms     3.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00      2.2±0.06ms     7.5 MB/sec    1.00      2.2±0.08ms     7.5 MB/sec
linter/default-rules/numpy/globals.py      1.04   271.6±15.17µs    10.9 MB/sec    1.00    261.1±9.81µs    11.3 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.7±0.16ms     5.4 MB/sec    1.01      4.8±0.22ms     5.3 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @MichaReiser on 2023-05-28 19:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/pycodestyle/rules/logical_lines/blank_lines.rs</code>:324 on 2023-05-30 07:35</div>
            <div class="timeline-body"><p>Nit: <code>len</code> gives you the number of bytes and not the number of blank characters. The two are different for non-ascii characters. E.g. emojis are commonly represented as 4 UTF-8 bytes, but they only form 1-2 characters.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/pycodestyle/rules/logical_lines/blank_lines.rs</code>:350 on 2023-05-30 07:37</div>
            <div class="timeline-body"><p>Please avoid introducing new calls to <code>deprecated</code> methods. Use <code>Fix::automatic</code>, <code>Fix::manual</code> or Fix::suggested` instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/pycodestyle/rules/logical_lines/blank_lines.rs</code>:343 on 2023-05-30 07:38</div>
            <div class="timeline-body"><p>I believe this check will fail if <code>prev_line</code> is an empty line even if it is the first method in the class. Or is this intended?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/pycodestyle/rules/logical_lines/blank_lines.rs</code>:101 on 2023-05-30 07:42</div>
            <div class="timeline-body"><p>Is this example correct? Isn't the rule testing for extraneous blank lines (and not too few blank lines)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/pycodestyle/rules/logical_lines/blank_lines.rs</code>:84 on 2023-05-30 07:42</div>
            <div class="timeline-body"><p>Is the title correct? Isn't it testing for missing blank lines?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-30 07:50</div>
            <div class="timeline-body"><p>Thanks for working on this. I haven't reviewed the changes in full details yet because I first want to discuss the overall direction.</p>
<p>I think using tokens to detect the blank lines is preferred over the physical lines. However, I would refrain from changing the definition of <code>LogicalLine</code>s to include empty lines too because it would then contradict <a href="https://docs.python.org/3/reference/lexical_analysis.html#logical-lines">Python's official definition of logical lines</a> (logical lines cannot be empty), which would be rather confusing.</p>
<p>Is my understanding correct, that the rule only tests for blank lines before and after functions, methods, and classes?</p>
<p>If so, then I think it might be <em>easiest</em> to rewrite the rule as an AST based rule that runs for every top level function (you'll need to pass the next statement too, to avoid duplicates), and classes. It can use the <code>Locator</code> and then count the leading/trailing new lines.</p>
<p>If the rules instead test for proper spacing between all statements, then I think it's best if we would build out a new <code>TokenVisitor</code> infrastructure that allows to runs some logic for every token in the program. Both <code>LogicalLine</code>s and your new rule could implement the <code>TokenVisitor</code> trait that has a single <code>visit_token(&amp;mut self, token: &amp;Tok, range: TextRange)</code> method. The visitor can track its own state internally and can trigger its rules when reaching a certain token (end of a logical line, end of a blank line). I would prefer this over changing the semantics of logical line because it still visits the tokens only once and provides us with a more extensible solution that could potentially even allow the other physical lines rule to work on tokens, rather than using the <code>UniversalNewlinesIterator</code>. @charliermarsh what do you think, would you have time to build such infrastructure?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @MichaReiser on 2023-05-30 07:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hoel-bagard">@hoel-bagard</a> on 2023-05-30 08:06</div>
            <div class="timeline-body"><blockquote>
<p>Is my understanding correct, that the rule only tests for blank lines before and after functions, methods, and classes?</p>
</blockquote>
<p>The rules check for proper spacing between all statements. For example, the following would generate an error:</p>
<pre><code class="language-python">a = 1



print(a)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/hoel-bagard">@hoel-bagard</a> on <code>crates/ruff/src/rules/pycodestyle/rules/logical_lines/blank_lines.rs</code>:343 on 2023-05-30 08:18</div>
            <div class="timeline-body"><p>Are you talking about a case like this ?</p>
<pre><code class="language-python">class A:

    def b():
        pass
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/hoel-bagard">@hoel-bagard</a> reviewed on 2023-05-30 08:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/hoel-bagard">@hoel-bagard</a> reviewed on 2023-05-30 08:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/hoel-bagard">@hoel-bagard</a> on <code>crates/ruff/src/rules/pycodestyle/rules/logical_lines/blank_lines.rs</code>:324 on 2023-05-30 08:19</div>
            <div class="timeline-body"><p>Fixed in 47063d4b7536e5624cf96b6cc150a62ad54a417f</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/hoel-bagard">@hoel-bagard</a> reviewed on 2023-05-30 08:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/hoel-bagard">@hoel-bagard</a> on <code>crates/ruff/src/rules/pycodestyle/rules/logical_lines/blank_lines.rs</code>:350 on 2023-05-30 08:19</div>
            <div class="timeline-body"><p>Fixed in 2b4e95954dd8f47317eaf7c3e46ca125bb133ffd</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/hoel-bagard">@hoel-bagard</a> on <code>crates/ruff/src/rules/pycodestyle/rules/logical_lines/blank_lines.rs</code>:101 on 2023-05-30 08:24</div>
            <div class="timeline-body"><p>My understanding is that some rules test for too few blank lines (<a href="https://www.flake8rules.com/rules/E301.html">E301</a>, <a href="https://www.flake8rules.com/rules/E302.html">E302</a>, <a href="https://www.flake8rules.com/rules/E305.html">E305</a> and <a href="https://www.flake8rules.com/rules/E306.html">E306</a>) and others for extraneous blank lines ( <a href="https://www.flake8rules.com/rules/E303.html">E303</a>, <a href="https://www.flake8rules.com/rules/E304.html">E304</a>)</p>
<p>I'm going to fix the titles/descriptions accordingly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/hoel-bagard">@hoel-bagard</a> reviewed on 2023-05-30 08:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/hoel-bagard">@hoel-bagard</a> reviewed on 2023-05-30 09:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/hoel-bagard">@hoel-bagard</a> on <code>crates/ruff/src/rules/pycodestyle/rules/logical_lines/blank_lines.rs</code>:84 on 2023-05-30 09:05</div>
            <div class="timeline-body"><p>Fixed in <a href="https://github.com/charliermarsh/ruff/pull/4694/commits/2fc94f80fcaed9bc599842b91172c8a322671699">2fc94f8</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-02 15:40</div>
            <div class="timeline-body"><p>I haven't reviewed <code>blank_lines.rs</code> extensively, but in pycodestyle, it seems like they just track the number of preceding blank lines in the logical lines builder (but don't emit empty lines), and then when they test the next non-blank logical line, they use that &quot;number of preceding blank lines&quot; state to enforce these rules.</p>
<p>Is that a viable approach for us? To avoid emitting blank lines, and instead track state as we build + include the blank-line context on the next logical line?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hoel-bagard">@hoel-bagard</a> on 2023-06-03 09:48</div>
            <div class="timeline-body"><p>That's essentially what I did (when the logical line is empty I just increment a counter and return), so I think that would work.
I tracked quite a few variables, so that might need to be refined.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @charliermarsh on 2023-06-13 02:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-13 03:20</div>
            <div class="timeline-body"><p>I looked into merging this but it doesn't seem to properly handle nested definitions -- this snippet is clean under pycodestyle, but yields violations here:</p>
<pre><code class="language-py">class C:
    def f():
        pass


def f():
    def f():
        pass
</code></pre>
<p>Yields:</p>
<pre><code>foo.py:2:5: E306 [*] Expected 1 blank line before a nested definition, found 0
foo.py:7:5: E302 [*] Expected 2 blank lines, found 0
foo.py:7:5: E306 [*] Expected 1 blank line before a nested definition, found 0
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hoel-bagard">@hoel-bagard</a> on 2023-06-13 03:27</div>
            <div class="timeline-body"><p>@charliermarsh Yes, the rules and examples of pycodestyles do not match the actual implementation.</p>
<p>For example, the rule <a href="https://www.flake8rules.com/rules/E306.html">E306</a>'s example is not detected by pycodestyle (as you've pointed out above), but this <a href="https://github.com/PyCQA/pycodestyle/issues/1011">false positive</a> is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hoel-bagard">@hoel-bagard</a> on 2023-06-13 03:29</div>
            <div class="timeline-body"><p>I haven't had time to look into tracking the number of blank lines in the logical lines builder yet, but I'll try to do it once I have time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hoel-bagard">@hoel-bagard</a> on 2023-06-16 14:35</div>
            <div class="timeline-body"><p>I've moved the tracking of blank lines into the logical lines builder, so blank lines are no longer emitted as logical lines.
However, I'm not sure how to track the number of blank characters there. I used to have <code>line.text().chars().count()</code>, but I don't think I can access the actual text from within the builder, so instead I used the tokens.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hoel-bagard">@hoel-bagard</a> on 2023-07-07 03:00</div>
            <div class="timeline-body"><p>I started reviewing the output on the pycodestyle fixture, and found a major issue with this PR. Pycodestyle's E3 rules take into account comments. For example:</p>
<pre><code class="language-python">a = 1




# a



# a
class A:
    pass
</code></pre>
<p>Pycodestyle output:</p>
<pre><code>example.py:6:1: E303 too many blank lines (4)
example.py:10:1: E303 too many blank lines (3)
example.py:11:1: E302 expected 2 blank lines, found 4
</code></pre>
<p>However, since comment only lines are not logical lines, I can't reproduce this output. Moreover, this causes the implementation of the autofix to mess up the code.</p>
<p>Without making empty lines/comment only lines into logical lines (or using physical lines), I don't think these rules can be implemented.
@charliermarsh Would you have a recommendation on how I could proceed ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-07 09:16</div>
            <div class="timeline-body"><blockquote>
<p>If the rules instead test for proper spacing between all statements, then I think it's best if we would build out a new TokenVisitor infrastructure that allows to runs some logic for every token in the program. Both LogicalLines and your new rule could implement the TokenVisitor trait that has a single visit_token(&amp;mut self, token: &amp;Tok, range: TextRange) method. The visitor can track its own state internally and can trigger its rules when reaching a certain token (end of a logical line, end of a blank line). I would prefer this over changing the semantics of logical line because it still visits the tokens only once and provides us with a more extensible solution that could potentially even allow the other physical lines rule to work on tokens, rather than using the UniversalNewlinesIterator. @charliermarsh what do you think, would you have time to build such infrastructure?</p>
</blockquote>
<p>@charliermarsh what do you think?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/akx">@akx</a> on 2023-07-24 11:52</div>
            <div class="timeline-body"><p>Could we move this forward somehow? I was about to start implementing these rules but luckily checked whether there was momentum on it already :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hoel-bagard">@hoel-bagard</a> on 2023-07-24 14:25</div>
            <div class="timeline-body"><p>I'll finish cleaning the fixture to make it easier to check that the implementation works (or not).</p>
<p>But without implementing something like the proposed TokenVisitor, it's difficult to progress.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @hoel-bagard on 2023-08-26 12:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hoel-bagard">@hoel-bagard</a> on 2023-09-25 10:57</div>
            <div class="timeline-body"><p>@MichaReiser Did something like the <code>TokenVisitor</code> get implemented since you talked about it ? I would like to finish the PR, but I can't do it using logical lines, since some cases do not include any logical line and should still emit an error (see the example below).</p>
<pre><code class="language-python"># comment




# comment
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-25 12:09</div>
            <div class="timeline-body"><blockquote>
<p>@MichaReiser Did something like the <code>TokenVisitor</code> get implemented since you talked about it ? I would like to finish the PR, but I can't do it using logical lines, since some cases do not include any logical line and should still emit an error (see the example below).</p>
<pre><code class="language-python"># comment




# comment
</code></pre>
</blockquote>
<p>Not the way I described it but there is a set of token-based rules that operate only on the tokens/indexer. Would that meet your needs?</p>
<p>https://github.com/astral-sh/ruff/blob/b34278e0cd25a24b69f4786897ca80c19fc3d5f1/crates/ruff_linter/src/checkers/tokens.rs#L22-L197</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hoel-bagard">@hoel-bagard</a> on 2023-09-25 12:27</div>
            <div class="timeline-body"><p>I think so, thank you.
Is there something I should keep in mind while using the tokens ? For example, in my attempt using physical lines it ended up too slow to be usable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-25 13:44</div>
            <div class="timeline-body"><blockquote>
<p>I should keep in mind while using the tokens ? For example, in my attempt using physical lines it ended up too slow to be usable.</p>
</blockquote>
<p>Try to perform as many operations as possible on the tokens directly. Only fall back to inspect the source code (or token content) if you must.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hoel-bagard">@hoel-bagard</a> on 2023-11-16 13:55</div>
            <div class="timeline-body"><p>Closed in favor of https://github.com/astral-sh/ruff/pull/8720.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @hoel-bagard on 2023-11-16 13:55</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:57:41 UTC
    </footer>
</body>
</html>
