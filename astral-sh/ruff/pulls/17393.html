<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] add a large-union-of-string-literals benchmark - astral-sh/ruff #17393</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] add a large-union-of-string-literals benchmark</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17393">#17393</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2025-04-14 14:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body">Summary
<p>Add a benchmark for a large-union case that currently has exponential blow-up in execution time.</p>
Test Plan
<p><code>cargo bench --bench red_knot</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/carljm">@carljm</a> on 2025-04-14 14:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/BurntSushi">@BurntSushi</a> by <a href="https://github.com/carljm">@carljm</a> on 2025-04-14 14:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/carljm">@carljm</a> on 2025-04-14 14:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-14 14:53</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:289 on 2025-04-14 16:25</div>
            <div class="timeline-body"><p>I&#x27;m not familiar with the existing benchmark setup here, and I see that we do the same thing for <code>benchmark_cold</code>, so this is more of a question: how can we be sure that we are actually re-inferring types in this call here (instead of relying on salsa-cached values)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> approved on 2025-04-14 16:26</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-04-14 16:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:289 on 2025-04-14 16:40</div>
            <div class="timeline-body"><p>I&#x27;m not an expert on this benchmark setup either, but I think the answer is our use of <code>iter_batched_ref</code>, which (per <a href="https://bheisler.github.io/criterion.rs/book/user_guide/timing_loops.html#iter_batchediter_batched_ref">the documentation</a>) treats the input data from the first closure as non-reusable. So it generates a batch of input data by running the first closure (setup) multiple times, then runs the second closure (timed) for each input in the batch. This means that each timed execution of the &quot;check&quot; is running on a brand-new separate Salsa db, with a new memory file system, etc -- they are fully isolated.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/carljm">@carljm</a> on 2025-04-14 16:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2025-04-14 16:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-14 16:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-04-14 17:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:289 on 2025-04-14 17:32</div>
            <div class="timeline-body"><blockquote>
<p>So it generates a batch of input data by running the first closure (setup) multiple times, then runs the second closure (timed) for each input in the batch.</p>
</blockquote>
<p>Oh — thanks for the explanation. I was wrongly assuming the &quot;setup&quot; to only run once for some reason (same terminology but different functionality in other benchmarking libraries).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-04-14 18:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:289 on 2025-04-14 18:09</div>
            <div class="timeline-body"><p>I think Criterion offers both; if the artifacts from the setup are reusable and only need to be created once, you use <code>iter</code> (this is the more common/basic case), if the setup artifacts are non-reusable and need to be generated once per execution, then you use <code>iter_batched/iter_batched_ref</code>. (I don&#x27;t find those method names very inherently clear, but the docs are useful.)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:13:19 UTC
    </footer>
</body>
</html>
