<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unify `Message` variants - astral-sh/ruff #18051</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Unify <code>Message</code> variants</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18051">#18051</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-05-12 17:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR unifies the ruff <code>Message</code> enum variants for syntax errors and rule violations into a single <code>Message</code> struct consisting of a shared <code>db::Diagnostic</code> and some additional, optional fields used for some rule violations.</p>
<p>This version of <code>Message</code> is nearly a drop-in replacement for <code>ruff_diagnostics::Diagnostic</code>, which is the next step I have in mind for the refactor.</p>
<p>I think this is also a useful checkpoint because we could possibly add some of these optional fields to the new <code>Diagnostic</code> type. I think we've previously discussed wanting support for <code>Fix</code>es, but the other fields seem less relevant, so we may just need to preserve the <code>Message</code> wrapper for a bit longer.</p>
<h2>Test plan</h2>
<p>Existing tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by @ntBre on 2025-05-12 17:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-05-12 17:40</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-05-12 17:40</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_INSTRUMENTATION_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/brent%2Fdiagnostic-refactor-2">CodSpeed Performance Report</a></h2>
<h3>Merging #18051 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>brent/diagnostic-refactor-2</code> (ae0b0ad) with <code>main</code> (220137c)</sub></p>
<h3>Summary</h3>
<p><code>✅ 34</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/message/mod.rs</code>:113 on 2025-05-12 17:48</div>
            <div class="timeline-body"><p>This is a bit of a hack. We're storing the pascal-case rule name as the primary diagnostic message (e.g. <code>MissingNewlineAtEndOfFile</code>) since it will accept a <code>String</code>, ~~while the <code>DiagnosticId</code> is the kebab-case <code>&amp;'static str</code> for the rule generated by <code>ruff_macros</code> (<code>missing-newline-at-end-of-file</code> in this case).~~ Edit: this is no longer the case after the perf changes below.</p>
<p>Returning <code>self.diagnostic.id().as_str()</code> from <code>Message::name</code> currently &quot;only&quot; causes two cache tests to fail, so it may not be too hard to fix this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-12 17:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-12 18:25</div>
            <div class="timeline-body"><p>I made a couple of tweaks in https://github.com/astral-sh/ruff/pull/18051/commits/28ad2605c4468d3d3cc26e1142d9b157c2f68eb7 to avoid constructing a <code>Rule</code> from a <code>DiagnosticKind</code> up front. This means we don't get a meaningful <code>DiagnosticId</code> anymore (we aren't really using it yet anyway), but the perf regression dropped from a worst case of 8% to 3%. If I'm reading the graph correctly, the remaining change is from allocating the <code>Vec</code>s inside the new <code>Diagnostic</code> type, which I think is unavoidable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-12 19:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff/src/cache.rs</code>:488 on 2025-05-12 19:08</div>
            <div class="timeline-body"><p>This change didn't actually end up helping at all (besides <code>None</code> being slightly shorter than <code>TextSize::default()</code>), so I'm happy to revert it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-12 19:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/message/mod.rs</code>:257 on 2025-05-12 19:20</div>
            <div class="timeline-body"><p>I can add a newtype with a generated <code>AsRule</code> implementation here instead of reusing <code>DiagnosticKind</code> if we want to keep this approach.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-05-12 20:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @ntBre on 2025-05-12 20:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @ntBre on 2025-05-12 21:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @ntBre on 2025-05-12 21:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @ntBre on 2025-05-12 21:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @ntBre on 2025-05-12 21:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @ntBre on 2025-05-12 21:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @ntBre on 2025-05-12 21:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dcreager removed by @ntBre on 2025-05-12 21:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @ntBre on 2025-05-12 21:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @ntBre on 2025-05-12 21:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @ntBre on 2025-05-12 21:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @ntBre on 2025-05-12 21:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/message/mod.rs</code>:117 on 2025-05-13 06:51</div>
            <div class="timeline-body"><p>I don't think we should do this because it isn't a temporary hack.</p>
<p>Unlike ty, ruff has two codes for every rule: The name and the noqa code. I don't think we can avoid storing both those fields on <code>Diagnostic</code>.</p>
<p>One option is to defer this problem for now and store the <code>NoqaCode</code> as a separate field.</p>
<p>I'm also not sure if this is the right way to work around the performance regression. <code>DiagnosticKind</code> stores a <code>name</code> but that name would be unused once we use the <code>DiagnosticId</code>. Could we change <code>DiagnosticKind::name</code> to store a <code>&amp;'static str</code>? to avoid the <code>rule</code> call or could we store the <code>rule</code> on <code>DiagnosticKind</code>?</p>
<p>I think it is worth doing some more exploration on how and if we can change the <code>DiagnosticKind</code>/<code>Diagnostic</code> representation</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/message/mod.rs</code>:257 on 2025-05-13 06:59</div>
            <div class="timeline-body"><p>Did you check where <code>rule</code> is used? Would it be sufficient to return a <code>NoqaCode</code> instead of the entire rule?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-05-13 07:04</div>
            <div class="timeline-body"><p>Thanks for working on this.</p>
<p>I haven't done an in-depth review. The two things that stand out to me:</p>
<ul>
<li>We'll need a way to store the noqa comment. I think the way you avoided this for now is to lookup the rule by code when necessary. I wonder if it would make sense to extend the diagnostic model to support a secondary code (where id = name, secondary code = noqa)</li>
<li>I don't think we should abuse <code>primary_message</code> for the id and fake an <code>UnknownRule</code> <code>Diagnostic. I think it should be possible to change </code>DiagnosticKind<code>name to</code>&amp;'static str`</li>
<li>Regarding perf: It may be worth exploring if using small vecs in <code>Diagnostic</code> helps with perf (it comes at the downside of increasing the <code>Diagnostic</code> size overall). Maybe best to explore separately</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-13 11:44</div>
            <div class="timeline-body"><p>To extend on my comment. I expect that one of the next steps is to eliminate <code>DiagnosticKind</code>. Because of that: Could we change <code>DiagnosticKind</code> in ways that make this refactor easier:</p>
<ul>
<li>Change <code>name</code> to a <code>LintName</code>?</li>
<li>Store the <code>noqa</code> code in addition to the name (would this remove the need to call <code>rule</code> in code using <code>DiagnosticKind</code> and higher?</li>
<li>...</li>
</ul>
<p>If so, it could then make sense to implement some of those changes as a separate PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-13 12:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/message/mod.rs</code>:257 on 2025-05-13 12:39</div>
            <div class="timeline-body"><p><code>message.rule().noqa_code()</code> does look like the most common usage, but there are multiple places accessing the <code>Rule</code>  name and URL too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-13 12:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/message/mod.rs</code>:117 on 2025-05-13 12:55</div>
            <div class="timeline-body"><p>That makes sense. I guess hand-wavily I was hoping it would be temporary and that a better solution would appear when replacing <code>Diagnostic</code> or something, but it definitely makes sense to use <code>DiagnosticId</code> correctly here.</p>
<p>I don't think we can change <code>DiagnosticKind::name</code> to be a <code>&amp;'static str</code>, at least without calling <code>Box::leak</code> or similar. It's stored in <code>CacheMessage</code> and used in serialization.</p>
<p>I'll look more closely at storing the rule on <code>DiagnosticKind</code>. I'm not sure it would help perf-wise, but it still might make sense. I think this is how they're typically constructed from a <code>Violation</code>:</p>
<p>https://github.com/astral-sh/ruff/blob/62fd8d4048be910ba74f628c19ced2ece48ae66a/crates/ruff_diagnostics/src/violation.rs#L83-L94</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-05-13 12:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/message/mod.rs</code>:117 on 2025-05-13 12:58</div>
            <div class="timeline-body"><p>Could we use a different representation for caching that then goes through the rules lookup to get the diagnostic kind?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-05-13 14:01</div>
            <div class="timeline-body"><p>I don't have a ton of context on the Ruff side of things here, but extending the diagnostic model for the noqa code seems fine to me.</p>
<p>And trying out smallvecs in <code>Diagnostic</code> also seems okay. Note that a <code>Diagnostic</code> is already using an <code>Arc</code> internally, so a <code>Diagnostic</code> itself should stay pointer-sized.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @ntBre on 2025-05-13 17:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-15 19:31</div>
            <div class="timeline-body"><p>After #18074, I got rid of the hacky misuse of <code>primary_message</code> and aligned the <code>Diagnostic</code> fields much better with the new <code>db::Diagnostic</code> type:</p>
<p>| <code>ruff_diagnostics::Diagnostic</code>           | <code>ruff_db::Diagnostic</code>                     |
|------------------------------|--------------------------------------|
| <code>name: &amp;'static str</code>         | <code>DiagnosticId</code>                       |
| <code>body: String</code>               | <code>primary_message</code>                    |
| <code>suggestion: Option&lt;String&gt;</code> | <code>primary_annotation().get_message()</code> |
| <code>range: TextRange</code>           | <code>primary_span().range()</code>             |
| <code>fix: Option&lt;Fix&gt;</code>           |                                      |
| <code>parent: Option&lt;TextSize&gt;</code>   |                                      |</p>
<p><code>Message</code> is now basically just a <code>ruff_diagnostics::Diagnostic</code> with the <code>name</code>, <code>body</code>, <code>suggestion</code>, and <code>range</code> fields folded into a <code>ruff_db::Diagnostic</code> and with one additional <code>noqa_offset</code> field.</p>
<p>I haven't resolved what to do about the <code>NoqaCode</code>s  long-term, but I did add <code>Message::noqa_code</code> and <code>Message::url</code> to make it easier to see where <code>Message::rule</code> is being called and a <code>Rule</code> is actually needed.</p>
<p>From here, I think it makes sense either to start adding fields to <code>db::Diagnostic</code> so that it contains all the information needed by <code>Message</code>, or to go ahead and replace <code>ruff_diagnostics::Diagnostic</code> with <code>Message</code>. I'm leaning towards the latter since <code>Message</code> is still a nice boundary, and it makes some sense to me to delay adding fields to <code>db::Diagnostic</code> until we try actually rendering them in ruff.</p>
<p>I think absorbing <code>ruff_diagnostics::Diagnostic</code> will be pretty straightforward, but this PR was already getting long.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @ntBre on 2025-05-16 22:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @ntBre on 2025-05-16 22:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/cache.rs</code>:488 on 2025-05-17 14:34</div>
            <div class="timeline-body"><p>It probably even increases the size of the struct but I think it's more correct overall.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-05-17 14:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/printer.rs</code>:47 on 2025-05-17 14:37</div>
            <div class="timeline-body"><p>I'd remove this struct and isntead implement <code>Serialize</code> for <code>NoqaCode</code>.</p>
<p>If you decide against it, update the name (because it doesn't serialize the rule)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/printer.rs</code>:330 on 2025-05-17 14:41</div>
            <div class="timeline-body"><p>I assume you're storing the <code>noqa_code</code> here over calling the method multiple times because calling <code>noqa_code</code> isn't free. I'd suggest renaming the method to <code>to_noqa_code</code> and <code>to_rule</code> to make this clear in the API.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/message/mod.rs</code>:114 on 2025-05-17 14:45</div>
            <div class="timeline-body"><p>Nit: The naming here is a bit confusing. Maybe <code>from_ruff_diagnostic</code>? (But I'm also okay leaving it as is, if the type is going away anyway)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/message/mod.rs</code>:192 on 2025-05-17 14:47</div>
            <div class="timeline-body"><p>I find this method somewhat confusing, now that <code>Message</code> no longer has two variants. I think I would replace the method with <code>is_syntax_error</code>.</p>
<p>Edit: I just see that it's only used in a single place and only to get the fix. A syntax error should never have a fix, so I think we can simply remove it all together</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/message/mod.rs</code>:196 on 2025-05-17 14:49</div>
            <div class="timeline-body"><p>Hmm, this is interesting. We need to think about how we want to handle the migration from <code>syntax-error</code> to <code>invalid-syntax</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/message/mod.rs</code>:218 on 2025-05-17 14:50</div>
            <div class="timeline-body"><p>Nit: I think I'd lean towards being more forgiving here and allow missing primary annotations, given that the method returns an <code>Option</code> anyway.</p>
<pre><code class="language-suggestion">        self.diagnostic
            .primary_annotation()?
            .get_message()
    }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/message/mod.rs</code>:236 on 2025-05-17 14:51</div>
            <div class="timeline-body"><p>I think it would be great if we can remove <code>Rule</code> from <code>Message</code> and only store the noqa code (alternate code). But I agree with you that we should leave this to a separate refactor.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/message/mod.rs</code>:254 on 2025-05-17 14:54</div>
            <div class="timeline-body"><p>Hmm, it's annoying that we need to return a <code>String</code> here. I'm leaning towards changing <code>primary_span</code> to return a <code>&amp;Span</code>. We can leave this to a separate PR to also get @BurntSushi's approval but I think it would be great if we don't need to clone unnecessarily</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/codes.rs</code>:14 on 2025-05-17 14:59</div>
            <div class="timeline-body"><p>More an idea for a separate PR if you're interested in it. I wonder if we should store the code as a single <code>&amp;str</code>, together with the byte-offset where the <code>prefix</code> ends and the suffix starts. This would have the advantage that it isn't necessary to call <code>to_string</code> to get the full noqa code (and we can still return a <code>&amp;str</code> for both prefix and suffix in O(1))</p>
<p>Thinking about this more. It's probably not even necessary to store the offset and we can simply compute the split point on demand.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/test.rs</code>:236 on 2025-05-17 15:01</div>
            <div class="timeline-body"><p>Nit: Just an idea</p>
<pre><code class="language-suggestion">        .filter_map(|msg| Some((msg.rule()?, msg)))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-05-17 15:02</div>
            <div class="timeline-body"><p>This is great.</p>
<p>Could you run the hyperfine benchmarks documented in the contribution guideline. Just to make sure we don't regress caching (and test that caching works too because I don't think we have any tests for it). In general. I think it would be good to do some extensive testing of the CLI (statistics etc)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-19 12:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/message/mod.rs</code>:114 on 2025-05-19 12:48</div>
            <div class="timeline-body"><p>Agreed, this and the <code>diagnostic</code> method don't make sense without the history of the <code>DiagnosticMessage</code> variant. I think I will just leave them for now since the intention is to delete them both in my next PR after this and  #18142.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-19 12:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/message/mod.rs</code>:196 on 2025-05-19 12:58</div>
            <div class="timeline-body"><p>Changing this to</p>
<pre><code class="language-rust">    pub fn name(&amp;self) -&gt; &amp;'static str {
        self.diagnostic.id().as_str()
    }
</code></pre>
<p>currently only fails one test for the <code>--statistics</code> flag.</p>
<p>But I agree, I'm not sure where else this could pop up  that might not be tested.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-19 12:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/message/mod.rs</code>:218 on 2025-05-19 12:59</div>
            <div class="timeline-body"><p>Sounds good, there were  a couple of places like that. I'll look for those too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-19 13:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/message/mod.rs</code>:218 on 2025-05-19 13:01</div>
            <div class="timeline-body"><p>Oh, the only other one was the <code>rule</code>. I think we might still want to <code>expect</code> a valid rule name, otherwise I think <code>to_rule</code> is sometimes used to indicate a syntax error in the <code>None</code> case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-19 13:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/codes.rs</code>:14 on 2025-05-19 13:05</div>
            <div class="timeline-body"><p>Added these three (<code>NoqaCode</code> instead of  rule, <code>&amp;Span</code>, and this) to my todo list as follow-ups!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-19 13:32</div>
            <div class="timeline-body"><blockquote>
<p>This is great.</p>
</blockquote>
<p>Thank you! And thanks for the reviews! I think all of the inline comments should be resolved.</p>
<blockquote>
<p>Could you run the hyperfine benchmarks documented in the contribution guideline. Just to make sure we don't regress caching (and test that caching works too because I don't think we have any tests for it). In general. I think it would be good to do some extensive testing of the CLI (statistics etc)</p>
</blockquote>
<p>This is looking like a good suggestion, unlike  the 6x speedup in the contributing guide, I'm seeing a 1.3x speedup:</p>
<pre><code>Benchmark 1: ./target/release/ruff check ./crates/ruff_linter/resources/test/cpython/ --no-cache -e
  Time (mean ± σ):     740.2 ms ±   6.2 ms    [User: 3241.7 ms, System: 135.5 ms]
  Range (min … max):   730.9 ms … 751.4 ms    10 runs

Benchmark 2: ./target/release/ruff check ./crates/ruff_linter/resources/test/cpython/ -e
  Time (mean ± σ):     564.5 ms ±   5.6 ms    [User: 628.6 ms, System: 133.7 ms]
  Range (min … max):   556.8 ms … 575.6 ms    10 runs

Summary
  ./target/release/ruff check ./crates/ruff_linter/resources/test/cpython/ -e ran
    1.31 ± 0.02 times faster than ./target/release/ruff check ./crates/ruff_linter/resources/test/cpython/ --no-cache -e
</code></pre>
<p>However, that's almost identical on <code>main</code>:</p>
<pre><code>Benchmark 1: ./target/release/ruff check ./crates/ruff_linter/resources/test/cpython/ --no-cache -e
  Time (mean ± σ):     710.9 ms ±   4.5 ms    [User: 3164.4 ms, System: 130.1 ms]
  Range (min … max):   701.2 ms … 718.4 ms    10 runs

Benchmark 2: ./target/release/ruff check ./crates/ruff_linter/resources/test/cpython/ -e
  Time (mean ± σ):     546.8 ms ±   5.1 ms    [User: 611.6 ms, System: 135.7 ms]
  Range (min … max):   539.1 ms … 554.2 ms    10 runs

Summary
  ./target/release/ruff check ./crates/ruff_linter/resources/test/cpython/ -e ran
    1.30 ± 0.01 times faster than ./target/release/ruff check ./crates/ruff_linter/resources/test/cpython/ --no-cache -e
</code></pre>
<p>Do you have anything in particular in mind for testing the CLI otherwise? Or should I just try the release build on a few  projects? I guess the ecosystem check showing no changes is somewhat comforting too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-19 13:36</div>
            <div class="timeline-body"><p>The caching speed is surprising. I wonder if this is something we broke recently? If you've time, it might be great to do a quick check that we aren't rerunning any lint rules (maybe just add a panic?). Definetely not blocking this PR, given that this already was like this before</p>
<blockquote>
<p>Do you have anything in particular in mind for testing the CLI otherwise? Or should I just try the release build on a few projects? I guess the ecosystem check showing no changes is somewhat comforting too.</p>
</blockquote>
<p>Not really. Maybe play with a few output formats?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-19 13:41</div>
            <div class="timeline-body"><blockquote>
<p>The caching speed is surprising. I wonder if this is something we broke recently? If you've time, it might be great to do a quick check that we aren't rerunning any lint rules (maybe just add a panic?). Definetely not blocking this PR, given that this already was like this before</p>
</blockquote>
<p>Will do, I might bisect a bit too.</p>
<blockquote>
<p>Not really. Maybe play with a few output formats?</p>
</blockquote>
<p>Will do!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-19 14:58</div>
            <div class="timeline-body"><p>It looks like the caching slowdown is not recent, it's been in a pretty steady decline since that 6x number was recorded. These tags aren't exact, just the tag before the commit I was bisecting:</p>
<p>| Tag     | Speedup |
|---------|---------|
| 0.11.10 | 1.3     |
| 0.9.2   | 1.4     |
| 0.7.3   | 1.7     |
| 0.5.7   | 1.7     |
| 0.5.0   | 1.7     |
| 0.4.5   | 2.6     |
| 0.3.0   | 3.4     |
| 0.0.290 | 3.6     |
| 0.0.240 | 6.1     |</p>
<p><code>Speedup</code> is the relative speedup reading from cache, as reported in the hyperfine summary above.</p>
<p>I couldn't actually build 0.0.240 because of a git dep on libCST that doesn't exist anymore, so that number is from <code>CONTRIBUTING.md</code>. 0.0.290 is the earliest version I could build easily because it added the <code>ruff_linter</code> crate, which is where I had my CPython clone.</p>
<p>I added a panic after the caching early return in <code>lint_path</code> and can confirm that the cache is working too. (I also tried adding a  panic <em>before</em> the early return, right at the top of <code>lint_path</code> and it definitely panicked)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-19 15:40</div>
            <div class="timeline-body"><p>Thanks for the thorough analysis. Let's create an issue to investigate if we can speed up caching. A 30% speed up is rather ridiculous (it should be at least 2x to justify its complexity)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-19 15:54</div>
            <div class="timeline-body"><p>For the CLI testing, I wrote a little script to loop through and diff the various output formats. It looks like the main difference is actually the  <code>noqa_offset</code> change, which is encoded as <code>&quot;noqa_row&quot;: null</code> instead of <code>&quot;noqa_row&quot;: 1</code> in the JSON and JSON-lines output formats.</p>
<p>The gitlab fingerprints also differ compared to 0.11.10, but I think that's from the previous PR, and we expected that there.</p>
<p>I also diffed the <code>--statistics</code> output, and I think it is unchanged, except that the sort appears to be unstable within groups of rules with the same number of diagnostics.</p>
<p>Script:</p>
<pre><code class="language-shell">formats=(
	concise
	full
	json
	json-lines
	junit
	grouped
	github
	gitlab
	pylint
	rdjson
	azure
	sarif
)

for format in ${formats[@]}; do
	echo &quot;checking output format: $format&quot;
	args=&quot;check --no-cache crates/ruff_linter/resources/test/cpython --output-format $format&quot;
	diff &lt;(ruff $args) &lt;(target/release/ruff $args)
done
</code></pre>
<p>Statistics check:</p>
<pre><code class="language-shell">diff  &lt;(ruff check --no-cache crates/ruff_linter/resources/test/cpython --statistics) &lt;(target/release/ruff check --no-cache crates/ruff_linter/resources/test/cpython --statistics)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-19 15:55</div>
            <div class="timeline-body"><blockquote>
<p>For the CLI testing, I wrote a little script to loop through and diff the various output formats. It looks like the main difference is actually the noqa_offset change, which is encoded as &quot;noqa_row&quot;: null instead of &quot;noqa_row&quot;: 1 in the JSON and JSON-lines output formats.</p>
</blockquote>
<p>Can you double check that this won't break ruff-lsp?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-19 16:20</div>
            <div class="timeline-body"><p>I tested in VS Code with the native server disabled on both files from CPython and from the openai-cookbook (I knew they had many notebooks from seeing it in the ecosystem check), and it seems to be working. I also confirmed that <a href="https://github.com/astral-sh/ruff-lsp/blob/main/ruff_lsp/server.py#L844"><code>DiagnosticData.noqa_row</code></a> is annotated as <code>int | None</code> in ruff-lsp, so I think <code>null</code> should be handled gracefully.</p>
<p>I also tested the playground locally, just in case.</p>
<p>Should we ping Dhruv for (or revert) the <code>noqa_offset</code> change? That seems like the biggest potential issue to me, but the things I've tried look okay so far.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-19 17:03</div>
            <div class="timeline-body"><p>I'm fine moving forward. Making it <code>Option</code> would be nice for the <code>Diagnostic</code> type and you did your share of testing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-19 17:07</div>
            <div class="timeline-body"><p>Sounds good, thanks for the testing ideas! I'll plan to merge this soon then.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-05-19 17:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-05-19 17:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-05-19 17:34</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:12:30 UTC
    </footer>
</body>
</html>
