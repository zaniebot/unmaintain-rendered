<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consider Jupyter index for code frames (`--show-source`) - astral-sh/ruff #5402</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Consider Jupyter index for code frames (<code>--show-source</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5402">#5402</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2023-06-27 19:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Consider Jupyter index for code frames (<code>--show-source</code>).</p>
<p>This solves two problems as mentioned in the linked issue:</p>
<blockquote>
<p>Omit any contents from adjoining cells</p>
</blockquote>
<p>If the Jupyter index is present, we'll use that to check if the surrounding
lines belong to the same cell as the content line. If not, we'll skip that line
until we either reach the one which does or we reach the content line.</p>
<blockquote>
<p>code frame line number</p>
</blockquote>
<p>If the Jupyter index is present, we'll use that to get the actual start line in
corresponding to the computed start index.</p>
<h2>Test Plan</h2>
<p><code>cargo run --bin ruff -- check --no-cache --isolated --select=ALL --show-source /path/to/notebook.ipynb</code></p>
<p>fixes: #5395</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-06-27 19:43</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #5402</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5402" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5402?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-06-27 19:45</div>
            <div class="timeline-body"><p>I'm not sure if I'm happy with the implementation due to a bunch of <code>Option</code> handling. I think we should figure out some other way in the future as it could be problematic when other source kinds are introduced (markdown, SQL, etc.).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-06-27 19:52</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      8.3Â±0.03ms     4.9 MB/sec    1.00      8.3Â±0.03ms     4.9 MB/sec
formatter/numpy/ctypeslib.py               1.00   1715.2Â±1.48Âµs     9.7 MB/sec    1.00   1716.6Â±4.16Âµs     9.7 MB/sec
formatter/numpy/globals.py                 1.00    188.1Â±0.34Âµs    15.7 MB/sec    1.00    188.8Â±0.36Âµs    15.6 MB/sec
formatter/pydantic/types.py                1.01      3.9Â±0.03ms     6.5 MB/sec    1.00      3.9Â±0.00ms     6.6 MB/sec
linter/all-rules/large/dataset.py          1.01     14.1Â±0.05ms     2.9 MB/sec    1.00     13.9Â±0.06ms     2.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.5Â±0.02ms     4.8 MB/sec    1.00      3.5Â±0.01ms     4.8 MB/sec
linter/all-rules/numpy/globals.py          1.00    371.3Â±0.75Âµs     7.9 MB/sec    1.00   372.4Â±12.00Âµs     7.9 MB/sec
linter/all-rules/pydantic/types.py         1.01      6.2Â±0.03ms     4.1 MB/sec    1.00      6.1Â±0.03ms     4.2 MB/sec
linter/default-rules/large/dataset.py      1.01      7.1Â±0.02ms     5.7 MB/sec    1.00      7.0Â±0.01ms     5.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01   1490.8Â±2.02Âµs    11.2 MB/sec    1.00   1471.4Â±2.49Âµs    11.3 MB/sec
linter/default-rules/numpy/globals.py      1.02    158.7Â±0.20Âµs    18.6 MB/sec    1.00    155.8Â±0.28Âµs    18.9 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.2Â±0.01ms     7.9 MB/sec    1.00      3.2Â±0.01ms     8.0 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      9.7Â±0.42ms     4.2 MB/sec    1.01      9.8Â±0.37ms     4.1 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.0Â±0.09ms     8.3 MB/sec    1.05      2.1Â±0.12ms     7.9 MB/sec
formatter/numpy/globals.py                 1.00    231.7Â±8.15Âµs    12.7 MB/sec    1.08   250.9Â±19.30Âµs    11.8 MB/sec
formatter/pydantic/types.py                1.06      4.8Â±0.33ms     5.3 MB/sec    1.00      4.6Â±0.20ms     5.6 MB/sec
linter/all-rules/large/dataset.py          1.12     17.4Â±0.64ms     2.3 MB/sec    1.00     15.5Â±0.39ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.16      4.8Â±0.22ms     3.4 MB/sec    1.00      4.2Â±0.15ms     4.0 MB/sec
linter/all-rules/numpy/globals.py          1.14   605.2Â±26.80Âµs     4.9 MB/sec    1.00   528.6Â±25.36Âµs     5.6 MB/sec
linter/all-rules/pydantic/types.py         1.05      7.9Â±0.47ms     3.2 MB/sec    1.00      7.5Â±0.39ms     3.4 MB/sec
linter/default-rules/large/dataset.py      1.01      8.4Â±0.63ms     4.9 MB/sec    1.00      8.3Â±0.28ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1757.3Â±88.51Âµs     9.5 MB/sec    1.04  1821.6Â±61.27Âµs     9.1 MB/sec
linter/default-rules/numpy/globals.py      1.00    207.2Â±7.51Âµs    14.2 MB/sec    1.10   228.5Â±15.74Âµs    12.9 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.6Â±0.18ms     7.0 MB/sec    1.09      4.0Â±0.17ms     6.4 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-28 01:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/message/text.rs</code>:199 on 2023-06-28 01:20</div>
            <div class="timeline-body"><p>Should we put this outside of the <code>while</code>, and have separate <code>while</code> loops in the <code>if</code> and <code>else</code> branches? The control flow here is a little hard to follow.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-28 01:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/message/text.rs</code>:231 on 2023-06-28 01:20</div>
            <div class="timeline-body"><p>Same here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-06-28 01:20</div>
            <div class="timeline-body"><p>Seems reasonable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-06-28 03:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/message/text.rs</code>:199 on 2023-06-28 03:14</div>
            <div class="timeline-body"><p>Make sense. I've separated them out and also used <code>unwrap_or_default</code> for <code>index.cell</code> and <code>index.cell_row</code>. The unwrap failure is unlikely but if it happens then the rendering will be incorrect and would most likely be reported by the user.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-06-28 03:14</div>
            <div class="timeline-body"><p>@charliermarsh Can you check if the control flow is reasonable to follow now?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-28 03:16</div>
            <div class="timeline-body"><p>LGTM.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2023-06-28 03:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2023-06-28 03:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-06-28 03:24</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:58:25 UTC
    </footer>
</body>
</html>
