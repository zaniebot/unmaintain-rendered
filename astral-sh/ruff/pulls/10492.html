<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix instable formatting for trailing subscribt end-of-line comment - astral-sh/ruff #10492</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix instable formatting for trailing subscribt end-of-line comment</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10492">#10492</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-03-20 16:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-03-20 16:48</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR fixes an instability where formatting a subscribt
where the <code>slice</code> is not an <code>ExprSlice</code> and it has a trailing end-of-line comment after its opening <code>[</code> required two formatting passes to be stable.</p>
<p>The fix is to associate the trailing end-of-line comment as dangling comment on <code>[</code> to preserve its position, similar to how Ruff does it for other parenthesized expressions.
This also matches how trailing end-of-line subscript comments are handled when the <code>slice</code> is an <code>ExprSlice</code>.</p>
<p>Fixes https://github.com/astral-sh/ruff/issues/10355</p>
<h2>Versioning</h2>
<p>Shipping this as part of a patch release is fine because:</p>
<ul>
<li>It fixes a stability issue</li>
<li>It doesn't impact already formatted code because Ruff would already have moved to the comment to the end of the line (instead of preserving it)</li>
</ul>
<h2>Test Plan</h2>
<p>Added tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @MichaReiser on 2024-03-20 16:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2024-03-20 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2024-03-20 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @MichaReiser on 2024-03-20 16:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-03-20 16:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-03-20 16:59</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Formatter (stable)</h3>
<p>ℹ️ ecosystem check <strong>detected format changes</strong>. (+15 -5 lines in 3 files in 1 projects; 42 projects unchanged)</p>
<details><summary><a href="https://github.com/demisto/content">demisto/content</a> (+15 -5 lines across 3 files)</summary>
<p>
<pre>ruff format --no-preview --exclude Packs/ThreatQ/Integrations/ThreatQ/ThreatQ.py</pre>
</p>
<p>

<p><a href='https://github.com/demisto/content/blob/426215f184c4e7476a38d883cd4d88feee40874b/Packs/ApiModules/Scripts/CoreIRApiModule/CoreIRApiModule_test.py#L770'>Packs/ApiModules/Scripts/CoreIRApiModule/CoreIRApiModule_test.py~L770</a></p>
<pre><code class="language-diff"> 
     assert (
         &quot;handle_outgoing_issue_closure Closing Remote incident incident_id=None with status resolved_security_testing&quot;
-        in request_data_log.call_args[0][0]  # noqa: E501
+        in request_data_log.call_args[  # noqa: E501
+            0
+        ][0]
     )
 
 
</code></pre>
<p><a href='https://github.com/demisto/content/blob/426215f184c4e7476a38d883cd4d88feee40874b/Packs/Base/Scripts/DBotTrainClustering/DBotTrainClustering.py#L241'>Packs/Base/Scripts/DBotTrainClustering/DBotTrainClustering.py~L241</a></p>
<pre><code class="language-diff">                 dist = {k: v * 100 / total for k, v in chosen.items()}
                 dist_total[cluster_number] = {}
                 dist_total[cluster_number][&quot;number_samples&quot;] = sum(
-                    self.clustering.raw_data[self.clustering.model.labels_ == cluster_number].label.isin(  # type: ignore  # type: ignore
+                    self.clustering.raw_data[  # type: ignore
+                        self.clustering.model.labels_ == cluster_number
+                    ].label.isin(  # type: ignore
                         list(chosen.keys())
                     )
                 )  # type: ignore
</code></pre>
<p><a href='https://github.com/demisto/content/blob/426215f184c4e7476a38d883cd4d88feee40874b/Packs/Base/Scripts/DBotTrainClustering/DBotTrainClustering.py#L603'>Packs/Base/Scripts/DBotTrainClustering/DBotTrainClustering.py~L603</a></p>
<pre><code class="language-diff">             &quot;pivot&quot;: &quot;clusterId:&quot; + str(cluster_number),
             &quot;incidents_ids&quot;: [
                 x
-                for x in incidents_df[clustering.model.labels_ == cluster_number].id.values.tolist()  # type: ignore
+                for x in incidents_df[  # type: ignore
+                    clustering.model.labels_ == cluster_number
+                ].id.values.tolist()
             ],  # type: ignore
             &quot;incidents&quot;: incidents_df[clustering.model.labels_ == cluster_number][  # type: ignore
                 display_fields + fields_for_clustering_remove_display
</code></pre>
<p><a href='https://github.com/demisto/content/blob/426215f184c4e7476a38d883cd4d88feee40874b/Packs/Base/Scripts/DBotTrainClustering/DBotTrainClustering.py#L617'>Packs/Base/Scripts/DBotTrainClustering/DBotTrainClustering.py~L617</a></p>
<pre><code class="language-diff">     d_outliers = {
         &quot;incidents_ids&quot;: [
             x
-            for x in incidents_df[clustering.model.labels_ == -1].id.values.tolist()  # type: ignore
+            for x in incidents_df[  # type: ignore
+                clustering.model.labels_ == -1
+            ].id.values.tolist()
         ],  # type: ignore
         &quot;incidents&quot;: incidents_df[clustering.model.labels_ == -1][display_fields].to_json(  # type: ignore
             orient=&quot;records&quot;
</code></pre>
<p><a href='https://github.com/demisto/content/blob/426215f184c4e7476a38d883cd4d88feee40874b/Packs/Orca/Integrations/Orca/Orca.py#L47'>Packs/Orca/Integrations/Orca/Orca.py~L47</a></p>
<pre><code class="language-diff"> 
     def get_alerts_by_filter(
         self, alert_type: Optional[str] = None, asset_unique_id: Optional[str] = None, limit: int = 1000
-    ) -&gt; Union[List[Dict[str, Any]], str]:  # pylint: disable=E1136 # noqa: E501  # pylint: disable=E1136 # noqa: E125
+    ) -&gt; Union[  # pylint: disable=E1136 # noqa: E501
+        List[Dict[str, Any]], str
+    ]:  # pylint: disable=E1136 # noqa: E125
         demisto.info(&quot;get_alerts_by_filter, enter&quot;)
 
         url_suffix = &quot;/alerts&quot;
</code></pre>
</p>
</details>

<h3>Formatter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected format changes</strong>. (+15 -5 lines in 3 files in 1 projects; 42 projects unchanged)</p>
<details><summary><a href="https://github.com/demisto/content">demisto/content</a> (+15 -5 lines across 3 files)</summary>
<p>
<pre>ruff format --preview --exclude Packs/ThreatQ/Integrations/ThreatQ/ThreatQ.py</pre>
</p>
<p>

<p><a href='https://github.com/demisto/content/blob/426215f184c4e7476a38d883cd4d88feee40874b/Packs/ApiModules/Scripts/CoreIRApiModule/CoreIRApiModule_test.py#L768'>Packs/ApiModules/Scripts/CoreIRApiModule/CoreIRApiModule_test.py~L768</a></p>
<pre><code class="language-diff"> 
     assert (
         &quot;handle_outgoing_issue_closure Closing Remote incident incident_id=None with status resolved_security_testing&quot;
-        in request_data_log.call_args[0][0]  # noqa: E501
+        in request_data_log.call_args[  # noqa: E501
+            0
+        ][0]
     )
 
 
</code></pre>
<p><a href='https://github.com/demisto/content/blob/426215f184c4e7476a38d883cd4d88feee40874b/Packs/Base/Scripts/DBotTrainClustering/DBotTrainClustering.py#L241'>Packs/Base/Scripts/DBotTrainClustering/DBotTrainClustering.py~L241</a></p>
<pre><code class="language-diff">                 dist = {k: v * 100 / total for k, v in chosen.items()}
                 dist_total[cluster_number] = {}
                 dist_total[cluster_number][&quot;number_samples&quot;] = sum(
-                    self.clustering.raw_data[self.clustering.model.labels_ == cluster_number].label.isin(  # type: ignore  # type: ignore
+                    self.clustering.raw_data[  # type: ignore
+                        self.clustering.model.labels_ == cluster_number
+                    ].label.isin(  # type: ignore
                         list(chosen.keys())
                     )
                 )  # type: ignore
</code></pre>
<p><a href='https://github.com/demisto/content/blob/426215f184c4e7476a38d883cd4d88feee40874b/Packs/Base/Scripts/DBotTrainClustering/DBotTrainClustering.py#L603'>Packs/Base/Scripts/DBotTrainClustering/DBotTrainClustering.py~L603</a></p>
<pre><code class="language-diff">             &quot;pivot&quot;: &quot;clusterId:&quot; + str(cluster_number),
             &quot;incidents_ids&quot;: [
                 x
-                for x in incidents_df[clustering.model.labels_ == cluster_number].id.values.tolist()  # type: ignore
+                for x in incidents_df[  # type: ignore
+                    clustering.model.labels_ == cluster_number
+                ].id.values.tolist()
             ],  # type: ignore
             &quot;incidents&quot;: incidents_df[clustering.model.labels_ == cluster_number][  # type: ignore
                 display_fields + fields_for_clustering_remove_display
</code></pre>
<p><a href='https://github.com/demisto/content/blob/426215f184c4e7476a38d883cd4d88feee40874b/Packs/Base/Scripts/DBotTrainClustering/DBotTrainClustering.py#L617'>Packs/Base/Scripts/DBotTrainClustering/DBotTrainClustering.py~L617</a></p>
<pre><code class="language-diff">     d_outliers = {
         &quot;incidents_ids&quot;: [
             x
-            for x in incidents_df[clustering.model.labels_ == -1].id.values.tolist()  # type: ignore
+            for x in incidents_df[  # type: ignore
+                clustering.model.labels_ == -1
+            ].id.values.tolist()
         ],  # type: ignore
         &quot;incidents&quot;: incidents_df[clustering.model.labels_ == -1][display_fields].to_json(  # type: ignore
             orient=&quot;records&quot;
</code></pre>
<p><a href='https://github.com/demisto/content/blob/426215f184c4e7476a38d883cd4d88feee40874b/Packs/Orca/Integrations/Orca/Orca.py#L47'>Packs/Orca/Integrations/Orca/Orca.py~L47</a></p>
<pre><code class="language-diff"> 
     def get_alerts_by_filter(
         self, alert_type: Optional[str] = None, asset_unique_id: Optional[str] = None, limit: int = 1000
-    ) -&gt; Union[List[Dict[str, Any]], str]:  # pylint: disable=E1136 # noqa: E501  # pylint: disable=E1136 # noqa: E125
+    ) -&gt; Union[  # pylint: disable=E1136 # noqa: E501
+        List[Dict[str, Any]], str
+    ]:  # pylint: disable=E1136 # noqa: E125
         demisto.info(&quot;get_alerts_by_filter, enter&quot;)
 
         url_suffix = &quot;/alerts&quot;
</code></pre>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-03-20 17:09</div>
            <div class="timeline-body"><p>Hmm, I was wrong. I need to look into the ecosystem changes.</p>
<p>Never mind. These are unformatted projects and the ecosystem changes show that the comment position is now preserved</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2024-03-20 17:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-03-20 17:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-03-20 17:12</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 22:48:02 UTC
    </footer>
</body>
</html>
