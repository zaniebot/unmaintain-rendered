```yaml
number: 6099
title: Pull in RustPython parser
type: pull_request
state: merged
author: MichaReiser
labels:
  - internal
assignees: []
merged: true
base: main
head: pull-in-rust-python
created_at: 2023-07-26T16:55:07Z
updated_at: 2023-07-27T09:46:03Z
url: https://github.com/astral-sh/ruff/pull/6099
synced_at: 2026-01-12T15:55:20Z
```

# Pull in RustPython parser

---

_@MichaReiser_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This PR pulls in the RustPython-parser from https://github.com/astral-sh/RustPython-Parser

The reason for pulling in RustPython are:

* Working on two repositories requires more steps: 1) Crate a PR to the parser repository and merge, 2) Update the hash in our dependency, fix Ruff 
* Our fork has diverged significantly from upstream, to the point where pulling in changes automatically is hard, and copy pasting the changes is often times easier. 

This doesn't mean we won't contribute to the upstream parser in the future. We'll decide on upstream contributions on a case per case basis. 

Another benefit of pulling in the rust python AST is that we can now define our own method on the AST types rather than needing free-standing functions or traits.

## Requested Feedback

* I still need to pull in the RustPython license. Let me know if you have opinions on where to place it and whether we should mention the RustPython team in the crates author metadata
* I copied over the files from the repository. That means we lost the git history. Let me know if you find it important to preserve the history and I can look into it if there's a way to do it
* Merging `rustpython-ast` and `ruff_python_ast` revealed that using the parser inside of `ruff_python_ast` unit tests is no longer possible because that creates a cyclic dependency.  The only way around this is to either extract the tests as integration tests (what I've done here), or keep the two crates separate. 


<!-- What's the purpose of the change? What does it do, and why? -->

## Test Plan

`cargo test`

<!-- How was it tested? -->


---

_Review requested from @dhruvmanila by @MichaReiser on 2023-07-26 16:55_

---

_Comment by @MichaReiser on 2023-07-26 16:55_

Current dependencies on/for this PR:
* main
  * **PR #6099** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6099" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6099?utm_source=stack-comment).

---

_Review requested from @charliermarsh by @MichaReiser on 2023-07-26 17:00_

---

_@charliermarsh approved on 2023-07-26 17:59_

---

_Label `internal` added by @MichaReiser on 2023-07-27 06:25_

---

_Comment by @davidszotten on 2023-07-27 08:12_

seems a shame to lose the history. i think last time i did something like this i followed https://medium.com/@ayushya/move-directory-from-one-repository-to-another-preserving-git-history-d210fa049d4b (i may be misremembering the article; there are lots of tutorials online and i've successfully merged repos a few times in the past without too much trouble)

---

_Merged by @MichaReiser on 2023-07-27 09:29_

---

_Closed by @MichaReiser on 2023-07-27 09:29_

---

_Branch deleted on 2023-07-27 09:29_

---

_Comment by @github-actions[bot] on 2023-07-27 09:32_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     11.7Â±0.48ms     3.5 MB/sec    1.03     12.0Â±0.44ms     3.4 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.3Â±0.13ms     7.3 MB/sec    1.03      2.3Â±0.12ms     7.1 MB/sec
formatter/numpy/globals.py                 1.00   255.2Â±18.36Âµs    11.6 MB/sec    1.02   259.1Â±19.73Âµs    11.4 MB/sec
formatter/pydantic/types.py                1.00      5.0Â±0.20ms     5.1 MB/sec    1.01      5.0Â±0.18ms     5.1 MB/sec
linter/all-rules/large/dataset.py          1.01     17.7Â±0.56ms     2.3 MB/sec    1.00     17.6Â±0.69ms     2.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.3Â±0.24ms     3.9 MB/sec    1.00      4.3Â±0.14ms     3.9 MB/sec
linter/all-rules/numpy/globals.py          1.00   565.4Â±23.93Âµs     5.2 MB/sec    1.01   571.5Â±31.48Âµs     5.2 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.8Â±0.20ms     3.3 MB/sec    1.00      7.8Â±0.32ms     3.3 MB/sec
linter/default-rules/large/dataset.py      1.01      8.7Â±0.22ms     4.7 MB/sec    1.00      8.6Â±0.26ms     4.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1779.1Â±81.36Âµs     9.4 MB/sec    1.00  1786.2Â±57.55Âµs     9.3 MB/sec
linter/default-rules/numpy/globals.py      1.01   208.1Â±11.46Âµs    14.2 MB/sec    1.00   206.4Â±11.79Âµs    14.3 MB/sec
linter/default-rules/pydantic/types.py     1.02      3.8Â±0.12ms     6.6 MB/sec    1.00      3.8Â±0.13ms     6.7 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      8.7Â±0.28ms     4.7 MB/sec    1.02      8.8Â±0.13ms     4.6 MB/sec
formatter/numpy/ctypeslib.py               1.00  1575.9Â±17.03Âµs    10.6 MB/sec    1.04   1639.4Â±8.07Âµs    10.2 MB/sec
formatter/numpy/globals.py                 1.00    165.0Â±3.46Âµs    17.9 MB/sec    1.01    167.1Â±4.04Âµs    17.7 MB/sec
formatter/pydantic/types.py                1.00      3.5Â±0.04ms     7.2 MB/sec    1.03      3.7Â±0.03ms     7.0 MB/sec
linter/all-rules/large/dataset.py          1.00     11.8Â±0.05ms     3.4 MB/sec    1.04     12.3Â±0.75ms     3.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.0Â±0.02ms     5.5 MB/sec    1.00      3.0Â±0.03ms     5.5 MB/sec
linter/all-rules/numpy/globals.py          1.01    306.9Â±2.62Âµs     9.6 MB/sec    1.00    304.4Â±5.49Âµs     9.7 MB/sec
linter/all-rules/pydantic/types.py         1.01      5.2Â±0.02ms     4.9 MB/sec    1.00      5.2Â±0.04ms     4.9 MB/sec
linter/default-rules/large/dataset.py      1.00      6.4Â±0.07ms     6.3 MB/sec    1.01      6.5Â±0.24ms     6.2 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01  1233.1Â±11.82Âµs    13.5 MB/sec    1.00  1225.3Â±15.03Âµs    13.6 MB/sec
linter/default-rules/numpy/globals.py      1.02    126.5Â±2.71Âµs    23.3 MB/sec    1.00    123.5Â±0.92Âµs    23.9 MB/sec
linter/default-rules/pydantic/types.py     1.05      2.8Â±0.04ms     9.1 MB/sec    1.00      2.7Â±0.04ms     9.5 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Comment by @MichaReiser on 2023-07-27 09:36_

Oh no, auto merge was still enabled. I wanted to look into in preserving the history

---
