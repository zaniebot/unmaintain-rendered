<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add a daily workflow to fuzz the parser with randomly selected seeds - astral-sh/ruff #11203</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add a daily workflow to fuzz the parser with randomly selected seeds</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11203">#11203</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-04-29 13:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body">Summary
<p>In https://github.com/astral-sh/ruff/commit/f5c7a62aa65decb9e286bd65ba17f1a3bd1f91e6, we added a new CI job to fuzz the parser. The job runs on all PRs touching the parser, and deliberately only runs the fuzzer with the same seeds each time, so that it can function as a regression test: any bugs surfaced by that job can be guaranteed to be <em>new</em> bugs that we know didn&#x27;t exist on <code>main</code>. (A given seed is always guaranteed to lead to the same file being generated by <code>pysource-codegen</code>.)</p>
<p>This PR adds a second CI job that runs once a day and runs the fuzzer on a <em>randomly selected</em> set of 1,000 seeds. This is less useful as a regression test, as any bugs surfaced by this CI job will not necessarily be <em>new</em> bugs. Theoretically, however, randomly selecting the seeds could be a more successful way of discovering bugs in the parser.</p>
<p>If the daily job fails, a bot will automatically open an issue reporting the failure. Here&#x27;s an example at typeshed of what the issue would look like (we use a similar daily job at typeshed): <a href="https://github.com/python/typeshed/issues/11837">python/typeshed#11837</a>.</p>
Is this useful?
<p>This PR is a proof-of-concept, but I&#x27;m not sure how useful this job would actually be. While this could theoretically help us find more bugs in the parser, I think it&#x27;s likely that most bugs surfaced by this fuzzer would be encountered in the 500 seeds run as part of the CI job that we already run on PRs affecting the parser and pushes to <code>main</code>. If someone&#x27;s working on a big parser change that they want to test to destruction, they can run the script with a larger set of random seeds locally. I&#x27;m putting this PR up in case it&#x27;s helpful, but I&#x27;ll fully defer to the parser experts on the team as to whether it&#x27;s something we want to go ahead with or not; I&#x27;m pretty undecided.</p>
Test Plan
<p>The new job should run as part of this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-04-29 13:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/dhruvmanila">@dhruvmanila</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-04-29 13:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-04-29 13:54</div>
            <div class="timeline-body"><p>I don&#x27;t mind some random fuzzing once a day. It allows us to cover a larger test set and may even reveal errors in the existing implementation</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-04-29 13:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>.github/workflows/daily_fuzz.yaml</code>:52 on 2024-04-29 13:56</div>
            <div class="timeline-body"><p>Is this clamping the random numbers to a range between 1000000 is there a reason why not to go higher (or move the random number generation into the fuzzer script?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-04-29 14:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>.github/workflows/daily_fuzz.yaml</code>:52 on 2024-04-29 14:05</div>
            <div class="timeline-body"><blockquote>
<p>Is this clamping the random numbers to a range between 1000000</p>
</blockquote>
<p>yes</p>
<blockquote>
<p>is there a reason why not to go higher</p>
</blockquote>
<p>It looks like we can go as high as 9999999999999999999! Add any more digits to that number and the <code>shuf</code> shell utility fails (at least for me locally):</p>
<pre><code>(ruff) % echo $(shuf -i0-99999999999999999991 -n 100)                                                                                                                     ~/dev/ruff
shuf: invalid input range: ‘0-99999999999999999991’: Value too large to be stored in data type
</code></pre>
<p>I&#x27;ll bump the number to the maximum.</p>
<blockquote>
<p>move the random number generation into the fuzzer script?</p>
</blockquote>
<p>The argparsing gets significantly more complex if we move the random generation into the fuzzer script (currently <code>seeds</code> is a required command-line argument), so I&#x27;d <em>prefer</em> to simply pass a randomly selected set of seeds from the command line.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ci</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-04-29 14:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2024-04-29 16:48</div>
            <div class="timeline-body"><p>Thank you. I think this could be useful.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-04-29 16:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-04-29 16:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-04-29 16:54</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:03:48 UTC
    </footer>
</body>
</html>
