<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Format ExprTuple - astral-sh/ruff #4963</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Format ExprTuple</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4963">#4963</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2023-06-08 15:21
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><p>This implements formatting ExprTuple, including magic trailing comma. I intentionally didn't change the settings mechanism but just added a dummy global const flag.</p>
<p>Besides the snapshots, I added custom breaking/joining tests and a deeply nested test case. The diffs look better than previously, proper black compatibility depends on parentheses handling.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-06-08 15:21</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #4963</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4963" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4963?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-06-08 15:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/expr_tuple.rs</code>:146 on 2023-06-08 15:23</div>
            <div class="timeline-body"><p>not sure if this would be useful anywhere else</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_tuple.rs</code>:31 on 2023-06-08 15:41</div>
            <div class="timeline-body"><p>Can you add a test for an empty tuple that contains a comment:</p>
<pre><code class="language-python">(
	# empty
)
</code></pre>
<p>You'll need to handle that case manually by:</p>
<ul>
<li>overriding <code>fmt_dangling_comments</code> on <code>FormatNodeRule</code></li>
<li>Use <code>block_indent(&amp;dangling_node_comments(item.into())</code> here to format the dangling comments proper</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_tuple.rs</code>:39 on 2023-06-08 15:42</div>
            <div class="timeline-body"><p>Do we need the inner group?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/expression/tuple_expression.py</code>:10 on 2023-06-08 15:42</div>
            <div class="timeline-body"><p>Can you add some cases where the elements have comments (leading, trailing)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_tuple.rs</code>:49 on 2023-06-08 15:42</div>
            <div class="timeline-body"><p>Shouldn't this not already always be true? Because the Expr formatting sets the level to <code>NodeLevel::Expression</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_tuple.rs</code>:69 on 2023-06-08 15:44</div>
            <div class="timeline-body"><p>The group here is useless because you'll always force it to <code>expand</code> by writing the <code>block_indent</code> and the <code>hard_line_break</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_tuple.rs</code>:77 on 2023-06-08 15:44</div>
            <div class="timeline-body"><p>We don't need to solve this here but we probably need to preserve the right amount of parentheses.</p>
<p>Isn't the <code>Expr</code> parentheses handling already covering this case?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-06-08 15:44</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      6.7Â±0.30ms     6.1 MB/sec    1.04      6.9Â±0.31ms     5.9 MB/sec
formatter/numpy/ctypeslib.py               1.00  1440.3Â±81.39Âµs    11.6 MB/sec    1.01  1451.6Â±84.92Âµs    11.5 MB/sec
formatter/numpy/globals.py                 1.06   145.2Â±11.10Âµs    20.3 MB/sec    1.00    137.5Â±7.88Âµs    21.5 MB/sec
formatter/pydantic/types.py                1.01      2.8Â±0.20ms     9.0 MB/sec    1.00      2.8Â±0.19ms     9.1 MB/sec
linter/all-rules/large/dataset.py          1.02     15.4Â±0.59ms     2.6 MB/sec    1.00     15.1Â±0.56ms     2.7 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.6Â±0.15ms     4.6 MB/sec    1.00      3.6Â±0.16ms     4.6 MB/sec
linter/all-rules/numpy/globals.py          1.11   489.9Â±39.21Âµs     6.0 MB/sec    1.00   442.0Â±19.43Âµs     6.7 MB/sec
linter/all-rules/pydantic/types.py         1.05      6.6Â±0.28ms     3.9 MB/sec    1.00      6.3Â±0.37ms     4.0 MB/sec
linter/default-rules/large/dataset.py      1.08      7.9Â±0.30ms     5.2 MB/sec    1.00      7.3Â±0.30ms     5.6 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.13  1691.7Â±95.99Âµs     9.8 MB/sec    1.00  1503.3Â±68.99Âµs    11.1 MB/sec
linter/default-rules/numpy/globals.py      1.06   189.2Â±11.69Âµs    15.6 MB/sec    1.00   177.8Â±10.22Âµs    16.6 MB/sec
linter/default-rules/pydantic/types.py     1.11      3.5Â±0.15ms     7.2 MB/sec    1.00      3.2Â±0.13ms     8.0 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                    pr
-----                                      ----                                    --
formatter/large/dataset.py                 1.02      9.8Â±0.62ms     4.2 MB/sec     1.00      9.6Â±0.51ms     4.2 MB/sec
formatter/numpy/ctypeslib.py               1.00  1956.9Â±114.95Âµs     8.5 MB/sec    1.01  1971.6Â±180.69Âµs     8.4 MB/sec
formatter/numpy/globals.py                 1.00   194.8Â±15.50Âµs    15.1 MB/sec     1.03   201.3Â±16.65Âµs    14.7 MB/sec
formatter/pydantic/types.py                1.03      4.1Â±0.21ms     6.3 MB/sec     1.00      3.9Â±0.21ms     6.5 MB/sec
linter/all-rules/large/dataset.py          1.00     20.5Â±0.73ms  2036.9 KB/sec     1.00     20.5Â±0.88ms  2028.7 KB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      5.2Â±0.23ms     3.2 MB/sec     1.00      5.1Â±0.28ms     3.2 MB/sec
linter/all-rules/numpy/globals.py          1.00   612.9Â±39.56Âµs     4.8 MB/sec     1.03   628.4Â±44.22Âµs     4.7 MB/sec
linter/all-rules/pydantic/types.py         1.00      8.6Â±0.46ms     3.0 MB/sec     1.01      8.7Â±0.46ms     2.9 MB/sec
linter/default-rules/large/dataset.py      1.05     10.6Â±0.49ms     3.8 MB/sec     1.00     10.0Â±0.45ms     4.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00      2.1Â±0.10ms     7.9 MB/sec     1.03      2.2Â±0.12ms     7.6 MB/sec
linter/default-rules/numpy/globals.py      1.02   253.9Â±19.17Âµs    11.6 MB/sec     1.00   249.2Â±15.07Âµs    11.8 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.6Â±0.28ms     5.5 MB/sec     1.00      4.6Â±0.38ms     5.5 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_tuple.rs</code>:124 on 2023-06-08 15:46</div>
            <div class="timeline-body"><p>Nit: You can simplify this by always writing the trailing comma after having written all elements.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_tuple.rs</code>:127 on 2023-06-08 15:47</div>
            <div class="timeline-body"><p>You can simplify this by using <code>joiner</code>:</p>
<pre><code class="language-suggestion">		let separator = format_with(|f| write!(f[text(&quot;,&quot;), soft_line_break_or_space()]));
		f.join_with(separator).entries(self.elts.iter().formatted()).finish()?;
		
		// Write the trailing comma 
		write!(f, [if_group_breaks(&amp;text(&quot;,&quot;))])?;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_tuple.rs</code>:146 on 2023-06-08 15:48</div>
            <div class="timeline-body"><p>It's good to know that it exists. We can pull it out if it is used elsewhere.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_tuple.rs</code>:135 on 2023-06-08 15:51</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    tuple_range: TextRange,
</code></pre>
<p>I had to look it up on the call side to know what range this is.It could even make sense to pass the whole tuple</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_tuple.rs</code>:140 on 2023-06-08 15:53</div>
            <div class="timeline-body"><p>I believe this panics if the first character is a non-ascii character.</p>
<p>It's probably safe to use `&amp;f.context().contents(usize::from(range.start())..].chars().next()</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2023-06-08 15:54</div>
            <div class="timeline-body"><p>Looks good. Putting it back into your queue to add some tests around comment handling.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-06-09 09:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/expr_tuple.rs</code>:49 on 2023-06-09 09:24</div>
            <div class="timeline-body"><p>yep, forgot to update that code</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/expr_tuple.rs</code>:77 on 2023-06-09 09:28</div>
            <div class="timeline-body"><p>yep, also didn't realize that this is now handled</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-06-09 09:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/expr_tuple.rs</code>:77 on 2023-06-09 10:40</div>
            <div class="timeline-body"><p>on second test, surprisingly not:</p>
<pre><code>((1))
# item.range() = 2..3
</code></pre>
<pre><code>((1,))
# item.range() = 1..5
# item.range() = 2..3
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-06-09 10:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_tuple.rs</code>:77 on 2023-06-09 10:50</div>
            <div class="timeline-body"><p>Ah that makes sense. The expr handling doesn't preserve tuple parentheses. Can we end up with too many parentheses if the expr and tuple ends up adding them (maybe return Never in needs_parentheses when they are optional)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-09 10:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-06-09 10:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/expr_tuple.rs</code>:31 on 2023-06-09 10:54</div>
            <div class="timeline-body"><p>didn't realize earlier, but it's neat that block_ident is a noop when empty</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_tuple.rs</code>:40 on 2023-06-09 11:00</div>
            <div class="timeline-body"><p>It's not necessary to use a <code>group</code> here because the <code>block_indent</code> emits a <code>hard_line_break</code> that always forces the <code>group</code> to expand</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_tuple.rs</code>:60 on 2023-06-09 11:01</div>
            <div class="timeline-body"><p>Nit</p>
<pre><code class="language-suggestion">            &amp;&amp; matches!(first_non_trivia_token(last.range().end(), f.context().contents()), Some(Token { kind: TokenKind::Comma }))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_tuple.rs</code>:72 on 2023-06-09 11:02</div>
            <div class="timeline-body"><p>The <code>hard_line_breaks</code> are not necessary. The <code>block_indent</code> adds the line breaks for you (unlike <code>indent</code> that never renders line breaks and relies on you to add the appropriate line breaks)</p>
<pre><code class="language-suggestion">                    block_indent(&amp;ExprSequence::new(elts)),
</code></pre>
<p>You can't see the extra <code>hard_line_breaks</code> in the output because the <code>Printer</code> optimizes them away.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_tuple.rs</code>:127 on 2023-06-09 11:04</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        write!(f, [if_group_breaks(&amp;text(&quot;,&quot;))])
</code></pre>
<p>Adding a trailing line break should be handled by the code wrapping the sequence. I assume that's already the case because you always use <code>block_indent</code> and <code>soft_block_indent</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-06-09 11:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @konstin on 2023-06-12 12:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2023-06-12 12:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-06-12 12:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davidszotten">@davidszotten</a> reviewed on 2023-06-17 13:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/davidszotten">@davidszotten</a> on <code>crates/ruff_python_formatter/src/expression/expr_tuple.rs</code>:77 on 2023-06-17 13:40</div>
            <div class="timeline-body"><p>ðŸ‘‹ looking here after trying to implement <code>StmtFor</code>. for <code>for</code> loops, it seems black removes existing parens around the target <code>for (x, y) in z</code> -&gt; <code>for x, y in z</code></p>
<p>see e.g. https://github.com/astral-sh/ruff/blob/be107dad64510e3e34fdd322ba333da06b61be6c/crates/ruff_python_formatter/resources/test/fixtures/black/simple_cases/remove_for_brackets.py#L1</p>
<p>i'm still trying to learn by way around this codebase but i guess this needs to check the parenthesize options or something?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:57:58 UTC
    </footer>
</body>
</html>
