<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`refurb`] Parenthesize lambda and ternary expressions in iter (`FURB122`, `FURB142`) - astral-sh/ruff #18592</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>refurb</code>] Parenthesize lambda and ternary expressions in iter (<code>FURB122</code>, <code>FURB142</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18592">#18592</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-06-09 13:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes #18590 by adding parentheses around lambdas and if expressions in <code>for</code> loop iterators for FURB122 and FURB142. I also updated the docs on the helper function to reflect the part actually being parenthesized and the new checks.</p>
<p>The <code>lambda</code> case actually causes a <code>TypeError</code> at runtime, but I think it's still worth handling to avoid causing a syntax error.</p>
<pre><code class="language-pycon">&gt;&gt;&gt; s = set()
... for x in (1,) if True else (2,):
...     s.add(-x)
... for x in lambda: 0:
...     s.discard(-x)
...
Traceback (most recent call last):
  File &quot;&lt;python-input-0&gt;&quot;, line 4, in &lt;module&gt;
    for x in lambda: 0:
             ^^^^^^^^^
TypeError: 'function' object is not iterable
</code></pre>
<h2>Test Plan</h2>
<p>New test cases based on the bug report</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ntBre on 2025-06-09 13:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @ntBre on 2025-06-09 13:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @ntBre on 2025-06-09 13:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-09 13:58</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-06-09 14:13</div>
            <div class="timeline-body"><p>I think we only want to parenthesize if the fix would write out a comprehension and if it's not already parenthesized, right? So maybe we need to do something like this:</p>
<pre><code class="language-diff">diff --git c/crates/ruff_linter/src/rules/refurb/rules/for_loop_set_mutations.rs w/crates/ruff_linter/src/rules/refurb/rules/for_loop_set_mutations.rs
index 08ccf08d7..84dd5e9a7 100644
--- c/crates/ruff_linter/src/rules/refurb/rules/for_loop_set_mutations.rs
+++ w/crates/ruff_linter/src/rules/refurb/rules/for_loop_set_mutations.rs
@@ -5,7 +5,7 @@ use ruff_python_semantic::analyze::typing;
 use crate::checkers::ast::Checker;
 use crate::{AlwaysFixableViolation, Applicability, Edit, Fix};
 
-use super::helpers::parenthesize_loop_iter_if_necessary;
+use super::helpers::{IterLocation, parenthesize_loop_iter_if_necessary};
 
 /// ## What it does
 /// Checks for code that updates a set with the contents of an iterable by
@@ -106,7 +106,7 @@ pub(crate) fn for_loop_set_mutations(checker: &amp;Checker, for_stmt: &amp;StmtFor) {
             format!(
                 &quot;{}.{batch_method_name}({})&quot;,
                 set.id,
-                parenthesize_loop_iter_if_necessary(for_stmt, checker),
+                parenthesize_loop_iter_if_necessary(for_stmt, checker, IterLocation::CallArgument),
             )
         }
         (for_target, arg) =&gt; format!(
@@ -114,7 +114,7 @@ pub(crate) fn for_loop_set_mutations(checker: &amp;Checker, for_stmt: &amp;StmtFor) {
             set.id,
             locator.slice(arg),
             locator.slice(for_target),
-            parenthesize_loop_iter_if_necessary(for_stmt, checker),
+            parenthesize_loop_iter_if_necessary(for_stmt, checker, IterLocation::InComprehension),
         ),
     };
 
diff --git c/crates/ruff_linter/src/rules/refurb/rules/for_loop_writes.rs w/crates/ruff_linter/src/rules/refurb/rules/for_loop_writes.rs
index 11ec83337..85180bd33 100644
--- c/crates/ruff_linter/src/rules/refurb/rules/for_loop_writes.rs
+++ w/crates/ruff_linter/src/rules/refurb/rules/for_loop_writes.rs
@@ -5,6 +5,7 @@ use ruff_python_semantic::{Binding, ScopeId, SemanticModel, TypingOnlyBindingsSt
 use ruff_text_size::{Ranged, TextRange, TextSize};
 
 use crate::checkers::ast::Checker;
+use crate::rules::refurb::rules::helpers::IterLocation;
 use crate::{AlwaysFixableViolation, Applicability, Edit, Fix};
 
 use super::helpers::parenthesize_loop_iter_if_necessary;
@@ -182,7 +183,7 @@ fn for_loop_writes(
             format!(
                 &quot;{}.writelines({})&quot;,
                 locator.slice(io_object_name),
-                parenthesize_loop_iter_if_necessary(for_stmt, checker),
+                parenthesize_loop_iter_if_necessary(for_stmt, checker, IterLocation::CallArgument),
             )
         }
         (for_target, write_arg) =&gt; {
@@ -191,7 +192,11 @@ fn for_loop_writes(
                 locator.slice(io_object_name),
                 locator.slice(write_arg),
                 locator.slice(for_target),
-                parenthesize_loop_iter_if_necessary(for_stmt, checker),
+                parenthesize_loop_iter_if_necessary(
+                    for_stmt,
+                    checker,
+                    IterLocation::InComprehension
+                ),
             )
         }
     };
diff --git c/crates/ruff_linter/src/rules/refurb/rules/helpers.rs w/crates/ruff_linter/src/rules/refurb/rules/helpers.rs
index 8f431ffcc..fa6b4a4d2 100644
--- c/crates/ruff_linter/src/rules/refurb/rules/helpers.rs
+++ w/crates/ruff_linter/src/rules/refurb/rules/helpers.rs
@@ -21,6 +21,7 @@ use crate::checkers::ast::Checker;
 pub(super) fn parenthesize_loop_iter_if_necessary&lt;'a&gt;(
     for_stmt: &amp;'a ast::StmtFor,
     checker: &amp;'a Checker,
+    iter_location: IterLocation,
 ) -&gt; Cow&lt;'a, str&gt; {
     let locator = checker.locator();
     let iter = for_stmt.iter.as_ref();
@@ -42,7 +43,25 @@ pub(super) fn parenthesize_loop_iter_if_necessary&lt;'a&gt;(
         ast::Expr::Tuple(tuple) if !tuple.parenthesized =&gt; {
             Cow::Owned(format!(&quot;({iter_in_source})&quot;))
         }
-        ast::Expr::Lambda(_) | ast::Expr::If(_) =&gt; Cow::Owned(format!(&quot;({iter_in_source})&quot;)),
+        ast::Expr::If(_) | ast::Expr::Lambda(_)
+            if matches!(iter_location, IterLocation::InComprehension) =&gt;
+        {
+            if let Some(_) = parenthesized_range(
+                iter.into(),
+                for_stmt.into(),
+                checker.comment_ranges(),
+                checker.source(),
+            ) {
+                Cow::Borrowed(iter_in_source)
+            } else {
+                Cow::Owned(format!(&quot;({iter_in_source})&quot;))
+            }
+        }
         _ =&gt; Cow::Borrowed(iter_in_source),
     }
 }
+
+pub(crate) enum IterLocation {
+    CallArgument,
+    InComprehension,
+}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-06-09 14:23</div>
            <div class="timeline-body"><p>Incidentally, and unrelated to your PR - in addition to the doc-comment being a little off, we also have two separate helpers modules for refurb rules:</p>
<ul>
<li>https://github.com/astral-sh/ruff/blob/ae2150bfa35fe2e4c306f32e1609e76e9ca5520f/crates/ruff_linter/src/rules/refurb/helpers.rs</li>
<li>https://github.com/astral-sh/ruff/blob/ae2150bfa35fe2e4c306f32e1609e76e9ca5520f/crates/ruff_linter/src/rules/refurb/rules/helpers.rs</li>
</ul>
<p>maybe they should be merged?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-09 14:27</div>
            <div class="timeline-body"><p>I think we will have already bailed out if the range is already parenthesized:</p>
<p>https://github.com/astral-sh/ruff/blob/931577219f894630ef7ce963b7cab3b0ff7a5a65/crates/ruff_linter/src/rules/refurb/rules/helpers.rs#L28-L37</p>
<p>but you're probably right about the callable part. I'll work on a test case for that.</p>
<p>I did also notice the two <code>helpers</code> modules. Which way would you merge them? Looks like we have a pretty even mix of <code>rules/LINTER/helpers.rs</code> and <code>rules/LINTER/rules/helpers.rs</code> :smile: I'd probably lean toward <code>LINTER/helpers.rs</code></p>
<pre><code class="language-shell">&gt; fd helpers.rs
crates/ruff_linter/src/cst/helpers.rs
crates/ruff_linter/src/rules/airflow/helpers.rs
crates/ruff_linter/src/rules/flake8_2020/helpers.rs
crates/ruff_linter/src/rules/flake8_annotations/helpers.rs
crates/ruff_linter/src/rules/flake8_async/helpers.rs
crates/ruff_linter/src/rules/flake8_bandit/helpers.rs
crates/ruff_linter/src/rules/flake8_boolean_trap/helpers.rs
crates/ruff_linter/src/rules/flake8_bugbear/helpers.rs
crates/ruff_linter/src/rules/flake8_builtins/helpers.rs
crates/ruff_linter/src/rules/flake8_comprehensions/rules/helpers.rs
crates/ruff_linter/src/rules/flake8_datetimez/rules/helpers.rs
crates/ruff_linter/src/rules/flake8_django/rules/helpers.rs
crates/ruff_linter/src/rules/flake8_executable/helpers.rs
crates/ruff_linter/src/rules/flake8_logging/rules/helpers.rs
crates/ruff_linter/src/rules/flake8_pytest_style/rules/helpers.rs
crates/ruff_linter/src/rules/flake8_quotes/helpers.rs
crates/ruff_linter/src/rules/flake8_return/helpers.rs
crates/ruff_linter/src/rules/flake8_slots/rules/helpers.rs
crates/ruff_linter/src/rules/flake8_type_checking/helpers.rs
crates/ruff_linter/src/rules/flynt/helpers.rs
crates/ruff_linter/src/rules/isort/helpers.rs
crates/ruff_linter/src/rules/numpy/helpers.rs
crates/ruff_linter/src/rules/pandas_vet/helpers.rs
crates/ruff_linter/src/rules/pep8_naming/helpers.rs
crates/ruff_linter/src/rules/perflint/helpers.rs
crates/ruff_linter/src/rules/pycodestyle/helpers.rs
crates/ruff_linter/src/rules/pydocstyle/helpers.rs
crates/ruff_linter/src/rules/pylint/helpers.rs
crates/ruff_linter/src/rules/pyupgrade/helpers.rs
crates/ruff_linter/src/rules/refurb/helpers.rs
crates/ruff_linter/src/rules/refurb/rules/helpers.rs
crates/ruff_linter/src/rules/ruff/rules/helpers.rs
crates/ruff_linter/src/rules/tryceratops/helpers.rs
crates/ruff_linter/src/text_helpers.rs
crates/ruff_python_ast/src/helpers.rs
crates/ruff_python_parser/src/parser/helpers.rs
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-06-09 17:41</div>
            <div class="timeline-body"><blockquote>
<p>I did also notice the two helpers modules. Which way would you merge them? Looks like we have a pretty even mix of rules/LINTER/helpers.rs and rules/LINTER/rules/helpers.rs ðŸ˜„ I'd probably lean toward LINTER/helpers.rs</p>
</blockquote>
<p>yikes! yeah I agree - but maybe should be a separate PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> approved on 2025-06-09 17:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-06-09 20:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-06-09 20:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-09 20:07</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:13:18 UTC
    </footer>
</body>
</html>
