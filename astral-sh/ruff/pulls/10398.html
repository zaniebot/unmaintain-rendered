<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`ruff server` default to current working directory in environments without any root directories or workspaces - astral-sh/ruff #10398</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>ruff server</code> default to current working directory in environments without any root directories or workspaces</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10398">#10398</a>
        opened by <a href="https://github.com/snowsignal">@snowsignal</a>
        on 2024-03-14 00:15
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-03-14 00:15</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes #10324</p>
<p>This removes an overeager failure case where we would exit early if no root directory or workspace folders were provided on server initialization. We now fall-back to the current working directory as a workspace for that file.</p>
<h2>Test Plan</h2>
<p>N/A</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @snowsignal on 2024-03-14 00:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @snowsignal on 2024-03-14 00:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-03-14 00:28</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-14 04:16</div>
            <div class="timeline-body"><p>Testing this out...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/server.rs</code>:48 on 2024-03-14 04:19</div>
            <div class="timeline-body"><p>If I understand this correctly, then the workspaces will be empty, right? Should we instead default to using the current working directory? In <code>ruff-lsp</code>, we default to using the current working directory as the workspace with the default settings. You might be more aware of how that will affect other parts of the code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-14 04:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-14 04:28</div>
            <div class="timeline-body"><p>It's not giving me any diagnostics. The LSP logs have this error:</p>
<pre><code>[ERROR][2024-03-14 09:56:07] .../vim/lsp/rpc.lua:789	&quot;rpc&quot;	&quot;/Users/dhruv/work/astral/ruff-test/target/release/ruff&quot;	&quot;stderr&quot;	&quot;┐ruff_server::server::api::notifications::did_open::run{file=file:///Users/dhruv/playground/python/animation.py}\n┘\n&quot;
</code></pre>
<p>I suspect this is because there's no workspace associated with that document, so the <code>did_open</code> notification is failing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-14 04:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/server.rs</code>:48 on 2024-03-14 04:28</div>
            <div class="timeline-body"><p>I think we should use the current working directory as the default workspace if not provided.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-03-15 21:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server.rs</code>:48 on 2024-03-15 21:33</div>
            <div class="timeline-body"><p>You're right, we should try to use the current working directory. Let me know if that works!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-03-15 21:35</div>
            <div class="timeline-body"><p>@dhruvmanila Right, it's failing to open because the file isn't associated with any workspace. The assumption that the server has made up until now is that any file being opened by the editor would have an associated workspace folder the client would have previously told us about, but this is clearly not the case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-03-15 21:37</div>
            <div class="timeline-body"><p>Actually, maybe what we need to do is just always create a new workspace in the session as a fallback mechanism if an file being opened isn't in a workspace path already.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2024-03-16 02:30</div>
            <div class="timeline-body"><p>Thank you! I tested out using diagnostics, code actions, formatting and range formatting. It works well. LGTM!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "`ruff server` now works in environments without any root directories or workspaces" to "`ruff server` default to current working directory in environments without any root directories or workspaces" by @MichaReiser on 2024-03-18 08:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @snowsignal on 2024-03-18 15:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @snowsignal on 2024-03-18 15:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-03-18 15:46</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 22:47:58 UTC
    </footer>
</body>
</html>
