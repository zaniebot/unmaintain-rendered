<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pylint`] Preserve original value format (`PLR6104`) - astral-sh/ruff #14978</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pylint</code>] Preserve original value format (<code>PLR6104</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14978">#14978</a>
        opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a>
        on 2024-12-15 01:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a></div>
            <div class="timeline-body">Summary
<p>Resolves #11672.</p>
Test Plan
<p><code>cargo nextest run</code> and <code>cargo insta test</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-12-15 01:13</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-12-15 01:15</div>
            <div class="timeline-body"><p>The existing implementation is surprisingly complex. On top of that, it uses the generator to create the fix, but that&#x27;s not strictly necessary. String slicing is much simpler and only requires an extra hardcoded <code>if</code> for the <code>Expr::Named</code> case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-12-15 15:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pylint/rules/non_augmented_assignment.rs</code>:170 on 2024-12-15 15:58</div>
            <div class="timeline-body"><p>I&#x27;d prefer if we could keep the enum and the associated methods (and avoid creating a <code>String</code>). Removing the <code>enum</code> also results in many unnecessary changes that makes reviewing the PR harder.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2024-12-15 15:59</div>
            <div class="timeline-body"><p>Thanks. Could you revert your changes to <code>AugmentedOperator</code> (and, if there are any, other refactors that aren&#x27;t strictly necessary for the fix). I&#x27;d prefer to keep the changes minimal to the fix or have separate PRs for refactor and fix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2024-12-15 16:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/src/rules/pylint/rules/non_augmented_assignment.rs</code>:170 on 2024-12-15 16:43</div>
            <div class="timeline-body"><p>I reworked the fix from scratch to minimize the changes. I remain unsatisfied with how it is implemented, however. Should I follow this up with a refactoring PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-12-15 17:15</div>
            <div class="timeline-body"><p>I&#x27;d like to believe it isn&#x27;t my fault that the <code>mdformat</code> check failed. A simple <code>uvx pre-commit run --all-files</code> commit should fix it, but I won&#x27;t submit a PR as I&#x27;m not interested in finding the cause.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-12-15 19:06</div>
            <div class="timeline-body"><blockquote>
<p>I&#x27;d like to believe it isn&#x27;t my fault that the <code>mdformat</code> check failed. A simple <code>uvx pre-commit run --all-files</code> commit should fix it, but I won&#x27;t submit a PR as I&#x27;m not interested in finding the cause.</p>
</blockquote>
<p>I believe it&#x27;s due to one of the mdformat plugins we use having released a new version. We don&#x27;t have these pinned in our pre-commit config file; we probably should.</p>
<p>Two of the plugins we use cut new releases a couple of hours ago, one of them a major version bump:</p>
<ul>
<li>https://github.com/KyleKing/mdformat-mkdocs/commit/ce6710808d35248d1419f5db89cb6e7a3fc6fd3d</li>
<li>https://github.com/KyleKing/mdformat-admon/commit/f6f2c231072bf5f55ce6b4237f4ee908ba44eed2</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-12-15 19:33</div>
            <div class="timeline-body"><p>I filed <a href="https://github.com/astral-sh/ruff/pull/14992">astral-sh/ruff#14992</a> to fix the pre-commit issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-15 19:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/pylint/rules/non_augmented_assignment.rs</code>:164 on 2024-12-15 19:45</div>
            <div class="timeline-body"><p>the <code>should_be_parenthesized_when_standalone()</code> function is so short, I feel like the code is easier to understand if the condition is just inlined:</p>
<pre><code>    // expressions using the walrus operator (`:=`) must be parenthesized
    // when they&#x27;re used as standalone expressions:
    let new_value_expr = if right_operand.is_named_expr() {
        format!(&quot;({right_operand_expr})&quot;)
    } else {
        right_operand_expr.to_string()
    };
    let new_content = format!(&quot;{target_expr} {operator} {new_value_expr}&quot;);

    Edit::range_replacement(new_content, range)
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-15 19:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/pylint/rules/non_augmented_assignment.rs</code>:164 on 2024-12-15 19:49</div>
            <div class="timeline-body"><p>This could also be done with just one allocation rather than two, but fixes aren&#x27;t generally that performance-sensitive and it would make the code less readable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-12-16 09:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/resources/test/fixtures/pylint/non_augmented_assignment.py</code>:75 on 2024-12-16 09:09</div>
            <div class="timeline-body"><p>Would you mind adding an example where the expression starts on a new line</p>
<pre><code>test4 = test4 + ( 
		4 
		* 
		10
)
</code></pre>
<p>I worry that the new logic generates an incorrect fix because the expression range doesn&#x27;t include the parentheses.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2024-12-16 12:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/resources/test/fixtures/pylint/non_augmented_assignment.py</code>:75 on 2024-12-16 12:23</div>
            <div class="timeline-body"><p>Added and fixed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-12-17 08:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pylint/rules/non_augmented_assignment.rs</code>:200 on 2024-12-17 08:33</div>
            <div class="timeline-body"><p>Can we use <code>parenthesized_range</code> instead of implementing our own, adhoc lexing here. I think it&#x27;s okay if the fix preserves parentheses, even if they&#x27;re unnecessary (they were unnecessary before)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-12-17 08:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pylint/rules/non_augmented_assignment.rs</code>:142 on 2024-12-17 08:34</div>
            <div class="timeline-body"><p>This seems complicated and I&#x27;m not sure I follow why it&#x27;s necessary.</p>
<p>Could we change the logic to instead take the range from after the operator to the end of the statement instead of trying to trim the range?</p>
<p>If so, I suggest using <code>SimpleTokenizer</code> to find the operator over implementing your own <code>Cursor</code> logic</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2024-12-17 11:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/src/rules/pylint/rules/non_augmented_assignment.rs</code>:142 on 2024-12-17 11:16</div>
            <div class="timeline-body"><p>Taking the range from after the operator is precisely what I&#x27;m doing (well, whitespace trimming too, but still).</p>
<p>I tried converting this to use <code>SimpleTokenizer</code> instead, but it isn&#x27;t a <code>DoubleEndedIterator</code>. <code>trim_left_operator</code> can easily be reimplemented as:</p>
<pre><code>let range = TextRange::new(0.into(), half_expr.text_len());

let mut tokenizer = SimpleTokenizer::new(half_expr, range);
let mut op_seen = false;

while let Some(token) = tokenizer.next() {
    match token.kind {
        SimpleTokenKind::Whitespace
        | SimpleTokenKind::Continuation
        | SimpleTokenKind::Newline =&gt; {}
        _ if op_seen =&gt; {
            return &amp;half_expr[token.start().into()..];
        }
        SimpleTokenKind::Plus
        | SimpleTokenKind::Ampersand
        | SimpleTokenKind::Vbar
        | SimpleTokenKind::Circumflex
        | SimpleTokenKind::DoubleSlash
        | SimpleTokenKind::Slash
        | SimpleTokenKind::LeftShift
        | SimpleTokenKind::Less
        | SimpleTokenKind::At
        | SimpleTokenKind::Percent
        | SimpleTokenKind::DoubleStar
        | SimpleTokenKind::Star
        | SimpleTokenKind::RightShift
        | SimpleTokenKind::Greater
        | SimpleTokenKind::Minus =&gt; {
            op_seen = true;
        }
        _ =&gt; {}
    }
}

unreachable!(&quot;half_expr does not contain an operator&quot;);
</code></pre>
<p>The same, however, could not be said for <code>trim_right_operator</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-12-17 11:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pylint/rules/non_augmented_assignment.rs</code>:142 on 2024-12-17 11:34</div>
            <div class="timeline-body"><p>Yeah, we have a <code>BackwardsTokenizer</code> but it&#x27;s not entirely clear why we even need to trim the right side. Can&#x27;t we just use the statement&#x27;s end?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/src/rules/pylint/rules/non_augmented_assignment.rs</code>:142 on 2024-12-17 11:39</div>
            <div class="timeline-body"><p>&quot;Trim&quot; is probably not the best word. Here&#x27;s how the <code>trim</code> functions work:</p>
<pre><code>x = x + (1 * 2)
     ^^^^^^^^^^ half_expr
x = x + (1 * 2)
        ^^^^^^^ trim_left_operator(half_expr)
</code></pre>
<pre><code>x = 1000000 + x
    ^^^^^^^^^^ half_expr
x = 1000000 + x
    ^^^^^^^ trim_right_operator(half_expr)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2024-12-17 11:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-12-17 11:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pylint/rules/non_augmented_assignment.rs</code>:142 on 2024-12-17 11:44</div>
            <div class="timeline-body"><p>Oh I see. The name&#x27;s are a bit misleading (or you mixed up the examples) considering that <code>trim_right_operator</code> trims the left operand?</p>
<p>Either way, I think we can once use the range from after <code>=</code> up to right before the operator and everything after the operator to the statement&#x27;s end</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2024-12-17 11:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/src/rules/pylint/rules/non_augmented_assignment.rs</code>:142 on 2024-12-17 11:59</div>
            <div class="timeline-body"><p><code>trim_left</code> trims the operator on the left of the expression whereas <code>trim_right</code> trims the operator on the right. These names are indeed confusing. I should have used <code>trim_start_operator</code> and <code>trim_end_operator</code>.</p>
<p>Anyway, I removed both of them. What I really needed but didn&#x27;t know of was <code>parenthesized_range</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-12-17 12:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-12-17 13:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pylint/rules/non_augmented_assignment.rs</code>:147 on 2024-12-17 13:55</div>
            <div class="timeline-body"><p>I think the parent here is incorrect. It should be the parent of <code>right_operand_ref</code> and that&#x27;s the binary expression</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-12-17 15:07</div>
            <div class="timeline-body"><p>Thanks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-17 15:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-17 15:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-12-17 16:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-12-19 12:58</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:09:28 UTC
    </footer>
</body>
</html>
