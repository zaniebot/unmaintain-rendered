<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consider the content of the new cells during notebook sync - astral-sh/ruff #12203</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Consider the content of the new cells during notebook sync</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/12203">#12203</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-07-05 10:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR fixes the bug where the server was not considering the <code>cells.structure.didOpen</code> field to sync up the new content of the newly added cells.</p>
<p>The parameters corresponding to this request provides two fields to get the newly added cells:</p>
<ol>
<li><code>cells.structure.array.cells</code>: This is a list of <code>NotebookCell</code> which doesn't contain any cell content. The only useful information from this array is the cell kind and the cell document URI which we use to initialize the new cell in the index.</li>
<li><code>cells.structure.didOpen</code>: This is a list of <code>TextDocumentItem</code> which corresponds to the newly added cells. This actually contains the text content and the version.</li>
</ol>
<p>This wasn't a problem before because we initialize the cell with an empty string and this isn't a problem when someone just creates an empty cell. But, when someone copy-pastes a cell, the cell needs to be initialized with the content.</p>
<p>fixes: #12201</p>
<h2>Test Plan</h2>
<p>First, let's see the panic in action:</p>
<ol>
<li>Press <kbd>Esc</kbd> to allow using the keyboard to perform cell actions (move around, copy, paste, etc.)</li>
<li>Copy the second cell with <kbd>c</kbd> key</li>
<li>Delete the second cell with <kbd>dd</kbd> key</li>
<li>Paste the copied cell with <kbd>p</kbd> key</li>
</ol>
<p>You can see that the content isn't synced up because the <code>unused-import</code> for <code>sys</code> is still being highlighted but it's being used in the second cell. And, the hover isn't working either. Then, as I start editing the second cell, it panics.</p>
<p>https://github.com/astral-sh/ruff/assets/67177269/fc58364c-c8fc-4c11-a917-71b6dd90c1ef</p>
<p>Now, here's the preview of the fixed version:</p>
<p>https://github.com/astral-sh/ruff/assets/67177269/207872dd-dca6-49ee-8b6e-80435c7ef22e</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dhruvmanila on 2024-07-05 10:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-07-05 10:59</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dhruvmanila on 2024-07-05 11:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2024-07-05 11:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-07-05 11:35</div>
            <div class="timeline-body"><p>The inline comments are very helpful. Thanks for adding them.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Consider the cell content during notebook sync" to "Consider the content of the new cells during notebook sync" by @dhruvmanila on 2024-07-05 11:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2024-07-05 11:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-07-05 11:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-07-05 11:40</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:05:11 UTC
    </footer>
</body>
</html>
