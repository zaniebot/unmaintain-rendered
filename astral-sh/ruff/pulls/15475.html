<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Corrections and improvements to intersection simplification - astral-sh/ruff #15475</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Corrections and improvements to intersection simplification</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15475">#15475</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-01-14 14:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-01-14 14:03</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>I noticed that we were incorrectly oversimplifying certain intersections, for example:</p>
<pre><code class="language-py">from knot_extensions import Intersection, Not, AlwaysTruthy

def g(
    x: Intersection[str, Not[AlwaysTruthy]]
):
    if isinstance(x, bool):
        reveal_type(x)  # revealed: Literal[False]
</code></pre>
<p>Here, <code>bool &amp; ~AlwaysTruthy</code> can indeed be simplified to <code>Literal[False]</code>, and therefore <code>str &amp; ~AlwaysTruthy &amp; bool</code> can be simplified to <code>str &amp; Literal[False]</code>, which then simplifies further to <code>Never</code> since <code>str</code> and <code>Literal[False]</code> are disjoint. But that's not what we're doing in the example above: instead, we're attempting to simplify <code>str</code> out of the intersection as part of the initial simplification, which then means that we never realise further along in the intersection simplification algorithm that the entire intersection simplifies to <code>Never</code>.</p>
<p>This PR fixes the bug, and also adds some more simplifications for intersections that we weren't doing previously:</p>
<ul>
<li><code>bool &amp; AlwaysTruthy</code> -&gt; <code>Literal[True]</code></li>
<li><code>bool &amp; AlwaysFalsy</code> -&gt; <code>Literal[False]</code></li>
<li><code>LiteralString &amp; AlwaysTruthy</code> -&gt; <code>LiteralString &amp; ~Literal[&quot;&quot;]</code></li>
<li><code>LiteralString &amp; AlwaysFalsy</code> -&gt; <code>Literal[&quot;&quot;]</code></li>
</ul>
<p>This furthers our aim of having equivalent types use identical internal representations wherever it's feasible to do so.</p>
<h2>Test Plan</h2>
<ul>
<li><code>cargo test -p red_knot_python_semantic --test mdtest</code></li>
<li><code>uvx pre-commit run -a</code></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-01-14 14:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-01-14 14:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2025-01-14 14:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-01-14 14:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-14 14:10</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-14 14:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/intersection_types.md</code>:694 on 2025-01-14 14:10</div>
            <div class="timeline-body"><p>Whether this is a &quot;simplification&quot; of <code>LiteralString &amp; AlwaysTruthy</code> is of course questionable, since a positive intersection is in some sense &quot;simpler&quot; than a negated intersection. I don't really mind much which one we go with, but I do think it's useful to pick one of them as our &quot;standard representation&quot; of the type, since the two are equivalent.</p>
<p>Neither is <em>particularly</em> user-friendly in its display right now, but users will probably be more familiar with <code>Literal</code> types than they are with <code>AlwaysTruthy</code> or <code>AlwaysFalsy</code>, so I weakly prefer simplifying to <code>LiteralString &amp; ~Literal[&quot;&quot;]</code> rather than <code>LiteralString &amp; AlwaysTruthy</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-01-14 14:11</div>
            <div class="timeline-body"><p>2% speedup on the Codspeed incremental benchmark?? I'll take it! https://codspeed.io/astral-sh/ruff/branches/alex%2Ftruthy-bools</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-14 14:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/builder.rs</code>:415 on 2025-01-14 14:18</div>
            <div class="timeline-body"><p>I suspect the codspeed improvement is because we're now doing fewer Salsa lookups eagerly due to changes like this (<code>KnownClass::Bool.to_instance(db)</code> eagerly looked up the <code>bool</code> type in the Salsa <code>db</code>) whereas the new <code>contains_bool()</code> closure here is lazier</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/intersection_types.md</code>:660 on 2025-01-14 15:10</div>
            <div class="timeline-body"><p>Would it make sense to replace <code>str</code> in these examples with an arbitrary <code>class P: ...</code> to make it clear that this is not related to a property of <code>str</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-14 15:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-14 15:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/intersection_types.md</code>:654 on 2025-01-14 15:12</div>
            <div class="timeline-body"><p>You <em>could</em> write all of the new tests in this test suite using</p>
<pre><code class="language-py">static_assert(is_equivalent_to(Intersection[bool, AlwaysTruthy], Literal[True]))
</code></pre>
<p>because they're all fully-static types. I think it makes them easier to read. On the other hand, it would make them dependent on a correct implementation of <code>is_equivalent_to</code>, so feel free to leave them in the current form if you think it makes them more independent.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-14 15:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/intersection_types.md</code>:654 on 2025-01-14 15:19</div>
            <div class="timeline-body"><p>I think I weakly prefer the tests the way they are, because I don't just want to test that <code>bool &amp; AlwaysTruthy</code> is <em>equivalent</em> to <code>Literal[True]</code> (that could be done with a special case in <code>Type::is_equivalent_to</code>); I want to test that <code>bool &amp; AlwaysTruthy</code> is <em>eagerly simplified</em> to <code>Literal[True]</code>.</p>
<p>Do my tests actually test that? Well... no, they actually test that the intersection is simplified to a type that <code>Type::display</code> displays as <code>&quot;Literal[True]&quot;</code>. The type could always be special-cased in <code>Type::display</code>; all mdtests are to some extent integration tests rather than unit tests if we're being pedantic about it. But it still feels slightly <em>closer</em> to what I'd <em>like</em> to test here to keep them as they are.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/intersection_types.md</code>:660 on 2025-01-14 15:21</div>
            <div class="timeline-body"><p>good call</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-14 15:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-01-14 15:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/builder.rs</code>:363 on 2025-01-14 15:27</div>
            <div class="timeline-body"><p>I think it's now possible that <code>index</code> is incorrect because <code>FxHashSet</code> doesn't preserve insertion order. That means, it can now happen that the index order is <code>3, 1, 5</code></p>
<p>I'm also a bit confused why it's no longer necessary to iterate in reverse order?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-14 15:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/intersection_types.md</code>:694 on 2025-01-14 15:27</div>
            <div class="timeline-body"><blockquote>
<p>Whether this is a &quot;simplification&quot; of <code>LiteralString &amp; AlwaysTruthy</code> is of course questionable</p>
</blockquote>
<p>I think it is!</p>
<p>It's not just a question of displaying types to users, I think there's potentially also more we can do with <code>~Literal[&quot;&quot;]</code>, for example in narrowing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-14 15:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/builder.rs</code>:363 on 2025-01-14 15:33</div>
            <div class="timeline-body"><p>Oh, really good point. Yeah, this is incorrect. I think we have some missing test coverage here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-14 15:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/builder.rs</code>:363 on 2025-01-14 15:50</div>
            <div class="timeline-body"><p>should be fixed in https://github.com/astral-sh/ruff/pull/15475/commits/3bf1a6aa600d4090322c695248bb83b8e78d79d8 -- I switched to a <code>BTreeSet</code>, went back to iterating in reverse order, and added a test that would have caught this bug</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-01-14 16:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/builder.rs</code>:363 on 2025-01-14 16:20</div>
            <div class="timeline-body"><p>I wonder if it's worth using a <code>BTreeSet</code> or if we could keep using a <code>Vec</code> and filter out duplicate values when iterating (by simply storing the last removed index and skipping if it remains the same).</p>
<p>I don't know which one will perform better. That probably depends on how common duplicates are</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-14 16:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/builder.rs</code>:363 on 2025-01-14 16:25</div>
            <div class="timeline-body"><p><code>to_remove</code> might have been populated by multiple different loops over <code>self.positive</code> and <code>self.negative</code> with my refactor, so this isn't just about deduplicating. It's also about ensuring the collection of removable indices stays in sorted order.</p>
<p>I could instead use a single <code>smallvec</code> for each loop, which would be a bit closer to the current code. It would be a <em>bit</em> more repetitive but might be more performant due to fewer allocations ðŸ¤·</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-14 17:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/builder.rs</code>:363 on 2025-01-14 17:52</div>
            <div class="timeline-body"><p>On closer examination, I think the <code>BTreeSet</code> was both unnecessary and possibly buggy... I've removed it. Thanks for pushing me on this :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-01-14 18:09</div>
            <div class="timeline-body"><p>This looks good to me, no notes!</p>
<p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-01-14 18:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-01-14 18:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-14 18:15</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 20:34:30 UTC
    </footer>
</body>
</html>
