```yaml
number: 6594
title: Call pattern formatting
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: call-pattern-formatting
created_at: 2023-08-15T12:24:53Z
updated_at: 2023-08-16T03:01:26Z
url: https://github.com/astral-sh/ruff/pull/6594
synced_at: 2026-01-12T15:55:22Z
```

# Call pattern formatting

---

_@MichaReiser_

## Summary

This PR adds changes to delegate the formatting for match pattern nodes in the `MatchCase` formatting i.e., making the `pattern.format` calls. The implementation goes on to preserving the leading/trailing comments on the pattern nodes, parenthesizing if there are any such comments. If the node itself is parenthesized without any comments, the parentheses are preserved as is done in Black.

## Test Plan

Added test cases for:
* Pattern with parentheses, without leading or trailing comments
* Pattern with parentheses, with trailing comments
* Pattern with parentheses, with leading comments
* Pattern with parentheses, with leading and trailing comments


---

_Comment by @MichaReiser on 2023-08-15 12:25_

Current dependencies on/for this PR:
* main
  * **PR #6594** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6594" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6594?utm_source=stack-comment).

---

_@MichaReiser reviewed on 2023-08-15 12:25_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/other/match_case.rs`:23 on 2023-08-15 12:25_

This now fails for cases where the pattern has comments. We may need to preserve parentheses similar to the `WithItem` formatting.

---

_Comment by @github-actions[bot] on 2023-08-15 12:59_

## PR Check Results
### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      4.7Â±0.17ms     8.7 MB/sec    1.02      4.8Â±0.21ms     8.5 MB/sec
formatter/numpy/ctypeslib.py               1.00   927.0Â±28.40Âµs    18.0 MB/sec    1.04   960.9Â±53.47Âµs    17.3 MB/sec
formatter/numpy/globals.py                 1.05     96.8Â±6.61Âµs    30.5 MB/sec    1.00     92.5Â±5.73Âµs    31.9 MB/sec
formatter/pydantic/types.py                1.00  1839.0Â±94.76Âµs    13.9 MB/sec    1.02  1866.7Â±77.64Âµs    13.7 MB/sec
linter/all-rules/large/dataset.py          1.06     15.2Â±0.36ms     2.7 MB/sec    1.00     14.4Â±0.33ms     2.8 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.8Â±0.07ms     4.4 MB/sec    1.00      3.7Â±0.10ms     4.5 MB/sec
linter/all-rules/numpy/globals.py          1.00   531.6Â±17.66Âµs     5.6 MB/sec    1.02   541.0Â±33.51Âµs     5.5 MB/sec
linter/all-rules/pydantic/types.py         1.03      7.6Â±0.22ms     3.3 MB/sec    1.00      7.4Â±0.19ms     3.4 MB/sec
linter/default-rules/large/dataset.py      1.11      8.3Â±0.15ms     4.9 MB/sec    1.00      7.5Â±0.18ms     5.4 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.06  1720.8Â±44.42Âµs     9.7 MB/sec    1.00  1620.9Â±49.95Âµs    10.3 MB/sec
linter/default-rules/numpy/globals.py      1.02    205.7Â±8.19Âµs    14.3 MB/sec    1.00    201.4Â±8.27Âµs    14.7 MB/sec
linter/default-rules/pydantic/types.py     1.12      3.7Â±0.24ms     6.8 MB/sec    1.00      3.3Â±0.09ms     7.6 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      5.2Â±0.29ms     7.8 MB/sec    1.00      5.2Â±0.32ms     7.8 MB/sec
formatter/numpy/ctypeslib.py               1.00  1035.4Â±56.10Âµs    16.1 MB/sec    1.02  1055.0Â±67.16Âµs    15.8 MB/sec
formatter/numpy/globals.py                 1.00    105.4Â±5.63Âµs    28.0 MB/sec    1.05    110.7Â±9.23Âµs    26.7 MB/sec
formatter/pydantic/types.py                1.00      2.1Â±0.10ms    12.3 MB/sec    1.03      2.1Â±0.11ms    12.0 MB/sec
linter/all-rules/large/dataset.py          1.01     16.2Â±0.53ms     2.5 MB/sec    1.00     16.1Â±0.55ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.4Â±0.18ms     3.8 MB/sec    1.04      4.5Â±0.36ms     3.7 MB/sec
linter/all-rules/numpy/globals.py          1.00   530.3Â±21.64Âµs     5.6 MB/sec    1.04   551.2Â±40.94Âµs     5.4 MB/sec
linter/all-rules/pydantic/types.py         1.00      8.2Â±0.36ms     3.1 MB/sec    1.02      8.4Â±0.43ms     3.0 MB/sec
linter/default-rules/large/dataset.py      1.00      8.7Â±0.29ms     4.7 MB/sec    1.02      8.9Â±0.22ms     4.6 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1869.4Â±80.02Âµs     8.9 MB/sec    1.02  1902.4Â±130.78Âµs     8.8 MB/sec
linter/default-rules/numpy/globals.py      1.00   214.8Â±12.32Âµs    13.7 MB/sec    1.02   218.7Â±12.36Âµs    13.5 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.9Â±0.14ms     6.5 MB/sec    1.03      4.1Â±0.24ms     6.3 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Assigned to @dhruvmanila by @MichaReiser on 2023-08-15 13:06_

---

_@dhruvmanila reviewed on 2023-08-15 16:52_

---

_Review comment by @dhruvmanila on `crates/ruff_python_formatter/src/other/match_case.rs`:23 on 2023-08-15 16:52_

@MichaReiser This is fixed

---

_Marked ready for review by @dhruvmanila on 2023-08-15 16:52_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/other/match_case.rs`:28 on 2023-08-15 17:02_

Nit
```suggestion
        if comments.has_leading_comments(pattern) {
            pattern.format().fmt(f)?;
        } else {
```

Do we need to handle trailing own line comments too? I guess my question is. Does this implement the parenthesizing exactly like black or is the goal to unblock the work on match cases and we follow up with a matching formatting later?

---

_@MichaReiser reviewed on 2023-08-15 17:02_

---

_Comment by @MichaReiser on 2023-08-15 17:03_

Thank you

---

_Label `formatter` added by @MichaReiser on 2023-08-15 17:03_

---

_@dhruvmanila reviewed on 2023-08-15 17:07_

---

_Review comment by @dhruvmanila on `crates/ruff_python_formatter/src/other/match_case.rs`:28 on 2023-08-15 17:07_

By trailing, do you mean the following?

```python
match foo:
    case (
        # test
    foo  # trailing 1
    # trailing 2
# trailing 3
    ):
        pass
```

If so, they're handled correctly:

```python
match foo:
    case (
        # test
        x as NOT_YET_IMPLEMENTED_PatternMatchAs  # trailing 1
        # trailing 2
        # trailing 3
    ):
        pass
```

---

_@dhruvmanila reviewed on 2023-08-15 17:09_

---

_Review comment by @dhruvmanila on `crates/ruff_python_formatter/src/other/match_case.rs`:28 on 2023-08-15 17:09_

Oh, also this change isn't necessary as we need the leading comments to be added ðŸ˜…

---

_@MichaReiser reviewed on 2023-08-15 17:18_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/other/match_case.rs`:28 on 2023-08-15 17:18_

Can you test it without the leading comment? Does the parentheses logic matches black's? I'm trying to understand if we need to do any follow up work. But maybe that's hard to tell now without pattern formatting and it could, therefore, make sense to revisit the parentheses once all patterns are implemented 

---

_Comment by @MichaReiser on 2023-08-15 17:18_

Lol, I can't approve the change 

---

_Review requested from @charliermarsh by @MichaReiser on 2023-08-15 17:19_

---

_Comment by @charliermarsh on 2023-08-15 17:21_

I'm so confused by this lol. Did Micha start this then Dhruv took over?

---

_@dhruvmanila approved on 2023-08-15 17:21_

ðŸ˜‰ 

---

_@dhruvmanila reviewed on 2023-08-15 17:24_

---

_Review comment by @dhruvmanila on `crates/ruff_python_formatter/src/other/match_case.rs`:28 on 2023-08-15 17:24_

Ah, you're correct, without the leading comments the parentheses aren't added. 

---

_Comment by @dhruvmanila on 2023-08-15 17:45_

@MichaReiser I went ahead and implemented the "only trailing comments" and "no comments" part as well. I've added test cases and the output matches `black`.

> I'm so confused by this lol. Did Micha start this then Dhruv took over?

Me and Micha discussed on Discord regarding calling the `pattern.format()` so that we can unlock https://github.com/astral-sh/ruff/issues/5834#issuecomment-1678848297 but that involved handling comments around the pattern. The implementation itself is similar to that of `StmtWith` formatting.

---

_Comment by @MichaReiser on 2023-08-15 20:13_

@dhruvmanila feel free to merge this when it's ready 

---

_Merged by @dhruvmanila on 2023-08-16 03:01_

---

_Closed by @dhruvmanila on 2023-08-16 03:01_

---

_Branch deleted on 2023-08-16 03:01_

---
