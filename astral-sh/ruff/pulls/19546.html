<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pycodestyle`] Fix handling of format specs for `invalid-escape-sequence (W605)` - astral-sh/ruff #19546</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pycodestyle</code>] Fix handling of format specs for <code>invalid-escape-sequence (W605)</code></h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19546">#19546</a>
        opened by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a>
        on 2025-07-25 01:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> on 2025-07-25 01:34</div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff/ty! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title? (Please prefix with `[ty]` for ty pull
  requests.)
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<!-- What's the purpose of the change? What does it do, and why? -->

<p>This PR fixes #11491, cleaning up the last of the interpolated string related issues with <a href="https://docs.astral.sh/ruff/rules/invalid-escape-sequence/#invalid-escape-sequence-w605">invalid-escape-sequence (W605)</a>. Interpolated string format specs behave very strangely, in that their contents are not affected by the raw-ness of their containing string, unless they are adjacent to a <code>{</code> or <code>}</code>, in which case they are affected.</p>
<p>The fix functions by separating out all of the non-raw-affected escapes into their own vec, since the only option for them is to be escaped via adding another <code>\</code>. The edge cases of <code>{</code> and <code>}</code> adjacent <code>\</code>s are left with the rest of the invalid escapes.</p>
<p>Passing the inside-format-spec-ness via a bool is a bit ugly, but I could not think of a better solution. Ideas welcome.</p>
<h2>Test Plan</h2>
<!-- How was it tested? -->

<p>Added 4 new test cases for the non-<code>{</code>-<code>}</code> edge cases, and 2 other new test cases for those edge cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-25 01:43</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`pycodestyle`] Fix handling of format specs for `invalid-escape-sequence (W605`" to "[`pycodestyle`] Fix handling of format specs for `invalid-escape-sequence (W605)`" by @MeGaGiGaGon on 2025-07-25 02:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @ntBre on 2025-07-25 21:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pycodestyle/rules/invalid_escape_sequence.rs</code>:274 on 2025-07-29 20:37</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// affected by whether or not the string is raw.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pycodestyle/rules/invalid_escape_sequence.rs</code>:209 on 2025-07-29 20:41</div>
            <div class="timeline-body"><p>Will this check handle escaped braces like <code>f&quot;{{x}}&quot;</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-07-29 20:44</div>
            <div class="timeline-body"><p>Thanks! This looks plausible to me in a quick skim. I just had one tiny docs nit and a question about doubled braces.</p>
<p>@MichaReiser or @dylwil3 if either of you remembers much context from #14748, you might be better suited to review this. If not, I'll do a deeper dive here myself.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ntBre on 2025-07-29 20:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> reviewed on 2025-07-29 21:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> on <code>crates/ruff_linter/src/rules/pycodestyle/rules/invalid_escape_sequence.rs</code>:209 on 2025-07-29 21:44</div>
            <div class="timeline-body"><p>Format specs operate under different rules for whatever reason, so <code>{{</code> escapes don't work in format specs. <code>{{</code>s outside format specs shouldn't be affected because of the <code>in_format_spec</code> check.</p>
<pre><code class="language-pycon">&gt;&gt;&gt; f&quot;{1: {{ }&quot;
  File &quot;&lt;python-input-0&gt;&quot;, line 1
    f&quot;{1: {{ }&quot;
              ^
SyntaxError: f-string: expecting '}'
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-07-29 22:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pycodestyle/rules/invalid_escape_sequence.rs</code>:209 on 2025-07-29 22:21</div>
            <div class="timeline-body"><p>Ohhh, gotcha. I forgot only the part after the colon was the format spec. I was thinking it was the whole set of curly braces.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dylwil3 by @MichaReiser on 2025-07-30 06:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-30 06:58</div>
            <div class="timeline-body"><p>Not really. But it makes sense that @dylwil3 takes a look</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/resources/test/fixtures/pycodestyle/W605_1.py</code>:144 on 2025-08-01 17:30</div>
            <div class="timeline-body"><p>Could you add a test for something like this?</p>
<pre><code class="language-python">rf&quot;xyz{a:\XFF}&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/pycodestyle/rules/invalid_escape_sequence.rs</code>:114 on 2025-08-01 17:31</div>
            <div class="timeline-body"><p>Might be a little clearer at the call site to make this an enum with two variants</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/pycodestyle/rules/invalid_escape_sequence.rs</code>:327 on 2025-08-01 17:33</div>
            <div class="timeline-body"><p>Can you give this a more descriptive name and/or a doc-comment to differentiate it from <code>check</code>? Something to indicate that this function is specifically for adding escapes rather than making strings raw.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> requested changes on 2025-08-01 17:55</div>
            <div class="timeline-body"><p>Thanks this looks good! A few suggestions. Also, can you point me to some documentation around the comment you made about format specifiers being the same whether or not there is a raw prefix on the f-string?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> on 2025-08-01 21:44</div>
            <div class="timeline-body"><blockquote>
<p>Thanks this looks good! A few suggestions. Also, can you point me to some documentation around the comment you made about format specifiers being the same whether or not there is a raw prefix on the f-string?</p>
</blockquote>
<p>I did some more digging, and it looks like there is no documentation on this, see https://github.com/python/cpython/issues/137314 .</p>
<p>So looks like the fix might need to behave differently dependent on the python version.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-08-03 15:06</div>
            <div class="timeline-body"><p>Thank you for the thorough investigation! It looks like there is now an open PR to change the behavior for some subset of Python versions where the change is still allowed to be made (https://github.com/python/cpython/pull/137328). So let's wait to see how that pans out and then revisit this - I've subscribed to that PR so hopefully will be pinged if and when it's merged.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-08-03 15:09</div>
            <div class="timeline-body"><p>That said - if you are optimistic that the PR will merge in (as I am), then you could make the changes now. It seems like after the PR is merged, the raw prefix will behave as expected <em>except</em> in version 3.12, where your custom logic is required.</p>
<p>Update: PR has merged to main, and will be backported to 3.13 and 3.14. There was a leftover question of whether it would also be backported to 3.12, so we'll see if in the end we don't need any version-specific logic after all.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-08-04 13:23</div>
            <div class="timeline-body"><p>@MeGaGiGaGon sorry for so many pings - it looks like the CPython changes are done and Python 3.12 is the only version that has this strange behavior going forward. Let me know if you need help implementing any of the updates, otherwise feel free to ping me when it's ready for re-review. Thank you!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:52:43 UTC
    </footer>
</body>
</html>
