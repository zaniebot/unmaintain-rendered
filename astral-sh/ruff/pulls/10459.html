<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store current `TokenKind` on `Parser` - astral-sh/ruff #10459</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Store current <code>TokenKind</code> on <code>Parser</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10459">#10459</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-03-18 14:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR updates the <code>Parser</code> struct to store the current <code>TokenKind</code> along with the <code>Spanned</code> (token and it's range). The token kind is being used in all of the parsing functions and it's beneficial to have it around instead of computing it every time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by @dhruvmanila on 2024-03-18 14:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2024-03-18 14:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-03-18 15:11</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-03-18 15:52</div>
            <div class="timeline-body"><blockquote>
<p>and it's beneficial to have it around instead of computing it every time.</p>
</blockquote>
<p>Can you expand on why it's beneficial? Does it improve performance?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-19 02:18</div>
            <div class="timeline-body"><blockquote>
<p>Does it improve performance?</p>
</blockquote>
<p>Not really. Benchmarking doesn't really show much difference:</p>
<pre><code class="language-console">$ critcmp main-parser current-kind                                                                
group                         current-kind                           main-parser
-----                         ------------                           -----------
parser/large/dataset.py       1.01    634.8±2.94µs    64.1 MB/sec    1.00    627.6±2.09µs    64.8 MB/sec
parser/numpy/ctypeslib.py     1.00    108.2±0.42µs   153.9 MB/sec    1.02    109.9±0.49µs   151.5 MB/sec
parser/numpy/globals.py       1.01      8.7±0.04µs   340.1 MB/sec    1.00      8.5±0.04µs   345.1 MB/sec
parser/pydantic/types.py      1.01    254.0±1.54µs   100.4 MB/sec    1.00    252.7±1.32µs   100.9 MB/sec
parser/unicode/pypinyin.py    1.01     33.4±0.15µs   125.9 MB/sec    1.00     32.9±0.15µs   127.7 MB/sec
</code></pre>
<p>Nor does the hyperfine benchmarks.</p>
<p>Although the amount of time we do the conversion is reduced by around 80% which is due to the fact that we do this conversion only once when the parser moves on to the next token (sometimes when we peek) instead of every time we want the token kind.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-03-19 08:44</div>
            <div class="timeline-body"><blockquote>
<p>Not really. Benchmarking doesn't really show much difference:</p>
</blockquote>
<p>I assume that is because we now trade computation with additional read/write instructions. I would hold off with this PR unless it improves performance because it introduces a potential source of inconsistency bugs (failing to update <code>token_kind</code> but moving to the next token). You could also try and see if https://github.com/astral-sh/ruff/pull/9537 helps with perf.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-19 08:48</div>
            <div class="timeline-body"><p>I see, thanks for the linked PR. I'll check it out soon. Putting this PR on draft for the time being.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @dhruvmanila on 2024-03-19 08:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-07 11:24</div>
            <div class="timeline-body"><p>I'll close this for now, can pick it up later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-04-07 11:24</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:03:11 UTC
    </footer>
</body>
</html>
