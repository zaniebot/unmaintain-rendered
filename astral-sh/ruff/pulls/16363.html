<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Handle possibly-unbound instance members - astral-sh/ruff #16363</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Handle possibly-unbound instance members</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16363">#16363</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-02-25 10:01
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-02-25 10:01</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Adds support for possibly-unbound/undeclared instance members.</p>
<h2>Test Plan</h2>
<p>New MD tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @sharkdp on 2025-02-25 10:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2025-02-25 10:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @sharkdp on 2025-02-25 10:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2025-02-25 10:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:899 on 2025-02-25 10:03</div>
            <div class="timeline-body"><p>We came to the same conclusion in an earlier PR. This is also mentioned higher up in this test suite. And mypy/pyright don't emit a diagnostic for this either (which is also mentioned higher up). This test is only added here for easier reference / completeness.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-25 10:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:816 on 2025-02-25 14:17</div>
            <div class="timeline-body"><p>I guess for this one, I'm not totally clear on how it's different to https://github.com/astral-sh/ruff/pull/16363/files#r1969441733. All members of the union have an <code>x</code> attribute here, and like https://github.com/astral-sh/ruff/pull/16363/files#r1969441733, it's still an instance attribute that we can't verify has been definitely defined. Like https://github.com/astral-sh/ruff/pull/16363/files#r1969441733, there's still the issue that it's (unfortunately) not uncommon in Python to initialize attributes on instances after the instance has been constructed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:407 on 2025-02-25 14:23</div>
            <div class="timeline-body"><p>is it worth generalising this optimisation inside the <code>UnionBuilder</code> rather than special-casing single-element unions here? The <code>UnionBuilder::elements</code> field is currently just <code>Vec&lt;Type&gt;</code>, but if it was something like <code>SmallVec&lt;[Type; 1]&gt;</code>, that would avoid allocating inside the union builder if there was only 1 element</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-02-25 14:24</div>
            <div class="timeline-body"><p>Looks good! A couple of minor questions</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-25 14:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:407 on 2025-02-25 14:32</div>
            <div class="timeline-body"><p>I'd probably prefer the approach that I started in https://github.com/astral-sh/ruff/pull/16218 over using a <code>SmallVec</code>. Each access in a small vec has an added cost because it first need to check if it's a stack or heap allocated vec. Although using <code>from_elements</code> might be challenging here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:407 on 2025-02-25 14:43</div>
            <div class="timeline-body"><blockquote>
<p>Although using <code>from_elements</code> might be challenging here.</p>
</blockquote>
<p>yeah, I think it's probably not practical to use it here unfortunately</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-25 14:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:407 on 2025-02-25 15:27</div>
            <div class="timeline-body"><p>Here and below <code>TypeQualifiers::empty()</code> doesn't feel right, but maybe it doesn't make sense to address this until we have support for more type qualifiers? We are throwing away type qualifiers from the <code>match</code> above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:427 on 2025-02-25 15:29</div>
            <div class="timeline-body"><p>Here also we are throwing away type-qualifier information from whatever superclass attribute(s) we found.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:816 on 2025-02-25 15:34</div>
            <div class="timeline-body"><p>The distinction this PR appears to be making is that we'll report boundness from the class body accurately, but when we find implicit attributes assigned in methods, we'll presume &quot;always bound&quot; for those. I'm not 100% sure where we'll end up here in practice, but this seems like a reasonable place to start: making something conditional in a class body is unusual, and to do that with a non-statically-known branch condition even more so.</p>
<p>That said, I do think there's a not-insignificant chance that in the face of feedback from real codebases, we end up rolling back most of our possibly-unbound diagnostics on methods and attributes, or making them opt-in.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-02-25 15:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-02-25 15:37</div>
            <div class="timeline-body"><p>The handling of inherited attributes here reminds me that we will also need to add eager Liskov checking for inherited classes (once we have callable types and can do callable subtype checks). For a mutable attribute (which all are by default) a strict Liskov interpretation would require invariance, which would make the union handling here irrelevant.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:816 on 2025-02-25 15:39</div>
            <div class="timeline-body"><p>That's a good question. I modeled it after the behavior on the class object, but we may want to design that differently. Should possible unboundness always be ignored for instance members?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-25 15:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-25 15:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:816 on 2025-02-25 15:42</div>
            <div class="timeline-body"><p>Oops. Didn't see @carljm's answer. Does that mean that we can keep the current behavior for now?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:816 on 2025-02-25 15:48</div>
            <div class="timeline-body"><blockquote>
<p>Should possible unboundness always be ignored for instance members?</p>
</blockquote>
<p>I would argue yes, but I'm also fine with deferring this for now. Could possibly add a TODO saying that this could be revisited in the future?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-25 15:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-02-25 15:59</div>
            <div class="timeline-body"><blockquote>
<p>which would make the union handling here irrelevant</p>
</blockquote>
<p>Mainly curious: is this true even in the presence of gradual types? Could a subclass refine a base-class <code>Any</code> attribute to a more static type <code>T</code>? And would it then make sense to treat a possibly-unbound-on-child-class attribute as being of type <code>Any | T</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-02-25 16:18</div>
            <div class="timeline-body"><blockquote>
<p>Mainly curious: is this true even in the presence of gradual types? Could a subclass refine a base-class <code>Any</code> attribute to a more static type <code>T</code>? And would it then make sense to treat a possibly-unbound-on-child-class attribute as being of type <code>Any | T</code>?</p>
</blockquote>
<p>That's a good point: I think that would make sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-25 18:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:407 on 2025-02-25 18:26</div>
            <div class="timeline-body"><p>Yes, thanks. Added a test case, preliminary handling of type qualifiers (without diagnostics for conflicting qualifiers), and a TODO.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-25 18:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:816 on 2025-02-25 18:27</div>
            <div class="timeline-body"><p>Done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-25 18:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:813 on 2025-02-25 18:33</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    # Note: we might want to consider ignoring possibly-unbound diagnostics for instance attributes eventually,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-25 18:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:813 on 2025-02-25 18:39</div>
            <div class="timeline-body"><p>I â€¦ what? :smile: Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-25 18:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/attributes.md</code>:813 on 2025-02-25 18:40</div>
            <div class="timeline-body"><p>hehe, no worries</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2025-02-25 19:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-02-25 19:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-25 19:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:400 on 2025-02-25 21:06</div>
            <div class="timeline-body"><p>Probably the diagnostic would be raised by an eager Liskov check at the inheritance site, rather than here? But it doesn't hurt to have a TODO here until we do that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-02-25 21:07</div>
            <div class="timeline-body"></div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:49:31 UTC
    </footer>
</body>
</html>
