<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix `can_omit_optional_parentheses` for expressions with a right most fstring - astral-sh/ruff #9124</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix <code>can_omit_optional_parentheses</code> for expressions with a right most fstring</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/9124">#9124</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-12-14 04:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">Summary
<p>This PR fixes an issue in our <code>can_omit_optional_parentheses</code> implementation.</p>
<p>The goal of <code>can_omit_optional_parentheses</code> is to return true when the expression starts or ends with a parenthesized expression.</p>
<pre><code>if a + [
	parentheses,
	are,
	not,
	required,
	here
]: pass
</code></pre>
<p>However, our implementation incorrectly traversed into fstrings and other expressions that end with a token. We should skip these
(similar to other parenthesized expressions) because they&#x27;re not at the end of the expression (they&#x27;re wrapped).</p>
<p>A silly example, but it should do it for illustrating what it is about</p>
<pre><code>if a + f&quot;parentheses are required because the list isn&#x27;t at the very end, the closing quote is {[1, 2]}&quot;: 
	pass

</code></pre>
Test Plan
<p>Added test. The similarity for our old compatibility check remains unchanged. The ecosystem only shows one intentional change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-12-14 04:46</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li><code>main</code><ul>
<li><strong>PR #9124</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/9124?utm_source=stack-comment-icon"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a>  üëà</li>
</ul>
</li>
</ul>
<p>This <a href="https://stacking.dev/?utm_source=stack-comment">stack of pull requests</a> is managed by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/9124?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-12-14 04:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-12-14 04:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-12-14 04:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-12-14 04:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-12-14 04:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-12-14 04:57</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Formatter (stable)
<p>‚ÑπÔ∏è ecosystem check <strong>detected format changes</strong>. (+5 -4 lines in 1 file in 41 projects)</p>
<a href="https://github.com/reflex-dev/reflex">reflex-dev/reflex</a> (+5 -4 lines across 1 file)
<p>

<p><a href="https://github.com/reflex-dev/reflex/blob/e245b6b6a0f90f71c8aba6e0299f4bcc31638330/tests/test_event.py#L239">tests/test_event.py~L239</a></p>
<pre><code>     assert spec.args[0][1].equals(Var.create_safe(&quot;testkey&quot;))
     assert spec.args[1][0].equals(Var.create_safe(&quot;options&quot;))
     assert spec.args[1][1].equals(Var.create_safe(options))
-    assert format.format_event(
-        spec
-    ) == f&#x27;Event(&quot;_remove_cookie&quot;, {{key:`testkey`,options:{json.dumps(options)}}})&#x27;
+    assert (
+        format.format_event(spec)
+        == f&#x27;Event(&quot;_remove_cookie&quot;, {{key:`testkey`,options:{json.dumps(options)}}})&#x27;
+    )
 
 
 def test_clear_local_storage():
</code></pre>
</p>


Formatter (preview)
<p>‚ÑπÔ∏è ecosystem check <strong>detected format changes</strong>. (+5 -4 lines in 1 file in 41 projects)</p>
<a href="https://github.com/reflex-dev/reflex">reflex-dev/reflex</a> (+5 -4 lines across 1 file)
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<p><a href="https://github.com/reflex-dev/reflex/blob/e245b6b6a0f90f71c8aba6e0299f4bcc31638330/tests/test_event.py#L239">tests/test_event.py~L239</a></p>
<pre><code>     assert spec.args[0][1].equals(Var.create_safe(&quot;testkey&quot;))
     assert spec.args[1][0].equals(Var.create_safe(&quot;options&quot;))
     assert spec.args[1][1].equals(Var.create_safe(options))
-    assert format.format_event(
-        spec
-    ) == f&#x27;Event(&quot;_remove_cookie&quot;, {{key:`testkey`,options:{json.dumps(options)}}})&#x27;
+    assert (
+        format.format_event(spec)
+        == f&#x27;Event(&quot;_remove_cookie&quot;, {{key:`testkey`,options:{json.dumps(options)}}})&#x27;
+    )
 
 
 def test_clear_local_storage():
</code></pre>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-12-14 04:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-12-14 04:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-12-14 04:58</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:59:58 UTC
    </footer>
</body>
</html>
