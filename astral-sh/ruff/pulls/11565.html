<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consider irrefutable pattern similar to `if .. else` for `C901` - astral-sh/ruff #11565</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Consider irrefutable pattern similar to <code>if .. else</code> for <code>C901</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11565">#11565</a>
        opened by <a href="https://github.com/blueraft">@blueraft</a>
        on 2024-05-27 10:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/blueraft">@blueraft</a></div>
            <div class="timeline-body">Summary
<p>Follow up to <a href="https://github.com/astral-sh/ruff/pull/11521">astral-sh/ruff#11521</a></p>
<p>Removes the extra added complexity for catch all match cases. This matches the implementation of plain <code>else</code> statements.</p>
Test Plan
<p>Added new test cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-05-27 10:47</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/mccabe/rules/function_is_too_complex.rs</code>:100 on 2024-05-27 12:14</div>
            <div class="timeline-body"><p>Can we use <code>saturating_sub</code> here to avoid a panic for <code>match a:</code>. This is not valid python but the parser might soon be able to recover from incomplete statements.</p>
<pre><code>                let last_index = cases.len().saturating_sub(1);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/mccabe/rules/function_is_too_complex.rs</code>:104 on 2024-05-27 12:15</div>
            <div class="timeline-body"><p>What&#x27;s the reason that we restrict the logic to only when the <code>_</code> pattern is last? Can&#x27;t we always subtract the complexity in that case?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-05-27 12:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-05-27 12:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/mccabe/rules/function_is_too_complex.rs</code>:104 on 2024-05-27 12:27</div>
            <div class="timeline-body"><p>Because an <a href="https://peps.python.org/pep-0634/#irrefutable-case-blocks">irrefutable pattern</a> can only occur in the last case block otherwise it&#x27;s a syntax error (checked by the compiler). We don&#x27;t raise this currently, but we should start doing so. I&#x27;m going to make an umbrella issue with such syntax errors raised by the compiler.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-05-27 12:28</div>
            <div class="timeline-body"><p>I think we should just use <code>cases.last</code>:</p>
<pre><code>if let Some(last_case) = cases.last() {
	// ...
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/blueraft">@blueraft</a> reviewed on 2024-05-27 12:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/blueraft">@blueraft</a> on <code>crates/ruff_linter/src/rules/mccabe/rules/function_is_too_complex.rs</code>:100 on 2024-05-27 12:35</div>
            <div class="timeline-body"><p>Went with Dhurv&#x27;s suggestion here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2024-05-27 12:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-05-27 12:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/mccabe/rules/function_is_too_complex.rs</code>:105 on 2024-05-27 12:55</div>
            <div class="timeline-body"><p>Actually, there are more cases to consider here:</p>
<ol>
<li>Make sure that the <code>guard</code> field is <code>None</code> (<code>last_case.guard.is_none()</code>)</li>
<li>Consider sequence pattern where if any pattern in the sequence is <code>_</code> or named capture, the entire sequence is considered irrefutable</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-05-27 12:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/mccabe/rules/function_is_too_complex.rs</code>:105 on 2024-05-27 12:56</div>
            <div class="timeline-body"><p>(Sorry for sending this review after the approval)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-05-27 13:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/mccabe/rules/function_is_too_complex.rs</code>:104 on 2024-05-27 13:09</div>
            <div class="timeline-body"><p>That makes sense. But that also implies that it would be safe to ignore the check here and simply assume it is the last?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/blueraft">@blueraft</a> reviewed on 2024-05-27 13:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/blueraft">@blueraft</a> on <code>crates/ruff_linter/src/rules/mccabe/rules/function_is_too_complex.rs</code>:105 on 2024-05-27 13:10</div>
            <div class="timeline-body"><p>Good catch! Done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2024-05-27 17:30</div>
            <div class="timeline-body"><p>Thank you! I&#x27;ve made <code>is_irrefutable</code> a method on <code>Pattern</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-05-27 17:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Handle match catch all case for complexity check&quot; to &quot;Consider irrefutable pattern similar to `if .. else` for `C901`&quot; by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-05-27 17:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-05-27 17:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-05-27 17:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-05-27 17:55</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:04:15 UTC
    </footer>
</body>
</html>
