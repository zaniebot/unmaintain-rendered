<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use CommentRanges in backwards lexing - astral-sh/ruff #7360</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use CommentRanges in backwards lexing</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7360">#7360</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2023-09-13 18:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>The tokenizer was split into a forward and a backwards tokenizer. The backwards tokenizer uses the same names as the forwards ones (e.g. <code>next_token</code>). The backwards tokenizer gets the comment ranges that we already built to skip comments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @konstin on 2023-09-13 18:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_trivia/src/tokenizer.rs</code>:521 on 2023-09-13 19:09</div>
            <div class="timeline-body"><p>Nit: We should avoid doing a binary search on every newline. We can instead do a binary search to find the end position and then use take_if from the back</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-13 19:10</div>
            <div class="timeline-body"><p>I really like the idea. It will simplify the tokenizer a lot.</p>
<p>I think I would overall prefer to split the backward lexing out of the simple tokenizer because the changes now complicate the use of <code>SimpleTokenizer</code> even when backward lexing isn't necessary. This will also allow us to support fewer tokens for backward lexing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-09-14 13:46</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_trivia/src/tokenizer.rs</code>:521 on 2023-09-15 10:20</div>
            <div class="timeline-body"><p>i've implemented this but it feels like i added more complexity than appropriate for that small perf :/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-15 10:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @konstin on 2023-09-15 10:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-15 11:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_trivia/src/snapshots/ruff_python_trivia__tokenizer__tests__tokenize_bogus.snap</code>:24 on 2023-09-15 11:35</div>
            <div class="timeline-body"><p>Nit: Would you mind moving this change out of this PR and make a separate PR for it? It eases reviewing and gives us higher confidence that the behavior doesn't change with your refactor.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/parenthesize.rs</code>:12 on 2023-09-15 12:06</div>
            <div class="timeline-body"><p>I think I would prefer passing <code>CommentRange</code>s. While not strictly necessary, it makes it easier to search for usages where the comment ranges are required and would allow for changes to the internal representation.</p>
<p>We can implement <code>Default</code> for CommentRanges` for the use case of that one rule that doesn't need comment ranges.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/mod.rs</code>:331 on 2023-09-15 12:09</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    pub(crate) fn ranges(&amp;self) -&gt; &amp;'a CommentRanges {
        self.comment_ranges
    }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/mod.rs</code>:327 on 2023-09-15 12:10</div>
            <div class="timeline-body"><p>Could we instead implement <code>default</code> for <code>CommentRanges</code> ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/binary_like.rs</code>:187 on 2023-09-15 12:11</div>
            <div class="timeline-body"><p>Nit: We could also consider passing <code>&amp;PyFormatContext</code> to have fewer arguments</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/binary_like.rs</code>:884 on 2023-09-15 12:12</div>
            <div class="timeline-body"><pre><code class="language-suggestion">            f.context().comments().ranges(),
</code></pre>
<p>Cloning shouldn't be necessary here because we aren't mutating <code>f</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:110 on 2023-09-15 12:13</div>
            <div class="timeline-body"><p>I think passing <code>&amp;PyFormatContext</code> instead could help cleaning up the call sites.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_trivia/src/tokenizer.rs</code>:483 on 2023-09-15 12:14</div>
            <div class="timeline-body"><p>I think we can remove this field as well. It is only used for backward lexing</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_trivia/src/tokenizer.rs</code>:529 on 2023-09-15 12:15</div>
            <div class="timeline-body"><p>Nit: <code>self.cursor = Cursor::new(&quot;&quot;)</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_trivia/src/tokenizer.rs</code>:749 on 2023-09-15 12:17</div>
            <div class="timeline-body"><p>Could we move <code>CommentRanges</code> to <code>ruff_python_trivia</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_trivia/src/tokenizer.rs</code>:751 on 2023-09-15 12:18</div>
            <div class="timeline-body"><p>Nit: Storing a slice and updating the slice when needed should give you the same</p>
<pre><code class="language-suggestion">    comment_ranges: &amp;'a [TextRange],
</code></pre>
<p>In the next function:</p>
<pre><code class="language-rust">while self
                .comment_ranges
                .last()
                .is_some_and(|comment| comment.start() &gt; self.back_offset)
            {
                self.comment_ranges = &amp;self.comment_ranges.split_last().unwrap().1;
            }

            // Inside of a comment
            if self.comment_ranges
                .last()
                .is_some_and(|comment| comment.contains_inclusive(self.back_offset))
            {
            } else {
            }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_trivia/src/tokenizer.rs</code>:763 on 2023-09-15 12:19</div>
            <div class="timeline-body"><p>Could we remove this field now. It was mainly necessary to avoid re-lexing the entire line. But that is now longer required, instead a simple check whether the last comment in <code>comment_ranges</code> includes the current position is sufficient to know whether we are in a comment or not.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_trivia/src/tokenizer.rs</code>:845 on 2023-09-15 12:20</div>
            <div class="timeline-body"><pre><code class="language-suggestion">            self.cursor = Cursor::new(&quot;&quot;);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_trivia/src/tokenizer.rs</code>:868 on 2023-09-15 12:22</div>
            <div class="timeline-body"><p>This could potentially happen if we start lexing before the <code>expr</code> in</p>
<pre><code class="language-python">f&quot;#{expr}&quot;
</code></pre>
<p>Let's return <code>Other</code> in this case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_trivia/src/tokenizer.rs</code>:1033 on 2023-09-15 12:24</div>
            <div class="timeline-body"><p>Nit</p>
<pre><code class="language-suggestion">            let comment_ranges: Vec&lt;_&gt; = lex(self.source, Mode::Module).filter_map(|result| {
	             let (token, range) = result.expect(&quot;Input to be a valid python program.&quot;);
                if matches!(token, Tok::Comment(_)) {
                    Some(range)
                } else {
                	None
              	}
            }).collect()
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-09-15 12:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-15 12:31</div>
            <div class="timeline-body"><p>:guitar:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-15 13:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/comments/mod.rs</code>:327 on 2023-09-15 13:38</div>
            <div class="timeline-body"><p>that doesn't work unfortunately because we store only a reference an the reference needs to outlive this function call</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-15 13:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_trivia/src/tokenizer.rs</code>:529 on 2023-09-15 13:39</div>
            <div class="timeline-body"><p>is that fine? i wasn't sure if i could do that given that now the cursor and the tokenizer disagree about source</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-15 13:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_trivia/src/tokenizer.rs</code>:763 on 2023-09-15 13:42</div>
            <div class="timeline-body"><p>this does mean we have to do the binary search when instantiating the tokenizer independent of whether we hit a newline, do you still prefer this solution? (i've also been thinking about switching)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-15 13:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/mod.rs</code>:327 on 2023-09-15 13:56</div>
            <div class="timeline-body"><p>On that note... we should probably move <code>CommentRange</code>s into the RC or <code>clone</code> to avoid that <code>clone</code> becomes more expensive.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_trivia/src/tokenizer.rs</code>:529 on 2023-09-15 13:57</div>
            <div class="timeline-body"><p>The cursor only stores the remainder string, which is empty at this point.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-15 13:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-15 13:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_trivia/src/tokenizer.rs</code>:763 on 2023-09-15 13:57</div>
            <div class="timeline-body"><p>Yeah, makes sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-15 20:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:110 on 2023-09-15 20:53</div>
            <div class="timeline-body"><p>that fails because it counts as an immutable borrow of <code>f</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-15 20:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:110 on 2023-09-15 20:59</div>
            <div class="timeline-body"><p>Where is this a problem? Is expression parenthesized returns a bool without any lifetimes</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-15 21:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:110 on 2023-09-15 21:06</div>
            <div class="timeline-body"><p>it's not there but other call sites of <code>is_expression_parenthesized</code> or their parents which e.g. call it in closures</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-15 21:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_trivia/src/tokenizer.rs</code>:868 on 2023-09-15 21:08</div>
            <div class="timeline-body"><p>ok, but it's really bad if you're doing that, the output of the tokenizer is completely wrong when you're lexing string content as rust</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-15 21:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_trivia/src/tokenizer.rs</code>:749 on 2023-09-15 21:54</div>
            <div class="timeline-body"><p>done, it's a bit odd though because the builder depends on <code>Tok</code> so it has to stay</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-09-15 22:02</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #7360</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7360" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ<ul>
<li><strong>PR #7425</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7425" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7360?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @konstin on 2023-09-16 03:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2023-09-16 03:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-09-16 03:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:00:13 UTC
    </footer>
</body>
</html>
