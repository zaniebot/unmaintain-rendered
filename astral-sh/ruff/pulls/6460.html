<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix formatter instability with half-indented comment - astral-sh/ruff #6460</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix formatter instability with half-indented comment</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6460">#6460</a>
        opened by <a href="https://github.com/LaBatata101">@LaBatata101</a>
        on 2023-08-09 21:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/LaBatata101">@LaBatata101</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>The bug was happening in this <a href="https://github.com/LaBatata101/ruff/blob/75f402eb8262f88dc0445beb6cab4d3cd224716c/crates/ruff_python_formatter/src/comments/placement.rs#L545">loop</a>.</p>
<p>Basically, In the first iteration of the loop, the <code>comment_indentation</code> is bigger than <code>child_indentation</code> (<code>comment_indentation</code> is 7 and <code>child_indentation</code> is 4) making the <code>Ordering::Greater</code>  branch execute. Inside the <code>Ordering::Greater</code> branch, the <code>if</code> block gets executed, resulting in the update of these variables.</p>
<pre><code class="language-rust">parent_body = current_body;                    
current_body = Some(last_child_in_current_body);
last_child_in_current_body = nested_child;
</code></pre>
<pre><code>                                                                      </code></pre>
<p>In the second iteration of the loop, <code>comment_indentation</code> is smaller than <code>child_indentation</code> (<code>comment_indentation</code> is 7 and <code>child_indentation</code> is 8) making the <code>Ordering::Less</code> branch execute. Inside the <code>Ordering::Less</code>  branch, the <code>if</code> block gets executed, this is where the bug was happening. At this point <code>parent_body</code> should be a <code>StmtFunctionDef</code> but it was a <code>StmtClassDef</code>. Causing the comment to be incorrectly formatted.</p>
<p>That happened for the following code:</p>
<pre><code class="language-python">class A:
    def f():
        pass
       # strangely indented comment

print()
</code></pre>
<p>There is only one problem that I couldn't figure it out a solution, the variable <code>current_body</code> in this <a href="https://github.com/LaBatata101/ruff/blob/75f402eb8262f88dc0445beb6cab4d3cd224716c/crates/ruff_python_formatter/src/comments/placement.rs#L542C5-L542C49">line</a> now gives this warning <em>&quot;value assigned to <code>current_body</code> is never read maybe it is overwritten before being read?&quot;</em>
Any tips on how to solve that?</p>
<p>Closes #5337</p>
<h2>Test Plan</h2>
<p>Add new test case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-08-09 21:51</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      8.3±0.02ms     4.9 MB/sec    1.00      8.3±0.01ms     4.9 MB/sec
formatter/numpy/ctypeslib.py               1.02   1623.0±3.81µs    10.3 MB/sec    1.00   1591.2±4.66µs    10.5 MB/sec
formatter/numpy/globals.py                 1.02    174.0±1.90µs    17.0 MB/sec    1.00    171.1±0.26µs    17.2 MB/sec
formatter/pydantic/types.py                1.02      3.6±0.03ms     7.2 MB/sec    1.00      3.5±0.01ms     7.3 MB/sec
linter/all-rules/large/dataset.py          1.03     10.6±0.03ms     3.8 MB/sec    1.00     10.3±0.02ms     3.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.03      2.9±0.01ms     5.7 MB/sec    1.00      2.8±0.00ms     5.9 MB/sec
linter/all-rules/numpy/globals.py          1.06    331.1±1.84µs     8.9 MB/sec    1.00    312.5±1.96µs     9.4 MB/sec
linter/all-rules/pydantic/types.py         1.14      5.5±0.01ms     4.6 MB/sec    1.00      4.8±0.01ms     5.3 MB/sec
linter/default-rules/large/dataset.py      1.04      5.6±0.01ms     7.3 MB/sec    1.00      5.4±0.01ms     7.6 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.08   1199.9±1.54µs    13.9 MB/sec    1.00   1110.6±2.07µs    15.0 MB/sec
linter/default-rules/numpy/globals.py      1.09    126.0±0.32µs    23.4 MB/sec    1.00    115.3±0.26µs    25.6 MB/sec
linter/default-rules/pydantic/types.py     1.06      2.5±0.01ms    10.1 MB/sec    1.00      2.4±0.01ms    10.7 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.02     10.0±0.07ms     4.1 MB/sec    1.00      9.8±0.09ms     4.1 MB/sec
formatter/numpy/ctypeslib.py               1.03  1921.1±17.92µs     8.7 MB/sec    1.00  1870.9±17.63µs     8.9 MB/sec
formatter/numpy/globals.py                 1.01    213.1±4.67µs    13.8 MB/sec    1.00   210.6±11.19µs    14.0 MB/sec
formatter/pydantic/types.py                1.01      4.2±0.05ms     6.1 MB/sec    1.00      4.2±0.05ms     6.1 MB/sec
linter/all-rules/large/dataset.py          1.02     12.7±0.18ms     3.2 MB/sec    1.00     12.4±0.11ms     3.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.03      3.5±0.03ms     4.8 MB/sec    1.00      3.4±0.04ms     4.9 MB/sec
linter/all-rules/numpy/globals.py          1.04    440.1±6.78µs     6.7 MB/sec    1.00    422.3±5.29µs     7.0 MB/sec
linter/all-rules/pydantic/types.py         1.16      6.6±0.12ms     3.9 MB/sec    1.00      5.7±0.05ms     4.5 MB/sec
linter/default-rules/large/dataset.py      1.05      7.0±0.07ms     5.8 MB/sec    1.00      6.6±0.06ms     6.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.07  1478.7±19.15µs    11.3 MB/sec    1.00  1385.0±17.12µs    12.0 MB/sec
linter/default-rules/numpy/globals.py      1.11    175.1±4.49µs    16.8 MB/sec    1.00    158.1±2.14µs    18.7 MB/sec
linter/default-rules/pydantic/types.py     1.05      3.1±0.05ms     8.2 MB/sec    1.00      3.0±0.03ms     8.6 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-08-11 11:16</div>
            <div class="timeline-body"><p>The original implementation was to complex, we only need to track the parent and the current node, the last child in the parent. If the indentation is less, assign to the parent. If it is equal, assign to the current node. If it is greater, try doing a recursion step where we look at the children of the current node. If a comment is half-indented, the indentation is first greater and then less, i.e. we assign it to the parent/less indented node.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @konstin on 2023-08-11 11:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2023-08-11 11:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-12-01 23:46</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:59:27 UTC
    </footer>
</body>
</html>
