<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Add `Symbol::or_fall_back_to_if` - astral-sh/ruff #15931</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Add <code>Symbol::or_fall_back_to_if</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15931">#15931</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-02-04 13:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body">Summary
<p>This PR replaces introduces a new API, <code>Symbol::or_fall_back_to_if()</code>. The new API replaces two existing methods on <code>Symbol</code>: <code>Symbol::possibly_unbound()</code> and <code>Symbol::or_fall_back_to()</code>, as well as <code>Boundness::or()</code>.</p>
<p>The new API allows us to elegantly chain a series of fallback symbol-lookups. It also means we&#x27;re lazy by default (I realized we were eagerly executing several <code>ModuleType::to_class_literal(db).member(db, name)</code> calls which would be immediately thrown away in several situations). Lastly, it means that in some situations we construct union types where the elements are arranged in a more intuitive order than we currently have on <code>main</code>.</p>
Test Plan
<p><code>cargo test -p red_knot_python_semantic</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-04 13:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-04 13:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-04 13:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-04 13:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-04 13:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:271 on 2025-02-04 13:20</div>
            <div class="timeline-body"><p>(Came here to do the TODO, ended up making this PR instead)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-04 13:26</div>
            <div class="timeline-body"><p><a href="https://codspeed.io/astral-sh/ruff/branches/alex%2Ffallback-if">Neutral on codspeed</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/symbol.rs</code>:71 on 2025-02-04 13:34</div>
            <div class="timeline-body"><p>Nit: Just <code>or_else</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-04 13:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-04 13:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/symbol.rs</code>:71 on 2025-02-04 13:34</div>
            <div class="timeline-body"><p>Never mind, it also accepts a condition</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-04 13:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/symbol.rs</code>:71 on 2025-02-04 13:37</div>
            <div class="timeline-body"><p>The <code>Option</code> API for this would be:</p>
<p><code>symbol.bound().filter(condition).unwrap_or_else(fallback)</code></p>
<p>However, that doesn&#x27;t work because the <code>b</code> case sometimes falls back to <code>self</code> and sometimes to the <code>fallback</code>. It still makes me wonder if we can decompose this operation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-04 13:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/symbol.rs</code>:71 on 2025-02-04 13:47</div>
            <div class="timeline-body"><p>I wondered about a version of this where we kept <code>Symbol::fall_back_to()</code> and implemented <code>Symbol::fall_back_to_if()</code> as a wrapper around <code>Symbol::fall_back_to()</code>:</p>
<pre><code>impl&lt;&#x27;db&gt; Symbol&lt;&#x27;db&gt; {
    fn or_fall_back_to(self, db, &amp;&#x27;db dyn Db, fallback: Symbol&lt;&#x27;db&gt;) -&gt; Self {
        match (&amp;self, &amp;other) {
            (Symbol::Type(_, Boundness::Bound), _) | (_, Symbol::Unbound) =&gt; self,
            (Symbol::Unbound, _) =&gt; other,
            (Symbol::Type(self_ty, _), (Symbol::Type(fallback_ty, fallback_boundness) =&gt; Symbol::Type(
                UnionType::from_elements(db, [self_ty, fallback_ty]),
                *fallback_boundness
            )
        }
    }

    fn or_fall_back_to_if(
        self,
        db: &amp;&#x27;db dyn Db,
        condition: impl FnOnce() -&gt; bool,
        fallback_fn: impl FnOnce() -&gt; Symbol&lt;&#x27;db&gt;,
    ) -&gt; Self {
        if self.possibly_unbound() &amp;&amp; condition() {
            self.or_fall_back_to(fallback_fn())
        } else {
            self
        }
    }
}
</code></pre>
<p>I don&#x27;t like this much, though. The <code>self.possibly_unbound()</code> call goes through another <code>match</code> expression which is redundant. We can do it in one <code>match</code>, which I find more readable (there&#x27;s less indirection). <code>Symbol::or_fall_back_to()</code> would also <em>only</em> be used by this one method (<code>Symbol::or_fall_back_to_if()</code>) if we did it like this; <code>Symbol::or_fall_back_to_if()</code> seems better for all our current use cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[red-knot] Add `Symbol::fall_back_to_if`&quot; to &quot;[red-knot] Add `Symbol::or_fall_back_to_if`&quot; by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-04 13:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-04 15:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/symbol.rs</code>:71 on 2025-02-04 15:09</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/compare/alex/symbol-fallback-builder?expand=1 is an alternative API, which in some ways I like more. What do you think of that?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-04 17:32</div>
            <div class="timeline-body"><p>#15943 is a competing PR to this, which I think I like more overall...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-04 17:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/symbol.rs</code>:71 on 2025-02-04 17:33</div>
            <div class="timeline-body"><p>(opened #15943)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-05 14:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-05 14:48</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:11:06 UTC
    </footer>
</body>
</html>
