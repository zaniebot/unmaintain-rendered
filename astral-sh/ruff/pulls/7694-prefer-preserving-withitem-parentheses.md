```yaml
number: 7694
title: "Prefer preserving `WithItem` parentheses"
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: with-item-parentheses
created_at: 2023-09-28T10:26:51Z
updated_at: 2023-09-28T13:42:42Z
url: https://github.com/astral-sh/ruff/pull/7694
synced_at: 2026-01-12T02:39:10Z
```

# Prefer preserving `WithItem` parentheses

---

_Pull request opened by @MichaReiser on 2023-09-28 10:26_

## Summary

This PR fixes a deviation to Black when formatting `WithItem`s.

```python
if True:
    with anyio.CancelScope(shield=True) if get_running_loop() else contextlib.nullcontext() as b:
        pass
    
    with (anyio.CancelScope(shield=True) if get_running_loop() else contextlib.nullcontext()):
        pass
```

Black formats this as:

```python
if True:
    with anyio.CancelScope(
        shield=True
    ) if get_running_loop() else contextlib.nullcontext() as b:
        pass

    with (
        anyio.CancelScope(shield=True)
        if get_running_loop()
        else contextlib.nullcontext()
    ):
        pass
```

Notice that the two examples are identical except that the second example has parentheses around the with context expression. 

Ruff formats both examples as if the context expression is not parenthesized:

```python
if True:
    with anyio.CancelScope(
        shield=True
    ) if get_running_loop() else contextlib.nullcontext() as b:
        pass
```

This PR uses the `IfBreaks` layout that prefers parenthesizing the context manager when it is already parenthesized in source, aligning the behavior with black.


Closes #7441 

## Test Plan

Added tests. I reviewed the changes and they now match black's formatting. 

The similarity index remains unchanged.


---

_Comment by @MichaReiser on 2023-09-28 10:27_

Current dependencies on/for this PR:
* main
  * **PR #7694** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7694" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7694?utm_source=stack-comment).

---

_Label `formatter` added by @MichaReiser on 2023-09-28 11:47_

---

_Marked ready for review by @MichaReiser on 2023-09-28 11:47_

---

_@charliermarsh approved on 2023-09-28 13:08_

---

_Renamed from "Prefer preserving `WithItem` parenthese" to "Prefer preserving `WithItem` parentheses" by @charliermarsh on 2023-09-28 13:08_

---

_Merged by @MichaReiser on 2023-09-28 13:42_

---

_Closed by @MichaReiser on 2023-09-28 13:42_

---

_Branch deleted on 2023-09-28 13:42_

---
