<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Box `BindingKind` enum variants - astral-sh/ruff #4263</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Box <code>BindingKind</code> enum variants</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4263">#4263</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-05-07 03:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-07 03:52</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Boxing the variants reduces the enum size from 48 bytes to 8 bytes. Need to do some deeper profiling to understand whether the tradeoffs here are favorable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-07 04:28</div>
            <div class="timeline-body"><p>I thought this would have a bigger impact. Best I can tell, it's <em>maybe</em> a hair faster but not a significant difference.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-05-07 04:29</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     14.0±0.14ms     2.9 MB/sec    1.00     13.9±0.08ms     2.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.4±0.01ms     5.0 MB/sec    1.00      3.3±0.01ms     5.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    412.6±0.71µs     7.2 MB/sec    1.00    411.4±0.65µs     7.2 MB/sec
linter/all-rules/pydantic/types.py         1.01      5.8±0.02ms     4.4 MB/sec    1.00      5.8±0.02ms     4.4 MB/sec
linter/default-rules/large/dataset.py      1.00      6.9±0.02ms     5.9 MB/sec    1.01      6.9±0.03ms     5.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1477.0±2.65µs    11.3 MB/sec    1.00   1483.6±1.94µs    11.2 MB/sec
linter/default-rules/numpy/globals.py      1.00    161.5±0.28µs    18.3 MB/sec    1.01    163.8±0.62µs    18.0 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.1±0.01ms     8.3 MB/sec    1.01      3.1±0.01ms     8.3 MB/sec
parser/large/dataset.py                    1.00      5.4±0.00ms     7.5 MB/sec    1.01      5.5±0.01ms     7.4 MB/sec
parser/numpy/ctypeslib.py                  1.00   1053.3±0.69µs    15.8 MB/sec    1.01   1063.5±1.46µs    15.7 MB/sec
parser/numpy/globals.py                    1.00    106.5±0.31µs    27.7 MB/sec    1.01    107.6±0.18µs    27.4 MB/sec
parser/pydantic/types.py                   1.00      2.3±0.00ms    11.0 MB/sec    1.00      2.3±0.00ms    11.0 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.01     16.5±0.20ms     2.5 MB/sec    1.00     16.3±0.19ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      4.2±0.04ms     4.0 MB/sec    1.00      4.1±0.04ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.00    488.6±9.35µs     6.0 MB/sec    1.00    488.9±6.26µs     6.0 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.9±0.10ms     3.7 MB/sec    1.00      6.9±0.07ms     3.7 MB/sec
linter/default-rules/large/dataset.py      1.00      8.2±0.06ms     4.9 MB/sec    1.01      8.3±0.05ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1735.9±14.14µs     9.6 MB/sec    1.02  1768.1±21.52µs     9.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    192.7±2.91µs    15.3 MB/sec    1.03   198.7±10.25µs    14.8 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.7±0.03ms     6.9 MB/sec    1.01      3.7±0.08ms     6.8 MB/sec
parser/large/dataset.py                    1.02      6.8±0.04ms     6.0 MB/sec    1.00      6.7±0.03ms     6.1 MB/sec
parser/numpy/ctypeslib.py                  1.01  1292.6±14.22µs    12.9 MB/sec    1.00  1276.5±15.02µs    13.0 MB/sec
parser/numpy/globals.py                    1.01    132.3±2.19µs    22.3 MB/sec    1.00    131.6±1.94µs    22.4 MB/sec
parser/pydantic/types.py                   1.02      2.9±0.05ms     8.8 MB/sec    1.00      2.8±0.04ms     9.0 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-05-07 04:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-07 04:31</div>
            <div class="timeline-body"><p>\cc @MichaReiser - you may find these results interesting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-05-08 11:45</div>
            <div class="timeline-body"><blockquote>
<p>\cc @MichaReiser - you may find these results interesting.</p>
</blockquote>
<p>I don't find the results very unexpected. The main issue is that the change exchanges the cost of writing and reading larger data structures with the cost of heap allocating, dereferencing, and decreased cache-locality.</p>
<p>The change also only reduces the size from 112 bytes to 82 bytes, which is still more than a single cache line.</p>
<p>Are there any usage patterns that we can make use of? For example, do we write the binding more often than read the <code>FromImportation</code>? If so, could we only store the start position (<code>TextSize</code>) and use a binary search to find it by traversing the AST or list of statements?</p>
<p>Or could we store the <code>StmtId</code> instead?</p>
<p>Other mechanisms that we could try is to store some of the optional metadata outside of the <code>Binding</code> (<code>runtime_usage</code>, <code>typing_usage</code>, <code>synthetic_usage</code>, <code>Exceptions</code>), especially if most <code>Binding</code>s have all these values set to <code>None</code>.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 03:57:15 UTC
    </footer>
</body>
</html>
