<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use cargo-binstall to fast install critcmp for benchmark-compare - astral-sh/ruff #3637</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use cargo-binstall to fast install critcmp for benchmark-compare</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/3637">#3637</a>
        opened by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a>
        on 2023-03-20 23:17
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JonathanPlasse">@JonathanPlasse</a></div>
            <div class="timeline-body"><p><em>No description provided.</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-03-20 23:30</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>✅ ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.01     14.0±0.18ms     2.9 MB/sec    1.00     13.9±0.04ms     2.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.02      3.8±0.08ms     4.4 MB/sec    1.00      3.7±0.00ms     4.5 MB/sec
linter/all-rules/numpy/globals.py          1.00    429.5±1.48µs     6.9 MB/sec    1.00   431.2±12.27µs     6.8 MB/sec
linter/all-rules/pydantic/types.py         1.01      6.3±0.05ms     4.1 MB/sec    1.00      6.2±0.01ms     4.1 MB/sec
linter/default-rules/large/dataset.py      1.01      7.8±0.16ms     5.2 MB/sec    1.00      7.7±0.09ms     5.3 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.02   1697.7±2.00µs     9.8 MB/sec    1.00  1671.0±18.57µs    10.0 MB/sec
linter/default-rules/numpy/globals.py      1.01    175.7±0.77µs    16.8 MB/sec    1.00    174.6±1.22µs    16.9 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.6±0.02ms     7.0 MB/sec    1.00      3.6±0.02ms     7.1 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     19.7±0.75ms     2.1 MB/sec    1.02     20.1±0.74ms     2.0 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.03      5.3±0.21ms     3.1 MB/sec    1.00      5.2±0.18ms     3.2 MB/sec
linter/all-rules/numpy/globals.py          1.00   659.1±34.14µs     4.5 MB/sec    1.00   656.4±28.50µs     4.5 MB/sec
linter/all-rules/pydantic/types.py         1.00      8.4±0.34ms     3.0 MB/sec    1.04      8.8±0.34ms     2.9 MB/sec
linter/default-rules/large/dataset.py      1.00     11.1±0.47ms     3.7 MB/sec    1.05     11.6±0.44ms     3.5 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00      2.3±0.16ms     7.1 MB/sec    1.03      2.4±0.09ms     6.9 MB/sec
linter/default-rules/numpy/globals.py      1.00   269.7±14.84µs    10.9 MB/sec    1.03   277.9±17.42µs    10.6 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.8±0.16ms     5.3 MB/sec    1.07      5.1±0.21ms     5.0 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @charliermarsh on 2023-03-20 23:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @charliermarsh on 2023-03-20 23:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>.github/workflows/benchmark.yaml</code>:29 on 2023-03-21 07:38</div>
            <div class="timeline-body"><p>whoops, thx</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>.github/workflows/benchmark.yaml</code>:81 on 2023-03-21 08:36</div>
            <div class="timeline-body"><p>I considered adding rust-cache to the critcmp step but decided against it because GitHub limits the cache per repository to 10GB. That means GitHub starts evicting cached artifacts once we exceed the 10GB limit. You can see all our cache artifacts <a href="https://github.com/charliermarsh/ruff/actions/caches">here</a>.</p>
<p>Now, the reason I excluded <code>critcmp</code> was to avoid adding yet another cache (where each cache is around 600MB) that results in the eviction of other cached artifacts (e.g., for the clippy process) because I thought having warm caches for clippy is more important than for the benchmark results.</p>
<p>I don't know if that's the right call, nor have I verified my assumption that caching the c<code>ritcmp</code> build causes any build time regression for other jobs. So happy to give it a try. But do we need to built <code>critcmp</code> in the first place...</p>
<p>I researched more to find ways to avoid building <code>critcmp</code> altogether. I was excited when I read that <a href="https://www.tweag.io/blog/2022-03-03-criterion-rs/">criterion 0.4</a> has built-in tabulating. No need to use <code>critcmp</code>, we can generate the comparison directly in the benchmark step. Unfortunately, they <a href="https://github.com/bheisler/criterion.rs/pull/610">removed tabulating</a> before the release in favor of adding it to <a href="https://github.com/bheisler/cargo-criterion"><code>cargo-criterion</code></a>. I tried <code>cargo criterion</code> locally, but the feature doesn't seem to exist, and even if it does, we would only be switching one dependency for another.</p>
<p>So what if we could avoid running <code>cargo install</code> altogether? Can we download the <code>critcmp</code> binary or cache it somehow? That's when I discovered <a href="https://github.com/cargo-bins/cargo-binstall"><code>cargo-binstall</code></a>. It installs binaries rather than building the crates from source... yay! Uhm, okay, but how do we install <code>cargo-binstall</code>?</p>
<p><code>cargo-binstall</code> recommends using <a href="https://github.com/marketplace/actions/install-development-tools">install-development-tools</a>: <code>uses: taiki-e/install-action@cargo-binstall</code>. All that's left to do is to run <code>cargo binstall critcmp</code> (maybe figure out the right options)</p>
<p>~~Luckily <code>cargo-binstall</code> publishes prebuilt binaries on GitHub and there are even a github actions to download binaries from the release page (<a href="https://github.com/marketplace/actions/release-downloader">release-downloader</a> or <a href="https://github.com/dtolnay/install"><code>dtonlay/install</code></a>). Alternatively, we could just use <code>curl</code> or <code>wget</code> to get the binary. Do you want to give this at try?~~</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-03-21 08:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> reviewed on 2023-03-21 08:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on <code>.github/workflows/benchmark.yaml</code>:81 on 2023-03-21 08:42</div>
            <div class="timeline-body"><p>Yes!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on <code>.github/workflows/benchmark.yaml</code>:81 on 2023-03-21 12:18</div>
            <div class="timeline-body"><p>Currently, <code>critcmp</code> does not seem to have prebuilt binaries on GitHub.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> reviewed on 2023-03-21 12:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-03-21 12:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>.github/workflows/benchmark.yaml</code>:81 on 2023-03-21 12:21</div>
            <div class="timeline-body"><p>This shouldn't be necessary as far as I understand. You can use <code>cargo binstall</code> to install <code>critcmp</code>. It uses the <a href="https://github.com/cargo-bins/cargo-quickinstall"><code>quickinstall</code></a> registry under the hood that provides pre-built binaries (at least it works on my linux machine)</p>
<pre><code class="language-sh">❯ cargo binstall critcmp -y
 INFO resolve: Resolving package: 'critcmp'
 WARN The package critcmp v0.1.7 will be downloaded from third-party source QuickInstall
 INFO This will install the following binaries:
 INFO   - critcmp (critcmp -&gt; /home/micha/.cargo/bin/critcmp-v0.1.7)
 INFO And create (or update) the following symlinks:
 INFO   - critcmp (/home/micha/.cargo/bin/critcmp -&gt; critcmp-v0.1.7)
 INFO Installing binaries...
 INFO Done in 2.070975169s
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-03-21 13:42</div>
            <div class="timeline-body"><p>3s instead of 2m3s to install <code>critcmp</code>!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-03-21 13:44</div>
            <div class="timeline-body"><blockquote>
<p>3s instead of 2m3s to install <code>critcmp</code>!</p>
</blockquote>
<p>Whooohoo nice :partying_face: ! Thanks for working on this.</p>
<p>@Boshen some more benchmark CI performance improvements ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-03-21 13:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-03-21 13:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-03-21 13:45</div>
            <div class="timeline-body"><p>Whoops, I should have changed the title before merging... Too late :no_good:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-03-21 13:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JonathanPlasse">@JonathanPlasse</a> on 2023-03-21 14:01</div>
            <div class="timeline-body"><p>Should it be revert and merge again with the good title?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Add Swatinem/rust-cache to benchmark-compare job" to "Use cargo-binstall to fast install critcmp for benchmark-compare" by @JonathanPlasse on 2023-03-21 14:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-03-21 14:06</div>
            <div class="timeline-body"><blockquote>
<p>Should it be revert and merge again with the good title?</p>
</blockquote>
<p>I think we're good. There are more fun things to do, and it isn't that bad in my view. The title may be misleading because the implementation is different but it correctly points out which part of the system was changed, and the PR contains all details.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:56:44 UTC
    </footer>
</body>
</html>
