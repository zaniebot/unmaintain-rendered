<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add a `SourceFile` to `OldDiagnostic` - astral-sh/ruff #18356</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add a <code>SourceFile</code> to <code>OldDiagnostic</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18356">#18356</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-05-28 18:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a></div>
            <div class="timeline-body">Summary
<p>This is the last main difference between the <code>OldDiagnostic</code> and <code>Message</code>
types, so attaching a <code>SourceFile</code> to <code>OldDiagnostic</code> should make combining the
two types almost trivial.</p>
<p>Initially I updated the remaining rules without access to a <code>Checker</code>  to take a
<code>&amp;SourceFile</code> directly, but after Micha&#x27;s suggestion in <a href="https://github.com/astral-sh/ruff/pull/18356">astral-sh/ruff#18356</a>#discussion_r2113281552, I updated all of these calls to take a
<code>LintContext</code> instead. This new type is a thin wrapper around a <code>RefCell&lt;Vec&lt;OldDiagnostic&gt;&gt;</code>
and a <code>SourceFile</code> and now has the <code>report_diagnostic</code> method returning a <code>DiagnosticGuard</code> instead of <code>Checker</code>.
This allows the same <code>Drop</code>-based implementation to be used in cases without a <code>Checker</code> and also avoids a lot of intermediate allocations of <code>Vec&lt;OldDiagnostic&gt;</code>s.</p>
<p><code>Checker</code> now also contains a <code>LintContext</code>, which it defers to for its <code>report_diagnostic</code> methods, which I preserved for convenience.</p>
Test Plan
<p>Existing tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-28 18:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-28 18:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-05-28 18:44</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-28 19:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-28 19:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/AlexWaygood">@AlexWaygood</a> removed by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-28 19:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-28 19:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/linter.rs</code>:122 on 2025-05-29 06:03</div>
            <div class="timeline-body"><p>This is a bit unfortunate, because <code>SourceFile</code>&#x27;s index is lazy too. But I also don&#x27;t see an easy way to share the line index. So I think this is fine (It&#x27;s also very rare now that we access the line index during linting. We needed it before we changed from <code>row</code>/<code>column</code> positions to <code>TextRane</code>.)</p>
<p>It could make sense (can be a follow up PR/issue to do it later) to investigate if we can remove <code>locator.line_index</code> and instead use <code>source_file</code> everywhere. We could even consider implementing <code>Located</code> on source file, which should allow us to replace most <code>Locator</code> usages.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/linter.rs</code>:115 on 2025-05-29 06:04</div>
            <div class="timeline-body"><p>I think the <code>LazyCell</code> here is mostly useless because you always dereference it when calling <code>check_tokens</code>, <code>check_file_path</code>. We should probably just build it eagerly</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pycodestyle/rules/logical_lines/whitespace_before_parameters.rs</code>:80 on 2025-05-29 06:11</div>
            <div class="timeline-body"><p>Nit: We could consider to have a <code>context.report_diagnostic</code> method that returns the same guard as <code>checker.report_diagnostic</code> but I think this is fine too</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/type_comment_in_stub.rs</code>:45 on 2025-05-29 06:12</div>
            <div class="timeline-body"><p>Nit: We could consider introducing a <code>DiagnosticsCollector</code> or similar which is a thin wrapper around a <code>Vec&lt;OldDIagnostic&gt;</code> and <code> SourceFile</code> with a <code>report_diagnostic</code> method. This would avoid introducing more arguments and would allow us to use the same pattern in more places.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-05-29 06:17</div>
            <div class="timeline-body"><p>This looks good. The only annoyance is that this introduces a new argument to so many functions. It may be worth checking if we can replace some <code>Locator</code> usages by using <code>SourceFile</code> instead (<code>str</code> implements <code>Located</code> which gives access to most methods on <code>Locator</code>))</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-29 12:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pycodestyle/rules/logical_lines/whitespace_before_parameters.rs</code>:80 on 2025-05-29 12:42</div>
            <div class="timeline-body"><p>I did consider that briefly, but I thought it might be annoying to make the guard generic over the context type. I think your <code>DiagnosticsCollector</code> idea below could help with that too, though! I&#x27;ll give it a try.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-29 12:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/linter.rs</code>:122 on 2025-05-29 12:46</div>
            <div class="timeline-body"><p>Ahh okay, that makes sense. I did notice that <code>Locator</code> was passed pretty much everywhere <code>SourceFile</code> was. I thought a little bit about storing the <code>SourceFile</code> <em>in</em> <code>Locator</code> but not about replacing <code>Locator</code>. This sounds interesting to try too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-05-29 12:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pycodestyle/rules/logical_lines/whitespace_before_parameters.rs</code>:80 on 2025-05-29 12:53</div>
            <div class="timeline-body"><p>Oh, I haven&#x27;t thoubht about the context. Yeah, that could be annoying</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-29 18:32</div>
            <div class="timeline-body"><p>I ran with your suggestion about the <code>DiagnosticsCollector</code> and replaced pretty much all of the places I had previously passed a <code>&amp;SourceFile</code>. This seems quite a bit nicer, and we get to use the new guard API too. I also opened #18376 to track the <code>Locator</code> idea. The new commits are PR-sized on their own, so this could probably use another review if you want.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:240 on 2025-05-29 21:00</div>
            <div class="timeline-body"><p>Nit. Maybe rename to diagnostics. It&#x27;s the more important part of the name</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:2964 on 2025-05-29 21:01</div>
            <div class="timeline-body"><p>Same here and in other places. Rename to diagnostics</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/checkers/noqa.rs</code>:50 on 2025-05-29 21:08</div>
            <div class="timeline-body"><p>I think this api opens the door for multiple mutable borrows. First when calling with_diagnostics and then when calling report_diagnostics on the collector. I think I would instead add an as_mut_slice method that takes a mut self. The method here should then also require no changes</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:3103 on 2025-05-29 21:10</div>
            <div class="timeline-body"><p>I think this method should take a mut self to avoid mutable borrows (eg by calling collectir.report from inside the callback)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:3110 on 2025-05-29 21:11</div>
            <div class="timeline-body"><p>Same, ideally this would take a mut self</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-05-29 21:11</div>
            <div class="timeline-body"><p>I haven&#x27;t done a full review but here some thoughts</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-29 21:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:240 on 2025-05-29 21:35</div>
            <div class="timeline-body"><p>Ah okay, that makes sense. I replaced all of them!</p>
<p>Do you think <code>diagnostics.report_diagnostic</code> is too repetitive? And <code>diagnostics.into_diagnostics</code>, though that one is much less common.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-29 21:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/noqa.rs</code>:50 on 2025-05-29 21:38</div>
            <div class="timeline-body"><p>Thanks, these all make sense. I saw <code>RefCell</code> and just made everything <code>&amp;self</code> without thinking about this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-29 21:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/noqa.rs</code>:50 on 2025-05-29 21:48</div>
            <div class="timeline-body"><p>Actually, I may be slightly misunderstanding in this case. What do you mean by the <code>as_mut_slice</code> method? I tried writing</p>
<pre><code>pub(crate) fn as_mut_slice(&amp;mut self) -&gt; &amp;mut [OldDiagnostic] {
    self.diagnostics.borrow_mut().as_mut_slice()
}
</code></pre>
<p>but the temporary value from <code>borrow_mut</code> is dropped in the function and can&#x27;t be returned. This is actually the original problem I ran into. All I really wanted was to call <code>self.diagnostics.borrow().iter()</code>, but the borrow gets dropped. That&#x27;s what led me to add <code>with_diagnostics</code>.</p>
<p>For now I&#x27;ve just updated <code>with_diagnostics</code> to take a <code>&amp;mut self</code> like <code>retain</code> and <code>swap_remove</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-05-30 05:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/checkers/noqa.rs</code>:50 on 2025-05-30 05:45</div>
            <div class="timeline-body"><p>You can use <code>self.diagnostics.get_mut</code> when you have a <code>&amp;self mut</code> because the borrow checker than guarantees that no one else can be mutating <code>diagnostic</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-05-30 05:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:240 on 2025-05-30 05:47</div>
            <div class="timeline-body"><p>It&#x27;s not ideal for sure :) I also thought about <code>LintContext</code> That would allow us to put more stuff on it that&#x27;s needed by all lint rules and isn&#x27;t directly tied to <code>Checker</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-30 11:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/noqa.rs</code>:50 on 2025-05-30 11:36</div>
            <div class="timeline-body"><p>Oh :facepalm: Thank you!</p>
<p>I think I&#x27;ll just replace all of these helper methods with an <code>as_mut</code> method. Some of them actually need the <code>Vec</code>, so I&#x27;m thinking either <code>as_mut_vec</code> or maybe <code>as_diagnostics</code> for the name.</p>
<p>I also added an <code>iter</code> method, also using <code>get_mut</code>, just to avoid having to call <code>as_mut_vec().iter()</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-30 11:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:240 on 2025-05-30 11:37</div>
            <div class="timeline-body"><p>I like that. I can do one more rename to <code>LintContext</code> and update the variable names to <code>context</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/linter.rs</code>:120 on 2025-05-30 13:25</div>
            <div class="timeline-body"><p>We can probably just remove this. At this point, it&#x27;s almost guaranteed that the line index is <code>none</code> (unless I&quot;m mistaken)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-05-30 13:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-30 13:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-30 13:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-05-30 13:34</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:15:00 UTC
    </footer>
</body>
</html>
