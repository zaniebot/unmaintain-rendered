<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unify `OldDiagnostic` and `Message` - astral-sh/ruff #18391</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Unify <code>OldDiagnostic</code> and <code>Message</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18391">#18391</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-05-30 19:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR unifies the remaining differences between <code>OldDiagnostic</code> and
<code>Message</code> (<code>OldDiagnostic</code> was only missing an optional <code>noqa_offset</code> field) and
replaces <code>Message</code> with <code>OldDiagnostic</code>.</p>
<p>The biggest functional difference is that the combined <code>OldDiagnostic</code> kind no
longer implements <code>AsRule</code> for an infallible conversion to <code>Rule</code>. This was
pretty easy to work around with <code>is_some_and</code> and <code>is_none_or</code> in the few places
it was needed. In <code>LintContext::report_diagnostic_if_enabled</code> we can just use
the new <code>Violation::rule</code> method, which takes care of most cases.</p>
<p>Most of the interesting changes are in <a href="https://github.com/astral-sh/ruff/pull/18391/files/8156992540f4e81f914a9534e99241b1e14382a1">this range</a> before I started renaming.</p>
<h2>Test Plan</h2>
<p>Existing tests</p>
<h2>Future Work</h2>
<p>I think it's time to start shifting some of these fields to the new <code>Diagnostic</code>
kind. I believe we want <code>Fix</code> for sure, but I'm less sure about the others. We
may want to keep a thin wrapper type here anyway to implement a <code>rule</code> method,
so we could leave some of these fields on that too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @ntBre on 2025-05-30 19:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by @ntBre on 2025-05-30 19:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-30 19:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/message/mod.rs</code>:176 on 2025-05-30 19:31</div>
            <div class="timeline-body"><p>It might be time to update the call sites.</p>
<p>With the exception of this method itself, I think the rest of this hunk was moved from <code>diagnostic.rs</code> with no changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-05-30 19:33</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_INSTRUMENTATION_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/brent%2Fcombine-message-diagnostic?runnerMode=Instrumentation">CodSpeed Instrumentation Performance Report</a></h2>
<h3>Merging #18391 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>brent/combine-message-diagnostic</code> (52a54a9) with <code>main</code> (4e83db4)</sub></p>
<h3>Summary</h3>
<p><code>✅ 37</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-05-30 19:33</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/tokens.rs</code>:178 on 2025-05-30 19:34</div>
            <div class="timeline-body"><p>Looking at this again, maybe these should all be <code>is_some_and</code>. I don't think it actually matters because they should all be lint diagnostics, not syntax errors, at this point, but <code>is_none_or</code> would retain syntax errors if they were ever present at this point.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-05-30 19:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-30 19:45</div>
            <div class="timeline-body"><p>Well the benchmark results are disappointing, but we're still ahead of where we were before #18234:</p>
<p>|    | Benchmark                                                | Change  | #18234  |
|----|----------------------------------------------------------|---------|---------|
| ❌ | <code>linter/all-rules[numpy/globals.py]</code>                 | -6.81%  | +7.9%   |
| ❌ | <code>linter/all-rules[pydantic/types.py]</code>                | -5.4%   | +7.04%  |
| ❌ | <code>linter/all-rules[unicode/pypinyin.py]</code>              | -13.82% | +21.11% |
| ❌ | <code>linter/all-with-preview-rules[numpy/ctypeslib.py]</code>  | -4.2%   | +6.13%  |
| ❌ | <code>linter/all-with-preview-rules[numpy/globals.py]</code>    | -5.47%  | +6.11%  |
| ❌ | <code>linter/all-with-preview-rules[pydantic/types.py]</code>   | -4.74%  | +6.49%  |
| ❌ | <code>linter/all-with-preview-rules[unicode/pypinyin.py]</code> | -12.77% | +20.21% |
| ❌ | <code>linter/all-rules[numpy/ctypeslib.py]</code>               | -3%     | +5.03%  |</p>
<p>I think I already went through all of the <code>to_rule</code> calls, but I'll look at the flamegraphs and see if I can find any improvements.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-30 21:12</div>
            <div class="timeline-body"><p>I haven't reviewed this but I think we should remove the rule method if possible (not as part of this pr)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-02 20:09</div>
            <div class="timeline-body"><p>Alright, we're finally back under the codspeed threshold, but the macro changes in the last commit feel potentially hacky to me. There are also still some ~2% perf regressions, but I think I handled all of the hot spots. The remaining new code in the flamegraphs looks pretty broadly distributed, which I think means it's just from the new <code>Diagnostic</code> construction.</p>
<p>One big thing I noticed is that all of the rules in <code>check_tokens</code> unconditionally push diagnostics and then a <code>retain</code> cleans them up at the end. Changing all of the <code>report_diagnostic</code> calls in that call graph to <code>report_diagnostic_if_enabled</code> should be a big help because both <code>Diagnostic</code> construction <em>and</em> the <code>to_rule</code> call in the final <code>retain</code> are expensive. But I think that's a better fit for a follow-up.</p>
<p>I'll leave this in draft because I'm a bit uncertain about the proc macro changes, especially, but I think it's ready for at least a quick review.</p>
<p>For a little more context on the proc macro changes, my goal was to make the conversion of <code>NoqaCode</code> to <code>Rule</code> less expensive by avoiding calling <code>Rule::from_code</code>:</p>
<p>https://github.com/astral-sh/ruff/blob/87a15f7e4cf328e6485cee98960d19f51a955ef4/crates/ruff_linter/src/registry.rs#L18-L26</p>
<p>which both requires formatting a <code>NoqaCode</code> into a <code>String</code> to call and then reparses the <code>NoqaCode</code> into its parts. I moved <code>Linter::common_prefix</code> out of the <code>RuleNamespace</code> trait so that it could become <code>const</code>, which enabled me to pass its output to the <code>match</code> in <code>generate_rule_to_code</code>.</p>
<p><code>Rule::from_code</code> was already faster than parsing a rule from a kebab-case rule name, which I saw in the performance report after https://github.com/astral-sh/ruff/pull/18391/commits/bba7f6df7112a1fbfca53b72a73b21ab3d27edb6. The macro changes drop the worst-case performance regression from -4.8% to -2%. That difference might be small enough not to mess with the macros anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/checkers/tokens.rs</code>:178 on 2025-06-03 06:43</div>
            <div class="timeline-body"><p>I didn't realize this before but it's pretty scary that <code>check_tokens</code> could remove diagnostics that were added outside <code>check_tokens</code> (we aren't in control of where the context comes from). I think we should refactor this and avoid pushing diagnostics that aren't enabled instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-03 06:52</div>
            <div class="timeline-body"><p>I skimmed through the changes and had two thoughts:</p>
<ul>
<li>Would it have been easier to replace the usages of <code>Message::to_rule</code> instead of trying to optimize its performance, given that this is probably something we want to do anyway (because we can't add <code>Rule</code> to <code>Diagnostic</code> or have it anywhere in our shared rendering logic). I skimmed through the usages and I think most places can easily be replaced by testing against the noqa code.</li>
<li>For the <code>noqa</code> code. One thing I mentioned in one of your previous PRs is that we could change the <code>NoqaCode</code> representation from <code>String, String</code> to <code>&amp;'static str, </code>usize<code>there the</code>usize is the split point between prefix and suffix. Using a pre-computed offset allows both <code>prefix</code> and <code>suffix</code> to return a <code>&amp;str</code> instead of a <code>String</code>. I'm not sure if this would have been helpful here.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-03 12:20</div>
            <div class="timeline-body"><p>Thanks for having a look!</p>
<blockquote>
<ul>
<li>Would it have been easier to replace the usages of <code>Message::to_rule</code> instead of trying to optimize its performance, given that this is probably something we want to do anyway</li>
</ul>
</blockquote>
<p>I tried that first, but my attempts turned out to be much larger refactors than expected or didn't help the performance like I hoped. For example, <a href="https://github.com/astral-sh/ruff/pull/18391/commits/d04d40dfc3dd2966ac00e3ae3992ec4fe6560635">this commit</a> was a slight regression from the commit before it and also made <code>cmp_fix</code> very awkward. This could still be the right approach since we'll need it later, though, like you said.</p>
<blockquote>
<ul>
<li>For the <code>noqa</code> code. One thing I mentioned in one of your previous PRs is that we could change the <code>NoqaCode</code> representation from <code>String, String</code> to <code>&amp;'static str, </code>usize<code>there the</code>usize is the split point between prefix and suffix. Using a pre-computed offset allows both <code>prefix</code> and <code>suffix</code> to return a <code>&amp;str</code> instead of a <code>String</code>. I'm not sure if this would have been helpful here.</li>
</ul>
</blockquote>
<p>Ah I did forget about that one. I tried using <code>NoqaCode(Linter, &amp;'static str)</code> instead of the current <code>NoqaCode(&amp;'static str, &amp;'static str)</code>, but not <code>(&amp;str, usize)</code>.</p>
<p>I can give both of these another try, but I'll probably start in a separate PR since I think they can be handled separately.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-05 19:54</div>
            <div class="timeline-body"><p>I spent a while today looking into refactoring <code>NoqaCode</code> to be a <code>(&amp;'static str, usize)</code>, and I think it's basically impossible. The <code>Linter::common_prefix</code> code is generated in the <code>RuleNamespace</code> derive macro, while the rest of the rule code is generated in the <code>map_codes</code> macro, so there's nowhere that has access to both the prefix and suffix strings to generate a single <code>&amp;'static str</code> combining them.</p>
<p>Even with a const <code>common_prefix</code> method like I added here, we can't actually call that const function in the macro, so we still can't get access to it at macro-expansion time. We can get two separate const <code>&amp;'static str</code>s, but I don't believe there's any way to combine them, at least without some wild transmutes through byte arrays, which is what the crates I found mentioning this did.</p>
<p>I think I need to do one more pass here to check the sites of <code>to_rule</code> calls[^1] that were added as part of the <code>OldDiagnostic</code> and <code>Message</code> merger to see if it's worth keeping the macro changes that added <code>NoqaCode::rule</code>, but otherwise this is up to date and the perf looks even better than before (worst case is -1%, down from -2%).</p>
<p>[^1]: To clarify, <code>to_rule</code> is still removed, they were added here before I rebased on the PR removing them, and I replaced them with <code>noqa_code().and_then(|code| code.rule())</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-17 20:05</div>
            <div class="timeline-body"><p>I rebased on main and reverted the proc macro changes to see if they really help the benchmarks now or not.</p>
<p>Edit: then I dropped the revert again since reverting caused an 8.7% perf regression.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-06-18 12:46</div>
            <div class="timeline-body"><p>With #18736 on hold for now, I think this is ready for review.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @ntBre on 2025-06-18 12:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @ntBre on 2025-06-18 12:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @ntBre on 2025-06-18 12:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @ntBre on 2025-06-18 12:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/message/mod.rs</code>:65 on 2025-06-18 13:06</div>
            <div class="timeline-body"><p>One challenge with the approach you've taken here is that I don't think we can store a <code>NoqaCode</code> on <code>ruff_db::Diagnostic</code>. Ideally, the type on the <code>ruff_db::Diagnostic</code> would just be a <code>String</code> or an otherwise mostly agnostic type.</p>
<p>I don't know how much that changes to your refactor. I guess we could call <code>Rule::from_code</code> in the places where we need to go back from code to <code>Rule</code>. I sort of would prefer this but I suspect that this would be slower because that requires actual parsing (and not just matching).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/linter.rs</code>:396 on 2025-06-18 13:35</div>
            <div class="timeline-body"><p>Could we account for <code>per_file_ignores</code> inside <code>report_diagnostic</code> instead of doing this post-filtering here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/linter.rs</code>:433 on 2025-06-18 13:37</div>
            <div class="timeline-body"><p>This would be a larger refactor, I think. But it would be somewhat nice if <code>diagnostic.build_fix</code> would return an <code>Option&lt;FixBuilder&gt;</code> that's only <code>Some</code> if we should generate a fix. But that's probably a larger refactor too. This would have the advantage that we still have a reference to <code>Rule</code> inside of <code>DiagnosticBuilder</code>. But I fear this would be another large and very painful refactor and I'm not sure if its' worth it.</p>
<p>Actually. I don't think that would work because we always want to generate a fix to show it to users even when it shouldn't get applied.... Although, looking at the code here I'm not sure if that's how Ruff currently works. Either way, I think this coudl simplify things actually...</p>
<p>Instead of what I wrote above. <code>DiagnosticBuilder::with_fix</code> or <code>set_fix</code> could still check if the fix should be applied and then wrap the <code>Fix</code> in a <code>FixWithFixability</code> which is an enum with two variants: <code>Fix(Fix)</code>, <code>DisplayOnly(Fix)</code> where <code>DisplayOnly</code> is a fix that we only want to show but not count in statistics or apply when applying code fixes.</p>
<p>Either way. I think that would be a separate refactor</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/linter.rs</code>:442 on 2025-06-18 13:42</div>
            <div class="timeline-body"><p>I guess, we could also eagerly resolve the applibabily during construction instead of doing it here.</p>
<p>Should this use <code>noqa_code</code> instead of <code>name().parse()</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/test.rs</code>:330 on 2025-06-18 13:44</div>
            <div class="timeline-body"><p>This is so confusing ... looking forward to have a single <code>print_diagnostics</code> function that prints all diagnostics.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_macros/src/map_codes.rs</code>:354 on 2025-06-18 13:45</div>
            <div class="timeline-body"><p>By how much does this blow up ruff's code size?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-06-18 13:47</div>
            <div class="timeline-body"><p>Thank you.</p>
<p>I think this is a step in the right direction. What's unclear to me is how we can avoid the <code>noqa_code.rule()</code> calls entirely (or in most cases). I left a few suggestions but that might require some more larger refactors (or maybe not?).</p>
<p>The reason why I think we should avoid <code>NoqaCode::rule</code> is because: a) it's slow and b) I don't think we should store a <code>NoqaCode</code> on <code>ruff_db::Diagnostic</code> (we can, but I would prefer not to)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/tokens.rs</code>:178 on 2025-06-18 15:52</div>
            <div class="timeline-body"><p>Yeah I looked into this a bit originally, and it's just a big refactor. Every rule reachable from this function needs to be updated to check if its rule is enabled before emitting a diagnostic. But it will make things simpler and more performant too. (And less scary, I didn't even consider dropping unrelated diagnostics before!)</p>
<p>I'll tackle that separately!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-18 15:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-18 15:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_macros/src/map_codes.rs</code>:354 on 2025-06-18 15:59</div>
            <div class="timeline-body"><p>I guess if there's one <code>NoqaCode</code> per rule and ~900 rules, this adds ~900 constants (which might get inlined?) and ~900 <code>match</code> arms. Is that a lot? I don't really have a good intuition for the effects of these kinds of changes on code size.</p>
<p>Anyway, I'm still hoping we can revert this part of the PR if we can recover the perf hits in other ways, hopefully from your other suggestions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-18 16:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_macros/src/map_codes.rs</code>:354 on 2025-06-18 16:02</div>
            <div class="timeline-body"><p>I suggest building ruff and comparing the binary sizes. You can also use https://github.com/RazrFalcon/cargo-bloat to get an understanding of the compiled code</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-18 16:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_macros/src/map_codes.rs</code>:354 on 2025-06-18 16:23</div>
            <div class="timeline-body"><p>I got these results from <code>du -b target/release/ruff</code>:</p>
<pre><code>41,559,344 bytes for main
41,669,840 bytes for this branch
</code></pre>
<p>so I guess this one is 110 kilobytes bigger. <code>NoqaCode::rule</code> does make an appearance in cargo-bloat too. <code>Rule::from_str</code> is present in both, so it would be nice if we ever get to remove that too.</p>
<details><summary>cargo-bloat output</summary>

<p>this branch:</p>
<pre><code> File  .text    Size               Crate Name
 0.2%   0.3% 76.0KiB         ruff_linter ruff_linter::checkers::ast::analyze::expression::expression
 0.1%   0.3% 72.1KiB                ruff &lt;ruff::args::CheckCommand as clap_builder::derive::Args&gt;::augment_args
 0.1%   0.2% 51.4KiB     ruff_workspace? &lt;ruff_workspace::options::_::&lt;impl serde::de::Deserialize for ruff_workspace::options::LintOptionsWire&gt;::deserialize::__Visitor as serde::de::Visitor&gt;::visit_map
 0.1%   0.2% 51.4KiB     ruff_workspace? &lt;ruff_workspace::options::_::&lt;impl serde::de::Deserialize for ruff_workspace::options::LintOptionsWire&gt;::deserialize::__Visitor as serde::de::Visitor&gt;::visit_map
 0.1%   0.2% 51.4KiB     ruff_workspace? &lt;ruff_workspace::options::_::&lt;impl serde::de::Deserialize for ruff_workspace::options::LintOptionsWire&gt;::deserialize::__Visitor as serde::de::Visitor&gt;::visit_map
 0.1%   0.2% 43.8KiB        ruff_linter? &lt;ruff_linter::codes::Rule as core::str::traits::FromStr&gt;::from_str
 0.1%   0.2% 39.8KiB         ruff_linter ruff_linter::checkers::ast::analyze::statement::statement
 0.1%   0.2% 35.7KiB     ruff_workspace? &lt;ruff_workspace::options::_::&lt;impl serde::de::Deserialize for ruff_workspace::options::LintOptionsWire&gt;::deserialize::__Visitor as serde::de::Visitor&gt;::visit_map
 0.1%   0.2% 35.7KiB     ruff_workspace? &lt;ruff_workspace::options::_::&lt;impl serde::de::Deserialize for ruff_workspace::options::LintOptionsWire&gt;::deserialize::__Visitor as serde::de::Visitor&gt;::visit_map
 0.1%   0.2% 35.3KiB         ruff_linter &lt;alloc::vec::Vec&lt;T,A&gt; as core::clone::Clone&gt;::clone
 0.1%   0.2% 35.1KiB ruff_python_codegen ruff_python_codegen::generator::Generator::unparse_stmt
 0.1%   0.1% 32.4KiB      ruff_workspace ruff_workspace::configuration::LintConfiguration::as_rule_table
 0.1%   0.1% 32.4KiB      ruff_workspace ruff_workspace::configuration::Configuration::into_settings
 0.1%   0.1% 31.3KiB         ruff_linter ruff_linter::checkers::ast::analyze::definitions::definitions
 0.1%   0.1% 31.3KiB         ruff_linter ruff_linter::checkers::ast::analyze::deferred_scopes::deferred_scopes
 0.1%   0.1% 31.2KiB         ruff_linter ruff_linter::codes::NoqaCode::rule
 0.1%   0.1% 30.8KiB      ruff_workspace ruff_workspace::configuration::Configuration::from_options
 0.1%   0.1% 29.8KiB       libcst_native libcst_native::parser::grammar::python::__parse_compound_stmt
 0.1%   0.1% 29.5KiB         ruff_server &lt;toml::value::Value as serde::de::Deserializer&gt;::deserialize_any
 0.1%   0.1% 29.5KiB                ruff &lt;toml::value::Value as serde::de::Deserializer&gt;::deserialize_any
44.5%  95.4% 21.3MiB                     And 33811 smaller methods. Use -n N to show more.
46.7% 100.0% 22.4MiB                     .text section size, the file size is 47.9MiB
</code></pre>
<p>main:</p>
<pre><code> File  .text    Size               Crate Name
 0.1%   0.3% 72.1KiB                ruff &lt;ruff::args::CheckCommand as clap_builder::derive::Args&gt;::augment_args
 0.1%   0.2% 51.4KiB     ruff_workspace? &lt;ruff_workspace::options::_::&lt;impl serde::de::Deserialize for ruff_workspace::options::LintOptionsWire&gt;::deserialize::__Visitor as serde::de::Visitor&gt;::visit_map
 0.1%   0.2% 51.4KiB     ruff_workspace? &lt;ruff_workspace::options::_::&lt;impl serde::de::Deserialize for ruff_workspace::options::LintOptionsWire&gt;::deserialize::__Visitor as serde::de::Visitor&gt;::visit_map
 0.1%   0.2% 51.4KiB     ruff_workspace? &lt;ruff_workspace::options::_::&lt;impl serde::de::Deserialize for ruff_workspace::options::LintOptionsWire&gt;::deserialize::__Visitor as serde::de::Visitor&gt;::visit_map
 0.1%   0.2% 46.2KiB         ruff_linter ruff_linter::checkers::ast::analyze::statement::statement
 0.1%   0.2% 43.8KiB        ruff_linter? &lt;ruff_linter::codes::Rule as core::str::traits::FromStr&gt;::from_str
 0.1%   0.2% 37.8KiB         ruff_linter ruff_linter::checkers::ast::analyze::expression::expression
 0.1%   0.2% 35.7KiB     ruff_workspace? &lt;ruff_workspace::options::_::&lt;impl serde::de::Deserialize for ruff_workspace::options::LintOptionsWire&gt;::deserialize::__Visitor as serde::de::Visitor&gt;::visit_map
 0.1%   0.2% 35.7KiB     ruff_workspace? &lt;ruff_workspace::options::_::&lt;impl serde::de::Deserialize for ruff_workspace::options::LintOptionsWire&gt;::deserialize::__Visitor as serde::de::Visitor&gt;::visit_map
 0.1%   0.2% 35.3KiB         ruff_linter &lt;alloc::vec::Vec&lt;T,A&gt; as core::clone::Clone&gt;::clone
 0.1%   0.2% 35.1KiB ruff_python_codegen ruff_python_codegen::generator::Generator::unparse_stmt
 0.1%   0.1% 32.4KiB      ruff_workspace ruff_workspace::configuration::LintConfiguration::as_rule_table
 0.1%   0.1% 32.4KiB      ruff_workspace ruff_workspace::configuration::Configuration::into_settings
 0.1%   0.1% 30.8KiB      ruff_workspace ruff_workspace::configuration::Configuration::from_options
 0.1%   0.1% 29.8KiB       libcst_native libcst_native::parser::grammar::python::__parse_compound_stmt
 0.1%   0.1% 29.5KiB         ruff_server &lt;toml::value::Value as serde::de::Deserializer&gt;::deserialize_any
 0.1%   0.1% 29.5KiB                ruff &lt;toml::value::Value as serde::de::Deserializer&gt;::deserialize_any
 0.1%   0.1% 28.7KiB      libcst_native? &lt;libcst_native::nodes::expression::Expression as core::clone::Clone&gt;::clone
 0.1%   0.1% 28.7KiB         ruff_linter ruff_linter::checkers::ast::analyze::deferred_scopes::deferred_scopes
 0.1%   0.1% 27.9KiB                ruff &lt;ruff::args::FormatCommand as clap_builder::derive::Args&gt;::augment_args
44.7%  95.5% 21.3MiB                     And 33578 smaller methods. Use -n N to show more.
46.7% 100.0% 22.3MiB                     .text section size, the file size is 47.8MiB
</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-18 21:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/tokens.rs</code>:178 on 2025-06-18 21:11</div>
            <div class="timeline-body"><p>Resolved by https://github.com/astral-sh/ruff/pull/18769</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-19 00:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/linter.rs</code>:396 on 2025-06-19 00:44</div>
            <div class="timeline-body"><p>Yeah, I guess we could check it in <code>report_diagnostic</code>, but that would be another case that would require returning an <code>Option&lt;DiagnosticGuard&gt;</code> right?</p>
<p>It looks like we could also just apply the per-file ignores to the <code>LinterSettings</code> at the top of <code>check_path</code> (or possibly even earlier). This changes one RUF100 snapshot from</p>
<pre><code>        0       │-RUF100_2.py:1:19: RUF100 [*] Unused `noqa` directive (unused: `F401`)
              0 │+RUF100_2.py:1:19: RUF100 [*] Unused `noqa` directive (non-enabled: `F401`)
</code></pre>
<p>but I think <code>non-enabled</code> is actually more correct. All of the other tests pass.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-19 09:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/linter.rs</code>:396 on 2025-06-19 09:00</div>
            <div class="timeline-body"><p>Ah right, we don't return <code>Option</code> today. But yes, I think we could just apply it to the <code>LinterSettings</code>!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-19 09:00</div>
            <div class="timeline-body"><p>By the way. I don't think any of those other refactors should block this PR. We can merge it and then try to reduce the places where we use <code>noqa_code().rule()</code> (Ideally, remove them all)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-06-19 12:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @ntBre on 2025-06-19 12:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-06-19 13:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-06-19 13:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-19 13:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-19 13:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/linter.rs</code>:396 on 2025-06-19 13:54</div>
            <div class="timeline-body"><p>Not only would this be more correct, it should also be faster because we can skip the rules entirely. I'm not sure if we want to change how we construct <code>LinterSettings</code> (we probably shouldn't if it requires a deep clone). But checking the rule set as resolved for this file inside <code>is_enabled</code> definetely makes sense</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-19 14:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/linter.rs</code>:396 on 2025-06-19 14:11</div>
            <div class="timeline-body"><p>Yeah I'm playing with this a bit today. It's easy enough to apply the per-file ignores at the top of <code>check_path</code>, but it does look like it needs a deep clone. I tried just cloning the rules table, but some of the nested calls expect the value on <code>settings</code> to be updated too.</p>
<p>Maybe we could have a wrapper around <code>LinterSettings</code> that is bound to a single path, or something like that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-19 14:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/linter.rs</code>:396 on 2025-06-19 14:18</div>
            <div class="timeline-body"><blockquote>
<p>I tried just cloning the rules table, but some of the nested calls expect the value on settings to be updated too.</p>
</blockquote>
<p>Uhm, that's annoying. could we refactor those calls or are there simply too many/are hard to find?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-19 14:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/linter.rs</code>:396 on 2025-06-19 14:41</div>
            <div class="timeline-body"><p>&quot;Some&quot; might have been a bit of an understatement. I think every, or nearly every, place we currently check if rules are enabled uses <code>settings.rules.enabled</code>, so it would be a pretty big refactor (making <code>LinterSettings::rules</code> private &quot;only&quot; causes 88 compilation errors, so maybe it's not <em>every</em> rule). I guess I'd end up touching all of those call sites with a wrapper too, though. I was picturing something like this:</p>
<pre><code class="language-rust">struct ResolvedLinterSettings&lt;'a&gt; {
    settings: &amp;'a LinterSettings,
    per_file_ignores: RuleSet,
}

impl&lt;'a&gt; ResolvedLinterSettings&lt;'a&gt; {
    fn new(settings: &amp;'a LinterSettings, path: &amp;Path) -&gt; Self {
        Self { settings, per_file_ignores: fs::ignores_from_path(path, &amp;settings.per_file_ignores) }
    }

    fn enabled(&amp;self, rule: Rule) -&gt; bool {
        self.settings.rules.enabled(rule) &amp;&amp; !self.per_file_ignores.contains(rule)
    }
}
</code></pre>
<p>or I guess cloning <code>self.settings.rules.enabled</code> and combining it with <code>per_file_ignores</code> more eagerly.</p>
<p>Do you like that idea, or would you prefer trying to pass down the updated rules table?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-19 14:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/linter.rs</code>:396 on 2025-06-19 14:44</div>
            <div class="timeline-body"><p>Oh you're right. I thought we added a <code>checker</code> (or <code>context</code>) <code>is_rule_enabled</code> method but it seems everyone just calls <code>settings.rule.enabled</code> directly :( But given that there are only 74 references, this might not be too bad to refactor (and we now have the right place to add the methnod -&gt; LintContext)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-19 14:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/linter.rs</code>:396 on 2025-06-19 14:47</div>
            <div class="timeline-body"><p>Oh that's true. I was worried about passing a <code>Path</code> everywhere, but if we can encapsulate it in the checker or context, that should work well. Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-20 20:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/linter.rs</code>:433 on 2025-06-20 20:09</div>
            <div class="timeline-body"><p>I could certainly be wrong, but my reading of this section of code is that it's removing fixes that the user explicitly marked as unfixable. Should we still generate a fix for display in those cases?</p>
<p>If not, I think I came up with a very simple solution, just applying both the applicability from your other comment and this <code>should_fix</code> check in <code>DiagnosticGuard::set_fix</code>. I'll open a PR soon to see what you think.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:13:02 UTC
    </footer>
</body>
</html>
