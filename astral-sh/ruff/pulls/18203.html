<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add support for PyPy virtual environments - astral-sh/ruff #18203</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add support for PyPy virtual environments</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18203">#18203</a>
        opened by <a href="https://github.com/Mathemmagician">@Mathemmagician</a>
        on 2025-05-19 17:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/Mathemmagician">@Mathemmagician</a> on 2025-05-19 17:55</div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff/ty! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title? (Please prefix with `[ty]` for ty pull
  requests.)
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<!-- What's the purpose of the change? What does it do, and why? -->

<p>Allows for better package discovery, ex. PyPy (fixes https://github.com/astral-sh/ty/issues/450)</p>
<p>Instead of only looking for <code>site-packages</code> in <code>lib/pythonX.Y/</code>, we also look into <code>lib/pypyX.Y/</code>. To avoid guesswork, we look at the <code>Implementation</code> value provided by virtual environments inside <code>pyvenv.cfg</code>.</p>
<ul>
<li>CPython or GraalPy -&gt; <code>lib/pythonX.Y/site-packages</code></li>
<li>Pypy -&gt; <code>lib/pypyX.Y/site-packages</code></li>
<li>Missing/Other value? -&gt; Check both locations</li>
</ul>
<h2>Test Plan</h2>
<!-- How was it tested? -->

<p>As of now, passed all current tests, but no new tests have been added yet.</p>
<p>TODO:</p>
<ol>
<li>Add new tests, i.e., adding Implementation field (PyPy vs CPython vs other vs missing) to VirtualEnvironmentTestCase</li>
<li>Update comments/docstrings</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @ntBre on 2025-05-19 17:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Mathemmagician">@Mathemmagician</a> on 2025-05-19 17:59</div>
            <div class="timeline-body"><p>Thank you, @AlexWaygood, for all the help and a super friendly first PyCon sprint experience :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-05-19 18:57</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "first pass adding implementation flag" to "[ty] Add support for PyPy virtual environments" by @AlexWaygood on 2025-05-19 22:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @AlexWaygood by @AlexWaygood on 2025-05-19 22:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-19 22:04</div>
            <div class="timeline-body"><p>I fixed CI and pushed a couple of nits. I'll add a test tomorrow and land it -- this looks great, thank you!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-20 18:28</div>
            <div class="timeline-body"><p>I added some unit tests to <code>site_packages.rs</code>. Ideally we'd add some mdtests here as well, but that would require adding some new features to mdtest to handle PyPy venv layouts, and that doesn't really seem worth it here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @AlexWaygood on 2025-05-20 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-05-20 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @AlexWaygood on 2025-05-20 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-05-20 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @AlexWaygood on 2025-05-20 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-05-20 18:44</div>
            <div class="timeline-body"><p>Looks good!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-05-20 18:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-05-20 18:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-20 18:47</div>
            <div class="timeline-body"><p>Thank you @Mathemmagician!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Mathemmagician">@Mathemmagician</a> on 2025-05-20 19:16</div>
            <div class="timeline-body"><p>Thanks @AlexWaygood !!! ðŸ¥³</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 18:51:29 UTC
    </footer>
</body>
</html>
