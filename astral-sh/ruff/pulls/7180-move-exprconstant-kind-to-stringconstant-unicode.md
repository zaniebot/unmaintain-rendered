```yaml
number: 7180
title: "Move `ExprConstant::kind` to `StringConstant::unicode`"
type: pull_request
state: merged
author: dhruvmanila
labels:
  - internal
assignees: []
merged: true
base: main
head: dhruv/str-unicode
created_at: 2023-09-06T07:11:19Z
updated_at: 2023-09-06T07:47:29Z
url: https://github.com/astral-sh/ruff/pull/7180
synced_at: 2026-01-12T15:55:23Z
```

# Move `ExprConstant::kind` to `StringConstant::unicode`

---

_@dhruvmanila_

## Summary

This PR refactors the `ExprConstant::kind` field to instead use
`StringConstant::unicode` to indicate a unicode string literal. The `kind`
field serves no other purpose, and is not used in any other way. This means
allocating a string to store `u`/`U` seems unnecessary.

The new field is similar to `implicit_concatenated`. It is a `bool` that
indicates whether the string literal is a unicode string literal.

This will also be useful in the f-string parsing to create an enum for possible
string literal types in implicit concatenation which are strings, bytes or
f-strings.

## Test Plan

```
cargo test --workspace --all-features
```


---

_Comment by @dhruvmanila on 2023-09-06 07:11_

Current dependencies on/for this PR:
* main
  * **PR #7180** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7180" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7180?utm_source=stack-comment).

---

_Review comment by @dhruvmanila on `crates/ruff/src/checkers/ast/analyze/expression.rs`:1227 on 2023-09-06 07:12_

We could instead add `is_unicode` but it seems redundant.

---

_Review comment by @dhruvmanila on `crates/ruff/src/rules/flake8_simplify/rules/ast_expr.rs`:218 on 2023-09-06 07:13_

This kind of change is required wherever the `kind` field was used.

---

_Review comment by @dhruvmanila on `crates/ruff/src/rules/pyupgrade/rules/unicode_kind_prefix.rs`:45 on 2023-09-06 07:14_

This is the only usage for the `unicode` field.

---

_Review comment by @dhruvmanila on `crates/ruff_python_ast/src/comparable.rs`:337 on 2023-09-06 07:16_

I added this mainly as it's present in `ExprConstant` for `ComparableExpr` as well but I just checked this in Python that `"foo" == u"foo"` gives `True`. I think then the `unicode` field here should be removed?

---

_@dhruvmanila reviewed on 2023-09-06 07:17_

---

_@MichaReiser approved on 2023-09-06 07:18_

---

_Label `internal` added by @MichaReiser on 2023-09-06 07:20_

---

_Comment by @MichaReiser on 2023-09-06 07:21_

Thanks for following up on this. Could you start adding the appropriate labels to your PR? Setting the appropriate label reduces the work involved in creating a new PR

---

_Comment by @dhruvmanila on 2023-09-06 07:22_

> Could you start adding the appropriate labels to your PR? Setting the appropriate label reduces the work involved in creating a new PR

Yeah, sorry. I'll keep that in mind.

---

_@MichaReiser reviewed on 2023-09-06 07:23_

---

_Review comment by @MichaReiser on `crates/ruff_python_ast/src/comparable.rs`:337 on 2023-09-06 07:23_

I'm not sure. Mainly because I never fully understood `ComparableExpr`. Is its intend to test if two trees are identical or if they resolve to the same runtime value? I think the later isn't true because that would require more than just comparing the expression trees but some of the implementation certainly does more so that the former isn't true either.

---

_@dhruvmanila reviewed on 2023-09-06 07:35_

---

_Review comment by @dhruvmanila on `crates/ruff_python_ast/src/comparable.rs`:337 on 2023-09-06 07:35_

That's a good point. I think we should leave it as it is to match the old behavior.

---

_Merged by @dhruvmanila on 2023-09-06 07:39_

---

_Closed by @dhruvmanila on 2023-09-06 07:39_

---

_Branch deleted on 2023-09-06 07:39_

---

_Comment by @github-actions[bot] on 2023-09-06 07:47_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.



---
