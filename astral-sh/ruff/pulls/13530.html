<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`refurb`] implement `hardcoded-string-charset` (FURB156) - astral-sh/ruff #13530</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>refurb</code>] implement <code>hardcoded-string-charset</code> (FURB156)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13530">#13530</a>
        opened by <a href="https://github.com/alex-700">@alex-700</a>
        on 2024-09-26 18:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/alex-700">@alex-700</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>Implement <code>hardcoded-string-charset</code> (FURB156)
See:</p>
<ul>
<li>https://github.com/astral-sh/ruff/issues/1348</li>
<li><a href="https://github.com/dosisod/refurb/blob/master/refurb/checks/string/charsets.py">original lint</a></li>
</ul>
<!-- What's the purpose of the change? What does it do, and why? -->

<h2>Test Plan</h2>
<p>cargo test</p>
<!-- How was it tested? -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-09-26 18:33</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+3 -0 violations, +0 -0 fixes in 2 projects; 52 projects unchanged)</p>
<details><summary><a href="https://github.com/apache/airflow">apache/airflow</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/apache/airflow/blob/e46006b25b025eee2feb5aedcb3bb01069a4b730/dev/breeze/src/airflow_breeze/utils/packages.py#L433'>dev/breeze/src/airflow_breeze/utils/packages.py:433:48:</a> FURB156 [*] Use of hardcoded string charset
</pre>

</p>
</details>
<details><summary><a href="https://github.com/bokeh/bokeh">bokeh/bokeh</a> (+2 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/reference/models/Text.py#L9'>examples/reference/models/Text.py:9:5:</a> FURB156 [*] Use of hardcoded string charset
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/tests/unit/bokeh/util/test_token.py#L69'>tests/unit/bokeh/util/test_token.py:69:20:</a> FURB156 [*] Use of hardcoded string charset
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| FURB156 | 3 | 3 | 0 | 0 | 0 |</p>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @zanieb by @zanieb on 2024-09-26 18:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-09-26 19:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/refurb/rules/hardcoded_string_charset.rs</code>:51 on 2024-09-26 19:03</div>
            <div class="timeline-body"><p>This is clever! But also somewhat complicated. Have you done a performance comparison with https://docs.rs/aho-corasick/latest/aho_corasick/</p>
<p>CC: @BurntSushi maybe you have a sense for whether the bitset approach or corasick is better here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/alex-700">@alex-700</a> reviewed on 2024-09-26 19:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/alex-700">@alex-700</a> on <code>crates/ruff_linter/src/rules/refurb/rules/hardcoded_string_charset.rs</code>:51 on 2024-09-26 19:36</div>
            <div class="timeline-body"><blockquote>
<p>Have you done a performance comparison with https://docs.rs/aho-corasick/latest/aho_corasick/?</p>
</blockquote>
<p>No.</p>
<p>There are two parts here:</p>
<ul>
<li><code>exact</code>: there are 9 <code>&amp;[u8]</code> comparisons, which are usually fail by <code>.len()</code> comparison. Do not believe that aho-corasick could help a lot (if we do not lift the scope higher than <code>fn string_like</code>).</li>
<li><code>as_set</code>:<ul>
<li>in the current implementation works only in <code>... [not] in &lt;str literal&gt;</code> case (looks not so often to care)</li>
<li>if we would like to save the semantic <code>set(...) == set(string.&lt;charset&gt;)</code>, AFAIK, aho-corasick does not help us. We still need some <code>set</code>-ish solution (e.g. like this inlined bitset). The one idea we can add is &quot;early return if the byte is not <code>printable</code>&quot;, but looks like premature optimization for me.</li>
</ul>
</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @MichaReiser on 2024-09-27 06:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @MichaReiser on 2024-09-27 06:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/refurb/rules/hardcoded_string_charset.rs</code>:69 on 2024-09-27 06:23</div>
            <div class="timeline-body"><p>Let's assert that a <code>Charset</code> is ascii only</p>
<pre><code class="language-suggestion">						assert!(bytes[i].is_ascii());
            bitset |= 1 &lt;&lt; bytes[i];
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/refurb/rules/hardcoded_string_charset.rs</code>:102 on 2024-09-27 06:24</div>
            <div class="timeline-body"><p>I suggest that we extract a <code>AsciiCharSet</code> struct that wraps the bitset to avoid repeating the bitset calculation. It also offers an opportunity to write some documentation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/refurb/rules/hardcoded_string_charset.rs</code>:174 on 2024-09-27 06:32</div>
            <div class="timeline-body"><p>The only charset that could be an exact match here should be the charset found by <code>check_charset_as_set</code>. Searching over all charsets seems unnecessary.</p>
<pre><code class="language-suggestion">        if charset.is_same(&amp;value.to_str()) {
        return;
    }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/refurb/rules/hardcoded_string_charset.rs</code>:184 on 2024-09-27 06:36</div>
            <div class="timeline-body"><p>You can move the invocation of this rule to the string-literal phase if it only needs to run on string literals.</p>
<pre><code class="language-suggestion">pub(crate) fn hardcoded_string_charset_literal(checker: &amp;mut Checker, string_literal: &amp;ExprStringLiteral) {
    let StringLike::String(expr) = string_like else {
        return;
    };
    let Some(charset) = check_charset_exact(expr.value.to_str().as_bytes()) else {
        return;
    };
    push_diagnostic(checker, string_like.range(), charset);
}
</code></pre>
<p>to https://github.com/astral-sh/ruff/blob/40149a17f5cf061664b849f7d6c0d03e42616038/crates/ruff_linter/src/checkers/ast/analyze/expression.rs#L1100-L1101</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/refurb/rules/hardcoded_string_charset.rs</code>:166 on 2024-09-27 06:41</div>
            <div class="timeline-body"><p>Nit: We prefer to pass the entire expression rather than picking individual fields</p>
<pre><code class="language-suggestion">pub(crate) fn hardcoded_string_charset_comparison(
    checker: &amp;mut Checker,
    ExprCompare {
        ops, comparators, ..
    }: &amp;ExprCompare,
) {
    let ([CmpOp::In | CmpOp::NotIn], [Expr::StringLiteral(ExprStringLiteral { value, .. })]) =
        (&amp;**ops, &amp;**comparators)
    else {
        return;
    };
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2024-09-27 06:47</div>
            <div class="timeline-body"><p>Thanks. This looks great.</p>
<p>I left a few smaller comments. It would also be great to add some documentation to <code>Charset</code> and <code>bitset</code>, considering that the representations are non-trivial and make some assumptions about how they're used.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/alex-700">@alex-700</a> reviewed on 2024-09-27 10:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/alex-700">@alex-700</a> on <code>crates/ruff_linter/src/rules/refurb/rules/hardcoded_string_charset.rs</code>:102 on 2024-09-27 10:42</div>
            <div class="timeline-body"><p>Added.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/alex-700">@alex-700</a> reviewed on 2024-09-27 10:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/alex-700">@alex-700</a> on <code>crates/ruff_linter/src/rules/refurb/rules/hardcoded_string_charset.rs</code>:174 on 2024-09-27 10:42</div>
            <div class="timeline-body"><p>Thanks! Nice catch! Fixed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/alex-700">@alex-700</a> reviewed on 2024-09-27 10:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/alex-700">@alex-700</a> on <code>crates/ruff_linter/src/rules/refurb/rules/hardcoded_string_charset.rs</code>:184 on 2024-09-27 10:43</div>
            <div class="timeline-body"><p>IIUC, the right place was https://github.com/astral-sh/ruff/blob/a4a585da2a98f94407e602fc2328d5e4207185f3/crates/ruff_linter/src/checkers/ast/analyze/expression.rs#L1370
Moved.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/alex-700">@alex-700</a> reviewed on 2024-09-27 10:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/alex-700">@alex-700</a> on <code>crates/ruff_linter/src/rules/refurb/rules/hardcoded_string_charset.rs</code>:166 on 2024-09-27 10:45</div>
            <div class="timeline-body"><p>Was copy-pasted from the neighbor:
https://github.com/astral-sh/ruff/blob/a4a585da2a98f94407e602fc2328d5e4207185f3/crates/ruff_linter/src/checkers/ast/analyze/expression.rs#L1356</p>
<p>Fixed now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/alex-700">@alex-700</a> reviewed on 2024-09-27 10:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/alex-700">@alex-700</a> on <code>crates/ruff_linter/src/rules/refurb/rules/hardcoded_string_charset.rs</code>:69 on 2024-09-27 10:46</div>
            <div class="timeline-body"><p>Asserted with <code>unwrap()</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/resources/test/fixtures/refurb/FURB156.py</code>:14 on 2024-09-27 11:52</div>
            <div class="timeline-body"><p>Could you add a test for a case where the string is parenthesized</p>
<pre><code class="language-suggestion">_ = (
	'0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!&quot;#$%&amp;\'()*+,-./:;&lt;=&gt;?@[\\]^_`{|}~ \t\n\r\x0b\x0c'
)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/refurb/rules/hardcoded_string_charset.rs</code>:65 on 2024-09-27 11:54</div>
            <div class="timeline-body"><p>What's the motivation for having both <code>from_bytes</code> and <code>from_bytes_const</code>? Aren't both returning <code>None</code> if the string contains any non ascii character?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-09-27 11:57</div>
            <div class="timeline-body"><p>Nice, thanks for following up. Let's add a test for when the expression is parenthesized to verify that the fix is correct (if not, take a look at <code>parenthesized_range</code>.</p>
<p>I also think that we may be able to remove the factory methods on <code>AsciiCharSet</code> and reduce them to just one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-09-27 12:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_linter/src/rules/refurb/rules/hardcoded_string_charset.rs</code>:51 on 2024-09-27 12:12</div>
            <div class="timeline-body"><p>I don't have a good sense here. 9 memcmp's could be very quick. This is the sort of thing where, if you want to go as fast as possible, you probably need a micro-benchmark to try and optimize it. But I think the approach here looks very reasonable to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @zanieb by @MichaReiser on 2024-09-27 13:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/alex-700">@alex-700</a> reviewed on 2024-09-29 16:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/alex-700">@alex-700</a> on <code>crates/ruff_linter/resources/test/fixtures/refurb/FURB156.py</code>:14 on 2024-09-29 16:14</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/13530/commits/066e7006e4b5fad341fa8c84a85ec1f5cf5d3602
I added the test and &quot;took a look&quot; on <code>parenthesized_range</code>, but its usage was really not intuitive for me in that special case. Could I somehow simplify &quot;getting the parent&quot; here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/alex-700">@alex-700</a> reviewed on 2024-09-29 16:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/alex-700">@alex-700</a> on <code>crates/ruff_linter/src/rules/refurb/rules/hardcoded_string_charset.rs</code>:65 on 2024-09-29 16:29</div>
            <div class="timeline-body"><p>I would like to stick to using a <code>const</code> here (another option, I would like to avoid, is runtime evaluation under &quot;OnceLock&quot;):
https://github.com/astral-sh/ruff/blob/066e7006e4b5fad341fa8c84a85ec1f5cf5d3602/crates/ruff_linter/src/rules/refurb/rules/hardcoded_string_charset.rs#L108
So I need <code>from_bytes</code> to be a <code>const fn</code>, but unfortunately currently &quot;in stable&quot; it cannot have a clean implementation like this:
https://github.com/astral-sh/ruff/blob/066e7006e4b5fad341fa8c84a85ec1f5cf5d3602/crates/ruff_linter/src/rules/refurb/rules/hardcoded_string_charset.rs#L62-L65</p>
<p>So I added the dirty implementation (which can be <code>const fn</code>) under another name <code>from_bytes_const</code>:
https://github.com/astral-sh/ruff/blob/066e7006e4b5fad341fa8c84a85ec1f5cf5d3602/crates/ruff_linter/src/rules/refurb/rules/hardcoded_string_charset.rs#L70-L85</p>
<p>And there is a TODO to remove it, when stable supports <code>const fn</code> like usual <code>from_bytes</code>.</p>
<p>The third factory is about the usage of <code>Option::unwrap</code> in <code>const fn</code>. Currently is not possible (wait for https://github.com/rust-lang/rust/issues/67441). When it will be shipped, we can write</p>
<pre><code class="language-rust">            ascii_char_set: AsciiCharSet::from_bytes_const(bytes).unwrap(),
</code></pre>
<p>instead of
https://github.com/astral-sh/ruff/blob/066e7006e4b5fad341fa8c84a85ec1f5cf5d3602/crates/ruff_linter/src/rules/refurb/rules/hardcoded_string_charset.rs#L103</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-09-29 17:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/refurb/rules/hardcoded_string_charset.rs</code>:65 on 2024-09-29 17:45</div>
            <div class="timeline-body"><p>I do like the const version but do we need  the non const version?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/alex-700">@alex-700</a> reviewed on 2024-09-29 22:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/alex-700">@alex-700</a> on <code>crates/ruff_linter/src/rules/refurb/rules/hardcoded_string_charset.rs</code>:65 on 2024-09-29 22:45</div>
            <div class="timeline-body"><p>The const version is non-idiomatic and will surprise a reader.</p>
<p>Having this non-idiomatic version in runtime could have some interesting behavior of optimization part of compiler.
While there is a difference in generated code ( see https://godbolt.org/z/53T3z86f8 ), I assume it is a good default decision to have two implemenation untill the <code>const fn</code> supports idiomatic implementation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-09-30 11:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_linter/src/rules/refurb/rules/hardcoded_string_charset.rs</code>:65 on 2024-09-30 11:53</div>
            <div class="timeline-body"><p>I'd be fine with keeping the code simpler and using <code>OnceLock</code> if that works personally.</p>
<p>Otherwise, if the non-const version isn't being used, I'd drop it. If you're worried about surprising the reader, then you could write a short comment. (Although I don't think it's that surprising. If you've ever tried to write a const fn before, you'll know that you're pretty limited in the tools you have.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/alex-700">@alex-700</a> reviewed on 2024-09-30 12:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/alex-700">@alex-700</a> on <code>crates/ruff_linter/src/rules/refurb/rules/hardcoded_string_charset.rs</code>:65 on 2024-09-30 12:27</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/13530/commits/b9b3b64937f000c66a850b541df17b4899bb3ed5
Ok. <code>AsciiCharSet</code> interface was simplified to the direction of only <code>const</code> implementation.
Also:</p>
<ul>
<li><code>from_bytes_const_unwrap</code> was inlined to localize the story of <code>Option::unwrap</code> in <code>const</code> context.</li>
<li>slightly change the <code>TODO</code> comments.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-10-07 07:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/resources/test/fixtures/refurb/FURB156.py</code>:14 on 2024-10-07 07:24</div>
            <div class="timeline-body"><p>I think it's fine to preserve the parentheses in this case. That also guarantees that we preserve (most) comments. I'm sorry that I set you off on the wrong trail.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-10-07 07:25</div>
            <div class="timeline-body"><p>Nice thanks. This looks great!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2024-10-07 07:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-10-07 07:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-10 20:46</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:06:43 UTC
    </footer>
</body>
</html>
