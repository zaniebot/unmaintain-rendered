<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Rework `Type::to_instance()` to return `Option&lt;Type&gt;` - astral-sh/ruff #16428</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Rework <code>Type::to_instance()</code> to return <code>Option&lt;Type&gt;</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16428">#16428</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-02-28 00:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-28 00:20</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR fixes https://github.com/astral-sh/ruff/issues/16302.</p>
<p>The PR reworks <code>Type::to_instance()</code> to return <code>Option&lt;Type&gt;</code> rather than <code>Type</code>. This reflects more accurately the fact that some variants cannot be &quot;turned into an instance&quot;, since they <em>already</em> represent instances of some kind. On <code>main</code>, we silently fallback to <code>Unknown</code> for these variants, but this implicit behaviour can be somewhat surprising and lead to unexpected bugs.</p>
<p>Returning <code>Option&lt;Type&gt;</code> rather than <code>Type</code> means that each callsite has to account for the possibility that the type might already represent an instance, and decide what to do about it.
In general, I think this increases the robustness of the code. Working on this PR revealed two latent bugs in the code:</p>
<ul>
<li>One which has already been fixed by https://github.com/astral-sh/ruff/pull/16427</li>
<li>One which is fixed as part of <a href="https://github.com/astral-sh/ruff/pull/16608">this PR (see my inline comment)</a></li>
</ul>
<p>I added special handling to <code>KnownClass::to_instance()</code>: If we fail to find one of these classes and the <code>test</code> feature is <em>not</em> enabled, we log a warning to the terminal saying that we failed to find the class in typeshed and that we will be falling back to <code>Type::Unknown</code>. A cache is maintained so that we record all classes that we have already logged a warning for; we only log a warning for failing to lookup a <code>KnownClass</code> if we know that it's the first time we're looking it up.</p>
<h2>Test Plan</h2>
<ul>
<li>All existing tests pass</li>
<li>I ran the property tests via <code>QUICKCHECK_TESTS=1000000 cargo test --release -p red_knot_python_semantic -- --ignored types::property_tests::stable</code></li>
</ul>
<p>I also manually checked that warnings are appropriately printed to the terminal when <code>KnownClass::to_instance()</code> falls back to <code>Unknown</code> and the <code>test</code> feature is not enabled. To do this, I applied this diff to the PR branch:</p>
<details>
<summary>Patch deleting `int` and `str` from buitins</summary>

<pre><code class="language-diff">diff --git a/crates/red_knot_vendored/vendor/typeshed/stdlib/builtins.pyi b/crates/red_knot_vendored/vendor/typeshed/stdlib/builtins.pyi
index 0a6dc57b0..86636a05b 100644
--- a/crates/red_knot_vendored/vendor/typeshed/stdlib/builtins.pyi
+++ b/crates/red_knot_vendored/vendor/typeshed/stdlib/builtins.pyi
@@ -228,111 +228,6 @@ _PositiveInteger: TypeAlias = Literal[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13,
 _NegativeInteger: TypeAlias = Literal[-1, -2, -3, -4, -5, -6, -7, -8, -9, -10, -11, -12, -13, -14, -15, -16, -17, -18, -19, -20]
 _LiteralInteger = _PositiveInteger | _NegativeInteger | Literal[0]  # noqa: Y026  # TODO: Use TypeAlias once mypy bugs are fixed
 
-class int:
-    @overload
-    def __new__(cls, x: ConvertibleToInt = ..., /) -&gt; Self: ...
-    @overload
-    def __new__(cls, x: str | bytes | bytearray, /, base: SupportsIndex) -&gt; Self: ...
-    def as_integer_ratio(self) -&gt; tuple[int, Literal[1]]: ...
-    @property
-    def real(self) -&gt; int: ...
-    @property
-    def imag(self) -&gt; Literal[0]: ...
-    @property
-    def numerator(self) -&gt; int: ...
-    @property
-    def denominator(self) -&gt; Literal[1]: ...
-    def conjugate(self) -&gt; int: ...
-    def bit_length(self) -&gt; int: ...
-    if sys.version_info &gt;= (3, 10):
-        def bit_count(self) -&gt; int: ...
-
-    if sys.version_info &gt;= (3, 11):
-        def to_bytes(
-            self, length: SupportsIndex = 1, byteorder: Literal[&quot;little&quot;, &quot;big&quot;] = &quot;big&quot;, *, signed: bool = False
-        ) -&gt; bytes: ...
-        @classmethod
-        def from_bytes(
-            cls,
-            bytes: Iterable[SupportsIndex] | SupportsBytes | ReadableBuffer,
-            byteorder: Literal[&quot;little&quot;, &quot;big&quot;] = &quot;big&quot;,
-            *,
-            signed: bool = False,
-        ) -&gt; Self: ...
-    else:
-        def to_bytes(self, length: SupportsIndex, byteorder: Literal[&quot;little&quot;, &quot;big&quot;], *, signed: bool = False) -&gt; bytes: ...
-        @classmethod
-        def from_bytes(
-            cls,
-            bytes: Iterable[SupportsIndex] | SupportsBytes | ReadableBuffer,
-            byteorder: Literal[&quot;little&quot;, &quot;big&quot;],
-            *,
-            signed: bool = False,
-        ) -&gt; Self: ...
-
-    if sys.version_info &gt;= (3, 12):
-        def is_integer(self) -&gt; Literal[True]: ...
-
-    def __add__(self, value: int, /) -&gt; int: ...
-    def __sub__(self, value: int, /) -&gt; int: ...
-    def __mul__(self, value: int, /) -&gt; int: ...
-    def __floordiv__(self, value: int, /) -&gt; int: ...
-    def __truediv__(self, value: int, /) -&gt; float: ...
-    def __mod__(self, value: int, /) -&gt; int: ...
-    def __divmod__(self, value: int, /) -&gt; tuple[int, int]: ...
-    def __radd__(self, value: int, /) -&gt; int: ...
-    def __rsub__(self, value: int, /) -&gt; int: ...
-    def __rmul__(self, value: int, /) -&gt; int: ...
-    def __rfloordiv__(self, value: int, /) -&gt; int: ...
-    def __rtruediv__(self, value: int, /) -&gt; float: ...
-    def __rmod__(self, value: int, /) -&gt; int: ...
-    def __rdivmod__(self, value: int, /) -&gt; tuple[int, int]: ...
-    @overload
-    def __pow__(self, x: Literal[0], /) -&gt; Literal[1]: ...
-    @overload
-    def __pow__(self, value: Literal[0], mod: None, /) -&gt; Literal[1]: ...
-    @overload
-    def __pow__(self, value: _PositiveInteger, mod: None = None, /) -&gt; int: ...
-    @overload
-    def __pow__(self, value: _NegativeInteger, mod: None = None, /) -&gt; float: ...
-    # positive __value -&gt; int; negative __value -&gt; float
-    # return type must be Any as `int | float` causes too many false-positive errors
-    @overload
-    def __pow__(self, value: int, mod: None = None, /) -&gt; Any: ...
-    @overload
-    def __pow__(self, value: int, mod: int, /) -&gt; int: ...
-    def __rpow__(self, value: int, mod: int | None = None, /) -&gt; Any: ...
-    def __and__(self, value: int, /) -&gt; int: ...
-    def __or__(self, value: int, /) -&gt; int: ...
-    def __xor__(self, value: int, /) -&gt; int: ...
-    def __lshift__(self, value: int, /) -&gt; int: ...
-    def __rshift__(self, value: int, /) -&gt; int: ...
-    def __rand__(self, value: int, /) -&gt; int: ...
-    def __ror__(self, value: int, /) -&gt; int: ...
-    def __rxor__(self, value: int, /) -&gt; int: ...
-    def __rlshift__(self, value: int, /) -&gt; int: ...
-    def __rrshift__(self, value: int, /) -&gt; int: ...
-    def __neg__(self) -&gt; int: ...
-    def __pos__(self) -&gt; int: ...
-    def __invert__(self) -&gt; int: ...
-    def __trunc__(self) -&gt; int: ...
-    def __ceil__(self) -&gt; int: ...
-    def __floor__(self) -&gt; int: ...
-    def __round__(self, ndigits: SupportsIndex = ..., /) -&gt; int: ...
-    def __getnewargs__(self) -&gt; tuple[int]: ...
-    def __eq__(self, value: object, /) -&gt; bool: ...
-    def __ne__(self, value: object, /) -&gt; bool: ...
-    def __lt__(self, value: int, /) -&gt; bool: ...
-    def __le__(self, value: int, /) -&gt; bool: ...
-    def __gt__(self, value: int, /) -&gt; bool: ...
-    def __ge__(self, value: int, /) -&gt; bool: ...
-    def __float__(self) -&gt; float: ...
-    def __int__(self) -&gt; int: ...
-    def __abs__(self) -&gt; int: ...
-    def __hash__(self) -&gt; int: ...
-    def __bool__(self) -&gt; bool: ...
-    def __index__(self) -&gt; int: ...
-
 class float:
     def __new__(cls, x: ConvertibleToFloat = ..., /) -&gt; Self: ...
     def as_integer_ratio(self) -&gt; tuple[int, int]: ...
@@ -437,190 +332,6 @@ class _FormatMapMapping(Protocol):
 class _TranslateTable(Protocol):
     def __getitem__(self, key: int, /) -&gt; str | int | None: ...
 
-class str(Sequence[str]):
-    @overload
-    def __new__(cls, object: object = ...) -&gt; Self: ...
-    @overload
-    def __new__(cls, object: ReadableBuffer, encoding: str = ..., errors: str = ...) -&gt; Self: ...
-    @overload
-    def capitalize(self: LiteralString) -&gt; LiteralString: ...
-    @overload
-    def capitalize(self) -&gt; str: ...  # type: ignore[misc]
-    @overload
-    def casefold(self: LiteralString) -&gt; LiteralString: ...
-    @overload
-    def casefold(self) -&gt; str: ...  # type: ignore[misc]
-    @overload
-    def center(self: LiteralString, width: SupportsIndex, fillchar: LiteralString = &quot; &quot;, /) -&gt; LiteralString: ...
-    @overload
-    def center(self, width: SupportsIndex, fillchar: str = &quot; &quot;, /) -&gt; str: ...  # type: ignore[misc]
-    def count(self, sub: str, start: SupportsIndex | None = ..., end: SupportsIndex | None = ..., /) -&gt; int: ...
-    def encode(self, encoding: str = &quot;utf-8&quot;, errors: str = &quot;strict&quot;) -&gt; bytes: ...
-    def endswith(
-        self, suffix: str | tuple[str, ...], start: SupportsIndex | None = ..., end: SupportsIndex | None = ..., /
-    ) -&gt; bool: ...
-    @overload
-    def expandtabs(self: LiteralString, tabsize: SupportsIndex = 8) -&gt; LiteralString: ...
-    @overload
-    def expandtabs(self, tabsize: SupportsIndex = 8) -&gt; str: ...  # type: ignore[misc]
-    def find(self, sub: str, start: SupportsIndex | None = ..., end: SupportsIndex | None = ..., /) -&gt; int: ...
-    @overload
-    def format(self: LiteralString, *args: LiteralString, **kwargs: LiteralString) -&gt; LiteralString: ...
-    @overload
-    def format(self, *args: object, **kwargs: object) -&gt; str: ...
-    def format_map(self, mapping: _FormatMapMapping, /) -&gt; str: ...
-    def index(self, sub: str, start: SupportsIndex | None = ..., end: SupportsIndex | None = ..., /) -&gt; int: ...
-    def isalnum(self) -&gt; bool: ...
-    def isalpha(self) -&gt; bool: ...
-    def isascii(self) -&gt; bool: ...
-    def isdecimal(self) -&gt; bool: ...
-    def isdigit(self) -&gt; bool: ...
-    def isidentifier(self) -&gt; bool: ...
-    def islower(self) -&gt; bool: ...
-    def isnumeric(self) -&gt; bool: ...
-    def isprintable(self) -&gt; bool: ...
-    def isspace(self) -&gt; bool: ...
-    def istitle(self) -&gt; bool: ...
-    def isupper(self) -&gt; bool: ...
-    @overload
-    def join(self: LiteralString, iterable: Iterable[LiteralString], /) -&gt; LiteralString: ...
-    @overload
-    def join(self, iterable: Iterable[str], /) -&gt; str: ...  # type: ignore[misc]
-    @overload
-    def ljust(self: LiteralString, width: SupportsIndex, fillchar: LiteralString = &quot; &quot;, /) -&gt; LiteralString: ...
-    @overload
-    def ljust(self, width: SupportsIndex, fillchar: str = &quot; &quot;, /) -&gt; str: ...  # type: ignore[misc]
-    @overload
-    def lower(self: LiteralString) -&gt; LiteralString: ...
-    @overload
-    def lower(self) -&gt; str: ...  # type: ignore[misc]
-    @overload
-    def lstrip(self: LiteralString, chars: LiteralString | None = None, /) -&gt; LiteralString: ...
-    @overload
-    def lstrip(self, chars: str | None = None, /) -&gt; str: ...  # type: ignore[misc]
-    @overload
-    def partition(self: LiteralString, sep: LiteralString, /) -&gt; tuple[LiteralString, LiteralString, LiteralString]: ...
-    @overload
-    def partition(self, sep: str, /) -&gt; tuple[str, str, str]: ...  # type: ignore[misc]
-    if sys.version_info &gt;= (3, 13):
-        @overload
-        def replace(
-            self: LiteralString, old: LiteralString, new: LiteralString, /, count: SupportsIndex = -1
-        ) -&gt; LiteralString: ...
-        @overload
-        def replace(self, old: str, new: str, /, count: SupportsIndex = -1) -&gt; str: ...  # type: ignore[misc]
-    else:
-        @overload
-        def replace(
-            self: LiteralString, old: LiteralString, new: LiteralString, count: SupportsIndex = -1, /
-        ) -&gt; LiteralString: ...
-        @overload
-        def replace(self, old: str, new: str, count: SupportsIndex = -1, /) -&gt; str: ...  # type: ignore[misc]
-    if sys.version_info &gt;= (3, 9):
-        @overload
-        def removeprefix(self: LiteralString, prefix: LiteralString, /) -&gt; LiteralString: ...
-        @overload
-        def removeprefix(self, prefix: str, /) -&gt; str: ...  # type: ignore[misc]
-        @overload
-        def removesuffix(self: LiteralString, suffix: LiteralString, /) -&gt; LiteralString: ...
-        @overload
-        def removesuffix(self, suffix: str, /) -&gt; str: ...  # type: ignore[misc]
-
-    def rfind(self, sub: str, start: SupportsIndex | None = ..., end: SupportsIndex | None = ..., /) -&gt; int: ...
-    def rindex(self, sub: str, start: SupportsIndex | None = ..., end: SupportsIndex | None = ..., /) -&gt; int: ...
-    @overload
-    def rjust(self: LiteralString, width: SupportsIndex, fillchar: LiteralString = &quot; &quot;, /) -&gt; LiteralString: ...
-    @overload
-    def rjust(self, width: SupportsIndex, fillchar: str = &quot; &quot;, /) -&gt; str: ...  # type: ignore[misc]
-    @overload
-    def rpartition(self: LiteralString, sep: LiteralString, /) -&gt; tuple[LiteralString, LiteralString, LiteralString]: ...
-    @overload
-    def rpartition(self, sep: str, /) -&gt; tuple[str, str, str]: ...  # type: ignore[misc]
-    @overload
-    def rsplit(self: LiteralString, sep: LiteralString | None = None, maxsplit: SupportsIndex = -1) -&gt; list[LiteralString]: ...
-    @overload
-    def rsplit(self, sep: str | None = None, maxsplit: SupportsIndex = -1) -&gt; list[str]: ...  # type: ignore[misc]
-    @overload
-    def rstrip(self: LiteralString, chars: LiteralString | None = None, /) -&gt; LiteralString: ...
-    @overload
-    def rstrip(self, chars: str | None = None, /) -&gt; str: ...  # type: ignore[misc]
-    @overload
-    def split(self: LiteralString, sep: LiteralString | None = None, maxsplit: SupportsIndex = -1) -&gt; list[LiteralString]: ...
-    @overload
-    def split(self, sep: str | None = None, maxsplit: SupportsIndex = -1) -&gt; list[str]: ...  # type: ignore[misc]
-    @overload
-    def splitlines(self: LiteralString, keepends: bool = False) -&gt; list[LiteralString]: ...
-    @overload
-    def splitlines(self, keepends: bool = False) -&gt; list[str]: ...  # type: ignore[misc]
-    def startswith(
-        self, prefix: str | tuple[str, ...], start: SupportsIndex | None = ..., end: SupportsIndex | None = ..., /
-    ) -&gt; bool: ...
-    @overload
-    def strip(self: LiteralString, chars: LiteralString | None = None, /) -&gt; LiteralString: ...
-    @overload
-    def strip(self, chars: str | None = None, /) -&gt; str: ...  # type: ignore[misc]
-    @overload
-    def swapcase(self: LiteralString) -&gt; LiteralString: ...
-    @overload
-    def swapcase(self) -&gt; str: ...  # type: ignore[misc]
-    @overload
-    def title(self: LiteralString) -&gt; LiteralString: ...
-    @overload
-    def title(self) -&gt; str: ...  # type: ignore[misc]
-    def translate(self, table: _TranslateTable, /) -&gt; str: ...
-    @overload
-    def upper(self: LiteralString) -&gt; LiteralString: ...
-    @overload
-    def upper(self) -&gt; str: ...  # type: ignore[misc]
-    @overload
-    def zfill(self: LiteralString, width: SupportsIndex, /) -&gt; LiteralString: ...
-    @overload
-    def zfill(self, width: SupportsIndex, /) -&gt; str: ...  # type: ignore[misc]
-    @staticmethod
-    @overload
-    def maketrans(x: dict[int, _T] | dict[str, _T] | dict[str | int, _T], /) -&gt; dict[int, _T]: ...
-    @staticmethod
-    @overload
-    def maketrans(x: str, y: str, /) -&gt; dict[int, int]: ...
-    @staticmethod
-    @overload
-    def maketrans(x: str, y: str, z: str, /) -&gt; dict[int, int | None]: ...
-    @overload
-    def __add__(self: LiteralString, value: LiteralString, /) -&gt; LiteralString: ...
-    @overload
-    def __add__(self, value: str, /) -&gt; str: ...  # type: ignore[misc]
-    # Incompatible with Sequence.__contains__
-    def __contains__(self, key: str, /) -&gt; bool: ...  # type: ignore[override]
-    def __eq__(self, value: object, /) -&gt; bool: ...
-    def __ge__(self, value: str, /) -&gt; bool: ...
-    @overload
-    def __getitem__(self: LiteralString, key: SupportsIndex | slice, /) -&gt; LiteralString: ...
-    @overload
-    def __getitem__(self, key: SupportsIndex | slice, /) -&gt; str: ...  # type: ignore[misc]
-    def __gt__(self, value: str, /) -&gt; bool: ...
-    def __hash__(self) -&gt; int: ...
-    @overload
-    def __iter__(self: LiteralString) -&gt; Iterator[LiteralString]: ...
-    @overload
-    def __iter__(self) -&gt; Iterator[str]: ...  # type: ignore[misc]
-    def __le__(self, value: str, /) -&gt; bool: ...
-    def __len__(self) -&gt; int: ...
-    def __lt__(self, value: str, /) -&gt; bool: ...
-    @overload
-    def __mod__(self: LiteralString, value: LiteralString | tuple[LiteralString, ...], /) -&gt; LiteralString: ...
-    @overload
-    def __mod__(self, value: Any, /) -&gt; str: ...
-    @overload
-    def __mul__(self: LiteralString, value: SupportsIndex, /) -&gt; LiteralString: ...
-    @overload
-    def __mul__(self, value: SupportsIndex, /) -&gt; str: ...  # type: ignore[misc]
-    def __ne__(self, value: object, /) -&gt; bool: ...
-    @overload
-    def __rmul__(self: LiteralString, value: SupportsIndex, /) -&gt; LiteralString: ...
-    @overload
-    def __rmul__(self, value: SupportsIndex, /) -&gt; str: ...  # type: ignore[misc]
-    def __getnewargs__(self) -&gt; tuple[str]: ...
-
 class bytes(Sequence[int]):
</code></pre>
</details>

<p>And then ran red-knot on my <a href="https://github.com/AlexWaygood/typeshed-stats">typeshed-stats</a> project using the command</p>
<pre><code>cargo run -p red_knot -- check --project ../typeshed-stats --python-version=&quot;3.12&quot; --verbose
</code></pre>
<p>I observed that the following logs were printed to the terminal, but that each warning was only printed once (the desired behaviour):</p>
<pre><code>INFO Python version: Python 3.12, platform: all
INFO Found 15 files in project `typeshed-stats`
INFO Python version: Python 3.12, platform: all
INFO Indexed 15 file(s)
INFO Could not find class `builtins.int` in typeshed on Python 3.12. Falling back to `Unknown` for the symbol instead.
INFO Could not find class `builtins.str` in typeshed on Python 3.12. Falling back to `Unknown` for the symbol instead.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-02-28 00:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-28 13:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:1069 on 2025-02-28 13:54</div>
            <div class="timeline-body"><p>The change here is that the canonical module for <code>KnownClass::TypeAliasType</code> is now <code>KnownModule::TypingExtensions</code> rather than <code>KnownModule::Typing</code>. Running the property tests on this branch instantly crashed without this change, as it was revealed that until now <code>KnownClass::TypeAliasType.to_instance(db)</code> has been silently resolving to <code>Type::Unknown</code> all this time, due to the fact that it was only added to the typing module in Python 3.12 but our default Python version is 3.9.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @AlexWaygood on 2025-02-28 14:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-02-28 14:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2025-02-28 14:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-02-28 14:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:1013 on 2025-02-28 14:21</div>
            <div class="timeline-body"><p>this approach was inspired by the existing Ruff macro <code>warn_user_once_by_message!()</code> here:</p>
<p>https://github.com/astral-sh/ruff/blob/0c7c00164744db56538843935073c15f086f6903/crates/ruff_linter/src/logging.rs#L37-L55</p>
<p>I couldn't find any tests for that macro, and I wasn't sure how to test this (since it deliberately works differently depending on whether the <code>test</code> feature is enabled, in order to prevent bugs silently going unnoticed in tests!). If anybody has any ideas, I'd be interested!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:913 on 2025-02-28 14:21</div>
            <div class="timeline-body"><p>Or I suppose this could be</p>
<pre><code class="language-suggestion">                if cfg!(debug_assertions) {
</code></pre>
<p>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-28 14:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1132 on 2025-02-28 16:49</div>
            <div class="timeline-body"><p>Shouldn't it be an invariant that a class' metaclass is always something instantiable? It seems like it should be, since the class itself should be an instance of its metaclass.</p>
<p>Should we have a method that gets the instance type for a class' metaclass and handles this internally with an <code>unreachable!</code> instead?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:913 on 2025-02-28 16:53</div>
            <div class="timeline-body"><p>or instead of being an if/else, this could simply be <code>debug_assert!(false, &quot;{}&quot;, lookup_error.display(db, self));</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:1005 on 2025-02-28 17:00</div>
            <div class="timeline-body"><p>FWIW, I'm not totally convinced that we need to / should warn on this at all. It seems natural that if you don't have a class in your custom typeshed, then any special behavior we have around that class won't occur. If someone is doing this intentionally, it could be irritating to have a non-silencable warning about it (and using a &quot;minimalist&quot; typeshed doesn't seem like a crazy thing for someone to do intentionally). It could be accidental, but there are tons of ways a custom typeshed could quietly break things, it seems odd to warn about this specific one.</p>
<p>I don't feel strongly about it, though, what you have here seems fine and we can adjust with more experience.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:1660 on 2025-02-28 17:38</div>
            <div class="timeline-body"><p>I guess this is a wording nit, sort of related to my &quot;not sure we need to warn&quot; comment above -- but I slightly object to the framing of this as a &quot;broken&quot; typeshed. I think we should aim to consider typesheds where certain symbols aren't present or aren't what we expect to still be &quot;working&quot;, where some behaviors will just fall back to gradual typing. Maybe it doesn't really matter, but I'd prefer we don't accept the idea that it's OK for things to be &quot;broken&quot; because a minimal typeshed is used.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-02-28 17:44</div>
            <div class="timeline-body"><p>Looks great, thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-28 17:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:1005 on 2025-02-28 17:53</div>
            <div class="timeline-body"><p>hmmm... yeah, I originally suggested just logging it (so that the information would be available to us when debugging, but wouldn't be printed by default), but @MichaReiser suggested in https://github.com/astral-sh/ruff/issues/16302#issuecomment-2674484226 that a warning might be better... I think I'll switch it to being a LOG rather than a warning, so that you only get it if you specify <code>--verbose</code> on the CLI</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-28 17:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:1660 on 2025-02-28 17:59</div>
            <div class="timeline-body"><p>Fair enough. FWIW, we <em>do</em> panic (Salsa cycles etc.) if there's no <code>object</code> class in builtins; we did before this PR, and will continue to with this PR. I'm not sure I have the appetite to fix that &quot;bug&quot; :P</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-02-28 18:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:1660 on 2025-02-28 18:07</div>
            <div class="timeline-body"><p>If it's salsa cycles, I expect the panics will go away with fixpoint iteration? Will check! Not having <code>object</code> basically means everything is <code>Unknown</code> (because everything inherits <code>Unknown</code>)...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-28 18:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1132 on 2025-02-28 18:13</div>
            <div class="timeline-body"><p>interesting point -- yes, I think you're right!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/mdtest_custom_typeshed.md</code>:39 on 2025-03-09 10:59</div>
            <div class="timeline-body"><p>The changes in this PR do mean that it's a little harder for us to write tests with minimal custom typesheds. I still think that's preferable to having various stdlib symbols silently fallback to <code>Unknown</code> in the context of one of our mdtests, though. I've already run into situations where this has led to hard-to-debug issues when writing tests that use custom typesheds. In the context of one of our tests, I'd much rather have a panic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_project/tests/check.rs</code>:96 on 2025-03-09 11:01</div>
            <div class="timeline-body"><p>This is necessary because some of the parser and linter corpus files use e.g. <code>except *</code> syntax, for which we need the <code>BaseExceptionGroup</code> symbol to be available, and it's only available on Python 3.11+. We would have had to make this change anyway pretty soon, since we'll probably be integrating @ntBre's work on improved syntax-error detection into red-knot at some point in the next few weeks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:1037 on 2025-03-09 11:04</div>
            <div class="timeline-body"><p>I changed this so that it panics if <em>either</em> the <code>test</code> feature is enabled <em>or</em> the <code>debug_assertions</code> feature is enabled. That's because we have some tests for which the <code>test</code> feature is apparently not enabled (mdtests), and we have some tests that we only ever run in release-mode in CI (property tests). I think we probably want both to panic if a known-class symbol lookup unexpectedly fails, rather than silently falling back to <code>Unknown</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-03-09 11:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-09 12:07</div>
            <div class="timeline-body"><p>I've rebased this, addressed review comments and improved some docs. @carljm it's changed a bit since you last took a look; you might want to give it a quick once-over again to check you're still okay with it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-03-09 12:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_project/tests/check.rs</code>:96 on 2025-03-10 09:16</div>
            <div class="timeline-body"><p>I don't think this change is necessary for the syntax-work integration because this test only asserts that we can pull all types. It doesn't assert the absence of diagnostics.</p>
<p>It's not clear to me why this change is necessary for what you did in this PR. Does that mean that Red Knot now panics if someone uses <code>except *</code> but sets <code>python-version=3.9</code> in their project configuration?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:1037 on 2025-03-10 09:20</div>
            <div class="timeline-body"><p>The downside of panicking in tests is that we now never actually test the fallback behavior... So we won't know if it works as expected. I'm inclined to remove the panic case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:1323 on 2025-03-10 09:21</div>
            <div class="timeline-body"><p>Nit: Consider implementing <code>Display</code> for <code>KnownClass</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-10 09:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-03-10 09:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_project/tests/check.rs</code>:96 on 2025-03-10 09:26</div>
            <div class="timeline-body"><blockquote>
<p>I don't think this change is necessary for the syntax-work integration because this test only asserts that we can pull all types. It doesn't assert the absence of diagnostics.</p>
</blockquote>
<p>Hmm, fair point</p>
<blockquote>
<p>Does that mean that Red Knot now panics if someone uses <code>except *</code> but sets <code>python-version=3.9</code> in their project configuration?</p>
</blockquote>
<p>Only if the <code>test</code> or <code>debug_assertions</code> features is enabled for their red-knot build. Which shouldn't ever really be the case for end users of red-knot.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-10 09:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_project/tests/check.rs</code>:96 on 2025-03-10 09:28</div>
            <div class="timeline-body"><p>Yeah, not having any test coverage that red knot indeed doesn't panic in those cases those make me a little nervous and in favor of removing the panics.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-10 17:46</div>
            <div class="timeline-body"><p>@MichaReiser persuaded me in my 1:1 earlier that I should remove the panicking behaviour from <code>KnownClass::to_instance()</code>. I still don't <em>love</em> that some variants will silently (and unexpectedly) fallback to <code>Unknown</code> if you forget to add stubs for them when writing mdtests with custom typesheds. But at least we'll now emit debug logs to tell you about that (you just need to remember to enable logging if you're debugging your mdtest!).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @AlexWaygood on 2025-03-10 17:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-10 18:01</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @AlexWaygood on 2025-03-11 16:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-11 16:28</div>
            <div class="timeline-body"><p>I think I've addressed/removed all the controversial points in this, and Carl approved an earlier version -- scheduling automerge now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-03-11 16:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:1028 on 2025-03-11 16:38</div>
            <div class="timeline-body"><p>I made this <code>tracing::info!()</code> rather than <code>tracing::warn!()</code> or <code>tracing::debug!()</code>.</p>
<ul>
<li><code>tracing::warn!()</code> is always shown</li>
<li><code>tracing::info!()</code> is shown with <code>--verbose</code> but not otherwise.</li>
<li><code>tracing::debug!()</code> is only shown with <code>--verbose --verbose</code>, and a <em>lot</em> of other tracing events are emitted if you specify that level of verbosity</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-03-11 16:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-03-11 16:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-03-11 16:42</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:49:31 UTC
    </footer>
</body>
</html>
