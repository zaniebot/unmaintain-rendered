<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Correct modeling of dunder calls - astral-sh/ruff #16368</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Correct modeling of dunder calls</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16368">#16368</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-02-25 11:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Model dunder-calls correctly (and in one single place), by implementing this behavior (using <code>__getitem__</code> as an example).</p>
<pre><code class="language-py">def getitem_desugared(obj: object, key: object) -&gt; object:
    getitem_callable = find_in_mro(type(obj), &quot;__getitem__&quot;)
    if hasattr(getitem_callable, &quot;__get__&quot;):
        getitem_callable = getitem_callable.__get__(obj, type(obj))

    return getitem_callable(key)
</code></pre>
<p>See the new <code>calls/dunder.md</code> test suite for more information. The new behavior also needs much fewer lines of code (the diff is positive due to new tests).</p>
<h2>Test Plan</h2>
<p>New tests; fix TODOs in existing tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @sharkdp on 2025-02-25 11:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2025-02-25 11:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @sharkdp on 2025-02-25 11:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2025-02-25 11:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-25 12:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/binary/instances.md</code>:262 on 2025-02-25 12:34</div>
            <div class="timeline-body"><p>We can also get rid of the <code>Unknown</code> by declaring it as <code>A</code> (<code>__add__: A = A()</code>), so I don't think it's worthy a TODO. The test is fine as is, I think. In fact, declaring it using a callable type would &quot;hide&quot; the actual type of this specific callable (<code>A</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-02-25 12:55</div>
            <div class="timeline-body"><p>Nice how this ended up simplifying the implementation. I, obviously, didn't review the semantic changes. I'll leave that to someone else.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/call/callable_instance.md</code>:85 on 2025-02-25 14:25</div>
            <div class="timeline-body"><p>better might be</p>
<pre><code class="language-suggestion"># error: 15 [invalid-argument-type] &quot;Object of type `Literal[&quot;foo&quot;]` cannot be assigned to parameter 2 (`x`) of bound method `C.__call__`; expected type `int`&quot;
</code></pre>
<p>(definitely not a blocking comment!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/call/dunder.md</code>:8 on 2025-02-25 14:31</div>
            <div class="timeline-body"><p>Interesting -- I would probably just call <code>[]</code> a &quot;subscription&quot; (Brett <a href="https://snarky.ca/unravelling-subscriptions-in-python/">does similarly</a>) rather than an &quot;operator&quot; -- but subscriptions are indeed listed in the <a href="https://docs.python.org/3/reference/expressions.html#operator-precedence">operator precedence</a> section of the language reference.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/call/dunder.md</code>:19 on 2025-02-25 14:33</div>
            <div class="timeline-body"><p>readers of the test may not be familiar with this method. It's possibly not worth it to fill in the body here since it's not very relevant to the test, but you could maybe link to Brett's blog or the Descriptor HOWTO docs in the docstring for this function if readers want to find out how it works?</p>
<p>Though the function isn't that long IIRC; it might be easier just to define it here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/call/dunder.md</code>:32 on 2025-02-25 14:35</div>
            <div class="timeline-body"><p>(It might be worth explicitly laying out that the semantics here are actually just a specific example of the semantics described in the <code>## Operating on instances</code> section you have immediately below)</p>
<pre><code class="language-suggestion">If we invoke a dunder method on a class, it is looked up on the *meta* class, since any class is an instance of its metaclass:
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/call/dunder.md</code>:88 on 2025-02-25 14:49</div>
            <div class="timeline-body"><p>and indeed, if you call the <code>__getitem__</code> method <em>directly</em> on the instance (<code>this_fails.__getitem__(this_fails, 0)</code>) rather than implicitly calling <code>__getitem__</code> using the <code>[]</code> syntax, that should also work</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-02-25 14:51</div>
            <div class="timeline-body"><p>excellent!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-25 15:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/call/callable_instance.md</code>:85 on 2025-02-25 15:47</div>
            <div class="timeline-body"><p>I wanted to do something like this at first, but then we probably need to construct a <code>String</code> for callable names instead of relying on <code>str</code> slices. Happy to make that change though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/binary/instances.md</code>:262 on 2025-02-25 16:29</div>
            <div class="timeline-body"><p>Yeah I think this is less a TODO and more a commentary on why <code>Unknown</code> is in the revealed type, since it may not be obvious at first.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/call/callable_instance.md</code>:85 on 2025-02-25 16:32</div>
            <div class="timeline-body"><p>I had the same thought on the previous diff that improved error messages, that ultimately probably we don't need to describe &quot;function&quot; vs &quot;bound method&quot; vs &quot;wrapper-descriptor&quot;, we can probably replace all of that with fully-qualified (within the module) function names (e.g. <code>C.f.__get__</code> already clarifies that this is is the <code>__get__</code> method of the function <code>f</code> in the class <code>C</code>, and is more similar to how things look in runtime messages). I think this is worth creating an issue for but isn't necessarily urgent.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/call/dunder.md</code>:8 on 2025-02-25 16:34</div>
            <div class="timeline-body"><p>I think it's correct to call it an operator, and I don't see it being confusing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/call/dunder.md</code>:19 on 2025-02-25 16:36</div>
            <div class="timeline-body"><p>I feel like regardless of familiarity, the name is sufficient here to explain what it does, and implementing it might be a distraction from the main point here, which is about descriptor behavior, not how names are looked up in base classes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-02-25 16:51</div>
            <div class="timeline-body"><p>Excellent!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-25 17:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/call/dunder.md</code>:8 on 2025-02-25 17:09</div>
            <div class="timeline-body"><blockquote>
<p>I think it's correct to call it an operator</p>
</blockquote>
<p>I didn't say otherwise. I linked to a section of the docs that confirm that it's correct!</p>
<p>This was more just me musing that &quot;the index operator&quot; isn't the term I would usually use to describe subscriptions. It wasn't really a demand for any change. Sorry if that was unclear.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-25 17:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/call/dunder.md</code>:19 on 2025-02-25 17:10</div>
            <div class="timeline-body"><blockquote>
<p>I feel like regardless of familiarity, the name is sufficient here to explain what it does</p>
</blockquote>
<p>Hmm, I sort-of disagree. I do agree that the implementation of the method isn't the main point of the test, but I think an inline link to the Descriptor HOWTO (for example), which provides an implementation of this function, wouldn't really distract readers</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-25 18:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/call/dunder.md</code>:19 on 2025-02-25 18:41</div>
            <div class="timeline-body"><blockquote>
<p>I think an inline link to the Descriptor HOWTO (for example), which provides an implementation of this function, wouldn't really distract readers</p>
</blockquote>
<p>Feels like a good compromise to me. I might also change that example here again when working on https://github.com/astral-sh/ruff/issues/16367</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-25 18:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/call/callable_instance.md</code>:85 on 2025-02-25 18:56</div>
            <div class="timeline-body"><blockquote>
<p>e.g. <code>C.f.__get__</code> already clarifies that this is is the <code>__get__</code> method of the function <code>f</code> in the class <code>C</code></p>
</blockquote>
<p>Consider the CPython error messages here (and imagine that everything &quot;above the fold&quot; is not visible in the current view):</p>
<pre><code class="language-py">class C:
    def f(self, x: int) -&gt; str:
        return str(x)

c = C()

# ------------

# C.f() missing 2 required positional arguments: 'self' and 'x'
C.f()

# C.f() missing 1 required positional argument: 'x'
c.f()
</code></pre>
<p>The notation <code>C.f()</code> which CPython uses does not clarify if we are calling the function <code>f</code> or the bound method <code>f</code>. Sure, the <code>self</code> gives it away, but adding that additional piece of information (function vs bound method) seems like it could be potentially helpful.</p>
<blockquote>
<p>and is more similar to how things look in runtime messages</p>
</blockquote>
<p>It feels to me like innovation in this area is not necessarily a bad thing, as long as we don't digress too far from established norms. We already <em>do</em> provide much better error messages than CPython. But that does not mean that they can't be better still. That's a general comment and not necessarily related to my changes earlier today. I'm happy to revisit them. I can open a ticket to discuss this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/snapshots/for.md_-_For_loops_-_Possibly-not-callable_`__getitem__`_method.snap</code>:81 on 2025-02-25 19:14</div>
            <div class="timeline-body"><p>@AlexWaygood Looks like the half-life of these snapshot tests was rather small :smile:. Do these new messages look okay to you? I think they are more correct now, but not necessarily more helpful. If we want to keep the current display-output of bound-method callable types, maybe we should consider reducing the verbosity in a different way here? I can look at this in a follow up, if we think it's worth doing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-25 19:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-25 19:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/snapshots/for.md_-_For_loops_-_Possibly_invalid_`__iter__`_methods.snap</code>:55 on 2025-02-25 19:17</div>
            <div class="timeline-body"><p>oh no, I didn't think it could get worse than <code>Literal[__iter__, __iter__]</code> ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-25 19:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/snapshots/for.md_-_For_loops_-_Possibly-not-callable_`__getitem__`_method.snap</code>:81 on 2025-02-25 19:23</div>
            <div class="timeline-body"><p>Oh no, what are you doing to my beautiful <code>not-iterable</code> diagnostics ðŸ˜†</p>
<p>but yes, no need for the PR to be blocked on this. Ideally I think we'd make several changes to how we talk about callable types in diagnostic messages:</p>
<ul>
<li>I don't think the <code>Literal[f]</code> display is working for us really; I think it's going to be pretty confusing for users. I'd vote for changing the display to <code>&lt;function f&gt;</code></li>
<li>I still think using the fully qualified name (with the module prepended) would be clearer in nearly all cases, and wouldn't make things much more verbose (e.g. <code>&lt;function foo.f&gt;</code></li>
<li>We may want to add a method to <code>FunctionType</code> and the various other <code>CallableType</code>s that pretty-prints the callable <em>signature</em> (<code>(str, int) -&gt; bytes</code>, or <code>def f(x: str, y: int) -&gt; bytes</code>, or similar), for uses in diagnostics like this. It's obviously no good referring to the function by (qualified) name if there are two functions in the same scope with the same name, but different signatures.</li>
</ul>
<p>All told, the function-literal display issues were already the weakest part of the <code>not-iterable</code> diagnostics prior to this PR, and I think we need to fix it holistically since it affects our diagnostic rendering in general -- it was already on my mind :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-25 19:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/call/dunder.md</code>:88 on 2025-02-25 19:25</div>
            <div class="timeline-body"><p>Sorry, took a while, but after reading it the third time, I realized that you proposed a much nicer way to formulate this section here. Changed now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-25 19:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/snapshots/for.md_-_For_loops_-_Possibly-not-callable_`__getitem__`_method.snap</code>:81 on 2025-02-25 19:26</div>
            <div class="timeline-body"><p>Alright, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2025-02-25 19:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-02-25 19:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-25 19:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-02-25 21:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/call/callable_instance.md</code>:85 on 2025-02-25 21:10</div>
            <div class="timeline-body"><blockquote>
<p>adding that additional piece of information (function vs bound method) seems like it could be potentially helpful.</p>
</blockquote>
<p>Yes, I agree this is helpful.</p>
<blockquote>
<p>innovation in this area is not necessarily a bad thing</p>
</blockquote>
<p>And I agree with this too!</p>
<p>I still think qualified name display will help messages be less ambiguous overall, and may allow us to remove some of the distinctions between function kinds -- but I definitely don't think we should closely hew to whatever the runtime does, and I think you're right that specifically distinguishing bound methods may be useful.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:10:20 UTC
    </footer>
</body>
</html>
