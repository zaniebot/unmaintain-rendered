```yaml
number: 5825
title: "perf(formatter): Improve `is_expression_parenthesized` performance"
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: perf-is-expression-parenthesized
created_at: 2023-07-17T08:18:44Z
updated_at: 2023-07-18T13:48:50Z
url: https://github.com/astral-sh/ruff/pull/5825
synced_at: 2026-01-12T03:30:21Z
```

# perf(formatter): Improve `is_expression_parenthesized` performance

---

_Pull request opened by @MichaReiser on 2023-07-17 08:18_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This PR improves the performance of `is_expression_parenthesized` by removing the unnecessary check whether the `(` is part of a comment **if** the token is on the same line as the start character of the expression.
Omitting the check for characters on the same line as the expression start is safe because, if there's a comment, then the expression would be commented out too. 

This brings down the formatting time of [this large file](https://github.com/angr/angr/blob/master/angr/procedures/definitions/win32_fwpuclnt.py) from 16s to 600ms

<!-- What's the purpose of the change? What does it do, and why? -->

## Test Plan

`cargo test`

<!-- How was it tested? -->


---

_Comment by @MichaReiser on 2023-07-17 08:18_

Current dependencies on/for this PR:
* main
  * **PR #5825** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5825" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/5825?utm_source=stack-comment).

---

_Comment by @github-actions[bot] on 2023-07-17 08:34_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     11.0Â±0.03ms     3.7 MB/sec    1.00     11.0Â±0.03ms     3.7 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.2Â±0.00ms     7.5 MB/sec    1.00      2.2Â±0.00ms     7.5 MB/sec
formatter/numpy/globals.py                 1.00    249.1Â±0.60Âµs    11.8 MB/sec    1.00    250.0Â±0.64Âµs    11.8 MB/sec
formatter/pydantic/types.py                1.02      4.8Â±0.01ms     5.3 MB/sec    1.00      4.8Â±0.03ms     5.4 MB/sec
linter/all-rules/large/dataset.py          1.00     15.8Â±0.08ms     2.6 MB/sec    1.01     16.0Â±0.11ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.0Â±0.00ms     4.2 MB/sec    1.02      4.1Â±0.07ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.00    524.0Â±0.61Âµs     5.6 MB/sec    1.03    538.9Â±3.22Âµs     5.5 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.1Â±0.01ms     3.6 MB/sec    1.01      7.2Â±0.04ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.00      7.9Â±0.01ms     5.2 MB/sec    1.02      8.0Â±0.02ms     5.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1686.8Â±3.08Âµs     9.9 MB/sec    1.05   1775.0Â±4.67Âµs     9.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    189.1Â±7.14Âµs    15.6 MB/sec    1.08    203.5Â±0.89Âµs    14.5 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.5Â±0.01ms     7.2 MB/sec    1.03      3.6Â±0.01ms     7.0 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01     13.0Â±0.24ms     3.1 MB/sec    1.00     12.9Â±0.21ms     3.2 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.6Â±0.05ms     6.5 MB/sec    1.00      2.6Â±0.04ms     6.5 MB/sec
formatter/numpy/globals.py                 1.00    291.7Â±9.48Âµs    10.1 MB/sec    1.02   297.7Â±14.82Âµs     9.9 MB/sec
formatter/pydantic/types.py                1.01      5.6Â±0.13ms     4.5 MB/sec    1.00      5.6Â±0.10ms     4.6 MB/sec
linter/all-rules/large/dataset.py          1.00     18.6Â±0.27ms     2.2 MB/sec    1.01     18.8Â±0.22ms     2.2 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.9Â±0.13ms     3.4 MB/sec    1.00      4.9Â±0.06ms     3.4 MB/sec
linter/all-rules/numpy/globals.py          1.00   591.1Â±11.42Âµs     5.0 MB/sec    1.01    596.5Â±9.12Âµs     4.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      8.3Â±0.10ms     3.1 MB/sec    1.01      8.4Â±0.20ms     3.0 MB/sec
linter/default-rules/large/dataset.py      1.00      9.6Â±0.13ms     4.2 MB/sec    1.01      9.7Â±0.10ms     4.2 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00      2.0Â±0.03ms     8.3 MB/sec    1.02      2.1Â±0.03ms     8.1 MB/sec
linter/default-rules/numpy/globals.py      1.00    230.6Â±5.70Âµs    12.8 MB/sec    1.05    242.7Â±4.26Âµs    12.2 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.3Â±0.09ms     6.0 MB/sec    1.01      4.3Â±0.07ms     5.9 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Review requested from @konstin by @MichaReiser on 2023-07-17 08:59_

---

_Label `formatter` added by @MichaReiser on 2023-07-17 08:59_

---

_@konstin approved on 2023-07-18 12:02_

:rocket: 

---

_Merged by @MichaReiser on 2023-07-18 13:48_

---

_Closed by @MichaReiser on 2023-07-18 13:48_

---

_Branch deleted on 2023-07-18 13:48_

---
