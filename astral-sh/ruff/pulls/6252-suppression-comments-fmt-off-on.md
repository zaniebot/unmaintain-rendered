```yaml
number: 6252
title: "Suppression comments: `fmt: off..on`"
type: pull_request
state: closed
author: MichaReiser
labels: []
assignees: []
draft: true
base: tombstone-element
head: fmt-off-on
created_at: 2023-08-01T16:20:15Z
updated_at: 2024-01-16T10:03:29Z
url: https://github.com/astral-sh/ruff/pull/6252
synced_at: 2026-01-12T15:55:21Z
```

# Suppression comments: `fmt: off..on`

---

_@MichaReiser_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This is a draft of the `fmt: off` / `fmt: on` suppression comment formatting. I admint, it feels a bit hacky but it mostly works (there's some instability now that I handle `fmt: off` comments in trailing comments too, but that can be fixed by writing the right amount of newlines). 

The implementation is a post-traversal on the formatted IR. It searches for sections of `fmt: off`..`fmt: on`, replaces all existing content with `FormatElement::Tombstone`, and instead inserts a verbatim node with the source code. 

Why this approach instead of handling it during formatting. The main reason is that Black allows `fmt: off` in all possible positions: E.g. the following is valid:

```python
def a(
	b,
	# fmt: off
	c,   d, eee, ff
): ...
```

The issue is, that the arguments formatting would now need to check whether the next argument is suppressed, and if that's the case, omit the `,` and newline after the argument, but only if the next argument is also suppressed. It would be necessary to add this kind of check everywhere where we iterate over a node sequence, which seems cumbersome. 

## Downsides

* The suppression comments are not a viable option when the formatter panics during formatting (because we still format the whole file)
* Suppression comments won't help to speed up the formatting of very large files.

## Alternatives

We could decide to only support `fmt: off` and `fmt: on` at the statements level. I collected a few numbers and it seems that using `fmt: off` to suppress expression seems somewhat common and is e.g. useful when disabling formatting for the if condition. 

```
ruff_python_formatter::comments::map::InOrderEntry                         5_029_089       15_032            0
ruff_python_formatter::comments::map::OutOfOrderEntry                          1_904            9            0
ruff_python_formatter::comments::visitor::ExpressionSuppressionComment           956            1            0
ruff_python_formatter::comments::visitor::OtherSuppressionComment                 66            1            0
ruff_python_formatter::comments::visitor::StatementSuppressionComment         16_482            1            0
                                                                                total     max_live         live
```



<!-- What's the purpose of the change? What does it do, and why? -->

## Test Plan

<!-- How was it tested? -->


---

_Comment by @MichaReiser on 2023-08-01 16:20_

Current dependencies on/for this PR:
* main
  * **PR #6251** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6251" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #6252** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6252" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6252?utm_source=stack-comment).

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/tests/snapshots/black_compatibility@simple_cases__fmtonoff.py.snap`:206 on 2023-08-01 16:42_

We incorrectly remove the trailing comma because we don't know that it is part of the value (it has no source information attached). It works as expected if the dictionary contains a `fmt: on` comment.

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/tests/snapshots/black_compatibility@simple_cases__fmtonoff.py.snap`:216 on 2023-08-01 16:42_

But it does ;)

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/tests/snapshots/black_compatibility@simple_cases__fmtonoff.py.snap`:238 on 2023-08-01 16:43_

TODO: double check why this trailing comma is added and what happens if the argument already had a trailing comma

---

_@MichaReiser reviewed on 2023-08-01 16:44_

---

_Comment by @github-actions[bot] on 2023-08-01 16:53_

## PR Check Results
### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      8.1Â±0.06ms     5.0 MB/sec    1.06      8.6Â±0.17ms     4.7 MB/sec
formatter/numpy/ctypeslib.py               1.00  1628.9Â±28.38Âµs    10.2 MB/sec    1.06  1727.0Â±46.37Âµs     9.6 MB/sec
formatter/numpy/globals.py                 1.00    180.5Â±0.91Âµs    16.3 MB/sec    1.07    193.6Â±6.79Âµs    15.2 MB/sec
formatter/pydantic/types.py                1.00      3.5Â±0.03ms     7.3 MB/sec    1.09      3.8Â±0.12ms     6.7 MB/sec
linter/all-rules/large/dataset.py          1.01     11.2Â±0.16ms     3.6 MB/sec    1.00     11.1Â±0.15ms     3.7 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      2.8Â±0.08ms     5.9 MB/sec    1.00      2.8Â±0.01ms     5.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    383.5Â±1.28Âµs     7.7 MB/sec    1.00    384.8Â±0.92Âµs     7.7 MB/sec
linter/all-rules/pydantic/types.py         1.01      5.0Â±0.11ms     5.1 MB/sec    1.00      5.0Â±0.10ms     5.1 MB/sec
linter/default-rules/large/dataset.py      1.01      5.8Â±0.08ms     7.0 MB/sec    1.00      5.8Â±0.02ms     7.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01  1208.4Â±16.54Âµs    13.8 MB/sec    1.00   1200.8Â±6.87Âµs    13.9 MB/sec
linter/default-rules/numpy/globals.py      1.00    131.8Â±3.40Âµs    22.4 MB/sec    1.01    133.5Â±0.30Âµs    22.1 MB/sec
linter/default-rules/pydantic/types.py     1.01      2.6Â±0.07ms     9.8 MB/sec    1.00      2.6Â±0.04ms    10.0 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     10.3Â±0.15ms     4.0 MB/sec    1.05     10.8Â±0.25ms     3.8 MB/sec
formatter/numpy/ctypeslib.py               1.00  1985.7Â±49.08Âµs     8.4 MB/sec    1.00  1982.1Â±71.62Âµs     8.4 MB/sec
formatter/numpy/globals.py                 1.00    210.4Â±3.95Âµs    14.0 MB/sec    1.06   222.8Â±13.40Âµs    13.2 MB/sec
formatter/pydantic/types.py                1.00      4.3Â±0.08ms     5.9 MB/sec    1.02      4.4Â±0.07ms     5.8 MB/sec
linter/all-rules/large/dataset.py          1.00     14.2Â±0.32ms     2.9 MB/sec    1.00     14.2Â±0.33ms     2.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.7Â±0.08ms     4.5 MB/sec    1.00      3.7Â±0.07ms     4.6 MB/sec
linter/all-rules/numpy/globals.py          1.01   447.1Â±10.15Âµs     6.6 MB/sec    1.00    443.2Â±9.01Âµs     6.7 MB/sec
linter/all-rules/pydantic/types.py         1.02      6.5Â±0.24ms     3.9 MB/sec    1.00      6.4Â±0.21ms     4.0 MB/sec
linter/default-rules/large/dataset.py      1.00      7.7Â±0.16ms     5.3 MB/sec    1.00      7.7Â±0.15ms     5.3 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.02  1551.2Â±41.51Âµs    10.7 MB/sec    1.00  1516.9Â±20.38Âµs    11.0 MB/sec
linter/default-rules/numpy/globals.py      1.02    171.5Â±7.53Âµs    17.2 MB/sec    1.00    168.2Â±4.73Âµs    17.5 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.4Â±0.07ms     7.6 MB/sec    1.00      3.4Â±0.07ms     7.6 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Review comment by @konstin on `crates/ruff_formatter/src/format_element.rs`:78 on 2023-08-03 08:59_

nit: maybe:
```suggestion
        if elements.len() > 2 {
            Some(FormatElement::Interned(Interned::new(elements)))
        } else {
            elements.pop()
        }
```

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/comments/format.rs`:85 on 2023-08-03 09:04_

```suggestion
    /// `# fmt: off`
    FormatOff,
    /// `# fmt: on`
    FormatOn,
```

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/lib.rs`:188 on 2023-08-03 09:19_

i'm in favor of warnings in that case independent of how we handle it

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/lib.rs`:255 on 2023-08-03 09:24_

these don't need tombstones?

---

_@konstin reviewed on 2023-08-03 09:26_

---

_Comment by @davidszotten on 2023-08-03 10:38_

> Suppression comments won't help to speed up the formatting of very large files.

should we consider doing both? ie supporting some statement level during formatting and only doing the ones inside expressions as post traversal?

---

_Comment by @MichaReiser on 2023-08-03 11:53_

> > Suppression comments won't help to speed up the formatting of very large files.
> 
> should we consider doing both? ie supporting some statement level during formatting and only doing the ones inside expressions as post traversal?

Doing both comes at a maintenance cost (need to test that both cases work) and introduces additional complexity (which, can reduce performance for all cases where no suppressions are used). I don't think comfortable justifying this without having concrete use cases where performance is a problem and disabling formatting for the whole file isn't a viable solution. 

---

_Comment by @MichaReiser on 2023-08-04 12:53_

I still like this approach a lot, but it will restrict us never to move a comment, or it may cause invalid syntax:

```python
re.compile(
    # fmt: off
    a
    # fmt: on
    ,
    re.MULTILINE|re.VERBOSE
)

# Before applying suppression
re.compile(
    # fmt: off
    a,
    # fmt: on
    re.MULTILINE | re.VERBOSE,
)

# Output
re.compile(
    # fmt: off
    a
    # fmt: on
    re.MULTILINE | re.VERBOSE,
)
```

The output misses a `,` after the `a` argument because our formatter associates the `fmt: on` with the `re.MULTILINE` node. Whether this is correct or not is not important, it just shows that a comment moving can introduce syntax errors and there's no good way for us to detect at least that we messed up and provide guidance (We could parse the whole file, but still)

I want to keep the ability to move comments because I'm convinced this ability allows better formatting overall. 

---

_Closed by @MichaReiser on 2023-08-04 12:53_

---

_Branch deleted on 2024-01-16 10:03_

---
