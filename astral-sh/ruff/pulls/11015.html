<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add a script to fuzz the parser (courtesy of `pysource-codegen`) - astral-sh/ruff #11015</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add a script to fuzz the parser (courtesy of <code>pysource-codegen</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11015">#11015</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-04-18 19:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-04-18 19:40</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR adds a script that can be used to fuzz the parser against randomly generated, syntactically correct Python source-code files.</p>
<h2>Test Plan</h2>
<p>I reverted the <code>crates/ruff_python_parser</code> directory back to how it was as of https://github.com/astral-sh/ruff/commit/13ffb5bc1936493816f01fb5583359e3d8fffca7 (in order to deliberately reintroduce some parser bugs), then ran the script several times with various invocations. Example output with the bugs reintroduced:</p>
<details>

<pre><code>(ruff) (add-fuzzing-script)‚ö° % python crates/ruff_python_parser/scripts/fuzz.py 0-6 50 100-200                                                                                                         ~/dev/ruff
Concurrently running the fuzzer on 109 randomly generated source-code files...
Ran fuzzer successfully on seed 5
Ran fuzzer successfully on seed 1
Ran fuzzer successfully on seed 104
Ran fuzzer successfully on seed 0
Ran fuzzer successfully on seed 2
Ran fuzzer successfully on seed 3
Ran fuzzer successfully on seed 105
Ran fuzzer successfully on seed 101
Ran fuzzer successfully on seed 4
Ran fuzzer successfully on seed 103
Ran fuzzer successfully on seed 102
Ran fuzzer successfully on seed 100
Ran fuzzer successfully on seed 50
Ran fuzzer successfully on seed 106
Ran fuzzer successfully on seed 107
Ran fuzzer successfully on seed 116
Ran fuzzer successfully on seed 109
Ran fuzzer successfully on seed 108
Ran fuzzer successfully on seed 111
Ran fuzzer successfully on seed 114
Ran fuzzer successfully on seed 110
Ran fuzzer successfully on seed 118
Ran fuzzer successfully on seed 117
Ran fuzzer successfully on seed 113
Ran fuzzer successfully on seed 112
Ran fuzzer successfully on seed 119
Ran fuzzer successfully on seed 115
Ran fuzzer successfully on seed 120
Ran fuzzer successfully on seed 121
Ran fuzzer successfully on seed 124
Ran fuzzer successfully on seed 126
Ran fuzzer successfully on seed 122
Ran fuzzer successfully on seed 125
Ran fuzzer successfully on seed 129
Ran fuzzer successfully on seed 131
Ran fuzzer successfully on seed 127
Ran fuzzer successfully on seed 123
Ran fuzzer successfully on seed 133
Ran fuzzer successfully on seed 130
Ran fuzzer successfully on seed 135
Ran fuzzer successfully on seed 132
Ran fuzzer successfully on seed 128
Ran fuzzer successfully on seed 136
Ran fuzzer successfully on seed 138
Ran fuzzer successfully on seed 137
Ran fuzzer successfully on seed 134
Ran fuzzer successfully on seed 139
Ran fuzzer successfully on seed 140
Ran fuzzer successfully on seed 143
Ran fuzzer successfully on seed 142
Ran fuzzer successfully on seed 141
Ran fuzzer successfully on seed 150
Ran fuzzer successfully on seed 145
Ran fuzzer successfully on seed 144
Ran fuzzer successfully on seed 147
Ran fuzzer successfully on seed 148
Ran fuzzer successfully on seed 153
Ran fuzzer successfully on seed 154
Ran fuzzer successfully on seed 149
Ran fuzzer successfully on seed 151
Ran fuzzer successfully on seed 158
Ran fuzzer successfully on seed 160
Ran fuzzer successfully on seed 156
Ran fuzzer successfully on seed 159
Ran fuzzer successfully on seed 155
Ran fuzzer successfully on seed 157
Ran fuzzer successfully on seed 161
Ran fuzzer successfully on seed 163
Ran fuzzer successfully on seed 162
Ran fuzzer successfully on seed 165
Ran fuzzer successfully on seed 164
Ran fuzzer successfully on seed 166
Ran fuzzer successfully on seed 170
Ran fuzzer successfully on seed 167
Ran fuzzer successfully on seed 168
Ran fuzzer successfully on seed 171
Ran fuzzer successfully on seed 169
Ran fuzzer successfully on seed 175
Ran fuzzer successfully on seed 172
Ran fuzzer successfully on seed 173
Ran fuzzer successfully on seed 180
Ran fuzzer successfully on seed 174
Ran fuzzer successfully on seed 178
Ran fuzzer successfully on seed 181
Ran fuzzer successfully on seed 182
Ran fuzzer successfully on seed 177
Ran fuzzer successfully on seed 183
Ran fuzzer successfully on seed 179
Ran fuzzer successfully on seed 176
Ran fuzzer successfully on seed 186
Ran fuzzer successfully on seed 188
Ran fuzzer successfully on seed 190
Ran fuzzer successfully on seed 187
Ran fuzzer successfully on seed 184
Ran fuzzer successfully on seed 189
Ran fuzzer successfully on seed 194
Ran fuzzer successfully on seed 185
Ran fuzzer successfully on seed 193
Ran fuzzer successfully on seed 195
Ran fuzzer successfully on seed 192
Ran fuzzer successfully on seed 191
Ran fuzzer successfully on seed 197
Ran fuzzer successfully on seed 199
Ran fuzzer successfully on seed 196
Ran fuzzer successfully on seed 198
Ran fuzzer on seed 6
The following code triggers a bug:

for name_3[name_1 &gt; name_2] in name_4:
    pass

Ran fuzzer on seed 146
The following code triggers a bug:

with (name_3 async for name_1 in name_0) if name_5 else name_2:
    pass

Ran fuzzer on seed 152
The following code triggers a bug:

for name_2[name_4 not in name_5] in ():
    pass

Ran fuzzer on seed 200
The following code triggers a bug:

with (name_4 if name_2 else name_5) and name_0:
    pass

Bugs found in the following seeds:
6 146 152 200
</code></pre>
</details>

<p>Screenshot to show how it looks with colour:</p>
<details>

<p><img src="https://github.com/astral-sh/ruff/assets/66076021/9d637796-a5f5-4c44-99c4-817ab86bee99" alt="image" /></p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2024-04-18 19:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2024-04-18 19:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @AlexWaygood on 2024-04-18 19:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-04-18 19:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_parser/scripts/fuzz_parser.py</code>:1 on 2024-04-18 19:41</div>
            <div class="timeline-body"><p>No idea if this is the correct place to put this script! This adds a whole new <code>scripts/</code> directory to the crate</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-04-18 19:57</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>‚úÖ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>‚úÖ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_python_parser/scripts/fuzz_parser.py</code>:11 on 2024-04-18 20:43</div>
            <div class="timeline-body"><pre><code class="language-suggestion">- Run the fuzzer using seeds 0, 1, 2, 78 and 93 to generate the code:
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_python_parser/scripts/fuzz_parser.py</code>:165 on 2024-04-18 20:53</div>
            <div class="timeline-body"><p>I was thinking we'd have to actually partition the list of seeds, but we don't; we just feed them to the executors one by one, which is a lot simpler (and balances better, too.)</p>
<p>That also means technically we wouldn't have to fully materialize the list of seeds like we do now; instead we <em>could</em> just store the <code>list[int | range]</code> here, and have a method that yields seeds one at a time.</p>
<p>But I think this doesn't really matter, and for smaller sizes of list, materializing is probably faster than a generator.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-04-18 20:53</div>
            <div class="timeline-body"><p>Code looks good to me! Comments are just a typo and something that's probably not worth acting on.</p>
<p>The location of the script seems reasonable to me, but you could wait for someone who actually knows something about preferred ruff directory structure to comment on that, if you want to.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/scripts/fuzz_parser.py</code>:147 on 2024-04-19 05:52</div>
            <div class="timeline-body"><p>Did I nerd snip you into making it concurrent :D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/scripts/fuzz_parser.py</code>:191 on 2024-04-19 05:53</div>
            <div class="timeline-body"><p>This is nice. So we can also just use it to test the parser in general.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-04-19 05:53</div>
            <div class="timeline-body"><p>Thank you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2024-04-19 05:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-04-19 09:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_parser/scripts/fuzz_parser.py</code>:147 on 2024-04-19 09:46</div>
            <div class="timeline-body"><p>Maybe üòÅ @carljm and I looked at it in our pairing session yesterday</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-04-19 09:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_parser/scripts/fuzz_parser.py</code>:147 on 2024-04-19 09:46</div>
            <div class="timeline-body"><p>Making it concurrent was a very good call, though. It's <em>much</em> faster now :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/scripts/fuzz_parser.py</code>:1 on 2024-04-19 10:13</div>
            <div class="timeline-body"><p>We have a <code>scripts</code> directory at the project root, I would just put it there in a subdirectory along with a <code>requirements.in</code> (and generated <code>requirements.txt</code>) file. And, the module docstring could go in the <code>README.md</code> of that directory. Refer to <code>scripts/release</code> or <code>scripts/benchmarks</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/scripts/fuzz_parser.py</code>:8 on 2024-04-19 10:14</div>
            <div class="timeline-body"><p>As mentioned, we can include a <code>requirements.in</code> (and <code>uv</code> generated <code>requirements.txt</code>) file for this)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2024-04-19 10:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-04-19 10:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/scripts/fuzz_parser.py</code>:1 on 2024-04-19 10:17</div>
            <div class="timeline-body"><p>Or, if you prefer to keep it in <code>ruff_python_parser</code>, we could rename it to <code>fuzz</code> instead to make the intent clear</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-04-19 11:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_parser/scripts/fuzz_parser.py</code>:1 on 2024-04-19 11:26</div>
            <div class="timeline-body"><p>I moved it to the <code>scripts/</code> directory. I'd rather keep the module docstring, though, as it currently doubles as the text that's shown if you pass <code>-h</code> or <code>--help</code> as a CLI argument to the script:</p>
<details>

<pre><code>(ruff) (add-fuzzing-script) % py scripts/fuzz-parser/fuzz.py -h                                                                                                                                        ~/dev/ruff
usage: fuzz.py [-h] [--only-new-bugs] [--quiet] seeds [seeds ...]

Run the parser on randomly generated (but syntactically valid) Python source-code files.

To install all dependencies for this script into an environment using `uv`, run:
    uv pip install -r scripts/fuzz-parser/requirements.txt

Example invocations of the script:
- Run the fuzzer using seeds 0, 1, 2, 78 and 93 to generate the code:
  `python scripts/fuzz-parser/fuzz.py 0-2 78 93`
- Run the fuzzer concurrently using seeds in range 0-10 inclusive,
  but only reporting bugs that are new on your branch:
  `python scripts/fuzz-parser/fuzz.py 0-10 --new-bugs-only`
- Run the fuzzer concurrently on 10,000 different Python source-code files,
  and only print a summary at the end:
  `python scripts/fuzz-parser/fuzz.py 1-10000 --quiet

N.B. The script takes a few seconds to get started, as the script needs to compile
your checked out version of ruff with `--release` as a first step before it
can actually start fuzzing.

positional arguments:
  seeds            Either a single seed, or an inclusive range of seeds in the format `0-5`

options:
  -h, --help       show this help message and exit
  --only-new-bugs  Only report bugs if they exist on the current branch, but *didn't* exist on the released version of Ruff installed into the Python environment we're running in
  --quiet          Print fewer things to the terminal while running the fuzzer
</code></pre>
</details>

<p>There also doesn't actually seem to be a <code>README.md</code> file for the <code>scripts/</code> directory right now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2024-04-19 11:33</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2024-04-19 11:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-04-19 11:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-04-19 11:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-04-19 11:44</div>
            <div class="timeline-body"><p>Cc. @15r10nk -- <code>pysource-codegen</code> is awesome :-) an early version of this script helped us find several bugs in our new parser before releasing Ruff 0.4!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/15r10nk">@15r10nk</a> on 2024-04-19 12:04</div>
            <div class="timeline-body"><p>That's great :rocket:. It makes me really happy to know that pysource-codegen is useful for you.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 22:37:37 UTC
    </footer>
</body>
</html>
