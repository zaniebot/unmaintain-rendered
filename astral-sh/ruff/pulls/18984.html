<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Request configuration from client - astral-sh/ruff #18984</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Request configuration from client</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18984">#18984</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-06-27 13:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR makes the necessary changes to the server that it can request configurations from the client using the <code>configuration</code> request.
This PR doesn't make use of the request yet. It only sets up the foundation (mainly the coordination between client and server)
so that future PRs could pull specific settings.</p>
<p>I plan to use this for pulling the Python environment from the Python extension.</p>
<p>Deno does something very similar to this.</p>
<h2>Test Plan</h2>
<p>Tested that diagnostics are still shown.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MichaReiser on 2025-06-27 13:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MichaReiser on 2025-06-27 13:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @MichaReiser on 2025-06-27 13:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @MichaReiser on 2025-06-27 13:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @MichaReiser on 2025-06-27 13:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @MichaReiser on 2025-06-27 13:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-27 13:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server.rs</code>:230 on 2025-06-27 13:29</div>
            <div class="timeline-body"><p>I decided to change all the <code>Client</code> methods to not return a <code>Result</code> if the only reason why they can fail is if the channel <code>Receiver</code> gets dropped. The main motivation is that this should never happen. The <code>main_loop</code> receiver is always alive for as long as the <code>Server</code> is alive. The client receiver could die due to a panic in that thread. That's why we keep writing a log message but we no longer propagate the <code>Result</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-27 13:29</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">dulwich (https://github.com/dulwich/dulwich)
- TOTAL MEMORY USAGE: ~156MB
+ TOTAL MEMORY USAGE: ~142MB
-     memo fields = ~129MB
+     memo fields = ~117MB

alerta (https://github.com/alerta/alerta)
- TOTAL MEMORY USAGE: ~106MB
+ TOTAL MEMORY USAGE: ~117MB

discord.py (https://github.com/Rapptz/discord.py)
-     memo fields = ~207MB
+     memo fields = ~189MB

tornado (https://github.com/tornadoweb/tornado)
-     memo fields = ~129MB
+     memo fields = ~142MB

freqtrade (https://github.com/freqtrade/freqtrade)
-     memo fields = ~276MB
+     memo fields = ~304MB

paasta (https://github.com/yelp/paasta)
-     memo fields = ~171MB
+     memo fields = ~156MB

static-frame (https://github.com/static-frame/static-frame)
-     memo fields = ~304MB
+     memo fields = ~334MB

meson (https://github.com/mesonbuild/meson)
-     memo fields = ~304MB
+     memo fields = ~334MB

rotki (https://github.com/rotki/rotki)
-     memo fields = ~490MB
+     memo fields = ~445MB

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @AlexWaygood on 2025-06-27 13:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @MichaReiser on 2025-06-27 14:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @MichaReiser on 2025-06-27 14:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dcreager removed by @MichaReiser on 2025-06-27 14:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @MichaReiser on 2025-06-27 14:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-28 16:25</div>
            <div class="timeline-body"><p>Uh, I think this actually breaks the settings configured by the client because the fetched settings override the settings from the <code>initialize</code> request. I won't have time to fix this before my PTO.</p>
<p>I think the &quot;proper&quot; fix is that <code>Workspaces::register</code> registers the workspace with default options and that we move retrieve all options from the <code>configuration</code> request.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @dhruvmanila by @dhruvmanila on 2025-06-30 06:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-02 08:30</div>
            <div class="timeline-body"><blockquote>
<p>Uh, I think this actually breaks the settings configured by the client because the fetched settings override the settings from the <code>initialize</code> request. I won't have time to fix this before my PTO.</p>
<p>I think the &quot;proper&quot; fix is that <code>Workspaces::register</code> registers the workspace with default options and that we move retrieve all options from the <code>configuration</code> request.</p>
</blockquote>
<p>Why is this a problem? Isn't this correct? The fetched settings from <code>workspace/configuration</code> should be overriding the ones coming from <code>InitializationOptions</code>. I think they're going to be the same until the user changes the setting in the editor.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-02 08:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/main_loop.rs</code>:199 on 2025-07-02 08:59</div>
            <div class="timeline-body"><p>I think this would need to be moved in a standalone method or something as it'll be used for handling <code>didChangeConfiguration</code> and probably <code>didChangeWorkspaceFolders</code> but it doesn't need to be done now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-07-02 09:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2025-07-02 09:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2025-07-02 09:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-02 09:01</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:13:45 UTC
    </footer>
</body>
</html>
