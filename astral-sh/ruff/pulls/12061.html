<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] intern types using Salsa - astral-sh/ruff #12061</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] intern types using Salsa</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/12061">#12061</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2024-06-27 04:15
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body"><p>Intern types using Salsa interning instead of in the <code>TypeInference</code> result.</p>
<p>This eliminates the need for <code>TypingContext</code>, and also paves the way for finer-grained type inference queries.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-28 07:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-28 08:16</div>
            <div class="timeline-body"><p>As reference, this is how rustc interns types:</p>
<p>The data type:</p>
<p>https://github.com/rust-lang/rust/blob/42add88d2275b95c98e512ab680436ede691e853/compiler/rustc_middle/src/ty/adt.rs#L97-L106</p>
<p>A reference to a type (bound to the <code>TyCtxt</code> lifetime)</p>
<p>https://github.com/rust-lang/rust/blob/42add88d2275b95c98e512ab680436ede691e853/compiler/rustc_middle/src/ty/adt.rs#L172-L174</p>
<p>The definition of <code>Interned</code></p>
<p>https://github.com/rust-lang/rust/blob/42add88d2275b95c98e512ab680436ede691e853/compiler/rustc_data_structures/src/intern.rs#L13-L25</p>
<p>And this is used in <code>TyCtxt</code> which is rustcs arena where it interns all data.</p>
<p>https://github.com/rust-lang/rust/blob/42add88d2275b95c98e512ab680436ede691e853/compiler/rustc_middle/src/ty/context.rs#L194-L197</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-06-28 08:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/intern.rs</code>:39 on 2024-06-28 08:30</div>
            <div class="timeline-body"><p>I think returning a refence would work if we use an actual <code>Arena</code> that allocates a new vector when it runs out of space instead of resizing the existing one (which would invalidate previously returned Ids).</p>
<p>Or more generally. The way to return references here is by lifting the lifetime of types outside of type store by having the actual data owned further up.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-28 08:41</div>
            <div class="timeline-body"><p>I do like splitting out the type internet from the type inference result. I think it makes sense to have them separate and also allows more effective reuse.</p>
<p>The part that&#x27;s unclear to me and that you already mentioned on your write up is how to collect unused types. How can we prevent that this is an ever-growing arena?</p>
<p>We could try to track type references by using an <code>AtomicUsize</code> (not an <code>Arc</code> because that would heap allocate each type!) It would give us very fine-grained reclamation of types, at least if we use a slab like arena that supports reusing IDs. An other possibility could be to rely on Salsa by using one interner per file, package or some other granularity, and the interner would be retrieved by calling a salsa-query. This won&#x27;t give us type level collection, but salsa would evict the entire type store if e.g. the file gets deleted (or all files in a package).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-07-05 06:45</div>
            <div class="timeline-body"><p>This now uses Salsa interning, which eliminates a lot of our own interning and ID boilerplate, and actually works!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-07-05 06:48</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/cjm/fine">CodSpeed Performance Report</a>
Merging #12061 will <strong>degrade performances by 4.03%</strong>
<p>Comparing <code>cjm/fine</code> (c93aeeb) with <code>main</code> (7b50061)</p>
Summary
<p><code>‚ùå 1 (üëÅ 1)</code> regressions
<code>‚úÖ 32</code> untouched benchmarks</p>
Benchmarks breakdown
<p>|     | Benchmark | <code>main</code> | <code>cjm/fine</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| üëÅ | <code>red_knot_check_file[without_parse]</code> | 292 ¬µs | 304.3 ¬µs | -4.03% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-07-05 06:55</div>
            <div class="timeline-body"><p>Some things in this PR that might require further attention:</p>
<ul>
<li>I think you mentioned you don&#x27;t want to expose Salsa Db directly to lint rules, but I&#x27;m not sure how this will work with the need for lint rules to call methods on types. Previously you exposed typing context, which is just a wrapped db and is passed to all methods on types. Now methods on types take a db, so if we want to avoid exposing db to lint rules, they won&#x27;t be able to call methods on types.</li>
<li>Interning <code>UnionType</code> and <code>IntersectionType</code> in Salsa requires that all their fields be hashable, which means I can&#x27;t use <code>IndexSet</code>. For now I just switched to <code>Vec</code>, but I need to do a bit more careful analysis of what properties we need here (do we want ordering? do we need fast contains checks? etc) in order to settle on the right data structure.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-07-05 06:56</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>‚ÑπÔ∏è ecosystem check <strong>encountered linter errors</strong>. (no lint changes; 1 project error)</p>
<a href="https://github.com/python-trio/trio">python-trio/trio</a> (error)
<p>

<pre><code>Failed to clone python-trio/trio: warning: Could not find remote branch master to clone.
fatal: Remote branch master not found in upstream origin
</code></pre>
</p>


Linter (preview)
<p>‚ÑπÔ∏è ecosystem check <strong>encountered linter errors</strong>. (no lint changes; 1 project error)</p>
<a href="https://github.com/python-trio/trio">python-trio/trio</a> (error)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre><code>Failed to clone python-trio/trio: warning: Could not find remote branch master to clone.
fatal: Remote branch master not found in upstream origin
</code></pre>
</p>


Formatter (stable)
<p>‚ÑπÔ∏è ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<a href="https://github.com/python-trio/trio">python-trio/trio</a> (error)
<p>

<pre><code>Failed to clone python-trio/trio: warning: Could not find remote branch master to clone.
fatal: Remote branch master not found in upstream origin
</code></pre>
</p>


Formatter (preview)
<p>‚ÑπÔ∏è ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<a href="https://github.com/python-trio/trio">python-trio/trio</a> (error)
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<pre><code>Failed to clone python-trio/trio: warning: Could not find remote branch master to clone.
fatal: Remote branch master not found in upstream origin
</code></pre>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-07-05 06:58</div>
            <div class="timeline-body"><p>The message says I&#x27;m supposed to acknowledge the regression on CodSpeed, but when I login to CodSpeed with GitHub, it says I&#x27;m not allowed to acknowledge the regression...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/carljm">@carljm</a> on 2024-07-05 06:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/carljm">@carljm</a> on 2024-07-05 06:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/carljm">@carljm</a> on 2024-07-05 06:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[red-knot] intern types separately from type inference result&quot; to &quot;[red-knot] intern types using Salsa&quot; by <a href="https://github.com/carljm">@carljm</a> on 2024-07-05 06:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-05 08:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:275 on 2024-07-05 08:44</div>
            <div class="timeline-body"><p>I&#x27;m unsure if it is worth interning <code>ModuleType</code>, considering that it only stores a <code>VfsFile</code>. A salsa ingredient requires more metadata than the amount of memory that we save by interning the module type.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-07-05 08:47</div>
            <div class="timeline-body"><p>I&#x27;m a bit surprised by the regression but I think it makes sense. Previously, accessing a field on <code>ClassType</code> was reading a reference but it is now a lookup in the salsa ingredient table. Niko&#x27;s work should help reduce that cost but certainly something to be aware of. The good news, we can still build a more fancy type interner if it turns out that this is the bottleneck</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-05 08:49</div>
            <div class="timeline-body"><p>You now have the permissions to acknowledge regressions. Use it responsibly :P</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-05 11:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/lint.rs</code>:153 on 2024-07-05 11:01</div>
            <div class="timeline-body"><p>Okay, This is a bit problematic because I don&#x27;t want to give lint rules access to the <code>db</code>, because I don&#x27;t consider the <code>db</code> to be part of the stable API.</p>
<p>The solution for <code>has_decorator</code> is relatively simple, we make it a method on <code>model</code>: <code>model.has_decorator(ty, decorator_ty)</code>. It&#x27;s less clear to me me how we remove the <code>db</code> dependency from <code>name</code>, and <code>inherited_class_member</code>. Can we change <code>has_decorator</code> and add a TODO for the other methods.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/src/lint.rs</code>:153 on 2024-07-05 15:46</div>
            <div class="timeline-body"><p>After offline discussion, I&#x27;m going to just add a TODO here; we need to explore this further and find a general solution, and it&#x27;s not clear that we&#x27;d even want <code>has_decorator</code> to be a method directly on the <code>SemanticModel</code> once we have that general solution.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-07-05 15:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-07-05 15:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:275 on 2024-07-05 15:47</div>
            <div class="timeline-body"><p>Good point, I can try removing this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-07-05 15:50</div>
            <div class="timeline-body"><p>After offline discussion with @MichaReiser, going to switch to <code>OrderSet</code> for unions and intersections (from https://crates.io/crates/ordermap/0.5.0 ), which is a newtype wrapper around <code>IndexSet</code> that also adds order-respecting <code>Eq</code> and <code>Hash</code>. If we care about respecting order in unions (for UX reasons only, not because it&#x27;s meaningful in the type system), which I think we do, and we care about fast contains checks (I think we also do), then this seems like the best option. It means we will intern &quot;duplicate&quot; unions that differ only in order separately, but this is pretty much unavoidable if we really want to respect order for UX. We will have to see how much of a cost this is in practice, and if it&#x27;s worth paying for the UX.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-07-05 18:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:275 on 2024-07-05 18:37</div>
            <div class="timeline-body"><p>I just removed <code>ModuleType</code> entirely in favor of having <code>Type::Module</code> directly hold a <code>VfsFile</code>. At the moment there&#x27;s really no reason to have the extra <code>ModuleType</code> layer at all, just to implement the <code>member</code> method, which is a one-liner that can just as well go directly in <code>Type::member</code> in the <code>Type::Module</code> arm.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-07-05 18:58</div>
            <div class="timeline-body"><p>The updated perf results are a bit better; not sure if this is just noise or if not interning <code>ModuleType</code> actually helped. I don&#x27;t think Vec vs OrderSet should help, since we aren&#x27;t currently doing any contains checks on unions or intersections.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/carljm">@carljm</a> on 2024-07-05 19:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2024-07-05 19:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-07-05 19:16</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:04:56 UTC
    </footer>
</body>
</html>
