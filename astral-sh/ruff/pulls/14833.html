<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`ruff`] Detect more strict-integer expressions (`RUF046`) - astral-sh/ruff #14833</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>ruff</code>] Detect more strict-integer expressions (<code>RUF046</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14833">#14833</a>
        opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a>
        on 2024-12-08 04:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Part 2 of the big change introduced in #14828 and the follow-up to #14832.</p>
<h2>Test Plan</h2>
<p><code>cargo nextest run</code> and <code>cargo insta test</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[ruff] Do not simplify round() calls (RUF046)" to "[`ruff`] Detect more strict-integer expressions (`RUF046`)" by @InSyncWithFoo on 2024-12-08 04:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-12-08 04:25</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+1 -0 violations, +0 -0 fixes in 1 projects; 54 projects unchanged)</p>
<details><summary><a href="https://github.com/rotki/rotki">rotki/rotki</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/rotki/rotki/blob/da76cb8e347543bb2f539a6731c8666bc382eacb/rotkehlchen/tests/utils/ethereum.py#L231'>rotkehlchen/tests/utils/ethereum.py:231:15:</a> RUF046 [*] Value being casted is already an integer
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| RUF046 | 1 | 1 | 0 | 0 | 0 |</p>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-09 08:48</div>
            <div class="timeline-body"><p>Hmm, I can't change the base branch if the target is from a fork. I'll wait reviewing this PR until the target is merged.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-09 08:52</div>
            <div class="timeline-body"><p>Would you mind writing a short summary of what you're changing in the PR description? It's hard to review code if the change is unclear.</p>
<p>Did you review through the ecosystem changes? It's unclear to me why we're no longer flagging</p>
<p>https://github.com/RasaHQ/rasa/blob/b8de3b231126747ff74b2782cb25cb22d2d898d7/rasa/shared/core/training_data/loading.py#L86</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-12-09 12:40</div>
            <div class="timeline-body"><p>@MichaReiser These changes are all expected, even if they don't seem correct at first sight. For example:</p>
<pre><code class="language-py">#                                                   vvvvvvvvvvvvv Not `int`.
def load_data_from_files(..., exclusion_percentage: Optional[int] = None) -&gt; ...:
    ...
#                   vvvvvvvvvvvvvvvvvvvvvvvvvvvv This is classified as &quot;Maybe&quot; rather than &quot;Likely&quot;.
    idx = int(round(exclusion_percentage / 100.0 * len(story_steps)))
#                   \______This thus might also not be `int`______/
</code></pre>
<p>However, I also agree that this is suboptimal. <code>round()</code> with no <code>ndigits</code> is indeed likely to produce an <code>int</code>. In any case, since #14832 and this have diverged, I can only work on improving this after the former is merged.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @InSyncWithFoo on 2024-12-11 19:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-12-11 19:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch restored on 2024-12-11 19:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @InSyncWithFoo on 2024-12-11 19:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2024-12-12 09:01</div>
            <div class="timeline-body"><p>Would you mind updating your PR with a short summary outlining the change? It's otherwise very difficult to review the PR without even knowing what the intended behavior is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-12-12 13:25</div>
            <div class="timeline-body"><p>The goal of this PR is to correctly detect <code>1 &amp; 1</code> and other kinds of expressions to be strict instances of <code>int</code>. Other cases can be found in <code>RUF046.py</code>.</p>
<p>To give an example, <code>int(len(foo) // 2)</code> would not be detected as a violation prior to this PR. It now is. Existing violations are also preserved.</p>
<p>There are, however, limitations. <code>foo is not bar</code> is classified as <code>IsStrictlyInt::False</code>, resulting in <code>1 + (foo is not bar)</code> being <code>IsStrictlyInt::Maybe</code>, even though <code>1 + True</code> is <code>2</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-12 13:35</div>
            <div class="timeline-body"><p>Thanks for the extra explanation. That's helpful.</p>
<p>I don't think the pattern is common enough to justify the increase in complexity. Unless we move some of the logic into <code>typing::is_int</code> where it can be used for other rules as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-12-12 14:05</div>
            <div class="timeline-body"><p>@MichaReiser On the other hand, it is:</p>
<ul>
<li><a href="https://sourcegraph.com/search?q=context:global+lang:Python+%5Cbint%5C%28%5Cs*%5Cd%2B%5Cs*%28%3F:%5B-%2B*%5E%26%7C%5D%7C//%29%5Cs*%5Cd%2B%5Cs*%5C%29&amp;patternType=regexp&amp;case=yes&amp;sm=0"><code>\bint\(\s*\d+\s*(?:[-+*^&amp;|]|//)\s*\d+\s*\)</code></a>: 500+ results</li>
<li><a href="https://sourcegraph.com/search?q=context:global+lang:Python+%5Cbint%5C%28%5Cs*%5Cd%2B%5Cs*%5C%29&amp;patternType=regexp&amp;case=yes&amp;sm=0"><code>\bint\(\s*\d+\s*\)</code></a>: 10000+ results</li>
</ul>
<p>That's without function calls, variables and such.</p>
<p>There's also <a href="https://sourcegraph.com/search?q=context:global+lang:Python+%5Cbint%5C%28%5Cs*%5Cd%2B%5Cs*/%5Cs*%5Cd%2B%5Cs*%5C%29&amp;patternType=regexp&amp;case=yes&amp;sm=0"><code>\bint\(\s*\d+\s*/\s*\d+\s*\)</code></a> with ~900 results, but I suppose that should be another rule.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-13 08:05</div>
            <div class="timeline-body"><p>I'm not suggesting that we should not improve the rule at all, but I'm wary of making rules unnecessarily complex by implementing too much ad hoc type inference. It results in inconsistent behavior between rules and makes Ruff harder to maintain.</p>
<p>Can we focus on the most important cases you outlined above: single numbers, mathematical expressions, and a few known function calls? It also makes me wonder if we could move some or most of the logic into <code>typing::is_int</code> (we can only move the &quot;strict&quot; part). The logic would then benefit all rules instead of just a few.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-12-14 06:19</div>
            <div class="timeline-body"><blockquote>
<p>Can we focus on the most important cases you outlined above: single numbers, mathematical expressions, and a few known function calls?</p>
</blockquote>
<p>But I'm already focused on such expressions. All three kinds you mention, yes. <code>expr_is_strictly_int()</code> just recurses into subexpressions, nothing more. I really don't think I can simplify it any further (save for the <code>Expr::Compare</code> branch?).</p>
<p><code>typing::is_int()</code> attempts to infer the type of a binding, not an arbitrary expression. I could move <code>expr_is_strictly_int()</code> to somewhere inside <code>typing</code>, but that's about it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-15 16:35</div>
            <div class="timeline-body"><p>A <code>is_int_expr</code> next to <code>is_int</code> that returns <code>true</code> for expressions that are guaranteed to be <code>int</code> seems like a good outcome. What do you think? The maybe-int cases can then be handled inside the rule itself.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-12-15 17:40</div>
            <div class="timeline-body"><p><code>expr_is_strictly_int()</code> is now located in <code>typing.rs</code> with its name changed to <code>is_strictly_int_expr</code>. I'm not sure if that changes anything, though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-19 12:49</div>
            <div class="timeline-body"><p>@AlexWaygood made me aware that we already have <a href="https://github.com/astral-sh/ruff/blob/8d9e408dbb0f1876e3b56c8b4e2adb93258fb713/crates/ruff_python_semantic/src/analyze/type_inference.rs#L9">ResolvedPythonType</a> which implements a very similar infrastructure. I think we should integrate your changes there <strong>but</strong> without the <code>True</code>, <code>Maybe</code> distinction. Instead, it only infers <code>Int</code> if the type is guaranteed to be an int and it returns <code>Unknown</code> otherwise.</p>
<p>My suggestion for <strong>this</strong> PR is to simply use <code>ResolvedPythonType</code> without changing its implementation. We can improve <code>ResolvedPythonType</code> if needed in a separate PR</p>
<p>That means that the handling of <code>round</code> must remain in this rule.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-12-19 18:19</div>
            <div class="timeline-body"><p>@MichaReiser I'm not sure if I follow. How would I detect <code>int(round(...) * 42)</code> with <code>ResolvedPythonType</code>? As I see, it doesn't handle calls, which means <code>round(...) * 42</code> would be resolved to <code>Unknown</code>. Or do you mean we should not fix such cases for now?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-20 07:58</div>
            <div class="timeline-body"><p>@InSyncWithFoo</p>
<p>We shouldn't fix those cases for now. We can handle <code>round</code> calls directly in <code>RUF046</code> and anything more involved using <code>round</code> won't be detected because <code>ResolvedPythonType</code> doesn't support it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @InSyncWithFoo on 2024-12-20 23:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @MichaReiser on 2024-12-21 14:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @MichaReiser on 2024-12-21 14:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-21 14:19</div>
            <div class="timeline-body"><p>Perfect, thank you! I think this is a great improvement to the rule without significantly increasing its complexity.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-12-21 14:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2024-12-21 14:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-12-21 14:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-12-21 18:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-12-21 19:00</div>
            <div class="timeline-body"><p>@MichaReiser Why was the file renamed to <code>round_applicability</code>? That's not the name of the rule.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:08:19 UTC
    </footer>
</body>
</html>
