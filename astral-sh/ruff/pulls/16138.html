<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Remove a parameter from the `symbol_by_id()` query - astral-sh/ruff #16138</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Remove a parameter from the <code>symbol_by_id()</code> query</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16138">#16138</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-02-13 13:22
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><p>Salsa queries are more performant when they have fewer parameters, so this might lead to a performance improvement</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @AlexWaygood on 2025-02-13 13:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-02-13 13:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-02-13 13:27</div>
            <div class="timeline-body"><p>I like this better even if it doesn't improve perf because it moves the computation closer to where it's needed and makes it more lazy. It should also remove the <code>symbol_table</code> dependency for the query calling <code>symbol</code> which is nice.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @AlexWaygood on 2025-02-13 13:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-02-13 13:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-02-13 13:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-13 13:30</div>
            <div class="timeline-body"><p>no impact on perf :-( https://codspeed.io/astral-sh/ruff/branches/alex%2Fdunder-slots-arg</p>
<p>but yeah, as you say, a nice small change anyway :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> removed by @AlexWaygood on 2025-02-13 13:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-02-13 13:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-02-13 13:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-13 13:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-02-13 21:07</div>
            <div class="timeline-body"><blockquote>
<p>I like this better even if it doesn't improve perf because it moves the computation closer to where it's needed</p>
</blockquote>
<p>Yes, I like this too.</p>
<blockquote>
<p>and makes it more lazy. It should also remove the <code>symbol_table</code> dependency for the query calling <code>symbol</code> which is nice.</p>
</blockquote>
<p>But I don't think this is accurate. The outer query still needs the symbol table to get from name to symbol ID, and now we also need the symbol table again in the inner query to go from symbol ID back to name. (You can see in the diff that it doesn't remove any <code>symbol_table</code> query usages). So this introduces strictly more direct dependencies on the symbol table, and more symbol table lookups (though the added one is just an IndexVec indexing, not a hashmap lookup, which is good.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-02-13 21:17</div>
            <div class="timeline-body"><blockquote>
<p>no impact on perf</p>
</blockquote>
<p>FWIW, I wouldn't expect removing an argument here to improve perf. The things that I'd expect to improve perf are either 1) getting it back down to just one argument (other than the db) so as to avoid the need for an extra interning of the arguments, which I don't think is possible for this query since we don't have a symbol ingredient, or 2) reducing the overall number of possible cached results from the query. Removing an argument <em>could</em> have the latter effect in some cases, but in this case it doesn't because a given symbol always either is or is not named <code>__slots__</code>, so both before and after this diff we only cached exactly one possible result for a given scope and symbol. (That is, the value of <code>is_dunder_slots</code> was inherently locked to the value of the <code>symbol</code> argument, which is both the reason we <em>could</em> move this calculation inside, and also the reason moving it inside doesn't actually reduce our total count of cached values.)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:10:01 UTC
    </footer>
</body>
</html>
