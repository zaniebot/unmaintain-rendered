<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>fix: Use BestFit layout for subscript - astral-sh/ruff #7409</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>fix: Use BestFit layout for subscript</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7409">#7409</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-09-15 15:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">Summary
<p>Ruff never parenthesized long attribute chains followed by a subscript:</p>
<pre><code>def main() -&gt; None:
    if True:
        some_very_long_variable_name_abcdefghijk = Foo()
        some_very_long_variable_name_abcdefghijk = some_very_long_variable_name_abcdefghijk[
            some_very_long_variable_name_abcdefghijk.some_very_long_attribute_name
            == &quot;This is a very long string abcdefghijk&quot;
        ]
</code></pre>
<p>Whereas Black formats this as</p>
<pre><code>def main() -&gt; None:
    if True:
        some_very_long_variable_name_abcdefghijk = Foo()
        some_very_long_variable_name_abcdefghijk = (
            some_very_long_variable_name_abcdefghijk[
                some_very_long_variable_name_abcdefghijk.some_very_long_attribute_name
                == &quot;This is a very long string abcdefghijk&quot;
            ]
        )
</code></pre>
<p>This PR changes the <code>needs_parentheses</code> function of <code>ExprSubscript</code> to use the <code>BestFit</code> layout if its value proposes the <code>BestFit</code> layout (except when in return type annotations, see inline comments)</p>
<p>Making this change revealed an instability because the formatter incorrectly removed the parentheses from callees or objects. I changed the call chain formatting to preserve parentheses.</p>
<p>Closes #7407.</p>
<p>Closes #7422.</p>
Test Plan
<p>I added new tests</p>
<p><strong>Base</strong></p>
<p>| project      | similarity index  | total files       | changed files     |
|--------------|------------------:|------------------:|------------------:|
| cpython      |           0.76083 |              1789 |              1632 |
| django       |           0.99982 |              2760 |                37 |
| transformers |           0.99957 |              2587 |               399 |
| twine        |           1.00000 |                33 |                 0 |
| typeshed     |           0.99983 |              3496 |                18 |
| warehouse    |           0.99923 |               648 |                18 |
| zulip        |           0.99962 |              1437 |                22 |</p>
<p><strong>This PR</strong></p>
<p>| project      | similarity index  | total files       | changed files     |
|--------------|------------------:|------------------:|------------------:|
| cpython      |           0.76083 |              1789 |              1632 |
| django       |           0.99982 |              2760 |                37 |
| transformers |           0.99957 |              2587 |               399 |
| twine        |           1.00000 |                33 |                 0 |
| typeshed     |           0.99983 |              3496 |                18 |
| <strong>warehouse</strong>    |           0.99929 |               648 |                16 | &lt;--
| zulip        |           0.99962 |              1437 |                22 |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-15 15:59</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #7409</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7409"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a>  üëà</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7409?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-15 16:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-15 16:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-15 16:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Formatter: Beta&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-15 16:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone &quot;Formatter: Beta&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-15 16:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2023-09-15 16:16</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/subscript-best-fit-layout">CodSpeed Performance Report</a>
Merging #7409 will <strong>degrade performances by 7.48%</strong>
<p>Comparing <code>subscript-best-fit-layout</code> (84107e8) with <code>main</code> (f936d31)</p>
Summary
<p><code>‚ùå 4 (üëÅ 4)</code> regressions
<code>‚úÖ 21</code> untouched benchmarks</p>
Benchmarks breakdown
<p>|     | Benchmark | <code>main</code> | <code>subscript-best-fit-layout</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| üëÅ | <code>formatter[pydantic/types.py]</code> | 19.7 ms | 21.2 ms | -7.48% |
| üëÅ | <code>formatter[numpy/ctypeslib.py]</code> | 10.7 ms | 11 ms | -2.71% |
| üëÅ | <code>formatter[large/dataset.py]</code> | 57.6 ms | 60.9 ms | -5.5% |
| üëÅ | <code>formatter[unicode/pypinyin.py]</code> | 3.6 ms | 3.7 ms | -2.55% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;fix: Use BestFit layout for subscribt&quot; to &quot;fix: Use BestFit layout for subscript&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-15 16:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/expression/expr_subscript.rs</code>:110 on 2023-09-16 02:19</div>
            <div class="timeline-body"><p>Can you use <code>is_some_and</code> here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-09-16 02:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-16 14:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_subscript.rs</code>:110 on 2023-09-16 14:21</div>
            <div class="timeline-body"><p>I already use <code>is_some_and</code> on line 105. Do you mean for the equality comparison? I prefer avoiding lambdas when possible because it leads to very nested code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-16 14:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-09-16 14:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-09-16 14:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:57:18 UTC
    </footer>
</body>
</html>
