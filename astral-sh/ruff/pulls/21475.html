<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Improve diagnostics for invalid exceptions - astral-sh/ruff #21475</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Improve diagnostics for invalid exceptions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21475">#21475</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-11-15 19:44
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-15 19:44</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Not a high-priority task... but it <em>is</em> a weekend :P</p>
<p>This PR improves our diagnostics for invalid exceptions. Specifically:</p>
<ul>
<li>We now give a special-cased <code>help: Did you mean `NotImplementedError</code> subdiagnostic for <code>except NotImplemented</code>, <code>raise NotImplemented</code> and <code>raise &lt;EXCEPTION&gt; from NotImplemented</code></li>
<li>If the user catches a tuple of exceptions (<code>except (foo, bar, baz):</code>) and multiple elements in the tuple are invalid, we now collect these into a single diagnostic rather than emitting a separate diagnostic for each tuple element</li>
<li>The explanation of why the <code>except</code>/<code>raise</code> was invalid (&quot;must be a <code>BaseException</code> instance or <code>BaseException</code> subclass&quot;, etc.) is relegated to a subdiagnostic. This makes the top-level diagnostic summary much more concise.</li>
</ul>
<h2>Test Plan</h2>
<p>Lots of snapshots. And here's some screenshots:</p>
<details>
<summary>Screenshots</summary>

<p><img width="1770" height="1520" alt="image" src="https://github.com/user-attachments/assets/7f27fd61-c74d-4ddf-ad97-ea4fd24d06fd" /></p>
<p><img width="1916" height="1392" alt="image" src="https://github.com/user-attachments/assets/83e5027c-8798-48a6-a0ec-1babfc134000" /></p>
<p><img width="1696" height="588" alt="image" src="https://github.com/user-attachments/assets/1bc16048-6eb4-4dfa-9ace-dd271074530f" /></p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-11-15 19:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-11-15 19:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-11-15 19:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @AlexWaygood on 2025-11-15 19:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by @AlexWaygood on 2025-11-15 19:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-15 19:46</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-15 19:47</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">stone (https://github.com/dropbox/stone)
- stone/backends/python_rsrc/stone_validators.py:714:16: error[invalid-exception-caught] Cannot catch object of type `list[Unknown | &lt;class 'AttributeError'&gt; | &lt;class 'ValueError'&gt;]` in an exception handler (must be a `BaseException` subclass or a tuple of `BaseException` subclasses)
+ stone/backends/python_rsrc/stone_validators.py:714:16: error[invalid-exception-caught] Invalid object caught in an exception handler: Object has type `list[Unknown | &lt;class 'AttributeError'&gt; | &lt;class 'ValueError'&gt;]`

beartype (https://github.com/beartype/beartype)
- beartype/typing/_typingcache.py:130:23: error[invalid-raise] Cannot raise object of type `object` (must be a `BaseException` subclass or instance)
+ beartype/typing/_typingcache.py:130:23: error[invalid-raise] Cannot raise object of type `object`: Not an instance or subclass of `BaseException`

scikit-learn (https://github.com/scikit-learn/scikit-learn)
- sklearn/utils/_indexing.py:348:15: error[invalid-raise] Cannot raise object of type `None` (must be a `BaseException` subclass or instance)
+ sklearn/utils/_indexing.py:348:15: error[invalid-raise] Cannot raise object of type `None`: Not an instance or subclass of `BaseException`

manticore (https://github.com/trailofbits/manticore)
- manticore/platforms/linux.py:328:15: error[invalid-raise] Cannot raise object of type `NotImplementedType` (must be a `BaseException` subclass or instance)
+ manticore/platforms/linux.py:328:15: error[invalid-raise] Cannot raise `NotImplemented`: Did you mean `NotImplementedError`?
- manticore/platforms/linux.py:331:15: error[invalid-raise] Cannot raise object of type `NotImplementedType` (must be a `BaseException` subclass or instance)
+ manticore/platforms/linux.py:331:15: error[invalid-raise] Cannot raise `NotImplemented`: Did you mean `NotImplementedError`?
- manticore/platforms/linux.py:334:15: error[invalid-raise] Cannot raise object of type `NotImplementedType` (must be a `BaseException` subclass or instance)
+ manticore/platforms/linux.py:334:15: error[invalid-raise] Cannot raise `NotImplemented`: Did you mean `NotImplementedError`?
- manticore/platforms/linux.py:341:15: error[invalid-raise] Cannot raise object of type `NotImplementedType` (must be a `BaseException` subclass or instance)
+ manticore/platforms/linux.py:341:15: error[invalid-raise] Cannot raise `NotImplemented`: Did you mean `NotImplementedError`?
- manticore/platforms/linux.py:344:15: error[invalid-raise] Cannot raise object of type `NotImplementedType` (must be a `BaseException` subclass or instance)
+ manticore/platforms/linux.py:344:15: error[invalid-raise] Cannot raise `NotImplemented`: Did you mean `NotImplementedError`?
- manticore/platforms/linux.py:347:15: error[invalid-raise] Cannot raise object of type `NotImplementedType` (must be a `BaseException` subclass or instance)
+ manticore/platforms/linux.py:347:15: error[invalid-raise] Cannot raise `NotImplemented`: Did you mean `NotImplementedError`?
- manticore/platforms/linux.py:350:15: error[invalid-raise] Cannot raise object of type `NotImplementedType` (must be a `BaseException` subclass or instance)
+ manticore/platforms/linux.py:350:15: error[invalid-raise] Cannot raise `NotImplemented`: Did you mean `NotImplementedError`?
- manticore/platforms/linux.py:353:15: error[invalid-raise] Cannot raise object of type `NotImplementedType` (must be a `BaseException` subclass or instance)
+ manticore/platforms/linux.py:353:15: error[invalid-raise] Cannot raise `NotImplemented`: Did you mean `NotImplementedError`?

scikit-build-core (https://github.com/scikit-build/scikit-build-core)
+ src/scikit_build_core/build/wheel.py:98:20: error[no-matching-overload] No overload of bound method `__init__` matches arguments
- Found 43 diagnostics
+ Found 44 diagnostics

pwndbg (https://github.com/pwndbg/pwndbg)
- pwndbg/dbg/lldb/__init__.py:527:23: error[invalid-raise] Cannot raise object of type `None | Error` (must be a `BaseException` subclass or instance)
+ pwndbg/dbg/lldb/__init__.py:527:23: error[invalid-raise] Cannot raise object of type `None | Error`: Not an instance or subclass of `BaseException`

prefect (https://github.com/PrefectHQ/prefect)
- src/prefect/flow_engine.py:363:23: error[invalid-raise] Cannot raise object of type `BaseException | (type[NotSet] &amp; ~&lt;class 'NotSet'&gt;) | (Unknown &amp; ~&lt;class 'NotSet'&gt;)` (must be a `BaseException` subclass or instance)
+ src/prefect/flow_engine.py:363:23: error[invalid-raise] Cannot raise object of type `BaseException | (type[NotSet] &amp; ~&lt;class 'NotSet'&gt;) | (Unknown &amp; ~&lt;class 'NotSet'&gt;)`: Not an instance or subclass of `BaseException`
- src/prefect/flow_engine.py:950:23: error[invalid-raise] Cannot raise object of type `BaseException | (type[NotSet] &amp; ~&lt;class 'NotSet'&gt;) | (Unknown &amp; ~&lt;class 'NotSet'&gt;)` (must be a `BaseException` subclass or instance)
+ src/prefect/flow_engine.py:950:23: error[invalid-raise] Cannot raise object of type `BaseException | (type[NotSet] &amp; ~&lt;class 'NotSet'&gt;) | (Unknown &amp; ~&lt;class 'NotSet'&gt;)`: Not an instance or subclass of `BaseException`
- src/prefect/states.py:649:11: error[invalid-raise] Cannot raise object of type `Unknown | Coroutine[Any, Any, Unknown]` (must be a `BaseException` subclass or instance)
+ src/prefect/states.py:649:11: error[invalid-raise] Cannot raise object of type `Unknown | Coroutine[Any, Any, Unknown]`: Not an instance or subclass of `BaseException`
- src/prefect/task_engine.py:499:23: error[invalid-raise] Cannot raise object of type `BaseException | (type[NotSet] &amp; ~&lt;class 'NotSet'&gt;) | (Unknown &amp; ~&lt;class 'NotSet'&gt;)` (must be a `BaseException` subclass or instance)
+ src/prefect/task_engine.py:499:23: error[invalid-raise] Cannot raise object of type `BaseException | (type[NotSet] &amp; ~&lt;class 'NotSet'&gt;) | (Unknown &amp; ~&lt;class 'NotSet'&gt;)`: Not an instance or subclass of `BaseException`
- src/prefect/task_engine.py:1107:23: error[invalid-raise] Cannot raise object of type `BaseException | (type[NotSet] &amp; ~&lt;class 'NotSet'&gt;) | (Unknown &amp; ~&lt;class 'NotSet'&gt;)` (must be a `BaseException` subclass or instance)
+ src/prefect/task_engine.py:1107:23: error[invalid-raise] Cannot raise object of type `BaseException | (type[NotSet] &amp; ~&lt;class 'NotSet'&gt;) | (Unknown &amp; ~&lt;class 'NotSet'&gt;)`: Not an instance or subclass of `BaseException`

pywin32 (https://github.com/mhammond/pywin32)
- com/win32com/test/testvb.py:251:12: error[invalid-exception-caught] Cannot catch object of type `Unknown | None` in an exception handler (must be a `BaseException` subclass or a tuple of `BaseException` subclasses)
+ com/win32com/test/testvb.py:251:12: error[invalid-exception-caught] Invalid object caught in an exception handler: Object has type `Unknown | None`

dd-trace-py (https://github.com/DataDog/dd-trace-py)
- ddtrace/vendor/psutil/_psbsd.py:509:12: error[invalid-exception-caught] Cannot catch object of type `None` in an exception handler (must be a `BaseException` subclass or a tuple of `BaseException` subclasses)
- ddtrace/vendor/psutil/_psbsd.py:511:12: error[invalid-exception-caught] Cannot catch object of type `None` in an exception handler (must be a `BaseException` subclass or a tuple of `BaseException` subclasses)
+ ddtrace/vendor/psutil/_psbsd.py:509:12: error[invalid-exception-caught] Invalid object caught in an exception handler: Object has type `None`
+ ddtrace/vendor/psutil/_psbsd.py:511:12: error[invalid-exception-caught] Invalid object caught in an exception handler: Object has type `None`
- ddtrace/vendor/psutil/_psosx.py:252:16: error[invalid-exception-caught] Cannot catch object of type `None` in an exception handler (must be a `BaseException` subclass or a tuple of `BaseException` subclasses)
- ddtrace/vendor/psutil/_psosx.py:321:16: error[invalid-exception-caught] Cannot catch object of type `None` in an exception handler (must be a `BaseException` subclass or a tuple of `BaseException` subclasses)
- ddtrace/vendor/psutil/_psosx.py:323:16: error[invalid-exception-caught] Cannot catch object of type `None` in an exception handler (must be a `BaseException` subclass or a tuple of `BaseException` subclasses)
+ ddtrace/vendor/psutil/_psosx.py:252:16: error[invalid-exception-caught] Invalid object caught in an exception handler: Object has type `None`
+ ddtrace/vendor/psutil/_psosx.py:321:16: error[invalid-exception-caught] Invalid object caught in an exception handler: Object has type `None`
+ ddtrace/vendor/psutil/_psosx.py:323:16: error[invalid-exception-caught] Invalid object caught in an exception handler: Object has type `None`
- ddtrace/vendor/psutil/_psosx.py:363:20: error[invalid-exception-caught] Cannot catch object of type `None` in an exception handler (must be a `BaseException` subclass or a tuple of `BaseException` subclasses)
+ ddtrace/vendor/psutil/_psosx.py:363:20: error[invalid-exception-caught] Invalid object caught in an exception handler: Object has type `None`
- ddtrace/vendor/psutil/_pssunos.py:472:16: error[invalid-exception-caught] Cannot catch object of type `None` in an exception handler (must be a `BaseException` subclass or a tuple of `BaseException` subclasses)
- ddtrace/vendor/psutil/_pssunos.py:482:16: error[invalid-exception-caught] Cannot catch object of type `None` in an exception handler (must be a `BaseException` subclass or a tuple of `BaseException` subclasses)
+ ddtrace/vendor/psutil/_pssunos.py:472:16: error[invalid-exception-caught] Invalid object caught in an exception handler: Object has type `None`
+ ddtrace/vendor/psutil/_pssunos.py:482:16: error[invalid-exception-caught] Invalid object caught in an exception handler: Object has type `None`
- ddtrace/vendor/psutil/_pswindows.py:783:20: error[invalid-exception-caught] Cannot catch object of type `None` in an exception handler (must be a `BaseException` subclass or a tuple of `BaseException` subclasses)
+ ddtrace/vendor/psutil/_pswindows.py:783:20: error[invalid-exception-caught] Invalid object caught in an exception handler: Object has type `None`

ibis (https://github.com/ibis-project/ibis)
- ibis/backends/druid/__init__.py:174:16: error[invalid-exception-caught] Cannot catch object of type `Unknown | None` in an exception handler (must be a `BaseException` subclass or a tuple of `BaseException` subclasses)
+ ibis/backends/druid/__init__.py:174:16: error[invalid-exception-caught] Invalid object caught in an exception handler: Object has type `Unknown | None`
- ibis/backends/flink/__init__.py:325:16: error[invalid-exception-caught] Cannot catch object of type `Unknown | None` in an exception handler (must be a `BaseException` subclass or a tuple of `BaseException` subclasses)
+ ibis/backends/flink/__init__.py:325:16: error[invalid-exception-caught] Invalid object caught in an exception handler: Object has type `Unknown | None`
- ibis/backends/flink/__init__.py:1051:16: error[invalid-exception-caught] Cannot catch object of type `Unknown | None` in an exception handler (must be a `BaseException` subclass or a tuple of `BaseException` subclasses)
+ ibis/backends/flink/__init__.py:1051:16: error[invalid-exception-caught] Invalid object caught in an exception handler: Object has type `Unknown | None`

sympy (https://github.com/sympy/sympy)
- sympy/utilities/codegen.py:959:23: error[invalid-raise] Cannot raise object of type `CodeGen` (must be a `BaseException` subclass or instance)
+ sympy/utilities/codegen.py:959:23: error[invalid-raise] Cannot raise object of type `CodeGen`: Not an instance or subclass of `BaseException`


</code></pre>
</details>

<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-11-15 21:57</div>
            <div class="timeline-body"><p>Nice</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-11-15 22:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-11-15 22:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-11-15 22:12</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:54:20 UTC
    </footer>
</body>
</html>
