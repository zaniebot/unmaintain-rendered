<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Consider `type_check_only` when ranking completions - astral-sh/ruff #20910</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Consider <code>type_check_only</code> when ranking completions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20910">#20910</a>
        opened by <a href="https://github.com/decorator-factory">@decorator-factory</a>
        on 2025-10-16 04:02
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/decorator-factory">@decorator-factory</a></div>
            <div class="timeline-body">Summary
<p>This pull request enhances <code>Type</code>s with information on whether they are &quot;for type checking only&quot;, and changes autocompletion ranking so that</p>
<p>This is the first step in solving <a href="https://github.com/astral-sh/ty/issues/816">astral-sh/ty#816</a></p>
<ul>
<li>[x] TODO: I only implemented <code>@type_check_only</code> for classes, right now I&#x27;m figuring out how to do it for functions. It&#x27;s a bit puzzling why this decorator supports functions in the first place. The only place I found it used successfully is <code>scipy-stubs</code>, where &quot;imaginary methods&quot; are used to make certain classes match certain protocols.</li>
</ul>
Test Plan
<p>Added a <code>import_type_check_only_lowers_ranking</code> test case, which used to fail.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-16 07:04</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-16 07:05</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected âœ…
No memory usage changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[ty] Consider `type_check_only` when ranking completions&quot; to &quot;[ty] WIP: Consider `type_check_only` when ranking completions&quot; by <a href="https://github.com/decorator-factory">@decorator-factory</a> on 2025-10-16 07:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-16 10:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-16 10:57</div>
            <div class="timeline-body"><blockquote>
<p>TODO: I only implemented <code>@type_check_only</code> for classes, right now I&#x27;m figuring out how to do it for functions. It&#x27;s a bit puzzling why this decorator supports functions in the first place. The only place I found it used successfully is <code>scipy-stubs</code>, where &quot;imaginary methods&quot; are used to make certain classes match certain protocols.</p>
</blockquote>
<p>Fine to defer functions for now, IMO! I think the vast majority of uses are with classes. Let&#x27;s get an MVP in first that we can iterate on in followups</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/decorator-factory">@decorator-factory</a> reviewed on 2025-10-17 00:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/decorator-factory">@decorator-factory</a> on <code>crates/ty_ide/src/completion.rs</code>:851 on 2025-10-17 00:34</div>
            <div class="timeline-body"><p>Maybe it&#x27;s out of scope for this PR, but perhaps deprecated items should also ranked  last? (and crossed out in the autocompletion list)</p>
<p><img alt="Image" src="https://github.com/user-attachments/assets/44234814-e418-40bd-b2de-1ce8b7efde14"></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/decorator-factory">@decorator-factory</a> on 2025-10-17 00:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/decorator-factory">@decorator-factory</a> on 2025-10-17 00:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/decorator-factory">@decorator-factory</a> on 2025-10-17 00:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/decorator-factory">@decorator-factory</a> on 2025-10-17 00:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/decorator-factory">@decorator-factory</a> on 2025-10-17 00:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/decorator-factory">@decorator-factory</a> on 2025-10-17 00:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[ty] WIP: Consider `type_check_only` when ranking completions&quot; to &quot;[ty] Consider `type_check_only` when ranking completions&quot; by <a href="https://github.com/decorator-factory">@decorator-factory</a> on 2025-10-17 00:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/decorator-factory">@decorator-factory</a> reviewed on 2025-10-17 00:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/decorator-factory">@decorator-factory</a> on <code>crates/ty_python_semantic/src/types/function.rs</code>:1370 on 2025-10-17 00:41</div>
            <div class="timeline-body"><p>Was it an important detail that it&#x27;s really defined in the module at runtime? I am not sure, but <code>type_check_only</code> should be the only exception, probably</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/decorator-factory">@decorator-factory</a> reviewed on 2025-10-17 00:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/decorator-factory">@decorator-factory</a> on <code>crates/ty_python_semantic/src/types.rs</code>:907 on 2025-10-17 00:42</div>
            <div class="timeline-body"><p>If there a way to avoid this somehow? Maybe <code>typing.type_check_only</code> could get the <code>TYPE_CHECK_ONLY</code> decorator flag when it&#x27;s &quot;inserted&quot; into the typing module? I wasn&#x27;t able to find where that happens</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types/infer/builder.rs</code>:2627 on 2025-10-17 07:17</div>
            <div class="timeline-body"><p>Given that this is only used in the LSP context. Could we infer this lazilzy (we can cache it with a salsa query) instead of storing it on every class literal?</p>
<p>So the way this would work is that you make it a method on <code>ClassLiteral</code> that then iterates over all decorators too see if any of them are <code>type_check_only</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-17 07:20</div>
            <div class="timeline-body"><p>Nice! This looks great to me. I&#x27;ve one question about whether we can compute the <code>is_type_check_only</code> flag lazily rather than storing it on every <code>ClassLiteral</code>.</p>
<p>It would also be great if we could add an integration test for this. See https://github.com/astral-sh/ruff/blob/651f7963a7b5e0ce63e1edb2ea9c3a84e30f0034/crates/ty_completion_eval/README.md#L11 for how to do that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-17 07:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/completion.rs</code>:851 on 2025-10-17 07:21</div>
            <div class="timeline-body"><p>Yeah, agree. I think that sounds like a great change for another PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-17 07:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-17 07:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/infer/builder.rs</code>:2627 on 2025-10-17 07:25</div>
            <div class="timeline-body"><blockquote>
<p>Given that this is only used in the LSP context.</p>
</blockquote>
<p>We&#x27;ll want to use it in other contexts in the future, though, e.g. we&#x27;ll want to emit a diagnostic if a <code>type_check_only</code> symbol is imported in a <code>.py</code> file outside of an <code>if TYPE_CHECKING</code> block</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/completion.rs</code>:349 on 2025-10-17 11:55</div>
            <div class="timeline-body"><p>This seems to mean that completions that would require an auto-import are always considered &quot;not type-check-only&quot;. Here&#x27;s a screenshot from a local playground build using your branch (to build the playground locally, use <code>cd playground &amp;&amp; npm start --workspace ty-playground</code> from the Ruff repo root):</p>
<p><img alt="image" src="https://github.com/user-attachments/assets/5884ae56-4dc2-4a67-93a8-13abad7e13c3"></p>
<p><code>module.py</code> has these contents, so I would expect <code>Foo</code> to be ranked below <code>Foooo</code>:</p>
<pre><code>from typing import type_check_only

@type_check_only
class Foo: ...

class Foooo: ...
</code></pre>
<p>since that&#x27;s what I get in other situations on your branch (which is great!):</p>
<p><img alt="image" src="https://github.com/user-attachments/assets/09e3d31c-74a3-49a4-85f7-394e1eaba3ae"></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types.rs</code>:907 on 2025-10-17 12:02</div>
            <div class="timeline-body"><p>This should do it:</p>
<pre><code>diff --git a/crates/ty_python_semantic/src/types/infer/builder.rs b/crates/ty_python_semantic/src/types/infer/builder.rs
index 820da99a89..19d78133b3 100644
--- a/crates/ty_python_semantic/src/types/infer/builder.rs
+++ b/crates/ty_python_semantic/src/types/infer/builder.rs
@@ -2205,6 +2205,11 @@ impl&lt;&#x27;db, &#x27;ast&gt; TypeInferenceBuilder&lt;&#x27;db, &#x27;ast&gt; {
         let known_function =
             KnownFunction::try_from_definition_and_name(self.db(), definition, name);
 
+        // `type_check_only` is itself not available at runtime
+        if known_function == Some(KnownFunction::TypeCheckOnly) {
+            function_decorators |= FunctionDecorators::TYPE_CHECK_ONLY;
+        }
+
         let body_scope = self
             .index
             .node_scope(NodeWithScopeRef::Function(function))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-17 12:03</div>
            <div class="timeline-body"><p>Nice, thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-17 12:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/completion.rs</code>:349 on 2025-10-17 12:04</div>
            <div class="timeline-body"><p>if getting this right is difficult for auto-import completions, it&#x27;s fine to defer it for now, but we should add a TODO comment here if so</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/decorator-factory">@decorator-factory</a> reviewed on 2025-10-17 12:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/decorator-factory">@decorator-factory</a> on <code>crates/ty_ide/src/completion.rs</code>:349 on 2025-10-17 12:56</div>
            <div class="timeline-body"><p>I think let&#x27;s defer it for now :+1:
I added some TODOs in the integration test.</p>
<p>Right now deprecation and type-check-only-ness are stored on types, not symbols, which makes this difficult. (we&#x27;d have to eagerly infer types to produce autoimport suggestions if I understand it correctly)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/decorator-factory">@decorator-factory</a> on 2025-10-17 13:01</div>
            <div class="timeline-body"><blockquote>
<p>I&#x27;ve one question about whether we can compute the is_type_check_only flag lazily rather than storing it on every ClassLiteral</p>
</blockquote>
<p>I think it is nicely symmetrical with storing <code>FunctionDecorators</code> on function types :smiley_cat: . It also allows pre-populating this flag in things we know to be type-check only like <code>@typing.type_check_only</code> itself. (the diff Alex suggested above)</p>
<p>This is something <code>ty</code> would have to check pretty much every time you use a class in a runtime context (like if you do <code>list(something)</code>), so I don&#x27;t know which way is better for performance there</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-17 13:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/completion.rs</code>:349 on 2025-10-17 13:09</div>
            <div class="timeline-body"><p>Hmm, so we&#x27;d have to infer the types of every symbol that could possibly be imported in order to provide autocomplete suggestions for a single <code>x = Fo&lt;CURSOR&gt;</code> situation... that would indeed undermine the &quot;only lazily infer exactly what we need&quot; architecture of ty ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/completion.rs</code>:349 on 2025-10-17 13:44</div>
            <div class="timeline-body"><blockquote>
<p>situation... that would indeed undermine the &quot;only lazily infer exactly what we need&quot; architecture of ty ðŸ˜†</p>
</blockquote>
<p>Yeah, let&#x27;s wait for @BurntSushi on this, but we can definitely infer the type after we&#x27;ve done some filtering</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-17 13:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-22 15:21</div>
            <div class="timeline-body"><p>@decorator-factory I&#x27;m not sure what the state of this PR is. Would you mind requesting re-review when it&#x27;s ready for another round of feedback or you can put your PR in draft mode and change it to &quot;ready for review&quot; once it&#x27;s ready for another round.</p>
<p>Thank you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/decorator-factory">@decorator-factory</a> on 2025-10-22 16:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/decorator-factory">@decorator-factory</a> on 2025-10-22 16:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/decorator-factory">@decorator-factory</a> on 2025-10-22 16:47</div>
            <div class="timeline-body"><p>I think it&#x27;s ready to merge in the current state. As Alex said, the main use case for <code>@type_check_only</code> is classes/protocols that only exist at runtime, so we can fix the <code>TODO</code> tests for methods in a later PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_completion_eval/truth/import-deprioritizes-type_check_only/main.py</code>:12 on 2025-10-23 13:03</div>
            <div class="timeline-body"><p>I <em>believe</em> the idea with the tests in this crate is that for autocomplete suggestions that don&#x27;t achieve a great result currently, that&#x27;s simply reflected in a lower score in <code>crates/ty_completion_eval/completion-evaluation-tasks.csv</code>. So that implies that we should uncomment these lines, and then when we improve our ranking in the future that will simply result in us having to update the score in that CSV file to reflect the fact that the ranking has improved.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-10-23 13:04</div>
            <div class="timeline-body"><p>Thanks, and sorry for the delay in getting back to this! Looks good now, just one comment about the tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/decorator-factory">@decorator-factory</a> reviewed on 2025-10-23 13:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/decorator-factory">@decorator-factory</a> on <code>crates/ty_completion_eval/truth/import-deprioritizes-type_check_only/main.py</code>:12 on 2025-10-23 13:58</div>
            <div class="timeline-body"><p>I see, that&#x27;s how it seems to work in the <code>numpy-array</code> and <code>scope-existing-over-new-import</code> cases indeed. Fixed in the latest commit</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-23 14:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-23 14:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-10-28 13:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_completion_eval/truth/import-deprioritizes-type_check_only/main.py</code>:12 on 2025-10-28 13:41</div>
            <div class="timeline-body"><p>@AlexWaygood Yup that&#x27;s exactly right! More broadly, it may be the case that some rankings can&#x27;t improve or can&#x27;t improve without regressing others.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-10-28 13:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:349 on 2025-10-28 13:51</div>
            <div class="timeline-body"><p>My loose plan at this point was to basically never infer the type of unimported symbols, by virtue of there being so many. It&#x27;s true that we could try doing that after we&#x27;ve done filtering, but I fear this could still have a negative overall effect where we end needing to type check a substantial portion of third party code just by virtue of using completions. And I of course worry about the latency impact this will have on auto-import completions.</p>
<p>This is why the way auto-import works currently is to basically bypass any type checking and just pick up symbols straight from the AST. The way I would try to tackle <code>type_check_only</code> support here is to see if we can add it to that AST extraction bit and <em>not</em> try to bring in type checking machinery for it.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:19:36 UTC
    </footer>
</body>
</html>
