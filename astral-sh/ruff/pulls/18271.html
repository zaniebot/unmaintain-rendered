<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`fastapi`] Avoid false positive for class dependencies (`FAST003`) - astral-sh/ruff #18271</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>fastapi</code>] Avoid false positive for class dependencies (<code>FAST003</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18271">#18271</a>
        opened by <a href="https://github.com/twentyone212121">@twentyone212121</a>
        on 2025-05-23 07:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/twentyone212121">@twentyone212121</a> on 2025-05-23 07:36</div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff/ty! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title? (Please prefix with `[ty]` for ty pull
  requests.)
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>Closes #17226.</p>
<p>This PR updates the <code>FAST003</code> rule to correctly handle <a href="https://fastapi.tiangolo.com/tutorial/dependencies/classes-as-dependencies/">FastAPI class dependencies</a>. Specifically, if a path parameter is declared in either:</p>
<ul>
<li>a <code>pydantic.BaseModel</code> used as a dependency, or</li>
<li>the <code>__init__</code> method of a class used as a dependency,</li>
</ul>
<p>then <code>FAST003</code> will no longer incorrectly report it as unused.</p>
<p>FastAPI allows a shortcut when using annotated class dependencies - <code>Depends</code> can be called without arguments, e.g.:</p>
<pre><code class="language-python">class MyParams(BaseModel):
    my_id: int

@router.get(&quot;/{my_id}&quot;)
def get_id(params: Annotated[MyParams, Depends()]): ...
</code></pre>
<p>This PR ensures that such usage is properly supported by the linter.</p>
<p>Note: Support for dataclasses is not included in this PR. Let me know if you’d like it to be added.</p>
<h2>Test Plan</h2>
<p>Added relevant test cases to the <code>FAST003.py</code> fixture.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-05-23 07:43</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @ntBre on 2025-05-28 21:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @ntBre on 2025-05-28 21:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/fastapi/rules/fastapi_unused_path_parameter.rs</code>:291 on 2025-05-28 22:13</div>
            <div class="timeline-body"><p>I'm pretty sure it's impossible to get here if <code>tuple.elts</code> is empty, but we could use <code>tuple.elts.first()?</code> just in case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/fastapi/rules/fastapi_unused_path_parameter.rs</code>:414 on 2025-05-28 22:17</div>
            <div class="timeline-body"><pre><code class="language-suggestion">   semantic.resolve_qualified_name(expr)
   .is_some_and(|qualified_name| matches!(qualified_name.segments(), [&quot;pydantic&quot;, &quot;BaseModel&quot;]))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/fastapi/rules/fastapi_unused_path_parameter.rs</code>:374 on 2025-05-28 22:26</div>
            <div class="timeline-body"><p>Can we use <code>non_posonly_non_variadic_parameters</code> like in the function branch and just tack <code>skip(1)</code> on the end? I think that would be the same as this, just with the <code>chain</code> and <code>skip</code> calls swapped, which seems like it should be okay.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-05-28 22:47</div>
            <div class="timeline-body"><p>Thanks! I had a couple of very minor suggestions, but this looks good to me.</p>
<p>How much work do you think it would be to add support for dataclasses? I don't feel too strongly either way. I think we could handle <a href="https://docs.python.org/3/library/typing.html#typing.NamedTuple"><code>typing.NamedTuple</code></a>s with just a <code>| [&quot;typing&quot;, &quot;NamedTuple&quot;]</code> in the <code>is_pydantic_base_model</code> match,  but that's probably even less common.</p>
<p>The issue was about <code>BaseModel</code> anyway, so I think it's totally fine to leave it here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/twentyone212121">@twentyone212121</a> on 2025-05-29 09:17</div>
            <div class="timeline-body"><p>Thanks for the review! I’ve made the changes you suggested in the latest commit.</p>
<p>Regarding dataclasses, the simple option would be to check if <code>&quot;dataclass&quot;</code> is in <code>class_def.decorator_list</code>. But since <code>pydantic</code> has its own version (<code>pydantic.dataclasses.dataclass</code>) and there’s also support from the <code>attrs</code> library, it gets a bit trickier.</p>
<p>I saw that Ruff already has some logic for handling this in <code>ruff/rules/helpers.rs</code>, which seems pretty thorough. But it seems like I can't access it from <code>fastapi</code> module.
https://github.com/astral-sh/ruff/blob/04dc48e17c2518f97436d76284a509499087d81c/crates/ruff_linter/src/rules/ruff/rules/helpers.rs#L95-L109</p>
<p>That said, I’m not sure we need that level of complexity for this rule. Open to your thoughts if you think it’s worth adding support for them here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/twentyone212121">@twentyone212121</a> on 2025-05-29 09:19</div>
            <div class="timeline-body"><p>CI / ecosystem check is failing due to a Connect Timeout Error. Not sure what to do about this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-29 13:26</div>
            <div class="timeline-body"><p>Ah okay, I didn't really consider the full variety of &quot;dataclasses.&quot; I think it's fine to leave the PR as is! Nice find on the helpers, though, that will come in handy if we update this later. I think we'd just need to change <code>pub(super)</code> to <code>pub(crate)</code> to access them here, but it's possible that we'd have to change some module visibilities or even move the code too.</p>
<blockquote>
<p>CI / ecosystem check is failing due to a Connect Timeout Error. Not sure what to do about this</p>
</blockquote>
<p>Looks like this resolved eventually, probably just a temporary network issue.</p>
<p>I'll give this another quick review soon, hopefully today!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-06-02 18:34</div>
            <div class="timeline-body"><p>Looks great, thanks again!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-06-02 18:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-06-02 18:34</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 18:45:31 UTC
    </footer>
</body>
</html>
