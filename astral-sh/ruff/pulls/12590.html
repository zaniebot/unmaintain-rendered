<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add tests for hard and soft links - astral-sh/ruff #12590</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add tests for hard and soft links</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/12590">#12590</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-07-31 07:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-31 07:48</div>
            <div class="timeline-body"><h1>Summary</h1>
<p>The goal I set out for was to add support for symlinks and hard links when watching files. I no longer think we should pursue this goal, at least not now. This PR has mainly become a documentation PR and it adds a few tests demonstrating the behavior on different systems/platforms.</p>
<p>Why not support watching symlinks and hardlinks? Primarily, because I don't think there's sufficient use to justify the complexity. I tested both VS Code and Pycharm and both show stale results after making changes to a hard-linked file or updating a symlinked file. This is as good as Red Knot is today.  Specifically, the following changes are not supported:</p>
<ul>
<li>Changing a symlinked file only updates the symlink target or source, but not both</li>
<li>Changing a hardlinked file only updates the specific file to which the change was written. Creating or removing hard links are regular file events and they are supported on all platforms (this is important because uv uses hardlinks)</li>
</ul>
<p>The other reason is that the platform specific file watcher APIs don't generate the necessary events. I compared the events with <code>@parcel/watcher</code> (used by VS Code, and parcel), and <code>fs.watch</code> (nodejs) and the generated events match. The only system that I found that supported hard links well is Pyright which is based on <a href="https://github.com/paulmillr/chokidar"><code>chokidar</code></a>. I'm not a 100% sure how chokidar makes it work but I belive it does a directory traversal to find changes rather than relying on the events only. We could do that as well, but it seems rather expensive to support a not so common workflow.</p>
<p>There are ways how we could support symlinks and hardlinks without traversing the directory.</p>
<ul>
<li>We could keep a map from <code>Handle</code> to <code>Vec&lt;File&gt;</code> to lookup all files pointing to the same hard link. There's some complexity how we would support this with our <code>System</code> abstraction</li>
<li>We could keep a reverse map from <code>real_path</code> to <code>Vec&lt;File&gt;</code> for all symlinked files.</li>
</ul>
<p>I think any approach (or traversing the directory to find changes) is worth exploring if this is something that users run into often.</p>
<p>It is probably also worth exploring <a href="https://facebook.github.io/watchman/">watchman</a> as a possible <code>notify</code> backend to support very large projects.</p>
<p>Side note: Ruff doesn't follow symlinks today. Pyright has support for it.</p>
<h1>Test Plan</h1>
<p>This PR is only tests ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-07-31 10:50</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @MichaReiser on 2024-07-31 12:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2024-07-31 13:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MichaReiser on 2024-07-31 13:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MichaReiser on 2024-07-31 13:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-31 13:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:1154 on 2024-07-31 13:49</div>
            <div class="timeline-body"><p>This fixes a few unused warnings on windows</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/tests/file_watching.rs</code>:52 on 2024-07-31 13:50</div>
            <div class="timeline-body"><p>I hope this will help to improve the stability of the tests. We can now use a high timeout for functions that expect at least a single event and a smaller timeout for functions that don't.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-31 13:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-31 13:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/tests/file_watching.rs</code>:265 on 2024-07-31 13:50</div>
            <div class="timeline-body"><p>Let's hope this fixes the other instability</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/tests/file_watching.rs</code>:26 on 2024-07-31 14:14</div>
            <div class="timeline-body"><p>I assume this is stored on the <code>TestCase</code> instance, even though it's unused, because the temporary directory will be immediately cleaned up if there are no remaining references to the <code>TempDir</code> instance, and we need the temporary directory to exist for the duration of the test that's using the <code>TestCase</code> instance? Could you maybe add a comment to that effect?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/tests/file_watching.rs</code>:51 on 2024-07-31 14:19</div>
            <div class="timeline-body"><p>This seems to assume that <code>self.watcher</code> will never be <code>None</code> when this method is called. It's not immediately obvious to me what the invariant is here, because it's not immediately obvious to me why the <code>watcher</code> field is an <code>Option</code> in the first place. With this PR branch, do we ever create <code>TestCase</code> instances currently when <code>watcher</code> is set to <code>None</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/tests/file_watching.rs</code>:788 on 2024-07-31 14:23</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// For reference: VS Code and PyCharm have the same behavior where the results for one of the
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/tests/file_watching.rs</code>:1093 on 2024-07-31 14:32</div>
            <div class="timeline-body"><p><code>extra-paths</code>? It looks like the <code>extra_paths</code> search-path setting has been set to an empty <code>vec![]</code> immediately above?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/tests/file_watching.rs</code>:1132 on 2024-07-31 14:33</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        // * PyCharm doesn't update diagnostics if a symlinked module is changed (same as red knot).
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/tests/file_watching.rs</code>:1124 on 2024-07-31 14:33</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        // The best we can assert here is that one of the files should have been updated.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/tests/file_watching.rs</code>:1128 on 2024-07-31 14:33</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        // only `chokidar` seems to support it (used by Pyright).
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/tests/file_watching.rs</code>:1142 on 2024-07-31 14:34</div>
            <div class="timeline-body"><p>This is a very long line :P</p>
<pre><code class="language-suggestion">        assert!(
            original_updated || symlinked_updated,
            &quot;Expected one of the files to be updated but neither file was updated.\nOriginal: {original_text}\nSymlinked: {symlinked_text}&quot;,
            original_text = original_text.as_str(),
            symlinked_text = symlinked_text.as_str(),
        );
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/tests/file_watching.rs</code>:1160 on 2024-07-31 14:35</div>
            <div class="timeline-body"><pre><code class="language-suggestion"></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/tests/file_watching.rs</code>:1236 on 2024-07-31 14:36</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        // Pyright does support it, thanks to chokidar.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-31 14:36</div>
            <div class="timeline-body"><p>Some of this I've only skimmed, but it LGTM overall. I have a few questions and a few nits:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-31 14:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/tests/file_watching.rs</code>:788 on 2024-07-31 14:48</div>
            <div class="timeline-body"><p>Changing it to Pycharm triggers clippy :laughing:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/tests/file_watching.rs</code>:954 on 2024-07-31 17:33</div>
            <div class="timeline-body"><p>It doesn't look like there is any <code>foo.py</code> in this test.</p>
<pre><code class="language-suggestion"></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/tests/file_watching.rs</code>:1047 on 2024-07-31 17:38</div>
            <div class="timeline-body"><p>Given the description of the scenario above (&quot;workspace contains a symlink to another directory inside the workspace&quot;), I'm not clear why site-packages should be involved in this test at all. That described scenario can be constructed without even having a site-packages.</p>
<p>We probably do need some tests around having site-packages inside vs outside the workspace, since both will be common setups that we need to support, and it does pose some potentially-tricky questions around properly distinguishing third-party from first-party code. (FWIW, and off-topic for this PR, my feeling is that when site-packages is inside the workspace, we should basically pretend that it isn't, and treat it the same as if it were outside. Putting your venv in your workspace doesn't mean that site-packages is now first-party code.)</p>
<p>But having site-packages contain symlinks to first-party code is an extremely strange scenario that I doubt we ever encounter, and it just feels odd to include that complexity in this test, when that's not part of the documented intention of the test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-07-31 17:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-31 20:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/tests/file_watching.rs</code>:51 on 2024-07-31 20:15</div>
            <div class="timeline-body"><p>I'll add a comment. Althought his isn't new code.</p>
<p>The reason why it is an <code>Option</code> is because <code>watcher.stop</code> consumes the watcher and I didn't want to make the method take a <code>self</code> because it would consume the <code>TestCase</code> (which deletes the tempdir).</p>
<p>The invariant here is that you can only call <code>stop_watch</code> once. Calling it a second time panics because the watcher isn't running anymore.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-31 22:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/tests/file_watching.rs</code>:51 on 2024-07-31 22:32</div>
            <div class="timeline-body"><blockquote>
<p>Althought his isn't new code.</p>
</blockquote>
<p>Well, the <code>.unwrap()</code> call you're introducing in this PR is new. Previously you used <code>if let Some(watcher) = self.watcher.take()</code>, which implied it was okay to call <code>stop_watch()</code> several times â€” it just wouldn't have have done anything the second time, I suppose.</p>
<blockquote>
<p>The invariant here is that you can only call <code>stop_watch</code> once. Calling it a second time panics because the watcher isn't running anymore.</p>
</blockquote>
<p>Great, thanks. Maybe we could use <code>.expect(&quot;Cannot call stop_watch() more than once!&quot;)</code> instead of <code>.unwrap()</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-08-01 06:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot/tests/file_watching.rs</code>:788 on 2024-08-01 06:04</div>
            <div class="timeline-body"><p>I guess we could add &quot;PyCharm&quot; in https://github.com/astral-sh/ruff/blob/a3e67abf4ce7b519152c03ff441424c18e4c18ee/clippy.toml#L1-L13</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2024-08-02 10:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-08-02 10:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-08-02 10:14</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 21:47:35 UTC
    </footer>
</body>
</html>
