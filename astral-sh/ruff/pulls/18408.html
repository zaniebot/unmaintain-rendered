<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix false positive in  for mutations in return statements (B909) - astral-sh/ruff #18408</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix false positive in  for mutations in return statements (B909)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18408">#18408</a>
        opened by <a href="https://github.com/K-dash">@K-dash</a>
        on 2025-06-01 04:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/K-dash">@K-dash</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff/ty! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title? (Please prefix with `[ty]` for ty pull
  requests.)
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>Fixes false positive in B909 (<code>loop-iterator-mutation</code>) where mutations inside return/break statements were incorrectly flagged as violations.
The fix adds tracking for when mutations occur within return/break statements and excludes them from violation detection, as they don't cause the iteration issues B909 is designed to prevent.</p>
<h2>Test Plan</h2>
<ul>
<li>Added test cases covering the reported false positive scenarios to <code>B909.py</code></li>
<li>Verified existing B909 tests continue to pass (no regressions)</li>
<li>Ran <code>cargo test -p ruff_linter --lib flake8_bugbear</code> successfully</li>
</ul>
<p>Fixes #18399</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @ntBre on 2025-06-01 14:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @ntBre on 2025-06-01 14:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-01 14:29</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+0 -1 violations, +26 -0 fixes in 6 projects; 49 projects unchanged)</p>
<details><summary><a href="https://github.com/apache/airflow">apache/airflow</a> (+0 -0 violations, +8 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/apache/airflow/blob/aae99f2aa6b3764fe2fcf6cb0e44051d3eb15ea5/airflow-core/src/airflow/api_fastapi/auth/managers/base_auth_manager.py#L78'>airflow-core/src/airflow/api_fastapi/auth/managers/base_auth_manager.py:78:22:</a> PYI059 [*] `Generic[]` should always be the last base class
- <a href='https://github.com/apache/airflow/blob/aae99f2aa6b3764fe2fcf6cb0e44051d3eb15ea5/airflow-core/src/airflow/api_fastapi/auth/managers/base_auth_manager.py#L78'>airflow-core/src/airflow/api_fastapi/auth/managers/base_auth_manager.py:78:22:</a> PYI059 `Generic[]` should always be the last base class
+ <a href='https://github.com/apache/airflow/blob/aae99f2aa6b3764fe2fcf6cb0e44051d3eb15ea5/airflow-core/src/airflow/api_fastapi/common/exceptions.py#L37'>airflow-core/src/airflow/api_fastapi/common/exceptions.py:37:23:</a> PYI059 [*] `Generic[]` should always be the last base class
- <a href='https://github.com/apache/airflow/blob/aae99f2aa6b3764fe2fcf6cb0e44051d3eb15ea5/airflow-core/src/airflow/api_fastapi/common/exceptions.py#L37'>airflow-core/src/airflow/api_fastapi/common/exceptions.py:37:23:</a> PYI059 `Generic[]` should always be the last base class
+ <a href='https://github.com/apache/airflow/blob/aae99f2aa6b3764fe2fcf6cb0e44051d3eb15ea5/airflow-core/src/airflow/api_fastapi/core_api/base.py#L52'>airflow-core/src/airflow/api_fastapi/core_api/base.py:52:16:</a> PYI059 [*] `Generic[]` should always be the last base class
- <a href='https://github.com/apache/airflow/blob/aae99f2aa6b3764fe2fcf6cb0e44051d3eb15ea5/airflow-core/src/airflow/api_fastapi/core_api/base.py#L52'>airflow-core/src/airflow/api_fastapi/core_api/base.py:52:16:</a> PYI059 `Generic[]` should always be the last base class
+ <a href='https://github.com/apache/airflow/blob/aae99f2aa6b3764fe2fcf6cb0e44051d3eb15ea5/airflow-core/src/airflow/api_fastapi/core_api/services/public/common.py#L37'>airflow-core/src/airflow/api_fastapi/core_api/services/public/common.py:37:18:</a> PYI059 [*] `Generic[]` should always be the last base class
- <a href='https://github.com/apache/airflow/blob/aae99f2aa6b3764fe2fcf6cb0e44051d3eb15ea5/airflow-core/src/airflow/api_fastapi/core_api/services/public/common.py#L37'>airflow-core/src/airflow/api_fastapi/core_api/services/public/common.py:37:18:</a> PYI059 `Generic[]` should always be the last base class
</pre>

</p>
</details>
<details><summary><a href="https://github.com/langchain-ai/langchain">langchain-ai/langchain</a> (+0 -0 violations, +8 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/langchain-ai/langchain/blob/5839801897c798b7a516f9a6c415bead2386209f/libs/core/langchain_core/output_parsers/base.py#L31'>libs/core/langchain_core/output_parsers/base.py:31:26:</a> PYI059 [*] `Generic[]` should always be the last base class
- <a href='https://github.com/langchain-ai/langchain/blob/5839801897c798b7a516f9a6c415bead2386209f/libs/core/langchain_core/output_parsers/base.py#L31'>libs/core/langchain_core/output_parsers/base.py:31:26:</a> PYI059 `Generic[]` should always be the last base class
+ <a href='https://github.com/langchain-ai/langchain/blob/5839801897c798b7a516f9a6c415bead2386209f/libs/core/langchain_core/prompts/base.py#L45'>libs/core/langchain_core/prompts/base.py:45:25:</a> PYI059 [*] `Generic[]` should always be the last base class
- <a href='https://github.com/langchain-ai/langchain/blob/5839801897c798b7a516f9a6c415bead2386209f/libs/core/langchain_core/prompts/base.py#L45'>libs/core/langchain_core/prompts/base.py:45:25:</a> PYI059 `Generic[]` should always be the last base class
+ <a href='https://github.com/langchain-ai/langchain/blob/5839801897c798b7a516f9a6c415bead2386209f/libs/core/langchain_core/runnables/base.py#L111'>libs/core/langchain_core/runnables/base.py:111:15:</a> PYI059 [*] `Generic[]` should always be the last base class
- <a href='https://github.com/langchain-ai/langchain/blob/5839801897c798b7a516f9a6c415bead2386209f/libs/core/langchain_core/runnables/base.py#L111'>libs/core/langchain_core/runnables/base.py:111:15:</a> PYI059 `Generic[]` should always be the last base class
+ <a href='https://github.com/langchain-ai/langchain/blob/5839801897c798b7a516f9a6c415bead2386209f/libs/core/langchain_core/stores.py#L26'>libs/core/langchain_core/stores.py:26:16:</a> PYI059 [*] `Generic[]` should always be the last base class
- <a href='https://github.com/langchain-ai/langchain/blob/5839801897c798b7a516f9a6c415bead2386209f/libs/core/langchain_core/stores.py#L26'>libs/core/langchain_core/stores.py:26:16:</a> PYI059 `Generic[]` should always be the last base class
</pre>

</p>
</details>
<details><summary><a href="https://github.com/latchbio/latch">latchbio/latch</a> (+0 -0 violations, +4 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/latchbio/latch/blob/30315fdd1b2c95444911010b60e9086b8cceba50/src/latch/types/metadata.py#L440'>src/latch/types/metadata.py:440:25:</a> PYI059 [*] `Generic[]` should always be the last base class
- <a href='https://github.com/latchbio/latch/blob/30315fdd1b2c95444911010b60e9086b8cceba50/src/latch/types/metadata.py#L440'>src/latch/types/metadata.py:440:25:</a> PYI059 `Generic[]` should always be the last base class
+ <a href='https://github.com/latchbio/latch/blob/30315fdd1b2c95444911010b60e9086b8cceba50/src/latch/types/metadata.py#L489'>src/latch/types/metadata.py:489:24:</a> PYI059 [*] `Generic[]` should always be the last base class
- <a href='https://github.com/latchbio/latch/blob/30315fdd1b2c95444911010b60e9086b8cceba50/src/latch/types/metadata.py#L489'>src/latch/types/metadata.py:489:24:</a> PYI059 `Generic[]` should always be the last base class
</pre>

</p>
</details>
<details><summary><a href="https://github.com/python/typeshed">python/typeshed</a> (+0 -0 violations, +2 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview --select E,F,FA,I,PYI,RUF,UP,W</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/python/typeshed/blob/ecd5141cc036366cc9e3ca371096d6a14b0ccd13/stdlib/asyncio/queues.pyi#L28'>stdlib/asyncio/queues.pyi:28:12:</a> PYI059 [*] `Generic[]` should always be the last base class
- <a href='https://github.com/python/typeshed/blob/ecd5141cc036366cc9e3ca371096d6a14b0ccd13/stdlib/asyncio/queues.pyi#L28'>stdlib/asyncio/queues.pyi:28:12:</a> PYI059 `Generic[]` should always be the last base class
</pre>

</p>
</details>
<details><summary><a href="https://github.com/zulip/zulip">zulip/zulip</a> (+0 -0 violations, +4 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/zulip/zulip/blob/a25000298fe5099ed6e47104449aba100e086ae9/zerver/lib/notes.py#L12'>zerver/lib/notes.py:12:16:</a> PYI059 [*] `Generic[]` should always be the last base class
- <a href='https://github.com/zulip/zulip/blob/a25000298fe5099ed6e47104449aba100e086ae9/zerver/lib/notes.py#L12'>zerver/lib/notes.py:12:16:</a> PYI059 `Generic[]` should always be the last base class
+ <a href='https://github.com/zulip/zulip/blob/a25000298fe5099ed6e47104449aba100e086ae9/zerver/lib/queue.py#L35'>zerver/lib/queue.py:35:18:</a> PYI059 [*] `Generic[]` should always be the last base class
- <a href='https://github.com/zulip/zulip/blob/a25000298fe5099ed6e47104449aba100e086ae9/zerver/lib/queue.py#L35'>zerver/lib/queue.py:35:18:</a> PYI059 `Generic[]` should always be the last base class
</pre>

</p>
</details>
<details><summary><a href="https://github.com/pytest-dev/pytest">pytest-dev/pytest</a> (+0 -1 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
- <a href='https://github.com/pytest-dev/pytest/blob/9e9633de9da7a9fab03b4bba3a326bf85b412050/src/_pytest/recwarn.py#L214'>src/_pytest/recwarn.py:214:24:</a> B909 Mutation to loop iterable `self._list` during iteration
</pre>

</p>
</details>
<details><summary>Changes by rule (2 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PYI059 | 26 | 0 | 0 | 26 | 0 |
| B909 | 1 | 0 | 1 | 0 | 0 |</p>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_bugbear/rules/loop_iterator_mutation.rs</code>:294 on 2025-06-03 21:22</div>
            <div class="timeline-body"><p>If we're not going to add the mutations anyway, can we simply skip the <code>walk_stmt</code> call here?</p>
<pre><code class="language-suggestion"></code></pre>
<p>I tried this locally and it seems to work, but maybe there's an edge case I'm missing. I even found the <a href="https://github.com/astral-sh/ruff/pull/9578/commits/8fe10406c5a80c76af2233de533be1847cac9e53">commit</a> from the initial PR that added the rule, but I didn't see any reasoning for including it, so hopefully we're safe to skip it if all the tests pass.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-03 21:35</div>
            <div class="timeline-body"><p>Thanks! The new tests look great, but I think there might be a simpler fix for the issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/K-dash">@K-dash</a> reviewed on 2025-06-03 22:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/K-dash">@K-dash</a> on <code>crates/ruff_linter/src/rules/flake8_bugbear/rules/loop_iterator_mutation.rs</code>:294 on 2025-06-03 22:27</div>
            <div class="timeline-body"><p>You're absolutely right.
Since we're not walking the statement at all, there's no need for the flag-based approach. The mutations simply won't be detected in the first place because we skip traversing the expressions within return/break statements entirely.</p>
<p>I've simplified the implementation to just skip the <code>walk_stmt</code> call. Thanks for the review!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @K-dash on 2025-06-03 22:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-06-04 02:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_bugbear/rules/loop_iterator_mutation.rs</code>:148 on 2025-06-04 02:25</div>
            <div class="timeline-body"><p>I think we should also revert this field addition. I'm a bit surprised clippy didn't catch it, but I suppose it does look used.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/K-dash">@K-dash</a> on <code>crates/ruff_linter/src/rules/flake8_bugbear/rules/loop_iterator_mutation.rs</code>:148 on 2025-06-04 04:42</div>
            <div class="timeline-body"><p>Oh... You're totally right. I've already reverted the field addition and simplified the implementation. The <code>in_return_or_break</code> field has been removed along with all its associated logic. Thanks for catching that!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/K-dash">@K-dash</a> reviewed on 2025-06-04 04:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @K-dash on 2025-06-08 01:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/K-dash">@K-dash</a> on 2025-06-13 01:07</div>
            <div class="timeline-body"><p>@ntBre
I was wondering if you've had a chance to review this yet?
I would greatly appreciate your feedback when you have the opportunity.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-06-13 14:25</div>
            <div class="timeline-body"><p>Excellent, thank you! It's always fun to fix a bug by deleting code :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-06-13 14:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-06-13 14:39</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:13:03 UTC
    </footer>
</body>
</html>
