<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Simplify unions of T and ~T - astral-sh/ruff #15400</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Simplify unions of T and ~T</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15400">#15400</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-01-10 13:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body">Summary
<p>Simplify unions of <code>T</code> and <code>~T</code> to <code>object</code>.</p>
Test Plan
<p>Adapted existing tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-10 13:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-10 13:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-10 13:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-10 13:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/truthiness.md</code>:24 on 2025-01-10 13:43</div>
            <div class="timeline-body"><p>In these first four, only the order changed slightly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-10 13:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/truthiness.md</code>:90 on 2025-01-10 13:47</div>
            <div class="timeline-body"><p>According to the descriptions in <a href="https://github.com/astral-sh/ruff/pull/14687">astral-sh/ruff#14687</a>, we have</p>
<pre><code>~AlwaysTruthy = Falsy
~AlwaysFalsy = Truthy
</code></pre>
<p>and</p>
<pre><code>Truthy | Falsy = U = object (U is the Universal Set in set theory)
</code></pre>
<p>So we can rewrite what we had before to prove that this is correct:</p>
<pre><code>  A &amp; ~AlwaysTruthy | B &amp; ~AlwaysTruthy | A &amp; ~AlwaysFalsy | B &amp; ~AlwaysFalsy
= A &amp; Falsy | B &amp; Falsy | A &amp; Truthy | B &amp; Truthy
= A &amp; Falsy | B &amp; Falsy | A &amp; Truthy | B &amp; Truthy
= A &amp; Falsy | A &amp; Truthy | B &amp; Falsy | B &amp; Truthy
= A &amp; (Falsy | Truthy) | B &amp; (Falsy | Truthy)
= A &amp; object | B &amp; object
= A | B
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-10 13:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-10 13:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/truthiness.md</code>:93 on 2025-01-10 13:48</div>
            <div class="timeline-body"><p>Same proof as above, just starts with a reordered union.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-10 13:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/truthiness.md</code>:217 on 2025-01-10 13:49</div>
            <div class="timeline-body"><p>Similar to above:</p>
<pre><code>  A &amp; ~AlwaysTruthy | A &amp; ~AlwaysFalsy
= A &amp; Falsy | A &amp; Truthy
= A &amp; (Falsy | Truthy)
= A &amp; object
= A
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-10 13:50</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-10 13:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/truthiness.md</code>:219 on 2025-01-10 13:51</div>
            <div class="timeline-body"><p>This PR does not resolve #15023, but we can remove the TODO comment nevertheless.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-10 13:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/narrow/truthiness.md</code>:90 on 2025-01-10 13:56</div>
            <div class="timeline-body"><p>To show that <em>no</em> narrowing happens (i.e. that we still have <code>A | B</code>) also seems to be the intention of this test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/builder.rs</code>:85 on 2025-01-10 16:39</div>
            <div class="timeline-body"><p>Is there an argument for inlining the negation to ensure we avoid doing it if one of the above cases matches? We only use <code>ty_negated</code> once.</p>
<pre><code>                    } else if ty.negate(self.db).is_subtype_of(self.db, *element) {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-01-10 16:39</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-10 21:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/builder.rs</code>:85 on 2025-01-10 21:48</div>
            <div class="timeline-body"><blockquote>
<p>We only use <code>ty_negated</code> once.</p>
</blockquote>
<p>It&#x27;s still a loop though, so we would compute it for every pre-existing element of the union, no?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/builder.rs</code>:85 on 2025-01-10 21:56</div>
            <div class="timeline-body"><p>Oh, I totally missed that, you&#x27;re right. Let&#x27;s leave it as is. If this shows up as a significant cost, I think there would be ways we can make it more efficient. For example, we could have a dedicated <code>negation_is_subtype_of</code> that would short circuit the most costly cases (where <code>ty</code> is a simple type and <code>ty_negated</code> requires constructing an intersection, in which case we will never be able to declare the resulting negation type a subtype of anything other than <code>object</code> or another negation type) and defer to <code>self.negate(db).is_subtype_of(...)</code> for the remainder.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-01-10 21:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-10 22:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-10 22:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-10 22:00</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:10:13 UTC
    </footer>
</body>
</html>
