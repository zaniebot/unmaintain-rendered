<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`ruff server`: Support `noqa` comment code action - astral-sh/ruff #11276</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>ruff server</code>: Support <code>noqa</code> comment code action</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11276">#11276</a>
        opened by <a href="https://github.com/snowsignal">@snowsignal</a>
        on 2024-05-04 01:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-05-04 01:33</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes https://github.com/astral-sh/ruff/issues/10594.</p>
<p>Code actions to disable a diagnostic via <code>noqa</code> comment are now available.</p>
<p>https://github.com/astral-sh/ruff/assets/19577865/6d3bcf11-a9d9-499b-8c7f-a10cd39cfbba</p>
<p><code>DiagnosticFix</code> has been changed so that <code>noqa</code> code actions appear even for diagnostics with no available quick fix. It can contain quick fix edits, <code>noqa</code> comment edits, or both.</p>
<h2>Test Plan</h2>
<p>The scenarios that need to be tested are as follows:</p>
<ul>
<li>A code action to disable a diagnostic should be available for every diagnostic.</li>
<li>Using this code action should append to the appropriate line with the diagnostic, or modify an existing <code>noqa</code> comment.</li>
<li>Adding a <code>noqa</code> comment manually should make a diagnostic disappear</li>
<li><code>Fix all auto-fixable problems</code> should not add <code>noqa</code> comments</li>
<li>Removing a code from a <code>noqa</code> comment should make the diagnostic re-appear</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @snowsignal on 2024-05-04 01:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-05-04 01:47</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/T-256">@T-256</a> on 2024-05-04 11:28</div>
            <div class="timeline-body"><p><img src="https://github.com/astral-sh/ruff/assets/132141463/538c9fc9-2d13-41ae-a895-45f4cf0f8834" alt="image" /></p>
<p>Could it possible instead of clearing noqa by hand, add code action when moving cursor on noqa code comments?
For example, moving cursor on <code># noqa:</code>, show these code actions:</p>
<ul>
<li>Ruff (ANN201): Re-enable for this line.</li>
<li>Ruff (D103): Re-enable for this line.</li>
<li>Re-enable all disabled rules for this line.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/lint.rs</code>:41 on 2024-05-06 10:30</div>
            <div class="timeline-body"><p>a) I think it could make sense to start documenting the fields.</p>
<p>b) What's the motivation for using an <code>Option&lt;Vec&lt;_&gt;&gt;</code>? Could we just use an empty vec in case there are no edits?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/lint.rs</code>:29 on 2024-05-06 10:34</div>
            <div class="timeline-body"><p>I think it's worthfile to start documenting the struct fields</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/code_action.rs</code>:84 on 2024-05-06 10:36</div>
            <div class="timeline-body"><p>I would use <code>filter_map</code> to avoid the <code>expect</code> call</p>
<pre><code class="language-suggestion">        .filter_map(|fix| {
            let edits = fix.edits.as_ref()?;

            let mut tracker = WorkspaceEditTracker::new(snapshot.resolved_client_capabilities());

            tracker.set_edits_for_document(
                snapshot.url().clone(),
                document.version(),
                edits
            )?;

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/code_action.rs</code>:106 on 2024-05-06 10:37</div>
            <div class="timeline-body"><p>Nit: I'm not sure if that works but maybe</p>
<pre><code class="language-suggestion">            let edit = fix.noqa_edit.cloned()?;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/api/requests/code_action.rs</code>:85 on 2024-05-06 10:39</div>
            <div class="timeline-body"><p>Nit: I like to implement methods on structs that return references to remove the number of <code>as_ref</code> calls necessary:</p>
<pre><code>fix.edits().expect()
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-05-06 10:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-05-07 06:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/lint.rs</code>:41 on 2024-05-07 06:32</div>
            <div class="timeline-body"><blockquote>
<p>b) What's the motivation for using an Option&lt;Vec&lt;_&gt;&gt;? Could we just use an empty vec in case there are no edits?</p>
</blockquote>
<p>There is a distinction in the codebase between an empty vec and a <code>None</code> value (a fix with an empty vec would result in a code action that doesn't make any edits). But since 'a code action that doesn't make any edits' shouldn't be sent in the first place, I support your suggestion to make an empty vec represent the lack of a quick fix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-05-07 08:46</div>
            <div class="timeline-body"><p>Is this PR up-to date with the base PR (<code>jane/linter/noqa-edits</code>)? I think there's an issue with multiline strings:</p>
<p>Considering the above code snippet, in the following screen recording (left is new server, right is <code>ruff-lsp</code>) you can see that the new server adds the NoQA comment <em>inside</em> the multiline string while <code>ruff-lsp</code> correctly adds it at the end.</p>
<p>https://github.com/astral-sh/ruff/assets/67177269/c75bb4dd-73d2-4c92-90fe-c3ec8268e138</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-05-07 19:12</div>
            <div class="timeline-body"><p>@dhruvmanila Thanks for pointing this out, I'll investigate.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @snowsignal on 2024-05-09 19:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @snowsignal on 2024-05-09 19:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-05-09 19:04</div>
            <div class="timeline-body"><p>@AlexWaygood @dhruvmanila You can ignore the review request, that seemed to happen automatically when I rebased the branch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @AlexWaygood on 2024-05-09 19:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dhruvmanila removed by @AlexWaygood on 2024-05-09 19:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-05-11 21:32</div>
            <div class="timeline-body"><p>@dhruvmanila I've confirmed that https://github.com/astral-sh/ruff/pull/11276/commits/b321a3fdbb3ef0c57d8029a80f461c282b10e1b0 fixes the issue with multiline diagnostics üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @snowsignal on 2024-05-12 21:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @snowsignal on 2024-05-12 21:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-05-12 21:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-05-12 21:41</div>
            <div class="timeline-body"><p>@T-256 Thanks for this suggestion - can you open an issue for this?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 22:05:57 UTC
    </footer>
</body>
</html>
