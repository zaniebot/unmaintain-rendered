<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Add new `Diagnostic` data type - astral-sh/ruff #16503</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Add new <code>Diagnostic</code> data type</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16503">#16503</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2025-03-04 17:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-03-04 17:50</div>
            <div class="timeline-body"><p>This also moves most (but not all) of the existing diagnostic
infrastructure into an <code>old</code> submodule, and renames the types to
include &quot;old&quot; in the name. The intent is for the <code>old</code> submodule to be
deleted.</p>
<p>Otherwise, the new <code>Diagnostic</code> data type is meant to capture
our diagnostic data model (discussed internally). I expect the
implementation to be tweaked over time (there isn't too much
interesting going on yet), but I think this is a good base to start
with.</p>
<p>Note that this doesn't include fixes or diffs. I think we're punting
on doing too much with that for right now.</p>
<p>Closes #16505</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @BurntSushi on 2025-03-04 17:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @BurntSushi on 2025-03-04 17:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @BurntSushi on 2025-03-04 17:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @BurntSushi on 2025-03-04 17:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-03-04 17:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by @BurntSushi on 2025-03-04 18:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-04 18:11</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/diagnostic/old.rs</code>:349 on 2025-03-04 18:34</div>
            <div class="timeline-body"><p>I don't think we' have to rename this diagnostic, similar to how you didn't rename <code>TypeCheckDiagnostic</code>. This is a concrete diagnostic that will implement <code>IntoDiagnostic</code> under your new model.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:32 on 2025-03-04 18:36</div>
            <div class="timeline-body"><p>We could use the <a href="https://docs.rs/drop_bomb/latest/drop_bomb/"><code>drop_bomb</code></a> type for this, instead of wrapping it in an <code>Option</code>. It has the advantage that it doesn't require the more awkward <code>Option</code> access pattern. You can also choose a <code>DebugBomb</code> that is disabled in release (red knot panicking because of a dropped diagnostic in production doesn't seem the right trade off to me)</p>
<p>The additional <code>Box</code>ing might be unfortunate for Red Knot where we have to also <code>Arc</code> them to make them cheap clonable. Although that depends if Red Knot will propagate <code>TypeCheckDiagnostic</code>s or <code>Diagnostic</code>s. It's also just one additional allocation that shouldn't matter much. Let's ignore this for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:311 on 2025-03-04 19:42</div>
            <div class="timeline-body"><p>It's somewhat unfortunate that git thinks everything below here is new when it isn't. It would be nice to keep the history</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-03-04 19:44</div>
            <div class="timeline-body"><p>This is great. A few smaller nit comments, nothing major</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-03-04 20:13</div>
            <div class="timeline-body"><p>Looks great to me!! Looking forward to being able to use this to improve our existing diagnostics.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_db/src/diagnostic/old.rs</code>:349 on 2025-03-05 12:42</div>
            <div class="timeline-body"><p>For <code>TypeCheckDiagnostic</code>, I think that was mostly just an oversight because it wasn't defined in <code>ruff_db</code>. I expect <code>TypeCheckDiagnostic</code>, as it currently exists, to likely be deleted.</p>
<p><code>ParseDiagnostic</code> (or <code>OldParseDiagnostic</code>) might still hang around. I'm actually not sure. It could definitely implement <code>IntoDiagnostic</code> (when that trait is defined).</p>
<p>But this type exists to integrate with the old diagnostic trait, so I think I'd prefer to just mark it as &quot;old&quot; for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-03-05 12:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-03-05 13:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:32 on 2025-03-05 13:06</div>
            <div class="timeline-body"><p>That's not the kind of crate I would normally use to be honest. It's tiny! But it looks like we're already using it, so I might as well. Although, if you want to give a good error message (e.g., with the diagnostic ID or something), then it forces you to allocate a string up-front (even if it's a fake bomb, as it would be in release mode) instead of just creating the message in the <code>Drop</code> impl itself. But maybe that's fine.</p>
<p>The point about <code>debug_assertions</code> is a good one.</p>
<p>I'll just switch to <code>drop_bomb</code> for now. ... Except it doesn't implement <code>Clone</code>.</p>
<p>This is silly. I just need a simple <code>bool</code> gated on <code>cfg(debug_assertions)</code>. And then we can have a nicer panic message. So... concerns addressed I think, without using <code>drop_bomb</code>. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-03-05 13:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:311 on 2025-03-05 13:07</div>
            <div class="timeline-body"><p>:-(</p>
<p>Sometimes using <code>--follow</code> can help when browsing git history. Although it is hit-or-miss in my experience.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-03-05 13:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:32 on 2025-03-05 13:09</div>
            <div class="timeline-body"><blockquote>
<p>The additional Boxing might be unfortunate for Red Knot where we have to also Arc them to make them cheap clonable. Although that depends if Red Knot will propagate TypeCheckDiagnostics or Diagnostics. It's also just one additional allocation that shouldn't matter much. Let's ignore this for now.</p>
</blockquote>
<p>I wasn't sure what the needed pattern was, so I used <code>Box</code>.</p>
<p>If we really do want the <code>Arc</code>, then I can make <code>Diagnostic</code> use an <code>Arc</code> with <code>Arc::make_mut</code> that will only copy if the ref count is greater than <code>1</code>. Then callers can freely and cheaply clone, and only pay for it if you need mutation after cloning. But yeah for now, I'll just leave it as a <code>Box</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @BurntSushi on 2025-03-05 13:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2025-03-05 13:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-03-05 13:23</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:49:31 UTC
    </footer>
</body>
</html>
