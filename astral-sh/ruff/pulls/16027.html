<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pyupgrade`] Comments within parenthesized value ranges should not affect applicability (`UP040`) - astral-sh/ruff #16027</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pyupgrade</code>] Comments within parenthesized value ranges should not affect applicability (<code>UP040</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16027">#16027</a>
        opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a>
        on 2025-02-07 17:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-02-07 17:16</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Follow-up to #16026.</p>
<p>Previously, the fix for this would be marked as unsafe, even though all comments are preserved:</p>
<pre><code class="language-python"># .pyi
T: TypeAlias = (  # Comment
	int | str
)
</code></pre>
<p>Now it is safe: comments within the parenthesized range no longer affect applicability.</p>
<h2>Test Plan</h2>
<p><code>cargo nextest run</code> and <code>cargo insta test</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-02-07 17:39</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-07 18:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/pep695/non_pep695_type_alias.rs</code>:287 on 2025-02-07 18:34</div>
            <div class="timeline-body"><p>thank you! I actually feel like I'd find it easier to understand this if we just put all the applicability logic in this function. Something like this (relative to your branch)?</p>
<pre><code class="language-diff">diff --git a/crates/ruff_linter/src/rules/pyupgrade/rules/pep695/non_pep695_type_alias.rs b/crates/ruff_linter/src/rules/pyupgrade/rules/pep695/non_pep695_type_alias.rs
index da34672c9..777bb3184 100644
--- a/crates/ruff_linter/src/rules/pyupgrade/rules/pep695/non_pep695_type_alias.rs
+++ b/crates/ruff_linter/src/rules/pyupgrade/rules/pep695/non_pep695_type_alias.rs
@@ -1,5 +1,4 @@
 use itertools::Itertools;
-use std::cmp;
 
 use ruff_diagnostics::{Applicability, Diagnostic, Edit, Fix, FixAvailability, Violation};
 use ruff_macros::{derive_message_formats, ViolationMetadata};
@@ -177,7 +176,6 @@ pub(crate) fn non_pep695_type_alias_type(checker: &amp;Checker, stmt: &amp;StmtAssign) {
         &amp;target_name.id,
         value,
         &amp;vars,
-        Applicability::Safe,
         TypeAliasKind::TypeAliasType,
     ));
 }
@@ -237,13 +235,6 @@ pub(crate) fn non_pep695_type_alias(checker: &amp;Checker, stmt: &amp;StmtAnnAssign) {
         name,
         value,
         &amp;vars,
-        // The fix is only safe in a type stub because new-style aliases have different runtime behavior
-        // See https://github.com/astral-sh/ruff/issues/6434
-        if checker.source_type.is_stub() {
-            Applicability::Safe
-        } else {
-            Applicability::Unsafe
-        },
         TypeAliasKind::TypeAlias,
     ));
 }
@@ -255,7 +246,6 @@ fn create_diagnostic(
     name: &amp;Name,
     value: &amp;Expr,
     type_vars: &amp;[TypeVar],
-    base_applicability: Applicability,
     type_alias_kind: TypeAliasKind,
 ) -&gt; Diagnostic {
     let source = checker.source();
@@ -272,20 +262,28 @@ fn create_diagnostic(
     );
     let edit = Edit::range_replacement(content, stmt.range());
 
-    // it would be easier to check for comments in the whole `stmt.range`, but because
-    // `create_diagnostic` uses the full source text of `value`, comments within `value` are
-    // actually preserved. thus, we have to check for comments in `stmt` but outside of `value`
-    let pre_value = TextRange::new(stmt.start(), range_with_parentheses.start());
-    let post_value = TextRange::new(range_with_parentheses.end(), stmt.end());
     let applicability =
-        if comment_ranges.intersects(pre_value) || comment_ranges.intersects(post_value) {
+        if type_alias_kind == TypeAliasKind::TypeAlias &amp;&amp; !checker.source_type.is_stub() {
+            // The fix is always unsafe in non-stubs stub
+            // because new-style aliases have different runtime behavior at runtime.
+            // See https://github.com/astral-sh/ruff/issues/6434
             Applicability::Unsafe
         } else {
-            Applicability::Safe
+            // In stub files, or in non-stub files for `TypeAliasType` assignments,
+            // the fix is only unsafe if it would delete comments.
+            //
+            // it would be easier to check for comments in the whole `stmt.range`, but because
+            // `create_diagnostic` uses the full source text of `value`, comments within `value` are
+            // actually preserved. thus, we have to check for comments in `stmt` but outside of `value`
+            let pre_value = TextRange::new(stmt.start(), range_with_parentheses.start());
+            let post_value = TextRange::new(range_with_parentheses.end(), stmt.end());
+            if comment_ranges.intersects(pre_value) || comment_ranges.intersects(post_value) {
+                Applicability::Unsafe
+            } else {
+                Applicability::Safe
+            }
         };
 
-    let fix = Fix::applicable_edit(edit, cmp::min(applicability, base_applicability));
-
     Diagnostic::new(
         NonPEP695TypeAlias {
             name: name.to_string(),
@@ -293,5 +291,5 @@ fn create_diagnostic(
         },
         stmt.range(),
     )
-    .with_fix(fix)
+    .with_fix(Fix::applicable_edit(edit, applicability))
 }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @dylwil3 on 2025-02-07 19:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/pep695/non_pep695_type_alias.rs</code>:268 on 2025-02-07 20:33</div>
            <div class="timeline-body"><pre><code class="language-suggestion">            // The fix is always unsafe in non-stubs
            // because new-style aliases have different runtime behavior.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> requested changes on 2025-02-07 20:36</div>
            <div class="timeline-body"><p>Couple typos but otherwise lgtm!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> approved on 2025-02-07 20:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dylwil3 on 2025-02-07 20:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dylwil3 on 2025-02-07 20:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-07 20:44</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:57:52 UTC
    </footer>
</body>
</html>
