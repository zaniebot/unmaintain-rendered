<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Add &quot;cheap&quot; `program.snapshot`  - astral-sh/ruff #11172</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Add &quot;cheap&quot; <code>program.snapshot</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11172">#11172</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-04-27 06:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">Summary
<p>This PR implements a snapshotting mechanism for <code>Database</code> and makes query cancellation a <code>Database</code> concept. The motivation for this change is the LSP where the main loop in the LSP uses <code>spawn</code> to schedule some work on its thread pool. <code>sapwn</code> requires that all arguments have a <code>&#x27;static</code> lifetime. That means passing a <code>&amp;Program</code> as we&#x27;ve done in the CLI main loop won&#x27;t be possible.</p>
<p>To solve this, this PR introduces a <code>program.snapshot</code> method that returns an owned but read-only database instance. The LSP can safely pass the snapshot to its worker thread because it satisfies the <code>&#x27;static</code> lifetime requirement.</p>
<p>The main challenge of the <code>snapshot</code> function is that we don&#x27;t want to create a deep-clone of the database including the <code>jars</code> state because:</p>
<ul>
<li>a deep-clone of the caches is very expensive</li>
<li>it would mean that caching is restricted to a single thread. However, we want to share a single cache between all threads.</li>
</ul>
<p>Getting cheap &quot;clones&quot; is achieved by wrapping the <code>jars</code> state in an <code>Arc</code>. However, this introduces a new problem. Now, mutating is expensive because <code>Arc</code>s are read-only by default. Solving this, requires introducing cancellation.</p>
<p>The implementation makes use of the fact that mutating an <code>Arc</code> in place is possible if the <code>Arc</code> has exactly one reference. The <code>Database</code> now stores its own cancellation token and calling a mutation method on the storage (or database) automatically requests cancellation of all queries and waits until all other references to <code>jars</code> are dropped. It is then possible to safely take the mutable reference from the <code>Arc</code>.</p>
<p>Waiting is implemented using a <a href="https://docs.rs/crossbeam/latest/crossbeam/sync/struct.WaitGroup.html"><code>WaitGroup</code></a>. The WaitGroup is stored in the <code>Jars</code> storage, and its counter is incremented whenever a <code>Snapshot</code> is created and automatically decremented when a <code>Snapshot</code> drops.</p>
<p>The last missing piece is to ensure that queries stop &quot;soonish&quot; when cancellation is requested. This is achieved by changing the <code>db.jar()</code> method to return a <code>QueryResult</code>. It returns <code>Err(QueryError::Cancelled)</code> in case cancellation has been requested. This requires that we change the return type of each query to <code>QueryResult</code> because they won&#x27;t have a result when they&#x27;re cancelled.
Checking cancellation in the <code>jars</code> method has the advantage that it is automatically tested by each query that uses caching because the method is needed to retrieve the query storage. Queries have the possibility to manually test for cancellation if needed by calling <code>db.cancelled()?</code>, but that should only be necessary for long operations that never issue a new query.</p>
Catch unwind
<p>An alternative to <code>QueryResult</code> is to panic with a specific error and catch that error in a catch unwind boundary. This is what salsa does. I decided to use a <code>Result</code> instead to make cancellation more explicit. I think that it is important to be aware that a request can be cancelled because it means that we need to ensure to never write &quot;partial&quot; results into the cache, and if we do, have a way to undo the change in case the query gets cancelled to leave the cache in a clean state.</p>
Test plan
<p>I ran the linter and used <code>touch</code> to trigger a re-run. This PR adds a new <code>RED_KNOT_SLOW_LINT</code> that adds an artificial slowdown to <code>lint_syntax</code> for testing cancellation.</p>
Attribution
<p>The ideas here are heavily inspired by Salsa and sometimes applied 1:1.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-04-28 10:58</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>âœ… ecosystem check detected no linter changes.</p>
Linter (preview)
<p>âœ… ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>âœ… ecosystem check detected no format changes.</p>
Formatter (preview)
<p>âœ… ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[red-knot] Add snapshotting mechanism&quot; to &quot;[red-knot] Add &quot;cheap&quot; `program.snapshot` &quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-04-29 09:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-04-29 09:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/cancellation.rs</code>:12 on 2024-04-29 09:22</div>
            <div class="timeline-body"><p>I simplified the implementation because we never used the <code>wait</code> method that needs the condvar.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-04-29 10:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/main.rs</code>:140 on 2024-04-29 10:24</div>
            <div class="timeline-body"><p>@snowsignal I think the loop here is now very similar to what we have in the LSP. That&#x27;s why I think that it should now be easy to implement the database into the LSP.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-04-29 10:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/main.rs</code>:236 on 2024-04-29 10:25</div>
            <div class="timeline-body"><p>@carljm Thanks for the suggestion using a revision. I think it simplifies a lot.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-04-29 10:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/program/check.rs</code>:230 on 2024-04-29 10:27</div>
            <div class="timeline-body"><p>This can deadlock when <code>files.len() &gt; max_concurrency)</code>. I have a follow up PR to fix this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-04-29 10:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/program/mod.rs</code>:130 on 2024-04-29 10:28</div>
            <div class="timeline-body"><p>I think we can derive the implementations in the future by having a <code>#[derive(Db(field_name=jars, jars=(SourceJar, SemanticJar)))]</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-04-29 10:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-04-29 11:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/snowsignal">@snowsignal</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-04-29 11:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-04-29 11:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-04-29 11:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/db/storage.rs</code>:65 on 2024-04-29 11:09</div>
            <div class="timeline-body"><p>This takes a <code>&amp;mut self</code>, so this method can only be called from the main database but never from a <code>Snapshot</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/red_knot/src/db.rs</code>:56 on 2024-04-29 16:40</div>
            <div class="timeline-body"><p>I think this sentence is unfinished?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/red_knot/src/db.rs</code>:96 on 2024-04-29 16:54</div>
            <div class="timeline-body"><p>I really like how you ensured snapshot immutability here ðŸ˜„</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/red_knot/src/main.rs</code>:140 on 2024-04-29 17:05</div>
            <div class="timeline-body"><p>This does look similar! I think the main difference is that here, a response is sent back to the main loop, whereas server tasks don&#x27;t (currently) communicate with the main loop. That shouldn&#x27;t make things harder for the server (in fact, I think it will be even easier than what we have here), I just wanted to point that out.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/red_knot/src/program/check.rs</code>:274 on 2024-04-29 17:18</div>
            <div class="timeline-body"><p>Shouldn&#x27;t we return <code>Err(QueryError::Cancelled)</code> immediately if we get <code>CheckFileMessage::Cancelled</code>, instead of waiting for the loop to finish?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> approved on 2024-04-29 17:23</div>
            <div class="timeline-body"><p>Thank you for implementing this! The detailed comments you left made this pull request really easy to read, and I can see a way to integrate this with the server as-is ðŸ˜„</p>
<p>I&#x27;ve left a few small comments but otherwise this looks great!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-04-29 23:47</div>
            <div class="timeline-body"><p>Looks good!</p>
<p>To be clear, the &quot;immutable snapshot&quot; means we won&#x27;t be applying file changes or invalidating anything concurrently (which is great, because it will simplify invalidation a lot). But caching within e.g. <code>TypeStore</code> uses interior mutability and can still be updated in workers, because it implements its own internal locking and doesn&#x27;t rely on having an exclusive reference to the db.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-04-30 06:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/main.rs</code>:140 on 2024-04-30 06:49</div>
            <div class="timeline-body"><p>That&#x27;s true. Thanks for pointing this out. I agree, I don&#x27;t think this should matter because that communication is only about how results are communicated back to the user interface. In the LSP case, that&#x27;s done by sending a response and in the CLI case it&#x27;s done by sending a message back to the main loop.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-04-30 06:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/db.rs</code>:96 on 2024-04-30 06:55</div>
            <div class="timeline-body"><p>Thank you, but I don&#x27;t really deserve the credit because I only stole the idea from salsa :D But I agree, it&#x27;s a very clever (and simple) way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-04-30 06:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/program/check.rs</code>:274 on 2024-04-30 06:58</div>
            <div class="timeline-body"><p>The problem with returning immediately is that we then drop the only reference to <code>receiver</code>. That means, that any <code>sender.send(message).unwrap()</code> calls will fail in the threads checking the files. I&#x27;m not sure if there&#x27;s a more idiomatic way of doing this other than waiting for all file check operations to complete to be sure there will be no more incoming messages and only then exit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-04-30 07:00</div>
            <div class="timeline-body"><blockquote>
<p>To be clear, the &quot;immutable snapshot&quot; means we won&#x27;t be applying file changes or invalidating anything concurrently (which is great, because it will simplify invalidation a lot). But caching within e.g. TypeStore uses interior mutability and can still be updated in workers, because it implements its own internal locking and doesn&#x27;t rely on having an exclusive reference to the db.</p>
</blockquote>
<p>Yes, that&#x27;s correct. The immutable snapshot still allows for caches to cache new values, but no &quot;inputs&quot; should change (which would change the result of  the analysis). Another way to think about this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-04-30 07:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-04-30 07:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-04-30 07:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-04-30 15:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/red_knot/src/program/check.rs</code>:274 on 2024-04-30 15:12</div>
            <div class="timeline-body"><p>Can&#x27;t we just handling that error in the threads checking the files though? Like, if <code>sender.send(message)</code> fails, we can still exit the thread gracefully instead of panicking.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-04-30 16:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/program/check.rs</code>:274 on 2024-04-30 16:08</div>
            <div class="timeline-body"><p>I guess we could, but it would mean that it will be harder to find the bug if we drop the receiver accidentally for another reason. Anyway. The next PR reworked this quiet significantly and I think there we can return immediately.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:03:45 UTC
    </footer>
</body>
</html>
