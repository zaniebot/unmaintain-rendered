<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Reject obvious `snapshot-diagnostics` typos in mdtests - astral-sh/ruff #16426</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Reject obvious <code>snapshot-diagnostics</code> typos in mdtests</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16426">#16426</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-02-27 22:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body">Summary
<p>This PR adds some heuristics to the mdtest framework so that obvious typos such as <code>&lt;!-- snpashot-diagnostics</code> or <code>&lt;!-- snpshot-dignosstics --&gt;</code> are rejected. The heuristics are that if the HTML comment is not equal to <code>snapshot-diagnostics</code>, but has a high fuzzy similarity score and is similar in length, we deduce that it&#x27;s probably a typo.</p>
<p>I&#x27;m not sure at all this is the way to go, but I figured I&#x27;d put it up to see what people think of the idea. The pros of this PR are that it&#x27;s an easy mistake to make to have a typo in a <code>snapshot-diagnostics</code> HTML comment, and that this PR doesn&#x27;t add much complexity to mdtest. The cons are that we add some dissatisfying heuristics to mdtest, and add a new (admittedly very small) third-party dependency.</p>
<p>Note that the <code>looks_like_snapshot_directive_typo()</code> function introduced in this PR also has <em>some</em> false positives. It rejects HTML comments such as <code>&lt;!-- snapdragon-diagnostics --&gt;</code> as being too similar to <code>&lt;!-- snapshot-diagnostics --&gt;</code>. It <em>does</em> seem pretty unlikely that anybody is going to actually add a <code>&lt;!-- snapdragon-diagnostics --&gt;</code> HTML comment to an mdtest, however; we have the luxury of knowing that this framework is only for internal use.</p>
<p>Fixes <a href="https://github.com/astral-sh/ruff/issues/16352">astral-sh/ruff#16352</a></p>
Test Plan
<p>Added unit tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-27 22:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-27 22:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/BurntSushi">@BurntSushi</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-27 22:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-27 22:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-27 22:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-27 22:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-27 23:00</div>
            <div class="timeline-body"><p>aw c&#x27;mon, now the <code>typos</code> pre-commit hook is complaining about the test I added to make sure that we detected typos</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-02-27 23:02</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-27 23:08</div>
            <div class="timeline-body"><blockquote>
<p>aw c&#x27;mon, now the <code>typos</code> pre-commit hook is complaining about the test I added to make sure that we detected typos</p>
</blockquote>
<p>...and I suppose that does point to another obvious approach that avoids false positives, which is to do exactly what that project does (hard-code a list of obvious typos for <code>snapshot</code> and <code>diagnostics</code>, and reject HTML comments that contain any of them)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-27 23:16</div>
            <div class="timeline-body"><p>I&#x27;m actually unsure why that pre-commit hook is catching the typo in <code>.rs</code> files but not in <code>.md</code> files</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-02-28 00:53</div>
            <div class="timeline-body"><p>I&#x27;m OK with this, but I think I&#x27;d prefer the simpler plan of just having an allowlist of HTML comments that are not an error in an mdtest. It looks to me like the only ones currently used are <code>snapshot-diagnostics</code>, <code>blacken-docs:on</code>, and <code>blacken-docs:off</code>. That&#x27;s a very manageable allowlist, and I don&#x27;t really see why we&#x27;d need freeform HTML comments in mdtests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-28 00:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-28 10:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-28 10:04</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:11:52 UTC
    </footer>
</body>
</html>
