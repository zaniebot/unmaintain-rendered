<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix file watching on macOS if a module-search path is a symlink - astral-sh/ruff #12634</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix file watching on macOS if a module-search path is a symlink</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/12634">#12634</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-08-02 15:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR fixes the <code>symlinked_module_search_path</code> test for macOS</p>
<p>The scenario that it tests is</p>
<pre><code>A module search path is a symlink.

Setup:

 - site-packages
   | - bar/baz.py

 - workspace
   |-- .venv/lib/python3.12/site-packages -&gt; /site-packages
   |
   |-- foo.py
</code></pre>
<p>The key point here is that the <code>site-packages</code> module search path links to a path outside the workspace. But the symlink itself is part of the workspace.</p>
<p>Fixing this required a few changes:</p>
<ol>
<li>We need to canonicalize the watch paths <strong>before</strong> deduplicating them to avoid removing <code>.venv/lib/python3.12/site-packages</code> because we believe the workspace watch already covers it.</li>
<li>We need to canonicalize watch paths or the macOS watcher won't observe any changes made in that directory (it would only observe the symlink file, not what we want)</li>
<li>We need to canonicalize the module search paths because the module path otherwise is <code>.venv/lib/python3.12/site-packages/bar/baz.py</code> but the watcher emits events for <code>site-packages/bar/baz.py</code>.</li>
</ol>
<p>Now this fixed it for macOS, but it broke Windows and Unix. Fun times.</p>
<p>I'm not too fond of what comes next, but it seems that Windows and Unix rely on the order in which the watch paths are registered (oh my...) and emit an event for the last registered watch path. In the previous implementation, the workspace was always last, so we only received an event for ``.venv/lib/python3.12/site-packages/bar/baz.py<code>, but not for </code>site-packages/bar/baz.py` and thus missed the updated :(</p>
<p>This PR changes the order in which we register search paths.</p>
<p>Fixes #12645</p>
<h2>Alternative designs</h2>
<p>I considered canonicalizing the path in <code>apply_changes</code> so that we cover both the symlinked and canonicalized paths. This works fine unless someone deletes the file, in which case canonicalizing no longer works.</p>
<p>We could keep a bi-directional map from path -&gt; realpath and realpath -&gt; path in <code>Files</code>. I see this as an option but I would still prefer if we don't need it, at least for now.</p>
<p>I'm open to alternative suggestions.</p>
<h2>Test plan</h2>
<p>I tested the last revision on macOs and Linux. The test on the Windows CI pass.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-08-02 15:53</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<details><summary><a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)</summary>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to parse examples/Chat_finetuning_data_prep.ipynb:6:18:25: Unparenthesized generator expression cannot be used here
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_confluence.ipynb:15:1:5: Simple statements must be separated by newlines or semicolons
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_gmail.ipynb:15:1:1: Expected an expression
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_jira.ipynb:15:1:1: Expected an expression
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_notion.ipynb:15:1:1: Expected an expression
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_sharepoint_doc.ipynb:28:1:5: Simple statements must be separated by newlines or semicolons
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_sharepoint_text.ipynb:28:1:5: Simple statements must be separated by newlines or semicolons
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_middleware_azure_function.ipynb:37:1:13: Simple statements must be separated by newlines or semicolons
</code></pre>
</p>
</details>

<h3>Formatter (preview)</h3>
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<details><summary><a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)</summary>
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to parse examples/Chat_finetuning_data_prep.ipynb:6:18:25: Unparenthesized generator expression cannot be used here
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_confluence.ipynb:15:1:5: Simple statements must be separated by newlines or semicolons
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_gmail.ipynb:15:1:1: Expected an expression
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_jira.ipynb:15:1:1: Expected an expression
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_notion.ipynb:15:1:1: Expected an expression
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_sharepoint_doc.ipynb:28:1:5: Simple statements must be separated by newlines or semicolons
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_sharepoint_text.ipynb:28:1:5: Simple statements must be separated by newlines or semicolons
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_middleware_azure_function.ipynb:37:1:13: Simple statements must be separated by newlines or semicolons
</code></pre>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @MichaReiser on 2024-08-02 17:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-08-02 17:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/watch/workspace_watcher.rs</code>:74 on 2024-08-02 17:24</div>
            <div class="timeline-body"><p>There's a small risk that we miss events between de-registering and registering. Pyright also removes all watchers before setting the new watchers so I think that's fine (this code should almost never run)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2024-08-02 17:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MichaReiser on 2024-08-02 17:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MichaReiser on 2024-08-02 17:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Canonicalize watch paths" to "Fix file watching on macOS if a module-search path is a symlink" by @MichaReiser on 2024-08-02 17:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_workspace/src/watch/workspace_watcher.rs</code>:55 on 2024-08-02 18:20</div>
            <div class="timeline-body"><p>I'm not sure I understand how this can happen if a) we first canonicalize all paths and then b) we de-deduplicate nested paths.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_workspace/src/watch/workspace_watcher.rs</code>:55 on 2024-08-02 18:22</div>
            <div class="timeline-body"><p>Oh, if there's a symlink from within one root to within another root, on some systems I guess we might get an event for a path within either root (or both) for the symlinked file (or a file inside a symlinked directory)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-08-02 18:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/watch/workspace_watcher.rs</code>:55 on 2024-08-03 07:19</div>
            <div class="timeline-body"><p>I added an example.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-08-03 07:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2024-08-03 07:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-08-03 07:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-08-03 07:24</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:05:39 UTC
    </footer>
</body>
</html>
