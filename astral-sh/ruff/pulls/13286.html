<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pydoclint`] Add support for Sphinx-style docstrings in the `pydoclint` rules. - astral-sh/ruff #13286</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pydoclint</code>] Add support for Sphinx-style docstrings in the <code>pydoclint</code> rules.</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13286">#13286</a>
        opened by <a href="https://github.com/augustelalande">@augustelalande</a>
        on 2024-09-08 21:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/augustelalande">@augustelalande</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>Add support for Sphinx-style docstrings in the <code>pydoclint</code> rules. This also defines (out of necessity) the set of pydocstyle rules enforced when the sphinx style is selected. For lack of a good reference I just copied the exclusions from the pep257 selection, minus <code>Rule::SectionNotOverIndented</code>.</p>
<p>Part of #12434.</p>
<p>Resolves #12520.</p>
<h2>Test Plan</h2>
<p>Test cases added.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-09-08 21:24</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+0 -36 violations, +0 -0 fixes in 2 projects; 52 projects unchanged)</p>
<details><summary><a href="https://github.com/bokeh/bokeh">bokeh/bokeh</a> (+0 -2 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/document/document.py#L767'>src/bokeh/document/document.py:767:9:</a> DOC201 `return` is not documented in docstring
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/document/models.py#L160'>src/bokeh/document/models.py:160:9:</a> DOC201 `return` is not documented in docstring
</pre>

</p>
</details>
<details><summary><a href="https://github.com/pandas-dev/pandas">pandas-dev/pandas</a> (+0 -34 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
- doc/source/user_guide/style.ipynb:cell 113:31:89: E501 Line too long (90 > 88)
- doc/source/user_guide/style.ipynb:cell 113:33:89: E501 Line too long (98 > 88)
- doc/source/user_guide/style.ipynb:cell 123:5:56: E741 Ambiguous variable name: `l`
- doc/source/user_guide/style.ipynb:cell 125:2:13: C408 Unnecessary `dict` call (rewrite as a literal)
- doc/source/user_guide/style.ipynb:cell 125:4:13: C408 Unnecessary `dict` call (rewrite as a literal)
- doc/source/user_guide/style.ipynb:cell 125:6:13: C408 Unnecessary `dict` call (rewrite as a literal)
- doc/source/user_guide/style.ipynb:cell 125:8:13: C408 Unnecessary `dict` call (rewrite as a literal)
- doc/source/user_guide/style.ipynb:cell 126:1:1: NPY002 Replace legacy `np.random.seed` call with `np.random.Generator`
- doc/source/user_guide/style.ipynb:cell 126:2:1: PLW0127 Self-assignment of variable `cmap`
- doc/source/user_guide/style.ipynb:cell 126:2:8: PLW0128 Redeclared variable `cmap` in assignment
- doc/source/user_guide/style.ipynb:cell 126:3:22: NPY002 Replace legacy `np.random.randn` call with `np.random.Generator`
- doc/source/user_guide/style.ipynb:cell 128:1:22: NPY002 Replace legacy `np.random.randn` call with `np.random.Generator`
- doc/source/user_guide/style.ipynb:cell 134:1:89: E501 Line too long (93 > 88)
- doc/source/user_guide/style.ipynb:cell 141:1:89: E501 Line too long (95 > 88)
- doc/source/user_guide/style.ipynb:cell 157:1:38: F811 Redefinition of unused `f` from cell 123, line 5
- doc/source/user_guide/style.ipynb:cell 15:2:89: E501 Line too long (103 > 88)
- doc/source/user_guide/style.ipynb:cell 15:3:89: E501 Line too long (156 > 88)
- doc/source/user_guide/style.ipynb:cell 16:48:89: E501 Line too long (103 > 88)
... 12 additional changes omitted for rule E501
- doc/source/user_guide/style.ipynb:cell 37:1:1: NPY002 Replace legacy `np.random.seed` call with `np.random.Generator`
- doc/source/user_guide/style.ipynb:cell 37:2:20: NPY002 Replace legacy `np.random.randn` call with `np.random.Generator`
- doc/source/user_guide/style.ipynb:cell 60:1:20: NPY002 Replace legacy `np.random.randn` call with `np.random.Generator`
- doc/source/user_guide/style.ipynb:cell 6:1:27: NPY002 Replace legacy `np.random.rand` call with `np.random.Generator`
... 2 additional changes omitted for rule NPY002
</pre>

</p>
</details>
<details><summary>Changes by rule (8 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| E501 | 18 | 0 | 18 | 0 | 0 |
| NPY002 | 8 | 0 | 8 | 0 | 0 |
| C408 | 4 | 0 | 4 | 0 | 0 |
| DOC201 | 2 | 0 | 2 | 0 | 0 |
| E741 | 1 | 0 | 1 | 0 | 0 |
| PLW0127 | 1 | 0 | 1 | 0 | 0 |
| PLW0128 | 1 | 0 | 1 | 0 | 0 |
| F811 | 1 | 0 | 1 | 0 | 0 |</p>
</p>
</details>

<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-10 18:22</div>
            <div class="timeline-body"><p>Wow thanks. This is great.</p>
<p>There are a lot of new ecosystem reports. Some of the superset violations look somewhat suspicious:</p>
<ul>
<li><a href="https://github.com/apache/superset/blob/0744abe87bacd1ff79672106b9bcaf93e6e4b816/RELEASING/generate_email.py#L47">RELEASING/generate_email.py:47:5:</a> D405 [*] Section name should be properly capitalized (&quot;&quot;)</li>
<li><a href="https://github.com/apache/superset/blob/0744abe87bacd1ff79672106b9bcaf93e6e4b816/RELEASING/generate_email.py#L47">RELEASING/generate_email.py:47:5:</a> D410 [*] Missing blank line after section (&quot;&quot;)</li>
<li><a href="https://github.com/apache/superset/blob/0744abe87bacd1ff79672106b9bcaf93e6e4b816/RELEASING/generate_email.py#L49">RELEASING/generate_email.py:49:5:</a> D405 [*] Section name should be properly capitalized (&quot;&quot;)</li>
<li><a href="https://github.com/apache/superset/blob/0744abe87bacd1ff79672106b9bcaf93e6e4b816/RELEASING/generate_email.py#L49">RELEASING/generate_email.py:49:5:</a> D411 [*] Missing blank line before section (&quot;&quot;)</li>
<li><a href="https://github.com/apache/superset/blob/0744abe87bacd1ff79672106b9bcaf93e6e4b816/RELEASING/generate_email.py#L49">RELEASING/generate_email.py:49:5:</a> D413 [*] Missing blank line after last section (&quot;&quot;)</li>
<li><a href="https://github.com/apache/superset/blob/0744abe87bacd1ff79672106b9bcaf93e6e4b816/RELEASING/generate_email.py#L49">RELEASING/generate_email.py:49:5:</a> D414 Section has no content (&quot;&quot;)</li>
</ul>
<p>Like why are all the names empty?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-10 18:31</div>
            <div class="timeline-body"><p>It might just be that the docstyle is a bit too aggressive right now. Should <a href="https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/server/app/server_auth/app.py#L4">this</a> be considered a sphinx docstring?</p>
<p>Before I try to figure it out from the code. Did you gate the new code style behind preview mode? I think we have to because this change greatly increases the scope of the rule and it's probably good to get some feedback before rolling it out to everyone</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/augustelalande">@augustelalande</a> on 2024-09-10 19:24</div>
            <div class="timeline-body"><p>All the <code>pydoclint</code> rules are in preview</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-11 20:10</div>
            <div class="timeline-body"><p>Looking at the airflow result I'm unsure if the parsing is correct. Could you take a look at them?</p>
<p>Why is <code>param</code> over indented?</p>
<ul>
<li><ul>
<li><a href="https://github.com/apache/airflow/blob/a71944f8c401ce82a2c3a920cb2eab128f8215ad/airflow/providers/google/leveldb/operators/leveldb.py#L36">airflow/providers/google/leveldb/operators/leveldb.py:36:10:</a> D214 [*] Section is over-indented (&quot;param&quot;)</li>
</ul>
</li>
</ul>
<p>Why is <code>param</code> considered a section?</p>
<ul>
<li><a href="https://github.com/apache/airflow/blob/a71944f8c401ce82a2c3a920cb2eab128f8215ad/airflow/api/common/delete_dag.py#L47">airflow/api/common/delete_dag.py:47:6:</a> D410 [*] Missing blank line after section (&quot;param&quot;)</li>
</ul>
<p>The other thing I'm unsure about is whether the blank line rule between parameters should be disabled by default. All the examples I found don't require blank lines between parameters. What do you think?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/augustelalande">@augustelalande</a> on 2024-09-11 20:37</div>
            <div class="timeline-body"><blockquote>
<p>Why is param over indented?</p>
</blockquote>
<p>It is over indented relative to the docstring as a whole, since it is indented within the <code>.. seealso::</code> section</p>
<blockquote>
<p>Why is param considered a section?</p>
</blockquote>
<p>Sphinx doesn't have sections per se, so to make the sphinxs docstrings fit into the mold in use for google and numpy docstrings, I consider each <code>:param title: Text</code> to be a section.</p>
<p>Note: It's not possible to combine all the param entries into a single param sections, since as far as I know there is no obligation that params must follow each other, although in practice they usually would.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-11 20:46</div>
            <div class="timeline-body"><blockquote>
<p>Sphinx doesn't have sections per se, so to make the sphinxs docstrings fit into the mold in use for google and numpy docstrings, I consider each :param title: Text to be a section.</p>
</blockquote>
<p>That makes sense but it seems confusing to users because I wouldn't consider those sections and it seems to cause many false positives in other rules. I would have to think this through more carefully but would we emit different diagnostics if we designed this from scratch?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tmke8">@tmke8</a> on 2024-09-11 21:12</div>
            <div class="timeline-body"><p>Everything sphinx can parse successfully with default settings should be fine, no? And sphinx definitely doesn't require blank lines between <code>:param ...:</code> entries.</p>
<p>Here is a docstring that uses a lot of sphinx features and which is parsed correctly by sphinx.</p>
<pre><code class="language-python">class SAM(Optimizer):
    &quot;&quot;&quot;Sharpness Aware Minimization

    Implements the 'Sharpness Aware Minimization' (SAM) algorithm introducued in
    `Sharpness Aware Minimization`_) and the adaptive variant of it introduced in `ASAM`_.

    We can use inline math: :math:`\\alpha`. You don't need the double backslash if
    the python docstring is a raw string (r-string).

    Block math:

    .. math::

       (a + b)^2 = a^2 + 2ab + b^2

    .. note::
        Implementation based on: https://github.com/cybertronai/pytorch-lamb
    .. seealso:: :class:`LAMB`

    .. _Sharpness Aware Minimization:
        https://arxiv.org/abs/2010.01412
    .. _ASAM:
        https://arxiv.org/abs/2102.11600

    :param base_optimizer: Base optimizer for SAM. (If the explanation goes
        over two lines, the second line needs to be indented.
    :param rho: Neighborhood size.

    :raises ValueError: if ``rho`` is negative.

    :example:
        Everything associated with the example section needs to be indented, so that Sphinx
        knows what belongs to the example.

        .. code-block:: python

           # Use AdamW as the base optimizer.
           base_optimizer = AdamW(model.parameters())
           # Wrap the base optimizer in SAM.
           optimizer = SAM(base_optimizer)

           # Closure required for recomputing the loss after computing epsilon(w).
           def _closure():
               return loss_function(logits=model(input), targets=targets)

           loss = _closure()
           loss.backward()

           optimizer.step(closure=_closure)
           optimizer.zero_grad()

        You can also write it in this syntax:

        &gt;&gt;&gt; import template
        &gt;&gt;&gt; a = template.MainClass1()
        &gt;&gt;&gt; a.function1(1,1,1)
        2
    &quot;&quot;&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/augustelalande">@augustelalande</a> on 2024-09-11 21:25</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>Sphinx doesn't have sections per se, so to make the sphinxs docstrings fit into the mold in use for google and numpy docstrings, I consider each :param title: Text to be a section.</p>
</blockquote>
<p>That makes sense but it seems confusing to users because I wouldn't consider those sections and it seems to cause many false positives in other rules. I would have to think this through more carefully but would we emit different diagnostics if we designed this from scratch?</p>
</blockquote>
<p>We probably would not emit D410 among others for sphinx style docstrings. And in fact if the user specifies sphinx as their docstring convention then those rules get disabled (each convention runs a different subset of D). The problem is when the convention is unspecified we still run it.</p>
<p>One solution would be to disable innapropriate rules if sphinx is detected. There is some precendence for that, and I have already done it for some of them.</p>
<p>I don't know what a &quot;proper&quot; implementation of &quot;D410&quot; would look like for sphinx, since there are no &quot;sections&quot; per se</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/augustelalande">@augustelalande</a> on 2024-09-11 21:29</div>
            <div class="timeline-body"><p>One of the problems is that <code>pydocstyle</code> doesn't support sphinx so there is nothing to reference. We could choose to not run <code>pydocstyle</code> rules if sphinx is detected or specified.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @MichaReiser on 2024-09-12 18:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @MichaReiser on 2024-09-12 18:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tmke8">@tmke8</a> on 2024-09-19 13:35</div>
            <div class="timeline-body"><p>So, is the problem here that pydocstyle and pydoclint are incompatible? I see a <code>--convention=pep257</code> flag in pydocstyle – this sounds like the convention that should be compatible with &quot;sphinx-style&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @MichaReiser by @MichaReiser on 2024-09-20 08:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-23 23:27</div>
            <div class="timeline-body"><p>One thing I'm not following from the conversation is why there are so many <code>D</code> rule changes in stable. I know the pydoclint rules are in preview, but I think this Sphinx detection should be too, right? In other words, we shouldn't see any non-preview changes in this PR for the <code>D</code> rules.</p>
<p>Another thing we could do is: never <em>infer</em> Sphinx. Require that users set it via a <code>convention</code>. That would help a lot with backwards compatibility while still giving us these benefits. On top of that, I'd err on the side of enabling a small set of rules for Sphinx, those we are confident in.</p>
<p>Finally... I think pydocstyle <em>did</em> add Sphinx support, at least for D417? Can we make sure that whatever we do here is consistent with the pydocstyle implementation? See: https://github.com/PyCQA/pydocstyle/pull/595</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/augustelalande">@augustelalande</a> on 2024-09-28 05:33</div>
            <div class="timeline-body"><p>Per above, I have improved the gating so sphinx will only be active in preview mode.</p>
<p>I have also implemented the change to never infer sphinx, which should prevent a lot of the issues. But I am concerned that this prevents the ecosystem check to work properly, since they don't specify sphinx in their configs. Would love to hear some insights on this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/augustelalande">@augustelalande</a> on 2024-09-28 05:39</div>
            <div class="timeline-body"><p>Ok so D417 is undocumented-param, which I think I can address in #13280 if this gets merged first (otherwise I'll add it here). Note, we already don't have full parity with D417 since the ruff version only supports google style.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CommentatorForAll">@CommentatorForAll</a> on 2025-05-05 09:06</div>
            <div class="timeline-body"><p>what is the state of this pull request and when can a merge be expected?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/afonsotrepa">@afonsotrepa</a> on 2025-10-02 17:57</div>
            <div class="timeline-body"><p>Is there anything left (for a non-maintainer) to do to get this merged?
I'm willing to put in some cycles if needed.</p>
<p>Thanks for the great work @augustelalande</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-12 06:26</div>
            <div class="timeline-body"><p>It's mainly that someone from the team has to find the time to go through all the changes again. We'll do some roadmapping next week. I'll try to bring it up there</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:06:26 UTC
    </footer>
</body>
</html>
