<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Handle cycles when finding implicit attributes - astral-sh/ruff #19833</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Handle cycles when finding implicit attributes</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19833">#19833</a>
        opened by <a href="https://github.com/dcreager">@dcreager</a>
        on 2025-08-08 18:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a></div>
            <div class="timeline-body"><p>The <a href="https://gist.github.com/dcreager/fc53c59b30d7ce71d478dcb2c1c56444">minimal reproduction</a> of https://github.com/astral-sh/ty/issues/948 is an example of a class with implicit attributes whose types end up depending on themselves. Our existing cycle detection for <code>infer_expression_types</code> is usually enough to handle this situation correctly, but when there are very many of these implicit attributes, we get a combinatorial explosion of running time and memory usage.</p>
<p>Adding a separate cycle handler for <code>ClassLiteral::implicit_attribute</code> lets us catch and recover from this situation earlier.</p>
<p>Closes https://github.com/astral-sh/ty/issues/948</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dcreager on 2025-08-08 18:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @dcreager on 2025-08-08 18:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dcreager on 2025-08-08 18:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @dcreager on 2025-08-08 18:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-08 18:08</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-08 18:09</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅</p>
<details>
<summary>Memory usage changes were detected when running on open source projects</summary>

<pre><code class="language-diff">trio (https://github.com/python-trio/trio)
- TOTAL MEMORY USAGE: ~159MB
+ TOTAL MEMORY USAGE: ~167MB
-     struct fields = ~9MB
+     struct fields = ~10MB
-     memo metadata = ~22MB
+     memo metadata = ~23MB

sphinx (https://github.com/sphinx-doc/sphinx)
-     struct metadata = ~11MB
+     struct metadata = ~12MB
-     memo metadata = ~38MB
+     memo metadata = ~40MB

prefect (https://github.com/PrefectHQ/prefect)
-     struct metadata = ~25MB
+     struct metadata = ~26MB

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-08-08 18:15</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_INSTRUMENTATION_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/dcreager%2Fflax-hang?runnerMode=Instrumentation">CodSpeed Instrumentation Performance Report</a></h2>
<h3>Merging #19833 will <strong>improve performances by 7.15%</strong></h3>
<p><sub>Comparing <code>dcreager/flax-hang</code> (cac8c77) with <code>main</code> (0095ff4)</sub></p>
<h3>Summary</h3>
<p><code>⚡ 2</code> improvements<br />
<code>✅ 40</code> untouched benchmarks</p>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ⚡ | <code>ty_micro[many_enum_members]</code> | 103.2 ms | 96.3 ms | +7.15% |
| ⚡ | <code>ty_micro[many_string_assignments]</code> | 73.3 ms | 69.8 ms | +5.04% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-08-08 18:16</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_WALLTIME_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/dcreager%2Fflax-hang?runnerMode=WallTime">CodSpeed WallTime Performance Report</a></h2>
<h3>Merging #19833 will <strong>improve performances by 9.43%</strong></h3>
<p><sub>Comparing <code>dcreager/flax-hang</code> (cac8c77) with <code>main</code> (0095ff4)</sub></p>
<h3>Summary</h3>
<p><code>⚡ 1</code> improvements<br />
<code>✅ 6</code> untouched benchmarks</p>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ⚡ | <code>medium[pandas]</code> | 26.9 s | 24.6 s | +9.43% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-08-08 20:56</div>
            <div class="timeline-body"><p>Nice find! I suspect the win here is not &quot;catching the cycle sooner&quot; but that we are now memoizing a chunk of work that we did not memoize before, and presumably that work was previously being repeated a lot in cycle iteration, and now is not.</p>
<p>This is a good reminder that there are potentially significant performance wins hiding in &quot;add memoization&quot; that aren't necessarily obvious until we hit a pathological case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dcreager on 2025-08-08 21:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dcreager on 2025-08-08 21:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-08 21:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-08-09 16:27</div>
            <div class="timeline-body"><p>This does seem to increae memory usage a fair bit. I'm not suggesting that this wasn't the right fix. But it might have been interesting to measure the total memory usage on a large project and comparing it to main (by using <code>TY_MEMORY_REPORT=full</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-10 13:08</div>
            <div class="timeline-body"><blockquote>
<p>The <a href="https://gist.github.com/dcreager/fc53c59b30d7ce71d478dcb2c1c56444">minimal reproduction</a> of <a href="https://github.com/astral-sh/ty/issues/948">astral-sh/ty#948</a> is an example of a class with implicit attributes whose types end up depending on themselves.</p>
</blockquote>
<p>Is it worth adding something like this as a micro-benchmark, to ensure that we don't regress on this in the future?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:14:57 UTC
    </footer>
</body>
</html>
