<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] `SemanticIndexBuilder` visits value before target in named expressions - astral-sh/ruff #13053</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] <code>SemanticIndexBuilder</code> visits value before target in named expressions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13053">#13053</a>
        opened by <a href="https://github.com/dylwil3">@dylwil3</a>
        on 2024-08-22 11:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-08-22 11:45</div>
            <div class="timeline-body"><p>The <code>SemanticIndexBuilder</code> was causing a cycle in a salsa query by attempting to resolve the target before the value in a named expression (e.g. <code>x := x+1</code>). This PR swaps the order, avoiding a panic.</p>
<p>Closes #13012.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dylwil3 on 2024-08-22 11:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dylwil3 on 2024-08-22 11:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dylwil3 on 2024-08-22 11:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-08-22 11:51</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/dylwil3:red-knot-named-expr">CodSpeed Performance Report</a></h2>
<h3>Merging #13053 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>dylwil3:red-knot-named-expr</code> (c7bd4ba) with <code>main</code> (02c4373)</sub></p>
<h3>Summary</h3>
<p><code>✅ 32</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @MichaReiser on 2024-08-22 12:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-08-22 12:10</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-08-22 13:15</div>
            <div class="timeline-body"><p>Thanks. Makes sense</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-08-22 13:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/resources/test/corpus/04_assign_named_expr.py</code>:1 on 2024-08-22 13:16</div>
            <div class="timeline-body"><p>Up to now, the corpus tests are inherited tests from other projects. I don't see a strong reason why we shouldn't use the same infrastructure to add our own smoke tests but interested to hear what others think</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:663 on 2024-08-22 13:23</div>
            <div class="timeline-body"><p>I'm not sure if it matters, but elsewhere in this file <code>self.current_assignment</code> is always <code>None</code> unless we're visiting the <em>target</em> of the assignment. So that implies that we should do this:</p>
<pre><code class="language-suggestion">                self.visit_expr(&amp;node.value);
                self.current_assignment = Some(node.into());
                // TODO walrus in comprehensions is implicitly nonlocal
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-22 13:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-22 13:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_workspace/resources/test/corpus/04_assign_named_expr.py</code>:1 on 2024-08-22 13:23</div>
            <div class="timeline-body"><p>I'm fine with using the same infrastructure personally, I think it makes sense!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-08-22 13:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:663 on 2024-08-22 13:28</div>
            <div class="timeline-body"><p>Yes to what Alex has suggested, because the <code>current_assignment</code> is used to add the definition for the target expression.</p>
<p>This makes me wonder why there's no failure because for something like <code>x := x + 1</code> there'll be two definitions. Maybe we might want to add a semantic index test case for named expression in https://github.com/astral-sh/ruff/blob/d37e2e5d33deadc15bf4194216e08ce1528a638c/crates/red_knot_python_semantic/src/semantic_index.rs#L309-L310.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-08-22 13:29</div>
            <div class="timeline-body"><p>@dylwil3 -- just want to say how much I appreciate your contributions recently, they're very high-quality!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2024-08-22 13:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:663 on 2024-08-22 13:33</div>
            <div class="timeline-body"><p>Done! (re reordering - still have to add a unit test)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-08-22 13:35</div>
            <div class="timeline-body"><blockquote>
<p>@dylwil3 -- just want to say how much I appreciate your contributions recently, they're very high-quality!</p>
</blockquote>
<p>Thank you! Truly a joy to contribute to this repo: well-written code, friendly maintainers, and <em>incredibly fast</em> (and helpful!) feedback for issues and PRs!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2024-08-22 14:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:663 on 2024-08-22 14:09</div>
            <div class="timeline-body"><p>Thanks for the suggestion @dhruvmanila ! The plot thickens... this test fails when trying to unwrap the <code>first_definition</code>:</p>
<pre><code class="language-rust">    #[test]
    fn walrus_assignment() {
        let TestCase { db, file } = test_case(&quot;x := x + 1&quot;);
        let scope = global_scope(&amp;db, file);
        let global_table = symbol_table(&amp;db, scope);

        assert_eq!(names(&amp;global_table), vec![&quot;x&quot;]);

        let use_def = use_def_map(&amp;db, scope);
        let definition = use_def
            .first_public_definition(global_table.symbol_id_by_name(&quot;x&quot;).unwrap())
            .unwrap();

        assert!(matches!(
            definition.node(&amp;db),
            DefinitionKind::NamedExpression(_)
        ));
    }
</code></pre>
<p>Some relevant debug info:</p>
<pre><code class="language-bash">[crates/red_knot_python_semantic/src/semantic_index.rs:494:9] &amp;global_table = SymbolTable {
    symbols: [
        Symbol {
            name: Name(&quot;x&quot;),
            flags: SymbolFlags(
                IS_USED,
            ),
        },
    ],
    symbols_by_name: {
        ScopedSymbolId(
            0,
        ): (),
    },
}
[crates/red_knot_python_semantic/src/semantic_index.rs:499:9] &amp;use_def = UseDefMap {
    all_definitions: [],
    all_constraints: [],
    definitions_by_use: [
        SymbolState {
            visible_definitions: Inline(
                [
                    0,
                    0,
                    0,
                ],
            ),
            constraints: [],
            may_be_unbound: true,
        },
        SymbolState {
            visible_definitions: Inline(
                [
                    0,
                    0,
                    0,
                ],
            ),
            constraints: [],
            may_be_unbound: true,
        },
    ],
    public_definitions: [
        SymbolState {
            visible_definitions: Inline(
                [
                    0,
                    0,
                    0,
                ],
            ),
            constraints: [],
            may_be_unbound: true,
        },
    ],
}
[crates/red_knot_python_semantic/src/semantic_index.rs:500:9] &amp;global_table.symbol_id_by_name(&quot;x&quot;).unwrap() = ScopedSymbolId(
    0,
)
thread 'semantic_index::tests::walrus_assignment' panicked at crates/red_knot_python_semantic/src/semantic_index.rs:503:14:
called `Option::unwrap()` on a `None` value
</code></pre>
<p>Will try to look into this a little later. (Not sure if it merits a follow-up PR or if it belongs in this one).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_workspace/resources/test/corpus/04_assign_named_expr.py</code>:1 on 2024-08-22 14:51</div>
            <div class="timeline-body"><p>Yeah when I added the corpus I actually already added some missing tests for newer Python syntax, so even before this PR it's already been augmented in ruff.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-08-22 14:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-08-22 14:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:663 on 2024-08-22 14:58</div>
            <div class="timeline-body"><p>The issue here is that <code>x := x + 1</code> is actually a syntax error, while wrapping it in parens makes it syntactically valid. But our parser is error-recovering, and currently red-knot doesn't issue any diagnostics for invalid syntax, so what ends up happening here is that you just silently don't get any definition of x, because there isn't even an <code>ExprNamed</code> in the AST.</p>
<p>This isn't the first time invalid-syntax has caused such confusing symptoms; I think diagnostics on invalid syntax should be a priority for us. I created #13058 to track this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-08-22 14:59</div>
            <div class="timeline-body"><p>Looks good to me!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @carljm on 2024-08-22 14:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2024-08-22 14:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-08-22 15:13</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 21:39:02 UTC
    </footer>
</body>
</html>
