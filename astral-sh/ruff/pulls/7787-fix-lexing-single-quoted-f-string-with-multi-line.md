```yaml
number: 7787
title: Fix lexing single-quoted f-string with multi-line format spec
type: pull_request
state: merged
author: dhruvmanila
labels:
  - bug
assignees: []
merged: true
base: main
head: dhruv/multiline-fstring-with-format-spec
created_at: 2023-10-03T17:12:47Z
updated_at: 2023-10-05T17:42:10Z
url: https://github.com/astral-sh/ruff/pull/7787
synced_at: 2026-01-12T15:55:24Z
```

# Fix lexing single-quoted f-string with multi-line format spec

---

_@dhruvmanila_

## Summary

Reported at https://github.com/python/cpython/issues/110259

## Test Plan

Add test cases for the fix and update the snapshots


---

_Comment by @dhruvmanila on 2023-10-03 17:12_

Current dependencies on/for this PR:
* main
  * **PR #7787** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7787" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7787?utm_source=stack-comment).

---

_Label `bug` added by @dhruvmanila on 2023-10-03 17:13_

---

_Comment by @codspeed-hq[bot] on 2023-10-03 17:26_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/dhruv/multiline-fstring-with-format-spec)

### Merging #7787 will **improve performances by 2.5%**

<sub>Comparing <code>dhruv/multiline-fstring-with-format-spec</code> (9e6ae10) with <code>main</code> (17fba99)</sub>



### Summary

`âš¡ 1` improvements
`âœ… 24` untouched benchmarks




### Benchmarks breakdown

|     | Benchmark | `main` | `dhruv/multiline-fstring-with-format-spec` | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| âš¡ | `linter/default-rules[pydantic/types.py]` | 38.9 ms | 38 ms | +2.5% |


---

_Comment by @github-actions[bot] on 2023-10-03 17:29_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.



---

_Marked ready for review by @dhruvmanila on 2023-10-04 10:44_

---

_Review requested from @konstin by @dhruvmanila on 2023-10-04 10:45_

---

_Review requested from @charliermarsh by @dhruvmanila on 2023-10-05 13:46_

---

_Comment by @dhruvmanila on 2023-10-05 13:46_

The CPython PR has been merged: https://github.com/python/cpython/pull/110271

---

_Comment by @pablogsal on 2023-10-05 13:47_

Friendly reminder to review the discussion in https://github.com/python/cpython/issues/110259 so you end implementing the same as CPython ðŸ˜‰ 

---

_Comment by @dhruvmanila on 2023-10-05 13:54_

> Friendly reminder to review the discussion in [python/cpython#110259](https://github.com/python/cpython/issues/110259) so you end implementing the same as CPython ðŸ˜‰

I did, thanks for the heads up! :)

---

_@charliermarsh reviewed on 2023-10-05 14:56_

---

_Review comment by @charliermarsh on `crates/ruff_python_parser/src/lexer.rs`:2079 on 2023-10-05 14:56_

How should this one be interpreted? What is the intended "meaning"? Does this have a format spec, or no?

---

_@dhruvmanila reviewed on 2023-10-05 15:32_

---

_Review comment by @dhruvmanila on `crates/ruff_python_parser/src/lexer.rs`:2079 on 2023-10-05 15:32_

It does have the format spec and it contains newlines. The interpretation of the actual value is left to the runtime but the parser should preserve the newlines. The reason this is the case for triple-quoted f-strings is to maintain backwards compatibility as the following code works on 3.11 and earlier as well:

```
In [3]: f"""{datetime.datetime.now():%Y
   ...:     %m
   ...:     %d}"""
Out[3]: '2023\n    10\n    05'
```

---

_Review comment by @charliermarsh on `crates/ruff_python_parser/src/snapshots/ruff_python_parser__lexer__tests__fstring_with_multiline_format_spec.snap`:95 on 2023-10-05 15:36_

Does the parser handle treating this as a format spec?

---

_@charliermarsh reviewed on 2023-10-05 15:36_

---

_@charliermarsh approved on 2023-10-05 15:37_

---

_Review comment by @dhruvmanila on `crates/ruff_python_parser/src/snapshots/ruff_python_parser__lexer__tests__fstring_with_multiline_format_spec.snap`:95 on 2023-10-05 15:40_

Yes, I'll add a test case for it.

---

_@dhruvmanila reviewed on 2023-10-05 15:40_

---

_Comment by @dhruvmanila on 2023-10-05 15:57_

Actually, there's more to it for single-quoted f-string that I missed (sorry!). The newline should basically _end_ the lexing of format spec which we currently don't.

---

_Comment by @pablogsal on 2023-10-05 16:06_

> Actually, there's more to it for single-quoted f-string that I missed (sorry!). The newline should basically _end_ the lexing of format spec which we currently don't.

That's why I suggested to double check :)

---

_Comment by @dhruvmanila on 2023-10-05 16:30_

> That's why I suggested to double check :)

Hehe, I must've missed that part ðŸ˜… 

---

I'm going to try a couple solutions and look at the benchmarks, please bear with me :)

---

_@dhruvmanila reviewed on 2023-10-05 16:49_

---

_Review comment by @dhruvmanila on `crates/ruff_python_parser/src/lexer.rs`:1208 on 2023-10-05 16:49_

We need to end the lexing of format spec at every non logical newline because we're still inside the curly braces. This might be error prone if in the future there's other place where we might need to emit a `NonLogicalNewline` but I think it's not that likely.

Another solution is to have a new `State::AfterNonLogicalNewline` which then will be checked before we lex for `FStringMiddle`/`FStringEnd` token:

```rust
pub fn next_token(&mut self) -> LexResult {
    if let Some(fstring) = self.fstrings.current() {
		if self.state.is_after_non_logical_newline() && fstring.is_in_format_spec(self.nesting) {
			fstring.try_end_format_spec(self.nesting);
		} else if !fstring.is_in_expression(self.nesting) {
			// ...
		}
	}
	// ...
```

---

_@dhruvmanila reviewed on 2023-10-05 17:07_

---

_Review comment by @dhruvmanila on `crates/ruff_python_parser/src/lexer.rs`:1208 on 2023-10-05 17:07_

This involves other changes as well so I'm leaning towards solution 1.

---

_@dhruvmanila reviewed on 2023-10-05 17:17_

---

_Review comment by @dhruvmanila on `crates/ruff_python_parser/src/snapshots/ruff_python_parser__lexer__tests__fstring_with_multiline_format_spec.snap`:220 on 2023-10-05 17:17_

It's important that `b` is a `Name` token as we ended the format spec lexing at the newline. This will help the parser to raise a syntax error (unexpected token 'b') similar to the CPython implementation.

```python
f'__{
	x:a
		b
}__'
```

---

_Renamed from "Allow multi-line f-string with format spec" to "Fix lexing single-quoted f-string with multi-line format spec" by @dhruvmanila on 2023-10-05 17:18_

---

_Review requested from @charliermarsh by @dhruvmanila on 2023-10-05 17:27_

---

_Comment by @dhruvmanila on 2023-10-05 17:29_

Update after the first review is that the following case will now raise a syntax error as it should:

```python
f'__{
	x:a
		b
}__'
```

The reason it didn't earlier is because we didn't end the format spec lexing after we reached the newline (after `a`). Now, we do which means the lexer will emit a `Name` token for `b` for which the parser will raise an unexpected token error.

---

_@charliermarsh approved on 2023-10-05 17:40_

---

_Merged by @dhruvmanila on 2023-10-05 17:42_

---

_Closed by @dhruvmanila on 2023-10-05 17:42_

---

_Branch deleted on 2023-10-05 17:42_

---
