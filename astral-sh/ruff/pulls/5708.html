<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pass parent to `NeedsParentheses` - astral-sh/ruff #5708</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Pass parent to <code>NeedsParentheses</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5708">#5708</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-07-12 13:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-12 13:08</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR refactors <code>NeedsParentheses</code> so that implementations get access to the <code>parent</code> node. Having access to the parent node is e.g. required for omitting parentheses from the walrus operator when not strictly necessary.</p>
<p>The main challenge that I ran into is that simply storing the parent node in <code>Parenthesize::Optional</code> isn't possible because <code>Parenthesize</code> then requires lifetimes, and <code>AsFormat</code> (with <code>FormatRuleWithOptions</code>) does not support lifetimes... ugh</p>
<p>This forced me to rethink the problem and I'm not entirely unhappy with the outcome (There's room for improvement on the naming).</p>
<ul>
<li><code>FormatExpr</code>: Accepts a <code>Parentheses</code> option that can either be <code>Always</code>, <code>Never</code>, <code>Preserve</code>, where <code>Preserve</code> is the default. This covers the base case of expression formatting</li>
<li><code>maybe_parenthesize_expression</code> is a new builder that <em>may</em> parenthesize an expression depending on <code>Parenthesized</code> and the expressions <code>NeedsParentheses</code> implementation.</li>
</ul>
<p>I went along and removed <code>Parentheses::Custom</code> as part of this PR. This caused me some headaches with string formatting until I realized that we currently make an exception for string formatting which we do not for other nodes. The old implementation forced strings to be flat when used in an Expression statement to match Black, but we don't enforce the same for binary expressions and other expressions nodes. My take is that we should solve this holistically rather than for some nodes only.</p>
<h2>Test Plan</h2>
<p>Most of this is pure refactor. I reviewed the snapshot tests and they seem reasonable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-12 13:08</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #5711</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5711" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #5708</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5708" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5708?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/snapshots/black_compatibility@simple_cases__comments4.py.snap</code>:125 on 2023-07-12 13:14</div>
            <div class="timeline-body"><p>Requires call chain formatting</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/snapshots/black_compatibility@simple_cases__expression.py.snap</code>:769 on 2023-07-12 13:15</div>
            <div class="timeline-body"><p>Requires proper generator formatting</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/snapshots/format@expression__string.py.snap</code>:206 on 2023-07-12 13:16</div>
            <div class="timeline-body"><p>This per se is a regression because black keeps the string flat inside of <code>ExprStmt</code>. However, this is the same as that black does not try to wrap binary expressions on statement level (except if they contain a list). I decided to remove the <em>work around</em> for strings so that we have the same behavior for all expressions and either solve it holistically or not at all.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_name.rs</code>:33 on 2023-07-12 13:16</div>
            <div class="timeline-body"><p>Names never require optional parentheses... There's nothing to split by</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-07-12 13:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_call.rs</code>:114 on 2023-07-12 13:17</div>
            <div class="timeline-body"><p>Never is incorrect. It requires parentheses if the func node requires parentheses (see attribute chain)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-07-12 13:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @MichaReiser on 2023-07-12 13:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2023-07-12 13:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-07-12 13:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_constant.rs</code>:62 on 2023-07-12 13:58</div>
            <div class="timeline-body"><p>This is somewhat slow. We should consider extracting the ranges of all multiline strings (similar to Ruff)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2023-07-12 13:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-07-12 14:12</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01      8.0Â±0.02ms     5.1 MB/sec    1.00      7.9Â±0.02ms     5.2 MB/sec
formatter/numpy/ctypeslib.py               1.02   1871.4Â±2.93Âµs     8.9 MB/sec    1.00   1832.7Â±2.17Âµs     9.1 MB/sec
formatter/numpy/globals.py                 1.00    204.5Â±0.38Âµs    14.4 MB/sec    1.00    204.8Â±0.52Âµs    14.4 MB/sec
formatter/pydantic/types.py                1.01      4.0Â±0.01ms     6.3 MB/sec    1.00      4.0Â±0.01ms     6.4 MB/sec
linter/all-rules/large/dataset.py          1.00     13.3Â±0.02ms     3.0 MB/sec    1.01     13.4Â±0.03ms     3.0 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.4Â±0.01ms     4.9 MB/sec    1.00      3.4Â±0.02ms     4.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    431.2Â±0.58Âµs     6.8 MB/sec    1.00    431.3Â±0.46Âµs     6.8 MB/sec
linter/all-rules/pydantic/types.py         1.05      6.3Â±0.08ms     4.1 MB/sec    1.00      6.0Â±0.02ms     4.3 MB/sec
linter/default-rules/large/dataset.py      1.00      6.7Â±0.01ms     6.1 MB/sec    1.01      6.8Â±0.02ms     6.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1487.4Â±1.40Âµs    11.2 MB/sec    1.00   1482.8Â±1.61Âµs    11.2 MB/sec
linter/default-rules/numpy/globals.py      1.00    169.2Â±0.86Âµs    17.4 MB/sec    1.00    168.9Â±0.22Âµs    17.5 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.1Â±0.01ms     8.3 MB/sec    1.00      3.1Â±0.01ms     8.4 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01     12.4Â±0.59ms     3.3 MB/sec    1.00     12.2Â±0.49ms     3.3 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.7Â±0.13ms     6.1 MB/sec    1.01      2.8Â±0.15ms     6.0 MB/sec
formatter/numpy/globals.py                 1.00   305.5Â±18.11Âµs     9.7 MB/sec    1.04   317.8Â±22.72Âµs     9.3 MB/sec
formatter/pydantic/types.py                1.00      6.0Â±0.27ms     4.3 MB/sec    1.01      6.0Â±0.32ms     4.2 MB/sec
linter/all-rules/large/dataset.py          1.02     20.9Â±0.92ms  1993.5 KB/sec    1.00     20.6Â±0.70ms  2024.7 KB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      5.3Â±0.22ms     3.2 MB/sec    1.04      5.5Â±0.52ms     3.0 MB/sec
linter/all-rules/numpy/globals.py          1.00   643.5Â±39.84Âµs     4.6 MB/sec    1.00   644.1Â±26.30Âµs     4.6 MB/sec
linter/all-rules/pydantic/types.py         1.01      9.2Â±0.33ms     2.8 MB/sec    1.00      9.0Â±0.39ms     2.8 MB/sec
linter/default-rules/large/dataset.py      1.03     10.7Â±0.42ms     3.8 MB/sec    1.00     10.3Â±0.54ms     3.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.02      2.2Â±0.10ms     7.5 MB/sec    1.00      2.2Â±0.09ms     7.7 MB/sec
linter/default-rules/numpy/globals.py      1.00   268.5Â±16.21Âµs    11.0 MB/sec    1.01   272.3Â±13.31Âµs    10.8 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.7Â±0.15ms     5.5 MB/sec    1.01      4.7Â±0.24ms     5.5 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/expr_call.rs</code>:114 on 2023-07-12 14:29</div>
            <div class="timeline-body"><p>yep i should have placed a todo comment about missing fluent style support there</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/tests/snapshots/black_compatibility@simple_cases__comments4.py.snap</code>:125 on 2023-07-12 14:31</div>
            <div class="timeline-body"><p>yep i had opened https://github.com/astral-sh/ruff/issues/5343 to track this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/tests/snapshots/format@expression__string.py.snap</code>:206 on 2023-07-12 14:33</div>
            <div class="timeline-body"><p>implicit string concatenation (vs. triple quoted strings) at statement level seems like an odd choice, do you by chance have any usage examples?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/expr_named_expr.rs</code>:39 on 2023-07-12 14:35</div>
            <div class="timeline-body"><p>it's actually a TODO on my end</p>
<pre><code class="language-suggestion">        // mandatory. TODO(konstin): Implement [PEP 572](https://peps.python.org/pep-0572/) rules.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-07-12 14:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-07-13 06:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/snapshots/format@expression__string.py.snap</code>:206 on 2023-07-13 06:57</div>
            <div class="timeline-body"><p>I didn't find any in the whole django project... (as expected?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-07-13 06:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-07-13 06:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-07-13 06:57</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 03:31:00 UTC
    </footer>
</body>
</html>
