```yaml
number: 4124
title: "Truncate `SyntaxError`s before newline character"
type: pull_request
state: merged
author: MichaReiser
labels: []
assignees: []
merged: true
base: main
head: fix-multiline-syntax-errors
created_at: 2023-04-26T21:46:56Z
updated_at: 2023-05-10T06:37:58Z
url: https://github.com/astral-sh/ruff/pull/4124
synced_at: 2026-01-12T03:56:38Z
```

# Truncate `SyntaxError`s before newline character

---

_Pull request opened by @MichaReiser on 2023-04-26 21:46_

Fixes #3520

**Before**

```
error: Failed to parse  C:\Users\Micha\Downloads\fix_except0.py:39:14: invalid syntax. Got unexpected token """
    try_stmt< 'try' ':' (simple_stmt | suite)
                  cleanup=(except_clause ':' (simple_stmt | suite))+
                  tail=(['except' ':' (simple_stmt | suite)]
                        ['else' ':' (simple_stmt | suite)]
                        ['finally' ':' (simple_stmt | suite)]) >
    """
C:\Users\Micha\Downloads\fix_except0.py:39:14: E999 SyntaxError: invalid syntax. Got unexpected token """
    try_stmt< 'try' ':' (simple_stmt | suite)
                  cleanup=(except_clause ':' (simple_stmt | suite))+
                  tail=(['except' ':' (simple_stmt | suite)]
                        ['else' ':' (simple_stmt | suite)]
                        ['finally' ':' (simple_stmt | suite)]) >
    """
   |
39 |     BM_compatible = True
40 |
41 |     PATTERN  """
   |              ^ E999
42 |     try_stmt< 'try' ':' (simple_stmt | suite)
43 |                   cleanup=(except_clause ':' (simple_stmt | suite))+
   |

Found 1 error.
```

**After**

```
error: Failed to parse C:\Users\Micha\Downloads\fix_except0.py:39:14: unexpected token """âŽ...
C:\Users\Micha\Downloads\fix_except0.py:39:14: E999 SyntaxError: unexpected token """âŽ...
   |
39 |     BM_compatible = True
40 |
41 |     PATTERN  """
   |              ^ E999
42 |     try_stmt< 'try' ':' (simple_stmt | suite)
43 |                   cleanup=(except_clause ':' (simple_stmt | suite))+
   |

Found 1 error.

```

I decided to implement this in Ruff rather than RustPython becuse this behaviour must only apply in a context where each error should only span a single line. 

Ideally, the parser emit the full range for the token so that we can proberly highlight it in the diagnostic and use the Token text as it appears in the source document (RustPython assumes `"` even if the source text uses `'`). 

## Alternatives

An alternative would be to escape newlines. I decided not to escape newlines because it can lead to extremelly long lines in the output. 

---

_Comment by @MichaReiser on 2023-04-26 21:47_

Current dependencies on/for this PR:
* main
  * **PR #4124** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4124" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/charliermarsh/ruff/4124?utm_source=stack-comment).

---

_@MichaReiser reviewed on 2023-04-26 21:50_

---

_Review comment by @MichaReiser on `crates/ruff/src/logging.rs`:173 on 2023-04-26 21:50_

I copied this from `RustPython` but wrapped all `tok` variables.

---

_Comment by @github-actions[bot] on 2023-04-26 21:57_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Review requested from @charliermarsh by @MichaReiser on 2023-05-09 06:08_

---

_@charliermarsh approved on 2023-05-09 15:47_

Sorry, I looked at this before, but I felt like I was missing the context and got side-tracked. Does this not have the potential to confuse by way of emitting partial error messages? Why truncate at the first newline?

---

_Comment by @MichaReiser on 2023-05-09 16:19_

> Sorry, I looked at this before, but I felt like I was missing the context and got side-tracked. Does this not have the potential to confuse by way of emitting partial error messages? Why truncate at the first newline?

It only truncates the token text, not the message itself. I guess, it could be confusing if the unexpected token was a newline, but I think that would already have been confusing today, because Ruff doesn't use special formatting for whitespace.

---

_Comment by @charliermarsh on 2023-05-09 16:36_

Sounds reasonable -- go for it.

---

_Merged by @MichaReiser on 2023-05-10 06:37_

---

_Closed by @MichaReiser on 2023-05-10 06:37_

---

_Branch deleted on 2023-05-10 06:37_

---
