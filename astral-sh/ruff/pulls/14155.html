<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Add a new `Type::KnownInstanceType` variant - astral-sh/ruff #14155</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Add a new <code>Type::KnownInstanceType</code> variant</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14155">#14155</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-11-07 14:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-07 14:42</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes #14114. I don't think I can really describe the problems with our current architecture (and therefore the motivations for this PR) any better than @carljm did in that issue, so I'll just copy it out here!</p>
<hr />
<p>We currently represent &quot;known instances&quot; (e.g. special forms like <code>typing.Literal</code>, which are an instance of <code>typing._SpecialForm</code>, but need to be handled differently from other instances of <code>typing._SpecialForm</code>) as an <code>InstanceType</code> with a <code>known</code> field that is <code>Some(...)</code>.</p>
<p>This makes it easy to handle a known instance as if it were a regular instance type (by ignoring the <code>known</code> field), and in some cases (e.g. <code>Type::member</code>) that is correct and convenient. But in other cases (e.g. <code>Type::is_equivalent_to</code>) it is not correct, and we currently have a bug that we would consider the known-instance type of <code>typing.Literal</code> as equivalent to the general instance type for <code>typing._SpecialForm</code>, and we would fail to consider it a singleton type or a single-valued type (even though it is both.)</p>
<p>An instance type with <code>known.is_some()</code> is semantically quite different from an instance type with <code>known.is_none()</code>. The former is a singleton type that represents exactly one runtime object; the latter is an open type that represents many runtime objects, including instances of unknown subclasses. It is too error-prone to represent these very-different types as a single <code>Type</code> variant. We should instead introduce a dedicated <code>Type::KnownInstance</code> variant and force ourselves to handle these explicitly in all <code>Type</code> variant matches.</p>
<h2>Possible followups</h2>
<p>There is still a little bit of awkwardness in our current design in some places, in that we first infer the symbol <code>typing.Literal</code> as a <code>_SpecialForm</code> instance, and then later convert that instance-type into a known-instance-type. We could also use this <code>KnownInstanceType</code> enum to account for other special runtime symbols such as <code>builtins.Ellipsis</code> or <code>builtins.NotImplemented</code>.</p>
<p>I think these might be worth pursuing, but I didn't do them here as they didn't seem essential right now, and I wanted to keep the diff relatively minimal.</p>
<h2>Test Plan</h2>
<p><code>cargo test -p red_knot_python_semantic</code>. New unit tests added for <code>Type::is_subtype_of</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2024-11-07 14:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2024-11-07 14:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2024-11-07 14:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2024-11-07 14:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Add a new Type::KnownInstanceType variant" to "[red-knot] Add a new `Type::KnownInstanceType` variant" by @AlexWaygood on 2024-11-07 14:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-07 14:56</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>‚ÑπÔ∏è ecosystem check <strong>encountered linter errors</strong>. (no lint changes; 1 project error)</p>
<details><summary><a href="https://github.com/freedomofpress/securedrop">freedomofpress/securedrop</a> (error)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre><code>Failed to pull: error: RPC failed; curl 92 HTTP/2 stream 0 was not closed cleanly: CANCEL (err 8)
error: 6437 bytes of body are still expected
fetch-pack: unexpected disconnect while reading sideband packet
fatal: early EOF
fatal: fetch-pack: invalid index-pack output
</code></pre>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:338 on 2024-11-07 19:27</div>
            <div class="timeline-body"><p>nit: I don't think these objects are particularly special &quot;at runtime&quot; -- it's in the type system where they are special! And I think it's useful if these doc comments always talk about the set of objects represented: &quot;a specific symbol&quot; doesn't do that clearly.</p>
<pre><code class="language-suggestion">    /// A single Python object that requires special treatment in the type system
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/narrow.rs</code>:358 on 2024-11-07 19:41</div>
            <div class="timeline-body"><p>We do this a lot in this PR, I wonder about a <code>Class::to_instance_type()</code> method for it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-11-07 19:42</div>
            <div class="timeline-body"><p>Looks great, thank you!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-11-07 21:57</div>
            <div class="timeline-body"><p>I think I might resolve conflicts and land this, if that's OK with you? I'm realizing that I think I want to represent a TypeVar (not as a type, but the type of the typevar's own symbol, e.g. <code>T</code> in <code>def f[T](): ...</code>) as a <code>KnownInstanceType</code> with fallback type <code>typing.TypeVar</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-11-07 21:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/narrow.rs</code>:358 on 2024-11-07 21:59</div>
            <div class="timeline-body"><p>This can be considered separately as a follow-up if it's worth it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-11-07 22:00</div>
            <div class="timeline-body"><p>Go for it! It's late here and I'm still travelling back from choir üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @carljm on 2024-11-07 22:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2024-11-07 22:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-07 22:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-08 23:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/narrow.rs</code>:358 on 2024-11-08 23:24</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/14215</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 20:51:27 UTC
    </footer>
</body>
</html>
