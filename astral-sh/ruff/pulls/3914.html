<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allow users to extend the set of included files via `include` - astral-sh/ruff #3914</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Allow users to extend the set of included files via <code>include</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/3914">#3914</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-04-08 04:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>This PR adds an <code>include</code> mechanism to Ruff&#x27;s configuration, which mirrors <code>exclude</code> (and <code>extend_exclude</code>), but is applied <em>after</em> exclusions, and allows users to include files beyond <code>*.pyi</code> and <code>*.py</code> (the default) when running Ruff.</p>
<p>For example, if users want to lint <code>.pyw</code> files in addition to <code>.pyi</code> and <code>py</code> files, they could add:</p>
<pre><code>[tool.ruff]
extend-include = [&quot;*.pyw&quot;]
</code></pre>
<p>Closes #3410.</p>
<p>Closes #3783.</p>
<p>Closes #2192 (by providing a workaround).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-04-08 04:18</div>
            <div class="timeline-body"><p>This introduces a small performance regression (from ~247ms to ~251ms on CPython).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-04-08 04:25</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>✅ ecosystem check detected no changes.</p>
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.02     15.3±0.71ms     2.7 MB/sec    1.00     15.0±0.79ms     2.7 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.04      3.9±0.21ms     4.3 MB/sec    1.00      3.7±0.21ms     4.4 MB/sec
linter/all-rules/numpy/globals.py          1.08   526.0±15.70µs     5.6 MB/sec    1.00   486.2±31.93µs     6.1 MB/sec
linter/all-rules/pydantic/types.py         1.04      6.7±0.38ms     3.8 MB/sec    1.00      6.5±0.42ms     3.9 MB/sec
linter/default-rules/large/dataset.py      1.01      8.0±0.36ms     5.1 MB/sec    1.00      7.9±0.38ms     5.2 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.03  1871.4±78.63µs     8.9 MB/sec    1.00  1812.1±80.79µs     9.2 MB/sec
linter/default-rules/numpy/globals.py      1.00   194.7±12.37µs    15.2 MB/sec    1.04   201.6±10.75µs    14.6 MB/sec
linter/default-rules/pydantic/types.py     1.06      3.8±0.18ms     6.7 MB/sec    1.00      3.6±0.23ms     7.1 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     16.3±0.36ms     2.5 MB/sec    1.00     16.2±0.16ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.1±0.05ms     4.0 MB/sec    1.01      4.2±0.05ms     4.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    491.3±6.23µs     6.0 MB/sec    1.02    498.7±8.13µs     5.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.9±0.15ms     3.7 MB/sec    1.00      6.9±0.10ms     3.7 MB/sec
linter/default-rules/large/dataset.py      1.00      8.1±0.07ms     5.0 MB/sec    1.03      8.4±0.11ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1777.4±30.43µs     9.4 MB/sec    1.04  1846.4±30.48µs     9.0 MB/sec
linter/default-rules/numpy/globals.py      1.00    192.7±4.41µs    15.3 MB/sec    1.02    197.5±5.24µs    14.9 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.7±0.05ms     6.8 MB/sec    1.02      3.8±0.08ms     6.7 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-04-08 15:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-04-08 15:15</div>
            <div class="timeline-body"><p>I think we can improve performance by tracking whether <em>any</em> settings have custom inclusions or exclusions, and avoiding the settings resolution altogether if not. But, that would be better as a separate PR anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/resolver.rs</code>:331 on 2023-04-11 06:21</div>
            <div class="timeline-body"><p>Nit: I wonder if it would improve performance if we merge <code>extend_include</code> and <code>include</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-04-11 06:24</div>
            <div class="timeline-body"><p>I think this is a good change to unlock users, even though I would have preferred a new settings schema first, but this is taking too long.</p>
<blockquote>
<p>This PR adds an include mechanism to Ruff&#x27;s configuration, which mirrors exclude (and extend_exclude), but is applied after exclusions, and allows users to include files beyond *.pyi and *.py (the default) when running Ruff.</p>
</blockquote>
<p>I would have expected the opposite: <code>include</code>s define the initial file set and <code>exclude</code> filter the files. What&#x27;s your motivation for choosing this precedence?</p>
<p>Do you know how flake8 supports these use cases? I wasn&#x27;t able to find an <code>include</code> option.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-04-11 06:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-04-12 03:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/resolver.rs</code>:331 on 2023-04-12 03:30</div>
            <div class="timeline-body"><p>It&#x27;s nice to have the separate debug &quot;reason&quot; but I agree, in theory at least it would be faster. In practice (and in my benchmarks), <code>extend_include</code> is almost always empty.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-04-12 03:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/resolver.rs</code>:327 on 2023-04-12 03:30</div>
            <div class="timeline-body"><p>I think the real performance penalty is having to resolve settings for every file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-04-12 03:32</div>
            <div class="timeline-body"><blockquote>
<p>I would have expected the opposite: includes define the initial file set and exclude filter the files. What&#x27;s your motivation for choosing this precedence?</p>
</blockquote>
<blockquote>
<p>Do you know how flake8 supports these use cases? I wasn&#x27;t able to find an include option.</p>
</blockquote>
<p>Good question -- the precedence here is from Black, here&#x27;s the documentation:</p>
<pre><code>  --include TEXT                  A regular expression that matches files and
                                  directories that should be included on
                                  recursive searches. An empty value means all
                                  files are included regardless of the name.
                                  Use forward slashes for directories on all
                                  platforms (Windows, too). Exclusions are
                                  calculated first, inclusions later.
                                  [default: \.pyi?$]
  --exclude TEXT                  A regular expression that matches files and
                                  directories that should be excluded on
                                  recursive searches. An empty value means no
                                  paths are excluded. Use forward slashes for
                                  directories on all platforms (Windows, too).
                                  Exclusions are calculated first, inclusions
                                  later. [default: /(\.direnv|\.eggs|\.git|\.h
                                  g|\.mypy_cache|\.nox|\.tox|\.venv|venv|\.svn
                                  |\.ipynb_checkpoints|_build|buck-
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-04-12 03:33</div>
            <div class="timeline-body"><p>(Related to the above docs: I don&#x27;t really know what it would mean to apply an inclusion to a <em>directory</em> in this context, since we traverse over all directories by default and exclusions are applied first (so you can never include a subdirectory within an excluded parent). So I&#x27;m only testing inclusions against <em>files</em>.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-04-12 03:38</div>
            <div class="timeline-body"><p>Relevant stuff from Black:</p>
<p>https://github.com/psf/black/pull/281
<a href="https://github.com/psf/black/issues/270">psf/black#270</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-04-12 03:39</div>
            <div class="timeline-body"><p>AFAICT, they also only apply inclusion checks to individual files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-04-12 03:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-04-12 03:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-04-12 03:39</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:53:12 UTC
    </footer>
</body>
</html>
