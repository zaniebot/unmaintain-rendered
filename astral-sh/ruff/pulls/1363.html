<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Trailing Commas in isort - astral-sh/ruff #1363</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Magic Trailing Commas in isort</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/1363">#1363</a>
        opened by <a href="https://github.com/colin99d">@colin99d</a>
        on 2022-12-24 19:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/colin99d">@colin99d</a></div>
            <div class="timeline-body"><p>This fixes #1200 by adding magic trailing comma support. Looking forward to your feedback!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-24 19:05</div>
            <div class="timeline-body"><p>Awesome, thank you for this! Will try to review today.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-12-24 19:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>resources/test/fixtures/isort/magic_trailing_comma.py</code>:15 on 2022-12-24 19:06</div>
            <div class="timeline-body"><p>Can we add a few more examples, like:</p>
<pre><code class="language-py">from os import (
    path,
    environ,
    execl,
    execv,  # Ends with a comment, should still treat as magic trailing comma.
)
</code></pre>
<pre><code class="language-py"># These will be combined, but without a trailing comma.
from foo import bar
from foo import baz
</code></pre>
<pre><code class="language-py"># These will be combined, _with_ a trailing comma, I think? Follow `isort` here.
from foo import bar
from foo import (
  baz,
  bop,
)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andersk">@andersk</a> on 2022-12-24 19:49</div>
            <div class="timeline-body"><p>In isort this is configurable with the <code>split_on_trailing_comma</code> option. We should do the same.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-24 20:05</div>
            <div class="timeline-body"><p>Agreed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/colin99d">@colin99d</a> on <code>resources/test/fixtures/isort/magic_trailing_comma.py</code>:15 on 2022-12-24 20:23</div>
            <div class="timeline-body"><img width="772" alt="Screenshot 2022-12-24 at 3 21 01 PM" src="https://user-images.githubusercontent.com/72827203/209450095-f4726f8e-be9e-48f4-aa44-360b09c65d81.png">
It looks like the way you suggested is how isort does it. This is the one test my PR is currently failing on, will work on fixing it.

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/colin99d">@colin99d</a> reviewed on 2022-12-24 20:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Jackenmen">@Jackenmen</a> on 2022-12-24 20:26</div>
            <div class="timeline-body"><p>I haven't tested but... Awesome!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-12-24 21:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>resources/test/fixtures/isort/magic_trailing_comma.py</code>:15 on 2022-12-24 21:17</div>
            <div class="timeline-body"><p>I read the isort PR at some point, and I think the logic is that if either import block has a trailing comma, they preserve that when merging the two blocks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @colin99d on 2022-12-24 22:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/colin99d">@colin99d</a> on <code>src/isort/mod.rs</code>:478 on 2022-12-25 02:18</div>
            <div class="timeline-body"><p>This will fail if there is a duplicate word before the desired word, I need to fix this before I am ready for a review.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/colin99d">@colin99d</a> reviewed on 2022-12-25 02:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/colin99d">@colin99d</a> on <code>src/isort/mod.rs</code>:478 on 2022-12-26 01:40</div>
            <div class="timeline-body"><p>This is resolved now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/colin99d">@colin99d</a> reviewed on 2022-12-26 01:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/isort/mod.rs</code>:478 on 2022-12-26 01:42</div>
            <div class="timeline-body"><p>Sweet</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-12-26 01:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @colin99d on 2022-12-26 03:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/colin99d">@colin99d</a> reviewed on 2022-12-26 03:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/colin99d">@colin99d</a> on <code>resources/test/fixtures/isort/magic_trailing_comma.py</code>:15 on 2022-12-26 03:08</div>
            <div class="timeline-body"><p>Perfect! Got this implemented.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-12-26 14:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/isort/helpers.rs</code>:33 on 2022-12-26 14:38</div>
            <div class="timeline-body"><p>@colin99d - I went with a slightly different approach here. The previous version relied on passing around the entire source code and iterating over characters, which ran two risks: (1) it's kind of inefficient to grab the entire source code; and (2) the logic (while working!) required handling a variety of cases, since we were matching on raw strings.</p>
<p>This version tokenizes the code, so that we can just look for the <code>Tok::Comma</code> as the &quot;last&quot; token in the import (excluding some unimportant tokens, like newlines).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/colin99d">@colin99d</a> on 2022-12-26 14:38</div>
            <div class="timeline-body"><p>@charliermarsh it looks like this has some weird behavior when importing with as, even if the feature is disabled. I am not sure why. But I will dig in.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-12-26 14:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>README.md</code>:2540 on 2022-12-26 14:39</div>
            <div class="timeline-body"><p>I also made this the default, to match isort's <code>profile = &quot;black&quot;</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2022-12-26 14:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/isort/mod.rs</code>:151 on 2022-12-26 14:39</div>
            <div class="timeline-body"><p>I also tweaked the order of operations: instead of collecting locations, and looking at the locations at the end, we detect a trailing comma for each block, and then propagate it through the code as we merge imports.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/colin99d">@colin99d</a> reviewed on 2022-12-26 14:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/colin99d">@colin99d</a> on <code>src/isort/helpers.rs</code>:33 on 2022-12-26 14:39</div>
            <div class="timeline-body"><p>This is much better! I was assuming there were better ways to do things that would come out in the review.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2022-12-26 14:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2022-12-26 14:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-26 14:40</div>
            <div class="timeline-body"><p>Thank you! Appreciate all the effort and output here :)</p>
<p>I made a few changes (which I think fixed the <code>as</code> handling), but let me know if you have any questions or disagree with any of the choices I made.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/colin99d">@colin99d</a> on 2022-12-26 14:41</div>
            <div class="timeline-body"><p>I love all of them, thanks for the help!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2022-12-26 14:42</div>
            <div class="timeline-body"><p>@colin99d - Thank <em>you</em>! Grateful for the contribution!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2022-12-28 02:56</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:55:14 UTC
    </footer>
</body>
</html>
