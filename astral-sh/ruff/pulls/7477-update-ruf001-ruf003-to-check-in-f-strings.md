```yaml
number: 7477
title: "Update `RUF001`, `RUF003` to check in f-strings"
type: pull_request
state: merged
author: dhruvmanila
labels:
  - rule
  - python312
assignees: []
merged: true
base: dhruv/pep-701
head: dhruv/issue-7294
created_at: 2023-09-18T07:30:12Z
updated_at: 2023-09-28T03:58:55Z
url: https://github.com/astral-sh/ruff/pull/7477
synced_at: 2026-01-12T02:39:10Z
```

# Update `RUF001`, `RUF003` to check in f-strings

---

_Pull request opened by @dhruvmanila on 2023-09-18 07:30_

## Summary

This PR updates the rule `RUF001` and `RUF003` to check in f-strings using the
`FStringMiddle` token which contains the non-expression part of a f-string.

For reference,
| Code | Name | Message|
| --- | --- | --- |
| RUF001 | ambiguous-unicode-character-string | String contains ambiguous {}. Did you mean {}? |
| RUF003 | ambiguous-unicode-character-comment | Comment contains ambiguous {}. Did you mean {}? |

## Test Plan

`cargo test`


---

_Comment by @dhruvmanila on 2023-09-18 07:30_

Current dependencies on/for this PR:
* main
  * **PR #7376** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7376" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7690** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7690" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7667** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7667" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7597** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7597" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7588** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7588" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #7589** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7589" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7586** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7586" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7515** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7515" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7477** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7477" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #7387** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7387" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7378** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7378" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7329** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7329" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7328** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7328" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7327** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7327" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7326** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7326" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7325** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7325" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7477?utm_source=stack-comment).

---

_Label `rule` added by @dhruvmanila on 2023-09-18 07:30_

---

_Label `python312` added by @dhruvmanila on 2023-09-18 07:30_

---

_Renamed from "Update `RUF001-003` to check in f-strings" to "Update `RUF001`, `RUF003` to check in f-strings" by @dhruvmanila on 2023-09-18 07:31_

---

_@dhruvmanila reviewed on 2023-09-18 07:35_

---

_Review comment by @dhruvmanila on `crates/ruff/src/rules/ruff/snapshots/ruff__rules__ruff__tests__confusables.snap`:66 on 2023-09-18 07:35_

Should we add a new context to make this message say "F-string contains ..." instead of "String contains ..."?

---

_Review requested from @MichaReiser by @dhruvmanila on 2023-09-18 07:37_

---

_Review requested from @charliermarsh by @dhruvmanila on 2023-09-18 13:14_

---

_Review comment by @MichaReiser on `crates/ruff/src/checkers/tokens.rs`:56 on 2023-09-18 16:20_

Can fstrings be docstrings? 


---

_Review comment by @MichaReiser on `crates/ruff/src/checkers/tokens.rs`:47 on 2023-09-18 16:21_

Does this "state machine" need any updating to correctly handle fstrings? 

---

_@MichaReiser reviewed on 2023-09-18 16:21_

---

_@dhruvmanila reviewed on 2023-09-18 16:42_

---

_Review comment by @dhruvmanila on `crates/ruff/src/checkers/tokens.rs`:56 on 2023-09-18 16:42_

No. Reference: https://docs.python.org/3/reference/lexical_analysis.html#formatted-string-literals

> Formatted string literals cannot be used as docstrings, even if they do not include expressions.
> 
> ```python
> def foo():
>     f"Not a docstring"
> 
> foo.__doc__ is None
> # True
> ```

---

_@dhruvmanila reviewed on 2023-09-18 16:43_

---

_Review comment by @dhruvmanila on `crates/ruff/src/checkers/tokens.rs`:47 on 2023-09-18 16:43_

No, as f-strings cannot be used as docstrings. The state machine is mainly used for docstring detection.

---

_@MichaReiser reviewed on 2023-09-18 16:48_

---

_Review comment by @MichaReiser on `crates/ruff/src/checkers/tokens.rs`:47 on 2023-09-18 16:48_

That's correct. But does it need any updating to not get confused by the new tokens emitted by the lexer?

---

_@MichaReiser reviewed on 2023-09-18 16:51_

---

_Review comment by @MichaReiser on `crates/ruff/src/checkers/tokens.rs`:56 on 2023-09-18 16:51_

I would then rewrite it for better clarity

```rust
if tok.is_string() && is_docstring {
	Context::Docstring
} else if tok.is_comment() {
	Context::Comment
} else {
	Context::String
}
```
or even using a match

```rust
let context = match tok {
	Tok::String => if is_docstring { Context::Docstring } else { Context::String },
	Tok::FStringMiddle => Context::String,
	Tok::Comment => Context::Comment,
	_ => unreachable!()
};

```

---

_@dhruvmanila reviewed on 2023-09-18 16:54_

---

_Review comment by @dhruvmanila on `crates/ruff/src/checkers/tokens.rs`:47 on 2023-09-18 16:54_

Good point. No, it doesn't. The reason being that the detection mechanism resets the state if it finds any token other than the string token after a function / class / module.

---

_@dhruvmanila reviewed on 2023-09-18 16:54_

---

_Review comment by @dhruvmanila on `crates/ruff/src/checkers/tokens.rs`:56 on 2023-09-18 16:54_

Thanks!

---

_@MichaReiser approved on 2023-09-18 19:26_

---

_Merged by @dhruvmanila on 2023-09-19 06:29_

---

_Closed by @dhruvmanila on 2023-09-19 06:29_

---

_Branch deleted on 2023-09-19 06:29_

---
