<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Match variadic argument to variadic parameter - astral-sh/ruff #20511</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Match variadic argument to variadic parameter</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20511">#20511</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2025-09-22 09:22
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-09-22 09:22</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Closes: https://github.com/astral-sh/ty/issues/1236</p>
<p>This PR fixes a bug where the variadic argument wouldn't match against the variadic parameter in certain scenarios.</p>
<p>This was happening because I didn't realize that the <code>all_elements</code> iterator wouldn't keep on returning the variable element (which is correct, I just didn't realize it back then).</p>
<p>I don't think we can use the <code>resize</code> method here because we don't know how many parameters this variadic argument is matching against as this is where the actual parameter matching occurs.</p>
<h2>Test Plan</h2>
<p>Expand test cases to consider a few more combinations of arguments and parameters which are variadic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dhruvmanila on 2025-09-22 09:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dhruvmanila on 2025-09-22 09:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @dhruvmanila on 2025-09-22 09:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @dhruvmanila on 2025-09-22 09:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dhruvmanila on 2025-09-22 09:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @dhruvmanila on 2025-09-22 09:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-22 09:29</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-22 09:40</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">ignite (https://github.com/pytorch/ignite)
+ ignite/contrib/engines/tbptt.py:120:28: error[invalid-argument-type] Argument to bound method `register_events` is incorrect: Expected `list[str] | list[EventEnum]`, found `Tbptt_Events`
+ tests/ignite/engine/test_custom_events.py:18:28: error[invalid-argument-type] Argument to bound method `register_events` is incorrect: Expected `list[str] | list[EventEnum]`, found `CustomEvents`
+ tests/ignite/engine/test_custom_events.py:37:28: error[invalid-argument-type] Argument to bound method `register_events` is incorrect: Expected `list[str] | list[EventEnum]`, found `CustomEvents`
+ tests/ignite/engine/test_custom_events.py:103:28: error[invalid-argument-type] Argument to bound method `register_events` is incorrect: Expected `list[str] | list[EventEnum]`, found `CustomEvents`
+ tests/ignite/engine/test_custom_events.py:117:28: error[invalid-argument-type] Argument to bound method `register_events` is incorrect: Expected `list[str] | list[EventEnum]`, found `CustomEvents`
+ tests/ignite/engine/test_custom_events.py:129:32: error[invalid-argument-type] Argument to bound method `register_events` is incorrect: Expected `list[str] | list[EventEnum]`, found `CustomEvents`
+ tests/ignite/engine/test_custom_events.py:140:28: error[invalid-argument-type] Argument to bound method `register_events` is incorrect: Expected `list[str] | list[EventEnum]`, found `CustomEvents`
+ tests/ignite/engine/test_custom_events.py:606:32: error[invalid-argument-type] Argument to bound method `register_events` is incorrect: Expected `list[str] | list[EventEnum]`, found `CustomEvents`
+ tests/ignite/handlers/test_time_profilers.py:71:35: error[invalid-argument-type] Argument to bound method `register_events` is incorrect: Expected `list[str] | list[EventEnum]`, found `CustomEvents`
- Found 2153 diagnostics
+ Found 2162 diagnostics

sphinx (https://github.com/sphinx-doc/sphinx)
- sphinx/domains/python/_annotations.py:434:74: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- sphinx/domains/python/_annotations.py:498:64: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- sphinx/domains/python/_annotations.py:588:72: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 522 diagnostics
+ Found 519 diagnostics

meson (https://github.com/mesonbuild/meson)
- test cases/common/214 source set custom target/cp.py:5:10: error[invalid-argument-type] Argument to function `copyfile` is incorrect: Expected `list[str]`, found `str`
- test cases/unit/15 prebuilt object/cp.py:5:10: error[invalid-argument-type] Argument to function `copyfile` is incorrect: Expected `list[str]`, found `str`
- test cases/unit/56 introspection/cp.py:5:10: error[invalid-argument-type] Argument to function `copyfile` is incorrect: Expected `list[str]`, found `str`
- Found 883 diagnostics
+ Found 880 diagnostics

vision (https://github.com/pytorch/vision)
+ test/datasets_utils.py:1045:9: error[invalid-assignment] Object of type `str` is not assignable to `tuple[str, ...]`
- Found 1479 diagnostics
+ Found 1480 diagnostics

schemathesis (https://github.com/schemathesis/schemathesis)
+ src/schemathesis/generation/hypothesis/builder.py:230:73: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 284 diagnostics
+ Found 285 diagnostics

scikit-build-core (https://github.com/scikit-build/scikit-build-core)
- src/scikit_build_core/build/_wheelfile.py:51:22: error[no-matching-overload] No overload of function `field` matches arguments
- Found 53 diagnostics
+ Found 52 diagnostics

pandas (https://github.com/pandas-dev/pandas)
- pandas/core/generic.py:6089:16: error[no-matching-overload] No overload of function `pipe` matches arguments
- pandas/core/groupby/groupby.py:770:16: error[no-matching-overload] No overload of function `pipe` matches arguments
- pandas/core/window/rolling.py:1573:16: error[no-matching-overload] No overload of function `pipe` matches arguments
- pandas/io/formats/style.py:3961:16: error[no-matching-overload] No overload of function `pipe` matches arguments
- pandas/tests/indexes/interval/test_indexing.py:107:46: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Argument type `Unknown | list[Unknown | int] | list[Unknown | float | int]` does not satisfy constraints (`int`, `int | float`, `Timestamp`, `Timedelta`) of type variable `_OrderableT`
- pandas/tests/indexes/interval/test_indexing.py:110:42: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Argument type `Unknown | list[Unknown | int] | list[Unknown | float | int]` does not satisfy constraints (`int`, `int | float`, `Timestamp`, `Timedelta`) of type variable `_OrderableT`
- Found 3324 diagnostics
+ Found 3318 diagnostics

bokeh (https://github.com/bokeh/bokeh)
+ src/bokeh/layouts.py:117:26: error[invalid-argument-type] Argument to function `_handle_child_sizing` is incorrect: Expected `list[UIElement]`, found `list[UIElement | list[UIElement]]`
+ src/bokeh/layouts.py:118:16: error[invalid-argument-type] Argument is incorrect: Expected `list[UIElement]`, found `list[UIElement | list[UIElement]]`
+ src/bokeh/layouts.py:152:26: error[invalid-argument-type] Argument to function `_handle_child_sizing` is incorrect: Expected `list[UIElement]`, found `list[UIElement | list[UIElement]]`
+ src/bokeh/layouts.py:153:19: error[invalid-argument-type] Argument is incorrect: Expected `list[UIElement]`, found `list[UIElement | list[UIElement]]`
- Found 463 diagnostics
+ Found 467 diagnostics

ibis (https://github.com/ibis-project/ibis)
- ibis/expr/format.py:74:16: error[no-matching-overload] No overload of bound method `center` matches arguments
- Found 3287 diagnostics
+ Found 3286 diagnostics

core (https://github.com/home-assistant/core)
- homeassistant/components/sensor/recorder.py:613:27: error[invalid-assignment] Invalid assignment to key &quot;max&quot; with declared type `int | float` on TypedDict `StatisticData`: value of type `Unknown | islice[Unknown]`
- homeassistant/components/sensor/recorder.py:617:27: error[invalid-assignment] Invalid assignment to key &quot;min&quot; with declared type `int | float` on TypedDict `StatisticData`: value of type `Unknown | islice[Unknown]`
- Found 13740 diagnostics
+ Found 13738 diagnostics

</code></pre>
</details>
No memory usage changes detected ✅

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-09-22 12:59</div>
            <div class="timeline-body"><p>Nice! I think this approach still has some false negatives on &quot;mixed tuples&quot; with fixed-length suffixes. E.g. here's the current behaviour on this branch:</p>
<pre><code class="language-py">def func(*args: str): ...

def _(
    a: tuple[str, ...],
    b: tuple[str, *tuple[str, ...]],
    c: tuple[str, *tuple[str, ...], str],
    d: tuple[int, *tuple[str, ...]],
    e: tuple[int, *tuple[str, ...], str],
    f: tuple[*tuple[str, ...], str],
    g: tuple[*tuple[str, ...], int],
    h: tuple[int, *tuple[str, ...], int],
):
    func(*a)  # no error (good)
    func(*b)  # no error (good)
    func(*c)  # no error (good)
    func(*d)  # error (good)
    func(*d)  # error (good)
    func(*e)  # error (good)
    func(*f)  # no error (good)
    func(*g)  # &lt;-------------  no error (bad!)
    func(*h)  # error (good)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-09-23 04:29</div>
            <div class="timeline-body"><p>I think the core issue here is that we've a way to structure a one-to-many mapping like <code>*args</code> argument to multiple parameters via the <code>MatchedArgument</code> but we don't have a way to structure a many-to-one mapping which will occur in this scenario where a variadic argument is being unpacked into a variadic parameter. I'm thinking if it's actually required or not, and if so how to structure it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @dhruvmanila on 2025-09-23 14:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_python_semantic/src/types/call/bind.rs</code>:2505 on 2025-09-24 06:43</div>
            <div class="timeline-body"><p>The reason this isn't required now is because the unpacking of a variadic argument is being done during parameter matching itself. This was added in https://github.com/astral-sh/ruff/pull/20130 to make sure that specialization builder has access to the correct type for each parameter.</p>
<p>The <code>MatchedArgument</code> already stores the unpacked types for a variadic argument so we can directly use that here instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_python_semantic/src/types/call/bind.rs</code>:2145 on 2025-09-24 06:44</div>
            <div class="timeline-body"><p>The length isn't required here because we already have access to <code>Tuple&lt;Type&gt;</code> in this function so we can use that directly to get the <code>TupleLength</code>. This also simplifies the overload evaluation where we needed to change this length when argument type expansion lead to retrying of parameter matching.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_python_semantic/src/types/call/bind.rs</code>:2197 on 2025-09-24 06:46</div>
            <div class="timeline-body"><p>This is the core logic that would actually match the variadic argument with the variadic parameter in cases where it's missed today. Refer to mdtest examples.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-09-24 06:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-09-24 08:58</div>
            <div class="timeline-body"><h2>Ecosystem analysis</h2>
<p>All of the new diagnostics in <code>ignite</code> are, I think, correct. The annotation of the variadic parameter for <code>register_events</code> function is <code>*event_names: Union[List[str], List[EventEnum]]</code> which suggests that each element of an unpacking should be a list but the provided parameter is unpacking the enum class directly.</p>
<pre><code class="language-py">from enum import Enum

class Foo(Enum):
    foo = &quot;foo&quot;
    bar = &quot;bar&quot;

def f(*args: list[Foo]): ...

# This should raise a diagnostic because it unpacks into `Foo` variants but the
# annotated parameter type expects each element to be a `list[Foo]`
f(*Foo)
</code></pre>
<p>The diagnostic in <code>vision</code> is correct as well:</p>
<pre><code class="language-py">import itertools
import string


def _(*digits: str):
    if not digits:
        digits = string.ascii_lowercase
    else:
        # ty: Object of type `str` is not assignable to `tuple[str, ...]` [invalid-assignment]
        digits = &quot;&quot;.join(itertools.chain(*digits))
</code></pre>
<p>The diagnostic in <code>bokeh</code> seems to be related to generics which, if I remember correctly, was brought up during an early discussion regarding how to consider the entire union to map the concrete type so that it doesn't map it to <code>T</code> and instead considers <code>T | list[T]</code> (the details are a bit hazy in my mind right now).</p>
<pre><code class="language-py">def f[T](*args: T | list[T]) -&gt; list[T]:
    return []


class Foo: ...


def _(*args: Foo | list[Foo]):
	# This PR reveals this to be `list[Foo | list[Foo]]` and in `bokeh` it then creates a
    # diagnostic when it's being used where `list[Foo]` is expected.
    reveal_type(f(*args))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dhruvmanila on 2025-09-24 08:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dhruvmanila on 2025-09-24 08:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-09-24 08:59</div>
            <div class="timeline-body"><p>(This is something that I'd love to get @dcreager review on specifically as the original author for single-starred argument.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/call/function.md</code>:713 on 2025-09-24 14:28</div>
            <div class="timeline-body"><p>Could possibly consider adding some mixed-tuple cases here too (but not essential!)</p>
<pre><code class="language-suggestion">def _(args1: list[int], args2: tuple[int], args3: tuple[int, int], args4: tuple[int, ...], args5: tuple[int, *tuple[str, ...]], args6: tuple[int, int, *tuple[str, ...]]) -&gt; None:
    # error: [invalid-argument-type] &quot;Argument to function `f` is incorrect: Expected `str`, found `int`&quot;
    reveal_type(f(*args1))  # revealed: int

    # This shouldn't raise an error because the unpacking doesn't match the variadic parameter.
    reveal_type(f(*args2))  # revealed: int

    # But, this should because the second tuple element is not assignable.
    # error: [invalid-argument-type] &quot;Argument to function `f` is incorrect: Expected `str`, found `int`&quot;
    reveal_type(f(*args3))  # revealed: int

    # error: [invalid-argument-type] &quot;Argument to function `f` is incorrect: Expected `str`, found `int`&quot;
    reveal_type(f(*args4))  # revealed: int
    
    # The first element of the tuple matches the required argument;
    # all subsequent elements match the variadic argument
    reveal_type(f(*args5))  # revealed: int
    
    # error: [invalid-argument-type] &quot;Argument to function `f` is incorrect: Expected `str`, found `int`&quot;
    reveal_type(f(*args6))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-09-24 14:30</div>
            <div class="timeline-body"><p>This looks reasonable to me, thanks! I agree it would be great to get @dcreager's eyes on it, though</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @carljm on 2025-09-24 16:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/call/bind.rs</code>:2151 on 2025-09-25 00:33</div>
            <div class="timeline-body"><p>It looks like you only ever use the variable element to extend the <code>all_elements</code> iterator with a never-ending stream of <code>variable_element</code> items. You could do the same thing by chaining a <code>std::iter::repeat</code> to the end of the <code>all_elements</code> iterator. Then you wouldn't need the <code>.or(variable_element)</code> calls below. (You might also consider adding that as an additional method on <code>Tuple</code> or <code>TupleSpec</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/call/bind.rs</code>:2145 on 2025-09-25 00:38</div>
            <div class="timeline-body"><p>That's a great catch!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> approved on 2025-09-25 00:42</div>
            <div class="timeline-body"><p>This approach looks good! We still need to know the type of the splatted argument before we can perform parameter matching; otherwise we don't know how many elements are in the argument and therefore how many parameters it will be matched to. I think that's unavoidable, though. (And @ibraheemdev, I think this the main thing that might wreak havoc on your work to use bidirectional type checking with function arguments.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-09-25 07:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_python_semantic/src/types/call/bind.rs</code>:2151 on 2025-09-25 07:44</div>
            <div class="timeline-body"><p>That's a good idea although there's one place where I don't use the <code>.or(...)</code> call at the end which just loops over the remaining argument types if any. This is usually the case for suffix elements.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-09-25 07:45</div>
            <div class="timeline-body"><blockquote>
<p>This approach looks good! We still need to know the type of the splatted argument before we can perform parameter matching; otherwise we don't know how many elements are in the argument and therefore how many parameters it will be matched to. I think that's unavoidable, though.</p>
</blockquote>
<p>Yeah, I agree that this is unavoidable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-09-25 07:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_python_semantic/resources/mdtest/call/function.md</code>:713 on 2025-09-25 07:47</div>
            <div class="timeline-body"><p>Thanks, I've added them.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2025-09-25 07:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2025-09-25 07:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-09-25 07:51</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:40:54 UTC
    </footer>
</body>
</html>
