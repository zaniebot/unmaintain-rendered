<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parse triple quoted string annotations as if parenthesized - astral-sh/ruff #15387</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Parse triple quoted string annotations as if parenthesized</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15387">#15387</a>
        opened by <a href="https://github.com/Glyphack">@Glyphack</a>
        on 2025-01-09 23:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/Glyphack">@Glyphack</a> on 2025-01-09 23:37</div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<!-- What's the purpose of the change? What does it do, and why? -->

<p>Resolves #9467</p>
<p>Parse quoted annotations as if the string content is inside parenthesis.
With this logic <code>x</code> and <code>y</code> in this example are equal:</p>
<pre><code class="language-python">y: &quot;&quot;&quot;
   int |
   str
&quot;&quot;&quot;

z: &quot;&quot;&quot;(
    int |
    str
)
&quot;&quot;&quot;
</code></pre>
<p>Also this rule only applies to triple quotes(<a href="https://github.com/python/typing-council/issues/9#issuecomment-1890808610">link</a>).</p>
<p>This PR is based on the <a href="https://github.com/astral-sh/ruff/issues/9467#issuecomment-2579180991">comments</a> on the issue.</p>
<p>I did one extra change, since we don't want any indentation tokens I am setting the <code>State::Other</code> as the initial state of the Lexer.</p>
<p>Remaining work:</p>
<ul>
<li>[x] Add a test case for red-knot.</li>
<li>[x] Add more tests.</li>
</ul>
<h2>Test Plan</h2>
<p>Added a test which previously failed because quoted annotation contained indentation.
Added an mdtest for red-knot.
Updated previous test.</p>
<!-- How was it tested? -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-09 23:52</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<details><summary><a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)</summary>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to read examples/Assistants_API_overview_python.ipynb: Expected a Jupyter Notebook, which must be internally stored as JSON, but this file isn't valid JSON: expected `,` or `]` at line 197 column 8
</code></pre>
</p>
</details>

<h3>Formatter (preview)</h3>
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<details><summary><a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)</summary>
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to read examples/Assistants_API_overview_python.ipynb: Expected a Jupyter Notebook, which must be internally stored as JSON, but this file isn't valid JSON: expected `,` or `]` at line 197 column 8
</code></pre>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Glyphack">@Glyphack</a> reviewed on 2025-01-13 22:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Glyphack">@Glyphack</a> on <code>crates/ruff_python_parser/src/lib.rs</code>:195 on 2025-01-13 22:34</div>
            <div class="timeline-body"><p>I don't know if this function is necessary. I was worried someone might update the linter parsing logic for string annotations and forget red knot. With this at least it will be applied for both.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @Glyphack on 2025-01-13 22:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @Glyphack on 2025-01-13 22:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @Glyphack on 2025-01-13 22:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @Glyphack on 2025-01-13 22:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @Glyphack on 2025-01-13 22:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @Glyphack on 2025-01-13 22:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Parse Quoted annotations as if parenthesized" to "Parse triple quoted annotations as if parenthesized" by @Glyphack on 2025-01-13 22:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Parse triple quoted annotations as if parenthesized" to "Parse triple quoted string annotations as if parenthesized" by @Glyphack on 2025-01-13 22:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/annotations/string.md</code>:198 on 2025-01-13 23:48</div>
            <div class="timeline-body"><p>I assume out of these four, only <code>a4</code> failed before this PR? (Can't check right now, since GH git ops are down.)</p>
<p>Not sure what <code>a1</code> and <code>a2</code> are really testing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-01-13 23:50</div>
            <div class="timeline-body"><p>Thank you!! The red-knot test and changes look fine to me, but that's a small part of this PR. Would rather have @dhruvmanila take a look at the parser/ruff side.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/lib.rs</code>:645 on 2025-01-14 07:34</div>
            <div class="timeline-body"><p>I'd move it next to <code>Expression</code> and let's add a comment explaining what this mode is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-01-14 07:34</div>
            <div class="timeline-body"><p>Thank you. Would you mind adding a test where an expression is incorrectly parenthesized?</p>
<pre><code class="language-python">def f(
	a: &quot;&quot;&quot;
		int | 
str)
&quot;&quot;&quot;
)
</code></pre>
<p>or</p>
<pre><code class="language-python">def f(
	a: &quot;&quot;&quot;
		int) | 
str
&quot;&quot;&quot;
)
</code></pre>
<p>I'm curious how it recovers in those cases and if we need to do something more than just setting <code>nesting = 1</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by @MichaReiser on 2025-01-14 07:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Glyphack">@Glyphack</a> reviewed on 2025-01-14 09:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Glyphack">@Glyphack</a> on <code>crates/red_knot_python_semantic/resources/mdtest/annotations/string.md</code>:198 on 2025-01-14 09:03</div>
            <div class="timeline-body"><p>Yes only a4 fails. I initially added the other ones to test more cases. But I now replaced those with the better cases that Micha <a href="https://github.com/astral-sh/ruff/pull/15387#pullrequestreview-2548984289">provided</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Glyphack">@Glyphack</a> on 2025-01-14 18:45</div>
            <div class="timeline-body"><p>@MichaReiser I added the test cases you suggested and the tests pass(see this <a href="https://github.com/astral-sh/ruff/pull/15387/commits/b3cf440dfdc9500afd4826b23d97363928cb9ec4">commit</a>)
But I think that is because the parser is recovering.</p>
<p>So I fixed the nesting check to check for nesting value of 1 when mode is <code>ParenthesizedExpression</code>. This way the lexer will detect the problem that nesting is one level lower than started as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:91 on 2025-01-15 05:22</div>
            <div class="timeline-body"><p>nit:</p>
<pre><code class="language-suggestion">        let (state, nesting) = if mode == Mode::ParenthesizedExpression {
            (State::Other, 1)
        } else {
            (State::AfterNewline, 0)
        };
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/lib.rs</code>:649 on 2025-01-15 05:27</div>
            <div class="timeline-body"><p>I've suggested some improvements and I don't think we should specify the internal details about implementation within the lexer.</p>
<pre><code class="language-suggestion">    /// The code consists of a single expression and is parsed as if it is parenthesized. The parentheses themselves aren't required.
    /// This allows for having valid multiline expression without the need of parentheses
    /// and is specifically useful for parsing string annotations.
    ParenthesizedExpression,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/lib.rs</code>:195 on 2025-01-15 05:28</div>
            <div class="timeline-body"><p>What do you think about <code>parse_string_annotation</code> or <code>parse_string_annotation_content</code>? Additionally, we should provide documentation similar to what you've done in <code>parse_parenthesized_expression_range</code> as this is a public function and the crate is being used by multiple projects.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/resources/test/fixtures/pyflakes/F722.py</code>:29 on 2025-01-15 05:33</div>
            <div class="timeline-body"><p>Can we add the same test case using triple-quoted string which will be useful as a documentation?</p>
<pre><code class="language-py"># but, using the same annotation inside a triple-quoted string is valid
valid: &quot;&quot;&quot;\n int&quot;&quot;&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/resources/test/fixtures/pyflakes/F722.py</code>:38 on 2025-01-15 05:41</div>
            <div class="timeline-body"><p>Can we add some test cases for unclosed parenthesis similar to how these? It would also be useful to provide test cases with multiple parentheses.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-01-15 05:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:1328 on 2025-01-15 05:53</div>
            <div class="timeline-body"><p>Should this be <code>if self.nesting &gt; 1</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-01-15 05:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:1337 on 2025-01-15 07:34</div>
            <div class="timeline-body"><pre><code class="language-suggestion">				// For Mode::ParenthesizedExpression we start with nesting level 1.
        // So we check if we end with that level.
				let init_nesting = if self.mode == Mode::ParenthesizedExpression {
					1
				} else {
					0
				};

        if self.nesting &gt; init_nesting {
            // Reset the nesting to avoid going into infinite loop.
            self.nesting = 0;
            return self
                .push_error(LexicalError::new(LexicalErrorType::Eof, self.token_range()));
        }
            
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-01-15 07:36</div>
            <div class="timeline-body"><p>Thanks. This looks great.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Glyphack">@Glyphack</a> reviewed on 2025-01-15 19:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Glyphack">@Glyphack</a> on <code>crates/ruff_linter/resources/test/fixtures/pyflakes/F722.py</code>:29 on 2025-01-15 19:01</div>
            <div class="timeline-body"><p>Actually I made a mistake here, <code>invalid: &quot;\n int&quot;</code> is in a python file. So this string will not actually have a newline character but <code>\</code> and <code>n</code> as characters. So also <code>&quot;&quot;&quot;&quot;\n int&quot;&quot;&quot;</code> fails.
Is there a way to actually create a type annotation that contains newline inside a python file without using triple quotes?</p>
<p>https://pyright-play.net/?code=JYOwbghgNsAmBcACARKgOiRoAurkCh9RIYEVUiRcKg</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Glyphack">@Glyphack</a> reviewed on 2025-01-15 20:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Glyphack">@Glyphack</a> on <code>crates/ruff_linter/resources/test/fixtures/pyflakes/F722.py</code>:29 on 2025-01-15 20:41</div>
            <div class="timeline-body"><p>I removed this right now. Since I could not figure out how to do it correctly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Glyphack">@Glyphack</a> reviewed on 2025-01-15 20:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Glyphack">@Glyphack</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:1328 on 2025-01-15 20:41</div>
            <div class="timeline-body"><p>I applied the suggestion below and it resolves it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Glyphack">@Glyphack</a> reviewed on 2025-01-15 20:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Glyphack">@Glyphack</a> on <code>crates/ruff_python_parser/src/lib.rs</code>:195 on 2025-01-15 20:42</div>
            <div class="timeline-body"><p>I agree, renamed to <code>parse_string_annotation</code> and added documentation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @Glyphack on 2025-01-15 20:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-01-16 06:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/resources/test/fixtures/pyflakes/F722.py</code>:29 on 2025-01-16 06:03</div>
            <div class="timeline-body"><p>I see, that makes sense. I don't think it's even possible to have a newline in a single-quoted string without the <code>\n</code> character. This will also utilize <code>parse_complex_annotation</code> and not <code>parse_simple_annotation</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-01-16 06:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/pyflakes/snapshots/ruff_linter__rules__pyflakes__tests__F722_F722.py.snap</code>:23 on 2025-01-16 06:06</div>
            <div class="timeline-body"><p>Unrelated to this PR, I think it would be useful to provide the syntax error that was raised during parsing this string content.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-01-16 06:07</div>
            <div class="timeline-body"><p>Thank you for working on this!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2025-01-16 06:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2025-01-16 06:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-05-21 20:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 18:51:28 UTC
    </footer>
</body>
</html>
