<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Consider virtual files for workspace diagnostics - astral-sh/ruff #19182</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Consider virtual files for workspace diagnostics</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19182">#19182</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2025-07-07 14:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body">Summary
<p>Follow-up from #19181 and #19225, this PR adds support for virtual files to workspace diagnostics. This is part of astral-sh/ty#81.</p>
<p>The way this is implemented</p>
Test Plan
<p>This video demonstrates that in VS Code when you open a new (unsaved) file whose language is Python, the diagnostics are present in the Problems tab and are updated as I change the content. The diagnostics are cleared when the file is closed without saving it.</p>
<p>https://github.com/user-attachments/assets/7329dfcb-9b37-4eab-80ef-b0fa90c23854</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-07 14:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-07 14:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[ty] Track open files in the server&quot; to &quot;[ty] Consider virtual files for workspace diagnostics&quot; by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-07 14:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-07 14:36</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_project/src/lib.rs</code>:595 on 2025-07-08 14:49</div>
            <div class="timeline-body"><p>Personally I find <code>open_files.map(...).unwrap_or(0)</code> more clear.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_project/src/lib.rs</code>:620 on 2025-07-08 14:54</div>
            <div class="timeline-body"><pre><code>                    open_files: open_files.into_iter().flatten(),
</code></pre>
<p>I <em>think</em> works here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_project/src/lib.rs</code>:664 on 2025-07-08 15:46</div>
            <div class="timeline-body"><p>This would benefit from a brief comment to the effect of &quot;iterate forward the open_files until we find the next virtual one, or the iterator returns None (and hash_set::Iter is a FusedIterator so it will keep yielding None)&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-08 16:01</div>
            <div class="timeline-body"><p>Having trouble finding where the notion of virtual files comes from -- is this the &quot;open files are in-memory files&quot; or &quot;files in the playground&quot; or both?</p>
<p>The idea here is that when checking a workspace, if we have an in-memory copy and an on-disk copy, the in-memory one should be preferred? or?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-08 16:11</div>
            <div class="timeline-body"><blockquote>
<p>Having trouble finding where the notion of virtual files comes from -- is this the &quot;open files are in-memory files&quot; or &quot;files in the playground&quot; or both?</p>
</blockquote>
<p>It&#x27;s exclusively used for the LSP use case where a new file in an editor doesn&#x27;t have a path yet. It only exists in the editor but without any associated path. Instead, it&#x27;s identified by a unique string (it&#x27;s an URL). The virtual file becomes a regular file once the user hits save in the editor and picks a location for it.</p>
<p>Files that are open in the editor and have unsaved changes are handled by our <a href="https://github.com/astral-sh/ruff/blob/ebc70a4002dbad17ffac27a35959d937793787ee/crates/ruff_db/src/system.rs#L49"><code>System</code></a> abstraction. The <code>System</code> abstraction hides where ty is running and it provides methods for reading files etc. The LSP has a custom <code>System</code> implementation that returns the unsaved file changes over the file content on disk if it is open in the editor (<a href="https://github.com/astral-sh/ruff/blob/ebc70a4002dbad17ffac27a35959d937793787ee/crates/ty_server/src/system.rs#L165">`LSPSystem</a>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-09 09:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_project/src/lib.rs</code>:620 on 2025-07-09 09:39</div>
            <div class="timeline-body"><p>That doesn&#x27;t work but <code>open_files.as_deref().into_iter().flatten()</code> does which would then require updating the <code>open_files</code> type to be a bit verbose (<code>std::iter::Flatten&lt;std::option::IntoIter&lt;&amp;std::collections::HashSet&lt;File&gt;&gt;&gt;</code>) and I&#x27;m not sure if that&#x27;ll work. I&#x27;m leaning towards what I have currently, thanks for the suggestion!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/lib.rs</code>:545 on 2025-07-10 10:20</div>
            <div class="timeline-body"><p>We do want to drop AST nodes even in <code>CheckMode::AllFiles</code> if they&#x27;re not open. Reparsing should only be necessary if a dependency of that file changed (and only if that files public interface changed).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-10 10:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-10 10:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/lib.rs</code>:572 on 2025-07-10 10:22</div>
            <div class="timeline-body"><p>I think I would simply combine those and eagerly compute the Virtual files in <code>ProjectFiles::new</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-10 10:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/db.rs</code>:15 on 2025-07-10 10:23</div>
            <div class="timeline-body"><p>Do we still need <code>is_file_open</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-10 10:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/lib.rs</code>:397 on 2025-07-10 10:26</div>
            <div class="timeline-body"><p>I&#x27;m not sure this is correct. Looking at this, I&#x27;m actually not sure if we even need to change this because <code>project.is_file_open</code> already correctly returns <code>true</code> for virtual paths</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-10 10:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_project/src/lib.rs</code>:545 on 2025-07-10 10:29</div>
            <div class="timeline-body"><p>I noticed that for every <code>workspace/diagnostic</code> request that VS Code sent, all of the files were being re-parsed even though nothing changed. This is why I thought it might be useful to do this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-10 10:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_project/src/lib.rs</code>:397 on 2025-07-10 10:34</div>
            <div class="timeline-body"><p>Hmm, yeah. I think I changed the ordering within the <code>project.is_file_open</code> after implementing this and I think you&#x27;re right that this might not be required now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-10 10:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/lib.rs</code>:545 on 2025-07-10 10:35</div>
            <div class="timeline-body"><p>Oh, I think I see the problem. It&#x27;s because <code>check_file_impl</code> isn&#x27;t a salsa query. I can fix this real quick.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-10 10:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/lib.rs</code>:545 on 2025-07-10 10:56</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/19255</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-10 14:37</div>
            <div class="timeline-body"><p>I&#x27;ve found a few other issues in the implementation, I&#x27;m looking at them. I&#x27;ll create another PR and avoid the PR stack for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-10 14:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-10 14:41</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:16:21 UTC
    </footer>
</body>
</html>
