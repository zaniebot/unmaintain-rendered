```yaml
number: 6589
title: Use single lookup for leading, dangling, and trailing comments
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: comments-single-lookup
created_at: 2023-08-15T05:48:26Z
updated_at: 2023-08-15T15:39:47Z
url: https://github.com/astral-sh/ruff/pull/6589
synced_at: 2026-01-12T15:55:22Z
```

# Use single lookup for leading, dangling, and trailing comments

---

_@MichaReiser_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This is a preparation PR for https://github.com/astral-sh/ruff/pull/6561. The `fmt: skip` support requires looking up the trailing comments to determine whether a node is suppressed or not. However, looking up the comments for a node isn't free and we would now perform 6 comment lookups for every statement:

* The leading and trailing comments each once to test if the node falls into a suppressed range
* Once to determine whether the statement is suppressed by a trailing comment. 
* Once to format the leading comments
* Once to format the dangling comments
* Once to format the trailing comments

This is a lot. This PR reduces the number of lookups to 2 (or 3 if the dangling comment formatting is handled by the node):

* Once to test the range suppression comments
* Once to test the trailing suppresseion comment and format the leading, dangling, and trailing comments.

<!-- What's the purpose of the change? What does it do, and why? -->


## Performance

This results in a small performance improvement

```
Gnuplot not found, using plotters backend
formatter/numpy/globals.py
                        time:   [38.282 Âµs 38.439 Âµs 38.579 Âµs]
                        thrpt:  [76.484 MiB/s 76.761 MiB/s 77.077 MiB/s]
                 change:
                        time:   [-2.6719% -2.2332% -1.8094%] (p = 0.00 < 0.05)
                        thrpt:  [+1.8427% +2.2842% +2.7452%]
                        Performance has improved.
formatter/pydantic/types.py
                        time:   [801.74 Âµs 802.72 Âµs 803.74 Âµs]
                        thrpt:  [31.731 MiB/s 31.771 MiB/s 31.810 MiB/s]
                 change:
                        time:   [-0.0133% +0.4071% +0.8294%] (p = 0.06 > 0.05)
                        thrpt:  [-0.8226% -0.4055% +0.0133%]
                        No change in performance detected.
Found 6 outliers among 100 measurements (6.00%)
  4 (4.00%) high mild
  2 (2.00%) high severe
formatter/numpy/ctypeslib.py
                        time:   [395.65 Âµs 396.25 Âµs 396.95 Âµs]
                        thrpt:  [41.948 MiB/s 42.021 MiB/s 42.086 MiB/s]
                 change:
                        time:   [-1.8160% -1.4214% -1.0641%] (p = 0.00 < 0.05)
                        thrpt:  [+1.0755% +1.4419% +1.8496%]
                        Performance has improved.
Found 2 outliers among 100 measurements (2.00%)
  1 (1.00%) high mild
  1 (1.00%) high severe
formatter/large/dataset.py
                        time:   [2.0272 ms 2.0319 ms 2.0380 ms]
                        thrpt:  [19.962 MiB/s 20.022 MiB/s 20.069 MiB/s]
                 change:
                        time:   [+0.4893% +0.9936% +1.4942%] (p = 0.00 < 0.05)
                        thrpt:  [-1.4722% -0.9838% -0.4869%]
                        Change within noise threshold.
Found 3 outliers among 100 measurements (3.00%)
  1 (1.00%) high mild
  2 (2.00%) high severe

```

## Test Plan

`cargo test`
<!-- How was it tested? -->


---

_Comment by @MichaReiser on 2023-08-15 05:48_

Current dependencies on/for this PR:
* main
  * **PR #6589** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6589" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #6561** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6561" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #6593** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6593" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6589?utm_source=stack-comment).

---

_Marked ready for review by @MichaReiser on 2023-08-15 05:58_

---

_Label `formatter` added by @MichaReiser on 2023-08-15 05:58_

---

_Review requested from @charliermarsh by @MichaReiser on 2023-08-15 05:58_

---

_Comment by @github-actions[bot] on 2023-08-15 06:30_

## PR Check Results
### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01      3.9Â±0.03ms    10.4 MB/sec    1.00      3.9Â±0.03ms    10.5 MB/sec
formatter/numpy/ctypeslib.py               1.02    780.5Â±2.85Âµs    21.3 MB/sec    1.00   767.9Â±34.81Âµs    21.7 MB/sec
formatter/numpy/globals.py                 1.04     78.9Â±0.37Âµs    37.4 MB/sec    1.00     76.2Â±1.47Âµs    38.7 MB/sec
formatter/pydantic/types.py                1.03  1574.7Â±28.52Âµs    16.2 MB/sec    1.00   1526.5Â±6.92Âµs    16.7 MB/sec
linter/all-rules/large/dataset.py          1.00     10.3Â±0.02ms     4.0 MB/sec    1.00     10.3Â±0.03ms     3.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      2.8Â±0.01ms     6.0 MB/sec    1.00      2.8Â±0.02ms     6.0 MB/sec
linter/all-rules/numpy/globals.py          1.01    396.9Â±0.46Âµs     7.4 MB/sec    1.00    393.4Â±0.59Âµs     7.5 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.4Â±0.04ms     4.8 MB/sec    1.00      5.4Â±0.02ms     4.8 MB/sec
linter/default-rules/large/dataset.py      1.01      5.5Â±0.02ms     7.4 MB/sec    1.00      5.5Â±0.02ms     7.5 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01   1217.6Â±1.38Âµs    13.7 MB/sec    1.00   1209.9Â±2.79Âµs    13.8 MB/sec
linter/default-rules/numpy/globals.py      1.00    141.5Â±0.33Âµs    20.9 MB/sec    1.00    141.0Â±0.30Âµs    20.9 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.5Â±0.01ms    10.3 MB/sec    1.00      2.5Â±0.01ms    10.3 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.02      4.2Â±0.01ms     9.8 MB/sec    1.00      4.1Â±0.02ms    10.0 MB/sec
formatter/numpy/ctypeslib.py               1.02    790.6Â±9.06Âµs    21.1 MB/sec    1.00   778.4Â±23.75Âµs    21.4 MB/sec
formatter/numpy/globals.py                 1.03     81.1Â±0.46Âµs    36.4 MB/sec    1.00     78.5Â±1.10Âµs    37.6 MB/sec
formatter/pydantic/types.py                1.03  1632.1Â±24.20Âµs    15.6 MB/sec    1.00  1590.9Â±17.52Âµs    16.0 MB/sec
linter/all-rules/large/dataset.py          1.00     12.6Â±0.05ms     3.2 MB/sec    1.00     12.6Â±0.07ms     3.2 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.6Â±0.02ms     4.7 MB/sec    1.00      3.5Â±0.01ms     4.7 MB/sec
linter/all-rules/numpy/globals.py          1.01    370.5Â±5.06Âµs     8.0 MB/sec    1.00    368.5Â±8.38Âµs     8.0 MB/sec
linter/all-rules/pydantic/types.py         1.01      6.6Â±0.02ms     3.9 MB/sec    1.00      6.5Â±0.02ms     3.9 MB/sec
linter/default-rules/large/dataset.py      1.01      7.0Â±0.04ms     5.8 MB/sec    1.00      6.9Â±0.03ms     5.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01   1452.3Â±5.78Âµs    11.5 MB/sec    1.00   1440.4Â±6.11Âµs    11.6 MB/sec
linter/default-rules/numpy/globals.py      1.00    150.9Â±1.23Âµs    19.6 MB/sec    1.00    150.8Â±1.98Âµs    19.6 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.1Â±0.02ms     8.2 MB/sec    1.00      3.1Â±0.03ms     8.2 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_@charliermarsh approved on 2023-08-15 13:03_

---

_Merged by @MichaReiser on 2023-08-15 15:39_

---

_Closed by @MichaReiser on 2023-08-15 15:39_

---

_Branch deleted on 2023-08-15 15:39_

---
