<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Support publishing diagnostics in the server - astral-sh/ruff #18309</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Support publishing diagnostics in the server</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18309">#18309</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2025-05-26 04:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR adds support for <a href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#textDocument_publishDiagnostics">publishing diagnostics</a> from the ty language server.</p>
<p>It only adds support for it for text documents and not notebook documents because the server doesn't have full notebook support yet.</p>
<p>Closes: astral-sh/ty#79</p>
<h2>Test Plan</h2>
<p>Testing this out in Helix and Zed since those are the two editors that I know of that doesn't support pull diagnostics:</p>
<h3>Helix</h3>
<p>https://github.com/user-attachments/assets/e193f804-0b32-4f7e-8b83-6f9307e3d2d4</p>
<h3>Zed</h3>
<p>https://github.com/user-attachments/assets/93ec7169-ce2b-4521-b009-a82d8afb9eaa</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @dhruvmanila on 2025-05-26 04:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @dhruvmanila on 2025-05-26 04:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-05-26 04:29</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dhruvmanila on 2025-05-26 05:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dhruvmanila on 2025-05-26 05:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2025-05-26 05:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dhruvmanila on 2025-05-26 05:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @dhruvmanila on 2025-05-26 05:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @dhruvmanila on 2025-05-26 05:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dcreager removed by @dhruvmanila on 2025-05-26 05:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @dhruvmanila on 2025-05-26 05:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @dhruvmanila on 2025-05-26 05:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @dhruvmanila on 2025-05-26 05:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api/diagnostics.rs</code>:82 on 2025-05-26 06:59</div>
            <div class="timeline-body"><p>Delete</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api/diagnostics.rs</code>:99 on 2025-05-26 06:59</div>
            <div class="timeline-body"><p>Is <code>usize::default</code> correct here? What is it used for? I also don't understand the comment beauase it's unclear to me where we use source kind here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api/notifications/did_change.rs</code>:62 on 2025-05-26 07:01</div>
            <div class="timeline-body"><p>Could we add a <code>path_db</code> or similar method to <code>session</code> that handles the db lookup internally</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api/notifications/did_open.rs</code>:58 on 2025-05-26 07:02</div>
            <div class="timeline-body"><p>The code here seems to be the same as in <code>did_change</code>. Can we move it into a shared method?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api/diagnostics.rs</code>:47 on 2025-05-26 07:04</div>
            <div class="timeline-body"><p>It would be useful to have a comment explaining that all <code>uri</code>s belong to the same file because I was worried at first what would happen if <code>check_file(db, document_a</code>) returns two diagnostics for file <code>b</code> but <code>check_file(db, document_b)</code> returns 4, in which case publishing the diagnostics would override each other.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-05-26 07:05</div>
            <div class="timeline-body"><p>Thanks. This overall looks good.</p>
<p>I think there's an opportunity to reduce code duplication a bit and there are some code paths that I don't understand (see inline comments)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-05-26 07:12</div>
            <div class="timeline-body"><p>Oh, we also need to think about how this integrates with <code>didWatchedFilesChange</code>. I don't think it's necessary to call publish diagnostic if a single python file changed because that file isn't open. But we have to re-publish all diagnostics when the configuration changed</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @MichaReiser on 2025-05-26 07:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/diagnostics.rs</code>:99 on 2025-05-26 13:09</div>
            <div class="timeline-body"><p>We would need to use <code>source_kind</code> (which is currently commented out) to get the <code>NotebookIndex</code> which will be used to get the cell index in which the diagnostics occur. This index will be used to get the URI for that cell to publish the diagnostics for.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-05-26 13:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-05-26 13:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/diagnostics.rs</code>:47 on 2025-05-26 13:11</div>
            <div class="timeline-body"><p>Yeah, I can do that. You're correct that the URI here belong to the same document, it's mainly to accommodate the different text documents that represents the cell of a notebook. I could use an enum to make this more concrete like:</p>
<pre><code class="language-rs">enum Diagnostics {
  TextDocument(Url, Vec&lt;Diagnostic&gt;),
  NotebookDocument(FxHashMap&lt;Url, Vec&lt;Diagnostic&gt;&gt;),
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-05-27 00:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/notifications/did_open.rs</code>:58 on 2025-05-27 00:10</div>
            <div class="timeline-body"><p>I could move it to <code>Session</code> so that it's <code>session.publish_diagnostics</code> but the main issue is that the data structure that's required for this is part of <code>server</code> crate and not the <code>session</code> crate. I could just expose them at the <code>ty_server</code> crate level but I'm not sure if <code>session</code> should depend on <code>server</code> but <code>server</code> <em>already</em> depends on <code>session</code> crate as <code>Server</code> contains the <code>Session</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-05-27 00:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/notifications/did_change.rs</code>:62 on 2025-05-27 00:12</div>
            <div class="timeline-body"><p>Added <code>Session::project_db_or_default</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-05-27 04:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api/notifications/did_open.rs</code>:58 on 2025-05-27 04:54</div>
            <div class="timeline-body"><p>Sorry, if I was misleading. A standalone function is fine too</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-05-27 07:34</div>
            <div class="timeline-body"><p>Video testing that any changes to configuration files refreshes the diagnostics via publish mechanism in Zed:</p>
<p>https://github.com/user-attachments/assets/433008db-fe8e-4f8c-afe8-8dfa9bae4faa</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-05-27 09:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api/notifications/did_change_watched_files.rs</code>:66 on 2025-05-27 09:04</div>
            <div class="timeline-body"><p>I'd prefer if we put this into <code>apply_changes</code> to avoid duplicating the logic when a project has changed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-05-27 10:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/notifications/did_change_watched_files.rs</code>:66 on 2025-05-27 10:13</div>
            <div class="timeline-body"><p>I think this change already exists in <code>apply_changes</code></p>
<p>https://github.com/astral-sh/ruff/blob/cd1fd80f595b3e41943d11f8479b34460d446bd1/crates/ty_project/src/db/changes.rs#L45-L53</p>
<p>, this is present here mainly to check whether we need to refresh the diagnostics or not as the <code>didChangeWatchedFiles</code> is registered for <code>.py</code>, <code>.pyi</code>, and <code>.ipynb</code> files as well for which we shouldn't need to do that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-05-27 10:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api/notifications/did_change_watched_files.rs</code>:66 on 2025-05-27 10:23</div>
            <div class="timeline-body"><p>Yes. I'd prefer if we wouldn't duplicate the logic here and instead add a return value to <code>apply_changes</code> indicating what changed. There are other cases where it assumes a <code>project_changed</code> event that aren't covered by what you have in <code>did_change_watched_files</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/notifications/did_change_watched_files.rs</code>:66 on 2025-05-28 05:59</div>
            <div class="timeline-body"><p>Got it, I've made the change to return a <code>ChangeResult</code> that contains boolean fields to indicate what changes were detected by the <code>apply_changes</code> method.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-05-28 06:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-05-28 06:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/notifications/did_open.rs</code>:58 on 2025-05-28 06:19</div>
            <div class="timeline-body"><p>No, I think I misunderstood. I've added <code>publish_diagnostics</code> in <a href="https://github.com/astral-sh/ruff/pull/18309/commits/fc2d72500238fb3d92b3b1d5d4ae7bdd2601151a"><code>fc2d725</code> (#18309)</a> although it does make call to <code>url_to_any_system_path</code> twice for <code>didOpen</code> and <code>didChange</code> handler (not for <code>didChangeWatchedFiles</code> handler).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-05-28 06:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/notifications/did_change_watched_files.rs</code>:97 on 2025-05-28 06:20</div>
            <div class="timeline-body"><p>@MichaReiser can you verify this comment?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-05-28 06:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/notifications/did_change_watched_files.rs</code>:101 on 2025-05-28 06:21</div>
            <div class="timeline-body"><p>I think this should be fine even after we add support for multiple workspaces.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2025-05-28 06:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/db/changes.rs</code>:22 on 2025-05-28 06:30</div>
            <div class="timeline-body"><p>I don't think this comment is accurate. We set <code>project_changed</code> to <code>true </code>for changes that <em>may have</em> changed the project structure. There's no guarantee for it. I would remove the part about files were added or removed because this is only the case when:</p>
<ul>
<li>The file watcher sends a rescan event -&gt; which means the file watcher is out of sync</li>
<li>A directory was deleted that was likely to contain the project configuration.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/db/changes.rs</code>:281 on 2025-05-28 06:30</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        result
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api/notifications/did_change_watched_files.rs</code>:97 on 2025-05-28 06:32</div>
            <div class="timeline-body"><p>I think this is accurate. It may change in the future but we'll then need to change this line :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-05-28 06:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2025-05-28 07:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2025-05-28 07:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-05-28 07:45</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:12:56 UTC
    </footer>
</body>
</html>
