<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disallow single-line implicit concatenated strings - astral-sh/ruff #13928</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Disallow single-line implicit concatenated strings</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13928">#13928</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-10-25 15:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes https://github.com/astral-sh/ruff/issues/8272</p>
<p>The formatter is incompatible with <code>ISC001</code> because it can introduce new single-line implicit concatenated strings if all parts fit on the line. The new implicit concatenated string formatting style already addresses this incompatibility for regular strings and most f-string but not for triple quoted strings and raw strings.</p>
<p>This PR proposes to change the formatter style to <strong>never</strong> collapse the parts of an implicit concatenated string onto a single line unless it has been formatted on a single line by the author.</p>
<pre><code class="language-python">(
	r&quot;aaaaaaa&quot; &quot;bbbbbbbbbbbb&quot;
)
</code></pre>
<p>Is preserved as is because the author wrote the implicit concatenated string on a single line and it fits. The source i already incompatible with ISC001.</p>
<pre><code class="language-python">(
	r&quot;aaaaaaa&quot;
	&quot;bbbbbbbbbbbb&quot;
)
</code></pre>
<p>The current style collapses this string to match the example above. The style proposed in this PR preserves the multiline formatting in this case because there's a line break between the two parts.</p>
<h2>Preview gating</h2>
<p>It's technically not required to gate this change behind preview because it doesn't change the formatting of any existing code. But it fits nicely into the other implicit concatenated work that we've been doing and the new implicit concatenated string formatting also largely mitigates that this leads to slightly less consistent formatting (because it's up to the author whether the string remains multiline or not)</p>
<h2>Test Plan</h2>
<p>Added tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2024-10-25 15:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">style</span> added by @MichaReiser on 2024-10-25 15:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-10-25 15:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/snapshots/black_compatibility@cases__preview_long_strings__regression.py.snap</code>:947 on 2024-10-25 15:43</div>
            <div class="timeline-body"><p>The diff here is slightly confusing. We should double check that this change is correct.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-10-25 15:58</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected format changes</strong>. (+18 -6 lines in 4 files in 3 projects; 51 projects unchanged)</p>
<details><summary><a href="https://github.com/bokeh/bokeh">bokeh/bokeh</a> (+11 -3 lines across 2 files)</summary>
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<p><a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/examples/styling/mathtext/latex_bessel.py#L21'>examples/styling/mathtext/latex_bessel.py~L21</a></p>
<pre><code class="language-diff">     width=700,
     height=500,
     title=(
-        r&quot;Bessel functions of the first kind: $$J_\alpha(x) = \sum_{m=0}^{\infty}&quot; r&quot;\frac{(-1)^m}{m!\:\Gamma(m+\alpha+1)} \left(\frac{x}{2}\right)^{2m+\alpha}$$&quot;
+        r&quot;Bessel functions of the first kind: $$J_\alpha(x) = \sum_{m=0}^{\infty}&quot;
+        r&quot;\frac{(-1)^m}{m!\:\Gamma(m+\alpha+1)} \left(\frac{x}{2}\right)^{2m+\alpha}$$&quot;
     ),
 )
 p.x_range.range_padding = 0
</code></pre>
<p><a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/core/property/color.py#L126'>src/bokeh/core/property/color.py~L126</a></p>
<pre><code class="language-diff">             Regex(r&quot;^#[0-9a-fA-F]{4}$&quot;),
             Regex(r&quot;^#[0-9a-fA-F]{6}$&quot;),
             Regex(r&quot;^#[0-9a-fA-F]{8}$&quot;),
-            Regex(r&quot;^rgba\(((25[0-5]|2[0-4]\d|1\d{1,2}|\d\d?)\s*,&quot; r&quot;\s*?){2}(25[0-5]|2[0-4]\d|1\d{1,2}|\d\d?)\s*,&quot; r&quot;\s*([01]\.?\d*?)\)&quot;),
-            Regex(r&quot;^rgb\(((25[0-5]|2[0-4]\d|1\d{1,2}|\d\d?)\s*,&quot; r&quot;\s*?){2}(25[0-5]|2[0-4]\d|1\d{1,2}|\d\d?)\s*?\)&quot;),
+            Regex(
+                r&quot;^rgba\(((25[0-5]|2[0-4]\d|1\d{1,2}|\d\d?)\s*,&quot;
+                r&quot;\s*?){2}(25[0-5]|2[0-4]\d|1\d{1,2}|\d\d?)\s*,&quot;
+                r&quot;\s*([01]\.?\d*?)\)&quot;
+            ),
+            Regex(
+                r&quot;^rgb\(((25[0-5]|2[0-4]\d|1\d{1,2}|\d\d?)\s*,&quot;
+                r&quot;\s*?){2}(25[0-5]|2[0-4]\d|1\d{1,2}|\d\d?)\s*?\)&quot;
+            ),
             Tuple(Byte, Byte, Byte),
             Tuple(Byte, Byte, Byte, Percent),
             RGB,
</code></pre>
</p>
</details>
<details><summary><a href="https://github.com/pandas-dev/pandas">pandas-dev/pandas</a> (+4 -2 lines across 1 file)</summary>
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<p><a href='https://github.com/pandas-dev/pandas/blob/a3f14bfa373c6fb4e3470a1f3bd8fed1657e09e1/pandas/tests/tools/test_to_datetime.py#L1346'>pandas/tests/tools/test_to_datetime.py~L1346</a></p>
<pre><code class="language-diff">         assert res is NaT
 
         msg = &quot;|&quot;.join([
-            r'^time data &quot;a&quot; doesn\'t match format &quot;%H:%M:%S&quot;. ' f&quot;{PARSING_ERR_MSG}$&quot;,
+            r'^time data &quot;a&quot; doesn\'t match format &quot;%H:%M:%S&quot;. '
+            f&quot;{PARSING_ERR_MSG}$&quot;,
             r'^Given date string &quot;a&quot; not likely a datetime$',
             r'^unconverted data remains when parsing with format &quot;%H:%M:%S&quot;: &quot;9&quot;. '
             f&quot;{PARSING_ERR_MSG}$&quot;,
</code></pre>
<p><a href='https://github.com/pandas-dev/pandas/blob/a3f14bfa373c6fb4e3470a1f3bd8fed1657e09e1/pandas/tests/tools/test_to_datetime.py#L1396'>pandas/tests/tools/test_to_datetime.py~L1396</a></p>
<pre><code class="language-diff"> 
         msg = &quot;|&quot;.join([
             r'^Given date string &quot;a&quot; not likely a datetime$',
-            r'^time data &quot;a&quot; doesn\'t match format &quot;%H:%M:%S&quot;. ' f&quot;{PARSING_ERR_MSG}$&quot;,
+            r'^time data &quot;a&quot; doesn\'t match format &quot;%H:%M:%S&quot;. '
+            f&quot;{PARSING_ERR_MSG}$&quot;,
             r'^unconverted data remains when parsing with format &quot;%H:%M:%S&quot;: &quot;9&quot;. '
             f&quot;{PARSING_ERR_MSG}$&quot;,
             r&quot;^second must be in 0..59: 00:01:99$&quot;,
</code></pre>
</p>
</details>
<details><summary><a href="https://github.com/rotki/rotki">rotki/rotki</a> (+3 -1 lines across 1 file)</summary>
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<p><a href='https://github.com/rotki/rotki/blob/e625dac30d750424cb81166890d0c945372047fc/rotkehlchen/exchanges/coinbase.py#L68'>rotkehlchen/exchanges/coinbase.py~L68</a></p>
<pre><code class="language-diff"> LEGACY_RE: re.Pattern = re.compile(r&quot;^[\w]+$&quot;)
 NEW_RE: re.Pattern = re.compile(r&quot;^organizations/[\w-]+/apiKeys/[\w-]+$&quot;)
 PRIVATE_KEY_RE: re.Pattern = re.compile(
-    r&quot;^-----BEGIN EC PRIVATE KEY-----\n&quot; r&quot;[\w+/=\n]+&quot; r&quot;-----END EC PRIVATE KEY-----\n?$&quot;,
+    r&quot;^-----BEGIN EC PRIVATE KEY-----\n&quot;
+    r&quot;[\w+/=\n]+&quot;
+    r&quot;-----END EC PRIVATE KEY-----\n?$&quot;,
     re.MULTILINE,
 )
 
</code></pre>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @MichaReiser on 2024-11-01 16:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2024-11-01 17:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @MichaReiser on 2024-11-01 17:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MichaReiser on 2024-11-01 17:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-11-02 17:21</div>
            <div class="timeline-body"><p>I think this is a smart change. We should document it in the Black deviations though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-02 17:33</div>
            <div class="timeline-body"><blockquote>
<p>I think this is a smart change. We should document it in the Black deviations though.</p>
</blockquote>
<p>Thanks for the feedback. I plan to document the deviations as part of promoting the new style guide.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2024-11-03 11:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-11-03 11:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-03 11:49</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:07:14 UTC
    </footer>
</body>
</html>
