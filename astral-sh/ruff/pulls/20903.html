<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Standardize syntax error construction - astral-sh/ruff #20903</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Standardize syntax error construction</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20903">#20903</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-10-15 18:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a></div>
            <div class="timeline-body">Summary
<p>This PR unifies the two different ways Ruff and ty construct syntax errors. Ruff has been storing the primary message in the diagnostic itself, while ty attached the message to the primary annotation:</p>
<pre><code>&gt; ruff check try.py
invalid-syntax: name capture `x` makes remaining patterns unreachable
 --&gt; try.py:2:10
  |
1 | match 42:
2 |     case x: ...
  |          ^
3 |     case y: ...
  |

Found 1 error.
&gt; uvx ty check try.py
WARN ty is pre-release software and not ready for production use. Expect to encounter bugs, missing features, and fatal errors.
Checking ------------------------------------------------------------ 1/1 files                                                                                                 
error[invalid-syntax]
 --&gt; try.py:2:10
  |
1 | match 42:
2 |     case x: ...
  |          ^ name capture `x` makes remaining patterns unreachable
3 |     case y: ...
  |

Found 1 diagnostic
</code></pre>
<p>I think there are benefits to both approaches, and I do like ty&#x27;s version, but I feel like we should pick one (and it might help with #20901 eventually). I slightly prefer Ruff&#x27;s version, so I went with that. Hopefully this isn&#x27;t too controversial, but I&#x27;m happy to close this if it is.</p>
<p>Note that this shouldn&#x27;t change any other diagnostic formats in ty because <a href="https://github.com/astral-sh/ruff/blob/98d27c412810e157f8a65ea75726d66676628225/crates/ruff_db/src/diagnostic/mod.rs#L177"><code>Diagnostic::primary_message</code></a> was already falling back to the primary annotation message if the diagnostic message was empty. As a result, I think this change will partially resolve the FIXME therein.</p>
Test Plan
<p>Existing tests with updated snapshots</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-15 18:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-15 18:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-15 18:32</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-15 18:34</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected âœ…
No memory usage changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-15 18:47</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>âœ… ecosystem check detected no linter changes.</p>
Linter (preview)
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-10-15 18:48</div>
            <div class="timeline-body">

<a href="https://codspeed.io/astral-sh/ruff/branches/brent%2Fstandardize-syntax-error-message">CodSpeed Performance Report</a>
Merging #20903 will <strong>improve performances by 6.51%</strong>
<p>Comparing <code>brent/standardize-syntax-error-message</code> (d2e8d76) with <code>main</code> (9de34e7)[^unexpected-base]
[^unexpected-base]: No successful run was found on <code>main</code> (fd568f0) during the generation of this report, so 9de34e7 was used instead as the comparison base. There might be some changes unrelated to this pull request in this report.</p>
Summary
<p><code>âš¡ 1</code> improvement<br>
<code>âœ… 50</code> untouched</p>
Benchmarks breakdown
<p>|     | Mode | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | ---- | --------- | ------ | ------ | ------ |
| âš¡ | WallTime | <a href="https://codspeed.io/astral-sh/ruff/branches/brent%2Fstandardize-syntax-error-message?uri=crates%2Fruff_benchmark%2Fbenches%2Fty_walltime.rs%3A%3Amedium%5Bcolour-science%5D&amp;runnerMode=WallTime"><code>medium[colour-science]</code></a> | 11.2 s | 10.5 s | +6.51% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-15 18:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-15 18:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-15 18:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-15 18:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-15 18:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-15 18:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-15 18:53</div>
            <div class="timeline-body"><blockquote>
<p>Merging #20903 will <strong>improve performances by 6.51%</strong></p>
</blockquote>
<p>yeah, that&#x27;s just a merge race with <a href="https://github.com/astral-sh/ruff/pull/20377">astral-sh/ruff#20377</a>, judging by the footnote that Codspeed put at the bottom of that comment ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-15 18:55</div>
            <div class="timeline-body"><p>Yes good call, I don&#x27;t think this should affect performance :laughing:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/snapshots/semantic_syntax_erroâ€¦_-_Semantic_syntax_erroâ€¦_-_`async`_comprehensioâ€¦_-_Python_3.10_(96aa8ec77d46553d).snap</code>:44 on 2025-10-15 18:55</div>
            <div class="timeline-body"><p>Something like this might be nice here (but not blocking):</p>
<pre><code>error[invalid-syntax]: cannot use an asynchronous comprehension inside of a synchronous comprehension on Python 3.10
 --&gt; src/mdtest_snippet.py:6:19
  |
4 | async def f():
5 |     # error: 19 [invalid-syntax] &quot;cannot use an asynchronous comprehension inside of a synchronous comprehension on Python 3.10 (syntaxâ€¦
6 |     return {n: [x async for x in elements(n)] for n in range(3)}
  |                   ^^^^^^^^^^^^^^^^^^^^^^^^^^ Syntax was added in 3.11
7 | async def test():
8 |     # error: [not-iterable] &quot;Object of type `range` is not async-iterable&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-10-15 18:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ty_python_semantic/resources/mdtest/snapshots/semantic_syntax_erroâ€¦_-_Semantic_syntax_erroâ€¦_-_`async`_comprehensioâ€¦_-_Python_3.10_(96aa8ec77d46553d).snap</code>:44 on 2025-10-15 18:58</div>
            <div class="timeline-body"><p>I was thinking about that too, or an info sub-diagnostic. I think either option will need something like <a href="https://github.com/astral-sh/ruff/issues/20901">astral-sh/ruff#20901</a>, though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-10-15 18:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ty_python_semantic/resources/mdtest/snapshots/semantic_syntax_erroâ€¦_-_Semantic_syntax_erroâ€¦_-_`async`_comprehensioâ€¦_-_Python_3.10_(96aa8ec77d46553d).snap</code>:44 on 2025-10-15 18:59</div>
            <div class="timeline-body"><p>(or just a separate constructor from the very generic <code>invalid_syntax</code> for unsupported syntax errors)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-10-15 18:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-10-15 19:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-16 15:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-16 15:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-10-16 15:56</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:19:35 UTC
    </footer>
</body>
</html>
