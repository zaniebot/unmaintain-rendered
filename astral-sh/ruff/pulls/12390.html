<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Resolve symbols from `builtins.pyi` in the stdlib if they cannot be found in other scopes - astral-sh/ruff #12390</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Resolve symbols from <code>builtins.pyi</code> in the stdlib if they cannot be found in other scopes</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/12390">#12390</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-07-18 19:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-18 19:23</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR means that red-knot is now able to understand builtin symbols -- resolving them to symbols in a <code>builtins.pyi</code> stub file (either in a custom typeshed directory, if one was supplied, or to the vendored stubs we ship as part of the binary).</p>
<p>The first commit here moves some code around in the module resolver and adds a new public function exported by the module resolver, <code>resolve_builtins</code>. This is a thin wrapper around a new Salsa query, <code>resolve_builtins_query</code>. The query short-circuits most of the module resolution logic we do for other Python modules, because this is what Python does at runtime: builtin symbols are (nearly) always resolved to the builtins module shipped as part of the interpreter, even if a <code>builtins.py</code> file exists in the first-party workspace.</p>
<p>The second commit uses this new query exposed by the module resolver to obtain the builtins scope, and uses the builtins scope to resolve builtin symbols and infer the types of those symbols.</p>
<h2>Test Plan</h2>
<p>New tests have been added to <code>red_knot_module_resolver</code> and <code>red_knot_python_semantic</code></p>
<p>Co-authored-by: Carl Meyer <a href="mailto:carl@astral.sh">carl@astral.sh</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2024-07-18 19:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2024-07-18 19:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2024-07-18 19:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-18 19:34</div>
            <div class="timeline-body"><p>Haha, that's fun. This makes the red-knot benchmarks crash. I belive that's because the benchmarks just use the vendored typeshed stubs, and the benchmark code uses <code>str</code> as a return annotation in one function, and the definition of <code>str</code> in typeshed's <code>builtins.pyi</code> file is</p>
<pre><code class="language-py">class str(Sequence[str]):
    ...
</code></pre>
<p>which we obviously can't cope with right now, so we panic üòÜ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-07-18 19:37</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:32 on 2024-07-18 19:48</div>
            <div class="timeline-body"><p>This change is because otherwise we panic when trying to resolve the <code>str</code> builtin symbol, because the <code>str</code> class in typeshed's <code>builtins.pyi</code> file has a <code>Subscript</code> node as its sole base, and we don't support those yet. An alternative solution would be to use a custom typeshed in the benchmark here -- but then the benchmarks won't catch any unexpected performance regressions caused by a PR syncing our vendored typeshed stubs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-18 19:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:55 on 2024-07-18 19:51</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// Shorthand for `symbol_ty` that looks up a symbol in the builtins.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-07-18 19:52</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/builtins-resolution">CodSpeed Performance Report</a></h2>
<h3>Merging #12390 will <strong>degrade performances by 97.48%</strong></h3>
<p><sub>Comparing <code>builtins-resolution</code> (0f0f5b2) with <code>main</code> (1c7b840)</sub></p>
<h3>Summary</h3>
<p><code>‚ùå 3 (üëÅ 3)</code> regressions
<code>‚úÖ 30</code> untouched benchmarks</p>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>main</code> | <code>builtins-resolution</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| üëÅ | <code>red_knot_check_file[cold]</code> | 347.1 ¬µs | 13,754.9 ¬µs | -97.48% |
| üëÅ | <code>red_knot_check_file[incremental]</code> | 211.3 ¬µs | 423.7 ¬µs | -50.12% |
| üëÅ | <code>red_knot_check_file[without_parse]</code> | 260.2 ¬µs | 6,359.1 ¬µs | -95.91% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:32 on 2024-07-18 19:56</div>
            <div class="timeline-body"><p>Yeah, I think this is the best approach for now; we should be adding to our benchmark anyway as we add new supported features.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-07-18 19:56</div>
            <div class="timeline-body"><p>Looks great!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-18 19:57</div>
            <div class="timeline-body"><blockquote>
<p>Merging #12390 will <strong>degrade performances by 98.09%</strong></p>
</blockquote>
<p>Sort-of expected, I think... not sure there's any way around that; this is just what we have to do, I think!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-07-18 19:58</div>
            <div class="timeline-body"><p>Wait, are those super-high regression numbers on the benchmarks because it was failing, or are those from after the benchmark fix?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-18 20:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:32 on 2024-07-18 20:01</div>
            <div class="timeline-body"><p>Can we land this change separately, then rebase so that we get proper benchmark numbers.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:700 on 2024-07-18 20:02</div>
            <div class="timeline-body"><p>I think one issue shown by the benchmarks might be that we're getting cycles? I think we should ensure that if we are inferring types in the builtins scope, we <em>don't</em> make this fallback.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:46 on 2024-07-18 20:02</div>
            <div class="timeline-body"><p>I would prefer if we don't use the resolve prefix for all salsa queries. I don't see it adding much</p>
<p>What's the reason for this wrapper function. It doesn't do anything</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:689 on 2024-07-18 20:03</div>
            <div class="timeline-body"><p>This is a pre-existing issue, so it could be done in a separate PR, but I think we also need to ensure we don't make <em>this</em> fallback if we are already inferring types in the module global scope.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-07-18 20:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-18 20:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:700 on 2024-07-18 20:04</div>
            <div class="timeline-body"><p>Ah! Very good point.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/builtins.rs</code>:11 on 2024-07-18 20:04</div>
            <div class="timeline-body"><p>What's the reason for returning an option if it is always some</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-18 20:07</div>
            <div class="timeline-body"><p>It would be helpful for reviews if the summary could explain some of the newly introduced concepts.</p>
<p>We should also a analyze the performance regression. The increase seems to big for the few builtins that we resolve</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-18 20:08</div>
            <div class="timeline-body"><p>I think we have to update our benchmarks first, for example by pre-parsing builtins</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-18 20:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:32 on 2024-07-18 20:10</div>
            <div class="timeline-body"><blockquote>
<p>Can we land this change separately, then rebase so that we get proper benchmark numbers.</p>
</blockquote>
<p>sure</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-18 20:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/builtins.rs</code>:11 on 2024-07-18 20:11</div>
            <div class="timeline-body"><p>It's not always <code>Some</code>. There's a question-mark operator in there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-07-18 20:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/builtins.rs</code>:11 on 2024-07-18 20:11</div>
            <div class="timeline-body"><p>There's a question mark in the function, so it's not always Some</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-18 20:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:46 on 2024-07-18 20:16</div>
            <div class="timeline-body"><blockquote>
<p>What's the reason for this wrapper function. It doesn't do anything</p>
</blockquote>
<p>If you make this diff to my PR branch (which was what Carl and I tried initially):</p>
<pre><code class="language-diff">--- a/crates/red_knot_module_resolver/src/db.rs
+++ b/crates/red_knot_module_resolver/src/db.rs
@@ -2,7 +2,7 @@ use ruff_db::Upcast;
 
 use crate::resolver::{
     editable_install_resolution_paths, file_to_module, internal::ModuleNameIngredient,
-    module_resolution_settings, resolve_builtins_query, resolve_module_query,
+    module_resolution_settings, resolve_builtins, resolve_module_query,
 };
 use crate::typeshed::parse_typeshed_versions;
 
@@ -12,7 +12,7 @@ pub struct Jar(
     module_resolution_settings,
     editable_install_resolution_paths,
     resolve_module_query,
-    resolve_builtins_query,
+    resolve_builtins,
     file_to_module,
     parse_typeshed_versions,
 );
diff --git a/crates/red_knot_module_resolver/src/resolver.rs b/crates/red_knot_module_resolver/src/resolver.rs
index 28c7f0222..a4945054e 100644
--- a/crates/red_knot_module_resolver/src/resolver.rs
+++ b/crates/red_knot_module_resolver/src/resolver.rs
@@ -43,12 +43,8 @@ pub(crate) fn resolve_module_query&lt;'db&gt;(
     Some(module)
 }
 
-pub fn resolve_builtins(db: &amp;dyn Db) -&gt; Option&lt;Module&gt; {
-    resolve_builtins_query(db)
-}
-
 #[salsa::tracked]
-pub(crate) fn resolve_builtins_query(db: &amp;dyn Db) -&gt; Option&lt;Module&gt; {
+pub fn resolve_builtins(db: &amp;dyn Db) -&gt; Option&lt;Module&gt; {
     let _span = tracing::trace_span!(&quot;resolve_builtins&quot;).entered();
</code></pre>
<p>then Clippy issues this complaint, despite the fact that it's publicly exported from the crate in <code>lib.rs</code>:</p>
<pre><code>warning: unreachable `pub` item
  --&gt; crates/red_knot_module_resolver/src/resolver.rs:47:1
   |
47 | pub fn resolve_builtins(db: &amp;dyn Db) -&gt; Option&lt;Module&gt; {
   | ---^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
   | |
   | help: consider restricting its visibility: `pub(crate)`
   |
   = help: or consider exporting it for use by other crates
   = note: requested on the command line with `-W unreachable-pub`
</code></pre>
<p>We found that using a wrapper function solved this issue, and I suppose we assumed that this was the way to go since this file already has <code>resolve_module()</code>, which is just a thin wrapper around <code>resolve_module_query()</code>. But perhaps it's better just to suppress the bogus Clippy warning in this instance?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-18 20:18</div>
            <div class="timeline-body"><p>This is neat! And awesome how few changes weren't required</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-07-18 20:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:46 on 2024-07-18 20:18</div>
            <div class="timeline-body"><p>Renaming to <code>builtins_module</code> instead of <code>resolve_builtins</code>.</p>
<p>The reason for the wrapped function is that there seems to be an issue with making a salsa query <code>pub</code> -- even if we re-export it in <code>lib.rs</code> it still issues an &quot;unreachable pub item&quot; warning. I think this is maybe because <code>#[salsa::tracked]</code> creates both a function and a struct by that name? Not sure.</p>
<p>Anyway, I can just allow that warning instead of using the no-op wrapper function.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-18 20:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:46 on 2024-07-18 20:19</div>
            <div class="timeline-body"><p>Yeah. That's a clippy issue that we already suppress in other places and is something we have to fix upstream in salsa</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-18 20:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:32 on 2024-07-18 20:20</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/12392</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/builtins.rs</code>:11 on 2024-07-18 20:22</div>
            <div class="timeline-body"><p>I wonder if we should use specify in this query to create the builtin module instead of having two queries. Or are there other cases where we need access to the builtins module?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-18 20:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-07-18 20:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:32 on 2024-07-18 20:26</div>
            <div class="timeline-body"><p>Oh I just did https://github.com/astral-sh/ruff/pull/12393 and already rebased this PR on top of it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-07-18 20:30</div>
            <div class="timeline-body"><blockquote>
<p>It would be helpful for reviews if the summary could explain some of the newly introduced concepts.</p>
</blockquote>
<p>Definitely agree, but it's not obvious to me which concepts in the PR were not well explained in the summary?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-18 20:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/builtins.rs</code>:11 on 2024-07-18 20:32</div>
            <div class="timeline-body"><p>That's an interesting question! I don't think there are any cases that come to mind where we should be short-circuiting the normal module-resolution process in the same way, no. So perhaps the new function that we publicly expose from the module resolver should not be Salsa-tracked at all, just a regular function, since we know it will only be called from this one place in the <code>red_knot_python_semantic</code> crate, and that one place <em>will</em> be Salsa-tracked.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-07-18 20:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/builtins.rs</code>:11 on 2024-07-18 20:33</div>
            <div class="timeline-body"><p>Probably not other cases where we need it, but not 100% sure? Mostly it just seemed like a better division of responsibilities to keep the module-finding logic in <code>red_knot_module_resolver</code> and the scope query in <code>red_knot_python_semantic</code>; not sure how we would keep that separation if we used <code>specify</code>.</p>
<p>It's also not clear to me what the actual benefit of <code>specify</code> here would be. Both these queries should run exactly once per program (until module resolution settings change), it doesn't seem like a significant cost either way.</p>
<p>It seems to me that specify is more for queries with arguments, where for some special argument values, you want to provide a special result. Here there are no arguments, so what is the difference between using specify and just letting the query run once?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-07-18 20:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/builtins.rs</code>:11 on 2024-07-18 20:37</div>
            <div class="timeline-body"><p>Actually I think what would make sense here for now is simply to make <code>builtins_module</code> a regular function instead of a salsa query. No need for specify, but also not reason for <code>builtins_module</code> to be a query until/unless we have other callers of it, and so we need separate caching at that layer. For now the caching of <code>builtins_scope</code> is sufficient.</p>
<p>I'll make that change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-07-18 20:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:700 on 2024-07-18 20:44</div>
            <div class="timeline-body"><p>This doesn't actually result in a cycle currently, because querying a public symbol type is different from querying a use type, and doesn't go through these scope fallbacks. But this does result in a lot of extra work, which I suspect is the cause of the regression. And it can also result in wrong results. Adding tests with the fix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-18 20:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/builtins.rs</code>:11 on 2024-07-18 20:59</div>
            <div class="timeline-body"><p>Kind of related. What happens if someone does from builtins import string.</p>
<p>I would suspect that this would fo through the module resolver unless we handle it at every call site (which I rather avoid).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-18 21:01</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>It would be helpful for reviews if the summary could explain some of the newly introduced concepts.</p>
</blockquote>
<p>Definitely agree, but it's not obvious to me which concepts in the PR were not well explained in the summary?</p>
</blockquote>
<p>I'm mainly interested in understanding newly introduced salsa queries and how they relate</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-07-18 21:02</div>
            <div class="timeline-body"><blockquote>
<p>I think we have to update our benchmarks first, for example by pre-parsing builtins</p>
</blockquote>
<p>There's a cycle problem here, because we kind of need the <code>builtins_module</code> function added in this PR in order to add pre-parsing of builtins to the benchmarks. I guess I can split <code>builtins_module</code> out into its own PR, along with the change to the &quot;without_parse&quot; benchmark.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-18 21:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/builtins.rs</code>:11 on 2024-07-18 21:03</div>
            <div class="timeline-body"><blockquote>
<p>Kind of related. What happens if someone does from builtins import string.</p>
<p>I would suspect that this would fo through the module resolver unless we handle it at every call site (which I rather avoid).</p>
</blockquote>
<p>Yeah, that should just go through normal module resolution machinery. Python won't apply any special-casing there ‚Äî if there's a first-party module called <code>builtins</code>, it will completely shadow the stdlib builtins module for the &quot;explicit&quot; import ‚Äî so we shouldn't special-case it either. It's only the &quot;implicit&quot; builtins scope that we need to special-case when it comes to module resolution.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-18 21:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/builtins.rs</code>:11 on 2024-07-18 21:05</div>
            <div class="timeline-body"><p>Except we kind of have to for the case where there is no first party module with that name. Otherwise resolve module returns a different Module instance (which means we reparse and reinfer it)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-18 21:06</div>
            <div class="timeline-body"><blockquote>
<p>I think we have to update our benchmarks first, for example by pre-parsing builtins</p>
</blockquote>
<p>This would mean that our benchmarks wouldn't catch any performance regressions caused by upstream changes to typeshed's stubs for <code>builtins</code>. Mypy has had several of these in the past; I think it would be very useful if our benchmarks automatically flagged any performance degradations as part of the CI run for an automated PR syncing our vendored typeshed stubs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-18 21:08</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>I think we have to update our benchmarks first, for example by pre-parsing builtins</p>
</blockquote>
<p>This would mean that our benchmarks wouldn't catch any performance regressions caused by upstream changes to typeshed's stubs for <code>builtins</code>. Mypy has had several of these in the past; I think it would be very useful if our benchmarks automatically flagged any performance degradations as part of the CI run for an automated PR syncing our vendored typeshed stubs.</p>
</blockquote>
<p>I think we want more benchmarks. The once we have today are intentionally narrow in scope so that they're very sensitive to overhead in the type inference machinery</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/builtins.rs</code>:11 on 2024-07-18 21:10</div>
            <div class="timeline-body"><p>We should add two tests. One where there's no first party builtins and one where there is. For the first case, the module on builtins scope should resolve to the same module as when calling resolve_module</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-18 21:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-18 21:11</div>
            <div class="timeline-body"><blockquote>
<p>I think we want more benchmarks. The once we have today are intentionally narrow in scope so that they're very sensitive to overhead in the type inference machinery</p>
</blockquote>
<p>That makes sense. In that case, my instinct would be to update the benchmarks to use a custom typeshed directory with a minimal builtins stub, rather than using the vendored typeshed builtins stub.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-18 21:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/builtins.rs</code>:11 on 2024-07-18 21:13</div>
            <div class="timeline-body"><p>Very good points</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-07-18 21:15</div>
            <div class="timeline-body"><p>I think the <code>without_parse</code> red-knot benchmark should exclude parsing builtins also, and the other benchmarks can be left as-is (the &quot;incremental&quot; one should automatically exclude parsing builtins, since builtins won't have changed, and the &quot;cold&quot; one should include parsing builtins.) I'm already working on a PR for this.</p>
<p>I don't think we should use a fake builtins for the benchmarks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-07-18 21:34</div>
            <div class="timeline-body"><blockquote>
<p>There's a cycle problem here</p>
</blockquote>
<p>Also this was wrong, it's easy enough to just create a <code>VendoredPath</code> and call <code>vendored_path_to_file</code> in the benchmark, we don't need to pull in anything from this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-07-18 21:35</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/12395 adds builtins pre-parsing to the without-parse benchmark, and https://github.com/astral-sh/ruff/pull/12396 fixes what looks like reversed naming of benchmarks. This PR is rebased on both.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-07-18 21:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/builtins.rs</code>:11 on 2024-07-18 21:50</div>
            <div class="timeline-body"><p>Good call, will add this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-07-18 22:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/builtins.rs</code>:11 on 2024-07-18 22:08</div>
            <div class="timeline-body"><p>I think what's important here is that they are the same <code>File</code>, not the same <code>Module</code>. <code>File</code> is the actual ingredient we use everywhere which has identity semantics; <code>Module</code> is just a struct to hold a name and a <code>File</code>, which I think we should treat with value semantics (i.e. two different <code>Module</code> struct with same name and <code>File</code> are equivalent); we discard the <code>Module</code> pretty much immediately in type inference and don't use it anywhere.</p>
<p>Imported builtins and implicit builtins via <code>builtins_scope()</code> are already the same <code>File</code> (but I am adding a test for this).</p>
<p>At some point we may want to evaluate whether we even gain any value from the <code>Module</code> struct. (Maybe it's important inside the resolver? But it's not used anywhere in type inference.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-07-18 22:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/builtins.rs</code>:11 on 2024-07-18 22:22</div>
            <div class="timeline-body"><p>In fact I think we should just change <code>builtins_module</code> to <code>builtins_file</code> instead; if <code>builtins_scope</code> is the only caller, it's silly to wrap the file in a <code>Module</code> which we then immediately discard in <code>builtins_scope</code>, which only needs the file. Then there is no question of them being &quot;the same Module&quot; because there is no Module at all in the <code>builtins_scope</code> path.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-07-18 23:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/builtins.rs</code>:11 on 2024-07-18 23:04</div>
            <div class="timeline-body"><p>Regarding first-party code overriding builtins module, this isn't actually possible at runtime unless you mess with importer hooks (which we don't need to -- and can't possibly -- support). If you check <code>sys.meta_path</code>, <code>BuiltinsImporter</code> comes first, before <code>PathFinder</code>, which is the hook that actually implements all the normal filesystem module resolution. So in any normal Python installation, <code>import sys</code> and <code>import builtins</code> <em>always</em> resolve to the built-in <code>sys</code> and <code>builtins</code> modules, regardless of first-party code.</p>
<p>This will require some special handling in the module resolver, and I don't think it needs to be done in this PR; I've created https://github.com/astral-sh/ruff/issues/12398 to track it as a separate change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-18 23:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/builtins.rs</code>:11 on 2024-07-18 23:07</div>
            <div class="timeline-body"><p>Blegh. I forgot that Python special-cased those modules. Agree with deferring those to a followup.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-07-18 23:46</div>
            <div class="timeline-body"><p>Hmm, it doesn't seem like the fixes I made to avoid redundant globals/builtins queries made a big dent in the perf regression here, so something I don't understand is still going on. Trying to dig into the CodSpeed data to understand what it could be.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-07-19 00:29</div>
            <div class="timeline-body"><p>Ok, after poring over the CodSpeed flame graphs for a while, my conclusion is that in the non-incremental benchmarks (<code>cold</code> and <code>without_parse</code>) the main difference is that we are now paying for semantic indexing of a very large file (<code>builtins.pyi</code>) which is many orders of magnitude larger than any file the benchmark previously touched, and in the incremental benchmark we pay for deep validation of that semantic index and the other ingredients depending on it.</p>
<p>I also pored over the traces from locally linting the same files that the benchmark runs on, and I didn't see any issues in the traces: it looked to me like we are doing the work we expect to do.</p>
<p>One way we could potentially reduce this cost would be to semantic-index by scope instead of by file? But this might be over-indexing on the current example, where we use very little of a large file; in real-world large projects I expect the proportional cost of semantic indexing for stuff we don't use would be much, much lower.</p>
<p>At this point I am open to further exploration, but my inclination based on what I've seen is that this regression is accurate based on adding semantic index of a much larger file, and we should merge it and keep paying attention to the benchmarks as we go; once we are able to check a much larger real-world program, we should take a careful look at where the bottlenecks are.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/builtins.rs</code>:11 on 2024-07-19 05:47</div>
            <div class="timeline-body"><p>Considering that the module resolver needs special handling for built-ins anyway (#12398,) my preferred solution is to call <code>resolve_module(&quot;builtins&quot;)</code> here instead of resolving the file manually. Yes, there's an extra cost to it but it should be marginal in comparison to checking an entire project and any later <code>resolve_module(&quot;builtins&quot;)</code> would be free after that (or as free as Salsa makes a query lookup).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-07-19 05:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-19 10:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/builtins.rs</code>:11 on 2024-07-19 10:23</div>
            <div class="timeline-body"><p>I think we should leave it as-is for now. We'll need a routine that's <em>like</em> this for short-circuiting &quot;normal module resolution&quot; when we encounter a builtin module anyway. So I think #12398 will be easier to implement if we keep this as a separate routine for now. When we fix #12398, we can generalise the routine so that we can short-circuit other special-cased modules as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-19 10:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/builtins.rs</code>:11 on 2024-07-19 10:45</div>
            <div class="timeline-body"><blockquote>
<p>We'll need a routine that's like this for short-circuiting &quot;normal module resolution&quot; when we encounter a builtin module anyway.</p>
</blockquote>
<p>That's correct. What I understand is that this routine would live in <code>resolve_module</code>?</p>
<p>Edit: Already using <code>resolve_module</code> means that the change in #12398 would be minimal without touching other code (that we might forget updating)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-07-19 15:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/builtins.rs</code>:11 on 2024-07-19 15:41</div>
            <div class="timeline-body"><p>Looking at this again, I think I agree with Micha -- it seems like the simplest implementation of this &quot;special case&quot; ultimately is just a bit of added code in <code>resolve_name</code> to skip non-stdlib search paths if the name being resolved is in the builtin-modules set. Once we have that, <code>builtins_scope</code> may as well just <code>resolve_module(&quot;builtins&quot;)</code>. So I don't see where a separate routine is actually really needed.</p>
<p>Also it looks to me like the fix for #12398 is likely to be so small (literally it looks like just adding the set of builtin module names, then one <code>if not search_path.is_standard_library() and builtin_module_names.contains(name) { continue; }</code> in <code>resolve_name</code>?) that maybe we may as well just do it in this PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-19 15:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/builtins.rs</code>:11 on 2024-07-19 15:47</div>
            <div class="timeline-body"><blockquote>
<p>Looking at this again, I think I agree with Micha -- it seems like the simplest implementation of this &quot;special case&quot; ultimately is just a bit of added code in <code>resolve_name</code> to skip non-stdlib search paths if the name being resolved is in the builtin-modules set. Once we have that, <code>builtins_scope</code> may as well just <code>resolve_module(&quot;builtins&quot;)</code>. So I don't see where a separate routine is actually really needed.</p>
</blockquote>
<p>Yes, fair enough</p>
<blockquote>
<p>Also it looks to me like the fix for #12398 is likely to be so small (literally it looks like just adding the set of builtin module names, then one <code>if not search_path.is_standard_library() and builtin_module_names.contains(name) { continue; }</code> in <code>resolve_name</code>?) that maybe we may as well just do it in this PR?</p>
</blockquote>
<p>If we just hardcode the list of builtin names into <code>resolver.rs</code>, yes. Longer term I think we probably want to have generated Rust code like in https://github.com/astral-sh/ruff/blob/main/crates/ruff_python_stdlib/src/sys.rs, which will require writing a Python script like in https://github.com/astral-sh/ruff/blob/main/scripts/generate_known_standard_library.py. Which also won't be that much work, but is big enough to warrant its own PR, I think. But I'm fine with just hardcoding a list in <code>resolver.rs</code> for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-19 16:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:454 on 2024-07-19 16:20</div>
            <div class="timeline-body"><p>rather than being a <code>const &amp;[&amp;str]</code>, this could also possibly be a <code>Lazy&lt;HashSet&lt;&amp; 'static str&gt;&gt;</code>, which might make containment checks faster. But we can probably optimize this in the followup where we write a script to generate a Rust file that contains this list?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-19 16:28</div>
            <div class="timeline-body"><p>(It doesn't look like I have permissions to acknowledge the perf regression on CodSpeed. Somebody else might have to do that for me -- or give me permission to do so ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-19 16:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:454 on 2024-07-19 16:31</div>
            <div class="timeline-body"><p>We should probably use <code>static</code> here. <code>const</code> inlines the variable on every use. we don't want that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-07-19 16:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-07-19 16:31</div>
            <div class="timeline-body"><p>Looks good! I think we should also add a test that first-party <code>builtins.py</code> doesn't override the builtin one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-19 16:31</div>
            <div class="timeline-body"><blockquote>
<p>Looks good! I think we should also add a test that first-party <code>builtins.py</code> doesn't override the builtin one.</p>
</blockquote>
<p>I added that test in the latest push ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:454 on 2024-07-19 16:39</div>
            <div class="timeline-body"><p>done!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-19 16:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2024-07-19 16:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-07-19 16:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-07-19 16:44</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 21:47:34 UTC
    </footer>
</body>
</html>
