<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Implement go-to for binary and unary operators - astral-sh/ruff #21001</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Implement go-to for binary and unary operators</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21001">#21001</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-10-20 17:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR implements goto and hover for binary operations and unary expressions.</p>
<p>As for other hover targets, the implementation doesn't try to match overloads yet.</p>
<p>This PR doesn't implement go-to support for augmented assign, which seems to match Pylance. I don't see a reason why we couldn't but I suggest leaving that for a separate PR</p>
<p>Fixes https://github.com/astral-sh/ty/issues/1151</p>
<h2>Test plan</h2>
<p>Added tests</p>
<p>https://github.com/user-attachments/assets/5b04daea-c04f-4937-a899-2c9879e2d99a</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @MichaReiser on 2025-10-20 17:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @MichaReiser on 2025-10-20 17:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/goto_definition.rs</code>:801 on 2025-10-21 10:12</div>
            <div class="timeline-body"><p>I moved this to the end. It felt weird having it in the middle of the tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-21 10:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-21 10:14</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types/ide_support.rs</code>:974 on 2025-10-21 10:14</div>
            <div class="timeline-body"><p>It didn't feel worth pulling this out into its own <code>Type</code> method, especially because <code>__bool__</code> is somewhat complicated when all we need here is to get the<code>__bool__</code> dunder</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-21 10:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-21 10:15</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-21 11:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types/call.rs</code>:29 on 2025-10-21 11:26</div>
            <div class="timeline-body"><p>I extracted this from <code>builder.rs</code>. The lines are unchanged except that the <code>map(|outcome| outcome.return_type())</code> remains in <code>builder.rs</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2025-10-21 11:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MichaReiser on 2025-10-21 11:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MichaReiser on 2025-10-21 11:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @MichaReiser on 2025-10-21 11:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @MichaReiser on 2025-10-21 11:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @MichaReiser on 2025-10-21 11:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @Gankra by @MichaReiser on 2025-10-21 11:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dcreager removed by @MichaReiser on 2025-10-21 11:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @MichaReiser on 2025-10-21 11:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-21 12:13</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_ide/src/goto.rs</code>:939 on 2025-10-21 14:35</div>
            <div class="timeline-body"><p>Just out of curiosity, is this to avoid returning <code>Some</code> when the cursor is inside a comment?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-10-21 15:01</div>
            <div class="timeline-body"><p>Looks good, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-21 15:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/goto.rs</code>:939 on 2025-10-21 15:58</div>
            <div class="timeline-body"><p>Short answer: yes :)</p>
<p>The problem with binary expressions and unary expressions is that we don't know the operator's range. That means, we would return <code>Some</code> for</p>
<pre><code class="language-py">(
	a + # comment&lt;CURSOR&gt;
	b
)
</code></pre>
<p>Because the range is between <code>a</code> and <code>b</code>. But that's obviously not what we want.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-21 16:04</div>
            <div class="timeline-body"><p>One <em>tiny</em> UI nit (possibly not solvable, possibly playground-specific, just posting it because I noticed it):</p>
<p>If I have the <code>cmd</code> key held down and hover over a symbol, the symbol changes colour and becomes underlined, and my mouse symbol changes to a little ✋ to tell me that I can click on it to go to its definition. But the same thing doesn't happen if I have the <code>cmd</code> key held down and hover over an operator, so it's hard for me to tell that cmd-clicking on it is going to take me to the method being displayed by the on-hover tooltip. Here's a video in which I have the <code>cmd</code> key held down for the duration:</p>
<p>https://github.com/user-attachments/assets/503ce993-572c-4a66-a91e-87433be73df2</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-21 16:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/ide_support.rs</code>:974 on 2025-10-21 16:13</div>
            <div class="timeline-body"><p>You could <em>possibly</em> consider adding methods like these to the AST nodes directly, similar to what we already have for the bin-op nodes:</p>
<p>https://github.com/astral-sh/ruff/blob/e1cada1ec30d289acb00390058fab8bce765836e/crates/ruff_python_ast/src/nodes.rs#L2546-L2602</p>
<p>But yeah, <code>not</code> is complicated because it falls back to <code>__len__</code> as well as <code>__bool__</code>, even if you ignore all the fancy special casing we have baked in for the truthiness of various types.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-21 16:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/ide_support.rs</code>:1002 on 2025-10-21 16:13</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// This is so that we show e.g. `int.__add__` instead of `Literal[4].__add__`.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-10-21 16:14</div>
            <div class="timeline-body"><p>Really cool. The core logic looks great!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-21 16:27</div>
            <div class="timeline-body"><blockquote>
<p>If I have the cmd key held down and hover over a symbol, the symbol changes colour and becomes underlined, and my mouse symbol changes to a little ✋ to tell me that I can click on it to go to its definition. But the same thing doesn't happen if I have the cmd key held down and hover over an operator, so it's hard for me to tell that cmd-clicking on it is going to take me to the method being displayed by the on-hover tooltip. Here's a video in which I have the cmd key held down for the duration:</p>
</blockquote>
<p>I noticed this too but it's not clear to me why it is happening, because we report the full range of the binary expression as its range. I can try to use a narrower range to see if that helps</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-21 17:04</div>
            <div class="timeline-body"><p>Nope, that doesn't help (but I think is strictly better). I did give r-a a try and it also doesn't underline <code>+</code> and other operands. We also correctly set the <a href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#locationLink"><code>originSelectionRange</code></a> but it seems VS code doesn't care?</p>
<p>It does work fine with <code>not</code>.</p>
<p>Confirmed, Zed renders this correctly</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-10-21 17:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-10-21 17:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-10-21 17:25</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:16:35 UTC
    </footer>
</body>
</html>
