<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Add some narrowing for assignment expressions - astral-sh/ruff #17448</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Add some narrowing for assignment expressions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17448">#17448</a>
        opened by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a>
        on 2025-04-17 12:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>Fixes #14866
Fixes #17437</p>
<h2>Test Plan</h2>
<p>Update mdtests in <code>narrow/</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MatthewMckee4 on 2025-04-17 12:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MatthewMckee4 on 2025-04-17 12:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @MatthewMckee4 on 2025-04-17 12:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @MatthewMckee4 on 2025-04-17 12:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Add narrowing for assignment expressions for bool and call" to "[red-knot] Add narrowing for assignment expressions for bool and call" by @MatthewMckee4 on 2025-04-17 12:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-04-17 12:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-17 12:28</div>
            <div class="timeline-body"><p>There is still more to cover regarding named expressions. Such as:</p>
<pre><code class="language-py">def f() -&gt; bool: ...

if x := f():
    reveal_type(x)  # revealed: Literal[True]
else:
    reveal_type(x)  # revealed: Literal[False]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-17 12:29</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">psycopg (https://github.com/psycopg/psycopg)
- error[lint:unsupported-operator] /tmp/mypy_primer/projects/psycopg/psycopg/psycopg/rows.py:215:12: Operator `&lt;` is not supported for types `None` and `int`, in comparing `int | None` with `Literal[1]`
- warning[lint:possibly-unbound-attribute] /tmp/mypy_primer/projects/psycopg/psycopg/psycopg/sql.py:376:28: Attribute `pgconn` on type `@Todo(map_with_boundness: intersections with negative contributions) | None` is possibly unbound
- error[lint:invalid-return-type] /tmp/mypy_primer/projects/psycopg/psycopg/psycopg/types/datetime.py:77:16: Return type does not match returned value: Expected `timedelta`, found `timedelta | None`
- warning[lint:possibly-unbound-attribute] /tmp/mypy_primer/projects/psycopg/psycopg/psycopg/_conninfo_utils.py:81:31: Attribute `envvar` on type `ParamDef | None` is possibly unbound
- warning[lint:possibly-unbound-attribute] /tmp/mypy_primer/projects/psycopg/psycopg_pool/psycopg_pool/sched_async.py:66:24: Attribute `time` on type `@Todo(map_with_boundness: intersections with negative contributions) | None` is possibly unbound
- warning[lint:possibly-unbound-attribute] /tmp/mypy_primer/projects/psycopg/psycopg_pool/psycopg_pool/sched_async.py:69:33: Attribute `time` on type `@Todo(map_with_boundness: intersections with negative contributions) | None` is possibly unbound
+ error[lint:invalid-argument-type] /tmp/mypy_primer/projects/psycopg/psycopg/psycopg/_conninfo_attempts.py:101:15: Argument to this function is incorrect: Expected `bytes | str | int | None`, found `str &amp; ~AlwaysFalsy | ParamDef &amp; ~AlwaysTruthy &amp; ~AlwaysFalsy | @Todo(map_with_boundness: intersections with negative contributions) &amp; ~AlwaysFalsy`
+ error[lint:call-non-callable] /tmp/mypy_primer/projects/psycopg/psycopg/psycopg/generators.py:282:13: Object of type `None` is not callable
+ error[lint:call-non-callable] /tmp/mypy_primer/projects/psycopg/psycopg/psycopg/generators.py:293:13: Object of type `None` is not callable
+ error[lint:invalid-argument-type] /tmp/mypy_primer/projects/psycopg/psycopg/psycopg/_conninfo_attempts_async.py:105:19: Argument to this function is incorrect: Expected `bytes | str | int | None`, found `str &amp; ~AlwaysFalsy | ParamDef &amp; ~AlwaysTruthy &amp; ~AlwaysFalsy | @Todo(map_with_boundness: intersections with negative contributions) &amp; ~AlwaysFalsy`
- warning[lint:possibly-unbound-attribute] /tmp/mypy_primer/projects/psycopg/psycopg_pool/psycopg_pool/sched.py:70:24: Attribute `time` on type `@Todo(map_with_boundness: intersections with negative contributions) | None` is possibly unbound
- warning[lint:possibly-unbound-attribute] /tmp/mypy_primer/projects/psycopg/psycopg_pool/psycopg_pool/sched.py:73:33: Attribute `time` on type `@Todo(map_with_boundness: intersections with negative contributions) | None` is possibly unbound
- error[lint:invalid-argument-type] /tmp/mypy_primer/projects/psycopg/psycopg/psycopg/_conninfo_attempts.py:101:15: Argument to this function is incorrect: Expected `bytes | str | int | None`, found `str | None | ParamDef &amp; ~AlwaysTruthy &amp; ~AlwaysFalsy | @Todo(map_with_boundness: intersections with negative contributions) &amp; ~AlwaysFalsy`
- error[lint:invalid-argument-type] /tmp/mypy_primer/projects/psycopg/psycopg/psycopg/_conninfo_attempts_async.py:105:19: Argument to this function is incorrect: Expected `bytes | str | int | None`, found `str | None | ParamDef &amp; ~AlwaysTruthy &amp; ~AlwaysFalsy | @Todo(map_with_boundness: intersections with negative contributions) &amp; ~AlwaysFalsy`
- warning[lint:possibly-unbound-attribute] /tmp/mypy_primer/projects/psycopg/psycopg/psycopg/pq/pq_ctypes.py:636:17: Attribute `contents` on type `@Todo(generics) | None` is possibly unbound
- warning[lint:possibly-unbound-attribute] /tmp/mypy_primer/projects/psycopg/psycopg/psycopg/generators.py:256:33: Attribute `status` on type `PGresult | None` is possibly unbound
- error[lint:invalid-argument-type] /tmp/mypy_primer/projects/psycopg/psycopg/psycopg/generators.py:282:35: Argument to this function is incorrect: Expected `PGnotify`, found `PGnotify | None`
- error[lint:invalid-argument-type] /tmp/mypy_primer/projects/psycopg/psycopg/psycopg/generators.py:293:35: Argument to this function is incorrect: Expected `PGnotify`, found `PGnotify | None`
- Found 1598 diagnostics
+ Found 1588 diagnostics

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-17 12:32</div>
            <div class="timeline-body"><p>mypy_primer looks good</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Add narrowing for assignment expressions for bool and call" to "[red-knot] Add some narrowing for assignment expressions" by @MatthewMckee4 on 2025-04-17 12:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-04-17 12:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_python_semantic/src/types/narrow.rs</code>:484 on 2025-04-17 12:44</div>
            <div class="timeline-body"><p>I'm not sure if its worth it to try to duplicate less code, here. passing <code>is_positive</code> into <code>evaluate_named_expr_compare</code> seems pointless and after that theres nothing else we can really do.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/narrow.rs</code>:484 on 2025-04-17 20:16</div>
            <div class="timeline-body"><p>I'm OK with this level of duplicated code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/narrow.rs</code>:368 on 2025-04-17 20:19</div>
            <div class="timeline-body"><p>This method name doesn't seem right -- there's nothing <code>NamedExpr</code> specific about this method, and it is used for both named exprs and simple names. I suggest <code>evaluate_expr_compare_op</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-04-17 20:24</div>
            <div class="timeline-body"><p>Looks really good, thank you!</p>
<blockquote>
<p>There is still more to cover regarding named expressions.</p>
</blockquote>
<p>Not required if you don't have time, but it would be really cool if this PR could just establish full parity, since it should be generally true that anywhere we would narrow on a <code>Name</code>, we should also be able to narrow on a <code>NamedExpr</code>. (If we don't reach parity, then I wouldn't want to close the associated issue yet.) And it doesn't seem like we are very far from that? It looks like a <code>NamedExpr</code> version of <code>evaluate_name_expr</code> (to intersect with <code>AlwaysFalsy</code> or <code>AlwaysTruthy</code>) would just be like five or six lines?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-17 20:44</div>
            <div class="timeline-body"><p>Okay, if you think I should do that in this PR, then I'll get that done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-04-17 20:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_python_semantic/src/types/narrow.rs</code>:368 on 2025-04-17 20:46</div>
            <div class="timeline-body"><p>Okay sounds good</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-18 00:10</div>
            <div class="timeline-body"><p>Im not sure what else i need to cover</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-04-18 00:26</div>
            <div class="timeline-body"><p>Looks to me like you got everything! Thank you!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-04-18 00:27</div>
            <div class="timeline-body"><p>I also re-checked the updated ecosystem results and they look good. The new errors are not a regression, they are just cases where other missing features mean there is still a (different) error on the same line that previously had an error.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @carljm on 2025-04-18 00:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-04-18 00:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-19 13:59</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:11:39 UTC
    </footer>
</body>
</html>
