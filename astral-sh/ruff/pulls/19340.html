<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Move Pylint rendering to `ruff_db` - astral-sh/ruff #19340</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Move Pylint rendering to <code>ruff_db</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19340">#19340</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-07-14 21:24
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-14 21:24</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This is a very simple output format, the only decision is what to do if the file
is missing from the diagnostic. For now, I opted to <code>unwrap_or_default</code> both the
path and the <code>OneIndexed</code> row number, giving <code>:1: main diagnostic message</code> in
the test without a file.</p>
<p>Another quirk here is that the path is relativized. I just pasted in the
<code>relativize_path</code> and <code>get_cwd</code> implementations from <code>ruff_linter::fs</code> for now,
but maybe there's a better place for them.</p>
<p>I didn't see any details about why this needs to be relativized in the original
<a href="https://github.com/astral-sh/ruff/issues/1953">issue</a>,
<a href="https://github.com/astral-sh/ruff/pull/1995">PR</a>, or in the pylint
<a href="https://flake8.pycqa.org/en/latest/internal/formatters.html#pylint-formatter">docs</a>,
but it did change the results of the CLI integration test when I tried deleting
it. I haven't been able to reproduce that in the CLI, though, so it may only
happen with <code>Command::current_dir</code>.</p>
<h2>Test Plan</h2>
<p>Tests ported from <code>ruff_linter</code> and a new test for the case with no file</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @ntBre on 2025-07-14 21:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by @ntBre on 2025-07-14 21:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-07-14 21:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_db/src/diagnostic/render/pylint.rs</code>:53 on 2025-07-14 21:25</div>
            <div class="timeline-body"><p>This is carried over from the original code, but we could use the lint name as a backup again.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-14 21:28</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-14 21:41</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @ntBre on 2025-07-14 21:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @ntBre on 2025-07-14 21:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @ntBre on 2025-07-14 21:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @ntBre on 2025-07-14 21:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @ntBre on 2025-07-14 21:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @ntBre on 2025-07-14 21:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dcreager removed by @ntBre on 2025-07-14 21:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @ntBre on 2025-07-14 21:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @ntBre on 2025-07-14 21:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @ntBre on 2025-07-14 21:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/Cargo.toml</code>:40 on 2025-07-15 08:02</div>
            <div class="timeline-body"><p>The <code>ruff_db</code> crate shouldn't depend on any OS specific behavior except for code gated by the <code>os</code> feature. It otherwise makes compiling on other tagets (like you noticed with WASM) a fair bit more complicated.</p>
<p>For ty, making the path relative is implemented in <code>FileResolver</code>. Now, whether this is correct I'm not sure because it does mean that the paths are relative for all rendered output formats (including JSON where we might want to use absolute paths, although I'm not sure). But it is the right place to abstract away the integration logic between ty and Ruff.</p>
<p>https://github.com/astral-sh/ruff/blob/988479d7359a82418906d226280466d75ef27ec0/crates/ruff_db/src/diagnostic/render.rs#L714-L716</p>
<p>One solution is to change <code>UnifiedFile::path</code> to also return a relative path for Ruff files. A better solution is probably to add a <code>current_directory</code> method to <code>FileResolver</code> which returns <code>system.current_directory</code> for ty and whatever <code>path-absolutize</code> uses for ruff. You can then add a <code>relative_path</code> method to <code>UnifiedFile</code> which makes <code>::path</code> relative to <code>file_resolver.current_directory</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/diagnostic/render/pylint.rs</code>:37 on 2025-07-15 08:03</div>
            <div class="timeline-body"><p>Let's not add TODO for let-chain. Either clippy fixes them automatically for us or we can rewrite the code when we make chagnes in the future</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/diagnostic/render/pylint.rs</code>:47 on 2025-07-15 08:08</div>
            <div class="timeline-body"><p>Nit: I find mutable references harder to reason about because it's less clear when they get initialized (it requires tracing the entire code to find all places where the variable is written to).</p>
<p>I would rewrite this to:</p>
<pre><code class="language-rust">            let (filename, row) = diagnostic
                .primary_span_ref()
                .map(|span| {
                    let file = span.file();

                    let row =span.range().filter(|_| !self.resolver.is_notebook(file)).map(|range| {
                        file.diagnostic_source(self.resolver)
                            .as_source_code()
                            .line_column(range.start())
                            .line,
                    });


                    (file.path(self.resolver), row)
                })
                .unwrap_or_default();
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/diagnostic/render/pylint.rs</code>:53 on 2025-07-15 08:16</div>
            <div class="timeline-body"><p>I'm leaning towards doing that. It should also remove the need for the extra <code>format</code> and <code>to_string</code> calls</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/diagnostic/render/pylint.rs</code>:58 on 2025-07-15 08:19</div>
            <div class="timeline-body"><p>Interesting, it seems that this matches pylint's VS code reporter and not the text reporter:</p>
<p>https://github.com/pylint-dev/pylint/blob/a14b2c4e68d3585c74fb7a3bbd5636e807a3ce77/pylint/reporters/text.py#L204</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-15 08:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_db/src/diagnostic/render/pylint.rs</code>:58 on 2025-07-15 12:44</div>
            <div class="timeline-body"><p>I think it might be <code>ParseableTextReporter</code> actually: https://github.com/pylint-dev/pylint/blob/a14b2c4e68d3585c74fb7a3bbd5636e807a3ce77/pylint/reporters/text.py#L189</p>
<p>The VS Code one doesn't have a colon between <code>path</code> and <code>row</code>. This is the link in the renderer docstring that I copied over from <code>ruff_linter</code>: https://flake8.pycqa.org/en/latest/internal/formatters.html#pylint-formatter. I think it's supposed to be the Pylint output format from the flake8 tool.</p>
<p>Working on these definitely makes me curious if/how people are using the various output formats!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-07-15 12:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-07-15 12:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_db/Cargo.toml</code>:40 on 2025-07-15 12:54</div>
            <div class="timeline-body"><p>I was playing with both the ty and ruff CLIs yesterday, and I think they have similar behavior here. As I mentioned in the description, the only place I saw a difference was in the integration tests where the <code>[TMP]/</code> prefix appeared in the output even though it's supposed to be the <code>current_dir</code>. So I was thinking that this relativize call might be unnecessary in general.</p>
<p>But I'll add a method to the <code>FileResolver</code> just in case, that seems like a nice approach.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-15 12:59</div>
            <div class="timeline-body"><blockquote>
<p>I didn't see any details about why this needs to be relativized in the original
For the why: This is so that ruff only prints <code>main.py</code> if it is in the root of your project and not the full path</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-15 13:16</div>
            <div class="timeline-body"><p>Oh yeah, I understand why we relativize the path in general, I just meant that I couldn't find any cases in the CLI where <em>this</em> relativize call made a difference. However, I found one immediately today, so I guess I wasn't testing the right thing yesterday.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @ntBre on 2025-07-15 14:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-07-15 14:04</div>
            <div class="timeline-body"><p>Thank you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-07-15 14:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-07-15 14:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-15 14:14</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:58:38 UTC
    </footer>
</body>
</html>
