<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-annotations`] Don't suggest `NoReturn` for functions raising `NotImplementedError` (`ANN201`, `ANN202`, `ANN205`, `ANN206`) - astral-sh/ruff #21311</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-annotations</code>] Don't suggest <code>NoReturn</code> for functions raising <code>NotImplementedError</code> (<code>ANN201</code>, <code>ANN202</code>, <code>ANN205</code>, <code>ANN206</code>)</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21311">#21311</a>
        opened by <a href="https://github.com/danparizher">@danparizher</a>
        on 2025-11-07 05:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danparizher">@danparizher</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fix ANN201, ANN202, ANN205, and ANN206 to not automatically suggest <code>NoReturn</code>/<code>Never</code> return type annotations for functions that raise <code>NotImplementedError</code>. These rules will still flag missing return type annotations but won't provide an auto-fix, allowing developers to manually specify the actual return type that implementations should return.</p>
<p>Fixes #18886</p>
<h2>Problem Analysis</h2>
<p>The bug occurred because the <code>auto_return_type</code> function in <code>flake8_annotations/helpers.rs</code> detects when all control flow paths in a function raise an exception (<code>Terminal::Raise</code>) and automatically suggests <code>NoReturn</code>/<code>Never</code> as the return type. However, <code>NotImplementedError</code> is semantically different from other exceptions - it's used to indicate abstract methods that should be implemented by subclasses, not methods that truly never return.</p>
<p>When a function raises <code>NotImplementedError</code>, it's typically an abstract method pattern where:</p>
<ul>
<li>The base class defines the method signature but doesn't implement it</li>
<li>Subclasses are expected to override the method with a proper implementation</li>
<li>The return type should reflect what implementations will actually return, not <code>NoReturn</code></li>
</ul>
<p>For example, in Django's serializer pattern:</p>
<pre><code class="language-py">class BaseSerializer:
    def to_internal_value(self, data):
        raise NotImplementedError('`to_internal_value()` must be implemented.')
</code></pre>
<p>This method should have a return type annotation like <code>dict</code> or <code>Any</code>, not <code>NoReturn</code>, because implementations will return actual values.</p>
<h2>Approach</h2>
<p>The fix modifies the <code>auto_return_type</code> function to:</p>
<ol>
<li><p><strong>Added semantic analysis capability</strong>: Modified <code>auto_return_type</code> to accept a <code>SemanticModel</code> parameter, enabling it to analyze exception types in raise statements.</p>
</li>
<li><p><strong>Created detection helper</strong>: Implemented <code>only_raises_not_implemented_error()</code> function that:</p>
<ul>
<li>Traverses the function body using a custom visitor to collect all <code>raise</code> statements</li>
<li>Checks if all raises are <code>NotImplementedError</code> (or <code>NotImplemented</code>) using semantic analysis</li>
<li>Returns <code>true</code> only if all raises are <code>NotImplementedError</code></li>
</ul>
</li>
<li><p><strong>Modified return type inference</strong>: When <code>Terminal::Raise</code> is detected, the function now:</p>
<ul>
<li>First checks if all raises are <code>NotImplementedError</code></li>
<li>If yes, returns <code>None</code> (no auto-fix suggested, but diagnostic still emitted)</li>
<li>If no, returns <code>AutoPythonType::Never</code> as before (suggesting <code>NoReturn</code>/<code>Never</code>)</li>
</ul>
</li>
<li><p><strong>Updated all call sites</strong>: Updated all 4 call sites in <code>definition.rs</code> to pass <code>checker.semantic()</code>:</p>
<ul>
<li>ANN201 (public functions)</li>
<li>ANN202 (private functions)</li>
<li>ANN205 (static methods)</li>
<li>ANN206 (class methods)</li>
</ul>
</li>
</ol>
<p>The fix ensures that:</p>
<ul>
<li>Functions raising <code>NotImplementedError</code> still get flagged for missing return type annotations</li>
<li>But no auto-fix is suggested, allowing manual specification of the correct return type</li>
<li>Functions raising other exceptions (like <code>ValueError</code>) still correctly get <code>NoReturn</code>/<code>Never</code> suggestions</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-11-07 05:21</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-11-07 20:56</div>
            <div class="timeline-body"><p>Could you summarize the similarities/differences from #18927? I quickly skimmed both implementations and this looks similar to the earlier PR. Has @MichaReiser's concern in https://github.com/astral-sh/ruff/pull/18927#discussion_r2166250598 been addressed?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @ntBre on 2025-11-07 20:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/danparizher">@danparizher</a> on 2025-11-07 23:00</div>
            <div class="timeline-body"><p>I missed that, thanks for bringing it back up. I just refactored the implementation:</p>
<ul>
<li>Adds a new <code>Terminal::RaiseNotImplemented</code> variant that's detected during the initial <code>Terminal::from_function()</code> traversal</li>
<li>Eliminates the need for the <code>only_raises_not_implemented_error()</code> function that was doing a second pass</li>
<li>Updates <code>auto_return_type()</code> to check for <code>Terminal::RaiseNotImplemented</code> directly</li>
</ul>
<p>The way I did it in the original PR is pretty similar, minus the logic that I just implemented</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @amyreese on 2025-11-26 01:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_semantic/src/analyze/terminal.rs</code>:164 on 2025-12-01 19:16</div>
            <div class="timeline-body"><p>I looked at the references to <code>from_body</code>, and I don't think there are any cases where a semantic model is unavailable. It's only passed as <code>None</code> in <code>sometimes_breaks</code>, but <code>sometimes_breaks</code> is only called from <code>from_body</code>, which has access to a semantic model, unless  I'm missing something.</p>
<p>I also think we could use <code>has_builtin_binding</code> here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_semantic/src/analyze/terminal.rs</code>:15 on 2025-12-01 19:19</div>
            <div class="timeline-body"><p>Did you check if all of the other uses of <code>Terminal::Raise</code> should now be something like this?</p>
<pre><code class="language-rust">matches!(terminal, Terminal::Raise | Terminal::RaiseNotImplemented)
</code></pre>
<p>It doesn't look like any other tests or ecosystem results are changing, but at least from a quick look, I would think these variants should be treated the same in some other rules. If so, it might be good to add a <code>Terminal::is_raise</code> helper method with a <code>matches!</code> like the one above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_semantic/src/analyze/terminal.rs</code>:203 on 2025-12-01 19:20</div>
            <div class="timeline-body"><p>Should we combine this with the arms above?</p>
<pre><code class="language-suggestion">            // If one of the operators is `RaiseNotImplemented`, treat it like `Raise` for combinations
            (Self::Raise | Self::RaiseNotImplemented, Self::ConditionalReturn) =&gt; Self::RaiseOrReturn,
            (Self::ConditionalReturn, Self::Raise | Self::RaiseNotImplemented) =&gt; Self::RaiseOrReturn,
</code></pre>
<p>or maybe just group the lines and not separate them with a comment.</p>
<p>Hmm, after scrolling through a few more of these, it might be easier if every <code>Self::Raise</code> just became <code>Self::Raise | Self::RaiseNotImplemented</code> except where the behavior should differ. Otherwise we have to manually compare the two everywhere they appear.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> requested changes on 2025-12-01 19:26</div>
            <div class="timeline-body"><p>Thanks, this looks reasonable to me overall. I just think we can make the <code>SemanticModel</code> a  required argument, and we should double check all of the existing uses of <code>Terminal::Raise</code> to be sure they handle <code>Terminal::RaiseNotImplemented</code> correctly.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:17:01 UTC
    </footer>
</body>
</html>
