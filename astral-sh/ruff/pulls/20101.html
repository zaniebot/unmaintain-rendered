<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use new diff rendering format in tests - astral-sh/ruff #20101</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use new diff rendering format in tests</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20101">#20101</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-08-26 16:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>I spun this off from #19919 to separate the rendering code change and snapshot updates from the (much smaller) changes to expose this in the CLI. I grouped all of the <code>ruff_linter</code> snapshot changes in the final commit in an effort to make this easier to review. The code changes are in <a href="https://github.com/astral-sh/ruff/pull/20101/files/619395eb417d2030e31fbb0e487a72dac58902db">this range</a>.</p>
<p>I went through all of the snapshots, albeit fairly quickly, and they all looked correct to me. In the last few commits I was trying to resolve an existing issue in the alignment of the line number separator:</p>
<p>https://github.com/astral-sh/ruff/blob/73720c73be981df6f71ce837a67ca1167da0265e/crates/ruff_linter/src/rules/flake8_comprehensions/snapshots/ruff_linter__rules__flake8_comprehensions__tests__C409_C409.py.snap#L87-L89</p>
<p>In the snapshot above on <code>main</code>, you can see that a double-digit line number at the end of the context lines for a snippet was causing a misalignment with the other separators. That's now resolved. The one downside is that this can lead to a mismatch with the diagnostic above:</p>
<pre><code>C409 [*] Unnecessary list literal passed to `tuple()` (rewrite as a tuple literal)
 --&gt; C409.py:4:6
  |
2 |   t2 = tuple([1, 2])
3 |   t3 = tuple((1, 2))
4 |   t4 = tuple([
  |  ______^
5 | |     1,
6 | |     2
7 | | ])
  | |__^
8 |   t5 = tuple(
9 |       (1, 2)
  |
help: Rewrite as a tuple literal
1  | t1 = tuple([])
2  | t2 = tuple([1, 2])
3  | t3 = tuple((1, 2))
   - t4 = tuple([
4  + t4 = (
5  |     1,
6  |     2
   - ])
7  + )
8  | t5 = tuple(
9  |     (1, 2)
10 | )
note: This is an unsafe fix and may remove comments or change runtime behavior
</code></pre>
<p>But I don't think we can avoid that without really reworking this rendering to make the diagnostic and diff rendering aware of each other. Anyway, this should only happen in relatively rare cases where the diagnostic is near a digit boundary and also near a context boundary. Most of our diagnostics line up nicely.</p>
<p>Another potential downside of the new rendering format is its handling of long stretches of <code>+</code> or <code>-</code> lines:</p>
<pre><code>help: Replace with `Literal[...] | None`
21 |     ...
22 |
23 |
   - def func6(arg1: Literal[
   -     &quot;hello&quot;,
   -     None  # Comment 1
   -     , &quot;world&quot;
   -     ]):
24 + def func6(arg1: Literal[&quot;hello&quot;, &quot;world&quot;] | None):
25 |     ...
26 |
27 |
note: This is an unsafe fix and may remove comments or change runtime behavior
</code></pre>
<p>To me it just seems a little hard to tell what's going on with just a long streak of <code>-</code>-prefixed lines. I saw an even more exaggerated example at some point, but I think this is also fairly rare. Most of the snapshots seem more like the examples we looked at on Discord with plenty of <code>|</code> lines and pairs of <code>+</code> and <code>-</code> lines.</p>
<h2>Test Plan</h2>
<p>Existing tests plus one new test in <code>ruff_db</code> to isolate a line separator alignment issue</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-26 16:44</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @ntBre on 2025-08-26 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @ntBre on 2025-08-26 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @ntBre on 2025-08-26 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @ntBre on 2025-08-26 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @ntBre on 2025-08-26 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @ntBre on 2025-08-26 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dcreager removed by @ntBre on 2025-08-26 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @ntBre on 2025-08-26 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @ntBre on 2025-08-26 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @ntBre on 2025-08-26 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @ntBre on 2025-08-26 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @ntBre on 2025-08-26 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by @ntBre on 2025-08-26 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-08-28 10:47</div>
            <div class="timeline-body"><p>This looks pretty straightforward change, thanks for taking the time to go through the snapshot changes!</p>
<p>It would be useful for @zanieb to take a brief look as I think they've been heavily involved in the design process.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-08-28 14:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_db/src/diagnostic/render/full.rs</code>:236 on 2025-08-28 14:07</div>
            <div class="timeline-body"><p>I might just say &quot;change behavior&quot;? I guess we could keep &quot;may remove comments&quot; for now, but I'm wary to encode that into the meaning of &quot;unsafe&quot; (I think it's sort of vague these days). The silly part is that we should <em>know</em> if we've dropped a comment, e.g., by inspecting the diff? That's separate work though :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2025-08-28 14:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-08-28 14:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_db/src/diagnostic/render/full.rs</code>:236 on 2025-08-28 14:22</div>
            <div class="timeline-body"><p>Sounds good! Those are the two main criteria in our docs, but it does feel a bit too specific to include in each diagnostic message.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-08-28 14:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-08-28 14:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-28 14:57</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:15:20 UTC
    </footer>
</body>
</html>
