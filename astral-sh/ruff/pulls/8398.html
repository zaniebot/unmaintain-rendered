<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detect and ignore Jupyter automagics - astral-sh/ruff #8398</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Detect and ignore Jupyter automagics</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/8398">#8398</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-10-31 23:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-10-31 23:25</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>LangChain is attempting to use Ruff over their Jupyter notebooks (https://github.com/langchain-ai/langchain/pull/12677/files), but running into a bunch of syntax errors, the majority of which come from our inability to recognize automagic.</p>
<p>If you run this in a cell:</p>
<pre><code class="language-jupyter">pip install requests
</code></pre>
<p>Jupyter will automatically treat that as:</p>
<pre><code class="language-jupyter">%pip install requests
</code></pre>
<p>We need to ignore cells that use these automagics, since the parser doesn't understand them. (I guess we could support it in the parser, but that seems much harder?). The good news is that AFAICT Jupyter doesn't let you mix automagics with code, so by skipping these cells, we don't miss out on analyzing any Python code.</p>
<h2>Test Plan</h2>
<ol>
<li><code>cargo test</code></li>
<li>Ran over LangChain and verified that there are no more errors relating to <code>pip install</code> automagics.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @charliermarsh on 2023-10-31 23:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-10-31 23:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_notebook/src/notebook.rs</code>:196 on 2023-10-31 23:25</div>
            <div class="timeline-body"><p>Obviously some risk of this getting stale but I kind of doubt these change dramatically over time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cli</span> added by @MichaReiser on 2023-10-31 23:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cli</span> removed by @MichaReiser on 2023-10-31 23:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-10-31 23:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_notebook/src/notebook.rs</code>:93 on 2023-10-31 23:31</div>
            <div class="timeline-body"><p>Nit: Trim python whitespace only?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_notebook/src/notebook.rs</code>:117 on 2023-10-31 23:31</div>
            <div class="timeline-body"><p>Nit: Split on whitspace only</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-10-31 23:32</div>
            <div class="timeline-body"><p>LGTM, leaving it to @dhruvmanila, the IPython expert to approve.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-10-31 23:47</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_notebook/src/notebook.rs</code>:93 on 2023-11-01 03:23</div>
            <div class="timeline-body"><p>The <code>trim_start</code> is required because the magics can be at any indentation level but it seems like the logic is different for auto-magics. For example, the following is invalid:</p>
<pre><code class="language-python">if True:
	pwd
</code></pre>
<p>But, then the following is valid:</p>
<pre><code class="language-python">	pwd
# ^^ unnecessary indentation
</code></pre>
<p>I think it's fine to go forward with this as it seems difficult to detect this without the surrounding context.</p>
<img width="666" alt="Screenshot 2023-11-01 at 08 52 43" src="https://github.com/astral-sh/ruff/assets/67177269/f93d96b0-f41c-44d7-9925-ad1787be0489">

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_notebook/src/notebook.rs</code>:196 on 2023-11-01 03:24</div>
            <div class="timeline-body"><p>I agree. There are user defined magics as well but I think that's out of scope ðŸ˜…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_notebook/src/notebook.rs</code>:596 on 2023-11-01 03:27</div>
            <div class="timeline-body"><p>Can we add some additional test cases where there's Python code mixed with auto-magics?</p>
<p>Python code <em>before</em> the auto-magic:</p>
<pre><code class="language-python">x = 1
pwd
</code></pre>
<p>Python code <em>after</em> the auto-magic:</p>
<pre><code class="language-python">pwd
x = 1
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2023-11-01 03:28</div>
            <div class="timeline-body"><p>I think this is a reasonable approach. In the future, we could alter the AST to include the magic command name separately from the rest of the command value. That could be beneficial to have dedicated logic for specific magic command.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-11-01 03:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_notebook/src/notebook.rs</code>:120 on 2023-11-01 03:34</div>
            <div class="timeline-body"><p>There are shell commands listed here as well. Can we add a comment on the source of the possible shell commands here?</p>
<p>Separately, does this list include <em>all</em> of the line and cell magics in the linked documentation (https://ipython.readthedocs.io/en/stable/interactive/magics.html)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-01 03:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_notebook/src/notebook.rs</code>:120 on 2023-11-01 03:35</div>
            <div class="timeline-body"><p>I believe this only applies to line magics, and not cell magics.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-01 03:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_notebook/src/notebook.rs</code>:120 on 2023-11-01 03:37</div>
            <div class="timeline-body"><p>Please correct me if I'm wrong though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-01 03:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_notebook/src/notebook.rs</code>:93 on 2023-11-01 03:40</div>
            <div class="timeline-body"><p>Can we still trim, but only test the first line, rather than all subsequent lines?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-01 04:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_notebook/src/notebook.rs</code>:93 on 2023-11-01 04:43</div>
            <div class="timeline-body"><p>Hmm, we actually run the risk of some false positives here...</p>
<p>For example, I guess we'd now flag <code>alias + 1</code> as an automagic, incorrectly.</p>
<p>We may need to try parsing this cell...? And fall back to automagics?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-11-01 05:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_notebook/src/notebook.rs</code>:120 on 2023-11-01 05:08</div>
            <div class="timeline-body"><p>Yes, you're correct.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-11-01 05:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_notebook/src/notebook.rs</code>:93 on 2023-11-01 05:19</div>
            <div class="timeline-body"><blockquote>
<p>Can we still trim, but only test the first line, rather than all subsequent lines?</p>
</blockquote>
<p>That might risk in not detecting cases where there's Python code <em>before</em> the magic commands.</p>
<blockquote>
<p>For example, I guess we'd now flag <code>alias + 1</code> as an automagic, incorrectly.</p>
</blockquote>
<p>Are you referring <code>alias</code> as a variable name? Yes, that's basically a risk for all escape commands ðŸ˜…</p>
<blockquote>
<p>We may need to try parsing this cell...? And fall back to automagics?</p>
</blockquote>
<p>How would this help?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-11-02 09:14</div>
            <div class="timeline-body"><p><img src="https://github.com/astral-sh/ruff/assets/6826232/202b0284-ee90-4047-b136-1242cdd55241" alt="image" /></p>
<p>:face_with_spiral_eyes:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-03 00:42</div>
            <div class="timeline-body"><p>@dhruvmanila - Thought on this a bit more, and it seems like a reasonable approach for now. If a user <em>does</em> have a cell that consists of code, but starts with a standalone automagic, then the behavior of that cell will vary based on the order in which the cells are executed. So I think it's ok to assume it's an automagic. But I'm definitely open to refinement.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-11-03 01:01</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-11-03 01:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-11-03 01:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-11-03 01:14</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 02:13:16 UTC
    </footer>
</body>
</html>
