<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enable short URLs in the playground - astral-sh/ruff #6383</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Enable short URLs in the playground</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6383">#6383</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-08-07 04:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-07 04:45</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR adds a <a href="https://developers.cloudflare.com/workers/runtime-apis/kv/">Workers KV</a>-based database to the playground, which enables us to associate shared snippets with a stable ID, which in turn allows us to generate short URLs, rather than our existing extremely-long URLs.</p>
<p>For now, the URLs are based on UUID, so they look like https://play.ruff.rs/a1c40d58-f643-4a3e-bc23-15021e16acef. (This URL isn't expected to work, as the playground isn't deployed; it's only included as an example.)</p>
<p>There are no visible changes in the UI here -- you still click the &quot;Share&quot; button, which copies the link to your URL. There's no user-visible latency either -- KV is very fast.</p>
<p>For context, with Workers KV, we provision a Workers KV store in our Cloudflare account (<code>wrangler kv:namespace create &quot;PLAYGROUND&quot;</code>), and then create a Cloudflare Worker that's bound to the KV store via the <code>wrangler.toml</code>:</p>
<pre><code class="language-toml">name = &quot;db&quot;
main = &quot;src/index.ts&quot;
compatibility_date = &quot;2023-08-07&quot;

kv_namespaces = [
  { binding = &quot;PLAYGROUND&quot;, id = &quot;672e16c4fb5e4887845973bf0e9f6021&quot;, preview_id = &quot;0a96477e116540e5a6e1eab6d6e7523e&quot; }
]
</code></pre>
<p>The KV store exists in perpetuity, while the Worker can be updated, deployed, removed, etc. independently of the KV store. The Worker itself has unfettered access to the KV store. The Worker is exposed publicly, and just does some basic verification against the request host.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">playground</span> added by @charliermarsh on 2023-08-07 04:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-07 04:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>playground/db/tsconfig.json</code>:1 on 2023-08-07 04:46</div>
            <div class="timeline-body"><p>(This is generated by <code>wrangler init</code>.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>playground/src/Editor/settings.ts</code>:31 on 2023-08-07 04:48</div>
            <div class="timeline-body"><p>Perhaps this should instead be a truncated hex string of the hash, so that you get a stable URL for a given snippet?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-07 04:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>playground/db/README.md</code>:1 on 2023-08-07 06:29</div>
            <div class="timeline-body"><p>Should we move this into the playground readme or link to it? I don't think I'll be able to find it otherwise.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>playground/db/src/index.ts</code>:36 on 2023-08-07 06:31</div>
            <div class="timeline-body"><p>Could you add some documentation about the supported URL schema? Or / and refactor out the common path (getting the <code>PLAYGROUND</code> env variable and doing some sort of slicing on the pathname (this is where an inline comment would be useful, what's the thing we remove?</p>
<p>Could we use <code>url.hash</code>? (assuming this is what you're slicing off)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>playground/src/Editor/Editor.tsx</code>:103 on 2023-08-07 06:32</div>
            <div class="timeline-body"><p>Nit: Use <code>async</code> <code>await</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>playground/src/Editor/db.ts</code>:1 on 2023-08-07 06:33</div>
            <div class="timeline-body"><p>Nit: Move outside of <code>Editor</code> and/or rename to <code>api</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>playground/src/Editor/db.ts</code>:9 on 2023-08-07 06:33</div>
            <div class="timeline-body"><pre><code class="language-suggestion">  const response = await fetch(`${DB_URL}/${encodeURIComponent(key)}`);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>playground/src/Editor/db.ts</code>:20 on 2023-08-07 06:37</div>
            <div class="timeline-body"><pre><code class="language-suggestion">  const response = await fetch(`${DB_URL}/${encodeURIComponent(key)}`, {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>playground/src/Editor/settings.ts</code>:31 on 2023-08-07 06:39</div>
            <div class="timeline-body"><p>What about hash collisions?</p>
<p>I guess it depends on the desired UX:</p>
<ul>
<li>Should users be able to keep making changes to the linked version even after sharing (and support different versions)</li>
<li>or do we want unique URLs for each possible playgorund.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>playground/src/Editor/db.ts</code>:26 on 2023-08-07 06:40</div>
            <div class="timeline-body"><p>Can we include some details from the response to ease debugging?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-07 06:40</div>
            <div class="timeline-body"><p>Neat. A few follow up questions</p>
<ul>
<li>Do all core contributors have the necessary permissions to log-in to our KV storage?</li>
<li>Does this break existing playgrounds? If so, would it be difficult to continue supporting the old URL format to not break links in issues?</li>
<li>How does the frontend authenticate against the key value storage?</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-07 13:37</div>
            <div class="timeline-body"><blockquote>
<p>Do all core contributors have the necessary permissions to log-in to our KV storage?</p>
</blockquote>
<p>They will, once we add folks to the Cloudflare team. I intentionally created this in the team Cloudflare account rather than my personal :)</p>
<blockquote>
<p>Does this break existing playgrounds? If so, would it be difficult to continue supporting the old URL format to not break links in issues?</p>
</blockquote>
<p>It does break existing playgrounds but I can fix it.</p>
<blockquote>
<p>How does the frontend authenticate against the key value storage?</p>
</blockquote>
<p>So because the site is public facing, I don't know if there's anything we can do that will be completely unspoofable. My plan is to just guard based on the request host in the Worker, so there's at least <em>something</em>. But even an API key would be spoofable. (We should definitely not expose deletions on the public API though.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-07 13:55</div>
            <div class="timeline-body"><blockquote>
<p>They will, once we add folks to the Cloudflare team. I intentionally created this in the team Cloudflare account rather than my personal :)</p>
</blockquote>
<p>I would prefer holding off with this PR until this happened. It otherwise prevents other people from contributing to the playground. Do we have a setup for external contributors?</p>
<blockquote>
<p>So because the site is public facing, I don't know if there's anything we can do that will be completely unspoofable. My plan is to just guard based on the request host in the Worker, so there's at least something. But even an API key would be spoofable. (We should definitely not expose deletions on the public API though.)</p>
</blockquote>
<p>Okay. It would help me if you can add some more context to the PR how this looks deployed (I'm not familiar with CF workers). Do we deploy our own backend and the backend uses a KV store? The question then is how we authenticate against the frontend?</p>
<p>Have you considered using a github gist instead? The nice thing about a gist is that it could also be shareable in issues because it stores separate files for the source and configuraiton.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-07 13:56</div>
            <div class="timeline-body"><blockquote>
<p>I would prefer holding off with this PR until this happened. It otherwise prevents other people from contributing to the playground. Do we have a setup for external contributors?</p>
</blockquote>
<p>Can you describe how this prevents others from contributing to the playground? Why is access to this functionality required to contribute to the playground?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-07 13:58</div>
            <div class="timeline-body"><blockquote>
<p>Can you describe how this prevents others from contributing to the playground? Why is access to this functionality required to contribute to the playground?</p>
</blockquote>
<p>I probably don't understand the architecture. So I don't know. Maybe the question should be different. Can external contributors make changes to the playground without having to set up their own backend (including share functionality)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-07 20:34</div>
            <div class="timeline-body"><blockquote>
<p>I probably don't understand the architecture. So I don't know. Maybe the question should be different. Can external contributors make changes to the playground without having to set up their own backend (including share functionality)?</p>
</blockquote>
<p>The setup no longer requires logging in to Cloudflare for any development. <code>wrangler dev --local</code> runs a local key-value store and persists the data locally.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-08-07 20:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>playground/src/Editor/settings.ts</code>:31 on 2023-08-07 20:44</div>
            <div class="timeline-body"><p>I'd expect the second one for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-07 20:45</div>
            <div class="timeline-body"><blockquote>
<p>Have you considered using a github gist instead? The nice thing about a gist is that it could also be shareable in issues because it stores separate files for the source and configuraiton.</p>
</blockquote>
<p>This is interesting but aren't the local development and auth challenges here much harder, since you'd need a GitHub API key in order to develop locally? I suppose we'd also still need a Worker so that we could deploy the API key to a server rather than making requests from the client directly. Workers and KV are also fast enough that there is no discernible latency vs. using local storage, which is a nice property.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-08-07 20:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>playground/src/Editor/settings.ts</code>:31 on 2023-08-07 20:48</div>
            <div class="timeline-body"><p>I worry about truncated hash collisions though?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-07 20:51</div>
            <div class="timeline-body"><blockquote>
<p>Does this break existing playgrounds? If so, would it be difficult to continue supporting the old URL format to not break links in issues?</p>
</blockquote>
<p>Existing URLs are now supported.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-07 20:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>playground/src/Editor/settings.ts</code>:31 on 2023-08-07 20:56</div>
            <div class="timeline-body"><p>Yeah I think the second one is the correct model. It would perhaps be nice if hitting <code>Share</code> multiple times on the same snippet gave you the same URL though, that's what I meant by &quot;Stable URL&quot; (same content leads to same URL).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-08-07 22:54</div>
            <div class="timeline-body"><ol>
<li>Nothing is persisted until the share button is pressed, correct?</li>
<li>Can we easily egress data from the KV store if we want to switch providers?</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-08 00:28</div>
            <div class="timeline-body"><blockquote>
<p>Nothing is persisted until the share button is pressed, correct?</p>
</blockquote>
<p>Correct.</p>
<blockquote>
<p>Can we easily egress data from the KV store if we want to switch providers?</p>
</blockquote>
<p>Yes, we can paginate over the KV store (list keys) and export the key-value pairs, but it would admittedly require writing some kind of script to do the export itself (e.g. https://github.com/stevenpack/cloudflare-workers-kv-export).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2023-08-08 06:51</div>
            <div class="timeline-body"><p>The code changes look good to me. I would find a short note saying that we now have a backend service (maybe call it <code>api</code> rather than <code>db</code> because the db is the key value store) useful.</p>
<p>We should also look into how we want to protect the API endpoint. At least deploy what cloudflare gives us to avoid trivial attacks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>playground/src/Editor/settings.ts</code>:31 on 2023-08-08 07:45</div>
            <div class="timeline-body"><p>What I like about <a href="https://astexplorer.net/">astexplorer.net </a> is that the workflow is explicit about when it creates a new gist vs updating the existing one.</p>
<p>The <a href="https://play.rust-lang.org/">Rust playground</a> creates a new gist whenever you hit save. (Gists everywhere)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-08 07:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-09 02:40</div>
            <div class="timeline-body"><blockquote>
<p>I would find a short note saying that we now have a backend service (maybe call it api rather than db because the db is the key value store) useful.</p>
</blockquote>
<p>I expanded in the README, but let me know if I'm misinterpreting the request.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>playground/README.md</code>:26 on 2023-08-09 06:59</div>
            <div class="timeline-body"><p>Thanks, that helps. It wasn't clear to me in the first version that we have a worker sitting between the database and KV.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>playground/api/README.md</code>:1 on 2023-08-09 07:00</div>
            <div class="timeline-body"><p>API?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>playground/api/src/index.ts</code>:26 on 2023-08-09 07:01</div>
            <div class="timeline-body"><p>Should we be more restrictive?</p>
<p>https://developers.cloudflare.com/workers/examples/security-headers/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>playground/src/Editor/db.ts</code>:11 on 2023-08-09 07:05</div>
            <div class="timeline-body"><p>Should this return an <code>Error</code> similar to <code>set</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>playground/src/Editor/db.ts</code>:7 on 2023-08-09 07:07</div>
            <div class="timeline-body"><p>This is a bit abstract (same as the <code>get/set</code> method names). I would be leaning towards more specific method names (given a playground id, restores the playground state) and for set, given the playground state, persists the state and returns the key.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-08-09 07:07</div>
            <div class="timeline-body"><p>Looks good. Please take a look at the error handling in <code>db.ts</code> and grant the team permission to cloudflare.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-09 11:45</div>
            <div class="timeline-body"><p>I thought about the hash collision problem a bit more and think it would be good to make the API less generic, so that it can act more intelligently. We don't need to do this as part of this PR but I think it is a worthwhile improvement:</p>
<ul>
<li>Change the POST (should probably be PUT) API to accept the playground state as JSON payload</li>
<li>The API generates a key based on the payload and tries to get an entry with the key<ul>
<li>If an existing entry is present<ul>
<li>If the payload is identical, return the key</li>
<li>Otherwise add a <code>-{i}</code> or similar to the input before re-hashing the data. Retry</li>
</ul>
</li>
<li>If no entry exists, create it</li>
</ul>
</li>
<li>Return the key</li>
</ul>
<p>This still leaves the risk of a race, but this is extremely unlikely (needs a hash collision + race).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-09 13:22</div>
            <div class="timeline-body"><p>I’m happy to make the IDs content-addressed as described, but I don’t know that I feel the need to design around hash collisions. We can just use the full SHA if we want, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-09 17:45</div>
            <div class="timeline-body"><blockquote>
<p>I’m happy to make the IDs content-addressed as described, but I don’t know that I feel the need to design around hash collisions. We can just use the full SHA if we want, right?</p>
</blockquote>
<p>Thank's for pushing back. I'm sometimes too fast with my ideas. I forgot that we're using uuid keys, and the likelihood of a uuid collision is extremely low. Moving the uuid generation to the server (and returning it rather than having the client provide it) could be a nice change because it allows us to drop the <code>uuid</code> dependency from the frontend code. Adding a loop to testing for uuid collisions is straightforward but probably not worth the effort. So we could keep the API as is  (client provides a content string), except that the server computes the id</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-09 23:28</div>
            <div class="timeline-body"><p>Sounds good. Do you have a preference between (1) server generates a UUID, or (2) server hashes the contents and returns the full SHA as the ID? (The latter would mean that we return the same URL given the same playground contents, which is a nice property, but isn't fully required.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-10 06:08</div>
            <div class="timeline-body"><blockquote>
<p>Sounds good. Do you have a preference between (1) server generates a UUID, or (2) server hashes the contents and returns the full SHA as the ID? (The latter would mean that we return the same URL given the same playground contents, which is a nice property, but isn't fully required.)</p>
</blockquote>
<p>UUID seems simpler but I don't have a strong preference. And changing it later is easy enough.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-08-11 02:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-08-11 02:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-08-11 02:31</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 02:52:41 UTC
    </footer>
</body>
</html>
