<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add a diagnostic for prohibited `NamedTuple` attribute overrides - astral-sh/ruff #21717</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add a diagnostic for prohibited <code>NamedTuple</code> attribute overrides</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21717">#21717</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2025-12-01 02:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Closes https://github.com/astral-sh/ty/issues/1684.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @charliermarsh on 2025-12-01 02:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @charliermarsh on 2025-12-01 02:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @charliermarsh on 2025-12-01 02:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @charliermarsh on 2025-12-01 02:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @charliermarsh on 2025-12-01 02:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-01 02:53</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-01 02:55</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">scikit-build-core (https://github.com/scikit-build/scikit-build-core)
- src/scikit_build_core/_logging.py:153:13: warning[unsupported-base] Unsupported class base with type `&lt;class 'Mapping[str, Style]'&gt; | &lt;class 'Mapping[str, Divergent]'&gt;`
- src/scikit_build_core/build/_pathutil.py:25:38: error[invalid-argument-type] Argument to function `__new__` is incorrect: Expected `str | PathLike[str]`, found `DirEntry[Path]`
- src/scikit_build_core/build/_pathutil.py:27:24: error[invalid-argument-type] Argument to function `__new__` is incorrect: Expected `str | PathLike[str]`, found `DirEntry[Path]`
- src/scikit_build_core/build/wheel.py:98:20: error[no-matching-overload] No overload of bound method `__init__` matches arguments
- Found 45 diagnostics
+ Found 41 diagnostics

pandas-stubs (https://github.com/pandas-dev/pandas-stubs)
- pandas-stubs/_typing.pyi:1207:16: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 5815 diagnostics
+ Found 5814 diagnostics

pydantic (https://github.com/pydantic/pydantic)
- pydantic/fields.py:943:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
+ pydantic/fields.py:943:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
- pydantic/fields.py:983:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
+ pydantic/fields.py:983:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
- pydantic/fields.py:1026:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
+ pydantic/fields.py:1026:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
- pydantic/fields.py:1066:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
+ pydantic/fields.py:1066:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
- pydantic/fields.py:1109:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
+ pydantic/fields.py:1109:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
- pydantic/fields.py:1148:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
+ pydantic/fields.py:1148:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
- pydantic/fields.py:1188:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
+ pydantic/fields.py:1188:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
- pydantic/fields.py:1567:13: error[invalid-argument-type] Argument is incorrect: Expected `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`, found `Top[dict[Unknown, Unknown]] | (((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) &amp; ~Top[dict[Unknown, Unknown]]) | None`
+ pydantic/fields.py:1567:13: error[invalid-argument-type] Argument is incorrect: Expected `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`, found `Top[dict[Unknown, Unknown]] | (((dict[str, Divergent], /) -&gt; None) &amp; ~Top[dict[Unknown, Unknown]]) | None`


</code></pre>
</details>

<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Add a diagnostic for prohibited `NamedTuple` attribute overrides" to "[ty] Add a diagnostic for prohibited `NamedTuple` attribute overrides" by @AlexWaygood on 2025-12-01 09:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-12-01 09:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/diagnostic.rs</code>:1817 on 2025-12-01 18:42</div>
            <div class="timeline-body"><p>is it worth adding a new error code just for this, or would it be better to reuse the <code>invalid-named-tuple</code> error code? The name of the new error code seems <em>very</em> long... and I'm not sure I can think of a situation where a user would want to e.g. enable one error code spotting ways namedtuple class creation might fail, but disable another error code that also spots ways namedtuple class creation might fail.</p>
<p>The examples are nice though; we could add those for sure!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/overrides.rs</code>:372 on 2025-12-01 18:49</div>
            <div class="timeline-body"><p>I think you can simplify this (and optimise slightly), e.g.</p>
<pre><code class="language-diff">diff --git a/crates/ty_python_semantic/src/types/overrides.rs b/crates/ty_python_semantic/src/types/overrides.rs
index f4bd5fc6cd..46016541ac 100644
--- a/crates/ty_python_semantic/src/types/overrides.rs
+++ b/crates/ty_python_semantic/src/types/overrides.rs
@@ -56,12 +56,6 @@ pub(super) fn check_class&lt;'db&gt;(context: &amp;InferContext&lt;'db, '_&gt;, class: ClassLite
     let own_class_members: FxHashSet&lt;_&gt; =
         all_declarations_and_bindings(db, class.body_scope(db)).collect();
 
-    if configuration.check_prohibited_named_tuple_attrs()
-        &amp;&amp; CodeGeneratorKind::NamedTuple.matches(db, class, None)
-    {
-        check_prohibited_namedtuple_attrs(context, &amp;own_class_members);
-    }
-
     for member in own_class_members {
         check_class_declaration(context, configuration, class_specialized, &amp;member);
     }
@@ -152,6 +146,27 @@ fn check_class_declaration&lt;'db&gt;(
     let (literal, specialization) = class.class_literal(db);
     let class_kind = CodeGeneratorKind::from_class(db, literal, specialization);
 
+    // Check for prohibited `NamedTuple` attribute overrides.
+    //
+    // `NamedTuple` classes have certain synthesized attributes (like `_asdict`, `_make`, etc.)
+    // that cannot be overwritten. Attempting to assign to these attributes (without type
+    // annotations) or define methods with these names will raise an `AttributeError` at runtime.
+    if class_kind == Some(CodeGeneratorKind::NamedTuple)
+        &amp;&amp; configuration.check_prohibited_named_tuple_attrs()
+        &amp;&amp; PROHIBITED_NAMEDTUPLE_ATTRS.contains(&amp;member.name.as_str())
+        &amp;&amp; !matches!(definition.kind(db), DefinitionKind::AnnotatedAssignment(_))
+        &amp;&amp; let Some(builder) = context.report_lint(
+            &amp;OVERRIDE_OF_PROHIBITED_NAMED_TUPLE_ATTRIBUTE,
+            definition.focus_range(db, context.module()),
+        )
+    {
+        let mut diagnostic = builder.into_diagnostic(format_args!(
+            &quot;Cannot overwrite NamedTuple attribute `{}`&quot;,
+            &amp;member.name
+        ));
+        diagnostic.info(&quot;This will cause the class creation to fail at runtime&quot;);
+    }
+
     let mut subclass_overrides_superclass_declaration = false;
     let mut has_dynamic_superclass = false;
     let mut has_typeddict_in_mro = false;
@@ -361,43 +376,6 @@ fn check_class_declaration&lt;'db&gt;(
     }
 }
 
-/// Check for prohibited `NamedTuple` attribute overrides.
-///
-/// `NamedTuple` classes have certain synthesized attributes (like `_asdict`, `_make`, etc.)
-/// that cannot be overwritten. Attempting to assign to these attributes (without type
-/// annotations) or define methods with these names will raise an `AttributeError` at runtime.
-fn check_prohibited_namedtuple_attrs&lt;'db&gt;(
-    context: &amp;InferContext&lt;'db, '_&gt;,
-    own_class_members: &amp;FxHashSet&lt;MemberWithDefinition&lt;'db&gt;&gt;,
-) {
-    let db = context.db();
-    let module = context.module();
-
-    for member in own_class_members {
-        if !PROHIBITED_NAMEDTUPLE_ATTRS.contains(&amp;member.member.name.as_str()) {
-            continue;
-        }
-
-        let Some(definition) = member.definition else {
-            continue;
-        };
-
-        // Only annotated assignments are allowed (they become fields).
-        // Everything else (assignments, method definitions, etc.) is an error.
-        if !matches!(definition.kind(db), DefinitionKind::AnnotatedAssignment(_)) {
-            if let Some(builder) = context.report_lint(
-                &amp;OVERRIDE_OF_PROHIBITED_NAMED_TUPLE_ATTRIBUTE,
-                definition.full_range(db, module),
-            ) {
-                builder.into_diagnostic(format_args!(
-                    &quot;Cannot overwrite NamedTuple attribute `{}`&quot;,
-                    member.member.name
-                ));
-            }
-        }
-    }
-}
-
 #[derive(Debug, Clone, Copy, PartialEq, Eq, Default)]
 pub(super) enum MethodKind&lt;'db&gt; {
     Synthesized(CodeGeneratorKind&lt;'db&gt;),
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/overrides.rs</code>:390 on 2025-12-01 18:49</div>
            <div class="timeline-body"><p>we should use <code>.focus_range()</code> here rather than <code>.full_range()</code> -- the full range might be huge!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-12-01 18:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-12-02 01:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ty_python_semantic/src/types/diagnostic.rs</code>:1817 on 2025-12-02 01:23</div>
            <div class="timeline-body"><p>Makes sense, will consolidate.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2025-12-02 02:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-12-02 02:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-12-02 02:47</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:17:41 UTC
    </footer>
</body>
</html>
