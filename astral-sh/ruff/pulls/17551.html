<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Emit a diagnostic if a non-protocol is passed to `get_protocol_members` - astral-sh/ruff #17551</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Emit a diagnostic if a non-protocol is passed to <code>get_protocol_members</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17551">#17551</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-04-22 13:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-22 13:55</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Passing a non-protocol class to <code>get_protocol_members</code> fails at runtime. This PR adds logic to red-knot so that we detect that error and warn the user about it.</p>
<p>Stacked on top of #17550</p>
<h2>Test Plan</h2>
<p>Existing mdtests updated and extended. Snapshots added!</p>
<p>Screenshot of what the diagnostics look like in the terminal:
<img src="https://github.com/user-attachments/assets/3298df31-f612-4215-a1f4-55f264056328" alt="image" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-04-22 13:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-04-22 13:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-04-22 13:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @AlexWaygood on 2025-04-22 13:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-22 14:02</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-22 14:14</div>
            <div class="timeline-body"><p>I don't know why the ruff (not red-knot!) ecosystem check is failing, but it doesn't seem related to this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-04-22 14:25</div>
            <div class="timeline-body"><blockquote>
<p>I don't know why the ruff (not red-knot!) ecosystem check is failing, but it doesn't seem related to this PR.</p>
</blockquote>
<p>It's because you're using stacked PRs, once the PR that's below this one has the ecosystem check completed, you can re-run here so that it can find the base ecosystem report which would be part of that PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-22 16:53</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>I don't know why the ruff (not red-knot!) ecosystem check is failing, but it doesn't seem related to this PR.</p>
</blockquote>
<p>It's because you're using stacked PRs, once the PR that's below this one has the ecosystem check completed, you can re-run here so that it can find the base ecosystem report which would be part of that PR.</p>
</blockquote>
<p>Hrm, I've tried rerunning the job several times now (and the PR below this one has definitely completed its CI!).</p>
<p>I think it's possibly because the PR below this one (#17550) had the Linux build skipped entirely in its CI run? I'm not sure why -- PRs that only change <code>.md</code> files don't seem to have any tests run on them right now, which is sorta problematic for red-knot PRs ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-04-22 17:01</div>
            <div class="timeline-body"><blockquote>
<p>I think it's possibly because the PR below this one (#17550) had the Linux build skipped entirely in its CI run?</p>
</blockquote>
<p>Ah, yeah that's probably the case. The Ruff ecosystem checks needs a base report to compare against. This is usually from <code>main</code> but as this is a stacked PR, it'll fetch it from the previous PR (which is correct) but that doesn't exists and so this workflow fails.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/snapshots/protocols.md_-_Protocols_-_Invalid_calls_to_`get_protocol_members()`.snap</code>:80 on 2025-04-22 19:39</div>
            <div class="timeline-body"><p>it's kinda weird to link to the typing spec here, as it's not designed as user-facing documentation. But the typing-module docs don't go into the details here; PEP 544 is a snapshot of a decision that was taken years ago rather than up-to-date documentation; and it feels like an admission of defeat to link to the mypy docs ðŸ˜† I think the typing spec is maybe the least bad option</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-22 19:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-04-22 20:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/red_knot_python_semantic/resources/mdtest/snapshots/protocols.md_-_Protocols_-_Invalid_calls_to_`get_protocol_members()`.snap</code>:80 on 2025-04-22 20:55</div>
            <div class="timeline-body"><blockquote>
<p>it feels like an admission of defeat to link to the mypy docs ðŸ˜†</p>
</blockquote>
<p>That suggests that the ideal solution is to eventually describe this in our own (public-facing) documentation. So I think linking to the typing spec is fine as a placeholder, maybe with a TODO comment in the code to update it to the public docs once they're written.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-22 21:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/snapshots/protocols.md_-_Protocols_-_Invalid_calls_to_`get_protocol_members()`.snap</code>:80 on 2025-04-22 21:01</div>
            <div class="timeline-body"><p>Yes. Or for us to invest resources into improving type-checker-agnostic docs for <code>Protocol</code>! A TODO here sounds like a good idea whatever the case, though (I'll add tomorrow; it's late here)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/diagnostic.rs</code>:1360 on 2025-04-22 23:57</div>
            <div class="timeline-body"><p>This is a lovely diagnostic, and a great example for what we can be doing with the new diagnostic framework in other cases -- but it's also a lot of code for an extremely narrow case (misuse of one specific function)! Not really suggesting we change anything here, just not sure it will be worth investing this much in every narrow edge-case diagnostic...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-04-22 23:59</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-23 10:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/diagnostic.rs</code>:1360 on 2025-04-23 10:06</div>
            <div class="timeline-body"><p>Yeah, I know what you mean.</p>
<p>I think there might be ways to make the diagnostic APIs a little less verbose? The code here isn't that complicated, just a little boilerplate-y. And I think the way you get a reputation for having &quot;excellent error messages&quot; like rustc is by paying attention to lots of little details like this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-04-23 10:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-04-23 10:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-23 10:13</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:33:29 UTC
    </footer>
</body>
</html>
