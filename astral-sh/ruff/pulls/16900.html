<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Do not emit `invalid-return-type` for abstract functions - astral-sh/ruff #16900</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Do not emit <code>invalid-return-type</code> for abstract functions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16900">#16900</a>
        opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a>
        on 2025-03-21 16:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a></div>
            <div class="timeline-body">Summary
<p>Resolves #16895.</p>
<p><code>abstractmethod</code> is now a <code>KnownFunction</code>. When a function is decorated by <code>abstractmethod</code> or when the parent class inherits directly from <code>Protocol</code>, <code>invalid-return-type</code> won&#x27;t be emitted for that function.</p>
Test Plan
<p>Markdown tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-03-21 16:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-03-21 16:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-03-21 16:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-03-21 16:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-21 16:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-21 16:20</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>packaging (https://github.com/pypa/packaging)
- error[lint:invalid-return-type] /tmp/mypy_primer/projects/packaging/src/packaging/specifiers.py:46:26: Function can implicitly return `None`, which is not assignable to return type `str`
- error[lint:invalid-return-type] /tmp/mypy_primer/projects/packaging/src/packaging/specifiers.py:53:27: Function can implicitly return `None`, which is not assignable to return type `int`
- error[lint:invalid-return-type] /tmp/mypy_primer/projects/packaging/src/packaging/specifiers.py:59:40: Function can implicitly return `None`, which is not assignable to return type `bool`
- error[lint:invalid-return-type] /tmp/mypy_primer/projects/packaging/src/packaging/specifiers.py:84:71: Function can implicitly return `None`, which is not assignable to return type `bool`
- Found 141 diagnostics
+ Found 137 diagnostics

pyinstrument (https://github.com/joerick/pyinstrument)
- error[lint:invalid-return-type] /tmp/mypy_primer/projects/pyinstrument/pyinstrument/frame.py:47:42: Function can implicitly return `None`, which is not assignable to return type `str`
- Found 288 diagnostics
+ Found 287 diagnostics

rich (https://github.com/Textualize/rich)
- error[lint:invalid-return-type] /tmp/mypy_primer/projects/rich/rich/console.py:264:10: Function can implicitly return `None`, which is not assignable to return type `ConsoleRenderable | RichCast | str`
- error[lint:invalid-return-type] /tmp/mypy_primer/projects/rich/rich/console.py:562:10: Function can implicitly return `None`, which is not assignable to return type `list`
- error[lint:invalid-return-type] /tmp/mypy_primer/projects/rich/rich/layout.py:86:32: Function can implicitly return `None`, which is not assignable to return type `str`
- Found 589 diagnostics
+ Found 586 diagnostics

</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-21 16:22</div>
            <div class="timeline-body"><p>I don&#x27;t know if we want to support <code>abstractproperty</code>, <code>abstractclassmethod</code> and <code>abstractstaticmethod</code>. They&#x27;ve all been deprecated for many Python releases, and are unsupported by both mypy and pyright. The support you&#x27;re adding for them in this PR isn&#x27;t too much added complexity, but I suspect that full support for these decorators might be a significant amount of complexity. It will be less confusing for users if we don&#x27;t support them at all rather than partially supporting them.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-03-21 16:47</div>
            <div class="timeline-body"><p>Glad to hear that! Reverted.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-21 16:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1230 on 2025-03-21 16:52</div>
            <div class="timeline-body"><p>Nit: We don&#x27;t need to get the <code>ScopeId</code> here because we know that all scopes are from the same file (this is slightly faster)</p>
<pre><code>                let current_scope_id = self.scope().file_scope_id(self.db());
                let current_scope = self.index.scope(current_scope_id);

                let Some(parent_scope_id) = current_scope.parent() else {
                    return false;
                };
                let parent_scope = self.index.scope(parent_scope_id);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-21 16:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1251 on 2025-03-21 16:53</div>
            <div class="timeline-body"><p>Can you add a test where the class uses a type parameters and, because of that, has one extra scope</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-03-21 17:08</div>
            <div class="timeline-body"><p>Should we add a test for &quot;Function can implicitly return <code>None</code>, which is not assignable to return type <code>{}</code>&quot; is emitted when you have a function with no body outside of class</p>
<pre><code># error: [invalid-return-type] &quot;Function can implicitly return `None`, which is not assignable to return type `int`&quot;
def f(self) -&gt; int: ...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-03-21 18:48</div>
            <div class="timeline-body"><p>This looks great to me -- thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1251 on 2025-03-21 19:14</div>
            <div class="timeline-body"><p>I think the test you added using a legacy <code>TypeVar</code> is useful because it shows that this code doesn&#x27;t understand inheritance from <code>Protocol[T]</code> as creating a protocol class. But I think @MichaReiser&#x27;s comment was aimed in a slightly different direction. New-style (PEP 695) generics create an extra nested type-params scope wrapping the function body or class body scope, which will confuse code like this that tries to walk up a fixed number of expected scopes. Thus I think we should test both of these cases:</p>
<pre><code>class GenericProto[T](Protocol[T]):
    def f(self) -&gt; int: ...

class ProtoWithGenericMethod(Protocol):
    def f[T](self, x: T) -&gt; T: ...
</code></pre>
<p>I suspect that the first case is already correctly finding the class node (because of the use of <code>parent_scope.node()</code> which already bypasses the nested type-params scope for the class), but will still not work yet for the same reason that the legacy-TypeVar test doesn&#x27;t work (we don&#x27;t understand inheriting <code>Protocol[T]</code> as creating a generic protocol.) I think it&#x27;s fine for this to remain a TODO pending generic protocol support.</p>
<p>I suspect the latter case will not work because we will identify the wrong <code>parent_scope</code> (due to the nested type-params scope in between the class scope and the body scope of <code>f</code>). I think this is important to fix before we land this code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1259 on 2025-03-21 19:43</div>
            <div class="timeline-body"><p>In terms of API, rather than doing all this right here in type inference, I think we should have methods <code>Class::is_protocol() -&gt; bool</code> and <code>FunctionType::enclosing_class() -&gt; Option&lt;Class&lt;&#x27;db&gt;&gt;</code>.</p>
<p>In terms of how those methods are implemented, I did wonder about an alternate strategy that would record the enclosing-class information for each function in semantic indexing. This would imply that <code>DefinitionKind::Function</code> would include an <code>Option&lt;FileScopeId&gt;</code> which is the body scope of the lexically enclosing class.</p>
<p>But I&#x27;m not sure this is really better; it would require extra work in semantic indexing to maintain the &quot;enclosing class&quot; state and clear it appropriately (that is, nested functions inside methods are not themselves methods and should have no enclosing class), and I think the scope-walking code you have here can be made fully correct without too much difficulty.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-03-21 19:43</div>
            <div class="timeline-body"><p>Thank you, this is a nice improvement!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-03-21 19:47</div>
            <div class="timeline-body"><blockquote>
<p>Should we add a test for &quot;Function can implicitly return <code>None</code>, which is not assignable to return type <code>{}</code>&quot; is emitted when you have a function with no body outside of class</p>
</blockquote>
<p>I think we should test this, but it seems orthogonal to this PR. If we are lacking a test for this and you want to submit a PR to add it, that would be great!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-03-23 14:08</div>
            <div class="timeline-body"><p>Added tests look good! I would still like to see us break up the mass of the new added code by extracting some reusable and meaningfully-named functions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-03-23 17:00</div>
            <div class="timeline-body"><p>@carljm <code>FunctionType::enclosing_class()</code> seems unhelpful here, since <code>infer_function_body()</code> is trying to figure out that type in the first place. Am I missing something?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-03-23 17:46</div>
            <div class="timeline-body"><blockquote>
<p><code>FunctionType::enclosing_class()</code> seems unhelpful here, since <code>infer_function_body()</code> is trying to figure out that type in the first place. Am I missing something?</p>
</blockquote>
<p><code>infer_function_body</code> is not part of figuring out the <code>FunctionType</code>; checking the function body is separate and only done on demand. So it would be possible to get the <code>FunctionType</code> here by looking up the function <code>Definition</code> and querying its type. But you&#x27;re right that it may not be the simplest / most ergonomic thing.</p>
<p>My other concern is that we should let <code>Class</code> keep responsibility for interpreting the types of its bases, rather than having ad-hoc code in various places looking directly at the base class elements in the AST. But I&#x27;m fine with just adding a TODO for that for now, since it will be natural to do it when actually adding <code>Protocol</code> support.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-03-23 17:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1254 on 2025-03-23 17:47</div>
            <div class="timeline-body"><pre><code>                // TODO move this to `Class` once we add proper `Protocol` support
                node_ref.bases().iter().any(|base| {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-03-23 17:48</div>
            <div class="timeline-body"><p>Still halfway tempted to move &quot;find the enclosing class&quot; logic to <code>Scope</code>, but I think we can wait on that until/unless we have a second or third use case for the same logic. (I think it initially struck me as duplication because we had this same code previously, but I think the previous occurrence of it was removed in favor of storing the &quot;defining node&quot; of a scope in the scope itself.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-03-23 17:49</div>
            <div class="timeline-body"><p>Thanks for the PR!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/carljm">@carljm</a> on 2025-03-23 17:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2025-03-23 17:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-03-23 17:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-03-23 20:53</div>
            <div class="timeline-body"><p>Ok, I found where I had seen this is-method-of-class logic before, and we still have it (and it&#x27;s currently wrong). See <a href="https://github.com/astral-sh/ruff/issues/16928">astral-sh/ruff#16928</a></p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:12:31 UTC
    </footer>
</body>
</html>
