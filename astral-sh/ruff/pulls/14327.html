<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`ruff`] Also report problems for `attrs` dataclasses in preview mode (`RUF008`, `RUF009`) - astral-sh/ruff #14327</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>ruff</code>] Also report problems for <code>attrs</code> dataclasses in preview mode (<code>RUF008</code>, <code>RUF009</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14327">#14327</a>
        opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a>
        on 2024-11-14 00:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Resolves #9757.</p>
<h2>Test Plan</h2>
<p><code>cargo nextest run</code> and <code>cargo insta test</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-14 00:20</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+8 -6 violations, +0 -0 fixes in 1 projects; 53 projects unchanged)</p>
<details><summary><a href="https://github.com/apache/airflow">apache/airflow</a> (+8 -6 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/apache/airflow/blob/61076f0ab57feda67ab4d013ed41365774be9bbd/airflow/lineage/entities.py#L64'>airflow/lineage/entities.py:64:23:</a> RUF008 Do not use mutable default values for dataclass attributes
- <a href='https://github.com/apache/airflow/blob/61076f0ab57feda67ab4d013ed41365774be9bbd/airflow/lineage/entities.py#L64'>airflow/lineage/entities.py:64:23:</a> RUF012 Mutable class attributes should be annotated with `typing.ClassVar`
+ <a href='https://github.com/apache/airflow/blob/61076f0ab57feda67ab4d013ed41365774be9bbd/airflow/lineage/entities.py#L86'>airflow/lineage/entities.py:86:23:</a> RUF008 Do not use mutable default values for dataclass attributes
- <a href='https://github.com/apache/airflow/blob/61076f0ab57feda67ab4d013ed41365774be9bbd/airflow/lineage/entities.py#L86'>airflow/lineage/entities.py:86:23:</a> RUF012 Mutable class attributes should be annotated with `typing.ClassVar`
+ <a href='https://github.com/apache/airflow/blob/61076f0ab57feda67ab4d013ed41365774be9bbd/airflow/lineage/entities.py#L88'>airflow/lineage/entities.py:88:29:</a> RUF008 Do not use mutable default values for dataclass attributes
- <a href='https://github.com/apache/airflow/blob/61076f0ab57feda67ab4d013ed41365774be9bbd/airflow/lineage/entities.py#L88'>airflow/lineage/entities.py:88:29:</a> RUF012 Mutable class attributes should be annotated with `typing.ClassVar`
+ <a href='https://github.com/apache/airflow/blob/61076f0ab57feda67ab4d013ed41365774be9bbd/airflow/lineage/entities.py#L89'>airflow/lineage/entities.py:89:26:</a> RUF008 Do not use mutable default values for dataclass attributes
- <a href='https://github.com/apache/airflow/blob/61076f0ab57feda67ab4d013ed41365774be9bbd/airflow/lineage/entities.py#L89'>airflow/lineage/entities.py:89:26:</a> RUF012 Mutable class attributes should be annotated with `typing.ClassVar`
+ <a href='https://github.com/apache/airflow/blob/61076f0ab57feda67ab4d013ed41365774be9bbd/airflow/lineage/entities.py#L90'>airflow/lineage/entities.py:90:29:</a> RUF008 Do not use mutable default values for dataclass attributes
- <a href='https://github.com/apache/airflow/blob/61076f0ab57feda67ab4d013ed41365774be9bbd/airflow/lineage/entities.py#L90'>airflow/lineage/entities.py:90:29:</a> RUF012 Mutable class attributes should be annotated with `typing.ClassVar`
+ <a href='https://github.com/apache/airflow/blob/61076f0ab57feda67ab4d013ed41365774be9bbd/airflow/models/dag.py#L433'>airflow/models/dag.py:433:25:</a> RUF009 Do not perform function call in dataclass defaults
+ <a href='https://github.com/apache/airflow/blob/61076f0ab57feda67ab4d013ed41365774be9bbd/airflow/models/dag.py#L434'>airflow/models/dag.py:434:24:</a> RUF009 Do not perform function call `airflow_conf.get_mandatory_value` in dataclass defaults
+ <a href='https://github.com/apache/airflow/blob/61076f0ab57feda67ab4d013ed41365774be9bbd/providers/src/airflow/providers/papermill/operators/papermill.py#L41'>providers/src/airflow/providers/papermill/operators/papermill.py:41:31:</a> RUF008 Do not use mutable default values for dataclass attributes
- <a href='https://github.com/apache/airflow/blob/61076f0ab57feda67ab4d013ed41365774be9bbd/providers/src/airflow/providers/papermill/operators/papermill.py#L41'>providers/src/airflow/providers/papermill/operators/papermill.py:41:31:</a> RUF012 Mutable class attributes should be annotated with `typing.ClassVar`
</pre>

</p>
</details>
<details><summary>Changes by rule (3 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| RUF008 | 6 | 6 | 0 | 0 | 0 |
| RUF012 | 6 | 0 | 6 | 0 | 0 |
| RUF009 | 2 | 2 | 0 | 0 | 0 |</p>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-11-14 01:05</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/InSyncWithFoo:RUF008">CodSpeed Performance Report</a></h2>
<h3>Merging #14327 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>InSyncWithFoo:RUF008</code> (a958a82) with <code>main</code> (9a3001b)</sub></p>
<h3>Summary</h3>
<p><code>✅ 32</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @MichaReiser on 2024-11-14 08:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-14 08:11</div>
            <div class="timeline-body"><p>@AlexWaygood would you mind taking a look at this rule. I don't have the necessary context about what it changes to review it.</p>
<p>I do think that we should make this a preview-only change because it increases the rule's scope.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MichaReiser on 2024-11-14 08:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-11-14 15:07</div>
            <div class="timeline-body"><p>Thanks @InSyncWithFoo, this is great! I pushed some changes:</p>
<ul>
<li>Optimised it a bit by adding some tracking to the semantic model of whether <code>attrs</code> has been imported or not</li>
<li>Consolidated the logic in the <code>rules::ruff::helpers</code> module</li>
<li>Made the change preview-only for now, since it increases the scope of the rule.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @AlexWaygood on 2024-11-14 15:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`ruff`] Also report problems for `attrs` dataclasses (`RUF008`, `RUF009`)" to "[`ruff`] Also report problems for `attrs` dataclasses in preview mode (`RUF008`, `RUF009`)" by @AlexWaygood on 2024-11-14 15:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2024-11-14 15:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-11-14 15:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-14 18:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pwuertz">@pwuertz</a> on 2024-11-16 00:35</div>
            <div class="timeline-body"><p>Note that <code>RUF009</code> can be a bit misleading when <code>auto_attribs=False</code> (or with older <code>attr.s</code> codebases):</p>
<pre><code class="language-python">import attrs

@attrs.define(auto_attribs=False)
class X:
    a_field: int = attrs.field(default=42)
    not_a_field: list = (lambda: [])()
#                       ^^^^^^^^^^^^^^ RUF009 Do not perform function call in dataclass defaults
</code></pre>
<p>Without <code>auto_attribs</code>, <code>not_a_field</code> can't possibly be a  <code>dataclass</code> field. In this example, it's an incorrectly typed class variable. Fixing the typing error also fixes the <code>RUF009</code> warning:</p>
<pre><code class="language-python">@attrs.define(auto_attribs=False)
class X:
    a_field: int = attrs.field(default=42)
    not_a_field: typing.ClassVar[list] = (lambda: [])()
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pwuertz">@pwuertz</a> on 2024-11-16 00:53</div>
            <div class="timeline-body"><p>This is an issue though when using <code>attrs.field</code> wrappers:</p>
<pre><code class="language-python">def my_field():
    return attrs.field(default=42, metadata={&quot;my_metadata&quot;: 42})


@attrs.define(auto_attribs=False)
class X:
    a_field: int = my_field()
#                  ^^^^^^^^^^ RUF009 Do not perform function call `my_field` in dataclass defaults
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-11-16 02:19</div>
            <div class="timeline-body"><p>@pwuertz I'll work on a fix. Could you open a new issue with all the details, please?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ashb">@ashb</a> on 2025-03-04 10:22</div>
            <div class="timeline-body"><p>I can't get this working, even on 0.9.0 which was when this was merged:</p>
<pre><code>❯ cat tst.py
import attrs

@attrs.deinfe
class B :
    mutable_default: list[int] = []
    mutable_default2: list[int] = attrs.field(default=[])

❯ uvx ruff@0.9.0 check --extend-select RUF008,B006 --preview -n --isolated  tst.py
All checks passed!
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-04 10:26</div>
            <div class="timeline-body"><blockquote>
<p>I can't get this working, even on 0.9.0 which was when this was merged:</p>
<pre><code>❯ cat tst.py
import attrs

@attrs.deinfe
class B :
    mutable_default: list[int] = []
    mutable_default2: list[int] = attrs.field(default=[])

❯ uvx ruff@0.9.0 check --extend-select RUF008,B006 --preview -n --isolated  tst.py
All checks passed!
</code></pre>
</blockquote>
<p>Please open a new issue. It makes it easier to help and allows other users to find it too</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:07:42 UTC
    </footer>
</body>
</html>
