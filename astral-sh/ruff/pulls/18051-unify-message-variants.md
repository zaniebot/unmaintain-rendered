```yaml
number: 18051
title: "Unify `Message` variants"
type: pull_request
state: merged
author: ntBre
labels:
  - internal
  - diagnostics
assignees: []
merged: true
base: main
head: brent/diagnostic-refactor-2
created_at: 2025-05-12T17:33:34Z
updated_at: 2025-05-19T17:34:06Z
url: https://github.com/astral-sh/ruff/pull/18051
synced_at: 2026-01-12T15:56:11Z
```

# Unify `Message` variants

---

_@ntBre_

## Summary

This PR unifies the ruff `Message` enum variants for syntax errors and rule violations into a single `Message` struct consisting of a shared `db::Diagnostic` and some additional, optional fields used for some rule violations.

This version of `Message` is nearly a drop-in replacement for `ruff_diagnostics::Diagnostic`, which is the next step I have in mind for the refactor.

I think this is also a useful checkpoint because we could possibly add some of these optional fields to the new `Diagnostic` type. I think we've previously discussed wanting support for `Fix`es, but the other fields seem less relevant, so we may just need to preserve the `Message` wrapper for a bit longer.

## Test plan

Existing tests

---

_Label `diagnostics` added by @ntBre on 2025-05-12 17:33_

---

_Comment by @github-actions[bot] on 2025-05-12 17:40_

<!-- generated-comment ecosystem -->
## `ruff-ecosystem` results
### Linter (stable)
✅ ecosystem check detected no linter changes.

### Linter (preview)
✅ ecosystem check detected no linter changes.




---

_Comment by @codspeed-hq[bot] on 2025-05-12 17:40_

<!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->
<!-- __CODSPEED_INSTRUMENTATION_PERFORMANCE_REPORT_COMMENT__ -->

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/brent%2Fdiagnostic-refactor-2)

### Merging #18051 will **not alter performance**

<sub>Comparing <code>brent/diagnostic-refactor-2</code> (ae0b0ad) with <code>main</code> (220137c)</sub>



### Summary

`✅ 34` untouched benchmarks  





---

_Review comment by @ntBre on `crates/ruff_linter/src/message/mod.rs`:113 on 2025-05-12 17:48_

This is a bit of a hack. We're storing the pascal-case rule name as the primary diagnostic message (e.g. `MissingNewlineAtEndOfFile`) since it will accept a `String`, ~~while the `DiagnosticId` is the kebab-case `&'static str` for the rule generated by `ruff_macros` (`missing-newline-at-end-of-file` in this case).~~ Edit: this is no longer the case after the perf changes below.

Returning `self.diagnostic.id().as_str()` from `Message::name` currently "only" causes two cache tests to fail, so it may not be too hard to fix this.

---

_@ntBre reviewed on 2025-05-12 17:48_

---

_Comment by @ntBre on 2025-05-12 18:25_

I made a couple of tweaks in https://github.com/astral-sh/ruff/pull/18051/commits/28ad2605c4468d3d3cc26e1142d9b157c2f68eb7 to avoid constructing a `Rule` from a `DiagnosticKind` up front. This means we don't get a meaningful `DiagnosticId` anymore (we aren't really using it yet anyway), but the perf regression dropped from a worst case of 8% to 3%. If I'm reading the graph correctly, the remaining change is from allocating the `Vec`s inside the new `Diagnostic` type, which I think is unavoidable.

---

_@ntBre reviewed on 2025-05-12 19:08_

---

_Review comment by @ntBre on `crates/ruff/src/cache.rs`:488 on 2025-05-12 19:08_

This change didn't actually end up helping at all (besides `None` being slightly shorter than `TextSize::default()`), so I'm happy to revert it.

---

_@ntBre reviewed on 2025-05-12 19:20_

---

_Review comment by @ntBre on `crates/ruff_linter/src/message/mod.rs`:257 on 2025-05-12 19:20_

I can add a newtype with a generated `AsRule` implementation here instead of reusing `DiagnosticKind` if we want to keep this approach.

---

_Closed by @ntBre on 2025-05-12 20:36_

---

_Reopened by @ntBre on 2025-05-12 20:36_

---

_Marked ready for review by @ntBre on 2025-05-12 21:06_

---

_Review requested from @carljm by @ntBre on 2025-05-12 21:06_

---

_Review requested from @MichaReiser by @ntBre on 2025-05-12 21:06_

---

_Review requested from @AlexWaygood by @ntBre on 2025-05-12 21:06_

---

_Review requested from @sharkdp by @ntBre on 2025-05-12 21:06_

---

_Review requested from @dcreager by @ntBre on 2025-05-12 21:06_

---

_Review request for @dcreager removed by @ntBre on 2025-05-12 21:06_

---

_Review request for @carljm removed by @ntBre on 2025-05-12 21:06_

---

_Review request for @sharkdp removed by @ntBre on 2025-05-12 21:06_

---

_Review request for @AlexWaygood removed by @ntBre on 2025-05-12 21:06_

---

_Review requested from @BurntSushi by @ntBre on 2025-05-12 21:06_

---

_Review comment by @MichaReiser on `crates/ruff_linter/src/message/mod.rs`:117 on 2025-05-13 06:51_

I don't think we should do this because it isn't a temporary hack. 

Unlike ty, ruff has two codes for every rule: The name and the noqa code. I don't think we can avoid storing both those fields on `Diagnostic`. 

One option is to defer this problem for now and store the `NoqaCode` as a separate field. 


I'm also not sure if this is the right way to work around the performance regression. `DiagnosticKind` stores a `name` but that name would be unused once we use the `DiagnosticId`. Could we change `DiagnosticKind::name` to store a `&'static str`? to avoid the `rule` call or could we store the `rule` on `DiagnosticKind`? 

I think it is worth doing some more exploration on how and if we can change the `DiagnosticKind`/`Diagnostic` representation


---

_Review comment by @MichaReiser on `crates/ruff_linter/src/message/mod.rs`:257 on 2025-05-13 06:59_

Did you check where `rule` is used? Would it be sufficient to return a `NoqaCode` instead of the entire rule?

---

_@MichaReiser reviewed on 2025-05-13 07:04_

Thanks for working on this. 

I haven't done an in-depth review. The two things that stand out to me:

* We'll need a way to store the noqa comment. I think the way you avoided this for now is to lookup the rule by code when necessary. I wonder if it would make sense to extend the diagnostic model to support a secondary code (where id = name, secondary code = noqa)
* I don't think we should abuse `primary_message` for the id and fake an `UnknownRule` `Diagnostic. I think it should be possible to change `DiagnosticKind` name to `&'static str`
* Regarding perf: It may be worth exploring if using small vecs in `Diagnostic` helps with perf (it comes at the downside of increasing the `Diagnostic` size overall). Maybe best to explore separately

---

_Comment by @MichaReiser on 2025-05-13 11:44_

To extend on my comment. I expect that one of the next steps is to eliminate `DiagnosticKind`. Because of that: Could we change `DiagnosticKind` in ways that make this refactor easier:

* Change `name` to a `LintName`?
* Store the `noqa` code in addition to the name (would this remove the need to call `rule` in code using `DiagnosticKind` and higher?
* ... 

If so, it could then make sense to implement some of those changes as a separate PR

---

_@ntBre reviewed on 2025-05-13 12:39_

---

_Review comment by @ntBre on `crates/ruff_linter/src/message/mod.rs`:257 on 2025-05-13 12:39_

`message.rule().noqa_code()` does look like the most common usage, but there are multiple places accessing the `Rule`  name and URL too.

---

_@ntBre reviewed on 2025-05-13 12:55_

---

_Review comment by @ntBre on `crates/ruff_linter/src/message/mod.rs`:117 on 2025-05-13 12:55_

That makes sense. I guess hand-wavily I was hoping it would be temporary and that a better solution would appear when replacing `Diagnostic` or something, but it definitely makes sense to use `DiagnosticId` correctly here.

I don't think we can change `DiagnosticKind::name` to be a `&'static str`, at least without calling `Box::leak` or similar. It's stored in `CacheMessage` and used in serialization.

I'll look more closely at storing the rule on `DiagnosticKind`. I'm not sure it would help perf-wise, but it still might make sense. I think this is how they're typically constructed from a `Violation`:

https://github.com/astral-sh/ruff/blob/62fd8d4048be910ba74f628c19ced2ece48ae66a/crates/ruff_diagnostics/src/violation.rs#L83-L94

---

_@MichaReiser reviewed on 2025-05-13 12:58_

---

_Review comment by @MichaReiser on `crates/ruff_linter/src/message/mod.rs`:117 on 2025-05-13 12:58_

Could we use a different representation for caching that then goes through the rules lookup to get the diagnostic kind?

---

_@BurntSushi reviewed on 2025-05-13 14:01_

I don't have a ton of context on the Ruff side of things here, but extending the diagnostic model for the noqa code seems fine to me.

And trying out smallvecs in `Diagnostic` also seems okay. Note that a `Diagnostic` is already using an `Arc` internally, so a `Diagnostic` itself should stay pointer-sized.

---

_Converted to draft by @ntBre on 2025-05-13 17:59_

---

_Comment by @ntBre on 2025-05-15 19:31_

After #18074, I got rid of the hacky misuse of `primary_message` and aligned the `Diagnostic` fields much better with the new `db::Diagnostic` type:


| `ruff_diagnostics::Diagnostic`           | `ruff_db::Diagnostic`                     |
|------------------------------|--------------------------------------|
| `name: &'static str`         | `DiagnosticId`                       |
| `body: String`               | `primary_message`                    |
| `suggestion: Option<String>` | `primary_annotation().get_message()` |
| `range: TextRange`           | `primary_span().range()`             |
| `fix: Option<Fix>`           |                                      |
| `parent: Option<TextSize>`   |                                      |

`Message` is now basically just a `ruff_diagnostics::Diagnostic` with the `name`, `body`, `suggestion`, and `range` fields folded into a `ruff_db::Diagnostic` and with one additional `noqa_offset` field.

I haven't resolved what to do about the `NoqaCode`s  long-term, but I did add `Message::noqa_code` and `Message::url` to make it easier to see where `Message::rule` is being called and a `Rule` is actually needed.

From here, I think it makes sense either to start adding fields to `db::Diagnostic` so that it contains all the information needed by `Message`, or to go ahead and replace `ruff_diagnostics::Diagnostic` with `Message`. I'm leaning towards the latter since `Message` is still a nice boundary, and it makes some sense to me to delay adding fields to `db::Diagnostic` until we try actually rendering them in ruff.

I think absorbing `ruff_diagnostics::Diagnostic` will be pretty straightforward, but this PR was already getting long.

---

_Label `internal` added by @ntBre on 2025-05-16 22:11_

---

_Marked ready for review by @ntBre on 2025-05-16 22:11_

---

_Review comment by @MichaReiser on `crates/ruff/src/cache.rs`:488 on 2025-05-17 14:34_

It probably even increases the size of the struct but I think it's more correct overall. 

---

_@MichaReiser reviewed on 2025-05-17 14:34_

---

_Review comment by @MichaReiser on `crates/ruff/src/printer.rs`:47 on 2025-05-17 14:37_

I'd remove this struct and isntead implement `Serialize` for `NoqaCode`. 

If you decide against it, update the name (because it doesn't serialize the rule)

---

_Review comment by @MichaReiser on `crates/ruff/src/printer.rs`:330 on 2025-05-17 14:41_

I assume you're storing the `noqa_code` here over calling the method multiple times because calling `noqa_code` isn't free. I'd suggest renaming the method to `to_noqa_code` and `to_rule` to make this clear in the API.

---

_Review comment by @MichaReiser on `crates/ruff_linter/src/message/mod.rs`:114 on 2025-05-17 14:45_

Nit: The naming here is a bit confusing. Maybe `from_ruff_diagnostic`? (But I'm also okay leaving it as is, if the type is going away anyway)

---

_Review comment by @MichaReiser on `crates/ruff_linter/src/message/mod.rs`:192 on 2025-05-17 14:47_

I find this method somewhat confusing, now that `Message` no longer has two variants. I think I would replace the method with `is_syntax_error`.

Edit: I just see that it's only used in a single place and only to get the fix. A syntax error should never have a fix, so I think we can simply remove it all together

---

_Review comment by @MichaReiser on `crates/ruff_linter/src/message/mod.rs`:196 on 2025-05-17 14:49_

Hmm, this is interesting. We need to think about how we want to handle the migration from `syntax-error` to `invalid-syntax`.

---

_Review comment by @MichaReiser on `crates/ruff_linter/src/message/mod.rs`:218 on 2025-05-17 14:50_

Nit: I think I'd lean towards being more forgiving here and allow missing primary annotations, given that the method returns an `Option` anyway.
```suggestion
        self.diagnostic
            .primary_annotation()?
            .get_message()
    }
```

---

_Review comment by @MichaReiser on `crates/ruff_linter/src/message/mod.rs`:236 on 2025-05-17 14:51_

I think it would be great if we can remove `Rule` from `Message` and only store the noqa code (alternate code). But I agree with you that we should leave this to a separate refactor.

---

_Review comment by @MichaReiser on `crates/ruff_linter/src/message/mod.rs`:254 on 2025-05-17 14:54_

Hmm, it's annoying that we need to return a `String` here. I'm leaning towards changing `primary_span` to return a `&Span`. We can leave this to a separate PR to also get @BurntSushi's approval but I think it would be great if we don't need to clone unnecessarily

---

_Review comment by @MichaReiser on `crates/ruff_linter/src/codes.rs`:14 on 2025-05-17 14:59_

More an idea for a separate PR if you're interested in it. I wonder if we should store the code as a single `&str`, together with the byte-offset where the `prefix` ends and the suffix starts. This would have the advantage that it isn't necessary to call `to_string` to get the full noqa code (and we can still return a `&str` for both prefix and suffix in O(1))

Thinking about this more. It's probably not even necessary to store the offset and we can simply compute the split point on demand.

---

_Review comment by @MichaReiser on `crates/ruff_linter/src/test.rs`:236 on 2025-05-17 15:01_

Nit: Just an idea
```suggestion
        .filter_map(|msg| Some((msg.rule()?, msg)))
```

---

_@MichaReiser approved on 2025-05-17 15:02_

This is great.

Could you run the hyperfine benchmarks documented in the contribution guideline. Just to make sure we don't regress caching (and test that caching works too because I don't think we have any tests for it). In general. I think it would be good to do some extensive testing of the CLI (statistics etc)

---

_@ntBre reviewed on 2025-05-19 12:48_

---

_Review comment by @ntBre on `crates/ruff_linter/src/message/mod.rs`:114 on 2025-05-19 12:48_

Agreed, this and the `diagnostic` method don't make sense without the history of the `DiagnosticMessage` variant. I think I will just leave them for now since the intention is to delete them both in my next PR after this and  #18142.

---

_@ntBre reviewed on 2025-05-19 12:58_

---

_Review comment by @ntBre on `crates/ruff_linter/src/message/mod.rs`:196 on 2025-05-19 12:58_

Changing this to

```rust
    pub fn name(&self) -> &'static str {
        self.diagnostic.id().as_str()
    }
```

currently only fails one test for the `--statistics` flag.

But I agree, I'm not sure where else this could pop up  that might not be tested.

---

_@ntBre reviewed on 2025-05-19 12:59_

---

_Review comment by @ntBre on `crates/ruff_linter/src/message/mod.rs`:218 on 2025-05-19 12:59_

Sounds good, there were  a couple of places like that. I'll look for those too.

---

_@ntBre reviewed on 2025-05-19 13:01_

---

_Review comment by @ntBre on `crates/ruff_linter/src/message/mod.rs`:218 on 2025-05-19 13:01_

Oh, the only other one was the `rule`. I think we might still want to `expect` a valid rule name, otherwise I think `to_rule` is sometimes used to indicate a syntax error in the `None` case.

---

_@ntBre reviewed on 2025-05-19 13:05_

---

_Review comment by @ntBre on `crates/ruff_linter/src/codes.rs`:14 on 2025-05-19 13:05_

Added these three (`NoqaCode` instead of  rule, `&Span`, and this) to my todo list as follow-ups!

---

_Comment by @ntBre on 2025-05-19 13:32_

> This is great.

Thank you! And thanks for the reviews! I think all of the inline comments should be resolved.

> Could you run the hyperfine benchmarks documented in the contribution guideline. Just to make sure we don't regress caching (and test that caching works too because I don't think we have any tests for it). In general. I think it would be good to do some extensive testing of the CLI (statistics etc)

This is looking like a good suggestion, unlike  the 6x speedup in the contributing guide, I'm seeing a 1.3x speedup:

```
Benchmark 1: ./target/release/ruff check ./crates/ruff_linter/resources/test/cpython/ --no-cache -e
  Time (mean ± σ):     740.2 ms ±   6.2 ms    [User: 3241.7 ms, System: 135.5 ms]
  Range (min … max):   730.9 ms … 751.4 ms    10 runs

Benchmark 2: ./target/release/ruff check ./crates/ruff_linter/resources/test/cpython/ -e
  Time (mean ± σ):     564.5 ms ±   5.6 ms    [User: 628.6 ms, System: 133.7 ms]
  Range (min … max):   556.8 ms … 575.6 ms    10 runs

Summary
  ./target/release/ruff check ./crates/ruff_linter/resources/test/cpython/ -e ran
    1.31 ± 0.02 times faster than ./target/release/ruff check ./crates/ruff_linter/resources/test/cpython/ --no-cache -e
```

However, that's almost identical on `main`:

```
Benchmark 1: ./target/release/ruff check ./crates/ruff_linter/resources/test/cpython/ --no-cache -e
  Time (mean ± σ):     710.9 ms ±   4.5 ms    [User: 3164.4 ms, System: 130.1 ms]
  Range (min … max):   701.2 ms … 718.4 ms    10 runs

Benchmark 2: ./target/release/ruff check ./crates/ruff_linter/resources/test/cpython/ -e
  Time (mean ± σ):     546.8 ms ±   5.1 ms    [User: 611.6 ms, System: 135.7 ms]
  Range (min … max):   539.1 ms … 554.2 ms    10 runs

Summary
  ./target/release/ruff check ./crates/ruff_linter/resources/test/cpython/ -e ran
    1.30 ± 0.01 times faster than ./target/release/ruff check ./crates/ruff_linter/resources/test/cpython/ --no-cache -e
```

Do you have anything in particular in mind for testing the CLI otherwise? Or should I just try the release build on a few  projects? I guess the ecosystem check showing no changes is somewhat comforting too.

---

_Comment by @MichaReiser on 2025-05-19 13:36_

The caching speed is surprising. I wonder if this is something we broke recently? If you've time, it might be great to do a quick check that we aren't rerunning any lint rules (maybe just add a panic?). Definetely not blocking this PR, given that this already was like this before

> Do you have anything in particular in mind for testing the CLI otherwise? Or should I just try the release build on a few projects? I guess the ecosystem check showing no changes is somewhat comforting too.

Not really. Maybe play with a few output formats? 




---

_Comment by @ntBre on 2025-05-19 13:41_

> The caching speed is surprising. I wonder if this is something we broke recently? If you've time, it might be great to do a quick check that we aren't rerunning any lint rules (maybe just add a panic?). Definetely not blocking this PR, given that this already was like this before

Will do, I might bisect a bit too.

> Not really. Maybe play with a few output formats?

Will do!


---

_Comment by @ntBre on 2025-05-19 14:58_

It looks like the caching slowdown is not recent, it's been in a pretty steady decline since that 6x number was recorded. These tags aren't exact, just the tag before the commit I was bisecting:

| Tag     | Speedup |
|---------|---------|
| 0.11.10 | 1.3     |
| 0.9.2   | 1.4     |
| 0.7.3   | 1.7     |
| 0.5.7   | 1.7     |
| 0.5.0   | 1.7     |
| 0.4.5   | 2.6     |
| 0.3.0   | 3.4     |
| 0.0.290 | 3.6     |
| 0.0.240 | 6.1     |

`Speedup` is the relative speedup reading from cache, as reported in the hyperfine summary above.

I couldn't actually build 0.0.240 because of a git dep on libCST that doesn't exist anymore, so that number is from `CONTRIBUTING.md`. 0.0.290 is the earliest version I could build easily because it added the `ruff_linter` crate, which is where I had my CPython clone.

I added a panic after the caching early return in `lint_path` and can confirm that the cache is working too. (I also tried adding a  panic _before_ the early return, right at the top of `lint_path` and it definitely panicked)

---

_Comment by @MichaReiser on 2025-05-19 15:40_

Thanks for the thorough analysis. Let's create an issue to investigate if we can speed up caching. A 30% speed up is rather ridiculous (it should be at least 2x to justify its complexity)

---

_Comment by @ntBre on 2025-05-19 15:54_

For the CLI testing, I wrote a little script to loop through and diff the various output formats. It looks like the main difference is actually the  `noqa_offset` change, which is encoded as `"noqa_row": null` instead of `"noqa_row": 1` in the JSON and JSON-lines output formats.

The gitlab fingerprints also differ compared to 0.11.10, but I think that's from the previous PR, and we expected that there.

I also diffed the `--statistics` output, and I think it is unchanged, except that the sort appears to be unstable within groups of rules with the same number of diagnostics.

Script:
```shell
formats=(
	concise
	full
	json
	json-lines
	junit
	grouped
	github
	gitlab
	pylint
	rdjson
	azure
	sarif
)

for format in ${formats[@]}; do
	echo "checking output format: $format"
	args="check --no-cache crates/ruff_linter/resources/test/cpython --output-format $format"
	diff <(ruff $args) <(target/release/ruff $args)
done
```

Statistics check:

```shell
diff  <(ruff check --no-cache crates/ruff_linter/resources/test/cpython --statistics) <(target/release/ruff check --no-cache crates/ruff_linter/resources/test/cpython --statistics)
```

---

_Comment by @MichaReiser on 2025-05-19 15:55_

> For the CLI testing, I wrote a little script to loop through and diff the various output formats. It looks like the main difference is actually the noqa_offset change, which is encoded as "noqa_row": null instead of "noqa_row": 1 in the JSON and JSON-lines output formats.

Can you double check that this won't break ruff-lsp?

---

_Comment by @ntBre on 2025-05-19 16:20_

I tested in VS Code with the native server disabled on both files from CPython and from the openai-cookbook (I knew they had many notebooks from seeing it in the ecosystem check), and it seems to be working. I also confirmed that [`DiagnosticData.noqa_row`](https://github.com/astral-sh/ruff-lsp/blob/main/ruff_lsp/server.py#L844) is annotated as `int | None` in ruff-lsp, so I think `null` should be handled gracefully.

I also tested the playground locally, just in case.

Should we ping Dhruv for (or revert) the `noqa_offset` change? That seems like the biggest potential issue to me, but the things I've tried look okay so far.

---

_Comment by @MichaReiser on 2025-05-19 17:03_

I'm fine moving forward. Making it `Option` would be nice for the `Diagnostic` type and you did your share of testing.

---

_Comment by @ntBre on 2025-05-19 17:07_

Sounds good, thanks for the testing ideas! I'll plan to merge this soon then.

---

_Merged by @ntBre on 2025-05-19 17:34_

---

_Closed by @ntBre on 2025-05-19 17:34_

---

_Branch deleted on 2025-05-19 17:34_

---
