<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix re-entrance deadlock in Package::files - astral-sh/ruff #12948</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix re-entrance deadlock in Package::files</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/12948">#12948</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-08-17 12:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">Summary
<p>This PR fixes a bug in the lazy <code>packages.files</code> logic where red knot dead-locked because:</p>
<ul>
<li><code>check</code> iterated over all files in the package, holding on to the <code>files</code> lock</li>
<li><code>infer</code> tried to determine if the current file is open by calling <code>package.contains_file</code> which calls <code>files</code> internally. This deadlocked because rust&#x27;s mutex doesn&#x27;t allow re-entrance.</li>
</ul>
<p>The plus of this is that the new logic is much simpler, and probably faster.
It also entirely encapsulates the mutex (it no longer returns a lock guard) so that re-entrance bugs should be history.</p>
Test Plan
<p>Added a new test, verified that it dead locks on main.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-17 12:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-17 12:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-17 12:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/workspace/files.rs</code>:120 on 2024-08-17 12:45</div>
            <div class="timeline-body"><p>That was an incorrect assumption of mine. Salsa doesn&#x27;t compare input-fields for equality. Setting an input field is always considered to be a change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-08-17 12:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-08-17 12:57</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-08-17 13:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/workspace.rs</code>:304 on 2024-08-17 13:27</div>
            <div class="timeline-body"><p>I&#x27;m not sure why I added caching for files when I implemented this. We only do the indexing once and then cache the result. There&#x27;s no need to cache it again</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_workspace/src/workspace/files.rs</code>:35 on 2024-08-19 17:28</div>
            <div class="timeline-body"><p>It feels kinda awkward how mnay <code>Arc&lt;FxHashSet&lt;File&gt;&gt;</code> annotations there are everywhere now. Would it be worth creating a newtype wrapper <code>struct IndexedFilesInner(Arc&lt;FxHashSet&lt;File&gt;&gt;);</code> that dereferences to <code>FxHashSet&lt;File&gt;</code>? Or at least create a type alias somewhere?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_workspace/src/workspace/files.rs</code>:77 on 2024-08-19 17:30</div>
            <div class="timeline-body"><pre><code>        //   can&#x27;t outlive the database (constrained by the `db` lifetime).
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_workspace/Cargo.toml</code>:18 on 2024-08-19 17:36</div>
            <div class="timeline-body"><p>Oh, I think this is no longer necessary after <a href="https://github.com/astral-sh/ruff/pull/12985">astral-sh/ruff#12985</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-19 17:37</div>
            <div class="timeline-body"><p>Carl would probably be a better reviewer here as I&#x27;m not too familiar with this code, but this seems reasonable</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/workspace/files.rs</code>:35 on 2024-08-20 06:38</div>
            <div class="timeline-body"><p>A newtype wrapper seems unnecessary complicated. I don&#x27;t want to hide the type. I can do a type alias, although 4 usages don&#x27;t seem that many to me and naming now kind of becomes awkward</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-08-20 06:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-20 06:45</div>
            <div class="timeline-body"><blockquote>
<p>Carl would probably be a better reviewer here as I&#x27;m not too familiar with this code, but this seems reasonable</p>
</blockquote>
<p>Thanks for reviewing.</p>
<p>I feel fairly confident about the change and it&#x27;s also a local change with very limited impact if we need to do any follow up &quot;cleanup&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-20 06:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-20 06:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-08-20 06:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-08-20 06:52</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/package-files-reentrence-deadlock">CodSpeed Performance Report</a>
Merging #12948 will <strong>degrade performances by 4.82%</strong>
<p>Comparing <code>package-files-reentrence-deadlock</code> (f8b4dfd) with <code>main</code> (abb4cdb)</p>
Summary
<p><code>❌ 1</code> regressions
<code>✅ 31</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/package-files-reentrence-deadlock">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
Benchmarks breakdown
<p>|     | Benchmark | <code>main</code> | <code>package-files-reentrence-deadlock</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ❌ | <code>linter/all-rules[numpy/globals.py]</code> | 727.4 µs | 764.3 µs | -4.82% |</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:06:08 UTC
    </footer>
</body>
</html>
