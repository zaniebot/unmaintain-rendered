<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[flake8-logging] Add `ExcInfoOutsideExceptionHandler` (LOG014) - astral-sh/ruff #14682</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[flake8-logging] Add <code>ExcInfoOutsideExceptionHandler</code> (LOG014)</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14682">#14682</a>
        opened by <a href="https://github.com/snowdrop4">@snowdrop4</a>
        on 2024-11-29 16:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/snowdrop4">@snowdrop4</a> on 2024-11-29 16:57</div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>Add <code>ExcInfoOutsideExceptionHandler</code> (<code>LOG014</code>) from the <code>flake8-logging</code> plugin (parent issue #7248).</p>
<p>This rule detects the <code>exc_info</code> kwarg being set to <code>True</code> outside of an exception handling block, which results in unwanted logging output.</p>
<p>I did some mild refactoring by adding a <code>helpers.rs</code> in the crate to reduce duplication.</p>
<h2>Test Plan</h2>
<p>Lots of fixtures.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "New Rule: LOG014 from flake8-logging" to "[flake8-logging] Add LOG014" by @snowdrop4 on 2024-11-29 17:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[flake8-logging] Add LOG014" to "[flake8-logging] Add `ExcInfoOutsideExceptionHandler` (LOG014)" by @snowdrop4 on 2024-11-29 17:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-29 17:10</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+15 -0 violations, +0 -0 fixes in 4 projects; 51 projects unchanged)</p>
<details><summary><a href="https://github.com/apache/airflow">apache/airflow</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/apache/airflow/blob/35000c91ea7b2ce0851a8af117fdfc3683ec07bb/task_sdk/src/airflow/sdk/execution_time/supervisor.py#L527'>task_sdk/src/airflow/sdk/execution_time/supervisor.py:527:9:</a> LOG014 Use of `exc_info` outside an exception handler
</pre>

</p>
</details>
<details><summary><a href="https://github.com/apache/superset">apache/superset</a> (+12 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/apache/superset/blob/97dde8c4855641de38f01218d0a4bb5460e3f1b2/superset/commands/report/base.py#L105'>superset/commands/report/base.py:105:13:</a> LOG014 Use of `exc_info` outside an exception handler
+ <a href='https://github.com/apache/superset/blob/97dde8c4855641de38f01218d0a4bb5460e3f1b2/superset/db_engine_specs/hive.py#L587'>superset/db_engine_specs/hive.py:587:9:</a> LOG014 Use of `exc_info` outside an exception handler
+ <a href='https://github.com/apache/superset/blob/97dde8c4855641de38f01218d0a4bb5460e3f1b2/superset/sql_lab.py#L136'>superset/sql_lab.py:136:5:</a> LOG014 Use of `exc_info` outside an exception handler
+ <a href='https://github.com/apache/superset/blob/97dde8c4855641de38f01218d0a4bb5460e3f1b2/superset/sql_lab.py#L140'>superset/sql_lab.py:140:5:</a> LOG014 Use of `exc_info` outside an exception handler
+ <a href='https://github.com/apache/superset/blob/97dde8c4855641de38f01218d0a4bb5460e3f1b2/superset/tasks/cache.py#L270'>superset/tasks/cache.py:270:9:</a> LOG014 Use of `exc_info` outside an exception handler
+ <a href='https://github.com/apache/superset/blob/97dde8c4855641de38f01218d0a4bb5460e3f1b2/superset/utils/core.py#L572'>superset/utils/core.py:572:9:</a> LOG014 Use of `exc_info` outside an exception handler
+ <a href='https://github.com/apache/superset/blob/97dde8c4855641de38f01218d0a4bb5460e3f1b2/superset/views/error_handling.py#L140'>superset/views/error_handling.py:140:9:</a> LOG014 Use of `exc_info` outside an exception handler
+ <a href='https://github.com/apache/superset/blob/97dde8c4855641de38f01218d0a4bb5460e3f1b2/superset/views/error_handling.py#L145'>superset/views/error_handling.py:145:9:</a> LOG014 Use of `exc_info` outside an exception handler
+ <a href='https://github.com/apache/superset/blob/97dde8c4855641de38f01218d0a4bb5460e3f1b2/superset/views/error_handling.py#L151'>superset/views/error_handling.py:151:9:</a> LOG014 Use of `exc_info` outside an exception handler
+ <a href='https://github.com/apache/superset/blob/97dde8c4855641de38f01218d0a4bb5460e3f1b2/superset/views/error_handling.py#L160'>superset/views/error_handling.py:160:9:</a> LOG014 Use of `exc_info` outside an exception handler
+ <a href='https://github.com/apache/superset/blob/97dde8c4855641de38f01218d0a4bb5460e3f1b2/superset/views/error_handling.py#L187'>superset/views/error_handling.py:187:9:</a> LOG014 Use of `exc_info` outside an exception handler
+ <a href='https://github.com/apache/superset/blob/97dde8c4855641de38f01218d0a4bb5460e3f1b2/superset/views/error_handling.py#L209'>superset/views/error_handling.py:209:9:</a> LOG014 Use of `exc_info` outside an exception handler
</pre>

</p>
</details>
<details><summary><a href="https://github.com/rotki/rotki">rotki/rotki</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/rotki/rotki/blob/901667b8e2dc55caee1ccb7a02d22446131c1529/rotkehlchen/api/server.py#L431'>rotkehlchen/api/server.py:431:9:</a> LOG014 Use of `exc_info` outside an exception handler
</pre>

</p>
</details>
<details><summary><a href="https://github.com/zulip/zulip">zulip/zulip</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/zulip/zulip/blob/1bf3bc0f18c7863727641666033ecbfd7fe648d6/zerver/lib/push_notifications.py#L1330'>zerver/lib/push_notifications.py:1330:17:</a> LOG014 Use of `exc_info` outside an exception handler
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| LOG014 | 15 | 15 | 0 | 0 | 0 |</p>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @AlexWaygood on 2024-11-29 17:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @AlexWaygood on 2024-11-29 17:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowdrop4">@snowdrop4</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_logging/LOG014.py</code>:154 on 2024-11-29 17:15</div>
            <div class="timeline-body"><p>The ecosystem checks are turning up a few instances just like this.</p>
<p>Technically in this case, if we are able to tell that <code>banana()</code> is <em>only</em> ever called from inside an exception handling block, then we could mark this as okay. But I don't think it's possible to check all calling sites?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowdrop4">@snowdrop4</a> reviewed on 2024-11-29 17:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_logging/LOG014.py</code>:154 on 2024-11-29 17:32</div>
            <div class="timeline-body"><p>It's possible, but you'd need to move the rule to <code>crates/ruff_linter/src/checkers/ast/analyze/bindings.rs</code> rather than <code>crates/ruff_linter/src/checkers/ast/analyze/expression.rs</code>. The difference is that the rules executed from <code>bindings.rs</code> are run after the entire semantic model has been built, so they have more information available to them in some ways: they're able to iterate through all the references to a binding as well as looking at the original binding itself. You can see an example of how to do it in a PR I merged this morning: https://github.com/astral-sh/ruff/pull/14661.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-29 17:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowdrop4">@snowdrop4</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_logging/LOG014.py</code>:154 on 2024-11-29 18:50</div>
            <div class="timeline-body"><p>Ahh. I'll revise it to include that check then. Thanks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowdrop4">@snowdrop4</a> reviewed on 2024-11-29 18:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-11-29 18:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_logging/LOG014.py</code>:154 on 2024-11-29 18:51</div>
            <div class="timeline-body"><p>no problem, thanks for the PR!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowdrop4">@snowdrop4</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_logging/LOG014.py</code>:154 on 2024-12-02 14:29</div>
            <div class="timeline-body"><p>Forgive me if I'm misunderstanding, but I don't think moving it to <code>bindings.rs</code> works?</p>
<p>An expression like <code>logging.info(&quot;foo&quot;, exc_info=True)</code> isn't a binding, so if I move my lint function call to <code>bindings.rs</code>, then the only situation the lint could possibly apply would be <code>x = logging.info(&quot;foo&quot;, exc_info=True)</code> or <code>(x := logging.info(&quot;foo&quot;, exc_info=True))</code>, which no one writes.</p>
<p>Is it possible to make a new version of <code>expression.rs</code> that's called after the entire semantic model has been built? I don't think there's any way around calling the lint function on expressions, since the lint is designed to find bad function calls.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowdrop4">@snowdrop4</a> reviewed on 2024-12-02 14:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-02 14:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_logging/LOG014.py</code>:154 on 2024-12-02 14:35</div>
            <div class="timeline-body"><blockquote>
<p>An expression like <code>logging.info(&quot;foo&quot;, exc_info=True)</code> isn't a binding, so if I move my lint function call to <code>bindings.rs</code>, then the only situation the lint could possibly apply would be <code>x = logging.info(&quot;foo&quot;, exc_info=True)</code> or <code>(x := logging.info(&quot;foo&quot;, exc_info=True))</code>, which no one writes.</p>
</blockquote>
<p>ah, you're quite right.</p>
<p>I suppose what would be best would be to collect all <code>logging.(...)</code> calls into a <code>Vec</code> stored on <a href="https://github.com/astral-sh/ruff/blob/6dfe125f44352f5fdff19f6d47fc33ac7a6e86ad/crates/ruff_linter/src/checkers/ast/deferred.rs#L4-L15">this struct</a> as we traverse the AST in https://github.com/astral-sh/ruff/blob/main/crates/ruff_linter/src/checkers/ast/mod.rs. Then after the AST has been fully visited and the <code>SemanticModel</code> has been fully constructed, we can call this rule on each <code>logging(...)</code> call we stored in the Vec.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dylwil3 by @dylwil3 on 2024-12-04 18:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-12-05 19:28</div>
            <div class="timeline-body"><p>@snowdrop4 Thanks for working on this!</p>
<p>Would you, by any chance, be able to walk me through (at least some of) the ecosystem results and help me understand why/whether they are true positives?</p>
<p>I'm a little worried (probably unnecessarily) that a library may define a function in a publicly accessible namespace</p>
<pre><code class="language-python">def foo():
    # &lt;-- function logic here --- &gt;
    
    # exc_info outside of except
    logging.exception(..., exc_info=True)
</code></pre>
<p>and then any of the following (or a mixture) may occur:</p>
<ol>
<li><code>foo</code> is imported in a different file and called inside an except block.</li>
<li><code>foo</code> is called from the body of <code>bar</code> which is called from the body of <code>baz</code>... etc. which is then called inside an except block.</li>
<li><code>foo</code> has a decorator which secretly inserts a try/except.</li>
<li><code>foo</code> is not called in an except block in the whole library, but it is meant to be consumed by users within an except block.</li>
</ol>
<p>I don't think I know enough about the use-cases for specifying <code>exc_info=True</code> outside of an except block to tell whether people are really doing it by accident or intentionally for something like 1-4.</p>
<p>I don't think there's a problem with performing this lint for functions defined inside another function scope, since they cannot be used elsewhere, but for the above case I'm less sure.</p>
<p>Apologies if I'm making a mountain out of a molehill here - you probably know more than me about Python logging practices and can tell me I'm off base here!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-12-17 16:20</div>
            <div class="timeline-body"><p>@snowdrop4 Sorry again for the added complexity here. What do you think of the following conservative approach to this rule?</p>
<ol>
<li>If the violation is in the module-level scope, emit a lint.</li>
<li>If the violation is in a <em>nested</em> function, emit a lint</li>
<li>If the violation is in a function <em>and</em> the function is used somewhere in the file <em>not</em> inside an except-handler, emit a lint</li>
<li>otherwise, don't emit a lint</li>
</ol>
<p>As I said in the previous comment, I'm happy to be overruled here if you think the current ecosystem check and scope of the rule seems reasonable given how Python developers use this logging option generally.</p>
<p>Thanks for your patience and your contribution!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-04 09:52</div>
            <div class="timeline-body"><p>I'll close this because LOG014 was added in https://github.com/astral-sh/ruff/pull/15799</p>
<p>Thanks again for giving this rule a try!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-02-04 09:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/snowdrop4">@snowdrop4</a> on 2025-02-04 10:39</div>
            <div class="timeline-body"><p>Ah, sorry, I've been so busy, I wasn't able to revisit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-04 10:41</div>
            <div class="timeline-body"><p>No apology needed @snowdrop4. Thanks again for the PR!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:57:51 UTC
    </footer>
</body>
</html>
