<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Support inlay hint type hint location - astral-sh/ruff #21505</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Support inlay hint type hint location</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21505">#21505</a>
        opened by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a>
        on 2025-11-17 21:21
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-11-17 21:21</div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff/ty! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title? (Please prefix with `[ty]` for ty pull
  requests.)
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>Resolves https://github.com/astral-sh/ty/issues/1078.</p>
<p><a href="https://github.com/user-attachments/assets/eb1249fe-83ad-4d2a-aed8-2ab33eb0fbcd">Screencast_20251117_212227.webm</a>.</p>
<p>To find valid identifiers in the display string we do the following.</p>
<ol>
<li>iterate over each char</li>
<li>start with max length string (current char to end of string)</li>
<li>reduce string length until valid identifier is found</li>
<li>If no valid identifier is found, we append the character to the label parts.</li>
<li>if we do find one we check all global symbols (this should be sped up) to find the symbol we want.</li>
<li>Add inlay label part and navigation target.</li>
</ol>
<h2>Test Plan</h2>
<p>Our current snapshots for inlay hint locations are very hard to understand and frankly arent useful at all.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-17 21:23</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-17 21:24</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅</p>
<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-17 21:33</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-11-17 21:41</div>
            <div class="timeline-body"><p>There are a lot of false positives (random targets) here.</p>
<ul>
<li>In &quot;Todo&quot; annotations</li>
<li>In literal string annotations.</li>
</ul>
<p>I think this is a good test but probably not a good solution.</p>
<p>Interested to see people's thoughts.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MatthewMckee4 on 2025-11-17 21:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MatthewMckee4 on 2025-11-17 21:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @MatthewMckee4 on 2025-11-17 21:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @MatthewMckee4 on 2025-11-17 21:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @MatthewMckee4 on 2025-11-17 21:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MatthewMckee4 on 2025-11-17 21:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Support inlay hint type hint location" to "[ty] Support inlay hint type hint location" by @amyreese on 2025-11-17 22:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @MichaReiser on 2025-11-18 08:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dcreager removed by @MichaReiser on 2025-11-18 08:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @MichaReiser on 2025-11-18 08:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @MichaReiser on 2025-11-18 08:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-18 08:27</div>
            <div class="timeline-body"><p>Thanks to work on this.</p>
<p>It feels wrong to me to render the type to a string, and then trying to reparse the information. I think we should either:</p>
<ul>
<li>Accept the fact that the LSP needs more flexibility and use a separate rendering pipeline all together</li>
<li>Use a visitor approach where we don't write to a <code>std::fmt::Formatter</code> but to our own formatter instead, which is a <code>trait</code> with <code>visit_type(&amp;mut self, ty)</code>, <code>write_str</code> etc. methods. I'd have to play with the problem myself to get a good sense for how an ergonomic API for this would look like.</li>
</ul>
<p>We do have a similar problem for showing go to targets on hover. It's slightly different than inlay but we would want to collect all types, resolve their definitions, and render the definitions in a separate list. That's why I think a visitor approach where one implementation writes to a normal formatter, another that creates the inlay hint parts, and a third that writes to a normal formatter and collects the go to definition targets seems best?</p>
<p>But curious to hear what @Gankra thinks. She worked on this code more than I</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-18 08:33</div>
            <div class="timeline-body"><blockquote>
<ul>
<li>Use a visitor approach where we don't write to a <code>std::fmt::Formatter</code> but to our own formatter instead, which is a <code>trait</code> with <code>visit_type(&amp;mut self, ty)</code>, <code>write_str</code> etc. methods. I'd have to play with the problem myself to get a good sense for how an ergonomic API for this would look like.</li>
</ul>
</blockquote>
<p>For reference, we have a <code>TypeVisitor</code> trait at https://github.com/astral-sh/ruff/blob/d5a95ec8246aae0656c3be6b5b23741e84fa8a86/crates/ty_python_semantic/src/types/visitor.rs#L32, but I'm not totally sure from your description whether it would work for your purposes here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-18 08:46</div>
            <div class="timeline-body"><p>I think we would want something more specific to rendering types. I very much doubt that we need separate visitor methods for each type. We're more interested in getting &quot;hook-in-points&quot; to know when we enter a new type and when we exit it, as well as having a way to write the label for the current type.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-11-18 11:07</div>
            <div class="timeline-body"><blockquote>
<p>It feels wrong to me to render the type to a string</p>
</blockquote>
<p>I agree</p>
<p>It also feels wrong to duplicate display logic from <code>display.rs</code>.</p>
<p>Could we make changes in <code>display.rs</code>? Possibly making some intermediate struct that collects all the parts of the string, importantly parts that have a definition (or just <code>TextRange</code>) that we can goto. Then implement <code>Display</code> for that.</p>
<p>Meaning we can get all the information we need from the intermediate struct.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-11-18 11:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-18 12:15</div>
            <div class="timeline-body"><blockquote>
<p>Could we make changes in display.rs? Possibly making some intermediate struct that collects all the parts of the string, importantly parts that have a definition (or just TextRange) that we can goto. Then implement Display for that.</p>
</blockquote>
<p>I think this would work but has two downsides:</p>
<ul>
<li>We collect a lot of unnecessary information for the common case where we just want to render a type to a string</li>
<li>It's not enough for go to in hover (https://github.com/astral-sh/ty/issues/1575), requiring another refactor.</li>
</ul>
<p>The approach I would try is to define a new trait:</p>
<pre><code class="language-rust">pub trait DisplayTypeFormatter&lt;'db&gt; {
	fn enter_type(&amp;mut self, ty: Type&lt;'db&gt;) {}
	fn exit_type(&amp;mut self) {}
	fn write_str(&amp;mut self, part: &amp;str);
}
</code></pre>
<p>I think we can even implement <code>std::fmt::Write</code> for <code>DisplayVisitor</code> so that we can keep using <code>write!(f, &quot;text{interpolation}&quot;);</code> by either implementing it for <code>&amp;dyn DisplayTypeFormatter</code> or generic over <code>T</code></p>
<pre><code class="language-rust">impl std::fmt::Write for dyn DisplayTypeFormatter&lt;'_&gt; {
	fn write_str(&amp;mut self, text: &amp;str) -&gt; std::fmt::Result&lt;()&gt; {
		DisplayFormatter::write_str(self, text);
		Ok(())
	}
}
</code></pre>
<p>The implementation to formatting the type to a string is:</p>
<pre><code class="language-rust">struct DisplayToString(String);

impl DisplayTypeFormatter&lt;'_&gt; for DisplayToString {
	fn write_str(&amp;mut self, part: &amp;str) {
		self.0.push_str(part);
	}
}
</code></pre>
<p>Extracting the inlay is a bit tricky. It will require maintaining a stack of inlay parts where you push to the stack when entering a new type and popping from the stack when exiting (the stack is your scratch pad and you move them to a finalized state once finished.</p>
<p>The hover implementation wraps a <code>DisplayTypeFormatter</code> and also keeps a <code>HashSet</code> of all seen <code>Definition</code>.</p>
<p>Note: I haven't tried any of this, so this might not work or require more methods or different signatures but I think this is worth exploring.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-18 19:27</div>
            <div class="timeline-body"><p>Oh how serendipitous, I was just thinking about implementing this. We already have the visitor pattern in our display code, it's used by signature_help. I would absolutely implement this feature by expanding upon this design:</p>
<p>https://github.com/astral-sh/ruff/blob/192c37d5401786b3043aafbfb657b4f5e7df8ac8/crates/ty_python_semantic/src/types/display.rs#L1099-L1109</p>
<p>https://github.com/astral-sh/ruff/blob/192c37d5401786b3043aafbfb657b4f5e7df8ac8/crates/ty_python_semantic/src/types/display.rs#L1155-L1160</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-11-19 11:00</div>
            <div class="timeline-body"><p>Cool, I'll close this for now and let you do your thing, I'm happy to link it up to the inlay hints if you don't get to that.</p>
<p>I will also think about a better way to snapshot the targets.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MatthewMckee4 on 2025-11-19 11:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-20 14:41</div>
            <div class="timeline-body"><p>@MatthewMckee4 done in #21533, thanks for getting the ball rolling!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-12-27 00:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:36:42 UTC
    </footer>
</body>
</html>
