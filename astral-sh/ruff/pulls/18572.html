<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-pyi`] Expand `Optional[A]` to `A | None` (`PYI016`) - astral-sh/ruff #18572</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-pyi</code>] Expand <code>Optional[A]</code> to <code>A | None</code> (<code>PYI016</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18572">#18572</a>
        opened by <a href="https://github.com/robsdedude">@robsdedude</a>
        on 2025-06-08 20:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/robsdedude">@robsdedude</a> on 2025-06-08 20:45</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Under preview :test_tube: I've expanded rule <code>PYI016</code> to also flag type union duplicates containing <code>None</code> and <code>Optional</code>.</p>
<h2>Test Plan</h2>
<p>Examples/tests have been added. I've made sure that the existing examples did not change unless preview is enabled.</p>
<h2>Relevant Issues</h2>
<ul>
<li>https://github.com/astral-sh/ruff/issues/18508 (discussing introducing/extending a rule to flag <code>Optional[None]</code>)</li>
<li>https://github.com/astral-sh/ruff/issues/18546 (where I discussed this addition with @AlexWaygood)</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-08 21:16</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+2 -0 violations, +0 -0 fixes in 1 projects; 54 projects unchanged)</p>
<details><summary><a href="https://github.com/langchain-ai/langchain">langchain-ai/langchain</a> (+2 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/langchain-ai/langchain/blob/0189c50570913d73afe8c854f95dcfd5e7d6dd71/libs/core/langchain_core/language_models/llms.py#L158'>libs/core/langchain_core/language_models/llms.py:158:44:</a> PYI016 [*] Duplicate union member `None`
+ <a href='https://github.com/langchain-ai/langchain/blob/0189c50570913d73afe8c854f95dcfd5e7d6dd71/libs/core/langchain_core/language_models/llms.py#L194'>libs/core/langchain_core/language_models/llms.py:194:44:</a> PYI016 [*] Duplicate union member `None`
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PYI016 | 2 | 2 | 0 | 0 | 0 |</p>
</p>
</details>

<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @ntBre on 2025-06-09 20:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @robsdedude on 2025-06-09 21:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @robsdedude on 2025-06-09 21:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-09 21:05</div>
            <div class="timeline-body"><p>Nice, the ecosystem hits are both true positives!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @ntBre on 2025-06-17 18:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @ntBre on 2025-06-17 18:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/ast/analyze/expression.rs</code>:98 on 2025-06-17 18:51</div>
            <div class="timeline-body"><p>Could we move this check inside the rule itself so we don't have to duplicate it? This feels surprising to me, but I tried removing them locally and they're obviously needed somewhere to avoid duplicate diagnostics, as the comment says.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/preview.rs</code>:138 on 2025-06-17 18:52</div>
            <div class="timeline-body"><p>I think the convention here is to prefix these with <code>is_</code>. Obviously the previously-last one didn't follow that, but it looks like that has been fixed on <code>main</code> too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/mod.rs</code>:178 on 2025-06-17 18:55</div>
            <div class="timeline-body"><p>This is the source of the merge conflict. I think you'll need to resurrect this <code>preview_rules</code> function but leave off PYI044.pyi.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/duplicate_union_member.rs</code>:96 on 2025-06-17 19:09</div>
            <div class="timeline-body"><p>What do you think about something like this:</p>
<pre><code class="language-rust">        let diagnostic_range = expr.range();

        let expr = if optional_as_none_in_union_enabled(checker.settings)
            &amp;&amp; is_optional_type(checker, expr)
        {
            &amp;VIRTUAL_NONE_LITERAL
        } else {
            expr
        };

        // If we've already seen this union member, raise a violation.
        if seen_nodes.insert(expr.into()) {
            unique_nodes.push(expr);
        } else {
            diagnostics.push(checker.report_diagnostic(
                DuplicateUnionMember {
                    duplicate_name: checker.generator().expr(expr),
                },
                diagnostic_range,
            ));
        }
</code></pre>
<p>The contents of the two branches looked very similar except for the value of <code>expr</code>. The one downside is having to compute the <code>diagnostic_range</code> earlier since we can't use the range from <code>VIRTUAL_NONE_LITERAL</code>. Another option there is just not shadowing <code>expr</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_semantic/src/analyze/typing.rs</code>:461 on 2025-06-17 19:15</div>
            <div class="timeline-body"><p>I think I'm not as against passing bare <code>bool</code> arguments as most people, but if you really want to avoid it, I think the more typical approach is defining a two-variant enum. Maybe something like this:</p>
<pre><code class="language-rust">enum TraverseOptions {
    Yes,
    No,
}
</code></pre>
<p>As an even smaller nit here, I think we usually put the docs above the <code>#[derive]</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/snapshots/ruff_linter__rules__flake8_pyi__tests__preview__PYI016_PYI016.py.snap</code>:935 on 2025-06-17 19:29</div>
            <div class="timeline-body"><p>I was a bit skeptical about this transformation in https://github.com/astral-sh/ruff/issues/18508#issuecomment-2950452307 but if you and @AlexWaygood think it's fine, I'm happy with it. I just thought it was likely to be a separate mistake that a safe autofix could hide.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_semantic/src/model.rs</code>:1628 on 2025-06-17 19:35</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    /// Return `true` if the model is inside an Optional (e.g., the inner `Union` in
    /// `Optional[Union[int, str]]`).
</code></pre>
<p>I might throw in &quot;directly inside&quot; to make it clear this doesn't keep traversing nested structure. I would have assumed that based on the name alone, but that also applies to the existing function above. Maybe that's just me anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-06-17 20:05</div>
            <div class="timeline-body"><p>Nice! This is looking good. I just had a few minor suggestions and a question about <code>Optional[None]</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a> reviewed on 2025-06-24 19:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robsdedude">@robsdedude</a> on <code>crates/ruff_python_semantic/src/analyze/typing.rs</code>:461 on 2025-06-24 19:53</div>
            <div class="timeline-body"><p>I went with the struct as it's easier to extend should the need for more config options arise in the future. If you'd rather have it an enum, I'm also fine with that. I just find bare bool arguments hard to read at call sites, so I try to avoid them unless the function name gives a strong clue as to what the flag does.</p>
<p>Should I change it anyway?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a> reviewed on 2025-06-24 19:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robsdedude">@robsdedude</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/snapshots/ruff_linter__rules__flake8_pyi__tests__preview__PYI016_PYI016.py.snap</code>:935 on 2025-06-24 19:58</div>
            <div class="timeline-body"><p>This might become hard to track, but how about making the fix unsafe if both</p>
<ol>
<li>An <code>Optional</code> was visited</li>
<li><code>None</code> is (one of) the redundant types in the union</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robsdedude">@robsdedude</a> on <code>crates/ruff_linter/src/checkers/ast/analyze/expression.rs</code>:98 on 2025-06-24 20:02</div>
            <div class="timeline-body"><p>I suppose we could. I was just trying to be consistent with what I saw in the code-base. Just a few lines above there's</p>
<pre><code class="language-rust">// Avoid duplicate checks if the parent is a union, since these rules already
// traverse nested unions.
if !checker.semantic.in_nested_union() {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a> reviewed on 2025-06-24 20:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_semantic/src/analyze/typing.rs</code>:461 on 2025-06-26 20:33</div>
            <div class="timeline-body"><p>Are there more options you think might be needed? I guess I was assuming this would be the only one.</p>
<p>In any case, I don't feel too strongly about this, so we can just move ahead with the current version.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/snapshots/ruff_linter__rules__flake8_pyi__tests__preview__PYI016_PYI016.py.snap</code>:935 on 2025-06-26 20:36</div>
            <div class="timeline-body"><p>I guess it's fine if it would complicate the code, again I don't feel too strongly. And the change is in preview, so we can collect some feedback here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/ast/analyze/expression.rs</code>:98 on 2025-06-26 20:37</div>
            <div class="timeline-body"><p>Fair enough!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-06-26 20:40</div>
            <div class="timeline-body"><p>Thanks! Can you resolve the conflicts?</p>
<p>After that, I can merge after the patch release today.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`flake8_pyi`] Expand `Optional[A]` to `A | None` in duplicate-union-member (`PYI016`)" to "[`flake8_pyi`] Expand `Optional[A]` to `A | None` in `duplicate-union-member` (`PYI016`)" by @ntBre on 2025-06-27 15:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`flake8_pyi`] Expand `Optional[A]` to `A | None` in `duplicate-union-member` (`PYI016`)" to "[`flake8-pyi`] Expand `Optional[A]` to `A | None` (`PYI016`)" by @ntBre on 2025-06-27 15:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-06-27 15:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-06-27 15:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-29 11:43</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 18:39:35 UTC
    </footer>
</body>
</html>
