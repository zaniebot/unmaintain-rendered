<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`ruff`] Offer fixes for `RUF039` in more cases - astral-sh/ruff #19065</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>ruff</code>] Offer fixes for <code>RUF039</code> in more cases</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19065">#19065</a>
        opened by <a href="https://github.com/robsdedude">@robsdedude</a>
        on 2025-07-01 07:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a></div>
            <div class="timeline-body">Summary
<p>Expand cases in which ruff can offer a fix for <code>RUF039</code> (some of which are unsafe).</p>
<p>While turning <code>&quot;\n&quot;</code> (== <code>\n</code>) into <code>r&quot;\n&quot;</code> (== <code>\\n</code>) is not equivalent at run-time, it&#x27;s still functionally equivalent to do so in the context of <a href="https://docs.python.org/3/library/re.html#regular-expression-syntax">regex patterns</a> as they themselves interpret the escape sequence. Therefore, an unsafe fix can be offered.</p>
<p>Further, this PR also makes ruff offer fixes for byte string literals, not only strings literals as before.</p>
Test Plan
<p>Tests for all escape sequences have been added.</p>
Related
<p>Closes: <a href="https://github.com/astral-sh/ruff/issues/16713">astral-sh/ruff#16713</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-01 08:08</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+0 -0 violations, +2 -0 fixes in 1 projects; 54 projects unchanged)</p>
<a href="https://github.com/pytest-dev/pytest">pytest-dev/pytest</a> (+0 -0 violations, +2 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
- <a href="https://github.com/pytest-dev/pytest/blob/cfc66062cb298e8b90a2849127e2104cd5070293/testing/python/metafunc.py#L432">testing/python/metafunc.py:432:45:</a> RUF039 First argument to `re.compile()` is not raw bytes literal
+ <a href="https://github.com/pytest-dev/pytest/blob/cfc66062cb298e8b90a2849127e2104cd5070293/testing/python/metafunc.py#L432">testing/python/metafunc.py:432:45:</a> RUF039 [*] First argument to `re.compile()` is not raw bytes literal
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| RUF039 | 2 | 0 | 0 | 2 | 0 |</p>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/robsdedude">@robsdedude</a> on 2025-07-01 08:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/ntBre">@ntBre</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-07 12:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-07 12:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-08 14:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unraw_re_pattern.rs</code>:28 on 2025-07-08 14:07</div>
            <div class="timeline-body"><p>Sometimes we also include a <code>## Fix availability</code> section. Would that be useful here? &quot;If a fix is available&quot; is kind of raising that question for me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unraw_re_pattern.rs</code>:279 on 2025-07-08 14:20</div>
            <div class="timeline-body"><p>This is some related code that I wrote for another rule:</p>
<p>https://github.com/astral-sh/ruff/blob/2f8bc9a30bbcb3839fa0a5031e0bbae329210e53/crates/ruff_linter/src/rules/ruff/rules/unnecessary_regular_expression.rs#L191-L210</p>
<p>It looks like we&#x27;re handling a slightly different set of characters there: <code>abfnrtv</code>. <code>b</code> is present there but not here and <code>x</code> is here but not there, for example. Is that expected, or should the two be the same?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unraw_re_pattern.rs</code>:279 on 2025-07-08 14:26</div>
            <div class="timeline-body"><p>I kind of like this <code>str::contains</code> check more than having to pass a closure. Then we could avoid calling the <code>checker.target_version()</code> repeatedly too, not that it&#x27;s too expensive. For example:</p>
<pre><code>let allowed = if checker.target_version() &gt;= PythonVersion::PY38 {
    &quot;afnrtuUvxN&quot;
} else {
    &quot;afnrtuUvx&quot;
};
</code></pre>
<p>and for bytes it would just be <code>&quot;afnrtvx&quot;</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unraw_re_pattern.rs</code>:279 on 2025-07-08 14:31</div>
            <div class="timeline-body"><p>There&#x27;s also this section in the <a href="https://docs.python.org/3/library/re.html#module-contents">docs</a> (just above the linked node):</p>
<blockquote>
<p>Octal escapes are included in a limited form. If the first digit is a 0, or if there are three octal digits, it is considered an octal escape. Otherwise, it is a group reference. As for string literals, octal escapes are always at most three digits in length.</p>
</blockquote>
<p>This might be too niche to worry about, if it&#x27;s relevant at all. I see there&#x27;s a test case with an octal escape, so this seems intentional.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unraw_re_pattern.rs</code>:257 on 2025-07-08 14:42</div>
            <div class="timeline-body"><pre><code>                // If the next character is not one of the whitelisted ones, we likely cannot safely turn
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unraw_re_pattern.rs</code>:191 on 2025-07-08 14:42</div>
            <div class="timeline-body"><pre><code>/// Check how safe it is to prepend the `r` prefix to the string.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-07-08 14:44</div>
            <div class="timeline-body"><p>Thanks! I just had a couple of questions/suggestions around the allowed escape characters and an idea for the docs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a> reviewed on 2025-07-22 17:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robsdedude">@robsdedude</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unraw_re_pattern.rs</code>:279 on 2025-07-22 17:18</div>
            <div class="timeline-body"><blockquote>
<p>I kind of like this <code>str::contains</code> check more</p>
</blockquote>
<p>If you prefer the <code>str::contains</code> approach for readability, I&#x27;ll follow whatever you prefer as this is your code base to maintain. If you worry about performance: match is often faster. Pulling the <code>checker.target_version()</code> out of the closure is still possible and since Rust will monomorphize <code>raw_applicability</code> with the closure/anonymous function the compiler can optimize things to its heart&#x27;s content (as opposed to receiving an opaque <code>str</code> and calling <code>contains</code> on it (see <a href="https://godbolt.org/#g:!((g:!((g:!((h:codeEditor,i:(filename:%271%27,fontScale:14,fontUsePx:%270%27,j:1,lang:rust,selection:(endColumn:74,endLineNumber:11,positionColumn:74,positionLineNumber:11,selectionStartColumn:74,selectionStartLineNumber:11,startColumn:74,startLineNumber:11">godbolt example</a>,source:&#x27;use+std::hint::black_box%3B%0A%0A%23%5Binline(never)%5D%0Apub+fn+f1(c:+char)+-%3E+bool+%7B%0A++++let+matches+%3D+black_box(%22afnrtuUvxN%22)%3B%0A++++matches.contains(c)%0A%7D%0A%0A%23%5Binline(never)%5D%0Apub+fn+f2(c:+char)+-%3E+bool+%7B%0A++++matches!!(c,+!&#x27;a!&#x27;+%7C+!&#x27;f!&#x27;+%7C+!&#x27;n!&#x27;+%7C+!&#x27;r!&#x27;+%7C+!&#x27;t!&#x27;+%7C+!&#x27;u!&#x27;+%7C+!&#x27;U!&#x27;+%7C+!&#x27;v!&#x27;+%7C+!&#x27;x!&#x27;+%7C+!&#x27;N!&#x27;)%0A%7D%0A%0Apub+fn+main()+%7B+%0A++++let+input+%3D+black_box(!&#x27;c!&#x27;)%3B%0A++++black_box(f1(input))%3B%0A++++black_box(f2(input))%3B%0A+%7D%0A&#x27;),l:&#x27;5&#x27;,n:&#x27;0&#x27;,o:&#x27;Rust+source+%231&#x27;,t:&#x27;0&#x27;)),k:50,l:&#x27;4&#x27;,n:&#x27;0&#x27;,o:&#x27;&#x27;,s:0,t:&#x27;0&#x27;),(g:!((h:compiler,i:(compiler:r1860,filters:(b:&#x27;0&#x27;,binary:&#x27;1&#x27;,binaryObject:&#x27;1&#x27;,commentOnly:&#x27;0&#x27;,debugCalls:&#x27;1&#x27;,demangle:&#x27;0&#x27;,directives:&#x27;0&#x27;,execute:&#x27;1&#x27;,intel:&#x27;0&#x27;,libraryCode:&#x27;0&#x27;,trim:&#x27;1&#x27;,verboseDemangling:&#x27;0&#x27;),flagsViewOpen:&#x27;1&#x27;,fontScale:14,fontUsePx:&#x27;0&#x27;,j:1,lang:rust,libs:!(),options:&#x27;-O&#x27;,overrides:!(),selection:(endColumn:12,endLineNumber:78,positionColumn:12,positionLineNumber:78,selectionStartColumn:10,selectionStartLineNumber:78,startColumn:10,startLineNumber:78),source:1),l:&#x27;5&#x27;,n:&#x27;0&#x27;,o:&#x27;+rustc+1.86.0+(Editor+%231)&#x27;,t:&#x27;0&#x27;)),k:50,l:&#x27;4&#x27;,n:&#x27;0&#x27;,o:&#x27;&#x27;,s:0,t:&#x27;0&#x27;)),l:&#x27;2&#x27;,n:&#x27;0&#x27;,o:&#x27;&#x27;,t:&#x27;0&#x27;)),version:4)).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a> reviewed on 2025-07-22 17:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robsdedude">@robsdedude</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unraw_re_pattern.rs</code>:279 on 2025-07-22 17:23</div>
            <div class="timeline-body"><blockquote>
<p>Is that expected, or should the two be the same?</p>
</blockquote>
<p>I&#x27;m unsure. The linked code sure is different. If I&#x27;m interpreting it right, it&#x27;s trying to go from <code>re.sub</code> to <code>str.replace</code>. While in this PR we&#x27;re trying to go from <code>re.some_func(&quot;some str&quot;)</code> to <code>re.some_func(r&quot;some str&quot;)</code>. So here we&#x27;re always staying in the regex world. It&#x27;s just a question of how many <code>\</code>es the string will end up having. My gut feeling is that those cases are not the same. But as said, unsure.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robsdedude">@robsdedude</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unraw_re_pattern.rs</code>:279 on 2025-07-22 17:29</div>
            <div class="timeline-body"><blockquote>
<p>This might be too niche to worry about</p>
</blockquote>
<p>Yeah... I didn&#x27;t want to go there :sweat_smile: I mean it wouldn&#x27;t be hard to implement, but probably slightly less efficient because the search window would grow from 2 to 4 characters.</p>
<p>I&#x27;ll leave it up to you to decide if you want me to go for it or not.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a> reviewed on 2025-07-22 17:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-07-24 15:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unraw_re_pattern.rs</code>:279 on 2025-07-24 15:42</div>
            <div class="timeline-body"><p>You&#x27;ve convinced me :) let&#x27;s stick with this version.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-07-24 15:42</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-24 15:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-24 15:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-24 18:33</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:16:07 UTC
    </footer>
</body>
</html>
