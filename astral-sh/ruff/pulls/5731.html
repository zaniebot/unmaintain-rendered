<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add a tool for shrinking failing examples - astral-sh/ruff #5731</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add a tool for shrinking failing examples</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5731">#5731</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2023-07-13 09:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body">Summary
<p>For formatter instabilities, the message we get look something like this:</p>
<pre><code>Unstable formatting /home/konsti/ruff/target/checkouts/deepmodeling:dpdispatcher/dpdispatcher/slurm.py
@@ -47,9 +47,9 @@
-            script_header_dict[&quot;slurm_partition_line&quot;] = (
-                NOT_YET_IMPLEMENTED_ExprJoinedStr
-            )
+            script_header_dict[
+                &quot;slurm_partition_line&quot;
+            ] = NOT_YET_IMPLEMENTED_ExprJoinedStr
Unstable formatting /home/konsti/ruff/target/checkouts/deepmodeling:dpdispatcher/dpdispatcher/pbs.py
@@ -26,9 +26,9 @@
-            pbs_script_header_dict[&quot;select_node_line&quot;] += (
-                NOT_YET_IMPLEMENTED_ExprJoinedStr
-            )
+            pbs_script_header_dict[
+                &quot;select_node_line&quot;
+            ] += NOT_YET_IMPLEMENTED_ExprJoinedStr
</code></pre>
<p>For ruff crashes. you don&#x27;t even get that but just the file that crashed it. To extract the actual bug, you&#x27;d need to manually remove parts of the file, rerun to see if the bug still occurs (and revert if it doesn&#x27;t) until you have a minimal example.</p>
<p>With this script, you run</p>
<pre><code>cargo run --bin ruff_shrinking -- target/checkouts/deepmodeling:dpdispatcher/dpdispatcher/slurm.py target/minirepo/code.py &quot;Unstable formatting&quot; &quot;target/debug/ruff_dev format-dev --stability-check target/minirepo&quot;
</code></pre>
<p>and get</p>
<pre><code>class Slurm():
    def gen_script_header(self, job):
        if resources.queue_name != &quot;&quot;:
            script_header_dict[&quot;slurm_partition_line&quot;] = f&quot;#SBATCH --partition {resources.queue_name}&quot;
</code></pre>
<p>which is an nice minimal example.</p>
<p>I&#x27;ve been using this script and it would be easier for me if this were part of main. The main disadvantage to merging is that it adds additional dependencies.</p>
Test Plan
<p>I&#x27;ve been using this for a number of minimization. This is an internal helper script you only run manually. I could add a test that minimizes a rule violation if required.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/konstin">@konstin</a> on 2023-07-13 09:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-07-13 10:24</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>✅ ecosystem check detected no changes.</p>
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.13     12.9±0.42ms     3.2 MB/sec    1.00     11.4±0.27ms     3.6 MB/sec
formatter/numpy/ctypeslib.py               1.08      2.4±0.06ms     6.9 MB/sec    1.00      2.2±0.06ms     7.4 MB/sec
formatter/numpy/globals.py                 1.06   275.9±16.09µs    10.7 MB/sec    1.00   260.1±14.76µs    11.3 MB/sec
formatter/pydantic/types.py                1.10      5.4±0.14ms     4.8 MB/sec    1.00      4.9±0.18ms     5.2 MB/sec
linter/all-rules/large/dataset.py          1.03     17.4±0.56ms     2.3 MB/sec    1.00     16.8±0.38ms     2.4 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      4.3±0.16ms     3.9 MB/sec    1.00      4.2±0.20ms     3.9 MB/sec
linter/all-rules/numpy/globals.py          1.01   571.9±20.28µs     5.2 MB/sec    1.00   566.7±21.88µs     5.2 MB/sec
linter/all-rules/pydantic/types.py         1.01      7.8±0.26ms     3.3 MB/sec    1.00      7.7±0.27ms     3.3 MB/sec
linter/default-rules/large/dataset.py      1.05      8.7±0.27ms     4.7 MB/sec    1.00      8.2±0.25ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.03  1779.3±54.79µs     9.4 MB/sec    1.00  1719.9±45.11µs     9.7 MB/sec
linter/default-rules/numpy/globals.py      1.02    210.7±9.42µs    14.0 MB/sec    1.00    206.3±6.76µs    14.3 MB/sec
linter/default-rules/pydantic/types.py     1.05      3.8±0.18ms     6.7 MB/sec    1.00      3.6±0.09ms     7.0 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     11.1±0.17ms     3.7 MB/sec    1.02     11.4±0.20ms     3.6 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.2±0.03ms     7.7 MB/sec    1.03      2.2±0.07ms     7.5 MB/sec
formatter/numpy/globals.py                 1.00    244.2±5.81µs    12.1 MB/sec    1.02    248.9±8.63µs    11.9 MB/sec
formatter/pydantic/types.py                1.00      4.8±0.10ms     5.3 MB/sec    1.01      4.8±0.11ms     5.3 MB/sec
linter/all-rules/large/dataset.py          1.02     16.2±0.35ms     2.5 MB/sec    1.00     16.0±0.51ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      4.2±0.07ms     4.0 MB/sec    1.00      4.1±0.05ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.00    503.3±9.86µs     5.9 MB/sec    1.01   506.3±10.09µs     5.8 MB/sec
linter/all-rules/pydantic/types.py         1.01      7.4±0.24ms     3.4 MB/sec    1.00      7.3±0.19ms     3.5 MB/sec
linter/default-rules/large/dataset.py      1.00      8.1±0.15ms     5.0 MB/sec    1.02      8.3±0.22ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1700.2±30.04µs     9.8 MB/sec    1.01  1724.1±25.33µs     9.7 MB/sec
linter/default-rules/numpy/globals.py      1.00    192.2±4.29µs    15.4 MB/sec    1.01    193.6±8.00µs    15.2 MB/sec
linter/default-rules/pydantic/types.py     1.03      3.7±0.08ms     6.9 MB/sec    1.00      3.6±0.06ms     7.1 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-07-13 23:47</div>
            <div class="timeline-body"><blockquote>
<p>I&#x27;ve been using this script and it would be easier for me if this were part of main. The main disadvantage to merging is that it adds additional dependencies.</p>
</blockquote>
<p>Should we consider having some internal ruff tooling in another repository?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_minimizer/Cargo.toml</code>:9 on 2023-07-14 06:30</div>
            <div class="timeline-body"><p>What&#x27;s the motivation for this to be its own crate vs making it part of the <code>cargo dev</code> crate? We could also start splitting <code>cargo dev</code> into multiple sub crates, see https://github.com/rome/tools/tree/main/xtask</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_minimizer/src/main.rs</code>:209 on 2023-07-14 06:34</div>
            <div class="timeline-body"><pre><code>            input[TextRange::up_to(range.start())].to_string() + &amp;input[range.end().to_usize()..]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_minimizer/Cargo.toml</code>:2 on 2023-07-14 06:36</div>
            <div class="timeline-body"><p>This is called <code>shrinking</code> in property based testing https://www.educative.io/answers/what-is-shrinking</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_minimizer/src/main.rs</code>:64 on 2023-07-14 06:37</div>
            <div class="timeline-body"><p>Nit: This could be implemented as an enum, considering that it is a fixed set of strategies. But I can see how this allows you to split the code nicer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-07-14 06:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_minimizer/Cargo.toml</code>:9 on 2023-07-14 08:12</div>
            <div class="timeline-body"><p>having less dependencies / faster compilation, but i&#x27;m happy to move it anywhere</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-07-14 08:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_minimizer/src/main.rs</code>:64 on 2023-07-14 08:16</div>
            <div class="timeline-body"><p>i&#x27;ve had been thinking about an enum too, with traits it&#x27;s marginally easier to attach methods</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-07-14 08:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-07-14 08:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_minimizer/Cargo.toml</code>:2 on 2023-07-14 08:16</div>
            <div class="timeline-body"><p>that link is helpful, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Add a failing example minimizer&quot; to &quot;Add a tool for shrinking failing examples&quot; by <a href="https://github.com/konstin">@konstin</a> on 2023-07-14 08:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-07-14 08:32</div>
            <div class="timeline-body"><blockquote>
<p>Should we consider having some internal ruff tooling in another repository?</p>
</blockquote>
<p>I&#x27;ve prototyped this in this (internal) repo: https://github.com/astral-sh/ruff-tools</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-07-14 16:03</div>
            <div class="timeline-body"><p>My initial take is that i&#x27;m generally pro-monorepo, and it seems reasonable to add this to <code>ruff_dev</code>. I&#x27;m less concerned about the added dependencies since <code>ruff_dev</code> isn&#x27;t included in the Ruff binary anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/konstin">@konstin</a> on 2023-07-18 08:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/konstin">@konstin</a> on 2023-07-18 08:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-07-18 08:03</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:55:17 UTC
    </footer>
</body>
</html>
