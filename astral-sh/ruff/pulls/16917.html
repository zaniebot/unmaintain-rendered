<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Discover local venv folder in cli - astral-sh/ruff #16917</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Discover local venv folder in cli</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16917">#16917</a>
        opened by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a>
        on 2025-03-22 18:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>Fixes astral-sh/ty#171</p>
<p>Code from
https://github.com/astral-sh/uv/blob/bbf4f830b5b346d9bdba18b6bc319c9527e5e92c/crates/uv-python/src/virtualenv.rs#L124-L144</p>
<h2>Test Plan</h2>
<p>Manual testing</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MatthewMckee4 on 2025-03-22 18:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MatthewMckee4 on 2025-03-22 18:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @MatthewMckee4 on 2025-03-22 18:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @MatthewMckee4 on 2025-03-22 18:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @MatthewMckee4 on 2025-03-22 18:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-22 18:42</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @ntBre on 2025-03-22 19:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_project/src/metadata/options.rs</code>:116 on 2025-03-22 21:25</div>
            <div class="timeline-body"><p>I'm not sure if implementing the fallback here, at least how it's done now is the most ideal solution. I've two concerns:</p>
<ol>
<li>This re-implements part of the discovery logic in <code>VirtualEnvironment::new</code></li>
<li>It's now possible that Red Knot picks up a <code>.venv</code> for which <code>VirtualEnvironment::new</code> later fails (for example, because the <code>pyenv.cfg</code> is invalid). Red Knot will fail to start</li>
</ol>
<p>I think my preferred behavior is that Red Knot ignores any errors (may log a warning or debug message) if a <code>.venv</code> directory exists but it isn't a valid venv. But I don't think Red Knot should fail to start in that case because it isn't an input explicitly set by the user.</p>
<p>One way to implement this is to have a <code>PythonPath::Discover</code> option where the fallback behavior is implemented in <code>SearchPaths::from_settings</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-22 21:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-03-22 22:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_project/src/metadata/options.rs</code>:116 on 2025-03-22 22:00</div>
            <div class="timeline-body"><blockquote>
<p>It's now possible that Red Knot picks up a .venv for which VirtualEnvironment::new later fails (for example, because the pyenv.cfg is invalid). Red Knot will fail to start</p>
</blockquote>
<p>Could this not happen already? It could pick up the env variable of an invalid .venv right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-03-22 22:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_project/src/metadata/options.rs</code>:116 on 2025-03-22 22:19</div>
            <div class="timeline-body"><p>Could we say we just don't error for site packages discovery for these?</p>
<pre><code class="language-rs">SysPrefixPathOrigin::VirtualEnvVar | SysPrefixPathOrigin::LocalVenv
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-23 08:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_project/src/metadata/options.rs</code>:116 on 2025-03-23 08:00</div>
            <div class="timeline-body"><blockquote>
<p>Could this not happen already? It could pick up the env variable of an invalid .venv right?</p>
</blockquote>
<p>IMO, this is different because the user explicitly sets the <code>VIRTUAL_ENV</code> environment variable. They're explicitly telling Red Knot to use that folder.</p>
<blockquote>
<p>Could we say we just don't error for site packages discovery for these?</p>
</blockquote>
<p>We could do that. But I wonder if it still leads to some more code duplication compared to deferring more to the resolver.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-03-23 13:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_project/src/metadata/options.rs</code>:116 on 2025-03-23 13:06</div>
            <div class="timeline-body"><p>Do you think its still bad to look for a venv there</p>
<pre><code class="language-rs">                .or_else(PythonPath::from_local_venv)
</code></pre>
<p>Then in SearchPaths::from_settings, we allow an invalid venv, and fallback to no site packages?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @carljm on 2025-03-23 13:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Discover local venv folder in cli" to "[red-knot] Discover local venv folder in cli" by @MatthewMckee4 on 2025-03-23 13:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @MatthewMckee4 on 2025-03-23 13:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-25 20:14</div>
            <div class="timeline-body"><p>Sorry, for being slow to respond. We're having an on-site and have very limited time on GitHub. I'll come back to your question no later than next week; I just don't know when. Sorry for that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-03-25 20:52</div>
            <div class="timeline-body"><p>All good, no worries at all, thank you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-27 16:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_project/src/metadata/options.rs</code>:116 on 2025-03-27 16:09</div>
            <div class="timeline-body"><p>I don't think it's bad in itself. It even has some advantages from a persistent caching perspective (long-term) because we'd calculate a different cache key when running red knot when the <code>.venv</code> folder exists vs when it isn't.</p>
<p>However, I do wonder if we could remove some code duplication (the code roughly repeats some of the discovery logic that we already have in resolver) by moving this logic entirely into the resolver.</p>
<p>There's a last part to this feature, but I think it's okay to tackle it separately: We need to re-run the event discovery if the <code>.venv</code> folder gets deleted or created.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-03-27 16:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_project/src/metadata/options.rs</code>:116 on 2025-03-27 16:20</div>
            <div class="timeline-body"><p>Are you thinking of reverting to what we had before discovery of any venv:</p>
<pre><code class="language-rs">            python_path: python
                .map(|python_path| {
                    PythonPath::SysPrefix(python_path.absolute(project_root, system))
                })
                .unwrap_or_else(|| PythonPath::KnownSitePackages(vec![])),
</code></pre>
<p>Then do all discovery of venvs inside SearchPathSettings, or in SearchPaths.from_settings?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-27 17:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_project/src/metadata/options.rs</code>:116 on 2025-03-27 17:13</div>
            <div class="timeline-body"><p>No, I'd introduce a new <code>PythonPath</code> variant because the resolver otherwise can't know that it should do the venv discovery (<code>KnownSitePackages</code> would then become testing only)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-03-27 17:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_project/src/metadata/options.rs</code>:116 on 2025-03-27 17:34</div>
            <div class="timeline-body"><p>Okay I think understand, I'll have a go at this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-03-27 19:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_project/src/metadata/options.rs</code>:116 on 2025-03-27 19:10</div>
            <div class="timeline-body"><p>How does that look?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-03-27 19:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_project/src/metadata/options.rs</code>:116 on 2025-03-27 19:18</div>
            <div class="timeline-body"><p>Sorry yeah now <code>KnownSitePackages</code> is only used in tests.</p>
<p>What is <code>KnownSitePackages</code> currently used for anyway, if its only used with an empty vec. Seems there is no use right now other than a fallback</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-27 19:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/module_resolver/resolver.rs</code>:140 on 2025-03-27 19:48</div>
            <div class="timeline-body"><p>I'm interested into @AlexWaygood's opinion but I don't think we should test if the current (or any parent) directory is a venv. It's unclear to me why you'd want to run red knot <strong>inside</strong> a venv.</p>
<p>Let's also add some <code>debug</code> logs when we pick up a venv (here or in the <code>::Discover</code> match arm so that users understand that Red Knot picked up a venv.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-27 19:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/module_resolver/resolver.rs</code>:274 on 2025-03-27 19:49</div>
            <div class="timeline-body"><p>Nit</p>
<pre><code class="language-suggestion">                                &quot;Ignoring automatically detected virtual environment at '{}': {}&quot;,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-03-27 19:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_python_semantic/src/module_resolver/resolver.rs</code>:140 on 2025-03-27 19:53</div>
            <div class="timeline-body"><p>Okay sure, i just took this straight from uv, i can clean it up.</p>
<p>Ill add some debug logs first</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-03-27 20:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_python_semantic/src/module_resolver/resolver.rs</code>:140 on 2025-03-27 20:23</div>
            <div class="timeline-body"><p>Also, isn't checking if your in a venv pointless. If you are in a venv, then you will eventually get to the parent of the venv which will detect the venv. I'll remove this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-03-28 17:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-03-28 17:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-03-29 00:11</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:10:56 UTC
    </footer>
</body>
</html>
