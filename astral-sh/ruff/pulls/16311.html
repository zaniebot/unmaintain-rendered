<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Also use alists for list of live bindings/declarations - astral-sh/ruff #16311</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Also use alists for list of live bindings/declarations</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16311">#16311</a>
        opened by <a href="https://github.com/dcreager">@dcreager</a>
        on 2025-02-21 22:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dcreager">@dcreager</a> on 2025-02-21 22:40</div>
            <div class="timeline-body"><p>This PR extends #16306 to also use association lists to store the list of live bindings and declarations for each symbol in the use-def map.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @dcreager on 2025-02-21 22:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @dcreager on 2025-02-21 22:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-02-21 22:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/red_knot_python_semantic/src/semantic_index/use_def/symbol_state.rs</code>:1 on 2025-02-21 22:44</div>
            <div class="timeline-body"><p>Much of the churn is this file is from the new parameters to thread through the <code>SymbolStates</code> arenas</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dcreager on 2025-02-21 22:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dcreager on 2025-02-21 22:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dcreager on 2025-02-21 22:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dcreager on 2025-02-21 22:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @dcreager on 2025-02-21 22:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-02-21 22:47</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-02-21 23:31</div>
            <div class="timeline-body"><p>(Haven't reviewed this one yet, just wanted to note that <a href="https://codspeed.io/astral-sh/ruff/branches/dcreager%2Falist-for-live-bds">CodSpeed</a> seems to think this one is a 1% cold-check regression. So if that's consistent, we'll need to decide if there are sufficient code simplicity arguments to do it anyway, or if there's something we can do to eliminate the regression.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-23 15:29</div>
            <div class="timeline-body"><p>The code changes look good to me (they seem mostly mechanical).</p>
<p>What would help me review this PR conceptually is a short explanation on how live bindings and declarations are used (what are the creation and access patterns) and why using alists is a good fit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-23 15:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/use_def.rs</code>:726 on 2025-02-23 15:31</div>
            <div class="timeline-body"><p>I prefer accepting own instances for functions that unconditionally clone the parameter to make the cost more visible to callers. It can also help avoiding unnecessary calls in the cases where doesn't use the owned instance besides calling the function</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-23 15:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/use_def/symbol_state.rs</code>:314 on 2025-02-23 15:34</div>
            <div class="timeline-body"><p>Is it possible to keep the <code>len</code> comparison to avoid comparing iterators of different lengths?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-23 15:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_index/src/list.rs</code>:237 on 2025-02-23 15:35</div>
            <div class="timeline-body"><p>Nit: I'd probably move the <code>Clone</code> constraint closer to <code>map</code> to avoid that we accidentally &quot;inherit&quot; it for other methods adding to this <code>ListBuilder</code> impl block</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @dcreager on 2025-02-25 19:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-02-25 19:56</div>
            <div class="timeline-body"><p>Putting this back to draft while I fix up some merge conflicts</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-02-27 01:23</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_INSTRUMENTATION_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/dcreager%2Falist-for-live-bds">CodSpeed Performance Report</a></h2>
<h3>Merging #16311 will <strong>degrade performances by 4.18%</strong></h3>
<p><sub>Comparing <code>dcreager/alist-for-live-bds</code> (3fb1653) with <code>main</code> (7dad0c4)</sub></p>
<h3>Summary</h3>
<p><code>❌ 1</code> regressions<br />
<code>✅ 31</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/dcreager%2Falist-for-live-bds">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ❌ | <code>red_knot_check_file[cold]</code> | 84.2 ms | 87.8 ms | -4.18% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-02-28 19:57</div>
            <div class="timeline-body"><p>I've tried a few variations on this, but have not been able to get a performance increase.  I get things down to performance-neutral with the reusable alist cells from #16408, but that's not worth the extra code complexity.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dcreager on 2025-02-28 19:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-28 19:58</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:49:31 UTC
    </footer>
</body>
</html>
