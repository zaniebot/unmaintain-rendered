```yaml
number: 6871
title: "Add prototype of `ruff format` for projects"
type: pull_request
state: merged
author: konstin
labels:
  - formatter
assignees: []
merged: true
base: main
head: ruff-format-a-project
created_at: 2023-08-25T11:59:47Z
updated_at: 2023-08-27T19:12:33Z
url: https://github.com/astral-sh/ruff/pull/6871
synced_at: 2026-01-12T02:45:38Z
```

# Add prototype of `ruff format` for projects

---

_Pull request opened by @konstin on 2023-08-25 11:59_

**Summary** Add recursive formatting based on `ruff check` file discovery for `ruff format`, as a prototype for the formatter alpha. This allows e.g. `format ../projects/django/`. It's still lacking support for any settings except line length.

Note just like the existing `ruff format` this will become part of the production build, i.e. you'll be able to use it - hidden by default and with a prominent warning - with `ruff format .` after the next release.

Error handling works in my manual tests (the colors do also work):

```
$  target/debug/ruff format scripts/
warning: `ruff format` is a work-in-progress, subject to change at any time, and intended for internal use only.
```
(the above changes `add_rule.py` where we have the wrong bin op breaking)

```
$ target/debug/ruff format ../projects/django/
warning: `ruff format` is a work-in-progress, subject to change at any time, and intended for internal use only.
Failed to format /home/konsti/projects/django/tests/test_runner_apps/tagged/tests_syntax_error.py: source contains syntax errors: ParseError { error: UnrecognizedToken(Name { name: "syntax_error" }, None), offset: 131, source_path: "<filename>" }
```

```
$ target/debug/ruff format a
warning: `ruff format` is a work-in-progress, subject to change at any time, and intended for internal use only.
Failed to read /home/konsti/ruff/a/d.py: Permission denied (os error 13)
```

**Test Plan** Missing! I'm not sure if it's worth building tests at this stage or how they should look like.




---

_Comment by @konstin on 2023-08-25 11:59_

Current dependencies on/for this PR:
* main
  * **PR #6871** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6871" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #6873** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6873" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6871?utm_source=stack-comment).

---

_Comment by @github-actions[bot] on 2023-08-25 12:15_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_@konstin reviewed on 2023-08-25 13:33_

---

_Review comment by @konstin on `crates/ruff_cli/src/commands/format.rs`:59 on 2023-08-25 13:33_

Fixed by #6873

---

_@konstin reviewed on 2023-08-25 13:34_

---

_Review comment by @konstin on `crates/ruff_cli/src/commands/format.rs`:94 on 2023-08-25 13:34_

we get tracing :) it's not configured though so it does nothing here yet

---

_@konstin reviewed on 2023-08-25 13:35_

---

_Review comment by @konstin on `crates/ruff_cli/src/lib.rs`:177 on 2023-08-25 13:35_

i'd only do this after we know how the cli will look like

---

_@konstin reviewed on 2023-08-25 13:35_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/lib.rs`:104 on 2023-08-25 13:35_

these were redundant since the debug representation prints the kind anyway

---

_Comment by @charliermarsh on 2023-08-25 13:38_

Just chatted with @konstin - I'll review this today and then take over getting it merged while he's out next week.

---

_Label `formatter` added by @konstin on 2023-08-25 13:38_

---

_Review comment by @charliermarsh on `crates/ruff_cli/src/commands/format.rs`:44 on 2023-08-25 13:41_

I would suggest omitting this, and then in the `map` below, can we use `PySourceType::from(path)` and only run on Python files?

---

_@charliermarsh reviewed on 2023-08-25 13:41_

---

_@charliermarsh reviewed on 2023-08-25 13:42_

---

_Review comment by @charliermarsh on `crates/ruff_cli/src/commands/format.rs`:82 on 2023-08-25 13:42_

Can we do this more like in `run` where the error handling is inside the `map` above?

---

_@charliermarsh reviewed on 2023-08-25 13:42_

---

_Review comment by @charliermarsh on `crates/ruff_cli/src/lib.rs`:177 on 2023-08-25 13:42_

I think for the alpha it could be worth supporting `--verbose`, `--dry-run`, and `--stdin-filename` (for the LSP). What do you think? Yes no? Anything else?

---

_Review comment by @konstin on `crates/ruff_cli/src/commands/format.rs`:44 on 2023-08-25 15:03_

`PySourceType` doesn't handle toml so it's now a strange mixture

---

_@konstin reviewed on 2023-08-25 15:03_

---

_Marked ready for review by @konstin on 2023-08-25 15:14_

---

_@konstin reviewed on 2023-08-25 15:15_

---

_Review comment by @konstin on `crates/ruff_cli/src/commands/format.rs`:82 on 2023-08-25 15:15_

moved it into the map, i hope that's what you were aiming for

---

_Assigned to @charliermarsh by @konstin on 2023-08-25 15:40_

---

_Comment by @charliermarsh on 2023-08-27 18:55_

Gonna merge this, and then make a few small follow-up changes.

---

_Merged by @charliermarsh on 2023-08-27 19:12_

---

_Closed by @charliermarsh on 2023-08-27 19:12_

---

_Branch deleted on 2023-08-27 19:12_

---
