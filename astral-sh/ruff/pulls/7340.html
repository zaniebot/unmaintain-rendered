<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add a benchmarking script for the formatter CLI - astral-sh/ruff #7340</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add a benchmarking script for the formatter CLI</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7340">#7340</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-09-13 15:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-09-13 15:27</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR adds a benchmarking script for the formatter, which benchmarks the Ruff formatter against Black, yapf, and autopep8.</p>
<p>Three benchmarks are included:</p>
<ol>
<li>Format everything.</li>
<li>Format everything, but use a single thread.</li>
<li>Format everything, but <code>--check</code> (don't write to disk).</li>
</ol>
<p>There's some nuance in figuring out the right combination of arguments to each command, but the <em>main</em> nuance is to ensure that we always run the given formatter (and modify the target repo in-place) prior to benchmarking it, so that the formatters aren't disadvantaged by the existing formatting of the target repo. (E.g.: prior to benchmarking Black's preview style, we need to make sure we format the target repo with Black's preview style; otherwise, preview style appears much slower.)</p>
<p>Part of https://github.com/astral-sh/ruff/issues/7309.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-13 15:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>scripts/benchmarks/pyproject.toml</code>:17 on 2023-09-13 15:28</div>
            <div class="timeline-body"><p>Honestly don't know if Poetry is worth preserving here. I end up using <code>pipx</code> for these selectively.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @charliermarsh on 2023-09-13 15:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2023-09-13 15:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>scripts/benchmarks/run_formatter.sh</code>:18 on 2023-09-13 15:56</div>
            <div class="timeline-body"><p><code>ignore-failure</code> can mask real failures. Can we remove it and replace it with e.g. <code>-e</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>scripts/benchmarks/run_formatter.sh</code>:57 on 2023-09-13 15:59</div>
            <div class="timeline-body"><p>The comparision with <code>yapf</code> and <code>autopep8</code> is a bit unfair because the source formatting probably doesn't match their style guide -&gt; Potentially more work, need to write every file where other tools only need to write changed file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>scripts/benchmarks/run_formatter.sh</code>:18 on 2023-09-13 16:01</div>
            <div class="timeline-body"><p>I'm not entirely sure but I believe <code>--setup</code> only runs once. Meaning, subsequent runs don't work on a clean git directory. We may want to use <code>--prepare</code> instead</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-13 16:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-13 16:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>scripts/benchmarks/run_formatter.sh</code>:57 on 2023-09-13 16:05</div>
            <div class="timeline-body"><p>No, the warmup ensures that the first run formats the directory to match the style. (We then do this manually for the <code>--check</code> version.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-13 16:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>scripts/benchmarks/run_formatter.sh</code>:18 on 2023-09-13 16:05</div>
            <div class="timeline-body"><p>This is intentional. We don't want to reset the directory on each invocation, otherwise the benchmarks will suffer from the issue you pointed out in the comment above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-13 16:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>scripts/benchmarks/run_formatter.sh</code>:18 on 2023-09-13 16:06</div>
            <div class="timeline-body"><p>While I'd prefer <code>-e</code>, not every command in the benchmark supports such a flag (or, at least, I haven't been able to find one for Black).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-13 16:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>scripts/benchmarks/run_formatter.sh</code>:57 on 2023-09-13 16:22</div>
            <div class="timeline-body"><p>We should document the caveats of our benchmarks and highlight any potential incorrectness.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>scripts/benchmarks/run_formatter.sh</code>:57 on 2023-09-13 16:23</div>
            <div class="timeline-body"><p>I'll add some additional notes to the script. Is this a caveat though? What we're doing here seems correct.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-13 16:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-13 16:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>scripts/benchmarks/run_formatter.sh</code>:18 on 2023-09-13 16:24</div>
            <div class="timeline-body"><p>The example is to use <code>--setup</code> to compile your program. That means it only runs once for the whole benchmark.</p>
<p>I guess the reset doesn't really matter because each formatter will format the file to their expected output as part of the warmup.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/qarmin">@qarmin</a> on <code>scripts/benchmarks/run_formatter.sh</code>:18 on 2023-09-13 16:40</div>
            <div class="timeline-body"><p>So maybe it's worth adding a new benchmark that would at least partially test the formatting performance(with a note that probably most of the test files were previously reformatted according to black guidelines)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/qarmin">@qarmin</a> reviewed on 2023-09-13 16:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-09-13 17:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-09-13 17:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-09-13 17:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-13 17:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>scripts/benchmarks/run_formatter.sh</code>:18 on 2023-09-13 17:15</div>
            <div class="timeline-body"><p>Yeah, perhaps over a repo like CPython that (AFAIK) isn't formatted.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 02:39:46 UTC
    </footer>
</body>
</html>
