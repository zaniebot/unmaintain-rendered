<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Consider `from thispackage import y` to re-export `y` in `__init__.pyi` - astral-sh/ruff #21387</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Consider <code>from thispackage import y</code> to re-export <code>y</code> in <code>__init__.pyi</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21387">#21387</a>
        opened by <a href="https://github.com/Gankra">@Gankra</a>
        on 2025-11-11 18:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-11 18:11</div>
            <div class="timeline-body"><p>Fixes https://github.com/astral-sh/ty/issues/1487</p>
<p>This one is a true extension of non-standard semantics, and is therefore a certified Hot Take we might conclude is simply a Bad Take (let's see what ecosystem tests say...).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @Gankra on 2025-11-11 18:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @Gankra on 2025-11-11 18:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @Gankra on 2025-11-11 18:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @Gankra on 2025-11-11 18:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @Gankra on 2025-11-11 18:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by @Gankra on 2025-11-11 18:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-11 18:13</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-11 18:14</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">cki-lib (https://gitlab.com/cki-project/cki-lib)
- cki_lib/timeout.py:23:20: error[unresolved-attribute] Module `multiprocessing` has no member `context`
- Found 205 diagnostics
+ Found 204 diagnostics

scikit-build-core (https://github.com/scikit-build/scikit-build-core)
+ src/scikit_build_core/build/wheel.py:98:20: error[no-matching-overload] No overload of bound method `__init__` matches arguments
- Found 43 diagnostics
+ Found 44 diagnostics


</code></pre>
</details>

<p>No memory usage changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-11 18:18</div>
            <div class="timeline-body"><!-- generated-comment ty ecosystem-analyzer -->

<h2><code>ecosystem-analyzer</code> results</h2>
<p>| Lint rule | Added | Removed | Changed |
|-----------|------:|--------:|--------:|
| <code>unresolved-attribute</code> | 0 | 1 | 0 |
| <strong>Total</strong> | <strong>0</strong> | <strong>1</strong> | <strong>0</strong> |</p>
<p><strong><a href="https://gankra-abs-re.ecosystem-663.pages.dev/diff">Full report with detailed diff</a></strong> (<a href="https://gankra-abs-re.ecosystem-663.pages.dev/timing">timing results</a>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-11 18:19</div>
            <div class="timeline-body"><p>Hillarious.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-11-11 18:24</div>
            <div class="timeline-body"><p>Nice! One less false positive in the ecosystem ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-11 18:24</div>
            <div class="timeline-body"><p>The one (1) change is this code:</p>
<p>https://gitlab.com/cki-project/cki-lib/blob/fca022d15d1e881f561f3a53da3b19dc6c4cae18/cki_lib/timeout.py#L23</p>
<p>Accesses <code>multiprocessing.context</code>, and in typeshed we now think it exists because of:</p>
<p>https://github.com/python/typeshed/blob/5c8b7fcbbeb4af2d7e9f33e745a7863e401c2578/stdlib/multiprocessing/<strong>init</strong>.pyi#L1</p>
<pre><code class="language-py">from multiprocessing import context, reduction as reducer
</code></pre>
<p>(Additional context: this stub includes an <code>__all__</code> that actually doesn't actually list <code>context</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-11 18:26</div>
            <div class="timeline-body"><p>I am fine with landing this, but this seems more like an argument that maybe typeshed should be changed here X3</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-11-11 18:27</div>
            <div class="timeline-body"><p>This is a false positive we are removing: at runtime <code>multiprocessing.context</code> is always available, due to https://github.com/python/cpython/blob/main/Lib/multiprocessing/<strong>init</strong>.py#L16</p>
<p>I don't know if sample size of one is a sufficient indication that this is the right heuristic for stub files.</p>
<p>@AlexWaygood what do you think? Should we land this, or should we change <code>multiprocessing/__init__.pyi</code> in typeshed to make the re-export more explicit?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-11 18:29</div>
            <div class="timeline-body"><p>My two cents is that I actually like how explicit/clear <code>from . import x</code> is compared to <code>from thispackage import x</code>, and I <em>think</em> pyright only supports the former so we're in some sense introducing less fragmentation by not shipping this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-11 18:33</div>
            <div class="timeline-body"><blockquote>
<p>This one is a true extension of non-standard semantics</p>
</blockquote>
<p>But so is considering <code>from . import y</code> as a stub re-export, right? There doesn't seem to me to be a principled reason to privilege <code>from . import y</code> as a stub re-export but not <code>from thispackage import y</code>. According to the spec, neither should be considered a stub re-export, and they have the same semantics at runtime, so if we're special-casing one of them I think we should special-case the other too.</p>
<p>On the other hand -- yes, that typeshed import is definitely <em>not</em> intended to be an explicit re-export of the <code>context</code> submodule from <code>multiprocessing/__init__.pyi</code>. It's true that you can access <code>.context</code> from the <code>multiprocessing</code> module at runtime, but the <code>multiprocessing.context</code> module is entirely undocumented; people are supposed to use the public API of <code>multiprocessing</code> from the top-level module rather than use its undocumented submodules. It seems to me like it's an implementation detail of the runtime that the submodule is currently exposed from the <code>__init__.py</code> at runtime; I'm not sure users should be depending on that.</p>
<blockquote>
<p>(Additional context: this stub includes an <code>__all__</code> that actually doesn't actually list <code>context</code>)</p>
</blockquote>
<p>If <code>__all__</code> exists in the stub, maybe that should just have the final say over which import definitions in stubs are considered re-exported from the stub?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-11 18:43</div>
            <div class="timeline-body"><p>Would you also want it to be able to mask out <code>from x import y as y</code>? That's a pretty big change...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-11 19:01</div>
            <div class="timeline-body"><blockquote>
<p>Would you also want it to be able to mask out <code>from x import y as y</code>? That's a pretty big change...</p>
</blockquote>
<p>Hmm... the <a href="https://typing.python.org/en/latest/spec/distributing.html#library-interface-public-and-private-symbols">spec</a> says:</p>
<blockquote>
<p>Type checkers can use the following rules to determine which symbols are visible outside of the package.</p>
<ul>
<li><p>Symbols whose names begin with an underscore (but are not dunder names) are considered private.</p>
</li>
<li><p>Imported symbols are considered private by default. A fixed set of <a href="https://typing.python.org/en/latest/spec/distributing.html#import-conventions">import forms</a> re-export imported symbols.</p>
</li>
<li><p>A module can expose an <code>__all__</code> symbol at the module level that provides a list of names that are considered part of the interface. This overrides all other rules above, allowing imported symbols or symbols whose names begin with an underscore to be included in the interface.</p>
</li>
</ul>
</blockquote>
<p>The <code>from x import y as y</code> convention is the second bullet point here -- but the third bullet point (regarding <code>__all__</code> states that &quot;this overrides all other rules above&quot;. So that would imply that yeah, if <code>y</code> doesn't appear in <code>__all__</code>, we should regard it as unexported even if it was imported with <code>from x import y as y</code>.</p>
<p>But on the other hand, there's literally no reason to use a redundant alias like that unless you want it re-exported. You can't get any more explicit than that. So I think leaving it as it is there would also be fine, even if it would arguably be most consistent to give <code>__all__</code> top priority in all cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-11-11 19:14</div>
            <div class="timeline-body"><p>IMO the typing spec is not super clear about the relationship between the <code>import x as x</code> convention and respecting <code>__all__</code>, but personally I think the wording implies that they are additive -- if a symbol uses the <code>x as x</code> convention OR appears in <code>__all__</code>, it is exported. It does say that <code>__all__</code> &quot;overrides all rules above&quot; but it never suggests that overriding in a negative direction is even considered as a possibility. (The additive version is also what mypy and pyright actually implement. And I think it's the better choice for users, since <code>x as x</code> is so clear and explicit.)</p>
<p>The trouble here is that we are adding some less-explicit re-exports, and we have to decide if we should treat them the same as the explicit <code>x as x</code>, or let them be overridden in a negative direction by <code>__all__</code>. Personally I don't think this is worth the complexity either in implementation or in mental model for users. We should just decide if we want to consider these forms re-exports, and if we do, then we should treat them the same as the fully-explicit re-exports.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-11 19:22</div>
            <div class="timeline-body"><blockquote>
<p>The trouble here is that we are adding some less-explicit re-exports, and we have to decide if we should treat them the same as the explicit <code>x as x</code>, or let them be overridden in a negative direction by <code>__all__</code>. Personally I don't think this is worth the complexity either in implementation or in mental model for users. We should just decide if we want to consider these forms re-exports, and if we do, then we should treat them the same as the fully-explicit re-exports.</p>
</blockquote>
<p>Yeah, that's fair. In that case, I think I favour landing this PR as-is, despite the fact that the <code>multiprocessing.context</code> thing is arguably an ecosystem regression. I think it makes our heuristic easier to understand if we consider <code>from thispackage import y</code> the same way as we consider <code>from . import y</code>, since they do the same thing at runtime.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-11-11 19:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-11-11 19:26</div>
            <div class="timeline-body"><p>The one thing that occurs to me: if we land this and don't let <code>__all__</code> override it negatively, would there be any way for the stub author to say &quot;no, actually, this submodule is private.&quot;?</p>
<p>If the answer is no, that maybe suggests we shouldn't land this? Because the other direction is always an easy fix for the stub author -- just use <code>x as x</code> in the import. (Though I agree that if we don't land this, we should also revert making <code>from . import sub</code> a re-export -- and that one seemed clearly positive in the ecosystem. So I guess I don't think we should revert that, which means I do think we should land this regardless, to maintain consistency.)</p>
<p>The other possible thing we could do is ensure the &quot;initial underscore means private&quot; rule does override this heuristic. That would mean that <code>from thispackage import sub</code> and <code>from . import sub</code>, if they were really meant to not be re-exports, could be rewritten as <code>from thispackage import sub as _sub</code> or <code>from . import sub as _sub</code> (or actually rename the submodule to begin with underscore.) But I think this is low priority, we can wait and see if we get any user requests for it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-11 19:32</div>
            <div class="timeline-body"><p>I pushed up a docs change to add some more context:</p>
<ul>
<li>Unlike <code>from . import x</code>, this was done purely for consistency and not for compatibility</li>
<li>The only way to opt out is with <code>from . import x as y</code> (this already worked and is tested)</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-11 19:33</div>
            <div class="timeline-body"><blockquote>
<p>The one thing that occurs to me: if we land this and don't let <code>__all__</code> override it negatively, would there be any way for the stub author to say &quot;no, actually, this submodule is private.&quot;?</p>
</blockquote>
<p>I don't think so, no. If you need to import it in <code>__init__.pyi</code> for a type annotation, there'd be no way of excluding it from the public interface. But distinguishing between <code>from . import y</code> and <code>from thispackage import y</code> just seems very arbitrary; I think the only reason why one had more ecosystem impact is just that <code>from thispackage import y</code> is more characters to type out, so it's a less popular idiom in general in <code>__init__.pyi</code> files. It doesn't mean that people are using that syntactic form specifically so that type checkers will recognise the submodule as re-exported. I do think treating them both the same way is the most important thing here: if we want <code>__all__</code> to be able to override these re-exports negatively, we should apply that to both <code>from . import y</code> and <code>from thispackage import y</code>.</p>
<blockquote>
<p>But I think this is low priority, we can wait and see if we get any user requests for it.</p>
</blockquote>
<p>Yes, I agree; we can come back to all this later. Nobody's going to complain if the ty beta lets you access <code>.context</code> as an attribute on the stdlib <code>multiprocessing</code> module, in contravention of the intentions of the typeshed maintainers ðŸ˜„</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-11 19:34</div>
            <div class="timeline-body"><blockquote>
<p>The only way to opt out is with <code>from . import x as y</code> (this already worked and is tested)</p>
</blockquote>
<p>Oh, we <em>still</em> have a nonstandardised syntactic distinction even after this PR? I'm not sure I like that either ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-11 19:35</div>
            <div class="timeline-body"><p>Oh to be clear <code>from . import x as y</code> and <code>from thispackage import x as y</code> <em>both</em> opt-out of the re-export. I basically prioritize the <code>x as x</code> check over the self-import check if there is an alias.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-11-11 19:38</div>
            <div class="timeline-body"><p>I think the exception for <code>from {.,thispackage} import x as y</code> is good. Conceptually with this re-export rule we are modeling automatic submodule attribute attachment, and saying &quot;if you explicitly import a submodule, we'll consider it exported&quot;. In the case of <code>x as y</code>, the submodule attribute would be <code>x</code>, not <code>y</code>, but you chose to rename it, so we're certainly not going to consider <code>x</code> as exported, nor <code>y</code> because it doesn't match any other rule. It's only when the <code>x</code> and <code>y</code> line up with the same name that we're going to consider that &quot;strong enough&quot; to be a re-export.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-11 19:39</div>
            <div class="timeline-body"><blockquote>
<p>I think the exception for <code>from {.,thispackage} import x as y</code> is good. Conceptually with this re-export rule we are modeling automatic submodule attribute attachment, and saying &quot;if you explicitly import a submodule, we'll consider it exported&quot;. In the case of <code>x as y</code>, the submodule attribute would be <code>x</code>, not <code>y</code>, but you chose to rename it, so we're certainly not going to consider <code>x</code> as exported, nor <code>y</code> because it doesn't match any other rule. It's only when the <code>x</code> and <code>y</code> line up with the same name that we're going to consider that &quot;strong enough&quot; to be a re-export.</p>
</blockquote>
<p>I guess that makes as much sense as anything else here ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-11-11 19:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-11 19:41</div>
            <div class="timeline-body"><p>Alright merging, have fun explaining your sins to all your typing counsel friends!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @Gankra on 2025-11-11 19:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Gankra on 2025-11-11 19:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-11-11 19:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-11 19:45</div>
            <div class="timeline-body"><blockquote>
<p>Alright merging, have fun explaining your sins to all your typing counsel friends!</p>
</blockquote>
<p>ðŸ˜­</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:54:20 UTC
    </footer>
</body>
</html>
