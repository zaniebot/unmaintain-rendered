<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Reachability analysis - astral-sh/ruff #17199</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Reachability analysis</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17199">#17199</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-04-04 11:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR proposes a new approach to silencing <code>unresolved-reference</code> diagnostics by keeping track of the reachability of each use of a symbol. The changes merged in https://github.com/astral-sh/ruff/pull/17169 are still needed for the &quot;Use of variable in nested function&quot; test case, but that could also be solved in another way eventually (see https://github.com/astral-sh/ty/issues/210). We can use the same technique to silence <code>unresolved-import</code> and <code>unresolved-attribute</code> false-positives, but I think this could be merged in isolation.</p>
<h2>Test Plan</h2>
<p>New Markdown tests, ecosystem tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @sharkdp on 2025-04-04 11:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-04 11:13</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">packaging (https://github.com/pypa/packaging)
- warning[lint:unresolved-reference] /tmp/mypy_primer/projects/packaging/src/packaging/metadata.py:28:22: Name `ExceptionGroup` used when not defined
- Found 96 diagnostics
+ Found 95 diagnostics

werkzeug (https://github.com/pallets/werkzeug)
- warning[lint:possibly-unresolved-reference] /tmp/mypy_primer/projects/werkzeug/src/werkzeug/formparser.py:64:36: Name `TemporaryFile` used when possibly not defined
- Found 683 diagnostics
+ Found 682 diagnostics

rich (https://github.com/Textualize/rich)
- warning[lint:unresolved-reference] /tmp/mypy_primer/projects/rich/rich/traceback.py:462:43: Name `BaseExceptionGroup` used when not defined
- warning[lint:unresolved-reference] /tmp/mypy_primer/projects/rich/rich/traceback.py:462:63: Name `ExceptionGroup` used when not defined
- warning[lint:unresolved-reference] /tmp/mypy_primer/projects/rich/tests/test_progress.py:186:13: Name `_time` used when not defined
- warning[lint:unresolved-reference] /tmp/mypy_primer/projects/rich/tests/test_progress.py:499:20: Name `time` used when not defined
- Found 382 diagnostics
+ Found 378 diagnostics

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-04-04 18:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/semantic_index/use_def.rs</code>:620 on 2025-04-04 18:39</div>
            <div class="timeline-body"><p>I'm completely fine with keeping this more concise.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-04-04 18:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/unreachable.md</code>:433 on 2025-04-04 18:39</div>
            <div class="timeline-body"><p>I will leave attributes and imports for a follow up. I want to get some feedback on this first.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @sharkdp on 2025-04-04 18:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2025-04-04 18:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2025-04-04 18:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @sharkdp on 2025-04-04 18:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-04-04 19:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/unreachable.md</code>:221 on 2025-04-04 19:29</div>
            <div class="timeline-body"><p>Nothing changed in this test, but this explanation was outdated. And the <code>return x  # â€¦</code> below as confusing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-04-04 19:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/unreachable.md</code>:265 on 2025-04-04 19:30</div>
            <div class="timeline-body"><p>The fact that we reveal <code>Unknown</code> here is tracked in https://github.com/astral-sh/ruff/issues/15777</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-04-04 19:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/unreachable.md</code>:275 on 2025-04-04 19:31</div>
            <div class="timeline-body"><p>We don't support <code>Final</code> yet, so I needed to declare this as <code>Literal[False]</code>. Otherwise, the public type (which we use below) would be <code>Unknown | Literal[False]</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-04-04 20:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:4191 on 2025-04-04 20:31</div>
            <div class="timeline-body"><p>We could potentially defer the evaluation of the visibility constraint here, if it turns out to be a performance problem.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/semantic_index/use_def.rs</code>:894 on 2025-04-08 02:46</div>
            <div class="timeline-body"><p>nit: we should also <code>self.reachability_by_use.shrink_to_fit()</code> above?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-04-08 02:49</div>
            <div class="timeline-body"><p>Looks good to me!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2025-04-08 06:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-04-08 06:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-08 06:37</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:11:16 UTC
    </footer>
</body>
</html>
