<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transition to salsa coarse-grained tracked structs - astral-sh/ruff #15763</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Transition to salsa coarse-grained tracked structs</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15763">#15763</a>
        opened by <a href="https://github.com/ibraheemdev">@ibraheemdev</a>
        on 2025-01-27 04:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a></div>
            <div class="timeline-body">

Summary
<p>Transition to using coarse-grained tracked structs (depends on <a href="https://github.com/salsa-rs/salsa/pull/657">salsa-rs/salsa#657</a>). For now, this PR doesn&#x27;t add any <code>#[tracked]</code> fields, meaning that any changes cause the entire struct to be invalidated. It also changes <code>AstNodeRef</code> to be compared/hashed by pointer address, instead of performing a deep AST comparison.</p>
Test Plan
<p>This yields a 10-15% improvement on my machine (though weirdly some runs were 5-10% without being flagged as inconsistent by criterion, is there some non-determinism involved?). It&#x27;s possible that some of this is unrelated, I&#x27;ll try applying the patch to the current salsa version to make sure.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-01-27 04:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-01-27 04:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/red_knot_python_semantic/src/module_resolver/resolver.rs</code>:21 on 2025-01-27 04:31</div>
            <div class="timeline-body"><p>This change was caused by the new bounds introduced in https://github.com/salsa-rs/salsa/commit/f428a94a9f350d35ae5c68c6e1e11db7fe74d87a. I&#x27;m not sure why there&#x27;s no blanket implementation for <code>&amp;T</code> anymore.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-01-27 04:41</div>
            <div class="timeline-body">



<a href="https://codspeed.io/astral-sh/ruff/branches/ibraheemdev%3Asalsa-coarse-deps">CodSpeed Performance Report</a>
Merging #15763 will <strong>improve performances by 14.08%</strong>
<p>Comparing <code>ibraheemdev:salsa-coarse-deps</code> (ba377f2) with <code>main</code> (7fbd89c)</p>
Summary
<p><code>âš¡ 2</code> improvements<br>
<code>âœ… 30</code> untouched benchmarks</p>
Benchmarks breakdown
<p>|     | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| âš¡ | <code>red_knot_check_file[cold]</code> | 95 ms | 90.7 ms | +4.73% |
| âš¡ | <code>red_knot_check_file[incremental]</code> | 5.2 ms | 4.5 ms | +14.08% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-01-27 05:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-27 06:18</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>âœ… ecosystem check detected no linter changes.</p>
Linter (preview)
<p>âœ… ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>âœ… ecosystem check detected no format changes.</p>
Formatter (preview)
<p>âœ… ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-02-08 09:34</div>
            <div class="timeline-body"><p>@MichaReiser this is now failing because of the new <code>Update</code> trait requirement. I&#x27;m unsure how to implement that for the <code>ParsedModule</code>, <code>SourceText</code>, and <code>LineIndex</code> types (or should I be using a macro to derive it somehow)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-02-08 09:39</div>
            <div class="timeline-body"><p>Ah there is a derive macro, I missed that. There are... a lot of types that need to implement <code>Update</code> now ðŸ˜…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-08 15:57</div>
            <div class="timeline-body"><blockquote>
<p>Ah there is a derive macro, I missed that. There are... a lot of types that need to implement <code>Update</code> now ðŸ˜…</p>
</blockquote>
<p>It seems you found the <code>Update</code> derive macro. Yeah, I&#x27;m sorry about that. Feel free to only upgrade right before the commit introducing the <code>Update</code> constraint or let me know when you want some help adding <code>Update</code> implementations and I can commit right to this branch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-08 15:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/module_resolver/resolver.rs</code>:21 on 2025-02-08 15:57</div>
            <div class="timeline-body"><p>Upstream PR <a href="https://github.com/salsa-rs/salsa/pull/678">salsa-rs/salsa#678</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-08 20:32</div>
            <div class="timeline-body"><p>I went ahead and added the required update implementations. This requires <a href="https://github.com/salsa-rs/salsa/pull/680">salsa-rs/salsa#680</a></p>
<p>However... There are now weird panics. Somethings off. I was able to narrow it down to <em>something something</em> coarse grained dependencies because backing out of those commits makes the panics go away. Do you remember what&#x27;s different from the version where you created this PR the first time and the coarse grained dependency that now is in salsa main?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-02-08 20:37</div>
            <div class="timeline-body"><blockquote>
<p>Do you remember what&#x27;s different from the version where you created this PR the first time and the coarse grained dependency that now is in salsa main?</p>
</blockquote>
<p>I believe the only difference is the ingredients only being created for tracked fields. However, we don&#x27;t even use any tracked fields in this PR, so I don&#x27;t see how that could be an issue. This is the commit from the original: <a href="https://github.com/salsa-rs/salsa/commit/9436f8ff6b39d052d435a35467871132cb92bea3">9436f8ff6b39d052d435a35467871132cb92bea3</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-08 20:58</div>
            <div class="timeline-body"><p>Hmm, I now tried bisecting which commit of that PR causes the problem but I had to back out all commits to make it work again. I have to find a more minimum reproduction but not sure how to do that...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-08 21:12</div>
            <div class="timeline-body"><p>Backing out <a href="https://github.com/salsa-rs/salsa/pull/647">salsa-rs/salsa#647</a> does the trick too</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">do-not-merge</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-09 15:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-09 15:14</div>
            <div class="timeline-body"><p>The <code>dependency_implicit_instance_attribute</code> test fails now. It suggests that we broke incrementality somehow (we end up performing type inference in a file that&#x27;s unchanged). Good that @sharkdp added that test. However, it&#x27;s very unclear to me what&#x27;s triggering the invalidation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-09 15:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/constraint.rs</code>:45 on 2025-02-09 15:16</div>
            <div class="timeline-body"><p>Countme&#x27;s <code>eq</code> implementation is a no-op anyway</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-09 17:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/constraint.rs</code>:38 on 2025-02-09 17:13</div>
            <div class="timeline-body"><p><code>Expression</code> is <code>Copy</code>, no need to return a ref</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/expression.rs</code>:45 on 2025-02-09 17:18</div>
            <div class="timeline-body"><p>It&#x27;s a bit unfortunate but we still need to keep the <code>tracked</code> for the <code>AstNodeRef</code> itself as @sharkdp test demonstrated it. The problem otherwise is that all definitions and expressions get new ids in the next revision, which in turn invalidates all <code>AttributeAssignment</code>, and the <code>attribute_assignments</code> query. The only way around this is if we use ids instead of actual ast nodes, ideally ids that are numbered per scope instead of globally to avoid that inserting an expression at the top invalidates the ids of all lower expressions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-09 17:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-09 17:19</div>
            <div class="timeline-body"><p>@ibraheemdev I think this PR is ready for review. We only need to wait for the salsa PR to merge so that we can update the dependnecy</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-10 14:22</div>
            <div class="timeline-body"><p>The upstream PR should be merged (is about to be merged). We can remove the <code>do-not-merge</code> label once the PR uses the commit from upstream salsa.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-10 17:22</div>
            <div class="timeline-body"><p>I updated the salsa dep to use the upstream commit and I&#x27;ll mark it ready for review. It might be good to get a review from someone other than me, considering that I did some of the work but I think it&#x27;s also fine if it&#x27;s just me reviewing it if everyone else is short on time. I&#x27;ll merge the PR on Wednesday if it hasn&#x27;t received any reviews by then.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">do-not-merge</span> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-10 17:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-10 17:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-10 17:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-10 17:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-10 17:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/ast_node_ref.rs</code>:94 on 2025-02-10 18:36</div>
            <div class="timeline-body"><p>What is the relationship of this change to the rest of the PR?</p>
<p>Could we do this today in main, independently of the tracked-struct changes? And if we did, how much of the perf win of this PR would come with it?</p>
<p>(Not really suggesting we need to split it out, just trying to understand this change and its perf impact better.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-10 18:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/statistics.rs</code>:1 on 2025-02-10 18:38</div>
            <div class="timeline-body"><p>I&#x27;m okay with removing this module for now per the conversation we had in <a href="https://github.com/astral-sh/ruff/pull/15834">astral-sh/ruff#15834</a>, but it seems unrelated to the PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/statistics.rs</code>:1 on 2025-02-10 18:39</div>
            <div class="timeline-body"><p>It is related in the sense that the upgrade requires changes to that module and I decided that it&#x27;s not worth my time updating unused code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-10 18:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/semantic_index/definition.rs</code>:38 on 2025-02-10 18:43</div>
            <div class="timeline-body"><p>Should we add a comment here explaining why this needs to be tracked?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/semantic_index/expression.rs</code>:45 on 2025-02-10 18:45</div>
            <div class="timeline-body"><p>...and using IDs also requires that we allocate the AST in an arena so we have free efficient lookup from ID to node, otherwise the lookup becomes expensive.</p>
<p>This makes sense; should we document it in a code comment?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/semantic_index/use_def.rs</code>:281 on 2025-02-10 18:46</div>
            <div class="timeline-body"><p>I guess maybe it&#x27;s too late to be worth it now, but it might have made sense to do the <code>salsa::Update</code> bound change first in a separate PR, and the coarse-grained structs separately?</p>
<p>I don&#x27;t <em>love</em> this Salsa-specific trait &quot;infecting&quot; a bunch of previously independent code, but it&#x27;s pretty harmless and not an invasive change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-02-10 18:53</div>
            <div class="timeline-body"><p>Looks reasonable to me!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-10 19:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/ast_node_ref.rs</code>:94 on 2025-02-10 19:27</div>
            <div class="timeline-body"><p>We could probably revert this change now that <code>AstNodeRef</code> fields are <code>tracked</code> again. Let me try tomorrow.</p>
<p>I don&#x27;t think changing the implementation on main would lead to a performance improvement because all <code>AstNodeRef</code> fields are marked with <code>no_eq</code> and are never marked as <code>id</code> (they&#x27;re never hashed). That means this implementation should be mostly unused today.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-10 19:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/use_def.rs</code>:281 on 2025-02-10 19:29</div>
            <div class="timeline-body"><p>Ideally yes. But it&#x27;s not realy possible because of the order in which the PRs merged into Salsa. Coarse grained dependencies reqiures a bug fix that merged after the require <code>Update</code> trait PR and adding the <code>Update</code> requires the most recent commit which requires fewer <code>Update</code> implementations than the first PR...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-11 10:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/expression.rs</code>:45 on 2025-02-11 10:08</div>
            <div class="timeline-body"><p>Hmm, not sure where the best place is. I&#x27;ll add it to <code>AstNodeRef</code> because that&#x27;s the only &quot;common&quot; place or I&#x27;d have to document it on every tracked struct</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-11 10:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/statistics.rs</code>:1 on 2025-02-11 10:29</div>
            <div class="timeline-body"><p>this is enough to make everything compile without warnings, FWIW :P</p>
<pre><code>diff --git a/crates/red_knot_python_semantic/src/types/statistics.rs b/crates/red_knot_python_semantic/src/types/statistics.rs
index 625a38d52..561765dd3 100644
--- a/crates/red_knot_python_semantic/src/types/statistics.rs
+++ b/crates/red_knot_python_semantic/src/types/statistics.rs
@@ -1,11 +1,12 @@
+#![allow(unused)]
+
 use crate::types::{infer_scope_types, semantic_index, Type};
 use crate::Db;
 use ruff_db::files::File;
 use rustc_hash::FxHashMap;
 
 /// Get type-coverage statistics for a file.
-#[salsa::tracked(return_ref)]
-pub fn type_statistics&lt;&#x27;db&gt;(db: &amp;&#x27;db dyn Db, file: File) -&gt; TypeStatistics&lt;&#x27;db&gt; {
+pub(crate) fn type_statistics(db: &amp;dyn Db, file: File) -&gt; TypeStatistics {
     let _span = tracing::trace_span!(&quot;type_statistics&quot;, file=?file.path(db)).entered();
 
     tracing::debug!(
@@ -71,7 +72,7 @@ mod tests {
         db: &amp;&#x27;db mut TestDb,
         filename: &amp;str,
         source: &amp;str,
-    ) -&gt; &amp;&#x27;db TypeStatistics&lt;&#x27;db&gt; {
+    ) -&gt; TypeStatistics&lt;&#x27;db&gt; {
         db.write_dedented(filename, source).unwrap();
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-11 10:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-11 10:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-02-11 17:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/ast_node_ref.rs</code>:94 on 2025-02-11 17:16</div>
            <div class="timeline-body"><p>It looks like you decided not to revert this change? Anything worth documenting about why?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:10:52 UTC
    </footer>
</body>
</html>
