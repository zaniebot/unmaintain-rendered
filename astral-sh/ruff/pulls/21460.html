<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Suppress completions when introducing names with `as` - astral-sh/ruff #21460</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Suppress completions when introducing names with <code>as</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21460">#21460</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2025-11-14 17:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a></div>
            <div class="timeline-body"><p>There are a few places in Python where it is known that new names are
being introduced and thus we probably shouldn&#x27;t offer completions. We
already handle this today for things like <code>class &lt;CURSOR&gt;</code> and <code>def &lt;CURSOR&gt;</code>. But we didn&#x27;t handle <code>as &lt;CURSOR&gt;</code>, which can appear in
<code>import</code>, <code>with</code>, <code>except</code> and <code>match</code> statements. Indeed, these are
exactly the 4 cases where the <code>as</code> keyword can occur. So we look for the
presence of <code>as</code> and suppress completions based on that.</p>
<p>While we&#x27;re here, we also make the implementation a bit more robust with
respect to suppressing completions when the user hasn&#x27;t typed anything.
Namely, previously, we&#x27;d still offer completions in a <code>class &lt;CURSOR&gt;</code>
context. But it looks like LSP clients (at least, VS Code) doesn&#x27;t ask
for completions here, so we were &quot;saved&quot; incidentally. This PR detects
this case and suppresses completions there so we don&#x27;t rely on LSP
client behavior to handle that case correctly.</p>
<p>Fixes astral-sh/ty#1287</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-11-14 17:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-11-14 17:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-11-14 17:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-11-14 17:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-11-14 17:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/dcreager">@dcreager</a> removed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-11-14 17:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/carljm">@carljm</a> removed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-11-14 17:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/sharkdp">@sharkdp</a> removed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-11-14 17:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-11-14 17:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-11-14 17:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-11-14 17:49</div>
            <div class="timeline-body"><p>Demo:</p>
<p>https://github.com/user-attachments/assets/b595bf9d-1bc7-4a87-b4ac-a45d694cc36a</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-14 17:51</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-14 17:51</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>scikit-build-core (https://github.com/scikit-build/scikit-build-core)
- src/scikit_build_core/build/wheel.py:98:20: error[no-matching-overload] No overload of bound method `__init__` matches arguments
- Found 44 diagnostics
+ Found 43 diagnostics


</code></pre>


<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/completion.rs</code>:935 on 2025-11-14 18:26</div>
            <div class="timeline-body"><p>(optional, obviously)</p>
<pre><code>    if last.kind() != TokenKind::Name &amp;&amp; !last.kind().is_keyword() {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/completion.rs</code>:3175 on 2025-11-14 18:29</div>
            <div class="timeline-body"><p>❤️</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-11-14 18:35</div>
            <div class="timeline-body"><p>Very nice, thank you!</p>
<p>The ony issue I spotted from manual testing is that in this location, <code>as</code> does not seem to be suggested (and in fact, <code>as</code> should probably be the <em>only</em> suggestion in this context?). But that&#x27;s probably a distinct issue to the ones being fixed in this PR.</p>
<p>(Screengrab is from a playground build using your PR branch)</p>
<p><img alt="image" src="https://github.com/user-attachments/assets/6d2e2616-0ab5-4449-a566-a8ac6b106fac"></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-11-14 18:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-14 18:41</div>
            <div class="timeline-body"><blockquote>
<p>Fixes <a href="https://github.com/astral-sh/ty/issues/1287">astral-sh/ty#1287</a></p>
</blockquote>
<p>The first three bullets in <a href="https://github.com/astral-sh/ty/issues/1287">astral-sh/ty#1287</a>#issuecomment-3527860427 will not be fixed by this PR -- but we can open a followup issue(s) for those</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:935 on 2025-11-14 19:11</div>
            <div class="timeline-body"><p>I very weakly prefer <code>matches!</code> here. :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-11-14 19:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-11-14 19:12</div>
            <div class="timeline-body"><blockquote>
<p>The ony issue I spotted from manual testing is that in this location, <code>as</code> does not seem to be suggested (and in fact, <code>as</code> should probably be the <em>only</em> suggestion in this context?). But that&#x27;s probably a distinct issue to the ones being fixed in this PR.</p>
</blockquote>
<p>Yeah good catch. This is indeed a distinct issue. The <code>import</code> detection allows false positives, but not for any specifically compelling reason. I&#x27;ll open a new issue for this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-11-14 19:20</div>
            <div class="timeline-body"><p>I&#x27;ve filed <a href="https://github.com/astral-sh/ty/issues/1563">astral-sh/ty#1563</a> and <a href="https://github.com/astral-sh/ty/issues/1562">astral-sh/ty#1562</a> as additional work here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-11-14 19:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-11-14 19:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-11-14 19:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:20:40 UTC
    </footer>
</body>
</html>
