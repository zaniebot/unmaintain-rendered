```yaml
number: 5297
title: Basic string formatting
type: pull_request
state: merged
author: MichaReiser
labels:
  - internal
  - formatter
assignees: []
merged: true
base: main
head: format-string
created_at: 2023-06-22T12:20:31Z
updated_at: 2023-06-23T08:05:13Z
url: https://github.com/astral-sh/ruff/pull/5297
synced_at: 2026-01-12T15:55:18Z
```

# Basic string formatting

---

_@MichaReiser_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This PR implements formatting for non-f-string Strings that do not use implicit concatenation. 

Docstring formatting is out of the scope of this PR.

<!-- What's the purpose of the change? What does it do, and why? -->

## Test Plan

I added a few tests for simple string literals. 

## Performance

Ouch. This is hitting performance somewhat hard. This is probably because we now iterate each string a couple of times:

1. To detect if it is an implicit string continuation
2. To detect if the string contains any new lines
3. To detect the preferred quote
4. To normalize the string

Edit: I integrated the detection of newlines into the preferred quote detection so that we only iterate the string three time.
We can probably do better by merging the implicit string continuation with the quote detection and new line detection by iterating till the end of the string part and returning the offset. We then use our simple tokenizer to skip over any comments or whitespace until we find the first non trivia token. From there we keep continue doing this in a loop until we reach the end o the string. I'll leave this improvement for later. 

---

_Comment by @MichaReiser on 2023-06-22 12:20_

Current dependencies on/for this PR:
* main
  * **PR #5289** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5289" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #5292** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5292" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #5297** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5297" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/5297?utm_source=stack-comment).

---

_Comment by @github-actions[bot] on 2023-06-22 12:49_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01      7.4Â±0.35ms     5.5 MB/sec    1.00      7.3Â±0.32ms     5.6 MB/sec
formatter/numpy/ctypeslib.py               1.00  1723.0Â±93.08Âµs     9.7 MB/sec    1.01  1741.2Â±93.18Âµs     9.6 MB/sec
formatter/numpy/globals.py                 1.00   207.5Â±13.20Âµs    14.2 MB/sec    1.02   210.7Â±13.52Âµs    14.0 MB/sec
formatter/pydantic/types.py                1.04      3.9Â±0.40ms     6.5 MB/sec    1.00      3.8Â±0.21ms     6.7 MB/sec
linter/all-rules/large/dataset.py          1.07     15.7Â±0.92ms     2.6 MB/sec    1.00     14.7Â±0.46ms     2.8 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.7Â±0.15ms     4.5 MB/sec    1.01      3.7Â±0.18ms     4.5 MB/sec
linter/all-rules/numpy/globals.py          1.00   472.5Â±24.15Âµs     6.2 MB/sec    1.04   491.9Â±28.96Âµs     6.0 MB/sec
linter/all-rules/pydantic/types.py         1.01      6.6Â±0.31ms     3.8 MB/sec    1.00      6.6Â±0.33ms     3.9 MB/sec
linter/default-rules/large/dataset.py      1.00      7.2Â±0.25ms     5.7 MB/sec    1.07      7.7Â±0.45ms     5.3 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1580.9Â±77.03Âµs    10.5 MB/sec    1.04  1650.6Â±122.86Âµs    10.1 MB/sec
linter/default-rules/numpy/globals.py      1.00   189.4Â±10.17Âµs    15.6 MB/sec    1.01   191.5Â±12.14Âµs    15.4 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.4Â±0.18ms     7.5 MB/sec    1.00      3.4Â±0.14ms     7.5 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      8.0Â±0.09ms     5.1 MB/sec    1.00      8.0Â±0.07ms     5.1 MB/sec
formatter/numpy/ctypeslib.py               1.00  1773.0Â±15.83Âµs     9.4 MB/sec    1.00  1777.6Â±17.46Âµs     9.4 MB/sec
formatter/numpy/globals.py                 1.00    203.9Â±5.46Âµs    14.5 MB/sec    1.00    203.9Â±4.40Âµs    14.5 MB/sec
formatter/pydantic/types.py                1.00      4.1Â±0.04ms     6.3 MB/sec    1.01      4.1Â±0.06ms     6.2 MB/sec
linter/all-rules/large/dataset.py          1.00     15.2Â±0.12ms     2.7 MB/sec    1.00     15.3Â±0.08ms     2.7 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.1Â±0.10ms     4.1 MB/sec    1.00      4.1Â±0.02ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.00    427.5Â±6.56Âµs     6.9 MB/sec    1.00    428.0Â±8.00Âµs     6.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.9Â±0.04ms     3.7 MB/sec    1.01      6.9Â±0.06ms     3.7 MB/sec
linter/default-rules/large/dataset.py      1.00      8.0Â±0.09ms     5.1 MB/sec    1.00      8.1Â±0.05ms     5.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1671.0Â±15.33Âµs    10.0 MB/sec    1.00  1677.3Â±22.38Âµs     9.9 MB/sec
linter/default-rules/numpy/globals.py      1.00    181.6Â±3.37Âµs    16.2 MB/sec    1.00    181.5Â±1.88Âµs    16.3 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.6Â±0.02ms     7.0 MB/sec    1.01      3.7Â±0.02ms     7.0 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Marked ready for review by @MichaReiser on 2023-06-22 14:50_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/string.rs`:110 on 2023-06-22 15:08_

can we debug_assert that this is only `"` or `'` or can it be other chars, too?

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/string.rs`:131 on 2023-06-22 15:09_

surprisingly, i've never seen this before

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/string.rs`:140 on 2023-06-22 15:10_

so glad about having gotten rid of python 2 compat everywhere :D 

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/string.rs`:154 on 2023-06-22 15:11_

i didn't realize this when using black, i always thought it was doing double quotes always, interesting to know

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/string.rs`:155 on 2023-06-22 15:12_

would it also be possible to count `'` and `"` in the range?

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/string.rs`:230 on 2023-06-22 15:23_

Could you add a `"\\"` (a backstring escaping a backstring) test, maybe with some form of  `"\\' \"\""`  ?

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/string.rs`:247 on 2023-06-22 15:28_

```suggestion
                    // Remove the escape by ending before the backstring and starting again with the quote
                    last_index = index + '\\'.len_utf8();
```

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/string.rs`:252 on 2023-06-22 15:29_

that's a neat trick, but i think it needs a comment somewhere at the top of the function

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/lib.rs`:345 on 2023-06-22 15:30_

why is that gone?

---

_@konstin approved on 2023-06-22 15:30_

---

_@MichaReiser reviewed on 2023-06-22 15:56_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/lib.rs`:345 on 2023-06-22 15:56_

My understanding is that `ensure_stability_when_formatting_twice` now already asserts that reformatting the file twice yields the same result. Thanks to your refactor :)

---

_@MichaReiser reviewed on 2023-06-22 15:57_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/string.rs`:131 on 2023-06-22 15:57_

I should probably add a comment linking to https://black.readthedocs.io/en/stable/the_black_code_style/current_style.html#r-strings-and-r-strings

---

_@MichaReiser reviewed on 2023-06-22 16:06_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/string.rs`:155 on 2023-06-22 16:06_

I simplified the logic a bit. What this code does is counting the `'` and `"` but in a single pass. Calling `.count()` would (possibly) traverse the string twice.

---

_Label `internal` added by @MichaReiser on 2023-06-22 16:37_

---

_Label `formatter` added by @MichaReiser on 2023-06-22 16:37_

---

_Comment by @MichaReiser on 2023-06-23 07:35_

[Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/5297) rebased this pull request after merging its parent, because this pull request is set to merge when ready.

---

_Merged by @MichaReiser on 2023-06-23 07:46_

---

_Closed by @MichaReiser on 2023-06-23 07:46_

---

_Branch deleted on 2023-06-23 07:46_

---

_Comment by @MichaReiser on 2023-06-23 07:46_

@MichaReiser merged this pull request with [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/5297).

---
