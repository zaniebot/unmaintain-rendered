```yaml
number: 6507
title: Indent statements in suppressed ranges
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: fix-suppressed-indentation
created_at: 2023-08-11T17:12:58Z
updated_at: 2023-08-15T06:00:37Z
url: https://github.com/astral-sh/ruff/pull/6507
synced_at: 2026-01-12T15:55:21Z
```

# Indent statements in suppressed ranges

---

_@MichaReiser_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This PR implements logic to fix up the indentation of suppressed statement ranges to prevent that formatting the following file results in a syntax error:

```python
if True:
  pass
  # fmt: off
  print("test")

# Before
if True:
    pass
  # fmt: off
  print("test")

# After this PR
if True:
    pass
    # fmt: off
    print("test")

```

* The relative indent of nested statements remains unchanged. 
* Indentations of parenthesized expressions remain unchanged. Users have to fix these indents up manually. This is to align the `fmt: skip` and `fmt: off` behavior (re-indents the statement, but not its content)


It may be a bit surprising that this PR also changes the indentation of comments. This is necessary to avoid that a comment getting associated with a different node after formatting once, if the indentation sequence changed: 

For example, if we format the following with an indent of 4 spaces:

```python
# fmt: off
def test():
  pass

  # It is necessary to indent comments because the following fmt: on comment because it otherwise becomes a trailing comment
  # of the `test` function if the "proper" indentation is larger than 2 spaces.
  # fmt: on

disabled +  formatting;
```

The output without re-indenting comments would be:

```python
# fmt: off
def test():
	pass

  # It is necessary to indent comments because the following fmt: on comment because it otherwise becomes a trailing comment
  # of the `test` function if the "proper" indentation is larger than 2 spaces.
  # fmt: on

disabled +  formatting;
```

This results in an instability because the end of body comments of `test` now have a smaller indentation than `pass`, resulting in the formatter associating these as trailing comments of the function `test` rather than the `pass` statement. Now, `fmt: on` suddenly re-enables formatting of `disabled + formatting;`

The re-formatting of comments and statements may be controversial inside of a `fmt: off..fmt: on` region but the benefits of being able to format files with suppressed ranges rather than just failing if the indentations end up miss matching outweighs the maybe surprising behavior mainly because it results in no chance if the statements are correctly indented. 


## Test Plan

I added new test cases, including test cases with mixed indentation.


---

_Comment by @MichaReiser on 2023-08-11 17:13_

Current dependencies on/for this PR:
* main
  * **PR #6443** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6443" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #6452** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6452" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #6477** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6477" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #6507** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6507" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
          * **PR #6561** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6561" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6507?utm_source=stack-comment).

---

_Review comment by @MichaReiser on `crates/ruff_formatter/src/printer/mod.rs`:110 on 2023-08-11 17:14_

This was an awkward bug. The form feed character has a width of 0, but we need to print it. I hope this won't hurt performance much (one more field to track and write)

---

_@MichaReiser reviewed on 2023-08-11 17:14_

---

_Label `formatter` added by @MichaReiser on 2023-08-11 17:14_

---

_Comment by @github-actions[bot] on 2023-08-11 17:44_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      4.5Â±0.06ms     8.9 MB/sec    1.00      4.6Â±0.06ms     8.9 MB/sec
formatter/numpy/ctypeslib.py               1.00    889.4Â±6.43Âµs    18.7 MB/sec    1.01    898.5Â±4.05Âµs    18.5 MB/sec
formatter/numpy/globals.py                 1.00     90.2Â±0.64Âµs    32.7 MB/sec    1.06     95.6Â±5.45Âµs    30.9 MB/sec
formatter/pydantic/types.py                1.00  1781.8Â±28.44Âµs    14.3 MB/sec    1.02   1809.1Â±6.54Âµs    14.1 MB/sec
linter/all-rules/large/dataset.py          1.02     13.0Â±0.45ms     3.1 MB/sec    1.00     12.6Â±0.09ms     3.2 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.3Â±0.04ms     5.0 MB/sec    1.00      3.3Â±0.03ms     5.0 MB/sec
linter/all-rules/numpy/globals.py          1.01    473.1Â±8.17Âµs     6.2 MB/sec    1.00    470.2Â±0.72Âµs     6.3 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.5Â±0.17ms     3.9 MB/sec    1.02      6.6Â±0.52ms     3.8 MB/sec
linter/default-rules/large/dataset.py      1.00      6.6Â±0.09ms     6.2 MB/sec    1.02      6.7Â±0.04ms     6.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1430.4Â±13.88Âµs    11.6 MB/sec    1.02   1455.6Â±4.67Âµs    11.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    168.6Â±1.16Âµs    17.5 MB/sec    1.00    169.1Â±0.44Âµs    17.4 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.9Â±0.04ms     8.7 MB/sec    1.01      3.0Â±0.02ms     8.6 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01      4.2Â±0.05ms     9.6 MB/sec    1.00      4.2Â±0.05ms     9.7 MB/sec
formatter/numpy/ctypeslib.py               1.00   796.0Â±10.80Âµs    20.9 MB/sec    1.00   793.3Â±14.85Âµs    21.0 MB/sec
formatter/numpy/globals.py                 1.00     82.0Â±2.03Âµs    36.0 MB/sec    1.00     81.8Â±1.96Âµs    36.1 MB/sec
formatter/pydantic/types.py                1.01  1678.5Â±31.20Âµs    15.2 MB/sec    1.00  1664.2Â±27.01Âµs    15.3 MB/sec
linter/all-rules/large/dataset.py          1.02     13.0Â±0.17ms     3.1 MB/sec    1.00     12.7Â±0.12ms     3.2 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.6Â±0.03ms     4.6 MB/sec    1.00      3.5Â±0.07ms     4.7 MB/sec
linter/all-rules/numpy/globals.py          1.02    372.1Â±9.55Âµs     7.9 MB/sec    1.00    364.5Â±7.95Âµs     8.1 MB/sec
linter/all-rules/pydantic/types.py         1.01      6.6Â±0.07ms     3.8 MB/sec    1.00      6.5Â±0.06ms     3.9 MB/sec
linter/default-rules/large/dataset.py      1.00      7.0Â±0.06ms     5.8 MB/sec    1.00      7.0Â±0.11ms     5.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01  1468.5Â±37.67Âµs    11.3 MB/sec    1.00  1448.9Â±20.34Âµs    11.5 MB/sec
linter/default-rules/numpy/globals.py      1.04    151.4Â±3.68Âµs    19.5 MB/sec    1.00    145.3Â±3.18Âµs    20.3 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.1Â±0.04ms     8.1 MB/sec    1.00      3.1Â±0.02ms     8.2 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Review requested from @konstin by @MichaReiser on 2023-08-14 11:48_

---

_Review requested from @charliermarsh by @MichaReiser on 2023-08-14 11:49_

---

_Marked ready for review by @MichaReiser on 2023-08-14 11:49_

---

_Review comment by @konstin on `crates/ruff_python_formatter/resources/test/fixtures/ruff/fmt_on_off/.editorconfig`:3 on 2023-08-14 12:56_

that's neat, do we want that for the entire formatter fixtures?

---

_Review comment by @konstin on `crates/ruff_formatter/src/printer/mod.rs`:111 on 2023-08-14 12:58_

can this value be something except 0 or >0?

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/verbatim.rs`:605 on 2023-08-14 13:00_

There's already an `Indentation` in ruff_python_parser, do we want to give this one a different name?

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/verbatim.rs`:618 on 2023-08-14 13:05_

i'd have gone for .take_while.count

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/verbatim.rs`:613 on 2023-08-14 13:06_

you taught me about `is_python_whitespace`

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/verbatim.rs`:677 on 2023-08-14 13:23_

i like the docstring solution of only stripping the shared leading indentation, through docstring we would also already have the utils for that, except for own line comments.

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/verbatim.rs`:794 on 2023-08-14 13:46_

what would that content be and how do we know whether it contains newlines?

---

_@konstin approved on 2023-08-14 13:50_

---

_@MichaReiser reviewed on 2023-08-14 13:56_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/verbatim.rs`:618 on 2023-08-14 13:56_

I had that initially but clippy loves to complain about a possible truncation. So I ended up changing it.

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/verbatim.rs`:613 on 2023-08-14 13:57_

This is intentionally different because we don't want to trim any form-feed characters (see the `form_feed.py` test case)

---

_@MichaReiser reviewed on 2023-08-14 13:57_

---

_@MichaReiser reviewed on 2023-08-14 14:25_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/verbatim.rs`:677 on 2023-08-14 14:25_

I would like that too. But we would need to track two different indentations:

* One to strip before statements
* The shared leading indentation, for comments

It may otherwise result in invalid code if a comment has less indentation than the statements. I think we consider introducing this complexity if we get reports that our fmt: off breaks the intended formatting (or e.g. test if the entire suite is disabled, and if so, don't fix up the indent)




---

_@charliermarsh reviewed on 2023-08-14 14:28_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/verbatim.rs`:609 on 2023-08-14 14:28_

How does this implementation handle multi-statement lines? Like `x = 1; import os`. Or, is that not relevant since you can't have a comment _within_ a multi-statement line (and so the `first_suppressed` is guaranteed to be at the start of a logical line)?

---

_@charliermarsh reviewed on 2023-08-14 14:31_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/verbatim.rs`:844 on 2023-08-14 14:31_

Off-topic: do you have a general preference between `<T: Ranged>` and `where T: Ranged`?

---

_@charliermarsh approved on 2023-08-14 14:32_

---

_@MichaReiser reviewed on 2023-08-14 14:33_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/verbatim.rs`:609 on 2023-08-14 14:33_

This is an interesting case. This works because the `fmt: off` comment must be an own line comment. Meaning either the whole multiline statement gets formatted or suppressed. 

---

_@MichaReiser reviewed on 2023-08-14 14:34_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/verbatim.rs`:844 on 2023-08-14 14:34_

Uhm, not consciously. I generally avoid using `impl` (but there are exceptions), and lean towards `where` because I find them more readable when more complicated constraints become necessary.

---

_@konstin reviewed on 2023-08-14 14:50_

---

_Review comment by @konstin on `crates/ruff_python_formatter/resources/test/fixtures/ruff/fmt_on_off/indent.py`:40 on 2023-08-14 14:50_

Could you add a multi line string test case?

---

_@konstin reviewed on 2023-08-14 14:55_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/verbatim.rs`:613 on 2023-08-14 14:55_

could you add a comment about this?

---

_@MichaReiser reviewed on 2023-08-14 15:50_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/resources/test/fixtures/ruff/fmt_on_off/.editorconfig`:3 on 2023-08-14 15:50_

Maybe. Let me move it.

---

_@MichaReiser reviewed on 2023-08-14 15:52_

---

_Review comment by @MichaReiser on `crates/ruff_formatter/src/printer/mod.rs`:111 on 2023-08-14 15:52_

No. It's a u32 and must be a zero or a positive number. But I should probably revert this change. It's unrelated. I only changed it because I first changed the printer to differentiate between no-content and a line width zero-width content. But I now opted to not make this change, so I should not change the printer here (I'm pretty sure LLVM compiles this down to the same code anyway)

---

_@MichaReiser reviewed on 2023-08-14 16:00_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/verbatim.rs`:794 on 2023-08-14 16:00_

I extended the comment to mention what content it is and changed `contains_newlines` to always be `No` because the lexer would otherwise return a `Newline` token.

---

_@MichaReiser reviewed on 2023-08-14 16:07_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/verbatim.rs`:605 on 2023-08-14 16:07_

Do you have a recommendation? I wasn't able to come up with a good name. 

I'm not too concerned about the naming conflict, considering that this is a private type.

---

_Merged by @MichaReiser on 2023-08-15 06:00_

---

_Closed by @MichaReiser on 2023-08-15 06:00_

---

_Branch deleted on 2023-08-15 06:00_

---
