<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`ruff`] Unnecessary rounding (`RUF057`) - astral-sh/ruff #14828</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>ruff</code>] Unnecessary rounding (<code>RUF057</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14828">#14828</a>
        opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a>
        on 2024-12-07 00:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a></div>
            <div class="timeline-body">Summary
<p>Resolves #14793.</p>
Test Plan
<p><code>cargo nextest run</code> and <code>cargo insta test</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-12-07 00:39</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-07 18:20</div>
            <div class="timeline-body"><p>Thanks for following up on this!</p>
<p>Would you mind splitting the PR into two if it isn&#x27;t too much work:</p>
<ol>
<li>Changes the existing rule</li>
<li>Adding the new rule</li>
</ol>
<p>Two separate PRs have the advantage that we can list the two changes separately in the changelog. It also makes it easier for me to review your PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-12-07 18:31</div>
            <div class="timeline-body"><p>@MichaReiser I would prefer not having to do that. <code>RUF057</code> depends on a <code>RUF046</code> API (<code>expr_is_strictly_int()</code>), which itself comprises most of the change to <code>RUF046</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-07 18:36</div>
            <div class="timeline-body"><p>Yeah, that&#x27;s a bit annoying. However, I just skimmed over the changes, and there&#x27;s too much going on in this PR, which makes it difficult for me and future readers to understand what it is about. That&#x27;s why I have to insist that you split the PR. I suggest three PRs:</p>
<ol>
<li>Scope change of <code>RUF046</code>
2.. Improving the integer inference of <code>RUF046</code></li>
<li>Adding the new <code>RUF057</code></li>
</ol>
<p>I&#x27;d suggest you start with one PR and then submit the next once that is merged. Or you can create stacked PRs, but they can be a bit painful when it comes to rebasing them.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[`ruff`] Detect more strict-integer expressions and move `round()` logic to new rule (`RUF046`, `RUF057`)&quot; to &quot;[`ruff`] Unnecessary ndigits argument to `round()` (`RUF057`)&quot; by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-12-08 04:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[`ruff`] Unnecessary ndigits argument to `round()` (`RUF057`)&quot; to &quot;[`ruff`] Unnecessary `ndigits` argument to `round()` (`RUF057`)&quot; by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-12-08 04:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-12-08 04:22</div>
            <div class="timeline-body"><p>All done. I don&#x27;t mind a little bit of rebasing, so stacked PRs it is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-08 17:47</div>
            <div class="timeline-body"><p>Thank you.</p>
<p>Hmm. This is not the rule I expected. From our conversation in #14793 I&#x27;d expected a rule that detects unnecessary <code>round</code> calls rather than unnecessary <code>ndigits</code>.</p>
<p>E.g. <code>round(5)</code> should be converted to just <code>5</code>. The same for <code>round(5, None)</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[`ruff`] Unnecessary `ndigits` argument to `round()` (`RUF057`)&quot; to &quot;[`ruff`] Unnecessary rounding (`RUF057`)&quot; by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2024-12-25 21:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unnecessary_rounding.rs</code>:36 on 2024-12-26 09:46</div>
            <div class="timeline-body"><pre><code>        &quot;Remove unnecessary `round` call&quot;.to_string()
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unnecessary_rounding.rs</code>:90 on 2024-12-26 09:49</div>
            <div class="timeline-body"><p>Can you tell me more about the motivation for distinguishing between <code>ResolvedInt</code> and <code>InferredInt</code>? I think this is also worth documenting because it&#x27;s not obvious to readers why the distinction is necessary.</p>
<p>It might be better to have more semantic names rather than the source  because both <code>typing::int</code> and <code>ResolvedPythonType</code> are doing type inference, which makes <code>InferredInt</code> rather confusing</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unnecessary_rounding.rs</code>:13 on 2024-12-26 09:52</div>
            <div class="timeline-body"><p>Rounding a value that&#x27;s already an integer is unnecessary. It&#x27;s more clear to use the value directly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unnecessary_rounding.rs</code>:27 on 2024-12-26 09:53</div>
            <div class="timeline-body"><p>I&#x27;m leaning towards naming the method <code>UnnecessaryRound</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-12-26 09:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-26 09:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-26 09:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unnecessary_rounding.rs</code>:90 on 2024-12-26 10:42</div>
            <div class="timeline-body"><p>The inference results of <code>ResolvedPythonType</code> is much more reliable than that of <code>InferredInt</code>, so <code>ResolvedInt</code> leads to <code>Safe</code> applicability while that of <code>InferredInt</code> is <code>Unsafe</code>. In hindsight, <code>ResolvedInt</code> should probably be merged with <code>LiteralInt</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2024-12-26 10:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-12-28 09:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unnecessary_rounding.rs</code>:90 on 2024-12-28 09:18</div>
            <div class="timeline-body"><p>As a reader, I still wonder what the difference between <code>InferredInt</code> and <code>ResolvedInt</code> is. I think we should rename the variants or add documentation (the best option is probably to do both).</p>
<p>Can you share an example where <code>InferredInt</code> returns <code>true</code> for something that shouldn&#x27;t be an <code>int</code>? Is it because booleans are assignable to <code>int</code>:</p>
<p>E.g. this is fine according to pyright</p>
<pre><code>def test(a: int) -&gt; int:
    return a

test(True)  # Returns `True`
</code></pre>
<p>But <code>round(True)</code> evaluates to <code>1</code></p>
<pre><code>&gt;&gt;&gt; round(True)
1
</code></pre>
<p>Are there more cases like this? If not, then how about renaming the <code>InferredInt</code> variant to <code>AnnotatedInt</code> or <code>Int</code> vs <code>LiteralInt</code> with a comment saying that one is equivalent to an <code>:int</code> annotation and the other <code>Literal[int]</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unnecessary_rounding.rs</code>:90 on 2024-12-28 11:25</div>
            <div class="timeline-body"><p><code>LiteralInt</code> has the false implication that the argument was given as a literal in the source code, even though it might very well be a complex expression. <code>AnnotatedInt</code> has the false implication that the variable was annotated, but <code>typing::is_int()</code> returns <code>true</code> even for names that are only bound to an assignment whose value is an integer literal:</p>
<pre><code>a = 1
_ = round(a)
#   ^^^^^^^^ RUF057
</code></pre>
<p>That we also need to account for subclasses of <code>int</code> is the reason to make the fix for <code>InferredInt</code> unsafe, yes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2024-12-28 11:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-12-30 10:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unnecessary_rounding.rs</code>:90 on 2024-12-30 10:08</div>
            <div class="timeline-body"><p>Thanks for adding some documentation. I did read it, but I&#x27;m not sure it&#x27;s very helpful because it only documents what&#x27;s already apparent from the code. What&#x27;s unclear to a reader is why the distinction is important. The names are also somewhat confusing, as you mentioned in your last comment. For example, <code>LiteralInt</code> doesn&#x27;t mean that it&#x27;s a <code>Literal</code>; it could also be a complex expression.</p>
<p>I still only have a limited understanding but my impression is that the variants for <code>RoundKind</code> are all about <em>how likely the expression is an <code>int</code></em>. Or possibly whether the value is equivalent to <code>int</code> or only assignable to int. How about we introduce a new enum to <code>InferedType</code> with the variants <code>Equivalent</code> (it&#x27;s exactly <code>int</code>), and <code>AssignableTo</code> (5 or <code>True</code>). <code>RoundKind</code> then has the variants <code>Int(InferredType)</code>, <code>Float(InferredType)</code>, and <code>Other</code> and <code>NdigitsKind</code> has <code>Absent</code>, <code>LiteralNone</code>, <code>Int(InferredType)</code>, and <code>Other</code>.</p>
<p>We can then add documentation to where we construct the <code>InferredType</code> why e.g. <code>typing::is_int</code> is <code>InferredType::AssignableTo</code> and why <code>ResolvedPythonType</code> is <code>Equivalent</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unnecessary_round.rs</code>:59 on 2024-12-31 15:51</div>
            <div class="timeline-body"><p>Some examples will help future readers</p>
<pre><code>				// ```python
        // round(3)
        // round(3, 0)
        // round(3, ..)
        // ```
        (RoundedKind::Int(InferredType::Equivalent), _) =&gt; Applicability::Safe,
</code></pre>
<p>It would also be great if we can add examples to the other branches</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unnecessary_round.rs</code>:64 on 2024-12-31 15:53</div>
            <div class="timeline-body"><p>It&#x27;s not clear to me why the round call should be unnecessary if the value is a float:</p>
<pre><code>&gt;&gt;&gt; round(3.0)
3
&gt;&gt;&gt; 3.0
3.0
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unnecessary_round.rs</code>:71 on 2024-12-31 15:54</div>
            <div class="timeline-body"><p>Same here, i don&#x27;t think we can ever remove round calls if the value is a <code>float</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unnecessary_round.rs</code>:122 on 2024-12-31 15:55</div>
            <div class="timeline-body"><pre><code>    let rounded = arguments.find_argument_value(&quot;number&quot;, 0)?;
    let ndigits = arguments.find_argument_value(&quot;ndigits&quot;, 1);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-12-31 15:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unnecessary_round.rs</code>:94 on 2024-12-31 15:57</div>
            <div class="timeline-body"><p>Nit: Rename to <code>RoundedValue</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unnecessary_round.rs</code>:102 on 2024-12-31 15:57</div>
            <div class="timeline-body"><p>Rename to <code>NdigitsValue</code>. Value is somewhat more specific than <code>Kind</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-12-31 15:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unnecessary_round.rs</code>:14 on 2024-12-31 15:58</div>
            <div class="timeline-body"><pre><code>/// It&#x27;s clearer to use the value directly.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-12-31 15:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF057.py</code>:11 on 2025-01-01 11:07</div>
            <div class="timeline-body"><p>Should we make this an error too if the value is known to be equivalent to an int? The only semantic change that I could see is that <code>round</code> no longer throws if <code>foo</code> isn&#x27;t an int. But we could make the fix unsafe to account for this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unnecessary_round.rs</code>:118 on 2025-01-01 11:19</div>
            <div class="timeline-body"><p>I removed the type alias because it wasn&#x27;t used consistently and I found it more confusing than helpful (I had to lookup what its type is). In this case, I think adding some documentation might be more helpful</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-01-01 11:25</div>
            <div class="timeline-body"><p>Thanks and happy new year. This is looking great. I&#x27;ve one last comment on where I think the rule should flag a <code>round</code> call but currently isn&#x27;t. I&#x27;m interested in why you chose to not flag that <code>round</code> call site.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2025-01-01 11:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF057.py</code>:11 on 2025-01-01 11:49</div>
            <div class="timeline-body"><p>(Happy new year to you too.) Done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-02 09:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-02 09:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-02 14:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:09:15 UTC
    </footer>
</body>
</html>
