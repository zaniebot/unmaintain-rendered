<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Approximate tokens len - astral-sh/ruff #9546</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Approximate tokens len</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/9546">#9546</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-01-16 08:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-01-16 08:11</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>The <code>parser</code> benchmark has become flaky after merging https://github.com/astral-sh/ruff/pull/9466.
A possible reason for the flakiness could be some non-determinism in jemalloc that makes it execute different branches while collecting the tokens into a <code>Vec</code>.</p>
<p>The idea of this PR is to approximate the size of the tokens <code>Vec</code> based on the source code length. The approximation used here is based on an analysis of the CPython code base and our ecosystem projects (including aiflow, black, django, transformers, twine, warehouse, zulip). I added a console output that prints the source code length and resulting <code>tokens</code> vec size for each file and piped it into a CSV. I then used a small python script to paint the $buffer/source$ distribution and picked 0.15 as a lower bound for the size of the tokens vec.</p>
<p><strong>Ecosystem</strong>
<img src="https://github.com/astral-sh/ruff/assets/1203881/19c82944-69dd-4c9a-87ef-4382fe95f5c2" alt="ecosystem" /></p>
<p><strong>CPython</strong>
<img src="https://github.com/astral-sh/ruff/assets/1203881/66c322a3-a705-4be1-9032-0be6b37b8a19" alt="python" /></p>
<blockquote>
<p><strong>Note</strong>: The 1 looks suspicious. It is due to empty files. I'm not sure why there are so many empty files</p>
</blockquote>
<p><a href="https://gist.github.com/MichaReiser/5a75f2d4ce66fb9c59b5a3ab2aa685c3">Source</a></p>
<h2>Test Plan</h2>
<p>I expected some real world perf improvements from this work but neither our <code>hyperfine</code> benchmarks nor the parser's microbenchmarks show any real improvement :shrug:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2024-01-16 08:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2024-01-16 08:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-01-16 08:52</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-01-16 20:22</div>
            <div class="timeline-body"><p>Neat idea.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2024-01-19 16:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-01-19 16:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-01-19 16:39</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 22:58:03 UTC
    </footer>
</body>
</html>
