<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[syntax-errors] Annotated name cannot be global - astral-sh/ruff #20868</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[syntax-errors] Annotated name cannot be global</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20868">#20868</a>
        opened by <a href="https://github.com/11happy">@11happy</a>
        on 2025-10-14 16:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/11happy">@11happy</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff/ty! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title? (Please prefix with `[ty]` for ty pull
  requests.)
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<!-- What's the purpose of the change? What does it do, and why? -->

<p>This PR implements a new semantic syntax error where annotated name can't be global
example</p>
<pre><code>x: int = 1

def f():
    global x
    x: str = &quot;foo&quot;  # SyntaxError: annotated name 'x' can't be global
</code></pre>
<h2>Test Plan</h2>
<!-- How was it tested? -->

<p>I have written tests as directed in #17412</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @11happy on 2025-10-14 16:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @11happy on 2025-10-14 16:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-14 17:19</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> reviewed on 2025-10-14 19:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/linter.rs</code>:1080 on 2025-10-14 19:01</div>
            <div class="timeline-body"><p>Should we also add a test case like:</p>
<pre><code>d: int = 1
def f3():
    global d
    d: str
</code></pre>
<p>to ensure we catch annotations without explicit assignments, and:</p>
<pre><code>e: int = 1
def f3():
    e: str = &quot;whatever&quot;
</code></pre>
<p>to prove that this doesn't trigger on shadowed variables that aren't actually marked with <code>global</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[syntax-errors]: annotated name connot be global" to "[syntax-errors]: annotated name cannot be global" by @amyreese on 2025-10-14 19:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/11happy">@11happy</a> reviewed on 2025-10-15 16:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/11happy">@11happy</a> on <code>crates/ruff_linter/src/linter.rs</code>:1080 on 2025-10-15 16:21</div>
            <div class="timeline-body"><p>yes, these are great additions to the testcases, I have added them, Thank you : )</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> approved on 2025-10-16 00:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @amyreese on 2025-10-16 00:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-10-17 20:26</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-17 20:35</div>
            <div class="timeline-body"><p>Actually, I thought of one more edge case, and it looks like we have a false positive:</p>
<pre><code class="language-py">global f
f: int
</code></pre>
<p>This is actually allowed in module scope, for whatever reason, but the opposite order is not:</p>
<pre><code class="language-py">f: int
global f
</code></pre>
<pre><code class="language-shell">$ python &lt;&lt;EOF
global f
f: int
EOF
$ python &lt;&lt;EOF
f: int
global f
EOF
  File &quot;&lt;stdin&gt;&quot;, line 2
SyntaxError: annotated name 'f' can't be global
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> requested changes on 2025-12-04 14:37</div>
            <div class="timeline-body"><p>Thanks for adding the new test case, but as I mentioned in my previous comment, this case is actually allowed by CPython, so the new snapshot is showing a false positive. We'll need to fix that and the merge conflicts before this can land.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/11happy">@11happy</a> on 2025-12-05 07:28</div>
            <div class="timeline-body"><blockquote>
<p>Thanks for adding the new test case, but as I mentioned in my previous comment, this case is actually allowed by CPython, so the new snapshot is showing a false positive. We'll need to fix that and the merge conflicts before this can land.</p>
</blockquote>
<p>Done, Thank you for the patience with this PR
: )</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:303 on 2025-12-08 19:59</div>
            <div class="timeline-body"><p>I pushed another test case that should still raise an error in the module scope. This <code>in_function_scope</code> check is too restrictive, we still miss the new case I added:</p>
<pre><code class="language-shell">❯ python &lt;&lt;EOF
g: int = 1
global g
EOF
  File &quot;&lt;stdin&gt;&quot;, line 2
SyntaxError: annotated name 'g' can't be global
</code></pre>
<p>I also noticed that ty actually has a false positive on the <code>f</code> case: https://play.ty.dev/d6285858-e5cf-429e-a983-291a243db217.</p>
<p>So we may want to fix that as well, if we can find a nice solution on the Ruff side.</p>
<p>For Ruff, we may be able to compare the range returned by <code>ctx.global</code> to the range of the <code>ExprName</code>. I think that's what we do for the other <code>global</code> error:</p>
<p>https://github.com/astral-sh/ruff/blob/e8540d9b085980bef22cc8e1d4c6e75531cf140c/crates/ruff_python_parser/src/semantic_errors.rs#L858-L860</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> requested changes on 2025-12-08 20:01</div>
            <div class="timeline-body"><p>Thanks for your continued work here!</p>
<p>I think we're still not quite getting the right answer in the module scope, but I had an idea for how we could fix it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/11happy">@11happy</a> reviewed on 2025-12-14 08:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/11happy">@11happy</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:303 on 2025-12-14 08:24</div>
            <div class="timeline-body"><p>with the current fix, all tests are working as expected. however, I wanted to ask about an edge case:</p>
<p>does order matter in function scope for the <code>AnnotatedGlobal</code> error? Currently, Ruff emits <code>AnnotatedGlobal</code> for this case:</p>
<pre><code class="language-python">a: str = &quot;hel&quot;
def foo():
    a: str = &quot;foo&quot;
    global a
</code></pre>
<p>But ty emits a different error  https://play.ty.dev/dc80ad75-cb1c-4f30-99f2-4fa555b191c7</p>
<p>also, since most of the errors in #17412 are now addressed, I would appreciate any suggestions for related issues or areas I could work on next. I would also be grateful if you could review some of my other open PRs when you have time.
Thank you : )</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-12-16 20:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:303 on 2025-12-16 20:11</div>
            <div class="timeline-body"><p>No I don't believe order matters in functions, only in the module scope:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; def foo():
...     a: str
...     global a
...
  File &quot;&lt;python-input-1&gt;&quot;, line 3
    global a
    ^^^^^^^^
SyntaxError: annotated name 'a' can't be global
&gt;&gt;&gt; def bar():
...     global a
...     a: str
...
  File &quot;&lt;python-input-2&gt;&quot;, line 3
    a: str
    ^^^^^^
SyntaxError: annotated name 'a' can't be global
</code></pre>
<p>at least the module scope is the only strange case I've found so far.</p>
<blockquote>
<p>But ty emits a different error <a href="https://play.ty.dev/dc80ad75-cb1c-4f30-99f2-4fa555b191c7">play.ty.dev/dc80ad75-cb1c-4f30-99f2-4fa555b191c7</a></p>
</blockquote>
<p>I think we can file a follow-up issue for ty, but I would expect the fix to be here:</p>
<p>https://github.com/astral-sh/ruff/blob/0f373603ebd007196af4f211e14d421024a6b947/crates/ty_python_semantic/src/semantic_index/builder.rs#L2275-L2282</p>
<p>Assuming both errors can be emitted in this part of the code, I would probably prioritize the <code>AnnotatedGlobal</code> error here instead of <code>LoadBeforeGlobalDeclaration</code> to match CPython.</p>
<blockquote>
<p>also, since most of the errors in https://github.com/astral-sh/ruff/issues/17412 are now addressed, I would appreciate any suggestions for related issues or areas I could work on next.</p>
</blockquote>
<p>In general, anything with the <code>help wanted</code> or <code>bug</code> labels would be great :) We don't have too many big tracking issue like #17412 open at the moment. A couple of issues that I've opened that came to mind are https://github.com/astral-sh/ruff/issues/15642 and https://github.com/astral-sh/ruff/issues/17203 if those look interesting to you.</p>
<blockquote>
<p>I would also be grateful if you could review some of my other open PRs when you have time.</p>
</blockquote>
<p>Will do! They're all in my inbox, just been busy with other tasks recently.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-12-16 20:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:305 on 2025-12-16 20:13</div>
            <div class="timeline-body"><p>Could you check how CPython and your code handle the class scope? I think we probably want to check <code>!ctx.in_module_scope()</code> here instead of specifically checking <code>in_functon_scope</code>. I'm picturing an example like this:</p>
<pre><code class="language-py">class C:
    x: str
    global x

class D:
    global x
    x: str
</code></pre>
<p>It looks like these should both be errors:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; class C:
...     x: str
...     global x
...
  File &quot;&lt;python-input-3&gt;&quot;, line 3
    global x
    ^^^^^^^^
SyntaxError: annotated name 'x' can't be global
&gt;&gt;&gt; class D:
...     global x
...     x: str
...
  File &quot;&lt;python-input-4&gt;&quot;, line 3
    x: str
    ^^^^^^
SyntaxError: annotated name 'x' can't be global
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/11happy">@11happy</a> reviewed on 2025-12-17 09:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/11happy">@11happy</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:305 on 2025-12-17 09:41</div>
            <div class="timeline-body"><p>done , Yes, these were earlier not being detected, I have updated the check with <code>!ctx.in_module_scope()</code> .</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @ntBre on 2025-12-17 13:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-12-17 13:38</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[syntax-errors]: annotated name cannot be global" to "[syntax-errors] Annotated name cannot be global" by @ntBre on 2025-12-17 13:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-12-17 13:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-12-17 13:39</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:16:25 UTC
    </footer>
</body>
</html>
