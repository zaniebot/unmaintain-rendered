<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Split off ruff_cli crate from ruff library - astral-sh/ruff #1816</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Split off ruff_cli crate from ruff library</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/1816">#1816</a>
        opened by <a href="https://github.com/not-my-profile">@not-my-profile</a>
        on 2023-01-12 13:21
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-01-12 13:21</div>
            <div class="timeline-body"><p>Please preserve the commits when merging.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/not-my-profile">@not-my-profile</a> reviewed on 2023-01-12 15:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on <code>.github/workflows/ruff.yaml</code>:37 on 2023-01-12 15:03</div>
            <div class="timeline-body"><p>I am not sure if this works ... I haven't tested it. @messense do you think that should work?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-12 15:18</div>
            <div class="timeline-body"><p>Nice! This will be a big improvement.</p>
<p>Before I dig in, I just want to confirm: there are intended to be no behavior changes here, right? As in, Ruff itself should function identically? Purely an internal refactor?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-01-12 15:20</div>
            <div class="timeline-body"><p>Yes exactly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-12 15:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>Cargo.toml</code>:7 on 2023-01-12 15:24</div>
            <div class="timeline-body"><p>I have some thoughts, but in your opinion, how does this compare to the following alternative?</p>
<blockquote>
<p>Move everything in <code>src</code> into <code>ruff_core</code>, keep <code>ruff_cli</code> as it is (roughly), then change the root to point to <code>ruff_cli/src/main.rs</code> or appropriate.</p>
</blockquote>
<p>This is, IIUC, how <a href="https://github.com/BurntSushi/ripgrep"><code>ripgrep</code></a> is structured.</p>
<p>Right now, there's a slight oddity here in that the top-level project isn't what's being packaged and distributed (which relates to having to change the working directory on CI).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>.github/workflows/ruff.yaml</code>:17 on 2023-01-12 15:25</div>
            <div class="timeline-body"><p>Should this be <code>ruff_cli</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-12 15:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/messense">@messense</a> on <code>ruff_cli/pyproject.toml</code>:16 on 2023-01-12 15:25</div>
            <div class="timeline-body"><p>This won't work for sdist since maturin doesn't know where to put the LICENSE file in sdist at the moment.</p>
<pre><code>üîó Found bin bindings
üì° Using build options bindings from pyproject.toml
üí• maturin failed
  Caused by: Failed to build source distribution
  Caused by: Failed to add file from /Users/messense/Desktop/ruff/ruff_cli/../LICENSE to sdist as ruff-0.0.219/../LICENSE
  Caused by: paths in archives must not have `..` when setting path for ruff-0.0.219
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-12 15:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>ruff_cli/pyproject.toml</code>:16 on 2023-01-12 15:26</div>
            <div class="timeline-body"><p>The <code>tool.setuptools</code> references below would need to be changed as well (though I think they're currently being ignored -- please change them though).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/messense">@messense</a> on <code>ruff_cli/pyproject.toml</code>:16 on 2023-01-12 15:27</div>
            <div class="timeline-body"><p>It might be easier to keep <code>pyproject.toml</code> in top level, and add <code>manifest-path</code> option</p>
<pre><code class="language-toml">[tool.maturin]
bindings = &quot;bin&quot;
manifest-path = &quot;ruff_cli/Cargo.toml&quot;
python-source = &quot;python&quot;
strip = true
</code></pre>
<p>Better keep <code>pyproject.toml</code> in the same level as <code>python</code> source directory, otherwise the python code in <code>python/ruff</code> won't be packaged.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/messense">@messense</a> reviewed on 2023-01-12 15:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/messense">@messense</a> reviewed on 2023-01-12 15:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/messense">@messense</a> on <code>.github/workflows/ruff.yaml</code>:37 on 2023-01-12 15:32</div>
            <div class="timeline-body"><p>Should work for building wheels but will have trouble with sdist, see https://github.com/charliermarsh/ruff/pull/1816#discussion_r1068265123, if you move <code>pyproject.toml</code> back to top level and set <code>manifest-path</code> option in it then you don't need this <code>working-directory</code> option.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/not-my-profile">@not-my-profile</a> reviewed on 2023-01-12 15:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on <code>.github/workflows/ruff.yaml</code>:17 on 2023-01-12 15:34</div>
            <div class="timeline-body"><p>Ah yes, good catch!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/messense">@messense</a> reviewed on 2023-01-12 15:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/messense">@messense</a> on <code>ruff_cli/Cargo.toml</code>:32 on 2023-01-12 15:36</div>
            <div class="timeline-body"><p>You can use cargo workspace inheritance feature to manage common dependencies between workspace members, see https://doc.rust-lang.org/cargo/reference/workspaces.html#the-dependencies-table</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>Cargo.toml</code>:7 on 2023-01-12 15:37</div>
            <div class="timeline-body"><p>(It would also be ok to say &quot;We want to do this later, since it's another big change, but it is planned.&quot; I'm mostly trying to understand and align on the desired end-state.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-12 15:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on <code>ruff_cli/pyproject.toml</code>:16 on 2023-01-12 15:39</div>
            <div class="timeline-body"><p>Thanks, I made the changes you suggested :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/not-my-profile">@not-my-profile</a> reviewed on 2023-01-12 15:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/messense">@messense</a> on 2023-01-12 15:45</div>
            <div class="timeline-body"><p>I just checked locally, looks like maturin is having trouble with this kind of layout, mostly related to <code>python-source</code> option:</p>
<ul>
<li><code>python/ruff/*</code> isn't in the right place in sdist</li>
<li><code>python/ruff/*</code> isn't packaged in wheel</li>
</ul>
<p>I'll take a look tomorrow.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/not-my-profile">@not-my-profile</a> reviewed on 2023-01-12 16:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on <code>Cargo.toml</code>:7 on 2023-01-12 16:15</div>
            <div class="timeline-body"><p>I consider the &quot;core&quot; of ruff to be conceptually separate from the rule implementations, even if they are currently entangled. So I think the crate of the currently top-level <code>src</code> directory should keep the name <code>ruff</code>, as long as it contains both the core and the rule implementations.</p>
<p>While I think it makes some sense that the top-level <code>src</code> directory contains the code that contributors are most likely interested in editing, I'd be alright with moving <code>src</code> to <code>ruff/src</code> for the sake of consistency, however we might firstly want to think about further splitting up the crate, see #1820.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on <code>ruff_cli/Cargo.toml</code>:32 on 2023-01-12 16:29</div>
            <div class="timeline-body"><p>Oh neat, I didn't know about that!</p>
<p>I guess you meant specifically for these verbose dependencies on <code>rustpython-*</code> right? I just changed <code>ruff::message</code> to <code>pub use rustpython_ast::Location;</code> and dropped the direct dependencies on rustpython-* from <code>ruff_cli</code>, which I think is even better :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/not-my-profile">@not-my-profile</a> reviewed on 2023-01-12 16:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-12 16:53</div>
            <div class="timeline-body"><p>@not-my-profile - How big of a problem will it be for you if I make some changes to the <code>pyproject.toml</code> resolution code? (Specifically, to solve #1812.) I'm happy to wait until this is merged if it saves you a headache, though guessing that will be tomorrow or the next day and not today given the packaging needs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @not-my-profile on 2023-01-12 17:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-01-12 17:26</div>
            <div class="timeline-body"><p>Thanks for asking :)</p>
<p>You could merge the first two commits from this PR first (I just opened #1822 for that). Then you can change the resolution code without causing headaches :) (The remaining two commits of this PR can be easily rebased.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-12 22:38</div>
            <div class="timeline-body"><p>@not-my-profile - Hope you feel empowered to keep pushing on these sorts of refactors. They're making the project much stronger.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/messense">@messense</a> reviewed on 2023-01-13 02:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/messense">@messense</a> on <code>ruff_cli/Cargo.toml</code>:13 on 2023-01-13 02:39</div>
            <div class="timeline-body"><pre><code class="language-suggestion"># See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html

[[bin]]
name = &quot;ruff&quot;
path = &quot;src/main.rs&quot;
doctest = false
</code></pre>
<p>To keep the binary name <code>ruff</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/messense">@messense</a> on <code>ruff_cli/Cargo.toml</code>:58 on 2023-01-13 03:04</div>
            <div class="timeline-body"><pre><code class="language-suggestion">update-informer = [&quot;dep:update-informer&quot;]

[package.metadata.maturin]
name = &quot;ruff&quot;
</code></pre>
<p>To keep the python package name <code>ruff</code> after https://github.com/PyO3/maturin/pull/1409 lands.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/messense">@messense</a> reviewed on 2023-01-13 03:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-01-13 03:14</div>
            <div class="timeline-body"><p>Thanks @messense! I have applied your suggested changes locally ... I'll force push this once the new maturin version has been published so that I can also bump the minimum version in <code>pyproject.toml</code>:</p>
<pre><code class="language-toml">[build-system]
requires = [&quot;maturin&gt;=0.14,&lt;0.15&quot;]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/messense">@messense</a> on 2023-01-13 05:19</div>
            <div class="timeline-body"><p>@not-my-profile maturin <a href="https://pypi.org/project/maturin/0.14.10/">v0.14.10</a> is out.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @not-my-profile on 2023-01-13 05:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @not-my-profile on 2023-01-13 19:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-13 19:46</div>
            <div class="timeline-body"><p>Will review (and hopefully merge) later today.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-14 01:33</div>
            <div class="timeline-body"><p>@not-my-profile - Can I squash the Clippy commit?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-14 01:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>ruff_cli/Cargo.toml</code>:10 on 2023-01-14 01:34</div>
            <div class="timeline-body"><p>@messense - This was also necessary. As-is, <code>ruff-0.0.220.dist-info/METADATA</code> was missing the README contents.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-14 01:35</div>
            <div class="timeline-body"><p>Okay, the packages are looking more similar now:</p>
<p>Before:</p>
<pre><code>‚ùØ unzip -l /Users/crmarsh/workspace/ruff/target/wheels/ruff-0.0.220-py3-none-macosx_11_0_arm64.whl
Archive:  /Users/crmarsh/workspace/ruff/target/wheels/ruff-0.0.220-py3-none-macosx_11_0_arm64.whl
  Length      Date    Time    Name
---------  ---------- -----   ----
   120482  01-14-2023 01:34   ruff-0.0.220.dist-info/METADATA
      103  01-14-2023 01:34   ruff-0.0.220.dist-info/WHEEL
     1070  01-14-2023 01:34   ruff-0.0.220.dist-info/license_files/LICENSE
        0  01-14-2023 01:34   ruff/__init__.py
      193  01-14-2023 01:34   ruff/__main__.py
 40412178  01-14-2023 01:34   ruff-0.0.220.data/scripts/ruff
      540  01-14-2023 01:34   ruff-0.0.220.dist-info/RECORD
</code></pre>
<p>After:</p>
<pre><code>‚ùØ unzip -l /Users/crmarsh/workspace/ruff/target/wheels/ruff-0.0.220-py3-none-macosx_11_0_arm64.whl
Archive:  /Users/crmarsh/workspace/ruff/target/wheels/ruff-0.0.220-py3-none-macosx_11_0_arm64.whl
  Length      Date    Time    Name
---------  ---------- -----   ----
   120482  01-14-2023 01:37   ruff-0.0.220.dist-info/METADATA
      103  01-14-2023 01:37   ruff-0.0.220.dist-info/WHEEL
     1070  01-14-2023 01:37   ruff-0.0.220.dist-info/license_files/LICENSE
        0  01-14-2023 01:37   ruff/__init__.py
      193  01-14-2023 01:37   ruff/__main__.py
 38732738  01-14-2023 01:37   ruff-0.0.220.data/scripts/ruff
      540  01-14-2023 01:37   ruff-0.0.220.dist-info/RECORD
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-14 01:38</div>
            <div class="timeline-body"><p>@not-my-profile - In fact, can we squash this to a single commit, with the message you want? I had to fix one bug (the missing README), then merged to resolve conflicts and verify that the contents on <code>main</code> were identical.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-01-14 02:12</div>
            <div class="timeline-body"><p>Since the first commit doesn't edit the files of the second commit and the clippy commit isn't that important, sure ... squashed into one :) Thanks for the fixes!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/messense">@messense</a> approved on 2023-01-14 02:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-01-14 02:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-01-14 02:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-14 02:38</div>
            <div class="timeline-body"><p>Awesome - thank you both!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-01-14 03:20</div>
            <div class="timeline-body"><p>(I missed that we also have to update a command in the <code>playground.yml</code> workflow ... however <code>wasm-pack build</code> apparently doesn't support the new structure anyway ... I just opened #1860 to track that.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-14 20:02</div>
            <div class="timeline-body"><p>For reasons I don't fully understand, I think this change broke GitHub's dependency tracking:</p>
<p><img src="https://user-images.githubusercontent.com/1309177/212494082-7891b58b-e747-46ee-8ce4-cc3ba481df3d.png" alt="Screen Shot 2023-01-14 at 3 00 48 PM" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-14 20:03</div>
            <div class="timeline-body"><p>I'd really love to get this back. I don't understand why it broke as we still have the top-level <code>setup.py</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-01-14 20:04</div>
            <div class="timeline-body"><p>Yeah I have also noticed that it's bugged ... when I refresh the page a couple of times it sometimes shows:</p>
<p><img src="https://user-images.githubusercontent.com/73739153/212494153-4ec762dd-7a92-416b-afbf-675270991946.png" alt="image" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-14 20:05</div>
            <div class="timeline-body"><p>Oh, wait, I see that now too...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-01-14 20:06</div>
            <div class="timeline-body"><p>I don't think this PR changed any files that GitHub uses for dependency tracking ... maybe GitHub just cannot handle how many projects depend on ruff :P</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-15 07:33</div>
            <div class="timeline-body"><p>Interestingly, I now see this, which toggles between the results. I wonder if there's any way to avoid the Rust version from showing up. Oh, maybe this is because we took the <a href="https://crates.io/crates/ruff">ruff</a> crate?</p>
<img width="1624" alt="Screen Shot 2023-01-15 at 2 32 14 AM" src="https://user-images.githubusercontent.com/1309177/212528547-8739f903-1f6f-44c1-a364-2bb52f17c2ac.png">

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-15 07:37</div>
            <div class="timeline-body"><p>Ah, there's a setting for this! Ok, perfect.</p>
<img width="1022" alt="Screen Shot 2023-01-15 at 2 37 01 AM" src="https://user-images.githubusercontent.com/1309177/212528706-6108006c-6db9-4d2e-832c-a2fda3040800.png">

</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 05:26:15 UTC
    </footer>
</body>
</html>
