<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Add support for `--system-site-packages` virtual environments - astral-sh/ruff #12759</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Add support for <code>--system-site-packages</code> virtual environments</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/12759">#12759</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-08-08 16:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-08-08 16:32</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Many things about Python virtual environments are not specified, but the following things are:</p>
<ul>
<li>All Python virtual environments have a <code>pyvenv.cfg</code> file in the venv root.</li>
<li>The <code>pyvenv.cfg</code> file is guaranteed to have a <code>home = &lt;path&gt;</code> key in it, which will point to the parent directory of the system Python installation that was used to create this venv</li>
<li>The venv will always have its own, isolated <code>site-packages</code> directory which will be appended to <code>sys.path</code> at runtime by the stdlib <code>site</code> module</li>
<li>If the <code>pyvenv.cfg</code> file contains <code>include-system-site-packages = true</code>, (or <code>include-system-site-packages = TrUe</code>, or any other case variations of the word &quot;true&quot;), Python's stdlib module will also append the system Python's <code>site-packages</code> directory <em>as well as</em> the venv's isolated <code>site-packages</code> directory.</li>
</ul>
<p>This PR emulates that runtime behaviour in red-knot.</p>
<h2>Test Plan</h2>
<p>Several tests have been added to this PR.</p>
<p>The <code>pyvenv.cfg</code> files provided by uv, virtualenv and the stdlib <code>venv</code> module are all consistent on the above bullets, but differ in many other subtle aspects. As such, I've added two more venvs to the <code>resources/test</code> directory, in addition to the <code>uv</code>-created one: one created using <code>virtualenv</code> and one created using the stdlib <code>venv</code> module.</p>
<p>I haven't added any tests with venvs that actually have <code>include-system-site-packages = true</code> in their <code>pyvenv.cfg</code> files. I'm not sure how I'd add tests for that without actually committing a complete system Python installation into the <code>resources/test</code> directory. I did manual testing with <code>--system-site-packages</code> venvs created using all three tools, however, and everything seemed to be working as expected. (I tried using both a <code>pyenv</code>-installed Python and a <code>homebrew</code>-installed Python.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2024-08-08 16:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2024-08-08 16:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2024-08-08 16:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-08-08 16:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:1 on 2024-08-08 16:44</div>
            <div class="timeline-body"><p>Should this now be moved into the semantic index crate?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-08 16:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:1 on 2024-08-08 16:45</div>
            <div class="timeline-body"><p>at some point, yes</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-08-08 16:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:47 on 2024-08-08 16:45</div>
            <div class="timeline-body"><p>Is it important that we canonicalize the path here or do we need an absolute path? If it is a relative path, is it relative to the directory in which the CLI runs or the workspace?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-08-08 16:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:89 on 2024-08-08 16:47</div>
            <div class="timeline-body"><p>Same as above. Do we need an absolute path or do we need to resolve symlinks?</p>
<p>I feel like we should return an <code>Error</code> if <code>canonicalize</code> fails (if canonicalizing is important)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:160 on 2024-08-08 16:48</div>
            <div class="timeline-body"><p>Nit: Should we implement this as a method on <code>TargetVersion</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:247 on 2024-08-08 16:49</div>
            <div class="timeline-body"><pre><code class="language-suggestion">pub enum PyvenvCfgParseErrorKind {
</code></pre>
<p>That's the terminology that e.g. <code>std::io::Error</code> uses</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:42 on 2024-08-08 16:50</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        path: SystemPathBuf,
</code></pre>
<p>This is a very large function. We want to avoid monomorphization.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-08-08 16:51</div>
            <div class="timeline-body"><p>Looks exciting. I'll take a closer look tomorrow</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-08 17:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:160 on 2024-08-08 17:45</div>
            <div class="timeline-body"><p>I don't think we should use the <code>TargetVersion</code> type here. The user might be using a Python venv constructed creating a Python version we don't support. In theory that's fine as long as they pass <code>--target-version</code> with a Python version we <em>do</em> support</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-08 17:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:47 on 2024-08-08 17:51</div>
            <div class="timeline-body"><p>Yes, it's very important that we resolve symlinks here: see my extended conversation with @carljm on my prior PR: https://github.com/astral-sh/ruff/pull/12716#discussion_r1705853339. System installations created by e.g. homebrew seem to make heavy use of symlinks so that they put <code>site-packages</code> in odd places while still nominally adhering to Python's expected installation layout. I can add a comment</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-08-08 18:14</div>
            <div class="timeline-body"><p>Ah dang. The existing tests that I previously added in https://github.com/astral-sh/ruff/commit/7fa76a2b2b07f303a18528d4bbdfa89911670b74 now fail, because we now reject a venv as an invalid venv if the venv's <code>pyvenv.cfg</code> file contains a <code>home</code> key that doesn't point to an actually existing directory. And the virtual environments that I committed to <code>resources/test</code> all have <code>home</code> keys in their <code>pyvenv.cfg</code> files that point to directories that exist for me locally, but that don't exist in CI (because I have not committed my system Python installation to the Ruff repo).</p>
<p>Not sure what to do here... it <em>would</em> be really nice if we could have some way of creating a venv on the fly in the context of our test suite... but the venv would need to depend on some system Python installation, which would mean that our test suite would fail unless you had Python installed...</p>
<p>I guess we could just give up on the idea of testing with &quot;real&quot; venvs and create mock venv-like directory structures in the test? But it still feels unclear to me how valuable a test like that would actually be, since we'd really just be repeating the logic from the implementation in the test</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-08 18:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:160 on 2024-08-08 18:17</div>
            <div class="timeline-body"><p>I added some more docs to the type</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-08 19:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:181 on 2024-08-08 19:15</div>
            <div class="timeline-body"><p>In the <code>ruff_linter</code> crate I'd use the <code>warn_user!()</code> macro for this... what should I use here? A <code>tracing</code> call?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-08-08 19:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:181 on 2024-08-08 19:54</div>
            <div class="timeline-body"><p>tracing::warn although there's no guarantee that is only shown once if the function is called multiple times. We may also have to return a diagnostic if this is something that runs in a salsa query. See my tracing documentation</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:98 on 2024-08-08 19:56</div>
            <div class="timeline-body"><p>FWIW I don't <em>think</em> this is true for Windows. I don't have a Windows machine handy to check, but I have a vague memory (from many years ago) that on Windows the Python binary goes directly in the prefix dir of the installation, not inside <code>\Scripts</code>, which is the Windows equivalent to the <code>bin/</code> dir.</p>
<p>(This may also explain the lack of clarity in the docs around <code>bin/</code> dir vs prefix dir; IIRC Vinay, who wrote the docs, uses Windows, where I think there is no distinction to be made.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-08-08 19:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:160 on 2024-08-08 19:56</div>
            <div class="timeline-body"><p>I don't think unsupported python versions are a concern because constructing the Program settings would fail to construct and red knot aborts immediately (but we may want to design TargetVersion in a way so that this isn't a problem)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:163 on 2024-08-08 20:03</div>
            <div class="timeline-body"><p>Not to keep beating the same drum, but this function is not specific to being used from a venv, and there's no need to name the Python minor version this way, it's just a Python minor version no matter where we get it from.</p>
<pre><code class="language-suggestion">    python_minor_version: Option&lt;PythonMinorVersion&gt;,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:308 on 2024-08-08 20:04</div>
            <div class="timeline-body"><p>Similar here; it doesn't matter from where we know the Python version, just that we know it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:255 on 2024-08-08 20:07</div>
            <div class="timeline-body"><p>Nit: Does the <code>Kind</code> suffix add anything useful to the name of this enum?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:49 on 2024-08-08 20:09</div>
            <div class="timeline-body"><p>What's the benefit of splitting this out? (Not a problem, just curious)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:181 on 2024-08-08 20:13</div>
            <div class="timeline-body"><p>I think <code>tracing::warn!</code> is fine for this kind of thing? I think a settings-related warning like this is somewhat different from a diagnostic. But @MichaReiser might have a different thought.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-08-08 20:22</div>
            <div class="timeline-body"><p>Looks good!</p>
<blockquote>
<p>I guess we could just give up on the idea of testing with &quot;real&quot; venvs and create mock venv-like directory structures in the test? But it still feels unclear to me how valuable a test like that would actually be, since we'd really just be repeating the logic from the implementation in the test</p>
</blockquote>
<p>I know we touched on this briefly in the previous PR, but I really think this is a non-issue, and having tests that use (accurate) &quot;mock&quot; venvs is very useful, and in fact is precisely equally useful to using &quot;real&quot; venvs that we've committed directly.</p>
<p>Once we commit the files into our repo, it is for all intents and purposes a mock either way, because we don't have any ongoing validation that it continues to match what the venv module (or whatever other venv creator) does, and because the tests aren't running on the real system where the venv was created and can actually function. It's good to base our mocks carefully on real observed venvs, but it's also totally fine to then strip out known-to-be irrelevant parts, change the home path to point to an actual directory, etc. None of that makes the tests any less useful.</p>
<p>If it were me, I'd remove a bunch more unnecessary cruft from the committed mock venvs (like <code>pip</code> scripts and whatnot that are also non-functional because they refer to non-existent directories.)</p>
<p>I think the <code>home</code> thing will require (at least partly) switching from pre-committed mocks to written-out-by-the-test mocks, because it should be an absolute path (changing it to a relative path would IMO be too much of a departure from a real venv), and you won't know in advance what absolute path you can write to on some arbitrary system the tests run on.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-08 20:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:160 on 2024-08-08 20:35</div>
            <div class="timeline-body"><blockquote>
<p>constructing the Program settings would fail to construct</p>
</blockquote>
<p>Why? Again, the Python version that the user is running locally could be a completely different Python version to the one they've specified with <code>--target-version</code>. The former is what's relevant here, not the latter.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-08 20:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:49 on 2024-08-08 20:36</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/12759#discussion_r1709913740</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-08 20:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:255 on 2024-08-08 20:41</div>
            <div class="timeline-body"><p>It indicates that it's not an enum that implements <code>std::error::Error</code>; instead, it just stores some additional metadata providing some extra information about one of the variants of <code>SitePackagesDiscoveryError</code>. It's similar to <code>std::io::ErrorKind</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-08-08 20:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:49 on 2024-08-08 20:46</div>
            <div class="timeline-body"><p>Aha, very interesting, I hadn't considered that!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/main.rs</code>:13 on 2024-08-09 07:05</div>
            <div class="timeline-body"><p>It feels a bit surprising that <code>VirtualEnvironment</code> is part of the <code>site_packages</code> module. Shouldn' we rename the <code>site_packages</code> module to <code>venv</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/main.rs</code>:168 on 2024-08-09 07:08</div>
            <div class="timeline-body"><p>I think it's important that the CLI converts the <code>path</code> because IMO, the path should be relative to the CLI's current working directory and not <code>--current-directory</code>.</p>
<p>E.g. when I run the following command in <code>/project/ruff</code></p>
<pre><code class="language-shell">red_knot --current-directory ../test/sub --virtual-env ../venv`  
</code></pre>
<p>I would expect that <code>../venv</code> resolves to <code>/project/venv</code> and <code>current-directory</code> to <code>/project/test/sub</code>. I would be surprised if virtual env resolves to <code>/project/test/venv</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:48 on 2024-08-09 07:12</div>
            <div class="timeline-body"><p>can you explain why it is <code>ok</code> to return <code>None</code> if the canonicalize fails. Shouldn't we return an error in that case (or at least log a warning) saying that we skipped that path because we don't have access or the symlink is broken.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:43 on 2024-08-09 07:12</div>
            <div class="timeline-body"><p>Is it guaranteed that <code>path</code> is an absolute path? If not, to what directory is it relative to?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:40 on 2024-08-09 07:14</div>
            <div class="timeline-body"><p>This might be a Python habit of you but I generally prefer to have the public API at the top of the module and move module internal structs and functions further down. I find that it helps reading the code because I'm mostly concerned about the public API and only want to dive into the internals if I have to make changes/fix something.</p>
<p>I think it can also help reviewers because I'm now forced to first read all internals before I get to the point where I see the external API, which is probably the most interesting thing to review.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:95 on 2024-08-09 07:15</div>
            <div class="timeline-body"><p>Same as above.</p>
<ul>
<li>I think we should either propagate a canonicalize failure or at least log a warning if it is safe to recover.</li>
<li>Can <code>unvalidated_path</code> be relative, if so, what to is it relative?</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:106 on 2024-08-09 07:18</div>
            <div class="timeline-body"><p>Only representing the minor version here seems problematic to me because this will break with the release of Python 4.</p>
<p>I still think we should just use <code>TargetVersion</code> here and instead change <code>TargetVersion</code> so that it can deal with future versions (by e.g. storing two <code>u8</code> internally and expose constants for the <em>known</em> python versions)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:318 on 2024-08-09 07:21</div>
            <div class="timeline-body"><p>Uh, the <code>t</code> is subtle! I had to compare the strings in my text editor to spot the difference</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:292 on 2024-08-09 07:23</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// The format of this file is not defined in anyway, and exactly which keys are present
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:73 on 2024-08-09 07:25</div>
            <div class="timeline-body"><p>Do we need to worry about env files that use <code>\r</code> file endings? I'm asking because <code>lines</code> only supports <code>\r\n</code> and <code>\n</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:456 on 2024-08-09 07:28</div>
            <div class="timeline-body"><p>Nit: I would use <code>split_once</code> in combination with a <code>contains</code> here</p>
<pre><code class="language-suggestion">            if let Some((key, value)) = line.split_once('=') {
                if value.contains('=') {
                    let line_number = index.checked_add(1).and_then(NonZeroUsize::new).unwrap();
                    return Err(SitePackagesDiscoveryError::PyvenvCfgParseError(
                        pyvenv_cfg_path,
                        PyvenvCfgParseErrorKind::TooManyEquals { line_number },
                    ));
                }
                
                let key = key.trim();
                let value = value.trim();
                
                match key {
                    &quot;include-system-site-packages&quot; =&gt; {
                        include_system_site_packages = value.eq_ignore_ascii_case(&quot;true&quot;);
                    }
                    &quot;home&quot; =&gt; base_executable_home_path = Some(value),
                    // `virtualenv` and `uv` call this key `version_info`,
                    // but the stdlib venv module calls it `version`
                    &quot;version&quot; | &quot;version_info&quot; =&gt; version_info_string = Some(value),
                    _ =&gt; continue,
                }
            }
        }

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:153 on 2024-08-09 07:31</div>
            <div class="timeline-body"><p>Considering that we log <code>Attempting to...</code> with level=<code>debug</code>, I would expect that we log the &quot;outcome&quot; at the same level. To me, knowing to what the virtual environment resolved to seems more important than knowing that Red Knot is about to resolve it.</p>
<p>However, That would mean that we might not want log the entire <code>metadata</code> struct in debug mode and have to write a slightly more polished message.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:415 on 2024-08-09 07:32</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    pub fn site_packages_directories(
</code></pre>
<p>We spell <code>directories</code> out almost everywhere else.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:426 on 2024-08-09 07:33</div>
            <div class="timeline-body"><p>I would prefer a <code>as_u8</code> method. <code>as_ref</code> in combination with <code>copied</code> reads strange.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:542 on 2024-08-09 07:34</div>
            <div class="timeline-body"><p>I think it would be good to also have a windows venv. Considering that this is the platform that <strong>we</strong> use the least. Meaning, we won't get any coverage by using red knot ourselves.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-08-09 07:35</div>
            <div class="timeline-body"><p>This is great.</p>
<p>I mainly left questions around how we handle errors and how to handle relative paths.</p>
<p>I'm not too fond of <code>PythonMinorVersion</code>. I still think we should just use <code>TargetVersion</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-09 08:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:318 on 2024-08-09 08:38</div>
            <div class="timeline-body"><p>Yes, this is quite annoying... Is there a way of making this more obvious, do you think?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-09 08:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:426 on 2024-08-09 08:40</div>
            <div class="timeline-body"><p>I'm not sure it's possible for me to add a new method to <code>std:: option::Option</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:426 on 2024-08-09 08:44</div>
            <div class="timeline-body"><p>Oh, it's just about converting from <code>&amp;Option&lt;T&gt;</code> to <code>Option&lt;T&gt;</code>. You can do</p>
<pre><code>let minor_version = *minor_version;
</code></pre>
<p>I would then probably inline the expression</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-08-09 08:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-09 12:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:106 on 2024-08-09 12:17</div>
            <div class="timeline-body"><p>I filed #12782. If we merge that, then we can use the <code>PythonVersion</code> type from that PR here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-09 12:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:153 on 2024-08-09 12:31</div>
            <div class="timeline-body"><blockquote>
<p>Considering that we log <code>Attempting to...</code> with level=<code>debug</code>, I would expect that we log the &quot;outcome&quot; at the same level. To me, knowing to what the virtual environment resolved to seems more important than knowing that Red Knot is about to resolve it.</p>
</blockquote>
<p>We do log that with <code>level=debug</code>, but we emit one log message once we've collected all <code>site-packages</code> directories, at the end of <code>site_packages_dirs()</code> (which I'm about to rename to <code>site_packages_directories()</code>. This makes for a less busy debug log output that's easier to understand: just one log message that tells you about both <code>site-packages</code> entries discovered, instead of two log messages that might have other logs in between them.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-09 12:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:73 on 2024-08-09 12:34</div>
            <div class="timeline-body"><p>How do we handle this elsewhere in Ruff? Is there an easy way of iterating line by line that would be resilient to files that have <code>\r</code> endings?</p>
<p>My instinct would be to say that there's a 95% chance that we'd never encounter a <code>pyvenv.cfg</code> file with <code>\r</code> endings, so I'm inclined not to worry about this unless there's an easy fix</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-09 12:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:40 on 2024-08-09 12:38</div>
            <div class="timeline-body"><p>I don't think this is a particular convention I'm following; I think I'm just not thinking too much about it, which is on me :-)</p>
<p>I'll restructure this module and try to think more about this in the future, thanks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/src/main.rs</code>:13 on 2024-08-09 12:39</div>
            <div class="timeline-body"><p>That might make @carljm upset, since he keeps pointing out that several of the routines in this module really work with any Python installation, not just virtual environments ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-09 12:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-09 13:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:48 on 2024-08-09 13:44</div>
            <div class="timeline-body"><p>I'm not sure I understand. If canonicalisation fails, we immediately return <code>None</code> here, indicating that we failed to construct a <code>PythonHomePath</code> or a <code>SysPrefixPath</code>. The <code>.ok()?</code> call ensures that. At both places where we call <code>PythonHomePath::new()</code> or <code>SysPrefixPath::new()</code>, <code>None</code> being returned is immediately converted into an error. So we're not silently ignoring any errors here if canonicalisation fails.</p>
<p>Would you prefer it if this method return a <code>Result</code> rather than an <code>Option</code>? Would that make it clearer, in your opinion?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:43 on 2024-08-09 13:50</div>
            <div class="timeline-body"><p>uv, virtualenv and the stdlib <code>venv</code> module all use absolute paths for the <code>home</code> key. And the stdlib <code>site</code> module appears to assume that the <code>home</code> key will provide an absolute path. But I have no idea if this is specified anywhere or if it's safe to rely on that. Paging @carljm as the person who invented Python virtual environments xD</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-09 13:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-09 13:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:318 on 2024-08-09 13:52</div>
            <div class="timeline-body"><p>I added a comment</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-08-09 13:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:73 on 2024-08-09 13:54</div>
            <div class="timeline-body"><p>95% is kind of low haha. There's the <code>UniversalNewlinesIterator</code> in <code>ruff_source_file</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-08-09 13:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:153 on 2024-08-09 13:56</div>
            <div class="timeline-body"><p>Sounds good? Just make sure to not log a struct with multiple fields with level <code>debug</code>. The output is intended for users</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-08-09 13:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:48 on 2024-08-09 13:58</div>
            <div class="timeline-body"><blockquote>
<p>Would you prefer it if this method return a Result rather than an Option? Would that make it clearer, in your opinion?</p>
</blockquote>
<p>Returning a <code>Result</code> has the advantage that we can preserve the failure-cause which would be nice if this is an error that we show the user (or print to logs)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-08-09 13:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/main.rs</code>:13 on 2024-08-09 13:58</div>
            <div class="timeline-body"><p>Hmm yeah. Not sure. The hierarchy just feels slightly off to me. But we can also revisit this later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-09 13:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:153 on 2024-08-09 13:58</div>
            <div class="timeline-body"><p>Right, that's why I logged this very detailed information here (which is in addition to the tracing::debug!()<code>call at the end of</code>site_packages_directories()<code>) with </code>tracing::trace!()`</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-09 13:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:48 on 2024-08-09 13:59</div>
            <div class="timeline-body"><p>Alright, I'll do that</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-08-09 17:09</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-08-09 17:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/src/main.rs</code>:13 on 2024-08-09 17:14</div>
            <div class="timeline-body"><p>Well, it would depend how you do it :) I was actually going to make a similar comment and decided not to. But I would not want to just rename this module, I would want two modules, one which is specific to venvs and one which contains stuff that works on Python installations in general. But I'm also fine with just keeping it all in one module for now, which is why I didn't make that comment :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-08-09 17:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/src/main.rs</code>:168 on 2024-08-09 17:16</div>
            <div class="timeline-body"><p>I wouldn't be entirely sure which of those results to expect, mostly because of the name <code>--current-directory</code> for that flag. I think your interpretation is fine, but it would be more obvious to me if instead of a <code>--current-directory</code> flag we just accepted the directory to check as an optional positional argument on the CLI, rather than a flag argument. (Also it's less to type :) )</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-08-09 17:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:43 on 2024-08-09 17:24</div>
            <div class="timeline-body"><blockquote>
<p>Paging @carljm as the person who invented Python virtual environments</p>
</blockquote>
<p>Not true, that was Ian Bicking! (Or arguably PJ Eby, though his approach didn't catch on and Ian's did.)</p>
<blockquote>
<p>uv, virtualenv and the stdlib <code>venv</code> module all use absolute paths for the <code>home</code> key. And the stdlib <code>site</code> module appears to assume that the <code>home</code> key will provide an absolute path. But I have no idea if this is specified anywhere or if it's safe to rely on that.</p>
</blockquote>
<p>Sadly this doesn't appear to have been clearly specified in the PEP, and it should have been :/ I think it is safe to rely on, simply because CPython itself won't work correctly with a relative path there (at best it would interpret the relative path as relative to your CWD when you run Python, not as relative to <code>pyvenv.cfg</code>, so if it worked at all it would be very fragile based on your CWD), and no venv creator puts a relative path there. But this is definitely something to consider in a potential update of the venv docs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-09 17:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:73 on 2024-08-09 17:47</div>
            <div class="timeline-body"><p>I'm running into some annoying lifetime issues using <code>universal_newlines</code>. I tried making this change:</p>
<pre><code class="language-diff">diff --git a/Cargo.lock b/Cargo.lock
index 970f8db7f..30aeed0c8 100644
--- a/Cargo.lock
+++ b/Cargo.lock
@@ -1961,6 +1961,7 @@ dependencies = [
  &quot;ruff_cache&quot;,
  &quot;ruff_db&quot;,
  &quot;ruff_python_ast&quot;,
+ &quot;ruff_source_file&quot;,
  &quot;rustc-hash 2.0.0&quot;,
  &quot;salsa&quot;,
  &quot;thiserror&quot;,
diff --git a/crates/red_knot_workspace/Cargo.toml b/crates/red_knot_workspace/Cargo.toml
index d8d5203f6..dbe031c29 100644
--- a/crates/red_knot_workspace/Cargo.toml
+++ b/crates/red_knot_workspace/Cargo.toml
@@ -17,6 +17,7 @@ red_knot_python_semantic = { workspace = true }
 ruff_cache = { workspace = true }
 ruff_db = { workspace = true, features = [&quot;os&quot;, &quot;cache&quot;] }
 ruff_python_ast = { workspace = true }
+ruff_source_file = { workspace = true }
 
 anyhow = { workspace = true }
 crossbeam = { workspace = true }
diff --git a/crates/red_knot_workspace/src/site_packages.rs b/crates/red_knot_workspace/src/site_packages.rs
index 575d7f69a..0c9462ae9 100644
--- a/crates/red_knot_workspace/src/site_packages.rs
+++ b/crates/red_knot_workspace/src/site_packages.rs
@@ -15,6 +15,7 @@ use std::ops::Deref;
 
 use red_knot_python_semantic::PythonVersion;
 use ruff_db::system::{System, SystemPath, SystemPathBuf};
+use ruff_source_file::UniversalNewlines;
 
 type SitePackagesDiscoveryResult&lt;T&gt; = Result&lt;T, SitePackagesDiscoveryError&gt;;
 
@@ -70,7 +71,7 @@ impl VirtualEnvironment {
         // '=' characters, so that's what we should do as well.
         //
         // See also: https://snarky.ca/how-virtual-environments-work/
-        for (index, line) in pyvenv_cfg.lines().enumerate() {
+        for (index, line) in pyvenv_cfg.universal_newlines().enumerate() {
             if let Some((key, value)) = line.split_once('=') {
                 let key = key.trim();
                 if key.is_empty() 
</code></pre>
<p>But now the borrow checker complains:</p>
<pre><code>error[E0597]: `line` does not live long enough
   --&gt; crates/red_knot_workspace/src/site_packages.rs:75:41
    |
74  |         for (index, line) in pyvenv_cfg.universal_newlines().enumerate() {
    |                     ---- binding `line` declared here
75  |             if let Some((key, value)) = line.split_once('=') {
    |                                         ^^^^ borrowed value does not live long enough
...
116 |         }
    |         - `line` dropped here while still borrowed
...
122 |         let Some(base_executable_home_path) = base_executable_home_path else {
    |                                               ------------------------- borrow later used here
</code></pre>
<p>I don't understand this, as the <code>line</code> variable yielded by the <code>universal_newlines</code> iterator should surely have the same lifetime as the <code>line</code> in my current PR branch. I also don't know how to fix it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-09 17:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/src/main.rs</code>:13 on 2024-08-09 17:48</div>
            <div class="timeline-body"><p>Okay, I'll leave this for now; we can come back to it later</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-08-09 18:30</div>
            <div class="timeline-body"><p>I think I've now addressed everything except for https://github.com/astral-sh/ruff/pull/12759/files#r1711881269. Would appreciate it if somebody could take another quick look, though, as it's changed quite a lot today! In particular, the tests have been completely reworked (which was necessary to make them parse): there's no longer any committed virtual environments; we just create small mocks in tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2024-08-09 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2024-08-09 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:411 on 2024-08-09 19:26</div>
            <div class="timeline-body"><p>Were you able to verify this, or just trusted my vague years-old memory here? ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:540 on 2024-08-09 19:30</div>
            <div class="timeline-body"><p>Related to my question above: I think if it hasn't happened already and doesn't happen before merge, we should track a follow-up task for someone with access to a Windows machine to actually audit this and make sure we are testing for behaviors that actually match what a Windows system / venv looks like.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:530 on 2024-08-09 19:31</div>
            <div class="timeline-body"><p>Any particular reason we calculate this unconditionally out here, rather than in the non-Windows block below?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-08-09 19:34</div>
            <div class="timeline-body"><p>Looks good to me!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-09 19:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:411 on 2024-08-09 19:35</div>
            <div class="timeline-body"><p>I verified it on an extremely slow, very old Windows machine I had lying around. I had to install Python on the machine. It took forever -_-</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-09 19:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:540 on 2024-08-09 19:36</div>
            <div class="timeline-body"><p>agreed, these tests really need to be supplemented with manual testing</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-08-09 19:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:540 on 2024-08-09 19:38</div>
            <div class="timeline-body"><p>Manual testing would be great, but if you at least validated that this mock setup matches what you see on a real Windows machine with Python installed on it, that's a great start for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-09 19:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:540 on 2024-08-09 19:40</div>
            <div class="timeline-body"><p>Yeah, I did that much. But considering how long installing Python took, there's no way I'm installing the Rust toolchain and doing manual testing of this PR on that machine ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-09 20:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_workspace/src/site_packages.rs</code>:530 on 2024-08-09 20:00</div>
            <div class="timeline-body"><p>It's just annoying to have to define such a long variable so many times over and over... and this is a test, so I don't think binary size really matters quite so much here :P</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Use the system Python's `site-packages` as an additional search path if `include-system-site-packages = true` is present in a virtual environment's `pyvenv.cfg` file" to "[red-knot] Add support for `--system-site-packages` virtual environments" by @AlexWaygood on 2024-08-09 20:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2024-08-09 20:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-08-09 20:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-08-09 20:02</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 21:39:01 UTC
    </footer>
</body>
</html>
