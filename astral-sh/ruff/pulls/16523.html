<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[syntax-errors] Parenthesized context managers before Python 3.9 - astral-sh/ruff #16523</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[syntax-errors] Parenthesized context managers before Python 3.9</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16523">#16523</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-03-05 17:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>I thought this was very complicated based on the comment here: https://github.com/astral-sh/ruff/pull/16106#issuecomment-2653505671 and on some of the discussion in the CPython issue here: https://github.com/python/cpython/issues/56991. However, after a little bit of experimentation, I think it boils down to this example:</p>
<pre><code class="language-python">with (x as y): ...
</code></pre>
<p>The issue is parentheses around a <code>with</code> item with an <code>optional_var</code>, as we (and <a href="https://docs.python.org/3/library/ast.html#ast.withitem">Python</a>) call the trailing variable name (<code>y</code> in this case). It's not actually about line breaks after all, except that line breaks are allowed in parenthesized expressions, which explains the validity of cases like</p>
<pre><code class="language-pycon">&gt;&gt;&gt; with (
...     x,
...     y
... ) as foo:
...     pass
... 
</code></pre>
<p>even on Python 3.8.</p>
<p>I followed <a href="https://pyright-play.net/?pythonVersion=3.7&amp;strict=true&amp;code=FAdwlgLgFgBAFAewA4FMB2cBEAzBCB0EAHhJgJQwCGAzjLgmQFwz6tA">pyright</a>'s example again here on the diagnostic range (just the opening paren) and the wording of the error.</p>
<h2>Test Plan</h2>
<p>Inline tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by @ntBre on 2025-03-05 17:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @ntBre on 2025-03-05 17:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-05 17:57</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @ntBre on 2025-03-05 18:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @ntBre on 2025-03-05 18:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @ntBre on 2025-03-05 18:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:2114 on 2025-03-06 07:28</div>
            <div class="timeline-body"><p>Do we also need to emit the same diagnostic on line 2144, e.g. for <code>with (foo, bar):</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/error.rs</code>:702 on 2025-03-06 07:28</div>
            <div class="timeline-body"><p>It would be nice to add documentation, similar to what you did for other variants.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-06 07:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/tests/snapshots/invalid_syntax@parenthesized_context_manager_py38.py.snap</code>:179 on 2025-03-06 07:29</div>
            <div class="timeline-body"><p>@BurntSushi's new diagnostic system will allow us to mark both parentheses.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-03-06 11:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:2114 on 2025-03-06 11:42</div>
            <div class="timeline-body"><p>Should we move this check down below where we're sure that the parenthesis belongs to the with items and not the expression? i.e., on line 2162</p>
<pre><code class="language-rs">        if with_item_kind.is_parenthesized() {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-03-06 11:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:2114 on 2025-03-06 11:44</div>
            <div class="timeline-body"><p>Or, in <code>parse_with_items</code> like:</p>
<pre><code class="language-rs">        if self.at(TokenKind::Lpar) {
			let lpar_range = self.current_token_range();
            if let Some(items) = self.try_parse_parenthesized_with_items() {
				// check target version and raise error
                self.expect(TokenKind::Rpar);
                items
            } else {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-03-06 14:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:2114 on 2025-03-06 14:30</div>
            <div class="timeline-body"><p>No, that syntax is actually okay. I think <code>(foo, bar)</code> is just a tuple, so it falls under the expression grammar. The tuple doesn't have an <code>__enter__</code> method, so it causes a runtime error, but it does parse and even compile I guess.</p>
<p>As far as I can tell, the problem with parentheses is specific to the <code>as</code> case since that's part of the <code>with</code> statement grammar.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-03-06 14:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:2114 on 2025-03-06 14:31</div>
            <div class="timeline-body"><pre><code class="language-pycon">Python 3.7.9 (default, Aug 23 2020, 00:57:53)
[Clang 10.0.1 ] on linux
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; import ast
&gt;&gt;&gt; ast.parse(&quot;with (foo, bar): ...&quot;)
&lt;_ast.Module object at 0x70849fd20c10&gt;
&gt;&gt;&gt; ast.dump(_)
&quot;Module(body=[With(items=[withitem(context_expr=Tuple(elts=[Name(id='foo', ctx=Load()), Name(id='bar', ctx=Load())], ctx=Load()), optional_vars=None)], body=[Expr(value=Ellipsis())])])&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-03-06 15:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:2114 on 2025-03-06 15:13</div>
            <div class="timeline-body"><p>Oh nice, I moved it to <code>parse_with_items</code>. I just had to add a separate check for <code>optional_vars</code> otherwise we get a false positive on the case Micha mentioned above. I added that as a <code>test_ok</code> case to be sure.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-03-06 15:29</div>
            <div class="timeline-body"><p>Thanks for the reviews! I</p>
<ul>
<li>relocated the check to <code>parse_with_items</code></li>
<li>added variant docs</li>
<li>expanded the <code>test_ok</code> cases with Micha's suggestion and some of the other cases I put in the docs</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:2114 on 2025-03-07 08:20</div>
            <div class="timeline-body"><p>Ah right. I only remembered that we can't parenthesize multiple context managers in the formatter but that is because it would change the semantics (it would make it a tuple).</p>
<p>So yes, the problem is that not a single context manager is allowed to use <code>as</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:2069 on 2025-03-07 08:21</div>
            <div class="timeline-body"><p>Let's add an example where only some context managers use <code>as</code></p>
<pre><code class="language-suggestion">                    // with (foo as x, bar as y): ...
                    // with (foo, bar as y): ...
                    // with (foo as x, bar): ...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:2046 on 2025-03-07 08:34</div>
            <div class="timeline-body"><p>It is not directly related to your PR, but it is somewhat related that the parser now supports a <code>target_version</code> option.</p>
<p>If given:</p>
<pre><code class="language-py">with (CtxManager1(), CtxManager2()):
    ...
</code></pre>
<ul>
<li>Pre 3.9: The context manager expression is a tuple which is always a runtime error (I think)</li>
<li>3.9 or newer: This parses as a multiple-item context manager.</li>
</ul>
<p>There are two concerns here:</p>
<ol>
<li>Always parsing the above as a context manager with multiple with items affects downstream tools. E.g., a type checker will error when parsed as a tuple because the tuple doesn't implement the context manager protocol. However, the code might be valid when parsed as a with statement with multiple context expressions.</li>
<li>We'll miss errors that are technically not syntax errors, but they are most certainly not what the user wanted.</li>
</ol>
<p>I think we have two options here:</p>
<ol>
<li>We make the backwards compatibility stricter than it has to be and flag any parenthesized context manager with more than one expression or with a trailing comma as an error because it is parsed as a tuple on Python 3.8 or older</li>
<li>We leave it as is and consider this a concern of a lint rule to catch tuples in context manager positions.</li>
</ol>
<p>I'm not sure if we should change the parser to correctly parse this as a tuple instead of a statement with multiple context managers. I think it's fine to leave it as is for 1, but we should definitely change the parser if we go for 2.</p>
<p>I just tested how pyright handles this and pyright always flags:</p>
<pre><code>with (CtxManager1(), CtxManager2()):
    ...
</code></pre>
<p>While this is not a 100% correct, I think it's accurate enough and could be a simplified fix for 1 and 2, but I'm interested in more opinions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-07 08:37</div>
            <div class="timeline-body"><p>Okay, this is a bit more subtle. I wrote a longer inline comment about the problem and listed a few options</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:2046 on 2025-03-07 11:00</div>
            <div class="timeline-body"><p>Hmm, that's a good point.</p>
<blockquote>
<ul>
<li>Pre 3.9: The context manager expression is a tuple which is always a runtime error (I think)</li>
</ul>
</blockquote>
<p>Yes, it's a runtime error. I quickly tested it out:</p>
<details><summary>Context managers as tuple test code</summary>
<p>

<pre><code class="language-py">from contextlib import contextmanager


@contextmanager
def context1():
    yield 1


@contextmanager
def context2():
    yield 2


with (context1(), context2()):
    ...
</code></pre>
</p>
</details> 

<p>My initial thought was to change the parser to emit the correct AST as per the target version but that is something that we only need to question for this specific change as it seems to be the only change which not only changes the grammar but that in turn changes the parsed AST depending on the target version. But, I'm not sure if that'd actually provide any advantages.</p>
<p>I think my preference would be to go for (1) given that (a) it's already done by Pyright and I don't see any issues that users have brought up, (b) mypy doesn't flag this case on 3.8 either (<a href="https://mypy-play.net/?mypy=latest&amp;python=3.8&amp;gist=d1986f8345de346c91188f530b71a3e9&amp;flags=show-traceback,strict">mypy playground</a>), and (c) <a href="https://devguide.python.org/versions/">Python 3.8 is has reached EOL</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:2046 on 2025-03-07 14:59</div>
            <div class="timeline-body"><p>Oh that's a very good point, thanks for catching that.</p>
<p>Option (1) sounds like the easier of the two, but I see some appeal in having it as a lint rule too. I guess it's a bit weird to flag this as a <code>SyntaxError</code>, but like you said, I don't think there's any way for this not to cause an error at runtime. It also seems like a pain to change the parser for such an old Python version.</p>
<p><a href="https://pyright-play.net/?pythonVersion=3.8&amp;strict=true&amp;code=O4SwLgFgBAFA9gBwKYDsYCIBmc4DowAeY6AlADRSKoYBGAhgE75GkkBcUuXAUN6JLCposOZsXLtOXIA">pyright</a> is actually a little touchy here, I think. It flags the case with multiple elements as a parenthesized context manager, but for a single-element tuple, you get a type error about the tuple not implementing <code>__enter__</code> and <code>__exit__</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-03-07 14:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-03-07 18:18</div>
            <div class="timeline-body"><p>(A bit embarrassing but I just found out that my comment was still pending, submitting it now)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-03-14 19:54</div>
            <div class="timeline-body"><p>I implemented option (1) as discussed above (always flagging cases that we parse as parenthesized context managers).</p>
<p>The only remaining <code>ok</code> case is <code>with (foo, bar, baz) as tup: ...</code>. This could be a good candidate for a lint rule because we parse this accurately as a parenthesized expression within the <code>with</code> statement, making it actually accessible to ruff or red-knot as a tuple without having to modify the parser. This matches pyright too, which raises a type error about a tuple not implementing <code>__enter__</code> or <code>__exit__</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-03-17 08:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-03-17 12:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-03-17 12:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-03-17 12:54</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:10:31 UTC
    </footer>
</body>
</html>
