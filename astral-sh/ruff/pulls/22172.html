<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add named fields for `Place` enum - astral-sh/ruff #22172</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add named fields for <code>Place</code> enum</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22172">#22172</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2025-12-24 13:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Mechanical refactor to migrate this enum to named fields. No functional changes.</p>
<p>See: https://github.com/astral-sh/ruff/pull/22093#discussion_r2636050127.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @charliermarsh on 2025-12-24 13:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @charliermarsh on 2025-12-24 13:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-24 13:59</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-24 14:00</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">static-frame (https://github.com/static-frame/static-frame)
- static_frame/core/bus.py:675:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Bus[Any], object_]`, found `InterGetItemILocReduces[Self@iloc | Bus[Any], object_ | Self@iloc]`
+ static_frame/core/bus.py:671:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[Bus[Any], object_]`, found `InterGetItemLocReduces[Top[Index[Any]] | Top[Series[Any, Any]] | TypeBlocks | ... omitted 6 union elements, object_]`
+ static_frame/core/bus.py:675:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Bus[Any], object_]`, found `InterGetItemILocReduces[Top[Index[Any]] | TypeBlocks | Top[Bus[Any]] | ... omitted 6 union elements, generic[object]]`
- static_frame/core/series.py:772:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Series[Any, Any], TVDtype@Series]`, found `InterGetItemILocReduces[Top[Index[Any]] | TypeBlocks | Top[Bus[Any]] | ... omitted 6 union elements, generic[object]]`
+ static_frame/core/series.py:772:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Series[Any, Any], TVDtype@Series]`, found `InterGetItemILocReduces[Series[Any, Any] | TypeBlocks | Batch | ... omitted 6 union elements, generic[object]]`
- static_frame/core/series.py:4072:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[SeriesHE[Any, Any], TVDtype@SeriesHE]`, found `InterGetItemILocReduces[Top[Index[Any]] | TypeBlocks | Top[Bus[Any]] | ... omitted 7 union elements, generic[object]]`
+ static_frame/core/series.py:4072:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[SeriesHE[Any, Any], TVDtype@SeriesHE]`, found `InterGetItemILocReduces[Bottom[Series[Any, Any]] | TypeBlocks | Batch | ... omitted 7 union elements, generic[object]]`
- static_frame/core/yarn.py:418:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Yarn[Any], object_]`, found `InterGetItemILocReduces[Top[Index[Any]] | TypeBlocks | Top[Bus[Any]] | ... omitted 6 union elements, generic[object]]`
+ static_frame/core/yarn.py:418:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Yarn[Any], object_]`, found `InterGetItemILocReduces[Top[Yarn[Any]] | TypeBlocks | Batch | ... omitted 6 union elements, generic[object]]`
- Found 1841 diagnostics
+ Found 1842 diagnostics

pandas-stubs (https://github.com/pandas-dev/pandas-stubs)
+ pandas-stubs/_typing.pyi:1232:16: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- tests/frame/test_groupby.py:229:15: error[type-assertion-failure] Type `Series[Any]` does not match asserted type `Series[str | bytes | int | ... omitted 12 union elements]`
- tests/frame/test_groupby.py:625:15: error[type-assertion-failure] Type `Series[Any]` does not match asserted type `Series[str | bytes | int | ... omitted 12 union elements]`
- Found 5155 diagnostics
+ Found 5154 diagnostics

core (https://github.com/home-assistant/core)
+ homeassistant/util/variance.py:47:12: error[invalid-return-type] Return type does not match returned value: expected `(**_P@ignore_variance) -&gt; _R@ignore_variance`, found `_Wrapped[_P@ignore_variance, _R@ignore_variance | int | float | datetime, _P@ignore_variance, _R@ignore_variance | int | float | datetime]`
- Found 14474 diagnostics
+ Found 14475 diagnostics


</code></pre>
</details>

<p>No memory usage changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2026-01-05 21:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @charliermarsh on 2026-01-05 21:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @charliermarsh on 2026-01-05 21:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @charliermarsh on 2026-01-05 21:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @charliermarsh on 2026-01-05 21:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-06 14:47</div>
            <div class="timeline-body"><p>Looking at this, I wonder if a more elegant design might be to have <code>Place::Defined</code> wrap a struct that has the named fields?</p>
<pre><code class="language-rs">enum Place&lt;'db&gt; {
    Defined(DefinedPlace&lt;'db&gt;),
    Undefined,
}

struct DefinedPlace&lt;'db&gt; {
    ty: Type&lt;'db&gt;,
    origin: TypeOrigin,
    definedness: Definedness,
    widening: Widening,
}
</code></pre>
<p>it might make matching on <code>Place</code> a bit easier in places -- it would enable patterns like</p>
<pre><code class="language-rs">match place {
    Place::Defined(defined_place) if defined_place.is_definitely_defined() =&gt; {...}
    Place::Undefined =&gt; {...}
</code></pre>
<p>etc.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/place.rs</code>:263 on 2026-01-06 16:52</div>
            <div class="timeline-body"><pre><code class="language-suggestion">            Place::Defined(
                place @ DefinedPlace {
                    ty: Type::Union(union),
                    ..
                },
            ) =&gt; union.map_with_boundness(db, |elem| {
                Place::Defined(DefinedPlace { ty: *elem, ..place }).try_call_dunder_get(db, owner)
            }),
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/place.rs</code>:278 on 2026-01-06 16:52</div>
            <div class="timeline-body"><p>Can't add a suggestion here because the range spans deleted lines, but:</p>
<pre><code class="language-rs">            Place::Defined(
                place @ DefinedPlace {
                    ty: Type::Intersection(intersection),
                    ..
                },
            ) =&gt; intersection.map_with_boundness(db, |elem| {
                Place::Defined(DefinedPlace { ty: *elem, ..place }).try_call_dunder_get(db, owner)
            }),
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/place.rs</code>:790 on 2026-01-06 16:55</div>
            <div class="timeline-body"><p>I would do this as:</p>
<pre><code class="language-diff">diff --git a/crates/ty_python_semantic/src/place.rs b/crates/ty_python_semantic/src/place.rs
index 6b94d5e27e..faeffac47a 100644
--- a/crates/ty_python_semantic/src/place.rs
+++ b/crates/ty_python_semantic/src/place.rs
@@ -765,33 +765,22 @@ impl&lt;'db&gt; PlaceAndQualifiers&lt;'db&gt; {
     pub(crate) fn into_lookup_result(self, db: &amp;'db dyn Db) -&gt; LookupResult&lt;'db&gt; {
         match self {
             PlaceAndQualifiers {
-                place:
-                    Place::Defined(DefinedPlace {
-                        ty,
-                        origin,
-                        definedness: Definedness::AlwaysDefined,
-                        widening,
-                    }),
+                place: Place::Defined(place),
                 qualifiers,
-            } =&gt; {
-                let ty = widening.apply_if_needed(db, ty);
-                Ok(TypeAndQualifiers::new(ty, origin, qualifiers))
-            }
-            PlaceAndQualifiers {
-                place:
-                    Place::Defined(DefinedPlace {
+            } =&gt; match place.definedness {
+                Definedness::AlwaysDefined =&gt; {
+                    let ty = place.widening.apply_if_needed(db, place.ty);
+                    Ok(TypeAndQualifiers::new(ty, place.origin, qualifiers))
+                }
+                Definedness::PossiblyUndefined =&gt; {
+                    let ty = place.widening.apply_if_needed(db, place.ty);
+                    Err(LookupError::PossiblyUndefined(TypeAndQualifiers::new(
                         ty,
-                        origin,
-                        definedness: Definedness::PossiblyUndefined,
-                        widening,
-                    }),
-                qualifiers,
-            } =&gt; {
-                let ty = widening.apply_if_needed(db, ty);
-                Err(LookupError::PossiblyUndefined(TypeAndQualifiers::new(
-                    ty, origin, qualifiers,
-                )))
-            }
+                        place.origin,
+                        qualifiers,
+                    )))
+                }
+            },
             PlaceAndQualifiers {
                 place: Place::Undefined,
                 qualifiers,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types.rs</code>:1860 on 2026-01-06 17:00</div>
            <div class="timeline-body"><pre><code class="language-suggestion">                if let Place::Defined(place) = call_symbol
                    &amp;&amp; place.is_definitely_defined()
                {
                    place.ty.try_upcast_to_callable(db)
                } else {
                    None
                }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types.rs</code>:11352 on 2026-01-06 17:03</div>
            <div class="timeline-body"><p>I would do:</p>
<pre><code class="language-diff">diff --git a/crates/ty_python_semantic/src/types.rs b/crates/ty_python_semantic/src/types.rs
index acc83a4ebe..a9239ee1c6 100644
--- a/crates/ty_python_semantic/src/types.rs
+++ b/crates/ty_python_semantic/src/types.rs
@@ -11329,24 +11329,16 @@ impl&lt;'db&gt; ModuleLiteralType&lt;'db&gt; {
         // if it exists. First, we need to look up the `__getattr__` function in the module's scope.
         if let Some(file) = self.module(db).file(db) {
             let getattr_symbol = imported_symbol(db, file, &quot;__getattr__&quot;, None);
-            if let Place::Defined(DefinedPlace {
-                ty: getattr_type,
-                origin,
-                definedness: boundness,
-                widening,
-            }) = getattr_symbol.place
-            {
+            if let Place::Defined(place) = getattr_symbol.place {
                 // If we found a __getattr__ function, try to call it with the name argument
-                if let Ok(outcome) = getattr_type.try_call(
+                if let Ok(outcome) = place.ty.try_call(
                     db,
                     &amp;CallArguments::positional([Type::string_literal(db, name)]),
                 ) {
                     return PlaceAndQualifiers {
                         place: Place::Defined(DefinedPlace {
                             ty: outcome.return_type(db),
-                            origin,
-                            definedness: boundness,
-                            widening,
+                            ..place
                         }),
                         qualifiers: TypeQualifiers::FROM_MODULE_GETATTR,
                     };
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/member.rs</code>:97 on 2026-01-06 17:07</div>
            <div class="timeline-body"><pre><code class="language-suggestion">                        Place::Defined(place) =&gt; {
                            Place::Defined(DefinedPlace { ty, ..place }).with_qualifiers(qualifiers)
                        }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2026-01-06 17:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/place.rs</code>:128 on 2026-01-06 17:09</div>
            <div class="timeline-body"><p>I would just not define it if we don't use it right now. Though one of my review suggestions adds a use ðŸ˜„</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2026-01-06 17:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2026-01-06 17:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2026-01-06 17:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2026-01-06 17:24</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:18:23 UTC
    </footer>
</body>
</html>
