<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] fix a couple latent bugs uncovered during `nonlocal` work - astral-sh/ruff #19336</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] fix a couple latent bugs uncovered during <code>nonlocal</code> work</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19336">#19336</a>
        opened by <a href="https://github.com/oconnor663">@oconnor663</a>
        on 2025-07-14 17:24
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-07-14 17:24</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ty/issues/793</p>
<p>This PR includes two commits for two different bugs (I could separate them, but there would be a merge conflict, because they touch the same line):</p>
<ul>
<li>Free reads should terminate at an annotation-only declaration in an enclosing scope, even if that scope doesn't have a binding (in part because a sibling inner function could provide a binding).</li>
<li>Free reads should terminate at a <code>global</code> declaration in an enclosing scope, even if that scope doesn't have a binding (a type annotation would be a syntax error). Usually the global scope will have a definition, and we currently require that it does, although CPython doesn't require that at runtime. (Also add a test case for that.)</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @oconnor663 on 2025-07-14 17:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @oconnor663 on 2025-07-14 17:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @oconnor663 on 2025-07-14 17:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @oconnor663 on 2025-07-14 17:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/oconnor663">@oconnor663</a> reviewed on 2025-07-14 17:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/oconnor663">@oconnor663</a> on <code>crates/ty_python_semantic/resources/mdtest/scopes/global.md</code>:251 on 2025-07-14 17:25</div>
            <div class="timeline-body"><p>This is a test for existing behavior, not new in this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by @oconnor663 on 2025-07-14 17:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/scopes/global.md</code>:240 on 2025-07-14 17:27</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    # TODO: we should emit an error on the assignment to `z` because we're adding a variable
    # to an external scope when it does not have any declarations or bindings in that scope
    # (similar conceptually to monkey-patching a new attribute onto a class/instance)
    x, y, z = 1, 2, 3
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/scopes/nonlocal.md</code>:41 on 2025-07-14 17:28</div>
            <div class="timeline-body"><p>üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-14 17:29</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">porcupine (https://github.com/Akuli/porcupine)
- error[unresolved-reference] porcupine/utils.py:794:37: Name `value` used when not defined
- Found 34 diagnostics
+ Found 33 diagnostics

pywin32 (https://github.com/mhammond/pywin32)
+ error[unresolved-reference] Pythonwin/pywin/Demos/ocx/ocxtest.py:63:42: Name `calendarParentModule` used when not defined
- Found 2013 diagnostics
+ Found 2014 diagnostics

openlibrary (https://github.com/internetarchive/openlibrary)
+ warning[possibly-unbound-attribute] openlibrary/plugins/openlibrary/sentry.py:17:45: Attribute `capture_exception_webpy` on type `Sentry | None` is possibly unbound
- Found 680 diagnostics
+ Found 681 diagnostics

</code></pre>
</details>
No memory usage changes detected ‚úÖ

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/scopes/nonlocal.md</code>:61 on 2025-07-14 17:30</div>
            <div class="timeline-body"><pre><code class="language-suggestion">            y: int = x  # allowed: this loads the global `x` variable
                        # due to the `global` declaration in the immediate enclosing scope
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-07-14 17:31</div>
            <div class="timeline-body"><p>Brilliant! Could you double-check the mypy_primer hits are as expected?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-07-14 17:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "fix a couple latent bugs uncovered during `nonlocal` work" to "[ty] fix a couple latent bugs uncovered during `nonlocal` work" by @AlexWaygood on 2025-07-14 17:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> removed by @oconnor663 on 2025-07-14 19:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by @oconnor663 on 2025-07-14 19:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-14 19:55</div>
            <div class="timeline-body"><!-- generated-comment ty ecosystem-analyzer -->

<h2><code>ecosystem-analyzer</code> results</h2>
<p>| Lint rule | Added | Removed | Changed |
|-----------|------:|--------:|--------:|
| <code>unresolved-reference</code> | 1 | 1 | 0 |
| <code>possibly-unbound-attribute</code> | 1 | 0 | 0 |
| <strong>Total</strong> | <strong>2</strong> | <strong>1</strong> | <strong>0</strong> |</p>
<p><strong><a href="https://jack-read-declaration-only.ecosystem-663.pages.dev/diff">Full report with detailed diff</a></strong></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-07-14 20:02</div>
            <div class="timeline-body"><p>The first <code>mypy_primer</code> change <a href="https://github.com/Akuli/porcupine/blob/b6ea2acb9b4786f226dbaec6d234130ffd5788af/porcupine/utils.py#L776-L794">removes a false positive</a>. :tada:</p>
<p>The second change is <a href="https://github.com/mhammond/pywin32/blob/62821250e83cc1c1c2b4a613f4eb9f93db1c8fe9/Pythonwin/pywin/Demos/ocx/ocxtest.py#L52-L63">a new lint that I'm not sure about</a>. It boils down to an example like this. Should <code>print(x)</code> be an unresolved reference error here? Talking to @AlexWaygood, it sounds like we do want this example to error (or at least we're ok with it erroring), but showing an error <em>only</em> on the print is probably the most confusing way to do it. I need to look into exactly where the <code>x=5</code> binding is going.</p>
<pre><code class="language-py">def f():
    global x
    x = 5
    def g():
        print(x)
</code></pre>
<p>The third change is <a href="https://github.com/internetarchive/openlibrary/blob/master/openlibrary/plugins/openlibrary/sentry.py#L9-L17">a new lint that I think is a true positive</a>, but I'm not certain. It boils down to this:</p>
<pre><code class="language-py">x: int | None = None

def f():
    global x
    x = 5
    def g():
        y: int = x
</code></pre>
<p>Previously the <code>infer_place_load</code> for <code>x</code> in <code>g</code> stopped at <code>f</code>'s scope, and I think it concluded that <code>x</code> was <code>Literal[5]</code>. But under this PR it sees that <code>x</code> is <code>global</code> in <code>f</code> and skips straight to the global scope, where it sees <code>int | None</code> and concludes that that's not assignable to <code>int</code>. I think the new behavior is better?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-14 20:04</div>
            <div class="timeline-body"><blockquote>
<p>The third change is <a href="https://github.com/internetarchive/openlibrary/blob/master/openlibrary/plugins/openlibrary/sentry.py?rgh-link-date=2025-07-14T20%3A02%3A13Z#L9-L17">a new lint that I think is a true positive</a>, but I'm not certain. It boils down to this:</p>
<pre><code class="language-python">x: int | None = None

def f():
    global x
    x = 5
    def g():
        y: int = x
</code></pre>
<p>Previously the <code>infer_place_load</code> for <code>x</code> in <code>g</code> stopped at <code>f</code>'s scope, and I think it concluded that <code>x</code> was <code>Literal[5]</code>. But under this PR it sees that <code>x</code> is <code>global</code> in <code>f</code> and skips straight to the global scope, where it sees <code>int | None</code> and concludes that that's not assignable to <code>int</code>. I think the new behavior is better?</p>
</blockquote>
<p>this one feels related to https://github.com/astral-sh/ty/issues/311: since we don't narrow globals in other contexts yet, I think it's fine if we don't do that narrowing here either!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-07-14 20:12</div>
            <div class="timeline-body"><p>(<code>ecosystem-analyzer</code> reports the same 3 cases as <code>mypy_primer</code>.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @oconnor663 on 2025-07-14 20:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-07-15 00:09</div>
            <div class="timeline-body"><p>I've split out the question of how we want to lint these &quot;<code>global</code> statement doesn't correspond to any explicitly defined global variable&quot; case into https://github.com/astral-sh/ruff/pull/19344. I'll come back and rebase this once we decide what to do with that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-07-15 19:12</div>
            <div class="timeline-body"><p>I've moved this PR to be on top of https://github.com/astral-sh/ruff/pull/19344, which makes it an error to use the <code>global</code> keyword when there's no matching definition in the global scope. ~~Both of <a href="https://github.com/astral-sh/ruff/pull/19336#issuecomment-3070801379">the tricky examples above</a> fall into that category, so I'm not too worried about whether there are secondary errors below the <code>global</code> keyword. Marking this ready for review again.~~</p>
<p>Edit: Ah wait, that was wrong. Gonna think about this some more.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @oconnor663 on 2025-07-15 19:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @oconnor663 on 2025-07-15 19:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> removed by @oconnor663 on 2025-07-16 00:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by @oconnor663 on 2025-07-16 00:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-07-16 01:10</div>
            <div class="timeline-body"><p>Ok, yes, the <a href="https://github.com/mhammond/pywin32/blob/8b328dffac71b7afaf2d72f47c4048f27a32f6c8/Pythonwin/pywin/Demos/ocx/ocxtest.py#L63">first new lint</a> follows an invalid <code>global</code> keyword that we also lint on (now that https://github.com/astral-sh/ruff/pull/19344 is in), and I think it's fine.</p>
<p>The <a href="https://github.com/internetarchive/openlibrary/blob/fb3a5561bd912ee8a3bb3d94b278d7dcc8ad8100/openlibrary/plugins/openlibrary/sentry.py#L17">second new lint</a> is because the program is relying on narrowing globals across function scopes, which as @AlexWaygood pointed out we don't currently do, and which is probably unsound in general. (It's clear to me in this case that the value will never become <code>None</code> again after it's stopped being <code>None</code>, but I don't think Ty can see that. Maybe the global variable should be declared <code>sentry: Sentry</code> rather than <code>sentry: Sentry | None = None</code>?)</p>
<p>So yes, I'm ok with these lints and I think this is ready to land. I'll wait until tomorrow in case anyone else wants to review, since it's toggled back and forth a couple times.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @oconnor663 on 2025-07-16 01:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @oconnor663 on 2025-07-16 01:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-07-16 08:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @oconnor663 on 2025-07-16 15:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @oconnor663 on 2025-07-16 15:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-16 15:30</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:58:38 UTC
    </footer>
</body>
</html>
