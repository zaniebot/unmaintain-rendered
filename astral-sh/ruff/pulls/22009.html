<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-use-pathlib`] Make fixes unsafe when types change in compound statements (`PTH104`, `PTH105`, `PTH109`, `PTH115`) - astral-sh/ruff #22009</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-use-pathlib</code>] Make fixes unsafe when types change in compound statements (<code>PTH104</code>, <code>PTH105</code>, <code>PTH109</code>, <code>PTH115</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22009">#22009</a>
        opened by <a href="https://github.com/chirizxc">@chirizxc</a>
        on 2025-12-16 17:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/chirizxc">@chirizxc</a></div>
            <div class="timeline-body">Summary
<p>Fixes <a href="https://github.com/astral-sh/ruff/issues/21794">astral-sh/ruff#21794</a></p>
Test Plan
<p><code>cargo nextest run flake8_use_pathlib</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[`flake8-use-pathlib`]&quot; to &quot;[`flake8-use-pathlib`] Fix `PTH&#x27;s` unsafe handling when return types change in compound statements&quot; by <a href="https://github.com/chirizxc">@chirizxc</a> on 2025-12-16 17:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-16 17:20</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+0 -0 violations, +0 -26 fixes in 3 projects; 52 projects unchanged)</p>
<a href="https://github.com/apache/airflow">apache/airflow</a> (+0 -0 violations, +0 -16 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --no-fix --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
- <a href="https://github.com/apache/airflow/blob/e659539c002af35ff7b72ebb0eb0678c041dc808/dev/breeze/src/airflow_breeze/commands/minor_release_command.py#L180">dev/breeze/src/airflow_breeze/commands/minor_release_command.py:180:17:</a> PTH109 [*] `os.getcwd()` should be replaced by `Path.cwd()`
+ <a href="https://github.com/apache/airflow/blob/e659539c002af35ff7b72ebb0eb0678c041dc808/dev/breeze/src/airflow_breeze/commands/minor_release_command.py#L180">dev/breeze/src/airflow_breeze/commands/minor_release_command.py:180:17:</a> PTH109 `os.getcwd()` should be replaced by `Path.cwd()`
- <a href="https://github.com/apache/airflow/blob/e659539c002af35ff7b72ebb0eb0678c041dc808/dev/breeze/src/airflow_breeze/commands/release_candidate_command.py#L719">dev/breeze/src/airflow_breeze/commands/release_candidate_command.py:719:25:</a> PTH109 [*] `os.getcwd()` should be replaced by `Path.cwd()`
+ <a href="https://github.com/apache/airflow/blob/e659539c002af35ff7b72ebb0eb0678c041dc808/dev/breeze/src/airflow_breeze/commands/release_candidate_command.py#L719">dev/breeze/src/airflow_breeze/commands/release_candidate_command.py:719:25:</a> PTH109 `os.getcwd()` should be replaced by `Path.cwd()`
- <a href="https://github.com/apache/airflow/blob/e659539c002af35ff7b72ebb0eb0678c041dc808/dev/breeze/src/airflow_breeze/commands/release_command.py#L123">dev/breeze/src/airflow_breeze/commands/release_command.py:123:23:</a> PTH109 [*] `os.getcwd()` should be replaced by `Path.cwd()`
+ <a href="https://github.com/apache/airflow/blob/e659539c002af35ff7b72ebb0eb0678c041dc808/dev/breeze/src/airflow_breeze/commands/release_command.py#L123">dev/breeze/src/airflow_breeze/commands/release_command.py:123:23:</a> PTH109 `os.getcwd()` should be replaced by `Path.cwd()`
- <a href="https://github.com/apache/airflow/blob/e659539c002af35ff7b72ebb0eb0678c041dc808/dev/breeze/src/airflow_breeze/commands/release_command.py#L156">dev/breeze/src/airflow_breeze/commands/release_command.py:156:23:</a> PTH109 [*] `os.getcwd()` should be replaced by `Path.cwd()`
+ <a href="https://github.com/apache/airflow/blob/e659539c002af35ff7b72ebb0eb0678c041dc808/dev/breeze/src/airflow_breeze/commands/release_command.py#L156">dev/breeze/src/airflow_breeze/commands/release_command.py:156:23:</a> PTH109 `os.getcwd()` should be replaced by `Path.cwd()`
- <a href="https://github.com/apache/airflow/blob/e659539c002af35ff7b72ebb0eb0678c041dc808/dev/breeze/src/airflow_breeze/commands/release_command.py#L177">dev/breeze/src/airflow_breeze/commands/release_command.py:177:19:</a> PTH109 [*] `os.getcwd()` should be replaced by `Path.cwd()`
+ <a href="https://github.com/apache/airflow/blob/e659539c002af35ff7b72ebb0eb0678c041dc808/dev/breeze/src/airflow_breeze/commands/release_command.py#L177">dev/breeze/src/airflow_breeze/commands/release_command.py:177:19:</a> PTH109 `os.getcwd()` should be replaced by `Path.cwd()`
- <a href="https://github.com/apache/airflow/blob/e659539c002af35ff7b72ebb0eb0678c041dc808/dev/breeze/src/airflow_breeze/commands/release_command.py#L387">dev/breeze/src/airflow_breeze/commands/release_command.py:387:25:</a> PTH109 [*] `os.getcwd()` should be replaced by `Path.cwd()`
+ <a href="https://github.com/apache/airflow/blob/e659539c002af35ff7b72ebb0eb0678c041dc808/dev/breeze/src/airflow_breeze/commands/release_command.py#L387">dev/breeze/src/airflow_breeze/commands/release_command.py:387:25:</a> PTH109 `os.getcwd()` should be replaced by `Path.cwd()`
- <a href="https://github.com/apache/airflow/blob/e659539c002af35ff7b72ebb0eb0678c041dc808/dev/breeze/src/airflow_breeze/commands/release_command.py#L403">dev/breeze/src/airflow_breeze/commands/release_command.py:403:19:</a> PTH109 [*] `os.getcwd()` should be replaced by `Path.cwd()`
+ <a href="https://github.com/apache/airflow/blob/e659539c002af35ff7b72ebb0eb0678c041dc808/dev/breeze/src/airflow_breeze/commands/release_command.py#L403">dev/breeze/src/airflow_breeze/commands/release_command.py:403:19:</a> PTH109 `os.getcwd()` should be replaced by `Path.cwd()`
- <a href="https://github.com/apache/airflow/blob/e659539c002af35ff7b72ebb0eb0678c041dc808/dev/breeze/src/airflow_breeze/utils/reproducible.py#L61">dev/breeze/src/airflow_breeze/utils/reproducible.py:61:21:</a> PTH109 [*] `os.getcwd()` should be replaced by `Path.cwd()`
+ <a href="https://github.com/apache/airflow/blob/e659539c002af35ff7b72ebb0eb0678c041dc808/dev/breeze/src/airflow_breeze/utils/reproducible.py#L61">dev/breeze/src/airflow_breeze/utils/reproducible.py:61:21:</a> PTH109 `os.getcwd()` should be replaced by `Path.cwd()`
</pre>

</p>

<a href="https://github.com/bokeh/bokeh">bokeh/bokeh</a> (+0 -0 violations, +0 -8 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --no-fix --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
- <a href="https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/application/handlers/code_runner.py#L219">src/bokeh/application/handlers/code_runner.py:219:16:</a> PTH109 [*] `os.getcwd()` should be replaced by `Path.cwd()`
+ <a href="https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/application/handlers/code_runner.py#L219">src/bokeh/application/handlers/code_runner.py:219:16:</a> PTH109 `os.getcwd()` should be replaced by `Path.cwd()`
- <a href="https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/util/compiler.py#L246">src/bokeh/util/compiler.py:246:20:</a> PTH109 [*] `os.getcwd()` should be replaced by `Path.cwd()`
+ <a href="https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/util/compiler.py#L246">src/bokeh/util/compiler.py:246:20:</a> PTH109 `os.getcwd()` should be replaced by `Path.cwd()`
- <a href="https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/tests/support/util/filesystem.py#L160">tests/support/util/filesystem.py:160:11:</a> PTH109 [*] `os.getcwd()` should be replaced by `Path.cwd()`
+ <a href="https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/tests/support/util/filesystem.py#L160">tests/support/util/filesystem.py:160:11:</a> PTH109 `os.getcwd()` should be replaced by `Path.cwd()`
- <a href="https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/tests/unit/bokeh/application/handlers/test_code_runner.py#L154">tests/unit/bokeh/application/handlers/test_code_runner.py:154:19:</a> PTH109 [*] `os.getcwd()` should be replaced by `Path.cwd()`
+ <a href="https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/tests/unit/bokeh/application/handlers/test_code_runner.py#L154">tests/unit/bokeh/application/handlers/test_code_runner.py:154:19:</a> PTH109 `os.getcwd()` should be replaced by `Path.cwd()`
</pre>

</p>

<a href="https://github.com/latchbio/latch">latchbio/latch</a> (+0 -0 violations, +0 -2 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
- <a href="https://github.com/latchbio/latch/blob/dc91e5b22db76d1dcab1acf91c3afbcc597c0c3a/src/latch_cli/snakemake/serialize.py#L152">src/latch_cli/snakemake/serialize.py:152:25:</a> PTH109 [*] `os.getcwd()` should be replaced by `Path.cwd()`
+ <a href="https://github.com/latchbio/latch/blob/dc91e5b22db76d1dcab1acf91c3afbcc597c0c3a/src/latch_cli/snakemake/serialize.py#L152">src/latch_cli/snakemake/serialize.py:152:25:</a> PTH109 `os.getcwd()` should be replaced by `Path.cwd()`
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PTH109 | 26 | 0 | 0 | 0 | 26 |</p>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-12-17 15:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-12-17 15:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_use_pathlib/helpers.rs</code>:96 on 2025-12-17 15:36</div>
            <div class="timeline-body"><p>I think I would prefer to keep this check only in the rules that are affected. This helper is used in many additional PTH rules. Should all of those have unsafe fixes, or only the four in the issue?</p>
<p>To me, only the comment check is general enough to share here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_use_pathlib/helpers.rs</code>:225 on 2025-12-17 15:46</div>
            <div class="timeline-body"><p>I think this is too narrow a check. Even a simple assignment statement seems like it should cause an unsafe fix because we can&#x27;t (or at least don&#x27;t) verify what the user does with the variable:</p>
<pre><code>x = os.rename(&quot;a&quot;, &quot;b&quot;)
</code></pre>
<p>I think what we actually want to check is that the <a href="https://github.com/astral-sh/ruff/blob/1134e85972afb77f410eed90c4a86f18ab568b2f/crates/ruff_python_semantic/src/model.rs#L1261"><code>current_statement_parent</code></a> is  a <code>Stmt::Expr</code>:</p>
<pre><code>    checker.semantic().current_statement.is_expr_stmt()
</code></pre>
<p>Note that this negates the condition, so I guess a better name for the function would be <code>is_top_level_statement</code>, and the call sites will need a <code>!</code>.</p>
<p>Applying this locally caused tests for a few additional rules to fail, which supports my concern in the other comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> requested changes on 2025-12-17 15:47</div>
            <div class="timeline-body"><p>Thanks for working on this! But I think we need to be a bit more careful here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/ntBre">@ntBre</a> by <a href="https://github.com/chirizxc">@chirizxc</a> on 2025-12-17 16:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_use_pathlib/helpers.rs</code>:218 on 2025-12-17 16:52</div>
            <div class="timeline-body"><p>I think these are only called in the same places now, what do you think about combining them into one function? I think that was the original intent actually, but we overlooked the statement case in the previous PR. Maybe a name like <code>is_top_level_expression_in_statement</code> would work well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-12-17 16:53</div>
            <div class="timeline-body"><p>Thanks for the quick fix! I think the logic here is good to go, I just had one small suggestion about combining the two helper functions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chirizxc">@chirizxc</a> on 2025-12-17 17:17</div>
            <div class="timeline-body"><blockquote>
<p>Thanks for the quick fix! I think the logic here is good to go, I just had one small suggestion about combining the two helper functions.</p>
</blockquote>
<p>Yes, I think it makes sense to combine them.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-12-17 17:29</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[`flake8-use-pathlib`] Fix `PTH&#x27;s` unsafe handling when return types change in compound statements&quot; to &quot;[`flake8-use-pathlib`] Make fixes unsafe when types change in compound statements (`PTH104`, `PTH105`, `PTH109`, `PTH115`)&quot; by <a href="https://github.com/ntBre">@ntBre</a> on 2025-12-17 17:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/ntBre">@ntBre</a> on 2025-12-17 17:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/ntBre">@ntBre</a> on 2025-12-17 17:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-12-17 17:33</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:21:47 UTC
    </footer>
</body>
</html>
