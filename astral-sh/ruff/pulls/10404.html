<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automatic configuration reloading for `ruff server` - astral-sh/ruff #10404</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Automatic configuration reloading for <code>ruff server</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10404">#10404</a>
        opened by <a href="https://github.com/snowsignal">@snowsignal</a>
        on 2024-03-14 02:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-03-14 02:47</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes #10366.</p>
<p><code>ruff server</code> now registers a file watcher on the client side using the LSP protocol, and listen for events on configuration files. On such an event, it reloads the configuration in the 'nearest' workspace to the file that was changed.</p>
<h2>Test Plan</h2>
<p>N/A</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @snowsignal on 2024-03-14 02:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Automatic configuration reload for `ruff server`" to "Automatic configuration reloading for `ruff server`" by @snowsignal on 2024-03-14 02:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-03-14 03:00</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-03-17 21:47</div>
            <div class="timeline-body"><p>Cool.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_server/src/session.rs</code>:257 on 2024-03-17 21:49</div>
            <div class="timeline-body"><p>How does configuration work here exactly? Do we find one configuration for the workspace, and then use that for all files?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-17 21:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server.rs</code>:72 on 2024-03-18 07:45</div>
            <div class="timeline-body"><p>Do we need to check if the client supports dynamic <code>didChangeWatchedFiles</code> requests https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#didChangeWatchedFilesClientCapabilities</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server.rs</code>:67 on 2024-03-18 07:48</div>
            <div class="timeline-body"><p>Hardcoding 1 here seems a bit odd. It might be overkill for now, but should we use an <code>AtomicUsize</code> to get the next request id (that can be used when sending other requests too)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server.rs</code>:95 on 2024-03-18 07:50</div>
            <div class="timeline-body"><p>Do you mean response from <code>client</code>?</p>
<pre><code class="language-suggestion">        // Flush response from the client (to avoid an unexpected response appearing in the event loop)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/session.rs</code>:274 on 2024-03-18 07:56</div>
            <div class="timeline-body"><p>Nit: I couldn't guess the return value of <code>workspace_for_url</code> from the call site (I had no idea what the first tuple element should be). I had to navigate to the method declaration and read the code.</p>
<p>Maybe rename to <code>entry_for_url</code> and <code>entry_for_url_mut</code> but keep <code>workspace_for_url</code> and <code>workspace_for_url_mut</code> that use <code>entry_for_url</code> internally. I think having <code>workspace_for_url</code> and <code>workspace_for_url_mut</code> that returns a <code>&amp;Workspace</code> (or <code>&amp;mut Workspace</code>) does make sense and avoids destructuring or indexing in some call sites.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server.rs</code>:98 on 2024-03-18 07:57</div>
            <div class="timeline-body"><p>Do you have ideas on how you want to support this in the future for other requests from the server that possibly happen inside of the event loop (where it isn't guaranteed that the client won't send any other requests).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-03-18 07:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-18 15:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_server/src/session.rs</code>:257 on 2024-03-18 15:16</div>
            <div class="timeline-body"><p>(I'm asking because I'd like to understand how it works if a user has subdirectories with distinct <code>ruff.toml</code> configurations that should only be applied to files in each respective subdirectory.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-03-18 17:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/session.rs</code>:257 on 2024-03-18 17:25</div>
            <div class="timeline-body"><p>Good question! Right now, we only process one configuration file per workspace, but supporting this sub-folder configuration is on the roadmap. We do support this in a limited capacity at the moment - if a workspace is a subfolder of another workspace, we use the configuration file found in that workspace folder instead of the one in the parent workspace.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-18 17:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_server/src/session.rs</code>:257 on 2024-03-18 17:29</div>
            <div class="timeline-body"><p>How do you envision structuring / supporting it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-03-18 17:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server.rs</code>:72 on 2024-03-18 17:32</div>
            <div class="timeline-body"><p>We do, good catch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/session.rs</code>:274 on 2024-03-18 17:33</div>
            <div class="timeline-body"><p>Okay! I was worried that having separate methods would be 'too much' but I think we can justify it here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-03-18 17:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-03-18 17:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server.rs</code>:98 on 2024-03-18 17:37</div>
            <div class="timeline-body"><p>Responses from the client are received the same way as requests/notifications, so we'd handle them as part of the event loop - the scheduler would dispatch 'callback' tasks if the response is significant.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-03-18 18:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/session.rs</code>:257 on 2024-03-18 18:30</div>
            <div class="timeline-body"><p>We'd have a 'configuration index' in each workspace that would point to all valid configuration files and their locations. We could probably even cache the resolved configuration for this file path as part of the index. When taking a snapshot of a document, we'd find the corresponding resolved configuration from this index using the file path.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @snowsignal on 2024-03-18 20:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server.rs</code>:87 on 2024-03-21 17:11</div>
            <div class="timeline-body"><p>Nit: Could we use <code>fetch_add</code> here? the next request would probably need a new id anyway?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-03-21 17:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @snowsignal on 2024-03-21 20:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @snowsignal on 2024-03-21 20:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-03-21 20:17</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 22:47:59 UTC
    </footer>
</body>
</html>
