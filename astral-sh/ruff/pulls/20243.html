<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[syntax-errors]: multiple-starred-expressions (F622) - astral-sh/ruff #20243</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[syntax-errors]: multiple-starred-expressions (F622)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20243">#20243</a>
        opened by <a href="https://github.com/11happy">@11happy</a>
        on 2025-09-04 16:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/11happy">@11happy</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff/ty! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title? (Please prefix with `[ty]` for ty pull
  requests.)
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>This PR implements https://docs.astral.sh/ruff/rules/multiple-starred-expressions/ as a semantic syntax error</p>
<h2>Test Plan</h2>
<p>I have added inline tests as directed in #17412</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @11happy on 2025-09-04 16:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @11happy on 2025-09-04 16:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "feat: implement F622" to "[syntax-errors]: multiple-starred-expressions (F622)" by @11happy on 2025-09-04 16:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/11happy">@11happy</a> on 2025-09-07 16:14</div>
            <div class="timeline-body"><p>Hii @ntBre , would love your feedback on this when you get a chance.
Thank you : )</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-07 16:21</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-09-07 18:22</div>
            <div class="timeline-body"><p>Thanks for the pings. Your PRs are in my inbox, but we've been focused on the minor release. I'll get to them soon.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/11happy">@11happy</a> on 2025-09-07 18:48</div>
            <div class="timeline-body"><p>Sure, No worries at all, I completely understand.  Thank you for your time : )</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:1458 on 2025-09-12 17:05</div>
            <div class="timeline-body"><p>Could we add some documentation for this? I think this one could justify a larger writeup (like in the F622 docs) than some of the simpler errors like <code>YieldFromInAsyncFunction</code> directly above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:107 on 2025-09-12 17:07</div>
            <div class="timeline-body"><p>I don't think this check is quite right. There's a new ecosystem hit for a case like this:</p>
<pre><code class="language-py">(*_, normed), *_ = [(1,), 2]
</code></pre>
<p>which should be allowed. You may be able to take inspiration from the actual F622 implementation (which we'll also need to delete before adding this second implementation, or we'll get duplicate diagnostics. That's the reason for the change in the F622.py snapshot above).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:1272 on 2025-09-12 17:08</div>
            <div class="timeline-body"><p>I'd prefer not to reformat any unrelated code, but I guess if the formatting CI job doesn't complain it's okay.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> requested changes on 2025-09-12 17:09</div>
            <div class="timeline-body"><p>Thanks for your work here! I think we need to fix a false positive in the ecosystem check, avoid duplicate diagnostics, and add a bit of documentation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/11happy">@11happy</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:1458 on 2025-09-14 15:46</div>
            <div class="timeline-body"><p>done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/11happy">@11happy</a> reviewed on 2025-09-14 15:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/11happy">@11happy</a> reviewed on 2025-09-14 15:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/11happy">@11happy</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:107 on 2025-09-14 15:46</div>
            <div class="timeline-body"><p>done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/11happy">@11happy</a> reviewed on 2025-09-14 15:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/11happy">@11happy</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:1272 on 2025-09-14 15:47</div>
            <div class="timeline-body"><p>Sure</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/ast/analyze/expression.rs</code>:216 on 2025-09-15 21:25</div>
            <div class="timeline-body"><p>Is this argument still used for anything, or could we delete the argument and the code that checks it too?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:373 on 2025-09-15 21:51</div>
            <div class="timeline-body"><p>I think instead of recursing here, we could perform this <code>multiple_star_expression</code> check in <code>check_expr</code> instead of <code>check_stmt</code>. The parent visitor should already recurse automatically into the child expressions. That seems closer to how F622 was implemented originally. Concretely, I'd suggest something like this, which also uses the structure of the original F622 implementation:</p>
<details><summary>Patch</summary>

<pre><code class="language-diff">diff --git a/crates/ruff_python_parser/src/semantic_errors.rs b/crates/ruff_python_parser/src/semantic_errors.rs
index 1a8fb3ad6f..b4c0ffb947 100644
--- a/crates/ruff_python_parser/src/semantic_errors.rs
+++ b/crates/ruff_python_parser/src/semantic_errors.rs
@@ -104,9 +104,6 @@ impl SemanticSyntaxChecker {
                         *range,
                     );
                 }
-                for target in targets {
-                    Self::multiple_star_expression(target, ctx);
-                }
 
                 // test_ok assign_stmt_starred_expr_value
                 // _ = 4
@@ -361,38 +358,6 @@ impl SemanticSyntaxChecker {
             );
         }
     }
-    fn multiple_star_expression&lt;Ctx: SemanticSyntaxContext&gt;(expr: &amp;Expr, ctx: &amp;Ctx) {
-        match expr {
-            Expr::Tuple(ast::ExprTuple { elts, range, .. })
-            | Expr::List(ast::ExprList { elts, range, .. }) =&gt; {
-                let mut count = 0;
-                for elt in elts {
-                    if matches!(elt, Expr::Starred(_)) {
-                        count += 1;
-                    }
-                    Self::multiple_star_expression(elt, ctx);
-                }
-                if count &gt; 1 {
-                    // test_err multiple_starred_assignment_target
-                    // (*a, *b) = (1, 2)
-                    // [*a, *b] = (1, 2)
-                    // (*a, *b, c) = (1, 2, 3)
-                    // [*a, *b, c] = (1, 2, 3)
-
-                    // test_ok multiple_starred_assignment_target
-                    // (*a, b) = (1, 2)
-                    // (*_, normed), *_ = [(1,), 2]
-
-                    Self::add_error(
-                        ctx,
-                        SemanticSyntaxErrorKind::MultipleStarredExpressions,
-                        *range,
-                    );
-                }
-            }
-            _ =&gt; {}
-        }
-    }
 
     /// Check for [`SemanticSyntaxErrorKind::WriteToDebug`] in `stmt`.
     fn debug_shadowing&lt;Ctx: SemanticSyntaxContext&gt;(stmt: &amp;ast::Stmt, ctx: &amp;Ctx) {
@@ -765,6 +730,45 @@ impl SemanticSyntaxChecker {
             }) =&gt; {
                 Self::duplicate_parameter_name(parameters, ctx);
             }
+            Expr::Tuple(ast::ExprTuple {
+                elts,
+                ctx: expr_ctx,
+                range,
+                node_index: _,
+                parenthesized: _,
+            })
+            | Expr::List(ast::ExprList {
+                elts,
+                ctx: expr_ctx,
+                range,
+                node_index: _,
+            }) =&gt; {
+                if expr_ctx.is_store() {
+                    let mut has_starred: bool = false;
+                    for elt in elts {
+                        if elt.is_starred_expr() {
+                            if has_starred {
+                                // test_err multiple_starred_assignment_target
+                                // (*a, *b) = (1, 2)
+                                // [*a, *b] = (1, 2)
+                                // (*a, *b, c) = (1, 2, 3)
+                                // [*a, *b, c] = (1, 2, 3)
+
+                                // test_ok multiple_starred_assignment_target
+                                // (*a, b) = (1, 2)
+                                // (*_, normed), *_ = [(1,), 2]
+                                Self::add_error(
+                                    ctx,
+                                    SemanticSyntaxErrorKind::MultipleStarredExpressions,
+                                    *range,
+                                );
+                                return;
+                            }
+                            has_starred = true;
+                        }
+                    }
+                }
+            }
             _ =&gt; {}
         }
     }
</code></pre>
</details>

<p>That's pretty deeply indented, so it might still be a good idea to factor out a function.</p>
<p>Along these lines, another useful test case might be something like this:</p>
<pre><code class="language-py">(*a, *b, (*c, *d)) = (1, 2)
</code></pre>
<p>We currently emit 2 F622 diagnostics for this, including with your changes. That would help make sure we get the recursion in somewhere. At first I thought we could just delete the recursive <code>multiple_star_expression</code> call.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-09-15 21:58</div>
            <div class="timeline-body"><p>Thanks! I think the tests look good now, just a couple of simplification suggestions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/11happy">@11happy</a> reviewed on 2025-09-22 12:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/11happy">@11happy</a> on <code>crates/ruff_linter/src/checkers/ast/analyze/expression.rs</code>:216 on 2025-09-22 12:51</div>
            <div class="timeline-body"><p>done, yes I checked it can be removed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/11happy">@11happy</a> reviewed on 2025-09-22 12:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/11happy">@11happy</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:373 on 2025-09-22 12:51</div>
            <div class="timeline-body"><p>Thank you , I have updated it accordingly : )</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/11happy">@11happy</a> on 2025-09-22 16:32</div>
            <div class="timeline-body"><p>The <code>cargo test (wasm)</code> failure seems unrelated to this PR changes.</p>
<p>Thank you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/11happy">@11happy</a> on 2025-09-24 16:56</div>
            <div class="timeline-body"><p>Please let me know if there's any more changes required for this PR.</p>
<p>Thank you : )</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_parser/src/semantic_errors.rs</code>:392 on 2025-09-24 19:23</div>
            <div class="timeline-body"><p>tiny nit:</p>
<pre><code class="language-suggestion">
    fn multiple_star_expression&lt;Ctx: SemanticSyntaxContext&gt;(
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-09-24 19:28</div>
            <div class="timeline-body"><p>Thank you! I just had one tiny spacing nit that I'll apply and merge.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @ntBre on 2025-09-24 19:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-09-24 19:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-09-24 19:32</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:15:31 UTC
    </footer>
</body>
</html>
