<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remove lexing from flake8-pytest-style - astral-sh/ruff #6795</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Remove lexing from flake8-pytest-style</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6795">#6795</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-08-22 21:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>Another drive-by change to remove unnecessary custom lexing. We just need to know the parenthesized range, so we can use... <code>parenthesized_range</code>. I&#x27;ve also updated <code>parenthesized_range</code> to support nested parentheses.</p>
Test Plan
<p><code>cargo test</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-22 21:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-22 21:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_ast/src/parenthesize.rs</code>:48 on 2023-08-22 21:41</div>
            <div class="timeline-body"><p>@MichaReiser - Requesting review primarily for this portion (supporting nested parentheses).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-08-22 21:53</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>✅ ecosystem check detected no changes.</p>
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      3.5±0.04ms    11.6 MB/sec    1.00      3.5±0.03ms    11.6 MB/sec
formatter/numpy/ctypeslib.py               1.00    707.1±7.81µs    23.6 MB/sec    1.01   711.1±15.01µs    23.4 MB/sec
formatter/numpy/globals.py                 1.00     73.6±0.30µs    40.1 MB/sec    1.00     73.5±1.46µs    40.1 MB/sec
formatter/pydantic/types.py                1.00  1416.3±10.72µs    18.0 MB/sec    1.00  1414.2±16.51µs    18.0 MB/sec
linter/all-rules/large/dataset.py          1.00     10.3±0.05ms     3.9 MB/sec    1.00     10.3±0.02ms     4.0 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      2.8±0.02ms     5.9 MB/sec    1.00      2.8±0.00ms     5.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    313.8±1.49µs     9.4 MB/sec    1.00    314.8±1.37µs     9.4 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.4±0.04ms     4.7 MB/sec    1.00      5.4±0.02ms     4.7 MB/sec
linter/default-rules/large/dataset.py      1.00      5.5±0.01ms     7.4 MB/sec    1.00      5.5±0.01ms     7.4 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1170.6±4.50µs    14.2 MB/sec    1.00   1175.1±2.27µs    14.2 MB/sec
linter/default-rules/numpy/globals.py      1.00    121.8±0.37µs    24.2 MB/sec    1.01    122.6±0.26µs    24.1 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.5±0.01ms    10.2 MB/sec    1.00      2.5±0.00ms    10.3 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      4.9±0.18ms     8.4 MB/sec    1.01      4.9±0.24ms     8.3 MB/sec
formatter/numpy/ctypeslib.py               1.00   974.2±37.87µs    17.1 MB/sec    1.01   983.8±42.75µs    16.9 MB/sec
formatter/numpy/globals.py                 1.02    100.1±5.33µs    29.5 MB/sec    1.00     98.3±5.02µs    30.0 MB/sec
formatter/pydantic/types.py                1.00  1963.0±77.07µs    13.0 MB/sec    1.01  1989.1±102.40µs    12.8 MB/sec
linter/all-rules/large/dataset.py          1.00     16.6±0.71ms     2.5 MB/sec    1.01     16.8±0.64ms     2.4 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      4.5±0.20ms     3.7 MB/sec    1.00      4.4±0.13ms     3.7 MB/sec
linter/all-rules/numpy/globals.py          1.00   563.6±19.86µs     5.2 MB/sec    1.00   564.1±25.80µs     5.2 MB/sec
linter/all-rules/pydantic/types.py         1.01      8.5±0.32ms     3.0 MB/sec    1.00      8.4±0.31ms     3.0 MB/sec
linter/default-rules/large/dataset.py      1.00      9.0±0.31ms     4.5 MB/sec    1.01      9.1±0.32ms     4.5 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01  1884.9±48.85µs     8.8 MB/sec    1.00  1871.1±66.63µs     8.9 MB/sec
linter/default-rules/numpy/globals.py      1.00   231.7±10.37µs    12.7 MB/sec    1.01    233.4±7.53µs    12.6 MB/sec
linter/default-rules/pydantic/types.py     1.03      4.1±0.17ms     6.2 MB/sec    1.00      4.0±0.16ms     6.4 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-23 00:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/parenthesize.rs</code>:51 on 2023-08-23 06:15</div>
            <div class="timeline-body"><p>Nit: Is this the same as <code>left_tokenizer.zip(right_tokenizer).last().map(|(left, right)| TextRange::new(left.start(), right.end())</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/tests/parenthesize.rs</code>:15 on 2023-08-23 06:18</div>
            <div class="timeline-body"><p>Snapshot tests are neat for asserting against large and complicated data structure but have the downside that the expected value isn&#x27;t visible inside the test itself. It requires future us to read the test, find the right snapshot file (snapshot file names are very long), and then compare the values. This is significantly more work compared to having the expected value inline and using <code>assert_eq!(parenthesized, Some(TextRange::new(x, y)))</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-08-23 06:19</div>
            <div class="timeline-body"><p>The changes look good to me but I disagree with using insta for the tests. Insta is an overkill for asserting against a <code>TextRange</code>. Please use <code>assert_eq</code> instead</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-23 13:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_ast/src/parenthesize.rs</code>:51 on 2023-08-23 13:37</div>
            <div class="timeline-body"><p>Yeah and I originally wrote it that way, but then I was worried it would eagerly evaluate <code>left</code> (and at least per the comments here, we wanted to avoid doing so).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-23 13:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_ast/tests/parenthesize.rs</code>:15 on 2023-08-23 13:42</div>
            <div class="timeline-body"><p>Makes sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-23 13:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_ast/src/parenthesize.rs</code>:51 on 2023-08-23 13:42</div>
            <div class="timeline-body"><p>(I&#x27;ll test this definitively and maybe change it anyway -- this isn&#x27;t as much of a hot path as in the formatter.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-23 15:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_ast/src/parenthesize.rs</code>:51 on 2023-08-23 15:31</div>
            <div class="timeline-body"><p>Ok, confirmed that <code>zip</code> <em>doesn&#x27;t</em> proceed the <code>left_tokenizer</code> if the <code>right_tokenizer</code> exhausts <em>and</em> we invert the order from what you wrote above (i.e., <code>right_tokenizer.zip(left_tokenizer)</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-23 15:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-23 15:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-08-23 15:54</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:56:35 UTC
    </footer>
</body>
</html>
