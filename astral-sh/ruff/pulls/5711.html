<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Handle right parens in join comma builder - astral-sh/ruff #5711</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Handle right parens in join comma builder</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5711">#5711</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-07-12 13:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>The <code>JoinCommaSeparatedBuilder</code> only tested if the first token after the node is a <code>,</code>.
However, this always fails for expressions with parentheses, because the parentheses are not part of the expression's range.</p>
<p>This PR changes the <code>JoinCommaSeparatedBuilder</code> to skip right parens. However, we need to be careful, because <code>nested(call(arg),)</code> only the outer call has a trailing comma
in this example, not the inner arg. The way this is implemented is by also passing an approxiamted end of the sequence (normally the end of the enclosing node, but we don't always know precisely), and only search between the end of the last node and the end of the sequence.</p>
<p>I further went along and also fixed an issue where single argument call expressions were always parenthesized because <code>is_expression_parenthesized</code> doesn't know that the parens from the arguments belong to the call. The way to solve this is by handling parentheses
manually inside of <code>FormatCallExpr</code> if the call only has a single argument.</p>
<!-- What's the purpose of the change? What does it do, and why? -->

<h2>Test Plan</h2>
<p>See updated snapshot tests.</p>
<!-- How was it tested? -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @MichaReiser on 2023-07-12 13:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2023-07-12 13:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-12 13:38</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #5711</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5711" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ<ul>
<li><strong>PR #5708</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5708" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5711?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-07-12 13:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/snapshots/black_compatibility@miscellaneous__long_strings_flag_disabled.py.snap</code>:605 on 2023-07-12 13:39</div>
            <div class="timeline-body"><p>I tested this locally, black preserves the parentheses, regardless of what the text says</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-07-12 13:53</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01      9.4Â±0.04ms     4.3 MB/sec    1.00      9.4Â±0.12ms     4.3 MB/sec
formatter/numpy/ctypeslib.py               1.01      2.2Â±0.01ms     7.5 MB/sec    1.00      2.2Â±0.01ms     7.6 MB/sec
formatter/numpy/globals.py                 1.00    250.0Â±6.19Âµs    11.8 MB/sec    1.04   260.3Â±15.89Âµs    11.3 MB/sec
formatter/pydantic/types.py                1.01      4.7Â±0.08ms     5.4 MB/sec    1.00      4.7Â±0.06ms     5.4 MB/sec
linter/all-rules/large/dataset.py          1.04     17.1Â±0.53ms     2.4 MB/sec    1.00     16.4Â±0.53ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.03      4.3Â±0.14ms     3.9 MB/sec    1.00      4.2Â±0.15ms     4.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    518.6Â±1.31Âµs     5.7 MB/sec    1.00    518.1Â±2.03Âµs     5.7 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.2Â±0.04ms     3.5 MB/sec    1.00      7.2Â±0.08ms     3.5 MB/sec
linter/default-rules/large/dataset.py      1.01      8.1Â±0.04ms     5.1 MB/sec    1.00      8.0Â±0.12ms     5.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1754.2Â±11.10Âµs     9.5 MB/sec    1.01  1769.4Â±11.97Âµs     9.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    202.8Â±3.91Âµs    14.6 MB/sec    1.00    202.9Â±0.87Âµs    14.5 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.6Â±0.05ms     7.0 MB/sec    1.01      3.7Â±0.02ms     7.0 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      9.4Â±0.13ms     4.3 MB/sec    1.00      9.5Â±0.10ms     4.3 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.1Â±0.02ms     7.9 MB/sec    1.01      2.1Â±0.03ms     7.8 MB/sec
formatter/numpy/globals.py                 1.00    226.4Â±3.07Âµs    13.0 MB/sec    1.01    229.3Â±6.39Âµs    12.9 MB/sec
formatter/pydantic/types.py                1.00      4.7Â±0.03ms     5.5 MB/sec    1.01      4.7Â±0.03ms     5.4 MB/sec
linter/all-rules/large/dataset.py          1.00     15.6Â±0.16ms     2.6 MB/sec    1.00     15.7Â±0.07ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.1Â±0.04ms     4.0 MB/sec    1.00      4.1Â±0.02ms     4.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    423.1Â±5.51Âµs     7.0 MB/sec    1.00    424.6Â±5.50Âµs     6.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.0Â±0.05ms     3.6 MB/sec    1.01      7.1Â±0.04ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.00      8.0Â±0.02ms     5.1 MB/sec    1.02      8.2Â±0.06ms     5.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1638.2Â±11.37Âµs    10.2 MB/sec    1.02  1668.2Â±10.45Âµs    10.0 MB/sec
linter/default-rules/numpy/globals.py      1.00    177.8Â±1.65Âµs    16.6 MB/sec    1.01    179.5Â±1.51Âµs    16.4 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.6Â±0.02ms     7.1 MB/sec    1.01      3.6Â±0.01ms     7.0 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/tests/snapshots/black_compatibility@miscellaneous__long_strings_flag_disabled.py.snap</code>:605 on 2023-07-12 14:16</div>
            <div class="timeline-body"><p>you can open a black bug :P</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-07-12 14:16</div>
            <div class="timeline-body"><p>good catch</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-07-12 16:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-07-12 16:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-07-12 16:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:58:42 UTC
    </footer>
</body>
</html>
