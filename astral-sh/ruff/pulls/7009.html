<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add hidden `--preview` / `--no-preview` options to `ruff check` - astral-sh/ruff #7009</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add hidden <code>--preview</code> / <code>--no-preview</code> options to <code>ruff check</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7009">#7009</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2023-08-30 15:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>Per discussion at https://github.com/astral-sh/ruff/discussions/6998</p>
<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<!-- What's the purpose of the change? What does it do, and why? -->

<p>Adds a <code>--preview</code> and <code>--no-preview</code> option to the CLI for <code>ruff check</code> and corresponding settings. The CLI options are hidden for now.</p>
<p>Available in the settings as <code>preview = true</code> or <code>preview = false</code>.</p>
<p>Does not include environment variable configuration, although we may add it in the future.</p>
<h2>Test Plan</h2>
<!-- How was it tested? -->

<p><code>cargo build</code></p>
<p>Future work will build on this setting, such as toggling the mode during a test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_workspace/src/options.rs</code>:495 on 2023-08-30 15:52</div>
            <div class="timeline-body"><p>Should I just use <code>preview</code> here too?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-08-30 15:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-30 15:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_workspace/src/options.rs</code>:495 on 2023-08-30 15:54</div>
            <div class="timeline-body"><p>I would vote for <code>preview</code> here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-30 15:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_cli/src/args.rs</code>:118 on 2023-08-30 15:55</div>
            <div class="timeline-body"><p>Maybe a few-word description of what this will do?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-08-30 15:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cli</span> added by @charliermarsh on 2023-08-30 15:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-08-30 15:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_workspace/src/options.rs</code>:495 on 2023-08-30 15:59</div>
            <div class="timeline-body"><p>kk</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-30 16:03</div>
            <div class="timeline-body"><p>Should we introduce a <code>PreviewMode</code> enum that has <code>Enabled</code> and <code>Disabled</code> variant to make it easier to search for preview usages (instead of having to search for booleans named <code>preview</code>)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-30 16:04</div>
            <div class="timeline-body"><p>@MichaReiser - That's a nice idea.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-08-30 16:08</div>
            <div class="timeline-body"><p>I like it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-08-30 16:18</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>‚úÖ ecosystem check detected no changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-08-30 16:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_workspace/src/options.rs</code>:495 on 2023-08-30 16:23</div>
            <div class="timeline-body"><p>So.. I think we could make this <code>Option&lt;PreviewMode&gt;</code> too but I'm not entirely sure how to make that play nicely with the <code>JsonSchema</code>. I'm also not sure if we want <code>preview = enabled | disabled</code> or <code>preview = true | false</code> for users.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/settings/types.rs</code>:108 on 2023-08-30 16:29</div>
            <div class="timeline-body"><p>This always reminds me of @charliermarsh's tweet about how high-performance code looks like :laughing:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-30 16:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/options.rs</code>:495 on 2023-08-31 07:12</div>
            <div class="timeline-body"><p>I quickly looked into this but don't see a good solution for it other than implementing <code>Serialize</code>, <code>Deserialize</code> and <code>JsonSchema</code> manually on <code>PreviewMode</code> if we want <code>preview = true | false</code> (preview = enabled | disabled) should work out of the box.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-31 07:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-31 07:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/settings/types.rs</code>:100 on 2023-08-31 07:13</div>
            <div class="timeline-body"><p>This type being inside of the <code>ruff</code> crate means that we can't use it in the formatter, or any other crate (e.g. consider we need to gate some semantic model change)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-31 07:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/settings/types.rs</code>:98 on 2023-08-31 07:13</div>
            <div class="timeline-body"><p>I would expect the default value to come first</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/settings/types.rs</code>:95 on 2023-08-31 07:14</div>
            <div class="timeline-body"><pre><code class="language-suggestion">#[derive(Clone, Copy, Debug, PartialEq, Eq, Default, CacheKey, is_macro::Is)]
</code></pre>
<p>I think we can remove the ordering from PreviewMode. It's unclear to me where this would be useful (and what the expected ordering should be)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-31 07:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_workspace/src/options.rs</code>:495 on 2023-08-31 13:48</div>
            <div class="timeline-body"><p>Thanks! I'm happy to leave it as-is then</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-08-31 13:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-08-31 13:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/src/settings/types.rs</code>:100 on 2023-08-31 13:49</div>
            <div class="timeline-body"><p>Hm it seems wrong to put it elsewhere right now since there's a dedicated <code>settings/types.rs</code> module. This is a good callout though, we should probably have a <code>ruff_settings</code> crate so we can share with the formatter?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-08-31 13:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/src/settings/types.rs</code>:95 on 2023-08-31 13:50</div>
            <div class="timeline-body"><p>üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-31 13:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/settings/types.rs</code>:100 on 2023-08-31 13:59</div>
            <div class="timeline-body"><p>I think we can just move the <code>PreviewMode</code> because the type itself isn't specific to settings.</p>
<p>A <code>ruff_settings</code> crate isn't straightforward because the settings depend on the rules. So you would need to make the formatter depend on ruff.</p>
<p>I consider (at least most of what is in settings) settings as the linter-specific settings. The formatter has its own resolved settings that only contain the formatter settings. Most of this already exists with <code>PyFormatOptions</code>, although we probably want to add a few more settings.</p>
<p>What I have in mind is:</p>
<ul>
<li>each tool has its own resolved settings object</li>
<li><code>Configuration</code> is the unified configuration from which the workspace derives the tool Settings</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-08-31 14:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/src/settings/types.rs</code>:100 on 2023-08-31 14:00</div>
            <div class="timeline-body"><p>Where would you expect it to go?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-31 14:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/settings/types.rs</code>:100 on 2023-08-31 14:49</div>
            <div class="timeline-body"><p>I don't know :sweat_smile:</p>
<p>It would need to be some rather low-level crate that other crates can depend on without pulling in too many dependencies.</p>
<p>The alternative is to duplicate the enum in project where it is needed. I don't really mind that (e.g. the Linter has <code>LineLength</code> and the formatter has a very similar <code>LineWidth</code> option type)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-08-31 14:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/src/settings/types.rs</code>:100 on 2023-08-31 14:51</div>
            <div class="timeline-body"><p>Alright let's consider this TBD when preview support is added to the formatter</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2023-08-31 14:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2023-08-31 14:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-08-31 14:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-31 15:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/settings/types.rs</code>:100 on 2023-08-31 15:05</div>
            <div class="timeline-body"><p>Another way we could take is that <code>PreviewMode</code> remains in the configuration only and setting it to true or false changes individual settings in the tool-specific settings. Each tool can then decide whether it uses feature-specific flags or a single preview flag. For example, the formatter can either:</p>
<ul>
<li>Have a single preview setting that is set to enabled/disabled based on the preview mode</li>
<li>Or an experimental-string-handling and potentially other settings that configure a specific preview feature. Setting <code>preview=true</code> would enable/disable all of them at once.</li>
</ul>
<p>The benefit of feature specific flags is that individual features can be moved out of preview mode (and makes it easier to find all places where the check now needs to be removed)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:59:56 UTC
    </footer>
</body>
</html>
