<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update to macOS14 runner image - astral-sh/ruff #13728</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Update to macOS14 runner image</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13728">#13728</a>
        opened by <a href="https://github.com/diceroll123">@diceroll123</a>
        on 2024-10-13 06:28
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/diceroll123">@diceroll123</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Updates Github Actions macOS runner images to use macOS 13, since runners using 12 will be unavailable on/around December 3rd of this year.</p>
<p>Closes #13231</p>
<p>For more info, see that issue, as well as https://github.com/actions/runner-images/issues/10721. There will be a 10-hour brownout on each Monday in November.</p>
<h2>Test Plan</h2>
<p>I did not. ðŸ˜Ž (until after the checks passed)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cli</span> added by @MichaReiser on 2024-10-13 13:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-13 13:26</div>
            <div class="timeline-body"><p>Thanks for this PR and making us aware of the runner deprecation.</p>
<p>We intentionally downgraded the macOS runner in the past because using newer macOS versions resulted in binaries that are incompatible with macOS 11 (https://github.com/astral-sh/ruff/pull/11146, https://github.com/astral-sh/ruff/pull/9834). However, that means that we'll loose macOS 11 support, unless we find another way to cross compile binaries to macOS11.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-14 14:33</div>
            <div class="timeline-body"><p>I did some research and my general reading is that macOS only supports building for the same or newer versions but there doesn't seem to be a way to build for older macOS versions. That means, this PR drops support for macOS12 unless we find another way of running the release job in a macOs12 image.</p>
<p>I found some references of <code>MACOSX_DEPLOYMENT_TARGET</code> but it's unclear to me if that would have any effect, considering that the macOS13 image doesn't have the the macOS12 SDK installed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @MichaReiser by @MichaReiser on 2024-10-14 15:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-18 09:31</div>
            <div class="timeline-body"><p>Okay, good news. I think I narrowed down why Ruff 0.2 was crashing and we should be fine to just upgrade to the macos 14 runners.</p>
<p>I compared the dynamically linked libraries and they're mostly unchanged (ignoring versions)</p>
<pre><code>ruff 0.2
    /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation (compatibility version 150.0.0, current version 2202.0.0)
    /System/Library/Frameworks/CoreServices.framework/Versions/A/CoreServices (compatibility version 1.0.0, current version 1226.0.0)
    /usr/lib/libiconv.2.dylib (compatibility version 7.0.0, current version 7.0.0)
    /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1336.61.1)

ruff 0.6.9
    /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation (compatibility version 150.0.0, current version 2503.1.0)
    /System/Library/Frameworks/CoreServices.framework/Versions/A/CoreServices (compatibility version 1.0.0, current version 1226.0.0)
    /usr/lib/libiconv.2.dylib (compatibility version 7.0.0, current version 7.0.0)
    /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1345.120.2)
</code></pre>
<p>I also compared the dynamically linked symbols and they are almost identical: https://www.diffchecker.com/x9Nond5g/</p>
<p>That's why I went back to analysing the ruff 0.2 crash stack frame and I stumbled across https://github.com/realm/realm-swift/issues/8369 where one user suggests that this is an XCode bug that <a href="https://developer.apple.com/documentation/xcode-release-notes/xcode-15_1-release-notes#Resolved-Issues">was fixed</a> in 15.1</p>
<blockquote>
<p>Fixed: Binaries using symbols with a weak definition crash at runtime on iOS 14/macOS 12 or older. This impacts primarily C++ projects due to their extensive use of weak symbols. (114813650) (FB13097713)</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-18 09:31</div>
            <div class="timeline-body"><p>I'll upgrade the runner to macOS 14 to get faster compile times.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-18 09:34</div>
            <div class="timeline-body"><p>I tested that the binary built on macos 14 runs on a mac 10.15. I built the binary using the CI job in https://github.com/astral-sh/ruff/pull/13785</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Update to macOS13 runner image" to "Update to macOS14 runner image" by @MichaReiser on 2024-10-18 09:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-18 09:43</div>
            <div class="timeline-body"><p>I downloaded the macos x86-64 binary and verified that it works on macos 10.15</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2024-10-18 09:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-10-18 09:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cli</span> removed by @dhruvmanila on 2024-10-24 15:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ci</span> added by @dhruvmanila on 2024-10-24 15:13</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:06:57 UTC
    </footer>
</body>
</html>
