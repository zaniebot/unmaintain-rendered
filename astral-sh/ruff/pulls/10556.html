<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add tests for dictionary expression parsing - astral-sh/ruff #10556</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add tests for dictionary expression parsing</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10556">#10556</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-03-25 03:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR updates the existing valid test case for dictionary expression and adds some invalid ones to check how the parser is recovering.</p>
<p>The goal is mainly to check if the dictionary parsing is correct or not.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by @dhruvmanila on 2024-03-25 03:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by @dhruvmanila on 2024-03-25 03:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-27 09:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/resources/invalid/expressions/dict/recover.py</code>:27 on 2024-03-27 09:54</div>
            <div class="timeline-body"><p>This needs to be solved holistically similar to how it was done in star pattern parsing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-27 09:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:1325 on 2024-03-27 09:55</div>
            <div class="timeline-body"><p>Even parenthesized starred expression isn't allowed but that check will be done by <code>parse_parenthesized_expression</code> and not here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-27 09:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:1518 on 2024-03-27 09:56</div>
            <div class="timeline-body"><p>The idea to disallow starred expression in certain context would be to pass <code>AllowStarExpression</code> as an argument to <code>parse_conditional_expression_or_higher</code> and it'll report an error is it's not allowed. This way it's isolated to a single place. It'll be done in a follow-up PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dhruvmanila on 2024-03-27 09:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2024-03-27 09:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/tests/snapshots/invalid_syntax@expressions__dict__double_star.py.snap</code>:505 on 2024-03-27 10:26</div>
            <div class="timeline-body"><p>I'm a bit surprised by the recovery here. Should it not recognize that <code>if</code> is a valid expression start and parse the expression instead?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/tests/snapshots/invalid_syntax@expressions__dict__double_star.py.snap</code>:631 on 2024-03-27 10:28</div>
            <div class="timeline-body"><p>This is for the future. We could in theory parse this as a binary expression with a missing left side.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-03-27 10:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/resources/invalid/expressions/dict/missing_closing_brace_0.py</code>:1 on 2024-03-27 10:30</div>
            <div class="timeline-body"><p>I assume the reason why there's no test for an empty dictionary is because that's always parsed as an empty set?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-03-27 10:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-28 09:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/tests/snapshots/invalid_syntax@expressions__dict__double_star.py.snap</code>:505 on 2024-03-28 09:42</div>
            <div class="timeline-body"><p>The minimum precedence for an expression after <code>**</code> in a dictionary is bitwise or (<code>|</code>) and <code>if</code> expressions are lower than that. The parser won't parse the <code>if ...</code> because the grammar doesn't allow it. This is one of the areas which can possibly be changed when working on error recovery.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-28 09:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/resources/invalid/expressions/dict/missing_closing_brace_0.py</code>:1 on 2024-03-28 09:43</div>
            <div class="timeline-body"><p>Yes, unless the parser sees a <code>:</code>, it assumes that we're parsing a set.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-03-29 08:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/tests/snapshots/invalid_syntax@expressions__dict__double_star.py.snap</code>:631 on 2024-03-29 08:17</div>
            <div class="timeline-body"><p>The parser will be able to recover well with the star expression update I will be making in a follow-up PR. The grammar here is similar to star expression (<code>** bitwise_or</code>) but we'll allow the parser to be lenient and report an error.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2024-03-29 08:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-03-29 08:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-03-29 08:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-03-29 08:26</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:03:16 UTC
    </footer>
</body>
</html>
