<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] publish settings diagnostics - astral-sh/ruff #19335</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] publish settings diagnostics</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19335">#19335</a>
        opened by <a href="https://github.com/Gankra">@Gankra</a>
        on 2025-07-14 16:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/Gankra">@Gankra</a> on 2025-07-14 16:49</div>
            <div class="timeline-body"><p><em>No description provided.</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @Gankra on 2025-07-14 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @Gankra on 2025-07-14 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @Gankra on 2025-07-14 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @Gankra on 2025-07-14 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @Gankra on 2025-07-14 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @Gankra on 2025-07-14 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @Gankra on 2025-07-14 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by @Gankra on 2025-07-14 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @AlexWaygood on 2025-07-14 16:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-07-14 16:50</div>
            <div class="timeline-body"><p>Diagnostics now properly show up like this:</p>
<p><img width="1280" height="464" alt="Screenshot 2025-07-14 at 12 50 09 PM" src="https://github.com/user-attachments/assets/40770924-d50a-4819-9853-ab215e94a488" /></p>
<p>And clear out whenever the issue is fixed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-07-14 16:55</div>
            <div class="timeline-body"><p>Oh boy micha really merge conflicted me bad h'ok...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api/notifications/did_open.rs</code>:59 on 2025-07-14 16:57</div>
            <div class="timeline-body"><p>Can you tell me why we need to publish settings diagnostics during <code>did_open</code> and <code>did_change</code>? Is it that the diagnostics show up after starting the server? If so, here might be a better place for it:</p>
<p>https://github.com/astral-sh/ruff/blob/b4c42eb83b1215ad980a11265f38d84bdeba7e28/crates/ty_server/src/session.rs#L273-L285</p>
<p>Edit: I just saw that you already have a handler on that line. I guess it's simply not clear to me why we need this. I'd expect that <code>did_change_watched_files</code> is good enough</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-14 16:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api/diagnostics.rs</code>:117 on 2025-07-14 17:01</div>
            <div class="timeline-body"><p>I wonder if we should change this method to take a <code>&amp;mut Project</code> instead. It should be unlikely that a user changes all projects at once. It's more likely that they changed a setting for a specific project.</p>
<p>This would also ensure that we don't publish diagnostics for the default database (it should never have setting diagnostics but initializing it isn't entirely free)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-14 17:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-14 17:05</div>
            <div class="timeline-body"><blockquote>
<p>Oh boy micha really merge conflicted me bad h'ok...</p>
</blockquote>
<p>Lol sorry. But not all of the merge conflicts are because of me. Some are because of Dhruv ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-07-14 17:11</div>
            <div class="timeline-body"><p>Rebased</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-14 17:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_server/src/server/api/notifications/did_open.rs</code>:59 on 2025-07-14 17:13</div>
            <div class="timeline-body"><p>The code for apply_changes was complex enough to me that it wasn't clear that these entry points <em>couldn't</em> trigger a reparse of the ProjectMetadata, and the overhead of reprocessing the settings diagnostics seemed negligible (since 99.9% of the time there are no diagnostics and we do nothing).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-14 17:14</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_server/src/server/api/diagnostics.rs</code>:117 on 2025-07-14 17:16</div>
            <div class="timeline-body"><p>Huh, really? the default project really can't have any settings diagnostics?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-14 17:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-14 17:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_server/src/server/api/diagnostics.rs</code>:163 on 2025-07-14 17:18</div>
            <div class="timeline-body"><p>Any insight on this point would be appreciated</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-14 17:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_server/src/server/api/diagnostics.rs</code>:117 on 2025-07-14 17:20</div>
            <div class="timeline-body"><p>Also the current signature is &quot;required&quot; by the design of DidChangeWatchedFiles which processes random changes to random databases all together, producing only a single project_changed boolean. I could indeed make this more granular if we tracked project_changed per-project (but it's not clear to me it's worth the effort?).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-14 17:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api/notifications/did_open.rs</code>:59 on 2025-07-14 17:35</div>
            <div class="timeline-body"><p>My reasoning here would be that: Given that setting files are files that aren't tracked by the LSP, <code>didOpen</code> or <code>didChange</code> can never impact a setting file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-14 17:35</div>
            <div class="timeline-body"><p>I'll do a full review tomorrow as it's late here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-14 17:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api/diagnostics.rs</code>:163 on 2025-07-14 17:37</div>
            <div class="timeline-body"><p>You can get it from session (Session::position_encoding) and it's passed to all request handlers as an explicit argument. You might need to add a getter on <code>Session</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api/diagnostics.rs</code>:117 on 2025-07-15 09:06</div>
            <div class="timeline-body"><p><code>did_change_watched_files</code> does group all files by database and then calls <code>apply_changes</code> exacltly once per database. See this loop where <code>root </code>maps to the root of a database:</p>
<p>https://github.com/astral-sh/ruff/blob/fe8f0cfcf9760d39aa716deb180678bd72cd3aba/crates/ty_server/src/server/api/notifications/did_change_watched_files.rs#L88-L94</p>
<p>This should allow you to make <code>publish_settings_diagnostics</code> per database.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api/notifications/did_change_watched_files.rs</code>:110 on 2025-07-15 09:12</div>
            <div class="timeline-body"><p>We should skip calling <code>publish_settings_diagnostics</code> if the client uses workspace diagnostics as it is unnecessary</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/session.rs</code>:385 on 2025-07-15 09:12</div>
            <div class="timeline-body"><p>I think we need to call into <code>publish_settings_diagnostics</code> here to ensure the server pushes the diagnostics on initiale load.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-15 09:14</div>
            <div class="timeline-body"><p>This overall looks good.</p>
<p>We should remove the <code>publish_settings_diagnostics</code> calls in <code>did_change</code> and <code>did_open</code> because they're unnecessary. Instead, we should call <code>publish_settings_diagnostics</code> in <code>Session::initialize_workspaces</code></p>
<p>I'd also recommend making <code>publish_settings_diagnostics</code> to take a specific <code>project</code> instead of iterating over all projects.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @sharkdp on 2025-07-16 06:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-07-17 14:39</div>
            <div class="timeline-body"><p>Review addressed, should be ready to land.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-17 14:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_server/src/server/api/notifications/did_change_watched_files.rs</code>:110 on 2025-07-17 14:40</div>
            <div class="timeline-body"><p>I moved the check inside the call so each callsite doesn't need to think about it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-07-17 14:41</div>
            <div class="timeline-body"><p>Thank you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @Gankra on 2025-07-17 15:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Gankra on 2025-07-17 15:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-17 15:57</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:58:38 UTC
    </footer>
</body>
</html>
