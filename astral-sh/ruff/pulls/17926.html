<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Sort collected diagnostics before snapshotting them in mdtest - astral-sh/ruff #17926</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Sort collected diagnostics before snapshotting them in mdtest</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17926">#17926</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-05-07 17:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body">Summary
<p>ty&#x27;s diagnostics are always sorted into a stable order when ty is executed on the command line. However, this sorting is not applied when the diagnostics are collected by mdtests, which can result in them being snapshotted in our tests in a different order than they would appear to users. That&#x27;s quite confusing.</p>
<p>This PR fixes that by sorting the diagnostics collected by mdtest in the same way that we sort them when <code>ty</code> is actually executed on the command line.</p>
Test Plan
<ul>
<li><code>cargo test -p ty_python_semantic</code></li>
<li><code>cargo test -p ty_project</code></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-07 17:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-07 17:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-07 17:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-07 17:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-07 17:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-05-07 17:07</div>
            <div class="timeline-body"><p>Thank you! I noticed this a couple of times and I was going to open an issue for it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/BurntSushi">@BurntSushi</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-05-07 17:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-05-07 17:09</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:246 on 2025-05-07 17:09</div>
            <div class="timeline-body"><p>Nit: I sort of like how <code>TextRange</code> solved this. It has a <code>ordering</code> method. It could help reduce some complexity (no need for an extra struct, less lifetimes)</p>
<pre><code>pub fn ordering(&amp;self, db: &amp;dyn Db, other: &amp;Self) -&gt; Ordering {
	if let (Some(span1), Some(span2)) = (
      self.primary_span(),
      other.primary_span(),
  ) {
      let order = span1
          .file()
          .path(self.db)
          .as_str()
          .cmp(span2.file().path(self.db).as_str());
      if order.is_ne() {
          return order;
      }

      if let (Some(range1), Some(range2)) = (span1.range(), span2.range()) {
          let order = range1.start().cmp(&amp;range2.start());
          if order.is_ne() {
              return order;
          }
      }
  }
  // Reverse so that, e.g., Fatal sorts before Info.
  let order = self
      .severity()
      .cmp(&amp;other.severity())
      .reverse();
  if order.is_ne() {
      return order;
  }
  self.id().cmp(&amp;other.id())
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-05-07 17:10</div>
            <div class="timeline-body"><p>Nice, thank you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-05-07 17:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:246 on 2025-05-07 17:23</div>
            <div class="timeline-body"><p>I realised I could simplify it to a single lifetime (pushed the change). I weakly prefer encapsulating the sorting logic into a struct that represents the key (the way I have it now), but no strong opinion; happy to revisit this in a followup if others agree!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-07 17:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-07 17:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-05-07 17:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-05-07 17:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:246 on 2025-05-07 17:29</div>
            <div class="timeline-body"><p>I don&#x27;t feel too strongly personally. I&#x27;m fine with either approach given that these aren&#x27;t semver boundaries.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:14:09 UTC
    </footer>
</body>
</html>
