<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-async`] Implement `blocking-http-call-httpx` (`ASYNC212`) - astral-sh/ruff #20091</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-async</code>] Implement <code>blocking-http-call-httpx</code> (<code>ASYNC212</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20091">#20091</a>
        opened by <a href="https://github.com/amyreese">@amyreese</a>
        on 2025-08-26 00:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/amyreese">@amyreese</a> on 2025-08-26 00:18</div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff/ty! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title? (Please prefix with `[ty]` for ty pull
  requests.)
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>Adds new rule to find and report use of <code>httpx.Client</code> in synchronous
functions.</p>
<p>See issue #8451</p>
<h2>Test Plan</h2>
<p>New snapshots for <code>ASYNC212.py</code> with <code>cargo insta test</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amyreese">@amyreese</a> on 2025-08-26 00:23</div>
            <div class="timeline-body"><p>Still needs some work (and learning) to catch usage of <code>httpx.Client</code> methods, not just instantiation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-26 00:30</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> reviewed on 2025-08-27 00:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_async/ASYNC212.py</code>:61 on 2025-08-27 00:24</div>
            <div class="timeline-body"><p>This one still isn't caught, presumably because the TypeChecker bits only capture annotations at the function level?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @amyreese on 2025-08-27 00:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @ntBre on 2025-08-27 12:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_async/rules/blocking_http_call_httpx.rs</code>:45 on 2025-08-27 13:03</div>
            <div class="timeline-body"><p>You don't have to do this, but if you want to include the blocking call and/or the client in the message, you can include their names on the struct. Something like:</p>
<pre><code class="language-rust">#[derive(ViolationMetadata)]
pub(crate) struct BlockingHttpCallHttpxInAsyncFunction {
    call: String,
    client: String,
}

impl Violation for BlockingHttpCallHttpxInAsyncFunction {
    #[derive_message_formats]
    fn message(&amp;self) -&gt; String {
        format!(
            &quot;Blocking sync HTTP call {call} on httpx object {client}, use httpx.AsyncClient.&quot;,
            call = self.call, 
            client = self.client,
        )
    }
}
</code></pre>
<p>Nice work on the upstream contribution, I saw it when checking the upstream rule docs this morning :)</p>
<p>We also don't have to match the upstream phrasing, just using that as an idea to let you know this was possible.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_async/rules/blocking_http_call_httpx.rs</code>:73 on 2025-08-27 13:07</div>
            <div class="timeline-body"><p>I'm not sure we need this <code>traverse_union_and_optional</code> call, but to be honest I haven't written one of these <code>TypeChecker</code>s myself. Would something more like our <code>PathlibPathChecker</code> work:</p>
<p>https://github.com/astral-sh/ruff/blob/147f7a7f28c2c23ae5c749b7b57cadfc4a776ec3/crates/ruff_python_semantic/src/analyze/typing.rs#L914-L917</p>
<p>or did you run into cases where we weren't handling unions correctly? (That might be an issue with our other type checkers if so)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_async/rules/blocking_http_call_httpx.rs</code>:93 on 2025-08-27 13:12</div>
            <div class="timeline-body"><p>This looks great! My one tiny nit is to make this a sequence of early returns:</p>
<pre><code class="language-suggestion">    if !semantic.in_async_context() {
        return;
    }
    
    let Some(ast::ExprAttribute { value, attr, .. }) = call.func.as_attribute_expr() else {
        return;
    }
    
    let Some(name) = value.as_name_expr() else {
        return;
    }
</code></pre>
<p>That's a bit more verbose here, but I think that's our general style.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_async/ASYNC212.py</code>:61 on 2025-08-27 13:21</div>
            <div class="timeline-body"><p>I think this <em>should</em> work. I played around a bit with the PTH210 rule, which uses the <code>PathlibPathChecker</code>, and it will detect both module-level and function-level bindings like this:</p>
<pre><code class="language-py">def foo():
    path: Path = ...
    path.with_suffix(&quot;.&quot;)
</code></pre>
<p>I'm wondering if the union traversal might be disrupting this check.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_async/snapshots/ruff_linter__rules__flake8_async__tests__ASYNC212_ASYNC212.py.snap</code>:137 on 2025-08-27 13:29</div>
            <div class="timeline-body"><p>Ah okay, this doesn't work for PTH210. I understand the <code>traverse_union</code> call now. I'd probably lean toward not traversing unions and matching our other type inference calls, but I don't feel too strongly if you think this is an important use case. We could also consider making a more general change to our <code>TypeChecker</code> code if this would always be helpful.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_async/rules/blocking_http_call_httpx.rs</code>:73 on 2025-08-27 13:35</div>
            <div class="timeline-body"><p>I saw below that you do need this check. If I'm following the <code>traverse_union_options</code> code correctly, I think it's actually not &quot;traversing&quot; the top-level expression:</p>
<p>https://github.com/astral-sh/ruff/blob/147f7a7f28c2c23ae5c749b7b57cadfc4a776ec3/crates/ruff_python_semantic/src/analyze/typing.rs#L528-L531</p>
<p>which would explain the basic annotation check not working. You might just need to call your closure on <code>annotation</code> itself before passing it to <code>traverse_union_and_optional</code> to cover both cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-08-27 13:38</div>
            <div class="timeline-body"><p>This looks great, thank you! I just had a couple of small suggestions and some ideas about the union handling that might help with the simple annotation case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> reviewed on 2025-08-27 19:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/rules/flake8_async/snapshots/ruff_linter__rules__flake8_async__tests__ASYNC212_ASYNC212.py.snap</code>:137 on 2025-08-27 19:08</div>
            <div class="timeline-body"><p>I was doing this mostly to match behavior with the upstream ASYNC212 implementation, which explicitly includes these unions/optionals in its test cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-08-27 19:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/flake8_async/snapshots/ruff_linter__rules__flake8_async__tests__ASYNC212_ASYNC212.py.snap</code>:137 on 2025-08-27 19:18</div>
            <div class="timeline-body"><p>That makes sense! If we can handle both this and the regular annotation case, it's great to handle both. We can punt on trying to update any other <code>TypeChecker</code>s for now too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-08-27 21:22</div>
            <div class="timeline-body"><p>Nice, thanks!</p>
<p>Would you mind updating the title to:</p>
<p>[<code>flake8-async</code>] Implement <code>blocking-http-call-httpx</code> (<code>ASYNC212</code>)</p>
<p>(just wrapping the linter name and rule code in backticks)</p>
<p>We pull the PR titles for changelog entries, and that's how we usually stylize them.</p>
<p>Other than that, feel free to merge whenever you're ready!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @ntBre on 2025-08-27 21:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[flake8-async] Implement `blocking-http-call-httpx` (ASYNC212)" to "[`flake8-async`] Implement `blocking-http-call-httpx` (`ASYNC212`)" by @amyreese on 2025-08-27 22:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @amyreese on 2025-08-27 22:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @amyreese on 2025-08-27 22:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-28 16:56</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:46:48 UTC
    </footer>
</body>
</html>
