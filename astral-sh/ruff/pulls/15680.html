<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-pytest-style`] Rewrite references to `.exception` (`PT027`) - astral-sh/ruff #15680</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-pytest-style</code>] Rewrite references to <code>.exception</code> (<code>PT027</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15680">#15680</a>
        opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a>
        on 2025-01-23 01:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a></div>
            <div class="timeline-body">Summary
<p>Resolves #8650.</p>
Test Plan
<p><code>cargo nextest run</code> and <code>cargo insta test</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-23 01:32</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+2 -2 violations, +0 -0 fixes in 1 projects; 54 projects unchanged)</p>
<a href="https://github.com/apache/superset">apache/superset</a> (+2 -2 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --no-preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/apache/superset/blob/6d117ffbb564f611df21fcb9a19c15b9567f35d9/tests/integration_tests/charts/schema_tests.py#L59">tests/integration_tests/charts/schema_tests.py:59:9:</a> ANN201 Missing return type annotation for public function `test_query_context_series_limit`
- <a href="https://github.com/apache/superset/blob/6d117ffbb564f611df21fcb9a19c15b9567f35d9/tests/integration_tests/charts/schema_tests.py#L59">tests/integration_tests/charts/schema_tests.py:59:9:</a> ANN201 Missing return type annotation for public function `test_query_context_series_limit`
+ <a href="https://github.com/apache/superset/blob/6d117ffbb564f611df21fcb9a19c15b9567f35d9/tests/integration_tests/viz_tests.py#L739">tests/integration_tests/viz_tests.py:739:9:</a> ANN201 Missing return type annotation for public function `test_filter_nulls`
- <a href="https://github.com/apache/superset/blob/6d117ffbb564f611df21fcb9a19c15b9567f35d9/tests/integration_tests/viz_tests.py#L739">tests/integration_tests/viz_tests.py:739:9:</a> ANN201 Missing return type annotation for public function `test_filter_nulls`
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| ANN201 | 4 | 2 | 2 | 0 | 0 |</p>
</p>


Linter (preview)
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+3 -3 violations, +0 -0 fixes in 1 projects; 54 projects unchanged)</p>
<a href="https://github.com/apache/superset">apache/superset</a> (+3 -3 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
- <a href="https://github.com/apache/superset/blob/6d117ffbb564f611df21fcb9a19c15b9567f35d9/tests/integration_tests/charts/schema_tests.py#L59">tests/integration_tests/charts/schema_tests.py:59:9:</a> PLR6301 Method `test_query_context_series_limit` could be a function, class method, or static method
+ <a href="https://github.com/apache/superset/blob/6d117ffbb564f611df21fcb9a19c15b9567f35d9/tests/integration_tests/charts/schema_tests.py#L59">tests/integration_tests/charts/schema_tests.py:59:9:</a> PLR6301 Method `test_query_context_series_limit` could be a function, class method, or static method
- <a href="https://github.com/apache/superset/blob/6d117ffbb564f611df21fcb9a19c15b9567f35d9/tests/integration_tests/model_tests.py#L202">tests/integration_tests/model_tests.py:202:9:</a> PLR6301 Method `test_adjust_engine_params_mysql` could be a function, class method, or static method
+ <a href="https://github.com/apache/superset/blob/6d117ffbb564f611df21fcb9a19c15b9567f35d9/tests/integration_tests/model_tests.py#L202">tests/integration_tests/model_tests.py:202:9:</a> PLR6301 Method `test_adjust_engine_params_mysql` could be a function, class method, or static method
+ <a href="https://github.com/apache/superset/blob/6d117ffbb564f611df21fcb9a19c15b9567f35d9/tests/integration_tests/viz_tests.py#L899">tests/integration_tests/viz_tests.py:899:9:</a> ANN201 Missing return type annotation for public function `test_apply_rolling_without_data`
- <a href="https://github.com/apache/superset/blob/6d117ffbb564f611df21fcb9a19c15b9567f35d9/tests/integration_tests/viz_tests.py#L899">tests/integration_tests/viz_tests.py:899:9:</a> ANN201 Missing return type annotation for public function `test_apply_rolling_without_data`
</pre>

</p>

Changes by rule (2 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PLR6301 | 4 | 2 | 2 | 0 | 0 |
| ANN201 | 2 | 1 | 1 | 0 | 0 |</p>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/assertion.rs</code>:371 on 2025-01-23 07:08</div>
            <div class="timeline-body"><p>Do you mean <code>unittest_raises_assertion_binding</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/assertion.rs</code>:276 on 2025-01-23 07:10</div>
            <div class="timeline-body"><p>It took me a while to realise that the changes here are entirely unrelated to the PR itself. It can be helpful for changes like this to either add a comment that you decided to refactor it but it&#x27;s unrelated or make its own PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/assertion.rs</code>:375 on 2025-01-23 07:12</div>
            <div class="timeline-body"><p>Do I understand it correctly that what we want to test if <code>context_expr</code> is the <code>call</code>? If so, I suggest using <code>AnyNodeRef::ptr_eq</code>, it makes it more explicit rather than comparing ranges.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/assertion.rs</code>:395 on 2025-01-23 07:12</div>
            <div class="timeline-body"><p>Nit: I&#x27;d remove this, it&#x27;s already covered by line 397</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/assertion.rs</code>:433 on 2025-01-23 07:14</div>
            <div class="timeline-body"><p>A short inline comment explaining what this block does would be helpful</p>
<pre><code>    // Rewrite all references to `context_var.exception` to `context_var.value`
    // ```py
    // .. Example
    // ```
    for reference_id in binding.references() {
        let reference = semantic.reference(reference_id);
        let node_id = reference.expression_id()?;

        let mut ancestors = semantic.expressions(node_id).skip(1);

        let Expr::Attribute(ast::ExprAttribute { attr, .. }) = ancestors.next()? else {
            continue;
        };

        if attr.as_str() == &quot;exception&quot; {
            edits.push(Edit::range_replacement(&quot;value&quot;.to_string(), attr.range));
        }
    }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/assertion.rs</code>:425 on 2025-01-23 07:16</div>
            <div class="timeline-body"><p>Inline mainly helps with cross-crate calls and it should mainly be used for hot-functions (there&#x27;s a trade off with increased code size). Inlining more code can also lead to some compiler optimizations to no longer be applied because the function becomes too large. Furthermore, the compiler already applies heuristics to decide when to inline a function. That&#x27;s why <code>inline</code> should only be used where it matters, I don&#x27;t think it matters here.</p>
<pre><code></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/assertion.rs</code>:446 on 2025-01-23 07:18</div>
            <div class="timeline-body"><p><code>impl</code> can lead to monomorphization and we don&#x27;t need the flexibility here. We always have a vec (or can easily create an empty one)</p>
<pre><code>    extra_edits: Vec&lt;Edit&gt;,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-01-23 07:20</div>
            <div class="timeline-body"><p>Thanks. A few nit comments</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2025-01-23 13:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/assertion.rs</code>:276 on 2025-01-23 13:53</div>
            <div class="timeline-body"><p>Sorry. I should have said that only the first commit was intended to address the issue in question, like what I did <a href="https://github.com/astral-sh/ruff/pull/15665#issuecomment-2606000323">here</a>, but I forgot.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/src/rules/flake8_pytest_style/rules/assertion.rs</code>:395 on 2025-01-23 13:55</div>
            <div class="timeline-body"><p>I think I added this as a micro-optimization.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2025-01-23 13:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-23 15:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-01-23 16:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-23 16:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-23 16:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-23 16:53</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:10:44 UTC
    </footer>
</body>
</html>
