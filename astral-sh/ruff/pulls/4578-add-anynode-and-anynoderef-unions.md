```yaml
number: 4578
title: "Add `AnyNode` and `AnyNodeRef` unions"
type: pull_request
state: merged
author: MichaReiser
labels:
  - internal
assignees: []
merged: true
base: main
head: any-node-union
created_at: 2023-05-22T14:11:04Z
updated_at: 2023-05-23T06:53:33Z
url: https://github.com/astral-sh/ruff/pull/4578
synced_at: 2026-01-12T15:55:15Z
```

# Add `AnyNode` and `AnyNodeRef` unions

---

_@MichaReiser_

This introduces two new unions `AnyNode` and `AnyNodeRef`. They represent unions over all node python nodes and differ in that `AnyNodeRef` stores a reference where `AnyNode` is the owned version. 

Being able to pass an arbitrary node will become necessary in the formatter where I want to have a single function that decides to which node a comment should be associated (it accepts the parent node, preceding, and following nodes as `AnyNodeRef`). 

I further plan to use the `indextree` crate in the formatter that will allow us to access the parent/ancestor nodes. This requires a uniform type for all nodes and `AnyNodeRef` fits that bill perfectly. 

This looks like a lot of code. Most of it is just boilerplate (thanks multiline edits!). The API is:

## `AnyNode`
* `AnyNode::from(node)`: `AnyNode::from(if_stmt)` 
* `AnyNode::from(union)`: `AnyNode::from(stmt)` 
* `AnyNode::union() -> Option<Union>`: `node.statement()` returns `Some` if the `node` is any statement
* `AnyNode::node() -> Option<Node>`: `node.if_stmt()` returns `Some` if the `node` is an if statement
* `AnyNode::as_node() -> Option<&Node>`: `node.as_if_stmt()` returns `Some` if the `node` is an if statement
* `AnyNode::is_node() -> bool`: `node.is_if_stmt()` returns `true` if the `node` is an if statement.
* `AnyNode::as_ref() -> AnyNodeRef`: Returns a reference to this node. 

## Nodes

* `Node::cast(AnyNode) -> Option<Self>`: `IfStmt::cast(any_node)` returns `Some` if `any_node` is an if statement.
* `Node::cast_ref(AnyNodeRef) -> Option<&Self>: `IfStmt::cast_ref(node)` returns `Some` if the `node` is an if statement.

## `AnyNodeRef`

* `AnyNodeRef::from(&node)`
* `AnyNodeRef::from(&union)`
* `AnyNodeRef::as_node() -> Option<&Node>`
* `AnyNodeRef::is_node() -> bool` 

---

_Comment by @MichaReiser on 2023-05-22 14:11_

Current dependencies on/for this PR:
* main
  * **PR #4578** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4578" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #4585** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4585" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/charliermarsh/ruff/4578?utm_source=stack-comment).

---

_Comment by @github-actions[bot] on 2023-05-22 15:02_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.01     14.1Â±0.10ms     2.9 MB/sec    1.00     14.0Â±0.11ms     2.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.4Â±0.01ms     4.9 MB/sec    1.00      3.4Â±0.01ms     4.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    415.6Â±1.11Âµs     7.1 MB/sec    1.00    414.4Â±1.08Âµs     7.1 MB/sec
linter/all-rules/pydantic/types.py         1.01      5.8Â±0.05ms     4.4 MB/sec    1.00      5.8Â±0.02ms     4.4 MB/sec
linter/default-rules/large/dataset.py      1.00      6.6Â±0.04ms     6.2 MB/sec    1.00      6.6Â±0.03ms     6.2 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1434.7Â±5.13Âµs    11.6 MB/sec    1.00   1428.5Â±6.08Âµs    11.7 MB/sec
linter/default-rules/numpy/globals.py      1.01    159.5Â±0.28Âµs    18.5 MB/sec    1.00    158.3Â±1.08Âµs    18.6 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.0Â±0.00ms     8.5 MB/sec    1.00      3.0Â±0.01ms     8.6 MB/sec
parser/large/dataset.py                    1.00      5.2Â±0.01ms     7.9 MB/sec    1.01      5.2Â±0.01ms     7.8 MB/sec
parser/numpy/ctypeslib.py                  1.00   1019.6Â±0.60Âµs    16.3 MB/sec    1.01   1026.0Â±0.48Âµs    16.2 MB/sec
parser/numpy/globals.py                    1.00    104.8Â±0.15Âµs    28.2 MB/sec    1.01    105.5Â±0.14Âµs    28.0 MB/sec
parser/pydantic/types.py                   1.00      2.2Â±0.00ms    11.4 MB/sec    1.00      2.2Â±0.00ms    11.4 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.03     22.5Â±0.88ms  1855.3 KB/sec    1.00     21.8Â±0.84ms  1912.4 KB/sec
linter/all-rules/numpy/ctypeslib.py        1.05      5.6Â±0.24ms     3.0 MB/sec    1.00      5.3Â±0.32ms     3.1 MB/sec
linter/all-rules/numpy/globals.py          1.02   644.3Â±34.66Âµs     4.6 MB/sec    1.00   628.8Â±33.18Âµs     4.7 MB/sec
linter/all-rules/pydantic/types.py         1.09      9.6Â±0.34ms     2.6 MB/sec    1.00      8.8Â±0.37ms     2.9 MB/sec
linter/default-rules/large/dataset.py      1.18     12.5Â±0.59ms     3.3 MB/sec    1.00     10.6Â±0.41ms     3.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.15      2.5Â±0.44ms     6.5 MB/sec    1.00      2.2Â±0.10ms     7.5 MB/sec
linter/default-rules/numpy/globals.py      1.02   272.7Â±14.26Âµs    10.8 MB/sec    1.00   267.0Â±13.97Âµs    11.1 MB/sec
linter/default-rules/pydantic/types.py     1.13      5.3Â±0.23ms     4.8 MB/sec    1.00      4.7Â±0.20ms     5.4 MB/sec
parser/large/dataset.py                    1.31     10.8Â±0.50ms     3.8 MB/sec    1.00      8.3Â±0.22ms     4.9 MB/sec
parser/numpy/ctypeslib.py                  1.17  1937.9Â±96.17Âµs     8.6 MB/sec    1.00  1659.9Â±81.42Âµs    10.0 MB/sec
parser/numpy/globals.py                    1.21   198.3Â±12.87Âµs    14.9 MB/sec    1.00    163.5Â±9.09Âµs    18.0 MB/sec
parser/pydantic/types.py                   1.22      4.4Â±0.18ms     5.8 MB/sec    1.00      3.6Â±0.11ms     7.0 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Marked ready for review by @MichaReiser on 2023-05-22 16:19_

---

_Review comment by @charliermarsh on `Cargo.toml`:35 on 2023-05-22 16:40_

Do we not actually depend on this anywhere?

---

_@charliermarsh reviewed on 2023-05-22 16:40_

---

_@charliermarsh reviewed on 2023-05-22 16:41_

---

_Review comment by @charliermarsh on `crates/ruff_python_ast/src/node.rs`:80 on 2023-05-22 16:41_

What is this node kind?

---

_@charliermarsh approved on 2023-05-22 16:43_

---

_Comment by @charliermarsh on 2023-05-22 16:43_

If we use `indextree` in the formatter, should we consider using it in the linter? We have our own `Node` type, we do our own child-to-parent and sibling tracking. It'd be nice to use the same thing in both places, if we can.

---

_Comment by @MichaReiser on 2023-05-22 16:48_

> If we use `indextree` in the formatter, should we consider using it in the linter? We have our own `Node` type, we do our own child-to-parent and sibling tracking. It'd be nice to use the same thing in both places, if we can.

I think we could replace `Node` already today with `AnyNodeRef`, at least if we're okay that it now covers all Nodes and not just `Expr` and `Stmt`. 

Let me see how my experience is with `indextree` but I think re-using it could make sense (could also allow sharing more state between formatter and linter). 

---

_@MichaReiser reviewed on 2023-05-22 16:49_

---

_Review comment by @MichaReiser on `crates/ruff_python_ast/src/node.rs`:80 on 2023-05-22 16:49_

I don't know. But it exists ;)

---

_@MichaReiser reviewed on 2023-05-22 16:49_

---

_Review comment by @MichaReiser on `Cargo.toml`:35 on 2023-05-22 16:49_

I started using it in `ruff_python_ast` because our AST crate would, ideally, only depend on `ruff_python_ast` and not the lexer/parser.

---

_Comment by @charliermarsh on 2023-05-22 16:49_

Sounds good. Certainly doesn't need to block this PR or its use in the formatter.

---

_Merged by @MichaReiser on 2023-05-23 06:53_

---

_Closed by @MichaReiser on 2023-05-23 06:53_

---

_Branch deleted on 2023-05-23 06:53_

---

_Label `internal` added by @MichaReiser on 2023-05-23 06:53_

---
