<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Simplify unions containing multiple type variables during inference - astral-sh/ruff #21275</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Simplify unions containing multiple type variables during inference</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21275">#21275</a>
        opened by <a href="https://github.com/ibraheemdev">@ibraheemdev</a>
        on 2025-11-04 17:21
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a></div>
            <div class="timeline-body">Summary
<p>Splitting this one out from <a href="https://github.com/astral-sh/ruff/pull/21210">astral-sh/ruff#21210</a>. This is also something that should be made obselete by the new constraint solver, but is easy enough to fix now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-11-04 17:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-11-04 17:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-11-04 17:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-11-04 17:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-11-04 17:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-11-04 17:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-11-04 17:23</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-11-04 17:24</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>attrs (https://github.com/python-attrs/attrs)
- tests/test_validators.py:185:68: error[invalid-argument-type] Argument to function `matches_re` is incorrect: Expected `((Literal[&quot;a&quot;], Literal[&quot;a&quot;], int, /) -&gt; Match[Literal[&quot;a&quot;]] | None) | None`, found `Overload[(pattern: str | Pattern[str], string: str, flags: Unknown = Literal[0]) -&gt; Match[str] | None, (pattern: bytes | Pattern[bytes], string: @Todo, flags: Unknown = Literal[0]) -&gt; Match[bytes] | None]`
- tests/test_validators.py:219:56: error[invalid-argument-type] Argument to function `matches_re` is incorrect: Expected `((Literal[&quot;a&quot;], Literal[&quot;a&quot;], int, /) -&gt; Match[Literal[&quot;a&quot;]] | None) | None`, found `Overload[(pattern: str | Pattern[str], string: str, flags: Unknown = Literal[0]) -&gt; Match[str] | None, (pattern: bytes | Pattern[bytes], string: @Todo, flags: Unknown = Literal[0]) -&gt; Match[bytes] | None]`
- tests/test_validators.py:228:32: error[invalid-argument-type] Argument to function `matches_re` is incorrect: Expected `((Literal[&quot;a&quot;], Literal[&quot;a&quot;], int, /) -&gt; Match[Literal[&quot;a&quot;]] | None) | None`, found `() -&gt; Unknown`
+ tests/test_validators.py:228:32: error[invalid-argument-type] Argument to function `matches_re` is incorrect: Expected `((str, str, int, /) -&gt; Match[str] | None) | None`, found `() -&gt; Unknown`
- typing-examples/mypy.py:250:64: error[invalid-argument-type] Argument to function `matches_re` is incorrect: Expected `((Literal[&quot;foo&quot;], Literal[&quot;foo&quot;], int, /) -&gt; Match[Literal[&quot;foo&quot;]] | None) | None`, found `Overload[(pattern: str | Pattern[str], string: str, flags: Unknown = Literal[0]) -&gt; Match[str] | None, (pattern: bytes | Pattern[bytes], string: @Todo, flags: Unknown = Literal[0]) -&gt; Match[bytes] | None]`
- Found 587 diagnostics
+ Found 584 diagnostics

scrapy (https://github.com/scrapy/scrapy)
+ tests/test_http_request.py:1428:21: error[invalid-argument-type] Argument to function `parse_qs` is incorrect: Argument type `bytes | str` does not satisfy constraints (`str`, `bytes`) of type variable `AnyStr`
- Found 1699 diagnostics
+ Found 1700 diagnostics

schemathesis (https://github.com/schemathesis/schemathesis)
- src/schemathesis/specs/openapi/checks.py:644:37: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 254 diagnostics
+ Found 253 diagnostics

tornado (https://github.com/tornadoweb/tornado)
- tornado/test/httputil_test.py:91:30: error[invalid-argument-type] Argument to function `qs_to_qsl` is incorrect: Expected `dict[str, list[str]]`, found `dict[Literal[&quot;a=1&amp;b=2&amp;a=3&quot;], list[Literal[&quot;a=1&amp;b=2&amp;a=3&quot;]]]`
- Found 332 diagnostics
+ Found 331 diagnostics

optuna (https://github.com/optuna/optuna)
- optuna/_gp/search_space.py:74:21: error[invalid-argument-type] Argument to function `_normalize_one_param` is incorrect: Expected `tuple[int | float, int | float]`, found `tuple[Unknown | ndarray[Unknown, &lt;class &#x27;float&#x27;&gt;], Unknown | ndarray[Unknown, &lt;class &#x27;float&#x27;&gt;]]`
- optuna/_gp/search_space.py:75:21: error[invalid-argument-type] Argument to function `_normalize_one_param` is incorrect: Expected `int | float`, found `Unknown | ndarray[Unknown, &lt;class &#x27;float&#x27;&gt;]`
- optuna/_gp/search_space.py:104:21: error[invalid-argument-type] Argument to function `_normalize_one_param` is incorrect: Expected `tuple[int | float, int | float]`, found `tuple[Unknown | ndarray[Unknown, &lt;class &#x27;float&#x27;&gt;], Unknown | ndarray[Unknown, &lt;class &#x27;float&#x27;&gt;]]`
- optuna/_gp/search_space.py:105:21: error[invalid-argument-type] Argument to function `_normalize_one_param` is incorrect: Expected `int | float`, found `Unknown | ndarray[Unknown, &lt;class &#x27;float&#x27;&gt;]`
- optuna/_gp/search_space.py:181:53: error[invalid-argument-type] Argument to function `_round_one_normalized_param` is incorrect: Expected `tuple[int | float, int | float]`, found `tuple[Unknown | ndarray[Unknown, &lt;class &#x27;float&#x27;&gt;], Unknown | ndarray[Unknown, &lt;class &#x27;float&#x27;&gt;]]`
- optuna/_gp/search_space.py:181:83: error[invalid-argument-type] Argument to function `_round_one_normalized_param` is incorrect: Expected `int | float`, found `Unknown | ndarray[Unknown, &lt;class &#x27;float&#x27;&gt;]`
- tests/gp_tests/test_search_space.py:109:13: error[invalid-argument-type] Argument to function `_unnormalize_one_param` is incorrect: Expected `tuple[int | float, int | float]`, found `Unknown | ndarray[Unknown, &lt;class &#x27;float&#x27;&gt;]`
- tests/gp_tests/test_search_space.py:110:13: error[invalid-argument-type] Argument to function `_unnormalize_one_param` is incorrect: Expected `int | float`, found `Unknown | ndarray[Unknown, &lt;class &#x27;float&#x27;&gt;]`
- Found 583 diagnostics
+ Found 575 diagnostics

xarray (https://github.com/pydata/xarray)
+ xarray/coding/strings.py:180:13: error[invalid-argument-type] Argument to bound method `map_blocks` is incorrect: Argument type `Literal[&quot;S1&quot;]` does not satisfy upper bound `dtype[Any]` of type variable `_DType_co`
- Found 1747 diagnostics
+ Found 1748 diagnostics

meson (https://github.com/mesonbuild/meson)
- mesonbuild/interpreter/type_checking.py:307:1: error[invalid-assignment] Object of type `KwargInfo[dict[Unknown, Unknown]]` is not assignable to `KwargInfo[str | list[str] | dict[str, @Todo]]`
- unittests/internaltests.py:1446:88: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `dict[list[Unknown] | ContainerTypeInfo | type, str | tuple[str, str]] | None`, found `dict[Unknown | str, Unknown | str]`
- unittests/internaltests.py:1446:122: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `dict[list[Unknown] | ContainerTypeInfo | type, str | tuple[str, str]] | None`, found `dict[Unknown | str, Unknown | str]`
- unittests/internaltests.py:1447:75: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `dict[dict[Unknown, Unknown] | ContainerTypeInfo | type, str | tuple[str, str]] | None`, found `dict[Unknown | str, Unknown | str | tuple[str, str]]`
- unittests/internaltests.py:1447:143: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `dict[dict[Unknown, Unknown] | ContainerTypeInfo | type, str | tuple[str, str]] | None`, found `dict[Unknown | str, Unknown | str | tuple[str, str]]`
- Found 1680 diagnostics
+ Found 1675 diagnostics

scikit-learn (https://github.com/scikit-learn/scikit-learn)
- sklearn/preprocessing/tests/test_encoders.py:846:63: error[invalid-argument-type] Argument to function `__new__` is incorrect: Expected `Iterable[Unknown]`, found `Unknown | None | ndarray[tuple[int], &lt;class &#x27;object&#x27;&gt;]`
+ sklearn/preprocessing/tests/test_encoders.py:846:63: error[invalid-argument-type] Argument to function `__new__` is incorrect: Expected `Iterable[Unknown]`, found `Unknown | None`
- sklearn/preprocessing/tests/test_encoders.py:889:19: error[invalid-argument-type] Argument to function `__new__` is incorrect: Expected `Iterable[Unknown]`, found `Unknown | None | ndarray[tuple[int], &lt;class &#x27;object&#x27;&gt;]`
+ sklearn/preprocessing/tests/test_encoders.py:889:19: error[invalid-argument-type] Argument to function `__new__` is incorrect: Expected `Iterable[Unknown]`, found `Unknown | None`

dd-trace-py (https://github.com/DataDog/dd-trace-py)
- ddtrace/internal/ci_visibility/git_client.py:99:38: error[invalid-argument-type] Argument to function `urljoin` is incorrect: Expected `Literal[&quot;/evp_proxy/v2/api/v2/git&quot;]`, found `Unknown | DerivedVariable[Unknown]`
+ ddtrace/internal/ci_visibility/git_client.py:99:38: error[invalid-argument-type] Argument to function `urljoin` is incorrect: Expected `str`, found `Unknown | DerivedVariable[Unknown]`

pandas-stubs (https://github.com/pandas-dev/pandas-stubs)
- tests/indexes/test_indexes.py:1577:11: error[type-assertion-failure] Argument does not have asserted type `Index[Any]`
- Found 5415 diagnostics
+ Found 5414 diagnostics

pandas (https://github.com/pandas-dev/pandas)
- pandas/core/arrays/boolean.py:259:24: warning[possibly-missing-attribute] Attribute `shape` may be missing on object of type `Unknown | None`
+ pandas/core/arrays/boolean.py:259:24: warning[possibly-missing-attribute] Attribute `shape` may be missing on object of type `@Todo | None`
- pandas/core/arrays/boolean.py:262:12: error[invalid-return-type] Return type does not match returned value: expected `tuple[ndarray[@Todo, Unknown], ndarray[@Todo, Unknown]]`, found `tuple[@Todo | ndarray[tuple[int], &lt;class &#x27;bool&#x27;&gt;], Unknown | None]`
+ pandas/core/arrays/boolean.py:262:12: error[invalid-return-type] Return type does not match returned value: expected `tuple[ndarray[@Todo, Unknown], ndarray[@Todo, Unknown]]`, found `tuple[@Todo, @Todo | None]`
- pandas/core/internals/construction.py:254:29: error[invalid-argument-type] Argument to function `_ensure_2d` is incorrect: Expected `ndarray[@Todo, Unknown]`, found `Unknown | ExtensionArray | ndarray[@Todo, Unknown]`
- pandas/core/internals/managers.py:1165:21: warning[possibly-missing-attribute] Attribute `kind` may be missing on object of type `&lt;class &#x27;object&#x27;&gt; | Unknown`
- pandas/core/internals/managers.py:1175:24: warning[possibly-missing-attribute] Attribute `kind` may be missing on object of type `&lt;class &#x27;object&#x27;&gt; | Unknown`
- pandas/tests/scalar/timedelta/test_arithmetic.py:183:18: error[unsupported-operator] Operator `-` is unsupported between objects of type `Timedelta` and `timedelta64[str]`
- pandas/tests/scalar/timedelta/test_arithmetic.py:186:18: error[unsupported-operator] Operator `-` is unsupported between objects of type `timedelta64[str]` and `Timedelta`
- pandas/tests/scalar/timedelta/test_arithmetic.py:551:18: error[unsupported-operator] Operator `/` is unsupported between objects of type `timedelta64[str]` and `Timedelta`
+ pandas/tests/scalar/timedelta/test_arithmetic.py:551:18: error[unsupported-operator] Operator `/` is unsupported between objects of type `timedelta64[timedelta | int | None]` and `Timedelta`
- Found 3378 diagnostics
+ Found 3373 diagnostics

sympy (https://github.com/sympy/sympy)
+ sympy/polys/tests/test_polyclasses.py:110:12: error[unsupported-operator] Operator `+` is unsupported between objects of type `DMP[MPZ]` and `Literal[5]`
+ sympy/polys/tests/test_polyclasses.py:118:12: error[unsupported-operator] Operator `-` is unsupported between objects of type `DMP[MPZ]` and `Literal[5]`
+ sympy/polys/tests/test_polyclasses.py:126:12: error[unsupported-operator] Operator `*` is unsupported between objects of type `DMP[MPZ]` and `Literal[5]`
- Found 14459 diagnostics
+ Found 14462 diagnostics

scipy (https://github.com/scipy/scipy)
+ scipy/linalg/tests/test_basic.py:1427:29: error[no-matching-overload] No overload of function `tri` matches arguments
+ scipy/linalg/tests/test_basic.py:1439:29: error[no-matching-overload] No overload of function `tri` matches arguments
- Found 9074 diagnostics
+ Found 9076 diagnostics

</code></pre>

No memory usage changes detected ✅

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/generics/pep695/functions.md</code>:477 on 2025-11-04 17:50</div>
            <div class="timeline-body"><pre><code>If the type variable is present multiple times in the union, we choose the correct union element to
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-11-04 17:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-11-05 15:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-11-05 15:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-11-05 15:03</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:20:15 UTC
    </footer>
</body>
</html>
