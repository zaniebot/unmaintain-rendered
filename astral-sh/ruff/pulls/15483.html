<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`ruff`] `itertools.starmap(..., zip(...))` (`RUF058`) - astral-sh/ruff #15483</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>ruff</code>] <code>itertools.starmap(..., zip(...))</code> (<code>RUF058</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15483">#15483</a>
        opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a>
        on 2025-01-15 00:22
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a></div>
            <div class="timeline-body">Summary
<p>Resolves #15481, resolves #14835.</p>
Test Plan
<p><code>cargo nextest run</code> and <code>cargo insta test</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-15 00:28</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+2 -0 violations, +0 -0 fixes in 2 projects; 53 projects unchanged)</p>
<a href="https://github.com/pandas-dev/pandas">pandas-dev/pandas</a> (+1 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/pandas-dev/pandas/blob/a15a4b5e6f0397906f619ce8888670eadcf3af55/pandas/tests/arithmetic/test_datetime64.py#L2214">pandas/tests/arithmetic/test_datetime64.py:2214:32:</a> RUF058 [*] `itertools.starmap` called on `zip` iterable
</pre>

</p>

<a href="https://github.com/astropy/astropy">astropy/astropy</a> (+1 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/astropy/astropy/blob/fe715540195e94d6836bc639c9a312aceaf99849/astropy/table/soco.py#L81">astropy/table/soco.py:81:34:</a> RUF058 [*] `itertools.starmap` called on `zip` iterable
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| RUF058 | 2 | 2 | 0 | 0 | 0 |</p>
</p>


Formatter (stable)
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to read examples/Assistants_API_overview_python.ipynb: Expected a Jupyter Notebook, which must be internally stored as JSON, but this file isn&#x27;t valid JSON: expected `,` or `]` at line 197 column 8
</code></pre>
</p>


Formatter (preview)
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to read examples/Assistants_API_overview_python.ipynb: Expected a Jupyter Notebook, which must be internally stored as JSON, but this file isn&#x27;t valid JSON: expected `,` or `]` at line 197 column 8
</code></pre>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2025-01-15 09:06</div>
            <div class="timeline-body"><p>Thank you. I don&#x27;t think we can implement this right now without changing <code>FURB140</code>. You can see in this <a href="https://play.ruff.rs/a9af7dfb-6dc5-4eee-b8c9-f41437eb24bf">playground</a> that <code>FURB140</code> recommends using <code>starmap</code> for <code>map(..., zip)</code>. I think this is what I meant that we have to change <code>FURB140</code> first but I incorrectly wrote <code>map</code> instead of saying that it shouldn&#x27;t apply to <code>zip</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-15 09:07</div>
            <div class="timeline-body"><p>I&#x27;ll close this PR for now so that we can have the discussion in a single place. We can re-open it once we decide that the rule should be added and <code>FURB140</code> is changed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-15 09:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-15 13:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-15 13:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-15 13:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/refurb/rules/reimplemented_starmap.rs</code>:32 on 2025-01-15 13:55</div>
            <div class="timeline-body"><p>Thanks for updating the documentation. That means this PR also fixes <a href="https://github.com/astral-sh/ruff/issues/14835">astral-sh/ruff#14835</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/starmap_zip.rs</code>:13 on 2025-01-15 14:01</div>
            <div class="timeline-body"><p>I find the explanation here a bit confusing because it uses the term <code>zip</code>. It suggests that the iterable should be zipped (with <code>zip</code>) before calling <code>starmap</code> but it actually tests for the exact opposite.</p>
<p>I suggest to rephrase it by putting the focus on saying that <code>zip</code>ing an iterable only to unpack the elements using <code>starmap</code> is unnecessary and that <code>map</code> should be used instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/starmap_zip.rs</code>:55 on 2025-01-15 14:04</div>
            <div class="timeline-body"><p>Nit: Resolving the qualified name is more expensive than some of the other tests</p>
<pre><code>    if !call.arguments.keywords.is_empty() {
        return;
    }

    let [map_func, Expr::Call(iterable_call)] = call.arguments.args.as_ref() else {
        return;
    };


    let Some(qualified_name) = semantic.resolve_qualified_name(&amp;call.func) else {
        return;
    };

    if !matches!(qualified_name.segments(), [&quot;itertools&quot;, &quot;starmap&quot;]) {
        return;
    }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/starmap_zip.rs</code>:70 on 2025-01-15 14:05</div>
            <div class="timeline-body"><p>Would you mind creating an issue so that we don&#x27;t forget adding support for it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/starmap_zip.rs</code>:82 on 2025-01-15 14:10</div>
            <div class="timeline-body"><p>What&#x27;s the reason for using the range from <code>starmap.start</code> to the arguments here instead of using <code>starmap.func.range</code>. Using <code>starmap.func.range()</code> allows to preserve most of the existing formating</p>
<pre><code>    let starmap_func_range = TextRange::new(starmap.start(), starmap.arguments.start());
    let change_func_to_map = Edit::range_replacement(&quot;map&quot;.to_string(), starmap_func_range);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/starmap_zip.rs</code>:88 on 2025-01-15 14:10</div>
            <div class="timeline-body"><pre><code>        zip.arguments.start() + &quot;(&quot;.text_len(),
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/starmap_zip.rs</code>:122 on 2025-01-15 14:19</div>
            <div class="timeline-body"><pre><code>    let before_zip_end = zip_end - &quot;)&quot;.text_len();
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/starmap_zip.rs</code>:119 on 2025-01-15 14:20</div>
            <div class="timeline-body"><p>Could we add some comments here. E.g what&#x27;s this block doing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/starmap_zip.rs</code>:84 on 2025-01-15 14:20</div>
            <div class="timeline-body"><p>Would it be possible to use a combination of <code>remove_argument</code> and <code>add_argument</code> instead of rolling our own fix here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-01-15 14:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/src/rules/ruff/rules/starmap_zip.rs</code>:84 on 2025-01-15 15:16</div>
            <div class="timeline-body"><p>I don&#x27;t think so. <code>add_argument()</code> <a href="https://github.com/astral-sh/ruff/blob/55a7f72035390cf1093e4da0cf2462e793bfbce1/crates/ruff_linter/src/fix/edits.rs#L278">hardcodes <code>&quot;, {argument}&quot;</code></a> as the new content, while this rule aims to preserve styling as much as possible.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2025-01-15 15:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2025-01-15 15:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/src/rules/ruff/rules/starmap_zip.rs</code>:70 on 2025-01-15 15:44</div>
            <div class="timeline-body"><p>Opened #15506.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-01-16 11:01</div>
            <div class="timeline-body"><p>I pushed a commit that simplifies the fix a bit. I&#x27;m mainly trying to avoid using the tokens where they aren&#x27;t strictly necessary because they add a fair bit of complexity and it&#x27;s very easy to get them wrong.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-01-16 13:25</div>
            <div class="timeline-body"><p>The changes are nice, especially the extra <code>Arguments</code> methods. Why isn&#x27;t CI passing, though? I can&#x27;t reproduce this locally.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-16 13:33</div>
            <div class="timeline-body"><p>I think it requires a rebase (github rebases your changes on main before running the checks)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2025-01-16 14:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_text_size/src/range.rs</code>:47 on 2025-01-16 14:06</div>
            <div class="timeline-body"><p>@MichaReiser By the way, what is this for? Seems to be a debug-only change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-01-16 14:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_text_size/src/range.rs</code>:47 on 2025-01-16 14:17</div>
            <div class="timeline-body"><p>It changes where Rust reports any panics in this method. Without <code>track_caller</code>, the top stack frame is <code>TextRange::new</code> which isn&#x27;t very helpful when debugging why <code>start &gt; end</code>. Adding <code>track_caller</code> makes Rust report the call site instead of the assertion location</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-16 14:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-16 14:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-16 14:58</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:10:23 UTC
    </footer>
</body>
</html>
