<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Allow gradual lower/upper bounds in a constraint set - astral-sh/ruff #21957</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Allow gradual lower/upper bounds in a constraint set</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21957">#21957</a>
        opened by <a href="https://github.com/dcreager">@dcreager</a>
        on 2025-12-12 20:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a></div>
            <div class="timeline-body"><p>We now allow the lower and upper bounds of a constraint to be gradual. Before, we would take the top/bottom materializations of the bounds. This required us to pass in whether the constraint was intended for a subtyping check or an assignability check, since that would control whether we took the &quot;restrictive&quot; or &quot;permissive&quot; materializations, respectively.</p>
<p>Unfortunately, doing so means that we lost information about whether the original query involves a non-fully-static type. This would cause us to create specializations like <code>T = object</code> for the constraint <code>T ≤ Any</code>, when it would be nicer to carry through the gradual type and produce <code>T = Any</code>.</p>
<p>We&#x27;re not currently using constraint sets for subtyping checks, nor are we going to in the very near future. So for now, we&#x27;re going to assume that constraint sets are always used for assignability checks, and allow the lower/upper bounds to not be fully static. Once we get to the point where we need to use constraint sets for subtyping checks, we will consider how best to record this information in constraints.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/dcreager">@dcreager</a> on 2025-12-12 20:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/dcreager">@dcreager</a> on 2025-12-12 20:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/dcreager">@dcreager</a> on 2025-12-12 20:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/dcreager">@dcreager</a> on 2025-12-12 20:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/dcreager">@dcreager</a> on 2025-12-12 20:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-12-12 20:06</div>
            <div class="timeline-body"><p>As written, note that this PR still takes the materializations of gradual typevar bounds and constraints. That deserves its own think, but is not as simple of a change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-12 20:07</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-12 20:09</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected ✅</p>
<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-12 20:53</div>
            <div class="timeline-body"><p>Reviewing now... I&#x27;m seeing one failing test in CI? Is this something non-deterministic?</p>
<p>I think materializing gradual upper bounds / constraints is likely fine for now (and maybe for always).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/generics/specialize_constrained.md</code>:75 on 2025-12-12 20:55</div>
            <div class="timeline-body"><p>Nice, this seems like the right solution here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/generics/specialize_constrained.md</code>:169 on 2025-12-12 20:56</div>
            <div class="timeline-body"><p>These are <code>None</code> because we have no basis for picking between <code>Base</code> and <code>Unrelated</code>, so we&#x27;ll just fall back to <code>Unknown</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-12-12 20:57</div>
            <div class="timeline-body"><p>Looks good!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-12 20:58</div>
            <div class="timeline-body"><blockquote>
<p>I think materializing gradual upper bounds / constraints is likely fine for now (and maybe for always).</p>
</blockquote>
<p>Well, maybe not for always -- I just realized that not doing this may be part of the fix for all those TODOs in the tests around bound-by-gradual and constrained-by-gradual typevars, where we want to solve to the actual gradual constraint. But I think this is much lower priority.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-13 00:03</div>
            <div class="timeline-body"><p>The failing test is an intersection ordering, and it passes for me locally, so it looks like a non-deterministic Salsa IDs issue.</p>
<p>Not sure if there&#x27;s a cleverer solution inside the constraint-set implementation, but an easy (and I think cheap) solution would be to just normalize the ordering of those intersection types via <code>union_or_intersection_elements_ordering</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/resources/mdtest/generics/specialize_constrained.md</code>:169 on 2025-12-13 02:19</div>
            <div class="timeline-body"><p>That&#x27;s right</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-12-13 02:43</div>
            <div class="timeline-body"><blockquote>
<p>Not sure if there&#x27;s a cleverer solution inside the constraint-set implementation, but an easy (and I think cheap) solution would be to just normalize the ordering of those intersection types via <code>union_or_intersection_elements_ordering</code>.</p>
</blockquote>
<p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dcreager">@dcreager</a> on 2025-12-13 03:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dcreager">@dcreager</a> on 2025-12-13 03:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-12-13 03:18</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:21:41 UTC
    </footer>
</body>
</html>
