<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group function definition parameters with return type annotations - astral-sh/ruff #6410</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Group function definition parameters with return type annotations</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6410">#6410</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-08-08 01:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-08 01:37</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR removes the group around function definition parameters, instead grouping the parameters with the type parameters and return type annotation.</p>
<p>This increases Zulip's similarity score from 0.99385 to 0.99699, so it's a meaningful improvement. However, there's at least one stability error that I'm working on, and I'm really just looking for high-level feedback at this point, because I'm not happy with the solution.</p>
<p>Closes https://github.com/astral-sh/ruff/issues/6352.</p>
<h2>Test Plan</h2>
<p>Before:</p>
<ul>
<li><code>zulip</code>: 0.99396</li>
<li><code>django</code>: 0.99784</li>
<li><code>warehouse</code>: 0.99578</li>
<li><code>build</code>: 0.75436</li>
<li><code>transformers</code>: 0.99407</li>
<li><code>cpython</code>: 0.75987</li>
<li><code>typeshed</code>: 0.74432</li>
</ul>
<p>After:</p>
<ul>
<li><code>zulip</code>: 0.99702</li>
<li><code>django</code>: 0.99784</li>
<li><code>warehouse</code>: 0.99585</li>
<li><code>build</code>: 0.75623</li>
<li><code>transformers</code>: 0.99470</li>
<li><code>cpython</code>: 0.75988</li>
<li><code>typeshed</code>: 0.74853</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @charliermarsh on 2023-08-08 01:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2023-08-08 01:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-08 01:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/expression/parentheses.rs</code>:157 on 2023-08-08 01:38</div>
            <div class="timeline-body"><p>In short: we need to avoid this <code>group</code> call in <em>certain</em> uses of <code>parenthesized</code>. I could add an entirely separate builder if we prefer, but I'll need to add a separately builder for <code>empty_parenthesized</code> too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/other/parameters.rs</code>:251 on 2023-08-08 01:38</div>
            <div class="timeline-body"><p>E.g., here is where we're ungrouping.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-08 01:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/expression/parentheses.rs</code>:157 on 2023-08-08 01:39</div>
            <div class="timeline-body"><p>(For <code>empty_parenthesized</code>, we could even remove the <code>group</code> entirely and require the callers to wrap in <code>group</code>. For <code>parenthesized</code>, we can't do that, because we wrap the <code>group</code> in a <code>fits_expanded</code> in the <code>NodeLevel::Expression</code> case.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-08 01:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @charliermarsh on 2023-08-08 01:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @charliermarsh on 2023-08-08 01:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2023-08-08 01:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-08 01:40</div>
            <div class="timeline-body"><p>As I said in the summary, I'd like feedback on <code>with_ungroup</code>, or whether I should be doing this completely differently. I'm not yet looking for approval (but I also don't want to mark it as draft, since I do want eyes on it).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-08 02:07</div>
            <div class="timeline-body"><p>(I think this also breaks the behavior whereby we insert a trailing comma if the parameters group breaks, but I believe I can fix that.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-08-08 02:25</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.02      8.4Â±0.05ms     4.9 MB/sec    1.00      8.2Â±0.03ms     4.9 MB/sec
formatter/numpy/ctypeslib.py               1.03  1637.1Â±13.26Âµs    10.2 MB/sec    1.00  1592.1Â±10.64Âµs    10.5 MB/sec
formatter/numpy/globals.py                 1.03    176.0Â±0.55Âµs    16.8 MB/sec    1.00    170.4Â±1.99Âµs    17.3 MB/sec
formatter/pydantic/types.py                1.03      3.6Â±0.05ms     7.1 MB/sec    1.00      3.5Â±0.02ms     7.3 MB/sec
linter/all-rules/large/dataset.py          1.00     10.5Â±0.02ms     3.9 MB/sec    1.01     10.6Â±0.03ms     3.8 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      2.9Â±0.01ms     5.8 MB/sec    1.00      2.9Â±0.01ms     5.8 MB/sec
linter/all-rules/numpy/globals.py          1.01    319.0Â±2.29Âµs     9.3 MB/sec    1.00    316.8Â±1.66Âµs     9.3 MB/sec
linter/all-rules/pydantic/types.py         1.12      5.5Â±0.09ms     4.7 MB/sec    1.00      4.9Â±0.03ms     5.2 MB/sec
linter/default-rules/large/dataset.py      1.01      5.5Â±0.02ms     7.4 MB/sec    1.00      5.5Â±0.02ms     7.5 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.02   1153.3Â±5.46Âµs    14.4 MB/sec    1.00   1127.2Â±5.47Âµs    14.8 MB/sec
linter/default-rules/numpy/globals.py      1.02    117.3Â±2.69Âµs    25.2 MB/sec    1.00    114.6Â±0.30Âµs    25.7 MB/sec
linter/default-rules/pydantic/types.py     1.02      2.5Â±0.01ms    10.3 MB/sec    1.00      2.4Â±0.02ms    10.5 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.03     10.0Â±0.12ms     4.1 MB/sec    1.00      9.8Â±0.03ms     4.2 MB/sec
formatter/numpy/ctypeslib.py               1.06  1963.6Â±38.15Âµs     8.5 MB/sec    1.00  1860.4Â±15.01Âµs     9.0 MB/sec
formatter/numpy/globals.py                 1.02    197.5Â±1.86Âµs    14.9 MB/sec    1.00    194.0Â±3.57Âµs    15.2 MB/sec
formatter/pydantic/types.py                1.04      4.3Â±0.08ms     5.9 MB/sec    1.00      4.2Â±0.04ms     6.1 MB/sec
linter/all-rules/large/dataset.py          1.02     13.2Â±0.22ms     3.1 MB/sec    1.00     12.9Â±0.18ms     3.1 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.6Â±0.03ms     4.6 MB/sec    1.00      3.6Â±0.03ms     4.6 MB/sec
linter/all-rules/numpy/globals.py          1.02    374.9Â±7.97Âµs     7.9 MB/sec    1.00    367.6Â±5.51Âµs     8.0 MB/sec
linter/all-rules/pydantic/types.py         1.13      6.9Â±0.05ms     3.7 MB/sec    1.00      6.1Â±0.05ms     4.2 MB/sec
linter/default-rules/large/dataset.py      1.01      7.0Â±0.18ms     5.8 MB/sec    1.00      6.9Â±0.12ms     5.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.02  1404.7Â±26.09Âµs    11.9 MB/sec    1.00  1371.8Â±18.16Âµs    12.1 MB/sec
linter/default-rules/numpy/globals.py      1.03    143.6Â±1.47Âµs    20.5 MB/sec    1.00    138.8Â±1.01Âµs    21.3 MB/sec
linter/default-rules/pydantic/types.py     1.02      3.1Â±0.01ms     8.3 MB/sec    1.00      3.0Â±0.02ms     8.5 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/parentheses.rs</code>:190 on 2023-08-08 07:06</div>
            <div class="timeline-body"><p>I would expect that content with <code>ungroup = true</code> never gets grouped. Meaning, we should only use <code>fits_expanded(&amp;group(&amp;inner))</code> is false.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_function_def.rs</code>:60 on 2023-08-08 07:08</div>
            <div class="timeline-body"><p>Is it necessary for the type params to be part of the group too? If so, can you add tests that show how the expansion for a function with type params, parameters, and return type looks like</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/parentheses.rs</code>:159 on 2023-08-08 07:16</div>
            <div class="timeline-body"><p>We can unify these two branches. <code>dangling_open_parenthesis_comments</code> renders nothing if <code>comments</code> is empty.</p>
<p>I'm leaning towards inlining these five lines in <code>parameters.rs</code> rather than changing the grouping here.</p>
<pre><code>	let mut f = WithNodeLevel::new(NodeLevel::ParenthesizedExpression, f);
    write!(f, [ 
	    	text(self.left),
       	&amp;dangling_open_parenthesis_comments(self.comments),
    		&amp;soft_block_indent(&amp;Arguments::from(&amp;self.content)),
      		text(self.right)
      ]
	)
</code></pre>
<p>We aren't testing through the case of using <code>ungroup</code> inside another parenthesized expression (can never apply to arguments) and this seems to be a one-off problem.</p>
<p>We can introduce a new builder if you're concerned about code-reuse.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/parentheses.rs</code>:383 on 2023-08-08 07:17</div>
            <div class="timeline-body"><p>Nit: <code>without_group</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/other/parameters.rs</code>:251 on 2023-08-08 07:29</div>
            <div class="timeline-body"><p>Is this ungrouping necessary for the empty parenthesized case? I believe the extra group is unnecessary because a trailing comment will always make all parent groups extend. In addition, using a group for empty parenthesized may always be incorrect because we never want the printer to break right after the <code>(</code></p>
<pre><code class="language-python">a = bbbbbbbbbbbbbbbbbbbbb + ()
                                                             ^ max line width

# We don't want
a = bbbbbbbbbbbbbbbbbbbbb + (
)
</code></pre>
<pre><code class="language-rust">
let (end_of_line_comments, own_line_comments) = self.comments.split_at(end_of_line_split);

write!(
	f, 
	[
		text(self.left),
		trailing_comments(end_of_line_comments),
	]
)?;

if !own_line_comments.is_empty() {
	block_indent(&amp;dangling_comments(own_line_comments)).fmt(f)?;
} else if !end_of_line_comments.is_empty() {
	hard_line_break.fmt(f)?;
}
		
text(self.right).fmt(f)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-08 07:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/parentheses.rs</code>:118 on 2023-08-08 10:00</div>
            <div class="timeline-body"><p>nit: <code>no_group</code> instead of <code>ungroup</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-08-08 10:09</div>
            <div class="timeline-body"><p>Looking at the black test cases, i think the following is another one of those where black doesn't add parentheses if it doesn't help with fitting:</p>
<p>black:</p>
<pre><code class="language-black">def foo(
    a: int,
    b: int,
    c: int,
) -&gt; intsdfsafafafdfdsasdfsfsdfasdfafdsafdfdsfasdskdsdsfdsafdsafsdfdasfffsfdsfdsafafhdskfhdsfjdslkfdlfsdkjhsdfjkdshfkljds:
    return 2
</code></pre>
<p>ours:</p>
<pre><code class="language-python">def foo(
    a: int,
    b: int,
    c: int,
) -&gt; (
    intsdfsafafafdfdsasdfsfsdfasdfafdsafdfdsfasdskdsdsfdsafdsafsdfdasfffsfdsfdsafafhdskfhdsfjdslkfdlfsdkjhsdfjkdshfkljds
):
    return 2
</code></pre>
<p>Otherwise black_compatibility@simple_cases__return_annotation_brackets.py.snap looks good</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-08 20:48</div>
            <div class="timeline-body"><p>Okay, this got <em>way</em> simpler thanks for the feedback.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @charliermarsh on 2023-08-08 20:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/other/parameters.rs</code>:258 on 2023-08-09 06:55</div>
            <div class="timeline-body"><pre><code class="language-suggestion">                    dangling_open_parenthesis_comments(parenthesis_dangling),
                    soft_block_indent(&amp;group(&amp;format_inner)),
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-08-09 06:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-09 07:35</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #6410</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6410" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ<ul>
<li><strong>PR #6439</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6439" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6410?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-08-09 12:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-08-09 12:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-08-09 12:14</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 02:52:41 UTC
    </footer>
</body>
</html>
