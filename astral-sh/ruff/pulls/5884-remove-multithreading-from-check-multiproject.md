```yaml
number: 5884
title: Remove multithreading from check multiproject
type: pull_request
state: merged
author: MichaReiser
labels: []
assignees: []
merged: true
base: main
head: remove-task-pool-from-multi-project
created_at: 2023-07-19T14:30:04Z
updated_at: 2023-07-19T16:43:39Z
url: https://github.com/astral-sh/ruff/pull/5884
synced_at: 2026-01-12T15:55:19Z
```

# Remove multithreading from check multiproject

---

_@MichaReiser_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This PR removes the multithreading from the multiproject check because we already use a `par_iter` to iterate over the files. 

This doesn't give us as good parallelism because the discovery of the project files now runs single threaded but it's still pretty good
and it significantly simplies the code (and fixes the misterious stack overflow).

<!-- What's the purpose of the change? What does it do, and why? -->

## Test Plan

[Screencast from 2023-07-19 16-30-42.webm](https://github.com/astral-sh/ruff/assets/1203881/be7b95fb-af85-4dc5-b111-5513271a5958)


The whole check completes in about 90s

![image](https://github.com/astral-sh/ruff/assets/1203881/bf8da147-9f05-41dd-9dec-1e20a769bc76)


<!-- How was it tested? -->


---

_Comment by @MichaReiser on 2023-07-19 14:30_

Current dependencies on/for this PR:
* main
  * **PR #5884** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5884" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/5884?utm_source=stack-comment).

---

_Review requested from @konstin by @MichaReiser on 2023-07-19 14:30_

---

_Review comment by @konstin on `crates/ruff_dev/src/format_dev.rs`:220 on 2023-07-19 14:48_

i wouldn't unwrap those due to some failures in the past, can we collect them into an error? 

---

_Review comment by @konstin on `crates/ruff_dev/src/format_dev.rs`:229 on 2023-07-19 14:49_

```suggestion
    let mut error_file = args.error_file.as_ref().map(|error_file| {
        Ok(BufWriter::new(File::create(error_file).context("Couldn't open error file")?))
    }).transpose()?;
```

---

_Review comment by @konstin on `crates/ruff_dev/src/format_dev.rs`:232 on 2023-07-19 14:50_

```suggestion
        bar.suspend(|| println!("Starting {}", project_path.display()));
```

otherwise it won't print when redirecting to a file (https://docs.rs/indicatif/latest/indicatif/struct.ProgressBar.html#method.println, such a footgun), same below

---

_@konstin reviewed on 2023-07-19 14:51_

---

_Comment by @github-actions[bot] on 2023-07-19 15:06_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01     11.7Â±0.39ms     3.5 MB/sec    1.00     11.5Â±0.27ms     3.5 MB/sec
formatter/numpy/ctypeslib.py               1.04      2.3Â±0.10ms     7.1 MB/sec    1.00      2.3Â±0.08ms     7.4 MB/sec
formatter/numpy/globals.py                 1.01   263.3Â±13.38Âµs    11.2 MB/sec    1.00   261.0Â±11.00Âµs    11.3 MB/sec
formatter/pydantic/types.py                1.00      5.0Â±0.15ms     5.1 MB/sec    1.02      5.0Â±0.13ms     5.1 MB/sec
linter/all-rules/large/dataset.py          1.00     16.2Â±0.65ms     2.5 MB/sec    1.03     16.6Â±0.53ms     2.4 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      4.1Â±0.17ms     4.0 MB/sec    1.00      4.1Â±0.10ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.00   552.5Â±17.14Âµs     5.3 MB/sec    1.00   551.7Â±15.86Âµs     5.3 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.4Â±0.17ms     3.5 MB/sec    1.02      7.5Â±0.22ms     3.4 MB/sec
linter/default-rules/large/dataset.py      1.00      8.3Â±0.20ms     4.9 MB/sec    1.01      8.4Â±0.15ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01  1784.7Â±53.17Âµs     9.3 MB/sec    1.00  1770.4Â±38.28Âµs     9.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    205.8Â±6.35Âµs    14.3 MB/sec    1.00    206.7Â±6.07Âµs    14.3 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.7Â±0.08ms     6.9 MB/sec    1.02      3.8Â±0.15ms     6.8 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     14.1Â±0.65ms     2.9 MB/sec    1.18     16.5Â±0.63ms     2.5 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.8Â±0.17ms     5.9 MB/sec    1.16      3.3Â±0.19ms     5.1 MB/sec
formatter/numpy/globals.py                 1.00   332.7Â±21.30Âµs     8.9 MB/sec    1.08   359.1Â±24.06Âµs     8.2 MB/sec
formatter/pydantic/types.py                1.00      6.3Â±0.35ms     4.1 MB/sec    1.13      7.1Â±0.37ms     3.6 MB/sec
linter/all-rules/large/dataset.py          1.11     22.1Â±0.94ms  1883.5 KB/sec    1.00     19.9Â±0.91ms     2.0 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.06      5.7Â±0.28ms     2.9 MB/sec    1.00      5.4Â±0.45ms     3.1 MB/sec
linter/all-rules/numpy/globals.py          1.00   649.0Â±91.61Âµs     4.5 MB/sec    1.02   664.8Â±41.29Âµs     4.4 MB/sec
linter/all-rules/pydantic/types.py         1.00      9.4Â±0.50ms     2.7 MB/sec    1.08     10.1Â±0.49ms     2.5 MB/sec
linter/default-rules/large/dataset.py      1.02     11.1Â±0.41ms     3.7 MB/sec    1.00     10.8Â±0.39ms     3.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01      2.4Â±0.14ms     7.0 MB/sec    1.00      2.3Â±0.11ms     7.1 MB/sec
linter/default-rules/numpy/globals.py      1.00   264.4Â±14.65Âµs    11.2 MB/sec    1.03   273.0Â±14.80Âµs    10.8 MB/sec
linter/default-rules/pydantic/types.py     1.08      5.3Â±0.36ms     4.8 MB/sec    1.00      4.9Â±0.21ms     5.2 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_@MichaReiser reviewed on 2023-07-19 15:40_

---

_Review comment by @MichaReiser on `crates/ruff_dev/src/format_dev.rs`:232 on 2023-07-19 15:40_

oh man. And I thought it is because it would mess up the bar... I'll change it back

---

_Merged by @MichaReiser on 2023-07-19 16:18_

---

_Closed by @MichaReiser on 2023-07-19 16:18_

---

_Branch deleted on 2023-07-19 16:18_

---
