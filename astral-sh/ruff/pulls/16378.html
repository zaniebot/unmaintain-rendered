<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pylint`] Also reports `case np.nan`/`case math.nan` (`PLW0177`) - astral-sh/ruff #16378</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pylint</code>] Also reports <code>case np.nan</code>/<code>case math.nan</code> (<code>PLW0177</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16378">#16378</a>
        opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a>
        on 2025-02-25 17:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Resolves #16374.</p>
<p><code>PLW0177</code> now also reports the pattern of a case branch if it is an attribute access whose qualified name is that of either <code>np.nan</code> or <code>math.nan</code>.</p>
<p>As the rule is in preview, the changes are not preview-gated.</p>
<h2>Test Plan</h2>
<p><code>cargo nextest run</code> and <code>cargo insta test</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-02-25 18:01</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @ntBre on 2025-02-25 20:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-26 09:04</div>
            <div class="timeline-body"><p>@ntBre could you take a look at this PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2025-02-26 15:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/resources/test/fixtures/pylint/nan_comparison.py</code>:64 on 2025-02-26 15:44</div>
            <div class="timeline-body"><p>No reason, really; I just wanted to make sure I didn't mess up the logic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2025-02-26 15:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/resources/test/fixtures/pylint/nan_comparison.py</code>:66 on 2025-02-26 15:46</div>
            <div class="timeline-body"><p>The existing logic checks for such cases in comparisons (e.g., <code>a == b != c</code>), but not <code>match</code> patterns. <code>case float('nan')</code> does not invoke <code>float</code>, while <code>case npy_nan</code> binds the matched expression to that name.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/resources/test/fixtures/pylint/nan_comparison.py</code>:64 on 2025-02-26 15:54</div>
            <div class="timeline-body"><p>These caused a <code>TypeError</code> when I tried them. Is there a reason to test these specifically?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-02-26 15:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-02-26 15:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/resources/test/fixtures/pylint/nan_comparison.py</code>:66 on 2025-02-26 15:56</div>
            <div class="timeline-body"><p>These were a bit confusing for me because I forgot how <code>match</code> works again. I'm not sure if it's worth a comment saying that the first one doesn't match because it's a <code>MatchClass</code> pattern and the second is just a variable or if most readers will remember that. I'll leave it up to you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-02-26 15:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/ast/analyze/statement.rs</code>:1748 on 2025-02-26 15:57</div>
            <div class="timeline-body"><p>nit: I usually ignore all fields with <code>..</code></p>
<pre><code class="language-suggestion">           cases,
            ..
</code></pre>
<p>With any luck that will allow it to fit on one line too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-02-26 16:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/resources/test/fixtures/pylint/nan_comparison.py</code>:66 on 2025-02-26 16:05</div>
            <div class="timeline-body"><p>Oops, I thought I hit &quot;start review&quot; before I deleted the comment. I realized that I was just confused about <code>match</code> again. Thanks for the clarification!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pylint/rules/nan_comparison.rs</code>:51 on 2025-02-26 16:07</div>
            <div class="timeline-body"><p>I think what you have here is fine, but another possible refactor is to pull out <code>nan_comparison_impl</code> for example, with the signature</p>
<pre><code class="language-rust">fn nan_comparison_impl&lt;'a&gt;(checker: &amp;Checker, comparators: impl Iterator&lt;Item = &amp;'a Expr&gt;) {
</code></pre>
<p>and call it with this chained iterator in <code>nan_comparison</code> and make <code>nan_comparison_match</code> look like this.</p>
<pre><code class="language-rust">pub(crate) fn nan_comparison_match(checker: &amp;Checker, cases: &amp;[ast::MatchCase]) {
    nan_comparison_impl(
        checker,
        cases.iter().filter_map(|case| {
            case.pattern
                .as_match_value()
                .and_then(|pattern| Some(&amp;*pattern.value))
        }),
    );
}
</code></pre>
<p>Here's a patch relative to your branch, but the same approach relative to the original code would probably give a smaller diff.</p>
<details>
<summary>Patch</summary><p>

<pre><code class="language-diff">diff --git a/crates/ruff_linter/src/rules/pylint/rules/nan_comparison.rs b/crates/ruff_linter/src/rules/pylint/rules/nan_comparison.rs
index 991a84bb4..90e443c5d 100644
--- a/crates/ruff_linter/src/rules/pylint/rules/nan_comparison.rs
+++ b/crates/ruff_linter/src/rules/pylint/rules/nan_comparison.rs
@@ -48,7 +48,23 @@ impl Violation for NanComparison {
 
 /// PLW0177
 pub(crate) fn nan_comparison(checker: &amp;Checker, left: &amp;Expr, comparators: &amp;[Expr]) {
-    for expr in std::iter::once(left).chain(comparators) {
+    nan_comparison_impl(checker, std::iter::once(left).chain(comparators));
+}
+
+/// PLW0177
+pub(crate) fn nan_comparison_match(checker: &amp;Checker, cases: &amp;[ast::MatchCase]) {
+    nan_comparison_impl(
+        checker,
+        cases.iter().filter_map(|case| {
+            case.pattern
+                .as_match_value()
+                .and_then(|pattern| Some(&amp;*pattern.value))
+        }),
+    );
+}
+
+fn nan_comparison_impl&lt;'a&gt;(checker: &amp;Checker, comparators: impl Iterator&lt;Item = &amp;'a Expr&gt;) {
+    for expr in comparators {
         if expr.is_call_expr() {
             if is_nan_float(expr, checker.semantic()) {
                 checker.report_diagnostic(Diagnostic::new(
@@ -65,19 +81,6 @@ pub(crate) fn nan_comparison(checker: &amp;Checker, left: &amp;Expr, comparators: &amp;[Expr
     }
 }
 
-/// PLW0177
-pub(crate) fn nan_comparison_match(checker: &amp;Checker, cases: &amp;[ast::MatchCase]) {
-    for case in cases {
-        let ast::Pattern::MatchValue(pattern) = &amp;case.pattern else {
-            continue;
-        };
-
-        if let Some(nan) = Nan::from(&amp;pattern.value, checker.semantic()) {
-            checker.report_diagnostic(Diagnostic::new(NanComparison { nan }, pattern.range));
-        }
-    }
-}
-
 #[derive(Debug, PartialEq, Eq)]
 enum Nan {
     /// `math.isnan`
</code></pre>
</p></details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-02-26 16:09</div>
            <div class="timeline-body"><p>Thanks for your work on this and for the clarification on my <code>match</code> comments! I left a slightly different implementation strategy suggestion for your consideration, but I'm happy with this one too if you are.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2025-02-26 16:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/src/checkers/ast/analyze/statement.rs</code>:1748 on 2025-02-26 16:18</div>
            <div class="timeline-body"><p>I would write that too, but other reviewers (notably Alex) prefer <code>field: _</code> over <code>..</code> since the former would be caught by the compiler if something were to be changed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-02-26 16:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/ast/analyze/statement.rs</code>:1748 on 2025-02-26 16:20</div>
            <div class="timeline-body"><p>Ah okay, fair enough!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-02-26 18:50</div>
            <div class="timeline-body"><p>Nice, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-02-26 18:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-02-26 18:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-26 18:50</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:10:20 UTC
    </footer>
</body>
</html>
