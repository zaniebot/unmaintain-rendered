<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use the system allocator for codspeed benchmarks - astral-sh/ruff #13005</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use the system allocator for codspeed benchmarks</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13005">#13005</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-08-20 08:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">Summary
<p>Our benchmarks have been very flaky recently. The one thing that I noticed is that it is mainly due to changes where jemalloc performs reallocations (or moves entire arenas). This <em>randomness</em> is intentional by jemalloc but is kind of hurtful in &quot;reliable&quot; benchmarks.</p>
<p>I haven&#x27;t found a way to disable the randomness. This PR suggests disabling jemalloc for benchmarks running in codspeed. This has the downside that the codspeed benchmarks are further away from what we run in production. I do think that this is the less worse outcome than us loosing trust in our benchmarks (I&#x27;m currently ignoring them because they&#x27;re just noise).</p>
<p><a href="https://discord.com/channels/1065233827569598464/1211340667809169530/1220074050106167357">Codspeed support thread</a></p>
Test plan
<p>We&#x27;ll have to test on main to see if the benchmark results are more stable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ci</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-20 08:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-08-20 08:26</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/use-system-allocator-for-codspeed">CodSpeed Performance Report</a>
Merging #13005 will <strong>degrade performances by 11.91%</strong>
<p>Comparing <code>use-system-allocator-for-codspeed</code> (e367f53) with <code>main</code> (c65e331)</p>
Summary
<p><code>âš¡ 1</code> improvements
<code>âŒ 10 (ğŸ‘ 10)</code> regressions
<code>âœ… 21</code> untouched benchmarks</p>
Benchmarks breakdown
<p>|     | Benchmark | <code>main</code> | <code>use-system-allocator-for-codspeed</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ğŸ‘ | <code>linter/all-rules[pydantic/types.py]</code> | 8.3 ms | 8.7 ms | -4.1% |
| ğŸ‘ | <code>linter/default-rules[large/dataset.py]</code> | 3.7 ms | 3.9 ms | -5.64% |
| âš¡ | <code>linter/default-rules[numpy/globals.py]</code> | 188.9 Âµs | 171 Âµs | +10.47% |
| ğŸ‘ | <code>linter/default-rules[pydantic/types.py]</code> | 1.8 ms | 1.9 ms | -4.24% |
| ğŸ‘ | <code>linter/all-with-preview-rules[pydantic/types.py]</code> | 9.8 ms | 10.3 ms | -4.79% |
| ğŸ‘ | <code>linter/all-with-preview-rules[unicode/pypinyin.py]</code> | 2.4 ms | 2.5 ms | -4.03% |
| ğŸ‘ | <code>parser[large/dataset.py]</code> | 4.9 ms | 5.6 ms | -11.4% |
| ğŸ‘ | <code>parser[numpy/ctypeslib.py]</code> | 910.7 Âµs | 998.5 Âµs | -8.79% |
| ğŸ‘ | <code>parser[numpy/globals.py]</code> | 101.5 Âµs | 112.7 Âµs | -9.92% |
| ğŸ‘ | <code>parser[pydantic/types.py]</code> | 2 ms | 2.1 ms | -6.31% |
| ğŸ‘ | <code>parser[unicode/pypinyin.py]</code> | 308.9 Âµs | 350.6 Âµs | -11.91% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-08-20 08:34</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>âœ… ecosystem check detected no linter changes.</p>
Linter (preview)
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-20 08:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-21 06:46</div>
            <div class="timeline-body"><p>I&#x27;m going to merge this. We can still revert if it doesn&#x27;t help to make the benchmarks more stable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-21 06:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-21 06:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-08-21 06:46</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:06:13 UTC
    </footer>
</body>
</html>
