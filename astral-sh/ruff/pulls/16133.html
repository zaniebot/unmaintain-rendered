<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refactor symbol lookup APIs to hide re-export implementation details - astral-sh/ruff #16133</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Refactor symbol lookup APIs to hide re-export implementation details</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16133">#16133</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2025-02-13 06:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body">Summary
<p>This PR refactors the symbol lookup APIs to better facilitate the re-export implementation. Specifically,</p>
<ul>
<li>Add <code>module_type_symbol</code> which returns the <code>Symbol</code> that&#x27;s a member of <code>types.ModuleType</code></li>
<li>Rename <code>symbol</code> -&gt; <code>symbol_impl</code>; add <code>symbol</code> which delegates to <code>symbol_impl</code> with <code>RequireExplicitReExport::No</code></li>
<li>Update <code>global_symbol</code> to do <code>symbol_impl</code> -&gt; fall back to <code>module_type_symbol</code> and default to <code>RequireExplicitReExport::No</code></li>
<li>Add <code>imported_symbol</code> to do <code>symbol_impl</code> with <code>RequireExplicitReExport</code> as <code>Yes</code> if the module is in a stub file else <code>No</code></li>
<li>Update <code>known_module_symbol</code> to use <code>imported_symbol</code> with a fallback to <code>module_type_symbol</code></li>
<li>Update <code>ModuleLiteralType::member</code> to use <code>imported_symbol</code> with a custom fallback</li>
</ul>
<p>We could potentially also update <code>symbol_from_declarations</code> and <code>symbol_from_bindings</code> to avoid passing in the <code>RequireExplicitReExport</code> as it would be always <code>No</code> if called directly. We could add <code>symbol_from_declarations_impl</code> and <code>symbol_from_bindings_impl</code>.</p>
<p>Looking at the <code>_impl</code> functions, I think we should move all of these symbol related logic into <code>symbol.rs</code> where <code>Symbol</code> is defined and the <code>_impl</code> could be private while we expose the public APIs at the crate level. This would also make the <code>RequireExplicitReExport</code> an implementation detail and the caller doesn&#x27;t need to worry about it.</p>
<p>Happy to hear others thoughts on this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-02-13 09:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;WIP: Follow-up from re-export implementation&quot; to &quot;Refactor symbol lookup APIs to hide re-export implementation details&quot; by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-02-13 09:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-02-13 13:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-02-13 13:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-02-13 13:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-02-13 13:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-02-13 13:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:295 on 2025-02-13 13:14</div>
            <div class="timeline-body"><p>What&#x27;s the difference to <code>symbol</code>? Oh, is it that <code>symbol</code> infers the symbol as seen in that scope?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-13 13:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-13 13:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:315 on 2025-02-13 13:15</div>
            <div class="timeline-body"><p>In which cases do I need to handle the fallback? Is it always, or is it generally fine not to handle that case when doing a cross-module lookup?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-13 13:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:131 on 2025-02-13 13:16</div>
            <div class="timeline-body"><p>@AlexWaygood had an idea on how we could remove this argument. But maybe that&#x27;s something for its own PR (or something that @AlexWaygood can PR?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-02-13 13:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:295 on 2025-02-13 13:17</div>
            <div class="timeline-body"><p>Yes, <code>symbol</code> is for a specific scope while <code>global_symbol</code> is for the global scope specifically.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-13 13:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:305 on 2025-02-13 13:17</div>
            <div class="timeline-body"><pre><code>/// Infers the public type of an imported symbol as seen by `module`.
</code></pre>
<p>or is the module the module in which the symbol is defined?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-13 13:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:131 on 2025-02-13 13:17</div>
            <div class="timeline-body"><p>Oh, sure. I didn&#x27;t realise we had it here already.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-02-13 13:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:131 on 2025-02-13 13:19</div>
            <div class="timeline-body"><p>I thought of using a <code>bitflags</code> i.e., combining <code>is_dunder_slots</code> and <code>require_explicit_reexport</code> unless Alex&#x27;s plan is to do something different like removing it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-13 13:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:295 on 2025-02-13 13:22</div>
            <div class="timeline-body"><p>I see. It might be worth extending the <code>symbol</code> documentation to mention that it looks up the symbol in a specific scope.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-02-13 13:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:315 on 2025-02-13 13:22</div>
            <div class="timeline-body"><p>Good point. I think it will need to be handled every time. There are two cases here:</p>
<ul>
<li>Doing a cross module symbol lookup which is handled by <code>ModuleLiteralType::member</code> that includes the fallback logic</li>
<li>Doing a lookup in the builtins scope which is handled by <code>known_module_scope</code> which uses the <code>module_type_symbol</code> as the fallback logic</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-13 13:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:131 on 2025-02-13 13:22</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/16138</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:296 on 2025-02-13 21:32</div>
            <div class="timeline-body"><pre><code>/// Infers the public type of a module-global symbol as seen from within the same file.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:295 on 2025-02-13 21:33</div>
            <div class="timeline-body"><p>Given that <code>symbol</code> takes a <code>ScopeId</code> and a symbol name, I&#x27;m not sure how else it could be interpreted? I guess it could say &quot;Infer the public type of a symbol (its type as seen from outside its scope) by scope and symbol name.&quot;? But to me that seems redundant with what&#x27;s already clear from the signature.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:305 on 2025-02-13 21:35</div>
            <div class="timeline-body"><p>It&#x27;s the module in which we are looking up the symbol, not the module doing the lookup.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:317 on 2025-02-13 21:41</div>
            <div class="timeline-body"><p>Since all we need from the module is the file, and most of our APIs revolve around File, not Module, I would be inclined to leave this up to the caller.</p>
<pre><code>pub(crate) fn imported_symbol&lt;&#x27;db&gt;(db: &amp;&#x27;db dyn Db, file: File, name: &amp;str) -&gt; Symbol&lt;&#x27;db&gt; {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:315 on 2025-02-13 21:45</div>
            <div class="timeline-body"><p>I think we could also just have separate <code>builtin_symbol</code> and <code>imported_symbol</code> functions which each incorporate the correct module-symbols fallback for that case. It&#x27;s not like the other logic in this function is extensive. And if we don&#x27;t want to duplicate it, we could rename this function to something like <code>external_symbol_impl</code> (and make it private) and have both <code>builtin_symbol</code> and <code>imported_symbol</code> call it and then apply their respective fallback.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:875 on 2025-02-13 21:52</div>
            <div class="timeline-body"><p>I think maybe we should rename the current <code>symbol_from_declarations</code> and <code>symbol_from_bindings</code> to private functions <code>symbol_from_declarations_impl</code> and <code>symbol_from_bindings_impl</code> and then have public versions that assume <code>RequiresExplicitReExport::No</code>. IMO it would be ideal if <code>RequiresExplicitReExport</code> enum could be a private implementation detail of the lookup functions, and not part of the public lookup API at all. (Also maybe at some point we should move the lookup functions to a submodule so they actually can have implementation details that are private from inference.)</p>
<p>The reasoning is that type inference should only ever infer direct from some set of bindings or declarations when it&#x27;s doing within-file inference. All cross-file stuff should go through APIs like <code>imported_symbol</code> or <code>builtin_symbol</code>; it&#x27;s never correct for a different file to peek into another file&#x27;s individual bindings and declarations. So it doesn&#x27;t make sense to expose from-bindings and from-declarations APIs that let you specify <code>RequiresExplicitReExport</code> (and also it&#x27;s annoying to have to specify it everywhere.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-02-13 21:57</div>
            <div class="timeline-body"><p>Looks great!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-02-14 02:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:317 on 2025-02-14 02:18</div>
            <div class="timeline-body"><p>That&#x27;s fine. My main motivation here was that as it&#x27;s going to be used for a cross-module lookup, the caller should have the <code>Module</code> which could be enforced here but I see that it&#x27;s not going to make a big difference and I think the documentation + function name should be good enough.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-02-14 02:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:875 on 2025-02-14 02:21</div>
            <div class="timeline-body"><p>Yes, this is basically my plan as a follow-up (mentioned in the PR description) by moving it all in <code>symbol.rs</code>. I don&#x27;t think it&#x27;ll be &quot;private&quot; by staying in <code>types.rs</code> as it already contains a public usage of it. Apologies if it wasn&#x27;t obvious.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-02-14 02:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:295 on 2025-02-14 02:23</div>
            <div class="timeline-body"><p>I&#x27;ve added a &quot;... in the given <code>scope</code>.&quot; to be more explicit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-02-14 02:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:315 on 2025-02-14 02:27</div>
            <div class="timeline-body"><p>I think then I&#x27;ll update the existing <code>builtins_symbol</code> to reflect that, I was a bit hesitant on doing that but I think it should be fine. Any builtins that&#x27;s imported directly from the <code>builtins</code> module should go through the <code>ModuleLiteralType::member</code> method while the lookup in the builtins scope should go through <code>builtins_symbol</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-02-14 02:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:317 on 2025-02-14 02:51</div>
            <div class="timeline-body"><p>Oh that&#x27;s a solid rationale that I hadn&#x27;t thought about! No strong feelings either way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-02-14 02:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:875 on 2025-02-14 02:55</div>
            <div class="timeline-body"><p>Oops sorry totally missed that in the PR description! Great that we are independently thinking along the same lines :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-02-14 09:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:875 on 2025-02-14 09:35</div>
            <div class="timeline-body"><p>#16152</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-02-14 09:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-02-14 09:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-14 09:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-14 13:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:281 on 2025-02-14 13:35</div>
            <div class="timeline-body"><p>Sorry for the post-merge review. I think it might be good to add some more doc-comments to this function, because it&#x27;s a bit weird as a standalone routine. In general we wouldn&#x27;t check to see whether a symbol exists on a class before doing the <code>.member()</code> call on the instance type -- we&#x27;d just do the <code>.member()</code> call on the instance type, since it has the same end result. The reason for doing the funny dance here to only call <code>KnownClass::ModuleType.to_instance(db).member(db, name)</code> when absolutely necessary is that it was a fairly significant performance regression to fallback to doing that for every name lookup that wasn&#x27;t found in the module&#x27;s globals. So we use less idiomatic (and much more verbose) code here as a micro-optimisation because it&#x27;s used in a very hot path.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-16 17:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:349 on 2025-02-16 17:46</div>
            <div class="timeline-body"><p>Again, sorry for the delayed review... I&#x27;m a bit confused by the changes here. Why is the builtins namespace being handled so differently to all other module namespaces? Yes, it&#x27;s true that <code>__name__</code>, <code>__doc__</code> and other attributes found on <code>types.ModuleType</code> are present in the builtins namespace:</p>
<pre><code>&gt;&gt;&gt; import builtins
&gt;&gt;&gt; builtins_dict = builtins.__dict__
&gt;&gt;&gt; builtins_dict[&#x27;__name__&#x27;]
&#x27;builtins&#x27;
&gt;&gt;&gt; builtins_dict[&#x27;__doc__&#x27;]
&quot;Built-in functions, types, exceptions, and other objects.\n\nThis module provides direct access to all &#x27;built-in&#x27;\nidentifiers of Python; for example, builtins.len is\nthe full name for the built-in function len().\n\nThis module is not normally accessed explicitly by most\napplications, but can be useful in modules that provide\nobjects with the same name as a built-in value, but in\nwhich the built-in of that name is also needed.&quot;
</code></pre>
<p>but that&#x27;s also true for any other module:</p>
<pre><code>&gt;&gt;&gt; import typing
&gt;&gt;&gt; typing_dict = typing.__dict__
&gt;&gt;&gt; typing_dict[&#x27;__name__&#x27;]
&#x27;typing&#x27;
&gt;&gt;&gt; typing_dict[&#x27;__doc__&#x27;]
&#x27;\nThe typing module: Support for gradual typing as defined by PEP 484 and subsequent PEPs.\n\nAmong other things, the module includes the following:\n* Generic, Protocol, and internal machinery to support generic aliases.\n  All subscripted types like X[int], Union[int, str] are generic aliases.\n* Various &quot;special forms&quot; that have unique meanings in type annotations:\n  NoReturn, Never, ClassVar, Self, Concatenate, Unpack, and others.\n* Classes whose instances can be type arguments to generic classes and functions:\n  TypeVar, ParamSpec, TypeVarTuple.\n* Public helper functions: get_type_hints, overload, cast, final, and others.\n* Several protocols to support duck-typing:\n  SupportsFloat, SupportsIndex, SupportsAbs, and others.\n* Special types: NewType, NamedTuple, TypedDict.\n* Deprecated aliases for builtin types and collections.abc ABCs.\n\nAny name not present in __all__ is an implementation detail\nthat may be changed without notice. Use at your own risk!\n&#x27;
</code></pre>
<p>Why are we adding special handling to <code>builtins</code> specifically so that <code>builtins_symbol(db, &quot;__doc__&quot;)</code> returns a bound symbol, but not to all of the functions in <code>stdlib.rs</code>? <code>__doc__</code> is also present in the global namespace of <code>typing</code>, <code>typing_extensions</code>, or any other core module, and it&#x27;s a different object to <code>builtins.__doc__</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-02-17 10:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:349 on 2025-02-17 10:33</div>
            <div class="timeline-body"><p>That&#x27;s a good point.</p>
<p>So, while looking into the way builtins should be handled, I saw the other functions in <code>stdlib.rs</code> as well. The main reason for special handling builtins is related to <a href="https://github.com/astral-sh/ruff/issues/15476">astral-sh/ruff#15476</a> where we need to treat the builtins namespace as different to explicitly importing symbols from the <code>builtins</code> module.</p>
<ul>
<li>When considering a symbol from a builtins namespace (via the fallback logic of name lookup), the lookup should go through the external symbol query which will make sure that explicit re-exports are required.</li>
<li>While, when considering a symbol from the builtins module (via explicit import statement), the lookup should follow the normal module lookup logic that&#x27;s implemented via <code>imported_symbol</code></li>
</ul>
<p>The <code>known_module_symbol</code> is just a wrapper around <code>imported_symbol</code> lookup for the known modules i.e., they&#x27;re not available in the current namespace but requires an external lookup. This change just makes that explicit such that <code>typing_symbol</code> and <code>typing_extensions_symbol</code> lookup happens as if the symbols were imported via <code>from typing import ...</code> and <code>from typing_extensions import ...</code> respectively. There&#x27;s additional context in this thread: <a href="https://github.com/astral-sh/ruff/pull/16073">astral-sh/ruff#16073</a>#discussion_r1953810891</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-02-17 10:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:281 on 2025-02-17 10:43</div>
            <div class="timeline-body"><p>Added in <a href="https://github.com/astral-sh/ruff/pull/16152/commits/89cefbec07e39df143e2cbdc22cf5a5a7266cca3"><code>89cefbe</code> (#16152)</a></p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:11:25 UTC
    </footer>
</body>
</html>
