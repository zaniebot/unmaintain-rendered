<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Remove `Clone` from `Files` - astral-sh/ruff #11213</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Remove <code>Clone</code> from <code>Files</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11213">#11213</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-04-30 14:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR removes the <code>Clone</code> implementation on <code>Files</code> and replaces it with a <code>snapshot</code> function similar to <code>Database</code>.</p>
<p>The main motivation for this change is that I think it's important that we prevent that <code>Files</code> (or any other <code>Database</code> state) can change while we're creating a persistent cache, because that could potentially lead to partial caches.</p>
<p>What I have in mind is that we enforce a <code>&amp;mut</code> reference when creating the cache (maybe not for the entire period, e.g. maybe only for creating the cacheable data structure, but we release the <code>&amp;mut</code> before serializing the data structure to disk).
Taking a <code>&amp;mut</code> guarantees us that there's no other system (e.g. a file watcher) quietly mutating <code>Files</code> while we try to persist its state to disk.</p>
<p>The guarantee is not as strong as in the <code>Database</code> case where the <code>Snapshot</code> type prohibits access to the wrapped <code>Database</code> because we need a <code>Files</code> instance to create a snapshoted <code>Program</code>. I hope that the fact that
the type doesn't implement <code>Clone</code> and a, in the future, usage of <code>Arc::make_mut().unwrap</code> should be protection enough ;)</p>
<h2>Test Plan</h2>
<p><code>cargo test</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2024-04-30 14:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MichaReiser on 2024-04-30 14:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-04-30 14:31</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/src/db.rs</code>:60 on 2024-05-01 00:57</div>
            <div class="timeline-body"><p>Why is this needed?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/src/program/mod.rs</code>:201 on 2024-05-01 01:02</div>
            <div class="timeline-body"><p>Seems like a lot to dump all the file changes stuff straight into program/mod.rs. Submodule maybe?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-05-01 01:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-05-01 07:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/db.rs</code>:60 on 2024-05-01 07:10</div>
            <div class="timeline-body"><p>Clippy's <a href="https://rust-lang.github.io/rust-clippy/master/index.html#/must_use_candidate"><code>must_use</code></a> rule was yelling at me ;) but I think it's actually right.</p>
<p>You can mark struct/enums and methods as <code>must_use</code>. The compiler will then emit a warning if you call a function that returns a <em>must use</em> object that you aren't handling. You've probably seen these warnings before when calling a function that returns a <code>Result</code> that you aren't handling. The compiler generates these warnings because <code>Result</code> is marked as <code>must_use</code>.</p>
<p>I mark the <code>snapshot</code> function here as <code>must_use</code> because calling the function is useless if you aren't using the result. That means, it's most likely an error and you wanted to assign the result to a variable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-05-01 07:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/program/mod.rs</code>:201 on 2024-05-01 07:11</div>
            <div class="timeline-body"><p>Yeah, I don't know how to structure this yet. Maybe I think the file is still reasonably small (Rust has different standards when it comes to large files compared to JS/python ;)).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2024-05-01 07:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-05-01 07:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-05-01 07:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-05-01 15:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/src/db.rs</code>:60 on 2024-05-01 15:00</div>
            <div class="timeline-body"><p>Ah, ok, that makes perfect sense. I understand what <code>#[must_use]</code> does, I was just trying to figure out if there was some correctness or safety invariant that would be violated by failure to use the return value of this. But even if not it makes sense that it would likely be a bug not to use it, and it's nice to flag that likely bug.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:04:06 UTC
    </footer>
</body>
</html>
