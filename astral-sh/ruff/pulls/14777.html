<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Unify `setup_db()` functions, add `TestDb` builder - astral-sh/ruff #14777</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Unify <code>setup_db()</code> functions, add <code>TestDb</code> builder</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14777">#14777</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2024-12-04 20:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<ul>
<li>Instead of seven (more or less similar) <code>setup_db</code> functions, use just one in a single central place.</li>
<li>For every test that needs customization beyond that, offer a <code>TestDbBuilder</code> that can control the Python target version, custom typeshed, and pre-existing files.</li>
</ul>
<p>The main motivation for this is that we're soon going to need customization of the Python version, and I didn't feel like adding this to each of the existing <code>setup_db</code> functions.</p>
<p>It feels like there is much more we can do, especially around writing files, but let's first see if everyone is happy with this first step.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @sharkdp on 2024-12-04 20:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2024-12-04 20:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @sharkdp on 2024-12-04 20:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2024-12-04 20:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-12-04 20:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:3822 on 2024-12-04 20:07</div>
            <div class="timeline-body"><p>This is the only functional change, without any consequences. But it feels okay, since <code>typing.NoDefault</code> is only available since 3.13). I will need this — and similar things — soon in the statically-know branch, so I'm putting it into place already.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-12-04 20:11</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:3822 on 2024-12-04 20:13</div>
            <div class="timeline-body"><p>I think once we have the statically-known branch, we will probably want to add more tests around some of these &quot;exists in <code>typing</code> in recent versions and in <code>typing_extensions</code> as fallback&quot; known symbols, in terms of how they behave on older and newer Pythons. But this change seems fine for this PR and this particular test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:3819 on 2024-12-04 20:15</div>
            <div class="timeline-body"><p>@AlexWaygood previously expressed a preference for using <code>unwrap()</code> in tests, rather than having tests return a <code>Result</code> and then using <code>?</code> in the test. We have some existing tests using both styles. I don't have strong feelings, but I think I shared Alex's preference after writing tests in both styles; the need to end the test with <code>Ok(())</code> is irritating.</p>
<p>Do you have a preference in the other direction?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-12-04 20:17</div>
            <div class="timeline-body"><p>Thank you! Much nicer. This always bugged me slightly but never enough to fix it :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-12-04 20:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:3819 on 2024-12-04 20:23</div>
            <div class="timeline-body"><blockquote>
<p>Do you have a preference in the other direction?</p>
</blockquote>
<p>I do not. I usually also use <code>.unwrap()</code> liberally in tests. Sometimes the code looks a lot nicer if there are <em>many</em> <code>.unwrap()</code>s that can be replaced with <code>?</code>, so I guess it's okay to not have a strict guideline(?).</p>
<p>For <code>TestDbBuilder</code> specifically, I first wrote a version that didn't return a <code>Result</code>. I then changed it because I thought there might be more complex test setups in the future where it would be useful for the developer to see a good error message if they did something wrong in the setup of the test.</p>
<p>And note that <code>setup_db()</code> still returns a plain <code>TestDb</code>, not a <code>Result</code>. It's just the builder that returns a <code>Result</code>.</p>
<p>For the particular example here... nothing can go wrong when just setting the Python version, so I'll change this back to <code>.unwrap()</code> style.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2024-12-04 20:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2024-12-04 20:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-12-04 20:36</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:08:15 UTC
    </footer>
</body>
</html>
