<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refactor `Fix` and `Edit` API - astral-sh/ruff #4198</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Refactor <code>Fix</code> and <code>Edit</code> API</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4198">#4198</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2023-05-03 01:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>Part of <a href="https://github.com/charliermarsh/ruff/issues/4181">charliermarsh/ruff#4181</a>
Closes <a href="https://github.com/charliermarsh/ruff/issues/4182">charliermarsh/ruff#4182</a></p>
<p>Thanks for the well specified issue! This implements many of the noted changes (see commit messages). There are a couple of deviations:</p>
<ul>
<li>Removes <code>Fix::empty</code></li>
<li>Updates <code>Message::fix</code> to be <code>Option&lt;Fix&gt;</code></li>
<li>Updates <code>MessageHeader::fix</code> to be <code>Option&lt;Fix&gt;</code></li>
<li>Does not remove <code>From&lt;Edit&gt; for Fix</code> (see <a href="https://github.com/charliermarsh/ruff/pull/4198#issuecomment-1537473767">discussion</a>)</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-05-03 01:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/src/autofix/mod.rs</code>:46 on 2023-05-03 01:44</div>
            <div class="timeline-body"><p>I&#x27;m guessing there&#x27;s a more idiomatic way to handle this now that <code>diagnostic.fix</code> is an <code>Option</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-05-03 01:46</div>
            <div class="timeline-body"><p>The removal of <code>From&lt;Edit&gt; for Fix</code> is pretty heavy. It looks like many rule functions passed to <code>try_set_fix</code> return <code>Edit</code> types. Is the intention to replace the return value of all of those functions with <code>Fix::unspecified</code>? e.g. https://github.com/charliermarsh/ruff/blob/cab65b25da8aff6fb9cb539b55345aae64a835f0/crates/ruff/src/rules/pyflakes/fixes.rs#L198</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-05-03 02:09</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>âœ… ecosystem check detected no changes.</p>
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.01     16.9Â±0.20ms     2.4 MB/sec    1.00     16.8Â±0.17ms     2.4 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      4.0Â±0.01ms     4.1 MB/sec    1.00      4.0Â±0.04ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.00    500.1Â±1.40Âµs     5.9 MB/sec    1.01    505.6Â±6.62Âµs     5.8 MB/sec
linter/all-rules/pydantic/types.py         1.01      7.1Â±0.04ms     3.6 MB/sec    1.00      7.0Â±0.04ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.00      8.4Â±0.05ms     4.9 MB/sec    1.00      8.4Â±0.06ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1792.1Â±6.07Âµs     9.3 MB/sec    1.01   1802.9Â±6.57Âµs     9.2 MB/sec
linter/default-rules/numpy/globals.py      1.00    196.0Â±0.65Âµs    15.1 MB/sec    1.01    198.6Â±2.94Âµs    14.9 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.7Â±0.02ms     6.9 MB/sec    1.00      3.7Â±0.05ms     6.9 MB/sec
parser/large/dataset.py                    1.00      6.6Â±0.01ms     6.2 MB/sec    1.12      7.4Â±0.11ms     5.5 MB/sec
parser/numpy/ctypeslib.py                  1.00   1294.1Â±6.65Âµs    12.9 MB/sec    1.08  1396.5Â±21.32Âµs    11.9 MB/sec
parser/numpy/globals.py                    1.00   134.5Â±19.64Âµs    21.9 MB/sec    1.03    138.6Â±2.55Âµs    21.3 MB/sec
parser/pydantic/types.py                   1.00      2.8Â±0.00ms     9.0 MB/sec    1.09      3.1Â±0.05ms     8.3 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.03     17.6Â±0.20ms     2.3 MB/sec    1.00     17.1Â±0.21ms     2.4 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.03      4.4Â±0.08ms     3.8 MB/sec    1.00      4.3Â±0.11ms     3.9 MB/sec
linter/all-rules/numpy/globals.py          1.04   505.8Â±13.93Âµs     5.8 MB/sec    1.00    486.6Â±6.53Âµs     6.1 MB/sec
linter/all-rules/pydantic/types.py         1.02      7.4Â±0.14ms     3.4 MB/sec    1.00      7.2Â±0.16ms     3.5 MB/sec
linter/default-rules/large/dataset.py      1.01      8.7Â±0.12ms     4.7 MB/sec    1.00      8.7Â±0.12ms     4.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1817.6Â±38.49Âµs     9.2 MB/sec    1.00  1815.4Â±21.20Âµs     9.2 MB/sec
linter/default-rules/numpy/globals.py      1.00    195.3Â±3.36Âµs    15.1 MB/sec    1.02    199.9Â±8.55Âµs    14.8 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.8Â±0.05ms     6.7 MB/sec    1.01      3.8Â±0.05ms     6.6 MB/sec
parser/large/dataset.py                    1.01      6.8Â±0.08ms     6.0 MB/sec    1.00      6.8Â±0.07ms     6.0 MB/sec
parser/numpy/ctypeslib.py                  1.02  1305.7Â±18.54Âµs    12.8 MB/sec    1.00  1276.6Â±28.38Âµs    13.0 MB/sec
parser/numpy/globals.py                    1.03    133.4Â±2.82Âµs    22.1 MB/sec    1.00    129.2Â±2.78Âµs    22.8 MB/sec
parser/pydantic/types.py                   1.02      2.9Â±0.03ms     8.8 MB/sec    1.00      2.8Â±0.04ms     9.0 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/autofix/mod.rs</code>:46 on 2023-05-03 07:06</div>
            <div class="timeline-body"><p>You can write <code>diagnostic.fix().map(|fix| (diagnostic.kind.rule(), fix))</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-05-03 07:07</div>
            <div class="timeline-body"><blockquote>
<p>The removal of <code>From&lt;Edit&gt; for Fix</code> is pretty heavy. It looks like many rule functions passed to <code>try_set_fix</code> return <code>Edit</code> types. Is the intention to replace the return value of all of those functions with <code>Fix::unspecified</code>? e.g.</p>
<p>https://github.com/charliermarsh/ruff/blob/cab65b25da8aff6fb9cb539b55345aae64a835f0/crates/ruff/src/rules/pyflakes/fixes.rs#L198</p>
</blockquote>
<p>Yeah, this is unfortunate but necessary because we&#x27;ll need to explicitly pass the <code>Applicability</code> in the future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-03 07:08</div>
            <div class="timeline-body"><p>Thank you for working on this refactor</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/src/autofix/mod.rs</code>:46 on 2023-05-03 14:29</div>
            <div class="timeline-body"><p>Wonderful thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-05-03 14:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-05-03 14:30</div>
            <div class="timeline-body"><blockquote>
<p>Yeah, this is unfortunate but necessary because we&#x27;ll need to explicitly pass the Applicability in the future.</p>
</blockquote>
<p>Makes sense, just wanted to check before I really went down the rabbit hole on that one â€” I&#x27;ll make those changes next and mark this as ready for review when it&#x27;s done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-05-04 00:12</div>
            <div class="timeline-body"><p>@MichaReiser I&#x27;ve encountered a bit of a problem and since the work is rather repetitive I&#x27;d like to check in again :)</p>
<p>In many cases, we can just replace <code>Result&lt;Edit&gt;</code> with <code>Result&lt;Fix&gt;</code> but there are generic functions like <code>delete_stmt</code> that return <code>Result&lt;Edit&gt;</code> and should probably continue to do so. Since they&#x27;re used from many rules, I think it does not make sense for it to decide on the applicability of the proposed edits.
https://github.com/charliermarsh/ruff/blob/561f610b0543c28d46916c5760012c342aa8b08f/crates/ruff/src/autofix/actions.rs#LL169C1-L169C1</p>
<p>However there are some cases where this is used in <code>Diagnostic::try_set_fix</code>
https://github.com/charliermarsh/ruff/blob/e3bac78ea70667358a87ee090e2734bd9bb87dcb/crates/ruff/src/rules/flake8_pie/rules.rs#L143-L152</p>
<p>In this use, there&#x27;s not a clear way to provide the specificity without requiring an <code>Applicability</code> to be passed to <code>try_set_fix</code> or introducing new factory methods like <code>Fix::try_unspecified</code> or <code>Diagnostics::try_set_unspecified_fix</code>.</p>
<p>Suggestions?</p>
<p>Overall, this requires some careful editing as there are additional cases where a function is reused and probably should not decide the applicability level. My hopes of replacing these with regular expressions have gone down the drain ğŸ˜ Maybe it&#x27;d be easier to leave <code>From&lt;Edit&gt; for Fix</code> in place for now and update each call site individually?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-05-04 15:50</div>
            <div class="timeline-body"><blockquote>
<p>@MichaReiser I&#x27;ve encountered a bit of a problem and since the work is rather repetitive I&#x27;d like to check in again :)</p>
</blockquote>
<p>I would have been surprised if my proposal just worked :laughing:. Thanks for doing this work so carefully.</p>
<blockquote>
<p>In many cases, we can just replace <code>Result&lt;Edit&gt;</code> with <code>Result&lt;Fix&gt;</code> but there are generic functions like <code>delete_stmt</code> that return <code>Result&lt;Edit&gt;</code> and should probably continue to do so. Since they&#x27;re used from many rules, I think it does not make sense for it to decide on the applicability of the proposed edits. <a href="https://github.com/charliermarsh/ruff/blob/561f610b0543c28d46916c5760012c342aa8b08f/crates/ruff/src/autofix/actions.rs#LL169C1-L169C1"><code>561f610</code>/crates/ruff/src/autofix/actions.rs#LL169C1-L169C1</a></p>
</blockquote>
<p>I agree, that this should be decided by the caller rather than by <code>delete_stmt</code>.</p>
<blockquote>
<p>However there are some cases where this is used in <code>Diagnostic::try_set_fix</code></p>
<p>https://github.com/charliermarsh/ruff/blob/e3bac78ea70667358a87ee090e2734bd9bb87dcb/crates/ruff/src/rules/flake8_pie/rules.rs#L143-L152</p>
<p>In this use, there&#x27;s not a clear way to provide the specificity without requiring an <code>Applicability</code> to be passed to <code>try_set_fix</code> or introducing new factory methods like <code>Fix::try_unspecified</code> or <code>Diagnostics::try_set_unspecified_fix</code>.</p>
</blockquote>
<p>In this case, I would create the <code>Fix</code> inside of the callback by using the <code>try</code> operator. It&#x27;s a bit more verbose but avoids the need for new factory methods.</p>
<pre><code> diagnostic.try_set_fix(|| { 
	Ok(Fix::unspecified(
		delete_stmt( 
	         pass_stmt, 
	         None, 
	         &amp;[], 
	         checker.locator, 
	         checker.indexer, 
	         checker.stylist, 
	     )?
	))
 }); 
</code></pre>
<blockquote>
<p>Suggestions?</p>
<p>Overall, this requires some careful editing as there are additional cases where a function is reused and probably should not decide the applicability level.</p>
</blockquote>
<p>I think it&#x27;s fine if we get some of them wrong because we have to re-visit all of them anyway when deciding on the fixe&#x27;s safety. We can use this opportunity to decide whether the function should defer the determination of the fixe&#x27;s safety to the caller or even change the signature to return an <code>Edit</code>.</p>
<p>The main motivation behind changing all of them to <code>unspecified</code> is that we can then use the IDE to find all places that still need to be changed.</p>
<blockquote>
<p>My hopes of replacing these with regular expressions have gone down the drain grin Maybe it&#x27;d be easier to leave <code>From&lt;Edit&gt; for Fix</code> in place for now and update each call site individually?</p>
</blockquote>
<p>That&#x27;s&#x27; also be a valid approach that I haven&#x27;t thought of. Determining the &quot;fixes to migrate&quot; workflow could then be:</p>
<ul>
<li>comment out the <code>From</code> implementation</li>
<li>fix all build errors of a single rule,</li>
<li>uncomment the <code>From</code> implementation except if there are no build errors, then remove the <code>From</code> implementation.</li>
<li>Submit PR</li>
</ul>
<p>I&#x27;ll let you decide. You know the extent of the work best.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-05-04 16:20</div>
            <div class="timeline-body"><p>Of course you can just use a closure :) my lack of experience with Rust is showing. I think that&#x27;s a reasonable approach if you think it&#x27;s maintainable. I&#x27;ll forge onward but if the changes feel hard to review I&#x27;ll consider the &quot;separate changes&quot; workflow some more.</p>
<p>Thanks for the guidance again!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-05-04 19:39</div>
            <div class="timeline-body"><p>@MichaReiser I am leaning towards separate pull requests for individual rules. Otherwise this is going to take a while longer. It&#x27;ll be harder to review and I&#x27;ll need to keep rebasing as old patterns are used on <code>main</code>. I also wouldn&#x27;t be upset if you wanted to take a look â€” familiarity with the codebase would probably make doing it all at once significantly easier.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_cli/src/cache.rs</code>:236 on 2023-05-05 06:24</div>
            <div class="timeline-body"><p><code>MessageHeader</code> is a helper struct to deserialize a <code>Message</code>. Its fields must match the fields on <code>Message</code> or the deserialization will fail if we have a <code>Message</code> without a fix.</p>
<p>That&#x27;s why we should change the <code>fix</code> definition on <code>MessageHeader</code> to <code>Option&lt;Fix&gt;</code> to match <code>Message</code></p>
<pre><code>#[derive(Deserialize)]
struct MessageHeader {
    kind: DiagnosticKind,
    range: TextRange,
    fix: Option&lt;Fix&gt;,
    file_id: usize,
    noqa_row: TextSize,
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-05 06:27</div>
            <div class="timeline-body"><blockquote>
<p>@MichaReiser I am leaning towards separate pull requests for individual rules. Otherwise this is going to take a while longer. It&#x27;ll be harder to review and I&#x27;ll need to keep rebasing as old patterns are used on <code>main</code>. I also wouldn&#x27;t be upset if you wanted to take a look â€” familiarity with the codebase would probably make doing it all at once significantly easier.</p>
</blockquote>
<p>Sounds good to me. We can merge the PR as is and do a couple of follow-up PRs where we migrate a bunch of <code>.set_fix</code> calls to use <code>Fix::unspecified</code>. That also gives us the option for multiple collaborators to contribute to the refactor, so that you don&#x27;t have to do all by yourself.</p>
<p>Thank you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_cli/src/cache.rs</code>:236 on 2023-05-07 15:41</div>
            <div class="timeline-body"><p>Done in <a href="https://github.com/charliermarsh/ruff/pull/4198">charliermarsh/ruff#4198</a>/commits/310fa94f2c36b6d46d059f8168265085262ce29e â€” do you normally add tests for things like this to ensure it stays up to date?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-05-07 15:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/zanieb">@zanieb</a> on 2023-05-07 15:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-05-07 15:45</div>
            <div class="timeline-body"><p>Following merge, we can add a comment to #4181 and/or <a href="https://github.com/charliermarsh/ruff/issues/4184">charliermarsh/ruff#4184</a> covering the workflow for incremental removal of <code>From&lt;Edit&gt; for Fix</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-08 09:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_cli/src/cache.rs</code>:236 on 2023-05-08 09:56</div>
            <div class="timeline-body"><p>Thx. We probably should but don&#x27;t have to as part of this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-05-08 09:56</div>
            <div class="timeline-body"><p>Thank you, this is awesome.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-05-08 09:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-05-08 09:57</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:53:29 UTC
    </footer>
</body>
</html>
