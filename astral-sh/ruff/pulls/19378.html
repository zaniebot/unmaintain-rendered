<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pyupgrade`] Fix `UP030` to avoid modifying double curly braces in format strings - astral-sh/ruff #19378</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pyupgrade</code>] Fix <code>UP030</code> to avoid modifying double curly braces in format strings</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19378">#19378</a>
        opened by <a href="https://github.com/danparizher">@danparizher</a>
        on 2025-07-15 21:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danparizher">@danparizher</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes #19348</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-15 21:39</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @MichaReiser on 2025-07-18 13:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @ntBre on 2025-07-24 13:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/format_literals.rs</code>:136 on 2025-07-28 18:26</div>
            <div class="timeline-body"><p>At the risk of going too wild with regular expressions, I think we can just handle this directly in <code>FORMAT_SPECIFIER</code>:</p>
<pre><code class="language-rust">static FORMAT_SPECIFIER: LazyLock&lt;Regex&gt; = LazyLock::new(|| {
    Regex::new(
        r&quot;(?x)
            (?P&lt;prefix&gt;
                ^|[^{]|(?:\{{2})+  # preceded by nothing, a non-brace, or an even number of braces
            )
            \{                     # opening curly brace
                (?P&lt;int&gt;\d+)       # followed by any integer
                (?P&lt;fmt&gt;.*?)       # followed by any text
            }                      # followed by a closing brace
        &quot;,
    )
    .unwrap()
});
</code></pre>
<p>While I was here, I went ahead and set verbose mode on the regex (initial <code>(?x)</code>) and moved the comments on <code>FORMAT_SPECIFIER</code> into the regex itself.</p>
<p>With this change, we also have to pass along the <code>$prefix</code> in the calls below. For example:</p>
<pre><code class="language-rust">                        string.value = arena.alloc(
                            FORMAT_SPECIFIER
                                .replace_all(string.value, &quot;$prefix{$fmt}&quot;)
                                .to_string(),
                        );
</code></pre>
<p>I almost neglected the &quot;even number of braces&quot; check, but cases like this are valid:</p>
<pre><code class="language-py">&quot;{{{0}}}&quot;.format(123)
</code></pre>
<p>I think this is verging on needing us to parse the whole format string manually, but if we can't come up with any other edge cases, I think the regex is fine. I'd recommend adding this as a fixable test case too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-07-28 18:26</div>
            <div class="timeline-body"><p>Thanks! I think we can just extend the current regex and also handle an additional edge case at the same time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`pyupgrade`] Fix UP030 to avoid modifying double curly braces in format strings" to "[`pyupgrade`] Fix `UP030` to avoid modifying double curly braces in format strings" by @ntBre on 2025-07-29 18:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ntBre on 2025-07-29 18:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-07-29 18:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-07-29 18:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-29 19:31</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:14:18 UTC
    </footer>
</body>
</html>
