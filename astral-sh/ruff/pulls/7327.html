<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update `F541` to use new f-string tokens - astral-sh/ruff #7327</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Update <code>F541</code> to use new f-string tokens</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7327">#7327</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2023-09-13 04:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR updates the <code>F541</code> rule to use the new f-string tokens.</p>
<h2>Test Plan</h2>
<p>Add new test case and uncomment a broken test case.</p>
<p>fixes: #7292</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-13 04:42</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #7376</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7376" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #7690</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7690" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
<li><strong>PR #7667</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7667" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
<li><strong>PR #7597</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7597" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
<li><strong>PR #7588</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7588" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #7589</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7589" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
</ul>
</li>
<li><strong>PR #7586</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7586" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
<li><strong>PR #7515</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7515" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
<li><strong>PR #7477</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7477" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
<li><strong>PR #7387</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7387" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
<li><strong>PR #7378</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7378" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
<li><strong>PR #7329</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7329" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
<li><strong>PR #7328</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7328" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
<li><strong>PR #7327</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7327" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ</li>
<li><strong>PR #7326</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7326" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
<li><strong>PR #7325</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7325" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7327?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">python312</span> added by @dhruvmanila on 2023-09-13 05:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @dhruvmanila on 2023-09-13 05:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dhruvmanila on 2023-09-14 03:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @dhruvmanila on 2023-09-14 03:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/pyflakes/rules/f_string_missing_placeholders.rs</code>:67 on 2023-09-14 07:00</div>
            <div class="timeline-body"><p>Unrelated to your PR: Change expr to <code>ExprFString</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/pyflakes/rules/f_string_missing_placeholders.rs</code>:72 on 2023-09-14 07:01</div>
            <div class="timeline-body"><p>Nit: Just to make sure we never index from the start of the document</p>
<pre><code class="language-suggestion">    let mut current_f_string_start = expr.start();
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/pyflakes/rules/f_string_missing_placeholders.rs</code>:82 on 2023-09-14 07:04</div>
            <div class="timeline-body"><p>How does this work with multiple nested fstrings?</p>
<pre><code class="language-python">f&quot;{f&quot;{a + f&quot;{b}&quot;}&quot;}&quot;
</code></pre>
<p>I would expect that <code>f&quot;{b}&quot;</code> overrides the start position of <code>f&quot;{a + f&quot;{b}&quot;}&quot;</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-14 07:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-09-15 06:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/rules/pyflakes/rules/f_string_missing_placeholders.rs</code>:82 on 2023-09-15 06:09</div>
            <div class="timeline-body"><p>To give some context, the autofix for the rule <code>F541</code> is to remove the <code>f</code> prefix from the f-string <em>without</em> any placeholders. The placeholder checks are done at an expression level by checking if there's any <code>FormattedValue</code>. The function you're referring to is to get the <code>f</code> prefix range and the f-string range. At this point there can't be any nested f-strings.</p>
<p>Also, the reason the function returns an iterator is because of implicitly concatenated strings.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/rules/pyflakes/rules/f_string_missing_placeholders.rs</code>:82 on 2023-09-15 06:12</div>
            <div class="timeline-body"><p>I think the function name is a bit confusing which I'll rename. I've also added docs to the function.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-09-15 06:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-15 06:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/pyflakes/rules/f_string_missing_placeholders.rs</code>:82 on 2023-09-15 06:18</div>
            <div class="timeline-body"><p>Hmm, but the documentation mentions that this function returns all nested f-string ranges, meaning there need to be placeholders? It's also unclear to me where the filtering out of f-strings without placeholders happens.</p>
<p>So I think we need to update the documentation to match its actual behavior (or it's too early in the morning and I shouldn't be reviewing PR's :sweat_smile: )</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-09-15 06:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/rules/pyflakes/rules/f_string_missing_placeholders.rs</code>:111 on 2023-09-15 06:30</div>
            <div class="timeline-body"><blockquote>
<p>It's also unclear to me where the filtering out of f-strings without placeholders happens.</p>
</blockquote>
<p>@MichaReiser</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-09-15 06:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/rules/pyflakes/rules/f_string_missing_placeholders.rs</code>:82 on 2023-09-15 06:30</div>
            <div class="timeline-body"><blockquote>
<p>Hmm, but the documentation mentions that this function returns all nested f-string ranges, meaning there need to be placeholders?</p>
</blockquote>
<p>I've updated the documentation but I'm curious as to where was &quot;nested f-string ranges&quot; mentioned? ðŸ˜…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-15 07:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/pyflakes/rules/f_string_missing_placeholders.rs</code>:111 on 2023-09-15 07:03</div>
            <div class="timeline-body"><p>Thanks. The issue I see is that <code>find_useless_f_strings</code> returns all fstrings but with potentially incorrect ranges. So naming that function <code>find_useless_f_strings</code> is misleading in my view because not all fstrings returned by that function are useless.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-09-15 07:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/rules/pyflakes/rules/f_string_missing_placeholders.rs</code>:111 on 2023-09-15 07:15</div>
            <div class="timeline-body"><p>Yes, I totally agree. I've renamed it to <code>fstring_prefix_and_tok_range</code> but the main reason it returns an iterator is because the f-string can contain multiple implicitly concatenated (f-)strings.</p>
<blockquote>
<p>because not all fstrings returned by that function are useless.</p>
</blockquote>
<p>Can you expand on this? For example, in the below code snippet it would return (prefix range, token range) for the &quot;first&quot; and the &quot;last&quot; string and not for the &quot;normal&quot; string. Both f-strings are useless in the sense that there are no placeholders used and so the <code>f</code> prefix is useless. I don't think it ever returns incorrect ranges.</p>
<pre><code class="language-python">  f&quot;first&quot; &quot;normal&quot; rf&quot;second&quot;
# ^                  ^             (prefix range)
# ^^^^^^^^          ^^^^^^^^^^     (token range)

# (0..1, 0..8)      - `f&quot;first&quot;`
# (19..20, 18..28)  - `rf&quot;second&quot;`
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2023-09-18 16:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/pyflakes/rules/f_string_missing_placeholders.rs</code>:107 on 2023-09-18 16:24</div>
            <div class="timeline-body"><p>Nit: Values is now redundant, you can use <code>fstring.values</code> directly</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/pyflakes/rules/f_string_missing_placeholders.rs</code>:109 on 2023-09-18 16:25</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    if values.is_empty()
</code></pre>
<p>Because values can only be initialized with formatted values?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/pyflakes/rules/f_string_missing_placeholders.rs</code>:50 on 2023-09-18 16:25</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// Return an iterator containing a two-element tuple for each f-string part in the
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-09-18 16:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-09-18 16:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/rules/pyflakes/rules/f_string_missing_placeholders.rs</code>:109 on 2023-09-18 16:30</div>
            <div class="timeline-body"><p>No, it's initialized with both formatted values and string literals (other than the expression part). So, <code>f&quot;foo&quot;</code> will give:</p>
<pre><code class="language-rust">String(
    ExprFString {
        range: 0..6,
        values: [
            Constant(
                ExprConstant {
                    range: 2..5,
                    value: Str(
                        StringConstant {
                            value: &quot;foo&quot;,
                            unicode: false,
                            implicit_concatenated: false,
                        },
                    ),
                },
            ),
        ],
        implicit_concatenated: false,
    },
)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2023-09-18 16:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2023-09-18 16:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-09-18 16:44</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:00:11 UTC
    </footer>
</body>
</html>
