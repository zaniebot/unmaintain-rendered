<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix off-by one error in the `LineIndex::offset` calculation - astral-sh/ruff #13407</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix off-by one error in the <code>LineIndex::offset</code> calculation</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13407">#13407</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-09-19 11:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This fixes an error where Emacs showed obscure syntax errors.
The reason for the obscure syntax errors was that Ruff incorrectly
applied the change updates from emacs because of an off-by-one error
in the UTF32 to UTF8 offset calculation. When you add a new type wrapper to make it clear that the offsets are one-based and you still get it wrong :shrug:</p>
<p>We didn't notice this error before because VS code always uses UTF 16 and
I think neovim uses UTF8. The same method is also used to detect the format range.
But it was never significant there because range formatting always extends the range to the enclosing statement.</p>
<p>Fixes https://github.com/emacs-lsp/lsp-mode/issues/4547
Fixes https://github.com/astral-sh/ruff-lsp/issues/495</p>
<p>and possibly https://github.com/astral-sh/ruff/issues/13392</p>
<h2>Test Plan</h2>
<p>Added tests. I used emacs with a debug build that contains the fix and I no longer
observed any stale/obscure syntax errors</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @MichaReiser on 2024-09-19 11:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2024-09-19 11:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @MichaReiser on 2024-09-19 11:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-19 11:16</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2024-09-19 11:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-09-19 11:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-09-19 11:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-09-19 12:13</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:06:35 UTC
    </footer>
</body>
</html>
