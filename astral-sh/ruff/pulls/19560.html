<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add precise inference for indexing, slicing and unpacking `NamedTuple` instances - astral-sh/ruff #19560</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add precise inference for indexing, slicing and unpacking <code>NamedTuple</code> instances</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19560">#19560</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-07-25 17:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-25 17:27</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Infer the correct tuple supertype for <code>NamedTuple</code> classes. This allows us to infer precise types for indexing into <code>NamedTuple</code> classes, unpacking <code>NamedTuple</code> classes, and comparing <code>NamedTuple</code> classes.</p>
<pre><code class="language-py">from typing import NamedTuple

class Foo(NamedTuple):
    x: int
    y: str

def _(f: Foo):
    reveal_type(f[0])  # revealed: int
    reveal_type(f[1])  # revealed: str
    a, b = f
    reveal_type(a)  # revealed: int
    reveal_type(b)  # revealed: str
</code></pre>
<h2>Test Plan</h2>
<p>Mdtests.</p>
<h2>Typing conformance diff</h2>
<p>This is all great! We see lots of <code>type-assertion-failures</code> going away, and lots of diagnostics now being emitted on lines in the conformance tests that are meant to produce type-checker errors.</p>
<h2>Ecosystem analysis</h2>
<p>This all looks good to me! Analysis in https://github.com/astral-sh/ruff/pull/19560#issuecomment-3180074168.</p>
<h2>New ecosystem panics</h2>
<p>Unfortunately this causes many new ecosystem panics, because <code>packaging</code> has a <code>NamedTuple</code> class that has a field annotated with a recursive type alias: https://github.com/pypa/packaging/blob/0055d4b8ff353455f0617690e609bc68a1f9ade2/src/packaging/_parser.py#L55. The initial support https://github.com/astral-sh/ruff/pull/19805 added for recursive types doesn't help us here, because it only adds support for explicit PEP-695 type aliases, whereas <code>packaging</code>'s type alias is an implicit one.</p>
<p>Many projects use <code>packaging</code>, so this unfortunately causes quite a big fallout...</p>
<hr />
<p>Co-authored-by: Brent Westbrook <a href="mailto:brentrwestbrook@gmail.com">brentrwestbrook@gmail.com</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-07-25 17:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-25 18:10</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">attrs (https://github.com/python-attrs/attrs)
+ src/attr/_make.py:703:29: error[unresolved-attribute] Type `Attribute` has no attribute `name`
+ src/attr/_make.py:705:50: error[not-iterable] Object of type `type` is not iterable
+ src/attr/_make.py:739:22: error[not-iterable] Object of type `type` is not iterable
+ tests/test_make.py:197:52: error[not-iterable] Object of type `type` is not iterable
+ tests/test_make.py:222:25: error[invalid-argument-type] Argument to function `len` is incorrect: Expected `Sized`, found `type`
+ tests/test_make.py:223:54: error[not-iterable] Object of type `type` is not iterable
+ tests/test_make.py:268:20: error[invalid-argument-type] Argument to function `len` is incorrect: Expected `Sized`, found `type`
+ tests/test_make.py:271:18: error[not-iterable] Object of type `type` is not iterable
+ tests/test_make.py:287:20: error[invalid-argument-type] Argument to function `len` is incorrect: Expected `Sized`, found `type`
+ tests/test_make.py:290:18: error[not-iterable] Object of type `type` is not iterable
- Found 650 diagnostics
+ Found 660 diagnostics

pydantic (https://github.com/pydantic/pydantic)
+ pydantic/v1/types.py:704:12: error[unsupported-operator] Operator `&gt;=` is not supported for types `str` and `int`, in comparing `int | Literal[&quot;n&quot;, &quot;N&quot;, &quot;F&quot;]` with `Literal[0]`
+ pydantic/v1/types.py:706:22: error[unsupported-operator] Operator `+` is unsupported between objects of type `int` and `int | Literal[&quot;n&quot;, &quot;N&quot;, &quot;F&quot;]`
+ pydantic/v1/types.py:714:20: error[invalid-argument-type] Argument to function `abs` is incorrect: Expected `SupportsAbs[Unknown]`, found `int | Literal[&quot;n&quot;, &quot;N&quot;, &quot;F&quot;]`
+ pydantic/v1/types.py:715:41: error[invalid-argument-type] Argument to function `abs` is incorrect: Expected `SupportsAbs[Unknown]`, found `int | Literal[&quot;n&quot;, &quot;N&quot;, &quot;F&quot;]`
+ pydantic/v1/types.py:715:41: error[invalid-argument-type] Argument to function `abs` is incorrect: Expected `SupportsAbs[Unknown]`, found `int | Literal[&quot;n&quot;, &quot;N&quot;, &quot;F&quot;]`
+ pydantic/v1/types.py:718:32: error[invalid-argument-type] Argument to function `abs` is incorrect: Expected `SupportsAbs[Unknown]`, found `int | Literal[&quot;n&quot;, &quot;N&quot;, &quot;F&quot;]`
- Found 757 diagnostics
+ Found 763 diagnostics

mongo-python-driver (https://github.com/mongodb/mongo-python-driver)
- bson/decimal128.py:103:50: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 511 diagnostics
+ Found 510 diagnostics

cloud-init (https://github.com/canonical/cloud-init)
+ cloudinit/config/modules.py:287:48: error[unresolved-attribute] Type `ModuleType` has no attribute `handle`
+ cloudinit/config/modules.py:298:39: error[unresolved-attribute] Type `ModuleType` has no attribute `handle`
- Found 614 diagnostics
+ Found 616 diagnostics

pywin32 (https://github.com/mhammond/pywin32)
+ win32/Demos/win32gui_menu.py:354:16: error[unsupported-operator] Operator `&amp;` is unsupported between objects of type `int | None` and `Literal[8]`
+ win32/test/test_win32guistruct.py:89:43: error[invalid-argument-type] Argument to function `len` is incorrect: Expected `Sized`, found `str | None`
- Found 2004 diagnostics
+ Found 2006 diagnostics

psycopg (https://github.com/psycopg/psycopg)
- psycopg/psycopg/pq/pq_ctypes.py:937:71: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 655 diagnostics
+ Found 654 diagnostics

pytest (https://github.com/pytest-dev/pytest)
- src/_pytest/hookspec.py:1114:6: error[invalid-return-type] Function always implicitly returns `None`, which is not assignable to return type `TestShortLogReport | tuple[str, str, str | tuple[str, Mapping[str, bool]]]`
+ src/_pytest/hookspec.py:1114:6: error[invalid-return-type] Function always implicitly returns `None`, which is not assignable to return type `tuple[str, str, str | tuple[str, Mapping[str, bool]]]`

sympy (https://github.com/sympy/sympy)
+ sympy/integrals/manualintegrate.py:1894:28: error[unsupported-operator] Operator `&lt;` is not supported for types `Basic` and `int`, in comparing `Unknown | Basic` with `Literal[0]`
+ sympy/integrals/manualintegrate.py:1906:49: error[invalid-argument-type] Argument is incorrect: Expected `Expr`, found `Unknown | Basic`
- Found 12989 diagnostics
+ Found 12991 diagnostics

</code></pre>
</details>
<details>
<summary>Memory usage changes were detected when running on open source projects</summary>

<pre><code class="language-diff">flake8 (https://github.com/pycqa/flake8)
-     memo fields = ~54MB
+     memo fields = ~57MB

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by @AlexWaygood on 2025-07-25 18:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-25 18:22</div>
            <div class="timeline-body"><!-- generated-comment ty ecosystem-analyzer -->

<h2><code>ecosystem-analyzer</code> results</h2>
<p>| Lint rule | Added | Removed | Changed |
|-----------|------:|--------:|--------:|
| <code>invalid-overload</code> | 0 | 727 | 0 |
| <code>unresolved-import</code> | 0 | 267 | 0 |
| <code>unused-ignore-comment</code> | 0 | 266 | 0 |
| <code>invalid-argument-type</code> | 108 | 8 | 0 |
| <code>possibly-unbound-attribute</code> | 41 | 40 | 0 |
| <code>invalid-context-manager</code> | 0 | 56 | 0 |
| <code>unresolved-attribute</code> | 8 | 42 | 0 |
| <code>unsupported-operator</code> | 29 | 2 | 0 |
| <code>invalid-assignment</code> | 9 | 11 | 0 |
| <code>non-subscriptable</code> | 18 | 1 | 0 |
| <code>possibly-unresolved-reference</code> | 0 | 15 | 0 |
| <code>not-iterable</code> | 10 | 0 | 0 |
| <code>invalid-return-type</code> | 0 | 6 | 3 |
| <code>invalid-type-form</code> | 0 | 9 | 0 |
| <code>missing-argument</code> | 0 | 9 | 0 |
| <code>no-matching-overload</code> | 6 | 3 | 0 |
| <code>call-non-callable</code> | 1 | 4 | 0 |
| <code>redundant-cast</code> | 0 | 2 | 0 |
| <code>division-by-zero</code> | 0 | 1 | 0 |
| <code>unresolved-reference</code> | 0 | 1 | 0 |
| <strong>Total</strong> | <strong>230</strong> | <strong>1,470</strong> | <strong>3</strong> |</p>
<p><strong><a href="https://alex-brent-namedtuples.ecosystem-663.pages.dev/diff">Full report with detailed diff</a></strong></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-25 18:24</div>
            <div class="timeline-body"><p>The ecosystem report indicates that we shouldn't do this until we support unpacking tuple subclasses in the same way as we support unpacking tuples.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-30 12:13</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<details>
<summary>Changes were detected when running ty on typing conformance tests</summary>

<pre><code class="language-diff">--- old-output.txt	2025-08-13 15:17:32.371829275 +0000
+++ new-output.txt	2025-08-13 15:17:32.438829393 +0000
@@ -1,5 +1,5 @@
 WARN ty is pre-release software and not ready for production use. Expect to encounter bugs, missing features, and fatal errors.
-fatal[panic] Panicked at /home/runner/.cargo/git/checkouts/salsa-e6f3bb7c2a062968/918d35d/src/function/execute.rs:215:25 when checking `/home/runner/work/ruff/ruff/typing/conformance/tests/aliases_typealiastype.py`: `infer_definition_types(Id(c91d)): execute: too many cycle iterations`
+fatal[panic] Panicked at /home/runner/.cargo/git/checkouts/salsa-e6f3bb7c2a062968/918d35d/src/function/execute.rs:215:25 when checking `/home/runner/work/ruff/ruff/typing/conformance/tests/aliases_typealiastype.py`: `infer_definition_types(Id(14cb3)): execute: too many cycle iterations`
 _directives_deprecated_library.py:15:31: error[invalid-return-type] Function always implicitly returns `None`, which is not assignable to return type `int`
 _directives_deprecated_library.py:30:26: error[invalid-return-type] Function always implicitly returns `None`, which is not assignable to return type `str`
 _directives_deprecated_library.py:36:41: error[invalid-return-type] Function always implicitly returns `None`, which is not assignable to return type `Self@__add__`
@@ -661,14 +661,8 @@
 literals_semantics.py:24:5: error[invalid-assignment] Object of type `Literal[0]` is not assignable to `Literal[False]`
 literals_semantics.py:25:5: error[invalid-assignment] Object of type `Literal[False]` is not assignable to `Literal[0]`
 literals_semantics.py:33:5: error[invalid-assignment] Object of type `Literal[6, 7, 8]` is not assignable to `Literal[3, 4, 5]`
-namedtuples_define_class.py:23:1: error[type-assertion-failure] Argument does not have asserted type `int`
-namedtuples_define_class.py:24:1: error[type-assertion-failure] Argument does not have asserted type `int`
-namedtuples_define_class.py:25:1: error[type-assertion-failure] Argument does not have asserted type `str`
-namedtuples_define_class.py:26:1: error[type-assertion-failure] Argument does not have asserted type `str`
-namedtuples_define_class.py:27:1: error[type-assertion-failure] Argument does not have asserted type `int`
-namedtuples_define_class.py:28:1: error[type-assertion-failure] Argument does not have asserted type `int`
-namedtuples_define_class.py:29:1: error[type-assertion-failure] Argument does not have asserted type `tuple[int, int]`
-namedtuples_define_class.py:30:1: error[type-assertion-failure] Argument does not have asserted type `tuple[int, int, str]`
+namedtuples_define_class.py:32:7: error[index-out-of-bounds] Index 3 is out of bounds for tuple `Point` with length 3
+namedtuples_define_class.py:33:7: error[index-out-of-bounds] Index -4 is out of bounds for tuple `Point` with length 3
 namedtuples_define_class.py:44:6: error[missing-argument] No argument provided for required parameter `y`
 namedtuples_define_class.py:45:6: error[missing-argument] No argument provided for required parameter `y`
 namedtuples_define_class.py:46:15: error[invalid-argument-type] Argument is incorrect: Expected `int`, found `Literal[&quot;&quot;]`
@@ -679,15 +673,13 @@
 namedtuples_define_class.py:95:1: error[type-assertion-failure] Argument does not have asserted type `int | float`
 namedtuples_define_class.py:96:1: error[type-assertion-failure] Argument does not have asserted type `int | float`
 namedtuples_define_class.py:98:19: error[invalid-argument-type] Argument is incorrect: Expected `str`, found `float`
-namedtuples_usage.py:27:1: error[type-assertion-failure] Argument does not have asserted type `int`
-namedtuples_usage.py:28:1: error[type-assertion-failure] Argument does not have asserted type `int`
-namedtuples_usage.py:29:1: error[type-assertion-failure] Argument does not have asserted type `str`
-namedtuples_usage.py:30:1: error[type-assertion-failure] Argument does not have asserted type `str`
-namedtuples_usage.py:31:1: error[type-assertion-failure] Argument does not have asserted type `int`
-namedtuples_usage.py:32:1: error[type-assertion-failure] Argument does not have asserted type `int`
+namedtuples_type_compat.py:22:1: error[invalid-assignment] Object of type `Point` is not assignable to `tuple[int, int]`
+namedtuples_type_compat.py:23:1: error[invalid-assignment] Object of type `Point` is not assignable to `tuple[int, str, str]`
+namedtuples_usage.py:34:7: error[index-out-of-bounds] Index 3 is out of bounds for tuple `Point` with length 3
+namedtuples_usage.py:35:7: error[index-out-of-bounds] Index -4 is out of bounds for tuple `Point` with length 3
 namedtuples_usage.py:41:1: error[invalid-assignment] Cannot assign to object of type `Point` with no `__setitem__` method
-namedtuples_usage.py:49:1: error[type-assertion-failure] Argument does not have asserted type `int`
-namedtuples_usage.py:50:1: error[type-assertion-failure] Argument does not have asserted type `str`
+namedtuples_usage.py:52:1: error[invalid-assignment] Too many values to unpack: Expected 2
+namedtuples_usage.py:53:1: error[invalid-assignment] Not enough values to unpack: Expected 4
 narrowing_typeguard.py:17:9: error[type-assertion-failure] Argument does not have asserted type `tuple[str, str]`
 narrowing_typeguard.py:32:9: error[type-assertion-failure] Argument does not have asserted type `set[int]`
 narrowing_typeguard.py:69:9: error[type-assertion-failure] Argument does not have asserted type `int`
@@ -868,5 +860,5 @@
 typeddicts_operations.py:60:1: error[type-assertion-failure] Argument does not have asserted type `str | None`
 typeddicts_type_consistency.py:101:1: error[invalid-assignment] Object of type `Unknown | None` is not assignable to `str`
 typeddicts_usage.py:40:24: error[invalid-type-form] The special form `typing.TypedDict` is not allowed in type expressions. Did you mean to use a concrete TypedDict or `collections.abc.Mapping[str, object]` instead?
-Found 869 diagnostics
+Found 861 diagnostics
 WARN A fatal error occurred while checking some files. Not all project files were analyzed. See the diagnostics list above for details.
</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> removed by @AlexWaygood on 2025-08-05 18:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-12 16:10</div>
            <div class="timeline-body"><h1>Ecosystem analysis</h1>
<h2><code>attrs</code></h2>
<p>These are all because we previously inferred the three variables <a href="https://github.com/python-attrs/attrs/blob/616adf5af936b9e690e72d740440dcfc9df25c87/src/attr/_make.py#L690-L698">here</a> as all having type <code>Unknown</code>, because the <code>_transform_attrs</code> function there returns an instance of a <code>NamedTuple</code> class.</p>
<pre><code class="language-diff">+ src/attr/_make.py:703:29: error[unresolved-attribute] Type `Attribute` has no attribute `name`
</code></pre>
<p>This is expected with our current capabilities. The <a href="https://github.com/python-attrs/attrs/blob/616adf5af936b9e690e72d740440dcfc9df25c87/src/attr/_make.py#L2413"><code>Attribute</code></a> class doesn't declare the <code>name</code> instance attribute as a type annotation, nor does it statically set the <code>name</code> instance attribute in any methods; it's only set dynamically, e.g. <a href="https://github.com/python-attrs/attrs/blob/616adf5af936b9e690e72d740440dcfc9df25c87/src/attr/_make.py#L2508">here</a>. There <em>is</em> a <code>name</code> entry in the class's <code>__slots__</code>, but we don't support <code>__slots__</code> for inference of instance attributes currently.</p>
<pre><code class="language-diff">+ src/attr/_make.py:705:50: error[not-iterable] Object of type `type` is not iterable
+ src/attr/_make.py:739:22: error[not-iterable] Object of type `type` is not iterable
+ tests/test_make.py:197:52: error[not-iterable] Object of type `type` is not iterable
+ tests/test_make.py:222:25: error[invalid-argument-type] Argument to function `len` is incorrect: Expected `Sized`, found `type`
+ tests/test_make.py:223:54: error[not-iterable] Object of type `type` is not iterable
+ tests/test_make.py:268:20: error[invalid-argument-type] Argument to function `len` is incorrect: Expected `Sized`, found `type`
+ tests/test_make.py:271:18: error[not-iterable] Object of type `type` is not iterable
+ tests/test_make.py:287:20: error[invalid-argument-type] Argument to function `len` is incorrect: Expected `Sized`, found `type`
+ tests/test_make.py:290:18: error[not-iterable] Object of type `type` is not iterable
</code></pre>
<p>these all look like true positives to me? We now infer the <a href="https://github.com/python-attrs/attrs/blob/616adf5af936b9e690e72d740440dcfc9df25c87/src/attr/_make.py#L690"><code>attrs</code> variable here</a> as being of type <code>type</code> because it's the first element of <a href="https://github.com/python-attrs/attrs/blob/616adf5af936b9e690e72d740440dcfc9df25c87/src/attr/_make.py#L288-L291">this <code>NamedTuple</code> class</a>. Not totally sure what's going on here?</p>
<h2>Pydantic</h2>
<pre><code class="language-diff">pydantic (https://github.com/pydantic/pydantic)
+ pydantic/v1/types.py:704:12: error[unsupported-operator] Operator `&gt;=` is not supported for types `str` and `int`, in comparing `int | Literal[&quot;n&quot;, &quot;N&quot;, &quot;F&quot;]` with `Literal[0]`
+ pydantic/v1/types.py:706:22: error[unsupported-operator] Operator `+` is unsupported between objects of type `int` and `int | Literal[&quot;n&quot;, &quot;N&quot;, &quot;F&quot;]`
+ pydantic/v1/types.py:714:20: error[invalid-argument-type] Argument to function `abs` is incorrect: Expected `SupportsAbs[Unknown]`, found `int | Literal[&quot;n&quot;, &quot;N&quot;, &quot;F&quot;]`
+ pydantic/v1/types.py:715:41: error[invalid-argument-type] Argument to function `abs` is incorrect: Expected `SupportsAbs[Unknown]`, found `int | Literal[&quot;n&quot;, &quot;N&quot;, &quot;F&quot;]`
+ pydantic/v1/types.py:715:41: error[invalid-argument-type] Argument to function `abs` is incorrect: Expected `SupportsAbs[Unknown]`, found `int | Literal[&quot;n&quot;, &quot;N&quot;, &quot;F&quot;]`
+ pydantic/v1/types.py:718:32: error[invalid-argument-type] Argument to function `abs` is incorrect: Expected `SupportsAbs[Unknown]`, found `int | Literal[&quot;n&quot;, &quot;N&quot;, &quot;F&quot;]`
- Found 759 diagnostics
+ Found 765 diagnostics
</code></pre>
<p>Code <a href="https://github.com/pydantic/pydantic/blob/d5684659df98d55678a450690000346dd326280b/pydantic/v1/types.py#L694-L718">here</a>. The relevant <code>NamedTuple</code> definition is in typeshed <a href="https://github.com/python/typeshed/blob/6cae34647c8fa41060cd9de5a7de3ce6239b6b19/stdlib/decimal.pyi#L51-L54">here</a>, and the relevant field annotation is <code>int | Literal[&quot;n&quot;, &quot;N&quot;, &quot;F&quot;]</code>. They're trying to narrow the type to <code>int</code> by doing this:</p>
<pre><code class="language-py">        if exponent in {'F', 'n', 'N'}:
            raise errors.DecimalIsNotFiniteError()
</code></pre>
<p>which isn't a type narrowing operation we support currently.</p>
<h2><code>mongo-python-driver</code></h2>
<pre><code class="language-diff">mongo-python-driver (https://github.com/mongodb/mongo-python-driver)
- bson/decimal128.py:103:50: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 508 diagnostics
+ Found 507 diagnostics
</code></pre>
<p>Code <a href="https://github.com/mongodb/mongo-python-driver/blob/f105789e1245e383550731ca7cdf045003c76c47/bson/decimal128.py#L103">here</a>. This is another case of code running into typeshed's annotation for <code>DecimalTuple.exponent</code>.</p>
<h2>cloud-init</h2>
<pre><code class="language-diff">cloud-init (https://github.com/canonical/cloud-init)
+ cloudinit/config/modules.py:287:48: error[unresolved-attribute] Type `ModuleType` has no attribute `handle`
+ cloudinit/config/modules.py:298:39: error[unresolved-attribute] Type `ModuleType` has no attribute `handle`
- Found 614 diagnostics
+ Found 616 diagnostics
</code></pre>
<p>The <code>NamedTuple</code> <a href="https://github.com/canonical/cloud-init/blob/1b908e331a7baee4b1f5020800caafa6e6250707/cloudinit/config/modules.py#L52-L56">here</a> is annotated as having a <code>module: ModuleType</code> field. <code>ModuleType</code> has a <code>__getattr__</code> method in typeshed that's meant to make code like this easier to write, but we currently always ignore that <code>__getattr__</code> method when looking up attributes on <code>ModuleType</code>, due to a pre-existing bug.</p>
<h2>pywin32</h2>
<pre><code class="language-diff">+ win32/Demos/win32gui_menu.py:354:16: error[unsupported-operator] Operator `&amp;` is unsupported between objects of type `int | None` and `Literal[8]`
</code></pre>
<p>This looks correct given the definition of <code>UnpackMENUITEMINFO</code> and <code>_MENUITEMINFO</code> <a href="https://github.com/python/typeshed/blob/6cae34647c8fa41060cd9de5a7de3ce6239b6b19/stubs/pywin32/win32/lib/win32gui_struct.pyi#L41-L52">in typeshed's stubs for <code>pywin32</code></a> (which are installed as part of the primer run when checking <code>pywin32</code> itself!). The pywin32 code is <a href="https://github.com/mhammond/pywin32/blob/1baced97cc5f2828d00bae8c70ec5e1833b66999/win32/Demos/win32gui_menu.py#L342-L355">here</a>.</p>
<pre><code class="language-diff">+ win32/test/test_win32guistruct.py:89:43: error[invalid-argument-type] Argument to function `len` is incorrect: Expected `Sized`, found `str | None`
</code></pre>
<p>This has the same underlying cause as the first one (<a href="https://github.com/mhammond/pywin32/blob/1baced97cc5f2828d00bae8c70ec5e1833b66999/win32/test/test_win32guistruct.py#L64-L89">code here</a>).</p>
<h2>pyscopg, sympy</h2>
<p>The code here is quite complex to untangle, but I can't see any obvious evidence of <code>NamedTuple</code> bugs in these either!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[ty] Add precise inference for indexing into `NamedTuple` instances" to "[ty] Add precise inference for indexing, slicing and unpacking `NamedTuple` instances" by @AlexWaygood on 2025-08-12 17:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @AlexWaygood on 2025-08-12 17:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-08-12 17:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-08-12 17:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @AlexWaygood on 2025-08-12 17:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> approved on 2025-08-12 19:48</div>
            <div class="timeline-body"><p>This is great!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types.rs</code>:9393 on 2025-08-12 23:26</div>
            <div class="timeline-body"><p>I'm not convinced of this comment; I think the &quot;pivot class&quot; of a bound <code>super</code> object really is a &quot;base class&quot; (that is, it is anything that can exist in an MRO), and it's good to represent it with <code>ClassBase</code>.</p>
<p>I would frame the problem here slightly differently: <code>ClassBase</code> enum should represent &quot;a thing that can be in an MRO&quot;, but the constructor <code>ClassBase::try_from_type</code> is also emulating the behavior of <code>__mro_entries__</code>, and there are cases for wanting to construct a &quot;thing that can be in an MRO&quot; from a type without emulating <code>__mro_entries__</code>. So perhaps there should be a way to construct a <code>ClassBase</code> that doesn't model <code>__mro_entries__</code> (and would thus return <code>None</code> if you tried to use <code>NamedTuple</code> as a base type.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-08-12 23:29</div>
            <div class="timeline-body"><p>Fantastic!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types.rs</code>:9393 on 2025-08-13 15:07</div>
            <div class="timeline-body"><blockquote>
<p>I would frame the problem here slightly differently: <code>ClassBase</code> enum should represent &quot;a thing that can be in an MRO&quot;, but the constructor <code>ClassBase::try_from_type</code> is also emulating the behavior of <code>__mro_entries__</code>, and there are cases for wanting to construct a &quot;thing that can be in an MRO&quot; from a type without emulating <code>__mro_entries__</code>. So perhaps there should be a way to construct a <code>ClassBase</code> that doesn't model <code>__mro_entries__</code> (and would thus return <code>None</code> if you tried to use <code>NamedTuple</code> as a base type.)</p>
</blockquote>
<p>Hmm, that's an interesting way of thinking about it... although we don't really attempt to <em>fully</em> emulate <code>__mro_entries__</code> in <code>ClassBase::try_from_type</code>. We only really try to emulate the parts of <code>__mro_entries__</code> that consist of 1:1 replacements of one object for another. Some stdlib <code>__mro_entries__</code> methods implement more complex behaviour where e.g. bases are conditionally appended to the end of the bases list -- we emulate <em>that</em> behaviour in https://github.com/astral-sh/ruff/blob/e12747a903989a14735d37e3128f15ec74ecda31/crates/ty_python_semantic/src/types/mro.rs#L73-L102</p>
<p>To me this sort-of goes to show even more that the methods on <code>ClassBase</code> have (in their current state, at least) been designed only with the internals of our MRO implementation in mind, and don't necessarily make sense if you try to reuse the enum for other purposes. One solution to this (the one this TODO comment currently implies) is just to create a separate enum with the same variants as <code>ClassBase</code>, which you can losslessly convert a <code>ClassBase</code> into. Since <code>ClassBase</code> is not a very big enum at all, I don't think this would lead to much code duplication.</p>
<p>I think <code>BoundSuperType</code> pretty clearly shouldn't be using <code>ClassBase::try_from_type</code> here, at the very least: it leads to obvious false negatives like this -- the <code>super()</code> call here fails at runtime, but we don't detect that, because <code>typing.ChainMap</code> is valid as an entry in a class's bases tuple, so the <code>ClassBase::try_from_type</code> call succeeds:</p>
<pre><code class="language-py">import typing

# revealed: &lt;super: &lt;class 'ChainMap[Unknown, Unknown]'&gt;, Unknown&gt;
reveal_type(super(typing.ChainMap, typing.ChainMap()))
</code></pre>
<p>https://play.ty.dev/fa1b725b-8121-4250-8ad4-604301127a91</p>
<p>For now I'll just make the TODO comment more vague and try to clean this up in a followup.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-08-13 15:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-08-13 15:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-08-13 15:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-13 15:19</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:52:43 UTC
    </footer>
</body>
</html>
