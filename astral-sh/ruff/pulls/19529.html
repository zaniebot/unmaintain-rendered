<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Implement stdlib stub mapping - astral-sh/ruff #19529</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Implement stdlib stub mapping</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19529">#19529</a>
        opened by <a href="https://github.com/Gankra">@Gankra</a>
        on 2025-07-24 13:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a></div>
            <div class="timeline-body"><p>by using essentially the same logic for system site-packages, on the assumption that system site-packages are always a subdir of the stdlib we were looking for.</p>
<p>This requires some more testing, but at least on my macbook it lets me jump to e.g. <code>warnings.deprecated</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/Gankra">@Gankra</a> on 2025-07-24 13:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/Gankra">@Gankra</a> on 2025-07-24 13:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/Gankra">@Gankra</a> on 2025-07-24 13:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/Gankra">@Gankra</a> on 2025-07-24 13:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/Gankra">@Gankra</a> on 2025-07-24 13:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-24 13:22</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-24 13:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_project/src/metadata/options.rs</code>:173 on 2025-07-24 13:23</div>
            <div class="timeline-body"><p>As implemented this will redo a lot of work the site-packages path does -- for now I&#x27;m leaving them separate in case the implementations should diverge more, but I can merge them together once we&#x27;re more confident.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-24 13:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/src/module_resolver/resolver.rs</code>:415 on 2025-07-24 13:24</div>
            <div class="timeline-body"><p>Need to iterate on this part.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-24 13:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/src/module_resolver/resolver.rs</code>:587 on 2025-07-24 13:24</div>
            <div class="timeline-body"><p>Whoops, forgot to delete this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-24 13:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/src/site_packages.rs</code>:505 on 2025-07-24 13:27</div>
            <div class="timeline-body"><p>I don&#x27;t think we should be using this? But I&#x27;m not sure.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-24 13:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_test/src/lib.rs</code>:286 on 2025-07-24 13:28</div>
            <div class="timeline-body"><p>(Note: this is in testing code)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-07-24 13:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/module_resolver/resolver.rs</code>:415 on 2025-07-24 13:28</div>
            <div class="timeline-body"><p>hmm, I&#x27;m not sure it&#x27;s correct for this to come after e.g. the <code>site-packages</code> search path. I think this would mean that if e.g. the user had the moribund <a href="https://pypi.org/project/asyncio/"><code>asyncio</code> package from PyPI</a> installed into their venv, they had <code>import asyncio</code> in a file, and they did go-to-definition on the <code>asyncio</code> symbol, we&#x27;d jump to the module in the venv&#x27;s site-packages directory. But at runtime, the module in the venv&#x27;s site-packages directory will be totally ignored: the stdlib takes precedence in module resolution over third-party packages, so <code>import asyncio</code> will resolve to the stdlib <code>asyncio</code> module.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-07-24 13:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-07-24 13:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/module_resolver/resolver.rs</code>:415 on 2025-07-24 13:29</div>
            <div class="timeline-body"><p>oh sorry, I posted this comment before I saw your comment above</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-07-24 13:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/site_packages.rs</code>:505 on 2025-07-24 13:30</div>
            <div class="timeline-body"><p>I <em>think</em> <code>base_executable_home_path</code> should always be the same for the parent environment? It would be pretty weird if not? But you&#x27;re the uv expert here ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-07-24 13:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/src/module_resolver/resolver.rs</code>:415 on 2025-07-24 13:33</div>
            <div class="timeline-body"><p>No this is still a great insight, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-24 13:37</div>
            <div class="timeline-body"><p>Here&#x27;s the things I&#x27;d want to manually double-check that this works with:</p>
<ul>
<li>A uv-managed Python installation</li>
<li>A Brew-installed Python installation</li>
<li>A pyenv installation of Python</li>
<li>GraalPy</li>
<li>PyPy</li>
</ul>
<p>(If it doesn&#x27;t work with all of them right now, obviously fine to TODO some of them and leave them for followups!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-24 13:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/carljm">@carljm</a> removed by <a href="https://github.com/carljm">@carljm</a> on 2025-07-25 01:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-08-07 14:55</div>
            <div class="timeline-body"><p>Hmm ok so this works great with uv-managed cpython/pypy/graalpy but need to work harder for homebrew at least. It looks like they go out of their way to make site-packages follow this format, but the stdlib is somewhere else. Notably the python binary it refers to is symlinked, and if we follow that symlink then this logic once again works (the stdlib is in fact in <code>../Frameworks/Python.framework/Versions/3.13/lib/python3.13/</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-08-07 16:35</div>
            <div class="timeline-body"><p>Newest commit handles homebrew and the macos system python.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-07 16:36</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/metadata/options.rs</code>:174 on 2025-08-08 08:06</div>
            <div class="timeline-body"><p>I think it would be helpful to lg any error at least with <code>debug</code> severity. It might otherwise be difficult to pin-point why go to definition etc. isn&#x27;t working for users (but it&#x27;s working fine for everyone of the team because we all use uv and not some other bespoke distribution)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/module_resolver/resolver.rs</code>:330 on 2025-08-08 08:11</div>
            <div class="timeline-body"><p>Curious to hear @AlexWaygood&#x27;s thoughts on this. I suspect that ty&#x27;s results will be fairly bonkers when the standard library is shadowed</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/site_packages.rs</code>:1125 on 2025-08-08 08:16</div>
            <div class="timeline-body"><p>Nit: If a small preference to use a <code>match</code> or <code>let</code> here for <code>python_version</code> to avoid the unwrap. It&#x27;s, unfortunately, a bit more verbose without if let chains (only one more month before we can use them)</p>
<pre><code>        match (implementation, python_version) {
            (PythonImplementation::CPython, Some(python_version)) if python_version.free_threaded_build_available() =&gt; {
                let alternative_path =
                sys_prefix_path.join(format!(&quot;lib/python{}t&quot;, python_version.unwrap()));
                if system.is_directory(&amp;alternative_path) {
                    return Ok(alternative_path);
                }
            }
        }
        if matches!(implementation, PythonImplementation::CPython)
            &amp;&amp; python_version.is_some_and(PythonVersion::free_threaded_build_available)
        {
            
        }
    }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/site_packages.rs</code>:1291 on 2025-08-08 08:18</div>
            <div class="timeline-body"><p>Is this check redundant, given that we skip if <code>entry.file_type().is_directory()</code> or should this come after canonicalize?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-08-08 08:20</div>
            <div class="timeline-body"><p>Nice!</p>
<p>Would it be very involved to write a test for this similar to the other tests we have in <code>site_packages</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-08-08 13:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/src/site_packages.rs</code>:1125 on 2025-08-08 13:42</div>
            <div class="timeline-body"><p>note that this is copy-pasted logic from the equivalent site-packages logic (prioritized keeping them the same where i can)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-08-08 13:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/src/module_resolver/resolver.rs</code>:330 on 2025-08-08 13:44</div>
            <div class="timeline-body"><p>They mentioned <a href="https://github.com/astral-sh/ty/issues/523">astral-sh/ty#523</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_python_semantic/src/site_packages.rs</code>:1291 on 2025-08-08 13:48</div>
            <div class="timeline-body"><p>Ah good catch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-08-08 13:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-08-08 19:51</div>
            <div class="timeline-body"><p>I am going to land this, I&#x27;m reasonably confident in how safe the implementation is. I expect more bugs will come up with us failing to find Fun stdlibs but this is still a big win.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/Gankra">@Gankra</a> on 2025-08-08 19:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/Gankra">@Gankra</a> on 2025-08-08 19:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-08 19:52</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:16:58 UTC
    </footer>
</body>
</html>
