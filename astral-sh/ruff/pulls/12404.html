<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Add verbosity argument to CLI - astral-sh/ruff #12404</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Add verbosity argument to CLI</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/12404">#12404</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-07-19 10:35
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">Summary
<p>This PR adds a new <code>--verbose</code> and <code>-v</code>, <code>-vv</code> and <code>-vvv</code> options and uses the level to configure the tracing verbosity.</p>
Test Plan
<p>I ran red knot with the different settings and verified that traces appear according to that level.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-19 10:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-19 10:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-19 10:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-19 10:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-19 10:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/main.rs</code>:138 on 2024-07-19 10:42</div>
            <div class="timeline-body"><p>Sorry for the renames but clippy became very angry at me and told me that the old name was a bad name.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-19 10:50</div>
            <div class="timeline-body"><p>It looks a <em>litle</em> odd right now that <code>--verbose</code> is the only CLI option that doesn&#x27;t have a description when you run <code>--help</code>:</p>
<p><img src="https://github.com/user-attachments/assets/93c21fc8-73c1-471e-b1ca-0a0c3145eee2" alt="image"></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-19 10:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/src/cli/verbosity.rs</code>:33 on 2024-07-19 10:57</div>
            <div class="timeline-body"><p>I feel like this could be simplified if you added a <code>VerbosityLevel::Warn</code> variant and just returned <code>VerbosityLevel</code> from this method, rather than <code>Option&lt;VerbosityLevel&gt;</code>. Something like this?</p>
<pre><code>diff --git a/crates/red_knot/src/cli/verbosity.rs b/crates/red_knot/src/cli/verbosity.rs
index 30bc2a4a5..470bfa49c 100644
--- a/crates/red_knot/src/cli/verbosity.rs
+++ b/crates/red_knot/src/cli/verbosity.rs
@@ -1,5 +1,6 @@
 #[derive(Debug, Copy, Clone, Eq, PartialEq, Ord, PartialOrd)]
 pub(crate) enum VerbosityLevel {
+    Warn,
     Info,
     Debug,
     Trace,
@@ -19,12 +20,12 @@ pub(crate) struct Verbosity {
 }
 
 impl Verbosity {
-    pub(crate) fn level(&amp;self) -&gt; Option&lt;VerbosityLevel&gt; {
+    pub(crate) fn level(&amp;self) -&gt; VerbosityLevel {
         match self.verbose {
-            0 =&gt; None,
-            1 =&gt; Some(VerbosityLevel::Info),
-            2 =&gt; Some(VerbosityLevel::Debug),
-            _ =&gt; Some(VerbosityLevel::Trace),
+            0 =&gt; VerbosityLevel::Warn,
+            1 =&gt; VerbosityLevel::Info,
+            2 =&gt; VerbosityLevel::Debug,
+            _ =&gt; VerbosityLevel::Trace,
         }
     }
 }
diff --git a/crates/red_knot/src/main.rs b/crates/red_knot/src/main.rs
index 35bfe2380..f39a23fd2 100644
--- a/crates/red_knot/src/main.rs
+++ b/crates/red_knot/src/main.rs
@@ -75,7 +75,7 @@ pub fn main() -&gt; anyhow::Result&lt;()&gt; {
     } = Args::parse_from(std::env::args().collect::&lt;Vec&lt;_&gt;&gt;());
 
     let verbosity = verbosity.level();
-    countme::enable(verbosity == Some(VerbosityLevel::Trace));
+    countme::enable(verbosity &gt;= VerbosityLevel::Trace);
     setup_tracing(verbosity);
 
     let cwd = if let Some(cwd) = current_directory {
@@ -134,13 +134,13 @@ pub fn main() -&gt; anyhow::Result&lt;()&gt; {
 }
 
 struct MainLoop {
-    verbosity: Option&lt;VerbosityLevel&gt;,
+    verbosity: VerbosityLevel,
     orchestrator: crossbeam_channel::Sender&lt;OrchestratorMessage&gt;,
     receiver: crossbeam_channel::Receiver&lt;MainLoopMessage&gt;,
 }
 
 impl MainLoop {
-    fn new(verbosity: Option&lt;VerbosityLevel&gt;) -&gt; (Self, MainLoopCancellationToken) {
+    fn new(verbosity: VerbosityLevel) -&gt; (Self, MainLoopCancellationToken) {
         let (orchestrator_sender, orchestrator_receiver) = crossbeam_channel::bounded(1);
         let (main_loop_sender, main_loop_receiver) = crossbeam_channel::bounded(1);
 
@@ -203,12 +203,12 @@ impl MainLoop {
                 }
                 MainLoopMessage::CheckCompleted(diagnostics) =&gt; {
                     eprintln!(&quot;{}&quot;, diagnostics.join(&quot;\n&quot;));
-                    if self.verbosity == Some(VerbosityLevel::Trace) {
+                    if self.verbosity &gt;= VerbosityLevel::Trace {
                         eprintln!(&quot;{}&quot;, countme::get_all());
                     }
                 }
                 MainLoopMessage::Exit =&gt; {
-                    if self.verbosity == Some(VerbosityLevel::Trace) {
+                    if self.verbosity &gt;= VerbosityLevel::Trace {
                         eprintln!(&quot;{}&quot;, countme::get_all());
                     }
                     return;
@@ -361,12 +361,12 @@ enum OrchestratorMessage {
     FileChanges(Vec&lt;FileWatcherChange&gt;),
 }
 
-fn setup_tracing(verbosity: Option&lt;VerbosityLevel&gt;) {
+fn setup_tracing(verbosity: VerbosityLevel) {
     let trace_level = match verbosity {
-        None =&gt; Level::WARN,
-        Some(VerbosityLevel::Info) =&gt; Level::INFO,
-        Some(VerbosityLevel::Debug) =&gt; Level::DEBUG,
-        Some(VerbosityLevel::Trace) =&gt; Level::TRACE,
+        VerbosityLevel::Warn =&gt; Level::WARN,
+        VerbosityLevel::Info =&gt; Level::INFO,
+        VerbosityLevel::Debug =&gt; Level::DEBUG,
+        VerbosityLevel::Trace =&gt; Level::TRACE,
     };
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/cli/verbosity.rs</code>:33 on 2024-07-19 11:06</div>
            <div class="timeline-body"><p>Yeah, I started with this but I disliked the name warn for the default. What the option indicates is that the user didn&#x27;t specify any verbosity. I considered using <code>DEFAULT</code>, but then went with <code>Option</code>.</p>
<p>We probably need to revisit this once we add other means of logging messages to the user.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-19 11:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-07-19 11:07</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-19 11:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/src/cli/verbosity.rs</code>:33 on 2024-07-19 11:08</div>
            <div class="timeline-body"><p>Maybe <code>Unspecified</code>? Right now it feels unclear to me, as a reader of the code, why it returns <code>Option</code>, so I&#x27;d at least add a comment explaining the decision, I think :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-19 11:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/src/cli/verbosity.rs</code>:15 on 2024-07-19 11:09</div>
            <div class="timeline-body"><pre><code>        help = &quot;Use more verbose output (can be specified multiple times)&quot;,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-19 11:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-19 11:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-07-19 11:38</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:05:21 UTC
    </footer>
</body>
</html>
