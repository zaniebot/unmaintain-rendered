<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add mdtests that exercise constraint sets - astral-sh/ruff #20319</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add mdtests that exercise constraint sets</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20319">#20319</a>
        opened by <a href="https://github.com/dcreager">@dcreager</a>
        on 2025-09-09 18:09
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a></div>
            <div class="timeline-body"><p>This PR adds a new <code>ty_extensions.ConstraintSet</code> class, which is used to expose constraint sets to our mdtest framework. This lets us write a large collection of unit tests that exercise the invariants and rewrite rules of our constraint set implementation.</p>
<p>As part of this, <code>is_assignable_to</code> and friends are updated to return a <code>ConstraintSet</code> instead of a <code>bool</code>, and we implement <code>ConstraintSet.__bool__</code> to return when a constraint set is always satisfied. That lets us still use <code>static_assert(is_assignable_to(...))</code>, since the assertion will coerce the constraint set to a bool, and also lets us <code>reveal_type(is_assignable_to(...))</code> to see more detail about whether/when the two types are assignable. That lets us get rid of <code>reveal_when_assignable_to</code> and friends, since they are now redundant with the expanded capabilities of <code>is_assignable_to</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-09 18:18</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-09 18:21</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/dcreager">@dcreager</a> on 2025-09-10 01:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/dcreager">@dcreager</a> on 2025-09-10 01:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/dcreager">@dcreager</a> on 2025-09-10 01:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/dcreager">@dcreager</a> on 2025-09-10 01:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/dcreager">@dcreager</a> on 2025-09-10 01:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/generics/pep695/variables.md</code>:140 on 2025-09-10 01:17</div>
            <div class="timeline-body"><p>These get quite a bit more verbose. Almost tempted to say we should keep <code>reveal_when_assignable_to</code> as a wrapper since it&#x27;s so much more concise? But I also like reducing the API surface area of <code>ty_extensions</code>.</p>
<p>Since all of these tests reveal <code>always</code> or <code>never</code>, could they just use <code>static_assert(is_assignable_to(...))</code> and <code>static_assert(not is_assignable_to(...))</code> instead? Or is the idea that you want to verify we are returning <code>always</code> or <code>never</code>, rather than some set of conditions which we would convert to <code>false</code> along with <code>never</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/type_properties/constraints.md</code>:143 on 2025-09-10 01:45</div>
            <div class="timeline-body"><p>This seems arbitrary (the choice of top materialization), which I think is OK because I think it only ever matters when using <code>ty_extensions.not_equivalent_constraint</code>? Because otherwise a not-equivalent constraint would only ever be generated via negation of a range constraint, right? And the range constraint will already have fully-static upper and lower bounds, resulting in a fully-static hole from the start.</p>
<p>If this is all correct, would it make sense to clarify some of this more here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/type_properties/constraints.md</code>:182 on 2025-09-10 01:46</div>
            <div class="timeline-body"><p>Same comment as above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/type_properties/constraints.md</code>:503 on 2025-09-10 01:57</div>
            <div class="timeline-body"><p>Why doesn&#x27;t this union simplify to <code>SubSub &lt;= T &lt;= Super</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/type_properties/constraints.md</code>:510 on 2025-09-10 01:58</div>
            <div class="timeline-body"><p>Similarly it seems to me this should simplify to <code>Sub &lt;= T &lt;= Super</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-09-10 02:01</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-09-10 12:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/resources/mdtest/generics/pep695/variables.md</code>:140 on 2025-09-10 12:46</div>
            <div class="timeline-body"><p>I originally had left out the <code>ty_extensions.ConstraintSet</code> part, which would have left the reveal renderings exactly as they were before. But it seemed like we are trying to have the <code>reveal_type</code> output include the type name.</p>
<blockquote>
<p>Or is the idea that you want to verify we are returning <code>always</code> or <code>never</code>, rather than some set of conditions which we would convert to <code>false</code> along with <code>never</code>?</p>
</blockquote>
<p>This, and more importantly, in #20093 some of these start returning constraint sets that are only sometimes satisfiable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/resources/mdtest/type_properties/constraints.md</code>:503 on 2025-09-10 13:13</div>
            <div class="timeline-body"><p>There can be types that satisfy <code>SubSub ≤ T ≤ Super</code> but which aren&#x27;t comparable to <code>Sub</code> or <code>Base</code>, and which therefore shouldn&#x27;t be included in the union.</p>
<p>So with just set theory, if the possible values are 0, 1, and 2, you get a type lattice of</p>
<pre><code>   012
01  02  12
 0   1   2
     ∅
</code></pre>
<p>Then we might have</p>
<pre><code>SubSub = ∅
Sub    = 1
Base   = 12
Super  = 012

SubSub ≤ T ≤ Base  = {∅, 1, 2, 12}
Sub ≤ T ≤ Super    = {1, 01, 12, 012}
</code></pre>
<p>The union should be</p>
<pre><code>(SubSub ≤ T ≤ Base) ∪ (Sub ≤ T ≤ Super) = {∅, 1, 2, 01, 12, 012}
</code></pre>
<p>but the simplification you suggest would be</p>
<pre><code>SubSub ≤ T ≤ Super = {∅, 0, 1, 2, 01, 02, 12, 012}
</code></pre>
<p><code>0</code> and <code>02</code> are included in the simplification but not in the actual union.</p>
<p>Translating that into Python, an example problem type would be <code>Super \ Sub*</code>, where <code>Sub*</code> indicates instances of just <code>Sub</code>, but not any of its subclasses. (So in English, the problem type is &quot;instances of <code>Super</code>, or any subclass of <code>Super</code> other than <code>Sub</code>&quot;. That type is not in <code>SubSub ≤ T ≤ Base</code>, since it includes <code>Super</code>, which is outside the range. It&#x27;s also not in <code>Sub ≤ T ≤ Super</code>, because it does not include <code>Sub</code>. But it is in <code>SubSub ≤ T ≤ Super</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/resources/mdtest/type_properties/constraints.md</code>:143 on 2025-09-10 13:18</div>
            <div class="timeline-body"><blockquote>
<p>This seems arbitrary (the choice of top materialization),</p>
</blockquote>
<p>Yeah, I wasn&#x27;t sure which materialization to use here, or if the correct thing to do was to make a range from the bottom materialization to the top, and then negate that. (Even if that&#x27;s more correct, I&#x27;m not at all sure what the analogue would be for incomparable below.)</p>
<p>But as you point out, we never create these directly, so it should be moot. I&#x27;ll update the <code>ty_extensions</code> constructor to <em>require</em> fully static inputs, and add commentary here explaining why.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-09-10 13:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-09-10 16:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/type_properties/constraints.md</code>:503 on 2025-09-10 16:11</div>
            <div class="timeline-body"><p>Makes sense, thank you! Might be worth recording a short version of this as a comment?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-09-10 16:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/resources/mdtest/type_properties/constraints.md</code>:503 on 2025-09-10 17:05</div>
            <div class="timeline-body"><p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-09-10 17:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dcreager">@dcreager</a> on 2025-09-10 17:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dcreager">@dcreager</a> on 2025-09-10 17:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-09-10 17:22</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:18:28 UTC
    </footer>
</body>
</html>
