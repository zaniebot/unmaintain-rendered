<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remove dedicated ScopeKind structs in favor of AST nodes - astral-sh/ruff #4648</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Remove dedicated ScopeKind structs in favor of AST nodes</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4648">#4648</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-05-25 00:31
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR removes a variety of structs that we'd defined in <code>scope.rs</code> to enable precise typing of scope fields (e.g., <code>ScopeKind::ClassDef</code> should have a name, bases, etc.). Now that we have dedicated node types for each AST node (e.g., <code>ast::StmtClassDef</code>), we can just store those directly instead.</p>
<p>This change reduces the size of the <code>ScopeKind</code> enum from 104 bytes to 16 bytes. Unfortunately, that's a bit misleading, as I've moved the <code>globals</code> hash map off the enum and onto <code>Scope</code>, which is itself another 40 bytes -- so we're really going from 104 bytes to 56 bytes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-25 00:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_semantic/src/scope.rs</code>:25 on 2023-05-25 00:35</div>
            <div class="timeline-body"><p>I actually have a branch that removes this, but it's a little less computationally efficient. We have to store these upfront so that we can detect <code>Expr::Name</code> expressions that reference a name <em>before</em> it's bound via <code>global</code> statement -- that's a syntax error:</p>
<pre><code class="language-py">def f():
  print(a)
  global a
</code></pre>
<p>The way we do this today is that we iterate over the function body to find all globals when we <em>first</em> encounter the function (this isn't <em>too</em> expensive, since we only have to iterate over statements, and don't need to recurse into other functions or classes), store them on the function scope, then, as we do the standard traversal, we check each <code>Expr::Name</code> against that global list.</p>
<p>An alternative, which wouldn't require us to store these at all, would be: (1) find all <code>global</code> statements, then (2) if we found <em>any</em> global statements, do a full, dedicated traversal of the function body up to the location of the last <code>global</code> statement, to find any names that were used &quot;too early&quot;.</p>
<p>That is: rather than finding the globals upfront, and then checking against names as we iterate over the rest of the AST, we'd find the globals upfront, then find all names upfront too if needed. In theory, this should be slower, though in practice, it may not matter? Since the vast majority of scopes don't have globals anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-05-25 00:42</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>✅ ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.06     19.1±0.99ms     2.1 MB/sec    1.00     18.0±0.84ms     2.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.16      4.5±0.20ms     3.7 MB/sec    1.00      3.9±0.27ms     4.3 MB/sec
linter/all-rules/numpy/globals.py          1.05   557.3±20.27µs     5.3 MB/sec    1.00   529.1±31.36µs     5.6 MB/sec
linter/all-rules/pydantic/types.py         1.09      8.0±0.44ms     3.2 MB/sec    1.00      7.4±0.40ms     3.5 MB/sec
linter/default-rules/large/dataset.py      1.16      9.2±0.32ms     4.4 MB/sec    1.00      7.9±0.34ms     5.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.19  1949.5±48.21µs     8.5 MB/sec    1.00  1634.8±129.44µs    10.2 MB/sec
linter/default-rules/numpy/globals.py      1.08   224.2±10.48µs    13.2 MB/sec    1.00   208.4±23.28µs    14.2 MB/sec
linter/default-rules/pydantic/types.py     1.24      4.1±0.18ms     6.2 MB/sec    1.00      3.3±0.20ms     7.7 MB/sec
parser/large/dataset.py                    1.00      6.8±0.29ms     6.0 MB/sec    1.05      7.1±0.13ms     5.7 MB/sec
parser/numpy/ctypeslib.py                  1.00  1377.6±76.64µs    12.1 MB/sec    1.02  1404.3±30.76µs    11.9 MB/sec
parser/numpy/globals.py                    1.02    135.4±5.54µs    21.8 MB/sec    1.00    133.0±8.37µs    22.2 MB/sec
parser/pydantic/types.py                   1.00      3.0±0.10ms     8.6 MB/sec    1.01      3.0±0.12ms     8.5 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     16.9±0.20ms     2.4 MB/sec    1.02     17.3±0.27ms     2.4 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.3±0.06ms     3.9 MB/sec    1.03      4.4±0.10ms     3.8 MB/sec
linter/all-rules/numpy/globals.py          1.00    502.6±9.35µs     5.9 MB/sec    1.00    504.8±7.11µs     5.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.1±0.11ms     3.6 MB/sec    1.00      7.1±0.12ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.01      8.4±0.09ms     4.9 MB/sec    1.00      8.3±0.07ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1789.2±26.42µs     9.3 MB/sec    1.00  1787.3±22.91µs     9.3 MB/sec
linter/default-rules/numpy/globals.py      1.00    203.4±3.30µs    14.5 MB/sec    1.01    206.3±5.05µs    14.3 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.8±0.04ms     6.8 MB/sec    1.01      3.8±0.05ms     6.7 MB/sec
parser/large/dataset.py                    1.00      6.5±0.05ms     6.3 MB/sec    1.01      6.5±0.06ms     6.2 MB/sec
parser/numpy/ctypeslib.py                  1.00  1242.0±16.66µs    13.4 MB/sec    1.00  1244.4±15.76µs    13.4 MB/sec
parser/numpy/globals.py                    1.00    125.7±1.96µs    23.5 MB/sec    1.00    126.0±2.26µs    23.4 MB/sec
parser/pydantic/types.py                   1.00      2.8±0.03ms     9.1 MB/sec    1.00      2.8±0.03ms     9.1 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_semantic/src/scope.rs</code>:25 on 2023-05-25 06:15</div>
            <div class="timeline-body"><p>What's the motivation for removing it? To reduce the size of <code>Scope</code>? One thing that we could do is to store the hash map out of bounds. Meaning, we only store a <code>Option&lt;GlobalsId&gt;</code> here (4 bytes vs 48 bytes) and store the globals in a <code>Vec</code> on scopes (indexed by <code>GlobalsId</code>). This adds one additional indirection (or we can store an <code>Option&lt;Box&lt;HashMap&gt;&gt;</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-25 06:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/checkers/ast/mod.rs</code>:1687 on 2023-05-25 06:16</div>
            <div class="timeline-body"><p>Nit: <code>scope.kind.is_any_function()</code> ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/checkers/ast/mod.rs</code>:1901 on 2023-05-25 06:19</div>
            <div class="timeline-body"><p>I think it could make sense for us to introduce a <code>AnyFunctionDef</code> union in <code>rust_python_ast</code> that has accessor methods for every field (that both <code>FunctionDef</code> and <code>AsyncFunctionDef</code> have. It can implement <code>From</code>, the <code>AstNode</code> trait, and <code>as/into_function_def()</code> and <code>as/into_async_function_def()</code> methods.</p>
<p>We found this a very powerful pattern at Rome and I think that would simplify the usage here.</p>
<p>https://github.com/rome/tools/blob/38104b339da8ff688f469799e1fc3f4a46f3d2ec/crates/rome_js_syntax/src/generated/nodes.rs#L13369-L13404
https://github.com/rome/tools/blob/38104b339da8ff688f469799e1fc3f4a46f3d2ec/crates/rome_js_syntax/src/union_ext.rs#L132-L238</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/checkers/ast/mod.rs</code>:1935 on 2023-05-25 06:21</div>
            <div class="timeline-body"><p>Part 1</p>
<pre><code class="language-suggestion">            Stmt::ClassDef(class_def @ ast::StmtClassDef {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/checkers/ast/mod.rs</code>:1963 on 2023-05-25 06:22</div>
            <div class="timeline-body"><p>Part 2</p>
<pre><code class="language-suggestion">                self.semantic_model.push_scope(ScopeKind::Class(class_def));
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_unary_op.rs</code>:102 on 2023-05-25 06:23</div>
            <div class="timeline-body"><p>Do we need to distinguish between <code>Function</code> and <code>AsyncFunction</code>. If not, having a single <code>AnyFunction</code> kind might be easier to use (it will increase the enum size by 8 bytes because it now requires two discriminates).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-05-25 06:25</div>
            <div class="timeline-body"><p>I like it. I think we could improve the economics by introducing an <code>AnyFunctionDef</code> enum that abstracts away <code>Function</code> and <code>AsyncFunction</code> (still allows to retrieve it when necessary, but it doesn't seem to matter for 99% of the uses)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-25 15:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_semantic/src/scope.rs</code>:25 on 2023-05-25 15:37</div>
            <div class="timeline-body"><p>Yeah, to reduce the size of <code>Scope</code>. That's an interesting idea, I'll try it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-25 15:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/checkers/ast/mod.rs</code>:1901 on 2023-05-25 15:38</div>
            <div class="timeline-body"><p>What if we just used a single <code>FunctionDef</code> node with an <code>async_</code> property?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-25 15:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/checkers/ast/mod.rs</code>:1901 on 2023-05-25 15:39</div>
            <div class="timeline-body"><p>That's not CPython compatible ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-25 19:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/checkers/ast/mod.rs</code>:1935 on 2023-05-25 19:23</div>
            <div class="timeline-body"><p>Ugh, I know, I just hated that it wasn't symmetric with the function case :sob:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-25 19:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/checkers/ast/mod.rs</code>:1901 on 2023-05-25 19:25</div>
            <div class="timeline-body"><p>Pshhhh</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-25 19:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_simplify/rules/ast_unary_op.rs</code>:102 on 2023-05-25 19:25</div>
            <div class="timeline-body"><p>Leaving this for now, but what do you mean by &quot;two discriminates&quot; here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-25 19:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_semantic/src/scope.rs</code>:25 on 2023-05-25 19:26</div>
            <div class="timeline-body"><p>(Will explore in a separate PR.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-05-25 19:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-05-25 19:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-05-25 19:31</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:57:38 UTC
    </footer>
</body>
</html>
