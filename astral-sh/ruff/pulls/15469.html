<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Migrate `is_subtype_of` unit tests to Markdown tests - astral-sh/ruff #15469</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Migrate <code>is_subtype_of</code> unit tests to Markdown tests</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15469">#15469</a>
        opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a>
        on 2025-01-14 09:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-01-14 09:34</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Part of #15397.</p>
<h2>Test Plan</h2>
<p>Markdown tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @InSyncWithFoo on 2025-01-14 09:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @InSyncWithFoo on 2025-01-14 09:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @InSyncWithFoo on 2025-01-14 09:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @InSyncWithFoo on 2025-01-14 09:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Migrate `is_subtype_of` unit tests to Markdown tests" to "[red-knot] Migrate `is_subtype_of` unit tests to Markdown tests" by @InSyncWithFoo on 2025-01-14 09:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-14 09:40</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by @AlexWaygood on 2025-01-14 09:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-01-14 09:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-14 12:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_subtype_of.md</code>:86 on 2025-01-14 12:34</div>
            <div class="timeline-body"><p>I guess you want to use a <code>Todo</code> type using <code>tuple[int, ...]</code> here? I think we should rather replace <code>tuple[int, ...]</code> with <code>Any</code> here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_subtype_of.md</code>:231 on 2025-01-14 12:37</div>
            <div class="timeline-body"><p>I would trust that <code>Intersection</code> works as expected here and go with just:</p>
<pre><code class="language-suggestion">class A: ...
class B: ...

static_assert(not is_subtype_of(A, B))
static_assert(is_subtype_of(Intersection[A, B], A))
static_assert(is_subtype_of(Intersection[A, B], B))
</code></pre>
<p>In the Rust implementation, we used <code>a</code> and <code>b</code> to get access to the types <code>A</code> and <code>B</code> (and not just the class literal types <code>TypeOf[A]</code> and <code>TypeOf[B]</code>), but we don't need that here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-14 12:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-14 12:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_subtype_of.md</code>:142 on 2025-01-14 12:45</div>
            <div class="timeline-body"><p>This comment by @AlexWaygood probably also applies here: https://github.com/astral-sh/ruff/pull/15353#discussion_r1907236295. We could introduce something like</p>
<pre><code>class Meta(type): ...
class HasCustomMetaClass(metaclass=Meta): ...
</code></pre>
<p>and then use those instead of <code>ABCMeta</code>, <code>ABC</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-14 12:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_subtype_of.md</code>:107 on 2025-01-14 12:47</div>
            <div class="timeline-body"><p><code>Intersection[Not[T]]</code> is equivalent to just <code>Not[T]</code>:</p>
<pre><code class="language-suggestion">static_assert(is_subtype_of(Intersection[int, Not[Literal[2]]], Not[Literal[2]]))
</code></pre>
<p>The same simplification applies to a few other tests below as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-14 12:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_subtype_of.md</code>:185 on 2025-01-14 12:48</div>
            <div class="timeline-body"><p>Minor: If we use two files anyway, I think I'd prefer two subsections <code>### Unions</code> and <code>### Intersections</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @MichaReiser removed by @MichaReiser on 2025-01-14 12:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-14 12:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_subtype_of.md</code>:196 on 2025-01-14 12:51</div>
            <div class="timeline-body"><p>Maybe we could use a type alias here to make this a bit easier to read?</p>
<pre><code class="language-suggestion">type LiteralBase = TypeOf[Base]
type LiteralDerived = TypeOf[Derived]

assert_type(Base, LiteralBase)
assert_type(Derived, LiteralDerived)

static_assert(is_subtype_of(LiteralBase, type))
static_assert(is_subtype_of(LiteralDerived, object))

# and similar below …
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_subtype_of.md</code>:211 on 2025-01-14 12:53</div>
            <div class="timeline-body"><p>Using the type aliases above, this could probably also be written without a <code>flag</code> helper?</p>
<pre><code class="language-suggestion">static_assert(is_subtype_of(TypeOf[LiteralBase | LiteralUnrelated], type))
static_assert(is_subtype_of(TypeOf[LiteralBase | LiteralUnrelated], object))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-14 12:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-14 12:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_subtype_of.md</code>:28 on 2025-01-14 12:54</div>
            <div class="timeline-body"><p>Maybe we can move those tests involving <code>Any</code> or <code>Unknown</code> into a new subsection titled &quot;Non fully-static types do not participate in subtyping&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-14 12:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_subtype_of.md</code>:46 on 2025-01-14 12:55</div>
            <div class="timeline-body"><p>Maybe</p>
<pre><code class="language-suggestion">## `Never` is a subtype of every type
</code></pre>
<p>and then move other tests with <code>Never</code> on the LHS into this section?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-14 12:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_subtype_of.md</code>:46 on 2025-01-14 12:56</div>
            <div class="timeline-body"><p>Similarly, we could have a &quot;<code>object</code> is a supertype of every type&quot; section, and then move all tests with <code>object</code> on the RHS into that section?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> approved on 2025-01-14 12:59</div>
            <div class="timeline-body"><p>Thank you very much!</p>
<p>I think we can probably extend these tests and potentially organize them a little better now that it's easier to do so, but this does not (should not?) happen in this PR. I added a couple of review comments, but I'm also happy to merge this as a &quot;pure refactoring&quot; PR and incorporate these improvements myself as a follow up. Let me know what you think.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2025-01-14 13:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_subtype_of.md</code>:211 on 2025-01-14 13:24</div>
            <div class="timeline-body"><p>(I think you mean <code>is_subtype_of(LiteralBase | LiteralUnrelated, type)</code> without <code>TypeOf</code>.) Done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-01-14 13:25</div>
            <div class="timeline-body"><p>@sharkdp Please go right ahead! It would be rather unproductive for me to perform such organizational changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> approved on 2025-01-14 14:57</div>
            <div class="timeline-body"><p>Thank you for the updates. I made one minor change. I think this is an accurate representation of the tests we had before. If someone wants to make improvements to this test suite, we can always do them on top of this change after it's merged.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2025-01-14 14:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-01-14 14:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-14 15:14</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 20:34:30 UTC
    </footer>
</body>
</html>
