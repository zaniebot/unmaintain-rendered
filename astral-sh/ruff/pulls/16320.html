<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test auto generated codes are up to date - astral-sh/ruff #16320</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Test auto generated codes are up to date</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16320">#16320</a>
        opened by <a href="https://github.com/Glyphack">@Glyphack</a>
        on 2025-02-22 20:44
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Glyphack">@Glyphack</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<p>This is just an idea feel free to close the PR if you don't see the benefit. I thought it would be quicker to discuss in the PR rather than issue.</p>
<h2>Summary</h2>
<p>This PR replaces the check in the CI to ensure auto generated codes are up to date with a rust test. The benefit is that this will run along the tests and fails if the auto generated code is not up to date.</p>
<p>I was checking rust analyzer ast generator setup, and noticed <a href="https://github.com/rust-lang/rust-analyzer/blob/862693ff954660d169774c8ada4672fb96dabf36/crates/syntax/src/tests/sourcegen_ast.rs#L21">this test</a> that checks for generate scripts to be up to date.
I think it's a nice improvement since the check we have now only runs in the CI, when I was working on the ast auto generation I forgot to update the generated file and found out in the CI.</p>
<p>Changes to make this work:</p>
<ul>
<li>Installing <code>uv</code> before running test in all steps. This is because we need to ensure we're running 3.11.</li>
<li>line endings have different representation in different platforms on windows it's <code>\r\n</code> so we need to replace that with <code>\n</code> before checking. I have to admit this one was tricky for me to figure out why is it broken. Maybe it worth it to print a minimal diff in the CI?</li>
</ul>
<p>The CI time does not seem to increase with this change.
<a href="https://github.com/astral-sh/ruff/actions/runs/13475837412/job/37654902156">this branch</a> vs <a href="https://github.com/astral-sh/ruff/actions/runs/13475837412/job/37654902156">main</a></p>
<h2>Test Plan</h2>
<p>Moved the CI check to a rust test. The failure looks like this:</p>
<pre><code>ruff/crates/ruff_python_ast/src/generated.rs has changed after running ruff/crates/ruff_python_ast/generate.py. Commit the changes.
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre>
<!-- How was it tested? -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @Glyphack on 2025-02-22 20:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-02-22 21:08</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @Glyphack on 2025-02-22 22:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ci</span> added by @AlexWaygood on 2025-02-22 22:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by @AlexWaygood on 2025-02-22 22:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-23 09:40</div>
            <div class="timeline-body"><p>I like the idea of running those checks as part of tests. This is actually similar to how we already assert that the JSON schemas are up to date and it has the benefit that we get signal earlier.</p>
<p>However, its dependency on uv does unnecessarily complicate running tests locally (I now have to ensure that my uv environment is up to date).</p>
<p>That's why I think a prerequisite for this is that we rewrite all Python scripts into Rust so that they are dependency-free.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Glyphack">@Glyphack</a> on 2025-02-23 13:51</div>
            <div class="timeline-body"><p>I close it to revisit afterwards when we update the code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Glyphack on 2025-02-23 13:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-25 12:37</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:10:17 UTC
    </footer>
</body>
</html>
