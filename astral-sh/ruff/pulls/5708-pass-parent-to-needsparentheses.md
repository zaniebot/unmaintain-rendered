```yaml
number: 5708
title: "Pass parent to `NeedsParentheses`"
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: refactor-needs-parentheses
created_at: 2023-07-12T13:08:39Z
updated_at: 2023-07-13T06:57:30Z
url: https://github.com/astral-sh/ruff/pull/5708
synced_at: 2026-01-12T03:36:55Z
```

# Pass parent to `NeedsParentheses`

---

_Pull request opened by @MichaReiser on 2023-07-12 13:08_

## Summary

This PR refactors `NeedsParentheses` so that implementations get access to the `parent` node. Having access to the parent node is e.g. required for omitting parentheses from the walrus operator when not strictly necessary. 

The main challenge that I ran into is that simply storing the parent node in `Parenthesize::Optional` isn't possible because `Parenthesize` then requires lifetimes, and `AsFormat` (with `FormatRuleWithOptions`) does not support lifetimes... ugh

This forced me to rethink the problem and I'm not entirely unhappy with the outcome (There's room for improvement on the naming). 

* `FormatExpr`: Accepts a `Parentheses` option that can either be `Always`, `Never`, `Preserve`, where `Preserve` is the default. This covers the base case of expression formatting
* `maybe_parenthesize_expression` is a new builder that *may* parenthesize an expression depending on `Parenthesized` and the expressions `NeedsParentheses` implementation. 

I went along and removed `Parentheses::Custom` as part of this PR. This caused me some headaches with string formatting until I realized that we currently make an exception for string formatting which we do not for other nodes. The old implementation forced strings to be flat when used in an Expression statement to match Black, but we don't enforce the same for binary expressions and other expressions nodes. My take is that we should solve this holistically rather than for some nodes only.

## Test Plan

Most of this is pure refactor. I reviewed the snapshot tests and they seem reasonable. 


---

_Comment by @MichaReiser on 2023-07-12 13:08_

Current dependencies on/for this PR:
* main
  * **PR #5711** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5711" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #5708** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5708" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/5708?utm_source=stack-comment).

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/tests/snapshots/black_compatibility@simple_cases__comments4.py.snap`:125 on 2023-07-12 13:14_

Requires call chain formatting

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/tests/snapshots/black_compatibility@simple_cases__expression.py.snap`:769 on 2023-07-12 13:15_

Requires proper generator formatting

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/tests/snapshots/format@expression__string.py.snap`:206 on 2023-07-12 13:16_

This per se is a regression because black keeps the string flat inside of `ExprStmt`. However, this is the same as that black does not try to wrap binary expressions on statement level (except if they contain a list). I decided to remove the *work around* for strings so that we have the same behavior for all expressions and either solve it holistically or not at all.

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_name.rs`:33 on 2023-07-12 13:16_

Names never require optional parentheses... There's nothing to split by

---

_@MichaReiser reviewed on 2023-07-12 13:17_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_call.rs`:114 on 2023-07-12 13:17_

Never is incorrect. It requires parentheses if the func node requires parentheses (see attribute chain)

---

_@MichaReiser reviewed on 2023-07-12 13:17_

---

_Review requested from @konstin by @MichaReiser on 2023-07-12 13:51_

---

_Marked ready for review by @MichaReiser on 2023-07-12 13:51_

---

_@MichaReiser reviewed on 2023-07-12 13:58_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_constant.rs`:62 on 2023-07-12 13:58_

This is somewhat slow. We should consider extracting the ranges of all multiline strings (similar to Ruff) 

---

_Label `formatter` added by @MichaReiser on 2023-07-12 13:58_

---

_Comment by @github-actions[bot] on 2023-07-12 14:12_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01      8.0Â±0.02ms     5.1 MB/sec    1.00      7.9Â±0.02ms     5.2 MB/sec
formatter/numpy/ctypeslib.py               1.02   1871.4Â±2.93Âµs     8.9 MB/sec    1.00   1832.7Â±2.17Âµs     9.1 MB/sec
formatter/numpy/globals.py                 1.00    204.5Â±0.38Âµs    14.4 MB/sec    1.00    204.8Â±0.52Âµs    14.4 MB/sec
formatter/pydantic/types.py                1.01      4.0Â±0.01ms     6.3 MB/sec    1.00      4.0Â±0.01ms     6.4 MB/sec
linter/all-rules/large/dataset.py          1.00     13.3Â±0.02ms     3.0 MB/sec    1.01     13.4Â±0.03ms     3.0 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.4Â±0.01ms     4.9 MB/sec    1.00      3.4Â±0.02ms     4.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    431.2Â±0.58Âµs     6.8 MB/sec    1.00    431.3Â±0.46Âµs     6.8 MB/sec
linter/all-rules/pydantic/types.py         1.05      6.3Â±0.08ms     4.1 MB/sec    1.00      6.0Â±0.02ms     4.3 MB/sec
linter/default-rules/large/dataset.py      1.00      6.7Â±0.01ms     6.1 MB/sec    1.01      6.8Â±0.02ms     6.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1487.4Â±1.40Âµs    11.2 MB/sec    1.00   1482.8Â±1.61Âµs    11.2 MB/sec
linter/default-rules/numpy/globals.py      1.00    169.2Â±0.86Âµs    17.4 MB/sec    1.00    168.9Â±0.22Âµs    17.5 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.1Â±0.01ms     8.3 MB/sec    1.00      3.1Â±0.01ms     8.4 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01     12.4Â±0.59ms     3.3 MB/sec    1.00     12.2Â±0.49ms     3.3 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.7Â±0.13ms     6.1 MB/sec    1.01      2.8Â±0.15ms     6.0 MB/sec
formatter/numpy/globals.py                 1.00   305.5Â±18.11Âµs     9.7 MB/sec    1.04   317.8Â±22.72Âµs     9.3 MB/sec
formatter/pydantic/types.py                1.00      6.0Â±0.27ms     4.3 MB/sec    1.01      6.0Â±0.32ms     4.2 MB/sec
linter/all-rules/large/dataset.py          1.02     20.9Â±0.92ms  1993.5 KB/sec    1.00     20.6Â±0.70ms  2024.7 KB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      5.3Â±0.22ms     3.2 MB/sec    1.04      5.5Â±0.52ms     3.0 MB/sec
linter/all-rules/numpy/globals.py          1.00   643.5Â±39.84Âµs     4.6 MB/sec    1.00   644.1Â±26.30Âµs     4.6 MB/sec
linter/all-rules/pydantic/types.py         1.01      9.2Â±0.33ms     2.8 MB/sec    1.00      9.0Â±0.39ms     2.8 MB/sec
linter/default-rules/large/dataset.py      1.03     10.7Â±0.42ms     3.8 MB/sec    1.00     10.3Â±0.54ms     3.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.02      2.2Â±0.10ms     7.5 MB/sec    1.00      2.2Â±0.09ms     7.7 MB/sec
linter/default-rules/numpy/globals.py      1.00   268.5Â±16.21Âµs    11.0 MB/sec    1.01   272.3Â±13.31Âµs    10.8 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.7Â±0.15ms     5.5 MB/sec    1.01      4.7Â±0.24ms     5.5 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/expr_call.rs`:114 on 2023-07-12 14:29_

yep i should have placed a todo comment about missing fluent style support there

---

_Review comment by @konstin on `crates/ruff_python_formatter/tests/snapshots/black_compatibility@simple_cases__comments4.py.snap`:125 on 2023-07-12 14:31_

yep i had opened https://github.com/astral-sh/ruff/issues/5343 to track this

---

_Review comment by @konstin on `crates/ruff_python_formatter/tests/snapshots/format@expression__string.py.snap`:206 on 2023-07-12 14:33_

implicit string concatenation (vs. triple quoted strings) at statement level seems like an odd choice, do you by chance have any usage examples?

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/expr_named_expr.rs`:39 on 2023-07-12 14:35_

it's actually a TODO on my end
```suggestion
        // mandatory. TODO(konstin): Implement [PEP 572](https://peps.python.org/pep-0572/) rules.
```

---

_@konstin approved on 2023-07-12 14:39_

---

_@MichaReiser reviewed on 2023-07-13 06:57_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/tests/snapshots/format@expression__string.py.snap`:206 on 2023-07-13 06:57_

I didn't find any in the whole django project... (as expected?)

---

_Merged by @MichaReiser on 2023-07-13 06:57_

---

_Closed by @MichaReiser on 2023-07-13 06:57_

---

_Branch deleted on 2023-07-13 06:57_

---
