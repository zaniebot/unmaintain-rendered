<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Fix range filtering for tokens starting at the end of the requested range - astral-sh/ruff #21193</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Fix range filtering for tokens starting at the end of the requested range</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21193">#21193</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-11-01 23:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-01 23:00</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR fixes an issue where the semantic token provider returned tokens that
started at the end offset of the selected range. That is, the
token and requested range intersect, but the intersecting range is empty.</p>
<p>This isn't an issue for most documents because the only outcome is tha the server
sends one additional token to the client. However, this is an issue for notebooks
where the response can only contain tokens that all belong to the same cell. Sending one extra token can then have the effect of sending the first token of the next cell,
which isn't allowed.</p>
<h2>Test Plan</h2>
<p>Added test. My in draft notebook PR no longer panics during semantic syntax highlighting</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @MichaReiser on 2025-11-01 23:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @MichaReiser on 2025-11-01 23:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MichaReiser on 2025-11-01 23:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MichaReiser on 2025-11-01 23:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @MichaReiser on 2025-11-01 23:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @MichaReiser on 2025-11-01 23:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @MichaReiser on 2025-11-01 23:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @MichaReiser on 2025-11-01 23:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-11-01 23:02</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-11-01 23:03</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @AlexWaygood on 2025-11-01 23:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_ide/src/semantic_tokens.rs</code>:230 on 2025-11-02 13:23</div>
            <div class="timeline-body"><p>Maybe</p>
<pre><code class="language-suggestion">            // Only include ranges that have a non-empty overlap.
</code></pre>
<p>or</p>
<pre><code class="language-suggestion">            // Only include ranges that have a non-empty overlap. Adjacent ranges
            // should be excluded.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_ide/src/semantic_tokens.rs</code>:1297 on 2025-11-02 13:26</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        // Expected: only &quot;y&quot; @ 7..8 and &quot;2&quot; @ 11..12 (non-empty overlap with target range).
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_ide/src/semantic_tokens.rs</code>:1298 on 2025-11-02 13:26</div>
            <div class="timeline-body"><p>Maybe</p>
<pre><code class="language-suggestion">        // Not included: &quot;1&quot; @ 5..6 and &quot;z&quot; @ 13..14 (adjacent, but not overlapping at offsets 6 and 13).
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_ide/src/semantic_tokens.rs</code>:1292 on 2025-11-02 13:27</div>
            <div class="timeline-body"><p>Aside: I found the <code>&lt;CURSOR&gt;</code> here distracting, as I initially thought it would somehow influence or determine the target range. Can it be removed?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> approved on 2025-11-02 13:27</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-11-02 14:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/semantic_tokens.rs</code>:1292 on 2025-11-02 14:53</div>
            <div class="timeline-body"><p>I agree that <code>CURSOR</code> is ony confusing here and that semantic tokens should probably not use the cursor infrastructure to begin with. But I'd rather clean this up in a separate PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-11-02 14:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-11-02 14:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-11-02 14:58</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:54:19 UTC
    </footer>
</body>
</html>
