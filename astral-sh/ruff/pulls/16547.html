<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Infer `lambda` expression - astral-sh/ruff #16547</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Infer <code>lambda</code> expression</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16547">#16547</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2025-03-07 07:19
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body">Summary
<p>Part of <a href="https://github.com/astral-sh/ruff/issues/15382">astral-sh/ruff#15382</a></p>
<p>This PR adds support for inferring the <code>lambda</code> expression and return the <code>CallableType</code>.</p>
<p>Currently, this is only limited to inferring the parameters and a todo type for the return type.</p>
<p>For posterity, I tried using the <code>file_expression_type</code> to infer the return type of lambda but it would always lead to cycle. The main reason is that in <code>infer_parameter_definition</code>, the default expression is being inferred using <code>file_expression_type</code>, which is correct, but it then</p>
<p>Take the following source code as an example:</p>
<pre><code>lambda x=1: x
</code></pre>
<p>Here&#x27;s how the code will flow:</p>
<ul>
<li><code>infer_scope_types</code> for the global scope</li>
<li><code>infer_lambda_expression</code></li>
<li><code>infer_expression</code> for the default value <code>1</code></li>
<li><code>file_expression_type</code> for the return type using the body expression. This is because the body creates it&#x27;s own scope</li>
<li><code>infer_scope_types</code> (lambda body scope)</li>
<li><code>infer_name_load</code> for the symbol <code>x</code> whose visible binding is the lambda parameter <code>x</code></li>
<li><code>infer_parameter_definition</code> for parameter <code>x</code></li>
<li><code>file_expression_type</code> for the default value <code>1</code></li>
<li><code>infer_scope_types</code> for the global scope because of the default expression</li>
</ul>
<p>This will then reach to <code>infer_definition</code> for the parameter <code>x</code> again which then creates the cycle.</p>
Test Plan
<p>Add tests around <code>lambda</code> expression inference.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-07 07:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-10 12:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-10 12:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-10 12:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-10 12:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-10 12:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/expression/lambda.md</code>:1 on 2025-03-10 14:19</div>
            <div class="timeline-body"><p>Could we also add a test like this?</p>
<pre><code>lambda x=1: reveal_type(x)  # revealed: Unknown | Literal[1]
</code></pre>
<p>to demonstrate that it works the same way as <code>def</code> functions?</p>
<p>I also wondered about adding tests that show <code>lambda</code>s being called correctly and incorrectly such as</p>
<pre><code>y = lambda x: &quot;foo&quot;
y(42)
y(42, 42)
</code></pre>
<p>But it looks like that hasn&#x27;t been implemented yet (which is fine, of course!), so I&#x27;m happy to leave that for now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-03-10 14:20</div>
            <div class="timeline-body"><p>This looks great, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:129 on 2025-03-10 16:26</div>
            <div class="timeline-body"><p>This is similar to <code>infer_definition_types</code> and it allowed me to quickly understand the origin of the cycle and what was causing it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-03-10 16:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-03-10 16:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/resources/mdtest/expression/lambda.md</code>:1 on 2025-03-10 16:28</div>
            <div class="timeline-body"><p>Yeah, I can add that. I actually had that in my playground file but I forgot to transfer that to the mdtest. Thanks for the suggestion.</p>
<blockquote>
<p>I also wondered about adding tests that show <code>lambda</code>s being called correctly and incorrectly such as</p>
</blockquote>
<p>Yeah, this isn&#x27;t implemented yet and will tackle in a follow-up.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-11 04:48</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-03-11 05:26</div>
            <div class="timeline-body"><p>Looks great, thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-03-11 05:27</div>
            <div class="timeline-body"><p>As we discussed in 1:1, we can infer a return type in some cases if we make default values of the parameters standalone expressions, so they can be resolved without creating a cycle.</p>
<p>Longer term, we may want to do &quot;inlining&quot; of lambdas at their usage sites so we can do better transparent inference, but that&#x27;s for later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-11 05:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-11 05:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-03-11 05:55</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:12:06 UTC
    </footer>
</body>
</html>
