<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add support for help end IPython escape commands - astral-sh/ruff #6358</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add support for help end IPython escape commands</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6358">#6358</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2023-08-05 02:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR adds support for a stricter version of help end escape commands<a href="https://github.com/astral-sh/ruff/pull/6272#issue-1833094281">^1</a> in the parser. By stricter, I mean that the escape tokens are only at the end of the command and there are no tokens at the start. This makes it difficult to implement it in the lexer without having to do a lot of look aheads or keeping track of previous tokens.</p>
<p>Now, as we're adding this in the parser, the lexer needs to recognize and emit a new token for <code>?</code>. So, <code>Question</code> token is added which will be recognized only in <code>Jupyter</code> mode.</p>
<p>The conditions applied are the same as the ones in the original implementation in IPython codebase (which is a regex):</p>
<ul>
<li>There can only be either 1 or 2 question mark(s) at the end</li>
<li>The node before the question mark can be a <code>Name</code>, <code>Attribute</code>, <code>Subscript</code> (only with integer constants in slice position), or any combination of the 3 nodes.</li>
</ul>
<h2>Test Plan</h2>
<p>Added test cases for various combination of the possible nodes in the command value position and update the snapshots.</p>
<p>fixes: #6359
fixes: #5030 (This is the final piece)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-08-05 02:03</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #6272</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6272" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #6358</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6358" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6358?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by @dhruvmanila on 2023-08-05 02:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-08-05 02:15</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      9.7Â±0.04ms     4.2 MB/sec    1.02      9.9Â±0.10ms     4.1 MB/sec
formatter/numpy/ctypeslib.py               1.00  1907.1Â±91.23Âµs     8.7 MB/sec    1.03  1971.7Â±29.77Âµs     8.4 MB/sec
formatter/numpy/globals.py                 1.00    210.6Â±1.94Âµs    14.0 MB/sec    1.06    223.2Â±6.86Âµs    13.2 MB/sec
formatter/pydantic/types.py                1.00      4.1Â±0.06ms     6.3 MB/sec    1.04      4.2Â±0.09ms     6.1 MB/sec
linter/all-rules/large/dataset.py          1.00     12.1Â±0.05ms     3.4 MB/sec    1.03     12.5Â±0.14ms     3.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.2Â±0.01ms     5.2 MB/sec    1.05      3.4Â±0.18ms     4.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    447.0Â±1.56Âµs     6.6 MB/sec    1.03    459.3Â±0.89Âµs     6.4 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.5Â±0.03ms     4.6 MB/sec    1.03      5.7Â±0.08ms     4.5 MB/sec
linter/default-rules/large/dataset.py      1.00      6.3Â±0.04ms     6.4 MB/sec    1.02      6.4Â±0.03ms     6.3 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1343.8Â±5.06Âµs    12.4 MB/sec    1.04  1402.4Â±87.21Âµs    11.9 MB/sec
linter/default-rules/numpy/globals.py      1.00    156.7Â±8.50Âµs    18.8 MB/sec    1.01    157.7Â±1.84Âµs    18.7 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.8Â±0.01ms     9.1 MB/sec    1.04      2.9Â±0.02ms     8.8 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01     10.3Â±0.18ms     3.9 MB/sec    1.00     10.2Â±0.11ms     4.0 MB/sec
formatter/numpy/ctypeslib.py               1.00  1932.7Â±27.20Âµs     8.6 MB/sec    1.01  1950.9Â±38.52Âµs     8.5 MB/sec
formatter/numpy/globals.py                 1.00    213.4Â±7.18Âµs    13.8 MB/sec    1.04    220.9Â±9.68Âµs    13.4 MB/sec
formatter/pydantic/types.py                1.00      4.3Â±0.08ms     5.9 MB/sec    1.04      4.4Â±0.13ms     5.7 MB/sec
linter/all-rules/large/dataset.py          1.00     12.4Â±0.22ms     3.3 MB/sec    1.04     12.9Â±0.14ms     3.2 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.5Â±0.06ms     4.8 MB/sec    1.03      3.6Â±0.07ms     4.6 MB/sec
linter/all-rules/numpy/globals.py          1.00    427.4Â±7.29Âµs     6.9 MB/sec    1.04    444.5Â±7.62Âµs     6.6 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.9Â±0.13ms     4.3 MB/sec    1.06      6.2Â±0.13ms     4.1 MB/sec
linter/default-rules/large/dataset.py      1.00      7.0Â±0.11ms     5.8 MB/sec    1.02      7.1Â±0.16ms     5.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1419.9Â±19.34Âµs    11.7 MB/sec    1.03  1460.7Â±25.29Âµs    11.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    166.0Â±3.14Âµs    17.8 MB/sec    1.02    169.4Â±5.59Âµs    17.4 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.1Â±0.07ms     8.2 MB/sec    1.00      3.1Â±0.06ms     8.2 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:789 on 2023-08-07 19:12</div>
            <div class="timeline-body"><p>I'm not sure if we should be this strict in the lexer. This just makes sure that the <code>Question</code> token is emitted only when it's at the end of the line:</p>
<pre><code class="language-python">foo?
foo??
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-08-07 19:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-08-07 19:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/python.lalrpop</code>:375 on 2023-08-07 19:16</div>
            <div class="timeline-body"><p>We're permissive than the original implementation because we would allow whitespace between the expression and the suffix while the IPython implementation doesn't allow it. For example, <code>foo ?</code> would be valid in our case but invalid from IPython.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dhruvmanila on 2023-08-07 19:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2023-08-07 19:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @dhruvmanila on 2023-08-07 19:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:789 on 2023-08-08 07:37</div>
            <div class="timeline-body"><p>I think we can always emit it in Jupyter mode. It's a valid token and it's the Parser's job to determine if it is a valid position.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/python.lalrpop</code>:375 on 2023-08-08 07:39</div>
            <div class="timeline-body"><p>It's not just whitespace. It also includes comments, continuation tokens etc. We could use the source text to retrieve the expression range instead and assert whether it contains any whitespace, comments, or continuation tokens (I'm not suggesting that we should do this, but it's a possibility)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/python.lalrpop</code>:431 on 2023-08-08 07:39</div>
            <div class="timeline-body"><p>The <code>unparse</code> function doesn't preserve whitespace, comments, or continuation tokens. Is this okay?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-08-08 07:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_parser/src/python.lalrpop</code>:375 on 2023-08-08 09:33</div>
            <div class="timeline-body"><p>i'd add @dhruvmanila's comment as code comment</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-08-08 09:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-08-08 13:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/python.lalrpop</code>:375 on 2023-08-08 13:20</div>
            <div class="timeline-body"><p>Makes sense. I might play around with your idea.</p>
<p>(I'll also add it as a code comment)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-08-08 13:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/lexer.rs</code>:789 on 2023-08-08 13:22</div>
            <div class="timeline-body"><p>Yeah, makes sense. I'll also remove this check <code>!self.state.is_new_logical_line()</code> and update the parser code to only allow the <code>Question</code> token <em>before</em> the newline. I'll probably need to play around with some test cases to make sure the pattern is correct.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-08-08 13:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/python.lalrpop</code>:431 on 2023-08-08 13:26</div>
            <div class="timeline-body"><p>If any of the trivia/comments are present, then I don't think IPython will even consider it valid or it'll only consider the regex match as valid ignoring any other text. For example,</p>
<pre><code class="language-python">foo. \
   bar?
</code></pre>
<p>This will mean that the help command is called only for <code>bar</code> and not <code>foo.bar</code> in IPython implementation.</p>
<p>I think for now it's ok to continue as such instances in the wild will be rare but we can improve it in the future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Add support for help end line magics in the parser" to "Add support for help end IPython escape commands in the parser" by @dhruvmanila on 2023-08-09 04:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Add support for help end IPython escape commands in the parser" to "Add support for help end IPython escape commands" by @dhruvmanila on 2023-08-09 04:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2023-08-09 04:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2023-08-09 04:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-08-09 04:58</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:59:20 UTC
    </footer>
</body>
</html>
