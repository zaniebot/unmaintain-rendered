<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add some completion ranking improvements - astral-sh/ruff #20807</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add some completion ranking improvements</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20807">#20807</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2025-10-10 18:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-10-10 18:32</div>
            <div class="timeline-body"><p>This PR contains a few improvements for completions:</p>
<ul>
<li>We now take the text that has been typed into consideration when
generating completions in all cases. Previously, we only did this for
auto-import completions.</li>
<li>The keyword values <code>None</code>, <code>True</code> and <code>False</code> are now included in
scoped completions.</li>
<li>Completions are not shown within comments.</li>
<li>Completions are not shown within strings.</li>
<li>Completions are <em>still</em> shown within the interpolated segments of
f-strings and t-strings.</li>
</ul>
<p>We add some new evaluation tasks to capture some of these cases. (And
lots of tests for the string detection logic.)</p>
<p><strong>Note:</strong> I did make some changes to the <code>TokenFlags</code> representation.
I'm open to other ideas. But I wanted to flag this since <code>TokenFlags</code>
is used within the representation of a <code>Token</code>, which is a fundamental
data type inside of Ruff. Thankfully, even though <code>TokenFlags</code> gets
bigger, <code>Token</code> itself does not (because of padding/alignment).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @BurntSushi on 2025-10-10 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @BurntSushi on 2025-10-10 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @BurntSushi on 2025-10-10 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @BurntSushi on 2025-10-10 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @BurntSushi on 2025-10-10 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @BurntSushi on 2025-10-10 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-10 18:34</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dcreager removed by @BurntSushi on 2025-10-10 18:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @BurntSushi on 2025-10-10 18:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @BurntSushi on 2025-10-10 18:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-10 18:35</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @AlexWaygood on 2025-10-10 18:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-10-10 18:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/completion.rs</code>:297 on 2025-10-10 18:51</div>
            <div class="timeline-body"><p><code>True</code> is an instance of the <code>bool</code> class; it is not the <code>bool</code> class object itself. So IIUC what's going on here, this should be</p>
<pre><code class="language-suggestion">            ty: Some(known.to_instance(db)),
</code></pre>
<p>(the same applies for the other two keywords)</p>
<p>But also, a more precise type for <code>True</code> than <code>bool</code> is <code>Literal[True]</code> (<code>Type::BooleanLiteral(true)</code> in our representation). None is just an instance of <code>NoneType</code>, though; there's no more precise type there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-10 18:55</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-10 19:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-10-10 22:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:297 on 2025-10-10 22:06</div>
            <div class="timeline-body"><p>Derp. Fixed!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/completion.rs</code>:283 on 2025-10-11 18:00</div>
            <div class="timeline-body"><p>(sorry for the back-and-forth on this) -- I now remember that we actually have a helper function for getting &quot;instance of <code>NoneType</code>&quot; specifically, since that's quite common in ty:</p>
<pre><code class="language-suggestion">        (&quot;None&quot;, Type::none(db)),
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_parser/src/token.rs</code>:742 on 2025-10-11 18:43</div>
            <div class="timeline-body"><p>This has a <em>bit</em> of a bad smell for me, because for all the <code>*Flags</code> structs in the <code>ruff_python_ast</code> crate, we simply use the absence of the <code>DOUBLE_QUOTES</code> flag to determine if a string uses single quotes. This change reduces the symmetry between this bitflag and all those bitflags:</p>
<p>https://github.com/astral-sh/ruff/blob/dc64c086336148c57db14060c86f448351710b2e/crates/ruff_python_ast/src/nodes.rs#L809-L833</p>
<p>https://github.com/astral-sh/ruff/blob/dc64c086336148c57db14060c86f448351710b2e/crates/ruff_python_ast/src/nodes.rs#L1398-L1431</p>
<p>https://github.com/astral-sh/ruff/blob/dc64c086336148c57db14060c86f448351710b2e/crates/ruff_python_ast/src/nodes.rs#L1826-L1850</p>
<p>https://github.com/astral-sh/ruff/blob/dc64c086336148c57db14060c86f448351710b2e/crates/ruff_python_ast/src/nodes.rs#L2021-L2075</p>
<p>It seems what you're looking for is a way to determine whether a token with <code>TokenKind::Unknown</code> represents an unclosed string. So maybe we could just have an <code>IS_STRING</code> (or <code>ANY_STRING</code>?) flag that is always set when the lexer starts lexing a string? Something like this?</p>
<pre><code class="language-diff">--- a/crates/ruff_python_parser/src/lexer.rs
+++ b/crates/ruff_python_parser/src/lexer.rs
@@ -760,10 +760,10 @@ impl&lt;'src&gt; Lexer&lt;'src&gt; {
         #[cfg(debug_assertions)]
         debug_assert_eq!(self.cursor.previous(), quote);
 
+        self.current_flags |= TokenFlags::IS_STRING;
+
         if quote == '&quot;' {
             self.current_flags |= TokenFlags::DOUBLE_QUOTES;
-        } else if quote == '\'' {
-            self.current_flags |= TokenFlags::SINGLE_QUOTES;
         }
 
         if self.cursor.eat_char2(quote, quote) {
@@ -924,10 +924,10 @@ impl&lt;'src&gt; Lexer&lt;'src&gt; {
         #[cfg(debug_assertions)]
         debug_assert_eq!(self.cursor.previous(), quote);
 
+        self.current_flags |= TokenFlags::IS_STRING;
+
         if quote == '&quot;' {
             self.current_flags |= TokenFlags::DOUBLE_QUOTES;
-        } else if quote == '\'' {
-            self.current_flags |= TokenFlags::SINGLE_QUOTES;
         }
 
         // If the next two characters are also the quote character, then we have a triple-quoted
diff --git a/crates/ruff_python_parser/src/token.rs b/crates/ruff_python_parser/src/token.rs
index c26254f23f..329c65812c 100644
--- a/crates/ruff_python_parser/src/token.rs
+++ b/crates/ruff_python_parser/src/token.rs
@@ -736,10 +736,12 @@ impl fmt::Display for TokenKind {
 bitflags! {
     #[derive(Clone, Copy, Debug, PartialEq, Eq)]
     pub struct TokenFlags: u16 {
+        /// The token is probably a string.
+        /// Note that this will not only be set for string tokens, but also for
+        /// tokens with [`TokenKind::Unknown`] that the lexer suspects to be strings.
+        const IS_STRING = 1 &lt;&lt; 0;
         /// The token is a string with double quotes (`&quot;`).
-        const DOUBLE_QUOTES = 1 &lt;&lt; 0;
-        /// The token is a string with single quotes (`'`).
-        const SINGLE_QUOTES = 1 &lt;&lt; 1;
+        const DOUBLE_QUOTES = 1 &lt;&lt; 1;
         /// The token is a triple-quoted string i.e., it starts and ends with three consecutive
         /// quote characters (`&quot;&quot;&quot;` or `'''`).
         const TRIPLE_QUOTED_STRING = 1 &lt;&lt; 2;
@@ -844,12 +846,12 @@ impl TokenFlags {
         self.intersects(TokenFlags::RAW_STRING)
     }
 
-    /// Returns `true` when the flags contain an explicit double or single quotes.
+    /// Returns `true` if this token is probably a string.
     ///
-    /// This is useful for determining whether an &quot;unknown&quot; token corresponds
-    /// to the start of a string.
-    pub const fn has_quotes(self) -&gt; bool {
-        self.intersects(TokenFlags::DOUBLE_QUOTES) || self.intersects(TokenFlags::SINGLE_QUOTES)
+    /// Note that this may be set for tokens with [`TokenKind::Unknown`]
+    /// as well as for tokens with [`TokenKind::String`].
+    pub const fn is_string(self) -&gt; bool {
+        self.intersects(TokenFlags::IS_STRING)
     }
 }
 
diff --git a/crates/ty_ide/src/completion.rs b/crates/ty_ide/src/completion.rs
index 2322389222..2a8be276b4 100644
--- a/crates/ty_ide/src/completion.rs
+++ b/crates/ty_ide/src/completion.rs
@@ -863,10 +863,10 @@ fn is_in_unclosed_string(parsed: &amp;ParsedModuleRef, offset: TextSize) -&gt; bool {
     for (i, t) in tokens.iter().enumerate().rev() {
         match t.kind() {
             TokenKind::Unknown =&gt; {
-                // It's possible to lex an unknown token with single/double
-                // quotes. If we got here, then we assume it is the opening
-                // of an unclosed string.
-                if t.flags().has_quotes() {
+                // If the file is currently invalid syntax, the token kind may be
+                // `TokenKind::Unknown`, so also check the flags to see if the
+                // lexer suspects that it's dealing with a string.
+                if t.flags().is_string() {
                     return true;
                 }
                 // Otherwise, we permit any kind of unknown token to be
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/completion.rs</code>:815 on 2025-10-11 18:54</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    if last.end() &lt; offset {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/completion.rs</code>:818 on 2025-10-11 18:55</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    Some(source[last.range()].to_string())
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/completion.rs</code>:2876 on 2025-10-11 18:58</div>
            <div class="timeline-body"><p>you can delete the TODO comment here -- it's now done :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-10-11 19:11</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/token.rs</code>:742 on 2025-10-12 06:14</div>
            <div class="timeline-body"><p>Hmm, I think my preferred solution would just be to always lex strings as strings, even if they're unclosed. But I'd have to play with it to see if this breaks any assumptions in Ruff</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-12 06:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-12 14:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/token.rs</code>:742 on 2025-10-12 14:54</div>
            <div class="timeline-body"><p>I'll give this a try Tomorrow.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @sharkdp on 2025-10-13 08:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-13 08:05</div>
            <div class="timeline-body"><p>I planned to take a look at this, but it looks like we have two reviews already.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/token.rs</code>:742 on 2025-10-14 09:32</div>
            <div class="timeline-body"><p>See https://github.com/astral-sh/ruff/pull/20848</p>
<p>I'll rebase this PR once https://github.com/astral-sh/ruff/pull/20848 lands</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-14 09:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-15 08:31</div>
            <div class="timeline-body"><p>Hmm, I think the evaluation results differ between mac and linux?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types.rs</code>:70 on 2025-10-15 08:47</div>
            <div class="timeline-body"><pre><code class="language-suggestion">pub(crate) use class::{ClassLiteral, ClassType, GenericAlias, KnownClass};
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/class.rs</code>:4559 on 2025-10-15 08:48</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    pub(crate) fn to_instance(self, db: &amp;dyn Db) -&gt; Type&lt;'_&gt; {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-15 08:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-15 08:56</div>
            <div class="timeline-body"><p>Sorry @BurntSushi, I'll squash-merge the commits because @AlexWaygood and I don't have as good a commit hygiene as you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-10-15 08:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-10-15 08:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-10-15 08:59</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:35:00 UTC
    </footer>
</body>
</html>
