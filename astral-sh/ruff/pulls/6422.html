<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add `enter` and `leave_node` methods to Preoder visitor - astral-sh/ruff #6422</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add <code>enter</code> and <code>leave_node</code> methods to Preoder visitor</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6422">#6422</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-08-08 10:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-08 10:42</div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>This PR adds <code>enter_node</code> and <code>leave_node</code> methods to the <code>Preorder</code> visitor that are called before entering and leaving any node.
Having these methods on the Visitor prevents that we forget to override specific node methods when adding new nodes in the future for visitors
that must run for every node.</p>
<p>The motivation for adding these methods is that I need to add a visitor to the formatter that marks every comment in the suppressed range as formatted.</p>
<!-- What's the purpose of the change? What does it do, and why? -->

<h2>Foot guns</h2>
<p>Overriding a <code>visit_</code> function without calling the corresponding <code>walk_</code> methods results in the <code>enter_</code> and <code>leave_</code> methods not being called.</p>
<h2>Alternative designs</h2>
<p>An alternative design would be introducing a new <code>NodeVisitor</code> trait with only the <code>enter_node</code>, <code>leave_node</code>, and <code>visit</code> methods. The <code>visit</code> methods uses an internal <code>PreorderVisitor</code> implementation that overrides all relevant methods (similar to how it worked for <code>CommentsVisitor</code> before).</p>
<p>The advantage of this solution is that it removes the foot gun because you can't override specific node visitor methods. The downside is that you can't override node-specific methods and it's easier to forget adding the new method to that visitor (although one should review all visitor implementations when adding a new visitor method)</p>
<h2>Test Plan</h2>
<p><code>cargo test</code></p>
<!-- How was it tested? -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-08 10:42</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #6422</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6422" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ<ul>
<li><strong>PR #6426</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6426" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #6441</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6441" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #6178</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6178" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6422?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2023-08-08 10:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_ast/src/visitor/preorder.rs</code>:12 on 2023-08-08 10:53</div>
            <div class="timeline-body"><p>nit: just <code>#[inline]</code>, even though I'd be surprised if that wasn't already inlined</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_ast/src/visitor/preorder.rs</code>:20 on 2023-08-08 10:54</div>
            <div class="timeline-body"><p>do we have evidence that this is needed/helpful?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_ast/src/visitor/preorder.rs</code>:180 on 2023-08-08 10:55</div>
            <div class="timeline-body"><p>return early here to keep the indentation</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-08-08 10:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-08 11:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/visitor/preorder.rs</code>:180 on 2023-08-08 11:00</div>
            <div class="timeline-body"><p>We need to call <code>leave_node</code> for all nodes, even if we're not traversing the node.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-08-08 11:13</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      8.3Â±0.02ms     4.9 MB/sec    1.00      8.3Â±0.03ms     4.9 MB/sec
formatter/numpy/ctypeslib.py               1.00  1611.6Â±33.17Âµs    10.3 MB/sec    1.00   1613.9Â±6.08Âµs    10.3 MB/sec
formatter/numpy/globals.py                 1.00    171.9Â±0.26Âµs    17.2 MB/sec    1.00    171.2Â±0.56Âµs    17.2 MB/sec
formatter/pydantic/types.py                1.01      3.5Â±0.07ms     7.2 MB/sec    1.00      3.5Â±0.02ms     7.2 MB/sec
linter/all-rules/large/dataset.py          1.00     10.5Â±0.07ms     3.9 MB/sec    1.01     10.6Â±0.08ms     3.8 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      2.9Â±0.01ms     5.8 MB/sec    1.01      2.9Â±0.03ms     5.8 MB/sec
linter/all-rules/numpy/globals.py          1.00    318.9Â±1.89Âµs     9.3 MB/sec    1.00    319.1Â±5.23Âµs     9.2 MB/sec
linter/all-rules/pydantic/types.py         1.00      4.9Â±0.02ms     5.2 MB/sec    1.01      4.9Â±0.07ms     5.2 MB/sec
linter/default-rules/large/dataset.py      1.00      5.5Â±0.03ms     7.4 MB/sec    1.00      5.5Â±0.07ms     7.3 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1153.9Â±12.57Âµs    14.4 MB/sec    1.00   1158.5Â±2.34Âµs    14.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    117.9Â±0.35Âµs    25.0 MB/sec    1.00    117.4Â±2.04Âµs    25.1 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.5Â±0.00ms    10.2 MB/sec    1.00      2.5Â±0.03ms    10.2 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     10.2Â±0.13ms     4.0 MB/sec    1.00     10.2Â±0.11ms     4.0 MB/sec
formatter/numpy/ctypeslib.py               1.00  1964.7Â±50.29Âµs     8.5 MB/sec    1.01  1986.2Â±99.49Âµs     8.4 MB/sec
formatter/numpy/globals.py                 1.00   216.7Â±10.93Âµs    13.6 MB/sec    1.02   221.6Â±12.31Âµs    13.3 MB/sec
formatter/pydantic/types.py                1.00      4.3Â±0.06ms     6.0 MB/sec    1.01      4.3Â±0.06ms     5.9 MB/sec
linter/all-rules/large/dataset.py          1.01     12.9Â±0.17ms     3.2 MB/sec    1.00     12.8Â±0.19ms     3.2 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.5Â±0.03ms     4.8 MB/sec    1.00      3.5Â±0.03ms     4.8 MB/sec
linter/all-rules/numpy/globals.py          1.00    434.3Â±5.83Âµs     6.8 MB/sec    1.00    432.2Â±4.97Âµs     6.8 MB/sec
linter/all-rules/pydantic/types.py         1.01      6.0Â±0.10ms     4.3 MB/sec    1.00      5.9Â±0.08ms     4.3 MB/sec
linter/default-rules/large/dataset.py      1.01      7.0Â±0.08ms     5.8 MB/sec    1.00      6.9Â±0.07ms     5.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1431.5Â±28.82Âµs    11.6 MB/sec    1.01  1439.6Â±19.36Âµs    11.6 MB/sec
linter/default-rules/numpy/globals.py      1.00    164.7Â±5.88Âµs    17.9 MB/sec    1.00    164.9Â±3.49Âµs    17.9 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.1Â±0.03ms     8.3 MB/sec    1.01      3.1Â±0.03ms     8.2 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-08-08 12:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_ast/src/visitor/preorder.rs</code>:180 on 2023-08-08 12:27</div>
            <div class="timeline-body"><p>Would this work?</p>
<pre><code class="language-python">if !visitor.enter_node(node).is_traverse() {
    visitor.leave_node();
    return;
}
</code></pre>
<p>(or if you want more abstractions, <code>EnterNodeGuard</code> with a Drop impl)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-08 13:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/visitor/preorder.rs</code>:180 on 2023-08-08 13:07</div>
            <div class="timeline-body"><p>That would work but seemed more complicated than adding the extra indentation. I also thought about</p>
<pre><code>visit_node(node, |node| {
})
</code></pre>
<p>But it all feels overly complicated for a very simple problem.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-09 07:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/visitor/preorder.rs</code>:20 on 2023-08-09 07:57</div>
            <div class="timeline-body"><p>It can be beneficial across crate boundaries because it tells Rust to emit the necessary inline information to inline across crate boundaries. However, this isn't relevant for us because we use LTO.</p>
<p>The use case where it is useful for us is in debug builds. To my knowledge, Rust doesn't perform any inline in debug builds <em>except</em> for functions attributed with <code>inline</code>. This means we get slightly better performance for debug builds.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-08-09 09:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-08-09 09:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-08-09 09:09</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 02:52:41 UTC
    </footer>
</body>
</html>
