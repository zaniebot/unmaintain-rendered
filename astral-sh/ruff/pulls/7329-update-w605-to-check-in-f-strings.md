```yaml
number: 7329
title: "Update `W605` to check in f-strings"
type: pull_request
state: merged
author: dhruvmanila
labels:
  - rule
  - python312
assignees: []
merged: true
base: dhruv/pep-701
head: dhruv/issue-7295
created_at: 2023-09-13T05:36:57Z
updated_at: 2023-09-28T03:58:53Z
url: https://github.com/astral-sh/ruff/pull/7329
synced_at: 2026-01-12T15:55:23Z
```

# Update `W605` to check in f-strings

---

_@dhruvmanila_

## Summary

This PR updates the `W605` (invalid-escape-sequence) to check inside f-strings. It also adds support to report violation on invalid escape sequence within f-strings w.r.t. the curly braces. So, the following cases will be identified:

```python
f"\{1}"
f"\{{1}}"
f"{1:\}"
```

The new CPython parser also gives out a syntax warning for such cases:

```
fstring.py:1: SyntaxWarning: invalid escape sequence '\{'
  f"\{1}"
fstring.py:2: SyntaxWarning: invalid escape sequence '\{'
  f"\{{1}}"
fstring.py:3: SyntaxWarning: invalid escape sequence '\}'
  f"{1:\}"
```

Nested f-strings are supported here, so the generated fix is aware of that and will create an edit for the proper f-string.

## Test Plan

Add new test cases for f-strings.

fixes: #7295


---

_Comment by @dhruvmanila on 2023-09-13 05:37_

Current dependencies on/for this PR:
* main
  * **PR #7376** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7376" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7690** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7690" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7667** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7667" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7597** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7597" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7588** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7588" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #7589** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7589" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7586** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7586" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7515** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7515" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7477** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7477" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7387** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7387" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7378** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7378" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7329** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7329" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #7328** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7328" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7327** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7327" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7326** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7326" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7325** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7325" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7329?utm_source=stack-comment).

---

_Label `rule` added by @dhruvmanila on 2023-09-13 05:37_

---

_Label `python312` added by @dhruvmanila on 2023-09-13 05:37_

---

_Marked ready for review by @dhruvmanila on 2023-09-14 06:24_

---

_Review requested from @charliermarsh by @dhruvmanila on 2023-09-14 06:24_

---

_Review requested from @MichaReiser by @dhruvmanila on 2023-09-14 06:24_

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/pycodestyle/rules/invalid_escape_sequence.rs`:123 on 2023-09-14 07:15_

Nit: The `let` else is a bit more complicated to read because I first read the exceptional case before the "normal" flow

What we want to express here is, take the `next_char` if any and otherwise return

```rust
if let Some(next_char) locator.after(tok_range.end()).chars().next() {
    next_char
} else {
    continue;
}
```

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/pycodestyle/rules/invalid_escape_sequence.rs`:119 on 2023-09-14 07:19_

I'm a bit confused by this comment. It says that there won't be any `FStringMiddle` token but this branch handles f-string middle tokens. How is this related?

---

_Review comment by @MichaReiser on `crates/ruff/resources/test/fixtures/pycodestyle/W605_2.py`:53 on 2023-09-14 07:20_

Can we add some tests for nested fstrings?

---

_@MichaReiser reviewed on 2023-09-14 07:20_

---

_@dhruvmanila reviewed on 2023-09-14 08:32_

---

_Review comment by @dhruvmanila on `crates/ruff/src/rules/pycodestyle/rules/invalid_escape_sequence.rs`:119 on 2023-09-14 08:32_

That is for the code snippet mentioned above. I'm making a case to prove that the next character is always going to be inside the f-string as a whole. The code snippet is:

```python
f"foo\"
```

Here, the `FStringMiddle` token won't be emitted because it's an unterminated string literal as the end quote is being escaped. So, the character coming after a `\` is always going to be part of the f-string.

---

_Comment by @codspeed-hq[bot] on 2023-09-18 16:48_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/dhruv/issue-7295)

### Merging #7329 will **improve performances by 2.38%**

<sub>:warning: No base runs were found</sub>

<sub>Falling back to comparing <code>dhruv/issue-7295</code> (b88d5a0) with <code>dhruv/pep-701</code> (c496d9c)</sub>



### Summary

`âš¡ 1` improvements
`âœ… 24` untouched benchmarks




### Benchmarks breakdown

|     | Benchmark | `dhruv/pep-701` | `dhruv/issue-7295` | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| âš¡ | `linter/all-rules[unicode/pypinyin.py]` | 16.1 ms | 15.7 ms | +2.38% |


---

_@MichaReiser approved on 2023-09-18 19:28_

---

_Merged by @dhruvmanila on 2023-09-19 06:38_

---

_Closed by @dhruvmanila on 2023-09-19 06:38_

---

_Branch deleted on 2023-09-19 06:38_

---
