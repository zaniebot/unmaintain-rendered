<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Add support for unpacking `for` target - astral-sh/ruff #15058</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Add support for unpacking <code>for</code> target</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15058">#15058</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-12-19 11:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body">Summary
<p>Related to #13773</p>
<p>This PR adds support for unpacking <code>for</code> statement targets.</p>
<p>This involves updating the <code>value</code> field in the <code>Unpack</code> target to use an enum which specifies the &quot;where did the value expression came from?&quot;. This is because for an iterable expression, we need to unpack the iterator type while for assignment statement we need to unpack the value type itself. And, this needs to be done in the unpack query.</p>
Question
<p>One of the ways unpacking works in <code>for</code> statement is by looking at the union of the types because if the iterable expression is a tuple then the iterator type will be union of all the types in the tuple. This means that the test cases that will test the unpacking in <code>for</code> statement will also implicitly test the unpacking union logic. I was wondering if it makes sense to merge these cases and only add the ones that are specific to the union unpacking or for statement unpacking logic.</p>
Test Plan
<p>Add test cases involving iterating over a tuple type. I&#x27;ve intentionally left out certain cases for now and I&#x27;m curious to know any thoughts on the above query.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-12-19 11:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[red-knot] Add support for unpacking union types&quot; to &quot;[red-knot] Add support for unpacking `for` target&quot; by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-12-19 11:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-12-20 04:36</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/resources/mdtest/unpacking.md</code>:476 on 2024-12-20 12:12</div>
            <div class="timeline-body"><p>I&#x27;ve intentionally left out certain test cases, refer to the &quot;Question&quot; in PR description.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:1034 on 2024-12-20 12:12</div>
            <div class="timeline-body"><p>This is basically the same logic as in the assignment statement, I&#x27;m going to wait until I implement unpacking support in other places to get an overview of what can be simplified to avoid repetition.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:209 on 2024-12-20 12:13</div>
            <div class="timeline-body"><p>Inferring the value type is moved in the <code>Unpacker</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_workspace/tests/check.rs</code>:217 on 2024-12-20 12:14</div>
            <div class="timeline-body"><p>This is actually a bug, calling <code>visit_expr</code> on the expression panics in the following case:</p>
<pre><code>[] = *data
() = *data
</code></pre>
<p>This is because in <code>infer_target</code>, we completely skip the inference when there are no elements in the list / tuple target.</p>
<p>I&#x27;m going to fix this in a follow-up.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-12-20 12:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-12-20 12:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-12-20 12:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-12-20 12:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-12-20 12:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-12-20 12:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/unpacking.md</code>:476 on 2024-12-20 21:00</div>
            <div class="timeline-body"><p>I think the tests you have here look good!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-12-20 21:00</div>
            <div class="timeline-body"><p>Awesome!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-12-23 06:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-12-23 06:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-12-23 06:13</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:09:37 UTC
    </footer>
</body>
</html>
