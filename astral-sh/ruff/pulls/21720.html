<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>parser: parsing doublestar as a power op without a left hand side - astral-sh/ruff #21720</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>parser: parsing doublestar as a power op without a left hand side</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21720">#21720</a>
        opened by <a href="https://github.com/11happy">@11happy</a>
        on 2025-12-01 09:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/11happy">@11happy</a></div>
            <div class="timeline-body">

Summary


<p>Parses <code>**</code> Doublestar as power op without lhs, Part of #10653, referred discussion <a href="https://github.com/astral-sh/ruff/pull/10636">astral-sh/ruff#10636</a>#discussion_r1542405830</p>
Test Plan


<p>test case :</p>
<pre><code>{x: **y for x, y in data}
</code></pre>
<p>ruff-dev output before:</p>
<pre><code>Error: Expected an expression at byte range 4..6

Caused by:
    Expected an expression
</code></pre>
<p>ruff-dev output ast after:</p>
<pre><code>Module(
    ModModule {
        node_index: NodeIndex(None),
        range: 0..25,
        body: [
            Expr(
                StmtExpr {
                    node_index: NodeIndex(None),
                    range: 0..25,
                    value: DictComp(
                        ExprDictComp {
                            node_index: NodeIndex(None),
                            range: 0..25,
                            key: Name(
                                ExprName {
                                    node_index: NodeIndex(None),
                                    range: 1..2,
                                    id: Name(&quot;x&quot;),
                                    ctx: Load,
                                },
                            ),
                            value: BinOp(
                                ExprBinOp {
                                    node_index: NodeIndex(None),
                                    range: 4..7,
                                    left: Name(
                                        ExprName {
                                            node_index: NodeIndex(None),
                                            range: 7..7,
                                            id: Name(&quot;&quot;),
                                            ctx: Invalid,
                                        },
                                    ),
                                    op: Pow,
                                    right: Name(
                                        ExprName {
                                            node_index: NodeIndex(None),
                                            range: 6..7,
                                            id: Name(&quot;y&quot;),
                                            ctx: Load,
                                        },
                                    ),
                                },
                            ),
                            generators: [
                                Comprehension {
                                    range: 8..24,
                                    node_index: NodeIndex(None),
                                    target: Tuple(
                                        ExprTuple {
                                            node_index: NodeIndex(None),
                                            range: 12..16,
                                            elts: [
                                                Name(
                                                    ExprName {
                                                        node_index: NodeIndex(None),
                                                        range: 12..13,
                                                        id: Name(&quot;x&quot;),
                                                        ctx: Store,
                                                    },
                                                ),
                                                Name(
                                                    ExprName {
                                                        node_index: NodeIndex(None),
                                                        range: 15..16,
                                                        id: Name(&quot;y&quot;),
                                                        ctx: Store,
                                                    },
                                                ),
                                            ],
                                            ctx: Store,
                                            parenthesized: false,
                                        },
                                    ),
                                    iter: Name(
                                        ExprName {
                                            node_index: NodeIndex(None),
                                            range: 20..24,
                                            id: Name(&quot;data&quot;),
                                            ctx: Load,
                                        },
                                    ),
                                    ifs: [],
                                    is_async: false,
                                },
                            ],
                        },
                    ),
                },
            ),
        ],
    },
)


</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/11happy">@11happy</a> on 2025-12-01 09:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dhruvmanila">@dhruvmanila</a> by <a href="https://github.com/11happy">@11happy</a> on 2025-12-01 09:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-01 09:31</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2025-12-01 10:03</div>
            <div class="timeline-body"><p>Would you mind adding a few parser tests that demonstrate that the new recovery logic works as expected?</p>
<p>E.g., the ecosystem changes suggest that we:</p>
<p>a) Fail to emit a diagnostic in that case
b) or we now use this code path for <code>**kwargs</code> when we shouldn&#x27;t</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-01 10:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/11happy">@11happy</a> on 2025-12-02 07:30</div>
            <div class="timeline-body"><blockquote>
<p>Would you mind adding a few parser tests that demonstrate that the new recovery logic works as expected?</p>
</blockquote>
<blockquote>
<p>E.g., the ecosystem changes suggest that we:</p>
</blockquote>
<blockquote>
<p>a) Fail to emit a diagnostic in that case
b) or we now use this code path for **kwargs when we shouldn&#x27;t</p>
</blockquote>
<p>I have added tests &amp; I think its not the option b, I would appreciate any pointers to move forward</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:382 on 2025-12-05 08:18</div>
            <div class="timeline-body"><p>I&#x27;m not sure if this is the right place for the fix. Would it be possible to add it to <code>parse_binary_expression_or_higher</code> or even in <code>parse_binary_expression_or_higher_recursive</code>? If not, can you explain why?</p>
<p>Moving it their would give you the diagnostic for free</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-12-05 08:19</div>
            <div class="timeline-body"><p>Would you mind changing your PR to use the testing infrastructure described here</p>
<p>https://github.com/astral-sh/ruff/blob/f7bd94bd27eac49db9efa7fbd0b598a3c0cde806/crates/ruff_python_parser/CONTRIBUTING.md?plain=1#L5</p>
<p>Can you also add an example where there&#x27;s some content to the right, e.g. <code>** a + 3 * 2</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/11happy">@11happy</a> reviewed on 2025-12-08 12:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/11happy">@11happy</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:382 on 2025-12-08 12:54</div>
            <div class="timeline-body"><p>I think this might be correct place as we need to detect the missing left operand &amp; in <code>parse_binary_expression_or_higher_recursive</code> the LHS is passed already as a <code>ParsedExpr</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/11happy">@11happy</a> reviewed on 2025-12-08 12:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/11happy">@11happy</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:382 on 2025-12-08 12:56</div>
            <div class="timeline-body"><p>done I have written the inline tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/11happy">@11happy</a> on 2025-12-14 08:27</div>
            <div class="timeline-body"><p>ping!
would appreciate a review : )</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-12-14 09:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:371 on 2025-12-14 09:28</div>
            <div class="timeline-body"><p>This should be an invalid test and the parser should emit a diagnostic</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/11happy">@11happy</a> reviewed on 2025-12-15 07:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/11happy">@11happy</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:371 on 2025-12-15 07:26</div>
            <div class="timeline-body"><p>done
Thank you : )</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:400 on 2026-01-13 10:00</div>
            <div class="timeline-body"><p>I kept wondering why this branch is necessary and, in fact, removing it gives us the desired parsing. So I dont&#x27; think we need to do anything more here other than adding a few tests for it.</p>
<p>However, the tests show that we mess up node ranges somehow:</p>
<pre><code>Module(
    ModModule {
        node_index: NodeIndex(None),
        range: 0..22,
        body: [
            Expr(
                StmtExpr {
                    node_index: NodeIndex(None),
                    range: 0..22,
                    value: DictComp(
                        ExprDictComp {
                            node_index: NodeIndex(None),
                            range: 0..22,
                            key: Name(
                                ExprName {
                                    node_index: NodeIndex(None),
                                    range: 1..2,
                                    id: Name(&quot;x&quot;),
                                    ctx: Load,
                                },
                            ),
                            value: BinOp(
                                ExprBinOp {
                                    node_index: NodeIndex(None),
                                    range: 4..7,
                                    left: Name(
                                        ExprName {
                                            node_index: NodeIndex(None),
                                            range: 3..3,
                                            id: Name(&quot;&quot;),
                                            ctx: Invalid,
                                        },
                                    ),
                                    op: Pow,
                                    right: Name(
                                        ExprName {
                                            node_index: NodeIndex(None),
                                            range: 6..7,
                                            id: Name(&quot;y&quot;),
                                            ctx: Load,
                                        },
                                    ),
                                },
                            ),
                            generators: [
                                Comprehension {
                                    range: 8..21,
                                    node_index: NodeIndex(None),
                                    target: Tuple(
                                        ExprTuple {
                                            node_index: NodeIndex(None),
                                            range: 12..16,
                                            elts: [
                                                Name(
                                                    ExprName {
                                                        node_index: NodeIndex(None),
                                                        range: 12..13,
                                                        id: Name(&quot;x&quot;),
                                                        ctx: Store,
                                                    },
                                                ),
                                                Name(
                                                    ExprName {
                                                        node_index: NodeIndex(None),
                                                        range: 15..16,
                                                        id: Name(&quot;y&quot;),
                                                        ctx: Store,
                                                    },
                                                ),
                                            ],
                                            ctx: Store,
                                            parenthesized: false,
                                        },
                                    ),
                                    iter: Name(
                                        ExprName {
                                            node_index: NodeIndex(None),
                                            range: 20..21,
                                            id: Name(&quot;z&quot;),
                                            ctx: Load,
                                        },
                                    ),
                                    ifs: [],
                                    is_async: false,
                                },
                            ],
                        },
                    ),
                },
            ),
        ],
    },
)
</code></pre>
<p>See how the invalid <code>ExprName</code> has a range of <code>3..3</code> but the <code>ExprBinOp</code> has a range of <code>4..7</code>. Not sure why this is happening</p>
<p>Which I think requires addressing https://github.com/astral-sh/ruff/blob/af623e1f9a0a99a471ab5a3a066bf8f1686e894d/crates/ruff_python_parser/src/parser/mod.rs#L278-L287</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2026-01-13 10:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/11happy">@11happy</a> reviewed on 2026-01-15 09:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/11happy">@11happy</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:400 on 2026-01-15 09:02</div>
            <div class="timeline-body"><p>would you like me to remove this branch &amp; keep the error with tests?
however I would like to point out as you can see in snapshots</p>
<pre><code>value: BinOp(
                                ExprBinOp {
                                    node_index: NodeIndex(None),
                                    range: 47..50,
                                    left: Name(
                                        ExprName {
                                            node_index: NodeIndex(None),
                                            range: 47..47,
                                            id: Name(&quot;&quot;),
                                            ctx: Invalid,
                                        },
                                    ),
                                    op: Pow,
                                    right: Name(
                                        ExprName {
                                            node_index: NodeIndex(None),
                                            range: 49..50,
                                            id: Name(&quot;y&quot;),
                                            ctx: Load,
                                        },
                                    ),
                                },
</code></pre>
<p>here the ranges are identified correctly with current changes,</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2026-01-15 09:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:400 on 2026-01-15 09:04</div>
            <div class="timeline-body"><p>I suggest removing this branch and fixing the underlying issue why the ranges are incorrect. Although I expect this to be somewhat tricky.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/11happy">@11happy</a> on <code>crates/ruff_python_parser/src/parser/expression.rs</code>:400 on 2026-01-15 09:07</div>
            <div class="timeline-body"><p>sure let me investigate on the underlying issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/11happy">@11happy</a> reviewed on 2026-01-15 09:07</div>
            <div class="timeline-body"></div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:21:13 UTC
    </footer>
</body>
</html>
