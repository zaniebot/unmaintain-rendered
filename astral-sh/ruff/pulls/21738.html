<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add token based `parenthesized_ranges` implementation - astral-sh/ruff #21738</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add token based <code>parenthesized_ranges</code> implementation</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21738">#21738</a>
        opened by <a href="https://github.com/denyszhak">@denyszhak</a>
        on 2025-12-01 20:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/denyszhak">@denyszhak</a></div>
            <div class="timeline-body">Summary
<p>Optimizes parenthesized_range by using token slice partitioning to reduce scanning overhead.</p>
<p>Closes #21510</p>
Test Plan
<ol>
<li>Added unit tests for parenthesized_range and parentheses_iterator</li>
<li>Added coverage to ensure behavior matches the previous implementation</li>
</ol>
<p>Acknowledging closed PR #21734 by @FarhanAliRaza for a couple of insights that helped shape the final version.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/denyszhak">@denyszhak</a> on 2025-12-01 20:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/denyszhak">@denyszhak</a> on 2025-12-01 20:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/denyszhak">@denyszhak</a> on 2025-12-01 20:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/denyszhak">@denyszhak</a> on 2025-12-01 20:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/denyszhak">@denyszhak</a> on 2025-12-01 20:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dhruvmanila">@dhruvmanila</a> by <a href="https://github.com/denyszhak">@denyszhak</a> on 2025-12-01 20:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/AlexWaygood">@AlexWaygood</a> removed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-01 20:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-01 20:30</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-01 20:31</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>scikit-build-core (https://github.com/scikit-build/scikit-build-core)
- src/scikit_build_core/build/_pathutil.py:25:38: error[invalid-argument-type] Argument to function `__new__` is incorrect: Expected `str | PathLike[str]`, found `DirEntry[Path]`
- src/scikit_build_core/build/_pathutil.py:27:24: error[invalid-argument-type] Argument to function `__new__` is incorrect: Expected `str | PathLike[str]`, found `DirEntry[Path]`
- src/scikit_build_core/build/wheel.py:98:20: error[no-matching-overload] No overload of bound method `__init__` matches arguments
- Found 44 diagnostics
+ Found 41 diagnostics

pandas-stubs (https://github.com/pandas-dev/pandas-stubs)
- pandas-stubs/_typing.pyi:1207:16: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 5815 diagnostics
+ Found 5814 diagnostics

pydantic (https://github.com/pydantic/pydantic)
- pydantic/fields.py:943:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
+ pydantic/fields.py:943:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
- pydantic/fields.py:983:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
+ pydantic/fields.py:983:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
- pydantic/fields.py:1026:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
+ pydantic/fields.py:1026:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
- pydantic/fields.py:1066:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
+ pydantic/fields.py:1066:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
- pydantic/fields.py:1109:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
+ pydantic/fields.py:1109:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
- pydantic/fields.py:1148:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
+ pydantic/fields.py:1148:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
- pydantic/fields.py:1188:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
+ pydantic/fields.py:1188:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
- pydantic/fields.py:1567:13: error[invalid-argument-type] Argument is incorrect: Expected `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`, found `Top[dict[Unknown, Unknown]] | (((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) &amp; ~Top[dict[Unknown, Unknown]]) | None`
+ pydantic/fields.py:1567:13: error[invalid-argument-type] Argument is incorrect: Expected `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`, found `Top[dict[Unknown, Unknown]] | (((dict[str, Divergent], /) -&gt; None) &amp; ~Top[dict[Unknown, Unknown]]) | None`


</code></pre>


<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-01 20:46</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/lib.rs</code>:86 on 2025-12-02 08:36</div>
            <div class="timeline-body"><p>I would add the method to <code>ruff_python_ast</code>. Ideally (not as part of this PR), we&#x27;d also move <code>Tokens</code> out of <code>ruff_python_parser</code> so that crates that only process the AST but don&#x27;t care about how it was created don&#x27;t have to depend on the parser crate.</p>
<p>I suggest moving this module into <code>ruff_python_ast::tokens</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parenthesize.rs</code>:16 on 2025-12-02 08:38</div>
            <div class="timeline-body"><pre><code>            | TokenKind::NonLogicalNewline
</code></pre>
<p>I think we should remove <code>Dedent</code>, <code>Indent</code>, and <code>Newline</code> as all of those aren&#x27;t trivia. Instead, they have semantic meaning in Python. Are there cases where you had to skip over those to make the two functions behave the same?</p>
<p>If they aren&#x27;t needed for correctness, you can then use <code>token.kind().is_trivia()</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parenthesize.rs</code>:50 on 2025-12-02 08:49</div>
            <div class="timeline-body"><p>Nit: You can rewrite it like this to keep it closer to the original implementation:</p>
<pre><code>    let after_tokens = if let Some(parent) = parent {
        // If the parent is a node that brings its own parentheses, exclude the closing parenthesis
        // from our search range. Otherwise, we risk matching on calls, like `func(x)`, for which
        // the open and close parentheses are part of the `Arguments` node.
        let exclusive_parent_end = if parent.is_arguments() {
            parent.end() - &quot;)&quot;.text_len()
        } else {
            parent.end()
        };

        tokens.in_range(TextRange::new(expr.end(), exclusive_parent_end))
    } else {
        tokens.after(expr.end())
    };
    
    let right_parens = after_tokens
        .iter()
        .filter(|token| !token.kind().is_trivia())
        .take_while(move |token| token.kind() == TokenKind::Rpar);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parenthesize.rs</code>:74 on 2025-12-02 08:50</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast_integration_tests/tests/parenthesize_optimized.rs</code>:1 on 2025-12-02 08:51</div>
            <div class="timeline-body"><p>I can see how those tests were useful during development to gain a better understanding of how the existing implementation works but I&#x27;m inclined to remove the tests now that you have a working implementation (or make them unit tests of <code>optimized_parenthesize</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> requested changes on 2025-12-02 08:52</div>
            <div class="timeline-body"><p>Nice, this looks great. I&#x27;ve a few smaller nit comments but it&#x27;s mostly good to go</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-02 08:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/denyszhak">@denyszhak</a> reviewed on 2025-12-02 14:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/denyszhak">@denyszhak</a> on <code>crates/ruff_python_parser/src/lib.rs</code>:86 on 2025-12-02 14:03</div>
            <div class="timeline-body"><p>New method depends on Tokens, which currently lives in ruff_python_parser. If we move that method into ruff_python_ast without also moving Tokens, then ruff_python_ast would need to depend on ruff_python_parser, creating a circular dependency. Does that sound reasonable or am I interpreting it wrong?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/denyszhak">@denyszhak</a> reviewed on 2025-12-02 14:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/denyszhak">@denyszhak</a> on <code>crates/ruff_python_ast_integration_tests/tests/parenthesize_optimized.rs</code>:1 on 2025-12-02 14:04</div>
            <div class="timeline-body"><p>I&#x27;m going to remove it, original unit tests provide broad coverage in general</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-12-02 15:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/lib.rs</code>:86 on 2025-12-02 15:55</div>
            <div class="timeline-body"><p>Oh hmm, that makes sense. It might be worth moving <code>Tokens</code> as a separate PR if you&#x27;re up to it (I don&#x27;t know how hard that would be)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/denyszhak">@denyszhak</a> reviewed on 2025-12-02 17:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/denyszhak">@denyszhak</a> on <code>crates/ruff_python_parser/src/lib.rs</code>:86 on 2025-12-02 17:13</div>
            <div class="timeline-body"><p>I would love to attempt it in a separate PR and leave this one in ruff_python_parser if you are ok with that</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/denyszhak">@denyszhak</a> reviewed on 2025-12-02 17:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/denyszhak">@denyszhak</a> on <code>crates/ruff_python_ast_integration_tests/tests/parenthesize_optimized.rs</code>:1 on 2025-12-02 17:31</div>
            <div class="timeline-body"><p>done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/denyszhak">@denyszhak</a> reviewed on 2025-12-02 17:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/denyszhak">@denyszhak</a> on <code>crates/ruff_python_parser/src/parenthesize.rs</code>:16 on 2025-12-02 17:39</div>
            <div class="timeline-body"><p>Part of additional kinds I referenced from SimpleTokenKind is_trivia, but part of it from the PR I referenced above thinking I have missed those. It doesn&#x27;t influence correctness at least for the tests I added.</p>
<p>I changed to using <code>oken.kind().is_trivia()</code> as you suggested because now I think mimicking SimpleTokenKind.is_trivia was the wrong move</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/denyszhak">@denyszhak</a> on 2025-12-02 21:48</div>
            <div class="timeline-body"><p>@MichaReiser this one should be ready for you to review again</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/amyreese">@amyreese</a> on 2025-12-02 23:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;feat: optimize parenthesized_range&quot; to &quot;Add token based `parenthesized_ranges` implementation&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-03 08:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-12-03 08:09</div>
            <div class="timeline-body"><p>Thanks, this is great.</p>
<p>If you&#x27;re interested, it would be great if we could rewrite the calls to <code>parenthesized_range</code> in <code>ruff_linter</code> to use your new implementation</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-03 08:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-03 08:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/denyszhak">@denyszhak</a> on 2025-12-03 09:52</div>
            <div class="timeline-body"><blockquote>
<p>Thanks, this is great.</p>
<p>If you&#x27;re interested, it would be great if we could rewrite the calls to <code>parenthesized_range</code> in <code>ruff_linter</code> to use your new implementation</p>
</blockquote>
<p>I&#x27;m definitely interested, let me prepare a PR for this, I will create an issue and link it there</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:21:16 UTC
    </footer>
</body>
</html>
