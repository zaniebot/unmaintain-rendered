<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use the common `OperatorPrecedence` for the parser - astral-sh/ruff #16747</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use the common <code>OperatorPrecedence</code> for the parser</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16747">#16747</a>
        opened by <a href="https://github.com/junhsonjb">@junhsonjb</a>
        on 2025-03-14 13:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/junhsonjb">@junhsonjb</a></div>
            <div class="timeline-body">Summary
<p>This change continues to resolve #16071 (and continues the work started in #16162). Specifically, this PR changes the code in the parser so that it uses the <code>OperatorPrecedence</code> struct from <code>ruff_python_ast</code> instead of its own version. This is part of an effort to get rid of the redundant definitions of <code>OperatorPrecedence</code> throughout the codebase.</p>
<p>Note that this PR only makes this change for <code>ruff_python_parser</code> -- we still want to make a similar change for the formatter (namely the <code>OperatorPrecedence</code> defined in the expression part of the formatter, the pattern one is different). I separated the work to keep the PRs small and easily reviewable.</p>
Test Plan
<p>Because this is an internal change, I didn&#x27;t add any additional tests. Existing tests do pass.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/junhsonjb">@junhsonjb</a> on 2025-03-14 13:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dhruvmanila">@dhruvmanila</a> by <a href="https://github.com/junhsonjb">@junhsonjb</a> on 2025-03-14 13:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-14 13:45</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>‚úÖ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>‚úÖ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>‚úÖ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>‚úÖ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-14 13:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-14 13:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-18 05:31</div>
            <div class="timeline-body"><blockquote>
<p>It&#x27;s worth noting however, that this change did have a slight impact on snapshot results. The removed defintion of <code>OperatorPrecedence</code> had separate enum variants <code>BitOr</code> and <code>BitXor</code>. This differs from the newer version of <code>OperatorPrecedence</code> which keeps both operators on the same level with <code>BitXorOr</code>.</p>
</blockquote>
<p>Why does the newer version does not have them as separate variants? As per the <a href="https://docs.python.org/3/reference/expressions.html#operator-precedence">documentation on operator precedence</a>, they should be separate.</p>
<p>It can be seen in the AST printed by the CPython parser that the overall expression is indeed a bitwise-or expression and not a bitwise-xor expression as is in the updated snapshot:</p>
<pre><code>‚ùØ echo &quot;1 | 2 &amp; 3 ^ 4 + 5 @ 6 &lt;&lt; 7 // 8 &gt;&gt; 9&quot; | uv run python -m ast -
Module(
   body=[
      Expr(
         value=BinOp(
            left=Constant(value=1),
            op=BitOr(),
            right=BinOp(
               left=BinOp(
                  left=Constant(value=2),
                  op=BitAnd(),
                  right=Constant(value=3)),
               op=BitXor(),
               right=BinOp(
                  left=BinOp(
                     left=BinOp(
                        left=Constant(value=4),
                        op=Add(),
                        right=BinOp(
                           left=Constant(value=5),
                           op=MatMult(),
                           right=Constant(value=6))),
                     op=LShift(),
                     right=BinOp(
                        left=Constant(value=7),
                        op=FloorDiv(),
                        right=Constant(value=8))),
                  op=RShift(),
                  right=Constant(value=9)))))])
</code></pre>
<p>This looks like a bug to me and should be fixed first.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/junhsonjb">@junhsonjb</a> on 2025-03-19 12:20</div>
            <div class="timeline-body"><p>@dhruvmanila You make a great point, I&#x27;ll get started on a fix for this! I am curious, though, about the motivation for giving <code>BitXor</code> and <code>BitOr</code> the same precedence in the first place. The code that does this was originally in the linter crate -- do you know if was there a reason for doing that?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/junhsonjb">@junhsonjb</a> on 2025-03-19 13:27</div>
            <div class="timeline-body"><p>@dhruvmanila @MichaReiser The patch for the requested bug-fix is in #16844  (pinging because the PR didn&#x27;t automatically add reviewers so I wanted to make sure it doesn&#x27;t get buried üôÇ)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-20 10:57</div>
            <div class="timeline-body"><p>@junhsonjb Thanks for fixing the highlighted issue! Can you rebase it on latest main? I think otherwise the PR looks good.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-03-20 15:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-20 15:28</div>
            <div class="timeline-body"><p>Looks good to me. I&#x27;ll leave the final review to @dhruvmanila because he&#x27;s our parser expert.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-03-21 04:08</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[internal] Use `ruff_python_ast::OperatorPrecedence` in Parser (`ruff_python_parser`)&quot; to &quot;Use the common `OperatorPrecedence` for the parser&quot; by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-21 04:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-21 04:10</div>
            <div class="timeline-body"><p>I removed the now fixed issue about bitwise precedence from the PR description as it&#x27;s used for the commit message as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-21 04:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-03-21 04:10</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:12:21 UTC
    </footer>
</body>
</html>
