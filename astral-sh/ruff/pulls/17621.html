<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] fix detecting a metaclass on a not-explicitly-specialized generic base - astral-sh/ruff #17621</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] fix detecting a metaclass on a not-explicitly-specialized generic base</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17621">#17621</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2025-04-25 01:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/carljm">@carljm</a> on 2025-04-25 01:37</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>After https://github.com/astral-sh/ruff/pull/17620 (which this PR is based on), I was looking at other call sites of <code>Type::into_class_type</code>, and I began to feel that <em>all</em> of them were currently buggy due to silently skipping unspecialized generic class literal types (though in some cases the bug hadn't shown up yet because we don't understand legacy generic classes from typeshed), and in every case they would be better off if an unspecialized generic class literal were implicitly specialized with the default specialization (which is the usual Python typing semantics for an unspecialized reference to a generic class), instead of silently skipped.</p>
<p>So I changed the method to implicitly apply the default specialization, and added a test that previously failed for detecting metaclasses on an unspecialized generic base.</p>
<p>I also renamed the method to <code>to_class_type</code>, because I feel we have a strong naming convention where <code>Type::into_foo</code> is always a trivial <code>const fn</code> that simply returns <code>Some()</code> if the type is of variant <code>Foo</code> and <code>None</code> otherwise. Even the existing method (with it handling both <code>GenericAlias</code> and <code>ClassLiteral</code>, and distinguishing kinds of <code>ClassLiteral</code>) was stretching this convention, and the new version definitely breaks that envelope.</p>
<h2>Test Plan</h2>
<p>Added a test that failed before this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @carljm on 2025-04-25 01:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @carljm on 2025-04-25 01:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @carljm on 2025-04-25 01:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @carljm on 2025-04-25 01:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-25 01:42</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-04-25 13:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @carljm on 2025-04-25 13:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-04-25 13:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-25 13:55</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:33:29 UTC
    </footer>
</body>
</html>
