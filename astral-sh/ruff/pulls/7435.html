<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refactor `tab-indentation` as a token-based rule - astral-sh/ruff #7435</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Refactor <code>tab-indentation</code> as a token-based rule</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7435">#7435</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2023-09-16 13:09
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body">Summary
<p>This PR updates the <code>W191</code> (<code>tab-indentation</code>) rule from a line-based to a
token-based rule.</p>
<p>Earlier, the rule used the <code>triple_quoted_string_ranges</code> from the indexer to
skip over any lines <em>inside</em> a triple-quoted string. This was the only use of
the ranges. These ranges were extracted through the tokens, so instead we can
directly use the newline tokens to perform the check.</p>
<p>This would also mean that we can remove the <code>triple_quoted_string_ranges</code> from
the indexer but I&#x27;ll hold that off until we have a better idea on #7326 but I
don&#x27;t think it would be a problem to remove it.</p>
<p>This will also fix #7379 once PEP 701 changes are merged.</p>
Test Plan
<p><code>cargo test</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-16 13:09</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #7435</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7435"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7435?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-16 13:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/pycodestyle/rules/tab_indentation.rs</code>:77 on 2023-09-16 13:26</div>
            <div class="timeline-body"><p>We could probably do the leading_indentation and tab find in one pass, via <code>take_while</code> and <code>find</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-09-16 13:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-09-16 13:27</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>âœ… ecosystem check detected no changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/pycodestyle/rules/tab_indentation.rs</code>:66 on 2023-09-16 14:16</div>
            <div class="timeline-body"><p>Can we add a comment why this is necessary? I understand is that the lexer emits a <code>Newline</code> or <code>NonLogicalNewline</code> token for every <code>\n</code>. Is this to capture tab indentation inside multiline strings?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-09-16 14:16</div>
            <div class="timeline-body"><p>Nice</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-09-16 19:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/rules/pycodestyle/rules/tab_indentation.rs</code>:66 on 2023-09-16 19:33</div>
            <div class="timeline-body"><p>The lexer doesn&#x27;t emit <code>Newline</code> / <code>NonLogicalNewline</code> for a line continuation. So, for the following code snippet where there&#x27;s a tab indentation before the <code>or</code> token:</p>
<pre><code>x \
	or y
</code></pre>
<p>The lexer will emit:</p>
<pre><code>Name { name: &quot;x&quot; }
Or
Name { name: &quot;y&quot; }
Newline
</code></pre>
<p>This is to capture tab indentation for multi-line expression separated using a line continuation character.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-09-16 19:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/pycodestyle/rules/tab_indentation.rs</code>:66 on 2023-09-16 19:38</div>
            <div class="timeline-body"><p>What happens if you have a continuation within a single-quoted or triple-quoted string?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-09-16 19:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/rules/pycodestyle/rules/tab_indentation.rs</code>:77 on 2023-09-16 19:48</div>
            <div class="timeline-body"><p>I tried this but we need the indent length for the diagnostic range:</p>
<pre><code>TextRange::at(line_start, indent.text_len())
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-09-16 19:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/rules/pycodestyle/rules/tab_indentation.rs</code>:66 on 2023-09-16 19:50</div>
            <div class="timeline-body"><p>We don&#x27;t check for tab indentation inside a string and the lexer captures the entire string as a single token.</p>
<p>This was the use-case of <code>triple_quoted_string_ranges</code> earlier where if the offset is part of a triple-quoted string, then we would skip it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-09-16 19:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/rules/pycodestyle/rules/tab_indentation.rs</code>:66 on 2023-09-16 19:54</div>
            <div class="timeline-body"><p>So, I guess an example like:</p>
<pre><code>	&quot;&quot;&quot;first line (tab indented start quoted)
	&lt;-- tab indentation
&quot;&quot;&quot;
</code></pre>
<p>would only emit a diagnostic for the first line and not the second line as that&#x27;s part of the string.</p>
<p>Oh, wait the new logic wouldn&#x27;t detect the first line as there&#x27;s no newline before that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-09-16 19:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/rules/pycodestyle/rules/tab_indentation.rs</code>:66 on 2023-09-16 19:55</div>
            <div class="timeline-body"><p>We&#x27;ll have to special case the first line to be checked every single time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2023-09-16 20:00</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/dhruv/tab-indentation-using-tok">CodSpeed Performance Report</a>
Merging #7435 will <strong>not alter performance</strong>
<p>Comparing <code>dhruv/tab-indentation-using-tok</code> (c025c41) with <code>main</code> (422ff82)</p>
Summary
<p><code>âœ… 25</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-09-16 20:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/rules/pycodestyle/rules/tab_indentation.rs</code>:66 on 2023-09-16 20:04</div>
            <div class="timeline-body"><p>Ok, I&#x27;ve updated to always check for the first line and added a test case for it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-16 20:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-16 20:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-16 20:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-16 20:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-09-16 20:25</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:57:21 UTC
    </footer>
</body>
</html>
