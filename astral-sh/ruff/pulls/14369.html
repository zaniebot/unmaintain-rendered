<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`perflint`] fix invalid hoist in `perf401` - astral-sh/ruff #14369</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>perflint</code>] fix invalid hoist in <code>perf401</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14369">#14369</a>
        opened by <a href="https://github.com/w0nder1ng">@w0nder1ng</a>
        on 2024-11-15 21:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/w0nder1ng">@w0nder1ng</a></div>
            <div class="timeline-body"><p>This should fix #14362. This new fix currently deletes lines like this:</p>
<pre><code class="language-python">- tmp = 1; result = []
- for i in range(10):
-   result.append(i+1)
+ result = [i+1 for i in range(10)]
</code></pre>
<p>Is there a convenient way to get every statement within a given <code>TextRange</code> to detect when this is happening?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-15 21:17</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>‚ÑπÔ∏è ecosystem check <strong>detected linter changes</strong>. (+18 -20 violations, +0 -0 fixes in 5 projects; 50 projects unchanged)</p>
<details><summary><a href="https://github.com/apache/airflow">apache/airflow</a> (+6 -6 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --no-preview --select ALL</pre>
</p>
<p>

<pre>
- <a href='https://github.com/apache/airflow/blob/3e2b5e2f54ea3b3695e6576313f87460fb098830/dev/breeze/src/airflow_breeze/commands/release_management_commands.py#L3074'>dev/breeze/src/airflow_breeze/commands/release_management_commands.py:3074:9:</a> PERF401 Use `list.extend` to create a transformed list
+ <a href='https://github.com/apache/airflow/blob/3e2b5e2f54ea3b3695e6576313f87460fb098830/dev/breeze/src/airflow_breeze/commands/release_management_commands.py#L3074'>dev/breeze/src/airflow_breeze/commands/release_management_commands.py:3074:9:</a> PERF401 Use a list comprehension to create a transformed list
- <a href='https://github.com/apache/airflow/blob/3e2b5e2f54ea3b3695e6576313f87460fb098830/dev/breeze/src/airflow_breeze/utils/exclude_from_matrix.py#L32'>dev/breeze/src/airflow_breeze/utils/exclude_from_matrix.py:32:9:</a> PERF401 Use `list.extend` to create a transformed list
+ <a href='https://github.com/apache/airflow/blob/3e2b5e2f54ea3b3695e6576313f87460fb098830/dev/breeze/src/airflow_breeze/utils/exclude_from_matrix.py#L32'>dev/breeze/src/airflow_breeze/utils/exclude_from_matrix.py:32:9:</a> PERF401 Use a list comprehension to create a transformed list
- <a href='https://github.com/apache/airflow/blob/3e2b5e2f54ea3b3695e6576313f87460fb098830/dev/breeze/src/airflow_breeze/utils/packages.py#L327'>dev/breeze/src/airflow_breeze/utils/packages.py:327:9:</a> PERF401 Use `list.extend` to create a transformed list
+ <a href='https://github.com/apache/airflow/blob/3e2b5e2f54ea3b3695e6576313f87460fb098830/dev/breeze/src/airflow_breeze/utils/packages.py#L327'>dev/breeze/src/airflow_breeze/utils/packages.py:327:9:</a> PERF401 Use a list comprehension to create a transformed list
- <a href='https://github.com/apache/airflow/blob/3e2b5e2f54ea3b3695e6576313f87460fb098830/docs/exts/docs_build/fetch_inventories.py#L103'>docs/exts/docs_build/fetch_inventories.py:103:9:</a> PERF401 Use `list.extend` to create a transformed list
+ <a href='https://github.com/apache/airflow/blob/3e2b5e2f54ea3b3695e6576313f87460fb098830/docs/exts/docs_build/fetch_inventories.py#L103'>docs/exts/docs_build/fetch_inventories.py:103:9:</a> PERF401 Use a list comprehension to create a transformed list
- <a href='https://github.com/apache/airflow/blob/3e2b5e2f54ea3b3695e6576313f87460fb098830/providers/src/airflow/providers/microsoft/azure/hooks/wasb.py#L721'>providers/src/airflow/providers/microsoft/azure/hooks/wasb.py:721:13:</a> PERF401 Use `list.extend` with an async comprehension to create a transformed list
+ <a href='https://github.com/apache/airflow/blob/3e2b5e2f54ea3b3695e6576313f87460fb098830/providers/src/airflow/providers/microsoft/azure/hooks/wasb.py#L721'>providers/src/airflow/providers/microsoft/azure/hooks/wasb.py:721:13:</a> PERF401 Use an async list comprehension to create a transformed list
- <a href='https://github.com/apache/airflow/blob/3e2b5e2f54ea3b3695e6576313f87460fb098830/scripts/in_container/update_quarantined_test_status.py#L81'>scripts/in_container/update_quarantined_test_status.py:81:13:</a> PERF401 Use `list.extend` to create a transformed list
+ <a href='https://github.com/apache/airflow/blob/3e2b5e2f54ea3b3695e6576313f87460fb098830/scripts/in_container/update_quarantined_test_status.py#L81'>scripts/in_container/update_quarantined_test_status.py:81:13:</a> PERF401 Use a list comprehension to create a transformed list
</pre>

</p>
</details>
<details><summary><a href="https://github.com/apache/superset">apache/superset</a> (+8 -8 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --no-preview --select ALL</pre>
</p>
<p>

<pre>
- <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/superset/db_engine_specs/base.py#L107'>superset/db_engine_specs/base.py:107:9:</a> PERF401 Use `list.extend` to create a transformed list
+ <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/superset/db_engine_specs/base.py#L107'>superset/db_engine_specs/base.py:107:9:</a> PERF401 Use a list comprehension to create a transformed list
+ <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/superset/db_engine_specs/lib.py#L245'>superset/db_engine_specs/lib.py:245:9:</a> PERF401 Use `list.extend` to create a transformed list
- <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/superset/db_engine_specs/lib.py#L245'>superset/db_engine_specs/lib.py:245:9:</a> PERF401 Use a list comprehension to create a transformed list
+ <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/superset/db_engine_specs/lib.py#L251'>superset/db_engine_specs/lib.py:251:9:</a> PERF401 Use `list.extend` to create a transformed list
- <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/superset/db_engine_specs/lib.py#L251'>superset/db_engine_specs/lib.py:251:9:</a> PERF401 Use a list comprehension to create a transformed list
+ <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/superset/db_engine_specs/lib.py#L261'>superset/db_engine_specs/lib.py:261:9:</a> PERF401 Use `list.extend` to create a transformed list
- <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/superset/db_engine_specs/lib.py#L261'>superset/db_engine_specs/lib.py:261:9:</a> PERF401 Use a list comprehension to create a transformed list
+ <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/superset/db_engine_specs/lib.py#L281'>superset/db_engine_specs/lib.py:281:9:</a> PERF401 Use `list.extend` to create a transformed list
- <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/superset/db_engine_specs/lib.py#L281'>superset/db_engine_specs/lib.py:281:9:</a> PERF401 Use a list comprehension to create a transformed list
+ <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/superset/db_engine_specs/lib.py#L293'>superset/db_engine_specs/lib.py:293:9:</a> PERF401 Use `list.extend` to create a transformed list
- <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/superset/db_engine_specs/lib.py#L293'>superset/db_engine_specs/lib.py:293:9:</a> PERF401 Use a list comprehension to create a transformed list
+ <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/superset/tasks/cache.py#L208'>superset/tasks/cache.py:208:13:</a> PERF401 Use `list.extend` to create a transformed list
- <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/superset/tasks/cache.py#L208'>superset/tasks/cache.py:208:13:</a> PERF401 Use a list comprehension to create a transformed list
+ <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/tests/integration_tests/security/migrate_roles_tests.py#L50'>tests/integration_tests/security/migrate_roles_tests.py:50:13:</a> PERF401 Use `list.extend` to create a transformed list
- <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/tests/integration_tests/security/migrate_roles_tests.py#L50'>tests/integration_tests/security/migrate_roles_tests.py:50:13:</a> PERF401 Use a list comprehension to create a transformed list
</pre>

</p>
</details>
<details><summary><a href="https://github.com/bokeh/bokeh">bokeh/bokeh</a> (+1 -3 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --no-preview --select ALL</pre>
</p>
<p>

<pre>
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/plotting/_figure.py#L479'>src/bokeh/plotting/_figure.py:479:17:</a> PERF401 Use `list.extend` to create a transformed list
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/plotting/_figure.py#L485'>src/bokeh/plotting/_figure.py:485:17:</a> PERF401 Use `list.extend` to create a transformed list
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/server/contexts.py#L310'>src/bokeh/server/contexts.py:310:17:</a> PERF401 Use `list.extend` to create a transformed list
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/server/contexts.py#L310'>src/bokeh/server/contexts.py:310:17:</a> PERF401 Use a list comprehension to create a transformed list
</pre>

</p>
</details>
<details><summary><a href="https://github.com/latchbio/latch">latchbio/latch</a> (+3 -3 violations, +0 -0 fixes)</summary>
<p>

<pre>
- <a href='https://github.com/latchbio/latch/blob/d7694f55d377f295472120076c8d7f3d3f0732bd/src/latch/ldata/_transfer/upload.py#L163'>src/latch/ldata/_transfer/upload.py:163:25:</a> PERF401 Use `list.extend` to create a transformed list
+ <a href='https://github.com/latchbio/latch/blob/d7694f55d377f295472120076c8d7f3d3f0732bd/src/latch/ldata/_transfer/upload.py#L163'>src/latch/ldata/_transfer/upload.py:163:25:</a> PERF401 Use a list comprehension to create a transformed list
- <a href='https://github.com/latchbio/latch/blob/d7694f55d377f295472120076c8d7f3d3f0732bd/src/latch/registry/utils.py#L70'>src/latch/registry/utils.py:70:13:</a> PERF401 Use `list.extend` to create a transformed list
+ <a href='https://github.com/latchbio/latch/blob/d7694f55d377f295472120076c8d7f3d3f0732bd/src/latch/registry/utils.py#L70'>src/latch/registry/utils.py:70:13:</a> PERF401 Use a list comprehension to create a transformed list
- <a href='https://github.com/latchbio/latch/blob/d7694f55d377f295472120076c8d7f3d3f0732bd/src/latch_cli/services/cp/utils.py#L54'>src/latch_cli/services/cp/utils.py:54:9:</a> PERF401 Use `list.extend` to create a transformed list
+ <a href='https://github.com/latchbio/latch/blob/d7694f55d377f295472120076c8d7f3d3f0732bd/src/latch_cli/services/cp/utils.py#L54'>src/latch_cli/services/cp/utils.py:54:9:</a> PERF401 Use a list comprehension to create a transformed list
</pre>

</p>
</details>
<details><summary><a href="https://github.com/pandas-dev/pandas">pandas-dev/pandas</a> (+0 -0 violations, +0 -0 fixes)</summary>
<p>

<pre>
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PERF401 | 38 | 18 | 20 | 0 | 0 |</p>
</p>
</details>

<h3>Linter (preview)</h3>
<p>‚ÑπÔ∏è ecosystem check <strong>detected linter changes</strong>. (+18 -20 violations, +0 -0 fixes in 4 projects; 51 projects unchanged)</p>
<details><summary><a href="https://github.com/apache/airflow">apache/airflow</a> (+6 -6 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
- <a href='https://github.com/apache/airflow/blob/3e2b5e2f54ea3b3695e6576313f87460fb098830/dev/breeze/src/airflow_breeze/commands/release_management_commands.py#L3074'>dev/breeze/src/airflow_breeze/commands/release_management_commands.py:3074:9:</a> PERF401 Use `list.extend` to create a transformed list
+ <a href='https://github.com/apache/airflow/blob/3e2b5e2f54ea3b3695e6576313f87460fb098830/dev/breeze/src/airflow_breeze/commands/release_management_commands.py#L3074'>dev/breeze/src/airflow_breeze/commands/release_management_commands.py:3074:9:</a> PERF401 Use a list comprehension to create a transformed list
- <a href='https://github.com/apache/airflow/blob/3e2b5e2f54ea3b3695e6576313f87460fb098830/dev/breeze/src/airflow_breeze/utils/exclude_from_matrix.py#L32'>dev/breeze/src/airflow_breeze/utils/exclude_from_matrix.py:32:9:</a> PERF401 Use `list.extend` to create a transformed list
+ <a href='https://github.com/apache/airflow/blob/3e2b5e2f54ea3b3695e6576313f87460fb098830/dev/breeze/src/airflow_breeze/utils/exclude_from_matrix.py#L32'>dev/breeze/src/airflow_breeze/utils/exclude_from_matrix.py:32:9:</a> PERF401 Use a list comprehension to create a transformed list
- <a href='https://github.com/apache/airflow/blob/3e2b5e2f54ea3b3695e6576313f87460fb098830/dev/breeze/src/airflow_breeze/utils/packages.py#L327'>dev/breeze/src/airflow_breeze/utils/packages.py:327:9:</a> PERF401 Use `list.extend` to create a transformed list
+ <a href='https://github.com/apache/airflow/blob/3e2b5e2f54ea3b3695e6576313f87460fb098830/dev/breeze/src/airflow_breeze/utils/packages.py#L327'>dev/breeze/src/airflow_breeze/utils/packages.py:327:9:</a> PERF401 Use a list comprehension to create a transformed list
- <a href='https://github.com/apache/airflow/blob/3e2b5e2f54ea3b3695e6576313f87460fb098830/docs/exts/docs_build/fetch_inventories.py#L103'>docs/exts/docs_build/fetch_inventories.py:103:9:</a> PERF401 Use `list.extend` to create a transformed list
+ <a href='https://github.com/apache/airflow/blob/3e2b5e2f54ea3b3695e6576313f87460fb098830/docs/exts/docs_build/fetch_inventories.py#L103'>docs/exts/docs_build/fetch_inventories.py:103:9:</a> PERF401 Use a list comprehension to create a transformed list
- <a href='https://github.com/apache/airflow/blob/3e2b5e2f54ea3b3695e6576313f87460fb098830/providers/src/airflow/providers/microsoft/azure/hooks/wasb.py#L721'>providers/src/airflow/providers/microsoft/azure/hooks/wasb.py:721:13:</a> PERF401 Use `list.extend` with an async comprehension to create a transformed list
+ <a href='https://github.com/apache/airflow/blob/3e2b5e2f54ea3b3695e6576313f87460fb098830/providers/src/airflow/providers/microsoft/azure/hooks/wasb.py#L721'>providers/src/airflow/providers/microsoft/azure/hooks/wasb.py:721:13:</a> PERF401 Use an async list comprehension to create a transformed list
- <a href='https://github.com/apache/airflow/blob/3e2b5e2f54ea3b3695e6576313f87460fb098830/scripts/in_container/update_quarantined_test_status.py#L81'>scripts/in_container/update_quarantined_test_status.py:81:13:</a> PERF401 Use `list.extend` to create a transformed list
+ <a href='https://github.com/apache/airflow/blob/3e2b5e2f54ea3b3695e6576313f87460fb098830/scripts/in_container/update_quarantined_test_status.py#L81'>scripts/in_container/update_quarantined_test_status.py:81:13:</a> PERF401 Use a list comprehension to create a transformed list
</pre>

</p>
</details>
<details><summary><a href="https://github.com/apache/superset">apache/superset</a> (+8 -8 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
- <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/superset/db_engine_specs/base.py#L107'>superset/db_engine_specs/base.py:107:9:</a> PERF401 Use `list.extend` to create a transformed list
+ <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/superset/db_engine_specs/base.py#L107'>superset/db_engine_specs/base.py:107:9:</a> PERF401 Use a list comprehension to create a transformed list
+ <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/superset/db_engine_specs/lib.py#L245'>superset/db_engine_specs/lib.py:245:9:</a> PERF401 Use `list.extend` to create a transformed list
- <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/superset/db_engine_specs/lib.py#L245'>superset/db_engine_specs/lib.py:245:9:</a> PERF401 Use a list comprehension to create a transformed list
+ <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/superset/db_engine_specs/lib.py#L251'>superset/db_engine_specs/lib.py:251:9:</a> PERF401 Use `list.extend` to create a transformed list
- <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/superset/db_engine_specs/lib.py#L251'>superset/db_engine_specs/lib.py:251:9:</a> PERF401 Use a list comprehension to create a transformed list
+ <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/superset/db_engine_specs/lib.py#L261'>superset/db_engine_specs/lib.py:261:9:</a> PERF401 Use `list.extend` to create a transformed list
- <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/superset/db_engine_specs/lib.py#L261'>superset/db_engine_specs/lib.py:261:9:</a> PERF401 Use a list comprehension to create a transformed list
+ <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/superset/db_engine_specs/lib.py#L281'>superset/db_engine_specs/lib.py:281:9:</a> PERF401 Use `list.extend` to create a transformed list
- <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/superset/db_engine_specs/lib.py#L281'>superset/db_engine_specs/lib.py:281:9:</a> PERF401 Use a list comprehension to create a transformed list
+ <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/superset/db_engine_specs/lib.py#L293'>superset/db_engine_specs/lib.py:293:9:</a> PERF401 Use `list.extend` to create a transformed list
- <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/superset/db_engine_specs/lib.py#L293'>superset/db_engine_specs/lib.py:293:9:</a> PERF401 Use a list comprehension to create a transformed list
+ <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/superset/tasks/cache.py#L208'>superset/tasks/cache.py:208:13:</a> PERF401 Use `list.extend` to create a transformed list
- <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/superset/tasks/cache.py#L208'>superset/tasks/cache.py:208:13:</a> PERF401 Use a list comprehension to create a transformed list
+ <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/tests/integration_tests/security/migrate_roles_tests.py#L50'>tests/integration_tests/security/migrate_roles_tests.py:50:13:</a> PERF401 Use `list.extend` to create a transformed list
- <a href='https://github.com/apache/superset/blob/423a0fefa5e024db9fbf75301997c511b3ec992f/tests/integration_tests/security/migrate_roles_tests.py#L50'>tests/integration_tests/security/migrate_roles_tests.py:50:13:</a> PERF401 Use a list comprehension to create a transformed list
</pre>

</p>
</details>
<details><summary><a href="https://github.com/bokeh/bokeh">bokeh/bokeh</a> (+1 -3 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/plotting/_figure.py#L479'>src/bokeh/plotting/_figure.py:479:17:</a> PERF401 Use `list.extend` to create a transformed list
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/plotting/_figure.py#L485'>src/bokeh/plotting/_figure.py:485:17:</a> PERF401 Use `list.extend` to create a transformed list
- <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/server/contexts.py#L310'>src/bokeh/server/contexts.py:310:17:</a> PERF401 Use `list.extend` to create a transformed list
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/server/contexts.py#L310'>src/bokeh/server/contexts.py:310:17:</a> PERF401 Use a list comprehension to create a transformed list
</pre>

</p>
</details>
<details><summary><a href="https://github.com/latchbio/latch">latchbio/latch</a> (+3 -3 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
- <a href='https://github.com/latchbio/latch/blob/d7694f55d377f295472120076c8d7f3d3f0732bd/src/latch/ldata/_transfer/upload.py#L163'>src/latch/ldata/_transfer/upload.py:163:25:</a> PERF401 Use `list.extend` to create a transformed list
+ <a href='https://github.com/latchbio/latch/blob/d7694f55d377f295472120076c8d7f3d3f0732bd/src/latch/ldata/_transfer/upload.py#L163'>src/latch/ldata/_transfer/upload.py:163:25:</a> PERF401 Use a list comprehension to create a transformed list
- <a href='https://github.com/latchbio/latch/blob/d7694f55d377f295472120076c8d7f3d3f0732bd/src/latch/registry/utils.py#L70'>src/latch/registry/utils.py:70:13:</a> PERF401 Use `list.extend` to create a transformed list
+ <a href='https://github.com/latchbio/latch/blob/d7694f55d377f295472120076c8d7f3d3f0732bd/src/latch/registry/utils.py#L70'>src/latch/registry/utils.py:70:13:</a> PERF401 Use a list comprehension to create a transformed list
- <a href='https://github.com/latchbio/latch/blob/d7694f55d377f295472120076c8d7f3d3f0732bd/src/latch_cli/services/cp/utils.py#L54'>src/latch_cli/services/cp/utils.py:54:9:</a> PERF401 Use `list.extend` to create a transformed list
+ <a href='https://github.com/latchbio/latch/blob/d7694f55d377f295472120076c8d7f3d3f0732bd/src/latch_cli/services/cp/utils.py#L54'>src/latch_cli/services/cp/utils.py:54:9:</a> PERF401 Use a list comprehension to create a transformed list
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PERF401 | 38 | 18 | 20 | 0 | 0 |</p>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-11-16 18:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @charliermarsh on 2024-11-16 18:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Skylion007">@Skylion007</a> on 2024-11-17 17:25</div>
            <div class="timeline-body"><p>@w0nder1ng Another fun edge case that PR #14369 doesn't currently fix. Scoping rules are different between list comprehensions and for loops:</p>
<p>another example from pytorch</p>
<pre><code class="language-diff">     if kwargs is None:
         kwargs = {}
-    impl_args = []
-    for a in args:
-        impl_args.append(_helper(a, map_fn))
+    impl_args = [_helper(a, map_fn) for a in args]
     impl_kwargs = {}
     for k in kwargs.keys():
         impl_kwargs[k] = _helper(a, map_fn)
</code></pre>
<p>the <code>a</code> on the line <code>impl_kwargs[k] = _helper(a, map_fn)</code> is now undefined (and will error with F821) since the list comprehension was converted from a loop. RUFF immeaditely flags this with an F821 error, and I test and confirm the temporary variable <code>a</code> does not leave the listcomp scope, while it does leave the for loop one.</p>
<p>@w0nder1ng If you want a good test bed, just run the autofix on PyTorch (or another large codebase) and see after applying the fixes if any other ruff rule violations are immediately detected.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Skylion007">@Skylion007</a> on 2024-11-17 17:29</div>
            <div class="timeline-body"><p>Also another really minor nit is that it can duplicate comments.</p>
<pre><code class="language-diff">-        for dtype in [&quot;f16&quot;, &quot;bf16&quot;]:
-            kernels.append(
-                cls(
-                    aligned=True,
-                    dtype=dtype,
-                    sm_range=(80, SM[SM.index(80) + 1]),
-                    apply_dropout=False,
-                    preload_mmas=True,
-                    block_i=128,
-                    block_j=64,
-                    max_k=96,
-                    # Sm80 has a faster kernel for this case
-                    dispatch_cond=&quot;cc == 86 || cc == 89&quot;,
-                )
+        # Sm80 has a faster kernel for this case
+        kernels.extend(
+            cls(
+                aligned=True,
+                dtype=dtype,
+                sm_range=(80, SM[SM.index(80) + 1]),
+                apply_dropout=False,
+                preload_mmas=True,
+                block_i=128,
+                block_j=64,
+                max_k=96,
+                # Sm80 has a faster kernel for this case
+                dispatch_cond=&quot;cc == 86 || cc == 89&quot;,
             )
+            for dtype in [&quot;f16&quot;, &quot;bf16&quot;]
+        )
</code></pre>
<p>See here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/w0nder1ng">@w0nder1ng</a> on 2024-11-17 22:02</div>
            <div class="timeline-body"><blockquote>
<p>Another fun edge case that PR https://github.com/astral-sh/ruff/pull/14369 doesn't currently fix</p>
</blockquote>
<p>I think in this case, the lint shouldn't apply at all. If applying the fix breaks the code, then someone manually doing the same thing also wouldn't work. It should probably check that all references to the loop variable are inside the for loop before reporting the lint.</p>
<p>I'll also try to fix the duplicate comments. I'm starting to see why this didn't have a fix before :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/w0nder1ng">@w0nder1ng</a> on 2024-11-18 02:22</div>
            <div class="timeline-body"><p>The comment duplication happened when the comment was inside the append body, it should be fixed now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/w0nder1ng">@w0nder1ng</a> reviewed on 2024-11-18 02:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/w0nder1ng">@w0nder1ng</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_list_comprehension.rs</code>:237 on 2024-11-18 02:27</div>
            <div class="timeline-body"><p>For some reason, <code>resolve_name</code> returns <code>None</code> for the for-loop target. Also, references to it outside of the for-loop are not included in its list of references; e.g.</p>
<pre><code class="language-python">def f():
    result = []
    for val in range(5):
        result.append(val * 2)
    print(val) # this reference is not included in the list of references
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-18 07:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_list_comprehension.rs</code>:237 on 2024-11-18 07:10</div>
            <div class="timeline-body"><p>I think the problem here is that we build the semantic model lazily as we traverse the AST for checking and it hasn't reached the point after the for loop yet</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-18 07:14</div>
            <div class="timeline-body"><p>Could you take a look why https://github.com/apache/superset/blob/e528cb48c44543c14c1ac9a93528b147bcaecfde/scripts/benchmark_migration.py#L128 is no longer reported. I might have missed something obvious but it isn't clear to me why the diagnostic isn't reported anymore.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-18 07:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_list_comprehension.rs</code>:237 on 2024-11-18 07:24</div>
            <div class="timeline-body"><p>@charliermarsh any suggestions on how to best find all usages of target?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/w0nder1ng">@w0nder1ng</a> on 2024-11-18 15:27</div>
            <div class="timeline-body"><p>I suspect the regressions are because of the <code>resolve_name</code> currently being a <code>lookup_symbol</code>. In the example you gave, I think it's finding a different <code>foreign_key</code> binding on line 113 and concluding that the symbol is used outside of the for loop. Once the binding has the right scope, the only regressions should be ones where the lint shouldn't have applied.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Skylion007">@Skylion007</a> on 2024-11-18 15:34</div>
            <div class="timeline-body"><blockquote>
<p>Could you take a look why https://github.com/apache/superset/blob/e528cb48c44543c14c1ac9a93528b147bcaecfde/scripts/benchmark_migration.py#L128 is no longer reported. I might have missed something obvious but it isn't clear to me why the diagnostic isn't reported anymore.</p>
</blockquote>
<p>Because the lambda arg here https://github.com/apache/superset/blob/e528cb48c44543c14c1ac9a93528b147bcaecfde/scripts/benchmark_migration.py#L131C28-L131C33 is shadowing the variable &quot;model&quot; in the for loop. In this specific case, it's probably okay since it's in a lambda arg, but in general it shouldn't apply the fix there. I suppose only references rvalues are problematic outside of the forloop, not lvalues (if all they do is immediately get overwritten after all).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Skylion007">@Skylion007</a> on 2024-11-18 15:49</div>
            <div class="timeline-body"><p>Okay hopefully last nit:</p>
<pre><code class="language-diff">     reduction_axes: List[int] = []
-    for i in range(input_rank):
-        if i != axis:
-            reduction_axes.append(i)
+    reduction_axes.extend(i for i in range(input_rank) if i != axis)
</code></pre>
<p>Doesn't seem to like to hoist if there are any type_hints on the original <code>[]</code> instantiation.  Is this intentional?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/w0nder1ng">@w0nder1ng</a> on 2024-11-18 15:52</div>
            <div class="timeline-body"><p>I'll take a look</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/w0nder1ng">@w0nder1ng</a> on 2024-11-18 16:18</div>
            <div class="timeline-body"><p>Annotated assigns have a different statement type than normal assigns, and I wasn't handling it. The fix should work on type-annotated lists now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Skylion007">@Skylion007</a> on 2024-11-18 21:20</div>
            <div class="timeline-body"><blockquote>
<p>@w0nder1ng Another fun edge case that PR #14369 doesn't currently fix. Scoping rules are different between list comprehensions and for loops:</p>
<p>another example from pytorch</p>
<pre><code class="language-diff">     if kwargs is None:
         kwargs = {}
-    impl_args = []
-    for a in args:
-        impl_args.append(_helper(a, map_fn))
+    impl_args = [_helper(a, map_fn) for a in args]
     impl_kwargs = {}
     for k in kwargs.keys():
         impl_kwargs[k] = _helper(a, map_fn)
</code></pre>
<p>the <code>a</code> on the line <code>impl_kwargs[k] = _helper(a, map_fn)</code> is now undefined (and will error with F821) since the list comprehension was converted from a loop. RUFF immeaditely flags this with an F821 error, and I test and confirm the temporary variable <code>a</code> does not leave the listcomp scope, while it does leave the for loop one.</p>
<p>@w0nder1ng If you want a good test bed, just run the autofix on PyTorch (or another large codebase) and see after applying the fixes if any other ruff rule violations are immediately detected.</p>
</blockquote>
<p>This one is still occurring sadly. Maybe because it references another loop lol?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Skylion007">@Skylion007</a> on 2024-11-19 15:15</div>
            <div class="timeline-body"><p>Despite this minor false positive, looks like all the other fixes worked well on the PyTorch codebase (for the torch/torchgen folders) https://github.com/pytorch/pytorch/pull/140980/. üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/w0nder1ng">@w0nder1ng</a> on 2024-11-22 15:50</div>
            <div class="timeline-body"><p>I'm still stuck on two things.</p>
<ol>
<li>How can I determine whether the binding statement has another statement on the line?</li>
</ol>
<pre><code class="language-python">result = []; test = [] # deleting this whole line is wrong, but only deleting the binding statement also is wrong
# since it would leave the comment if there were no other statement
for ...
</code></pre>
<ol start="2">
<li>How can I get the semantic model to find references after the for loop?</li>
</ol>
<pre><code class="language-python">result = []
for i in range(10):
  result.append(i+1)
print(i) # &quot;fixing&quot; this for loop is invalid because something relies on the loop variable, but the semantic model doesn't see this reference yet
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Skylion007">@Skylion007</a> on 2024-11-25 15:26</div>
            <div class="timeline-body"><p>@diceroll123 @MichaReiser Any idea how to tackle these edge cases?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-25 15:59</div>
            <div class="timeline-body"><p>@Skylion007 no, not from the top of my head and I haven't had time yet to look into it more closely</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/diceroll123">@diceroll123</a> on 2024-11-25 16:04</div>
            <div class="timeline-body"><p>I did not look into it any further after my last comment on #14551.</p>
<p>This PR and my PR contain a bunch of overlapping changes (while addressing different bugs), and I don't want to step on any toes or spend more time on it if it's not going to be considered, so if one or the other is merged, or some kind of plan is made, we can go from there I suppose! No strong feelings on my part. üòÑ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Skylion007">@Skylion007</a> on 2024-11-28 17:07</div>
            <div class="timeline-body"><p>One other place this autofix breaks (but ruff does appropriately catch it!). Apply it to <code>sympy/tensor/index_methods.py</code> in sympy. Fixing this loop breaks: https://github.com/sympy/sympy/blob/ba68537e73dd40fb34fa9c5aaf46c5a6e1ef12c7/sympy/tensor/index_methods.py#L427 . I suspect because it's using unusual python syntax to iterate over an implicit tuple.</p>
<pre><code class="language-python">for d in dbase, dexp:
</code></pre>
<p>transforming that to a list comprehension likely breaks</p>
<p>I will say that even it's current form, this autofix is extremely useful, and the encountered edge cases are very rare in real code, and usually caught by other checks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Skylion007">@Skylion007</a> on 2024-12-03 14:13</div>
            <div class="timeline-body"><p>This unaccepted rule would likely have to tackle many of the same problems. Did they solve this edge case? https://github.com/astral-sh/ruff/pull/11769</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/w0nder1ng">@w0nder1ng</a> reviewed on 2024-12-03 19:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/w0nder1ng">@w0nder1ng</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_list_comprehension.rs</code>:237 on 2024-12-03 19:18</div>
            <div class="timeline-body"><p>I think a working version would look something like this:</p>
<pre><code class="language-rust">let for_loop_read = checker.semantic().resolve_load(for_loop_target_name_expr);
let for_loop_binding = match for_loop_read {
    ReadResult::Resolved(id) =&gt; checker.semantic().binding(id),
    _ =&gt; unreachable!(&quot;for loop target must exist&quot;),
};
</code></pre>
<p>Unfortunately, <code>resolve_load</code> requires an <code>&amp;mut SemanticModel</code> and I don't see a way to get one from the checker. Am I missing something here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/w0nder1ng">@w0nder1ng</a> on 2024-12-03 20:13</div>
            <div class="timeline-body"><p>@Skylion007 the implicit tuple issue should be fixed now</p>
<p>@diceroll123 this should also fix the async generator issue, as well as not duplicating comments inside of the for loop's iterator. It'd be great if you could look over it, since I haven't worked with async python, but I think it accomplishes the same thing as yours</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-03 21:55</div>
            <div class="timeline-body"><p>I haven't thought this through yet but I wonder if we should convert this rule to a <a href="https://github.com/astral-sh/ruff/blob/f3d8c023d3baa1d225ef3f2a59f7660f90627003/crates/ruff_linter/src/checkers/ast/analyze/bindings.rs#L26-L27">binding rule instead</a>. Binding rules run <strong>after</strong> Ruff visited the entire AST. This has the advantage that the semantic model is complete.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/w0nder1ng">@w0nder1ng</a> on 2024-12-06 00:24</div>
            <div class="timeline-body"><p>I think that's all of the edge cases, except for the one involving the loop variable. I'd be happy to try to convert the rule into a binding rule, but I think that might be outside of the scope of this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-12-06 02:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_list_comprehension.rs</code>:237 on 2024-12-06 02:52</div>
            <div class="timeline-body"><p>Sorry, I didn't look deeply, but often in those cases you need to make it a deferred rule, so it runs <em>after</em> the semantic model has been built (e.g., run it in <code>deferred_for_loops</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/w0nder1ng">@w0nder1ng</a> on 2024-12-06 17:14</div>
            <div class="timeline-body"><p>Even after moving the lint into <code>deferred_for_loops</code>, it still doesn't properly find the loop variable:</p>
<pre><code class="language-python">def f():
    result = []
    for i in range(5):
    #   ^ running checker.semantic().resolve_name() on this ExprName returns None.
        result.append(i * 2)
        #             ^ when I run binding.statement() on this binding, 
        #               it returns the &quot;i = 1&quot; statement, even though that is clearly wrong
    i = 1
  # ^ lookup_symbol returns this i
    print(i) 
</code></pre>
<p>Am I missing something here, or is this behavior incorrect? See the last commit for the code I used to get this result.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-12-09 04:16</div>
            <div class="timeline-body"><blockquote>
<pre><code class="language-python">    for i in range(5):
    #   ^ running checker.semantic().resolve_name() on this ExprName returns None.
</code></pre>
</blockquote>
<p>That might be because <code>i</code> is itself the definition. What I see in the semantic model is that an entry in the <code>resolved_names</code> is created only by the <code>resolve_load</code> function which would work on the <code>ExprName</code> with the <code>ExprContext::Load</code> context. But, here the <code>i</code> variable that is the for target would have the <code>ExprContext::Store</code> context (https://play.ruff.rs/44c3909e-4f46-4a46-bd6e-36ea78223322) which is why I think you're getting <code>None</code> there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-12-09 09:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_list_comprehension.rs</code>:250 on 2024-12-09 09:17</div>
            <div class="timeline-body"><pre><code class="language-suggestion">
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-09 09:54</div>
            <div class="timeline-body"><blockquote>
<h1>^ lookup_symbol returns this i</h1>
</blockquote>
<p>This is because the semantic model now captures the state after running the entire program. It's complete, and running <code>lookup_symbol</code> gives you the most recent binding for <code>i</code> after evaluating the entire function scope. That means you now have to do some extra work to get the for-loop target binding:</p>
<pre><code class="language-rust">    let last_target_binding = checker
        .semantic()
        .lookup_symbol(id)
        .expect(&quot;For loop to exist&quot;);

    let mut bindings = [last_target_binding].into_iter().chain(
        checker
            .semantic()
            .shadowed_bindings(checker.semantic().scope_id, last_target_binding)
            .filter_map(|shadowed| shadowed.same_scope().then_some(shadowed.shadowed_id())),
    );

    let target_binding = bindings
        .find_map(|binding_id| {
            let binding = checker.semantic().binding(binding_id);

            if dbg!(binding.statement(checker.semantic())).and_then(Stmt::as_for_stmt)
                == Some(for_stmt)
            {
                Some(binding)
            } else {
                None
            }
        })
        .expect(&quot;for target binding must exist&quot;);

    drop(bindings);
</code></pre>
<p>There might be a better way to detect if the binding belongs to the target that e.g. avoids picking up named expressions in the iterator part.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/w0nder1ng">@w0nder1ng</a> reviewed on 2024-12-09 22:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/w0nder1ng">@w0nder1ng</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_list_comprehension.rs</code>:258 on 2024-12-09 22:00</div>
            <div class="timeline-body"><p>I made this a vector, but if there's enough references, it might make more sense for it to be a HashMap instead. What do you think?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-10 09:03</div>
            <div class="timeline-body"><p>It seems we're now skipping over the two <code>result.append</code> usages in https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/plotting/_figure.py#L485</p>
<p>Is this intentional? Should we change the implementation not to provide a fix but still the usage?</p>
<p>Edit: I think this is intentional because <code>kw</code> is shadowed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_list_comprehension.rs</code>:278 on 2024-12-10 09:14</div>
            <div class="timeline-body"><p>I don't understand what this code is doing. Would you mind adding a comment explaining why looking at the <code>shadowed_references</code> is necessary?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-12-10 09:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/w0nder1ng">@w0nder1ng</a> on 2024-12-10 19:11</div>
            <div class="timeline-body"><blockquote>
<p>It seems we're now skipping over the two <code>result.append</code> usages in https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/plotting/_figure.py#L485</p>
<p>Is this intentional? Should we change the implementation not to provide a fix but still the usage?</p>
<p>Edit: I think this is intentional because <code>kw</code> is shadowed.</p>
</blockquote>
<p>It would be shadowed if there weren't a return. A smaller example:</p>
<pre><code class="language-python">def f(switch):
    i = 1
#   ^ this is the `i` which actually gets returned
    if switch:
        items = [1, 2, 3, 4]
        result = []
        #   v if it weren't for the return, this `i` would be the binding
        for i in items:
            result.append(i + 1)
        # v unconditional return means that the binding is not actually relevant
        return result
    #       v fix thinks this `i` is the loop variable
    return [i]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/perflint/rules/manual_list_comprehension.rs</code>:474 on 2024-12-11 12:49</div>
            <div class="timeline-body"><p>I'm leaning towards not providing a fix in this case to avoid the extra complexity.</p>
<p>Either way, we should avoid parsing here. We can use the <code>SimpleTokenizer</code> if we need tokenization and can't just use the AST</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-12-11 12:53</div>
            <div class="timeline-body"><p>Uff, this rule is complicated. Thanks for pushing through it</p>
<p>I made it through the detection logic and pushed a few smaller simplifications. I'm now about to review the fix and noticed the <code>parse</code> call. I suggest to either not provide a fix in the multi assignment case (it's not that common) or to use the <code>SimpleTokenizer</code> to avoid using the full parser here. It might even simplify some of your code because it allows e.g. searching for the <code>;</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/w0nder1ng">@w0nder1ng</a> on 2024-12-11 21:28</div>
            <div class="timeline-body"><p>I've removed the tokenization without changing the rest of the code. The code now iterates over the characters directly because I was having trouble with the <code>SimpleTokenizer</code> not properly tokenizing some lines.</p>
<p>Is it worth also removing the code to handle multiple statements to simplify the logic?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-12 08:05</div>
            <div class="timeline-body"><blockquote>
<p>The code now iterates over the characters directly because I was having trouble with the SimpleTokenizer not properly tokenizing some lines.</p>
</blockquote>
<p>I pushed a change that uses the <code>SimpleTokenizer</code> and <code>BackwardsTokenizer</code> instead. That also revealed that we should remove any leading <code>;</code>.</p>
<p>But I think we're good now and can land this change. Thank you for working on this very involved. rule</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2024-12-12 08:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-12-12 08:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Skylion007">@Skylion007</a> on 2024-12-15 17:49</div>
            <div class="timeline-body"><p>Beautiful job landing this rule @w0nder1ng . Any plans on tackling the dict comprehension version since the logic is very similar?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/w0nder1ng">@w0nder1ng</a> on 2024-12-15 18:08</div>
            <div class="timeline-body"><p>Sure, when I have the opportunity</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:07:45 UTC
    </footer>
</body>
</html>
