```yaml
number: 6358
title: Add support for help end IPython escape commands
type: pull_request
state: merged
author: dhruvmanila
labels:
  - parser
assignees: []
merged: true
base: main
head: dhruv/jupyter-help-end-magic
created_at: 2023-08-05T02:03:27Z
updated_at: 2023-08-09T04:58:53Z
url: https://github.com/astral-sh/ruff/pull/6358
synced_at: 2026-01-12T15:55:21Z
```

# Add support for help end IPython escape commands

---

_@dhruvmanila_

## Summary

This PR adds support for a stricter version of help end escape commands[^1] in the parser. By stricter, I mean that the escape tokens are only at the end of the command and there are no tokens at the start. This makes it difficult to implement it in the lexer without having to do a lot of look aheads or keeping track of previous tokens.

Now, as we're adding this in the parser, the lexer needs to recognize and emit a new token for `?`. So, `Question` token is added which will be recognized only in `Jupyter` mode.

The conditions applied are the same as the ones in the original implementation in IPython codebase (which is a regex):
* There can only be either 1 or 2 question mark(s) at the end
* The node before the question mark can be a `Name`, `Attribute`, `Subscript` (only with integer constants in slice position), or any combination of the 3 nodes.

## Test Plan

Added test cases for various combination of the possible nodes in the command value position and update the snapshots.

fixes: #6359
fixes: #5030 (This is the final piece)

[^1]: https://github.com/astral-sh/ruff/pull/6272#issue-1833094281

---

_Comment by @dhruvmanila on 2023-08-05 02:03_

Current dependencies on/for this PR:
* main
  * **PR #6272** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6272" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #6358** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6358" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6358?utm_source=stack-comment).

---

_Label `parser` added by @dhruvmanila on 2023-08-05 02:10_

---

_Comment by @github-actions[bot] on 2023-08-05 02:15_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      9.7Â±0.04ms     4.2 MB/sec    1.02      9.9Â±0.10ms     4.1 MB/sec
formatter/numpy/ctypeslib.py               1.00  1907.1Â±91.23Âµs     8.7 MB/sec    1.03  1971.7Â±29.77Âµs     8.4 MB/sec
formatter/numpy/globals.py                 1.00    210.6Â±1.94Âµs    14.0 MB/sec    1.06    223.2Â±6.86Âµs    13.2 MB/sec
formatter/pydantic/types.py                1.00      4.1Â±0.06ms     6.3 MB/sec    1.04      4.2Â±0.09ms     6.1 MB/sec
linter/all-rules/large/dataset.py          1.00     12.1Â±0.05ms     3.4 MB/sec    1.03     12.5Â±0.14ms     3.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.2Â±0.01ms     5.2 MB/sec    1.05      3.4Â±0.18ms     4.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    447.0Â±1.56Âµs     6.6 MB/sec    1.03    459.3Â±0.89Âµs     6.4 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.5Â±0.03ms     4.6 MB/sec    1.03      5.7Â±0.08ms     4.5 MB/sec
linter/default-rules/large/dataset.py      1.00      6.3Â±0.04ms     6.4 MB/sec    1.02      6.4Â±0.03ms     6.3 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1343.8Â±5.06Âµs    12.4 MB/sec    1.04  1402.4Â±87.21Âµs    11.9 MB/sec
linter/default-rules/numpy/globals.py      1.00    156.7Â±8.50Âµs    18.8 MB/sec    1.01    157.7Â±1.84Âµs    18.7 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.8Â±0.01ms     9.1 MB/sec    1.04      2.9Â±0.02ms     8.8 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01     10.3Â±0.18ms     3.9 MB/sec    1.00     10.2Â±0.11ms     4.0 MB/sec
formatter/numpy/ctypeslib.py               1.00  1932.7Â±27.20Âµs     8.6 MB/sec    1.01  1950.9Â±38.52Âµs     8.5 MB/sec
formatter/numpy/globals.py                 1.00    213.4Â±7.18Âµs    13.8 MB/sec    1.04    220.9Â±9.68Âµs    13.4 MB/sec
formatter/pydantic/types.py                1.00      4.3Â±0.08ms     5.9 MB/sec    1.04      4.4Â±0.13ms     5.7 MB/sec
linter/all-rules/large/dataset.py          1.00     12.4Â±0.22ms     3.3 MB/sec    1.04     12.9Â±0.14ms     3.2 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.5Â±0.06ms     4.8 MB/sec    1.03      3.6Â±0.07ms     4.6 MB/sec
linter/all-rules/numpy/globals.py          1.00    427.4Â±7.29Âµs     6.9 MB/sec    1.04    444.5Â±7.62Âµs     6.6 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.9Â±0.13ms     4.3 MB/sec    1.06      6.2Â±0.13ms     4.1 MB/sec
linter/default-rules/large/dataset.py      1.00      7.0Â±0.11ms     5.8 MB/sec    1.02      7.1Â±0.16ms     5.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1419.9Â±19.34Âµs    11.7 MB/sec    1.03  1460.7Â±25.29Âµs    11.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    166.0Â±3.14Âµs    17.8 MB/sec    1.02    169.4Â±5.59Âµs    17.4 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.1Â±0.07ms     8.2 MB/sec    1.00      3.1Â±0.06ms     8.2 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Review comment by @dhruvmanila on `crates/ruff_python_parser/src/lexer.rs`:789 on 2023-08-07 19:12_

I'm not sure if we should be this strict in the lexer. This just makes sure that the `Question` token is emitted only when it's at the end of the line:

```python
foo?
foo??
```

---

_@dhruvmanila reviewed on 2023-08-07 19:13_

---

_@dhruvmanila reviewed on 2023-08-07 19:16_

---

_Review comment by @dhruvmanila on `crates/ruff_python_parser/src/python.lalrpop`:375 on 2023-08-07 19:16_

We're permissive than the original implementation because we would allow whitespace between the expression and the suffix while the IPython implementation doesn't allow it. For example, `foo ?` would be valid in our case but invalid from IPython.

---

_Marked ready for review by @dhruvmanila on 2023-08-07 19:16_

---

_Review requested from @MichaReiser by @dhruvmanila on 2023-08-07 19:17_

---

_Review requested from @konstin by @dhruvmanila on 2023-08-07 19:17_

---

_Review comment by @MichaReiser on `crates/ruff_python_parser/src/lexer.rs`:789 on 2023-08-08 07:37_

I think we can always emit it in Jupyter mode. It's a valid token and it's the Parser's job to determine if it is a valid position.

---

_Review comment by @MichaReiser on `crates/ruff_python_parser/src/python.lalrpop`:375 on 2023-08-08 07:39_

It's not just whitespace. It also includes comments, continuation tokens etc. We could use the source text to retrieve the expression range instead and assert whether it contains any whitespace, comments, or continuation tokens (I'm not suggesting that we should do this, but it's a possibility)

---

_Review comment by @MichaReiser on `crates/ruff_python_parser/src/python.lalrpop`:431 on 2023-08-08 07:39_

The `unparse` function doesn't preserve whitespace, comments, or continuation tokens. Is this okay? 

---

_@MichaReiser approved on 2023-08-08 07:40_

---

_Review comment by @konstin on `crates/ruff_python_parser/src/python.lalrpop`:375 on 2023-08-08 09:33_

i'd add @dhruvmanila's comment as code comment

---

_@konstin approved on 2023-08-08 09:44_

---

_@dhruvmanila reviewed on 2023-08-08 13:20_

---

_Review comment by @dhruvmanila on `crates/ruff_python_parser/src/python.lalrpop`:375 on 2023-08-08 13:20_

Makes sense. I might play around with your idea.

(I'll also add it as a code comment)

---

_@dhruvmanila reviewed on 2023-08-08 13:22_

---

_Review comment by @dhruvmanila on `crates/ruff_python_parser/src/lexer.rs`:789 on 2023-08-08 13:22_

Yeah, makes sense. I'll also remove this check `!self.state.is_new_logical_line()` and update the parser code to only allow the `Question` token _before_ the newline. I'll probably need to play around with some test cases to make sure the pattern is correct.

---

_@dhruvmanila reviewed on 2023-08-08 13:26_

---

_Review comment by @dhruvmanila on `crates/ruff_python_parser/src/python.lalrpop`:431 on 2023-08-08 13:26_

If any of the trivia/comments are present, then I don't think IPython will even consider it valid or it'll only consider the regex match as valid ignoring any other text. For example,

```python
foo. \
   bar?
```

This will mean that the help command is called only for `bar` and not `foo.bar` in IPython implementation.

I think for now it's ok to continue as such instances in the wild will be rare but we can improve it in the future.

---

_Renamed from "Add support for help end line magics in the parser" to "Add support for help end IPython escape commands in the parser" by @dhruvmanila on 2023-08-09 04:55_

---

_Renamed from "Add support for help end IPython escape commands in the parser" to "Add support for help end IPython escape commands" by @dhruvmanila on 2023-08-09 04:57_

---

_Merged by @dhruvmanila on 2023-08-09 04:58_

---

_Closed by @dhruvmanila on 2023-08-09 04:58_

---

_Branch deleted on 2023-08-09 04:58_

---
