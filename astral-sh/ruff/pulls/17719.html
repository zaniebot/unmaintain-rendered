<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Run py-fuzzer in CI to check for new panics - astral-sh/ruff #17719</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Run py-fuzzer in CI to check for new panics</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17719">#17719</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-04-29 18:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR sets up a CI job that uses the py-fuzzer script to check whether a PR introduces new panics to red-knot.</p>
<p>The py-fuzzer script still finds lots of panics in red-knot generally (see https://github.com/astral-sh/ty/issues/228 for a tracking issue), so running it with the default arguments in CI would lead to a lot of red CI jobs. However, the py-fuzzer script <em>also</em> has a <code>--only-new-bugs</code> CLI flag! If specified, it allows you to compare two binaries and check whether any <em>new</em> panics have been introduced by the PR. If any have been introduced, the script fails; if there are no new panics relative to the baseline binary, however, the script exits with code 0.</p>
<p>The CI job here ends up looking like a cross between the <code>fuzz-parser</code> CI job in <code>ci.yaml</code> (which already runs the <code>py-fuzzer</code> script in CI for us, but which runs it with the <code>ruff</code> binary to fuzz the parser rather than red-knot) and the <code>ruff-ecosystem</code> CI job in <code>ci.yaml</code> (which, in a similar way to this new CI job, downloads two binaries and compares them to see if there's any differences).</p>
<p>The CI job is currently failing because there's no baseline red-knot binary for the job to download (this PR adds the CI job that will start uploading the red-knot binary for future CI jobs to download). I'm not totally sure how to address this -- I suppose I could split it up into two PRs, one that adds the job uploading the binary and then a second one that adds the job to actually use the binary? I'll wait for review on the general idea here before going ahead with that, though.</p>
<h2>Test Plan</h2>
<p>I did the following:</p>
<ul>
<li><p>Built the binary on <code>main</code> with <code>--target-directory=target/main</code></p>
</li>
<li><p>Switched to a branch that had more panics and ran <code>cargo build -p red_knot</code></p>
</li>
<li><p>Ran the following command from my terminal and observed that the script only reported new panics that did not exist on <code>main</code>:</p>
<pre><code>uvx \
    --python=&quot;3.12&quot; \
    --from=./python/py-fuzzer \
    fuzz \
    --test-executable=&quot;./target/debug/red_knot&quot; \
    --baseline-executable=&quot;./target/main/debug/red_knot&quot; \
    --only-new-bugs \
    --bin=red_knot \
    0-500
</code></pre>
</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ci</span> added by @AlexWaygood on 2025-04-29 18:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-04-29 18:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-29 18:17</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>âœ… ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>âœ… ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @AlexWaygood on 2025-04-29 18:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @AlexWaygood on 2025-04-29 18:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-04-29 18:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2025-04-29 18:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-04-29 18:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-04-29 19:39</div>
            <div class="timeline-body"><blockquote>
<p>The CI job is currently failing because there's no baseline red-knot binary for the job to download (this PR adds the CI job that will start uploading the red-knot binary for future CI jobs to download). I'm not totally sure how to address this -- I suppose I could split it up into two PRs, one that adds the job uploading the binary and then a second one that adds the job to actually use the binary? I'll wait for review on the general idea here before going ahead with that, though.</p>
</blockquote>
<p>Or, you could create a dummy PR with either an empty commit or a random change (if it's required) to trigger CI which is stacked on top of this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-04-29 20:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @AlexWaygood on 2025-04-29 20:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @AlexWaygood on 2025-04-29 20:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @AlexWaygood on 2025-04-29 20:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-29 20:51</div>
            <div class="timeline-body"><blockquote>
<p>Or, you could create a dummy PR with either an empty commit or a random change (if it's required) to trigger CI which is stacked on top of this PR.</p>
</blockquote>
<p>I split this PR into two -- this change is now stacked on top of https://github.com/astral-sh/ruff/pull/17720 (so that there is a baseline binary to download), and CI is passing on the new job ðŸŽ‰ https://github.com/astral-sh/ruff/actions/runs/14740981444/job/41378854533?pr=17719#step:6:539</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>.github/workflows/ci.yaml</code>:640 on 2025-04-29 20:56</div>
            <div class="timeline-body"><p>This is the name that shows up in the CI jobs list -- I think it should mention fuzzing, it's not clear otherwise what &quot;check for new red-knot panics&quot; actually means</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-04-29 20:56</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-29 21:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>.github/workflows/ci.yaml</code>:640 on 2025-04-29 21:01</div>
            <div class="timeline-body"><p>Maybe this?</p>
<pre><code class="language-suggestion">    name: &quot;Fuzz for new red-knot panics&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-29 21:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>.github/workflows/ci.yaml</code>:640 on 2025-04-29 21:02</div>
            <div class="timeline-body"><p>or</p>
<pre><code class="language-suggestion">    name: &quot;Check for new red-knot panics using py-fuzzer&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-04-29 21:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>.github/workflows/ci.yaml</code>:640 on 2025-04-29 21:09</div>
            <div class="timeline-body"><p>Either seems fine to me, up to you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-04-29 21:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @AlexWaygood on 2025-04-29 21:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>.github/workflows/ci.yaml</code>:646 on 2025-04-29 21:16</div>
            <div class="timeline-body"><p>Yeah, and it's most useful to run it on a PR. We also don't run the py-fuzzer on parser on <code>main</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-04-29 21:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-04-29 21:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-04-29 21:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-29 21:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-04-29 21:21</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_INSTRUMENTATION_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/alex%2Fpanic-regrtest">CodSpeed Performance Report</a></h2>
<h3>Merging astral-sh/ruff#17719 will <strong>improve performances by 4.1%</strong></h3>
<p><sub>Comparing <code>alex/panic-regrtest</code> (8c563cc) with <code>main</code> (8c68d30)</sub></p>
<h3>Summary</h3>
<p><code>âš¡ 1</code> improvements<br />
<code>âœ… 32</code> untouched benchmarks</p>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| âš¡ | <code>parser[numpy/ctypeslib.py]</code> | 924.5 Âµs | 888 Âµs | +4.1% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-29 21:24</div>
            <div class="timeline-body"><blockquote>
<p>Merging astral-sh/ruff#17719 will <strong>improve performances by 4.1%</strong></p>
</blockquote>
<p>hmmmmm</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:12:02 UTC
    </footer>
</body>
</html>
