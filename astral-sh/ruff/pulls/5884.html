<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remove multithreading from check multiproject - astral-sh/ruff #5884</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Remove multithreading from check multiproject</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5884">#5884</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-07-19 14:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-19 14:30</div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>This PR removes the multithreading from the multiproject check because we already use a <code>par_iter</code> to iterate over the files.</p>
<p>This doesn't give us as good parallelism because the discovery of the project files now runs single threaded but it's still pretty good
and it significantly simplies the code (and fixes the misterious stack overflow).</p>
<!-- What's the purpose of the change? What does it do, and why? -->

<h2>Test Plan</h2>
<p><a href="https://github.com/astral-sh/ruff/assets/1203881/be7b95fb-af85-4dc5-b111-5513271a5958">Screencast from 2023-07-19 16-30-42.webm</a></p>
<p>The whole check completes in about 90s</p>
<p><img src="https://github.com/astral-sh/ruff/assets/1203881/bf8da147-9f05-41dd-9dec-1e20a769bc76" alt="image" /></p>
<!-- How was it tested? -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-19 14:30</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #5884</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5884" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5884?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @MichaReiser on 2023-07-19 14:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_dev/src/format_dev.rs</code>:220 on 2023-07-19 14:48</div>
            <div class="timeline-body"><p>i wouldn't unwrap those due to some failures in the past, can we collect them into an error?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_dev/src/format_dev.rs</code>:229 on 2023-07-19 14:49</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    let mut error_file = args.error_file.as_ref().map(|error_file| {
        Ok(BufWriter::new(File::create(error_file).context(&quot;Couldn't open error file&quot;)?))
    }).transpose()?;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_dev/src/format_dev.rs</code>:232 on 2023-07-19 14:50</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        bar.suspend(|| println!(&quot;Starting {}&quot;, project_path.display()));
</code></pre>
<p>otherwise it won't print when redirecting to a file (https://docs.rs/indicatif/latest/indicatif/struct.ProgressBar.html#method.println, such a footgun), same below</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-07-19 14:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-07-19 15:06</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01     11.7Â±0.39ms     3.5 MB/sec    1.00     11.5Â±0.27ms     3.5 MB/sec
formatter/numpy/ctypeslib.py               1.04      2.3Â±0.10ms     7.1 MB/sec    1.00      2.3Â±0.08ms     7.4 MB/sec
formatter/numpy/globals.py                 1.01   263.3Â±13.38Âµs    11.2 MB/sec    1.00   261.0Â±11.00Âµs    11.3 MB/sec
formatter/pydantic/types.py                1.00      5.0Â±0.15ms     5.1 MB/sec    1.02      5.0Â±0.13ms     5.1 MB/sec
linter/all-rules/large/dataset.py          1.00     16.2Â±0.65ms     2.5 MB/sec    1.03     16.6Â±0.53ms     2.4 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      4.1Â±0.17ms     4.0 MB/sec    1.00      4.1Â±0.10ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.00   552.5Â±17.14Âµs     5.3 MB/sec    1.00   551.7Â±15.86Âµs     5.3 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.4Â±0.17ms     3.5 MB/sec    1.02      7.5Â±0.22ms     3.4 MB/sec
linter/default-rules/large/dataset.py      1.00      8.3Â±0.20ms     4.9 MB/sec    1.01      8.4Â±0.15ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01  1784.7Â±53.17Âµs     9.3 MB/sec    1.00  1770.4Â±38.28Âµs     9.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    205.8Â±6.35Âµs    14.3 MB/sec    1.00    206.7Â±6.07Âµs    14.3 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.7Â±0.08ms     6.9 MB/sec    1.02      3.8Â±0.15ms     6.8 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     14.1Â±0.65ms     2.9 MB/sec    1.18     16.5Â±0.63ms     2.5 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.8Â±0.17ms     5.9 MB/sec    1.16      3.3Â±0.19ms     5.1 MB/sec
formatter/numpy/globals.py                 1.00   332.7Â±21.30Âµs     8.9 MB/sec    1.08   359.1Â±24.06Âµs     8.2 MB/sec
formatter/pydantic/types.py                1.00      6.3Â±0.35ms     4.1 MB/sec    1.13      7.1Â±0.37ms     3.6 MB/sec
linter/all-rules/large/dataset.py          1.11     22.1Â±0.94ms  1883.5 KB/sec    1.00     19.9Â±0.91ms     2.0 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.06      5.7Â±0.28ms     2.9 MB/sec    1.00      5.4Â±0.45ms     3.1 MB/sec
linter/all-rules/numpy/globals.py          1.00   649.0Â±91.61Âµs     4.5 MB/sec    1.02   664.8Â±41.29Âµs     4.4 MB/sec
linter/all-rules/pydantic/types.py         1.00      9.4Â±0.50ms     2.7 MB/sec    1.08     10.1Â±0.49ms     2.5 MB/sec
linter/default-rules/large/dataset.py      1.02     11.1Â±0.41ms     3.7 MB/sec    1.00     10.8Â±0.39ms     3.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01      2.4Â±0.14ms     7.0 MB/sec    1.00      2.3Â±0.11ms     7.1 MB/sec
linter/default-rules/numpy/globals.py      1.00   264.4Â±14.65Âµs    11.2 MB/sec    1.03   273.0Â±14.80Âµs    10.8 MB/sec
linter/default-rules/pydantic/types.py     1.08      5.3Â±0.36ms     4.8 MB/sec    1.00      4.9Â±0.21ms     5.2 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-07-19 15:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_dev/src/format_dev.rs</code>:232 on 2023-07-19 15:40</div>
            <div class="timeline-body"><p>oh man. And I thought it is because it would mess up the bar... I'll change it back</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-07-19 16:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-07-19 16:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-07-19 16:18</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 03:31:01 UTC
    </footer>
</body>
</html>
