```yaml
number: 5402
title: "Consider Jupyter index for code frames (`--show-source`)"
type: pull_request
state: merged
author: dhruvmanila
labels: []
assignees: []
merged: true
base: main
head: dhruv/jupyter-code-frames
created_at: 2023-06-27T19:43:24Z
updated_at: 2023-06-28T03:43:02Z
url: https://github.com/astral-sh/ruff/pull/5402
synced_at: 2026-01-12T03:36:55Z
```

# Consider Jupyter index for code frames (`--show-source`)

---

_Pull request opened by @dhruvmanila on 2023-06-27 19:43_

## Summary

Consider Jupyter index for code frames (`--show-source`).

This solves two problems as mentioned in the linked issue:

> Omit any contents from adjoining cells

If the Jupyter index is present, we'll use that to check if the surrounding
lines belong to the same cell as the content line. If not, we'll skip that line
until we either reach the one which does or we reach the content line.

> code frame line number

If the Jupyter index is present, we'll use that to get the actual start line in
corresponding to the computed start index.

## Test Plan

`cargo run --bin ruff -- check --no-cache --isolated --select=ALL --show-source /path/to/notebook.ipynb`

fixes: #5395


---

_Comment by @dhruvmanila on 2023-06-27 19:43_

Current dependencies on/for this PR:
* main
  * **PR #5402** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5402" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/5402?utm_source=stack-comment).

---

_Comment by @dhruvmanila on 2023-06-27 19:45_

I'm not sure if I'm happy with the implementation due to a bunch of `Option` handling. I think we should figure out some other way in the future as it could be problematic when other source kinds are introduced (markdown, SQL, etc.).

---

_Comment by @github-actions[bot] on 2023-06-27 19:52_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      8.3Â±0.03ms     4.9 MB/sec    1.00      8.3Â±0.03ms     4.9 MB/sec
formatter/numpy/ctypeslib.py               1.00   1715.2Â±1.48Âµs     9.7 MB/sec    1.00   1716.6Â±4.16Âµs     9.7 MB/sec
formatter/numpy/globals.py                 1.00    188.1Â±0.34Âµs    15.7 MB/sec    1.00    188.8Â±0.36Âµs    15.6 MB/sec
formatter/pydantic/types.py                1.01      3.9Â±0.03ms     6.5 MB/sec    1.00      3.9Â±0.00ms     6.6 MB/sec
linter/all-rules/large/dataset.py          1.01     14.1Â±0.05ms     2.9 MB/sec    1.00     13.9Â±0.06ms     2.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.5Â±0.02ms     4.8 MB/sec    1.00      3.5Â±0.01ms     4.8 MB/sec
linter/all-rules/numpy/globals.py          1.00    371.3Â±0.75Âµs     7.9 MB/sec    1.00   372.4Â±12.00Âµs     7.9 MB/sec
linter/all-rules/pydantic/types.py         1.01      6.2Â±0.03ms     4.1 MB/sec    1.00      6.1Â±0.03ms     4.2 MB/sec
linter/default-rules/large/dataset.py      1.01      7.1Â±0.02ms     5.7 MB/sec    1.00      7.0Â±0.01ms     5.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01   1490.8Â±2.02Âµs    11.2 MB/sec    1.00   1471.4Â±2.49Âµs    11.3 MB/sec
linter/default-rules/numpy/globals.py      1.02    158.7Â±0.20Âµs    18.6 MB/sec    1.00    155.8Â±0.28Âµs    18.9 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.2Â±0.01ms     7.9 MB/sec    1.00      3.2Â±0.01ms     8.0 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      9.7Â±0.42ms     4.2 MB/sec    1.01      9.8Â±0.37ms     4.1 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.0Â±0.09ms     8.3 MB/sec    1.05      2.1Â±0.12ms     7.9 MB/sec
formatter/numpy/globals.py                 1.00    231.7Â±8.15Âµs    12.7 MB/sec    1.08   250.9Â±19.30Âµs    11.8 MB/sec
formatter/pydantic/types.py                1.06      4.8Â±0.33ms     5.3 MB/sec    1.00      4.6Â±0.20ms     5.6 MB/sec
linter/all-rules/large/dataset.py          1.12     17.4Â±0.64ms     2.3 MB/sec    1.00     15.5Â±0.39ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.16      4.8Â±0.22ms     3.4 MB/sec    1.00      4.2Â±0.15ms     4.0 MB/sec
linter/all-rules/numpy/globals.py          1.14   605.2Â±26.80Âµs     4.9 MB/sec    1.00   528.6Â±25.36Âµs     5.6 MB/sec
linter/all-rules/pydantic/types.py         1.05      7.9Â±0.47ms     3.2 MB/sec    1.00      7.5Â±0.39ms     3.4 MB/sec
linter/default-rules/large/dataset.py      1.01      8.4Â±0.63ms     4.9 MB/sec    1.00      8.3Â±0.28ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1757.3Â±88.51Âµs     9.5 MB/sec    1.04  1821.6Â±61.27Âµs     9.1 MB/sec
linter/default-rules/numpy/globals.py      1.00    207.2Â±7.51Âµs    14.2 MB/sec    1.10   228.5Â±15.74Âµs    12.9 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.6Â±0.18ms     7.0 MB/sec    1.09      4.0Â±0.17ms     6.4 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_@charliermarsh reviewed on 2023-06-28 01:20_

---

_Review comment by @charliermarsh on `crates/ruff/src/message/text.rs`:199 on 2023-06-28 01:20_

Should we put this outside of the `while`, and have separate `while` loops in the `if` and `else` branches? The control flow here is a little hard to follow.

---

_@charliermarsh reviewed on 2023-06-28 01:20_

---

_Review comment by @charliermarsh on `crates/ruff/src/message/text.rs`:231 on 2023-06-28 01:20_

Same here.

---

_@charliermarsh approved on 2023-06-28 01:20_

Seems reasonable.

---

_@dhruvmanila reviewed on 2023-06-28 03:14_

---

_Review comment by @dhruvmanila on `crates/ruff/src/message/text.rs`:199 on 2023-06-28 03:14_

Make sense. I've separated them out and also used `unwrap_or_default` for `index.cell` and `index.cell_row`. The unwrap failure is unlikely but if it happens then the rendering will be incorrect and would most likely be reported by the user.

---

_Comment by @dhruvmanila on 2023-06-28 03:14_

@charliermarsh Can you check if the control flow is reasonable to follow now?

---

_Comment by @charliermarsh on 2023-06-28 03:16_

LGTM.

---

_Merged by @dhruvmanila on 2023-06-28 03:24_

---

_Closed by @dhruvmanila on 2023-06-28 03:24_

---

_Branch deleted on 2023-06-28 03:24_

---
