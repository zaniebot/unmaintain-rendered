<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Fix bug where module resolution would not be invalidated if an entire package was deleted - astral-sh/ruff #12378</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Fix bug where module resolution would not be invalidated if an entire package was deleted</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/12378">#12378</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-07-18 13:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-07-18 13:00</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This fixes a bug where module resolution would not be invalidated if an entire package was deleted</p>
<h2>Test Plan</h2>
<p>I added a test that fails on <code>main</code>, and passes with this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2024-07-18 13:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2024-07-18 13:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2024-07-18 13:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-07-18 13:14</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/path.rs</code>:390 on 2024-07-18 13:51</div>
            <div class="timeline-body"><p>Nit: We can use <code>vendored().exists</code> here because we know that the system is read only.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:1621 on 2024-07-18 13:52</div>
            <div class="timeline-body"><p>Do we have to delete these files as well? If so, should we call <code>touch</code> for them?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-07-18 13:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-18 13:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/path.rs</code>:390 on 2024-07-18 13:54</div>
            <div class="timeline-body"><p>I wondered about this. In what situation <em>should</em> we use <code>vendored_path_to_file()</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-18 13:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/path.rs</code>:390 on 2024-07-18 13:57</div>
            <div class="timeline-body"><p>In cases where we need a <code>File</code>, for example because we have to pass it to <code>source_text</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-18 13:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/path.rs</code>:390 on 2024-07-18 13:59</div>
            <div class="timeline-body"><p>Right -- but if we know it's immutable, maybe we should just be calling <code>vendored.read-to_string()</code> instead of <code>source_text()</code> to get the source text -- the same argument applies, no? (Not trying to be argumentative, just curious!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-18 14:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/path.rs</code>:390 on 2024-07-18 14:08</div>
            <div class="timeline-body"><p>It depends. Not if it is a Python file, because calling <code>source_text</code> then has the benefit that we read the vendored python file exactly once instead of multiple times (<code>file.read_to_string</code> is not cached).</p>
<p>That's also not the point I made above. We need <code>vendored_path_to_file</code> when calling <code>parsed_module</code> because the function takes a <code>File</code> argument (because it doesn't care if it is a vendored or non vendored file). That's when you need a file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-18 14:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/path.rs</code>:390 on 2024-07-18 14:39</div>
            <div class="timeline-body"><blockquote>
<p><code>file.read_to_string</code> is not cached</p>
</blockquote>
<p>Nor is <code>vendored.exists()</code> -- each time we call that, we'll be querying the zip archive. Is the logic that we think that this will be inexpensive enough that it's not worth caching?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-18 15:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:1621 on 2024-07-18 15:16</div>
            <div class="timeline-body"><p>Argh, you're right. This test doesn't exercise anything at all right now :( It passes on <code>main</code> if I <code>touch</code> both files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-18 16:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/path.rs</code>:390 on 2024-07-18 16:03</div>
            <div class="timeline-body"><p>I'm not sure I understand. This seems to be unrelated to the original question.</p>
<blockquote>
<p>it's not worth caching</p>
</blockquote>
<p>Probably not. Caching comes at a high cost (memory, locking, lookup). We cache the resolved module, which should prevent from calling into the vendored system in the first place. But we have to wait for some real world usage to tell.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-18 16:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/path.rs</code>:390 on 2024-07-18 16:23</div>
            <div class="timeline-body"><blockquote>
<p>This seems to be unrelated to the original question.</p>
</blockquote>
<p>It seems related to me, but perhaps this illustates confusion on my part :-)</p>
<p>I'm trying to understand when and why (in future PRs) I should go via the <code>Files</code> APIs for reading information about files stored in the vendored zip archive, and when it makes sense to just get this information from the <code>VendoredFileSystem</code>. If I understand correctly, the tradeoffs are as follows:</p>
<ol>
<li>Going via the <code>Files</code> API has the advantage that the query is automatically invalidated when the file changes -- but the file will never change for vendored files, so, unlike with filesystem files, that's not a good reason to go via the <code>Files</code> API.</li>
<li>Going via the <code>Files</code> API has the advantage that the call is automatically cached. This means that if we go via the <code>Files</code> API, we'll end up querying the zip archive less frequently; but that could also cost more than it saves us, due to higher memory allocation/consumption, and because locking and lookups in the cache are also costly.</li>
<li>Going via the <code>Files</code> API gives you a <code>File</code> object that you can pass directly to queries such as <code>ruff_db::parsed::parsed_module</code>. You wouldn't be able to call these queries if you just read the contents of the file as a string using the <code>VendoredFileSystem</code> directly.</li>
</ol>
<p>Is that an accurate summary? I feel like my question has been answered now, anyway!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-18 16:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_module_resolver/src/path.rs</code>:390 on 2024-07-18 16:33</div>
            <div class="timeline-body"><p>I think that's a good summary. I now see how it is related.</p>
<p>Regarding <code>vendored_path_to_file(...).exists</code>. This is actually not cached for files that don't exist. We could, but we currently don't to avoid tracking <code>File</code>s for vendored paths that don't exist. So <code>vendored().exists</code> and <code>vendored_path_to_file(path).exists</code> have the same cost for files that don't exist.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-07-19 12:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_module_resolver/src/resolver.rs</code>:1621 on 2024-07-19 12:51</div>
            <div class="timeline-body"><p>I removed the test, since your file-watching PR adds tests that fail reliably without this fix</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2024-07-19 12:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-07-19 12:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-07-19 12:53</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 21:47:34 UTC
    </footer>
</body>
</html>
