```yaml
number: 7386
title: "fix: Group fluent subscript"
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: group-fluent-subscript-chain
created_at: 2023-09-14T09:48:45Z
updated_at: 2023-09-14T11:04:16Z
url: https://github.com/astral-sh/ruff/pull/7386
synced_at: 2026-01-12T15:55:23Z
```

# fix: Group fluent subscript

---

_@MichaReiser_

## Summary

Wrap fluent subscript calls in a group the same as for attributes or call expressions. This ensures that the chain only splits if it doesn't fit on a line and not if the enclosing group (e.g. all arguments) don't fit. 

This fixes a black deviation where 

```python
self.assertEqual(
    houses.all()[0].occupants.all()[0].houses.all()[1].rooms.all()[0],
    self.room2_1,
)


self.assertEqual(
    suite._tests[0].id().split(".")[0],
    os.path.basename(os.getcwd()),
)
```

was formatted as 

```python
self.assertEqual(
    houses.all()[0]
    .occupants.all()[0]
    .houses.all()[1]
    .rooms.all()[0],
    self.room2_1,
)


self.assertEqual(
    suite._tests[0]
    .id()
    .split(".")[0],
    os.path.basename(os.getcwd()),
)
```

because of the trailing comma. 


## Test Plan

Added test

**Base**

| project      | similarity index  | total files       | changed files     |
|--------------|------------------:|------------------:|------------------:|
| cpython      |           0.76083 |              1789 |              1632 |
| django       |           0.99981 |              2760 |                39 |
| transformers |           0.99952 |              2587 |               408 |
| twine        |           1.00000 |                33 |                 0 |
| typeshed     |           0.99983 |              3496 |                18 |
| warehouse    |           0.99923 |               648 |                18 |
| zulip        |           0.99962 |              1437 |                22 |


**This PR**

| project      | similarity index  | total files       | changed files     |
|--------------|------------------:|------------------:|------------------:|
| cpython      |           0.76083 |              1789 |              1632 |
| **django**       |           0.99982 |              2760 |                37 |
| transformers |           0.99952 |              2587 |               408 |
| twine        |           1.00000 |                33 |                 0 |
| typeshed     |           0.99983 |              3496 |                18 |
| warehouse    |           0.99923 |               648 |                18 |
| zulip        |           0.99962 |              1437 |                22 |



---

_Comment by @MichaReiser on 2023-09-14 09:48_

Current dependencies on/for this PR:
* main
  * **PR #7386** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7386" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  üëà

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7386?utm_source=stack-comment).

---

_Label `formatter` added by @MichaReiser on 2023-09-14 09:49_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/binary_like.rs`:670 on 2023-09-14 09:58_

This should reduce the number of groups that we write because we avoid grouping e.g. a single identifier `a` and we instead rely on expressions that can be grouped to create their own groups (which we were already doing except for subscript)

---

_@MichaReiser reviewed on 2023-09-14 09:58_

---

_Comment by @codspeed-hq[bot] on 2023-09-14 10:10_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/group-fluent-subscript-chain)

### Merging #7386 will **improve performances by 2.12%**

<sub>Comparing <code>group-fluent-subscript-chain</code> (12b81ca) with <code>main</code> (1f8e2b8)</sub>



### Summary

`‚ö° 2` improvements
`‚úÖ 23` untouched benchmarks




### Benchmarks breakdown

|     | Benchmark | `main` | `group-fluent-subscript-chain` | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ‚ö° | `formatter[pydantic/types.py]` | 20.1 ms | 19.7 ms | +2.12% |
| ‚ö° | `formatter[large/dataset.py]` | 58.8 ms | 57.6 ms | +2.08% |


---

_Comment by @MichaReiser on 2023-09-14 10:19_

> ## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/group-fluent-subscript-chain)
> ### Merging #7386 will **degrade performances by 2.64%**
> 
> Comparing `group-fluent-subscript-chain` ([f61be6d](https://github.com/astral-sh/ruff/commit/f61be6d951c8eb76408aa8b71a2c64e9d4cbb273)) with `main` ([58b3040](https://github.com/astral-sh/ruff/commit/58b3040342c2d8214eac5fd628a401bfd1acf73c))
> ### Summary
> 
> `‚ö° 1` improvements `‚ùå 1` regressions `‚úÖ 23` untouched benchmarks
> 
> > ‚ö†Ô∏è _Please fix the performance issues or [acknowledge them on CodSpeed](https://codspeed.io/astral-sh/ruff/branches/group-fluent-subscript-chain)._
> 
> ### Benchmarks breakdown
> 	Benchmark 	`main` 	`group-fluent-subscript-chain` 	Change
> ‚ö° 	`formatter[pydantic/types.py]` 	20.1 ms 	19.7 ms 	+2.15%
> ‚ùå 	`formatter[large/dataset.py]` 	58.9 ms 	60.5 ms 	-2.64%

Lol why always large dataset. The format IR output (in display representation) is reduced by 1500 lines (from 27700) and we write significantly fewer IR elements because each group has a start and end tag. Let's re-run this

---

_Review requested from @charliermarsh by @MichaReiser on 2023-09-14 10:22_

---

_@konstin approved on 2023-09-14 10:35_

---

_Merged by @MichaReiser on 2023-09-14 11:04_

---

_Closed by @MichaReiser on 2023-09-14 11:04_

---

_Branch deleted on 2023-09-14 11:04_

---
