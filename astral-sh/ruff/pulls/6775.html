<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix `uncessary-coding-comment` fix when there's leading content - astral-sh/ruff #6775</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix <code>uncessary-coding-comment</code> fix when there's leading content</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6775">#6775</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2023-08-22 15:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>Closes https://github.com/astral-sh/ruff/issues/6756</p>
<p>Including whitespace, code, and continuations.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-22 15:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/pyupgrade/rules/unnecessary_coding_comment.rs</code>:71 on 2023-08-22 15:53</div>
            <div class="timeline-body"><p>What happens if the coding comment is preceded by content, like:</p>
<pre><code class="language-python">print(x) # coding=utf8
print(&quot;Hello world&quot;)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-08-22 16:07</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>✅ ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.03      4.0±0.18ms    10.1 MB/sec    1.00      3.9±0.05ms    10.4 MB/sec
formatter/numpy/ctypeslib.py               1.00   821.9±31.04µs    20.3 MB/sec    1.00   824.6±14.86µs    20.2 MB/sec
formatter/numpy/globals.py                 1.05     85.8±1.85µs    34.4 MB/sec    1.00     81.7±2.80µs    36.1 MB/sec
formatter/pydantic/types.py                1.00  1591.7±49.23µs    16.0 MB/sec    1.00  1590.1±43.83µs    16.0 MB/sec
linter/all-rules/large/dataset.py          1.05     12.1±0.17ms     3.4 MB/sec    1.00     11.5±0.34ms     3.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.02      3.2±0.03ms     5.2 MB/sec    1.00      3.1±0.09ms     5.3 MB/sec
linter/all-rules/numpy/globals.py          1.05    457.8±4.09µs     6.4 MB/sec    1.00   438.1±14.17µs     6.7 MB/sec
linter/all-rules/pydantic/types.py         1.06      6.4±0.07ms     4.0 MB/sec    1.00      6.1±0.21ms     4.2 MB/sec
linter/default-rules/large/dataset.py      1.00      6.3±0.12ms     6.5 MB/sec    1.02      6.4±0.13ms     6.4 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1356.7±32.98µs    12.3 MB/sec    1.01  1372.3±33.24µs    12.1 MB/sec
linter/default-rules/numpy/globals.py      1.00    159.9±4.07µs    18.4 MB/sec    1.04    166.2±2.02µs    17.7 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.8±0.06ms     9.2 MB/sec    1.04      2.9±0.03ms     8.8 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.14      3.0±0.02ms    13.5 MB/sec    1.00      2.7±0.06ms    15.3 MB/sec
formatter/numpy/ctypeslib.py               1.11    577.9±5.41µs    28.8 MB/sec    1.00   522.6±13.40µs    31.9 MB/sec
formatter/numpy/globals.py                 1.07     59.0±0.80µs    50.0 MB/sec    1.00     55.1±2.00µs    53.6 MB/sec
formatter/pydantic/types.py                1.11  1210.6±15.96µs    21.1 MB/sec    1.00  1094.8±26.23µs    23.3 MB/sec
linter/all-rules/large/dataset.py          1.00      9.1±0.08ms     4.5 MB/sec    1.02      9.3±0.09ms     4.4 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      2.6±0.02ms     6.5 MB/sec    1.03      2.6±0.03ms     6.3 MB/sec
linter/all-rules/numpy/globals.py          1.00    265.7±4.20µs    11.1 MB/sec    1.03    273.0±5.54µs    10.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      4.8±0.05ms     5.3 MB/sec    1.03      4.9±0.08ms     5.2 MB/sec
linter/default-rules/large/dataset.py      1.00      5.1±0.05ms     8.0 MB/sec    1.03      5.2±0.04ms     7.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1063.4±9.53µs    15.7 MB/sec    1.02  1087.7±21.93µs    15.3 MB/sec
linter/default-rules/numpy/globals.py      1.00    107.8±1.93µs    27.4 MB/sec    1.02    109.6±1.98µs    26.9 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.3±0.02ms    11.2 MB/sec    1.03      2.3±0.03ms    10.9 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-08-22 17:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/src/rules/pyupgrade/rules/unnecessary_coding_comment.rs</code>:71 on 2023-08-22 17:38</div>
            <div class="timeline-body"><p>That shouldn't match our regex, but I can add test coverage</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-08-22 17:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/src/rules/pyupgrade/rules/unnecessary_coding_comment.rs</code>:71 on 2023-08-22 17:40</div>
            <div class="timeline-body"><p>Except it does get removed.. humph will investigate</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-22 17:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/pyupgrade/rules/unnecessary_coding_comment.rs</code>:71 on 2023-08-22 17:41</div>
            <div class="timeline-body"><p>The regular expression is only run over the comment (the range is that of the comment).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-08-22 17:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/src/rules/pyupgrade/rules/unnecessary_coding_comment.rs</code>:71 on 2023-08-22 17:42</div>
            <div class="timeline-body"><p>Yeah I just realized that — this was less clear when the variable was named <code>line</code>, pretty obvious now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-08-22 17:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/src/rules/pyupgrade/rules/unnecessary_coding_comment.rs</code>:71 on 2023-08-22 17:49</div>
            <div class="timeline-body"><p><a href="https://peps.python.org/pep-0263/">PEP 263</a> doesn't let you declare these as comments with other content on the line so I've updated the regex to apply to the full line in https://github.com/astral-sh/ruff/pull/6775/commits/f0db7a43008e3c50c7b20f5d483cd24989c6c43d</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/pyupgrade/rules/unnecessary_coding_comment.rs</code>:97 on 2023-08-22 18:16</div>
            <div class="timeline-body"><p>What if we're given this:</p>
<pre><code class="language-python">x = 1 \
  # coding=utf8
x = 2
</code></pre>
<p>Fixing to:</p>
<pre><code class="language-ppython">```python
x = 1 \
x = 2
</code></pre>
<p>Would lead to a syntax error. (I'm not certain that's what's happening, but we have to consider and test these kinds of cases too. We have some logic around that elsewhere via <code>preceded_by_continuations</code>.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-22 18:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff/src/rules/pyupgrade/rules/unnecessary_coding_comment.rs</code>:97 on 2023-08-22 18:21</div>
            <div class="timeline-body"><p>Yeesh. Alright will fix this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-08-22 18:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-22 18:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/pyupgrade/rules/unnecessary_coding_comment.rs</code>:97 on 2023-08-22 18:23</div>
            <div class="timeline-body"><p>If we don't, it will get fuzzed eventually :joy:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2023-08-22 19:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fuzzer</span> added by @zanieb on 2023-08-22 19:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Fix `uncessary-coding-comment` fix when there is same-line leading whitespace" to "Fix `uncessary-coding-comment` fix when there leading content" by @zanieb on 2023-08-22 19:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Fix `uncessary-coding-comment` fix when there leading content" to "Fix `uncessary-coding-comment` fix when there's leading content" by @zanieb on 2023-08-22 19:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-08-22 20:53</div>
            <div class="timeline-body"><p>I think another valid solution here would be: if the comment isn't at the beginning of the line, delete <em>just</em> the comment (not the <code>locator.full_line_end</code> of the comment). Possibly a bit simpler since you wouldn't need to expand the line for the regex, wouldn't need to special-case continuations, etc. But defer to you as the author.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-08-22 21:26</div>
            <div class="timeline-body"><p>Hm that seems kind of nice but in the end we probably don't want to retain that extra content. Are there other rules that would cover the removing the remaining whitespace and newlines? I'm tempted to just move on until we see another edge-case in the future.</p>
<blockquote>
<p>wouldn't need to expand the line for the regex</p>
</blockquote>
<p>I still think we should be doing this anyway as the regex is designed to match a full line.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-22 21:57</div>
            <div class="timeline-body"><p>I worry that the regex will open the door to other problems though. How does the regex fare with an example like this?</p>
<pre><code class="language-python">&quot;&quot;&quot;
# coding=utf8&quot;&quot;&quot; # empty comment
</code></pre>
<p>(I hadn't considered this before, this is a new observation.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-08-22 22:29</div>
            <div class="timeline-body"><p>:sigh: yeah that is broken too. We could address that in the current implementation by making the end of the regex more strict or by applying the regex twice (once to the comment itself and once to the line), but you've convinced me to reconsider the approach.</p>
<p>I'm not sure about just narrowing the match though. Per the PEP</p>
<blockquote>
<p>There must not be any Python statement on the line that contains the encoding declaration.</p>
</blockquote>
<p>we should probably just ignore cases entirely if the line doesn't match the regex. It feels incorrect to delete a comment when it's not a valid coding comment in the first place.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-22 22:33</div>
            <div class="timeline-body"><p>What about something like:</p>
<ul>
<li>If there is any non-whitespace content between the start of the line and the comment, don't flag it.</li>
<li>If there is whitespace at the start of the line, only remove the comment range (not the entire line) <em>or</em> expand to include the continuation in the deletion.</li>
<li>Otherwise, remove the entire line.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-08-23 15:32</div>
            <div class="timeline-body"><p>I think applying the regex twice is the simplest way to ensure we're doing the right thing here without rewriting this whole thing to use a tokenizer? I could do that here but I'm leaning towards opening that as a follow-up issue for a contributor and merging this fix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/pyupgrade/rules/unnecessary_coding_comment.rs</code>:66 on 2023-08-23 15:52</div>
            <div class="timeline-body"><p>I think I would still recommend doing something like:</p>
<pre><code class="language-rust">// Check if there's any content preceding the comment.
let line_start = locator.line_start(*range.start());
if !locator
    .slice(TextRange::new(line_start, range.start()))
    .trim()
    .is_empty()
{
    continue;
}
</code></pre>
<p>Personally, I find that much easier to understand than running the regex twice.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-08-23 15:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-08-23 16:02</div>
            <div class="timeline-body"><p>Thanks for the example — I thought you were suggesting using the tokenizer but that's nice and simple.</p>
<p>I think the only thing that differs now is</p>
<blockquote>
<p>If there is whitespace at the start of the line, only remove the comment range (not the entire line) or expand to include the continuation in the deletion.</p>
</blockquote>
<p>Comments following continuations are not valid coding definitions as far as I can tell, we probably shouldn't flag them at all. I think it's kind of academic at this point though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-23 16:42</div>
            <div class="timeline-body"><p>This looks great!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2023-08-23 17:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2023-08-23 17:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-08-23 17:00</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:59:43 UTC
    </footer>
</body>
</html>
