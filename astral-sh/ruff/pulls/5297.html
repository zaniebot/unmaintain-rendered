<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basic string formatting - astral-sh/ruff #5297</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Basic string formatting</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5297">#5297</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-06-22 12:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-22 12:20</div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>This PR implements formatting for non-f-string Strings that do not use implicit concatenation.</p>
<p>Docstring formatting is out of the scope of this PR.</p>
<!-- What's the purpose of the change? What does it do, and why? -->

<h2>Test Plan</h2>
<p>I added a few tests for simple string literals.</p>
<h2>Performance</h2>
<p>Ouch. This is hitting performance somewhat hard. This is probably because we now iterate each string a couple of times:</p>
<ol>
<li>To detect if it is an implicit string continuation</li>
<li>To detect if the string contains any new lines</li>
<li>To detect the preferred quote</li>
<li>To normalize the string</li>
</ol>
<p>Edit: I integrated the detection of newlines into the preferred quote detection so that we only iterate the string three time.
We can probably do better by merging the implicit string continuation with the quote detection and new line detection by iterating till the end of the string part and returning the offset. We then use our simple tokenizer to skip over any comments or whitespace until we find the first non trivia token. From there we keep continue doing this in a loop until we reach the end o the string. I'll leave this improvement for later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-22 12:20</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #5289</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5289" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #5292</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5292" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #5297</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5297" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5297?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-06-22 12:49</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01      7.4Â±0.35ms     5.5 MB/sec    1.00      7.3Â±0.32ms     5.6 MB/sec
formatter/numpy/ctypeslib.py               1.00  1723.0Â±93.08Âµs     9.7 MB/sec    1.01  1741.2Â±93.18Âµs     9.6 MB/sec
formatter/numpy/globals.py                 1.00   207.5Â±13.20Âµs    14.2 MB/sec    1.02   210.7Â±13.52Âµs    14.0 MB/sec
formatter/pydantic/types.py                1.04      3.9Â±0.40ms     6.5 MB/sec    1.00      3.8Â±0.21ms     6.7 MB/sec
linter/all-rules/large/dataset.py          1.07     15.7Â±0.92ms     2.6 MB/sec    1.00     14.7Â±0.46ms     2.8 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.7Â±0.15ms     4.5 MB/sec    1.01      3.7Â±0.18ms     4.5 MB/sec
linter/all-rules/numpy/globals.py          1.00   472.5Â±24.15Âµs     6.2 MB/sec    1.04   491.9Â±28.96Âµs     6.0 MB/sec
linter/all-rules/pydantic/types.py         1.01      6.6Â±0.31ms     3.8 MB/sec    1.00      6.6Â±0.33ms     3.9 MB/sec
linter/default-rules/large/dataset.py      1.00      7.2Â±0.25ms     5.7 MB/sec    1.07      7.7Â±0.45ms     5.3 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1580.9Â±77.03Âµs    10.5 MB/sec    1.04  1650.6Â±122.86Âµs    10.1 MB/sec
linter/default-rules/numpy/globals.py      1.00   189.4Â±10.17Âµs    15.6 MB/sec    1.01   191.5Â±12.14Âµs    15.4 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.4Â±0.18ms     7.5 MB/sec    1.00      3.4Â±0.14ms     7.5 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      8.0Â±0.09ms     5.1 MB/sec    1.00      8.0Â±0.07ms     5.1 MB/sec
formatter/numpy/ctypeslib.py               1.00  1773.0Â±15.83Âµs     9.4 MB/sec    1.00  1777.6Â±17.46Âµs     9.4 MB/sec
formatter/numpy/globals.py                 1.00    203.9Â±5.46Âµs    14.5 MB/sec    1.00    203.9Â±4.40Âµs    14.5 MB/sec
formatter/pydantic/types.py                1.00      4.1Â±0.04ms     6.3 MB/sec    1.01      4.1Â±0.06ms     6.2 MB/sec
linter/all-rules/large/dataset.py          1.00     15.2Â±0.12ms     2.7 MB/sec    1.00     15.3Â±0.08ms     2.7 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.1Â±0.10ms     4.1 MB/sec    1.00      4.1Â±0.02ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.00    427.5Â±6.56Âµs     6.9 MB/sec    1.00    428.0Â±8.00Âµs     6.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.9Â±0.04ms     3.7 MB/sec    1.01      6.9Â±0.06ms     3.7 MB/sec
linter/default-rules/large/dataset.py      1.00      8.0Â±0.09ms     5.1 MB/sec    1.00      8.1Â±0.05ms     5.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1671.0Â±15.33Âµs    10.0 MB/sec    1.00  1677.3Â±22.38Âµs     9.9 MB/sec
linter/default-rules/numpy/globals.py      1.00    181.6Â±3.37Âµs    16.2 MB/sec    1.00    181.5Â±1.88Âµs    16.3 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.6Â±0.02ms     7.0 MB/sec    1.01      3.7Â±0.02ms     7.0 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2023-06-22 14:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:110 on 2023-06-22 15:08</div>
            <div class="timeline-body"><p>can we debug_assert that this is only <code>&quot;</code> or <code>'</code> or can it be other chars, too?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:131 on 2023-06-22 15:09</div>
            <div class="timeline-body"><p>surprisingly, i've never seen this before</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:140 on 2023-06-22 15:10</div>
            <div class="timeline-body"><p>so glad about having gotten rid of python 2 compat everywhere :D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:154 on 2023-06-22 15:11</div>
            <div class="timeline-body"><p>i didn't realize this when using black, i always thought it was doing double quotes always, interesting to know</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:155 on 2023-06-22 15:12</div>
            <div class="timeline-body"><p>would it also be possible to count <code>'</code> and <code>&quot;</code> in the range?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:230 on 2023-06-22 15:23</div>
            <div class="timeline-body"><p>Could you add a <code>&quot;\\&quot;</code> (a backstring escaping a backstring) test, maybe with some form of  <code>&quot;\\' \&quot;\&quot;&quot;</code>  ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:247 on 2023-06-22 15:28</div>
            <div class="timeline-body"><pre><code class="language-suggestion">                    // Remove the escape by ending before the backstring and starting again with the quote
                    last_index = index + '\\'.len_utf8();
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:252 on 2023-06-22 15:29</div>
            <div class="timeline-body"><p>that's a neat trick, but i think it needs a comment somewhere at the top of the function</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/lib.rs</code>:345 on 2023-06-22 15:30</div>
            <div class="timeline-body"><p>why is that gone?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-06-22 15:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-22 15:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/lib.rs</code>:345 on 2023-06-22 15:56</div>
            <div class="timeline-body"><p>My understanding is that <code>ensure_stability_when_formatting_twice</code> now already asserts that reformatting the file twice yields the same result. Thanks to your refactor :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-22 15:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:131 on 2023-06-22 15:57</div>
            <div class="timeline-body"><p>I should probably add a comment linking to https://black.readthedocs.io/en/stable/the_black_code_style/current_style.html#r-strings-and-r-strings</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-22 16:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/string.rs</code>:155 on 2023-06-22 16:06</div>
            <div class="timeline-body"><p>I simplified the logic a bit. What this code does is counting the <code>'</code> and <code>&quot;</code> but in a single pass. Calling <code>.count()</code> would (possibly) traverse the string twice.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2023-06-22 16:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2023-06-22 16:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-23 07:35</div>
            <div class="timeline-body"><p><a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5297">Graphite</a> rebased this pull request after merging its parent, because this pull request is set to merge when ready.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-06-23 07:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-06-23 07:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-06-23 07:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-23 07:46</div>
            <div class="timeline-body"><p>@MichaReiser merged this pull request with <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5297">Graphite</a>.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 03:37:34 UTC
    </footer>
</body>
</html>
