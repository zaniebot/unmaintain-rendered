<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-type-checking`] Stabilize `quoted-type-alias` (`TC008`) - astral-sh/ruff #16639</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-type-checking</code>] Stabilize <code>quoted-type-alias</code> (<code>TC008</code>)</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16639">#16639</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-03-11 17:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Stabilizes TC008. The test was already in the right place.</p>
<h2>Test Plan</h2>
<p>No open issues or PRs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @ntBre on 2025-03-11 17:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "v0.10" by @ntBre on 2025-03-11 17:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-03-11 17:34</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_INSTRUMENTATION_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/brent%2Ftc008-0.10">CodSpeed Performance Report</a></h2>
<h3>Merging #16639 will <strong>degrade performances by 12.88%</strong></h3>
<p><sub>Comparing <code>brent/tc008-0.10</code> (174758b) with <code>micha/ruff-0.10</code> (5ec7c13)</sub></p>
<h3>Summary</h3>
<p><code>❌ 1</code> regressions<br />
<code>✅ 31</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/brent%2Ftc008-0.10">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ❌ | <code>red_knot_check_file[incremental]</code> | 4.8 ms | 5.5 ms | -12.88% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-11 17:36</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+9 -0 violations, +0 -0 fixes in 3 projects; 52 projects unchanged)</p>
<details><summary><a href="https://github.com/ibis-project/ibis">ibis-project/ibis</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>

<pre>
+ <a href='https://github.com/ibis-project/ibis/blob/f6ea1ca4959617b84a7f01dd5d1237c5cf22ab95/ibis/common/typing.py#L28'>ibis/common/typing.py:28:47:</a> TC008 [*] Remove quotes from type alias
</pre>

</p>
</details>
<details><summary><a href="https://github.com/latchbio/latch">latchbio/latch</a> (+3 -0 violations, +0 -0 fixes)</summary>
<p>

<pre>
+ <a href='https://github.com/latchbio/latch/blob/66920c3cd06ceb02109db8525c62b5569f5c459b/src/latch/ldata/_transfer/upload.py#L30'>src/latch/ldata/_transfer/upload.py:30:32:</a> TC008 [*] Remove quotes from type alias
+ <a href='https://github.com/latchbio/latch/blob/66920c3cd06ceb02109db8525c62b5569f5c459b/src/latch/ldata/_transfer/upload.py#L31'>src/latch/ldata/_transfer/upload.py:31:35:</a> TC008 [*] Remove quotes from type alias
+ <a href='https://github.com/latchbio/latch/blob/66920c3cd06ceb02109db8525c62b5569f5c459b/src/latch_cli/snakemake/config/utils.py#L13'>src/latch_cli/snakemake/config/utils.py:13:33:</a> TC008 [*] Remove quotes from type alias
</pre>

</p>
</details>
<details><summary><a href="https://github.com/zulip/zulip">zulip/zulip</a> (+5 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --no-preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/zulip/zulip/blob/48e8250e2836fc39472518b7bf5d69da543eb768/analytics/views/stats.py#L341'>analytics/views/stats.py:341:14:</a> TC008 [*] Remove quotes from type alias
+ <a href='https://github.com/zulip/zulip/blob/48e8250e2836fc39472518b7bf5d69da543eb768/analytics/views/stats.py#L343'>analytics/views/stats.py:343:16:</a> TC008 [*] Remove quotes from type alias
+ <a href='https://github.com/zulip/zulip/blob/48e8250e2836fc39472518b7bf5d69da543eb768/confirmation/models.py#L76'>confirmation/models.py:76:5:</a> TC008 [*] Remove quotes from type alias
+ <a href='https://github.com/zulip/zulip/blob/48e8250e2836fc39472518b7bf5d69da543eb768/confirmation/models.py#L77'>confirmation/models.py:77:5:</a> TC008 [*] Remove quotes from type alias
+ <a href='https://github.com/zulip/zulip/blob/48e8250e2836fc39472518b7bf5d69da543eb768/zerver/lib/push_notifications.py#L76'>zerver/lib/push_notifications.py:76:49:</a> TC008 [*] Remove quotes from type alias
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| TC008 | 9 | 9 | 0 | 0 | 0 |</p>
</p>
</details>

<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-03-11 17:51</div>
            <div class="timeline-body"><p>These all look like false positives except the latchbio cases.</p>
<p>The Zulip cases require an import that is conditional on some <code>settings</code> type other than <code>TYPE_CHECKING</code>, so I think unconditionally unquoting those could be a problem.</p>
<p>And the ibis case is a recursive type alias, which I think must be quoted? Possibly the rule doesn't descend into the <code>Union</code> because it handles the <code>... | ...</code> version fine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Daverball">@Daverball</a> on 2025-03-12 07:47</div>
            <div class="timeline-body"><blockquote>
<p>The Zulip cases require an import that is conditional on some <code>settings</code> type other than <code>TYPE_CHECKING</code>, so I think unconditionally unquoting those could be a problem.</p>
</blockquote>
<p>Indeed, it would be a problem, although in order to detect this type of stuff we would need to start tracking all conditional bindings separately, not just <code>ConditionalDeletion</code> and I'm not fully convinced it's worth the extra complexity. Although we could probably come up with a more simple heuristic to exclude some bindings, like e.g. if the parent statement is an if/try statement without a corresponding shadowing binding in the other branch, then we reject that binding.</p>
<blockquote>
<p>And the ibis case is a recursive type alias, which I think must be quoted? Possibly the rule doesn't descend into the <code>Union</code> because it handles the <code>... | ...</code> version fine.</p>
</blockquote>
<p>It's because the if branch before it also defines the same symbol, so our naïve approach to bindings assumes the <code>else</code> branch has access to the symbol, since it was defined before our type alias definition. If recursive type aliases were broken, the line in the other branch would also yield a false positive.</p>
<p>So this is a similar problem to the other one, although it seems slightly easier to fix, e.g. by walking the parent statements of the the binding and reference in order to determine whether or not they are part of the same if statement, and if they are, whether or not they're part of the same branch. We would also need to do the same thing for match statements.</p>
<p>Red knot might be better suited for detecting these types of things though, since control flow analysis could tell us which bindings are unreachable starting from our reference.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-12 08:28</div>
            <div class="timeline-body"><p>Let's keep this rule in preview then and create a follow up issue. @dylwil3 has also done some work on control flow analysis in Ruff that might become useful here, once it's ready for prime time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-03-12 18:32</div>
            <div class="timeline-body"><p>Sounds good, I'll close this for now.</p>
<p>@Daverball thank you for the additional context here and on some of these other PRs. I really appreciate it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-03-12 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-05-01 15:32</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:10:39 UTC
    </footer>
</body>
</html>
