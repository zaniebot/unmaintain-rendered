<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Emit a diagnostic when frozen dataclass inherits a non-frozen dataclass and the other way around - astral-sh/ruff #21962</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Emit a diagnostic when frozen dataclass inherits a non-frozen dataclass and the other way around</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21962">#21962</a>
        opened by <a href="https://github.com/silamon">@silamon</a>
        on 2025-12-13 16:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/silamon">@silamon</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff/ty! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title? (Please prefix with `[ty]` for ty pull
  requests.)
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>Introduce a new diagnostic that is raised in the following situations:</p>
<ul>
<li>Checks for non-frozen dataclasses that inherit from frozen dataclasses.</li>
<li>Checks for frozen dataclasses that inherit from non-frozen dataclasses.</li>
</ul>
<h2>Test Plan</h2>
<p>Tests have been added.
The diagnostics include example codes to test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @silamon on 2025-12-13 16:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @silamon on 2025-12-13 16:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @silamon on 2025-12-13 16:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @silamon on 2025-12-13 16:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Raise a diagnostic when frozen dataclass inherits a non-frozen dataclass and the other way around" to "[ty] Emit a diagnostic when frozen dataclass inherits a non-frozen dataclass and the other way around" by @AlexWaygood on 2025-12-13 16:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-12-13 16:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-13 16:56</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<details>
<summary>Changes were detected when running ty on typing conformance tests</summary>

<pre><code class="language-diff">--- old-output.txt	2025-12-13 20:51:37.689793991 +0000
+++ new-output.txt	2025-12-13 20:51:41.343814255 +0000
@@ -282,6 +282,8 @@
 dataclasses_final.py:38:1: error[invalid-assignment] Cannot assign to final attribute `final_with_default` on type `&lt;class 'D'&gt;`
 dataclasses_frozen.py:16:1: error[invalid-assignment] Property `a` defined in `DC1` is read-only
 dataclasses_frozen.py:17:1: error[invalid-assignment] Property `b` defined in `DC1` is read-only
+dataclasses_frozen.py:23:7: error[invalid-frozen-dataclass-subclass] Non-frozen dataclass `DC2` cannot inherit from frozen dataclass `DC1`
+dataclasses_frozen.py:33:7: error[invalid-frozen-dataclass-subclass] Frozen dataclass `DC4` cannot inherit from non-frozen dataclass `DC3`
 dataclasses_kwonly.py:23:11: error[too-many-positional-arguments] Too many positional arguments: expected 1, got 2
 dataclasses_kwonly.py:38:11: error[too-many-positional-arguments] Too many positional arguments: expected 1, got 2
 dataclasses_kwonly.py:53:11: error[too-many-positional-arguments] Too many positional arguments: expected 1, got 2
@@ -342,6 +344,7 @@
 dataclasses_transform_func.py:70:8: error[missing-argument] No arguments provided for required parameters `id`, `name`
 dataclasses_transform_func.py:70:18: error[too-many-positional-arguments] Too many positional arguments: expected 0, got 2
 dataclasses_transform_func.py:76:36: error[invalid-return-type] Function always implicitly returns `None`, which is not assignable to return type `T@create_model_frozen`
+dataclasses_transform_func.py:89:7: error[invalid-frozen-dataclass-subclass] Non-frozen dataclass `Customer3Subclass` cannot inherit from frozen dataclass `Customer3`
 dataclasses_transform_func.py:96:1: error[invalid-assignment] Property `id` defined in `Customer3` is read-only
 dataclasses_transform_meta.py:63:1: error[invalid-assignment] Property `id` defined in `Customer1` is read-only
 dataclasses_transform_meta.py:66:8: error[missing-argument] No arguments provided for required parameters `id`, `name`
@@ -1022,4 +1025,4 @@
 typeddicts_usage.py:28:17: error[missing-typed-dict-key] Missing required key 'name' in TypedDict `Movie` constructor
 typeddicts_usage.py:28:18: error[invalid-key] Unknown key &quot;title&quot; for TypedDict `Movie`: Unknown key &quot;title&quot;
 typeddicts_usage.py:40:24: error[invalid-type-form] The special form `typing.TypedDict` is not allowed in type expressions
-Found 1024 diagnostics
+Found 1027 diagnostics

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-13 16:56</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">attrs (https://github.com/python-attrs/attrs)
+ tests/test_functional.py:84:7: error[invalid-frozen-dataclass-subclass] Non-frozen dataclass `SubFrozen` cannot inherit from frozen dataclass `Frozen`
+ tests/test_next_gen.py:252:15: error[invalid-frozen-dataclass-subclass] Non-frozen dataclass `C` cannot inherit from frozen dataclass `B`
+ tests/test_next_gen.py:297:19: error[invalid-frozen-dataclass-subclass] Non-frozen dataclass `C` cannot inherit from frozen dataclass `A`
- Found 605 diagnostics
+ Found 608 diagnostics

scikit-build-core (https://github.com/scikit-build/scikit-build-core)
- src/scikit_build_core/build/wheel.py:98:20: error[no-matching-overload] No overload of bound method `__init__` matches arguments
- Found 42 diagnostics
+ Found 41 diagnostics

pandas-stubs (https://github.com/pandas-dev/pandas-stubs)
+ pandas-stubs/_typing.pyi:1218:16: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 5136 diagnostics
+ Found 5137 diagnostics


</code></pre>
</details>

<p>No memory usage changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/diagnostic.rs</code>:2279 on 2025-12-13 16:58</div>
            <div class="timeline-body"><p>we should indeed catch this error, but not for the reason you describe in the documentation here ðŸ˜„ We should catch this error because it raises an exception at runtime!</p>
<pre><code class="language-pycon">&gt;&gt;&gt; from dataclasses import dataclass
&gt;&gt;&gt; @dataclass(frozen=True)
... class Foo:
...     x: int
...     
&gt;&gt;&gt; @dataclass
... class Bar(Foo):
...     y: str
...     
Traceback (most recent call last):
  File &quot;&lt;python-input-4&gt;&quot;, line 1, in &lt;module&gt;
    @dataclass
     ^^^^^^^^^
  File &quot;/Users/alexw/.pyenv/versions/3.13.1/lib/python3.13/dataclasses.py&quot;, line 1305, in dataclass
    return wrap(cls)
  File &quot;/Users/alexw/.pyenv/versions/3.13.1/lib/python3.13/dataclasses.py&quot;, line 1295, in wrap
    return _process_class(cls, init, repr, eq, order, unsafe_hash,
                          frozen, match_args, kw_only, slots,
                          weakref_slot)
  File &quot;/Users/alexw/.pyenv/versions/3.13.1/lib/python3.13/dataclasses.py&quot;, line 1038, in _process_class
    raise TypeError('cannot inherit non-frozen dataclass from a '
                    'frozen one')
TypeError: cannot inherit non-frozen dataclass from a frozen one
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/diagnostic.rs</code>:2250 on 2025-12-13 17:01</div>
            <div class="timeline-body"><p>Same here. I think we should definitely emit a diagnostic if we see this. But the documentation should just say that it raises an exception at runtime; there's no need to start talking abstractly about contracts or anything like that :-)</p>
<pre><code class="language-pycon">&gt;&gt;&gt; from dataclasses import dataclass
&gt;&gt;&gt; @dataclass
... class Foo:
...     x: int
...
&gt;&gt;&gt; @dataclass(frozen=True)
... class Bar(Foo):
...     y: str
...     
Traceback (most recent call last):
  File &quot;&lt;python-input-8&gt;&quot;, line 1, in &lt;module&gt;
    @dataclass(frozen=True)
     ~~~~~~~~~^^^^^^^^^^^^^
  File &quot;/Users/alexw/.pyenv/versions/3.13.1/lib/python3.13/dataclasses.py&quot;, line 1295, in wrap
    return _process_class(cls, init, repr, eq, order, unsafe_hash,
                          frozen, match_args, kw_only, slots,
                          weakref_slot)
  File &quot;/Users/alexw/.pyenv/versions/3.13.1/lib/python3.13/dataclasses.py&quot;, line 1043, in _process_class
    raise TypeError('cannot inherit frozen dataclass from a '
                    'non-frozen one')
TypeError: cannot inherit frozen dataclass from a non-frozen one
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-12-13 17:02</div>
            <div class="timeline-body"><p>Nice, we should definitely emit these diagnostics! These always raise exceptions at runtime, so it's a great thing for a type checker to catch.</p>
<p>But let's improve the documentation and add some tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-13 17:16</div>
            <div class="timeline-body"><p>The typing conformance suite results are great! They show us now emitting diagnostics on several places where we are meant to, but where we previously didn't.</p>
<p>The mypy_primer results show us now emitting three false-positive diagnostics on <code>attrs</code>. <code>attrs</code> has slightly different semantics to the stdlib <code>dataclasses</code> module here, apparently. For the stdlib <code>dataclasses</code> module, you <em>have</em> to explicitly pass <code>frozen=True</code> for a <code>@dataclass</code> subclass of a <code>frozen=True</code> <code>@dataclass</code> superclass. But for <code>attrs</code>, any subclass of a <code>frozen=True</code> <code>@attr.s</code> superclass is implicitly frozen.</p>
<p>The fact that we now emit a few false positives on <code>attrs</code> is a bit unfortunate, but I think it's fine. I don't think you need to worry about it here. We might add some special-cased support for <code>attrs</code> in the future, but until that point it's the right thing for us to just assume that <code>attrs</code> classes have the exact same semantics as stdlib dataclasses.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-13 18:14</div>
            <div class="timeline-body"><p>Maybe these should just be one error code? <code>invalid-frozen-dataclass-subclass</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @silamon on 2025-12-13 18:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-12-13 20:52</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-12-13 20:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-12-13 20:59</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:18:03 UTC
    </footer>
</body>
</html>
