<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feature: Add SARIF output support - astral-sh/ruff #9078</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Feature: Add SARIF output support</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/9078">#9078</a>
        opened by <a href="https://github.com/C-Hipple">@C-Hipple</a>
        on 2023-12-10 02:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/C-Hipple">@C-Hipple</a> on 2023-12-10 02:03</div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>Adds support for sarif v2.1.0 output to cli, usable via the output-format paramter.</p>
<p><code>ruff . --output-format=sarif</code></p>
<p>Includes a few changes I wasn't sure of, namely:</p>
<ul>
<li>Adds a few derives for Clone &amp; Copy, which I think could be removed with a little extra work as well.</li>
</ul>
<h2>Test Plan</h2>
<!-- How was it tested? -->

<p>I built and ran this against several large open source projects and verified that the output sarif was valid, using <a href="https://sarifweb.azurewebsites.net/Validation">Microsoft's SARIF validator tool</a></p>
<p>I've also attached an output of the sarif generated by this version of ruff on the main branch of django at commit: b287af5dc9
<a href="https://github.com/astral-sh/ruff/files/13626222/django_main_b287af5dc9_sarif.json">django_main_b287af5dc9_sarif.json</a></p>
<p>Note: this needs to be regenerated with the latest changes and confirmed.</p>
<h2>Open Points</h2>
<p>[ ] Convert to just using all Rules all the time
[ ] Fix the issue with getting the file URI when compiling for web assembly</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "add sarif output--update snapshots" to "Feature: Add SARIF output support" by @C-Hipple on 2023-12-10 02:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-12-10 02:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_cli/src/lib.rs</code>:427 on 2023-12-10 02:11</div>
            <div class="timeline-body"><p>So one potential issue here is that <code>pyproject_config</code> isn't guaranteed to contain the correct set of enabled rules for all files. Ruff supports hierarchical configuration, so you can have different configuration files that apply to different subdirectories in your project. The <code>pyproject_config</code> here really just represents the settings in the current working directory.</p>
<p>Could we infer the set of rules from the diagnostic messages? (What is this used for on the SARIF side?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/message/sarif.rs</code>:105 on 2023-12-10 02:12</div>
            <div class="timeline-body"><p>Nit: we tend to <code>derive(Debug)</code> for all structs that can support it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-12-10 02:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-12-10 02:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/message/sarif.rs</code>:129 on 2023-12-10 02:14</div>
            <div class="timeline-body"><p>If <code>filename</code> is relative here, would this convert it to absolute? I do think <code>filename</code> will always be absolute here... we pass around absolute paths, and expect callers to call <code>relativize_path</code> when displaying user-facing relative paths... But we may want to be defensive (call <code>.canonicalize()</code> or <code>normalize_path</code> or similar).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/C-Hipple">@C-Hipple</a> reviewed on 2023-12-10 02:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/C-Hipple">@C-Hipple</a> on <code>crates/ruff_linter/src/message/sarif.rs</code>:129 on 2023-12-10 02:18</div>
            <div class="timeline-body"><p>This is what I was referring to in the PR body.  It'll error if the path is relative, which is why I changed the path in the snapshot files.  I'll update to safely handle relative paths, should be straight forward.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-12-10 02:21</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>‚úÖ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>‚úÖ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/C-Hipple">@C-Hipple</a> reviewed on 2023-12-10 02:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/C-Hipple">@C-Hipple</a> on <code>crates/ruff_cli/src/lib.rs</code>:427 on 2023-12-10 02:25</div>
            <div class="timeline-body"><p>Gotcha--thanks for that context.  SARIF lists the rules applied as part of the tool description so that you can be sure you're getting an apples to apples comparison, rather than just saying both times you checked with a particular rust version.</p>
<p>While the field is not mandatory in the SARIF specification <a href="https://docs.oasis-open.org/sarif/sarif/v2.1.0/errata01/os/sarif-v2.1.0-errata01-os-complete.html#_Toc141790806">Section 3.19.23 rules property</a> it is <a href="https://docs.github.com/en/code-security/code-scanning/integrating-with-code-scanning/sarif-support-for-code-scanning">required by Github</a>.   Also see: <a href="https://docs.github.com/en/code-security/code-scanning/integrating-with-code-scanning/sarif-support-for-code-scanning#understanding-rules-and-results">Understand Rules and Results</a></p>
<p>I'm not exactly sure how github would handle having the <code>rules</code> be supplied as only the ones for which diagnostics could be found as that's not documented.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-12-10 02:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/message/sarif.rs</code>:129 on 2023-12-10 02:45</div>
            <div class="timeline-body"><p>üëç I did see that, but wasn't sure how <code>Url::from_file_path</code> would behave if the path wasn't absolute.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-12-10 02:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_cli/src/lib.rs</code>:427 on 2023-12-10 02:46</div>
            <div class="timeline-body"><p>Alternatively, could we just include <em>all</em> rules?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/C-Hipple">@C-Hipple</a> reviewed on 2023-12-10 03:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/C-Hipple">@C-Hipple</a> on <code>crates/ruff_linter/src/message/sarif.rs</code>:129 on 2023-12-10 03:03</div>
            <div class="timeline-body"><p>yeah, <code>normalize_path</code> seems like the right call here, as <code>.canonicalize()</code> will fail if the file doesn't actually exist (a la in test).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/C-Hipple">@C-Hipple</a> reviewed on 2023-12-10 03:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/C-Hipple">@C-Hipple</a> on <code>crates/ruff_cli/src/lib.rs</code>:427 on 2023-12-10 03:07</div>
            <div class="timeline-body"><p>Including all rules is probably the safest bet.  In my experience with code scanning on github, I've never looked at what checks were done, only the findings, so this is probably closest to the SARIF expectation.  My gut is that most people have most rules applied, and only turn off a handful, but I could be wrong, especially for older/larger projects.</p>
<p>Only downsides are if someone complains and then we change it, if others are using it in their CI, the rules set will change, which again, not sure how bad that is and that the file size will be a bit larger.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/C-Hipple">@C-Hipple</a> reviewed on 2023-12-10 04:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/C-Hipple">@C-Hipple</a> on <code>crates/ruff_linter/src/message/sarif.rs</code>:147 on 2023-12-10 04:11</div>
            <div class="timeline-body"><p>probably buggy</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-12-10 15:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_cli/src/lib.rs</code>:427 on 2023-12-10 15:09</div>
            <div class="timeline-body"><p>Let's try all-rules for now. You can iterate over them with <code>Rule::iter()</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-12-12 22:38</div>
            <div class="timeline-body"><p>I think this is probably good to merge once we change to enumerate all-rules. @C-Hipple do you plan to make that change, or would you like a hand?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/C-Hipple">@C-Hipple</a> on 2023-12-13 01:53</div>
            <div class="timeline-body"><p>I was planning on making this change tonight/tomorrow, but if that falls
through I'll let you know as I'll be leaving on a trip.  Seems simple
enough and also fix the issue to build for wasm seems straightforward.</p>
<p>On Tue, Dec 12, 2023, 5:38‚ÄØPM Charlie Marsh <em><strong>@</strong></em>.***&gt;
wrote:</p>
<blockquote>
<p><em><strong>@</strong></em>.**** commented on this pull request.</p>
<p>I think this is probably good to merge once we change to enumerate
all-rules. @C-Hipple <a href="https://github.com/C-Hipple">https://github.com/C-Hipple</a> do you plan to make
that change, or would you like a hand?</p>
<p>‚Äî
Reply to this email directly, view it on GitHub
<a href="https://github.com/astral-sh/ruff/pull/9078#pullrequestreview-1778552548">https://github.com/astral-sh/ruff/pull/9078#pullrequestreview-1778552548</a>,
or unsubscribe
<a href="https://github.com/notifications/unsubscribe-auth/ACBKSYUSPPC5AYNRJ5PRJ33YJDMIFAVCNFSM6AAAAABAOGQWJWVHI2DSMVQWIX3LMV43YUDVNRWFEZLROVSXG5CSMV3GSZLXHMYTONZYGU2TENJUHA">https://github.com/notifications/unsubscribe-auth/ACBKSYUSPPC5AYNRJ5PRJ33YJDMIFAVCNFSM6AAAAABAOGQWJWVHI2DSMVQWIX3LMV43YUDVNRWFEZLROVSXG5CSMV3GSZLXHMYTONZYGU2TENJUHA</a>
.
You are receiving this because you were mentioned.Message ID:
<em><strong>@</strong></em>.***&gt;</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-13 03:52</div>
            <div class="timeline-body"><p>Nice, thanks @C-Hipple!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/C-Hipple">@C-Hipple</a> on 2023-12-13 04:24</div>
            <div class="timeline-body"><p>please don't merge it yet--I'm adding a few more sarif fields</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-13 04:25</div>
            <div class="timeline-body"><p>@C-Hipple -- Okay, sounds good. I just removed some of the copy and clone changes since the code seems to compile without them now. I'll wait for you to mark as ready for review.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/C-Hipple">@C-Hipple</a> on 2023-12-13 04:26</div>
            <div class="timeline-body"><p>Thanks--your changes look good.  Appreciate your input there as I&quot;m relatively new to rust and was kinda using this issue as a way of getting a bit more familiar.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-13 04:28</div>
            <div class="timeline-body"><p>Any questions let me know. Sorry if I stepped on your toes, didn't realize you were planning more changes!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/C-Hipple">@C-Hipple</a> on 2023-12-13 04:39</div>
            <div class="timeline-body"><blockquote>
<p>@C-Hipple -- Okay, sounds good. I just removed some of the copy and clone changes since the code seems to compile without them now. I'll wait for you to mark as ready for review.</p>
</blockquote>
<p>Yeah, those were needed at one point with how SarifResults were copying rules into them, was also planning on backing them out but you beat me to it.</p>
<blockquote>
<p>Any questions let me know. Sorry if I stepped on your toes, didn't realize you were planning more changes!</p>
</blockquote>
<p>no worries!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/C-Hipple">@C-Hipple</a> on 2023-12-13 05:03</div>
            <div class="timeline-body"><p>@charliermarsh I'm happy with the PR now, but I'm really unsure of the last commit--the <code>anyhow</code> import was failing lint due to being unused in wasm and it was also failing lint for unnecessary wrapping, so I just ignored the errors, but open to learning if there's a more appropriate/idiomatic way</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @C-Hipple on 2023-12-13 05:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-13 05:22</div>
            <div class="timeline-body"><p>@C-Hipple -- What you have there is reasonable! But I'll play around with it and see if it can be improved.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-13 05:31</div>
            <div class="timeline-body"><p>@C-Hipple -- The only change I made was to use absolute references for the imports that were unused in the Wasm path. It's not a material difference, but it is nice to avoid the unused import ignore.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-13 05:32</div>
            <div class="timeline-body"><p>Unfortunately, <code>#[allow(clippy::unnecessary_wraps)]</code> is hard to avoid since we need the function to have the same signature on all platforms -- so if <em>any</em> of them return a <code>Result</code>, they <em>all</em> need to return a <code>Result</code>. We run into this in other parts of Ruff too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-12-13 05:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">linter</span> added by @charliermarsh on 2023-12-13 05:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-12-13 05:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-12-13 05:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-12-19 20:15</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 23:31:44 UTC
    </footer>
</body>
</html>
