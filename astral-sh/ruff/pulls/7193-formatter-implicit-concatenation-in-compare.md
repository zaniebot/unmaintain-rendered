```yaml
number: 7193
title: "Formatter: Implicit concatenation in compare expressions"
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: flatten-compare-expression
created_at: 2023-09-06T14:21:53Z
updated_at: 2023-09-21T10:38:44Z
url: https://github.com/astral-sh/ruff/pull/7193
synced_at: 2026-01-12T02:39:09Z
```

# Formatter: Implicit concatenation in compare expressions

---

_Pull request opened by @MichaReiser on 2023-09-06 14:21_

## Summary

This PR implements the logic for breaking implicit concatenated strings before compare expressions by building on top of  #7145 

The main change is a new `BinaryLike` enum that has the `BinaryExpression` and `CompareExpression` variants. Supporting both variants requires some downstream changes but doesn't introduce any new concepts. 

## Test Plan

I added a few more tests. The compatibility improvements are minor but we now perfectly match black on twine :partying_face: 


**PR**

| project      | similarity index  | total files       | changed files     |
|--------------|------------------:|------------------:|------------------:|
| cpython      |           0.76083 |              1789 |              1632 |
| django       |           0.99966 |              2760 |                58 |
| transformers |           0.99928 |              2587 |               454 |
| **twine**        |           1.00000 |                33 |                 0 | <-- improved
| typeshed     |           0.99978 |              3496 |              2173 |
| **warehouse**    |           0.99824 |               648 |                22 | <-- improved
| zulip        |           0.99948 |              1437 |                28 |


**Base**

| project      | similarity index  | total files       | changed files     |
|--------------|------------------:|------------------:|------------------:|
| cpython      |           0.76083 |              1789 |              1633 |
| django       |           0.99966 |              2760 |                58 |
| transformers |           0.99928 |              2587 |               454 |
| twine        |           0.99982 |                33 |                 1 | 
| typeshed     |           0.99978 |              3496 |              2173 |
| warehouse    |           0.99823 |               648 |                23 |
| zulip        |           0.99948 |              1437 |                28 |




---

_Comment by @MichaReiser on 2023-09-06 14:22_

Current dependencies on/for this PR:
* main
  * **PR #7145** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7145" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7193** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7193" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  üëà
      * **PR #7215** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7215" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #7217** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7217" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #7219** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7219" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
            * **PR #7242** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7242" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
              * **PR #7567** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7567" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7193?utm_source=stack-comment).

---

_Label `formatter` added by @MichaReiser on 2023-09-06 14:44_

---

_Added to milestone `Formatter: Beta` by @MichaReiser on 2023-09-06 15:26_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/binary_like.rs`:30 on 2023-09-06 16:12_

This is mostly moved from `flatten_binary_expression` except that it now supports compare expressions too

---

_@MichaReiser reviewed on 2023-09-06 16:12_

---

_Marked ready for review by @MichaReiser on 2023-09-06 16:27_

---

_Comment by @codspeed-hq[bot] on 2023-09-07 09:56_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/flatten-compare-expression)

### Merging #7193 will **degrade performances by 2.5%**

<sub>Comparing <code>flatten-compare-expression</code> (119a229) with <code>flatten-binary-expression</code> (8f4ae4c)</sub>



### Summary

`‚ùå 1` regressions
`‚úÖ 24` untouched benchmarks



> :warning: _Please fix the performance issues or [acknowledge them on CodSpeed](https://codspeed.io/astral-sh/ruff/branches/flatten-compare-expression)._

### Benchmarks breakdown

|     | Benchmark | `flatten-binary-expression` | `flatten-compare-expression` | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ‚ùå | `linter/all-rules[numpy/ctypeslib.py]` | 32.6 ms | 33.5 ms | -2.5% |


---

_Review requested from @charliermarsh by @MichaReiser on 2023-09-08 06:39_

---

_Review requested from @konstin by @MichaReiser on 2023-09-08 06:39_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/binary_like.rs`:59 on 2023-09-08 07:51_

Can this  ever happen/should this be a (debug_)assert?

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/binary_like.rs`:191 on 2023-09-08 08:04_

Could you add some comments about what datastructure we're building here?

---

_@konstin approved on 2023-09-08 08:06_

100% on twine!

---

_@MichaReiser reviewed on 2023-09-08 08:18_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/binary_like.rs`:191 on 2023-09-08 08:18_

There's somewhat extensive documentation on the `FlatBinaryExpressionSlice` 

---

_@konstin reviewed on 2023-09-08 08:19_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/binary_like.rs`:191 on 2023-09-08 08:19_

Could you link `FlatBinaryExpressionSlice` here?

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/binary_like.rs`:59 on 2023-09-08 08:21_

This should never happen for a valid tree but using a result (for which the formatter has good infrastructure) allows me to avoid the panic (and the resulting ruff crash). This is also similar to other code where we return a SyntaxError when we e.g. fail to find a keyword. 

But I don't feel strongly. We can also convert this to an assertion (I don't want to use a debug assertion because I want to abort to avoid formatting broken code and potentially removing code)

---

_@MichaReiser reviewed on 2023-09-08 08:22_

---

_@konstin reviewed on 2023-09-08 09:05_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/binary_like.rs`:59 on 2023-09-08 09:05_

my rule of thumb is: If i can't write a reasonable test case where this error gets returned, i use an assertion. I think a crash is fine than because we're then in a state we should never be in (and recovery is not modifying the user's file)

---

_Merged by @MichaReiser on 2023-09-08 09:32_

---

_Closed by @MichaReiser on 2023-09-08 09:32_

---

_Comment by @MichaReiser on 2023-09-08 09:32_

### Merge Activity

* **Sep 8, 5:32 AM**: @MichaReiser merged this pull request with [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7193).


---

_Branch deleted on 2023-09-08 09:32_

---
