<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ruff_db: switch diagnostic rendering over to `std::fmt::Display` - astral-sh/ruff #17154</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>ruff_db: switch diagnostic rendering over to <code>std::fmt::Display</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17154">#17154</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2025-04-02 14:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a></div>
            <div class="timeline-body"><p>It was already using this approach internally, so this is &quot;just&quot; a
matter of rejiggering the public API of <code>Diagnostic</code>.</p>
<p>We were previously writing directly to a <code>std::io::Write</code> since it was
thought that this worked better with the linear typing fakery. Namely,
it increased confidence that the diagnostic rendering was actually
written somewhere useful, instead of just being converted to a string
that could potentially get lost.</p>
<p>For reasons discussed in #17130, the linear type fakery was removed.
And so there is less of a reason to require a <code>std::io::Write</code>
implementation for diagnostic rendering. Indeed, this would sometimes
result in <code>unwrap()</code> calls when one wants to convert to a <code>String</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-04-02 14:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-04-02 14:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-04-02 14:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-04-02 14:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-04-02 14:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/dcreager">@dcreager</a> removed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-04-02 14:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/carljm">@carljm</a> removed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-04-02 14:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/sharkdp">@sharkdp</a> removed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-04-02 14:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/AlexWaygood">@AlexWaygood</a> removed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-04-02 14:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_ide/src/goto.rs</code>:874 on 2025-04-02 14:43</div>
            <div class="timeline-body"><p>Nit: In case you only created the <code>display</code> variable so that you can used name format args</p>
<pre><code>                write!(buf, &quot;{diag}&quot;, diag=diag.display(&amp;self.db, &amp;config)).unwrap();
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-02 14:44</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:111 on 2025-04-02 14:44</div>
            <div class="timeline-body"><p>We almost exclusively use <code>&#x27;db</code> for the db lifetime.</p>
<pre><code>        db: &amp;&#x27;db dyn Db,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/diagnostic/render.rs</code>:32 on 2025-04-02 14:45</div>
            <div class="timeline-body"><p>I&#x27;m sure you thought about this but are the fine grained lifetimes required or could we just use one saying: You can display this as long as neither <code>self</code>, <code>db</code> or <code>config</code> gets dropped.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-04-02 14:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-02 14:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_db/src/diagnostic/render.rs</code>:32 on 2025-04-02 14:53</div>
            <div class="timeline-body"><p>Yes I did. When it&#x27;s crate internal, it generally shouldn&#x27;t matter, because these are all shared borrows and thus subtyping comes into play. And if it does matter, well, then I guess you just fix the lifetimes.</p>
<p>It <em>can</em> matter though. See <a href="https://github.com/rust-lang/regex/issues/168">this</a> as an example. It&#x27;s not totally obvious to me that it <em>will</em> matter, but usually when I expose public APIs, I try not to collapse lifetimes. So I mostly just did this by reflex.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-04-02 14:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-04-02 14:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:111 on 2025-04-02 14:53</div>
            <div class="timeline-body"><p>Yeah... I suppose this will become generic at some point, but it seems fine to just use <code>db</code> for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-04-02 14:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/red_knot_ide/src/goto.rs</code>:874 on 2025-04-02 14:54</div>
            <div class="timeline-body"><p>It was originally a bigger expression, but sure, yeah, fixed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-04-02 15:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-04-02 15:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-02 15:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-02 15:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/diagnostic/render.rs</code>:32 on 2025-04-02 15:32</div>
            <div class="timeline-body"><p>It&#x27;s great to see that you have the same ambition for <code>ruff_db</code> as for the <code>regex</code> crate ðŸ˜†</p>
<p>Isn&#x27;t this slightly different in the sense that <code>DisplayDiagnostic</code> never returns any values? I do see the point of having all the lifetimes if <code>DisplayDiagnostic</code> had field accessors where it matters that they return the right lifetime. But here it feels like it&#x27;s mainly: You can only use it as long as the three borrows are valid.</p>
<p>Either way, not that important. It&#x27;s just very scary looking</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-04-02 16:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_db/src/diagnostic/render.rs</code>:32 on 2025-04-02 16:06</div>
            <div class="timeline-body"><p>Yeah that&#x27;s what I meant by it might not mattering. As in, I can&#x27;t easily come up with an example where it matters.</p>
<p>Happy to change it back, but I honestly don&#x27;t feel strongly.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:12:52 UTC
    </footer>
</body>
</html>
