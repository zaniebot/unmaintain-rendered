<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pyflakes`] [ty] Fix false positives for `__annotate__` (Py3.14+) and `__warningregistry__` (`F821`) - astral-sh/ruff #20154</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pyflakes</code>] [ty] Fix false positives for <code>__annotate__</code> (Py3.14+) and <code>__warningregistry__</code> (<code>F821</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20154">#20154</a>
        opened by <a href="https://github.com/danparizher">@danparizher</a>
        on 2025-08-29 16:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/danparizher">@danparizher</a> on 2025-08-29 16:40</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes #19970</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @danparizher on 2025-08-29 16:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @danparizher on 2025-08-29 16:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @danparizher on 2025-08-29 16:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @danparizher on 2025-08-29 16:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-29 16:42</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-29 16:45</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">CPython (cases_generator) (https://github.com/python/cpython)
- Lib/test/test_warnings/__init__.py:38:12: warning[unresolved-global] Invalid global declaration of `__warningregistry__`: `__warningregistry__` has no declarations or bindings in the global scope
- Lib/test/test_warnings/__init__.py:45:9: error[unresolved-reference] Name `__warningregistry__` used when not defined
+ Lib/test/test_warnings/__init__.py:45:9: warning[possibly-unresolved-reference] Name `__warningregistry__` used when possibly not defined
- Lib/test/test_warnings/__init__.py:153:35: error[unresolved-reference] Name `__warningregistry__` used when not defined
+ Lib/test/test_warnings/__init__.py:153:35: warning[possibly-unresolved-reference] Name `__warningregistry__` used when possibly not defined
- Lib/test/test_warnings/__init__.py:844:16: warning[unresolved-global] Invalid global declaration of `__warningregistry__`: `__warningregistry__` has no declarations or bindings in the global scope
- Found 23904 diagnostics
+ Found 23902 diagnostics

CPython (Argument Clinic) (https://github.com/python/cpython)
- Lib/test/test_warnings/__init__.py:38:12: warning[unresolved-global] Invalid global declaration of `__warningregistry__`: `__warningregistry__` has no declarations or bindings in the global scope
- Lib/test/test_warnings/__init__.py:45:9: error[unresolved-reference] Name `__warningregistry__` used when not defined
+ Lib/test/test_warnings/__init__.py:45:9: warning[possibly-unresolved-reference] Name `__warningregistry__` used when possibly not defined
- Lib/test/test_warnings/__init__.py:153:35: error[unresolved-reference] Name `__warningregistry__` used when not defined
+ Lib/test/test_warnings/__init__.py:153:35: warning[possibly-unresolved-reference] Name `__warningregistry__` used when possibly not defined
- Lib/test/test_warnings/__init__.py:844:16: warning[unresolved-global] Invalid global declaration of `__warningregistry__`: `__warningregistry__` has no declarations or bindings in the global scope
- Found 23904 diagnostics
+ Found 23902 diagnostics

CPython (peg_generator) (https://github.com/python/cpython)
- Lib/test/test_warnings/__init__.py:38:12: warning[unresolved-global] Invalid global declaration of `__warningregistry__`: `__warningregistry__` has no declarations or bindings in the global scope
- Lib/test/test_warnings/__init__.py:45:9: error[unresolved-reference] Name `__warningregistry__` used when not defined
+ Lib/test/test_warnings/__init__.py:45:9: warning[possibly-unresolved-reference] Name `__warningregistry__` used when possibly not defined
- Lib/test/test_warnings/__init__.py:153:35: error[unresolved-reference] Name `__warningregistry__` used when not defined
+ Lib/test/test_warnings/__init__.py:153:35: warning[possibly-unresolved-reference] Name `__warningregistry__` used when possibly not defined
- Lib/test/test_warnings/__init__.py:844:16: warning[unresolved-global] Invalid global declaration of `__warningregistry__`: `__warningregistry__` has no declarations or bindings in the global scope
- Found 23903 diagnostics
+ Found 23901 diagnostics

</code></pre>
</details>
No memory usage changes detected ✅

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-29 16:52</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ty_python_semantic/src/place.rs</code>:1 on 2025-09-09 16:28</div>
            <div class="timeline-body"><p>This change looks reasonable to me, but we'll want someone from the ty side to have a look too, maybe @AlexWaygood? I'm guessing they'd like you to have an mdtest for this as well. Possibly in <a href="https://github.com/astral-sh/ruff/blob/c3f1f0b9f1ed8e522a6d22c7d1670997c19183de/crates/ty_python_semantic/resources/mdtest/scopes/moduletype_attrs.md?plain=1#L1"><code>moduletype_attrs.md</code></a>, but I'm not really sure.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_stdlib/src/builtins.rs</code>:23 on 2025-09-09 16:35</div>
            <div class="timeline-body"><p>I think it's correct to put <code>__warningregistry__</code> here because I don't think it's available in <code>builtins</code>, but I think we should create a separate <code>PY314_PLUS_BUILTINS</code> down below like the other version-specific groups for <code>__annotate__</code> since it was introduced in 3.14.</p>
<p>It appears not to <em>really</em> matter since both <code>MAGIC_GLOBALS</code> and <code>python_builtins</code> are only called once each in the same place. But we may also need to update <code>is_python_builtin</code> since its comment says it's supposed to be kept in sync with <code>python_builtins</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pyflakes/mod.rs</code>:934 on 2025-09-09 16:37</div>
            <div class="timeline-body"><p>This doesn't seem to be testing what the test name suggests. As the comment says, the <code>flakes</code> test runner uses the <code>latest</code> version, which is still 3.13, so we'll need to write some custom test code here. We've been talking about switching this whole module over to the more common <code>test_path</code> and <code>assert_diagnostics</code> tests like most other rules, so I'd probably suggest just doing something like that here. One example of that:</p>
<p>https://github.com/astral-sh/ruff/blob/c3f1f0b9f1ed8e522a6d22c7d1670997c19183de/crates/ruff_linter/src/rules/ruff/mod.rs#L116-L125</p>
<p>We should also test that <code>__annotate__</code> is not available before 3.14. I think this test should actually be failing given the version being used.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-09-09 16:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @carljm on 2025-09-09 16:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/danparizher">@danparizher</a> on 2025-09-09 19:07</div>
            <div class="timeline-body"><p>Thanks for the detailed review!</p>
<p>I went ahead and version-gated magic globals by introducing <code>python_magic_globals</code> (with <code>__annotate__</code> behind <code>PY314_PLUS_MAGIC_GLOBALS</code>) and updated the linter to bind them per target version; I left <code>is_python_builtin</code> as-is since <code>__annotate__</code> isn’t a builtin.</p>
<p>I also reworked the pyflakes tests to explicitly check <code>__annotate__</code> on 3.13 vs 3.14, and added/adjusted ty mdtests to model <code>__warningregistry__</code> as possibly unbound and to validate the <code>__annotate__</code> gating. All tests pass locally.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-09-19 20:12</div>
            <div class="timeline-body"><p>Thanks! This looks good to me on the Ruff side.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-09-23 11:18</div>
            <div class="timeline-body"><p>@AlexWaygood would you mind taking a look at how the changes impact ty?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-09-23 11:54</div>
            <div class="timeline-body"><p>Thanks, this looks great! I made a couple of small tweaks to the ty changes so that we infer some more precise types for these symbols. I also made <code>__annotate__</code> possibly-unbound as well as <code>__warningregistry__</code>, since <code>__annotate__</code> is only present in the global scope if a module has an annotation like <code>x: int</code> or <code>x: int = 42</code> in the global scope</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-09-23 12:11</div>
            <div class="timeline-body"><p>The primer report LGTM too!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @AlexWaygood on 2025-09-23 12:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @AlexWaygood on 2025-09-23 12:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dcreager removed by @AlexWaygood on 2025-09-23 12:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-09-23 12:14</div>
            <div class="timeline-body"><p>Thank you both!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ntBre on 2025-09-23 12:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @ntBre on 2025-09-23 12:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-09-23 12:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-09-23 12:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-09-23 12:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`pyflakes`] Fix false positives for `__annotate__` (Py3.14+) and `__warningregistry__` (`F821`)" to "[`pyflakes`] [ty] Fix false positives for `__annotate__` (Py3.14+) and `__warningregistry__` (`F821`)" by @AlexWaygood on 2025-09-23 12:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-09-23 12:40</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:40:52 UTC
    </footer>
</body>
</html>
