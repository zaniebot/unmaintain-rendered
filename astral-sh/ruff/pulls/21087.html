<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flynt`] Fix static-join-to-f-string when mixing raw and non-raw strings (`FLY002`) - astral-sh/ruff #21087</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flynt</code>] Fix static-join-to-f-string when mixing raw and non-raw strings (<code>FLY002</code>)</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21087">#21087</a>
        opened by <a href="https://github.com/danparizher">@danparizher</a>
        on 2025-10-27 00:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danparizher">@danparizher</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fix FLY002 to bail on transformations when mixing raw and non-raw strings. Mixing them can cause syntax errors, null bytes, or incorrect carriage-return behavior.</p>
<p>Closes #21082</p>
<h2>Problem Analysis</h2>
<p>When the first string in a join is raw (<code>r&quot;&quot;</code>) and later strings are not:</p>
<ol>
<li>The code applies the raw flag to the entire result</li>
<li>Non-raw string escape sequences are not processed</li>
<li>This leads to:<ul>
<li>Syntax errors (e.g., <code>&quot;&quot;.join((r&quot;&quot;, '&quot;'))</code> → <code>r&quot;&quot;&quot;</code>)</li>
<li>Null bytes (e.g., <code>&quot;&quot;.join((r&quot;&quot;, &quot;\0&quot;))</code>)</li>
<li>Behavior changes (e.g., carriage returns or unexpected characters)</li>
</ul>
</li>
</ol>
<h2>Approach</h2>
<p>Added a check in <code>build_fstring</code> to verify all strings have the same raw status. If not, the transformation is skipped:</p>
<ol>
<li>Collect raw status for all string literals in the join</li>
<li>Return <code>None</code> early if raw statuses differ</li>
<li>Otherwise, proceed with the transformation</li>
</ol>
<h2>Testing</h2>
<p>Added tests covering:</p>
<ul>
<li><code>nok14-nok18</code>: Mixed raw/non-raw (not transformed)</li>
<li><code>ok7</code>, <code>ok8</code>: All raw (transformed)</li>
<li><code>ok9</code>, <code>ok10</code>: All non-raw (transformed)</li>
</ul>
<p>Ran with problematic examples from the issue; transformations are skipped as expected.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-27 01:07</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dscorbett">@dscorbett</a> on 2025-10-27 16:05</div>
            <div class="timeline-body"><p>Joining raw and non-raw strings is not the problem. The fix for FLY002 works fine for some combinations:</p>
<pre><code class="language-console">$ cat &gt;fly002.py &lt;&lt;'# EOF'
print(&quot;&quot;.join(('&quot;', r&quot;@&quot;)))
print(&quot;&quot;.join((r&quot;@&quot;, &quot;!&quot;)))
# EOF

$ python fly002.py
&quot;@
@!

$ ruff check --isolated fly002.py --select FLY002 --unsafe-fixes --fix
Found 2 errors (2 fixed, 0 remaining).

$ cat fly002.py
print('&quot;')
print(r&quot;!&quot;)

$ python fly002.py
&quot;@
@!
</code></pre>
<p>Removing support for such combinations would need to be done in preview, but it would be more helpful to instead keep the support and fix the bugs. In particular, that means that if the fix’s output string cannot be represented as a raw string, it should be represented as a non-raw string, even if the first input string is raw.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dscorbett">@dscorbett</a> on <code>crates/ruff_linter/resources/test/fixtures/flynt/FLY002.py</code>:39 on 2025-10-27 18:36</div>
            <div class="timeline-body"><p><code>&quot;\\r&quot;</code> does not have a carriage return escape: it has a backslash escape followed by a literal ⟨r⟩. FLY002 doesn’t change its behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dscorbett">@dscorbett</a> reviewed on 2025-10-27 18:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dscorbett">@dscorbett</a> on <code>crates/ruff_linter/src/rules/flynt/rules/static_join_to_fstring.rs</code>:112 on 2025-10-28 17:09</div>
            <div class="timeline-body"><p>A line feed (<code>'\n'</code>) <em>can</em> safely be represented in a raw string. The section after “If the result is a raw string and contains a newline, use triple quotes” handles that case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dscorbett">@dscorbett</a> on <code>crates/ruff_linter/src/rules/flynt/rules/static_join_to_fstring.rs</code>:115 on 2025-10-28 17:11</div>
            <div class="timeline-body"><p>A backslash can safely appear in a raw string as long as it is not the last character. It’s probably common for raw strings to contain backslashes (because their main point is that they handle backslashes differently) so it might be worth trying to support that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dscorbett">@dscorbett</a> reviewed on 2025-10-28 17:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @amyreese on 2025-10-29 01:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @amyreese on 2025-10-29 01:25</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:16:42 UTC
    </footer>
</body>
</html>
