```yaml
number: 6441
title: Preserve dangling f-string comments
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: fstring-comments
created_at: 2023-08-09T08:59:30Z
updated_at: 2023-08-10T07:24:13Z
url: https://github.com/astral-sh/ruff/pull/6441
synced_at: 2026-01-12T02:52:04Z
```

# Preserve dangling f-string comments

---

_Pull request opened by @MichaReiser on 2023-08-09 08:59_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This PR fixes the issue where the FString formatting dropped dangling comments between the string parts.

```python
result_f = (
    f'  File "{__file__}", line {lineno_f+1}, in f\n'
    '    f()\n'
    # XXX: The following line changes depending on whether the tests
    # are run through the interactive interpreter or with -m
    # It also varies depending on the platform (stack size)
    # Fortunately, we don't care about exactness here, so we use regex
    r'  \[Previous line repeated (\d+) more times\]' '\n'
    'RecursionError: maximum recursion depth exceeded\n'
)
```

The solution here isn't ideal because it re-introduces the `enclosing_parent` on `DecoratedComment` but it is the easiest fix that I could come up. 
I didn't spend more time finding another solution becaues I think we have to re-write most of the fstring formatting with the upcoming Python 3.12 support (because lexing the individual parts as we do now will no longer work).

closes #6440

<!-- What's the purpose of the change? What does it do, and why? -->

## Test Plan

`cargo test`

The child PR testing that all comments are formatted should now pass


---

_Comment by @MichaReiser on 2023-08-09 08:59_

Current dependencies on/for this PR:
* main
  * **PR #6422** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6422" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #6426** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6426" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #6441** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6441" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
        * **PR #6178** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6178" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6441?utm_source=stack-comment).

---

_Label `formatter` added by @MichaReiser on 2023-08-09 08:59_

---

_Review requested from @konstin by @MichaReiser on 2023-08-09 08:59_

---

_Review requested from @charliermarsh by @MichaReiser on 2023-08-09 08:59_

---

_@MichaReiser reviewed on 2023-08-09 09:00_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/resources/test/fixtures/ruff/expression/fstring.py`:1 on 2023-08-09 09:00_

I renamed the file from `joined_string` to `fstring` to match our most recent node naming.

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/comments/placement.rs`:78 on 2023-08-09 09:23_

Could you instead check whether the comment is between two string constants? i'd like to avoid reintroducing `enclosing_parent` if possible.

---

_@konstin reviewed on 2023-08-09 09:23_

---

_@konstin reviewed on 2023-08-09 09:25_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/comments/placement.rs`:78 on 2023-08-09 09:25_

Relatedly, where is the comment currently attached and would it be possible to check for constant comment in string formatting itself?

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/comments/placement.rs`:78 on 2023-08-09 09:34_

> Could you instead check whether the comment is between two string constants? i'd like to avoid reintroducing enclosing_parent if possible.

I would also like to avoid re-introducing enclosing_parent. However, the problem is that the comments fall into a `ConstantExpr` range and `following` and `preceding` are both `None`. 

> Relatedly, where is the comment currently attached and would it be possible to check for constant comment in string formatting itself?

The comments are attached to the `ExprConstant` without this change. I tried changing the string formatting to introduce a `AnyStringDanglingCommentsIter` that iterates over all dangling comments (includes all parts for an `FString`). However, I ran into problems because `leading_comments` and `trailing_comments` expect a `&[SourceComment]`. I tried collecting into a `Vec` but that doesn't work because the Vec's slice is of the type `&[&SourceComment]` (a slice of source comment references instead of source comments).

I then looked into changing `leading_comments` and `trailing_comments` to accept an iterator instead, but that complicates their implementations (and signatures) significantly. 

Lastly, I tried to add a `AnyString::parts` method that returns a `&[Expr]` slice. Unfortunately, this doesn't work for the same reasons as above AND has the additional issue that it's impossible to cast a `&ExprConstant` to a `&Expr`. 

I think changing `leading_` and `trailing_comments` is worth the effort if the current f-string formatting would be the final solution. But I don't think it is. I expect it to require significant re-work to support comments and nested parentheses inside of `FormattedValue`.

---

_@MichaReiser reviewed on 2023-08-09 09:35_

---

_@MichaReiser reviewed on 2023-08-09 09:40_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/comments/placement.rs`:78 on 2023-08-09 09:40_

The reason why I prefer re-introducing `enclosing_parent` is because rust will warn us when it is unused. Rust won't warn us if the `IntoIterator` variant of `leading_comments` is no longer needed. Meaning, that complexity likely remains forever.

---

_@konstin reviewed on 2023-08-09 09:46_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/comments/placement.rs`:78 on 2023-08-09 09:46_

thanks for the explanation!

---

_@konstin approved on 2023-08-09 09:47_

---

_Comment by @github-actions[bot] on 2023-08-09 09:49_

## PR Check Results
### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      8.4Â±0.06ms     4.8 MB/sec    1.00      8.4Â±0.07ms     4.8 MB/sec
formatter/numpy/ctypeslib.py               1.00  1648.0Â±16.97Âµs    10.1 MB/sec    1.01  1668.9Â±31.56Âµs    10.0 MB/sec
formatter/numpy/globals.py                 1.00    185.5Â±2.38Âµs    15.9 MB/sec    1.03    191.6Â±7.32Âµs    15.4 MB/sec
formatter/pydantic/types.py                1.00      3.5Â±0.06ms     7.3 MB/sec    1.02      3.6Â±0.10ms     7.1 MB/sec
linter/all-rules/large/dataset.py          1.00     10.5Â±0.10ms     3.9 MB/sec    1.02     10.7Â±0.10ms     3.8 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      2.8Â±0.01ms     6.0 MB/sec    1.01      2.8Â±0.03ms     5.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    386.6Â±3.97Âµs     7.6 MB/sec    1.00    387.8Â±0.53Âµs     7.6 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.5Â±0.10ms     4.6 MB/sec    1.03      5.7Â±0.05ms     4.5 MB/sec
linter/default-rules/large/dataset.py      1.02      5.4Â±0.02ms     7.5 MB/sec    1.00      5.4Â±0.03ms     7.6 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1156.8Â±5.10Âµs    14.4 MB/sec    1.00   1151.2Â±2.88Âµs    14.5 MB/sec
linter/default-rules/numpy/globals.py      1.00    132.2Â±0.53Âµs    22.3 MB/sec    1.00    132.2Â±1.98Âµs    22.3 MB/sec
linter/default-rules/pydantic/types.py     1.01      2.4Â±0.01ms    10.5 MB/sec    1.00      2.4Â±0.02ms    10.6 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      9.9Â±0.07ms     4.1 MB/sec    1.00      9.9Â±0.07ms     4.1 MB/sec
formatter/numpy/ctypeslib.py               1.00  1915.4Â±18.01Âµs     8.7 MB/sec    1.00  1915.3Â±18.14Âµs     8.7 MB/sec
formatter/numpy/globals.py                 1.00    216.0Â±3.64Âµs    13.7 MB/sec    1.00    216.6Â±5.51Âµs    13.6 MB/sec
formatter/pydantic/types.py                1.00      4.2Â±0.04ms     6.1 MB/sec    1.01      4.2Â±0.05ms     6.1 MB/sec
linter/all-rules/large/dataset.py          1.00     12.4Â±0.07ms     3.3 MB/sec    1.00     12.3Â±0.07ms     3.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.4Â±0.03ms     4.9 MB/sec    1.00      3.4Â±0.03ms     4.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    428.8Â±7.53Âµs     6.9 MB/sec    1.00    430.9Â±8.31Âµs     6.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.4Â±0.04ms     4.0 MB/sec    1.00      6.4Â±0.06ms     4.0 MB/sec
linter/default-rules/large/dataset.py      1.00      6.7Â±0.03ms     6.1 MB/sec    1.00      6.7Â±0.06ms     6.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1404.7Â±11.98Âµs    11.9 MB/sec    1.00  1408.5Â±14.55Âµs    11.8 MB/sec
linter/default-rules/numpy/globals.py      1.00    162.8Â±4.41Âµs    18.1 MB/sec    1.01    163.7Â±3.25Âµs    18.0 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.0Â±0.04ms     8.5 MB/sec    1.00      3.0Â±0.05ms     8.5 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Comment by @MichaReiser on 2023-08-10 07:00_

[Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6441) rebased this pull request as part of a merge.

---

_Merged by @MichaReiser on 2023-08-10 07:11_

---

_Closed by @MichaReiser on 2023-08-10 07:11_

---

_Branch deleted on 2023-08-10 07:11_

---

_Comment by @MichaReiser on 2023-08-10 07:11_

@MichaReiser merged this pull request with [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6441).

---
