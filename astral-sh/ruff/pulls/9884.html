<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remove unnecessary string cloning from the parser - astral-sh/ruff #9884</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Remove unnecessary string cloning from the parser</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/9884">#9884</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-02-07 22:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><p>Closes https://github.com/astral-sh/ruff/issues/9869.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-02-07 22:24</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-08 03:56</div>
            <div class="timeline-body"><p>Hate this change, didn't even improve benchmarks!!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-08 17:37</div>
            <div class="timeline-body"><blockquote>
<p>Hate this change, didn't even improve benchmarks!!!</p>
</blockquote>
<p>That's because codspeed uses the fixed cost 0 for allocations....</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2024-02-08 18:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @charliermarsh on 2024-02-08 18:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @charliermarsh on 2024-02-08 18:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-08 18:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_parser/src/string.rs</code>:293 on 2024-02-08 18:08</div>
            <div class="timeline-body"><p>@BurntSushi - Is this exposed in any crates that we already use? I had to vendor it from <code>bstr</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-02-08 18:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_parser/src/string.rs</code>:293 on 2024-02-08 18:46</div>
            <div class="timeline-body"><p>Yes. :P https://docs.rs/bstr/latest/bstr/trait.ByteSlice.html#method.find_non_ascii_byte</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/string.rs</code>:220 on 2024-02-08 19:46</div>
            <div class="timeline-body"><p>nit: the index could also include <code>{</code> or <code>}</code> as well, right? The variable name <code>before_with_slash</code> suggests otherwise unless I'm wrong.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2024-02-08 20:07</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by @dhruvmanila on 2024-02-08 20:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-02-08 20:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-02-08 20:44</div>
            <div class="timeline-body"><p>:guitar:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-02-08 21:33</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/charlie/string-parser">CodSpeed Performance Report</a></h2>
<h3>Merging #9884 will <strong>improve performances by 6.53%</strong></h3>
<p><sub>Comparing <code>charlie/string-parser</code> (58178b3) with <code>main</code> (7ca515c)</sub></p>
<h3>Summary</h3>
<p><code>⚡ 1</code> improvements
<code>✅ 29</code> untouched benchmarks</p>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>main</code> | <code>charlie/string-parser</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ⚡ | <code>linter/default-rules[pydantic/types.py]</code> | 8.6 ms | 8 ms | +6.53% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-09 02:46</div>
            <div class="timeline-body"><p>I'm gonna get to the bottom of this if it's the last thing I do.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @charliermarsh on 2024-02-09 04:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-09 04:50</div>
            <div class="timeline-body"><p>I see basically no improvement on local benchmarks either via criterion or hyperfine. I'm not sure why, to be honest. I guess I'll proceed with the change since it's both (1) a better API, and (2) intuitively better to avoid re-allocating here when we don't need to. But I'm a bit confused.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-09 04:51</div>
            <div class="timeline-body"><p>(Ignore current state of the PR, I duplicated the existing and updated code to do some benchmarking. I'll clean up later.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-09 20:05</div>
            <div class="timeline-body"><p>By removing lexing from the parser benchmark, I'm now able to see a more consistent 1-2% improvement in parse time, so I'll move forward with this. (Benchmarking the individual string-parsing functions (rather than the parser as a whole) shows an enormous speed-up, like 2x.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2024-02-09 20:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-02-09 21:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-02-09 21:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-02-09 21:03</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:02:41 UTC
    </footer>
</body>
</html>
