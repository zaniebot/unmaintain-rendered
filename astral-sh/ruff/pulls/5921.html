<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Format `ExprYield`/`ExprYieldFrom` - astral-sh/ruff #5921</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Format <code>ExprYield</code>/<code>ExprYieldFrom</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5921">#5921</a>
        opened by <a href="https://github.com/qdegraaf">@qdegraaf</a>
        on 2023-07-20 14:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/qdegraaf">@qdegraaf</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Formats:</p>
<ul>
<li><code>yield x</code></li>
<li><code>yield from x</code></li>
</ul>
<p>expressions</p>
<h2>Test Plan</h2>
<p>Added fixtures for both expressions, ran black_comparison.</p>
<p>NOTE: This is my first formatter PR. From what I gather there are many many ways that interesting combinations of comments and parentheses can lead to unexpected results. I will try and run the formatter against some large codebases to see if any unexpected results pop up, but figured I'd open it for review in the meantime</p>
<h2>Issue link:</h2>
<p>Closes: https://github.com/astral-sh/ruff/issues/5916</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @qdegraaf on 2023-07-20 14:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-07-20 14:53</div>
            <div class="timeline-body"><p>nice work</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-07-20 15:11</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      9.8±0.01ms     4.2 MB/sec    1.15     11.2±0.02ms     3.6 MB/sec
formatter/numpy/ctypeslib.py               1.00   1901.1±5.20µs     8.8 MB/sec    1.12      2.1±0.00ms     7.8 MB/sec
formatter/numpy/globals.py                 1.00    206.1±0.40µs    14.3 MB/sec    1.08    222.6±0.38µs    13.3 MB/sec
formatter/pydantic/types.py                1.00      4.2±0.01ms     6.0 MB/sec    1.12      4.7±0.00ms     5.4 MB/sec
linter/all-rules/large/dataset.py          1.02     13.8±0.02ms     3.0 MB/sec    1.00     13.6±0.04ms     3.0 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.5±0.00ms     4.8 MB/sec    1.00      3.4±0.01ms     4.8 MB/sec
linter/all-rules/numpy/globals.py          1.01    377.1±1.54µs     7.8 MB/sec    1.00    373.2±1.32µs     7.9 MB/sec
linter/all-rules/pydantic/types.py         1.02      6.2±0.01ms     4.1 MB/sec    1.00      6.1±0.01ms     4.2 MB/sec
linter/default-rules/large/dataset.py      1.04      7.3±0.01ms     5.6 MB/sec    1.00      7.0±0.01ms     5.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.02   1465.9±3.97µs    11.4 MB/sec    1.00   1435.4±3.52µs    11.6 MB/sec
linter/default-rules/numpy/globals.py      1.02    153.1±0.19µs    19.3 MB/sec    1.00    149.8±0.27µs    19.7 MB/sec
linter/default-rules/pydantic/types.py     1.03      3.2±0.02ms     7.9 MB/sec    1.00      3.1±0.00ms     8.1 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     10.8±0.09ms     3.8 MB/sec    1.00     10.8±0.09ms     3.8 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.1±0.03ms     7.9 MB/sec    1.00      2.1±0.02ms     7.9 MB/sec
formatter/numpy/globals.py                 1.00    236.4±5.45µs    12.5 MB/sec    1.02   240.2±12.21µs    12.3 MB/sec
formatter/pydantic/types.py                1.00      4.6±0.04ms     5.5 MB/sec    1.01      4.7±0.06ms     5.5 MB/sec
linter/all-rules/large/dataset.py          1.00     15.1±0.08ms     2.7 MB/sec    1.00     15.0±0.10ms     2.7 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.0±0.05ms     4.2 MB/sec    1.00      4.0±0.03ms     4.2 MB/sec
linter/all-rules/numpy/globals.py          1.00    484.3±8.64µs     6.1 MB/sec    1.00    482.8±5.97µs     6.1 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.8±0.09ms     3.7 MB/sec    1.00      6.8±0.05ms     3.7 MB/sec
linter/default-rules/large/dataset.py      1.00      7.9±0.05ms     5.2 MB/sec    1.00      7.9±0.06ms     5.2 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1646.7±15.45µs    10.1 MB/sec    1.00  1648.8±14.28µs    10.1 MB/sec
linter/default-rules/numpy/globals.py      1.00    188.9±2.26µs    15.6 MB/sec    1.00    189.3±2.37µs    15.6 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.5±0.03ms     7.3 MB/sec    1.00      3.5±0.02ms     7.3 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-07-20 15:11</div>
            <div class="timeline-body"><p>The cpython check failed on <code>Lib/test/test_asyncio/test_locks.py</code>, which can be shrunk to the following snippet:</p>
<pre><code class="language-python">def a():
    with (yield):
        pass
</code></pre>
<p>Seem like yield can appear everywhere, even in e.g. <code>if</code>. Searching for <code>yield_expression</code>  in https://docs.python.org/3/reference/grammar.html it seems that yield without parentheses is the exception (only for yield statements and right hand sides of assignment), in <code>atom</code> (through <code>group</code>) it has parentheses.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @konstin on 2023-07-20 16:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/qdegraaf">@qdegraaf</a> on 2023-07-20 22:03</div>
            <div class="timeline-body"><p>Interesting. I've expanded the test cases with a bunch more examples, and inverted the <code>needs_parentheses()</code> logic, excluding only <code>parent</code>s which are some type of assign</p>
<p>You mention <code>yield</code> statements also require no parentheses. How do you mean exactly? Looking at it now <code>yield (yield l)</code>, <code>yield from (yield l)</code> <code>yield (yield from l)</code> and <code>yield from (yield from l)</code> all seem to need parentheses)`.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/expr_yield.rs</code>:39 on 2023-07-21 10:10</div>
            <div class="timeline-body"><p>This should get a longer explanation about how only assignment right hand side and yield statements don't need parentheses and the special casing in the grammar, but we only need to handle assignment RHS here because StmtExpr doesn't add parentheses anyway (i just had to check that last part myself)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-07-21 10:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-07-21 10:20</div>
            <div class="timeline-body"><blockquote>
<p>You mention yield statements also require no parentheses. How do you mean exactly? Looking at it now yield (yield l), yield from (yield l) yield (yield from l) and yield from (yield from l) all seem to need parentheses)`.</p>
</blockquote>
<p>For</p>
<pre><code class="language-python">def f():
    yield 1
</code></pre>
<p>you get (simplified for readability) <code>StmtFunctionDef { body: [StmtExpr(ExprYield(..))] }</code>. <code>StmtExpr</code> gets formatted with</p>
<pre><code class="language-rust">impl FormatNodeRule&lt;StmtExpr&gt; for FormatStmtExpr {
    fn fmt_fields(&amp;self, item: &amp;StmtExpr, f: &amp;mut PyFormatter) -&gt; FormatResult&lt;()&gt; {
        let StmtExpr { value, .. } = item;

        if is_arithmetic_like(value) {
            maybe_parenthesize_expression(value, item, Parenthesize::Optional).fmt(f)
        } else {
            value.format().fmt(f)
        }
    }
}
</code></pre>
<p>so this doesn't become</p>
<pre><code class="language-python">def f():
    (yield 1)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/qdegraaf">@qdegraaf</a> reviewed on 2023-07-21 10:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/qdegraaf">@qdegraaf</a> on <code>crates/ruff_python_formatter/src/expression/expr_yield.rs</code>:39 on 2023-07-21 10:51</div>
            <div class="timeline-body"><p>Good point, added a comment describing the situation for both <code>expr_yield</code> and <code>expr_yield_from</code>. Thanks for the explanation in https://github.com/astral-sh/ruff/pull/5921#issuecomment-1645352816 as well, helps me get a clearer image of how the formatter is structured and what to watch out for.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @qdegraaf on 2023-07-21 10:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_yield.rs</code>:21 on 2023-07-21 11:53</div>
            <div class="timeline-body"><p>Nit:</p>
<pre><code class="language-suggestion">                    text(&quot;yield&quot;),
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_yield_from.rs</code>:20 on 2023-07-21 11:53</div>
            <div class="timeline-body"><pre><code class="language-suggestion">                text(&quot;yield from&quot;),
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-07-21 11:58</div>
            <div class="timeline-body"><p>This is awesome. We may want to consider unifying the implementation in a follow up PR similar to <code>AnyStmtWith</code> (it could also implement <code>NeedsParentheses</code> so that we have all the logic in a single place).</p>
<p>https://github.com/astral-sh/ruff/blob/03018896deebfeb2cf96c28c897dd98a5e1c7699/crates/ruff_python_formatter/src/statement/stmt_with.rs#L15-L114</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-07-21 12:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-07-21 12:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/qdegraaf">@qdegraaf</a> on 2023-07-21 13:01</div>
            <div class="timeline-body"><blockquote>
<p>This is awesome. We may want to consider unifying the implementation in a follow up PR similar to <code>AnyStmtWith</code> (it could also implement <code>NeedsParentheses</code> so that we have all the logic in a single place).</p>
</blockquote>
<p>Good idea @MichaReiser. I'll finish up my outstanding PRs, then move to work on that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-07-27 08:12</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:58:55 UTC
    </footer>
</body>
</html>
