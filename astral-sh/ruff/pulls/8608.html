<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generalize PIE807 to handle dict literals - astral-sh/ruff #8608</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Generalize PIE807 to handle dict literals</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/8608">#8608</a>
        opened by <a href="https://github.com/alanhdu">@alanhdu</a>
        on 2023-11-10 19:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/alanhdu">@alanhdu</a></div>
            <div class="timeline-body">Summary
<p>PIE807 will rewrite <code>lambda: []</code> to <code>list</code> -- AFAICT though, the same rationale also applies to dicts, so I&#x27;ve modified the code to also rewrite <code>lambda: {}</code> to <code>dict</code>.</p>
<p>Two things I&#x27;m not sure about:</p>
<ul>
<li>Should this go to a new rule? This no longer actually matches the behavior of flake8-pie, and while I think thematically it makes sense to be part of the same rule, we could make it a standalone rule (but if so, where should I put it and what error code should I use)?</li>
<li>If we want a single rule, are there backwards compatibility concerns with the rule name change (from <code>reimplemented_list_builtin</code> to <code>reimplemented_container_builtin</code>?</li>
</ul>
Test Plan
<p>Added snapshot tests of the functionality.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-11-10 20:00</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>‚ÑπÔ∏è ecosystem check <strong>detected linter changes</strong>. (+1 -0 violations, +0 -0 fixes in 41 projects)</p>
<a href="https://github.com/rotki/rotki">rotki/rotki</a> (+1 -0 violations, +0 -0 fixes)
<p>

<pre>
+ <a href="https://github.com/rotki/rotki/blob/07622daa4ef0fde41b527d27eed95ef16028f8f5/rotkehlchen/tests/api/test_balances.py#L953">rotkehlchen/tests/api/test_balances.py:953:135:</a> PIE807 [*] Prefer `dict` over useless lambda
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PIE807 | 1 | 1 | 0 | 0 | 0 |</p>
</p>


Linter (preview)
<p>‚ÑπÔ∏è ecosystem check <strong>detected linter changes</strong>. (+6 -0 violations, +0 -0 fixes in 41 projects)</p>
<a href="https://github.com/demisto/content">demisto/content</a> (+5 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --preview</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/demisto/content/blob/79b3c261d5ff72d9a367a01772b078523ea8f472/Packs/RubrikPolaris/Integrations/RubrikPolaris/RubrikPolaris_test.py#L61">Packs/RubrikPolaris/Integrations/RubrikPolaris/RubrikPolaris_test.py:61:45:</a> PIE807 [*] Prefer `dict` over useless lambda
+ <a href="https://github.com/demisto/content/blob/79b3c261d5ff72d9a367a01772b078523ea8f472/Packs/VMware/Integrations/VMware/VMware_test.py#L593">Packs/VMware/Integrations/VMware/VMware_test.py:593:48:</a> PIE807 [*] Prefer `dict` over useless lambda
+ <a href="https://github.com/demisto/content/blob/79b3c261d5ff72d9a367a01772b078523ea8f472/Packs/VMware/Integrations/VMware/VMware_test.py#L649">Packs/VMware/Integrations/VMware/VMware_test.py:649:48:</a> PIE807 [*] Prefer `dict` over useless lambda
+ <a href="https://github.com/demisto/content/blob/79b3c261d5ff72d9a367a01772b078523ea8f472/Packs/VMware/Integrations/VMware/VMware_test.py#L677">Packs/VMware/Integrations/VMware/VMware_test.py:677:48:</a> PIE807 [*] Prefer `dict` over useless lambda
+ <a href="https://github.com/demisto/content/blob/79b3c261d5ff72d9a367a01772b078523ea8f472/Packs/VMware/Integrations/VMware/VMware_test.py#L721">Packs/VMware/Integrations/VMware/VMware_test.py:721:48:</a> PIE807 [*] Prefer `dict` over useless lambda
</pre>

</p>

<a href="https://github.com/rotki/rotki">rotki/rotki</a> (+1 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --preview</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/rotki/rotki/blob/07622daa4ef0fde41b527d27eed95ef16028f8f5/rotkehlchen/tests/api/test_balances.py#L953">rotkehlchen/tests/api/test_balances.py:953:135:</a> PIE807 [*] Prefer `dict` over useless lambda
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PIE807 | 6 | 6 | 0 | 0 | 0 |</p>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-10 20:51</div>
            <div class="timeline-body"><p>üëç I think it&#x27;s fine to use a single rule, and even to rename it (I believe our versioning policy allows this), but we should probably gate the change in behavior to preview-only.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-10 20:51</div>
            <div class="timeline-body"><p>You can grep for <code>fn preview_rules</code> for an example of testing preview rules, and to find rules that currently deviate based on the preview flag.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-10 20:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-10 20:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-11-10 21:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_linter/src/rules/flake8_pie/rules/reimplemented_container_builtin.rs</code>:41 on 2023-11-10 21:01</div>
            <div class="timeline-body"><p>Maybe just <code>ReimplementedBuiltin</code> would suffice?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-11-10 21:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_linter/src/rules/flake8_pie/rules/reimplemented_container_builtin.rs</code>:49 on 2023-11-10 21:03</div>
            <div class="timeline-body"><p>You could store the type on the <code>Violation</code> then say &quot;Prefer <code>list</code> over lambda&quot; or &quot;Prefer <code>dict</code> over lambda&quot; depending on the case. It seems confusing to present both to the user when we know which they meant.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/flake8_pie/rules/reimplemented_container_builtin.rs</code>:41 on 2023-11-10 22:23</div>
            <div class="timeline-body"><p>I think we have some other rules that also detect re-implemented builtins though -- like the simplify rules that detect re-implemented <code>any</code> and <code>all</code> loops.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-10 22:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-10 22:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/flake8_pie/rules/reimplemented_container_builtin.rs</code>:49 on 2023-11-10 22:24</div>
            <div class="timeline-body"><p>Agreed! Can grep for <code>DeferralKeyword</code> as an example of this pattern.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-11-10 22:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_linter/src/rules/flake8_pie/rules/reimplemented_container_builtin.rs</code>:41 on 2023-11-10 22:32</div>
            <div class="timeline-body"><p>Hm yes <code>ReimplementedBuiltin</code> is used for <code>SIM110</code> and <code>SIM111</code> ‚Äî that&#x27;s such a generic name for those though...</p>
<p>I think <code>ReimplementedContainerBuiltin</code> is fine but separately we should consider changing that other one to be more specific :D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Skylion007">@Skylion007</a> on 2023-11-11 14:59</div>
            <div class="timeline-body"><p>I remember reviewing a PR for a more general rule about any lambda that didn&#x27;t pass any args to a function call. Would that be a better rule to enable? I think it was a pylint one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-11 15:04</div>
            <div class="timeline-body"><p>I think it&#x27;s <a href="https://github.com/astral-sh/ruff/pull/7953">astral-sh/ruff#7953</a>, although I think that rule may not catch this case because it&#x27;s not aware that (e.g.) <code>[]</code> is equivalent to <code>list</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Skylion007">@Skylion007</a> on 2023-11-11 15:25</div>
            <div class="timeline-body"><p>Ah, you are right. PIE807 doesn&#x27;t actually even catch</p>
<pre><code>doc_string_dict = defaultdict(lambda: list())
</code></pre>
<p>but unnecessary lambda does.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/alanhdu">@alanhdu</a> reviewed on 2023-11-13 15:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/alanhdu">@alanhdu</a> on <code>crates/ruff_linter/src/rules/flake8_pie/rules/reimplemented_container_builtin.rs</code>:46 on 2023-11-13 15:50</div>
            <div class="timeline-body"><p>I could make this an <code>enum</code> instead, but not sure it&#x27;s worthwhile compared to just storing the builtin inline.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-11-13 17:46</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-13 17:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/flake8_pie/rules/reimplemented_container_builtin.rs</code>:46 on 2023-11-13 17:46</div>
            <div class="timeline-body"><p>I decided to make it an enum to follow the pattern we use elsewhere, even though it&#x27;s really unimportant.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-13 17:46</div>
            <div class="timeline-body"><p>(The Rotki ecosystem change is expected as they use preview mode by default.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-13 17:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-13 17:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-11-16 02:33</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:59:15 UTC
    </footer>
</body>
</html>
