<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Conservative narrowing places optimization - astral-sh/ruff #22734</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Conservative narrowing places optimization</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22734">#22734</a>
        opened by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a>
        on 2026-01-19 19:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ericmarkmartin">@ericmarkmartin</a></div>
            <div class="timeline-body">

Summary


<p>Add helpers to compute a conservative upper bound on the set of places a predicate might actually narrow, and use this to save work when computing narrowing constraints.</p>
<p>For now just a draft PR to see perf numbers.</p>
Test Plan


<p>Existing tests pass</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-19 20:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-19 20:48</div>
            <div class="timeline-body">

<a href="https://github.com/python/typing/blob/dece44f2922ca390fe314145d09939514a21e76e/conformance/">Typing conformance results</a>
<p>No changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-19 20:49</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>tornado (https://github.com/tornadoweb/tornado)
- tornado/gen.py:255:62: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `None | Awaitable[Unknown] | list[Awaitable[Unknown]] | dict[Any, Awaitable[Unknown]] | Future[Unknown]`, found `_T@next | _VT@next | _T@next`
+ tornado/gen.py:255:62: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `None | Awaitable[Unknown] | list[Awaitable[Unknown]] | dict[Any, Awaitable[Unknown]] | Future[Unknown]`, found `_T@next | _T@next | _VT@next`

static-frame (https://github.com/static-frame/static-frame)
- static_frame/core/node_selector.py:526:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[TVContainer_co@InterfaceSelectQuartet, Any]`, found `InterGetItemLocReduces[Unknown | Bottom[Series[Any, Any]], Any]`
+ static_frame/core/node_selector.py:526:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[TVContainer_co@InterfaceSelectQuartet, Any]`, found `InterGetItemLocReduces[Bottom[Series[Any, Any]] | Unknown, Any]`

pandas-stubs (https://github.com/pandas-dev/pandas-stubs)
- tests/test_pandas.py:521:18: error[type-assertion-failure] Type `bool` does not match asserted type `TypeIs[timedelta64[timedelta &amp; ~NaTType &amp; ~NAType] @ np_td]`
+ tests/test_pandas.py:521:18: error[type-assertion-failure] Type `bool` does not match asserted type `TypeIs[timedelta64[timedelta] @ np_td]`
- tests/test_pandas.py:526:22: error[type-assertion-failure] Type `bool` does not match asserted type `TypeIs[str | bytes | date | ... omitted 9 union elements @ np_nat]`
+ tests/test_pandas.py:526:22: error[type-assertion-failure] Type `bool` does not match asserted type `TypeIs[timedelta64[timedelta | int | None] @ np_nat]`

core (https://github.com/home-assistant/core)
- homeassistant/util/variance.py:47:12: error[invalid-return-type] Return type does not match returned value: expected `(**_P@ignore_variance) -&gt; _R@ignore_variance`, found `_Wrapped[_P@ignore_variance, _R@ignore_variance | int | float | datetime, _P@ignore_variance, _R@ignore_variance | int | float | datetime]`
- Found 14492 diagnostics
+ Found 14491 diagnostics


</code></pre>



Memory usage changes were detected when running on open source projects

<pre><code>flake8 (https://github.com/pycqa/flake8)
- TOTAL MEMORY USAGE: ~66MB
+ TOTAL MEMORY USAGE: ~63MB
-     memo fields = ~49MB
+     memo fields = ~47MB

trio (https://github.com/python-trio/trio)
- TOTAL MEMORY USAGE: ~167MB
+ TOTAL MEMORY USAGE: ~159MB
-     struct fields = ~12MB
+     struct fields = ~11MB
-     memo metadata = ~33MB
+     memo metadata = ~31MB
-     memo fields = ~108MB
+     memo fields = ~103MB

sphinx (https://github.com/sphinx-doc/sphinx)
- TOTAL MEMORY USAGE: ~301MB
+ TOTAL MEMORY USAGE: ~287MB
-     memo fields = ~176MB
+     memo fields = ~167MB


</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Conservative narrowing places optimization&quot; to &quot;[ty] Conservative narrowing places optimization&quot; by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> on 2026-01-19 21:44</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:23:18 UTC
    </footer>
</body>
</html>
