<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`ruff server`: Introduce settings for directly configuring the linter and formatter - astral-sh/ruff #10984</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>ruff server</code>: Introduce settings for directly configuring the linter and formatter</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10984">#10984</a>
        opened by <a href="https://github.com/snowsignal">@snowsignal</a>
        on 2024-04-16 21:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a></div>
            <div class="timeline-body">Summary
<p>The following client settings have been introduced to the language server:</p>
<ul>
<li><code>lint.preview</code></li>
<li><code>format.preview</code></li>
<li><code>lint.select</code></li>
<li><code>lint.extendSelect</code></li>
<li><code>lint.ignore</code></li>
<li><code>exclude</code></li>
<li><code>lineLength</code></li>
</ul>
<p><code>exclude</code> and <code>lineLength</code> apply to both the linter and formatter.</p>
<p>This does not actually use the settings yet, but makes them available for future use.</p>
Test Plan
<p>Snapshot tests have been updated.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-04-16 21:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Ruff Server: Beta&quot; by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-04-16 21:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-04-16 21:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-04-16 21:49</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>‚úÖ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>‚úÖ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_linter/src/line_width.rs</code>:40 on 2024-04-16 22:22</div>
            <div class="timeline-body"><p>I&#x27;d like to <em>not</em> do this if possible, but I couldn&#x27;t find a better way to initialize <code>LineLength</code>. Maybe I should use <code>serde_json::from_value(serde_json::Value::Number(80))</code> instead?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/session/settings.rs</code>:272 on 2024-04-16 22:25</div>
            <div class="timeline-body"><p>I should probably explain why I&#x27;m not just removing <code>ResolvedClientSettings::resolve_or</code> entirely and using <code>resolve_optional(...).unwrap_or(&lt;default&gt;)</code> in its place. My reasoning is that I don&#x27;t want to move the logic that determines default values out of a dedicated function, because it opens up the possibility that someone might use <code>resolve_optional(...).unwrap_or_default()</code> or some other incorrect method of resolving a default value. We should always make the default value explicit when resolving a setting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-04-16 22:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-04-16 22:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dhruvmanila">@dhruvmanila</a> by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-04-16 22:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/line_width.rs</code>:40 on 2024-04-17 06:53</div>
            <div class="timeline-body"><p>Why don&#x27;t you use <code>LineLength::try_from(length).unwrap()</code> directly in your tests? It gives you the same assertions and isn&#x27;t longer than <code>LineLength::from_u16_for_testing_only()</code>.</p>
<p>I agree that we shouldn&#x27;t add this. We can have a similar helper function in the tests that need.</p>
<p>Unrelated: Two changes i would make if we wanted to have the function.</p>
<ul>
<li>Use <code>Self::MAX</code> instead of 320`</li>
<li>Use <code>#[test]</code> to exclude the method from production code.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/session/settings.rs</code>:50 on 2024-04-17 06:57</div>
            <div class="timeline-body"><p>We don&#x27;t need to do this in this PR (or at all).</p>
<p>But the naming we use in Ruff for all the different configuration related structures is:</p>
<ul>
<li><code>*Options</code>: The structs into which serde deserializes the TOML. E.g <code>FormatOptions</code></li>
<li><code>*Configuration</code>: A deserialization format independent representation of the configuration from a single file. Allows combining different configurations</li>
<li><code>*Settings</code>: The settings struct used internally by Ruff that only represents the information relevant at runtime. For example, it no longer has <code>select</code> and <code>ignore</code>. It only tracks the enabled rules.</li>
</ul>
<p>I think it would be good to use the same terminology in the LSP. That means, the structs here would be renamed to <code>Options</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-04-17 07:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-04-17 07:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/session/settings.rs</code>:651 on 2024-04-17 07:01</div>
            <div class="timeline-body"><p>Yeah, like the function is used exactly once. This doesn&#x27;t warrent adding the method. I recommend using <code>LineLength::try_from(80).unwrap()</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/session/settings.rs</code>:272 on 2024-04-17 13:00</div>
            <div class="timeline-body"><p>Maybe the documentation of <code>resolve_or</code> could point to <code>resolve_optional</code> and similarly you could add <code>resolve_or</code> in <code>resolve_optional</code>&#x27;s documentation. The wording would be:</p>
<pre><code>// Use [`ResolvedClientSettings::resolve_optional`] for ...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/session/settings.rs</code>:38 on 2024-04-17 13:02</div>
            <div class="timeline-body"><p>Why use <code>Option&lt;bool&gt;</code>? Can we define a default value instead? It would probably be <code>false</code> for both <code>lint_preview</code> and <code>format_preview</code>.</p>
<p>Same question for other settings where it makes sense. I guess I&#x27;m missing some context here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/session/settings.rs</code>:50 on 2024-04-17 13:04</div>
            <div class="timeline-body"><p>I think we should document this difference in possibly a <code>CONTRIBUTING.md</code> of <code>ruff_workspace</code> crate.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2024-04-17 13:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-04-17 16:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_linter/src/line_width.rs</code>:40 on 2024-04-17 16:15</div>
            <div class="timeline-body"><p>Somehow I did not see the <code>TryFrom</code> implementation ü§¶‚Äç‚ôÄÔ∏è</p>
<p>That&#x27;s a lot easier, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-04-18 06:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/session/settings.rs</code>:38 on 2024-04-18 06:06</div>
            <div class="timeline-body"><p>The reason why these are optional is because we&#x27;ll eventually merge them with the project configuration. If we set them to a default value here, we wouldn&#x27;t have a way of knowing whether that was an actually defined value or just the default value resulting from it being un-set on the client side. I&#x27;ll clarify this in a comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-04-18 07:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-04-18 07:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-04-18 07:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-20 03:14</div>
            <div class="timeline-body"><p>Will <code>--config</code> come later, or is it already supported? That was the last piece of the proposal, IIRC -- but may be misremembering.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-04-20 15:23</div>
            <div class="timeline-body"><p>@charliermarsh That will come later! I&#x27;ll be working on that next week.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:03:29 UTC
    </footer>
</body>
</html>
