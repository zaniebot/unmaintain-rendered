```yaml
number: 7722
title: "Consume the escaped Windows newline (`\\r\\n`) for `FStringMiddle`"
type: pull_request
state: merged
author: dhruvmanila
labels: []
assignees: []
merged: true
base: main
head: dhruv/fstring-eol
created_at: 2023-09-30T18:39:17Z
updated_at: 2023-10-01T02:28:21Z
url: https://github.com/astral-sh/ruff/pull/7722
synced_at: 2026-01-12T15:55:24Z
```

# Consume the escaped Windows newline (`\r\n`) for `FStringMiddle`

---

_@dhruvmanila_

## Summary

This PR fixes a bug where if a Windows newline (`\r\n`) character was escaped, then only the `\r` was consumed and not `\n` leading to an unterminated string error.

## Test Plan

Add new test cases to check the newline escapes.

fixes: #7632


---

_Comment by @dhruvmanila on 2023-09-30 18:39_

Current dependencies on/for this PR:
* main
  * **PR #7724** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7724" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7722** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7722" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7722?utm_source=stack-comment).

---

_Marked ready for review by @dhruvmanila on 2023-09-30 18:46_

---

_Comment by @codspeed-hq[bot] on 2023-09-30 18:49_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/dhruv/fstring-eol)

### Merging #7722 will **improve performances by 6.63%**

<sub>Comparing <code>dhruv/fstring-eol</code> (297fa88) with <code>dhruv/string-escaped-eol</code> (cbe3f43)</sub>



### Summary

`âš¡ 5` improvements
`âœ… 20` untouched benchmarks




### Benchmarks breakdown

|     | Benchmark | `dhruv/string-escaped-eol` | `dhruv/fstring-eol` | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| âš¡ | `lexer[pydantic/types.py]` | 4.2 ms | 4 ms | +6.2% |
| âš¡ | `lexer[large/dataset.py]` | 9.5 ms | 8.9 ms | +6.63% |
| âš¡ | `lexer[unicode/pypinyin.py]` | 617.5 Âµs | 582.6 Âµs | +6% |
| âš¡ | `lexer[numpy/ctypeslib.py]` | 2 ms | 1.9 ms | +5.5% |
| âš¡ | `lexer[numpy/globals.py]` | 240.2 Âµs | 230.5 Âµs | +4.23% |


---

_Comment by @github-actions[bot] on 2023-09-30 18:53_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.



---

_Renamed from "Consume the escaped Windows newline (`\r\n`)" to "Consume the escaped Windows newline (`\r\n`) for `FStringMiddle`" by @dhruvmanila on 2023-09-30 19:11_

---

_Review requested from @charliermarsh by @dhruvmanila on 2023-09-30 19:18_

---

_@charliermarsh approved on 2023-09-30 19:21_

Does this also account for the \r case (carriage return without newline character)?

---

_Comment by @dhruvmanila on 2023-09-30 19:23_

> Does this also account for the \r case (carriage return without newline character)?

Yes, you can confirm that in the snapshots.

---

_Comment by @qarmin on 2023-09-30 19:30_

Looks that this may also fix: (not reported yet, because I don't have file that cause problem)
```
...with the relevant file contents, the `pyproject.toml` settings, and the following stack trace, we'd be very appreciative!
panicked at 'The content 'integration_testing_environment.integration_testing_environment_ui. \
    menu.api_testka_menu.build_api_testka_menu' contains an unsupported '\r' line terminator character but text must only use line feeds '\n' as line separator. Use '\n' instead of '\r' and '\r\n' to insert a line break in strings.', crates/ruff_formatter/src/builders.rs:406:5
Backtrace:    0: ruff_cli::panic::catch_unwind::{{closure}}
             at ./ruff/crates/ruff_cli/src/panic.rs:31:25
   1: <alloc::boxed::Box<F,A> as core::ops::function::Fn<Args>>::call
             at /rustc/d5c2e9c342b358556da91d61ed4133f6f50fc0c3/library/alloc/src/boxed.rs:2007:9
   2: std::panicking::rust_panic_with_hook
             at /rustc/d5c2e9c342b358556da91d61ed4133f6f50fc0c3/library/std/src/panicking.rs:709:13
   3: std::panicking::begin_panic_handler::{{closure}}
             at /rustc/d5c2e9c342b358556da91d61ed4133f6f50fc0c3/library/std/src/panicking.rs:597:13
   4: std::sys_common::backtrace::__rust_end_short_backtrace
             at /rustc/d5c2e9c342b358556da91d61ed4133f6f50fc0c3/library/std/src/sys_common/backtrace.rs:151:18
   5: rust_begin_unwind
             at /rustc/d5c2e9c342b358556da91d61ed4133f6f50fc0c3/library/std/src/panicking.rs:593:5
   6: core::panicking::panic_fmt
             at /rustc/d5c2e9c342b358556da91d61ed4133f6f50fc0c3/library/core/src/panicking.rs:67:14
   7: ruff_formatter::builders::debug_assert_no_newlines
             at ./ruff/crates/ruff_formatter/src/builders.rs:406:5
   8: <ruff_formatter::builders::SourceTextSliceBuilder as ruff_formatter::Format<Context>>::fmt
             at ./ruff/crates/ruff_formatter/src/builders.rs:392:9
   9: <ruff_python_formatter::other::identifier::FormatIdentifier as ruff_formatter::FormatRule<ruff_python_ast::nodes::Identifier,ruff_python_formatter::context::PyFormatContext>>::fmt
             at ./ruff/crates/ruff_python_formatter/src/other/identifier.rs:11:9
  10: <ruff_formatter::FormatRefWithRule<T,R,C> as ruff_formatter::Format<C>>::fmt
             at ./ruff/crates/ruff_formatter/src/lib.rs:608:9
  11: <core::option::Option<T> as ruff_formatter::Format<Context>>::fmt
             at ./ruff/crates/ruff_formatter/src/lib.rs:488:28
  12: ruff_formatter::arguments::Argument<Context>::new::formatter
             at ./ruff/crates/ruff_formatter/src/arguments.rs:43:13
  13: ruff_formatter::arguments::Argument<Context>::format
             at ./ruff/crates/ruff_formatter/src/arguments.rs:56:9
  14: <ruff_formatter::formatter::Formatter<Context> as ruff_formatter::buffer::Buffer>::write_fmt
             at ./ruff/crates/ruff_formatter/src/formatter.rs:220:22
  15: <ruff_python_formatter::statement::stmt_import_from::FormatStmtImportFrom as ruff_python_formatter::FormatNodeRule<ruff_python_ast::nodes::StmtImportFrom>>::fmt_fields
             at ./ruff/crates/ruff_python_formatter/src/statement/stmt_import_from.rs:27:9
  16: ruff_python_formatter::FormatNodeRule::fmt
             at ./ruff/crates/ruff_python_formatter/src/lib.rs:62:13
```

---

_Comment by @dhruvmanila on 2023-10-01 02:28_

> Looks that this may also fix: (not reported yet, because I don't have file that cause problem)

I'm not sure. Maybe if we can get the file content, then we'll be able to diagnose correctly.

---

_Merged by @dhruvmanila on 2023-10-01 02:28_

---

_Closed by @dhruvmanila on 2023-10-01 02:28_

---

_Branch deleted on 2023-10-01 02:28_

---
