<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Improve error messages for except* (B025, B029, B030, B904) #14791 - astral-sh/ruff #14815</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Improve error messages for except* (B025, B029, B030, B904) #14791</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14815">#14815</a>
        opened by <a href="https://github.com/smokyabdulrahman">@smokyabdulrahman</a>
        on 2024-12-06 12:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/smokyabdulrahman">@smokyabdulrahman</a> on 2024-12-06 12:40</div>
            <div class="timeline-body"><p>Improves error message for <a href="https://peps.python.org/pep-0654/">except*</a> (Rules: B025, B029, B030, B904)</p>
<p>Example python snippet:</p>
<pre><code class="language-python">try:
    a = 1
except* ValueError:
    a = 2
except* ValueError:
    a = 2

try:
    pass
except* ():
    pass

try:
    pass
except* 1:  # error
    pass

try:
    raise ValueError
except* ValueError:
    raise UserWarning
</code></pre>
<p>Error messages
Before:</p>
<pre><code>$ ruff check --select=B foo.py
foo.py:6:9: B025 try-except block with duplicate exception `ValueError`
foo.py:11:1: B029 Using `except ():` with an empty tuple does not catch anything; add exceptions to handle
foo.py:16:9: B030 `except` handlers should only be exception classes or tuples of exception classes
foo.py:22:5: B904 Within an `except` clause, raise exceptions with `raise ... from err` or `raise ... from None` to distinguish them from errors in exception handling
Found 4 errors.
</code></pre>
<p>After:</p>
<pre><code>$ ruff check --select=B foo.py
foo.py:6:9: B025 try-except* block with duplicate exception `ValueError`
foo.py:11:1: B029 Using `except* ():` with an empty tuple does not catch anything; add exceptions to handle
foo.py:16:9: B030 `except*` handlers should only be exception classes or tuples of exception classes
foo.py:22:5: B904 Within an `except*` clause, raise exceptions with `raise ... from err` or `raise ... from None` to distinguish them from errors in exception handling
Found 4 errors.
</code></pre>
<p>Closes https://github.com/astral-sh/ruff/issues/14791</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-12-06 12:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/flake8_bugbear/rules/duplicate_exceptions.rs</code>:57 on 2024-12-06 12:51</div>
            <div class="timeline-body"><p>For obscure reasons, let's do this like:</p>
<pre><code class="language-rust">if is_star {
  format!(&quot;try-except* block with duplicate exception `{name}`&quot;)
} else {
  format!(&quot;try-except block with duplicate exception `{name}`&quot;)
}
</code></pre>
<p>(These messages get included as-is in the docs, so it's preferable to expand them like that sometimes.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-06 12:51</div>
            <div class="timeline-body"><p>If you're able, can you run <code>cargo test -p ruff_linter --lib</code> and then <code>cargo insta accept</code> to update the checked-in snapshots? You'll need to run <code>cargo install cargo-insta</code> first.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/smokyabdulrahman">@smokyabdulrahman</a> on 2024-12-06 13:01</div>
            <div class="timeline-body"><blockquote>
<p>If you're able, can you run <code>cargo test -p ruff_linter --lib</code> and then <code>cargo insta accept</code> to update the checked-in snapshots? You'll need to run <code>cargo install cargo-insta</code> first.</p>
</blockquote>
<p>Yes, sure thing. I've ran the tests locally before committing. However, I didn't know how to accept my test modifications.</p>
<p>Thank you üëå I will be doing that with in the next commit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/smokyabdulrahman">@smokyabdulrahman</a> reviewed on 2024-12-06 13:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/smokyabdulrahman">@smokyabdulrahman</a> on <code>crates/ruff_linter/src/rules/flake8_bugbear/rules/duplicate_exceptions.rs</code>:57 on 2024-12-06 13:02</div>
            <div class="timeline-body"><p>sure thing üëç
I will adopt this approach with all the rules.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-12-06 18:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/smokyabdulrahman">@smokyabdulrahman</a> on 2024-12-06 19:00</div>
            <div class="timeline-body"><p>BTW @charliermarsh</p>
<p>Since I am going to fix a couple more rules also. (B025, B029, B030, B904)</p>
<p>Does it make sense to do the following change <a href="https://github.com/astral-sh/ruff/blob/2119dcab6ffb89613b0be4d40dc68b5a2f01526a/crates/ruff_python_parser/src/parser/statement.rs#L1549">in the statement parser</a>:</p>
<pre><code class="language-rust">            ExceptHandler::ExceptHandler(ast::ExceptHandlerExceptHandler {
                type_,
                name,
                body: except_body,
                range: self.node_range(start),
                in_trystar: block_kind.is_star(), &lt;---- `try` block kind
            }),
</code></pre>
<p>so that <code>in_trystar</code> is accessible in all the rules handlers.
or is that an overkill?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-06 19:00</div>
            <div class="timeline-body"><p>@smokyabdulrahman -- I'd prefer not to change the parser / AST, if possible.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-12-06 19:16</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @smokyabdulrahman on 2024-12-06 20:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "WIP: Improve error messages for except* #14791" to "Improve error messages for except* (B025, B029, B030, B904) #14791" by @smokyabdulrahman on 2024-12-06 20:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by @dylwil3 on 2024-12-06 23:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-12-07 18:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast_integration_tests/tests/visitor.rs</code>:250 on 2024-12-07 18:28</div>
            <div class="timeline-body"><p>I'd prefer if we can keep the <code>Visitor</code> trait unchanged.</p>
<p>You can access the <code>try</code> statement from inside the rules using:</p>
<pre><code>let is_star = checker
                    .semantic()
                    .current_statement()
                    .as_try_stmt()
                    .is_some_and(|try_stmt| try_stmt.is_star);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/smokyabdulrahman">@smokyabdulrahman</a> reviewed on 2024-12-07 18:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/smokyabdulrahman">@smokyabdulrahman</a> on <code>crates/ruff_python_ast_integration_tests/tests/visitor.rs</code>:250 on 2024-12-07 18:30</div>
            <div class="timeline-body"><p>Got it üëç
I will be applying the changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-12-07 18:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast_integration_tests/tests/visitor.rs</code>:250 on 2024-12-07 18:37</div>
            <div class="timeline-body"><p>Thanks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/smokyabdulrahman">@smokyabdulrahman</a> reviewed on 2024-12-07 19:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/smokyabdulrahman">@smokyabdulrahman</a> on <code>crates/ruff_python_ast_integration_tests/tests/visitor.rs</code>:250 on 2024-12-07 19:05</div>
            <div class="timeline-body"><p>Change applied.
It's much simpler now!</p>
<p>I should spend sometime reading the common structs' definitions next time. :+1:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @smokyabdulrahman on 2024-12-08 17:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-12-08 17:33</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/smokyabdulrahman">@smokyabdulrahman</a> reviewed on 2024-12-08 17:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/smokyabdulrahman">@smokyabdulrahman</a> on <code>crates/ruff_linter/src/rules/flake8_bugbear/rules/duplicate_exceptions.rs</code>:219 on 2024-12-08 17:34</div>
            <div class="timeline-body"><p>Just for learning purposes. @MichaReiser
Why was this moved inside the <code>diagnostic-branch</code>?</p>
<p>I thought calculating it outside the loop once would be better.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2024-12-08 17:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-12-08 17:37</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 20:42:56 UTC
    </footer>
</body>
</html>
