<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consolidate diagnostics for matched disable/enable suppression comments - astral-sh/ruff #22099</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Consolidate diagnostics for matched disable/enable suppression comments</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22099">#22099</a>
        opened by <a href="https://github.com/amyreese">@amyreese</a>
        on 2025-12-19 21:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Combines diagnostics for matched suppression comments, so that ranges and autofixes for both
the <code>#ruff:disable</code> and <code>#ruff:enable</code> comments will be reported as a single diagnostic.</p>
<h2>Test Plan</h2>
<p>Snapshot changes, added new snapshot for full output from preview mode rather than just a diff.</p>
<p>Issue #3711</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @amyreese on 2025-12-19 21:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">suppression</span> added by @amyreese on 2025-12-19 21:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @amyreese on 2025-12-19 21:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @amyreese on 2025-12-19 21:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @amyreese on 2025-12-19 21:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-19 22:06</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/mod.rs</code>:340 on 2025-12-22 10:29</div>
            <div class="timeline-body"><p>Can you say what the reason is for adding this test? How is it different from <code>range_suppressions</code> (I see that it isn't a diff but it otherwise seems to capture the same)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/snapshots/ruff_linter__rules__ruff__tests__range_suppressions.snap</code>:555 on 2025-12-22 10:30</div>
            <div class="timeline-body"><p>I think the help text here is a bit misleading. It should probably be: Remove the invalid suppression</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/suppression.rs</code>:116 on 2025-12-22 10:38</div>
            <div class="timeline-body"><p>You can simplify your code by encoding the invariant &quot;that there's always at least a disable-comment&quot; into the struct:</p>
<pre><code class="language-suggestion">
    comments: DisableEnableComments,
}

#[derive(Debug)]
pub(crate) enum DisableEnableComments {
    /// An implicitly closed disable comment without a matching enable comment.
    Disable(SuppressionComment),

    /// A matching pair of disable and enable comments.
    Pair(SuppressionComment, SuppressionComment),
}

impl DisableEnableComments {
    pub(crate) fn disable_comment(&amp;self) -&gt; &amp;SuppressionComment {
        match self {
            DisableEnableComments::Disable(comment) =&gt; comment,
            DisableEnableComments::Pair(disable, _) =&gt; disable,
        }
    }

    pub(crate) fn enable_comment(&amp;self) -&gt; Option&lt;&amp;SuppressionComment&gt; {
        match self {
            DisableEnableComments::Disable(_) =&gt; None,
            DisableEnableComments::Pair(_, enable) =&gt; Some(enable),
        }
    }
}
</code></pre>
<p>It then allows you to write:</p>
<pre><code class="language-rust">            } else if let DisableEnableComments::Disable(disable_comment) = &amp;suppression.comments
            {
                // UnmatchedSuppressionComment
                let range = disable_comment.range;
                if unmatched_ranges.insert(range) {
                    context.report_diagnostic_if_enabled(UnmatchedSuppressionComment {}, range);
                }
            }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/suppression.rs</code>:1705 on 2025-12-22 10:41</div>
            <div class="timeline-body"><p>We don't need an owned comment here (this shoudl allow you to remove most <code>.clone</code> calls in debug</p>
<pre><code class="language-suggestion">        comment: Option&lt;&amp;'a SuppressionComment&gt;,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/suppression.rs</code>:286 on 2025-12-22 10:43</div>
            <div class="timeline-body"><p>You want to use a <code>if let Some(..)</code> here to avoid the unwrap (similar to a <code>if enable_comment := suppression.enable_comment</code> in Python)</p>
<pre><code class="language-suggestion">            if let Some(enable_comment) = suppression.enable_comment.as_ref() {
                let (range2, edit2) = Suppressions::delete_code_or_comment(
                    locator,
                    suppression,
                    enable_comment,
                    highlight_only_code,
                );
                diagnostic.secondary_annotation(&quot;&quot;, range2);
                diagnostic.set_fix(Fix::applicable_edits(edit, vec![edit2], applicability));
            } else {
                diagnostic.set_fix(Fix::applicable_edit(edit, applicability));
            }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/suppression.rs</code>:276 on 2025-12-22 10:44</div>
            <div class="timeline-body"><p>Nit: <code>enable_range</code> and <code>remove_enable_comment_edit</code> would be more meaningful names</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/suppression.rs</code>:179 on 2025-12-22 10:49</div>
            <div class="timeline-body"><p>Both fixes are safe, so I think we can avoid passing the fix safety here</p>
<pre><code class="language-suggestion"></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/suppression.rs</code>:283 on 2025-12-22 10:51</div>
            <div class="timeline-body"><p>Nit: We don't need to allocate a vector here, <code>applicable_edits</code> takes any type that implements <code>IntoIter</code>, like a stack allocated array</p>
<pre><code class="language-suggestion">                diagnostic.set_fix(Fix::applicable_edits(edit, [edit2], applicability));
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/suppression.rs</code>:309 on 2025-12-22 10:54</div>
            <div class="timeline-body"><p>Let's create an issue to track fixing <code>delete_code_or_comment</code> to correctly handle the cases where a suppression comment contains repeated codes (in which case <code>code_index</code> will always delete the first unused code but never the second).</p>
<p>The <code>unwrap</code> call in <code>delete_code_or_comment</code> also deserves a commetn why it is okay to call <code>unwrap</code> there OR, even better, use <code>expect</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-12-22 10:57</div>
            <div class="timeline-body"><p>I've a few nit comments and a suggestion on how to encode the invariant that a suppression always has at least a <code>disable</code> comment.</p>
<p>I also think we should delete the <code>_full</code> test. It's not clear what value it adds over the existing test</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> reviewed on 2026-01-05 22:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/rules/ruff/mod.rs</code>:340 on 2026-01-05 22:39</div>
            <div class="timeline-body"><p>It was a lot easier to analyze and debug the changes to the test cases when only seeing the raw output/diff of changes, rather than trying to decipher the diff of diffs. We don't need to keep it, but it was extremely helpful when working on this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> reviewed on 2026-01-05 23:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/suppression.rs</code>:1705 on 2026-01-05 23:56</div>
            <div class="timeline-body"><p>How do I then deal with the ownership of the <code>SuppressionComment</code> created in <code>parse_suppression_comment()</code>?  https://github.com/astral-sh/ruff/pull/22099/changes#diff-35bdff8d5bced4b2e861a0c49467cce54db87355ba881a3e7482e936fead6750L1561</p>
<p>With your suggested change, I get <code>cannot return value referencing local variable comment returns a value referencing data owned by the current function</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2026-01-06 07:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/mod.rs</code>:340 on 2026-01-06 07:45</div>
            <div class="timeline-body"><p>I'm leaning towards removing it as it's now mainly creating noise by duplicating all changes and it seems easy enough to re-add when debugging</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/suppression.rs</code>:1571 on 2026-01-06 07:51</div>
            <div class="timeline-body"><pre><code class="language-suggestion">            TextRange::new(offset, source.text_len()),
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2026-01-06 07:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/suppression.rs</code>:1705 on 2026-01-06 08:00</div>
            <div class="timeline-body"><p>Oh, I didn't see that use. Yeah, this doesn't work. You could use a <code>Cow</code> which is an enum over an owned value or a reference. But it's not worth it given that this ist test only.</p>
<p>The other solution is to move the ownership one level up, but this will make your tests more verbose (as in, there's more repeated code).</p>
<pre><code class="language-rust">    #[test]
    fn enable_single_code() -&gt; Result&lt;(), ParseError&gt; {
        let source = &quot;# ruff: enable[some-thing]&quot;;
        let comment = parse_suppression_comment(source)?;
        
        assert_debug_snapshot!(
            DebugSuppressionComment::new(comment, source),
            @r##&quot;
            SuppressionComment {
                text: &quot;# ruff: enable[some-thing]&quot;,
                action: Enable,
                codes: [
                    &quot;some-thing&quot;,
                ],
                reason: &quot;&quot;,
            },
        &quot;##,
        );

				Ok(())
    }
</code></pre>
<p>So, I think keeping what you have is fine.</p>
<p>(Changing your test function to return a <code>Result</code> might be worth it (or always calling <code>unwrap</code> on parse_suppression_comment<code>to avoid the noisy</code>Ok` wrapping in the snapshots</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2026-01-06 08:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @amyreese on 2026-01-07 02:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @amyreese on 2026-01-07 02:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2026-01-07 02:42</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:18:16 UTC
    </footer>
</body>
</html>
