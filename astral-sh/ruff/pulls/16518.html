<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add `OsSystem` support to mdtests - astral-sh/ruff #16518</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add <code>OsSystem</code> support to mdtests</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16518">#16518</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-03-05 12:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-05 12:57</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR introduces a new mdtest option <code>system</code> that can either be <code>in-memory</code> or <code>os</code>
where <code>in-memory</code> is the default.</p>
<p>The motivation for supporting <code>os</code> is so that we can write OS/system specific tests
with mdtests. Specifically, I want to write mdtests for the module resolver,
testing that module resolution is case sensitive.</p>
<h2>Test Plan</h2>
<p>I tested that the case-sensitive module resolver test start failing when setting <code>system = &quot;os&quot;</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @MichaReiser on 2025-03-05 13:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-05 13:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_project/src/metadata.rs</code>:324 on 2025-03-05 13:03</div>
            <div class="timeline-body"><p>I'm not very fond of this name. The <code>MemoryFileSystem::write_files</code> and <code>write_file</code> methods used to create any missing directories. This is inconsistent with what other systems do but is very convenient in tests.</p>
<p>That's why I renamed the existing <code>write_files</code> and <code>write_file</code> methods to <code>write_files_all</code> and <code>write_file_all</code> (in resemblence of <code>create_dir_all</code>) and created a new <code>write_file</code> method that errors when the parent directory doesn't exist. However, I don't think it's a very good name.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2025-03-05 14:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MichaReiser on 2025-03-05 14:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MichaReiser on 2025-03-05 14:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @MichaReiser on 2025-03-05 14:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-05 14:40</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_project/src/files.rs</code>:258 on 2025-03-05 17:37</div>
            <div class="timeline-body"><p>Why is the <code>as _</code> needed here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_db/src/system/test.rs</code>:162 on 2025-03-05 17:48</div>
            <div class="timeline-body"><p>Given the naming adjustments throughout this PR, I'm confused why a method named <code>write_file</code> explicitly creates all parent directories here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_project/src/metadata.rs</code>:324 on 2025-03-05 17:50</div>
            <div class="timeline-body"><p>The only other options that come to mind are significantly more verbose; <code>write_files_mkdirs</code>, <code>write_files_with_parents</code>... I think <code>write_files_all</code> is OK.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/src/db.rs</code>:31 on 2025-03-05 18:00</div>
            <div class="timeline-body"><p>Do we ever create an <code>MdtestSystem</code> with any cwd other than <code>/</code>? Should that just be built-in?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/src/db.rs</code>:45 on 2025-03-05 18:01</div>
            <div class="timeline-body"><p>It seems surprising at first that &quot;resetting&quot; a real fs just means throwing it away and replacing it with an in-memory fs. But I guess it makes sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/src/db.rs</code>:53 on 2025-03-05 18:03</div>
            <div class="timeline-body"><p>I think the <code>with_*</code> naming is surprising for methods that mutate in-place; that name strongly suggests an immutable builder pattern where <code>self</code> is cloned and the updated one is returned. (Because in that case the method name describes the returned object.)</p>
<p>For in-place mutation I would expect e.g. <code>set_tempdir_fs</code> and <code>set_os</code> instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/src/db.rs</code>:40 on 2025-03-05 18:05</div>
            <div class="timeline-body"><p>Nit: maybe delegate to a <code>self.system.reset_fs()</code> instead of digging so much into <code>MdTestSystem</code> internals from outside?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-03-05 18:07</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-05 18:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/system/test.rs</code>:162 on 2025-03-05 18:55</div>
            <div class="timeline-body"><p>Yeah that's fair. The thinking was that this trait is only used for testing where this seems the right default. But I can see how it is confusing in the bigger picture.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-06 09:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_project/src/files.rs</code>:258 on 2025-03-06 09:23</div>
            <div class="timeline-body"><p>It's not technically needed but it only makes the trait available in the module without importing it by name. That means you can call all the extension methods without binding the name locally.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-06 09:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/db.rs</code>:53 on 2025-03-06 09:28</div>
            <div class="timeline-body"><blockquote>
<p>that name strongly suggests an immutable builder pattern where self is cloned and the updated one is returned</p>
</blockquote>
<p>I've seen both usages of <code>with_</code> where they take <code>self</code> or <code>&amp;mut self</code>. I'd say it's even more common for builders taking <code>self</code> to omit the <code>with_</code> prefix altogether (because they don't have getters).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-03-06 09:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-03-06 09:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-03-06 09:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-03-06 15:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/src/db.rs</code>:53 on 2025-03-06 15:22</div>
            <div class="timeline-body"><p>I think the more relevant distinction maybe is that I would expect builder methods named <code>with_*</code> to return <code>self</code> (whether they clone or mutate in place) so they can be called chained; again because the <code>with_*</code> naming describes what is returned from the method.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:49:32 UTC
    </footer>
</body>
</html>
