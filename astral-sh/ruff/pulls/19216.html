<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add &quot;kind&quot; to completion suggestions - astral-sh/ruff #19216</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add &quot;kind&quot; to completion suggestions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19216">#19216</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2025-07-08 19:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-07-08 19:54</div>
            <div class="timeline-body"><p>This PR does some refactoring to expose a <code>Type</code> for each completion
item. This is mostly unexciting, except for the case of determining the
type of an instance attribute. Once the <code>Type</code> information is exposed,
we define a mapping between it and <a href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#completionItemKind"><code>CompletionItemKind</code></a>.</p>
<p>The mapping isn't perfect (it gives up on union/intersection types),
but we can improve it going forward. And it at least should give some
nice icons for many cases.</p>
<p>Closes astral-sh/ty#775</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @BurntSushi on 2025-07-08 19:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @BurntSushi on 2025-07-08 19:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @BurntSushi on 2025-07-08 19:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @BurntSushi on 2025-07-08 19:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @BurntSushi on 2025-07-08 19:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-07-08 19:55</div>
            <div class="timeline-body"><p>Demo in neovim:</p>
<p>https://github.com/user-attachments/assets/ab9368c4-af42-41d2-895d-88b2bce0a790</p>
<p>Demo in VS Code:</p>
<p>https://github.com/user-attachments/assets/783ccf95-39e6-4968-b41c-cc4cbde1edd0</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dcreager removed by @BurntSushi on 2025-07-08 19:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @BurntSushi on 2025-07-08 19:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @BurntSushi on 2025-07-08 19:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-08 19:58</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @MichaReiser on 2025-07-09 06:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @MichaReiser on 2025-07-09 06:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types/ide_support.rs</code>:300 on 2025-07-09 06:15</div>
            <div class="timeline-body"><p>Can you document why the equality only takes the name into account but not its type</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/api/requests/completion.rs</code>:111 on 2025-07-09 06:17</div>
            <div class="timeline-body"><p>We'll need the exact same mapping for <code>ty_wasm</code> to show the same symbols in the playground. Because of that, it would be great if <code>Completion</code> had a <code>kind</code> method that returns our own mapping which the server/playground facades then map to VS code's kinds.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-07-09 06:21</div>
            <div class="timeline-body"><p>Nice. It seems there are now two failing mdtests. I would also like if @sharkdp could take a look at the changes to <code>all_declarations_and_bindings</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-07-09 06:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_ide/src/completion.rs</code>:1232 on 2025-07-09 06:59</div>
            <div class="timeline-body"><p>If you take the example above and use <code>reveal_type(quux.some_attribute)</code>, you'll notice that a lot of these types here do not correspond to the actual type of the argument. This is because taking the type from the class body declaration/binding directly does not invoke the descriptor protocol. For example, <code>__class__</code> has a type of <code>property</code> here, but if you were to invoke the descriptor protocol, you would call the <code>__get__</code> method of the <code>property</code> and get <code>type[Quux]</code> as the result.</p>
<p>Similar, all functions are descriptors. When accessed on a class instance (like <code>quux: Quux</code>), they turn into bound method objects. So the type of <code>__delattr__</code> should be <code>bound method Quux.__delattr__(name: str, /) -&gt; None</code> (where the <code>self</code> parameter is already bound).</p>
<p>This probably means that we're incorrectly labeling methods as <code>CompletionItemKind::FUNCTION</code> instead of <code>CompletionItemKind::METHOD</code>, since we're not turning function literal types into bound method types.</p>
<p>Instead of repeating a lot of functionality from type inference here, I wonder if we can simply call <code>Type::member</code> for all attribute completions? No matter if it's a class member or an instance member, <code>Type::member</code> will do the right thing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_server/src/server/api/requests/completion.rs</code>:106 on 2025-07-09 07:05</div>
            <div class="timeline-body"><p>A lot of attributes may have dynamic types. Everything that is not annotated, for example. Maybe we should fall back to <code>VALUE</code>/<code>STRUCT</code> here for most of the variants in this match arm?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-07-09 07:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-07-09 07:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_server/src/server/api/requests/completion.rs</code>:108 on 2025-07-09 07:08</div>
            <div class="timeline-body"><p>A decent heuristic might be to go through the elements in the union and to take the kind of the first element that is not <code>None</code>?</p>
<p>Similar for intersections, go through all positive elements..?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_server/src/server/api/requests/completion.rs</code>:90 on 2025-07-09 07:09</div>
            <div class="timeline-body"><p>Maybe <code>INTERFACE</code> for protocols?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-07-09 07:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/requests/completion.rs</code>:91 on 2025-07-09 08:19</div>
            <div class="timeline-body"><p>There seems to be a <code>CompletionItemKind::PROPERTY</code>, should we use that instead here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/requests/completion.rs</code>:113 on 2025-07-09 08:23</div>
            <div class="timeline-body"><p>Should these be <code>FUNCTION</code> instead?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/api/requests/completion.rs</code>:109 on 2025-07-09 08:28</div>
            <div class="timeline-body"><p>Should we use <code>STRUCT</code> for these instead?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-07-09 08:29</div>
            <div class="timeline-body"><p>Looks good! Maybe @AlexWaygood could take a look at the <code>Type</code> -&gt; <code>CompletionItemKind</code> mapping?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-07-09 08:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_server/src/server/api/requests/completion.rs</code>:91 on 2025-07-09 08:48</div>
            <div class="timeline-body"><p>I guess <code>PROPERTY</code> was probably meant for something else. It's also extremely unlikely that someone will see something of type <code>PropertyInstance</code>, as you would normally see it's resolved <code>__get__</code> return type.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-09 09:05</div>
            <div class="timeline-body"><blockquote>
<p>Looks good! Maybe @AlexWaygood could take a look at the <code>Type</code> -&gt; <code>CompletionItemKind</code> mapping?</p>
</blockquote>
<p>I see the list of possible kinds in the LSP spec, but is there a description of what each <code>Kind</code> is meant to represent somewhere? E.g. <code>Struct</code> is not a term that would normally apply to Python at all; I don't know that I fully understand what it means for a completion to have a <code>CompletionItemKind::STRUCT</code> in the context of ty</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-09 09:12</div>
            <div class="timeline-body"><p>@AlexWaygood I don't think there is. My best guess is that a struct maps to a c# struct which has copy semantics by default, is passed by value, compares equal if its values are equal. This is unlike classes (in c#) that are passed by reference, compare equal if the reference is equal, ...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_server/src/server/api/requests/completion.rs</code>:99 on 2025-07-09 09:17</div>
            <div class="timeline-body"><p>I'm not sure I fully understand what <code>TEXT</code> is meant to represent, but my intuition would be something like when you're typing a string literal like this:</p>
<pre><code class="language-py">&quot;The Eiffel &lt;CURSOR&gt;&quot;
</code></pre>
<p>and then we would (somehow) autocomplete <code>Tower</code> to finish the string, given arbitrary sophistication. I don't know if it makes sense to think of a completion like the following, where we would autocomplete <code>tribute</code> to finish the expression <code>Foo.attribute</code> as a <code>TEXT</code> completion rather than a <code>VALUE</code> completion (<code>Foo.attribute</code> will be inferred as having type <code>Literal[&quot;X&quot;]</code> here, a.k.a. <code>Type::StringLiteral(_)</code>, so we'll be in this branch of the <code>match</code>):</p>
<pre><code class="language-py">from typing import Final

class Foo:
    attribute: Final = &quot;X&quot;

Foo.at&lt;CURSOR&gt;
</code></pre>
<p>Relatedly: if a <code>PlaceAndQualifiers</code> with <em>any</em> type has the <code>Final</code> qualifier, it actually probably make sense to use <code>CompletionItemKind::CONSTANT</code>, since the <code>Place</code> cannot be reassigned to if it has that qualifier. (<code>Qualifiers</code> are not stored on a <code>Type</code>, but they are stored on a <code>PlaceAndQualifiers</code>, and <code>Type::member()</code> returns a <code>PlaceAndQualifiers</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_server/src/server/api/requests/completion.rs</code>:113 on 2025-07-09 09:21</div>
            <div class="timeline-body"><p><code>WrapperDescriptor</code> should be <code>FUNCTION</code>, <code>MethodWrapper</code> should be <code>METHOD</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-07-09 09:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-07-09 14:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_server/src/server/api/requests/completion.rs</code>:106 on 2025-07-09 14:49</div>
            <div class="timeline-body"><p>I don't think I have a strong opinion here. I kind of feel like we <em>shouldn't</em> affix a kind if we don't actually know what it is. I guess I would rather the kind be unknown in the common case rather than occasionally wrong? Maybe this is something we leave for now.</p>
<p>EDIT: Changed a &quot;should&quot; to a &quot;shouldn't&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-07-09 14:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_server/src/server/api/requests/completion.rs</code>:108 on 2025-07-09 14:56</div>
            <div class="timeline-body"><p>Aye, done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-07-09 14:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:1232 on 2025-07-09 14:59</div>
            <div class="timeline-body"><p>Thank you, this was super helpful.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_server/src/server/api/requests/completion.rs</code>:111 on 2025-07-09 15:00</div>
            <div class="timeline-body"><p>Blech. Yeah.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-07-09 15:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-07-09 15:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_server/src/server/api/requests/completion.rs</code>:109 on 2025-07-09 15:12</div>
            <div class="timeline-body"><p><code>SpecialForm</code> could arguably be <code>CONSTANT</code> -- these are special symbols in the <code>typing</code> module that are all heavily special-cased by the typing system. They are type constructors, special forms, and type qualifiers that all have unique meaning when it comes to constructing types or annotating variables. You should never reassign them</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_server/src/server/api/requests/completion.rs</code>:109 on 2025-07-09 15:16</div>
            <div class="timeline-body"><p>I don't know. It's not obvious to me that we should. Like, <code>KnownInstance</code> can be a <code>TypeVar</code>? Maybe these need to be introspected more.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-07-09 15:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-07-09 15:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_server/src/server/api/requests/completion.rs</code>:109 on 2025-07-09 15:18</div>
            <div class="timeline-body"><p>Yeah, if it's a <code>KnownInstanceType::TypeVar</code> it should probably be <code>TypeParameter</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-07-09 15:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_server/src/server/api/requests/completion.rs</code>:99 on 2025-07-09 15:20</div>
            <div class="timeline-body"><p>I change this to <code>VALUE</code>. I'm partially convinced by your argument.</p>
<p>As for <code>CONSTANT</code>, I added your idea to my notes for a future improvement. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-07-09 15:23</div>
            <div class="timeline-body"><p>w.r.t. to <code>STRUCT</code>, my interpretation of that is basically maximally permissive: &quot;product type.&quot; That's how Rust uses it at least, so there's some precedent. We can certainly change this in response to user feedback.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-07-09 15:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @BurntSushi on 2025-07-09 15:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @BurntSushi on 2025-07-09 16:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2025-07-09 16:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-09 16:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/ide_support.rs</code>:271 on 2025-07-10 09:04</div>
            <div class="timeline-body"><p>I think this is fine for instances now, but note that something similar happens for accessing attributes on the class directly as well. Whenever an attribute is available on the <em>metaclass</em>, the descriptor protocol is invoked.</p>
<p>Attribute access always works like this: if the attribute is available on the <em>meta type</em> (for instances: the class, for classes: the metaclass), the descriptor protocol is invoked. If the attribute is available on the type itself, the descriptor protocol is not invoked.</p>
<p>To illustrate: https://play.ty.dev/2f98105c-1f02-4e16-89dd-79fa8b82b462</p>
<p>There's an additional complication if the attribute is accessible on both the meta type and the type itself. Which of these takes precedence depends on the nature of the descriptor (data descriptor vs non-data descriptor).</p>
<p>This is why I suggested elsewhere that we might be best off by calling <code>Type::member</code> for all attribute candidates? This would not just guarantee that we invoke the descriptor protocol if necessary. It would also take care of precedence, and handle unions/intersections, as well as possible-unboundness of attributes correctly (by building union types of result types from different stages of the descriptor protocol).</p>
<p>If you're looking for a test case that would show that something is not yet handled correctly, I guess the following metaclass example would work:</p>
<pre><code class="language-py">class Meta(type):
    @property
    def meta_attr(self) -&gt; int:
        return 0

class C(metaclass=Meta): ...

# accessing `meta_attr` on `C` should be `int`
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-07-10 09:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_python_semantic/src/types/ide_support.rs</code>:271 on 2025-07-11 14:48</div>
            <div class="timeline-body"><p>PR up with an attempt to fix this: https://github.com/astral-sh/ruff/pull/19286</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-07-11 14:48</div>
            <div class="timeline-body"></div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 18:33:38 UTC
    </footer>
</body>
</html>
