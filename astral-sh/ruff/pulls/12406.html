<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Upgrade to the *new* *new* salsa - astral-sh/ruff #12406</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Upgrade to the <em>new</em> <em>new</em> salsa</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/12406">#12406</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-07-19 13:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><p>This PR upgrades Salsa and refactors our code to the <a href="https://salsa.zulipchat.com/#narrow/stream/333573-salsa-3.2E0/topic/branch.3A.20.22hassle-free.22.20salsa"><em>hassle free</em> salsa</a>.</p>
<p>Most notable changes:</p>
<ul>
<li>Salsa macros no longer generate clippy warnings, :partying_face:</li>
<li><code>Jar</code> is gone. Adding <code>[#salsa::tracked]</code> is enough</li>
<li>Implementing any <code>Db</code> trait requires the <code>[#salsa::db]</code> macro</li>
<li><code>ParallelDatabase</code> is gone, use <code>Handle</code> instead</li>
<li><code>DebugWithDb</code> no longer exist. Instead use the normal <code>Debug</code> implementation. Outside a query, use <code>db.attach(|db| dbg!(ingredient))</code>.</li>
</ul>
Performance regression
<p>I invested quiet some time in figuring out where the regression comes from but I haven&#x27;t been successful so far. See <a href="https://salsa.zulipchat.com/#narrow/stream/333573-salsa-3.2E0/topic/Beautiful.20Salsa.20perf.20incremental.20checking.20perf.20regression">this zulip thread</a> for the entire conversation. I don&#x27;t think we should block the PR based on the regression.</p>
<p>There are ideas on how to mitigate the perf regression. I don&#x27;t want to block this PR by it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-07-20 09:55</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/upgrade-to-new-new-salsa">CodSpeed Performance Report</a>
Merging #12406 will <strong>degrade performances by 16.85%</strong>
<p>Comparing <code>upgrade-to-new-new-salsa</code> (a753af2) with <code>main</code> (9495331)</p>
Summary
<p><code>❌ 2</code> regressions
<code>✅ 31</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/upgrade-to-new-new-salsa">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
Benchmarks breakdown
<p>|     | Benchmark | <code>main</code> | <code>upgrade-to-new-new-salsa</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ❌ | <code>red_knot_check_file[incremental]</code> | 445.1 µs | 535.3 µs | -16.85% |
| ❌ | <code>red_knot_check_file[without_parse]</code> | 6.5 ms | 6.8 ms | -4.42% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-07-20 10:09</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to parse examples/Chat_finetuning_data_prep.ipynb:6:18:25: Unparenthesized generator expression cannot be used here
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_gmail.ipynb:15:1:1: Expected an expression
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_jira.ipynb:15:1:1: Expected an expression
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_sharepoint_doc.ipynb:28:1:5: Simple statements must be separated by newlines or semicolons
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_sharepoint_text.ipynb:28:1:5: Simple statements must be separated by newlines or semicolons
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_middleware_azure_function.ipynb:37:1:13: Simple statements must be separated by newlines or semicolons
</code></pre>
</p>


Formatter (preview)
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to parse examples/Chat_finetuning_data_prep.ipynb:6:18:25: Unparenthesized generator expression cannot be used here
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_gmail.ipynb:15:1:1: Expected an expression
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_jira.ipynb:15:1:1: Expected an expression
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_sharepoint_doc.ipynb:28:1:5: Simple statements must be separated by newlines or semicolons
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_sharepoint_text.ipynb:28:1:5: Simple statements must be separated by newlines or semicolons
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_middleware_azure_function.ipynb:37:1:13: Simple statements must be separated by newlines or semicolons
</code></pre>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-25 14:30</div>
            <div class="timeline-body"><p>This is mostly done. The part that&#x27;s missing is to find a way to assert whether a query did run. Salsa&#x27;s new model no-longer exposes the query itself. We probably need to fallback to doing string comparisons, ugh</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-25 14:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-26 08:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-26 08:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-26 08:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/src/main.rs</code>:134 on 2024-07-26 16:06</div>
            <div class="timeline-body"><p>We do this just to save on drop costs since we are exiting anyway?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/src/main.rs</code>:303 on 2024-07-26 16:07</div>
            <div class="timeline-body"><p>Did you mean to say &quot;with info&quot; here instead of &quot;with warn&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/db.rs</code>:112 on 2024-07-26 16:15</div>
            <div class="timeline-body"><p>So the new Salsa has a thread-local Db that&#x27;s used for Debug, and <code>attach</code> sets the thread-local? Seems like that will have some cost, but ideally it&#x27;s only used for debug code and can be avoided in the most perf sensitive cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/semantic_index.rs</code>:53 on 2024-07-26 16:17</div>
            <div class="timeline-body"><p>Snuck in some tracing improvements, too! Is this related to the Salsa change? Either way, I like it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2423 on 2024-07-26 16:18</div>
            <div class="timeline-body"><p>This ended up improving the usability of the API! Nice.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-07-26 16:19</div>
            <div class="timeline-body"><p>This looks fantastic!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-26 17:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/src/main.rs</code>:134 on 2024-07-26 17:21</div>
            <div class="timeline-body"><p>yes</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-26 17:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/db.rs</code>:112 on 2024-07-26 17:22</div>
            <div class="timeline-body"><p>Yes, it uses thread local but no, Salsa also uses thread local whenever it goes from external API -&gt; internal. That&#x27;s where the perf regression comes form (at least, one of them).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-26 17:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index.rs</code>:53 on 2024-07-26 17:23</div>
            <div class="timeline-body"><p>It&#x27;s because <code>debug</code> now prints the entire struct and not just the id. This was very verbose, so I had to truncate it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-26 17:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2423 on 2024-07-26 17:23</div>
            <div class="timeline-body"><p>Yeah I think so. String matching is still a bit annoying but we at least have tests that tell us when the string matching stops working.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-29 07:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-29 07:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-07-29 07:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:05:21 UTC
    </footer>
</body>
</html>
