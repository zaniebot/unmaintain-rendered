<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add a `ScopeKind` for the `__class__` cell - astral-sh/ruff #20048</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add a <code>ScopeKind</code> for the <code>__class__</code> cell</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20048">#20048</a>
        opened by <a href="https://github.com/ntBre">@ntBre</a>
        on 2025-08-22 17:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/ntBre">@ntBre</a> on 2025-08-22 17:42</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR aims to resolve (or help to resolve) #18442 and #19357 by encoding the CPython semantics around the <code>__class__</code> cell in our semantic model. Namely,</p>
<blockquote>
<p><code>__class__</code> is an implicit closure reference created by the compiler if any methods in a class body refer to either <code>__class__</code> or super.</p>
</blockquote>
<p>from the Python <a href="https://docs.python.org/3/reference/datamodel.html#creating-the-class-object">docs</a>.</p>
<p>As noted in the variant docs by @AlexWaygood, we don't fully model this behavior, opting always to create the <code>__class__</code> cell binding in a new <code>ScopeKind::DunderClassCell</code> around each method definition, without checking if any method in the class body actually refers to <code>__class__</code> or <code>super</code>.</p>
<p>As such, this PR fixes #18442 but not #19357.</p>
<h2>Test Plan</h2>
<p>Existing tests, plus the tests from #19783, which now pass without any rule-specific code.</p>
<p>Note that we opted not to alter the behavior of F841 here because flagging <code>__class__</code> in these cases still seems helpful. See the discussion in https://github.com/astral-sh/ruff/pull/20048#discussion_r2296252395 and in the test comments for more information.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @ntBre on 2025-08-22 17:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> removed by @ntBre on 2025-08-22 17:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ntBre on 2025-08-22 17:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-08-22 17:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_semantic/src/binding.rs</code>:459 on 2025-08-22 17:44</div>
            <div class="timeline-body"><p>oops, I think this is unused and can go (leftover from an earlier version of the PR!)</p>
<pre><code class="language-suggestion"></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-22 17:54</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-08-22 20:50</div>
            <div class="timeline-body"><p>I pulled in the tests from #19783 (and added @mikeleppane as a co-author, thank you!) and the issue with those rules is now resolved, with one additional change to the semantic model to reuse the cell binding for <code>__class__</code> in <code>add_binding</code> (c1604dd1c4).</p>
<p>I also tried the tests from #19424, but I think these still need some rule-specific code, so I decided to leave that as a separate PR. The changes here should still help, but they aren't sufficient on their own.</p>
<p>Finally, I applied our <code>class_variables_visible</code> change in a couple more places. Those were some of the last references to <code>&quot;__class__&quot;</code> that I found from grepping.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @ntBre on 2025-08-22 21:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_semantic/src/scope.rs</code>:172 on 2025-08-23 11:28</div>
            <div class="timeline-body"><p>a couple of nits:</p>
<ul>
<li>I think maybe <code>DunderClassCell</code> might be a better name for the variant? <code>ClassCell</code> might imply that it's something to do with classes, which it <em>is</em>, but we're really using &quot;class&quot; here to refer to the dunder-class variable rather than the class itself</li>
<li>I wonder if we should move the long comment we added in <code>crates/ruff_linter/src/checkers/ast/mod.rs</code> to be a doc-comment above this enum variant, and add a new comment where the long comment currently is that just says to see the doc-comment for this enum variant to find out what this <code>DunderClassCell</code> thing is. That way I'll see the long comment if I'm hovering over the variant in VSCode. I think I'd also expect to see some docs here if I clicked go-to definition in my IDE.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_semantic/src/model.rs</code>:438 on 2025-08-23 11:31</div>
            <div class="timeline-body"><p>I guess we could also write this as</p>
<pre><code class="language-suggestion">            class_variables_visible =
                matches!((scope.kind, index), (ScopeKind::Type, 0) | (ScopeKind::ClassCell, 1));
</code></pre>
<p>I'm happy with either! (If you do update this, it would be good to update the other occurence in this file too)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_semantic/src/binding.rs</code>:692 on 2025-08-23 11:32</div>
            <div class="timeline-body"><p>I guess I'd prefer <code>DunderClassCell</code> as the name for this variant too</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:2495 on 2025-08-23 18:20</div>
            <div class="timeline-body"><p>I know that if you remove this branch of code, we get a lot more F841 errors in the snapshot you added saying that various <code>__class__</code> definitions are assigned to but never used. But I actually feel like most of those diagnostics are desirable? I know that there's an example in https://github.com/astral-sh/ruff/issues/18442#issue-3114385820 of where assigning to <code>__class__</code> in one method will change the value of <code>__class__</code> when it's accessed in a very specific way from another method. But that honestly seems like extremely far-fetched code that neither a human nor an LLM would ever write. To me a diagnostic telling me that the assignment to <code>__class__</code> in <code>F.method()</code> here is unused seems useful -- for all common ways of accessing <code>__class__</code>, mutations made in one method will not affect the value as seen by other methods:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; class F:
...     def method(self):
...         __class__ = 42
...     def method2(self):
...         print(__class__)
...         
&gt;&gt;&gt; f = F()
&gt;&gt;&gt; f.method()
&gt;&gt;&gt; f.method2()
&lt;class '__main__.F'&gt;
</code></pre>
<p>IMO, practicality beats purity here -- if there's a bug in F841 regarding <code>__class__</code>, it's only that it refers to it as a &quot;local variable&quot;. We could consider making this edit to the error message if the variable name is <code>__class__</code> specifically:</p>
<pre><code class="language-diff">- f841_ple0117.py:14:9: F841 Local variable `__class__` is assigned to but never used
+ f841_ple0117.py:14:9: F841 Variable `__class__` is assigned to but never used
</code></pre>
<p>But even <em>that</em> feels just as likely to cause confusion as it is to clarify things -- honestly, I'd be inclined to just leave F841 as it is (but add more tests for how it behaves with <code>__class__</code>, and ideally add some comments to those tests!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-08-23 18:20</div>
            <div class="timeline-body"><p>This is great!! Would you be up for trying to apply the same change to ty as well?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-08-25 13:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_semantic/src/model.rs</code>:438 on 2025-08-25 13:59</div>
            <div class="timeline-body"><p>Yeah that seems a little nicer, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-08-25 14:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:2495 on 2025-08-25 14:07</div>
            <div class="timeline-body"><p>That makes sense to me! I didn't really look closely at the <code>__getattribute__</code> stuff in the issue until you mentioned it, that does seem pretty uncommon! I can comment there after we merge this and close the issue.</p>
<p>Are there any other tests you would add, or are the ones from #19783 enough once I add some comments?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-08-25 14:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:2495 on 2025-08-25 14:16</div>
            <div class="timeline-body"><p>Those tests LGTM! We can always add some more if more issues come up in the future. The big user-facing improvement here to me is that we no longer think this is a syntax error, which it obviously would be for any non-<code>__class__</code> variable:</p>
<pre><code class="language-py">class F:
    def method(self):
        nonlocal __class__
</code></pre>
<p>To me that seems like a somewhat serious bug on <code>main</code>, because obviously syntax errors are unsuppressable!</p>
<p>And I think the fact that modelling it as a separate scope (emulating the semantics at runtime precisely) means that we can remove special-casing for <code>__class__</code> elsewhere is another great reason to make this change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-08-25 14:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:2495 on 2025-08-25 14:48</div>
            <div class="timeline-body"><p>I wrote a comment on this case to explain why we don't flag it:</p>
<pre><code class="language-py">class A:
    __class__ = 1
</code></pre>
<p>I said that it was a normal class variable, not the special <code>__class__</code> cell, but maybe that's not the case:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; class A:
...     __class__ = 1
...
&gt;&gt;&gt; A.__class__
&lt;class 'type'&gt;
</code></pre>
<p>Should we be flagging that as well? That might be moving beyond the scope of this PR, though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-08-25 14:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:2495 on 2025-08-25 14:52</div>
            <div class="timeline-body"><p>I regret to inform you that there's sometimes a ~~cursed~~ &quot;good&quot; reason to assign to <code>__class__</code> in a class body:</p>
<p>https://github.com/python/typing_extensions/blob/d372913fd71f8f01008c20276fbfe01519ddf1df/src/typing_extensions.py#L1910-L1911</p>
<p>So... no, we shouldn't be flagging that ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-08-25 14:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:2495 on 2025-08-25 14:53</div>
            <div class="timeline-body"><p>Specifically:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; class Foo:
...     __class__ = bool
...     
&gt;&gt;&gt; Foo().__class__
&lt;class 'bool'&gt;
&gt;&gt;&gt; isinstance(Foo(), bool)
True
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-08-25 14:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:2495 on 2025-08-25 14:54</div>
            <div class="timeline-body"><p>I think it's some crazy descriptor magic that means that if you access it on the class object itself, it doesn't pay attention to the value you set in the class body, but if you access it on the instance it does</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-08-25 14:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:2495 on 2025-08-25 14:55</div>
            <div class="timeline-body"><p>That's good news to me! I think this PR is good to go then :laughing: Well, maybe &quot;normal class variable&quot; isn't exactly right still...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-08-25 14:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:2495 on 2025-08-25 14:57</div>
            <div class="timeline-body"><p>I guess there's an implicit &quot;for the purposes of F841&quot; in an F841 test file, so it seems close enough.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/resources/test/fixtures/pyflakes/F841_0.py</code>:157 on 2025-08-25 16:05</div>
            <div class="timeline-body"><pre><code class="language-suggestion"># OK -- `__class__` in this case is not the special `__class__` cell,
# so we don't emit a diagnostic. (It has its own special semantics --
# see https://github.com/astral-sh/ruff/pull/20048#discussion_r2298338048 --
# but those aren't relevant here.)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/resources/test/fixtures/pyflakes/F841_0.py</code>:165 on 2025-08-25 16:06</div>
            <div class="timeline-body"><pre><code class="language-suggestion"># error, and we still emit a diagnostic. See https://github.com/astral-sh/ruff/pull/20048#discussion_r2296252395
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-08-25 16:06</div>
            <div class="timeline-body"><p>Looks great!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dscorbett">@dscorbett</a> on 2025-08-25 16:37</div>
            <div class="timeline-body"><p>This comment is not true:</p>
<pre><code># The following three cases should technically be allowed because `__class__`
# is a nonlocal variable in the method scope. However, `__class__` isn't easily
# accessible in other methods, so setting it like this is still likely to be an
# error, and we still emit a diagnostic. See https://github.com/astral-sh/ruff/pull/20048#discussion_r2296252395
class A:
    def set_class(self, cls):
        __class__ = cls
</code></pre>
<p><code>__class__</code> is a local variable there because it is assigned. It would only be nonlocal with a <code>nonlocal __class__</code> statement.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-08-25 17:08</div>
            <div class="timeline-body"><p>Ah I see, thanks. For some reason I thought this should work even without the explicit <code>nonlocal</code>, but I think this resolves my confusion. This case is now fully resolved, not triggering PLE0117 or F841:</p>
<pre><code class="language-py">class A:
    def set_class(self, cls):
        nonlocal __class__
        __class__ = cls
</code></pre>
<p>and these cases are properly flagged because the local <code>__class__</code> variable <em>is</em> unused:</p>
<pre><code class="language-py">class A:
    class B:
        def set_class(self, cls):
            __class__ = cls


class A:
    def foo():
        class B:
            print(__class__)
            def set_class(self, cls):
                __class__ = cls
</code></pre>
<p>I'll update the first test case with the actual <code>nonlocal</code> statement and also fix the comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dscorbett">@dscorbett</a> on 2025-08-25 17:34</div>
            <div class="timeline-body"><p>In the following example, <code>__class__</code> is a local variable, which breaks the zero-argument <code>super</code>.</p>
<pre><code class="language-python">class C:
    def __str__(self):
        if False:
            __class__ = C
        return super().__str__()
print(str(C()))
</code></pre>
<p>With this PR, will that be handled properly?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-25 17:39</div>
            <div class="timeline-body"><blockquote>
<p>With this PR, will that be handled properly?</p>
</blockquote>
<p>No, that issue will still be outstanding after this PR has merged. (That doesn't mean that we won't necessarily fix it in the future. But while it's a valid bug report, it's probably low priority for us to fix it since it seems unlikely that a human or LLM would ever write that in real code :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-08-25 17:43</div>
            <div class="timeline-body"><p>I think https://github.com/astral-sh/ruff/pull/19424 will still be necessary to fix that, if that's the same issue. But the local variable should shadow the nonlocal binding from the cell after this PR, so I think it makes it slightly easier to resolve the other issue too, at least.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-08-26 13:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-08-26 13:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-26 13:49</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:46:48 UTC
    </footer>
</body>
</html>
