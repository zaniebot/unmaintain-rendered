<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Do not emit `Unknown` token - astral-sh/ruff #10326</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Do not emit <code>Unknown</code> token</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10326">#10326</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-03-11 06:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-11 06:18</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR updates the <code>TokenSource</code> to not emit the <code>Unknown</code> token if there's a lexical error.</p>
<p>To understand the reasoning behind this, we'll use the following example:</p>
<pre><code class="language-python">f'hello {x!

z = 1
</code></pre>
<p>Here, the lexer will emit two errors at the <em>same</em> location as show in the following output:</p>
<pre><code>...
13 Name {
    name: &quot;z&quot;,
} 14
15 Equal 16
17 Int {
    value: 1,
} 18
18 NonLogicalNewline 19
Error: 19:19 unexpected EOF while parsing
Error: 19:19 f-string: unterminated string
19 Newline 19
</code></pre>
<ol>
<li>The parser is trying to parse a list of module statements</li>
<li>Starts parsing f-string</li>
<li>The parser is trying to parse a list of f-string elements</li>
<li>It encounters <code>z</code> after <code>!</code> which is an invalid conversion flag.</li>
<li>Exit the list parsing logic as the recovery can be handled by the outer context (module statement)</li>
<li>... <em>some more error handling</em></li>
<li>Current token is <code>Unknown</code> because of the lexical error (unexpected EOF)</li>
<li>F-string parsing logic skips this</li>
<li>Current token is <code>Unknown</code> again because of the &quot;unterminated string&quot; error</li>
<li>Both the previous and current token are the same and at the same location which means that the parser didn't progress. Panic!</li>
</ol>
<p>The parser will then emit 2 <code>Unknown</code> tokens in total for the errors. This creates a problem in the logic to make sure that the parser is progressing because the tokens are at the same location which will seem like the parser is stuck. The program then panics.</p>
<p>This token is only used as a placeholder when there's a lexical error. This means that the parser need to skip this token when <code>next_token</code> is called or it needs to be handled by the parsing logic whichever matches against the current token kind. The latter was done by the f-string parsing logic. But this seems redundant as we can just avoid emitting it which is what this PR does.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by @dhruvmanila on 2024-03-11 06:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2024-03-11 06:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-03-11 09:31</div>
            <div class="timeline-body"><p>(There was an internal discussion for keeping this the way it is for now.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-03-11 09:31</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 22:47:56 UTC
    </footer>
</body>
</html>
