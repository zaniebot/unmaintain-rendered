<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Support class-arguments for dataclass transformers - astral-sh/ruff #21457</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Support class-arguments for dataclass transformers</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21457">#21457</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-11-14 15:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-11-14 15:18</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Allow metaclass-based and baseclass-based dataclass-transformers to overwrite the default behavior using class arguments:</p>
<pre><code class="language-py">class Person(Model, order=True):
    # ...
</code></pre>
<h2>Conformance tests</h2>
<p>Four new tests passing!</p>
<h2>Test Plan</h2>
<p>New Markdown tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @sharkdp on 2025-11-14 15:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by @sharkdp on 2025-11-14 15:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-14 15:20</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<details>
<summary>Changes were detected when running ty on typing conformance tests</summary>

<pre><code class="language-diff">--- old-output.txt	2025-11-15 11:08:04.194581567 +0000
+++ new-output.txt	2025-11-15 11:08:07.641576022 +0000
@@ -273,10 +273,10 @@
 dataclasses_postinit.py:29:7: error[unresolved-attribute] Object of type `DC1` has no attribute `y`
 dataclasses_slots.py:66:1: error[unresolved-attribute] Class `DC6` has no attribute `__slots__`
 dataclasses_slots.py:69:1: error[unresolved-attribute] Object of type `DC6` has no attribute `__slots__`
+dataclasses_transform_class.py:63:1: error[invalid-assignment] Property `id` defined in `Customer1` is read-only
 dataclasses_transform_class.py:66:8: error[missing-argument] No arguments provided for required parameters `id`, `name`
 dataclasses_transform_class.py:66:18: error[too-many-positional-arguments] Too many positional arguments: expected 0, got 2
 dataclasses_transform_class.py:72:6: error[unsupported-operator] Operator `&lt;` is not supported for types `Customer1` and `Customer1`
-dataclasses_transform_class.py:78:6: error[unsupported-operator] Operator `&lt;` is not supported for types `Customer2` and `Customer2`
 dataclasses_transform_class.py:82:8: error[missing-argument] No argument provided for required parameter `id`
 dataclasses_transform_class.py:82:18: error[too-many-positional-arguments] Too many positional arguments: expected 0, got 2
 dataclasses_transform_class.py:122:1: error[invalid-assignment] Property `id` defined in `Customer3` is read-only
@@ -324,10 +324,10 @@
 dataclasses_transform_func.py:70:18: error[too-many-positional-arguments] Too many positional arguments: expected 0, got 2
 dataclasses_transform_func.py:76:36: error[invalid-return-type] Function always implicitly returns `None`, which is not assignable to return type `T@create_model_frozen`
 dataclasses_transform_func.py:96:1: error[invalid-assignment] Property `id` defined in `Customer3` is read-only
+dataclasses_transform_meta.py:63:1: error[invalid-assignment] Property `id` defined in `Customer1` is read-only
 dataclasses_transform_meta.py:66:8: error[missing-argument] No arguments provided for required parameters `id`, `name`
 dataclasses_transform_meta.py:66:18: error[too-many-positional-arguments] Too many positional arguments: expected 0, got 2
 dataclasses_transform_meta.py:73:6: error[unsupported-operator] Operator `&lt;` is not supported for types `Customer1` and `Customer1`
-dataclasses_transform_meta.py:79:6: error[unsupported-operator] Operator `&lt;` is not supported for types `Customer2` and `Customer2`
 dataclasses_transform_meta.py:83:8: error[missing-argument] No argument provided for required parameter `id`
 dataclasses_transform_meta.py:83:18: error[too-many-positional-arguments] Too many positional arguments: expected 0, got 2
 dataclasses_transform_meta.py:103:1: error[invalid-assignment] Property `id` defined in `Customer3` is read-only

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-14 15:21</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">scikit-build-core (https://github.com/scikit-build/scikit-build-core)
- src/scikit_build_core/build/wheel.py:98:20: error[no-matching-overload] No overload of bound method `__init__` matches arguments
- Found 44 diagnostics
+ Found 43 diagnostics


</code></pre>
</details>

<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-14 15:25</div>
            <div class="timeline-body"><!-- generated-comment ty ecosystem-analyzer -->

<h2><code>ecosystem-analyzer</code> results</h2>
<p>No diagnostic changes detected ✅
<strong><a href="https://david-dataclass-transformer.ecosystem-663.pages.dev/diff">Full report with detailed diff</a></strong> (<a href="https://david-dataclass-transformer.ecosystem-663.pages.dev/timing">timing results</a>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> removed by @sharkdp on 2025-11-15 11:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by @sharkdp on 2025-11-15 11:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/resources/mdtest/dataclasses/dataclass_transform.md</code>:421 on 2025-11-15 11:16</div>
            <div class="timeline-body"><p>The reason why this doesn't work is a bit tricky. For frozen models, we generate a <code>__setattr__</code> method that returns <code>Never</code>. This allows us to emit the <code>invalid-assignment</code> diagnostic. We set <code>frozen=False</code> on <code>Mutable</code>, and with this PR, this means that we do not generate a <code>__setattr__</code> method on <code>Mutable</code> <em>directly</em> anymore. But the implicit <code>__setattr__</code> call in the assignment to <code>m.name</code> below calls also looks up <code>__setattr__</code> on the meta type of <code>Mutable</code>, i.e. <code>DefaultFrozenMeta</code>. And since <code>DefaultFrozenMeta</code> has <code>frozen_default=True</code>, we <em>do</em> generate a <code>__setattr__</code> method on the meta class. This method is what causes the right behavior for the <code>Frozen</code> model. But it turns out this is not what actually happens at runtime. https://typing.python.org/en/latest/spec/dataclasses.html#dataclass-semantics describes the precise semantics for frozen dataclasses transformers. <code>DefaultFrozenMeta</code> is actually neither frozen nor non-frozen. The <code>__setattr__</code> method should instead only be generated on <code>Frozen</code> directly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-11-15 11:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-11-15 11:19</div>
            <div class="timeline-body"><blockquote>
<pre><code class="language-diff">- src/scikit_build_core/build/wheel.py:98:20: error[no-matching-overload] No overload of bound method `__init__` matches arguments
</code></pre>
</blockquote>
<p>Is this another flaky ecosystem diff? :confused: I can not reproduce this locally, neither can ecosystem-analyzer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @sharkdp on 2025-11-15 11:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2025-11-15 11:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2025-11-15 11:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @sharkdp on 2025-11-15 11:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-15 12:05</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<pre><code class="language-diff"></code></pre>
</blockquote>
<blockquote>
<ul>
<li>src/scikit_build_core/build/wheel.py:98:20: error[no-matching-overload] No overload of bound method <code>__init__</code> matches arguments</li>
</ul>
</blockquote>
<blockquote>
<pre><code></code></pre>
</blockquote>
<p>Is this another flaky ecosystem diff? :confused: I can not reproduce this locally, neither can ecosystem-analyzer.</p>
</blockquote>
<p>Yes it is. It shows up on almost every PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/dataclasses/dataclass_transform.md</code>:421 on 2025-11-15 16:22</div>
            <div class="timeline-body"><p>Should we file an issue for this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-11-15 16:30</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-11-15 16:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/resources/mdtest/dataclasses/dataclass_transform.md</code>:421 on 2025-11-15 16:47</div>
            <div class="timeline-body"><p>Added to https://github.com/astral-sh/ty/issues/1327</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2025-11-15 16:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-11-15 16:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-11-15 16:47</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:54:20 UTC
    </footer>
</body>
</html>
