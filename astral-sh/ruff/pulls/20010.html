<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-pyi`] Avoid syntax error from conflict with `PIE790` (`PYI021`) - astral-sh/ruff #20010</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-pyi</code>] Avoid syntax error from conflict with <code>PIE790</code> (<code>PYI021</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20010">#20010</a>
        opened by <a href="https://github.com/second-ed">@second-ed</a>
        on 2025-08-20 20:17
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/second-ed">@second-ed</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff/ty! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title? (Please prefix with `[ty]` for ty pull
  requests.)
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<!-- What's the purpose of the change? What does it do, and why? -->

<p>First contribution so please let me know if I've made a mistake anywhere. This was aimed to fix #19982, it adds the isolation level to PYI021 to in the same style as the PIE790 rule.</p>
<p>fixes: #19982</p>
<h2>Test Plan</h2>
<!-- How was it tested? -->

<p>I added a case to the PYI021.pyi file where the two rules are present as there wasn't a case with them both interacting, using the minimal reproducible example that @ntBre created on the issue (I think I got the <code># ERROR</code> markings wrong, so please let me know how to fix that if I did).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @second-ed on 2025-08-20 20:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-20 20:36</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-08-20 21:21</div>
            <div class="timeline-body"><p>Awesome, thanks for working on this! One note, I believe the <code># ERROR</code> comments in that file are just to make reviewing snapshots a little easier and don't actually activate the rules. The file <code>PYI021.pyi</code> is used as one of the <code>test_case</code>s in this test:</p>
<p>https://github.com/astral-sh/ruff/blob/39f7a876d6aceedc3db4e3d63250d78bbb830fc2/crates/ruff_linter/src/rules/flake8_pyi/mod.rs#L130-L139</p>
<p>so only PYI021 is active still:</p>
<p>https://github.com/astral-sh/ruff/blob/39f7a876d6aceedc3db4e3d63250d78bbb830fc2/crates/ruff_linter/src/rules/flake8_pyi/mod.rs#L39</p>
<p>I think you'll probably want to create a copy of this test function and enable both the rules. Something like this:</p>
<pre><code class="language-rust">    #[test_case(Path::new(&quot;PYI021.pyi&quot;))]
    fn pyi021_pie790_empty_function(path: &amp;Path) -&gt; Result&lt;()&gt; {
        let diagnostics = test_path(
            Path::new(&quot;flake8_pyi&quot;).join(path).as_path(),
            &amp;settings::LinterSettings::for_rules([Rule::DocstringInStub, Rule::UnnecessaryPlaceholder]),
        )?;
        assert_diagnostics!(diagnostics);
        Ok(())
    }
</code></pre>
<p>Or you could just hard-code the path in this case since I doubt we'll need multiple <code>test_case</code>s :) It might also make sense to use a separate <code>pyi</code> file from the main <code>PYI021.pyi</code> case, but I don't think that's a big deal either way, up to you.</p>
<p>I think your fix is likely still correct, but this will make sure we're testing the right thing!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ntBre on 2025-08-20 21:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/second-ed">@second-ed</a> on 2025-08-20 21:45</div>
            <div class="timeline-body"><p>Perfect, thanks for the suggestions. I'll make those changes tomorrow!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @AlexWaygood on 2025-08-21 21:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/second-ed">@second-ed</a> on 2025-08-21 21:07</div>
            <div class="timeline-body"><p>Hey, I added the changes you suggested but I wasn't getting a pass on the test locally (as it was panicking after applying both fixes), I think there's something wrong with my isolation level check in the actual implementation. I've pushed up the code so you can see, but will have a play with it after work tomorrow and try to work out the issue</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-08-21 21:20</div>
            <div class="timeline-body"><p>I'll take a look. <code>Isolation</code> may not be enough. We may need to check explicitly (in one or both rules) that we're not leaving an empty function body. That might be a good separate test to try, or check if we already have some. Do the rules individually suggest deleting the last statement in a function?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-08-21 22:36</div>
            <div class="timeline-body"><p>Ah sorry, this might actually be trickier than I expected. PYI021 only looks at the deferred definitions after the AST has been traversed, so <code>checker.semantic().current_statement_id()</code> is returning <code>None</code>. That explains why <code>Isolation</code> isn't working. But both rules try to check that they aren't deleting the last statement in a definition, so <code>Isolation</code> also still seems like the right fix. I'm just not seeing a way to get a real <code>NodeId</code> to pass to <code>Checker::isolation</code> from a <code>Definition</code> or docstring literal.</p>
<p>We may have to move PYI021's check into the same phase of analysis as PIE790, which would be a bit more involved.</p>
<p>https://github.com/astral-sh/ruff/blob/a50b389d626528d55c22979dac50c48387a5e1e0/crates/ruff_linter/src/checkers/ast/analyze/suite.rs#L8-L12</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @second-ed on 2025-08-22 18:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/second-ed">@second-ed</a> on 2025-08-22 18:29</div>
            <div class="timeline-body"><p>Hey, having a look through now, will give my best guess but I'm sure you'll have a better idea! I'll commit as far as I get</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/second-ed">@second-ed</a> on 2025-08-22 19:16</div>
            <div class="timeline-body"><p>My initial plan is:
add both rules to a <code>IsolationLevel::Group</code> then look instead of getting the <code>current_statement_id</code> get something like the <code>current_scope</code> or something like that, does that sound reasonable?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @second-ed on 2025-08-23 08:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[ruff] #19982 add isolation rule for PYI021" to "[`flake8-pyi`] add isolation level for interaction between rules #19982 (PYI021)" by @second-ed on 2025-08-24 12:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-08-26 19:16</div>
            <div class="timeline-body"><p>Sorry, I don't mean to leave you hanging on this, I'm just not quite sure the best approach yet either. I don't think I mentioned this above, but I even tried something like this method added to our <code>SemanticModel</code>:</p>
<pre><code class="language-rust">    pub fn statement_id(&amp;self, stmt: &amp;ast::Stmt) -&gt; Option&lt;NodeId&gt; {
        self.nodes.iter().find(|node| self.statement(*node) == stmt)
    }
</code></pre>
<p>without much luck. Basically your idea sounds right to me, and is what I expected the fix to be too, but I'm not sure if it works with the way we're traversing the AST or calling this rule.</p>
<p>Don't feel any pressure to keep working on this, I'll try to take another look at some point too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/second-ed">@second-ed</a> on 2025-08-26 20:12</div>
            <div class="timeline-body"><p>Hey no worries - I can see you're pretty busy on a load of other PRs!</p>
<p>I'm happy to keep tweaking and chipping away at ideas, it's a good opportunity for me to get familiar with more of the codebase.</p>
<p>Out of interest what <code>Stmt</code> are you passing into this method?</p>
<pre><code class="language-rust">    pub fn statement_id(&amp;self, stmt: &amp;ast::Stmt) -&gt; Option&lt;NodeId&gt; {
        self.nodes.iter().find(|node| self.statement(*node) == stmt)
    }
</code></pre>
<p>Maybe passing the statement that holds the ellipsis expression could work?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/second-ed">@second-ed</a> on 2025-09-03 20:16</div>
            <div class="timeline-body"><p>I've had a play, I added the method you shared. After running <code>dbg!</code> on all of the statements in the <code>docstring_in_stubs</code>, they all seem to be returning None.</p>
<p>The fact that the <code>self.node_id</code> is None makes me agree with you that we should move the rule itself to the same point where the other rule is triggered, but that causes issues in that the function signature will need to change because the function that calls <code>unnecessary_placeholder</code> uses <code>suite: &amp;[Stmt]</code> whereas the other one uses <code>definition: &amp;Definition</code></p>
<p>I think that the self.node_id is always None because it's being called after the ast has finished traversing?</p>
<pre><code class="language-rust">[crates/ruff_python_semantic/src/model.rs:1414:9] &amp;self.node_id = None
[crates/ruff_linter/src/rules/flake8_pyi/rules/docstring_in_stubs.rs:65:5] checker.semantic().statement_id(&amp;statements[0]) = None
[crates/ruff_python_semantic/src/model.rs:1414:9] &amp;self.node_id = None
[crates/ruff_linter/src/rules/flake8_pyi/rules/docstring_in_stubs.rs:66:5] checker.semantic().statement_id(&amp;statements[1]) = None
[crates/ruff_python_semantic/src/model.rs:1414:9] &amp;self.node_id = None
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-09-03 20:49</div>
            <div class="timeline-body"><p>That all sounds right to me. I think the best course of action is to move it to the earlier analysis phase, while we're still traversing the AST, like <code>PIE790</code>. I was quite hesitant to do that earlier, but I think it won't be too bad after looking again today. We should still be able to call <code>docstring_from</code> on just a <code>&amp;[Stmt]</code>, which we have access to in that phase:</p>
<p>https://github.com/astral-sh/ruff/blob/bbfcf6e111648052783bdb68ec71706fc69b714f/crates/ruff_linter/src/docstrings/extraction.rs#L6-L8</p>
<p>and the only reason we pass a <code>Definition</code> to <code>PYI021</code> is also to extract its <code>&amp;[Stmt]</code>.</p>
<p>So this rule actually seems to fit nicely into <code>analyze::suite</code> next to <code>PIE790</code>:</p>
<p>https://github.com/astral-sh/ruff/blob/bbfcf6e111648052783bdb68ec71706fc69b714f/crates/ruff_linter/src/checkers/ast/analyze/suite.rs#L9-L12</p>
<p>unless there's some additional subtlety I'm missing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/second-ed">@second-ed</a> on 2025-09-03 21:14</div>
            <div class="timeline-body"><p>Awesome sounds good, cheers for the hint I'll give it a go!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/second-ed">@second-ed</a> on 2025-09-04 17:42</div>
            <div class="timeline-body"><p>I think I've got it there now, all tests pass without any hardcoding.</p>
<p>I moved <code>in_protocol_or_abstract_method</code> to the semantic model itself because I thought I might need to check it in PYI021 but didn't need it in the end so can move it back if you want although I think it makes more sense as a method than a free function</p>
<p>I know you're busy so no rush to review, but let me know what you think</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/second-ed">@second-ed</a> on 2025-09-08 17:39</div>
            <div class="timeline-body"><p>Hey @ntBre just realised I forgot to tag you in my last message, just to let you know I think this one is ready for review whenever you get a chance, cheers!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/second-ed">@second-ed</a> on 2025-09-08 19:01</div>
            <div class="timeline-body"><p>Sorry! forgot to update the snapshot tests, will do now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/second-ed">@second-ed</a> on 2025-09-08 19:57</div>
            <div class="timeline-body"><p>Hmmm I'm not getting the same fail when I run the tests locally I've run the following commands:</p>
<pre><code class="language-shell">cargo insta test --review
</code></pre>
<p>and this which I copied from the git action</p>
<pre><code class="language-shell">cargo insta test --all-features --unreferenced reject --test-runner nextest
</code></pre>
<p>the tests all pass when I run the code locally, not sure if I've missed something ðŸ¤”</p>
<p>no rush at all @ntBre , but please let me know if theres something I've overlooked! cheers</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-09-08 20:10</div>
            <div class="timeline-body"><p>You may need to rebase/merge main and then accept the snapshots again. It looks like an artifact from our recent diagnostic refactor, which changed the output format a bit.</p>
<p>(Sorry for the delayed review. The code changes look good from a quick skim, just trying to finish the 0.13 release before doing a proper review)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @second-ed on 2025-09-09 16:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @second-ed on 2025-09-09 16:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @second-ed on 2025-09-09 16:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @second-ed on 2025-09-09 16:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @second-ed on 2025-09-09 16:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/second-ed">@second-ed</a> on 2025-09-09 17:39</div>
            <div class="timeline-body"><p>Might be a good candidate to squash when merging ðŸ˜… sorry!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-09-09 17:49</div>
            <div class="timeline-body"><p>No worries, we always squash merge! It does look like something went slightly awry with the merge. At least on GitHub, it's showing 201 commits. I think it should still be okay, though. Only the relevant changes are showing up.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @ntBre on 2025-09-09 17:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @ntBre on 2025-09-09 17:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dcreager removed by @ntBre on 2025-09-09 17:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @MichaReiser removed by @ntBre on 2025-09-09 17:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dhruvmanila removed by @ntBre on 2025-09-09 17:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @ntBre on 2025-09-09 17:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/second-ed">@second-ed</a> on 2025-09-09 18:06</div>
            <div class="timeline-body"><p>Yeah sorry, I think I botched the rebase (thats what I get for rebasing when I'm firmly in camp merge!). I had a look at the changes too and they only are the ones I introduced so should be ok ðŸ¤ž</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_semantic/src/model.rs</code>:1411 on 2025-09-23 21:25</div>
            <div class="timeline-body"><p>Is this called anywhere now? I think we can revert this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_python_semantic/src/model.rs</code>:1671 on 2025-09-23 21:26</div>
            <div class="timeline-body"><p>I'd probably lean toward leaving this in the same file as before, unless there's a specific reason to move it out.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_pyi/PYI021_1.pyi</code>:2 on 2025-09-23 21:30</div>
            <div class="timeline-body"><p>This docstring seems slightly misleading since the snapshot shows it trying to fix both diagnostics ðŸ˜„</p>
<p>In testing this locally in the CLI, the net effect is that we still emit both diagnostics when checking, but the isolation level means only the first diagnostic actually gets fixed. Since we sort by diagnostic range, that means PYI021 gets fixed and PIE790 does not. You don't need to write all of that in the docstring, to be clear, just recording my observations!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/checkers/ast/analyze/suite.rs</code>:13 on 2025-09-23 22:00</div>
            <div class="timeline-body"><p>One thing I didn't realize about moving this here is that it now gets called for non-function (or -class or -module) suites, such as context managers or <code>if</code> statements:</p>
<pre><code class="language-py">with foo():
    &quot;&quot;&quot;docstring&quot;&quot;&quot;
    pass

if True:
    &quot;&quot;&quot;docstring&quot;&quot;&quot;
    pass
</code></pre>
<p>I tested these locally, and we flag both of these. Fortunately, it looks like we already track a <a href="https://github.com/astral-sh/ruff/blob/main/crates/ruff_linter/src/checkers/ast/mod.rs#L235"><code>docstring_state</code></a> field on <code>Checker</code>. We'd have to add a <code>pub(crate)</code> getter function for this and make the <code>DocstringState</code> and <code>ExpectedDocstringKind</code> enums <code>pub(crate)</code> too, but I think we can use that to check that we're in an actual docstring.</p>
<p>There's an existing <a href="https://github.com/astral-sh/ruff/blob/main/crates/ruff_python_semantic/src/model.rs#L1997"><code>SemanticModel::in_pep_257_docstring</code></a> method, but unfortunately that flag only gets set on the <code>SemanticModel</code> once we're actually visiting the docstring.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-09-23 22:06</div>
            <div class="timeline-body"><p>Thank you! This looks great overall, I just had a couple of nits and one slightly larger issue with the <code>suite</code> handling. But even the fix for that shouldn't be too bad.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/second-ed">@second-ed</a> reviewed on 2025-09-24 20:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/second-ed">@second-ed</a> on <code>crates/ruff_linter/src/checkers/ast/analyze/suite.rs</code>:13 on 2025-09-24 20:16</div>
            <div class="timeline-body"><p>Hey thanks for this, I think I've addressed all of the comments from the review, please let me know if I've missed anything!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-09-24 21:22</div>
            <div class="timeline-body"><p>Thank you, this is great!</p>
<p>I pushed one small commit fixing a few nits:</p>
<ul>
<li>revert changes to <code>unnecessary_placeholder.rs</code></li>
<li><code>current_docstring_state</code> -&gt; <code>docstring_state</code></li>
<li>exclude <code>ExpectedDocstringKind::Attribute</code></li>
</ul>
<p>The last one was probably the biggest, but I also think it wasn't possible to reach based on how we're calling <code>analyze::suite</code>. It just seemed better to be explicit in case that changed in the future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`flake8-pyi`] add isolation level for interaction between rules #19982 (PYI021)" to "[`flake8-pyi`] Avoid syntax error from conflict with `PIE790` (`PYI021`)" by @ntBre on 2025-09-24 21:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-09-24 21:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-09-24 21:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/second-ed">@second-ed</a> on 2025-09-24 21:52</div>
            <div class="timeline-body"><p>Awesome, nice one - I didn't realise that we didn't have to worry about docstring_state clashing being both an attribute and a method of the struct that's good to know. Yeah checking explicitly for the expected docstring kind makes sense too, I'll have a closer read of the changes you made to see if there are any tricks to steal!</p>
<p>Cheers for your help and guidance on this PR btw, I'll keep an eye out for any others that I think are my level of difficulty!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:15:12 UTC
    </footer>
</body>
</html>
