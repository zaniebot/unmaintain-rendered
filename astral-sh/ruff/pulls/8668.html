<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add autofix for PIE800 - astral-sh/ruff #8668</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add autofix for PIE800</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/8668">#8668</a>
        opened by <a href="https://github.com/alanhdu">@alanhdu</a>
        on 2023-11-14 04:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/alanhdu">@alanhdu</a> on 2023-11-14 04:10</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This adds an autofix for PIE800 (unnecessary spread) -- whenever we see a <code>**{...}</code> inside another dictionary literal, just delete the <code>**{</code> and <code>}</code> to inline the key-value pairs. So <code>{&quot;a&quot;: &quot;b&quot;, **{&quot;c&quot;: &quot;d&quot;}}</code> becomes just <code>{&quot;a&quot;: &quot;b&quot;, &quot;c&quot;: &quot;d&quot;}</code>.</p>
<p>I have enabled this just for preview mode.</p>
<h2>Test Plan</h2>
<p>Updated the preview snapshot test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/alanhdu">@alanhdu</a> on <code>crates/ruff_linter/src/rules/flake8_pie/rules/unnecessary_spread.rs</code>:58 on 2023-11-14 04:11</div>
            <div class="timeline-body"><p>I wasn't sure if there was a better way to do this -- the <code>key</code> is just <code>None</code>, and AFAICT nothing in the AST actually records the location of the <code>**</code>, so doing this <code>rfind</code> is the best way I could think of (at least w/o changing the AST).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/alanhdu">@alanhdu</a> on <code>crates/ruff_linter/src/rules/flake8_pie/snapshots/ruff_linter__rules__flake8_pie__tests__preview__PIE800_PIE800.py.snap</code>:82 on 2023-11-14 04:12</div>
            <div class="timeline-body"><p>Is there a requirement that the output be formatted nicely? The edit here is syntactically valid, but the formatting is going to be quite off after the fix if there are multiple indented keys.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/alanhdu">@alanhdu</a> reviewed on 2023-11-14 04:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-11-14 04:22</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+0 -0 violations, +6 -0 fixes in 41 projects)</p>
<details><summary><a href="https://github.com/apache/airflow">apache/airflow</a> (+0 -0 violations, +6 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --select ALL --preview</pre>
</p>
<p>

<pre>
- <a href='https://github.com/apache/airflow/blob/946e1e0c4e078aec6d76c708d578af053fdd62b6/tests/providers/common/sql/operators/test_sql_execute.py#L358'>tests/providers/common/sql/operators/test_sql_execute.py:358:49:</a> PIE800 Unnecessary spread `**`
+ <a href='https://github.com/apache/airflow/blob/946e1e0c4e078aec6d76c708d578af053fdd62b6/tests/providers/common/sql/operators/test_sql_execute.py#L358'>tests/providers/common/sql/operators/test_sql_execute.py:358:49:</a> PIE800 [*] Unnecessary spread `**`
- <a href='https://github.com/apache/airflow/blob/946e1e0c4e078aec6d76c708d578af053fdd62b6/tests/providers/docker/hooks/test_docker.py#L215'>tests/providers/docker/hooks/test_docker.py:215:29:</a> PIE800 Unnecessary spread `**`
+ <a href='https://github.com/apache/airflow/blob/946e1e0c4e078aec6d76c708d578af053fdd62b6/tests/providers/docker/hooks/test_docker.py#L215'>tests/providers/docker/hooks/test_docker.py:215:29:</a> PIE800 [*] Unnecessary spread `**`
- <a href='https://github.com/apache/airflow/blob/946e1e0c4e078aec6d76c708d578af053fdd62b6/tests/providers/docker/hooks/test_docker.py#L221'>tests/providers/docker/hooks/test_docker.py:221:29:</a> PIE800 Unnecessary spread `**`
+ <a href='https://github.com/apache/airflow/blob/946e1e0c4e078aec6d76c708d578af053fdd62b6/tests/providers/docker/hooks/test_docker.py#L221'>tests/providers/docker/hooks/test_docker.py:221:29:</a> PIE800 [*] Unnecessary spread `**`
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PIE800 | 6 | 0 | 0 | 6 | 0 |</p>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-14 04:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/flake8_pie/rules/unnecessary_spread.rs</code>:58 on 2023-11-14 04:27</div>
            <div class="timeline-body"><p>You could use our <code>SimpleTokenizer</code>, which is basically a stripped-down, zero-allocation lexer that's useful in cases like this. If you grep for <code>SimpleTokenizer::starts_at</code>, you can find some examples.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-14 04:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/flake8_pie/snapshots/ruff_linter__rules__flake8_pie__tests__preview__PIE800_PIE800.py.snap</code>:82 on 2023-11-14 04:32</div>
            <div class="timeline-body"><p>It's generally seen as &quot;best effort&quot; but not required.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-14 18:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/flake8_pie/rules/unnecessary_spread.rs</code>:57 on 2023-11-14 18:19</div>
            <div class="timeline-body"><p>Is there any way to restructure this to use <code>SimpleTokenizer</code>, i.e., forwards lexing? We've considered removing the backwards lexer in the past since it's quite complex, so I'd prefer to minimize usages if possible.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/alanhdu">@alanhdu</a> on <code>crates/ruff_linter/src/rules/flake8_pie/rules/unnecessary_spread.rs</code>:57 on 2023-11-14 18:57</div>
            <div class="timeline-body"><p>Yeah, I think that should be possible:</p>
<ul>
<li>For deleting <code>**{</code>, I can lex forward from the end of the previous value in the outer dictionary.</li>
<li>For deleting the last <code>}</code>, I can lex forward from the last value of the inner dictionary.</li>
</ul>
<p>I might have to change the function signature to passi n the whole dict (and not just the keys + values) to handle the case where <code>{**{&quot;a&quot;: &quot;b&quot;}}</code> case where there's no previous value (in which case I'd lex forward from the dict start).</p>
<p>(might not get to this until tomorrow though).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/alanhdu">@alanhdu</a> reviewed on 2023-11-14 18:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/alanhdu">@alanhdu</a> reviewed on 2023-11-15 04:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/alanhdu">@alanhdu</a> on <code>crates/ruff_linter/src/rules/flake8_pie/rules/unnecessary_spread.rs</code>:57 on 2023-11-15 04:03</div>
            <div class="timeline-body"><p>Ok -- I think this should work.</p>
<p>I ended up leaving the formatting fairly ugly -- the more I tried to make it look nice, the less confident I became that I handled all the edge-cases correctly (e.g. handling comments correctly, avoiding double commas, getting the indentation right, etc) so I ended up going for something simple and just letting an autoformatter figure it out afterwards.</p>
<p>I might try and take another crack at having the fix provide better formatted code later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-11-15 18:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-15 18:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/flake8_pie/rules/unnecessary_spread.rs</code>:57 on 2023-11-15 18:05</div>
            <div class="timeline-body"><p>Thanks for doing a second pass here!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">autofix</span> added by @charliermarsh on 2023-11-15 18:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @charliermarsh on 2023-11-15 18:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-11-15 18:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-11-15 18:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-11-16 02:33</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 02:13:19 UTC
    </footer>
</body>
</html>
