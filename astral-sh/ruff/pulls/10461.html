<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-pytest-style`] Add automatic fix for `pytest-parametrize-values-wrong-type` (`PT007`) - astral-sh/ruff #10461</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-pytest-style</code>] Add automatic fix for <code>pytest-parametrize-values-wrong-type</code> (<code>PT007</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10461">#10461</a>
        opened by <a href="https://github.com/autinerd">@autinerd</a>
        on 2024-03-18 17:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/autinerd">@autinerd</a> on 2024-03-18 17:58</div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>This adds automatic fixes for the <code>PT007</code> rule.</p>
<p>I am currently reviewing and adding Ruff rules to Home Assistant. One rule is PT007, which has multiple hundred occurrences in the codebase, but no automatic fix, and this is not fun to do manually, especially because using Regexes are not really possible with this.</p>
<p>My knowledge of the Ruff codebase and Rust in general is not good and this is my first PR here, so I hope it is not too bad.</p>
<p>One thing where I need help is: How can I have the transformed code to be formatted automatically, instead of it being minimized as it does it now?</p>
<h2>Test Plan</h2>
<p>Using the existing fixtures and updated snapshots.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @charliermarsh on 2024-03-18 18:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @charliermarsh on 2024-03-18 18:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-18 18:08</div>
            <div class="timeline-body"><p>Thanks for this!</p>
<blockquote>
<p>One thing where I need help is: How can I have the transformed code to be formatted automatically, instead of it being minimized as it does it now?</p>
</blockquote>
<p>So, if you want to do this, you can't use <code>generator</code>. The generator is just a basic printer that takes an AST and prints it without formatting. If you want to preserve the existing formatting (including comments), you need to implement a more manual fix (e.g., change the <code>[</code> to <code>(</code> and the <code>]</code> to <code>)</code>, or similar). Check out <code>unnecessary_generator_set</code> for an example of what that might look like.</p>
<p>I'm fine to merge with the generator-based fix, though a locator-based fix tends to preserve more of this kind of trivia. Are you interested in trying it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/autinerd">@autinerd</a> on 2024-03-18 18:15</div>
            <div class="timeline-body"><p>Oh yes, I see it now that this approach deletes all comments. Thanks for pointing me to a place to check, I will try if I can do this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-18 18:15</div>
            <div class="timeline-body"><p>Yeah it's kind of a tradeoff. The generator is much easier (to program, and to get right), but much lower-fidelity.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-03-18 18:16</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/autinerd">@autinerd</a> on 2024-03-18 18:59</div>
            <div class="timeline-body"><p>So, I have it now as a locator-based fix based of <code>unnecessary_generator_set</code>, thanks!</p>
<p>It also checks if a list has only 1 element and transforms <code>[&quot;test&quot;]</code> into <code>(&quot;test&quot;,)</code> to make it a valid tuple.</p>
<p>The only thing is that <code>(&quot;test&quot;,)</code> will be converted into <code>[&quot;test&quot;,]</code>, which is valid from the syntax, but of course not the most beautiful.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/autinerd">@autinerd</a> on 2024-03-18 19:06</div>
            <div class="timeline-body"><p>And I have it now as a unsafe fix, but I think it should be safe to use in this approach.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/autinerd">@autinerd</a> on 2024-03-18 19:12</div>
            <div class="timeline-body"><p>Oh, ruff-format seems to transform <code>[&quot;test&quot;,]</code> unconditionally into</p>
<pre><code>[
    &quot;test&quot;,
]
</code></pre>
<p>Then maybe I need to remove the comma, because this disrupts the source formatting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-18 19:13</div>
            <div class="timeline-body"><p>You could, e.g., <em>only</em> remove the trailing comma if it immediately precedes the closing brace.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/autinerd">@autinerd</a> on 2024-03-18 19:29</div>
            <div class="timeline-body"><p>~I'm sorry, but can you maybe hint me on how to access the text of the <code>Expr</code> to that I can check on whether it ends with <code>,)</code>?~</p>
<p>Ah, I'm blind, I see it now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/autinerd">@autinerd</a> on 2024-03-18 20:06</div>
            <div class="timeline-body"><p>It doesn't look very elegant in my opinion, but it works.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-18 20:07</div>
            <div class="timeline-body"><p>Thanks! I'll take a look now. I may tweak the locator usage a bit but it's generally what I was suggesting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-03-18 20:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-18 20:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_pytest_style/PT007.py</code>:82 on 2024-03-18 20:21</div>
            <div class="timeline-body"><p>Just one bugfix: the PR was adding a trailing comma here, which led to <code>,,</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Add automatic fixes for PT007" to "[`flake8-pytest-style`] Add automatic fix for `pytest-parametrize-values-wrong-type` (`PT007`)" by @charliermarsh on 2024-03-18 20:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-03-18 20:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-03-18 20:28</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 22:48:01 UTC
    </footer>
</body>
</html>
