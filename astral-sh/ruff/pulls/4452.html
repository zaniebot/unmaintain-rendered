<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avoid emitting empty logical lines - astral-sh/ruff #4452</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Avoid emitting empty logical lines</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4452">#4452</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-05-16 15:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>The changes to the lexer reflected in #4444 cause us to now encounter empty lines in the token stream, which we're now emitting as logical lines. Pycodestyle skips these entirely, and tracks the &quot;number of blank lines&quot; separately. This PR mimics that behavior, skipping empty lines.</p>
<p>(We may want to make this a flag on <code>LogicalLine</code>, but this seems fine for now.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-16 15:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/resources/test/fixtures/pycodestyle/E11.py</code>:66 on 2023-05-16 15:25</div>
            <div class="timeline-body"><p>We flag this as E112 (expected an indented block), but pycodestyle does not.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-05-16 15:31</div>
            <div class="timeline-body"><p>One bug, fixing...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-05-16 15:34</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>✅ ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     18.0±0.43ms     2.3 MB/sec    1.00     18.0±0.32ms     2.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.02      4.3±0.35ms     3.8 MB/sec    1.00      4.3±0.08ms     3.9 MB/sec
linter/all-rules/numpy/globals.py          1.01   545.5±16.71µs     5.4 MB/sec    1.00   539.9±11.06µs     5.5 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.4±0.16ms     3.5 MB/sec    1.00      7.4±0.15ms     3.5 MB/sec
linter/default-rules/large/dataset.py      1.00      8.4±0.13ms     4.8 MB/sec    1.00      8.4±0.09ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1790.5±37.14µs     9.3 MB/sec    1.01  1804.6±30.76µs     9.2 MB/sec
linter/default-rules/numpy/globals.py      1.01    216.5±8.36µs    13.6 MB/sec    1.00    215.2±6.13µs    13.7 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.8±0.10ms     6.7 MB/sec    1.00      3.8±0.06ms     6.7 MB/sec
parser/large/dataset.py                    1.00      6.7±0.10ms     6.1 MB/sec    1.00      6.7±0.18ms     6.1 MB/sec
parser/numpy/ctypeslib.py                  1.01  1326.9±27.51µs    12.5 MB/sec    1.00  1313.8±25.64µs    12.7 MB/sec
parser/numpy/globals.py                    1.01    134.5±4.37µs    21.9 MB/sec    1.00    132.9±3.93µs    22.2 MB/sec
parser/pydantic/types.py                   1.01      2.9±0.08ms     8.8 MB/sec    1.00      2.9±0.06ms     8.9 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     20.8±1.42ms  2006.2 KB/sec    1.10     22.8±1.31ms  1824.3 KB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      5.5±0.38ms     3.0 MB/sec    1.00      5.5±0.54ms     3.0 MB/sec
linter/all-rules/numpy/globals.py          1.02   633.1±44.41µs     4.7 MB/sec    1.00   617.7±60.73µs     4.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      9.0±0.51ms     2.8 MB/sec    1.02      9.2±0.56ms     2.8 MB/sec
linter/default-rules/large/dataset.py      1.03     10.6±0.60ms     3.9 MB/sec    1.00     10.3±0.51ms     4.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.02      2.3±0.10ms     7.3 MB/sec    1.00      2.2±0.14ms     7.5 MB/sec
linter/default-rules/numpy/globals.py      1.01   272.1±18.71µs    10.8 MB/sec    1.00   269.5±25.97µs    10.9 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.9±0.31ms     5.2 MB/sec    1.04      5.1±0.45ms     5.0 MB/sec
parser/large/dataset.py                    1.00      8.6±0.38ms     4.7 MB/sec    1.03      8.9±0.45ms     4.6 MB/sec
parser/numpy/ctypeslib.py                  1.00  1610.0±93.40µs    10.3 MB/sec    1.08  1737.5±91.22µs     9.6 MB/sec
parser/numpy/globals.py                    1.00   168.3±12.31µs    17.5 MB/sec    1.06   179.1±12.05µs    16.5 MB/sec
parser/pydantic/types.py                   1.00      3.6±0.17ms     7.0 MB/sec    1.05      3.8±0.20ms     6.6 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/pycodestyle/rules/logical_lines/mod.rs</code>:106 on 2023-05-16 15:41</div>
            <div class="timeline-body"><pre><code class="language-suggestion">                TokenKind::NonLogicalNewline if parens == 0 &amp;&amp; non_empty =&gt; { 
              		builder.finish_line();
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-16 15:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/checkers/logical_lines.rs</code>:267 on 2023-05-16 15:50</div>
            <div class="timeline-body"><p>Nit: Can we split this into its own test. Giving tests an explicit name help future us because it gives another hint on what the test is asserting and also allows to run the test on its own.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-16 15:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/pycodestyle/rules/logical_lines/mod.rs</code>:106 on 2023-05-16 15:57</div>
            <div class="timeline-body"><p>Moved the checks into the builder instead, which is necessary to handle <code>builder.finish()</code> properly (which calls <code>.finish_line()</code> internally).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/pycodestyle/rules/logical_lines/mod.rs</code>:461 on 2023-05-16 15:59</div>
            <div class="timeline-body"><p>Do you think it would work if we instead test inside of <code>finish_line</code> if all <code>tokens</code> are <code>NonLogicalNewLine</code>? That would have the benefit that it only runs once per line, doesn't require more state, and doesn't introduce more branching in this hot path (at the cost that, in the worst case, we have to iterate over all line tokens). We could optimize this further by providing a <code>finish_non_logical_line</code> and only add the check there (calls into the <code>finish_line</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-05-16 15:59</div>
            <div class="timeline-body"><p>Looks good. I only have some nits</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/checkers/logical_lines.rs</code>:267 on 2023-05-16 16:28</div>
            <div class="timeline-body"><p>Gonna do this as its own PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-05-16 16:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-05-16 16:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-05-16 16:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-05-16 16:33</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:57:26 UTC
    </footer>
</body>
</html>
