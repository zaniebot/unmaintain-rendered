<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report diagnostics for invalid/unmatched range suppression comments - astral-sh/ruff #21908</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Report diagnostics for invalid/unmatched range suppression comments</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21908">#21908</a>
        opened by <a href="https://github.com/amyreese">@amyreese</a>
        on 2025-12-10 23:21
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<ul>
<li>Adds new RUF103 and RUF104 diagnostics for invalid and unmatched suppression comments</li>
<li>Reports RUF104 diagnostics for any unmatched suppression comment</li>
</ul>
<h2>Test Plan</h2>
<p>Updated snapshots from test cases with unmatched suppression comments</p>
<p>Issue #3711
Fixes #21878
Fixes #21875</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-10 23:30</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Report diagnostics for unmatched range suppression comments" to "Report diagnostics for invalid/unmatched range suppression comments" by @amyreese on 2025-12-11 01:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-11 08:40</div>
            <div class="timeline-body"><p>Uff, <code>ruff: isort</code> ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @amyreese on 2025-12-12 01:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @amyreese on 2025-12-12 01:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @amyreese on 2025-12-12 01:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @MichaReiser on 2025-12-12 09:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @MichaReiser on 2025-12-12 09:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/suppressions.py</code>:94 on 2025-12-12 09:01</div>
            <div class="timeline-body"><p>Can you add a test that verifies we don't flag rules defined using <a href="https://docs.astral.sh/ruff/settings/#lint_external"><code>external</code></a> (might have to be a CLI test)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/invalid_suppression_comment.rs</code>:30 on 2025-12-12 09:03</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    pub(crate) kind: InvalidSuppressionCommentKind,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/rules/unmatched_suppression_comment.rs</code>:16 on 2025-12-12 09:05</div>
            <div class="timeline-body"><p>I suggest adding a few statements so that you can place the <code>ruff: enable</code> comment before the end of the block (which is sort of the main reason for the rule)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/snapshots/ruff_linter__rules__ruff__tests__range_suppressions.snap</code>:264 on 2025-12-12 09:07</div>
            <div class="timeline-body"><p>Maybe something like: Suppression comment without matching <code>ruff: enable</code> comment</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/snapshots/ruff_linter__rules__ruff__tests__range_suppressions.snap</code>:299 on 2025-12-12 09:10</div>
            <div class="timeline-body"><p>We actually do the opposite in ty:</p>
<ul>
<li>We highlight the entire comment if all codes are unused (and the message is: <em>unused ignore comment</em>)</li>
<li>We highlight the unused codes if not all of them are unused</li>
</ul>
<p>This has the advantage that IDEs render the entire comment or just the unused codes as &quot;unnecessary&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/snapshots/ruff_linter__rules__ruff__tests__range_suppressions.snap</code>:314 on 2025-12-12 09:11</div>
            <div class="timeline-body"><p>I didn't notice this when reviewing your previous PR.</p>
<p>I think we should create a single diagnostic for a single <code>disable/enable</code> pair. It''s okay to address this in a separate PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/suppression.rs</code>:266 on 2025-12-12 09:15</div>
            <div class="timeline-body"><p>I'm not sure we should offer a fix for invalid suppression comments. At least not a safe fix. We don't really know what the user wants to do in this case. Fix the comment? Remove it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/suppression.rs</code>:235 on 2025-12-12 09:16</div>
            <div class="timeline-body"><p>Does <code>noqa</code> offer a fix if the rule code is invalid? Removing is one possible solution but the user might also have misspelled the rule name and the proper fix is to fix the rule name instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/suppression.rs</code>:276 on 2025-12-12 09:18</div>
            <div class="timeline-body"><p>I think this is another case where I'd prefer to have dedicated <code>enable</code> and <code>disable</code> fields on <code>Suppression</code>. It would remove the need for code like this to &quot;poke&quot; into the internals.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/suppression.rs</code>:271 on 2025-12-12 09:25</div>
            <div class="timeline-body"><p>We should probably avoid flagging valid comments with invalid rule names. It might be best to unify the two checks into a single loop (and add a test)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/snapshots/ruff_linter__rules__ruff__tests__range_suppressions.snap</code>:597 on 2025-12-12 09:26</div>
            <div class="timeline-body"><p>The message here needs updating (it mentions <code>noqa</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-12-12 09:26</div>
            <div class="timeline-body"><p>Overall this looks good. A few more smaller suggestions</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/invalid_suppression_comment.rs</code>:28 on 2025-12-12 19:37</div>
            <div class="timeline-body"><p>We'll have to bump these after the release this week.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/invalid_suppression_comment.rs</code>:24 on 2025-12-12 19:39</div>
            <div class="timeline-body"><p>It might be worth linking to the related rules like the other one in this PR and RUF100. Sometimes we have a <code>## See also</code> section for this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/suppression.rs</code>:199 on 2025-12-12 19:46</div>
            <div class="timeline-body"><p>nit: I often avoid the binding if I can:</p>
<pre><code class="language-suggestion">                    context.report_diagnostic(
                        UnusedNOQA {
                            codes: Some(codes),
                            kind: UnusedNOQAKind::Suppression,
                        },
                        range,
                    ).set_fix(Fix::safe_edit(edit));
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/suppression.rs</code>:279 on 2025-12-12 19:53</div>
            <div class="timeline-body"><p>This probably doesn't help much since I think it collects something internally, but if this is just for getting the unique values, you can use the <a href="https://docs.rs/itertools/latest/itertools/trait.Itertools.html#method.unique">unique</a> adaptor from itertools.</p>
<p>(mostly an excuse to show you itertools, if you haven't seen it yet)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-12-12 19:58</div>
            <div class="timeline-body"><p>Nice! Just a couple of small things from me beyond Micha's comments.</p>
<p>This is a bit off topic, and I'm not sure if y'all have discussed this (or already implemented it?), but I was thinking it would be nice to have a code action to wrap the selected region with these comments, like we have for adding a noqa comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-12 20:06</div>
            <div class="timeline-body"><blockquote>
<p>This is a bit off topic, and I'm not sure if y'all have discussed this (or already implemented it?), but I was thinking it would be nice to have a code action to wrap the selected region with these comments, like we have for adding a noqa comment.</p>
</blockquote>
<p>I think this is trickier because the main use case is to suppress multiple statements. It still recommended to use noqa for local suppressions.</p>
<p>Showing too many code actions is also noisy, which is why I wouldn't implement this for now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> reviewed on 2025-12-16 23:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/suppressions.py</code>:94 on 2025-12-16 23:09</div>
            <div class="timeline-body"><p>Should we consider external rule codes &quot;valid&quot; outside of a <code>#noqa</code> context? Ie, do we actually expect external tools/linters to support <code>#ruff:disable</code> style suppressions?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> reviewed on 2025-12-16 23:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/suppression.rs</code>:235 on 2025-12-16 23:37</div>
            <div class="timeline-body"><p>Yes, the noqa implementation does a range deletion of either the entire comment or the individual invalid code, and also marks those as safe edits.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> reviewed on 2025-12-17 02:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/rules/ruff/snapshots/ruff_linter__rules__ruff__tests__range_suppressions.snap</code>:314 on 2025-12-17 02:18</div>
            <div class="timeline-body"><p>I think I need to learn/understand how to build diagnostics with multiple fixes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amyreese">@amyreese</a> on 2025-12-17 02:24</div>
            <div class="timeline-body"><p>Checkpointing the feedback I got to today.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amyreese">@amyreese</a> on 2025-12-18 02:12</div>
            <div class="timeline-body"><p>Reorganized the logic to reduce repeat iterations and only consider each suppression for one type of violation at a time (I think that's what Micha was getting at?). I'd like to leave consolidating the diagnostics and any other refactors/structural changes to follow-up PRs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @amyreese on 2025-12-18 02:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ntBre by @amyreese on 2025-12-18 02:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-12-18 10:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/suppressions.py</code>:94 on 2025-12-18 10:12</div>
            <div class="timeline-body"><p>I guess that makes sense</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/snapshots/ruff_linter__rules__ruff__tests__range_suppressions.snap</code>:562 on 2025-12-18 10:15</div>
            <div class="timeline-body"><p>It feels a bit off that we highlight the entire suppression here, given that the suppression itself is valid, it's just the rule code that isn't.</p>
<p>I'm inclined to change the range here just to the code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/snapshots/ruff_linter__rules__ruff__tests__range_suppressions.snap</code>:567 on 2025-12-18 10:15</div>
            <div class="timeline-body"><p>Maybe: <em>Remove the suppression comment</em> if all codes are invalid</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/suppression.rs</code>:234 on 2025-12-18 10:18</div>
            <div class="timeline-body"><p>I wonder if this is confusing for users that expect <code>ruff: disable</code> to work without rule codes, and having it report a invalid syntax error would be more helpful in that case (we could even special case it with a help text, saying they should add a rule code)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/suppression.rs</code>:199 on 2025-12-18 10:20</div>
            <div class="timeline-body"><pre><code class="language-suggestion">                    let rule = Rule::from_code(
                        get_redirect_target(&amp;suppression.code).unwrap_or(&amp;suppression.code),
                    ).expect(&quot;Should trigger `InvalidRuleCode`);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-12-18 10:22</div>
            <div class="timeline-body"><p>A few more nits about which diagnostics we emit but this otherwise looks good.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> reviewed on 2025-12-18 16:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/rules/ruff/snapshots/ruff_linter__rules__ruff__tests__range_suppressions.snap</code>:567 on 2025-12-18 16:59</div>
            <div class="timeline-body"><p>Changing this would also change the help text for all <code>#noqa</code> directives as well. Should that happen in a separate PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-12-18 18:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/ruff/snapshots/ruff_linter__rules__ruff__tests__range_suppressions.snap</code>:567 on 2025-12-18 18:04</div>
            <div class="timeline-body"><p>Yeah, maybe</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> reviewed on 2025-12-18 19:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/suppression.rs</code>:199 on 2025-12-18 19:50</div>
            <div class="timeline-body"><p>Turns out I can't do this because configured external rules are &quot;valid&quot; from the previous clause, but can't be unwrapped to a <code>Rule</code> here, and we don't want to treat those as unused either.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @amyreese on 2025-12-18 20:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @amyreese on 2025-12-18 20:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-12-18 20:58</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:17:59 UTC
    </footer>
</body>
</html>
