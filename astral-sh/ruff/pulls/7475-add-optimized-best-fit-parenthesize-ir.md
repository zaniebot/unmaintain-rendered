```yaml
number: 7475
title: "Add optimized `best_fit_parenthesize` IR"
type: pull_request
state: merged
author: MichaReiser
labels:
  - performance
  - formatter
assignees: []
merged: true
base: main
head: optional-parentheses-ir
created_at: 2023-09-18T06:43:43Z
updated_at: 2023-09-19T06:29:07Z
url: https://github.com/astral-sh/ruff/pull/7475
synced_at: 2026-01-12T02:39:10Z
```

# Add optimized `best_fit_parenthesize` IR

---

_Pull request opened by @MichaReiser on 2023-09-18 06:43_

## Summary

This PR adds a custom IR for content that should only be parenthesized if it makes it fit. The custom IR removes the need to use the costly `BestFitting` IR element, allowing us to remove the poor heuristic around when to use the `BestFit` layout (because the IR is now cheap).

The main downside of the custom IR is that it is less tested and further increases the complexity of the Printer (It is re-implementation of `BestFitting` with the three variants)

Closes https://github.com/astral-sh/ruff/issues/7463
Closes https://github.com/astral-sh/ruff/issues/7067
Closes #7462

## Test Plan

`cargo test`

**Base**

| project      | similarity index  | total files       | changed files     |
|--------------|------------------:|------------------:|------------------:|
| cpython      |           0.76083 |              1789 |              1632 |
| django       |           0.99982 |              2760 |                37 |
| transformers |           0.99957 |              2587 |               398 |
| twine        |           1.00000 |                33 |                 0 |
| typeshed     |           0.99983 |              3496 |                18 |
| warehouse    |           0.99929 |               648 |                16 |
| zulip        |           0.99962 |              1437 |                22 |



**This PR**
| project      | similarity index  | total files       | changed files     |
|--------------|------------------:|------------------:|------------------:|
| cpython      |           0.76083 |              1789 |              1631 |
| **django**       |           0.99983 |              2760 |                36 |
| **transformers** |           0.99956 |              2587 |               404 |
| twine        |           1.00000 |                33 |                 0 |
| typeshed     |           0.99983 |              3496 |                18 |
| warehouse    |           0.99929 |               648 |                16 |
| **zulip**        |           0.99969 |              1437 |                21 |


New *transformers* deviations: There are a few new transformers deviations of the form:

```python
if True:
    if True:
        if True:
			model.config.use_cache = False  # FSTM still requires this hack -> FSTM should probably be refactored similar to BART afterward

# Formatted
if True:
    if True:
        if True:
			model.config.use_cache = (
				False
			)  # FSTM still requires this hack -> FSTM should probably be refactored similar to BART afterward
```

This is because the `BestFit` layout is now also applied for constants. 

The formatting is now consistent with a 6 character identifier:

```python
if True:
    if True:
        if True:
            model.config.use_cache = aaaaaa  # FSTM still requires this hack -> FSTM should probably be refactored similar to BART afterward

# Formatted
if True:
    if True:
        if True:
            model.config.use_cache = (
                aaaaaa
            )  # FSTM still requires this hack -> FSTM should probably be refactored similar to BART afterward

```


---

_Comment by @MichaReiser on 2023-09-18 06:43_

Current dependencies on/for this PR:
* main
  * **PR #7475** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7475" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7475?utm_source=stack-comment).

---

_Comment by @codspeed-hq[bot] on 2023-09-18 11:37_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/optional-parentheses-ir)

### Merging #7475 will **improve performances by 9.15%**

<sub>Comparing <code>optional-parentheses-ir</code> (81333ac) with <code>main</code> (28b48ab)</sub>



### Summary

`âš¡ 4` improvements
`âœ… 21` untouched benchmarks




### Benchmarks breakdown

|     | Benchmark | `main` | `optional-parentheses-ir` | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| âš¡ | `formatter[pydantic/types.py]` | 20.8 ms | 19.3 ms | +7.62% |
| âš¡ | `formatter[large/dataset.py]` | 57.3 ms | 52.5 ms | +9.15% |
| âš¡ | `formatter[numpy/ctypeslib.py]` | 10.7 ms | 9.9 ms | +7.9% |
| âš¡ | `formatter[unicode/pypinyin.py]` | 3.6 ms | 3.4 ms | +7.92% |


---

_Label `performance` added by @MichaReiser on 2023-09-18 11:41_

---

_Label `formatter` added by @MichaReiser on 2023-09-18 11:41_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/tests/snapshots/black_compatibility@miscellaneous__long_strings_flag_disabled.py.snap`:325 on 2023-09-18 12:39_

These didn't use the `best_fitting` layout before because they were excluded by the `use_best_fit`. This is more consistent

---

_Renamed from "Add optional parentheses IR" to "Add optimized `best_fit_parenthesize` IR" by @MichaReiser on 2023-09-18 15:07_

---

_Review requested from @konstin by @MichaReiser on 2023-09-18 15:07_

---

_Review requested from @charliermarsh by @MichaReiser on 2023-09-18 15:07_

---

_Marked ready for review by @MichaReiser on 2023-09-18 15:07_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_constant.rs`:82 on 2023-09-18 15:11_

It's now cheap enough to always use `BestFit`. We only need to avoid it in cases where we never want parentheses

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/mod.rs`:200 on 2023-09-18 15:12_

Thanks @charliermarsh for adding these methods. It makes it straightforward to replace one API with the other :)

---

_@MichaReiser reviewed on 2023-09-18 15:13_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/lib.rs`:228 on 2023-09-19 00:09_

Maybe unintentional.

---

_Review comment by @charliermarsh on `crates/ruff_formatter/src/format_element/tag.rs`:95 on 2023-09-19 00:16_

Nit: `Beset` should `Best`

---

_@charliermarsh approved on 2023-09-19 00:17_

This looks great, and the speedups are impressive, though I'll admit I'm not very familiar with the printer internals.

---

_Merged by @MichaReiser on 2023-09-19 06:29_

---

_Closed by @MichaReiser on 2023-09-19 06:29_

---

_Branch deleted on 2023-09-19 06:29_

---
