<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-bugbear`] Ignore non-NFKC attribute names in B009 and B010 (`B009`, `B010`) - astral-sh/ruff #21131</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-bugbear</code>] Ignore non-NFKC attribute names in B009 and B010 (<code>B009</code>, <code>B010</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21131">#21131</a>
        opened by <a href="https://github.com/danparizher">@danparizher</a>
        on 2025-10-29 22:19
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/danparizher">@danparizher</a> on 2025-10-29 22:19</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR updates the <code>B009</code> (<code>get-attr-with-constant</code>) and <code>B010</code> (<code>set-attr-with-constant</code>) rules to ignore non-NFKC attribute names, preventing refactoring suggestions that could change program behavior.</p>
<p>Fixes #21126</p>
<h2>Problem Analysis</h2>
<p>Python normalizes identifiers using NFKC (Normalization Form KC) normalization. When using attribute access syntax (e.g., <code>obj.attr</code>), Python automatically normalizes the identifier. However, when using <code>getattr</code> or <code>setattr</code> with a string literal, the identifier is not normalized.</p>
<p>The issue occurs when an attribute name contains characters that normalize differently under NFKC. For example:</p>
<ul>
<li>The long s character <code>&quot;ſ&quot;</code> normalizes to <code>&quot;s&quot;</code> in NFKC</li>
<li>Using <code>setattr(ns, &quot;ſ&quot;, 1)</code> creates a distinct attribute from <code>ns.s</code></li>
<li>If Ruff suggests replacing <code>setattr(ns, &quot;ſ&quot;, 1)</code> with <code>ns.ſ = 1</code>, Python would normalize <code>ns.ſ</code> to <code>ns.s</code>, which changes the program's behavior</li>
</ul>
<p>The bug was that Ruff's B009 and B010 rules didn't account for this normalization difference, potentially suggesting unsafe refactorings.</p>
<h2>Approach</h2>
<p>The fix adds a check in both <code>B009</code> and <code>B010</code> rule implementations to detect non-NFKC attribute names. Before suggesting a refactoring, the code now:</p>
<ol>
<li>Normalizes the attribute name using NFKC</li>
<li>Compares the normalized form with the original</li>
<li>If they differ, the rule skips the check (returns early) to avoid suggesting an unsafe refactoring</li>
</ol>
<p>This ensures that:</p>
<ul>
<li>Rules only suggest refactorings when it's safe (i.e., when NFKC normalization wouldn't change the attribute name)</li>
<li>The fix is minimal and doesn't affect other rule functionality</li>
<li>Edge cases are handled correctly (non-NFKC names are silently ignored)</li>
</ul>
<p>Test cases were added to verify that non-NFKC attribute names (like <code>&quot;ſ&quot;</code>) are correctly ignored by both rules.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-29 22:29</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-30 01:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_bugbear/rules/getattr_with_constant.rs</code>:75 on 2025-10-30 01:02</div>
            <div class="timeline-body"><p>Let's move this after line 78 as this comparison is more expensive than testing if it is the builtin getattr</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-30 01:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/resources/test/fixtures/flake8_bugbear/B009_B010.py</code>:75 on 2025-10-30 01:04</div>
            <div class="timeline-body"><p>I suggest including a short explanation <strong>why</strong> they should be ignored</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @danparizher on 2025-10-30 01:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-30 13:01</div>
            <div class="timeline-body"><p>I'm leaning towards marking the fix as unsafe if the attribute is different after nfkc normalization instead of omitting the diagnostic entirely as I doubt that it's very intentional.</p>
<p>The counter-argument to this is that someone might deliberately use <code>getattr</code> because they're aware of the difference and it matters to them. The synta then acts as an explicit expression of their intent and forcing them to add a noqa comment feels redundant.</p>
<p>I'm leaning towards doing the former because the second seems extremely rare and a noqa suppression (with an explanation why) can serve as additional documentation for future readers. But I'm curious to hear what others think</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/amyreese">@amyreese</a> on 2025-10-31 00:47</div>
            <div class="timeline-body"><p>+1 to just marking it unsafe</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-11-01 22:54</div>
            <div class="timeline-body"><p>Thank you. This looks good. The only thing left to do is to update the rule documentation with an explanation when the fix is marked as unsafe</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-11-03 14:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2025-11-03 14:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @MichaReiser on 2025-11-03 14:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-11-03 14:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-11-03 14:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-11-03 15:07</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:54:19 UTC
    </footer>
</body>
</html>
