<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>perf: `RuleTable::any_enabled` - astral-sh/ruff #10971</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>perf: <code>RuleTable::any_enabled</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10971">#10971</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-04-16 08:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR improves the performance of <code>RuleTable::any_enabled</code> which is called frequently in expression checking to determine if a specific set of rules is enabled.</p>
<p>The old implementation used <code>enabled.intersects(RuleSet::from_iter(rules))</code> to test if the enabled set and the tested rules overlap.
This worked fine when we had few rules but is now becoming a performance bottleneck when bumping <code>RuleSet</code> from 13 to 14 usizes because each call zero initializes a 14 * 8=112 bytes large array on the stack, sets the rule indexes and then computes if the sets overlap.</p>
<p>The new implementation avoids constructing a <code>RuleSet</code> using <code>from_iter</code> based on the assumption that we mainly query <code>any_enabled</code> with a few rules. This avoids writing 112 bytes on each call.</p>
<p>This should make the <code>any_enabled</code> check independent of the size of the <code>RuleSet</code>.</p>
<h2>Test Plan</h2>
<p><code>cargo test</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @MichaReiser on 2024-04-16 08:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-04-16 08:46</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/perf-rules-any-enabled">CodSpeed Performance Report</a></h2>
<h3>Merging #10971 will <strong>improve performances by 20.14%</strong></h3>
<p><sub>Comparing <code>perf-rules-any-enabled</code> (bac6d21) with <code>main</code> (f779bab)</sub></p>
<h3>Summary</h3>
<p><code>⚡ 6</code> improvements
<code>✅ 24</code> untouched benchmarks</p>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>main</code> | <code>perf-rules-any-enabled</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ⚡ | <code>linter/all-rules[large/dataset.py]</code> | 82.4 ms | 79 ms | +4.32% |
| ⚡ | <code>linter/default-rules[large/dataset.py]</code> | 19.3 ms | 16.1 ms | +20.14% |
| ⚡ | <code>linter/default-rules[numpy/ctypeslib.py]</code> | 4.1 ms | 3.7 ms | +13.11% |
| ⚡ | <code>linter/default-rules[numpy/globals.py]</code> | 636.8 µs | 595.2 µs | +6.98% |
| ⚡ | <code>linter/default-rules[pydantic/types.py]</code> | 8.6 ms | 7.7 ms | +11.52% |
| ⚡ | <code>linter/default-rules[unicode/pypinyin.py]</code> | 1.5 ms | 1.3 ms | +16.67% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @BurntSushi by @MichaReiser on 2024-04-16 08:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-04-16 08:53</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-04-16 09:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/registry/rule_set.rs</code>:254 on 2024-04-16 09:02</div>
            <div class="timeline-body"><p>I intentionally use an bitwise OR here to avoid any branching.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_linter/src/registry/rule_set.rs</code>:254 on 2024-04-16 11:45</div>
            <div class="timeline-body"><p>I'd bet it would compile down to the same code if you used an <code>if</code>. :-) But I actually find this pretty readable as it is personally.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_linter/src/registry/rule_set.rs</code>:253 on 2024-04-16 11:46</div>
            <div class="timeline-body"><p>It looks like this entire function could just be written as <code>rules.iter().any(|r| self.contains(r))</code>? Did you try that and it was slower? (I believe it also has the benefit of short circuiting, which may or may not help depending on the typical length of <code>rules</code>.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-04-16 11:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-04-16 11:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/registry/rule_set.rs</code>:253 on 2024-04-16 11:55</div>
            <div class="timeline-body"><p>The typical length is like 1-8 rules (where 8 is rare). The downside is that the function can't be const anymore ;).</p>
<p>But the performance is about the same. So lets use <code>any</code> as it is easier to understand.</p>
<p>Edit: Codspeed disagrees. The shift version is slightly faster (23% speedup instead of 20%)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-04-16 12:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/registry/rule_set.rs</code>:254 on 2024-04-16 12:06</div>
            <div class="timeline-body"><p>Acutally, it does not</p>
<p>The iter version has a jump</p>
<pre><code>mov     rax, qword ptr [rsp - 112]
movzx   edx, byte ptr [rsp - 116]
mov     cl, 1
bt      rax, rdx
jb      .LBB0_2
movzx   ecx, byte ptr [rsp - 114]
bt      rax, rcx
setb    cl
</code></pre>
<p>The loop version does not (but it requires more instructions)</p>
<pre><code>mov     byte ptr [rsp - 117], cl
lea     rax, [rsp - 117]
movzx   ecx, byte ptr [rsp - 114]
mov     edx, 1
shl     edx, cl
movzx   ecx, byte ptr [rsp - 116]
bts     edx, ecx
test    dword ptr [rsp - 112], edx
setne   byte ptr [rsp - 117]
</code></pre>
<p>https://godbolt.org/z/oWWzqc6s1</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2024-04-16 12:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-04-16 12:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-04-16 12:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-04-16 12:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_linter/src/registry/rule_set.rs</code>:254 on 2024-04-16 12:24</div>
            <div class="timeline-body"><p>Yeah I just meant, <code>if self.contains(rules[i]) { any = true }</code>.</p>
<p>It makes sense that the <code>iter</code> version has an extra jump because of the short circuit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-04-16 12:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_linter/src/registry/rule_set.rs</code>:253 on 2024-04-16 12:24</div>
            <div class="timeline-body"><p>Ah I missed the <code>const</code> requirement.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-04-16 12:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/registry/rule_set.rs</code>:254 on 2024-04-16 12:27</div>
            <div class="timeline-body"><p>ah yeah, that probably compiles down to the same</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-16 13:18</div>
            <div class="timeline-body"><p>Woo!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:03:50 UTC
    </footer>
</body>
</html>
