<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add support for dynamic dataclasses via `make_dataclass` - astral-sh/ruff #22586</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add support for dynamic dataclasses via <code>make_dataclass</code></h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22586">#22586</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2026-01-14 22:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>Like #22327, but for dataclasses.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-14 22:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-14 22:22</div>
            <div class="timeline-body">

<a href="https://github.com/python/typing/blob/dece44f2922ca390fe314145d09939514a21e76e/conformance/">Typing conformance results</a>
<p>No changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-14 22:23</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>strawberry (https://github.com/strawberry-graphql/strawberry)
+ strawberry/experimental/pydantic/error_type.py:149:37: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
+ strawberry/experimental/pydantic/object_type.py:255:24: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 345 diagnostics
+ Found 347 diagnostics


</code></pre>


<p>No memory usage changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-15 02:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-15 02:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-15 02:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-15 02:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-15 02:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-15 02:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-15 03:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-15 03:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-15 09:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-15 09:23</div>
            <div class="timeline-body">

<code>ecosystem-analyzer</code> results
<p>| Lint rule | Added | Removed | Changed |
|-----------|------:|--------:|--------:|
| <code>invalid-parameter-default</code> | 0 | 0 | 7 |
| <code>invalid-return-type</code> | 0 | 4 | 2 |
| <code>invalid-assignment</code> | 0 | 0 | 4 |
| <code>invalid-argument-type</code> | 0 | 0 | 3 |
| <code>unused-ignore-comment</code> | 2 | 0 | 0 |
| <strong>Total</strong> | <strong>2</strong> | <strong>4</strong> | <strong>16</strong> |</p>
<p><strong><a href="https://afd3da90.ty-ecosystem-ext.pages.dev/diff">Full report with detailed diff</a></strong> (<a href="https://afd3da90.ty-ecosystem-ext.pages.dev/timing">timing results</a>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-15 13:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-15 13:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-15 13:46</div>
            <div class="timeline-body"><p>I&#x27;m a <em>bit</em> hesitant about this one. The typing spec doesn&#x27;t say anything about this function AFAIK, and I don&#x27;t remember seeing any user requests on the issue tracker for us to add special-cased support. Mypy_primer only shows two diagnostics going away in the ecosystem, on <code>strawberry</code> -- and it looks like those lines already have <code>type: ignore</code>s on them for mypy.</p>
<p>Meanwhile, this is <em>quite</em> a bit of new code, and the manual parsing of arguments in <code>infer/builder.rs</code> is quite complicated and error-prone.</p>
<p>Do any other type checkers have special-cased support for this function? We do have to draw the line <em>somewhere</em>.</p>
<p>I think I&#x27;d feel differently if we could share more of the call-expression-parsing logic with what we&#x27;ve already added for namedtuples (which definitely <em>was</em> necessary), but the schema <code>make_dataclass()</code> expects is <em>just</em> different enough that sharing more of the code seems like it could be pretty difficult?</p>
<p>Another -- much simpler -- way to avoid false positives with the objects returned by this function would be to just special-case the return type so that we infer <code>type[Unknown]</code> rather than <code>type</code> -- that wouldn&#x27;t involve any custom call-expression parsing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-15 13:59</div>
            <div class="timeline-body"><p>AFAICT, Mypy and Pyright do not support it. But... I would still advocate for us to support it? We have all the infrastructure to do so! And almost all of the new code is in argument parsing -- which is very verbose, but at least fairly mechanical and testable? (E.g., it&#x27;s much easier to know when we have that right, as opposed to something deep in type inference.) I think I don&#x27;t agree that <em>this</em> is where we should draw the line, unless it&#x27;s a feature that we can&#x27;t support for reasons that I don&#x27;t yet understand or would be uncovered by your review.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-15 14:01</div>
            <div class="timeline-body"><p>(I&#x27;m curious for @carljm&#x27;s and @dcreager&#x27;s opinions!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-15 14:08</div>
            <div class="timeline-body"><p>Ditto and am totally fine to be overruled on it of course. I took it as a given that we&#x27;d support this given that it&#x27;s in the <a href="https://github.com/astral-sh/ty/issues/1889">type system overview</a>; that may have been a mistake!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-15 14:10</div>
            <div class="timeline-body"><blockquote>
<p>Ditto and am totally fine to be overruled on it of course. I took it as a given that we&#x27;d support this given that it&#x27;s in the <a href="https://github.com/astral-sh/ty/issues/1889">type system overview</a>; that may have been a mistake!</p>
</blockquote>
<p>Well, that issue just says that we don&#x27;t have any tests for the function right now. But this PR adds a lot more than just test coverage ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types/infer/builder.rs</code>:7836 on 2026-01-15 14:12</div>
            <div class="timeline-body"><p>Can we match on the elements here. The same in other positions</p>
<pre><code>                    [name_expr, type_expr] =&gt; {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2026-01-15 14:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types/class.rs</code>:6387 on 2026-01-15 14:13</div>
            <div class="timeline-body"><p>It seems unfortunate that we have to repeat all those methods for every dynamic class literal. Can&#x27;t we share more infrastructure?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2026-01-15 14:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2026-01-16 00:53</div>
            <div class="timeline-body"><p>I think it&#x27;s pretty natural to support this (along with similar forms for namedtuple and TypedDict) and it seems pretty easy to do. I&#x27;m not really concerned by the argument parsing. It&#x27;s a chunk of code, sure, but it&#x27;s not a chunk of code that interacts with other things in a way that multiplies complexity; it&#x27;s pretty much standalone, we&#x27;ll only ever touch it if literally <code>make_dataclass</code> support is broken, and then we&#x27;ll know right where to look.</p>
<p>The fact that other type checkers don&#x27;t support it means I wouldn&#x27;t have considered it a priority for stable -- but if it&#x27;s done and working, I don&#x27;t see any significant downside to merging it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/dataclasses/make_dataclass.md</code>:56 on 2026-01-16 11:44</div>
            <div class="timeline-body"><pre><code>from dataclasses import make_dataclass
from ty_extensions import reveal_mro

Point2 = make_dataclass(&quot;Point2&quot;, [(&quot;x&quot;, int), (&quot;y&quot;, int)])

reveal_type(Point2)  # revealed: &lt;class &#x27;Point2&#x27;&gt;
reveal_mro(Point2)  # revealed: (&lt;class &#x27;Point2&#x27;&gt;, &lt;class &#x27;object&#x27;&gt;)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/dataclasses/make_dataclass.md</code>:76 on 2026-01-16 11:44</div>
            <div class="timeline-body"><p>nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/dataclasses/make_dataclass.md</code>:108 on 2026-01-16 11:45</div>
            <div class="timeline-body"><p>I&#x27;m not sure this test shows that much as-is, because all Python types inherit an <code>__eq__</code> method from <code>object</code> even if they don&#x27;t define <code>__eq__</code>, so you should be able to compare nearly all Python types using <code>==</code> without it failing</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-16 11:49</div>
            <div class="timeline-body"><p>Okiedokie</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/dataclasses/make_dataclass.md</code>:152 on 2026-01-16 11:51</div>
            <div class="timeline-body"><p>Can we also test that we view these attributes as immutable? (I can&#x27;t remember exactly what error we should be emitting here)</p>
<pre><code>from dataclasses import make_dataclass

PointFrozen = make_dataclass(&quot;PointFrozen&quot;, [(&quot;x&quot;, int), (&quot;y&quot;, int)], frozen=True)

p = PointFrozen(1, 2)

# frozen dataclasses generate __hash__
reveal_type(hash(p))  # revealed: int

# These should both fail, since frozen dataclasses are immutable
p.x = 42  # error
p.y = 56  # error
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/dataclasses/make_dataclass.md</code>:206 on 2026-01-16 11:53</div>
            <div class="timeline-body"><pre><code>from dataclasses import make_dataclass
from ty_extensions import reveal_mro

class Base:
    def greet(self) -&gt; str:
        return &quot;Hello&quot;

Derived = make_dataclass(&quot;Derived&quot;, [(&quot;value&quot;, int)], bases=(Base,))
reveal_mro(Derived)  # revealed: (&lt;class &#x27;Derived&#x27;&gt;, &lt;class &#x27;Base&#x27;&gt;, &lt;class &#x27;object&#x27;&gt;)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/dataclasses/make_dataclass.md</code>:238 on 2026-01-16 11:57</div>
            <div class="timeline-body"><pre><code>from dataclasses import make_dataclass
from ty_extensions import reveal_mro

def get_fields():
    return [(&quot;x&quot;, int)]

fields = get_fields()
PointDynamic = make_dataclass(&quot;PointDynamic&quot;, fields)

p = PointDynamic(1)  # No error - accepts any arguments
reveal_type(p.x)  # revealed: Any

# the class is still inferred as inheriting directly from `object`
# (`Unknown` is not inserted into the MRO)
reveal_mro(PointDynamic)  # revealed: (&lt;class &#x27;PointDynamic&#x27;&gt;, &lt;class &#x27;object&#x27;&gt;)

# ...but nontheless, we assume that all attributes are available,
# similar to attribute access on `Unknown`
reveal_type(p.unknown)  # revealed: Any
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/dataclasses/make_dataclass.md</code>:254 on 2026-01-16 11:58</div>
            <div class="timeline-body"><p>But you don&#x27;t currently emit a diagnostic on this branch for too <em>few</em> positional arguments -- this does not cause us to emit an error on this branch, but it fails at runtime:</p>
<pre><code>from dataclasses import make_dataclass

make_dataclass(&quot;foo&quot;)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/dataclasses/make_dataclass.md</code>:351 on 2026-01-16 12:00</div>
            <div class="timeline-body"><p>You don&#x27;t currently emit an error for <code>make_dataclass(&quot;foo&quot;, bases=12345)</code> on this branch</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/dataclasses/make_dataclass.md</code>:343 on 2026-01-16 12:02</div>
            <div class="timeline-body"><p>I think we&#x27;d be able to infer the MRO just fine, but <code>Protocol</code> classes are heavily special-cased elsewhere, and it would significantly complicate our internal logic to support dynamically constructed <code>Protocol</code> classes (which anyway aren&#x27;t mentioned anywhere by the typing spec)</p>
<pre><code>Protocol bases use a different lint (`unsupported-dynamic-base`) because they&#x27;re technically valid
Python but not supported by ty for dynamic classes.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2026-01-16 12:02</div>
            <div class="timeline-body"><p>A tests-only review for now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-16 13:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-16 14:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/dataclasses/make_dataclass.md</code>:1 on 2026-01-16 16:23</div>
            <div class="timeline-body"><p>Not sure you have any tests yet for what happens if <code>*args</code> or <code>**kwargs</code> are passed into a <code>make_dataclass</code> call.</p>
<p>Also (sorry): you should probably add tests for recursive and stringified types, e.g.</p>
<pre><code>from dataclasses import make_dataclass

X = make_dataclass(&quot;X&quot;, [(&quot;a&quot;, &quot;X | None&quot;)])
</code></pre>
<p>Since we&#x27;ll <em>have</em> to support recursive and stringified types for functional <code>typing.NamedTuple</code>s and functional <code>typing.TypedDict</code>s, we should probably be consistent and support them for functional dataclasses too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/class.rs</code>:676 on 2026-01-16 16:25</div>
            <div class="timeline-body"><p>do we have tests for what happens if functional dataclasses with and without <code>order=True</code> are passed to <code>total_ordering()</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/class.rs</code>:712 on 2026-01-16 16:29</div>
            <div class="timeline-body"><p>I think you could reduce duplication between the branches a little bit in this method, e.g.</p>
<pre><code>    /// Returns the type definition for this class.
    ///
    /// For static classes, returns `TypeDefinition::StaticClass`.
    /// For dynamic classes, returns `TypeDefinition::DynamicClass` if a definition is available.
    pub(crate) fn type_definition(self, db: &amp;&#x27;db dyn Db) -&gt; Option&lt;TypeDefinition&lt;&#x27;db&gt;&gt; {
        let definition = match self {
            Self::Dynamic(class) =&gt; class.definition(db),
            Self::DynamicNamedTuple(namedtuple) =&gt; namedtuple.definition(db),
            Self::DynamicDataclass(dataclass) =&gt; dataclass.definition(db),

            // This is the only variant that returns `TypeDefinition::StaticClass`
            // rather than `TypeDefinition::DynamicClass`.
            Self::Static(class) =&gt; return Some(TypeDefinition::StaticClass(class.definition(db))),
        };

        definition.map(TypeDefinition::DynamicClass)
    }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/class.rs</code>:771 on 2026-01-16 16:30</div>
            <div class="timeline-body"><p>do we have a test that demonstrates that a <code>slots=True</code> functional dataclass is understood as a disjoint base?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2026-01-16 16:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-16 20:00</div>
            <div class="timeline-body"><p>Can probably hold off on further review until <a href="https://github.com/astral-sh/ruff/pull/22627">astral-sh/ruff#22627</a> is resolved, since it will have implications for this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-19 13:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-19 13:41</div>
            <div class="timeline-body"><p>(Marking as draft while we finish the recursive definition work upstream.)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-21 23:10:57 UTC
    </footer>
</body>
</html>
