```yaml
number: 6896
title: Use Codspeed for continous benchmarking
type: pull_request
state: merged
author: MichaReiser
labels:
  - internal
assignees: []
merged: true
base: main
head: codspeed
created_at: 2023-08-26T13:26:40Z
updated_at: 2023-08-26T14:34:36Z
url: https://github.com/astral-sh/ruff/pull/6896
synced_at: 2026-01-12T02:45:38Z
```

# Use Codspeed for continous benchmarking

---

_Pull request opened by @MichaReiser on 2023-08-26 13:26_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This PR replaces our custom benchmarking CI step with [CodSpeed](https://codspeed.io/). 

CodSpeed requires us to use their criterion API wrapper. However, only using their wrapper has the downside that running the benchmarks locally becomes impossible (because it is unsupported).  I worked around this by adding a feature flag to our benchmark crate that controls whether we use `criterion`'s API directly or codespeed's wrapper. 

## Test Plan

[CI run](https://github.com/astral-sh/ruff/actions/runs/5985229230/job/16237132521?pr=6896) Running the benchmarks is significantly faster. I hope that build time will improve with a hot cache.
<!-- How was it tested? -->

The data shows up in the dashboard

![image](https://github.com/astral-sh/ruff/assets/1203881/e62cc8e6-ee8d-4dcc-b5c6-8c764fc37d48)


---

_Comment by @MichaReiser on 2023-08-26 13:26_

Current dependencies on/for this PR:
* main
  * **PR #6896** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6896" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6896?utm_source=stack-comment).

---

_Comment by @codspeed-hq[bot] on 2023-08-26 13:56_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/codspeed)


### Congrats! CodSpeed is installed ðŸŽ‰

`ðŸ†•` **16 new benchmarks were detected.**

You will start to see performance impacts in the reports once the benchmarks are run from your default branch.

<details>
  <summary><h3>Detected benchmarks</h3></summary>

- `formatter[numpy/globals.py]` (1.4 ms)
- `linter/default-rules[numpy/globals.py]` (2.2 ms)
- `formatter[large/dataset.py]` (72.6 ms)
- `formatter[pydantic/types.py]` (26.3 ms)
- `linter/default-rules[pydantic/types.py]` (38.8 ms)
- `linter/default-rules[numpy/ctypeslib.py]` (18.7 ms)
- `linter/default-rules[large/dataset.py]` (94.1 ms)
- `linter/all-rules[numpy/ctypeslib.py]` (34.3 ms)
- `parser[numpy/ctypeslib.py]` (12.5 ms)
- `parser[pydantic/types.py]` (26.8 ms)
- `parser[large/dataset.py]` (68.8 ms)
- `parser[numpy/globals.py]` (1.4 ms)
- `linter/all-rules[pydantic/types.py]` (71.7 ms)
- `formatter[numpy/ctypeslib.py]` (13.9 ms)
- `linter/all-rules[large/dataset.py]` (156.2 ms)
- `linter/all-rules[numpy/globals.py]` (4 ms)

</details>

---

_Comment by @github-actions[bot] on 2023-08-26 13:59_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Marked ready for review by @MichaReiser on 2023-08-26 14:02_

---

_Review requested from @charliermarsh by @MichaReiser on 2023-08-26 14:08_

---

_Label `internal` added by @MichaReiser on 2023-08-26 14:08_

---

_Comment by @MichaReiser on 2023-08-26 14:08_

@boshen you might enjoy this. Or you can wait and check in with me to ask about our experience with it.

---

_@charliermarsh approved on 2023-08-26 14:32_

Looks great. Excited to try it :)

---

_Merged by @MichaReiser on 2023-08-26 14:34_

---

_Closed by @MichaReiser on 2023-08-26 14:34_

---

_Branch deleted on 2023-08-26 14:34_

---
