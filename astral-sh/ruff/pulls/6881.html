<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Introduce AST nodes for `PatternMatchClass` arguments - astral-sh/ruff #6881</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Introduce AST nodes for <code>PatternMatchClass</code> arguments</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6881">#6881</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-08-25 20:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-25 20:20</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR introduces two new AST nodes to improve the representation of <code>PatternMatchClass</code>. As a reminder, <code>PatternMatchClass</code> looks like this:</p>
<pre><code class="language-python">case Point2D(0, 0, x=1, y=2):
  ...
</code></pre>
<p>Historically, this was represented as a vector of patterns (for the <code>0, 0</code> portion) and parallel vectors of keyword names (for <code>x</code> and <code>y</code>) and values (for <code>1</code> and <code>2</code>). This introduces a bunch of challenges for the formatter, but importantly, it's also really different from how we represent similar nodes, like arguments (<code>func(0, 0, x=1, y=2)</code>) or parameters (<code>def func(x, y)</code>).</p>
<p>So, firstly, we now use a single node (<code>PatternArguments</code>) for the entire parenthesized region, making it much more consistent with our other nodes. So, above, <code>PatternArguments</code> would be <code>(0, 0, x=1, y=2)</code>.</p>
<p>Secondly, we now have a <code>PatternKeyword</code> node for <code>x=1</code> and <code>y=2</code>. This is much more similar to the how <code>Keyword</code> is represented within <code>Arguments</code> for call expressions.</p>
<p>Closes https://github.com/astral-sh/ruff/issues/6866.</p>
<p>Closes https://github.com/astral-sh/ruff/issues/6880.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @charliermarsh on 2023-08-25 20:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:1304 on 2023-08-25 20:21</div>
            <div class="timeline-body"><p>This gets dramatically simplified.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-25 20:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-25 20:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/pattern/pattern_arguments.rs</code>:12 on 2023-08-25 20:24</div>
            <div class="timeline-body"><p>This is very, very similar to <code>arguments.rs</code>, but it's difficult to share much code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/pattern/pattern_match_class.rs</code>:126 on 2023-08-25 20:24</div>
            <div class="timeline-body"><p>This specific logic is way simpler now -- we only care if there are dangling comments, not where they are, since these are dangling comments between <code>Point2D</code> and its arguments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-25 20:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-25 20:25</div>
            <div class="timeline-body"><p>Adding these AST nodes does require a bunch of boilerplate, but I think it's worth it for the improved representation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @charliermarsh on 2023-08-25 20:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-08-25 20:53</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/python.lalrpop</code>:818 on 2023-08-26 10:26</div>
            <div class="timeline-body"><p>Nit: I got really confused by <code>ClassArguments</code>. I first thought you have two rules, one for <code>ClassArguments</code> and one for <code>PatternArguments</code>. I recommend renaming the rule to the same name as the node as we do for other rules too</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:1304 on 2023-08-26 10:28</div>
            <div class="timeline-body"><p>...dramatically :laughing:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-08-26 10:29</div>
            <div class="timeline-body"><p>Can you verify that the following continues to parse successfully (maybe add a test?)</p>
<pre><code class="language-python">match a:
   case Point2D((0), 0, x=(1), y=2):
        ...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-26 14:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:1304 on 2023-08-26 14:34</div>
            <div class="timeline-body"><p>Anything that deletes code is a &quot;dramatic simplification&quot; for me</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-08-26 14:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-08-26 14:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-08-26 14:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2023-08-26 14:49</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/charlie/pattern-ast">CodSpeed Performance Report</a></h2>
<h3>Merging #6881 will create unknown performance changes</h3>
<p><sub>Comparing <code>charlie/pattern-ast</code> (3b31526) with <code>main</code> (ed1b412)</sub></p>
<h3>Summary</h3>
<p><code>ðŸ†• 16</code> new benchmarks</p>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>main</code> | <code>charlie/pattern-ast</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ðŸ†• | <code>formatter[numpy/globals.py]</code> | N/A | 1.4 ms | N/A |
| ðŸ†• | <code>linter/default-rules[large/dataset.py]</code> | N/A | 91.9 ms | N/A |
| ðŸ†• | <code>formatter[large/dataset.py]</code> | N/A | 72.7 ms | N/A |
| ðŸ†• | <code>linter/default-rules[numpy/ctypeslib.py]</code> | N/A | 18.7 ms | N/A |
| ðŸ†• | <code>linter/all-rules[numpy/globals.py]</code> | N/A | 4 ms | N/A |
| ðŸ†• | <code>formatter[numpy/ctypeslib.py]</code> | N/A | 13.9 ms | N/A |
| ðŸ†• | <code>linter/default-rules[pydantic/types.py]</code> | N/A | 39 ms | N/A |
| ðŸ†• | <code>parser[numpy/globals.py]</code> | N/A | 1.4 ms | N/A |
| ðŸ†• | <code>parser[numpy/ctypeslib.py]</code> | N/A | 12.5 ms | N/A |
| ðŸ†• | <code>parser[pydantic/types.py]</code> | N/A | 26.8 ms | N/A |
| ðŸ†• | <code>parser[large/dataset.py]</code> | N/A | 68.8 ms | N/A |
| ðŸ†• | <code>linter/all-rules[pydantic/types.py]</code> | N/A | 71.8 ms | N/A |
| ðŸ†• | <code>linter/default-rules[numpy/globals.py]</code> | N/A | 2.2 ms | N/A |
| ðŸ†• | <code>linter/all-rules[numpy/ctypeslib.py]</code> | N/A | 34.2 ms | N/A |
| ðŸ†• | <code>linter/all-rules[large/dataset.py]</code> | N/A | 156.1 ms | N/A |
| ðŸ†• | <code>formatter[pydantic/types.py]</code> | N/A | 26.3 ms | N/A |</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 02:46:15 UTC
    </footer>
</body>
</html>
