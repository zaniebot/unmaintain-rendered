<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consider nested configs for settings reloading - astral-sh/ruff #12253</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Consider nested configs for settings reloading</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/12253">#12253</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-07-09 07:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body">Summary
<p>This PR fixes a bug in the settings reloading logic to consider nested configuration in a workspace.</p>
<p>fixes: #11766</p>
Test Plan
<p>https://github.com/astral-sh/ruff/assets/67177269/69704b7b-44b9-4cc7-b5a7-376bf87c6ef4</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-09 07:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-09 07:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-09 07:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-09 07:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/session/index.rs</code>:317 on 2024-07-09 07:36</div>
            <div class="timeline-body"><p>There are two main changes:</p>
<ol>
<li>We loop over every workspace folder. The <code>range_mut</code> is incorrect here because the &quot;enclosing_folder&quot; would be within the workspace.</li>
<li>The <code>starts_with</code> call is incorrect. We should be checking if the folder is part of the workspace or not and not the other way around which will always be incorrect for nested folders.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-07-09 07:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-07-09 07:45</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-09 07:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/session/index.rs</code>:317 on 2024-07-09 07:52</div>
            <div class="timeline-body"><p>I wonder if this is correct though: Let&#x27;s say we have workspace <code>a</code> and <code>b</code> and we add a configuration to <code>b/foo</code> so that <code>root</code> = <code>a</code> and <code>enclosing_folder=b/foo</code>. We would immediately hit the <code>break</code> here.</p>
<p>I think we want <code>self.settings.range(..enclosing_folder).rev()</code> and we take the paths for as long as they start with <code>enclosing_folder</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-07-09 08:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/session/index.rs</code>:317 on 2024-07-09 08:07</div>
            <div class="timeline-body"><p>Oh, that&#x27;s correct. Thanks. Let me update it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/session/index.rs</code>:318 on 2024-07-09 13:25</div>
            <div class="timeline-body"><p>Is <code>break</code> still incorrect here? I get the impression that we could use <code>break</code> here but not entirely sure</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-07-09 13:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_server/src/session/index.rs</code>:317 on 2024-07-10 05:20</div>
            <div class="timeline-body"><p>This is actually not correct either because the <code>root</code> folder can never start with an <code>enclosing_folder</code>. This is the main reason I switched the <code>starts_with</code> call in (2). Let me think about this a bit more considering your example as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-07-10 05:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-07-10 12:13</div>
            <div class="timeline-body"><p>To me it&#x27;s still unclear if <code>break</code> would be sufficient instead of <code>continue</code> but I&#x27;m not a 100% sure.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-12 04:55</div>
            <div class="timeline-body"><blockquote>
<p>To me it&#x27;s still unclear if <code>break</code> would be sufficient instead of <code>continue</code> but I&#x27;m not a 100% sure.</p>
</blockquote>
<p>I thought about this more and I think <code>break</code> should be sufficient. The only place where <code>continue</code> would matter is if there are at least three workspaces with the following characteristics:</p>
<ol>
<li>Should be refreshed</li>
<li>Should be <code>continue</code></li>
<li>Config file under this workspace has been changed
The output of <code>range</code> operation should yield <code>[3, 2, 1]</code>. I can&#x27;t come up with a workspace layout where this matches. The usage of <code>BtreeMap</code> avoids this kinds of cases where <code>continue</code> would be required.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-12 05:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-07-12 05:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-07-12 05:00</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:05:09 UTC
    </footer>
</body>
</html>
