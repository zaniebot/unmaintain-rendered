<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Add support for `@final` classes - astral-sh/ruff #15070</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Add support for <code>@final</code> classes</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15070">#15070</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-12-19 18:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR adds support for the <code>@final</code> decorator on classes. The <code>@final</code> decorator can also be applied to methods; this PR does not add support for that yet.</p>
<p><code>@final</code> is specified here: https://typing.readthedocs.io/en/latest/spec/qualifiers.html#final. When applied to a class, it declares to the type checker that the class cannot be subclassed, and that the type checker should emit an error if it sees the class being subclassed. This information is extremely valuable to a type checker, as it rules out certain multiple inheritance possibilities, allows for more precise inference in some cases, and improves analysis of whether or not certain blocks of code are reachable.</p>
<p>This PR doesn't yet make use of these extra capabilities that an understanding of <code>@final</code> opens up to us; it just adds a basic understanding of finality, and adds a rule such that we emit a diagnostic if we see a final class being subclassed.</p>
<h2>Test Plan</h2>
<p>New mdtests added to <code>final.md</code>.</p>
<p>Co-authored-by: Carl Meyer <a href="mailto:carl@astral.sh">carl@astral.sh</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2024-12-19 18:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2024-12-19 18:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2024-12-19 18:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2024-12-19 18:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-12-19 18:47</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+1 -0 violations, +0 -0 fixes in 1 projects; 54 projects unchanged)</p>
<details><summary><a href="https://github.com/python/typeshed">python/typeshed</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --no-preview --select E,F,FA,I,PYI,RUF,UP,W</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/python/typeshed/blob/d31e3ea11e2090afdb639324bf7638891695d1ad/stdlib/dataclasses.pyi#L259'>stdlib/dataclasses.pyi:259:19:</a> W292 No newline at end of file
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| W292 | 1 | 1 | 0 | 0 | 0 |</p>
</p>
</details>

<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/final.md</code>:14 on 2024-12-19 20:11</div>
            <div class="timeline-body"><p>I suppose since we put some work into this part of the implementation, we could also use the column-number assertion here to show that the error is on the specific base (I could be off-by-one here, not sure)</p>
<pre><code class="language-suggestion">class B(A): ...  # error: 9 [subclass-of-final-class] &quot;Class `B` cannot inherit from final class `A`&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:3136 on 2024-12-19 20:12</div>
            <div class="timeline-body"><p>We are going to be re-doing this filter/any anytime we check whether a class is final. I suspect this is fine, it's still cheap and we won't do it often enough to matter, so it's not worth another query to avoid it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-12-19 20:13</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2024-12-19 21:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-12-19 21:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-12-19 21:02</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:08:37 UTC
    </footer>
</body>
</html>
