<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add a script that tests formatter stability on repositories - astral-sh/ruff #5055</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add a script that tests formatter stability on repositories</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5055">#5055</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2023-06-13 16:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>We want to ensure that once formatted content stays the same when formatted again, which is known as formatter stability or formatter idempotency, and that the formatter prints syntactically valid code. As our test cases cover only a limited amount of code, this allows checking entire repositories.</p>
<p>This adds a new subcommand to <code>ruff_dev</code> which can be invoked as <code>cargo run --bin ruff_dev -- check-formatter-stability &lt;repo&gt;</code>. While initially only intended to check stability, it has also found cases where the formatter printed invalid syntax or panicked.</p>
<h2>Test Plan</h2>
<p>Running this on cpython is already identifying bugs (https://github.com/astral-sh/ruff/pull/5089)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-06-13 16:30</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #5055</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5055" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5055?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-06-13 16:44</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      6.2Â±0.01ms     6.5 MB/sec    1.00      6.2Â±0.02ms     6.5 MB/sec
formatter/numpy/ctypeslib.py               1.01   1322.5Â±7.76Âµs    12.6 MB/sec    1.00   1311.8Â±4.48Âµs    12.7 MB/sec
formatter/numpy/globals.py                 1.01    127.6Â±1.55Âµs    23.1 MB/sec    1.00    126.7Â±0.12Âµs    23.3 MB/sec
formatter/pydantic/types.py                1.00      2.6Â±0.01ms     9.9 MB/sec    1.00      2.6Â±0.01ms    10.0 MB/sec
linter/all-rules/large/dataset.py          1.00     13.3Â±0.06ms     3.1 MB/sec    1.00     13.4Â±0.15ms     3.0 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.3Â±0.00ms     5.1 MB/sec    1.00      3.3Â±0.01ms     5.1 MB/sec
linter/all-rules/numpy/globals.py          1.00    414.9Â±0.50Âµs     7.1 MB/sec    1.00    415.2Â±0.41Âµs     7.1 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.7Â±0.02ms     4.4 MB/sec    1.00      5.7Â±0.01ms     4.4 MB/sec
linter/default-rules/large/dataset.py      1.00      6.7Â±0.01ms     6.1 MB/sec    1.00      6.7Â±0.02ms     6.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1434.3Â±2.76Âµs    11.6 MB/sec    1.01   1455.6Â±3.19Âµs    11.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    158.9Â±0.32Âµs    18.6 MB/sec    1.00    159.3Â±0.74Âµs    18.5 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.0Â±0.01ms     8.4 MB/sec    1.00      3.0Â±0.01ms     8.4 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      7.9Â±0.04ms     5.1 MB/sec    1.00      8.0Â±0.07ms     5.1 MB/sec
formatter/numpy/ctypeslib.py               1.00  1596.9Â±12.50Âµs    10.4 MB/sec    1.00  1599.0Â±10.91Âµs    10.4 MB/sec
formatter/numpy/globals.py                 1.00    155.9Â±1.62Âµs    18.9 MB/sec    1.01    157.7Â±4.12Âµs    18.7 MB/sec
formatter/pydantic/types.py                1.00      3.2Â±0.04ms     7.9 MB/sec    1.01      3.3Â±0.08ms     7.8 MB/sec
linter/all-rules/large/dataset.py          1.00     15.9Â±0.19ms     2.6 MB/sec    1.04     16.6Â±0.19ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.2Â±0.03ms     4.0 MB/sec    1.04      4.3Â±0.06ms     3.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    429.2Â±5.64Âµs     6.9 MB/sec    1.02    437.7Â±7.55Âµs     6.7 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.1Â±0.09ms     3.6 MB/sec    1.02      7.2Â±0.09ms     3.5 MB/sec
linter/default-rules/large/dataset.py      1.00      8.4Â±0.06ms     4.9 MB/sec    1.03      8.6Â±0.09ms     4.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1750.6Â±11.18Âµs     9.5 MB/sec    1.03  1806.4Â±15.23Âµs     9.2 MB/sec
linter/default-rules/numpy/globals.py      1.00    185.9Â±1.63Âµs    15.9 MB/sec    1.02    189.3Â±4.35Âµs    15.6 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.8Â±0.02ms     6.7 MB/sec    1.02      3.9Â±0.02ms     6.6 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on 2023-06-14 15:24</div>
            <div class="timeline-body"><p>Potentially would also be interesting to integrate this with the fuzzer for generating that initial corpus. The corpus I used is from a somewhat outdated python3 dataset currently, so it might not be representative of all modern features.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @konstin on 2023-06-14 15:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @konstin on 2023-06-14 19:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-06-14 19:41</div>
            <div class="timeline-body"><p>As someone who has little experience with fuzzer, what would it mean to use cpython for the initial corpus?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on 2023-06-15 12:04</div>
            <div class="timeline-body"><p>The corpus is the set of inputs on which the fuzzer tries to modify such that it triggers new code paths. If the fuzzer is provided with a corpus containing representative samples of inputs that can be handled by the program being tested, then it is more likely to mutate into an input that triggers unexpected behaviour. This is because the parser is less likely to outright reject the input and the fuzzer more likely to introduce new data to the input that triggers unexpected behaviour while processing the parsed input. Also, it means the fuzzer has less work to do to &quot;discover&quot; new functionality or features.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-06-15 12:15</div>
            <div class="timeline-body"><p>Thanks for the explanation! In this case cpython plus our own test fixture should be a great start</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/addisoncrump">@addisoncrump</a> on 2023-06-15 15:02</div>
            <div class="timeline-body"><p>In that case, once this lands, I'll update the (re)init-fuzzer script to use cpython source as part of the corpus init.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-15 16:23</div>
            <div class="timeline-body"><p>@konstin - Is this ready for review? Tag me when ready :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @konstin on 2023-06-15 19:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-06-15 19:02</div>
            <div class="timeline-body"><p>it is :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-06-15 19:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_dev/src/main.rs</code>:74 on 2023-06-15 19:08</div>
            <div class="timeline-body"><p>i've changed this back and forth like three times :sweat_smile: i can also roll this back once again</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @konstin on 2023-06-19 11:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_dev/src/check_formatter_stability.rs</code>:26 on 2023-06-19 13:38</div>
            <div class="timeline-body"><p>These appear in the Clap output, right? Can we make them actual rustdocs?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-06-19 13:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_dev/src/check_formatter_stability.rs</code>:26 on 2023-06-19 14:05</div>
            <div class="timeline-body"><p>thanks i missed that</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-06-19 14:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @konstin on 2023-06-19 14:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2023-06-19 14:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-06-19 14:13</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:58:02 UTC
    </footer>
</body>
</html>
