<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`eradicate`] ignore `# language=` in commented-out-code rule (ERA001) - astral-sh/ruff #14069</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>eradicate</code>] ignore <code># language=</code> in commented-out-code rule (ERA001)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14069">#14069</a>
        opened by <a href="https://github.com/fabiob">@fabiob</a>
        on 2024-11-03 21:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/fabiob">@fabiob</a> on 2024-11-03 21:23</div>
            <div class="timeline-body"><p>Fixes one common case cited on #6019</p>
<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>The <code>commented-out-code</code> rule (ERA001) from <code>eradicate</code> is currently flagging a very common idiom that marks Python strings as another language, to help with syntax highlighting:</p>
<p><img src="https://github.com/user-attachments/assets/d523e83d-95cb-4668-a793-45f01d162234" alt="image" /></p>
<p>This PR adds this idiom to the list of allowed exceptions to the rule.</p>
<h2>Test Plan</h2>
<p>I've added some additional test cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-11-03 21:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-03 21:24</div>
            <div class="timeline-body"><p>Do you mind pushing the test cases? I only see the code changes.</p>
<p>For reference: https://www.jetbrains.com/help/pycharm/using-language-injections.html</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-11-03 21:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/fabiob">@fabiob</a> on 2024-11-03 21:26</div>
            <div class="timeline-body"><p>Sorry @charliermarsh , forgot to force-push after I amended the commit with the test cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-03 21:26</div>
            <div class="timeline-body"><p>No prob, thanks for the PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/fabiob">@fabiob</a> on 2024-11-03 21:26</div>
            <div class="timeline-body"><p>And looks like I need to fix the formatting... Working on it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/fabiob">@fabiob</a> on 2024-11-03 21:36</div>
            <div class="timeline-body"><blockquote>
<p>For reference: https://www.jetbrains.com/help/pycharm/using-language-injections.html</p>
</blockquote>
<p>I've added some more test cases and fixed the regexp with the additional cases described here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-11-03 21:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-11-03 21:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-03 21:50</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-03 22:10</div>
            <div class="timeline-body"><p>Thanks and welcome to the project.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-03 22:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2024-11-04 14:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/src/rules/eradicate/detection.rs</code>:19 on 2024-11-04 14:32</div>
            <div class="timeline-body"><p>This nested quantifier doesn't look so nice: <code>[a-zA-Z](?: ?[-_.a-zA-Z0-9]+)+</code>. The optional space at the start of the group leads to multiple ways of matching the same text.</p>
<p>I know Rust's regex engine guarantees linear time, but this is nevertheless a bad pattern. Prefer <code>[a-zA-Z][-_.a-zA-Z0-9]*(?: [-_.a-zA-Z0-9]+)*</code> instead.</p>
<p>Technically, language IDs <a href="https://github.com/JetBrains/intellij-community/blob/986fff1b53ed8005bffae54a652d85c8bf901065/platform/core-api/src/com/intellij/lang/Language.java#L62">can be anything</a>, so it's perhaps better to drop the leading character requirement: <code>[-_.a-zA-Z0-9]+(?: [-_.a-zA-Z0-9]+)*</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-11-04 15:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/eradicate/detection.rs</code>:19 on 2024-11-04 15:10</div>
            <div class="timeline-body"><p>Should we just use <code>language=</code>? All language identifiers will start with that, and false positives seem somewhat rare / not a huge deal here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/fabiob">@fabiob</a> reviewed on 2024-11-04 15:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/fabiob">@fabiob</a> on <code>crates/ruff_linter/src/rules/eradicate/detection.rs</code>:19 on 2024-11-04 15:21</div>
            <div class="timeline-body"><p>@InSyncWithFoo maybe I was extra cautious about false positives.</p>
<blockquote>
<p>Technically, language IDs <a href="https://github.com/JetBrains/intellij-community/blob/986fff1b53ed8005bffae54a652d85c8bf901065/platform/core-api/src/com/intellij/lang/Language.java#L62">can be anything</a>,</p>
</blockquote>
<p>Good catch! Maybe we can just require a non-space character after the equals sign. This should take care of most false positives anyway, as it's uncommon for Python users to omit spaces around assignment operators.</p>
<p>The only thing that worries me is about detecting a commented-out named parameter on a multi-line method invocation or declaration. But maybe I'm just being overzealous.</p>
<pre><code class="language-python">def check_spelling(
  text,
  # language=DEFAULT_LANGUAGE
) ...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2024-11-04 15:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/src/rules/eradicate/detection.rs</code>:19 on 2024-11-04 15:25</div>
            <div class="timeline-body"><p><a href="https://github.com/search?q=%2F%28%3F%3A%23%29%5B%5E%5Cn%5CS%5D*language%3D%2F+path%3A%22.py%22&amp;type=code">A quick search</a> shows that matching on <code>language=</code> alone would lead to many false negatives.</p>
<p>Language IDs are also displayed to the user as part of the UI, so I doubt they would contain non-ASCII characters. I would say limiting to <code>[-_.a-zA-Z0-9]</code> and spaces is the most balanced heuristic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2024-11-04 15:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/src/rules/eradicate/detection.rs</code>:19 on 2024-11-04 15:38</div>
            <div class="timeline-body"><blockquote>
<p>[...] it's uncommon for Python users to omit spaces around assignment operators.</p>
</blockquote>
<p>Don't forget keyword arguments, which are recommended to be written with no spaces around the equal sign:</p>
<pre><code class="language-python"># frobnicate(
#     language='en'  # Could also be `language=EN` with a predefined constant `EN`
# )
</code></pre>
<p>I think both this and the false negative you mention are well within the acceptable error margin.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/fabiob">@fabiob</a> reviewed on 2024-11-04 15:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/fabiob">@fabiob</a> on <code>crates/ruff_linter/src/rules/eradicate/detection.rs</code>:19 on 2024-11-04 15:55</div>
            <div class="timeline-body"><p>So @InSyncWithFoo , will you write the PR with the new regexp and test cases, or should I?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2024-11-04 16:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/src/rules/eradicate/detection.rs</code>:19 on 2024-11-04 16:00</div>
            <div class="timeline-body"><p>I'll handle it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2024-11-04 16:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/src/rules/eradicate/detection.rs</code>:19 on 2024-11-04 16:33</div>
            <div class="timeline-body"><p>Turns out language IDs in comments must be normalized.</p>
<p>This is JSON Lines (one value on each line, comments allowed):</p>
<p><img src="https://github.com/user-attachments/assets/84a2f648-7edc-4075-9aa3-b8ce2c5b4977" alt="" /></p>
<p>This is pure JSON (one single top-level value, comments disallowed):</p>
<p><img src="https://github.com/user-attachments/assets/8e651588-37f9-46ca-9681-9c1eb430eb06" alt="" /></p>
<p><code>jsonlines</code> must be used even though autocompletion popups use <code>json lines</code>:</p>
<p><img src="https://github.com/user-attachments/assets/15f9e26c-64dd-4c02-bc27-a274c6ecea5a" alt="" /></p>
<p>Notably, this rule applies to some languages but not others (though Ruff doesn't need to care about this):</p>
<p><img src="https://github.com/user-attachments/assets/10f475d7-3ad3-4692-a41a-97e193d104ee" alt="" /></p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 20:51:27 UTC
    </footer>
</body>
</html>
