```yaml
number: 6814
title: "Extend `BestFitting` with `mode`"
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: re-introduce-mode-for-best-fitting
created_at: 2023-08-23T12:10:05Z
updated_at: 2023-08-24T10:14:11Z
url: https://github.com/astral-sh/ruff/pull/6814
synced_at: 2026-01-12T02:45:38Z
```

# Extend `BestFitting` with `mode`

---

_Pull request opened by @MichaReiser on 2023-08-23 12:10_

## Summary

This PR brings back the best fitting mode first introduced by https://github.com/astral-sh/ruff/pull/5184 and later reverted by https://github.com/astral-sh/ruff/commit/9a8ba58b4cbb2dcbebfe1397ebdb867b641e30ce because it was no longer necessary for the binary expression formatting. 

This PR re-introduces the `BestFitting` mode to implement Black's behavior to only parenthesize non-breakable expressions if it makes them fit https://github.com/astral-sh/ruff/issues/6271. 

```python
x = aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
x_aaaa = aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa

# Output
x = aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
x_aaaa = (
	aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
)
```

This layout needs Best Fitting because with the new mode because

* it has three variations (not just two): flat, with parentheses, and flat as fallback
* Best fitting by default assumes that the content fits when reaching the first line break. This doesn't work for this use case because we need to measure if all content up to the `)` fits (this is kind of the point)



## Test Plan

Re-added tests. Used by the stacked PRs


---

_Comment by @MichaReiser on 2023-08-23 12:10_

Current dependencies on/for this PR:
* main
  * **PR #6814** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6814" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #6815** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6815" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #6816** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6816" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #6817** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6817" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #6848** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6848" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #6819** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6819" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6814?utm_source=stack-comment).

---

_Comment by @github-actions[bot] on 2023-08-23 12:36_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      4.0Â±0.19ms    10.1 MB/sec    1.00      4.0Â±0.12ms    10.1 MB/sec
formatter/numpy/ctypeslib.py               1.00   835.9Â±40.45Âµs    19.9 MB/sec    1.02   854.6Â±59.01Âµs    19.5 MB/sec
formatter/numpy/globals.py                 1.01     83.7Â±3.42Âµs    35.2 MB/sec    1.00     82.5Â±3.50Âµs    35.8 MB/sec
formatter/pydantic/types.py                1.01  1662.0Â±83.73Âµs    15.3 MB/sec    1.00  1650.3Â±50.47Âµs    15.5 MB/sec
linter/all-rules/large/dataset.py          1.00     12.3Â±0.27ms     3.3 MB/sec    1.01     12.4Â±0.32ms     3.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.3Â±0.10ms     5.1 MB/sec    1.00      3.2Â±0.06ms     5.1 MB/sec
linter/all-rules/numpy/globals.py          1.02   482.4Â±21.24Âµs     6.1 MB/sec    1.00   473.3Â±16.10Âµs     6.2 MB/sec
linter/all-rules/pydantic/types.py         1.01      6.5Â±0.19ms     3.9 MB/sec    1.00      6.4Â±0.15ms     4.0 MB/sec
linter/default-rules/large/dataset.py      1.01      6.6Â±0.13ms     6.2 MB/sec    1.00      6.5Â±0.15ms     6.2 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1434.9Â±53.55Âµs    11.6 MB/sec    1.00  1434.4Â±51.23Âµs    11.6 MB/sec
linter/default-rules/numpy/globals.py      1.00    174.2Â±6.46Âµs    16.9 MB/sec    1.02    177.0Â±9.12Âµs    16.7 MB/sec
linter/default-rules/pydantic/types.py     1.02      3.0Â±0.09ms     8.6 MB/sec    1.00      2.9Â±0.07ms     8.7 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01      3.0Â±0.04ms    13.4 MB/sec    1.00      3.0Â±0.02ms    13.5 MB/sec
formatter/numpy/ctypeslib.py               1.00    574.8Â±8.43Âµs    29.0 MB/sec    1.01    578.6Â±8.48Âµs    28.8 MB/sec
formatter/numpy/globals.py                 1.00     58.0Â±0.78Âµs    50.9 MB/sec    1.02     59.3Â±1.27Âµs    49.7 MB/sec
formatter/pydantic/types.py                1.00  1206.5Â±16.21Âµs    21.1 MB/sec    1.00  1202.1Â±15.30Âµs    21.2 MB/sec
linter/all-rules/large/dataset.py          1.00      9.4Â±0.19ms     4.3 MB/sec    1.02      9.6Â±0.10ms     4.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      2.6Â±0.06ms     6.3 MB/sec    1.02      2.7Â±0.04ms     6.2 MB/sec
linter/all-rules/numpy/globals.py          1.00    272.1Â±7.74Âµs    10.8 MB/sec    1.02    277.9Â±9.48Âµs    10.6 MB/sec
linter/all-rules/pydantic/types.py         1.00      4.9Â±0.17ms     5.2 MB/sec    1.01      5.0Â±0.13ms     5.1 MB/sec
linter/default-rules/large/dataset.py      1.00      5.2Â±0.09ms     7.8 MB/sec    1.01      5.2Â±0.06ms     7.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1073.7Â±17.95Âµs    15.5 MB/sec    1.02  1100.2Â±21.05Âµs    15.1 MB/sec
linter/default-rules/numpy/globals.py      1.00    108.5Â±1.53Âµs    27.2 MB/sec    1.00    108.8Â±1.64Âµs    27.1 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.4Â±0.03ms    10.7 MB/sec    1.00      2.4Â±0.03ms    10.7 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Renamed from "Re-introduce mode for `BestFitting`" to "Extend `BestFitting` with `mode`" by @MichaReiser on 2023-08-23 13:34_

---

_Label `formatter` added by @MichaReiser on 2023-08-23 13:38_

---

_Review comment by @MichaReiser on `crates/ruff_benchmark/benches/formatter.rs`:54 on 2023-08-23 13:39_

I got very flacky results without this. 

---

_@MichaReiser reviewed on 2023-08-23 13:39_

---

_Marked ready for review by @MichaReiser on 2023-08-23 13:40_

---

_Comment by @MichaReiser on 2023-08-23 15:23_

I'll merge this without review. You already reviewed the original PR

---

_Merged by @MichaReiser on 2023-08-23 15:23_

---

_Closed by @MichaReiser on 2023-08-23 15:23_

---

_Branch deleted on 2023-08-23 15:23_

---
