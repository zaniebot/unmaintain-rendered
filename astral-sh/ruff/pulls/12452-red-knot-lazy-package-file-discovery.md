```yaml
number: 12452
title: "[red-knot] Lazy package file discovery"
type: pull_request
state: merged
author: MichaReiser
labels:
  - ty
assignees: []
merged: true
base: main
head: lazy-files
created_at: 2024-07-22T13:12:46Z
updated_at: 2024-07-23T08:56:46Z
url: https://github.com/astral-sh/ruff/pull/12452
synced_at: 2026-01-10T21:47:02Z
```

# [red-knot] Lazy package file discovery

---

_Pull request opened by @MichaReiser on 2024-07-22 13:12_

## Summary
This PR changes the package file discovery from being done eagerly when loading the workspace to lazily when the files are first needed (e.g. because `workspace.check` is called). 

Implementing lazy discovery is a bit tricky because we don't want to throw away all discovered files when a new file watch event comes in. Instead, 
we want to update the workspace files in-place and tell Salsa that the files have changed. 

This PR uses an approach that uses internal mutability to achieve this while guaranteeing that the package files from one salsa revision don't compare equal to the same files in the next salsa revision (unless they are 100% equal).

## Test Plan

Updated integration tests.


---

_Review requested from @carljm by @MichaReiser on 2024-07-22 13:12_

---

_Review requested from @AlexWaygood by @MichaReiser on 2024-07-22 13:12_

---

_Label `red-knot` added by @MichaReiser on 2024-07-22 13:13_

---

_Comment by @github-actions[bot] on 2024-07-22 13:32_

<!-- generated-comment ecosystem -->
## `ruff-ecosystem` results
### Linter (stable)
✅ ecosystem check detected no linter changes.

### Linter (preview)
✅ ecosystem check detected no linter changes.




---

_Review comment by @carljm on `crates/red_knot/src/db.rs`:25 on 2024-07-22 22:08_

Is this name referring to something generated by Salsa macros which lets us reference `Package::files` as an ingredient?

---

_Review comment by @carljm on `crates/red_knot/src/workspace.rs`:245 on 2024-07-22 22:10_

I don't understand what it means for `Package` to be a Salsa input, but the impl of `Package` to be `[salsa::tracked]`.

---

_Review comment by @carljm on `crates/red_knot/src/workspace/files.rs`:113 on 2024-07-22 22:37_

```suggestion
/// whenever the files are changed. The revision ensures that salsa's comparison of the
```

---

_Review comment by @carljm on `crates/red_knot/src/workspace/files.rs`:19 on 2024-07-22 23:04_

Can we make this comment clearer and more concrete? I think I understand it now, after poring over this PR for a while, but without having taken that time I think I would be scared by this comment but confused about how to actually follow it correctly.

I think that the practical upshot is that changes to `PackageFiles` (and the `IndexedFiles` that it references via its `State`) must only be made via `IndexedFilesMut`, which takes care to go through `Package::set_file_set` (the Salsa setter) to update to a new `PackageFiles` with updated revision, so that Salsa knows about the change.

```suggestion
/// without triggering a new salsa revision. This is safe because the initial indexing happens on first access,
/// so no query can be depending on the contents of the indexed files before that. All subsequent mutations to
/// the indexed files must go through `IndexedFilesMut`, which uses the Salsa setter `package.set_file_set` to
/// ensure that Salsa always knows when the set of indexed files have changed.
```

---

_@carljm approved on 2024-07-22 23:06_

Nice! This is definitely subtle; I spent a while trying to understand all the different things named `*Files` and how they relate: `PackageFiles`, `IndexedFiles`, `LazyFiles`, and just `Files` -- and that's not even considering the `Files` struct over in `ruff_db`. I do wonder if there might be some naming that would make it clearer (particularly `Files` seems like it would be a core data structure given its name, but really it's just an ephemeral wrapper around a `MutexGuard` to allow updating it), but I didn't come up with any proposals that seemed like a clear improvement.

---

_@MichaReiser reviewed on 2024-07-23 06:20_

---

_Review comment by @MichaReiser on `crates/red_knot/src/db.rs`:25 on 2024-07-23 06:20_

It's salsa's notation for a query that's defined as a method. 

---

_@MichaReiser reviewed on 2024-07-23 06:20_

---

_Review comment by @MichaReiser on `crates/red_knot/src/workspace.rs`:245 on 2024-07-23 06:20_

It doesn't do anything to the impl itself but it allows methods that are marked as `salsa::tracked` -> methods can be queries.

---

_Merged by @MichaReiser on 2024-07-23 08:47_

---

_Closed by @MichaReiser on 2024-07-23 08:47_

---

_Branch deleted on 2024-07-23 08:47_

---

_Comment by @codspeed-hq[bot] on 2024-07-23 08:48_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/lazy-files)

### Merging #12452 will **improve performances by 4.26%**

<sub>Comparing <code>lazy-files</code> (f530e33) with <code>lazy-files</code> (e36aaf3)</sub>



### Summary

`⚡ 1` improvements
`✅ 32` untouched benchmarks




### Benchmarks breakdown

|     | Benchmark | `lazy-files` | `lazy-files` | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ⚡ | `lexer[numpy/globals.py]` | 30.4 µs | 29.2 µs | +4.26% |


---
