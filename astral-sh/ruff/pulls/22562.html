<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] `struct.unpack` return type inference - astral-sh/ruff #22562</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] <code>struct.unpack</code> return type inference</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22562">#22562</a>
        opened by <a href="https://github.com/sakgoyal">@sakgoyal</a>
        on 2026-01-13 22:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sakgoyal">@sakgoyal</a></div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ty/issues/2437</p>
<h2>Summary</h2>
<p>Allow the checker to analyze the format string for <code>struct.unpack</code> to ensure correct types are generated instead of <code>Any</code>.</p>
<h2>Test Plan</h2>
<p>Added mdtest cases from original issue.</p>
<blockquote>
<p>NOTE: the code in <code>types/call/bind.rs</code> was written by AI. the rest was written by me.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sakgoyal on 2026-01-13 22:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @sakgoyal on 2026-01-13 22:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sakgoyal on 2026-01-13 22:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @Gankra by @sakgoyal on 2026-01-13 22:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @sakgoyal on 2026-01-13 22:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @sakgoyal on 2026-01-13 22:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "`struct.unpack` Implementation attempt (with AI)" to "`struct.unpack` return type inference" by @sakgoyal on 2026-01-13 22:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-13 23:02</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2><a href="https://github.com/python/typing/blob/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance/">Typing conformance results</a></h2>
<p>No changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-13 23:03</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">dulwich (https://github.com/dulwich/dulwich)
+ dulwich/index.py:810:20: error[invalid-argument-type] Argument to function `sha_to_hex` is incorrect: Expected `RawObjectID`, found `bytes`
- Found 230 diagnostics
+ Found 231 diagnostics

tornado (https://github.com/tornadoweb/tornado)
- tornado/gen.py:255:62: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `None | Awaitable[Unknown] | list[Awaitable[Unknown]] | dict[Any, Awaitable[Unknown]] | Future[Unknown]`, found `_T@next | _T@next | _VT@next`
+ tornado/gen.py:255:62: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `None | Awaitable[Unknown] | list[Awaitable[Unknown]] | dict[Any, Awaitable[Unknown]] | Future[Unknown]`, found `_T@next | _VT@next | _T@next`
- tornado/websocket.py:1220:51: error[invalid-argument-type] Argument to bound method `_handle_message` is incorrect: Expected `int`, found `Any | None`
+ tornado/websocket.py:1220:51: error[invalid-argument-type] Argument to bound method `_handle_message` is incorrect: Expected `int`, found `Unknown | int | None`

manticore (https://github.com/trailofbits/manticore)
+ manticore/wasm/executor.py:1194:14: error[invalid-assignment] Object of type `int` is not assignable to `F32`
+ manticore/wasm/executor.py:1202:14: error[invalid-assignment] Object of type `int` is not assignable to `F64`
+ manticore/wasm/executor.py:1505:14: error[invalid-assignment] Object of type `float` is not assignable to `I32`
+ manticore/wasm/executor.py:1513:14: error[invalid-assignment] Object of type `float` is not assignable to `I64`
- Found 11070 diagnostics
+ Found 11074 diagnostics

pywin32 (https://github.com/mhammond/pywin32)
- win32/Demos/win32gui_menu.py:434:67: error[invalid-argument-type] Argument to function `ExtTextOut` is incorrect: Expected `PyRECT`, found `tuple[Any, Any, Any, Any]`
+ win32/Demos/win32gui_menu.py:434:67: error[invalid-argument-type] Argument to function `ExtTextOut` is incorrect: Expected `PyRECT`, found `tuple[int, int, int, int]`
+ win32/Lib/win32gui_struct.py:946:41: error[invalid-argument-type] Argument to function `IID` is incorrect: Expected `str`, found `bytes`
+ win32/Lib/win32gui_struct.py:950:41: error[invalid-argument-type] Argument to function `IID` is incorrect: Expected `str`, found `bytes`
- Found 2694 diagnostics
+ Found 2696 diagnostics

static-frame (https://github.com/static-frame/static-frame)
- static_frame/core/bus.py:671:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[Bus[Any], object_]`, found `InterGetItemLocReduces[Bus[Any] | Bottom[Index[Any]] | Bottom[Series[Any, Any]] | ... omitted 6 union elements, object_]`
+ static_frame/core/bus.py:671:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[Bus[Any], object_]`, found `InterGetItemLocReduces[Bus[Any] | Bottom[Series[Any, Any]] | ndarray[Never, Never] | ... omitted 6 union elements, object_]`
- static_frame/core/bus.py:675:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Bus[Any], object_]`, found `InterGetItemILocReduces[Bus[Any] | Bottom[Index[Any]] | Bottom[Series[Any, Any]] | ... omitted 6 union elements, object_ | Self@iloc]`
+ static_frame/core/bus.py:675:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Bus[Any], object_]`, found `InterGetItemILocReduces[Bus[Any] | Bottom[Index[Any]] | TypeBlocks | ... omitted 6 union elements, object_ | Self@iloc]`
- static_frame/core/node_selector.py:526:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[TVContainer_co@InterfaceSelectQuartet, Any]`, found `InterGetItemLocReduces[Unknown | Bottom[Series[Any, Any]], Any]`
+ static_frame/core/node_selector.py:526:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[TVContainer_co@InterfaceSelectQuartet, Any]`, found `InterGetItemLocReduces[Bottom[Series[Any, Any]] | Unknown, Any]`
+ static_frame/core/series.py:772:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Series[Any, Any], TVDtype@Series]`, found `InterGetItemILocReduces[Series[Any, Any] | Bottom[Index[Any]] | TypeBlocks | ... omitted 6 union elements, TVDtype@Series]`
- static_frame/core/series.py:4072:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[SeriesHE[Any, Any], TVDtype@SeriesHE]`, found `InterGetItemILocReduces[Bottom[Series[Any, Any]] | ndarray[Never, Never] | TypeBlocks | ... omitted 7 union elements, TVDtype@SeriesHE]`
+ static_frame/core/series.py:4072:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[SeriesHE[Any, Any], TVDtype@SeriesHE]`, found `InterGetItemILocReduces[Bottom[Series[Any, Any]] | Bottom[Index[Any]] | TypeBlocks | ... omitted 7 union elements, TVDtype@SeriesHE]`
- static_frame/core/yarn.py:418:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Yarn[Any], object_]`, found `InterGetItemILocReduces[Bottom[Series[Any, Any]] | Yarn[Any] | ndarray[Never, Never] | ... omitted 6 union elements, object_]`
+ static_frame/core/yarn.py:418:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Yarn[Any], object_]`, found `InterGetItemILocReduces[Yarn[Any] | Bottom[Index[Any]] | TypeBlocks | ... omitted 6 union elements, object_]`
- Found 1824 diagnostics
+ Found 1825 diagnostics

rotki (https://github.com/rotki/rotki)
- rotkehlchen/chain/decoding/tools.py:96:44: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- rotkehlchen/chain/decoding/tools.py:99:13: error[invalid-argument-type] Argument to function `decode_transfer_direction` is incorrect: Expected `Sequence[A@BaseDecoderTools]`, found `Unknown | tuple[BTCAddress, ...] | tuple[ChecksumAddress, ...] | tuple[SubstrateAddress, ...] | tuple[SolanaAddress, ...]`
- rotkehlchen/chain/decoding/tools.py:100:62: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
+ rotkehlchen/chain/decoding/tools.py:97:13: error[invalid-argument-type] Argument to function `decode_transfer_direction` is incorrect: Expected `BTCAddress | ChecksumAddress | SubstrateAddress | SolanaAddress`, found `A@BaseDecoderTools`
+ rotkehlchen/chain/decoding/tools.py:98:13: error[invalid-argument-type] Argument to function `decode_transfer_direction` is incorrect: Expected `BTCAddress | ChecksumAddress | SubstrateAddress | SolanaAddress | None`, found `A@BaseDecoderTools | None`
- Found 2057 diagnostics
+ Found 2056 diagnostics


</code></pre>
</details>

<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2026-01-13 23:16</div>
            <div class="timeline-body"><p>Thanks! Please take a look at https://github.com/astral-sh/ruff/blob/main/crates/ty/CONTRIBUTING.md for help with resolving the CI failures. Looks like prek and clippy are failing, as well as the new mdtests you added. Putting the PR back in draft; please mark it ready for review once CI is green.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @carljm on 2026-01-13 23:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sakgoyal">@sakgoyal</a> on 2026-01-14 02:09</div>
            <div class="timeline-body"><p>Will CI run in draft mode?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-14 02:09</div>
            <div class="timeline-body"><p>Yeah.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @sakgoyal on 2026-01-14 02:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @ntBre on 2026-01-14 14:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @AlexWaygood on 2026-01-15 15:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "`struct.unpack` return type inference" to "[ty] `struct.unpack` return type inference" by @AlexWaygood on 2026-01-16 11:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/oconnor663">@oconnor663</a> reviewed on 2026-01-16 19:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/oconnor663">@oconnor663</a> on <code>crates/ty_python_semantic/src/types/call/bind.rs</code>:1260 on 2026-01-16 19:02</div>
            <div class="timeline-body"><p>This loop should probably be bounded to some reasonable limit, and beyond that we should fall back to some other type? Currently I can exhaust all the memory on my machine and get <code>ty</code> OOM killed by checking this :)</p>
<pre><code class="language-py">def _(buf: bytes):
    reveal_type(struct.unpack(&quot;18446744073709551616c&quot;, buf))
</code></pre>
<p>Whatever we choose to do about this, it would make a good extra test case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sakgoyal">@sakgoyal</a> reviewed on 2026-01-16 23:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sakgoyal">@sakgoyal</a> on <code>crates/ty_python_semantic/src/types/call/bind.rs</code>:1260 on 2026-01-16 23:18</div>
            <div class="timeline-body"><p>thats a good point. maybe we put a limit at say 2^16? if it exceeds that, set the type to <code>Unknown</code>?</p>
<p>eg:</p>
<pre><code>reveal_type(struct.unpack(&quot;18446744073709551616c&quot;, buf))
reveal_type(struct.unpack(&quot;@i18446744073709551616c&quot;, buf))
</code></pre>
<p>should return <code>tuple[Unknown]</code>, <code>Unknown</code>, or <code>Any</code>?</p>
<p>i'm ok with either option, though i'd prefer <code>tuple[Unknown]</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dscorbett">@dscorbett</a> reviewed on 2026-01-17 00:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dscorbett">@dscorbett</a> on <code>crates/ty_python_semantic/src/types/call/bind.rs</code>:1260 on 2026-01-17 00:17</div>
            <div class="timeline-body"><p>It could also be a <code>tuple[bytes, ...]</code>, ignoring the count but keeping the type. Similarly, <code>struct.unpack(&quot;18446744073709551616c?&quot;, buf)</code> could be a <code>tuple[bytes | bool, ...]</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2026-01-17 01:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/call/bind.rs</code>:1260 on 2026-01-17 01:51</div>
            <div class="timeline-body"><p>I think it is not super important how precise the fallback type is in this edge case. Feel free to use the most precise fallback type that is definitely correct and doesn't require a lot of additional work to implement.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sakgoyal">@sakgoyal</a> reviewed on 2026-01-17 08:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sakgoyal">@sakgoyal</a> on <code>crates/ty_python_semantic/src/types/call/bind.rs</code>:1260 on 2026-01-17 08:01</div>
            <div class="timeline-body"><p>I did a quick and dirty fix. I think it's probably fine, but I dont know rust well enough to know how to do this properly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sakgoyal">@sakgoyal</a> on 2026-01-17 08:01</div>
            <div class="timeline-body"><p>Rolled up into 1 commit to make git history nicer if this gets merged</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2026-01-19 11:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types/call/bind.rs</code>:1245 on 2026-01-19 11:53</div>
            <div class="timeline-body"><p>Should we error / early return if we see any unsupported/unknown format specifiers?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-19 12:23:06 UTC
    </footer>
</body>
</html>
