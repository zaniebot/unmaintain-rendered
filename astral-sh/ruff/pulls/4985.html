<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Correctly handle left/right breaking of binary expression - astral-sh/ruff #4985</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Correctly handle left/right breaking of binary expression</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4985">#4985</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-06-09 16:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">

Summary
<p>Black supports for layouts when it comes to breaking binary expressions:</p>
<pre><code>#[derive(Copy, Clone, Debug, Eq, PartialEq)]
enum BinaryLayout {
    /// Put each operand on their own line if either side expands
    Default,

    /// Try to expand the left to make it fit. Add parentheses if the left or right don&#x27;t fit.
    ///
    ///```python
    /// [
    ///     a,
    ///     b
    /// ] &amp; c
    ///```
    ExpandLeft,

    /// Try to expand the right to make it fix. Add parentheses if the left or right don&#x27;t fit.
    ///
    /// ```python
    /// a &amp; [
    ///     b,
    ///     c
    /// ]
    /// ```
    ExpandRight,

    /// Both the left and right side can be expanded. Try in the following order:
    /// * expand the right side
    /// * expand the left side
    /// * expand both sides
    ///
    /// to make the expression fit
    ///
    /// ```python
    /// [
    ///     a,
    ///     b
    /// ] &amp; [
    ///     c,
    ///     d
    /// ]
    /// ```
    ExpandRightThenLeft,
}
</code></pre>
<p>Our current implementation only handles <code>ExpandRight</code> and <code>Default</code> correctly. This PR adds support for <code>ExpandRightThenLeft</code> and <code>ExpandLeft</code>.</p>
Test Plan
<p>I added tests that play through all 4 binary expression layouts.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-09 16:09</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #5184</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5184"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite"></a><ul>
<li><strong>PR #5205</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5205"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite"></a><ul>
<li><strong>PR #4985</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4985"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite"></a>  ðŸ‘ˆ<ul>
<li><strong>PR #5207</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5207"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite"></a><ul>
<li><strong>PR #4986</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4986"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite"></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4985?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Fix more binop line break&quot; to &quot;Correctly handle left/right breaking of binary expression&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-09 16:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_bin_op.rs</code>:75 on 2023-06-09 16:20</div>
            <div class="timeline-body"><p>Unchanged, moved up</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_bin_op.rs</code>:141 on 2023-06-09 16:20</div>
            <div class="timeline-body"><p>Unchanged</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_bin_op.rs</code>:153 on 2023-06-09 16:21</div>
            <div class="timeline-body"><p>The formatter breaks group-sequences from right to left, so that works just fine</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-06-09 16:41</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>âœ… ecosystem check detected no changes.</p>
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      6.5Â±0.02ms     6.3 MB/sec    1.00      6.4Â±0.01ms     6.3 MB/sec
formatter/numpy/ctypeslib.py               1.03   1362.0Â±2.58Âµs    12.2 MB/sec    1.00   1323.2Â±1.41Âµs    12.6 MB/sec
formatter/numpy/globals.py                 1.01    131.9Â±0.86Âµs    22.4 MB/sec    1.00    130.1Â±0.24Âµs    22.7 MB/sec
formatter/pydantic/types.py                1.02      2.7Â±0.01ms     9.5 MB/sec    1.00      2.6Â±0.02ms     9.7 MB/sec
linter/all-rules/large/dataset.py          1.00     13.1Â±0.04ms     3.1 MB/sec    1.00     13.1Â±0.04ms     3.1 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.3Â±0.00ms     5.0 MB/sec    1.00      3.3Â±0.00ms     5.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    424.8Â±0.49Âµs     6.9 MB/sec    1.00    424.6Â±1.95Âµs     6.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.8Â±0.01ms     4.4 MB/sec    1.00      5.8Â±0.01ms     4.4 MB/sec
linter/default-rules/large/dataset.py      1.01      6.7Â±0.02ms     6.1 MB/sec    1.00      6.6Â±0.01ms     6.2 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01   1473.3Â±2.73Âµs    11.3 MB/sec    1.00   1463.3Â±2.23Âµs    11.4 MB/sec
linter/default-rules/numpy/globals.py      1.01    166.7Â±0.45Âµs    17.7 MB/sec    1.00    165.5Â±0.35Âµs    17.8 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.1Â±0.01ms     8.3 MB/sec    1.00      3.0Â±0.01ms     8.4 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                    pr
-----                                      ----                                    --
formatter/large/dataset.py                 1.00     11.1Â±0.85ms     3.7 MB/sec     1.03     11.3Â±0.54ms     3.6 MB/sec
formatter/numpy/ctypeslib.py               1.00  1938.6Â±224.37Âµs     8.6 MB/sec    1.09      2.1Â±0.05ms     7.9 MB/sec
formatter/numpy/globals.py                 1.00   177.0Â±11.00Âµs    16.7 MB/sec     1.30   229.6Â±29.17Âµs    12.9 MB/sec
formatter/pydantic/types.py                1.00      3.8Â±0.44ms     6.8 MB/sec     1.15      4.3Â±0.22ms     5.9 MB/sec
linter/all-rules/large/dataset.py          1.14     20.3Â±1.57ms     2.0 MB/sec     1.00     17.8Â±1.01ms     2.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.18      5.4Â±0.51ms     3.1 MB/sec     1.00      4.6Â±0.23ms     3.7 MB/sec
linter/all-rules/numpy/globals.py          1.00   654.3Â±38.63Âµs     4.5 MB/sec     1.03   677.1Â±27.34Âµs     4.4 MB/sec
linter/all-rules/pydantic/types.py         1.11      8.8Â±0.40ms     2.9 MB/sec     1.00      7.9Â±0.62ms     3.2 MB/sec
linter/default-rules/large/dataset.py      1.00     11.2Â±0.74ms     3.6 MB/sec     1.04     11.6Â±0.52ms     3.5 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01      2.4Â±0.21ms     7.0 MB/sec     1.00      2.4Â±0.10ms     7.1 MB/sec
linter/default-rules/numpy/globals.py      1.02   290.7Â±24.63Âµs    10.1 MB/sec     1.00   285.0Â±17.19Âµs    10.4 MB/sec
linter/default-rules/pydantic/types.py     1.00      5.0Â±0.29ms     5.1 MB/sec     1.01      5.0Â±0.23ms     5.1 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-09 16:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-09 16:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_bin_op.rs</code>:88 on 2023-06-09 16:44</div>
            <div class="timeline-body"><p>The problem is that this group may now be, incorrectly, printed in flat mode if it happens that the printer measures the most outer group and that happens to fit. This is because the printer only computes <em>fits</em> ones per line and, when true, assumes that all following groups up to the next line break fit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-19 15:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-19 15:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-19 15:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_formatter/src/format_element.rs</code>:331 on 2023-06-19 15:34</div>
            <div class="timeline-body"><p>I couldn&#x27;t add <code>mode</code> here because it would increase the size of the struct to 24 bytes which, in turn, would increase the size of <code>FormatElement</code> from 24 to 32 bytes. Adding <code>mode</code> inline avoids the size increase</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-19 15:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_formatter/src/printer/mod.rs</code>:147 on 2023-06-19 15:35</div>
            <div class="timeline-body"><p>I struggled with the <code>!group.mode().is_flat</code> and decided to use <code>match</code> statements to make the branching more explicit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-19 15:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/mod.rs</code>:274 on 2023-06-19 15:56</div>
            <div class="timeline-body"><p>These changes are unrelated but I got annoyed by calling <code>.into()</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-19 15:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-19 15:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/expr_bin_op.rs</code>:322 on 2023-06-20 16:06</div>
            <div class="timeline-body"><p>Shouldn&#x27;t this be <code>||</code>, e.g. we just need any kind of arguments to allow breaking?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/expr_bin_op.rs</code>:98 on 2023-06-20 16:09</div>
            <div class="timeline-body"><p>This formatting always looks kinda odd to me but i guess python doesn&#x27;t allow much better</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/expr_bin_op.rs</code>:119 on 2023-06-20 16:14</div>
            <div class="timeline-body"><p>i&#x27;m having trouble following this code, shouldn&#x27;t right breaks and if right is expanded but this is insufficient the whole thing should be parenthesized and indented?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/expr_bin_op.rs</code>:153 on 2023-06-20 16:47</div>
            <div class="timeline-body"><p>please add as a source code comment</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-06-20 16:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-21 07:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_bin_op.rs</code>:322 on 2023-06-21 07:04</div>
            <div class="timeline-body"><p>Nice catch, thanks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-06-21 07:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/expr_bin_op.rs</code>:119 on 2023-06-21 07:14</div>
            <div class="timeline-body"><p>I&#x27;m not entirely sure if I understand this comment.</p>
<p>The formatter measures the left group to see if it fits. It does that by measuring if all the content <em>up to</em> the first line break (soft or hard) in the right group (or whatever comes after) fits on a line. It doesn&#x27;t expand the left group if that&#x27;s the case.</p>
<p>This is is the behavior that we want. We want to expand the right first and not add parentheses in that case. We only want to add parentheses and indent the code if the left expands. That&#x27;s why <code>indent_if_group_breaks</code> and the <code>if_group_breaks</code> refer to the left group and not their enclosing group.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-21 07:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-21 07:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-06-21 07:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-21 07:40</div>
            <div class="timeline-body"><p>@MichaReiser merged this pull request with <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4985">Graphite</a>.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:54:23 UTC
    </footer>
</body>
</html>
