<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consume the escaped Windows newline (`\r\n`) for `FStringMiddle` - astral-sh/ruff #7722</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Consume the escaped Windows newline (<code>\r\n</code>) for <code>FStringMiddle</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7722">#7722</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2023-09-30 18:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body">Summary
<p>This PR fixes a bug where if a Windows newline (<code>\r\n</code>) character was escaped, then only the <code>\r</code> was consumed and not <code>\n</code> leading to an unterminated string error.</p>
Test Plan
<p>Add new test cases to check the newline escapes.</p>
<p>fixes: #7632</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-30 18:39</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #7724</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7724"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a><ul>
<li><strong>PR #7722</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7722"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite"></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7722?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-30 18:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2023-09-30 18:49</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/dhruv/fstring-eol">CodSpeed Performance Report</a>
Merging #7722 will <strong>improve performances by 6.63%</strong>
<p>Comparing <code>dhruv/fstring-eol</code> (297fa88) with <code>dhruv/string-escaped-eol</code> (cbe3f43)</p>
Summary
<p><code>âš¡ 5</code> improvements
<code>âœ… 20</code> untouched benchmarks</p>
Benchmarks breakdown
<p>|     | Benchmark | <code>dhruv/string-escaped-eol</code> | <code>dhruv/fstring-eol</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| âš¡ | <code>lexer[pydantic/types.py]</code> | 4.2 ms | 4 ms | +6.2% |
| âš¡ | <code>lexer[large/dataset.py]</code> | 9.5 ms | 8.9 ms | +6.63% |
| âš¡ | <code>lexer[unicode/pypinyin.py]</code> | 617.5 Âµs | 582.6 Âµs | +6% |
| âš¡ | <code>lexer[numpy/ctypeslib.py]</code> | 2 ms | 1.9 ms | +5.5% |
| âš¡ | <code>lexer[numpy/globals.py]</code> | 240.2 Âµs | 230.5 Âµs | +4.23% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-09-30 18:53</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>âœ… ecosystem check detected no changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Consume the escaped Windows newline (`\r\n`)&quot; to &quot;Consume the escaped Windows newline (`\r\n`) for `FStringMiddle`&quot; by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-30 19:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-30 19:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-09-30 19:21</div>
            <div class="timeline-body"><p>Does this also account for the \r case (carriage return without newline character)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-30 19:23</div>
            <div class="timeline-body"><blockquote>
<p>Does this also account for the \r case (carriage return without newline character)?</p>
</blockquote>
<p>Yes, you can confirm that in the snapshots.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/qarmin">@qarmin</a> on 2023-09-30 19:30</div>
            <div class="timeline-body"><p>Looks that this may also fix: (not reported yet, because I don&#x27;t have file that cause problem)</p>
<pre><code>...with the relevant file contents, the `pyproject.toml` settings, and the following stack trace, we&#x27;d be very appreciative!
panicked at &#x27;The content &#x27;integration_testing_environment.integration_testing_environment_ui. \
    menu.api_testka_menu.build_api_testka_menu&#x27; contains an unsupported &#x27;\r&#x27; line terminator character but text must only use line feeds &#x27;\n&#x27; as line separator. Use &#x27;\n&#x27; instead of &#x27;\r&#x27; and &#x27;\r\n&#x27; to insert a line break in strings.&#x27;, crates/ruff_formatter/src/builders.rs:406:5
Backtrace:    0: ruff_cli::panic::catch_unwind::{{closure}}
             at ./ruff/crates/ruff_cli/src/panic.rs:31:25
   1: &lt;alloc::boxed::Box&lt;F,A&gt; as core::ops::function::Fn&lt;Args&gt;&gt;::call
             at /rustc/d5c2e9c342b358556da91d61ed4133f6f50fc0c3/library/alloc/src/boxed.rs:2007:9
   2: std::panicking::rust_panic_with_hook
             at /rustc/d5c2e9c342b358556da91d61ed4133f6f50fc0c3/library/std/src/panicking.rs:709:13
   3: std::panicking::begin_panic_handler::{{closure}}
             at /rustc/d5c2e9c342b358556da91d61ed4133f6f50fc0c3/library/std/src/panicking.rs:597:13
   4: std::sys_common::backtrace::__rust_end_short_backtrace
             at /rustc/d5c2e9c342b358556da91d61ed4133f6f50fc0c3/library/std/src/sys_common/backtrace.rs:151:18
   5: rust_begin_unwind
             at /rustc/d5c2e9c342b358556da91d61ed4133f6f50fc0c3/library/std/src/panicking.rs:593:5
   6: core::panicking::panic_fmt
             at /rustc/d5c2e9c342b358556da91d61ed4133f6f50fc0c3/library/core/src/panicking.rs:67:14
   7: ruff_formatter::builders::debug_assert_no_newlines
             at ./ruff/crates/ruff_formatter/src/builders.rs:406:5
   8: &lt;ruff_formatter::builders::SourceTextSliceBuilder as ruff_formatter::Format&lt;Context&gt;&gt;::fmt
             at ./ruff/crates/ruff_formatter/src/builders.rs:392:9
   9: &lt;ruff_python_formatter::other::identifier::FormatIdentifier as ruff_formatter::FormatRule&lt;ruff_python_ast::nodes::Identifier,ruff_python_formatter::context::PyFormatContext&gt;&gt;::fmt
             at ./ruff/crates/ruff_python_formatter/src/other/identifier.rs:11:9
  10: &lt;ruff_formatter::FormatRefWithRule&lt;T,R,C&gt; as ruff_formatter::Format&lt;C&gt;&gt;::fmt
             at ./ruff/crates/ruff_formatter/src/lib.rs:608:9
  11: &lt;core::option::Option&lt;T&gt; as ruff_formatter::Format&lt;Context&gt;&gt;::fmt
             at ./ruff/crates/ruff_formatter/src/lib.rs:488:28
  12: ruff_formatter::arguments::Argument&lt;Context&gt;::new::formatter
             at ./ruff/crates/ruff_formatter/src/arguments.rs:43:13
  13: ruff_formatter::arguments::Argument&lt;Context&gt;::format
             at ./ruff/crates/ruff_formatter/src/arguments.rs:56:9
  14: &lt;ruff_formatter::formatter::Formatter&lt;Context&gt; as ruff_formatter::buffer::Buffer&gt;::write_fmt
             at ./ruff/crates/ruff_formatter/src/formatter.rs:220:22
  15: &lt;ruff_python_formatter::statement::stmt_import_from::FormatStmtImportFrom as ruff_python_formatter::FormatNodeRule&lt;ruff_python_ast::nodes::StmtImportFrom&gt;&gt;::fmt_fields
             at ./ruff/crates/ruff_python_formatter/src/statement/stmt_import_from.rs:27:9
  16: ruff_python_formatter::FormatNodeRule::fmt
             at ./ruff/crates/ruff_python_formatter/src/lib.rs:62:13
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-10-01 02:28</div>
            <div class="timeline-body"><blockquote>
<p>Looks that this may also fix: (not reported yet, because I don&#x27;t have file that cause problem)</p>
</blockquote>
<p>I&#x27;m not sure. Maybe if we can get the file content, then we&#x27;ll be able to diagnose correctly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-10-01 02:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-10-01 02:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-10-01 02:28</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:57:53 UTC
    </footer>
</body>
</html>
