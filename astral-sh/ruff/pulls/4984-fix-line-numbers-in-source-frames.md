```yaml
number: 4984
title: Fix line numbers in source frames
type: pull_request
state: merged
author: MichaReiser
labels: []
assignees: []
merged: true
base: main
head: fix-source-frame-line-numbers
created_at: 2023-06-09T14:02:15Z
updated_at: 2023-06-09T15:21:20Z
url: https://github.com/astral-sh/ruff/pull/4984
synced_at: 2026-01-12T03:43:29Z
```

# Fix line numbers in source frames

---

_Pull request opened by @MichaReiser on 2023-06-09 14:02_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This bug fixes that the line numbers are off by 1-2 lines when the code diff shows additional context lines before the line with the violation.

The way the source frame works is that it starts from the violating line and then tries to include up to two lines before, at least if they are not whitespace only. 

https://github.com/charliermarsh/ruff/blob/574a57d60634da3e9c68b7bfdc093b05b30486f3/crates/ruff/src/message/text.rs#L173-L182

The bug was that I incorrectly used the line number from `content_start_index` which is the line number of the violating line. Meaning, the row number is always off by the number of context lines shown above. 

The fix is easy, just use `start_index`. 


## Test Plan

I reviewed the `text` emitter snapshot diffs. 


---

_Comment by @MichaReiser on 2023-06-09 14:02_

Current dependencies on/for this PR:
* main
  * **PR #4984** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4984" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/4984?utm_source=stack-comment).

---

_Comment by @github-actions[bot] on 2023-06-09 14:10_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                    pr
-----                                      ----                                    --
formatter/large/dataset.py                 1.00      6.6Â±0.33ms     6.2 MB/sec     1.00      6.6Â±0.29ms     6.2 MB/sec
formatter/numpy/ctypeslib.py               1.05  1486.2Â±103.01Âµs    11.2 MB/sec    1.00  1410.7Â±110.55Âµs    11.8 MB/sec
formatter/numpy/globals.py                 1.00    132.2Â±5.73Âµs    22.3 MB/sec     1.09   144.7Â±14.72Âµs    20.4 MB/sec
formatter/pydantic/types.py                1.00      2.7Â±0.10ms     9.6 MB/sec     1.03      2.7Â±0.09ms     9.3 MB/sec
linter/all-rules/large/dataset.py          1.00     14.7Â±0.47ms     2.8 MB/sec     1.03     15.1Â±0.43ms     2.7 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.6Â±0.11ms     4.6 MB/sec     1.00      3.6Â±0.13ms     4.6 MB/sec
linter/all-rules/numpy/globals.py          1.02   458.1Â±20.01Âµs     6.4 MB/sec     1.00   447.7Â±21.05Âµs     6.6 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.3Â±0.26ms     4.0 MB/sec     1.00      6.3Â±0.35ms     4.0 MB/sec
linter/default-rules/large/dataset.py      1.06      7.1Â±0.17ms     5.7 MB/sec     1.00      6.7Â±0.23ms     6.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.05  1511.3Â±53.85Âµs    11.0 MB/sec     1.00  1443.8Â±54.72Âµs    11.5 MB/sec
linter/default-rules/numpy/globals.py      1.00    168.1Â±7.84Âµs    17.5 MB/sec     1.12   187.7Â±16.71Âµs    15.7 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.2Â±0.19ms     8.0 MB/sec     1.00      3.2Â±0.25ms     8.0 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      8.0Â±0.12ms     5.1 MB/sec    1.01      8.1Â±0.06ms     5.0 MB/sec
formatter/numpy/ctypeslib.py               1.00  1619.4Â±13.82Âµs    10.3 MB/sec    1.01  1628.1Â±15.97Âµs    10.2 MB/sec
formatter/numpy/globals.py                 1.00    158.0Â±1.58Âµs    18.7 MB/sec    1.01    159.9Â±2.90Âµs    18.5 MB/sec
formatter/pydantic/types.py                1.00      3.3Â±0.02ms     7.8 MB/sec    1.02      3.3Â±0.04ms     7.7 MB/sec
linter/all-rules/large/dataset.py          1.00     17.3Â±0.21ms     2.3 MB/sec    1.00     17.3Â±0.12ms     2.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.4Â±0.06ms     3.8 MB/sec    1.00      4.4Â±0.03ms     3.8 MB/sec
linter/all-rules/numpy/globals.py          1.00    442.8Â±7.29Âµs     6.7 MB/sec    1.00    441.0Â±8.88Âµs     6.7 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.5Â±0.10ms     3.4 MB/sec    1.00      7.5Â±0.17ms     3.4 MB/sec
linter/default-rules/large/dataset.py      1.01      8.7Â±0.08ms     4.7 MB/sec    1.00      8.6Â±0.10ms     4.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1789.5Â±14.44Âµs     9.3 MB/sec    1.00  1793.5Â±18.63Âµs     9.3 MB/sec
linter/default-rules/numpy/globals.py      1.01    190.4Â±2.00Âµs    15.5 MB/sec    1.00    188.5Â±1.87Âµs    15.7 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.9Â±0.03ms     6.5 MB/sec    1.00      3.9Â±0.04ms     6.5 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Review comment by @charliermarsh on `crates/ruff/src/message/text.rs`:218 on 2023-06-09 14:20_

Impressive work

---

_@charliermarsh approved on 2023-06-09 14:20_

---

_Marked ready for review by @MichaReiser on 2023-06-09 15:21_

---

_Merged by @MichaReiser on 2023-06-09 15:21_

---

_Closed by @MichaReiser on 2023-06-09 15:21_

---

_Branch deleted on 2023-06-09 15:21_

---
