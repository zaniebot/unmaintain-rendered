<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Differentiate between runtime and typing-time annotations - astral-sh/ruff #5575</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Differentiate between runtime and typing-time annotations</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5575">#5575</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-07-07 02:01
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-07-07 02:01</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>In Python, the annotations on <code>x</code> and <code>y</code> here have very different treatment:</p>
<pre><code class="language-python">def foo(x: int):
  y: int
</code></pre>
<p>The <code>int</code> in <code>x: int</code> is a runtime-required annotation, because <code>x</code> gets added to the function's <code>__annotations__</code>. You'll notice, for example, that this fails:</p>
<pre><code class="language-python">from typing import TYPE_CHECKING

if TYPE_CHECKING:
  from foo import Bar

def f(x: Bar):
  ...
</code></pre>
<p>Because <code>Bar</code> is required to be available at runtime, not just at typing time. Meanwhile, this succeeds:</p>
<pre><code class="language-python">from typing import TYPE_CHECKING

if TYPE_CHECKING:
  from foo import Bar

def f():
  x: Bar = 1

f()
</code></pre>
<p>(Both cases are fine if you use <code>from __future__ import annotations</code>.)</p>
<p>Historically, we've tracked those annotations that are <em>not</em> runtime-required via the semantic model's <code>ANNOTATION</code> flag. But annotations that <em>are</em> runtime-required have been treated as &quot;type definitions&quot; that aren't annotations.</p>
<p>This causes problems for the flake8-future-annotations rules, which try to detect whether adding <code>from __future__ import annotations</code> would <em>allow</em> you to rewrite a type annotation. We need to know whether we're in <em>any</em> type annotation, runtime-required or not, since adding <code>from __future__ import annotations</code> will convert any runtime-required annotation to a typing-only annotation.</p>
<p>This PR adds separate state to track these runtime-required annotations. The changes in the test fixtures are correct -- these were false negatives before.</p>
<p>Closes https://github.com/astral-sh/ruff/issues/5574.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-07-07 02:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @charliermarsh on 2023-07-07 02:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @charliermarsh on 2023-07-07 02:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2023-07-07 04:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-07-07 04:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-07-07 04:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-07-07 04:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 03:37:35 UTC
    </footer>
</body>
</html>
