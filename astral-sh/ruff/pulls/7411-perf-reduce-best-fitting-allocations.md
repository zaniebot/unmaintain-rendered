```yaml
number: 7411
title: "perf: Reduce best fitting allocations"
type: pull_request
state: merged
author: MichaReiser
labels:
  - performance
  - formatter
assignees: []
merged: true
base: main
head: best-fitting-reduce-allocations
created_at: 2023-09-15T16:25:45Z
updated_at: 2023-09-18T19:50:56Z
url: https://github.com/astral-sh/ruff/pull/7411
synced_at: 2026-01-12T02:39:10Z
```

# perf: Reduce best fitting allocations

---

_Pull request opened by @MichaReiser on 2023-09-15 16:25_

Let's try this again, now that we have more best fitting elements.

## Summary

This PR removes the number of allocations necessary when using `BestFitting`. 

Best fitting performs the following allocations today:

1. It allocates one `Vec` in which it stores all variants
2. For each variant, allocate a `Vec<FormatElement>` that stores the variant's IR elements

This PR eliminates 2. It uses `StartBestFittingEntry` and `EndBestFittingEntry` markers to identify the start/end of a variant. The outer vector is still required because it otherwise gets fairly complicated to identify the start/end of a variant in case we encounter nested best fittings. 

This won't have as much impact anymore when #7475 lands but we'll need best fitting to implement Black's preview string processing

## Test Plan

`cargo test`



---

_Comment by @codspeed-hq[bot] on 2023-09-15 16:34_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/best-fitting-reduce-allocations)

### Merging #7411 will **improve performances by 7.76%**

<sub>Comparing <code>best-fitting-reduce-allocations</code> (441a75f) with <code>main</code> (2421805)</sub>



### Summary

`âš¡ 4` improvements
`âœ… 21` untouched benchmarks




### Benchmarks breakdown

|     | Benchmark | `main` | `best-fitting-reduce-allocations` | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| âš¡ | `formatter[unicode/pypinyin.py]` | 3.8 ms | 3.6 ms | +3.21% |
| âš¡ | `formatter[large/dataset.py]` | 61.7 ms | 57.3 ms | +7.76% |
| âš¡ | `formatter[pydantic/types.py]` | 21.4 ms | 20.8 ms | +3.18% |
| âš¡ | `formatter[numpy/ctypeslib.py]` | 11.1 ms | 10.7 ms | +3.64% |


---

_Comment by @MichaReiser on 2023-09-16 17:53_

Current dependencies on/for this PR:
* main
  * **PR #7411** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7411" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #7443** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7443" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7411?utm_source=stack-comment).

---

_Label `performance` added by @MichaReiser on 2023-09-16 18:19_

---

_Label `formatter` added by @MichaReiser on 2023-09-16 18:19_

---

_Marked ready for review by @MichaReiser on 2023-09-16 18:25_

---

_Review requested from @charliermarsh by @MichaReiser on 2023-09-18 16:19_

---

_Review requested from @konstin by @MichaReiser on 2023-09-18 16:19_

---

_@charliermarsh approved on 2023-09-18 17:07_

---

_Merged by @MichaReiser on 2023-09-18 19:49_

---

_Closed by @MichaReiser on 2023-09-18 19:49_

---

_Branch deleted on 2023-09-18 19:49_

---
