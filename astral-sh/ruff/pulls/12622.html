<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use uv workspaces instead of pip - astral-sh/ruff #12622</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use uv workspaces instead of pip</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/12622">#12622</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-08-02 09:09
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-02 09:09</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>I don't know what I'm doing and this doesn't work.</p>
<ul>
<li>The lock file looks okay?</li>
<li>I can't run any scripts because the dependencies don't seem to get installed</li>
<li>I'm probably doing something very wrong</li>
</ul>
<h2>Test Plan</h2>
<p>See contributing.md. I didn't get passed <code>uv sync</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2024-08-02 09:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/T-256">@T-256</a> on <code>docs/pyproject.toml</code>:21 on 2024-08-02 10:58</div>
            <div class="timeline-body"><ul>
<li>fixed <code>dependencies</code> under <code>project</code> table.</li>
<li>join dev-dependencies</li>
<li>add <code>requires-python</code></li>
<li>use upper bound instead of equality for dependencies. (lockfile will do version locks for us)</li>
</ul>
<pre><code class="language-suggestion">[project]
name = &quot;ruff-docs&quot;
version = &quot;0.0.0&quot;
dependencies = [
  &quot;PyYAML&gt;=6.0.1&quot;,
  &quot;mkdocs&gt;=1.5.0&quot;,
  &quot;mdformat&gt;=0.7.17&quot;,
  &quot;mdformat-mkdocs&gt;=2.0.4&quot;,
  &quot;mdformat-admon&gt;=2.0.2&quot;,
  &quot;mkdocs-material&gt;=9.1.18&quot;,
  &quot;mkdocs-redirects&gt;=1.2.1&quot;,
]
requires-python = &quot;&gt;=3.8&quot;

[build-system]
requires = [&quot;hatchling&quot;]
build-backend = &quot;hatchling.build&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/T-256">@T-256</a> on <code>docs/requirements-insiders.txt</code>:1 on 2024-08-02 10:58</div>
            <div class="timeline-body"><p>Why do we need to keep it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/T-256">@T-256</a> reviewed on 2024-08-02 11:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-08-02 11:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>docs/pyproject.toml</code>:21 on 2024-08-02 11:25</div>
            <div class="timeline-body"><p>lol, slightly emberassing :D Thanks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-08-02 11:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>docs/requirements-insiders.txt</code>:1 on 2024-08-02 11:26</div>
            <div class="timeline-body"><p>We use a custom version of mkdocs but external contributors don't have access to that repository. I don't know if there's a better way to support this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-02 12:43</div>
            <div class="timeline-body"><p>Can you clarify what's not working?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-02 12:50</div>
            <div class="timeline-body"><p>I can't run the mkdocs script because the dependencies are missing (I checked, they're not in my venv)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-02 12:53</div>
            <div class="timeline-body"><p>I'm not sure what you're running exactly but we need to mark Ruff as unmanaged. We don't want to be building Ruff to run scripts.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-02 13:34</div>
            <div class="timeline-body"><p>I try to run <code>uv run --verbose scripts/generate_mkdocs.py</code>. Overall, I try to get the workflow documented in the contributing.md to work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-02 13:47</div>
            <div class="timeline-body"><p>It's because the workspace members aren't declared as dependencies of the project.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-02 13:49</div>
            <div class="timeline-body"><p><code>uv run --package ruff-docs --verbose scripts/generate_mkdocs.py</code> does the right thing, but fails because <code>./docs</code> isn't a valid Python package (it needs <code>src/ruff_docs/__init__.py</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-02 13:50</div>
            <div class="timeline-body"><p>If you add this to <code>docs/pyproject.toml</code>, then <code>uv run --package ruff-docs -- scripts/generate_mkdocs.py </code> works:</p>
<pre><code class="language-toml">[tool.hatch.build.targets.wheel]
packages = [&quot;src/ruff_docs&quot;]
</code></pre>
<p>I think we should re-add that to <code>uv init</code>, it got dropped during code review.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-02 13:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>scripts/generate_mkdocs.py</code>:164 on 2024-08-02 13:58</div>
            <div class="timeline-body"><p>This was a breaking change in <code>mdformat-admon</code>, in the 2.0.3 release: https://github.com/KyleKing/mdformat-mkdocs/commit/6a329979e27da47a215607d4e30f61d22e683b89</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-02 13:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>CONTRIBUTING.md</code>:297 on 2024-08-02 13:58</div>
            <div class="timeline-body"><p>This seems off... Isn't that mismatched now?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-02 14:02</div>
            <div class="timeline-body"><p>Okay, I don't understand why I would have to declare <code>ruff_docs</code> as a package just so that the generate script can resolve <code>mdformat</code> :confused:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-08-02 14:18</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<details><summary><a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)</summary>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to parse examples/Chat_finetuning_data_prep.ipynb:6:18:25: Unparenthesized generator expression cannot be used here
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_confluence.ipynb:15:1:5: Simple statements must be separated by newlines or semicolons
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_gmail.ipynb:15:1:1: Expected an expression
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_jira.ipynb:15:1:1: Expected an expression
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_notion.ipynb:15:1:1: Expected an expression
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_sharepoint_doc.ipynb:28:1:5: Simple statements must be separated by newlines or semicolons
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_sharepoint_text.ipynb:28:1:5: Simple statements must be separated by newlines or semicolons
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_middleware_azure_function.ipynb:37:1:13: Simple statements must be separated by newlines or semicolons
</code></pre>
</p>
</details>

<h3>Formatter (preview)</h3>
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<details><summary><a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)</summary>
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to parse examples/Chat_finetuning_data_prep.ipynb:6:18:25: Unparenthesized generator expression cannot be used here
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_confluence.ipynb:15:1:5: Simple statements must be separated by newlines or semicolons
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_gmail.ipynb:15:1:1: Expected an expression
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_jira.ipynb:15:1:1: Expected an expression
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_notion.ipynb:15:1:1: Expected an expression
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_sharepoint_doc.ipynb:28:1:5: Simple statements must be separated by newlines or semicolons
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_sharepoint_text.ipynb:28:1:5: Simple statements must be separated by newlines or semicolons
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_middleware_azure_function.ipynb:37:1:13: Simple statements must be separated by newlines or semicolons
</code></pre>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-05 02:12</div>
            <div class="timeline-body"><p>Can you expand on your question?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-05 05:40</div>
            <div class="timeline-body"><p>It's more of an observation. I understand that the <code>packages</code> setting makes the listed package available to other packages. But the <code>generate_mkdocs</code> script doesn't depend on the <code>ruff_docs</code> package. It depends on some of its transitive dependencies.</p>
<p>That's why I think it odd that I have to add <code>ruff_docs</code> to <code>packages</code> just to make the script work. I could understand if I have to move the script into the <code>ruff_docs</code> directory to make it work (so that uv knows that it should run the script with additional third party dependencies).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-05 19:19</div>
            <div class="timeline-body"><p>@MichaReiser - I think part of the problem is that <code>ruff_docs</code> isn't really a package... An alternative is to make these all dev dependencies in the workspace root. Do you find that more intuitive?</p>
<pre><code class="language-diff">diff --git a/pyproject.toml b/pyproject.toml
index eeba1c160..1ab117188 100644
--- a/pyproject.toml
+++ b/pyproject.toml
@@ -8,7 +8,7 @@ version = &quot;0.5.6&quot;
 description = &quot;An extremely fast Python linter and code formatter, written in Rust.&quot;
 authors = [{ name = &quot;Astral Software Inc.&quot;, email = &quot;hey@astral.sh&quot; }]
 readme = &quot;README.md&quot;
-requires-python = &quot;&gt;=3.7&quot;
+requires-python = &quot;&gt;=3.8&quot;
 license = { file = &quot;LICENSE&quot; }
 keywords = [
   &quot;automation&quot;,
@@ -44,7 +44,18 @@ Documentation = &quot;https://docs.astral.sh/ruff/&quot;
 Changelog = &quot;https://github.com/astral-sh/ruff/blob/main/CHANGELOG.md&quot;

 [tool.uv.workspace]
-members = [&quot;docs&quot;, &quot;python/ruff-ecosystem&quot;]
+members = [&quot;python/ruff-ecosystem&quot;]
+
+[tool.uv]
+dev-dependencies = [
+  &quot;PyYAML&gt;=6.0.1&quot;,
+  &quot;mkdocs&gt;=1.5.0&quot;,
+  &quot;mdformat&gt;=0.7.17&quot;,
+  &quot;mdformat-mkdocs&gt;=2.0.4&quot;,
+  &quot;mdformat-admon&gt;=2.0.3&quot;,
+  &quot;mkdocs-material&gt;=9.1.18&quot;,
+  &quot;mkdocs-redirects&gt;=1.2.1&quot;,
+]

 [tool.maturin]
 bindings = &quot;bin&quot;
</code></pre>
<p>Then <code>uv run -- scripts/generate_mkdocs.py</code> works.</p>
<p>(I initially didn't realize that the script you were running wasn't part of <code>docs</code>.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/T-256">@T-256</a> on 2024-08-05 22:41</div>
            <div class="timeline-body"><p>Can I work on this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-06 05:51</div>
            <div class="timeline-body"><p>@charliermarsh I see. But let's pretend that <code>ruff_docs</code> is a package.</p>
<blockquote>
<p>An alternative is to make these all dev dependencies in the workspace root. Do you find that more intuitive?</p>
</blockquote>
<p>Kind of. With <code>lerna</code> I would have two options:</p>
<ol>
<li>Make it a workspace-level script</li>
<li>Move it into <code>ruff_docs</code> and make it a <code>ruff_docs</code> script</li>
</ol>
<p>To me it seems uv only supports 1. or what's the recommended way to run <code>generate_mkdocs.py</code> when declaring the dependency on the package level (let's pretend that <code>ruff_docs</code> is a real package)</p>
<p>@T-256 sure! Feel free to open a new PR. I then close this one</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-06 12:27</div>
            <div class="timeline-body"><p>@MichaReiser -- Genuinely trying to follow but I'm a little confused. For (2), you can add a <code>pyproject.toml</code> to <code>ruff_docs</code>, declare the dependencies in that <code>pyproject.toml</code>, and then run <code>uv run --package ruff-docs ./scripts/generate_mkdocs.py</code>. Isn't that the current state of this PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-08-06 12:55</div>
            <div class="timeline-body"><blockquote>
<p>Isn't that the current state of this PR?</p>
</blockquote>
<p>Not what's described in the <code>CONTRIBUTING.md</code>. So no. I wasn't aware that this is a possibility.</p>
<p>I think where the behavior of <code>uv run</code> differs from what I expected is that I expected <code>uv run ruff_docs/generate_mkdocs</code> to have the same behavior as <code>uv run -p ruff_docs ruff_docs/generate_mkdocs</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-06 12:56</div>
            <div class="timeline-body"><p>Oh I see, that running a script in the <code>ruff_docs</code> directory would behave equivalently to running a script <em>from</em> the <code>ruff_docs</code> directory.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-06 13:38</div>
            <div class="timeline-body"><p>Fwiw we do <code>uvx --with-requirements docs/requirements.txt -- mkdocs serve -f mkdocs.public.yml</code> in uv (but I know it's a little different over here)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-08-12 14:14</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 21:39:00 UTC
    </footer>
</body>
</html>
