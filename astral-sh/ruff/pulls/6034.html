<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Placement refactor - astral-sh/ruff #6034</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Placement refactor</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6034">#6034</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2023-07-24 15:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR is a refactoring of placement.rs. The code got more consistent, some comments were updated and some dead code was removed or replaced with debug assertions. It also contains a bugfix for the placement of end-of-branch comments with nested bodies inside try statements that occurred when refactoring the nested body loop.</p>
<h2>Test Plan</h2>
<p>The existing test cases don't change. I added a couple of cases that i think should be tested but weren't, and a regression test for the bugfix</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-07-24 15:30</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                    pr
-----                                      ----                                    --
formatter/large/dataset.py                 1.02     10.1Â±0.35ms     4.0 MB/sec     1.00      9.9Â±0.42ms     4.1 MB/sec
formatter/numpy/ctypeslib.py               1.00  1994.6Â±104.07Âµs     8.3 MB/sec    1.01      2.0Â±0.09ms     8.3 MB/sec
formatter/numpy/globals.py                 1.00   229.2Â±11.66Âµs    12.9 MB/sec     1.02   233.9Â±12.36Âµs    12.6 MB/sec
formatter/pydantic/types.py                1.00      4.3Â±0.19ms     5.9 MB/sec     1.00      4.3Â±0.21ms     5.9 MB/sec
linter/all-rules/large/dataset.py          1.00     14.0Â±0.56ms     2.9 MB/sec     1.00     14.0Â±0.59ms     2.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.5Â±0.15ms     4.7 MB/sec     1.01      3.6Â±0.14ms     4.7 MB/sec
linter/all-rules/numpy/globals.py          1.00   467.8Â±20.63Âµs     6.3 MB/sec     1.08    503.0Â±8.44Âµs     5.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.3Â±0.23ms     4.0 MB/sec     1.04      6.6Â±0.25ms     3.9 MB/sec
linter/default-rules/large/dataset.py      1.00      7.5Â±0.26ms     5.4 MB/sec     1.03      7.8Â±0.18ms     5.2 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.07  1663.8Â±35.31Âµs    10.0 MB/sec     1.00  1558.4Â±62.72Âµs    10.7 MB/sec
linter/default-rules/numpy/globals.py      1.00    172.4Â±8.35Âµs    17.1 MB/sec     1.02    175.5Â±9.22Âµs    16.8 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.3Â±0.15ms     7.7 MB/sec     1.00      3.3Â±0.14ms     7.8 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     13.0Â±0.35ms     3.1 MB/sec    1.01     13.1Â±0.32ms     3.1 MB/sec
formatter/numpy/ctypeslib.py               1.00      2.6Â±0.09ms     6.5 MB/sec    1.00      2.6Â±0.07ms     6.5 MB/sec
formatter/numpy/globals.py                 1.00   295.6Â±16.50Âµs    10.0 MB/sec    1.01   297.9Â±14.71Âµs     9.9 MB/sec
formatter/pydantic/types.py                1.00      5.6Â±0.21ms     4.5 MB/sec    1.01      5.7Â±0.19ms     4.5 MB/sec
linter/all-rules/large/dataset.py          1.00     17.9Â±0.35ms     2.3 MB/sec    1.00     17.9Â±0.29ms     2.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      4.8Â±0.10ms     3.5 MB/sec    1.00      4.7Â±0.11ms     3.5 MB/sec
linter/all-rules/numpy/globals.py          1.01   578.0Â±13.89Âµs     5.1 MB/sec    1.00   574.6Â±14.74Âµs     5.1 MB/sec
linter/all-rules/pydantic/types.py         1.00      8.2Â±0.23ms     3.1 MB/sec    1.00      8.2Â±0.17ms     3.1 MB/sec
linter/default-rules/large/dataset.py      1.01      9.7Â±0.18ms     4.2 MB/sec    1.00      9.6Â±0.22ms     4.2 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00      2.0Â±0.05ms     8.3 MB/sec    1.01      2.0Â±0.05ms     8.2 MB/sec
linter/default-rules/numpy/globals.py      1.00    231.9Â±8.61Âµs    12.7 MB/sec    1.01    234.3Â±8.55Âµs    12.6 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.3Â±0.11ms     5.9 MB/sec    1.00      4.3Â±0.17ms     5.9 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @konstin on 2023-07-24 15:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-07-24 18:04</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #6033</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6033" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #6034</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6034" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ<ul>
<li><strong>PR #6040</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6040" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6034?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-07-24 20:50</div>
            <div class="timeline-body"><p>@MichaReiser do you prefer reviewing this and then a next PR changing placement.rs again or do prefer an all-in-one complete rewrite PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/node.rs</code>:4397 on 2023-07-25 07:02</div>
            <div class="timeline-body"><p>What's the meaning of the <code>with_node</code> suffix? Should the function also return true for <code>ElifElseClause</code>s?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:272 on 2023-07-25 07:07</div>
            <div class="timeline-body"><p>Nit: It can be helpful for reviewers to add some comments to your PR, explaining what has changed. For example. I have to diff this part line by line because I don't know whether this part contains logical or structural (<code>if...else</code> to <code>let ... else</code>), which costs me a lot of time. This is where comments from the author can guide reviews to what's most important.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:277 on 2023-07-25 07:08</div>
            <div class="timeline-body"><p>Can we move the <code>comment_indentation</code> computation after this early return? Or can we remove it entirely? It seems that <code>own_line_comment_after_branch</code> recomputes the indentation. If not, can we pass the indentation to <code>own_line_comment_after_branch</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:316 on 2023-07-25 07:09</div>
            <div class="timeline-body"><p>Nit: I get the <code>with_node</code> suffix now. I'm leaning towards keeping this function local to <code>placement.rs</code>. It seems rather specific to the needs of the formatter.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:465 on 2023-07-25 07:16</div>
            <div class="timeline-body"><p>Hmm... I remember that I first used <code>unwrap_or_default</code> here but then had to change it to explicitly early return if the indentation is missing. Does this no longer apply because this code now only runs for an own line comment? What if we have</p>
<pre><code class="language-python">if test: print(&quot;True&quot;) 
    # comment
</code></pre>
<p>(or something similar)? Can you take a second look if this is indeed unproblematic?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:491 on 2023-07-25 07:17</div>
            <div class="timeline-body"><p>Ooch, I'm a big fan of using <code>break</code> with <code>loop</code> ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-07-25 07:19</div>
            <div class="timeline-body"><p>Nice. I didn't review line by line but I love how this unifies a lot of the individual rules (at least, the heavily lifting of them)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-07-25 07:20</div>
            <div class="timeline-body"><blockquote>
<p>@MichaReiser do you prefer reviewing this and then a next PR changing placement.rs again or do prefer an all-in-one complete rewrite PR?</p>
</blockquote>
<p>I haven't looked at the next PR but I prefer smaller PRs. <code>placement.rs</code> is challenging to review.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-07-25 09:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_ast/src/node.rs</code>:4397 on 2023-07-25 09:46</div>
            <div class="timeline-body"><p>it does!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-07-25 09:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:277 on 2023-07-25 09:48</div>
            <div class="timeline-body"><p>afaik this shouldn't actually be an early return</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @konstin on 2023-07-25 09:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2023-07-25 09:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-07-25 09:49</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:59:03 UTC
    </footer>
</body>
</html>
