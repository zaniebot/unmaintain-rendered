<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Move venv and conda env discovery to `SearchPath::from_settings` - astral-sh/ruff #18938</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Move venv and conda env discovery to <code>SearchPath::from_settings</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18938">#18938</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-06-25 16:04
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">Summary
<p>This PR centralizes the auto discovery logic for a Python environment into <code>SearchPaths::from_settings</code>.</p>
<p>This should make <a href="https://github.com/astral-sh/ty/issues/611">astral-sh/ty#611</a> an easy change (manly prioritizing <code>.venv</code> over <code>CONDA_PREFIX</code>).</p>
Test Plan
<p>Existing tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-25 16:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-25 16:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-25 16:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/ranged_value.rs</code>:1 on 2025-06-25 16:04</div>
            <div class="timeline-body"><p>I extracted this from <code>ty_project/metadata/value</code> I didn&#x27;t change the code other than adding the right feature gating and adjusting imports.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-25 16:07</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-06-25 16:14</div>
            <div class="timeline-body">



<a href="https://codspeed.io/astral-sh/ruff/branches/micha%2Fpython-discovery-search-paths?runnerMode=WallTime">CodSpeed WallTime Performance Report</a>
Merging #18938 will <strong>not alter performance</strong>
<p>Comparing <code>micha/python-discovery-search-paths</code> (77242e7) with <code>main</code> (d04e63a)</p>
Summary
<p><code>âœ… 8</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-25 16:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-25 16:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-25 16:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-25 16:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-25 16:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-25 16:44</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>âœ… ecosystem check detected no linter changes.</p>
Linter (preview)
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-25 16:50</div>
            <div class="timeline-body"><p>Hmm, not sure what&#x27;s up with the benchmark. The auto discovery isn&#x27;t run for benchmarks (it&#x27;s a fixed environment) and the program settings are resolved outside the benchmark</p>
<p>I verified that both main and this PR perform the same search path discovery in the benchmark...</p>
<p>Edit: It seems the benchmark triggers on other PRs too. So maybe just a flake?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-25 17:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/module_resolver/resolver.rs</code>:321 on 2025-06-25 17:50</div>
            <div class="timeline-body"><p>I&#x27;m not sure I understand the distinction between &quot;explicit configuration&quot; and &quot;auto discovery&quot; that this PR introduces. If I&#x27;ve explicitly activated an environment, or I&#x27;ve invoked ty via <code>uv run</code>, I&#x27;ll have a strong expectation that ty is going to use that environment. It would be very surprising to me if ty silently fell back to some other environment because it failed to parse the <code>pyvenv.cfg</code> file in my activated virtual environment. I&#x27;d much prefer a hard error in this situation as an end user that tells me what the problem is, rather than lots of confusing diagnostics about unresolved imports. That&#x27;s the behaviour we have on <code>main</code>, and I think it&#x27;s good behaviour.</p>
<p>The only situation where I think we maybe want to do something like this (where we log the error and continue down the chain) is implicit discovery of unactivated virtual environments in local <code>.venv</code> directories. If the user hasn&#x27;t explicitly activated the virtual environment, then we don&#x27;t even know for sure that they actually want us to use that environment, so in <em>that</em> situation I agree that it might make sense to just log the error and continue. But I think an explicitly activated virtual or conda environment is pretty different; I wouldn&#x27;t classify that under &quot;auto-discovery&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/carljm">@carljm</a> removed by <a href="https://github.com/carljm">@carljm</a> on 2025-06-25 19:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-25 20:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/module_resolver/resolver.rs</code>:321 on 2025-06-25 20:19</div>
            <div class="timeline-body"><p>Thanks for catching this. This wasn&#x27;t an intentional behavior change. Or more, I thought I correctly mapped the existing <code>or_else</code> chain but I didn&#x27;t notice that it maps over an <code>Option</code> and not a <code>Result</code> chain and I probably got mislead by how we handle the <code>.venv</code> case. I&#x27;ll change this tomorrow. This should also simplify the implementation a bit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-26 06:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/sharkdp">@sharkdp</a> removed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-06-26 07:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/program.rs</code>:210 on 2025-06-26 10:26</div>
            <div class="timeline-body"><p>The documentation here implies to me that this variant would only be used for the case where neither a virtual environment nor a conda environment has been activated but we find a <code>.venv</code> directory relative to the project root. But that doesn&#x27;t seem to be the case. It appears to also be used for the case where we read the <code>sys.prefix</code> value from the <code>VIRTUAL_ENV</code> or <code>CONDA_PREFIX</code> variables. (It&#x27;s sort of debatable whether reading environment variables that have either been explicitly set by the user or set as part of e.g. a <code>uv run</code> invocation really counts as &quot;automatic&quot; detection -- you could argue it&#x27;s just as explicit configuration as a CLI flag or a pyproject.toml setting?)</p>
<p>I&#x27;m not totally sold that adding this new variant is necessary. But if we do add it, we need to rename the <code>IntoSysPrefix</code> variant, because the <code>VIRTUAL_ENV</code> and <code>CONDA_PREFIX</code> environment variables point directly to the <code>sys.prefix</code> path (in fact, they&#x27;re the only <code>SysPrefixPathOrigin</code> variants that we can reliably count on <em>always</em> pointing directly to the <code>sys.prefix</code> path!).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_test/src/lib.rs</code>:277 on 2025-06-26 10:29</div>
            <div class="timeline-body"><p>is the <code>sys_prefix</code> method useful if this is all it does? ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-26 10:31</div>
            <div class="timeline-body"><p>Thanks! This looks basically good. I still feel like there&#x27;s some confusing distinctions being introduced that I&#x27;m not totally sold on.</p>
<p>It would also be ideal if we could add a regression test for <a href="https://github.com/astral-sh/ruff/pull/18938">astral-sh/ruff#18938</a>#discussion_r2167288287, but it was obviously a pre-existing issue that we had no coverage there :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_test/src/lib.rs</code>:277 on 2025-06-26 10:49</div>
            <div class="timeline-body"><p>It wasn&#x27;t introduced by me!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-26 10:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-26 10:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_test/src/lib.rs</code>:277 on 2025-06-26 10:52</div>
            <div class="timeline-body"><p>I know! ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-26 10:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/program.rs</code>:210 on 2025-06-26 10:53</div>
            <div class="timeline-body"><blockquote>
<p>The documentation here implies to me that this variant would only be used for the case where neither a virtual environment nor a conda environment has been activated but we find</p>
</blockquote>
<p>I&#x27;m not sure where the comment implies this. All it says is that it will to an automated discovery but it&#x27;s not specific about what that means (we could add it but we then end up repeating the same documentation in even more places).</p>
<blockquote>
<p>I&#x27;m not totally sold that adding this new variant is necessary.</p>
</blockquote>
<p>What alternative would you suggest? E.g. what should we specify in <code>to_search_path_settings</code> when no python path was specified in the Options. We can&#x27;t use <code>IntoSysPrefix</code> because we don&#x27;t have a virtual env path...</p>
<blockquote>
<p>I&#x27;m not totally sold that adding this new variant is necessary. But if we do add it, we need to rename the IntoSysPrefix variant, because the VIRTUAL_ENV and CONDA_PREFIX environment variables point directly to the sys.prefix path (in fact, they&#x27;re the only SysPrefixPathOrigin variants that we can reliably count on always pointing directly to the sys.prefix path!).</p>
</blockquote>
<p>I had a version that used <code>Option&lt;RangedValue&lt;SystemPathBuf&gt;&gt;</code> for the <code>SysPrefix</code> variant but it resulted in a large refactor. So I reverted the change. That means it&#x27;s now still possible to construct <code>IntoSysPrefix</code> with a <code>SysPrefixPathOrigin::CondaPrefix</code> even if we aren&#x27;t constructing this anyway. I think that&#x27;s fine. But regardless, I&#x27;m not sure how the environment variables influence the naming here because a) a caller has to resolve them in which case they create an <code>IntoSysPrefix</code> or the variable is resoloved in <code>SearchPaths::from_settings</code>, in which case it isn&#x27;t relevant for the enum variants here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-26 10:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/program.rs</code>:210 on 2025-06-26 10:58</div>
            <div class="timeline-body"><p>Overall, all this enum does is distinguish between 3 cases:</p>
<ul>
<li>Use a known list of search paths (testing only)</li>
<li>Use a specific path that can be converted to a sys prefix but it&#x27;s up to the caller to construct it</li>
<li>Use ty&#x27;s heuristics to find the python path</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-26 11:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/program.rs</code>:210 on 2025-06-26 11:19</div>
            <div class="timeline-body"><blockquote>
<p>All it says is that it will to an automated discovery</p>
</blockquote>
<p>Right, but why is reading configuration from an environment variable the user has set more &quot;automated&quot; than reading configuration from a pyproject.toml file? It feels just as explicit to me; the <code>VIRTUAL_ENV</code> variable is the conventional way in Python that you tell the language and all tooling which environment you&#x27;re currently using. It doesn&#x27;t feel like much of a heuristic to me; it feels pretty distinct to searching around on the filesystem for an unactivated virtual environment the user might have hanging around locally!</p>
<blockquote>
<p>What alternative would you suggest?</p>
</blockquote>
<p>I guess I sort-of like the current design where we convert <code>PythonPath</code> quite eagerly to <code>SysPrefixPathOrigin</code> in <code>options.rs</code>. I think <a href="https://github.com/astral-sh/ty/issues/611">astral-sh/ty#611</a> should be pretty fixable even with that structure: we can do a quick check upfront to see if <code>.venv/pyvenv.cfg</code> is a file on disk, and if so, assume the <code>.venv</code> directory is a virtual environment and use it; if not, fallback to the default conda environment. I believe basically the validation <a href="https://github.com/astral-sh/uv/pull/14214/files">uv</a> does to see if something should be treated as a virtual environment is just to check whether a <code>./pyvenv.cfg</code> file exists relative to that directory, and if so, it runs with it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-26 13:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/program.rs</code>:210 on 2025-06-26 13:20</div>
            <div class="timeline-body"><p>We discussed this offline. The main issue are the variant names. I&#x27;ll try to refine them but we both struggled to come up with good names</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/program.rs</code>:210 on 2025-06-26 13:39</div>
            <div class="timeline-body"><p>I did some renaming. Let me know if this is better.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-06-26 13:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/program.rs</code>:209 on 2025-06-26 13:44</div>
            <div class="timeline-body"><pre><code>    /// The path to the Python environment isn&#x27;t known. Try to discover the Python environment
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-06-26 13:45</div>
            <div class="timeline-body"><p>Thank you! The new names make it much clearer</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-26 14:22</div>
            <div class="timeline-body"><blockquote>
<p>Thank you! The new names make it much clearer</p>
</blockquote>
<p>It&#x27;s a shame that I&#x27;ll delete the entire enum in my next PR :D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-26 14:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-26 14:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-26 14:39</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:15:54 UTC
    </footer>
</body>
</html>
