<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check for `Any` in other types for `ANN401` - astral-sh/ruff #5601</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Check for <code>Any</code> in other types for <code>ANN401</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/5601">#5601</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2023-07-07 20:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-07-07 20:38</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Check for <code>Any</code> in other types for <code>ANN401</code>. This reuses the logic from <code>implicit-optional</code> rule to resolve the type to <code>Any</code>.</p>
<p>Following types are supported:</p>
<ul>
<li><code>Union[Any, ...]</code></li>
<li><code>Any | ...</code></li>
<li><code>Optional[Any]</code></li>
<li><code>Annotated[&lt;any of the above variant&gt;, ...]</code></li>
<li>Forward references i.e., <code>&quot;Any | ...&quot;</code></li>
</ul>
<h2>Test Plan</h2>
<p>Added test cases for various combinations.</p>
<p>fixes: #5458</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-07-07 20:39</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #5601</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5601" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ<ul>
<li><strong>PR #5717</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5717" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/5601?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-07-07 21:13</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.03      8.6Â±0.05ms     4.7 MB/sec    1.00      8.4Â±0.03ms     4.9 MB/sec
formatter/numpy/ctypeslib.py               1.03   1940.9Â±3.08Âµs     8.6 MB/sec    1.00   1893.5Â±4.20Âµs     8.8 MB/sec
formatter/numpy/globals.py                 1.01    206.8Â±1.06Âµs    14.3 MB/sec    1.00    204.3Â±0.33Âµs    14.4 MB/sec
formatter/pydantic/types.py                1.04      4.3Â±0.01ms     5.9 MB/sec    1.00      4.2Â±0.01ms     6.1 MB/sec
linter/all-rules/large/dataset.py          1.00     14.1Â±0.11ms     2.9 MB/sec    1.01     14.3Â±0.11ms     2.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.5Â±0.02ms     4.7 MB/sec    1.00      3.6Â±0.01ms     4.7 MB/sec
linter/all-rules/numpy/globals.py          1.00    364.3Â±1.25Âµs     8.1 MB/sec    1.01    369.0Â±2.21Âµs     8.0 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.3Â±0.03ms     4.1 MB/sec    1.02      6.4Â±0.05ms     4.0 MB/sec
linter/default-rules/large/dataset.py      1.00      7.1Â±0.03ms     5.7 MB/sec    1.01      7.2Â±0.03ms     5.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1466.1Â±5.45Âµs    11.4 MB/sec    1.02   1500.1Â±5.44Âµs    11.1 MB/sec
linter/default-rules/numpy/globals.py      1.00    155.1Â±0.25Âµs    19.0 MB/sec    1.03    159.9Â±0.90Âµs    18.5 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.2Â±0.01ms     8.0 MB/sec    1.02      3.2Â±0.01ms     7.9 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.03     12.7Â±0.41ms     3.2 MB/sec    1.00     12.4Â±0.29ms     3.3 MB/sec
formatter/numpy/ctypeslib.py               1.05      2.9Â±0.34ms     5.7 MB/sec    1.00      2.8Â±0.07ms     6.0 MB/sec
formatter/numpy/globals.py                 1.00   320.1Â±12.87Âµs     9.2 MB/sec    1.00   320.1Â±15.93Âµs     9.2 MB/sec
formatter/pydantic/types.py                1.00      6.1Â±0.20ms     4.2 MB/sec    1.00      6.1Â±0.20ms     4.2 MB/sec
linter/all-rules/large/dataset.py          1.02     21.4Â±0.54ms  1949.2 KB/sec    1.00     21.0Â±0.57ms  1981.4 KB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      5.5Â±0.19ms     3.0 MB/sec    1.00      5.4Â±0.20ms     3.1 MB/sec
linter/all-rules/numpy/globals.py          1.00   652.1Â±23.18Âµs     4.5 MB/sec    1.04   679.3Â±53.73Âµs     4.3 MB/sec
linter/all-rules/pydantic/types.py         1.00      9.5Â±0.35ms     2.7 MB/sec    1.00      9.5Â±0.25ms     2.7 MB/sec
linter/default-rules/large/dataset.py      1.02     10.9Â±0.36ms     3.7 MB/sec    1.00     10.6Â±0.18ms     3.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.02      2.2Â±0.09ms     7.4 MB/sec    1.00      2.2Â±0.06ms     7.5 MB/sec
linter/default-rules/numpy/globals.py      1.00    271.3Â±7.94Âµs    10.9 MB/sec    1.00   270.0Â±11.35Âµs    10.9 MB/sec
linter/default-rules/pydantic/types.py     1.01      4.8Â±0.18ms     5.3 MB/sec    1.00      4.8Â±0.15ms     5.3 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dhruvmanila on 2023-07-08 05:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/rules/flake8_annotations/rules/definition.rs</code>:438 on 2023-07-08 05:38</div>
            <div class="timeline-body"><p>I've moved the <code>is_overriden</code> check outside the function as it seems common. This avoids having many arguments to a function.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-07-08 05:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-07-08 05:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/rules/ruff/mod.rs</code>:4 on 2023-07-08 05:39</div>
            <div class="timeline-body"><p>Is this the correct place to keep the common functionality? We could move this to <code>ruff_python_ast</code> crate which would add dependencies to other crates mainly <code>ruff_python_semantic</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-07-08 05:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/rules/ruff/typing.rs</code>:84 on 2023-07-08 05:44</div>
            <div class="timeline-body"><p>Here's the difference between <code>None</code> and <code>Some(TypingTarget::Unknown)</code>:</p>
<p>| <code>None</code> | <code>Some(TypingTarget::Unknown)</code> |
|--------|--------|
| Known type but not a <code>TypingTarget</code> | Unknown type and not a <code>TypingTarget</code> |
| When <code>ExprSubscript.slice</code> is not a <code>ExprTuple</code> | Parsing fails for forward references |
| <strong>Flag violation</strong> | <strong>Do NOT flag violation</strong> |</p>
<p>My thought is to just remove the <code>None</code> variant. This means in failure we would <em>not</em> flag violation (currently we would). Any thoughts? \cc @charliermarsh</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-07-10 05:38</div>
            <div class="timeline-body"><p>(forced push to check ecosystem result via links :))</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @dhruvmanila on 2023-07-10 05:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/ruff/typing.rs</code>:291 on 2023-07-12 03:57</div>
            <div class="timeline-body"><p>Just a stylistic thing, but consider doing this match on <code>Some</code> in the <code>match target</code> below? Like:</p>
<pre><code class="language-rust">match TypingTarget::try_from_expr(annotation, semantic, locator, minor_version) {
  None =&gt; false,
  Some(TypingTarget::Any) =&gt; true,
  ...
}
</code></pre>
<p>But not blocking, up to your discretion of course.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-07-12 03:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-07-12 04:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/ruff/typing.rs</code>:84 on 2023-07-12 04:07</div>
            <div class="timeline-body"><p>Could we replace <code>None</code> with <code>Known</code>, and use <code>Result</code> to return an error when &quot;Parsing fails for forward references&quot; and &quot;When <code>ExprSubscript.slice</code> is not a <code>ExprTuple</code>&quot;? Even if we can't use <code>Result</code>, I think it makes sense to encode &quot;Known type but not a <code>TypingTarget</code>&quot; as its own variant. It's confusing that it's represented by <code>None</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-07-12 04:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/ruff/mod.rs</code>:4 on 2023-07-12 04:17</div>
            <div class="timeline-body"><p>It's probably okay for now, but you may be able to make it <code>pub(super)</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-07-12 04:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-07-12 17:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/rules/ruff/typing.rs</code>:291 on 2023-07-12 17:16</div>
            <div class="timeline-body"><p>I like this, updated at other relevant places as well. Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-07-12 17:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/rules/ruff/typing.rs</code>:84 on 2023-07-12 17:16</div>
            <div class="timeline-body"><blockquote>
<p>Even if we can't use <code>Result</code>, I think it makes sense to encode &quot;Known type but not a <code>TypingTarget</code>&quot; as its own variant. It's confusing that it's represented by <code>None</code>.</p>
</blockquote>
<p>This makes sense. Thanks!</p>
<p>I'm going with <code>Option&lt;...&gt;</code> and not flagging any violation in case of <code>None</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-07-12 17:43</div>
            <div class="timeline-body"><h2>Updates since last review</h2>
<ol>
<li>Explicit <code>Known</code> type for known types and not <code>TypingTarget</code></li>
<li>Refactor to use <code>match</code> expressions wherever possible</li>
<li>Fix a bug where single element like <code>Union[None]</code> would give false positive for implicit optionals <strong>(done in the child PR)</strong></li>
</ol>
<p>The (3) was due to the fact that <code>None</code> represented the &quot;When <code>ExprSubscript.slice</code> is not a <code>ExprTuple</code>&quot; case but the slice could be other types as well such as <code>ExprConstant</code> or <code>ExprName</code> in <code>Union[None]</code> and <code>Union[int]</code> respectively.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @dhruvmanila on 2023-07-12 17:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-07-12 18:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/rules/ruff/snapshots/ruff__rules__ruff__tests__RUF013_RUF013_0.py.snap</code>:44 on 2023-07-12 18:20</div>
            <div class="timeline-body"><p>This is intentional in this PR and is fixed in the child PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @charliermarsh removed by @dhruvmanila on 2023-07-12 18:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-07-12 20:47</div>
            <div class="timeline-body"><p>Still LGTM.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2023-07-13 05:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @dhruvmanila on 2023-07-13 05:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-07-13 05:41</div>
            <div class="timeline-body"><p>(Re-opening the PR to trigger CI, don't know why it went into &quot;waiting...&quot;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @dhruvmanila on 2023-07-13 05:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-07-13 05:58</div>
            <div class="timeline-body"><p>FYI, the PR stack is in reverse order which is the reason for <code>pre-commit</code> failure. Re-ordering involved resolving a bunch of merge conflicts and so I decided not to do it. I didn't realize the bug until quite later. Sorry for any failure notification ðŸ˜…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2023-07-13 12:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2023-07-13 12:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-07-13 12:49</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 03:31:00 UTC
    </footer>
</body>
</html>
