<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Separate type check diagnostics builder - astral-sh/ruff #13978</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Separate type check diagnostics builder</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13978">#13978</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-10-29 11:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body">Summary
<p>This PR creates a new <code>TypeCheckDiagnosticsBuilder</code> for the <code>TypeCheckDiagnostics</code> struct. The main motivation behind this is to separate the helpers required to build the diagnostics from the type inference builder itself. This allows us to use such helpers outside of the inference builder like for example in the unpacking logic in <a href="https://github.com/astral-sh/ruff/pull/13979">astral-sh/ruff#13979</a>.</p>
Test Plan
<p><code>cargo insta test</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-10-29 11:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-10-30 08:52</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-10-30 10:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:34 on 2024-10-30 10:11</div>
            <div class="timeline-body"><p>I couldn&#x27;t figure out why the order of the diagnostics changed here as nothing obvious stands out to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-10-30 10:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-10-30 10:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-10-30 10:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-10-30 10:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:1648 on 2024-10-30 10:44</div>
            <div class="timeline-body"><p>Nit: I suggest prefixing the builder methods with <code>add</code> because I otherwise expect that the <code>builder</code> returns the diagnostic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3472 on 2024-10-30 10:52</div>
            <div class="timeline-body"><p>I think what&#x27;s different now is that <code>extend</code> adds the diagnostics to <code>self.types.diagnostics</code> and <code>finish</code> merges the two.</p>
<p>We should not write to <code>types.diagnostics</code> and instead push all diagnostics to the <code>DiagnosticsBuilder</code> (we otherwise risk allocating more vecs)</p>
<pre><code>        self.types.diagnostics. = self.diagnostics.finish();
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-10-30 10:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3472 on 2024-10-30 10:56</div>
            <div class="timeline-body"><p>I don&#x27;t think we can directly override the <code>self.types.diagnostics</code> because otherwise it&#x27;ll drop the existing diagnostics that&#x27;s present. This happens because the inference builder is mutually recursive.</p>
<p>Did you mean the following?</p>
<pre><code>self.diagnostics.extend(self.diagnostics.finish());
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-10-30 10:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-10-30 11:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3472 on 2024-10-30 11:23</div>
            <div class="timeline-body"><p>types.diagnostics should be empty at  this point. If it isn&#x27;t (e.g because of extend), then these code paths should be updated as well to push the diagnostics to the builder instead. Pushing some diagnostics to the builder and some to types.diagnostics is the source of the reordering</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-10-30 11:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3472 on 2024-10-30 11:24</div>
            <div class="timeline-body"><p>We could argue that the reordering doesn&#x27;t matter and we should instead sort the diagnostics but it still has the disadvantage that we allocate one extra vec when the diagnostics are not empty</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-10-30 11:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:3472 on 2024-10-30 11:27</div>
            <div class="timeline-body"><p>Oh ok, got it. I see the issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-10-30 11:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:34 on 2024-10-30 11:31</div>
            <div class="timeline-body"><p>This is resolved in <a href="https://github.com/astral-sh/ruff/pull/13978">astral-sh/ruff#13978</a>/commits/8d3a2ff5ee818405fbd7f2c28ed37d6b58a741d0</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-10-30 12:45</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/diagnostic.rs</code>:238 on 2024-10-30 18:27</div>
            <div class="timeline-body"><p>This maybe duplicates the TODO below, but it seems confusing for the docstring to claim behavior that isn&#x27;t implemented yet:</p>
<pre><code>    /// TODO: the diagnostic does not get added if the rule isn&#x27;t enabled for this file.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-10-30 18:28</div>
            <div class="timeline-body"><p>This is great!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-10-30 18:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/diagnostic.rs</code>:238 on 2024-10-30 18:31</div>
            <div class="timeline-body"><p>I would leave it as is. It works correctly because the diagnostic gets omitted for third-party code (the rule is not enabled). There&#x27;s just no way to disable rules for first-party files and all rules are always enabled.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-10-30 18:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-10-30 18:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-10-30 18:50</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:07:53 UTC
    </footer>
</body>
</html>
