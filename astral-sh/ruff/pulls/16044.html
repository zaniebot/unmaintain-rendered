<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-pyi`] Extend fix to Python &lt;= 3.9 for `redundant-none-literal` (`PYI061`) - astral-sh/ruff #16044</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-pyi</code>] Extend fix to Python &lt;= 3.9 for <code>redundant-none-literal</code> (<code>PYI061</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16044">#16044</a>
        opened by <a href="https://github.com/dylwil3">@dylwil3</a>
        on 2025-02-08 21:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-08 21:20</div>
            <div class="timeline-body"><p>This PR extends the fix offered for <a href="https://docs.astral.sh/ruff/rules/redundant-none-literal/#redundant-none-literal-pyi061">redundant-none-literal (PYI061)</a> to include Python versions &lt;= 3.9 by using <code>typing.Optional</code> instead of the operator <code>|</code>. We also offer the fix with <code>|</code> for any target version on stub files.</p>
<p>Closes #15795</p>
<hr />
<p>For review:</p>
<ul>
<li>I recommend reading the extended commit message for the second commit (where the fix logic is implemented), which hopefully explains the perhaps larger than expected diff.</li>
<li>Note that the snapshots can still have bit-or operators <code>|</code> since we will not remove them if they are already present, e.g. <code>Literal[None] | int</code> simplifies to <code>None | int</code> regardless of Python version or source type.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @dylwil3 on 2025-02-08 21:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @dylwil3 on 2025-02-08 21:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dylwil3 on 2025-02-08 21:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-02-08 21:33</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>‚ÑπÔ∏è ecosystem check <strong>detected linter changes</strong>. (+15 -15 violations, +0 -0 fixes in 4 projects; 51 projects unchanged)</p>
<details><summary><a href="https://github.com/apache/airflow">apache/airflow</a> (+1 -1 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/apache/airflow/blob/6f1c5b75cea28ed3687cc3cfa6cd65954dc26247/airflow/models/dag.py#L1016'>airflow/models/dag.py:1016:36:</a> PYI061 [*] Use `Optional[Literal[...]]` rather than `Literal[None, ...]` 
- <a href='https://github.com/apache/airflow/blob/6f1c5b75cea28ed3687cc3cfa6cd65954dc26247/airflow/models/dag.py#L1016'>airflow/models/dag.py:1016:36:</a> PYI061 `Literal[None, ...]` can be replaced with `Literal[...] | None`
</pre>

</p>
</details>
<details><summary><a href="https://github.com/latchbio/latch">latchbio/latch</a> (+1 -1 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/latchbio/latch/blob/dd8f9fbb1a02b18a5d14dfaebd6b250dc43de553/src/latch/types/metadata.py#L500'>src/latch/types/metadata.py:500:45:</a> PYI061 [*] Use `Optional[Literal[...]]` rather than `Literal[None, ...]` 
- <a href='https://github.com/latchbio/latch/blob/dd8f9fbb1a02b18a5d14dfaebd6b250dc43de553/src/latch/types/metadata.py#L500'>src/latch/types/metadata.py:500:45:</a> PYI061 `Literal[None, ...]` can be replaced with `Literal[...] | None`
</pre>

</p>
</details>
<details><summary><a href="https://github.com/pandas-dev/pandas">pandas-dev/pandas</a> (+4 -4 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/pandas-dev/pandas/blob/e557039fda7d4325184cf76520892b3a635ec2dd/pandas/core/groupby/groupby.py#L4181'>pandas/core/groupby/groupby.py:4181:39:</a> PYI061 [*] Use `Literal[...] | None` rather than `Literal[None, ...]` 
- <a href='https://github.com/pandas-dev/pandas/blob/e557039fda7d4325184cf76520892b3a635ec2dd/pandas/core/groupby/groupby.py#L4181'>pandas/core/groupby/groupby.py:4181:39:</a> PYI061 [*] `Literal[None, ...]` can be replaced with `Literal[...] | None`
+ <a href='https://github.com/pandas-dev/pandas/blob/e557039fda7d4325184cf76520892b3a635ec2dd/pandas/core/groupby/indexing.py#L299'>pandas/core/groupby/indexing.py:299:39:</a> PYI061 [*] Use `Literal[...] | None` rather than `Literal[None, ...]` 
- <a href='https://github.com/pandas-dev/pandas/blob/e557039fda7d4325184cf76520892b3a635ec2dd/pandas/core/groupby/indexing.py#L299'>pandas/core/groupby/indexing.py:299:39:</a> PYI061 [*] `Literal[None, ...]` can be replaced with `Literal[...] | None`
+ <a href='https://github.com/pandas-dev/pandas/blob/e557039fda7d4325184cf76520892b3a635ec2dd/pandas/io/html.py#L1045'>pandas/io/html.py:1045:28:</a> PYI061 [*] Use `Literal[...] | None` rather than `Literal[None, ...]` 
- <a href='https://github.com/pandas-dev/pandas/blob/e557039fda7d4325184cf76520892b3a635ec2dd/pandas/io/html.py#L1045'>pandas/io/html.py:1045:28:</a> PYI061 [*] `Literal[None, ...]` can be replaced with `Literal[...] | None`
+ <a href='https://github.com/pandas-dev/pandas/blob/e557039fda7d4325184cf76520892b3a635ec2dd/pandas/io/html.py#L223'>pandas/io/html.py:223:32:</a> PYI061 [*] Use `Literal[...] | None` rather than `Literal[None, ...]` 
- <a href='https://github.com/pandas-dev/pandas/blob/e557039fda7d4325184cf76520892b3a635ec2dd/pandas/io/html.py#L223'>pandas/io/html.py:223:32:</a> PYI061 [*] `Literal[None, ...]` can be replaced with `Literal[...] | None`
</pre>

</p>
</details>
<details><summary><a href="https://github.com/zulip/zulip">zulip/zulip</a> (+9 -9 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/zulip/zulip/blob/d28f7d86223bab4f11629637d4237381943f6fc1/corporate/views/billing_page.py#L328'>corporate/views/billing_page.py:328:24:</a> PYI061 [*] Use `Literal[...] | None` rather than `Literal[None, ...]` 
- <a href='https://github.com/zulip/zulip/blob/d28f7d86223bab4f11629637d4237381943f6fc1/corporate/views/billing_page.py#L328'>corporate/views/billing_page.py:328:24:</a> PYI061 [*] `Literal[None, ...]` can be replaced with `Literal[...] | None`
+ <a href='https://github.com/zulip/zulip/blob/d28f7d86223bab4f11629637d4237381943f6fc1/corporate/views/remote_billing_page.py#L158'>corporate/views/remote_billing_page.py:158:26:</a> PYI061 [*] Use `Literal[...] | None` rather than `Literal[None, ...]` 
- <a href='https://github.com/zulip/zulip/blob/d28f7d86223bab4f11629637d4237381943f6fc1/corporate/views/remote_billing_page.py#L158'>corporate/views/remote_billing_page.py:158:26:</a> PYI061 [*] `Literal[None, ...]` can be replaced with `Literal[...] | None`
+ <a href='https://github.com/zulip/zulip/blob/d28f7d86223bab4f11629637d4237381943f6fc1/corporate/views/remote_billing_page.py#L159'>corporate/views/remote_billing_page.py:159:42:</a> PYI061 [*] Use `Literal[...] | None` rather than `Literal[None, ...]` 
- <a href='https://github.com/zulip/zulip/blob/d28f7d86223bab4f11629637d4237381943f6fc1/corporate/views/remote_billing_page.py#L159'>corporate/views/remote_billing_page.py:159:42:</a> PYI061 [*] `Literal[None, ...]` can be replaced with `Literal[...] | None`
+ <a href='https://github.com/zulip/zulip/blob/d28f7d86223bab4f11629637d4237381943f6fc1/corporate/views/remote_billing_page.py#L160'>corporate/views/remote_billing_page.py:160:48:</a> PYI061 [*] Use `Literal[...] | None` rather than `Literal[None, ...]` 
- <a href='https://github.com/zulip/zulip/blob/d28f7d86223bab4f11629637d4237381943f6fc1/corporate/views/remote_billing_page.py#L160'>corporate/views/remote_billing_page.py:160:48:</a> PYI061 [*] `Literal[None, ...]` can be replaced with `Literal[...] | None`
+ <a href='https://github.com/zulip/zulip/blob/d28f7d86223bab4f11629637d4237381943f6fc1/corporate/views/remote_billing_page.py#L679'>corporate/views/remote_billing_page.py:679:26:</a> PYI061 [*] Use `Literal[...] | None` rather than `Literal[None, ...]` 
- <a href='https://github.com/zulip/zulip/blob/d28f7d86223bab4f11629637d4237381943f6fc1/corporate/views/remote_billing_page.py#L679'>corporate/views/remote_billing_page.py:679:26:</a> PYI061 [*] `Literal[None, ...]` can be replaced with `Literal[...] | None`
+ <a href='https://github.com/zulip/zulip/blob/d28f7d86223bab4f11629637d4237381943f6fc1/corporate/views/remote_billing_page.py#L680'>corporate/views/remote_billing_page.py:680:42:</a> PYI061 [*] Use `Literal[...] | None` rather than `Literal[None, ...]` 
- <a href='https://github.com/zulip/zulip/blob/d28f7d86223bab4f11629637d4237381943f6fc1/corporate/views/remote_billing_page.py#L680'>corporate/views/remote_billing_page.py:680:42:</a> PYI061 [*] `Literal[None, ...]` can be replaced with `Literal[...] | None`
+ <a href='https://github.com/zulip/zulip/blob/d28f7d86223bab4f11629637d4237381943f6fc1/corporate/views/remote_billing_page.py#L681'>corporate/views/remote_billing_page.py:681:48:</a> PYI061 [*] Use `Literal[...] | None` rather than `Literal[None, ...]` 
- <a href='https://github.com/zulip/zulip/blob/d28f7d86223bab4f11629637d4237381943f6fc1/corporate/views/remote_billing_page.py#L681'>corporate/views/remote_billing_page.py:681:48:</a> PYI061 [*] `Literal[None, ...]` can be replaced with `Literal[...] | None`
+ <a href='https://github.com/zulip/zulip/blob/d28f7d86223bab4f11629637d4237381943f6fc1/corporate/views/remote_billing_page.py#L70'>corporate/views/remote_billing_page.py:70:5:</a> PYI061 [*] Use `Literal[...] | None` rather than `Literal[None, ...]` 
- <a href='https://github.com/zulip/zulip/blob/d28f7d86223bab4f11629637d4237381943f6fc1/corporate/views/remote_billing_page.py#L70'>corporate/views/remote_billing_page.py:70:5:</a> PYI061 [*] `Literal[None, ...]` can be replaced with `Literal[...] | None`
+ <a href='https://github.com/zulip/zulip/blob/d28f7d86223bab4f11629637d4237381943f6fc1/zerver/lib/event_types.py#L785'>zerver/lib/event_types.py:785:67:</a> PYI061 [*] Use `None` rather than `Literal[None]`
- <a href='https://github.com/zulip/zulip/blob/d28f7d86223bab4f11629637d4237381943f6fc1/zerver/lib/event_types.py#L785'>zerver/lib/event_types.py:785:67:</a> PYI061 [*] `Literal[None]` can be replaced with `None`
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PYI061 | 30 | 15 | 15 | 0 | 0 |</p>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-08 22:11</div>
            <div class="timeline-body"><p>Ecosystem changes as expected - both repos have <code>target-version</code> set to <code>py39</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-08 23:23</div>
            <div class="timeline-body"><blockquote>
<ul>
<li><a href="https://github.com/apache/airflow/blob/fd606b1d6e1469ebf977e327c947a1d288b5f0d2/airflow/models/dag.py#L1016">airflow/models/dag.py:1016:36:</a> PYI061 [*] <code>Literal[None, ...]</code> can be replaced with <code>Union[Literal[...], None]</code></li>
</ul>
</blockquote>
<p>Hmmm... wouldn't it be better to suggest <code>Optional[Literal[...]]</code> here rather than <code>Union[Literal[...], None]</code>? I think most people would consider that more idiomatic on Python &lt;=3.9</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_none_literal.rs</code>:241 on 2025-02-08 23:27</div>
            <div class="timeline-body"><p>nit: it would be better to return <code>anyhow::Result&lt;Fix&gt;</code> or <code>anyhow::Result&lt;Option&lt;Fix&gt;&gt;</code> from this function, do this here, and use <code>Diagnostic::try_set_fix</code> or <code>Diagnostic::try_set_optional_fix</code> to add the fix to the diagnostic:</p>
<pre><code class="language-suggestion">            let (import_edit, bound_name) = checker
                .importer()
                .get_or_import_symbol(
                    &amp;ImportRequest::import_from(&quot;typing&quot;, &quot;Union&quot;),
                    literal_expr.start(),
                    checker.semantic(),
                )?;
</code></pre>
<p>The advantage is that if you use <code>try_set_fix</code> or <code>try_set_optional_fix</code>, Ruff will print an error message to the terminal (if you run it with enough <code>-v</code> flags) with information from the <code>ResolutionError</code> here when this function returns an error. That makes it easier for users or us to debug why Ruff was unable to create an autofix in a specific situation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-08 23:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-09 01:58</div>
            <div class="timeline-body"><blockquote>
<p>Hmmm... wouldn't it be better to suggest Optional[Literal[...]]</p>
</blockquote>
<p>ü§¶ of course! much better</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_none_literal.rs</code>:66 on 2025-02-09 12:07</div>
            <div class="timeline-body"><p>While we're here, it might be nice to change these so they're a little more imperative:</p>
<pre><code class="language-suggestion">            UnionKind::NoUnion =&gt; &quot;Use `None` rather than `Literal[None]`&quot;.to_string(),
            UnionKind::TypingOptional =&gt; {
                &quot;Use `Optional[Literal[...]]` rather than `Literal[None, ...]`&quot;.to_string()
            }
            UnionKind::BitOr =&gt; {
                &quot;Use `Literal[...] | None` rather than `Literal[None, ...]`&quot;.to_string()
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_none_literal.rs</code>:228 on 2025-02-09 12:08</div>
            <div class="timeline-body"><p>ignorable nit (just my stylistic preference!) -- you could reduce some duplication between the branches here:</p>
<pre><code class="language-diff">diff --git a/crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_none_literal.rs b/crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_none_literal.rs
index 2f5e892d0..ddaa51ac8 100644
--- a/crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_none_literal.rs
+++ b/crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_none_literal.rs
@@ -225,7 +225,7 @@ fn create_fix(
         }),
     });
 
-    match union_kind {
+    let fix = match union_kind {
         UnionKind::TypingOptional =&gt; {
             let (import_edit, bound_name) = checker.importer().get_or_import_symbol(
                 &amp;ImportRequest::import_from(&quot;typing&quot;, &quot;Optional&quot;),
@@ -235,11 +235,7 @@ fn create_fix(
             let optional_expr = typing_optional(new_literal_expr, Name::from(bound_name));
             let content = checker.generator().expr(&amp;optional_expr);
             let optional_edit = Edit::range_replacement(content, literal_expr.range());
-            Ok(Some(Fix::applicable_edits(
-                import_edit,
-                [optional_edit],
-                applicability,
-            )))
+            Fix::applicable_edits(import_edit, [optional_edit], applicability)
         }
         UnionKind::BitOr =&gt; {
             let none_expr = Expr::NoneLiteral(ExprNoneLiteral {
@@ -248,13 +244,15 @@ fn create_fix(
             let union_expr = pep_604_union(&amp;[new_literal_expr, none_expr]);
             let content = checker.generator().expr(&amp;union_expr);
             let union_edit = Edit::range_replacement(content, literal_expr.range());
-            Ok(Some(Fix::applicable_edit(union_edit, applicability)))
+            Fix::applicable_edit(union_edit, applicability)
         }
         // We dealt with this case earlier to avoid allocating `lhs` and `rhs`
         UnionKind::NoUnion =&gt; {
             unreachable!()
         }
-    }
+    };
+
+    Ok(Some(fix))
 }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/redundant_none_literal.rs</code>:260 on 2025-02-09 12:09</div>
            <div class="timeline-body"><p>I tend to add these to simple enums like this, because you never know when they might be useful in tests or debug prints</p>
<pre><code class="language-suggestion">#[derive(Copy, Clone, Debug, PartialEq, Eq)]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-02-09 12:10</div>
            <div class="timeline-body"><p>Excellent, thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dylwil3 on 2025-02-09 15:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dylwil3 on 2025-02-09 15:58</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:57:52 UTC
    </footer>
</body>
</html>
