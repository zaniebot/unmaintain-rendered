<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`ruff server` sets worker thread pool size based on the user's available cores - astral-sh/ruff #10399</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>ruff server</code> sets worker thread pool size based on the user's available cores</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10399">#10399</a>
        opened by <a href="https://github.com/snowsignal">@snowsignal</a>
        on 2024-03-14 00:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-03-14 00:57</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes #10369.</p>
<h2>Test Plan</h2>
<p>N/A</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @snowsignal on 2024-03-14 00:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-03-14 01:10</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-14 15:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/args.rs</code>:505 on 2024-03-14 15:40</div>
            <div class="timeline-body"><p>Can you set the default in Clap directly?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @snowsignal on 2024-03-15 20:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-17 21:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/args.rs</code>:505 on 2024-03-17 21:31</div>
            <div class="timeline-body"><p>You can omit <code> - the default is 4.</code> This is one of the benefits of encoding it in Clap -- it's already handled in a consistent way:</p>
<pre><code>❯ cargo run -- server --help
   Compiling ruff_python_ast v0.0.0 (/Users/crmarsh/workspace/ruff/crates/ruff_python_ast)
   Compiling ruff v0.3.2 (/Users/crmarsh/workspace/ruff/crates/ruff)
   Compiling ruff_python_parser v0.0.0 (/Users/crmarsh/workspace/ruff/crates/ruff_python_parser)
   Compiling ruff_python_literal v0.0.0 (/Users/crmarsh/workspace/ruff/crates/ruff_python_literal)
   Compiling ruff_python_semantic v0.0.0 (/Users/crmarsh/workspace/ruff/crates/ruff_python_semantic)
   Compiling ruff_python_index v0.0.0 (/Users/crmarsh/workspace/ruff/crates/ruff_python_index)
   Compiling ruff_python_codegen v0.0.0 (/Users/crmarsh/workspace/ruff/crates/ruff_python_codegen)
   Compiling ruff_python_formatter v0.0.0 (/Users/crmarsh/workspace/ruff/crates/ruff_python_formatter)
   Compiling ruff_linter v0.3.2 (/Users/crmarsh/workspace/ruff/crates/ruff_linter)
   Compiling ruff_workspace v0.0.0 (/Users/crmarsh/workspace/ruff/crates/ruff_workspace)
   Compiling ruff_server v0.2.2 (/Users/crmarsh/workspace/ruff/crates/ruff_server)
    Finished dev [unoptimized + debuginfo] target(s) in 12.36s
     Running `target/debug/ruff server --help`
Run the language server

Usage: ruff server [OPTIONS]

Options:
      --preview            Enable preview mode; required for regular operation
      --threads &lt;THREADS&gt;  Set the number of background threads used for running tasks concurrently - the default is 4 [default: 4]
  -h, --help               Print help

Log levels:
  -v, --verbose  Enable verbose logging
  -q, --quiet    Print diagnostics, but nothing else
  -s, --silent   Disable all logging (but still exit with status code &quot;1&quot; upon detecting diagnostics)

Global options:
      --config &lt;CONFIG_OPTION&gt;  Either a path to a TOML configuration file (`pyproject.toml` or `ruff.toml`), or a TOML `&lt;KEY&gt; = &lt;VALUE&gt;` pair (such as you might find in a `ruff.toml` configuration file) overriding a specific
                                configuration option. Overrides of individual settings using this option always take precedence over all configuration files, including configuration files that were also specified using `--config`
      --isolated                Ignore all configuration files
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-03-17 21:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/schedule.rs</code>:51 on 2024-03-18 07:29</div>
            <div class="timeline-body"><p>I think we should change <code>Pool::new</code> to take a <code>NonZeroUsize</code> (and pass it as such all the way to the <code>::new</code> call) because the <code>Pool</code> is non-functioning when created with <code>0</code> (it has 0 threads, and the bounded queue has a capacity of 0, dropping all messages).</p>
<p>Not related to this PR but I noticed it when looking at the <code>Pool::new</code> definition.</p>
<pre><code>        let (job_sender, job_receiver) = crossbeam::channel::bounded(threads);
</code></pre>
<p>We should revisit the bounded queue's size and how a queue overflow is handled (currently panics). I'm saying that because using <code>--threads=1</code> created a bounded queue of size 1, and the server panics as soon as we queue the second message, which doesn't seem unlikely. I prefer a fixed message count that we allow to accumulate regardless of the thread count.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/args.rs</code>:507 on 2024-03-18 07:36</div>
            <div class="timeline-body"><p>This is related to the summary review feedback. The documentation isn't 100% accurate OR requires very specific knowledge of the LSP implementation. The LSP creates one more (background) thread for formatting.  This is what makes me think that it might be best to hide away the thread count from users.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-03-18 07:36</div>
            <div class="timeline-body"><p>The option seems very low-level and difficult to understand for users. As a user, I wouldn't know what a good default is. Should I use the number of CPU cores? If so, why does Ruff not use that by default?</p>
<p>I prefer to improve Ruff's default thread count detection (e.g., don't use more than the number of CPUs) and only expose this CLI option if we have a very specific use case that it enables.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-03-18 17:48</div>
            <div class="timeline-body"><p>@MichaReiser I agree that we could do better than hard-coding <code>4</code> as the thread count. Do you think <code>clamp(1, num_cpus, 4)</code> could work as a default? I still think we should give users the capability of setting a worker thread count themselves (in case they need more workers running or if the default puts too high of a demand on their computer). We should probably also be clear that this doesn't reflect the actual number of threads used by the program.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-03-18 17:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff/src/args.rs</code>:507 on 2024-03-18 17:50</div>
            <div class="timeline-body"><p>Maybe 'worker thread count' would be a better way to describe this. <code>rust-analyzer</code> has a <a href="https://rust-analyzer.github.io/manual.html#rust-analyzer.numThreads">similar setting</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-03-18 18:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server/schedule.rs</code>:51 on 2024-03-18 18:00</div>
            <div class="timeline-body"><p>I agree with this, though I have a question:</p>
<blockquote>
<p>We should revisit the bounded queue's size and how a queue overflow is handled (currently panics).</p>
</blockquote>
<p>Is this true? The <a href="https://docs.rs/crossbeam/latest/crossbeam/channel/fn.bounded.html">documentation</a> says that <code>send</code>-ing a message when the queue is at capacity will block the thread until space becomes available.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @snowsignal on 2024-03-18 20:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-03-18 20:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_server/src/server/schedule.rs</code>:51 on 2024-03-18 20:41</div>
            <div class="timeline-body"><p>Oh good point. I misunderstood the API. I guess a too small bounded queue is less of a concern in that case (do you know if it would be possible to lead to dead-locks when setting the count to 1 and the server sends a notification that requires a response?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-03-18 20:44</div>
            <div class="timeline-body"><blockquote>
<p>Do you think clamp(1, num_cpus, 4) could work as a default?</p>
</blockquote>
<p>That sounds like a good default to me</p>
<blockquote>
<p>I still think we should give users the capability of setting a worker thread count themselves (in case they need more workers running or if the default puts too high of a demand on their computer).</p>
</blockquote>
<p>I defer to you, but I would prefer waiting to add the option until we have a concrete use case (users asking for it). My concern with preemptively adding it is that it possibly hides problems with Ruff or the LSP that need fixing rather than having users tinker with thread counts.</p>
<ul>
<li>If Ruff require more than 4 threads to be responsive, than there's probably something wrong with Ruff or the LSP. Are we waiting too long for a lock? Are we re-computing too much data? Or something else? Rather than having users increase the thread count, we should investigate why Ruff is slow.</li>
<li>Reducing the thread count is a more appealing use case, but using <code>clamp(1, numcpus)</code> largely addresses this without leaking the thread pool abstraction or require manual configuration.</li>
</ul>
<p>It's worth noting that Ruff today (as far as I understand) only uses 1 thread.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-03-18 20:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-03-18 20:56</div>
            <div class="timeline-body"><p>@MichaReiser I think you've convinced me that we should not make this configurable for now. I've removed the command-line argument and kept the rest of the changes. Adding the argument back will be easy in the future, if we need it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Introduce `--threads` argument to `ruff server` for setting thread count" to "`ruff server` sets worker thread pool size based on the user's available cores" by @snowsignal on 2024-03-18 20:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-03-18 21:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/ruff_server/src/server/schedule.rs</code>:51 on 2024-03-18 21:06</div>
            <div class="timeline-body"><blockquote>
<p>(do you know if it would be possible to lead to dead-locks when setting the count to 1 and the server sends a notification that requires a response?)</p>
</blockquote>
<p>No, because any tasks active in the thread pool are not allowed to await server connections. They can <em>send</em> requests/notifications to the server, but they can't receive messages. The sender is one half of a zero-sized channel onto a dedicated I/O thread, and that shouldn't block unless the I/O between the server and client itself starts blocking.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @snowsignal on 2024-03-18 21:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @snowsignal on 2024-03-18 21:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-03-18 21:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-03-18 21:11</div>
            <div class="timeline-body"><p>Okay, I think there's one use case where a similar flag could be useful, but I don't think we need it today. That is when someone uses the LSP as our official Ruff API (instead of calling into the CLI). It could then be useful to let Ruff go as fast as possible (use up to numcpu threads). However, I don't know if I, as a user, would want to specify the thread count or instead set a <code>--detached</code> option that tells Ruff: Hey, you run out of an editor, go as fast as you can and don't bother about UI responsiveness. The advantage of a semantic option is that we could e.g. use a thread pool without priorities (less overhead). The downside is that Ruff might compete for computing resources with the calling script. It may need something of both. But let's leave that for another day.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 22:47:58 UTC
    </footer>
</body>
</html>
