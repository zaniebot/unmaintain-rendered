<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Introduce `ArgOrKeyword` to keep call parameter order - astral-sh/ruff #7302</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Introduce <code>ArgOrKeyword</code> to keep call parameter order</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7302">#7302</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2023-09-12 12:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/konstin">@konstin</a> on 2023-09-12 12:58</div>
            <div class="timeline-body"><h2>Motivation</h2>
<p>The <code>ast::Arguments</code> for call argument are split into positional arguments (args) and keywords arguments (keywords). We currently assume that call consists of first args and then keywords, which is generally the case, but not always:</p>
<pre><code class="language-python">f(*args, a=2, *args2, **kwargs)

class A(*args, a=2, *args2, **kwargs):
    pass
</code></pre>
<p>The consequence is accidentally reordering arguments (https://github.com/astral-sh/ruff/pull/7268).</p>
<h2>Summary</h2>
<p><code>Arguments::args_and_keywords</code> returns an iterator of an <code>ArgOrKeyword</code> enum that yields args and keywords in the correct order. I've fixed the obvious <code>args</code> and <code>keywords</code> usages, but there might be some cases with wrong assumptions remaining.</p>
<h2>Test Plan</h2>
<p>The generator got new test cases, otherwise the stacked PR (https://github.com/astral-sh/ruff/pull/7268) which uncovered this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-09-12 12:58</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #7302</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7302" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ<ul>
<li><strong>PR #7268</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7268" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7302?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/visitor.rs</code>:576 on 2023-09-12 13:01</div>
            <div class="timeline-body"><p>The ordering in this visitor should be the same as the execution order at runtime.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-09-12 13:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-12 13:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_ast/src/visitor.rs</code>:576 on 2023-09-12 13:15</div>
            <div class="timeline-body"><p>Input:</p>
<pre><code class="language-python">def f(*args, **kwargs):
    pass

def g(x):
    print(x)
    return x


f(*g([1]), a=g(2), *g([3]), **g({&quot;4&quot;: 5}))
</code></pre>
<p>Output:</p>
<pre><code class="language-python">[1]
[3]
2
{'4': 5}
</code></pre>
<p>:face_with_spiral_eyes:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-09-12 13:17</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-09-12 13:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_ast/src/visitor.rs</code>:576 on 2023-09-12 13:24</div>
            <div class="timeline-body"><p>thanks for making me check</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @konstin on 2023-09-12 14:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @konstin on 2023-09-12 14:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2023-09-12 15:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:2279 on 2023-09-12 15:39</div>
            <div class="timeline-body"><p>I find <code>declared</code> a bit misleading in this context because I would expect the order match the order of the arguments in the function or class declaration. But what I understand is that this is specific to call expressions and the arguments aren't a declaration (they aren't binding a name).</p>
<p>Maybe <code>arguments_preoder()</code> or <code>arguments_souce_order</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/helpers.rs</code>:216 on 2023-09-12 15:43</div>
            <div class="timeline-body"><p>The ordering shouldn't mater for <code>any_over_expr</code>, meaning we can use the &quot;cheaper&quot; arguments than keywords iteration. Same for classes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-09-12 15:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @konstin on 2023-09-13 08:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2023-09-13 08:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-09-13 08:45</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 02:39:46 UTC
    </footer>
</body>
</html>
