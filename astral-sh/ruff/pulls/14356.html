<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Mark LoggingGuard as `must_use` - astral-sh/ruff #14356</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Mark LoggingGuard as <code>must_use</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14356">#14356</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2024-11-15 10:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body">Summary
<p>Prevents developers like me from trying to use</p>
<pre><code>ruff_db::testing::setup_logging();
</code></pre>
<p>without capturing the returned guard in a variable:</p>
<pre><code>warning: unused `LoggingGuard` that must be used
  --&gt; crates/red_knot_workspace/tests/check.rs:24:5
   |
24 |     ruff_db::testing::setup_logging();
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
   |
   = note: Dropping the guard unregisters the tracing subscriber.
   = note: `#[warn(unused_must_use)]` on by default
</code></pre>
<p>I&#x27;m not sure why the inner <code>tracing::subscriber::DefaultGuard</code> is not marked as <code>must_use</code> in <code>tracing</code>, but they do mark the return value of <code>tracing::subscriber::set_default</code> as <code>must_use</code>:</p>
<p>https://github.com/tokio-rs/tracing/blob/15600a3a67c418f53cb80ff21da57d89a5de0486/tracing/src/subscriber.rs#L57</p>
<p>That doesn&#x27;t trigger anymore because we store the result in <code>LoggingBuilder::build()</code> here:</p>
<p>https://github.com/astral-sh/ruff/blob/1f82731856eb0f199c8b11f8e06c32020a6a9738/crates/ruff_db/src/testing.rs#L182-L206</p>
<p>An alternative might be to mark both <code>setup_logging</code> and <code>setup_logging_with_filter</code> as <code>must_use</code>.</p>
Test Plan
<p>Run <code>cargo test</code> with the code above and observe the compiler warning.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-15 10:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-15 10:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-15 10:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-15 10:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-11-15 10:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-11-15 10:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-15 11:03</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-15 11:47</div>
            <div class="timeline-body"><p>Ah nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-15 11:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-15 11:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-15 11:47</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:08:29 UTC
    </footer>
</body>
</html>
