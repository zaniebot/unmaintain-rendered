<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add progress reporting to workspace diagnostics - astral-sh/ruff #19616</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add progress reporting to workspace diagnostics</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19616">#19616</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-07-29 13:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR adds a nice little progress bar when ty is checking an entire workspace.</p>
<p>This turned out to be trickier than I thought. I initially thought that it would be as easy as taking the <code>work_done_token</code> from the workspace diagnostic request and sending the right <code>$/progress</code> notifications using that token. However, that doesn't work for VS Code nor Zed. It took me quite a while to find out that VS Code doesn't support this. Instead, a server has to use the server initiated work done token registration. With this, it finally works but it requires some awkward concurrent code because we aren't supposed to use that token until the client replied that it's ok to do so... but we don't want to delay checking only so that we can report progress.</p>
<h2>Test Plan</h2>
<p>https://github.com/user-attachments/assets/0fefea21-69b9-4c7a-803c-476d72a1bbaa</p>
<p>https://github.com/user-attachments/assets/f2ff1d4c-9924-413d-bdb9-1dcdb845f7ce</p>
<p>Disclaimer: I used a debug build to test this feature. A release build is much faster :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @MichaReiser on 2025-07-29 13:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @MichaReiser on 2025-07-29 13:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @MichaReiser on 2025-07-29 13:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @MichaReiser on 2025-07-29 13:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-29 13:15</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on typing conformance tests</h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-29 13:17</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2025-07-29 15:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MichaReiser on 2025-07-29 15:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MichaReiser on 2025-07-29 15:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @MichaReiser on 2025-07-29 15:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @MichaReiser on 2025-07-29 15:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dcreager removed by @MichaReiser on 2025-07-29 15:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @MichaReiser on 2025-07-29 15:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @MichaReiser on 2025-07-29 15:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @MichaReiser on 2025-07-29 15:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @MichaReiser on 2025-07-29 15:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[ty] Add progress report to workspace diagnostics" to "[ty] Add progress reporting to workspace diagnostics" by @MichaReiser on 2025-07-29 15:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server.rs</code>:61 on 2025-07-30 03:45</div>
            <div class="timeline-body"><p>Does this show up? Because, tracing hasn't been initialized yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/lazy_work_done_progress.rs</code>:32 on 2025-07-30 03:52</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// ## Server Initiated Progress
///
/// The implementation initiates a work done progress report lazily when no token is provided in the request.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/lazy_work_done_progress.rs</code>:14 on 2025-07-30 03:55</div>
            <div class="timeline-body"><p>nit: I usually move the references at the end so as to avoid breaking the reading flow</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/server/lazy_work_done_progress.rs</code>:151 on 2025-07-30 04:07</div>
            <div class="timeline-body"><p>This can only happen when the create progress failed somehow, right? Would it be useful to add a debug message in this case?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/tests/e2e/pull_diagnostics.rs</code>:200 on 2025-07-30 04:41</div>
            <div class="timeline-body"><p>nit: use <code>let ... else { return Err() }</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/session/client.rs</code>:78 on 2025-07-30 04:42</div>
            <div class="timeline-body"><p>Should this be <em>not</em> <code>pub(crate)</code> as, I think, it's internal now given that we have <code>send_request</code> and <code>send_deferred_request</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/session/client.rs</code>:44 on 2025-07-30 04:44</div>
            <div class="timeline-body"><p>(Can't comment on the actual lines)</p>
<p>The &quot;Note&quot; part of <code>send_request</code> is now implemented via <code>send_deferred_request</code>, we could either remove it or change it to reflect the current logic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-07-30 04:47</div>
            <div class="timeline-body"><p>This looks great!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/session/client.rs</code>:62 on 2025-07-30 04:50</div>
            <div class="timeline-body"><p>I'm still a bit unsure on why this is required. Do you mind explaining in brief on the reason this is required?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-30 04:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-30 05:02</div>
            <div class="timeline-body"><p>This is awesome to see. Here's a demo in Neovim:</p>
<p>https://github.com/user-attachments/assets/4d1a7eab-a7c1-421f-b4dd-889723d77e2c</p>
<p>Ignore the end message, that's an issue with the formatting logic that I've implemented.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-30 06:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server.rs</code>:61 on 2025-07-30 06:50</div>
            <div class="timeline-body"><p>Huh, I thought I deleted this line. Thanks for catching this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-30 06:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/server/lazy_work_done_progress.rs</code>:151 on 2025-07-30 06:51</div>
            <div class="timeline-body"><p>This can also happen if the client doesn't support work done progress reporting or if the server initiated request didn't complete before <code>Drop</code> is called</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-30 06:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/session/client.rs</code>:62 on 2025-07-30 06:53</div>
            <div class="timeline-body"><p><code>send_request</code> requires a <code>&amp;Session</code>. We don't have a <code>&amp;Session</code> in the background worker. We only have a <code>SessionSnapshot</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-07-30 08:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_server/src/session/client.rs</code>:62 on 2025-07-30 08:09</div>
            <div class="timeline-body"><p>Ah ok, so basically what the note mentioned. I thought there must be something else as well :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-30 10:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_server/src/session/client.rs</code>:78 on 2025-07-30 10:14</div>
            <div class="timeline-body"><p>It's also called from <code>main_loop</code> which requires it to be <code>pub(crate)</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-07-30 10:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-07-30 10:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-30 10:27</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:14:39 UTC
    </footer>
</body>
</html>
