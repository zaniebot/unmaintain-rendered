```yaml
number: 17178
title: "Fix relative import resolution in `site-packages` packages when the `site-packages` search path is a subdirectory of the first-party search path"
type: pull_request
state: merged
author: AlexWaygood
labels:
  - bug
  - ty
assignees: []
merged: true
base: main
head: alex/file-to-module-bug
created_at: 2025-04-03T14:28:39Z
updated_at: 2025-04-03T20:45:04Z
url: https://github.com/astral-sh/ruff/pull/17178
synced_at: 2026-01-10T19:40:37Z
```

# Fix relative import resolution in `site-packages` packages when the `site-packages` search path is a subdirectory of the first-party search path

---

_Pull request opened by @AlexWaygood on 2025-04-03 14:28_

## Summary

If a package in `site-packages` had this directory structure:

```py
# bar/__init__.py
from .a import A

# bar/a.py
class A: ...
```

then we would fail to resolve the `from .a import A` import _if_ (as is usually the case!) the `site-packages` search path was located inside a `.venv` directory that was a subdirectory of the project's first-party search path. The reason for this is a bug in `file_to_module` in the module resolver. In this loop, we would identify that `/project_root/.venv/lib/python3.13/site-packages/foo/__init__.py` can be turned into a path relative to the first-party search path (`/project_root`):

https://github.com/astral-sh/ruff/blob/6e2b8f9696e87d786cfed6304dc3baa0f029d341/crates/red_knot_python_semantic/src/module_resolver/resolver.rs#L101-L110

but we'd then try to turn the relative path (`.venv/lib/python3.13/site-packages/foo/__init__.py`) into a module path, realise that it wasn't a valid module path... and therefore immediately `break` out of the loop before trying any other search paths (such as the `site-packages` search path).

This bug was originally reported on Discord by @MatthewMckee4.

## Test Plan

I added a unit test for `file_to_module` in `resolver.rs`, and an integration test that shows we can now resolve the import correctly in `infer.rs`.


---

_Label `bug` added by @AlexWaygood on 2025-04-03 14:28_

---

_Label `red-knot` added by @AlexWaygood on 2025-04-03 14:28_

---

_Review requested from @carljm by @AlexWaygood on 2025-04-03 14:28_

---

_Review requested from @sharkdp by @AlexWaygood on 2025-04-03 14:28_

---

_Review requested from @dcreager by @AlexWaygood on 2025-04-03 14:28_

---

_Comment by @github-actions[bot] on 2025-04-03 14:30_

<!-- generated-comment mypy_primer -->
## `mypy_primer` results
No ecosystem changes detected âœ…


---

_Comment by @AlexWaygood on 2025-04-03 14:33_

> ## Test Plan
> 
> I added a unit test for `file_to_module` in `resolver.rs`, and an integration test that shows we can now resolve the import correctly in `infer.rs`.

I also manually checked that we are able to resolve the import `from pydantic import BaseModel` (when `pydantic` is installed into a virtual environment in a subdirectory of the project root), and we don't manage to resolve that import on `main`.

I guess we don't run mypy_primer on any projects that use pydantic right now!

---

_Comment by @MatthewMckee4 on 2025-04-03 14:36_

I now get "Module `pydantic` has no member `BaseModel`red-knot(lint:unresolved-import)"

This error does not show up with `model_validator` for example

Edit: not on all files though, ill try to reproduce

---

_Review comment by @carljm on `crates/red_knot_python_semantic/src/db.rs`:143 on 2025-04-03 14:39_

You removed `custom_typeshed` because we aren't using it anymore? (I guess mdtest now supports this so those tests have been able to move there.)

---

_@carljm approved on 2025-04-03 14:40_

Looks good!

---

_Comment by @AlexWaygood on 2025-04-03 14:42_

> I now get "Module `pydantic` has no member `BaseModel`red-knot(lint:unresolved-import)"
> 
> This error does not show up with `model_validator` for example

Huh. How are you running this branch?

If I run the following commands:

```
mkdir experiment
cd experiment
uv venv
uv pip install pydantic
echo "from pydantic import BaseModel; from typing_extensions import reveal_type; reveal_type(BaseModel)" > foo.py
cargo run --manifest-path ../ruff/Cargo.toml -p red_knot check foo.py
```

Where `../ruff` is a path to my local Ruff clone, and I have this branch of red-knot checked out, then red-knot now reports this for me:

```
info: revealed-type
 --> /Users/alexw/dev/experiment4/foo.py:1:76
  |
1 | from pydantic import BaseModel; from typing_extensions import reveal_type; reveal_type(BaseModel)
  |                                                                            ^^^^^^^^^^^^^^^^^^^^^^ Revealed type is `Literal[BaseModel]`
  |

Found 1 diagnostic
```

---

_@AlexWaygood reviewed on 2025-04-03 14:42_

---

_Review comment by @AlexWaygood on `crates/red_knot_python_semantic/src/db.rs`:143 on 2025-04-03 14:42_

Yes, exactly

---

_Comment by @MatthewMckee4 on 2025-04-03 14:46_

That works perfectly fine for me, just in one of my codebases this import fails, ill keep trying to reproduce

---

_Comment by @AlexWaygood on 2025-04-03 14:47_

I think I'll land this for now anyway since it definitely fixes _a_ bug (both test cases added here fail on `main`), even if there are more bugs to fix as well as this. But please do report it if you find a repro for the remaining issues!

---

_Merged by @AlexWaygood on 2025-04-03 14:48_

---

_Closed by @AlexWaygood on 2025-04-03 14:48_

---

_Branch deleted on 2025-04-03 14:48_

---

_Comment by @MatthewMckee4 on 2025-04-03 14:51_

Ah sorry im being stupid, my ruff server was linked to my fork of ruff and my ide was showing the old errors, sorry about that

---

_Comment by @AlexWaygood on 2025-04-03 14:52_

No worries at all -- very easily done :-)

---
