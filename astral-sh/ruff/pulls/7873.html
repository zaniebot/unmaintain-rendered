<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comments outside expression parentheses - astral-sh/ruff #7873</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Comments outside expression parentheses</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/7873">#7873</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2023-10-09 16:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>Fixes https://github.com/astral-sh/ruff/issues/7448
Fixes https://github.com/astral-sh/ruff/issues/7892</p>
<p>I've removed automatic dangling comment formatting, we're doing manual dangling comment formatting everywhere anyway (the assert-all-comments-formatted ensures this) and dangling comments would break the formatting there.</p>
<p>main:</p>
<p>| project        | similarity index  | total files       | changed files     |
|----------------|------------------:|------------------:|------------------:|
| cpython        |           0.75803 |              1799 |              1647 |
| django         |           0.99983 |              2772 |                <strong>35</strong> |
| home-assistant |           0.99953 |             10596 |               189 |
| poetry         |           0.99891 |               317 |                17 |
| <strong>transformers</strong>   |           <strong>0.99963</strong> |              2657 |               <strong>332</strong> |
| twine          |           1.00000 |                33 |                 0 |
| typeshed       |           0.99978 |              3669 |                20 |
| <strong>warehouse</strong>      |           <strong>0.99969</strong> |               654 |                <strong>15</strong> |
| zulip          |           0.99970 |              1459 |                22 |</p>
<p>PR:</p>
<p>| project        | similarity index  | total files       | changed files     |
|----------------|------------------:|------------------:|------------------:|
| cpython        |           0.75803 |              1799 |              1647 |
| django         |           0.99983 |              2772 |                <strong>34</strong> |
| home-assistant |           0.99953 |             10596 |               186 |
| poetry         |           0.99891 |               317 |                17 |
| <strong>transformers</strong>   |           <strong>0.99966</strong> |              2657 |               <strong>330</strong> |
| twine          |           1.00000 |                33 |                 0 |
| typeshed       |           0.99978 |              3669 |                20 |
| <strong>warehouse</strong>      |           <strong>0.99977</strong> |               654 |                <strong>13</strong> |
| zulip          |           0.99970 |              1459 |                22 |</p>
<h2>Test Plan</h2>
<p>New test file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @konstin on 2023-10-10 14:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @konstin on 2023-10-11 14:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-10-12 15:05</div>
            <div class="timeline-body"><p>An alternative we could explore is storing the parentheses range on <code>OptionalParentheses</code> through <code>needs_parentheses</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:1881 on 2023-10-16 02:21</div>
            <div class="timeline-body"><p>Is this change related to this PR? If not, could we split it out into a separate PR (or is this a rebasing issue?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:256 on 2023-10-16 02:43</div>
            <div class="timeline-body"><p>Calling <code>fmt_fields</code> directly by-passes the handling of trailing suppression comments. We need to duplicate the logic here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:209 on 2023-10-16 02:54</div>
            <div class="timeline-body"><p>Nit</p>
<pre><code class="language-suggestion">    let right_tokenizer = SimpleTokenizer::starts_at(
        expression.end(),
        f.context().source(),
    )
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:117 on 2023-10-16 02:57</div>
            <div class="timeline-body"><p>Nit: Use <code>leading_trailing_dangling</code> and pass the result to <code>format_with_parentheses_comments</code> to avoid querying comments for the same expression multiple times:</p>
<pre><code class="language-rust">node_comments = comments.leading_trailing_dangling(expression)`;
if !node_comments.has_leading() &amp;&amp; !node.comments.has_trailing() {
    ...
} else {
    format_with_parentheses_comments(expression, node_comments, f)
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:283 on 2023-10-16 03:01</div>
            <div class="timeline-body"><p>Nit: The main benefit of <code>FormatRuleWith</code> is that it wraps the object to format with how it gets formatted. I would probably lean towards calling the relevant format rules directly (fewer abstractions, easier to understand)</p>
<pre><code class="language-rust">Expr::Call =&gt; FormatExprCall::default().fmt_fields(expr, f)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-10-16 03:06</div>
            <div class="timeline-body"><p>How does this work for expressions where we use <code>maybe_parenthesize</code> with a layout that doesn't preserve parentheses and a trailing (non-own line) comment?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-10-16 08:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:256 on 2023-10-16 08:02</div>
            <div class="timeline-body"><p>Nevermind.. expressions don't support trailing expression comments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-10-17 10:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:209 on 2023-10-17 10:16</div>
            <div class="timeline-body"><p>thanks, i didn't realize it was on the tokenizer and instead failed to find it on text range</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-10-17 10:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:1881 on 2023-10-17 10:21</div>
            <div class="timeline-body"><p>yes, unary operations were doing their own placement conflicting with the changes in this PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:283 on 2023-10-17 10:25</div>
            <div class="timeline-body"><p>I prefer this one for avoiding repeating the <node> -&gt; Format<node> association.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-10-17 10:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @konstin on 2023-10-17 10:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-10-17 10:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:190 on 2023-10-17 10:50</div>
            <div class="timeline-body"><p>I'm still not sure what to do about this, otherwise this PR is ready</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @konstin on 2023-10-18 19:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-10-18 23:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:283 on 2023-10-18 23:23</div>
            <div class="timeline-body"><p>That's fair and up to you. It just requires a few more brain cycles to resolve <code>FormatNodeRule::fmt_fields(expr.format().rule(), expr, f)</code> to <code>FormatExprFString::default().fmt_fields(expr, f)</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-10-18 23:24</div>
            <div class="timeline-body"><p>Could you update the test plan with the similarity index table to see if there are any changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:1905 on 2023-10-18 23:27</div>
            <div class="timeline-body"><p>I think we could keep these two checks?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:190 on 2023-10-18 23:30</div>
            <div class="timeline-body"><p>I don't mind the duplication. We could implement a helper that returns an Iterator over the parentheses (opening and closing) and reuse it in <code>parenthesized_range</code> and here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:190 on 2023-10-18 23:33</div>
            <div class="timeline-body"><p><code>parenthesized_range</code> has a special case for call expressions like <code>call(a)</code> to avoid counting the <code>(</code> and <code>)</code> as the parentheses of this node. Is it safe to not special-tread call expressions here and if so why?</p>
<pre><code class="language-python">(
	call # sneaky
		( # comments
			a
	) # more	
)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:242 on 2023-10-18 23:35</div>
            <div class="timeline-body"><p>Nit</p>
<pre><code class="language-suggestion">    let (leading_outer, leading_inner) = node_comments.leading.split_at(leading_split);
    let (trailing_inner, trailing_outer) = node_comments.trailing.split_at(trailing_split);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:240 on 2023-10-18 23:36</div>
            <div class="timeline-body"><p>I'm surprised clippy doesn't complain here. It normally doesn't like <code>Default::default</code> and instead asks you to use <code>T::default</code></p>
<pre><code class="language-suggestion">        _ =&gt; (&amp;[], node_comments.leading),
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:245 on 2023-10-18 23:36</div>
            <div class="timeline-body"><p>Can we explain the reason why it has to be strange? Or can we make it not strange?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:255 on 2023-10-18 23:38</div>
            <div class="timeline-body"><p>Nit: It could make sense to extract this into it's own struct <code>FormatExprFields</code> to not make this function longer than absolutely necessary (It kind of breaks the reading flow, there's the comment above explaining what is happening, but it is then followed by this somewhat unrelated boilerplate)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/statement/with.py</code>:92 on 2023-10-18 23:39</div>
            <div class="timeline-body"><p>What's the reason for removing this test case?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-10-18 23:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-10-19 08:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/comments/placement.rs</code>:1905 on 2023-10-19 08:32</div>
            <div class="timeline-body"><p>no they'd lead to unstable formatting</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-10-19 08:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:190 on 2023-10-19 08:58</div>
            <div class="timeline-body"><p>The problem is that the expression would be <code>a</code> but a doesn't know its parent</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-10-19 09:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:245 on 2023-10-19 09:00</div>
            <div class="timeline-body"><p>Mainly because we have to construct the nested <code>format_with</code>s. I considered inlining everything but then we lack the proper structuring</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-10-19 09:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/statement/with.py</code>:92 on 2023-10-19 09:02</div>
            <div class="timeline-body"><p>It's a duplicate, sorry should have added a PR comment</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-10-19 09:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:240 on 2023-10-19 09:05</div>
            <div class="timeline-body"><pre><code>error[E0308]: `match` arms have incompatible types
   --&gt; crates/ruff_python_formatter/src/expression/mod.rs:241:14
    |
237 |       let (parentheses_comment, leading_inner) = match leading_inner.split_first() {
    |  ________________________________________________-
238 | |         Some((first, rest)) if first.line_position().is_end_of_line() =&gt; {
239 | |             (slice::from_ref(first), rest)
    | |             ------------------------------ this is found to be of type `(&amp;[comments::SourceComment], &amp;[comments::SourceComment])`
240 | |         }
241 | |         _ =&gt; (&amp;[], node_comments.leading),
    | |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^ expected `(&amp;[SourceComment], &amp;[SourceComment])`, found `(&amp;[_; 0], &amp;[SourceComment])`
242 | |     };
    | |_____- `match` arms have incompatible types
    |
    = note: expected tuple `(&amp;[comments::SourceComment], &amp;[comments::SourceComment])`
               found tuple `(&amp;[_; 0], &amp;[comments::SourceComment])`
</code></pre>
<p>I'll revert to default</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-10-19 09:18</div>
            <div class="timeline-body"><p>Added the similarity index table to the description, this had more impact than i had expected</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @konstin on 2023-10-19 09:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2023-10-19 09:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-10-19 09:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-10-19 09:30</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:00:45 UTC
    </footer>
</body>
</html>
