<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upgrade to Rust 1.86 and bump MSRV to 1.84 - astral-sh/ruff #17171</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Upgrade to Rust 1.86 and bump MSRV to 1.84</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17171">#17171</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-04-03 11:44
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">

Summary
<p>I decided to disable the new <a href="https://rust-lang.github.io/rust-clippy/master/index.html#needless_continue"><code>needless_continue</code></a> rule because I often found the explicit <code>continue</code> more readable over an empty block or having to invert the condition of an other branch.</p>
Test Plan
<p><code>cargo test</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-03 11:46</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-03 11:55</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>✅ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-03 12:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-03 12:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-03 12:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-03 12:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-03 12:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-03 12:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/BurntSushi">@BurntSushi</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-03 12:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dhruvmanila">@dhruvmanila</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-03 12:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/module_resolver/typeshed.rs</code>:337 on 2025-04-03 12:46</div>
            <div class="timeline-body"><pre><code></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff/src/args.rs</code>:983 on 2025-04-03 12:48</div>
            <div class="timeline-body"><p>if we expect this <code>write!()</code> call to always succeed, would <code>.unwrap()</code> or <code>.expect()</code> be better?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-04-03 12:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-03 12:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/args.rs</code>:983 on 2025-04-03 12:52</div>
            <div class="timeline-body"><p>I thought about that and it actually was the first thing I wrote (there was no autofix).</p>
<p>I went with the lint&#x27;s recommended fix because I expect most users to do the same, and this approach will lead to more consistent code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/flake8_gettext/rules/printf_in_gettext_func_call.rs</code>:57 on 2025-04-03 14:08</div>
            <div class="timeline-body"><p>Interesting, is this now allowed or was it always allowed and I wasn&#x27;t aware of it? i.e., matching against an enum struct variant without specifying the fields.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-04-03 14:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-03 15:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_gettext/rules/printf_in_gettext_func_call.rs</code>:57 on 2025-04-03 15:55</div>
            <div class="timeline-body"><p><code>Operator::Mod</code> has no fields. But it seems that Rust still allows you to use <code>{ .. } </code> in that case because that also matches &quot;no-fields&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-03 15:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-03 15:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-03 15:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-04-03 16:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/flake8_gettext/rules/printf_in_gettext_func_call.rs</code>:57 on 2025-04-03 16:01</div>
            <div class="timeline-body"><p>I see and I&#x27;m guessing that it&#x27;s the same for other struct variants for which the <code>{ .. }</code> was removed in this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff/src/commands/rule.rs</code>:56 on 2025-04-03 18:43</div>
            <div class="timeline-body"><p>I kinda wonder if we should propose add something to <code>std</code> to make this nicer. I like the way the <code>x.push_str(&amp;format!(&quot;...&quot;))</code> construction reads much nicer, but I guess this approach avoids an intermediate allocation. But this approach has the very ugly <code>let _ = ...;</code> construction.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-04-03 18:43</div>
            <div class="timeline-body"><p>Nice! Sorry for the late review. I was in the middle of reviewing this when I scratched my cornea, so I figured I&#x27;d finish it haha.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-03 18:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/commands/rule.rs</code>:56 on 2025-04-03 18:49</div>
            <div class="timeline-body"><p>That would be great. I definitely don&#x27;t love it and it has the downside that later refactoring the code to eg use a Write instead of a string now incorrectly suppresses errors (instead of Rust telling you that this might now fail)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eskultety">@eskultety</a> on 2025-05-07 08:47</div>
            <div class="timeline-body"><p>Hello, I&#x27;d like to know what the motivation to pin the Rust version to the latest release in <code>rust-toolchain.toml</code> was? Were there any interesting features that this project required to adopt that quickly (literally on the same day of Rust release)?
The reason for my question is that IIUC you&#x27;re essentially making it impossible for any distro out there to keep up with packaging and everyone is required to rely on <code>rustup</code> to get the exact toolchain version needed to build the project. Before I dive into any further discussion I&#x27;d first like to know where my lack of understanding the matter resides and therefore what the real motivation here was/is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-07 09:11</div>
            <div class="timeline-body"><blockquote>
<p>Hello, I&#x27;d like to know what the motivation to pin the Rust version to the latest release in <code>rust-toolchain.toml</code> was? Were there any interesting features that this project required to adopt that quickly (literally on the same day of Rust release)? The reason for my question is that IIUC you&#x27;re essentially making it impossible for any distro out there to keep up with packaging and everyone is required to rely on <code>rustup</code> to get the exact toolchain version needed to build the project. Before I dive into any further discussion I&#x27;d first like to know where my lack of understanding the matter resides and therefore what the real motivation here was/is.</p>
</blockquote>
<p>We&#x27;re aware that always using the latest version is challenging for downstream packagers. That&#x27;s why we only use the latest Rust version for local development (and in our release pipelines) but maintain backwards compatibility with <code>latest - 2</code> as the MSRV with which ruff compiles (see <a href="https://docs.astral.sh/ruff/versioning/#minimum-supported-rust-version">versioning policy</a>). That means Ruff can still be built with Rust 1.84 today.</p>
<p>I think what you&#x27;re running into is that you clone Ruff&#x27;s repository and invoke <code>cargo build</code> directly. Cargo then picks up the version specified in <code>rust-toolchain.toml</code>. The version in <code>rust-toolchain.toml</code> is the version <em>we use</em> and using the latest Rust version is desired because it gives us new clippy rules and enables new compiler optimizations in the release artifacts built as part of our pipeline.</p>
<p>I understand is that you want to use a different Rust version. You have a few options:</p>
<ul>
<li>use <code>rustup override set &lt;version&gt;</code></li>
<li>Use a toolchain override shorthand <code>cargo +stable</code></li>
<li>Use the <code>RUSTUP_TOOLCHAIN</code></li>
<li>Delete the <code>rust-toolchain.toml</code></li>
</ul>
<p>You can use any rust version that&#x27;s compatible with our MSRV (1.84 today). It can be newer or older than the version in our <code>rust-toolchain.toml</code> but it can&#x27;t be older than the MSRV.</p>
<p>I hope this helps</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eskultety">@eskultety</a> on 2025-05-07 09:33</div>
            <div class="timeline-body"><blockquote>
<p>That&#x27;s why we only use the latest Rust version for local development (and in our release pipelines)</p>
</blockquote>
<p>Hmm, have you considered adopting the latest &amp; greatest primarily in nightly CI builds to get early feedback on new stuff but move the upstream dependency on a slower pace to essentially not &quot;test in production&quot; and by production means all local dev setups? Kinda what Fedora Rawhide is for and commonly consumed in projects&#x27; CIs.</p>
<blockquote>
<p>I think what you&#x27;re running into is that you clone Ruff&#x27;s repository and invoke cargo build directly. Cargo then picks up the version specified in rust-toolchain.toml</p>
</blockquote>
<p>Our use case is actually quite different (ties to <code>cargo vendor</code>, not important), but yes, the result is the same. We work in the secure software supply chain field with a strong compliance with the strictest <a href="https://slsa.dev/spec/v1.0/">SLSA</a> levels which, among other things, means that builds are network-isolated, hence no rustup updates (also no rustup package). The other major factor (as if network isolation weren&#x27;t enough :) ) is strict provenance, to put it simply - consuming packages via source tarballs is preferred over binaries.</p>
<blockquote>
<p>Use a toolchain override shorthand cargo +stable
Use the RUSTUP_TOOLCHAIN
Delete the rust-toolchain.toml</p>
</blockquote>
<p>We may actually consider some of ^this, thanks for the pointer, I admit I didn&#x27;t pay thorough attention when reading https://rust-lang.github.io/rustup/overrides.html before dropping a comment on this PR. That said, if you say that <code>rust-toolchain.toml</code> is for development and to consume optimizations early for your binary artifacts, would you consider excluding the file from the Python sdist since based on the premise (and based on your backwards compatibility claim) it&#x27;s irrelevant to have it there for released packages.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-07 09:59</div>
            <div class="timeline-body"><blockquote>
<p>That said, if you say that rust-toolchain.toml is for development and to consume optimizations early for your binary artifacts, would you consider excluding the file from the Python sdist since based on the premise (and based on your backwards compatibility claim) it&#x27;s irrelevant to have it there for released packages.</p>
</blockquote>
<p>I think that makes sense</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-07 10:37</div>
            <div class="timeline-body"><p>I created <a href="https://github.com/astral-sh/ruff/issues/17909">astral-sh/ruff#17909</a>. I&#x27;m trying to figure out why we included it in the first place.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:12:53 UTC
    </footer>
</body>
</html>
